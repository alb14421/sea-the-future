// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/colorUtils","../../core/Error","../../geometry/support/scaleUtils","../../renderers/DotDensityRenderer","../../renderers/support/AuthoringInfo","../heuristics/outline","./support/dotDensityUtils","./support/regenerateUtils","./support/utils","../statistics/spatialStatistics","../statistics/summaryStatisticsForAttributes","../statistics/support/attributeDensity","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils","../symbology/dotDensity"],function(e,t,a,i,r,n,l,s,o,u,d,c,p,m,y,f,g){"use strict";async function b(e){const t=e.view;if(!(e?.layer&&t&&e.attributes?.length))throw new a("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>8)throw new a("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");e.forBinning&&m.verifyBinningParams(e,"dot-density-renderer");const i={...e,view:t,layer:e.layer,attributes:e.attributes},r=e.forBinning?f.binningCapableLayerTypes:[3,9,6,7,4,15],n=f.createLayerAdapter(i.layer,r,e.forBinning);if(!n)throw new a("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+f.getLayerTypeLabels(r).join(", "));i.dotBlendingEnabled??=!0,i.dotValueOptimizationEnabled??=!0;const l=null!=i.signal?{signal:i.signal}:null;if(await Promise.all([t.when(),n.load(l)]),"polygon"!==n.geometryType)throw new a("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");const s=[],o=i.attributes;for(const e of o){const t=await y.getFieldsList({field:e.field,valueExpression:e.valueExpression});s.push(...t)}const d=u.verifyBasicFieldValidity(n,s.filter(Boolean),"dot-density-renderer:invalid-parameters");if(d)throw d;return{...i,layer:n}}function w(e){return{dotValue:1,referenceScale:e.scale,minSliderValue:1,maxSliderValue:100}}async function v(e){const{view:t,layer:a,attributes:r,signal:n,filter:l}=e,o=await a.getSampleFeatures({view:t,sampleSize:500,returnGeometry:!0,filter:l,signal:n},"json"),[u,p]=await Promise.all([d({features:o,geometryType:a.geometryType}),c({layer:a,attributes:r,filter:l,includeZeros:!1,includeNegatives:!1,view:t,signal:n})]),m=null!=u&&"avgSize"in u&&u.avgSize,y=p.avg;if(!m||!y)return w(t);const f=i.getResolutionForScale(t.scale,t.spatialReference),g=m*m/(f*f)*.1;return{dotValue:s.roundValue(y/g)||1,referenceScale:t.scale,minSliderValue:1,maxSliderValue:s.roundValue(y)}}async function h(e){const{view:t,layer:a,attributes:r,signal:n,filter:l}=e,o=[];for(const e of r){const t=await y.getFieldsList({field:e.field,valueExpression:e.valueExpression});o.push(...t)}const u=await a.getSampleFeatures({view:t,sampleSize:500,requiredFields:o,filter:l,returnGeometry:!0,signal:n},"json"),{minDensity:d,maxDensity:c,avgDensity:m}=await p({features:u,attributes:r,includeZeros:!1,includeNegatives:!1,view:t});if(!m||!d||!c)return w(t);const f=i.getResolutionForScale(t.scale,t.spatialReference),g=f*f,b=s.roundValue(d*g),v=s.roundValue(c*g);let h=s.roundValue(m*g*10)||1;return h>v&&(h=v),{dotValue:h,referenceScale:t.scale,minSliderValue:b,maxSliderValue:v}}e.createRenderer=async function(e){const i=await b(e),s=i.layer,o=s.geometryType,d=await async function(e){let t=e.dotDensityScheme,a=null,i=null;const r=await u.getBasemapInfo(e.basemap,e.view);if(a=null!=r.basemapId?r.basemapId:null,i=null!=r.basemapTheme?r.basemapTheme:null,t)return{scheme:g.cloneScheme(t),basemapId:a,basemapTheme:i};const n=g.getSchemes({numColors:e.attributes.length,basemapTheme:i});return n&&(t=n.primaryScheme,a=n.basemapId,i=n.basemapTheme),{scheme:t,basemapId:a,basemapTheme:i}}(i),c=d?.scheme;if(!c)throw new a("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");const p=i.view,m=i.filter,y={layer:s,view:p,filter:m,attributes:i.attributes,signal:i.signal},f={layer:i.layer,view:p,filter:m,signal:i.signal},[w,S]=await Promise.all([i.trueDensity?h(y):v(y),i.outlineOptimizationEnabled?l(f).catch(u.errorCallback):null]),{dotValue:V,referenceScale:E,minSliderValue:x,maxSliderValue:T}=w,D=t.createUniqueColors(c.colors,i.attributes.length),I=i.attributes.map((e,t)=>({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:D[t]})),O=new r({attributes:I,dotBlendingEnabled:i.dotBlendingEnabled,outline:S?u.getSymbolOutlineFromScheme(c,o,S.opacity):null,dotValue:V,referenceScale:i.dotValueOptimizationEnabled?E:null,legendOptions:i.legendOptions});return S?.visualVariables.length&&(O.visualVariables=S.visualVariables.map(e=>e.clone())),O.authoringInfo=new n({type:"dot-density",minSliderValue:x,maxSliderValue:T}),{renderer:O,dotDensityScheme:c,basemapId:d.basemapId,basemapTheme:d.basemapTheme}},e.regenerateRenderer=async function(e){const{creatorParameters:t,renderer:i}=await async function(e){const t="regenerate-dot-density-renderer";await o.processRegenerateParams(e,t);const i=await o.getRendererToUpdate(e);if("dot-density"!==o.getStyleType(i))throw new a(`${t}:invalid-parameters`,"Renderer is invalid");const{layer:r,forBinning:n,filter:l,view:s,signal:u}=e,d=o.hasOutlineVV(i),c=i.attributes.map(e=>({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle})),p=await b({layer:r,attributes:c,dotValueOptimizationEnabled:null!=i.referenceScale,outlineOptimizationEnabled:d,forBinning:n,filter:l,view:s,signal:u});return{...e,creatorParameters:p,renderer:i}}(e),{layer:r,attributes:n,outlineOptimizationEnabled:s,view:d,signal:c,filter:p}=t,m={layer:r,view:d,filter:p,attributes:n,signal:c},[y,f]=await Promise.all([t.trueDensity?h(m):v(m),s?l({layer:r,view:d,signal:c,filter:p}).catch(u.errorCallback):null]),{dotValue:g,referenceScale:w,minSliderValue:S,maxSliderValue:V}=y;return i.dotValue=g,i.referenceScale=t.dotValueOptimizationEnabled?w:null,i.authoringInfo&&(i.authoringInfo.minSliderValue=S,i.authoringInfo.maxSliderValue=V),o.spliceVisualVariables(i,f?.visualVariables,o.findOutlineVVIndex),{renderer:i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});