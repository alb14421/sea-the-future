// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/Error","../../renderers/support/AuthoringInfo","../../renderers/support/ClassBreakInfo","../../renderers/visualVariables/support/SizeStop","../../renderers/visualVariables/support/visualVariableUtils","./color","./size","./support/regenerateUtils","./support/utils","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils","../symbology/support/aboveAndBelowUtils","../../symbols/support/cimSymbolUtils","../../symbols/support/Symbol3DMaterial"],function(e,i,a,s,o,n,l,t,r,u,p,c,m,d,v,b){"use strict";const y=2**53-1;async function f(e){if(!e?.layer||!(e.field||e.valueExpression||e.sqlExpression))throw new i("univariate-colorsize-visual-variables:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new i("univariate-colorsize-visual-variables:missing-parameters","View is required when 'valueExpression' is specified");if("above-and-below"===e.theme&&e.sizeOptions?.sizeOptimizationEnabled)throw new i("univariate-colorsize-visual-variables:invalid-parameters","sizeOptimizationEnabled cannot be true for 'above-and-below' theme");e.forBinning&&p.verifyBinningParams(e,"univariate-colorsize-visual-variables");const a={...e,layer:e.layer},s=e.forBinning?m.binningCapableLayerTypes:m.featureCapableLayerTypes,o=m.createLayerAdapter(a.layer,s,e.forBinning);if(!o)throw new i("univariate-colorsize-visual-variables:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(s).join(", "));a.layer=o,a.theme=a.theme||a.colorOptions?.theme?a.theme:"high-to-low";const n=null!=a.signal?{signal:a.signal}:null;await o.load(n);const l=await c.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}),t=u.verifyBasicFieldValidity(o,l,"univariate-colorsize-visual-variables:invalid-parameters");if(t)throw t;return a}function w(e,i){const a={...e},{sizeOptions:s,theme:o}=a,n=a.legendOptions||a.sizeOptions?.legendOptions;return delete a.sizeOptions,delete a.colorOptions,{...a,...s,statistics:i||a.statistics,theme:"above-and-below"===o?null:o,legendOptions:n}}function h(e,i){const a={...e},s=a.colorOptions,o=a.theme||s?.theme,n=a.legendOptions||a.colorOptions?.legendOptions;return delete a.sizeOptions,delete a.colorOptions,{...a,...s,statistics:i||a.statistics,theme:o,legendOptions:n}}async function g(e){if(!e?.layer||!(e.field||e.valueExpression||e.sqlExpression))throw new i("univariate-colorsize-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new i("univariate-colorsize-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&p.verifyBinningParams(e,"univariate-colorsize-continuous-renderer");const a={...e,layer:e.layer};a.symbolType=a.symbolType||"2d",a.colorOptions||(a.colorOptions={}),a.colorOptions.isContinuous=a.colorOptions.isContinuous??!1;const s=e.forBinning?m.binningCapableLayerTypes:m.featureCapableLayerTypes,o=m.createLayerAdapter(a.layer,s,e.forBinning);if(!o)throw new i("univariate-colorsize-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(s).join(", "));const n=null!=a.signal?{signal:a.signal}:null;if(await o.load(n),"above-and-below"===a.theme&&a.symbolOptions){if(a.symbolType.includes("3d-volumetric"))throw new i("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' is applicable for '2d' and '3d-flat' 'symbolType' only");if("point"!==o.geometryType&&"polygon"!==o.geometryType)throw new i("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' only apply to layers with 'point' or 'polygon' geometryType")}const l=await c.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}),t=u.verifyBasicFieldValidity(o,l,"univariate-colorsize-continuous-renderer:invalid-parameters");if(t)throw t;return{...a,layer:o}}function z(e,i){"type"in e&&"cim"===e.type?v.applyCIMSymbolColor(e,i):"type"in e&&e.type.includes("3d")?e.symbolLayers.forEach(e=>{"material"in e&&null!=e.material&&"color"in e.material&&(e.material?e.material.color=i:e.material=new b.Symbol3DMaterial({color:i}))}):"color"in e&&(e.color=i)}function V(e,i,a=!0){const s=i?.authoringInfo?.clone(),o=s?.visualVariables?.some(e=>"reference-size"===e.theme),n=o?[]:i.size.visualVariables.map(e=>e.clone());a?n.push(i.color.visualVariable.clone()):s.visualVariables=s.visualVariables?.filter(e=>"size"===e.type),e.visualVariables&&n.push(...e.visualVariables.filter(e=>"target"in e&&"outline"===e.target).map(e=>e.clone())),e.authoringInfo=s,e.visualVariables=n}function S(e){const i={...e},a=i.symbolType,s=!!a?.includes("3d-volumetric");delete i.symbolType,delete i.defaultSymbolEnabled;const o=i;return o.worldScale=s,s&&(o.sizeOptions={...o.sizeOptions},o.sizeOptions.axis="3d-volumetric-uniform"===a?"all":"height"),o}async function O(e,i,a,s,l){const t=e.find(e=>"width-and-depth"!==e.axis&&!e.target),r="number"==typeof t?.minSize?t?.minSize:null,p="number"==typeof t?.maxSize?t?.maxSize:null;if(null!=t?.minDataValue&&null!=r&&null!=p)if(s)if("above-and-below"===s){t.minDataValue=null,t.maxDataValue=null,t.minSize=null,t.maxSize=null;const e=u.createStopValuesForAboveBelow(a,l),s=u.clampAboveAndBelowStopValues(e,a);await async function(e,i,a,s){const l=i[0],t=i[1],r=Math.round((t-l)/2)+l,u=e.clone();u.stops=[new o({value:a[0],size:t}),new o({value:a[1],size:r}),new o({value:a[2],size:l}),new o({value:a[3],size:r}),new o({value:a[4],size:t})],e.stops=[new o({value:s[0],size:n.getSize(u,s[0])}),new o({value:s[1],size:n.getSize(u,s[1])}),new o({value:s[2],size:n.getSize(u,s[2])}),new o({value:s[3],size:n.getSize(u,s[3])}),new o({value:s[4],size:n.getSize(u,s[4])})]}(t,[r,p],e,s),i.stops.forEach((e,i)=>e.value=s[i])}else{const{minDataValue:e,maxDataValue:a}=t,s=u.createDefaultStopValues(e,a,5);i.stops.forEach((e,i)=>e.value=s[i]),t.minDataValue=s[0],t.maxDataValue=s[s.length-1]}else t.minDataValue=i.stops[0].value,t.maxDataValue=i.stops[i.stops.length-1].value}function x(e,i,s){const{theme:o,minValue:n,maxValue:l}=e,t=i.authoringInfo.visualVariables[0].clone(),r=s.authoringInfo.visualVariables[0].clone(),{stops:u}=i.visualVariable;return"above-and-below"===o?(t.minSliderValue=r.minSliderValue=n??u[0].value,t.maxSliderValue=r.maxSliderValue=l??u.at(-1)?.value,r.theme="above-and-below"):o&&"high-to-low"!==o||"reference-size"!==r.theme||2!==r.sizeStops?.length||(r.sizeStops[0].value=u[0].value,r.sizeStops[1].value=u.at(-1)?.value),new a({type:"univariate-color-size",univariateTheme:o,visualVariables:[t,r]})}async function E(e){const i=await f(e),a=await l.createVisualVariable(h(i)),{visualVariable:s,statistics:o}=a,n=await t.createVisualVariables(w(i,o)),r=n.visualVariables,u=e.layer,p=e.field?u.getField(e.field):null;return await O(r,s,o,i.theme,c.isAnyDateField(p)),{basemapId:n.basemapId,basemapTheme:n.basemapTheme,statistics:o,defaultValuesUsed:a.defaultValuesUsed,color:{visualVariable:s,colorScheme:a.colorScheme},size:{visualVariables:r,sizeScheme:n.sizeScheme},authoringInfo:x(i,a,n)}}async function T(e){const i=await g(e),{renderer:a,statistics:o,defaultValuesUsed:n}=await t.createContinuousRenderer(function(e){const i={...e},a={...i.sizeOptions};return delete i.sizeOptions,delete i.colorOptions,delete a.sizeOptimizationEnabled,{...i,...a}}(i)),l=S(i);l.statistics=o;const r=await E(l);return"above-and-below"===i.theme?function(e,i,a){const o=a.symbolOptions,n=a.layer,l=o?.symbols?"custom":o?.symbolStyle,t=a.colorOptions?.isContinuous;if(V(e,i,t),l||!t){const a=i.size.visualVariables[0].stops,{above:r,below:u}=function(e,i,a){if((i?.symbolStyle||i?.symbols)&&("point"===a||"polygon"===a))return i.symbols||d.getAboveAndBelowSymbols(i.symbolStyle);const s=e.classBreakInfos[0].symbol;return{above:s.clone(),below:s.clone()}}(e,o,n.geometryType);if(!t){const e=i.color.colorScheme.colors,a=e[0];z(r,e[e.length-1]),z(u,a)}e.classBreakInfos=[new s({minValue:-y,maxValue:a[2].value,symbol:u}),new s({minValue:a[2].value,maxValue:y,symbol:r})],l&&e.authoringInfo&&(e.authoringInfo.univariateSymbolStyle=l)}}(a,r,i):V(a,r),{renderer:a,statistics:o,defaultValuesUsed:n,color:i.colorOptions?.isContinuous||"above-and-below"!==i.theme?r.color:null,size:r.size,basemapId:r.basemapId,basemapTheme:r.basemapTheme}}e.createContinuousRenderer=async function(e){return T(e)},e.createRenderer=T,e.createVisualVariables=E,e.regenerateRenderer=async function(e){const{creatorParameters:a}=await async function(e){const a="regenerate-univariate-color-size-renderer";await r.processRegenerateParams(e,a);const s=await r.getRendererToUpdate(e);if("univariate-color-size"!==r.getStyleType(s))throw new i(`${a}:invalid-parameters`,"Renderer is invalid");const{layer:o,forBinning:n,filter:l,view:t,signal:u}=e,{field:p,normalizationField:c,valueExpression:m,valueExpressionTitle:d}=s,v=r.hasOutlineVV(s),b=r.hasScaleDependentSizeVV(s),y=s.authoringInfo?.univariateTheme,f=await g({layer:o,field:p,normalizationField:c,valueExpression:m,valueExpressionTitle:d,outlineOptimizationEnabled:v,theme:y,colorOptions:{isContinuous:"above-and-below"===y?s.visualVariables?.some(e=>"color"===e.type):void 0},sizeOptions:{sizeOptimizationEnabled:b},forBinning:n,filter:l,view:t,signal:u});return{...e,creatorParameters:f,renderer:s}}(e),{layer:s,field:o,theme:n,colorOptions:u}=a,{renderer:p,statistics:m}=await t.regenerateContinuousRenderer(e),d=await f({...S(a),statistics:m}),v=await l.createVisualVariable(h(d)),b=v.visualVariable,y=(await t.createVisualVariables(w(d))).visualVariables,z=o?s.getField(o):null;await O(y,b,m,n,c.isAnyDateField(z));const V=u?.isContinuous||"above-and-below"!==n,x=p.visualVariables?.find(r.isColorVV);V&&x?.stops&&(x.stops.forEach((e,i)=>e.value=b.stops[i].value),r.updateAuthoringInfoVisualVariable(p,v.authoringInfo,"color")),r.spliceVisualVariables(p,y,r.findSizeVVIndex);const E=r.getAuthoringInfoVisualVariable(p,"size");if((!n||"high-to-low"===n)&&E&&"reference-size"===E.theme&&2===E.sizeStops?.length){const{stops:e}=b;E.sizeStops[0].value=e[0].value,E.sizeStops[1].value=e.at(-1)?.value}if("above-and-below"===n&&y[0]?.stops){const e=y[0].stops;p.classBreakInfos[0].maxValue=e[2].value,p.classBreakInfos[1].minValue=e[2].value}return{renderer:p}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});