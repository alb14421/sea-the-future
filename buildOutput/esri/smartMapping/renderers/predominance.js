// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/colorUtils","../../core/Error","../../intl/messages","../../renderers/support/AuthoringInfo","../../renderers/support/AuthoringInfoVisualVariable","../../renderers/support/numberUtils","../../renderers/visualVariables/OpacityVariable","../../renderers/visualVariables/support/OpacityStop","../../renderers/visualVariables/support/VisualVariableLegendOptions","../heuristics/outline","./size","./type","./support/regenerateUtils","./support/utils","../statistics/predominantCategories","../statistics/support/predominanceUtils","../support/binningUtils","../support/adapters/support/layerUtils","../symbology/predominance"],function(e,a,i,n,r,l,s,t,o,p,d,u,m,c,y,b,g,f,h,v){"use strict";async function w(e){if(!(e?.layer&&e.view&&e.fields?.length))throw new i("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(e.fields.length<2)throw new i("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(e.fields.length>10)throw new i("predominance-renderer:invalid-parameters","Maximum 10 fields are supported");e.forBinning&&f.verifyBinningParams(e,"predominance-renderer");const a={...e,layer:e.layer,fields:e.fields};a.symbolType=a.symbolType||"2d",a.defaultSymbolEnabled??=!0,a.includeOpacityVariable=e.includeOpacityVariable||!1,a.includeSizeVariable=e.includeSizeVariable||!1,a.sortBy??="count";const n=e.forBinning?h.binningCapableLayerTypes:h.featureCapableLayerTypes,r=h.createLayerAdapter(a.layer,n,e.forBinning);if(!r)throw new i("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+h.getLayerTypeLabels(h.featureCapableLayerTypes).join(", "));const l=null!=a.signal?{signal:a.signal}:null;await r.load(l);const s=r.geometryType,t=a.symbolType.includes("3d");if(a.outlineOptimizationEnabled="polygon"===s&&a.outlineOptimizationEnabled,a.includeSizeVariable||(a.sizeOptimizationEnabled=("point"===s||"multipoint"===s||"polyline"===s)&&a.sizeOptimizationEnabled),"mesh"===s)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none",a.sizeOptimizationEnabled=!1;else{if(t&&("polyline"===s||"polygon"===s))throw new i("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(a.symbolType.includes("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new i("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}const o=a.fields.map(e=>e.name),p=y.verifyBasicFieldValidity(r,o,"predominance-renderer:invalid-parameters");if(p)throw p;return{...a,layer:r}}async function V(e){let a=e.predominanceScheme,i=null,n=null;const r=await y.getBasemapInfo(e.basemap,e.view);if(i=null!=r.basemapId?r.basemapId:null,n=null!=r.basemapTheme?r.basemapTheme:null,a)return{scheme:v.cloneScheme(a),basemapId:i,basemapTheme:n};const l=v.getSchemes({basemapTheme:n,geometryType:e.geometryType,numColors:e.numColors,theme:e.theme,worldScale:e.worldScale,view:e.view});return l&&(a=l.primaryScheme,i=l.basemapId,n=l.basemapTheme),{scheme:a,basemapId:i,basemapTheme:n}}async function z(e,a,i){const r=await n.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");return u.createVisualVariables({layer:e.layer,basemap:e.basemap,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,sizeScheme:i,sizeOptimizationEnabled:e.sizeOptimizationEnabled,worldScale:!!e.symbolType?.includes("3d-volumetric"),legendOptions:{title:r.sumOfCategories},filter:e.filter,view:e.view,signal:e.signal})}async function S(e,a){const i=await n.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),d=await y.getSummaryStatistics({layer:e.layer,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,filter:e.filter,view:e.view,signal:e.signal}),{avg:u,stddev:m}=d,c=null==u||null==m,b=1/e.fields.length*100;let g=c?100:u+1.285*m;g>100&&(g=100);const f=s.round([b,g],{strictBounds:!0}),h=new t({valueExpression:a.valueExpression,stops:[new o({value:f[0],opacity:.15}),new o({value:f[1],opacity:1})],legendOptions:new p({title:i.strengthOfPredominance})}),v=new l({type:"opacity",minSliderValue:d.min,maxSliderValue:d.max});return{visualVariable:h,statistics:d,defaultValuesUsed:c,authoringInfo:new r({visualVariables:[v]})}}e.createRenderer=async function(e){const i=await w(e),l=i.layer,s=(await V({basemap:i.basemap,geometryType:l.geometryType,numColors:i.fields.length,predominanceScheme:i.predominanceScheme,worldScale:!!i.symbolType?.includes("3d-volumetric"),view:i.view})).scheme,t=i.fields.map(e=>e.name),o=g.getPredominanceExpressions(l,t),p=async function(e,i,l,s){const t=await n.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),o=e.layer,{view:p,filter:u,signal:c}=e,[g,f]=await Promise.all([b({layer:o,fields:s,view:p,filter:u,signal:c}),e.outlineOptimizationEnabled?d({layer:o,view:p,filter:u,signal:c}).catch(y.errorCallback):null]);let h=g;g?.predominantCategoryInfos||(h={predominantCategoryInfos:s.map(e=>({value:e,count:0}))});const v=f?.opacity,w=await m.createRenderer({layer:o,basemap:e.basemap,valueExpression:i.valueExpression,valueExpressionTitle:t.predominantCategory,numTypes:-1,defaultSymbolEnabled:e.defaultSymbolEnabled,sortBy:e.sortBy,typeScheme:l,statistics:{uniqueValueInfos:h.predominantCategoryInfos},legendOptions:e.legendOptions,outlineOptimizationEnabled:!1,sizeOptimizationEnabled:(!e.includeSizeVariable||!e.sizeOptimizationEnabled)&&e.sizeOptimizationEnabled,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,filter:e.filter,view:e.view,signal:e.signal}),{renderer:V,basemapId:z,basemapTheme:S,uniqueValueInfos:T,excludedUniqueValueInfos:E}=w,O=V.uniqueValueInfos??[],I={};for(const a of e.fields){const e=o.getField(a.name);I[e.name]=a.label||e&&e.alias||a.name}if(O.forEach((e,a)=>{const i=I[e.value];e.label=i,T[a].label=i}),e.includeSizeVariable){let i=o.geometryType,n=null;if("polygon"===i){const a=l.sizeScheme,r=a.background;V.backgroundFillSymbol=y.createSymbol(i,{type:e.symbolType,color:r.color,outline:y.getSymbolOutlineFromScheme(r,i,v)}),n=a.marker.size,i="point"}else n="polyline"===i?l.width:l.size;const r=a.createUniqueColors(l.colors,O.length);O.forEach((a,s)=>{const t=y.createSymbol(i,{type:e.symbolType,color:r[s],size:n,outline:y.getSymbolOutlineFromScheme(l,i,v),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}});a.symbol=t,T[s].symbol=t.clone()})}return f?.visualVariables.length&&(V.visualVariables=f.visualVariables.map(e=>e.clone())),V.authoringInfo=new r({type:"predominance",fields:[...s]}),{renderer:V,predominantCategoryInfos:T,excludedCategoryInfos:E,predominanceScheme:l,basemapId:z,basemapTheme:S}}(i,o.predominantCategory,s,t),u=i.includeSizeVariable?z(i,o.size,s.sizeScheme):null,c=i.includeOpacityVariable?S(i,o.opacity):null,[f,h,v]=await Promise.all([p,u,c]),T=[],E=[];if(h&&(Array.prototype.push.apply(T,h.visualVariables.map(e=>e.clone())),delete h.sizeScheme,f.size=h,Array.prototype.push.apply(E,h.authoringInfo.visualVariables.map(e=>e.clone()))),v&&(T.push(v.visualVariable.clone()),f.opacity=v,Array.prototype.push.apply(E,v.authoringInfo.visualVariables.map(e=>e.clone()))),T.length){const e=f.renderer.visualVariables||[];Array.prototype.push.apply(e,T),f.renderer.visualVariables=e,f.renderer.authoringInfo??=new r,f.renderer.authoringInfo.visualVariables=E}return f},e.regenerateRenderer=async function(e){const{creatorParameters:a,view:n,signal:r,filter:l,renderer:s}=await async function(e){const a="regenerate-predominance-renderer",n=e.includedParts?.includes("size-variable")??!0;await c.processRegenerateParams(e,a);const r=await c.getRendererToUpdate(e);if("predominance"!==c.getStyleType(r))throw new i(`${a}:invalid-parameters`,"Renderer is invalid");const{visualVariables:l}=r,{layer:s,forBinning:t,filter:o,view:p,signal:d}=e,u=c.hasOutlineVV(r),m=c.hasScaleDependentSizeVV(r),y=n&&l?.some(c.isSizeVV),b=l?.some(e=>"opacity"===e.type),g=r.authoringInfo,f=g?.fields?.map(e=>({name:e}));if(!f?.length)throw new i(`${a}:invalid-parameters`,"Fields are required");const h=await w({layer:s,fields:f,outlineOptimizationEnabled:u,sizeOptimizationEnabled:m,includeSizeVariable:y,includeOpacityVariable:b,forBinning:t,filter:o,view:p,signal:d});return{...e,creatorParameters:h,renderer:r}}(e),{layer:t,fields:o,outlineOptimizationEnabled:p,includeSizeVariable:u,includeOpacityVariable:m}=a,b=o.map(e=>e.name),f=g.getPredominanceExpressions(t,b),h=(await V({geometryType:t.geometryType,numColors:a.fields.length,view:a.view})).scheme,v=h&&"sizeScheme"in h?h.sizeScheme:null,[T,E,O]=await Promise.all([p?d({layer:t,view:n,signal:r,filter:l}).catch(y.errorCallback):null,u?z(a,f.size,v):null,m?S(a,f.opacity):null]);return c.spliceVisualVariables(s,T?.visualVariables,c.findOutlineVVIndex),c.spliceVisualVariables(s,E?.visualVariables,c.findSizeVVIndex),c.spliceVisualVariables(s,O?.visualVariable,c.findOpacityVVIndex),c.updateAuthoringInfoVisualVariable(s,E?.authoringInfo,"size"),c.updateAuthoringInfoVisualVariable(s,O?.authoringInfo,"opacity"),{renderer:s}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});