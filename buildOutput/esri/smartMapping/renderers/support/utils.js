// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../Color","../../../intl","../../../core/Collection","../../../core/has","../../../core/Error","../../../intl/date","../../../renderers/support/numberUtils","../../../renderers/support/pointCloud/PointSizeSplatAlgorithm","../../heuristics/outline","../../statistics/classBreaks","../../statistics/summaryStatistics","../../statistics/support/ageUtils","../../support/utils","../../../symbols/ExtrudeSymbol3DLayer","../../../symbols/FillSymbol3DLayer","../../../symbols/IconSymbol3DLayer","../../../symbols/LineSymbol3D","../../../symbols/LineSymbol3DLayer","../../../symbols/MeshSymbol3D","../../../symbols/ObjectSymbol3DLayer","../../../symbols/PathSymbol3DLayer","../../../symbols/PointSymbol3D","../../../symbols/PolygonSymbol3D","../../../symbols/SimpleFillSymbol","../../../symbols/SimpleLineSymbol","../../../symbols/SimpleMarkerSymbol","../../../symbols/edges/SketchEdges3D","../../../symbols/edges/SolidEdges3D","../../../time/timeZoneUtils","../../../views/support/colorUtils","../../../intl/messages","../../../intl/substitute"],function(e,t,n,i,l,o,s,a,r,u,m,c,d,f,y,p,g,b,h,w,S,D,v,T,x,z,V,F,B,U,k,L,A){"use strict";const I=/^(\d+(\.\d+)?)\s*(%)$/i,M=new t([0,0,0,.4]),C=new Set(["hours","minutes","seconds"]),Z=[...f.defaultBasemapGroups.light,...f.defaultBasemapGroups.dark];function E(e,t,n,i){if("string"==typeof e){const t=n.getField(e);if(t&&f.isAnyDateField(t))return t.alias||t.name}else if("number"==typeof e||e instanceof Date){const l=null!=t&&C.has(t),o=l?"short-date-short-time":"short-date",a=s.convertDateFormatToIntlOptions(o);if(i&&l){const t=n.layer,{timeZone:l}=U.getTimeZoneFormattingOptions("preferredTimeZone"in t?t.preferredTimeZone:null,"datesInUnknownTimezone"in t&&t.datesInUnknownTimezone,i.timeZone,a,"date");return s.formatDate(e,{...a,timeZone:l,timeZoneName:U.shortTimeZoneName})}return s.formatDate(e,a)}return e}function P(e,t,n){return e+t>0&&0>e-t&&n<0?0:e}function R(e,t,n){let i,l;const o=function(e){let t,n,i=e&&e.statistics;if(i||(i={}),null==i.min)if(e.isDate){const e=O();t=e[0],n=e[1]}else t=0,n=100;else if(i.min===i.max)if(e.isDate){const e=O(i.min);t=e[0],n=e[1]}else i.min<0?(t=2*i.min,n=0):i.min>0?(t=0,n=2*i.min):(t=0,n=100);return{min:null!=t?t:i.min,max:null!=n?n:i.max,defaultValuesUsed:null!=t||null!=n}}({statistics:e,isDate:t});return o.defaultValuesUsed?(i=o.min,l=o.max):!n||null!=e.avg&&e.stddev||(i=e.min,l=e.max),null!=i&&null!=l?[i,l]:null}function O(e){const t=("number"==typeof e?new Date(e):new Date).getUTCFullYear();let n=Date.UTC(t,0,1,12,0,0,0),i=Date.UTC(t,11,31,12,0,0,0);return"number"==typeof e&&(e<n&&(n=e),e>i&&(i=e)),[n,i]}function j(e,t,n){const i=(t-e)/(n-1),l=[e];for(let t=1;t<=n-2;t++)l.push(e+t*i);return l.push(t),a.round(l,{strictBounds:!0})}function G({min:e,max:t,avg:n,stddev:i},l=!0){if(null==e||null==t||null==n||null==i)return[];let o=n-i,s=n+i;o<e&&(o=e),s>t&&(s=t),l&&(n=o+(s-o)/2);let r=a.round([o,s],{strictBounds:!0});return o=r[0],s=r[1],r=[o,o+(n-o)/2,n,n+(s-n)/2,s],a.round(r,{strictBounds:!0})}function N(e){const t=e.name?.toLowerCase();if(!t||t?.includes(":insufficient-info")||t?.includes(":insufficient-data"))return null;throw e}e.clampAboveAndBelowStopValues=function(e,t){const{min:n,max:i}=t,[l,o,s,r,u]=e,m=null!=n&&l<n,c=null!=i&&u>i;if(null==n||null==i||!m&&!c)return e;const d=m?n:l,f=m?d+(s-d)/2:o,y=c?i:u,p=c?s+(y-s)/2:r;return a.round([d,f,s,p,y],{strictBounds:!0})},e.createDataValues=function({minDataValue:e,maxDataValue:t,defaultValuesUsed:n},i,l,o=!0){return n||"above"===l||"below"===l?j(e,t,5):G(i,o)},e.createDefaultStopValues=j,e.createStopValues=G,e.createStopValuesForAboveBelow=function(e,t){const{avg:n,stddev:i}=e,l=e.min,o=e.max;if(null==n||null==i){const[n,i]=R(e,t,!0);return j(n,i,5)}const s=P(n,i,l),r=o-s,u=s-l,m=Math.max(r,u),c=s+m,d=s-m,f=s-m/2,y=m/2+s;return a.round([d,f,s,y,c],{strictBounds:!0})},e.createSymbol=function(e,t){const{type:n,size:l,color:o,outline:s}=t;let a;switch(e){case"point":case"multipoint":if("2d"===n)a=new V({color:o,size:l,outline:{color:s.color,width:s.width}});else if("3d-flat"===n)a=new v({symbolLayers:new i([new g({size:l,resource:{primitive:"circle"},material:{color:o},outline:{color:s.color,size:s.width}})])});else if(n?.includes("3d-volumetric")){const e="3d-volumetric-uniform"===n,s=new S({height:l,resource:{primitive:e?"sphere":"cylinder"},material:{color:o}});e||(s.width=t.widthAndDepth,s.depth=t.widthAndDepth),a=new v({symbolLayers:new i([s])})}break;case"polyline":"2d"===n?a=new z({color:o,width:l}):"3d-flat"===n?a=new b({symbolLayers:new i([new h({size:l,material:{color:o}})])}):"3d-volumetric"===n&&(a=new b({symbolLayers:new i([new D({width:"number"==typeof l?l:parseFloat(l),height:"number"==typeof l?l:parseFloat(l),material:{color:o}})])}));break;case"polygon":"2d"===n?a=new x({color:o,outline:{color:s.color,width:s.width}}):"3d-flat"===n?a=new T({symbolLayers:new i([new p({material:{color:o},outline:{color:s.color,size:s.width}})])}):"3d-volumetric"===n&&(a=new T({symbolLayers:new i([new y({size:l,material:{color:o}})])}));break;case"mesh":{const e=t.meshInfo?.colorMixMode,n=t.meshInfo?.edgesType;a=new w({symbolLayers:new i([new p({material:{color:o,colorMixMode:e||null},edges:"solid"===n?new B({color:M}):"sketch"===n?new F({color:M}):null})])});break}}return a},e.errorCallback=N,e.formatDate=E,e.getBaseValueForAboveBelow=P,e.getBasemapInfo=async function(e,t){let n=null,i=null;if(!e&&!t)return{basemapId:n,basemapTheme:i};if(t&&(i=await k.getBackgroundColorTheme(t),e||(e=t.map?.basemap)),e&&(n=f.getBasemapId(e,Z,!1),n&&!i)){const e=f.getBasemapGroup(n);null!=e&&(i=e)}return!n&&i&&(n="dark"===i?"dark-gray":"gray"),{basemapId:n,basemapTheme:i}},e.getClassBreaks=async function(e,t){const n={layer:e.layer,view:e.view,filter:e.filter,signal:e.signal},[i,l]=await Promise.all([m(e).catch(N),t?u(n).catch(N):null]),o=R({min:i?.minValue,max:i?.maxValue,avg:null,stddev:null},!1,!1);return{result:o?await m({...e,classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:o[0],maxValue:o[1],normalizationTotal:o[0]+o[1]}):i,defaultValuesUsed:!!o,outlineResult:l}},e.getDataRange=function(e,t,n,i){const{avg:l,stddev:o,min:s,max:a}=e,r=R(e,!!n,i??!0);let u=r?r[0]:s,m=r?r[1]:a;return r?{minDataValue:u,maxDataValue:m,defaultValuesUsed:!0}:("above"===t?u=P(l,o,s):"below"===t&&(m=P(l,o,s)),{minDataValue:u,maxDataValue:m,defaultValuesUsed:!1})},e.getDefaultDataRange=R,e.getPointSizeAlgorithm=function(e){if(null==e)return;const t=e.match(I),n=Number(t[1]);return"%"===t[3]?new r({scaleFactor:n/100}):void 0},e.getSizeRangeForAxis=function(e,t){let{minSize:n,maxSize:i}=e;return"height"===t&&(n=((i-n)/2+n)/4.6,i*=2),{minSize:n,maxSize:i}},e.getSummaryStatistics=function(e){return c({outStatisticTypes:f.defaultStatisticTypes,...e})},e.getSymbolOutlineFromScheme=function(e,t,n){switch(t){case"point":case"multipoint":case"polygon":{if(!("outline"in e))return null;const t={color:e.outline.color,width:e.outline.width};if(null!=n&&t.color){const e=t.color.clone();e.a=n,t.color=e}return t}default:return}},e.getSymbolSizeFromScheme=function(e,t,n){switch(t){case"point":case"multipoint":return n?"noDataSize"in e?e.noDataSize:null:"size"in e?e.size:null;case"polyline":return n?"noDataWidth"in e?e.noDataWidth:null:"width"in e?e.width:null;case"polygon":return"size"in e?e.size:null;default:return}},e.getTitleAndExpressionForAgeRenderer=async function(e,t){const{layer:n,startTime:i,endTime:l,view:o}=e,s=d.getAgeExpressions({layer:n,startTime:i,endTime:l,unit:t}).valueExpression,a=await L.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");return{valueExpression:s,title:A.substitute(a[`ageInfo_${t}`],{unit:t,startTime:E(i,t,n,o),endTime:E(l,t,n,o)})}},e.isValidPointSize=function(e){return I.test(e)},e.updateAgeRendererAuthoringInfoVV=function(e,t,n,i){e.startTime=t instanceof Date?t.getTime():t,e.endTime=n instanceof Date?n.getTime():n,e.units=i,e.field="string"==typeof t?t:"string"==typeof n?n:null},e.verifyBasicFieldValidity=function(e,t,n){const i=function(e){const t=e.layer;return e.fields.filter(e=>!t.getField(e))}({layer:e,fields:t});if(i.length)return new o(n,"Unknown fields: "+i.join(", ")+". You can only use fields defined in the layer schema");const l=function(e){const t=e.layer;return e.fields.filter(e=>{const n=t.getFieldUsageInfo(e);return!n||!n.supportsRenderer})}({layer:e,fields:t});return l.length?new o(n,"Unsupported fields: "+l.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});