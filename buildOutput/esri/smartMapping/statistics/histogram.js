// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../core/Error","../../layers/support/fieldUtils","./support/utils","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils"],function(i,e,a,s,r,t){"use strict";const n=[...r.dateTypes,"time-only",...e.numericTypes];return async function(l){const{layerAdapter:o,...p}=await async function(l){if(!l?.layer||!(l.field||l.valueExpression||l.sqlExpression))throw new i("histogram:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(l.valueExpression&&!l.sqlExpression&&!l.view)throw new i("histogram:missing-parameters","View is required when 'valueExpression' is specified");l.forBinning&&s.verifyBinningParams(l,"histogram");const{layer:o,...p}=l,d=[...t.defaultSupportedLayerTypes,5],f=l.forBinning?t.binningCapableLayerTypes:d,u=t.createLayerAdapter(o,f,l.forBinning);if(!u)throw new i("histogram:invalid-parameters","'layer' must be one of these types: "+t.getLayerTypeLabels(f).join(", "));const m={layerAdapter:u,...p};m.normalizationType=r.getNormalizationType(m);const h=null!=m.signal?{signal:m.signal}:null;await u.load(h);const y=m.valueExpression||m.sqlExpression,c=m.field,w=c?u.getField(c):null,g=!m.classificationMethod||"equal-interval"===m.classificationMethod,v=await r.getFieldsList({field:c,normalizationField:m.normalizationField,valueExpression:m.valueExpression}),E=a.verifyBasicFieldValidity(u,v,"histogram:invalid-parameters");if(E)throw E;if(w){const s=a.verifyFieldType(u,w,"histogram:invalid-parameters",n);if(s)throw s;if(r.isAnyDateField(w)||e.isTimeOnlyField(w)){if(m.normalizationType)throw new i("histogram:invalid-parameters","Normalization is not allowed for date fields");if(!g)throw new i("histogram:invalid-parameters","'classificationMethod' other than 'equal-interval' is not allowed for date fields")}}else if(y){if(m.normalizationType)throw new i("histogram:invalid-parameters","Normalization is not allowed when 'valueExpression' or 'sqlExpression' is specified");if(!g)throw new i("histogram:invalid-parameters","'classificationMethod' other than 'equal-interval' is not allowed when 'valueExpression' or 'sqlExpression' is specified")}m.filter&&!m.filter.spatialRelationship&&(m.filter.spatialRelationship="intersects");const x=a.verifyFilterValidity(m.filter,"histogram:invalid-parameters");if(x)throw x;return null==m.useQueryAttributeBins&&(m.useQueryAttributeBins=!0),m}(l);return o.histogram(p)}});