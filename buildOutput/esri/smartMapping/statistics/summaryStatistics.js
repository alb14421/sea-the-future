// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../core/Error","../../layers/support/fieldUtils","./support/utils","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils"],function(i,e,s,t,a,r){"use strict";const n=[...e.numericTypes,...a.dateTypes,"time-only","string"];return async function(l){const{layerAdapter:o,...p}=await async function(l){if(!l?.layer||!(l.field||l.valueExpression||l.sqlExpression))throw new i("summary-statistics:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(l.valueExpression&&!l.sqlExpression&&!l.view)throw new i("summary-statistics:missing-parameters","View is required when 'valueExpression' is specified");l.forBinning&&t.verifyBinningParams(l,"summary-statistics");const{layer:o,...p}=l,m=[...r.defaultSupportedLayerTypes,5],y=l.forBinning?r.binningCapableLayerTypes:m,u=r.createLayerAdapter(o,y,l.forBinning);if(!u)throw new i("summary-statistics:invalid-parameters","'layer' must be one of these types: "+r.getLayerTypeLabels(y).join(", "));const d={layerAdapter:u,...p};d.normalizationType=a.getNormalizationType(d);const f=null!=d.signal?{signal:d.signal}:null;await u.load(f);const c=d.field,w=d.normalizationType,v=d.valueExpression||d.sqlExpression,g=c?u.getField(c):null,E=await a.getFieldsList({field:d.field,normalizationField:d.normalizationField,valueExpression:d.valueExpression}),h=s.verifyBasicFieldValidity(u,E,"summary-statistics:invalid-parameters");if(h)throw h;if(g){const t=s.verifyFieldType(u,g,"summary-statistics:invalid-parameters",n);if(t)throw t;if((a.isAnyDateField(g)||e.isTimeOnlyField(g))&&w)throw new i("summary-statistics:invalid-parameters","Normalization is not allowed for date fields")}else if(v&&w)throw new i("summary-statistics:invalid-parameters","Normalization is not allowed when 'valueExpression' or 'sqlExpression' is specified");d.filter&&!d.filter.spatialRelationship&&(d.filter.spatialRelationship="intersects");const x=s.verifyFilterValidity(d.filter,"summary-statistics:invalid-parameters");if(x)throw x;return d}(l);return o.summaryStatistics(p)}});