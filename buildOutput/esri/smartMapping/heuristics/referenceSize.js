// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../core/Error","../../core/screenUtils","../../geometry/support/extentUtils","../statistics/spatialStatistics","../support/binningUtils","../support/adapters/support/layerUtils"],function(e,t,n,i,r,s){"use strict";function a(e){let t=0;for(const n of e)t+=n;return t/e.length}function o(e,t){const n=t??a(e),i=e.reduce((e,t)=>e+(t-n)**2,0);return Math.sqrt(i/e.length)}return async function(c){const f=await async function(t){const{view:n}=t;if(!(t&&n&&t.layer))throw new e("reference-size:missing-parameters","'view' and 'layer' parameters are required");t.forBinning&&r.verifyBinningParams(t,"reference-size");const{layer:i,...a}=t,o=t.forBinning?s.binningCapableLayerTypes:s.featureCapableLayerTypes,c=s.createLayerAdapter(i,o,t.forBinning);if(!c)throw new e("reference-size:invalid-parameters","'reference-size' must be one of these types: "+s.getLayerTypeLabels(o).join(", "));const f={layerAdapter:c,...a,view:n};await n.when();const u=null!=f.signal?{signal:f.signal}:null;if(await c.load(u),!t.forBinning&&"polygon"!==c.geometryType)throw new e("reference-size:not-supported",`reference-size is not supported for geometryType: ${c.geometryType}`);return f}(c),u=await f.layerAdapter.getSampleFeatures({sampleSize:-1,returnGeometry:!0,...f},"json");if(!u?.length)throw new e("reference-size:insufficient-info","No features are available to calculate statistics");return async function(r,s){const{view:c}=s;if(s.forBinning){const i=r[Math.floor(r.length/2)].geometry,s=n.getGeometryExtent(i);if(!s)throw new e("reference-size:insufficient-info","Extent is invalid");const a=Math.abs(s.xmax-s.xmin),o=Math.abs(s.ymax-s.ymin),f=Math.min(a,o);return{size:t.px2pt(f/c.resolution),isGrid:!0}}const{isGrid:f,avgSize:u}=await async function(t,r){const s=await i({features:t,geometryType:r});if(!(s&&"avgSize"in s&&s.avgSize))throw new e("reference-size:insufficient-info","average polygon size is invalid");const c=s.avgSize,f=[],u=[];for(const e of t){const t=n.getGeometryExtent(e.geometry);if(!t){f.push(0),u.push(0);continue}const i=Math.abs(t.xmax-t.xmin),r=Math.abs(t.ymax-t.ymin);f.push(i/r),u.push(Math.sqrt(i*r))}const p=Number(a(f).toFixed(2)),l=Number(o(f,p).toFixed(2)),y=o(u),g=Number((y/c).toFixed(2));return{isGrid:l<=.1&&p>=.75&&p<=1.25&&g<=.1,avgSize:c}}(r,s.layerAdapter.geometryType),p=f?.9*u:.75*u;return{size:t.px2pt(p/c.resolution),isGrid:f}}(u,f)}});