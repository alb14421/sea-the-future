// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../Graphic","../../../core/arrayUtils","../../../core/Error","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../layers/support/arcgisLayerUrl","../../../layers/support/fieldUtils","../../../rest/generateRenderer","../../../rest/support/GenerateRendererParameters","../../../rest/support/StatisticDefinition","../../../rest/support/UniqueValueDefinition","../../statistics/support/predominanceUtils","../../statistics/support/utils","../../statistics/support/WorkerClient","../utils","./InMemoryLayerAdapter","./support/histogramUtils","./support/utils","../../../statistics/utils","../../../views/2d/viewpointUtils"],function(e,t,r,i,s,a,n,o,l,u,c,h,m,d,p,y,f,F,g,S,w,v,x,_,E){"use strict";return e.default=class extends w{constructor(){super(...arguments),this.adapterName="feature-layer-adapter"}_isStatsSupportedOnService(){const e=this.layer;if(!e.capabilities?.query?.supportsStatistics||"multipatch"===this.geometryType&&!c.isHostedAgolService(e.url)&&e.version<10.5)throw new s(`${this.adapterName}:not-supported`,"Layer does not support statistics query");return Promise.resolve()}_fetchFeaturesFromService(e,t){return this.layer.queryFeatures(e,{signal:t}).then(e=>e.features)}_fetchFeaturesJSONFromService(e,t){return this._fetchFeaturesFromService(e,t).then(x.ensureFeaturesJSON)}_summaryStatsFromGenRend(e){const t=e.normalizationType,r=e.normalizationField;return this.classBreaks({field:e.field,numClasses:5,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:t,normalizationField:"field"===t?r:void 0,minValue:e.minValue,maxValue:e.maxValue,filter:e.filter,signal:e.signal}).then(t=>{let r,i,s;if(t.classBreakInfos?.some(e=>(e.hasAvg&&(r=e),!!r)),r){const e=r.maxValue-r.minValue;i=r.minValue+e/2,s=4*e}const a={min:t.minValue,max:t.maxValue,avg:i,stddev:s};return _.processSummaryStatisticsResult(a,e.outStatisticTypes)})}async _summaryStatsFromServiceQuery(e,t){await this._isStatsSupportedOnService(),"percent-of-total"===e.normalizationType&&(e.normalizationTotal=await this._getNormalizationTotal(e.field,e.normalizationType,e.filter));const r=S.isAnyDateField(t)||h.isTimeOnlyField(t),i="capabilities"in this.layer?this.layer.capabilities:null,s=i?.query?.supportsPercentileStatistics??!1,a=x.getSummaryStatsQuery(this,e,t,s),n=await this.layer.queryFeatures(a,{signal:e.signal}),o=x.getSummaryStatisticsFromFeatureSet(n,r);return _.processSummaryStatisticsResult(o,e.outStatisticTypes)}_uvFromGenRenderer(e,t){const r=e.field??void 0,i=new y({attributeField:r}),s=new d({classificationDefinition:i});return this.generateRenderer(s,e.signal).then(e=>{const t={},i=this.getField(r);return e.uniqueValues.forEach(e=>{let r=e.value;null!=r&&""!==r&&("string"!=typeof r||""!==r.trim()&&"<null>"!==r.toLowerCase())||(r=null),null==t[r]?t[r]={count:e.count,data:h.isNumericField(i)&&r?Number(r):r}:t[r].count=t[r].count+e.count}),{count:t}}).then(r=>_.createUVResult(r,[t],e.returnAllCodedValues))}async _uvFromServiceQuery(e,t){return this._isStatsSupportedOnService().then(()=>this.layer.queryFeatures(x.getUVQuery(this,e),{signal:e.signal})).then(t=>x.getUniqueValuesFromFeatureSet(t,{layer:this,field:e.field,field2:e.field2,field3:e.field3,fieldDelimiter:S.fieldDelimiter,view:e.view,signal:e.signal})).then(r=>_.createUVResult(r,t,e.returnAllCodedValues,S.fieldDelimiter))}_getNormalizationTotal(e,t,r,i){return e&&"percent-of-total"===t?this.summaryStatistics({field:e,outStatisticTypes:{include:["sum"]},filter:r,signal:i}).then(e=>e.sum):Promise.resolve(null)}_histogramForExpr(e){return this._getNormalizationTotal(e.field,e.normalizationType,e.filter,e.signal).then(t=>{const r=v.getQueryParamsForExpr(e,this,t);return v.getDataRange(r,this,e.minValue,e.maxValue).then(i=>{const s=i.min,a=i.max;if(null==s||null==a)return{bins:[],minValue:s,maxValue:a,normalizationTotal:t};const n=e.numBins||x.defaultNumBins,o=_.getEqualIntervalBins(s,a,n),l=function(e,t,r){const i=[],s=t.length;return t.forEach((t,a)=>{const[n,o]=t;let l=null;l=0!==a||r?a!==s-1||r?F.mergeWhereClauses(`${e} >= ${n}`,`${e} ${a===s-1?" <= ":" < "} ${o}`):`${e} >= ${n}`:`${e} < ${o}`,i.push("WHEN ("+l+") THEN "+(a+1))}),["CASE",i.join(" "),"ELSE 0","END"].join(" ")}(r.sqlExpression,o,null!=e.minValue&&null!=e.maxValue),u=new p({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"1"}),c=this.layer.createQuery();return c.where=F.mergeWhereClauses(c.where,r.sqlWhere),c.sqlFormat="standard",c.outStatistics=[u],c.groupByFieldsForStatistics=[l],c.orderByFields=[l],x.updateQueryWithFeatureFilter(c,e.filter),this._isStatsSupportedOnService().then(()=>this.layer.queryFeatures(c,{signal:r.signal})).then(e=>x.getHistogramFromFeatureSet(e,s,a,n,t))})})}async _histogramFromQueryAttributeBins(e){const{field:t,normalizationType:r,filter:i,signal:s}=e,a=await this._getNormalizationTotal(t,r,i,s),n=this.layer.createQuery(),{query:o,min:l,max:u}=await v.getAttributeBinsQuery(e,this,a,n?.where);if(!o)return{bins:[],minValue:l,maxValue:u,normalizationTotal:a};const c=await this.layer.queryAttributeBins(o,{signal:s});return v.processQueryAttributeBinsResult(c,t?this.getField(t):null,{minValue:l,maxValue:u,normalizationTotal:a})}_classBreaksFromGenRend(e){const{field:t,normalizationType:r,normalizationField:i,normalizationTotal:s,signal:a}=e,n=F.getSQLFilterForNormalization({field:t,normalizationType:r,normalizationField:i}),o=x.getFieldExpr({field:t,normalizationType:r,normalizationField:i,normalizationTotal:s,layer:this}),l=F.getRangeExpr(o,e.minValue,e.maxValue),u=_.createClassBreaksDefinition({field:t,normalizationType:r,normalizationField:i,classificationMethod:e.classificationMethod,standardDeviationInterval:e.standardDeviationInterval,breakCount:e.numClasses||5}),c=new d({classificationDefinition:u});return c.where=F.mergeWhereClauses(n,l),this.generateRenderer(c,a).then(t=>_.resolveCBResult(t,e.classificationMethod))}async summaryStatistics(e){const{field:t,normalizationType:r,valueExpression:i,sqlExpression:n,view:o,features:l,useFeaturesInView:u}=e,c=t?this.getField(t):null,m=S.isAnyDateField(c)||h.isTimeOnlyField(c),d=i&&!(n&&this.supportsSQLExpression),p=this._hasLocalSource||l||u,y=o&&"3d"===o.type;if(p||d)return d||l||u||y?this._summaryStatsFromMemory(e,c):this._summaryStatsFromClientQuery(e,c);if(!this.supportsSQLExpression&&(m||n||"natural-log"===r||"square-root"===r))throw new s(`${this.adapterName}:not-supported`,"Layer does not support standardized SQL expression for queries");return(r&&!this.supportsSQLExpression?this._summaryStatsFromGenRend(e):this._summaryStatsFromServiceQuery(e,c)).catch(()=>(a.throwIfAborted(e.signal),this._summaryStatsFromMemory(e,c)))}async uniqueValues(e){const{valueExpression:t,sqlExpression:r,features:i,useFeaturesInView:s,signal:n}=e,o=t&&!(r&&this.supportsSQLExpression),l=this._hasLocalSource||i||s||o,u=e.view,c=u&&"3d"===u.type,h=await x.getDomainsForFields(e,this);return l?o||i||s||c?this._uvFromMemory(e,h):this._uvFromClientQuery(e,h):this._uvFromServiceQuery(e,h).catch(t=>(a.throwIfAborted(n),!e.field||e.field2||e.field3||e.filter?t:this._uvFromGenRenderer(e,h[0]))).catch(()=>(a.throwIfAborted(n),c?this._uvFromMemory(e,h):this._uvFromClientQuery(e,h)))}async histogram(e){const{field:t,normalizationType:r,normalizationField:i,classificationMethod:n,view:o,filter:l,signal:u}=e,c=t?this.getField(t):null,m=S.isAnyDateField(c)||h.isTimeOnlyField(c),d=e.valueExpression||e.sqlExpression,p=e.valueExpression&&!(e.sqlExpression&&this.supportsSQLExpression),y=this._hasLocalSource||e.features||e.useFeaturesInView||p,f=this.supportsSQLExpression,g=!n||"equal-interval"===n,w=e.minValue,_=e.maxValue,E=null!=w&&null!=_,V=e.numBins||x.defaultNumBins;if(y)return this._histogramFromMemory(e);if(this.layer.capabilities?.operations?.supportsQueryBins&&e.useQueryAttributeBins)try{return await this._histogramFromQueryAttributeBins(e)}catch{return a.throwIfAborted(u),this._histogramFromQueryAttributeBinsFromMemory(e)}if((d||f)&&g){if(!f&&(d||"natural-log"===r||"square-root"===r))throw new s(`${this.adapterName}:not-supported`,"Layer does not support standardized SQL expression for queries");return this._histogramForExpr(e)}if(m&&g)throw new s(`${this.adapterName}:not-supported`,"Normalization and date field are not allowed when layer does not support standardized SQL expression for queries");return r||!g?v.binParamsFromGenRend(e,this).then(a=>{if(!E)return x.getBins(this,a,t,V,o,l,u);if(w>a.max||_<a.min)throw new s(`${this.adapterName}:insufficient-data`,"Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field");if(g)return x.getBins(this,{min:w,max:_,sqlExpr:a.sqlExpr,excludeZerosExpr:a.excludeZerosExpr},t,V,o,l,u);{const s={field:t,normalizationType:r,normalizationField:i,normalizationTotal:a.normTotal,layer:this},n=x.getFieldExpr(s),c=F.getRangeExpr(n,w,_);return v.binParamsFromGenRend(e,this,c).then(e=>x.getBins(this,e,t,V,o,l,u))}}):this._histogramForField(e)}async classBreaks(e){const t=!1!==e.analyzeData,r=this._hasLocalSource||e.features||e.useFeaturesInView||e.valueExpression||e.filter;return t&&r?this._classBreaksFromMemory(e):(t?this._classBreaksFromGenRend(e):this._classBreaksFromInterpolation(e)).catch(()=>(a.throwIfAborted(e.signal),this._classBreaksFromMemory(e)))}async queryFeatureCount(e){if(this._hasLocalSource)throw new s(`${this.adapterName}:not-supported`,"Layer does not support count query");const t=this.layer,r=t.createQuery();return r.where=F.mergeWhereClauses(r.where,e.whereClause),x.updateQueryWithFeatureFilter(r,e.filter),t.queryFeatureCount(r,{signal:e.signal})}async generateRenderer(e,t){const r=this.layer;if(this._hasLocalSource||r.version<10.1)throw new s(`${this.adapterName}:not-supported`,"Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)");const i=r.createQuery();return e.where=F.mergeWhereClauses(e.where,i.where),m.generateRenderer(r.parsedUrl?.path??"",{source:r.dynamicDataSource??void 0,gdbVersion:r.gdbVersion??void 0},e,{signal:t})}async predominantCategories(e){if(!this._hasLocalSource&&!this.supportsSQLExpression)throw new s(`${this.adapterName}:not-supported`,"Layer does not support advanced SQL expressions and standardized queries");const{fields:t,view:r,signal:i,filter:a}=e,n=f.getArcadeForPredominantCategory(t),o=f.getSQLForPredominantCategoryName(t),l=r&&this._hasLocalSource?await this._uvFromMemory({valueExpression:n,view:r,signal:i,filter:a}):await this._uvFromServiceQuery({sqlExpression:o.expression,valueExpression:n,signal:i,filter:a});return x.getPredominantCategoriesFromUVInfos(l.uniqueValueInfos,t)}async getSampleFeatures(e,t){const{view:s,requiredFields:n,returnGeometry:o,filter:l,signal:u}=e,c=e.sampleSize;if(null==c||0===c)return[];const h=this.layer.createQuery(),m="json"===t;h.outSpatialReference=s?.spatialReference,h.returnGeometry=!!o,h.outFields=n,x.updateQueryWithFeatureFilter(h,l);let d=[],p=!1;if(s)try{const a=await s.whenLayerView(this.layer);if(p=!x.getMissingFields(this,n,a).length,p){if(c>=1&&!e.filter&&"getSampleFeatures"in a){await this._waitForLayerViewUpdate(a);const e=await a.getSampleFeatures({minFeatureCount:c,sampleSize:c});if(null!=e)return m?e:e.map(e=>r.fromJSON(e))}if(d=await this._fetchFeaturesFromMemory(a,h,u,t),d.length>=c&&c>0)return i.pickRandom(d,c,1)}}catch(e){a.throwIfAborted(u)}try{if(this._hasLocalSource)return p?d:m?await this._fetchFeaturesJSONFromService(h,u):await this._fetchFeaturesFromService(h,u);const t=await this.queryFeatureCount({view:s,filter:l,signal:u}),r=this.layer.capabilities.query.maxRecordCount;let a=-1===c?t:c;if(a=r&&a>r?r:a,t<=d.length||d.length>=r)return d;if(h.maxAllowableOffset=e.resolution||4e5*(s?s.extent.width/s.width/s.scale:E.getScaleToResolutionFactor(this.layer.spatialReference)),t<=a)return m?await this._fetchFeaturesJSONFromService(h,u):await this._fetchFeaturesFromService(h,u);if(t<=2e4){const e=this.layer.createQuery();x.updateQueryWithFeatureFilter(e,l);const t=await this.layer.queryObjectIds();return h.objectIds=i.pickRandom(t,a,1),m?await this._fetchFeaturesJSONFromService(h,u):await this._fetchFeaturesFromService(h,u)}return this.layer.capabilities?.query?.supportsPagination&&(h.num=Math.min(a,2e4)),m?await this._fetchFeaturesJSONFromService(h,u):await this._fetchFeaturesFromService(h,u)}catch(e){return a.throwIfAborted(u),d}}load(e){const t=this.layer.load(e).then(async t=>{this.geometryType=t.geometryType,this.objectIdField=t.objectIdField,this.supportsSQLExpression=t.capabilities?.query?.supportsSqlExpression,this._hasLocalSource=!t.url&&!!t.source,this.hasQueryEngine=this._hasLocalSource,this.minScale=t.minScale,this.maxScale=t.maxScale,this.fullExtent=t.fullExtent,this.workerClient=g.WorkerClient.getInstance(),await this.workerClient.open(e.signal)});return this.addResolvingPromise(t),Promise.resolve(this)}},t.__decorate([n.property({readOnly:!0})],e.default.prototype,"adapterName",void 0),t.__decorate([n.property({constructOnly:!0})],e.default.prototype,"layer",void 0),e.default=t.__decorate([u.subclass("esri.smartMapping.support.adapters.FeatureLayerAdapter")],e.default),e.default});