// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["./bidiEngineTables"],function(t){"use strict";function r(t,a,i,u,s){const l=function(t,r,n){if(void 0===r.inFormat&&(r.inFormat=n.defInFormat),void 0===r.outFormat&&(r.outFormat=n.defOutFormat),void 0===r.swap&&(r.swap=n.defSwap),r.inFormat===r.outFormat)return r;const a=r.inFormat.slice(0,1),i=r.outFormat.slice(0,1);let o,u=r.inFormat.slice(1,4),s=r.outFormat.slice(1,4);return u.startsWith("C")&&(o=e(t),u="ltr"===o||"rtl"===o?o.toUpperCase():"L"===r.inFormat.charAt(2)?"LTR":"RTL",r.inFormat=a+u),s.startsWith("C")&&(o=e(t),"rtl"===o?s="RTL":"ltr"===o?(o=function(t){const r=t.split("");return r.reverse(),e(r.join(""))}(t),s=o.toUpperCase()):s="L"===r.outFormat.charAt(2)?"LTR":"RTL",r.outFormat=i+s),r}(t,{inFormat:a,outFormat:i,swap:u},s);if(l.inFormat===l.outFormat)return t;a=l.inFormat,i=l.outFormat,u=l.swap;const f=a.slice(0,1),c=a.slice(1,4),b=i.slice(0,1),h=i.slice(1,4);if(s.inFormat=a,s.outFormat=i,s.swap=u,"L"===f&&"VLTR"===i){if("LTR"===c)return s.dir=_,n(t,s);if("RTL"===c)return s.dir=v,n(t,s)}if("V"===f&&"V"===b)return s.dir="RTL"===c?v:_,o(t,s);if("L"===f&&"VRTL"===i)return"LTR"===c?(s.dir=_,t=n(t,s)):(s.dir=v,t=n(t,s)),o(t);if("VLTR"===a&&"LLTR"===i)return s.dir=_,n(t,s);if("V"===f&&"L"===b&&c!==h)return t=o(t),"RTL"===c?r(t,"LLTR","VLTR",u,s):r(t,"LRTL","VRTL",u,s);if("VRTL"===a&&"LRTL"===i)return r(t,"LRTL","VRTL",u,s);if("L"===f&&"L"===b){const e=s.swap;return s.swap=e.slice(0,1)+"N","RTL"===c?(s.dir=v,t=n(t,s),s.swap="N"+e.slice(1,3),s.dir=_,t=n(t,s)):(s.dir=_,t=n(t,s),s.swap="N"+e.slice(1,3),t=r(t,"VLTR","LRTL",s.swap,s)),t}return t}function e(t){const r=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(t);return r?r[0]<="z"?"ltr":"rtl":""}function n(t,r){const e=t.split(""),n=[];return a(e,n,r),function(t,r,e){if(0!==e.hiLevel&&e.swap[0]!==e.swap[1])for(let e=0;e<t.length;e++)1===r[e]&&(t[e]=h(t[e]))}(e,n,r),c(2,e,n,r),c(1,e,n,r),U=n,e.join("")}function a(r,e,n){const a=r.length,o=n.dir?t.impTabRtl:t.impTabLtr;let u=0,s=-1;const l=[],f=[];n.hiLevel=n.dir,n.lastArabic=!1,n.hasUbatAl=!1,n.hasUbatB=!1,n.hasUbatS=!1;for(let t=0;t<a;t++)l[t]=i(r[t]);for(let i=0;i<a;i++){const a=u,c=b(r,l,f,i,n);f[i]=c,u=o[a][c];const h=240&u;u&=15;const T=o[u][S];if(e[i]=T,h>0)if(16===h){for(let t=s;t<i;t++)e[t]=1;s=-1}else s=-1;if(o[u][E])-1===s&&(s=i);else if(s>-1){for(let t=s;t<i;t++)e[t]=T;s=-1}l[i]===t.ubatB&&(e[i]=0),n.hiLevel|=T}n.hasUbatS&&function(r,e,n,a){for(let i=0;i<n;i++)if(r[i]===t.ubatS){e[i]=a.dir;for(let n=i-1;n>=0&&r[n]===t.ubatWs;n--)e[n]=a.dir}}(l,e,a,n)}function i(r){const e=r.charCodeAt(0),n=t.primaryTable[e>>8];return n<t.tbbase?n:t.unicodeTable[n-t.tbbase][255&e]}function o(t,r){const e=t.split("");if(r){const t=[];a(e,t,r),U=t}return e.reverse(),R.reverse(),e.join("")}function u(t,r,e){for(let n=0;n<r;n++)if(t[n]===e)return n;return-1}function s(r){for(let e=0;e<t.arabicAlefBetIntervalsBegine.length;e++)if(r>=t.arabicAlefBetIntervalsBegine[e]&&r<=t.arabicAlefBetIntervalsEnd[e])return!0;return!1}function l(t,r,e,n){for(;r*e<n&&m(t[r]);)r+=e;return!!(r*e<n&&s(t[r]))}function f(r,e,n,a){for(;e*n<a&&m(r[e]);)e+=n;let i=" ";if(!(e*n<a))return!1;i=r[e];for(let r=0;r<t.aLefTable.length;r++)if(t.aLefTable[r]===i)return!0;return!1}function c(t,r,e,n){if(n.hiLevel<t)return;if(1===t&&n.dir===v&&!n.hasUbatB)return r.reverse(),void R.reverse();const a=r.length;let i,o,u,s,l,f=0;for(;f<a;){if(e[f]>=t){for(i=f+1;i<a&&e[i]>=t;)i++;for(o=f,u=i-1;o<u;o++,u--)s=r[o],r[o]=r[u],r[u]=s,l=R[o],R[o]=R[u],R[u]=l;f=i}f++}}function b(r,e,n,a,i){const o=e[a];return{UBAT_L:()=>(i.lastArabic=!1,t.ubatL),UBAT_R:()=>(i.lastArabic=!1,t.ubatR),UBAT_ON:()=>t.ubatOn,UBAT_AN:()=>t.ubatAn,UBAT_EN:()=>i.lastArabic?t.ubatAn:t.ubatEn,UBAT_AL:()=>(i.lastArabic=!0,i.hasUbatAl=!0,t.ubatR),UBAT_WS:()=>t.ubatOn,UBAT_CS:()=>{let r,o;return a<1||a+1>=e.length||(r=n[a-1])!==t.ubatEn&&r!==t.ubatAn||(o=e[a+1])!==t.ubatEn&&o!==t.ubatAn?t.ubatOn:(i.lastArabic&&(o=t.ubatAn),o===r?o:t.ubatOn)},UBAT_ES:()=>(a>0?n[a-1]:t.ubatB)===t.ubatEn&&a+1<e.length&&e[a+1]===t.ubatEn?t.ubatEn:t.ubatOn,UBAT_ET:()=>{if(a>0&&n[a-1]===t.ubatEn)return t.ubatEn;if(i.lastArabic)return t.ubatOn;let r=a+1;const o=e.length;for(;r<o&&e[r]===t.ubatEt;)r++;return r<o&&e[r]===t.ubatEn?t.ubatEn:t.ubatOn},UBAT_NSM:()=>{if("VLTR"===i.inFormat){const n=e.length;let i=a+1;for(;i<n&&e[i]===t.ubatNsm;)i++;if(i<n){const n=r[a].charCodeAt(0),o=n>=1425&&n<=2303||64286===n,u=e[i];if(o&&(u===t.ubatR||u===t.ubatAl))return t.ubatR}}return a<1||e[a-1]===t.ubatB?t.ubatOn:n[a-1]},UBAT_B:()=>(i.lastArabic=!0,i.hasUbatB=!0,i.dir),UBAT_S:()=>(i.hasUbatS=!0,t.ubatOn),UBAT_LRE:()=>(i.lastArabic=!1,t.ubatOn),UBAT_RLE:()=>(i.lastArabic=!1,t.ubatOn),UBAT_LRO:()=>(i.lastArabic=!1,t.ubatOn),UBAT_RLO:()=>(i.lastArabic=!1,t.ubatOn),UBAT_PDF:()=>(i.lastArabic=!1,t.ubatOn),UBAT_BN:()=>t.ubatOn}[t.typesNames[o]]()}function h(r){let e,n=0,a=t.swapTable.length-1;for(;n<=a;)if(e=Math.floor((n+a)/2),r<t.swapTable[e][0])a=e-1;else{if(!(r>t.swapTable[e][0]))return t.swapTable[e][1];n=e+1}return r}function T(r){for(let e=0;e<t.standAlonForm.length;e++)if(t.standAlonForm[e]===r)return!0;return!1}function L(r){for(let e=0;e<t.baseForm.length;e++)if(r===t.baseForm[e])return t.medialForm[e];return r}function A(r,e){for(let n=0;n<t.baseForm.length;n++)if(r===t.baseForm[n])return e[n];return r}function m(t){return t>="ً"&&t<="ٕ"}function d(t){return"L"===t?"LTR":"R"===t?"RTL":"C"===t?"CLR":"D"===t?"CRL":""}function F(t,r,e,n){for(;r*e<n&&m(t[r]);)r+=e;return r*e<n&&(t[r]=" ",!0)}function g(r,e){for(let n=0;n<t.aLefTable.length;n++)if(r===t.aLefTable[n])return e[n];return r}function p(t,r,e,n){for(let a=0;a<t.length;a++)(t[a]>r||!e&&t[a]===r)&&(t[a]+=n)}let R=[],B=[],U=[];const w={dir:0,defInFormat:"LLTR",defSwap:"YN",inFormat:"LLTR",outFormat:"VLTR",swap:"YN",hiLevel:0,lastArabic:!1,hasUbatAl:!1,defOutFormat:""},S=5,E=6,_=0,v=1,O=/^[(I|V)][(L|RCD)][(Y|N)][(S|N)]N$/,N=/[\u0591-\u06ff\ufb1d-\ufefc]/;return class{constructor(){this.inputFormat="ILYNN",this.outputFormat="VLNNN",this.sourceToTarget=[],this.targetToSource=[],this.levels=[]}bidiTransform(e,n,a){if(this.sourceToTarget=[],this.targetToSource=[],!e)return"";if(function(t,r,e){R=[],U=[];for(let n=0;n<e;n++)t[n]=n,r[n]=n,R[n]=n}(this.sourceToTarget,this.targetToSource,e.length),!this.checkParameters(n,a))return e;n=this.inputFormat,a=this.outputFormat;let i=e;const o=w,c=d(n.charAt(1)),b=d(a.charAt(1)),h=(n.startsWith("I")?"L":n.charAt(0))+c,S=(a.startsWith("I")?"L":a.charAt(0))+b,E=n.charAt(2)+a.charAt(2);o.defInFormat=h,o.defOutFormat=S,o.defSwap=E;const _=r(e,h,S,E,o);let v=!1;return"R"===a.charAt(1)?v=!0:"C"!==a.charAt(1)&&"D"!==a.charAt(1)||(v="rtl"===this.checkContextual(_)),this.sourceToTarget=R,this.targetToSource=function(t){const r=new Array(t.length);for(let e=0;e<t.length;e++)r[t[e]]=e;return r}(this.sourceToTarget),B=this.targetToSource,i=n.charAt(3)===a.charAt(3)?_:"S"===a.charAt(3)?function(r,e){if(0===e.length)return"";void 0===r&&(r=!0);const n=(e=String(e)).split("");let a=0,i=1,o=n.length;r||(a=n.length-1,i=-1,o=1);const c=function(r,e,n,a){let i=0;const o=[];let u=0;for(let c=e;c*n<a;c+=n)if(s(r[c])||m(r[c])){if("ل"===r[c]&&f(r,c+n,n,a)){r[c]=g(r[c+n],0===i?t.lamAlefInialTableFE:t.lamAlefMedialTableFE),c+=n,F(r,c,n,a),o[u]=c,u++,i=0;continue}const e=r[c];1===i?r[c]=l(r,c+n,n,a)?L(r[c]):A(r[c],t.finalForm):!0===l(r,c+n,n,a)?r[c]=A(r[c],t.initialForm):r[c]=A(r[c],t.isolatedForm),m(e)||(i=1),!0===T(e)&&(i=0)}else i=0;return o}(n,a,i,o);let b="";for(let t=0;t<n.length;t++)u(c,c.length,t)>-1?(p(B,t,!r,-1),R.splice(t,1)):b+=n[t];return b}(v,_):function(r,e){if(0===r.length)return"";void 0===e&&(e=!0);let n="";const a=(r=String(r)).split("");for(let i=0;i<r.length;i++){let o=!1;if(a[i]>="ﹰ"&&a[i]<"\ufeff"){const u=r.charCodeAt(i);a[i]>="ﻵ"&&a[i]<="ﻼ"?(e?(i>0&&" "===a[i-1]?n=n.slice(0,-1)+"ل":(n+="ل",o=!0),n+=t.aLefTable[(u-65269)/2]):(n+=t.aLefTable[(u-65269)/2],n+="ل",i+1<r.length&&" "===a[i+1]?i++:o=!0),o&&(p(B,i,!0,1),R.splice(i,0,R[i]))):n+=t.feTo06Table[u-65136]}else n+=a[i]}return n}(_,v),this.sourceToTarget=R,this.targetToSource=B,this.levels=U,i}_inputFormatSetter(t){if(!O.test(t))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.inputFormat=t}_outputFormatSetter(t){if(!O.test(t))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.outputFormat=t}checkParameters(t,r){return t?this._inputFormatSetter(t):t=this.inputFormat,r?this._outputFormatSetter(r):r=this.outputFormat,t!==r}checkContextual(t){let r=e(t);if("ltr"!==r&&"rtl"!==r){try{r=document.dir.toLowerCase()}catch(t){}"ltr"!==r&&"rtl"!==r&&(r="ltr")}return r}hasBidiChar(t){return N.test(t)}}});