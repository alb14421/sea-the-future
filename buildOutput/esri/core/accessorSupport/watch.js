// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../ArrayPool","../handleUtils","../lang","../ReentrantObjectPool","../scheduling","../SetUtils","../uid","./get","./Lifecycle","./trackingUtils","./utils"],function(e,t,l,r,a,n,i,c,o,u,s,d){"use strict";class h{constructor(){this.uid=c.generateUID(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static{this.pool=new a.ReentrantObjectPool(h)}static acquireUntracked(e,t,l,a,n){return this.pool.acquire(0,e,t,l,a,n,r.equals)}static acquireTracked(e,t,l,r){return this.pool.acquire(1,e,t,l,null,null,r)}notify(e,t){0===this.type?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t,void 0,void 0)}acquire(e,t,l,r,a,n,i){this.uid=c.generateUID(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=l,this.getValue=r,this.target=a,this.path=n,this.equals=i}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=c.generateUID(),this.removed=!0}}const f=new t,m=new Set;let v;function g(e){m.delete(e),m.add(e),v||(v=n.schedule(_))}function p(e){if(e.removed)return;const t=e.oldValue,l=e.getValue();e.equals(t,l)||(e.oldValue=l,e.notify(l,t))}function _(){let e=10;for(;v&&e--;){v=null;const e=k(),t=f.acquire();for(const l of e){const e=l.uid;p(l),e===l.uid&&l.removed&&t.push(l)}for(const e of m)e.removed&&(t.push(e),m.delete(e));for(const e of t)h.pool.release(e);f.release(t),f.release(e),q.forEach(e=>e())}}function k(){const e=f.acquire();e.length=m.size;let t=0;for(const l of m)e[t]=l,++t;return m.clear(),e}const q=new Set;e.afterDispatch=function(e){return q.add(e),l.makeHandle(()=>q.delete(e))},e.dispatch=_,e.isValueInUse=function(e){return i.someSet(m,t=>t.oldValue===e)},e.removeTarget=function(e){for(const t of m.values())t.target===e&&(t.removed=!0)},e.watch=function(e,t,a,n=!1){return e.__accessor__&&e.__accessor__.lifecycle!==u.Lifecycle.DESTROYED?n?function(e,t,l){const a=d.parse(e,t,l,(e,t,l)=>{let n=!1;return s.reaction(()=>o.valueOf(e,t),(i,c)=>{e.__accessor__.lifecycle!==u.Lifecycle.DESTROYED?n||(n=!0,r.equals(c,i)||l.call(e,i,c,t,e),n=!1):a.remove()})});return a}(e,t,a):function(e,t,r){let a=d.parse(e,t,r,(e,t,r)=>{let n,i,c=s.reactionDeferred(()=>o.valueOf(e,t),(l,c)=>{e.__accessor__?.lifecycle===u.Lifecycle.DESTROYED||n&&n.uid!==i?a.remove():(n||(n=h.acquireUntracked(l,r,c,e,t),i=n.uid),g(n))});return l.makeHandle(()=>{c.remove(),n&&(n.uid!==i||n.removed||(n.removed=!0,g(n)),n=null),a=c=null})});return a}(e,t,a):l.makeHandle()},e.watchTracked=function(e,t,a=!1,n=r.equalsShallow){return a?function(e,t,l){let r=!1;return s.reaction(e,(e,a)=>{r||(r=!0,l(a,e)||t(e,a),r=!1)})}(e,t,n):function(e,t,r){let a,n,i=s.reactionDeferred(e,(e,l)=>{a&&a.uid!==n?i.remove():(a||(a=h.acquireTracked(e,t,l,r),n=a.uid),g(a))});return l.makeHandle(()=>{i.remove(),a&&(a.uid!==n||a.removed||(a.removed=!0,g(a)),a=null),i=null})}(e,t,n)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});