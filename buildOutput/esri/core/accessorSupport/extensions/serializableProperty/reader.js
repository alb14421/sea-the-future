// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../Logger","../../../object","../../../Warning","../../metadata","./type"],function(e,t,r,n,o,i){"use strict";const p=()=>t.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function u(e){const t=e.ndimArray??0;if(t>1)return function(e){const t=y(e),r=s.bind(null,t),n=e.ndimArray??0;return(e,t,o)=>{if(null==e)return e;e=r(e,o,n);let i=n,p=e;for(;i>0&&Array.isArray(p);)i--,p=p[0];if(void 0!==p)for(let t=0;t<i;t++)e=[e];return e}}(e);if(1===t)return c(e);if("type"in e&&a(e.type)){const t=e.type.prototype?.itemType?.Type,r=c("function"==typeof t?{type:t}:{types:t});return(t,n,o)=>{const i=r(t,n,o);return i?new e.type(i):i}}return y(e)}function y(e){return"type"in e?function(e){return e.prototype.read?(t,r,n)=>{if(null==t)return t;const o=typeof t;if("object"!==o)return void p().error(`Expected JSON value of type 'object' to deserialize type '${e.prototype.declaredClass}', but got '${o}'`);const i=new e;return i.read(t,n),i}:e.fromJSON}(e.type):function(e){let t=null;const r=e.errorContext??"type",i=e.validate;return(u,y,s)=>{if(null==u)return u;const c=typeof u;if("object"!==c)return void p().error(`Expected JSON value of type 'object' to deserialize, but got '${c}'`);t||(t=function(e){const t={};for(const r in e.typeMap){const n=e.typeMap[r],i=o.getPropertiesMetadata(n.prototype);if("function"==typeof e.key)continue;const p=i[e.key];if(!p)continue;if(p.json?.type&&Array.isArray(p.json.type)&&1===p.json.type.length&&"string"==typeof p.json.type[0]){t[p.json.type[0]]=n;continue}const u=p.json?.write;if(!u?.writer){t[r]=n;continue}const y=u.target,s="string"==typeof y?y:e.key,c={};u.writer(r,c,s),c[s]&&(t[c[s]]=n)}return t}(e));const a=e.key;if("string"!=typeof a)return;const f=u[a],d=f?t[f]:e.defaultKeyValue?e.typeMap[e.defaultKeyValue]:void 0;if(!d){const e=`Type '${f||"unknown"}' is not supported`;return s?.messages&&u&&s.messages.push(new n(`${r}:unsupported`,e,{definition:u,context:s})),void p().error(e)}const l=new d;return l.read(u,s),i?i(l):l}}(e.types)}function s(e,t,r,n){return 0!==n&&Array.isArray(t)?t.map(t=>s(e,t,r,n-1)):e(t,void 0,r)}function c(e){const t=y(e);return(e,r,n)=>{if(null==e)return e;if(Array.isArray(e)){const r=[];for(const o of e){const e=t(o,void 0,n);void 0!==e&&r.push(e)}return r}const o=t(e,void 0,n);return void 0!==o?[o]:void 0}}function a(e){if(!i.isCollection(e))return!1;const t=e.prototype.itemType;return!(!t||!t.Type)&&("function"==typeof t.Type?f(t.Type):d(t.Type))}function f(e){return!Array.isArray(e)&&!!e&&e.prototype&&("read"in e.prototype||"fromJSON"in e||a(e))}function d(e){for(const t in e.typeMap)if(!f(e.typeMap[t]))return!1;return!0}e.create=function(e,t,n){e&&(!n&&!t.read||t.read?.reader||!1===t.read?.enabled||function(e){return"types"in e?d(e.types):f(e.type)}(e)&&r.setDeepValue("read.reader",u(e),t))},e.createTypeReader=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});