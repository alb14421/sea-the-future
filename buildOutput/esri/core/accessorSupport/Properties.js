// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../has","../lang","../Logger","../ObjectPool","./Lifecycle","./Property","./PropertyOrigin","./Store","./tracking","./tracking/Flags","./tracking/TrackingTarget"],function(e,t,i,s,r,a,n,o,c,l,h){"use strict";function g(e,t,i){return void 0!==e}function d(e,t,i,s){return!(void 0===e||null==i&&e.flags&l.Flags.NonNullable&&(s.lifecycle,r.Lifecycle.INITIALIZING,1))}const f=new s(class{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}});return class{constructor(e){this.host=e,this.propertiesByName=new Map,this.ctorArgs=null,this.lifecycle=r.Lifecycle.INITIALIZING,this.store=new o.Store,this.mutable=!0,this._origin=7;const t=this.host.constructor.__accessorMetadata__;for(const e in t){const i=new a.Property(e,t[e]);this.propertiesByName.set(e,i)}this.metadata=t}initialize(){this.lifecycle=r.Lifecycle.CONSTRUCTING}constructed(){this.lifecycle=r.Lifecycle.CONSTRUCTED}destroy(){this.lifecycle=r.Lifecycle.DESTROYED,this.propertiesByName.forEach(e=>e.destroy())}get initialized(){return this.lifecycle!==r.Lifecycle.INITIALIZING}get(e){const t=this.propertiesByName.get(e);if(!g(t))return;if(t.metadata.get)return t.getComputed(this);this.mutable&&c.trackAccess(t);const i=this.store;return i.has(e)?i.get(e):t.metadata.value}originOf(e){const t=this.store.originOf(e);if(void 0===t){const t=this.propertiesByName.get(e);if(void 0!==t&&t.flags&l.Flags.HasDefaultValue)return"defaults"}return n.idToName(t)}has(e){return this.propertiesByName.has(e)&&this.store.has(e)}keys(){return[...this.propertiesByName.keys()]}internalGet(e){const t=this.propertiesByName.get(e);if(g(t))return this.store.has(e)?this.store.get(e):t.metadata.value}internalSet(e,t){const i=this.propertiesByName.get(e);g(i)&&this._internalSet(i,t)}getDependsInfo(e,t,i){const s=this.propertiesByName.get(t);if(!g(s))return"";const r=new h.TrackingTarget,n=c.runTracked(r,()=>s.metadata.get?.call(e));let o=`${i}${e.declaredClass.split(".").pop()}.${t}: ${n}\n`;const l=r.accessed??new Set;if(0===l.size)return o;i+="  ";for(const e of l)e instanceof a.Property&&(o+=`${i}${e.propertyName}: undefined\n`);return o}setAtOrigin(e,t,i){const s=this.propertiesByName.get(e);if(g(s))return this._setAtOrigin(s,t,i)}isOverridden(e){const t=this.propertiesByName.get(e);return void 0!==t&&!!(t.flags&l.Flags.Overridden)}clearOrigin(e,t){const i=this.store,s=this.propertiesByName.get(e);if(!g(s))return;const r=i.isAtOrigin(e,t)&&!(s.flags&l.Flags.Overridden);i.delete(e,t),r&&s.notifyChange()}clearOverride(e){const t=this.propertiesByName.get(e);t&&t.flags&l.Flags.Overridden&&(t.flags&=~l.Flags.Overridden,t.notifyChange())}override(e,t){const i=this.propertiesByName.get(e);if(!d(i,0,t,this))return;const s=i.metadata.cast;if(s){const e=this._cast(s,t),{valid:i,value:r}=e;if(f.release(e),!i)return;t=r}i.flags|=l.Flags.Overridden,this._internalSet(i,t)}set(e,t){const i=this.propertiesByName.get(e);if(!d(i,0,t,this))return;const s=i.metadata.cast;if(s){const e=this._cast(s,t),{valid:i,value:r}=e;if(f.release(e),!i)return;t=r}const r=i.metadata.set;r?r.call(this.host,t):this._internalSet(i,t)}setDefaultOrigin(e){this._origin=n.nameToId(e)}getDefaultOrigin(){return n.idToName(this._origin)}notifyChange(e){const t=this.propertiesByName.get(e);void 0!==t&&t.notifyChange()}invalidate(e){const t=this.propertiesByName.get(e);void 0!==t&&t.invalidate()}commit(e){const t=this.propertiesByName.get(e);void 0!==t&&t.commit()}_internalSet(e,t){const i=this.lifecycle!==r.Lifecycle.INITIALIZING?this._origin:0;this._setAtOrigin(e,t,i)}_setAtOrigin(e,i,s){const r=this.store,a=e.propertyName;if(r.isAtOrigin(a,s)&&t.equals(i,r.get(a))&&~e.flags&l.Flags.Overridden)return;const n=r.isBelowOrigin(a,s)||r.isAtOrigin(a,s);n&&e.invalidate(),r.set(a,i,s),n&&e.commit(),c.initializeDependencyTracking(this.host,e)}_cast(e,t){const i=f.acquire();return i.valid=!0,i.value=t,e&&(i.value=e.call(this.host,t,i)),i}}});