// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../Error","../../MD5","../../multiOriginJSONSupportUtils","../../urlUtils","../../uuid","../metadata","../PropertyOrigin","./property","../../../portal/support/resourceExtension","../../../chunks/persistableUrlUtils"],function(e,t,r,o,s,n,i,c,u,p,a){"use strict";function l(e){const{targetUrl:o,params:i,value:c,context:u,dest:l,targetPropertyName:f}=e;if(!u.portalItem)return;const g=a.prefixAndFilenameFromResourceUrl(o),y=m(c,o,u);if(i?.contentAddressed&&"json"!==y.type)return void u.messages?.push(new t("persistable:contentAddressingUnsupported",`Property "${f}" is trying to serializing a resource with content of type ${y.type} with content addressing. Content addressing is only supported for json resources.`,{content:y}));const h=i?.contentAddressed&&"json"===y.type?r.createMD5Hash(y.jsonString):g?.filename??n.generateUUID(),U=i?.prefix??g?.prefix,v=s.join(U,h),b=`${v}.${p.getResourceContentExtension(y)}`;if(i?.contentAddressed&&u.resources&&"json"===y.type){const e=u.resources.toKeep.find(({resource:e})=>e.path===b)??u.resources.toAdd.find(({resource:e})=>e.path===b);if(e)return void(l[f]=e.resource.itemRelativeUrl)}const I=u.portalItem.resourceFromPath(b);s.isBlobProtocol(o)&&u.resources&&u.resources.pendingOperations.push(s.blobUrlToBlob(o).then(e=>{I.path=`${v}.${p.getResourceContentExtension({type:"blob",blob:e})}`,l[f]=I.itemRelativeUrl}).catch(()=>{}));const P=i?.compress??!1;u.resources&&d({...e,resource:I,content:y,compress:P,updates:u.resources.toAdd}),l[f]=I.itemRelativeUrl}function d({object:e,propertyName:t,updates:r,resource:o,content:s,compress:n}){r.push({resource:o,content:s,compress:n,finish:r=>{!function(e,t,r){"string"==typeof e[t]?e[t]=r.url:e[t].url=r.url}(e,t,r)}})}function m(e,t,r){return"string"==typeof e?{type:"url",url:t}:{type:"json",jsonString:JSON.stringify(e.toJSON(r))}}e.persistable=function(e){const t=e?.origins??[void 0];return(r,n)=>{const f=function(e,t,r){if("resource"===e?.type)return function(e,t,r){const n=i.getPropertyMetadata(t,r);return{type:String,read:(e,t,r)=>{const o=a.read(e,t,r);return n.type===String?o:"function"==typeof n.type?new n.type({url:o}):void 0},write:{isRequired:n.json?.write?.isRequired,writer(t,i,u,f){if(!f?.resources)return"string"==typeof t?void(i[u]=a.toJSON(t,f)):void(i[u]=t.write({},f));const g=null==(v=t)?null:"string"==typeof v?v:v.url,y=a.toJSON(g,{...f,verifyItemRelativeUrls:f?.verifyItemRelativeUrls?{writtenUrls:f.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},1),h=n.type!==String&&(!o.isMultiOriginJSONMixin(this)||f?.origin&&this.originIdOf(r)>c.nameToId(f.origin)),U={object:this,propertyName:r,value:t,targetUrl:y,dest:i,targetPropertyName:u,context:f,params:e};var v;f?.portalItem&&y&&!s.isAbsolute(y)?h&&e?.contentAddressed?l(U):h?function(e){const{context:t,targetUrl:r,params:o,value:n,dest:i,targetPropertyName:c}=e;if(!t.portalItem)return;const u=t.portalItem.resourceFromPath(r),a=m(n,r,t),f=p.getResourceContentExtension(a),g=s.getPathExtension(u.path),y=o?.compress??!1;f===g?(t.resources&&d({...e,resource:u,content:a,compress:y,updates:t.resources.toUpdate}),i[c]=r):l(e)}(U):function({context:e,targetUrl:t,dest:r,targetPropertyName:o}){e.portalItem&&e.resources&&(e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(t),compress:!1}),r[o]=t)}(U):f?.portalItem&&(null==y||null!=a.itemIdFromResourceUrl(y)||s.isBlobProtocol(y)||h)?l(U):i[u]=y}}}}(e,t,r);switch(e?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:e,write:t}=a.persistableUrlUtils;return{read:e,write:t}}}}(e,r,n);for(const e of t){const t=u.propertyJSONMeta(r,e,n);for(const e in f)t[e]=f[e]}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});