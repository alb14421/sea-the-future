// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","./nextTick","./PerformanceSampler","./PooledArray","./promiseUtils","./time"],function(e,n,t,s,r,i){"use strict";class o{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}}class a{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}}let c=0,l=0;const u={time:i.Milliseconds(0),deltaTime:i.Milliseconds(0),elapsedFrameTime:i.Milliseconds(0),frameDuration:i.Milliseconds(0)},m=["prepare","preRender","render","postRender","update","finish"],d=[],p=new s;class f{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1,h()}}function h(){null==v&&(c=performance.now(),v=requestAnimationFrame(A))}const w={frameTasks:p,willDispatch:!1,clearFrameTasks:function(e=!1){p.forAll(e=>{e.removed=!0}),e&&M()},dispatch:b,executeFrameTasks:function(e){const n=i.Milliseconds(e-c);c=e;const t=l>0?l:1e3/60,s=Math.max(0,n-t);u.time=e,u.frameDuration=i.Milliseconds(t-s);for(let t=0;t<m.length;t++){const s=performance.now(),r=m[t];p.forAll(s=>{s.paused||s.removed||(0===t&&s.ticks++,s.phases[r]&&(u.elapsedFrameTime=i.Milliseconds(performance.now()-e),u.deltaTime=0===s.ticks?i.Milliseconds(0):n,s.phases[r]?.call(s,u)))}),D[t].push(performance.now()-s)}M(),R.push(performance.now()-e)},reschedule:function(){null!=v&&(cancelAnimationFrame(v),v=requestAnimationFrame(A))}};function k(e){const t=new a(e);return d.push(t),w.willDispatch||(w.willDispatch=!0,n.nextTick(b)),t}function T(e){const n=new o(e);return p.push(n),h(),new f(n)}let v=null;function A(){const e=performance.now();v=null;const n=p.some(e=>!e.paused&&!e.removed);v=n?requestAnimationFrame(A):null,w.executeFrameTasks(e)}const F=new s;function M(){p.forAll(e=>{e.removed&&F.push(e)}),p.removeUnorderedMany(F.data,F.length),F.clear()}function b(){for(;d.length;){const e=d.shift();e.isActive&&e.callback()}w.willDispatch=!1}function x(e=1,t){const s=r.createResolver(),i=()=>{r.isAborted(t)?s.reject(r.createAbortError()):0===e?s():(--e,n.nextTick(()=>i()))};return i(),s.promise}function g(e){return x(1,e)}const D=m.map(e=>new t(e)),R=new t("total");e.FrameTaskHandle=f,e.addFrameTask=T,e.cleanupScheduling=function(){p.prune(),F.prune()},e.debug=w,e.performanceInfo=D,e.performanceTotal=R,e.schedule=k,e.setFrameDuration=function(e){l=Math.max(0,e)},e.waitAnimationFrame=async function(e){await g(e),await new Promise(n=>requestAnimationFrame(()=>{e?.aborted||n()}))},e.waitRender=function(){const e=r.createResolver(),n=T({postRender:()=>{n.remove(),k(e)}});return e.promise},e.waitTick=g,e.waitTicks=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});