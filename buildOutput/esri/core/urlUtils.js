// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../config","./arrayUtils","./Error","./Logger","./support/jsonUtils","../portal/support/urlUtils","../support/base64Utils"],function(t,e,n,r,o,s,i,l){"use strict";const u=e.request,c="esri/config: esriConfig.request.proxyUrl is not set.",a=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,f=/^\s*http:/i,h=/^\s*https:/i,p=/^\s*file:/i,d=/:\d+$/,m=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,y=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),g=new RegExp("^((([^[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^[:]*))(:([0-9]+))?$");class ${constructor(t=""){this.uri=t,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let e=this.uri.match(y);this.scheme=e[2]||(e[1]?"":null),this.authority=e[4]||(e[3]?"":null),this.path=e[5],this.query=e[7]||(e[6]?"":null),this.fragment=e[9]||(e[8]?"":null),null!=this.authority&&(e=this.authority.match(g),this.user=e[3]||null,this.password=e[4]||null,this.host=e[6]||e[7],this.port=e[9]||null)}toString(){return this.uri}}const x={},w=new $(e.applicationUrl);let U=w;const O=function(){const t=U.path,e=t.slice(0,t.lastIndexOf("/")+1);return`${U.scheme}://${U.host}${null!=U.port?`:${U.port}`:""}${e}`}();let b=O;const P={setAppUrl:t=>U=t,setAppBaseUrl:t=>b=t,restoreUrls:()=>{U=w,b=O}};function R(t){if(!t)return null;const e={path:null,query:null},n=new $(t),r=t.indexOf("?");return null===n.query?e.path=t:(e.path=t.slice(0,r),e.query=S(n.query)),n.fragment&&(e.hash=n.fragment,null===n.query&&(e.path=e.path.slice(0,e.path.length-(n.fragment.length+1)))),e}function S(t){const e=t.split("&"),n={};for(const t of e){if(!t)continue;const e=t.indexOf("=");let r,o;e<0?(r=decodeURIComponent(t),o=""):(r=decodeURIComponent(t.slice(0,e)),o=decodeURIComponent(t.slice(e+1)));let s=n[r];"string"==typeof s&&(s=n[r]=[s]),Array.isArray(s)?s.push(o):n[r]=o}return n}function A(t,e){return t?e&&"function"==typeof e?Object.keys(t).map(n=>encodeURIComponent(n)+"="+encodeURIComponent(e(n,t[n]))).join("&"):Object.keys(t).map(n=>{const r=t[n];if(null==r)return"";const o=encodeURIComponent(n)+"=",i=e?.[n];return i?o+encodeURIComponent(i(r)):Array.isArray(r)?r.map(t=>s.isSerializable(t)?o+encodeURIComponent(JSON.stringify(t)):o+encodeURIComponent(t)).join("&"):s.isSerializable(r)?o+encodeURIComponent(JSON.stringify(r)):o+encodeURIComponent(r)}).filter(t=>t).join("&"):""}function C(t=!1){let e,n=u.proxyUrl;if("string"==typeof t){e=_(t);const r=I(t);r&&(n=r.proxyUrl)}else e=!!t;if(!n)throw o.getLogger("esri.core.urlUtils").warn(c),new r("urlUtils:proxy-not-set",c);return e&&Y()&&(n=X(n)),R(n)}const q={path:"",query:""};function T(t){const e=t.indexOf("?");return-1!==e?(q.path=t.slice(0,e),q.query=t.slice(e+1)):(q.path=t,q.query=null),q}function v(t){return(t=Z(t=tt(t=T(t).path),!0)).toLowerCase()}function I(t){const e=u.proxyRules,n=v(t);for(let t=0;t<e.length;t++)if(n.startsWith(e[t].urlPrefix))return e[t]}function j(t){const e=(t=D(t)).indexOf("/sharing");return e>0?t.slice(0,e):t.replace(/\/+$/,"")}function L(t,e,n=!1){if(!t||!e)return!1;const r=et(t),o=et(e);return!(!n&&r.scheme!==o.scheme)&&null!=r.host&&null!=o.host&&r.host.toLowerCase()===o.host.toLowerCase()&&r.port===o.port}function B(t){return x[t]||(V(t)||N(t)?x[t]=[new $(W(t))]:x[t]=[new $(`http://${t}`),new $(`https://${t}`)]),x[t]}function W(t,e=b,n){return N(t)?n?.preserveProtocolRelative?t:"http"===U.scheme&&U.authority===k(t).slice(2)?`http:${t}`:`https:${t}`:V(t)?t:H(t.startsWith("/")?function(t){const e=t.indexOf("//"),n=t.indexOf("/",e+2);return-1===n?t:t.slice(0,n)}(e):e,t)}function D(t){return function(t){const e=u.httpsDomains;if(!function(t){return null!=t&&f.test(t)||"http"===U.scheme&&N(t)}(t))return t;const n=t.indexOf("/",7);let r;if(r=-1===n?t:t.slice(0,n),r=r.toLowerCase().slice(7),d.test(r)){if(!r.endsWith(":80"))return t;r=r.slice(0,-3),t=t.replace(":80","")}return"http"!==U.scheme||r!==U.authority||m.test(t)?((Y()&&r===U.authority||e&&e.some(t=>r===t||r.endsWith(`.${t}`))||Y()&&!I(t))&&(t=X(t)),t):t}(t=function(t){return t.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}(t=function(t){if(/^https?:\/\//i.test(t)){const e=T(t);t=(t=e.path.replaceAll(/\/{2,}/g,"/")).replace("/","//"),e.query&&(t+=`?${e.query}`)}return t}(t=W(t=t.trim()))))}function H(...t){const e=t.filter(n.isSome);if(!e?.length)return;const r=[];if(E(e[0])){const t=e[0],n=t.indexOf("//");-1!==n&&(r.push(t.slice(0,n+1)),null!=(o=e[0])&&p.test(o)&&(r[0]+="/"),e[0]=t.slice(n+2))}else e[0].startsWith("/")&&r.push("");var o;const s=e.reduce((t,e)=>e?t.concat(e.split("/")):t,[]);for(let t=0;t<s.length;t++){const e=s[t];".."===e&&r.length>0&&".."!==r[r.length-1]?r.pop():(!e&&t===s.length-1||e&&("."!==e||0===r.length))&&r.push(e)}return r.join("/")}function k(t,e=!1){if(null==t||G(t)||Q(t))return null;let n=t.indexOf("://");if(-1===n&&N(t))n=2;else{if(-1===n)return null;n+=3}const r=t.indexOf("/",n);return-1!==r&&(t=t.slice(0,r)),e&&(t=Z(t,!0)),t}function E(t){return N(t)||V(t)}function G(t){return null!=t&&t.startsWith("blob:")}function Q(t){return null!=t&&t.startsWith("data:")}function z(t){const e=K(t);return e?.isBase64?l.base64ToArrayBuffer(e.data):null}const F=/^data:(.*?)(;base64)?,(.*)$/;function K(t){const e=t.match(F);if(!e)return null;const[,n,r,o]=e;return{mediaType:n,isBase64:!!r,data:o}}function J(t){const e=z(t);if(!e)return null;const n=K(t);return new Blob([e],{type:n.mediaType})}function M(t,e){if(!t)return!1;const n=document.createElement("a");if(!("download"in n))return!1;const r=URL.createObjectURL(t);return n.download=e,n.href=r,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r),!0}function N(t){return null!=t&&t.startsWith("/")&&"/"===t[1]}function V(t){return null!=t&&a.test(t)}function _(t){return null!=t&&h.test(t)||"https"===U.scheme&&N(t)}function X(t){return N(t)?`https:${t}`:t.replace(f,"https:")}function Y(){return"https"===U.scheme}function Z(t,e=!1){return N(t)?t.slice(2):(t=t.replace(a,""),e&&t.length>1&&t.startsWith("/")&&"/"===t[1]&&(t=t.slice(2)),t)}function tt(t){return t.endsWith("/")?t:`${t}/`}function et(t){return"string"==typeof t?new $(W(t)):(t.scheme||(t.scheme=U.scheme),t)}const nt=/([^.]*)\.([^/]*)$/,rt=/(^data:image\/svg|\.svg$)/i;t.Url=$,t.addProxy=function(t,e=!1){const n=I(t);let r,o;if(n){const t=T(n.proxyUrl);r=t.path,o=t.query?S(t.query):null}else if(e){const e=C(t);r=e.path,o=e.query}if(r){const e=R(t);t=r+"?"+e.path;const n=A({...o,...e.query});n&&(t=`${t}?${n}`)}return t},t.addProxyRule=function(t){const e={proxyUrl:t.proxyUrl,urlPrefix:v(t.urlPrefix)},n=u.proxyRules,r=e.urlPrefix;let o=n.length;for(let t=0;t<n.length;t++){const e=n[t].urlPrefix;if(r.startsWith(e)){if(r.length===e.length)return-1;o=t;break}e.startsWith(r)&&(o=t+1)}return n.splice(o,0,e),o},t.addQueryParameter=function(t,e,n){const r=R(t),o=r.query||{};return o[e]=String(n),`${r.path}?${A(o)}`},t.addQueryParameters=function(t,e){if(!e)return t;const n=R(t),r=n.query||{};for(const[t,n]of Object.entries(e))null!=n&&(r[t]=n);const o=A(r);return o?`${n.path}?${o}`:n.path},t.base64UrlEncode=function(t){return l.arrayBufferToBase64(t).replaceAll("+","-").replaceAll("/","_").replace(/=+$/,"")},t.blobUrlToBlob=async function(t){return(await fetch(t)).blob()},t.changeDomain=function(t,e,n){if(!(e&&n&&t&&E(t)))return t;const r=t.indexOf("//"),o=t.indexOf("/",r+2),s=t.indexOf(":",r+2),i=Math.min(o<0?t.length:o,s<0?t.length:s);return t.slice(r+2,i).toLowerCase()!==e.toLowerCase()?t:`${t.slice(0,r+2)}${n}${t.slice(i)}`},t.changeHost=function(t,e){const n=new URL(t);return n.host=e,n.port&&!d.test(e)&&(n.port=""),n.toString()},t.dataComponents=K,t.dataToArrayBuffer=z,t.dataToBlob=J,t.downloadBlobAsFile=function(t,e){M(t,e)},t.downloadDataAsFile=function(t,e){!function(t,e){const n=J(t);if(!n)return!1;M(n,e)}(t,e)},t.ensureTrailingSlash=tt,t.getAppBaseUrl=()=>b,t.getAppUrl=()=>U,t.getFilename=function(t,e){if(!t)return"";const n=R(t).path.replace(/\/+$/,""),r=n.slice(n.lastIndexOf("/")+1);if(!e?.length)return r;const o=new RegExp(`\\.(${e.join("|")})$`,"i");return r.replace(o,"")},t.getHost=function(t){return new URL(t).host},t.getInterceptor=function(t,e=u.interceptors){const n=e=>e instanceof RegExp?e.test(t):"string"==typeof e?t.startsWith(e):null==e;if(e)for(const t of e)if(Array.isArray(t.urls)){if(t.urls.some(n))return t}else if(n(t.urls))return t;return null},t.getOrigin=k,t.getPathExtension=function(t){if(null==t)return null;const e=t.match(nt);return e?e[2]:null},t.getProxyRule=I,t.getProxyUrl=C,t.hasProtocol=V,t.hasSameCanonicalArcGISOnlinePortal=function(t,e){if(!t||!e)return!1;t=j(t),e=j(e);const n=i.parseKnownArcGISOnlineDomain(t),r=i.parseKnownArcGISOnlineDomain(e);return null!=n&&null!=r&&n.portalHostname===r.portalHostname},t.hasSameCanonicalPortal=function(t,e){if(!t||!e)return!1;t=j(t),e=j(e);const n=i.parseKnownArcGISOnlineDomain(t),r=i.parseKnownArcGISOnlineDomain(e);return null!=n&&null!=r?n.portalHostname===r.portalHostname:null==n&&null==r&&L(t,e,!0)},t.hasSameOrigin=L,t.hasSamePortal=function(t,e){return t=j(t),e=j(e),Z(t)===Z(e)},t.isAbsolute=E,t.isAppHTTPS=Y,t.isBlobProtocol=G,t.isDataProtocol=Q,t.isHTTPSProtocol=_,t.isProtocolRelative=N,t.isSVG=function(t){return rt.test(t)},t.isTrustedServer=function(t){if("string"==typeof t){if(!E(t))return!0;t=et(t)}if(L(t,U))return!0;const e=u.trustedServers||[];for(let n=0;n<e.length;n++){const r=B(e[n]);for(let e=0;e<r.length;e++)if(L(t,r[e]))return!0}return!1},t.join=H,t.makeAbsolute=W,t.makeData=function(t){return t.isBase64?`data:${t.mediaType};base64,${t.data}`:`data:${t.mediaType},${t.data}`},t.makeRelative=function(t,e=b,n){if(null==t||!E(t))return t;const r=D(t),o=r.toLowerCase(),s=D(e).toLowerCase().replace(/\/+$/,""),i=n?D(n).toLowerCase().replace(/\/+$/,""):null;if(i&&!s.startsWith(i))return t;const l=(t,e,n)=>-1===(n=t.indexOf(e,n))?t.length:n;let u=l(o,"/",o.indexOf("//")+2),c=-1;for(;o.slice(0,u+1)===s.slice(0,u)+"/"&&(c=u+1,u!==o.length);)u=l(o,"/",u+1);if(-1===c)return t;if(i&&c<i.length)return t;t=r.slice(c);const a=s.slice(c-1).replaceAll(/[^/]+/g,"").length;if(a>0)for(let e=0;e<a;e++)t=`../${t}`;else t=`./${t}`;return t},t.normalize=D,t.objectToQuery=A,t.parseData=async function(t){return"string"==typeof t?K(t)??{data:t}:new Promise((e,n)=>{const r=new FileReader;r.readAsDataURL(t),r.onload=()=>e(K(r.result)),r.onerror=t=>n(t)})},t.queryToObject=S,t.removeFile=function(t){let e=0;if(E(t)){const n=t.indexOf("//");-1!==n&&(e=n+2)}const n=t.lastIndexOf("/");return n<e?t:t.slice(0,n+1)},t.removeQueryParameter=function(t,e){const{path:n,query:r}=R(t);if(!r)return t;delete r[e];const o=A(r);return o?`${n}?${o}`:n},t.removeQueryParameters=function(t,e){const n=R(t),r=Object.keys(n.query||{});return r.length>0&&e&&e.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${r.join(", ")}.`),n.path},t.removeTrailingSlash=function(t){return t.replace(/\/+$/,"")},t.splitPathExtension=function(t){if(null==t)return null;const e=t.match(nt);return e?{path:e[1],extension:e[2]}:{path:t,extension:null}},t.test=P,t.toHTTP=function(t){return N(t)?`http:${t}`:t.replace(h,"http:")},t.toHTTPS=X,t.trustedServersUrlCache=x,t.urlToObject=R,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});