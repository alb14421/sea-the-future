// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","./asyncUtils","./Collection","./handleUtils","./promiseUtils","./reactiveUtils"],function(e,t,o,r,s,n){"use strict";function i(e,t,r){const s=r?.createCollection?.()??new o,i=r?.recycleItems?new a:null,c=(e,t=0)=>{if(!e?.length)return;const o=s.splice(t,e.length);i?i.processRemoved(e):o.forEach(d)},l=(e,o=0)=>{if(!e?.length)return;const r=[];for(const o of e){const e=i?.use(o);if(e)r.push(e);else{const e=t(o);i?.register(o,e),r.push(e)}}s.addMany(r,o)},m=n.on(e,"after-splice",({added:e,start:t,removed:o})=>{c(o,t),l(e,t)},{sync:!0,onListenerRemove:e=>c(e.items),onListenerAdd:e=>l(e.items)});return s.addHandles(m),s}class a{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(!e?.length)return;const{_removedItemCandidates:t}=this;for(const o of e)this._getItem(o)?.markRemoved()&&(t.add(o),this._queueGarbageCollection())}use(e){const t=this._getItem(e);return t&&(t.removed=!1),t?.item}register(e,t){this._originalToMapped.set(e,new c(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask(()=>this._garbageCollectCandidates()))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;const{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach(e=>this._garbageCollectIfRemoved(e))}_garbageCollectIfRemoved(e){const{_originalToMapped:t}=this,o=this._getItem(e);o?.removed&&(d(o.item),t.delete(e))}}class c{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}}function d(e){"object"==typeof e&&e&&("destroy"in e&&"function"==typeof e.destroy?e.destroy():r.removeIfHandle(e))}e.mapCollection=i,e.mapCollectionAsync=function(e,n,a){const c=new o,l=i(e,e=>t.createTask(async t=>{const o=await n(e,t);if(s.isAborted(t))throw d(o),s.createAbortError();return o}),a),m=()=>null,u=async e=>{const t=await e.promise,o=l.indexOf(e);o<0||c.splice(o,1,t)};c.addMany(l.items.map(m));for(const e of l)s.ignoreAbortErrors(u(e));const g=l.on("after-splice",({added:e,start:t,deleteCount:o})=>{const r=c.splice(t,o);for(const e of r)d(e);if(e?.length){c.addMany(e.map(m),t);for(const t of e)s.ignoreAbortErrors(u(t))}});return c.addHandles([r.destroyHandle(l),g]),c},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});