// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../has","../promiseUtils"],function(e,r,t){"use strict";const n="worker:port-closed",s={HANDSHAKE:0,OPEN:1,OPENED:2,RESPONSE:3,INVOKE:4,ABORT:5,CLOSE:6,OPEN_PORT:7,ON:8};let o=0;function i(e){return e&&"object"==typeof e&&("result"in e||"transferList"in e)}function a(e){return e?"string"==typeof e?JSON.stringify({name:"message",message:e}):e.toJSON?JSON.stringify(e):JSON.stringify({name:e.name,message:e.message,details:e.details||{stack:e.stack}}):null}function f(e){if(!e?.length)return null;if(r("esri-workers-arraybuffer-transfer"))return e;const t=e.filter(e=>{return!((r=e)instanceof ArrayBuffer||"ArrayBuffer"===r?.constructor?.name);var r});return t.length?t:null}e.MessageType=s,e.ignoreConnectionErrors=async function(e){try{return await e}catch(e){const r=e?.name===n;if(!t.isAbortError(e)&&!r)throw e;return}},e.isTransferableResult=i,e.newJobId=function(){return o++},e.portClosedErrorName=n,e.postMessage=function e(t,n,o,u){if(n.type===s.OPEN_PORT)return void t.postMessage(n,[n.port]);if(n.type!==s.INVOKE&&n.type!==s.RESPONSE)return void t.postMessage(n);let c;if(i(o)?(c=f(o.transferList),n.data=o.result):(c=f(u),n.data=o),c){if(r("ff"))for(const r of c)if("byteLength"in r&&r.byteLength>267386880){const r="Worker call with large ArrayBuffer would crash Firefox";switch(n.type){case s.INVOKE:throw r;case s.RESPONSE:return void e(t,{type:s.RESPONSE,jobId:n.jobId,error:a(r)})}}t.postMessage(n,c)}else t.postMessage(n)},e.receiveMessage=function(e){if(!e)return null;const r=e.data;return r?"string"==typeof r?JSON.parse(r):r:null},e.toInvokeError=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});