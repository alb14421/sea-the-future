// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../Error","../has","../promiseUtils","./Connection","./connectionRegistry","./RemoteClient","./WorkerOwner"],function(e,t,n,r,o,i,s,a,c){"use strict";function l(e){if(e&&e.__esModule)return e;const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e)for(const n in e)if("default"!==n){const r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:()=>e[n]})}return t.default=e,Object.freeze(t)}const u=r("host-browser")?Math.min(navigator.hardwareConcurrency-1,r("workers-pool-size")??8):0;let f=r("esri-mobile")?Math.min(u,3):u;f||(f=r("safari")&&r("mac")?7:2);let m=0;const d=[];async function w(e,t){const n=new i,{registryTarget:r,...o}=t;return await n.open(e,o),r&&s.register(r,n),n}let g,h=null;async function b(){if(h)return h;g=new AbortController;const e=[];for(let t=0;t<f;t++){const n=c.create(t).then(e=>(d[t]=e,e));e.push(n)}return h=Promise.all(e),h}t.Connection=i,t.RemoteClient=a,t.initialize=function(){b()},t.open=async function(t,i={}){if("string"!=typeof t)throw new n("workers:undefined-module","modulePath is missing");let s=i.strategy||"distributed";if(r("host-webworker")&&!r("esri-workers")&&(s="local"),"local"===s){let n=await a.loadWorker(t);n||(n=await new Promise((n,r)=>e([t],e=>n(l(e)),r))),o.throwIfAborted(i.signal);const r=i.client||n;return w([a.connect(n,i.schedule)],{...i,client:r})}if(await b(),o.throwIfAborted(i.signal),"dedicated"===s){const e=m++%f;return w([await d[e].open(t,i)],i)}if(i.maxNumWorkers&&i.maxNumWorkers>0){const e=Math.min(i.maxNumWorkers,f);if(e<f){const n=new Array(e);for(let r=0;r<e;++r){const e=m++%f;n[r]=d[e].open(t,i)}return w(n,i)}}return w(d.map(e=>e.open(t,i)),i)},t.openWithPorts=function(e,t){return w(e,{client:t})},t.terminate=function(){h&&(g.abort(),h=null);for(let e=0;e<d.length;e++)d[e]&&d[e].terminate();d.length=0},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});