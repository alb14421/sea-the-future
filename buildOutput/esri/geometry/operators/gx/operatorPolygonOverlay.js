// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/SimpleGeometryCursor","../../../chunks/Geometry","../../../chunks/Envelope2D","../../../chunks/Envelope","../../../chunks/MultiPathImpl","../../../chunks/ProjectionTransformation","../../../chunks/Point2D"],function(t,e,s,i,r,n,o,h){"use strict";function a(t){t&&t.checkProgress()}class m extends e.OverlayGeometryCursor{constructor(t,e,i,r){super(),this.m_shape=null,this.m_topoGraph=null,this.m_curveStitcher=null,this.m_stitchMaxDeviation=0,this.m_chainStack=[],this.m_bitsetToChains=null,this.m_chainsLists=null,this.m_visitedChainsIndex=-1,this.m_index=-1,this.m_geometryIndex=-1,this.m_progressCounter=0,this.m_currentIds=[],this.m_currentEdgeIds=[],t||s.throwInvalidArgumentException(""),this.m_progressTracker=r,this.m_options=0!==i?i:3,(this.m_options<=0||this.m_options>63)&&s.throwInvalidArgumentException("options"),this.m_inputGeometryCursor=t,this.m_sr=e}tock(){return!0}getRank(){return 1}next(){if(-1===this.m_index){this.m_shape=new n.EditShape;const t=new i.Envelope2D;t.setEmpty(),this.m_geometryIndex=this.m_shape.createGeometryUserIndex();for(let e=this.m_inputGeometryCursor.next();null!==e;e=this.m_inputGeometryCursor.next()){s.throwIfMesh(e);const r=this.m_shape.addGeometry(e);e.getGeometryType()!==s.GeometryType.enumPolygon&&s.throwInvalidArgumentException("Polygon Overlay only supports Polygons"),this.m_shape.setGeometryUserIndex(r,this.m_geometryIndex,this.m_inputGeometryCursor.getGeometryID());const o=this.m_inputGeometryCursor.getRank();o>n.defaultRank&&this.m_shape.assignRankToGeometryVertices(r,o);const h=new i.Envelope2D;e.queryLooseEnvelope(h),t.mergeEnvelope2D(h),a(this.m_progressTracker)}this.m_inputGeometryCursor=null;const e=r.calculateToleranceFromGeometryForOp(this.m_sr,t,!0),h=r.calculateToleranceFromGeometryForOp(this.m_sr,t,!1);t.inflate(10*e.total()),this.m_shape.forceSetEnvelope2D(t),this.m_stitchMaxDeviation=0;let m=0;if(this.m_shape.hasCurves()){this.m_curveStitcher=new o.CurveStitcher;const s=o.densificationDeviationFromTolerance(e.total(),t);this.m_stitchMaxDeviation=o.stitchingDensificationDeviationFromTolerance(e.total()),m=o.extraToleranceForCrackingAndClustering(s,this.m_stitchMaxDeviation),o.buildSegmentParentage(this.m_shape,s,e.total(),12e3,this.m_curveStitcher,null,this.m_progressTracker)}if(o.needsCrackingAndClustering(this.m_shape,h,this.m_progressTracker)){o.execute(this.m_shape,e.add(m),this.m_progressTracker,!0,!1);for(let t=this.m_shape.getFirstGeometry();t!==n.nullHandle;t=this.m_shape.getNextGeometry(t))this.m_shape.getGeometryType(t)===s.GeometryType.enumPolygon&&o.execute$1(this.m_shape,t,-1,!1,n.nullHandle,this.m_progressTracker)}this.m_topoGraph=new o.TopoGraph,this.m_topoGraph.buildGeometryParentageSets(),this.m_topoGraph.setEditShape(this.m_shape,this.m_progressTracker);const l=this.m_topoGraph.getFirstChain();for(let t=this.m_topoGraph.getChainFirstIsland(l);t!==n.nullHandle;t=this.m_topoGraph.getChainNextInParent(t))for(let e=this.m_topoGraph.getChainFirstIsland(t);e!==n.nullHandle;e=this.m_topoGraph.getChainNextInParent(e))this.m_chainStack.push(e);if(16&this.m_options){this.m_visitedChainsIndex=this.m_topoGraph.createUserIndexForChains(),this.m_bitsetToChains=new Map,this.m_chainsLists=new o.IndexMultiList;const t=[],e=this.m_topoGraph.getFirstChain();for(t.push(e);t.length>0;){const e=t.at(-1);t.pop();for(let s=this.m_topoGraph.getChainFirstIsland(e);s!==n.nullHandle;s=this.m_topoGraph.getChainNextInParent(s))for(let e=this.m_topoGraph.getChainFirstIsland(s);e!==n.nullHandle;e=this.m_topoGraph.getChainNextInParent(e)){const s=this.m_topoGraph.getChainBitSet(e);if(null!==s&&!s.isZero()){let t;this.m_bitsetToChains.has(s)?t=this.m_bitsetToChains.get(s):(t=this.m_chainsLists.createList(),this.m_bitsetToChains.set(s,t)),this.m_chainsLists.addElement(t,e)}t.push(e)}}}}return this.makeNextGeometry()}getGeometryID(){return this.m_index}getGeometryIDs(){return this.m_currentIds.slice()}getBoundaryIDs(){return this.m_currentEdgeIds.slice()}buildIdsFromBitset(t,e){if(!t)return;const s=this.m_topoGraph.getGeometriesFromBits(t);if(s.length>0){for(let t=0,i=s.length;t<i;t++)e.push(this.m_shape.getGeometryUserIndex(s[t],this.m_geometryIndex));h.numericSort(e)}}makeGeometryFromChainSinglePart(t){this.m_index++;const e=new n.EditShape;null!==this.m_curveStitcher&&e.setCurveStitcherPointer(this.m_curveStitcher);const s=this.m_topoGraph.extractPolygonFromChainAndIslands(e,n.nullHandle,t,n.nullHandle);return null!==this.m_curveStitcher&&this.m_curveStitcher.stitchCurves(e,s,this.m_stitchMaxDeviation,!1),e.getGeometry(s)}makeGeometryFromChainMultiPart(t,e){this.m_index++;const i=new n.EditShape;null!==this.m_curveStitcher&&i.setCurveStitcherPointer(this.m_curveStitcher);const r=this.m_bitsetToChains.has(e);s.geometryReleaseAssert(r);const h=this.m_bitsetToChains.get(e);let a=n.nullHandle;for(let t=this.m_chainsLists.getFirst(h);t!==o.IndexMultiList.st_nullNode();t=this.m_chainsLists.getNext(t)){const e=this.m_chainsLists.getElement(t);a=this.m_topoGraph.extractPolygonFromChainAndIslands(i,a,e,n.nullHandle),this.m_topoGraph.setChainUserIndex(e,this.m_visitedChainsIndex,1)}return null!==this.m_curveStitcher&&this.m_curveStitcher.stitchCurves(i,a,this.m_stitchMaxDeviation,!1),i.getGeometry(a)}makeNextGeometry(){for(a(this.m_progressTracker);this.m_chainStack.length>0;){this.m_currentIds.length=0,this.m_currentEdgeIds.length=0;const t=this.m_chainStack.at(-1);this.m_chainStack.pop();const e=this.m_topoGraph.getChainArea(t);if(0!==e)if(e<0)for(let e=this.m_topoGraph.getChainFirstIsland(t);e!==n.nullHandle;e=this.m_topoGraph.getChainNextInParent(e))this.m_topoGraph.getChainArea(e)>0&&this.m_chainStack.push(e);else{for(let e=this.m_topoGraph.getChainFirstIsland(t);e!==n.nullHandle;e=this.m_topoGraph.getChainNextInParent(e))this.m_topoGraph.getChainArea(e)<0&&this.m_chainStack.push(e);if(-1!==this.m_visitedChainsIndex&&1===this.m_topoGraph.getChainUserIndex(t,this.m_visitedChainsIndex))continue;const e=t=>{const e=t.getUnorderedBitIterator();let s=0;for(;e.next()!==o.UnorderedBitIterator.npos();)if(s++,s>1)return s;return s},s=e(this.m_topoGraph.getChainBitSet(t));if(s>0){if(1===s&&2&this.m_options||s>1&&1&this.m_options){const e=this.m_topoGraph.getChainBitSet(t);return this.buildIdsFromBitset(e,this.m_currentIds),16&this.m_options?this.makeGeometryFromChainMultiPart(t,e):this.makeGeometryFromChainSinglePart(t)}}else{if(!(12&~this.m_options)){if(32&this.m_options){const e=this.m_topoGraph.getChainBoundaryBitSet(t);this.buildIdsFromBitset(e,this.m_currentEdgeIds)}return this.makeGeometryFromChainSinglePart(t)}if(4&this.m_options){const s=this.m_topoGraph.getChainBoundaryBitSet(t);if(e(s)>1)return 32&this.m_options&&this.buildIdsFromBitset(s,this.m_currentEdgeIds),this.makeGeometryFromChainSinglePart(t);continue}if(8&this.m_options){const s=this.m_topoGraph.getChainBoundaryBitSet(t);if(1===e(s))return 32&this.m_options&&this.buildIdsFromBitset(s,this.m_currentEdgeIds),this.makeGeometryFromChainSinglePart(t);continue}}}}return null}}const l=new class{getOperatorType(){return 10012}accelerateGeometry(t,e,s){return!1}canAccelerateGeometry(t){return!1}supportsCurves(){return!0}executeMany(t,e,s,i){return new m(t,e,s,i)}};t.executeMany=function(t,s,i){return l.executeMany(new e.SimpleGeometryCursor(t),s,i,null)},t.supportsCurves=function(){return l.supportsCurves()},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});