// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../config","../../core/Error","../../core/Logger","../Polygon","../Polyline","./normalizeUtilsCommon","./spatialReferenceUtils","./webMercatorUtils","../../rest/geometryService/cut","../../rest/geometryService/simplify"],function(e,t,n,o,s,r,i,l,c,f,a){"use strict";const u=()=>o.getLogger("esri.geometry.support.normalizeUtils");function h(e){return"polygon"===e[0].type}function p(e){return"polyline"===e[0].type}function g(e){const t=[];let n=0,o=0;for(let s=0;s<e.length;s++){const r=e[s];let i=null;for(let e=0;e<r.length;e++)i=r[e],t.push(i),0===e?(n=i[0],o=n):(n=Math.min(n,i[0]),o=Math.max(o,i[0]));i&&t.push([(n+o)/2,0])}return t}function m(e,t){if(!(e instanceof r||e instanceof s)){const e="straightLineDensify: the input geometry is neither polyline nor polygon";throw u().error(e),new n("internal:geometry",e)}const o=i.getGeometryParts(e),l=[];for(const e of o){const n=[];l.push(n),n.push([e[0][0],e[0][1]]);for(let o=0;o<e.length-1;o++){const s=e[o][0],r=e[o][1],i=e[o+1][0],l=e[o+1][1],c=Math.sqrt((i-s)*(i-s)+(l-r)*(l-r)),f=(l-r)/c,a=(i-s)/c,u=c/t;if(u>1){for(let e=1;e<=u-1;e++){const o=e*t,i=a*o+s,l=f*o+r;n.push([i,l])}const e=(c+Math.floor(u-1)*t)/2,o=a*e+s,i=f*e+r;n.push([o,i])}n.push([i,l])}}return function(e){return"polygon"===e.type}(e)?new s({rings:l,spatialReference:e.spatialReference}):new r({paths:l,spatialReference:e.spatialReference})}function y(e,t,n){if(t){const t=m(e,1e6);e=c.webMercatorToGeographic(t,!0)}return n&&(e=i.updatePolyGeometry(e,n)),e}function d(e,t,n){if(Array.isArray(e)){const o=e[0];if(o>t){const n=i.offsetMagnitude(o,t);e[0]=o+n*(-2*t)}else if(o<n){const t=i.offsetMagnitude(o,n);e[0]=o+t*(-2*n)}}else{const o=e.x;if(o>t){const n=i.offsetMagnitude(o,t);e=e.clone().offset(n*(-2*t),0)}else if(o<n){const t=i.offsetMagnitude(o,n);e=e.clone().offset(t*(-2*n),0)}}return e}e.getClosestDenormalizedXToReference=function(e,t,n){const o=l.getInfo(n);if(null==o)return e;const[s,r]=o.valid,i=2*r;let c=0,f=0;t>r?c=Math.ceil(Math.abs(t-r)/i):t<s&&(c=-Math.ceil(Math.abs(t-s)/i)),e>r?f=Math.ceil(Math.abs(e-r)/i):e<s&&(f=-Math.ceil(Math.abs(e-s)/i));let a=e+(c-f)*i;const u=a-t;return u>r?a-=i:u<s&&(a+=i),a},e.getDenormalizedExtent=function(e){if(!e)return null;const t=e.extent;if(!t)return null;const n=e.spatialReference&&l.getInfo(e.spatialReference);if(!n)return t;const[o,s]=n.valid,r=2*s,{width:i}=t;let c,{xmin:f,xmax:a}=t;if([f,a]=[a,f],"extent"===e.type||0===i||i<=s||i>r||f<o||a>s)return t;switch(e.type){case"polygon":if(!(e.rings.length>1))return t;c=g(e.rings);break;case"polyline":if(!(e.paths.length>1))return t;c=g(e.paths);break;case"multipoint":c=e.points}const u=t.clone();for(let e=0;e<c.length;e++){let t=c[e][0];t<0?(t+=s,a=Math.max(t,a)):(t-=s,f=Math.min(t,f))}return u.xmin=f,u.xmax=a,u.width<i?(u.xmin-=s,u.xmax-=s,u):t},e.normalizeCentralMeridian=async function e(n,o,g){if(!Array.isArray(n))return e([n],o);o&&"string"!=typeof o&&u().warn("normalizeCentralMeridian()","The url object is deprecated, use the url string instead");const m="string"==typeof o?o:o?.url??t.geometryServiceUrl;let M,x,b,P,w,R,z,v,G=0;const T=[],I=[];for(const e of n)if(null!=e)if(M||(M=e.spatialReference,x=l.getInfo(M),b=M.isWebMercator,R=b?102100:4326,P=i.cutParams[R].maxX,w=i.cutParams[R].minX,z=i.cutParams[R].plus180Line,v=i.cutParams[R].minus180Line),x)if("mesh"===e.type)I.push(e);else if("point"===e.type)I.push(d(e.clone(),P,w));else if("multipoint"===e.type){const t=e.clone();t.points=t.points.map(e=>d(e,P,w)),I.push(t)}else if("extent"===e.type){const t=e.clone()._normalize(!1,!1,x);I.push(t.rings?new s(t):t)}else if(e.extent){const t=e.extent,n=i.offsetMagnitude(t.xmin,w)*(2*P);let o=0===n?e.clone():i.updatePolyGeometry(e.clone(),n);t.offset(n,0);let{xmin:s,xmax:r}=t;s=Number(s.toFixed(9)),r=Number(r.toFixed(9)),t.intersects(z)&&r!==P?(G=r>G?r:G,o=y(o,b),T.push(o),I.push("cut")):t.intersects(v)&&s!==w?(G=r*(2*P)>G?r*(2*P):G,o=y(o,b,360),T.push(o),I.push("cut")):I.push(o)}else I.push(e.clone());else I.push(e);else I.push(e);let L=i.offsetMagnitude(G,P),S=-90;const U=L,A=new r;for(;L>0;){const e=360*L-180;A.addPath([[e,S],[e,-1*S]]),S*=-1,L--}if(T.length>0&&U>0){const e=function(e,t){let n=-1;for(let o=0;o<t.cutIndexes.length;o++){const s=t.cutIndexes[o],r=t.geometries[o],l=i.getGeometryParts(r);for(let e=0;e<l.length;e++){const t=l[e];t.some(n=>{if(n[0]<180)return!0;{let n=0;for(let e=0;e<t.length;e++){const o=t[e][0];n=o>n?o:n}n=Number(n.toFixed(9));const o=-360*i.offsetMagnitude(n,180);for(let n=0;n<t.length;n++){const t=r.getPoint(e,n);r.setPoint(e,n,t.clone().offset(o,0))}return!0}})}if(s===n){if(h(e))for(const t of i.getGeometryParts(r))e[s]=e[s].addRing(t);else if(p(e))for(const t of i.getGeometryParts(r))e[s]=e[s].addPath(t)}else n=s,e[s]=r}return e}(T,await f.cut(m,T,A,g)),t=[],o=[];for(let s=0;s<I.length;s++){const r=I[s];if("cut"!==r)o.push(r);else{const r=e.shift(),i=n[s];null!=i&&"polygon"===i.type&&i.rings&&i.rings.length>1&&r.rings.length>=i.rings.length?(t.push(r),o.push("simplify")):o.push(b?c.geographicToWebMercator(r):r)}}if(!t.length)return o;const s=await a.simplify(m,t,g),r=[];for(let e=0;e<o.length;e++){const t=o[e];"simplify"!==t?r.push(t):r.push(b?c.geographicToWebMercator(s.shift()):s.shift())}return r}const C=[];for(let e=0;e<I.length;e++){const t=I[e];if("cut"!==t)C.push(t);else{const e=T.shift();C.push(!0===b?c.geographicToWebMercator(e):e)}}return C},e.normalizeMapX=function(e,t){const n=l.getInfo(t);if(n){const[t,o]=n.valid,s=o-t;if(e<t)for(;e<t;)e+=s;if(e>o)for(;e>o;)e-=s}return e},e.straightLineDensify=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});