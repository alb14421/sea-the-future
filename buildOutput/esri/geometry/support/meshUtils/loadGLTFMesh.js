// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../Color","../../../colorUtils","../../../request","../../../core/Error","../../../core/MapUtils","../../../core/mathUtils","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../MeshComponent","../MeshMaterialMetallicRoughness","../MeshTexture","../MeshTextureTransform","../MeshVertexAttributes","../meshVertexSpaceUtils","../buffer/BufferView","../../../chunks/vec3","../../../chunks/vec4","../buffer/utils","./vertexSpaceConversion","../../../views/3d/glTF/DefaultLoadingContext","../../../views/3d/glTF/loader","../../../views/3d/glTF/internal/indexUtils","../../../views/3d/glTF/internal/resourceUtils","../../../chunks/vec33","../../../chunks/vec43","../../../chunks/vec2"],function(e,t,r,o,n,a,s,l,i,c,u,f,m,p,d,g,x,w,T,h,V,v,B,b,M,y,C,S,R){"use strict";function F(e,t){if(null==e)return"-";const r=e.typedBuffer;return`${a.getOrCreateMapValue(t,r.buffer,()=>t.size)}/${r.byteOffset}/${r.byteLength}`}function A(e){return null!=e?e.toString():"-"}function $(e,t,r){t.writeVertices&&function(e,t){const{position:r,normal:o,tangent:n,color:a,texCoord0:c}=e.vertexAttributes,u=t.region.start,{attributes:f,transform:m}=t.gltf,p=f.position.count;if(T.transformMat4View(r.slice(u,p),f.position,m),null!=f.normal&&null!=o){const e=l.normalFromMat4(i.create(),m),t=o.slice(u,p);T.transformMat3View(t,f.normal,e),s.hasScaling(e)&&T.normalizeView(t,t)}else null!=o&&C.fill(o,0,0,1,{dstIndex:u,count:p});if(null!=f.tangent&&null!=n){const e=l.fromMat4(i.create(),m),t=n.slice(u,p);h.transformMat3View(t,f.tangent,e),s.hasScaling(e)&&h.normalize(t,t)}else null!=n&&S.fill(n,0,0,1,1,{dstIndex:u,count:p});if(null!=f.texCoord0&&null!=c?R.normalizeIntegerBufferView(c.slice(u,p),f.texCoord0):null!=c&&R.fill(c,0,0,{dstIndex:u,count:p}),null!=f.color&&null!=a){const e=f.color,t=a.slice(u,p);if(4===e.elementCount)e instanceof w.BufferViewVec4f?h.linearToSRGBView(t,e,1,255):(e instanceof w.BufferViewVec4u8||e instanceof w.BufferViewVec4u16)&&h.linearToSRGBView(t,e,1/255,255);else{S.fill(t,255,255,255,255);const r=w.BufferViewVec3u8.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof w.BufferViewVec3f?T.linearToSRGBView(r,e,1,255):(e instanceof w.BufferViewVec3u8||e instanceof w.BufferViewVec3u16)&&T.linearToSRGBView(r,e,1/255,255)}}else null!=a&&S.fill(a.slice(u,p),255,255,255,255)}(e,t);const{indices:o,attributes:n,primitiveType:a,material:c}=t.gltf;let u=M.convertPrimitiveToTriangles(o||n.position.count,a);const m=t.region.start;if(m){const e=new Uint32Array(u);for(let t=0;t<u.length;t++)e[t]+=m;u=e}e.components.push(new f({name:t.gltf.name,faces:u,material:r.get(c),shading:n.normal?"source":"flat",trustSourceNormals:!0}))}function U(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function G(e){switch(e){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function k(e){return e**(1/r.colorGamma)*255}e.loadGLTFMesh=async function(e,r,l){const i=new B.DefaultLoadingContext(function(e){const t=e?.resolveFile;return t?{busy:!1,request:async(e,r,n)=>{const a=t?.(e)??e,s=2===r?"image":1===r||3===r?"array-buffer":"json";return(await o(a,{responseType:s,signal:n?.signal,timeout:0})).data}}:null}(l)),f=(await b.loadGLTF(i,r,l,!0)).model,T=f.lods.shift(),h=new Map,M=new Map;f.textures.forEach((e,t)=>{return h.set(t,(o=e,new p({data:(y.isEncodedMeshTexture(o.data),o.data),wrap:(r=o.parameters.wrap,{horizontal:G(r.s),vertical:G(r.t)})})));var r,o}),f.materials.forEach((e,r)=>M.set(r,function(e,r){const o=new t((l=e.color,i=e.opacity,u.fromValues(k(l[0]),k(l[1]),k(l[2]),i))),n=e.emissiveFactor?new t(function(e){return c.fromValues(k(e[0]),k(e[1]),k(e[2]))}(e.emissiveFactor)):null,a=e=>e?new d({scale:e.scale?[e.scale[0],e.scale[1]]:[1,1],rotation:s.rad2deg(e.rotation??0),offset:e.offset?[e.offset[0],e.offset[1]]:[0,0]}):null;var l,i;return new m({color:o,colorTexture:r.get(e.colorTexture),normalTexture:r.get(e.normalTexture),emissiveColor:n,emissiveTexture:r.get(e.emissiveTexture),occlusionTexture:r.get(e.occlusionTexture),alphaMode:U(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:r.get(e.metallicRoughnessTexture),colorTextureTransform:a(e.colorTextureTransform),normalTextureTransform:a(e.normalTextureTransform),occlusionTextureTransform:a(e.occlusionTextureTransform),emissiveTextureTransform:a(e.emissiveTextureTransform),metallicRoughnessTextureTransform:a(e.metallicRoughnessTextureTransform)})}(e,h)));const C=function(e){let t=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1},o=new Map,n=new Map,s=[];for(const l of e.parts){const{position:e,normal:i,color:c,tangent:u,texCoord0:f}=l.attributes,m=`\n      ${F(e,o)}/\n      ${F(i,o)}/\n      ${F(c,o)}/\n      ${F(u,o)}/\n      ${F(f,o)}/\n      ${A(l.transform)}\n    `;let p=!1;const d=a.getOrCreateMapValue(n,m,()=>(p=!0,{start:t,length:e.count}));p&&(t+=e.count),i&&(r.normal=!0),c&&(r.color=!0),u&&(r.tangent=!0),f&&(r.texCoord0=!0),s.push({gltf:l,writeVertices:p,region:d})}return{vertexAttributes:{position:V.createBuffer(w.BufferViewVec3f64,t),normal:r.normal?V.createBuffer(w.BufferViewVec3f,t):null,tangent:r.tangent?V.createBuffer(w.BufferViewVec4f,t):null,color:r.color?V.createBuffer(w.BufferViewVec4u8,t):null,texCoord0:r.texCoord0?V.createBuffer(w.BufferViewVec2f,t):null},parts:s,components:[]}}(T);for(const e of C.parts)$(C,e,M);const{position:S,normal:R,tangent:E,color:L,texCoord0:z}=C.vertexAttributes,O=x.selectVertexSpace(e,l),D=e.spatialReference.isGeographic?x.selectVertexSpace(e):O,I=v.convertVertexSpace({vertexAttributes:{position:S.typedBuffer,normal:R?.typedBuffer,tangent:E?.typedBuffer},vertexSpace:D,spatialReference:e.spatialReference},O,{allowBufferReuse:!0,sourceUnit:l?.unitConversionDisabled?void 0:"meters"});if(!I)throw new n("load-gltf-mesh:vertex-space-projection",`Failed to load mesh from glTF because we could not convert the vertex space from ${D.type} to ${O.type}`);return{transform:null,vertexSpace:O,components:C.components,spatialReference:e.spatialReference,vertexAttributes:new g.MeshVertexAttributes({...I,color:L?.typedBuffer,uv:z?.typedBuffer})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});