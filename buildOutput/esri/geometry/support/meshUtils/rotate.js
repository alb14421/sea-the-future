// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Logger","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/quat","../../../core/libs/gl-matrix-2/factories/quatf64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../Point","../../spatialReferenceEllipsoidUtils","../../projection/computeTranslationToOriginAndRotation","../../projection/projectPointToVector","../axisAngleDegrees","../MeshTransform","../meshVertexSpaceUtils","./geographicUtils","./projection","./vertexSpaceConversion"],function(e,t,r,o,i,n,a,l,c,s,g,p,f,u,m,x,P,j,v,b){"use strict";const A=()=>t.getLogger("esri.geometry.support.meshUtils.rotate");function R(e,t,r,o=s.ZEROS){if(null!=e){i.fromRotation(F,m.angleRad(t),m.axis(t));for(let t=0;t<e.length;t+=r){for(let r=0;r<3;r++)h[r]=e[t+r]-o[r];c.transformMat4(h,h,F);for(let r=0;r<3;r++)e[t+r]=h[r]+o[r]}}}const h=s.create(),T=n.create(),d=m.create(),F=n.create(),S=o.create(),E=s.create(),C=l.create();e.rotate=function(e,t,o){if(!e.vertexAttributes?.position||0===t[3])return;const{spatialReference:n,vertexSpace:l}=e,M=o?.origin??e.origin,y=o?.geographic,O=j.performGlobalOperation(A,l,n,y);P.isMeshWithRelativeVertexSpace(e)?function(e,t,r){e.transform??=new x;const{vertexSpace:o,transform:n,spatialReference:l}=e,[p,f,u]=o.origin,P=new g({x:p,y:f,z:u,spatialReference:l}),j=h;if(P.equals(r))c.set(j,0,0,0);else if(!b.projectPointToVertexSpace(j,r,e))return void v.logProjectionError(A(),r.spatialReference,l,v.loadProjectErrorMessage);a.setAxisAngle(C,m.axis(t),m.angleRad(t));const R=i.fromRotationTranslationScaleOrigin(T,C,s.ZEROS,s.ONES,j),{localMatrix:d}=n,F=i.multiply(T,R,d);n.scale=i.getScale(s.create(),F),i.scale(F,F,c.inverse(h,n.scale));const S=n.rotationAxis;n.rotation=m.fromMatrix(F),0===n.rotationAngle&&(n.rotationAxis=S),n.translation=i.getTranslation(s.create(),F)}(e,t,M):O?function(e,t,o){const i=e.spatialReference,n=p.getSphericalPCPF(i),a=E;if(!u.projectPointToVector(o,a,n)&&(v.logProjectionError(A(),o.spatialReference,n,"Falling back to mesh origin"),!u.projectPointToVector(e.origin,a,n)))return void v.logProjectionError(A(),e.origin.spatialReference,n);const l=e.vertexAttributes.position,s=e.vertexAttributes.normal,g=e.vertexAttributes.tangent,x=new Float64Array(l.length),P=null!=s?new Float32Array(s.length):null,j=null!=g?new Float32Array(g.length):null;f.computeTranslationToOriginAndRotation(n,a,F,n),r.fromMat4(S,F);const b=d;c.transformMat3(m.axis(d),m.axis(t),S),b[3]=t[3],!v.projectToPCPF(l,i,x,n)||null!=s&&null!=P&&!v.projectNormalToPCPF(s,l,i,x,n,P)||null!=g&&null!=j&&!v.projectTangentToPCPF(g,l,i,x,n,j)?v.logProjectionError(A(),i,n):(R(x,b,3,a),!v.projectFromPCPF(x,n,l,i)||null!=s&&null!=P&&(R(P,b,3),!v.projectNormalFromPCPF(P,l,i,x,n,s))||null!=g&&null!=j&&(R(j,b,4),!v.projectTangentFromPCPF(j,l,i,x,n,g))?v.logProjectionError(A(),n,i):e.vertexAttributesChanged())}(e,t,M):function(e,t,r){const o=E;if(!u.projectPointToVector(r,o,e.spatialReference)){const t=e.origin;return o[0]=t.x,o[1]=t.y,o[2]=t.z,void v.logProjectionError(A(),r.spatialReference,e.spatialReference,v.loadProjectErrorMessage)}R(e.vertexAttributes.position,t,3,o),R(e.vertexAttributes.normal,t,3),R(e.vertexAttributes.tangent,t,4),e.vertexAttributesChanged()}(e,t,M)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});