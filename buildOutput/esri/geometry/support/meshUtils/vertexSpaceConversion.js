// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Logger","../../../core/mathUtils","../../../core/unitUtils","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../spatialReferenceEllipsoidUtils","../../projection/computeTranslationToOriginAndRotation","../../projection/projectPointToVector","../meshVertexSpaceUtils","../spatialReferenceUtils","../../../chunks/vec3","./projection"],function(t,n,r,e,o,i,a,l,c,s,u,f,g,p,m,P,v){"use strict";const x=()=>n.getLogger("esri.geometry.support.meshUtils.vertexSpaceConversion");function T(t,n){return n?.useEllipsoid&&m.isEarth(t)?u.WGS84ECEFSpatialReference:u.getSphericalPCPF(t)}function F(t,n){const r=new Float64Array(t.position.length);P.transformMat4(r,t.position,n);const e=t.normal?new Float32Array(t.normal.length):null,o=t.tangent?new Float32Array(t.tangent.length):null;return e&&t.normal&&v.transformNormal(t.normal,e,n),o&&t.tangent&&v.transformTangent(t.tangent,o,n),{position:r,normal:e,tangent:o}}function h(t,n,r,e){const o=j(n,r,e);y(o)||a.scale(t,t,[o,o,o])}function j(t,n,r){const e=!!(1&r),o=!!(2&r),i=n?.sourceUnit,a=n?.targetUnit;if(!i&&!a)return 1;let l=A(i,t);e||!i||y(l)||(x().warn("source unit conversion not supported"),l=1);let c=1/A(a,t);return o||!a||y(c)||(x().warn("target unit conversion not supported"),c=1),l*c}function y(t){return r.floatEqualUlp(t,1)}function A(t,n){if(null==t)return 1;const r=e.getMetersPerCartesianUnitForSR(n);return 1/e.convertUnit(r,"meters",t)}const S=l.create(),E=l.create(),R=i.create(),w=s.create(),d=l.create();t.convertVertexSpace=function(t,n,r){const{vertexSpace:e,transform:i,vertexAttributes:s}=t,u=p.isRelativeVertexSpace(e)?i:null,g=j(t.spatialReference,r,3);if(p.vertexSpaceEquals(e,n)&&(!u||a.exactEquals(u.localMatrix,l.IDENTITY))&&y(g)){const{position:t,normal:n,tangent:e}=s,o=r?.allowBufferReuse;return{position:o?t:t.slice(),normal:o?n:n?.slice(),tangent:o?e:e?.slice()}}switch(t.vertexSpace.type){case"local":return"local"===n.type?function({vertexAttributes:t,spatialReference:n,transform:r},{origin:e},o,i){const l=T(n,i);if(!f.computeTranslationToOriginAndRotation(n,e,S,l))return v.logProjectionError(x(),n,l),null;if(r&&a.multiply(S,S,r.localMatrix),!f.computeTranslationToOriginAndRotation(n,o,E,l))return v.logProjectionError(x(),l,n),null;a.invert(E,E);const c=a.multiply(S,E,S);return h(c,n,i,3),F(t,c)}(t,t.vertexSpace,n.origin,r):function({spatialReference:t,vertexAttributes:n,transform:r},{origin:e},o,i){const l=T(t,i);if(!f.computeTranslationToOriginAndRotation(t,e,S,l))return v.logProjectionError(x(),t,l),null;r&&a.multiply(S,S,r.localMatrix),h(S,t,i,1);const s=new Float64Array(n.position.length),u=function(t,n,r,e,o){P.transformMat4(e,t,n);const i=new Float64Array(t.length);return v.projectFromPCPF(e,o,i,r)?i:(v.logProjectionError(x(),o,r),null)}(n.position,S,t,s,l);if(!u)return null;const g=function(t,n,r,e,o,i){if(null==o)return null;const a=new Float32Array(o.length);return v.transformNormal(o,a,i),v.projectNormalFromPCPF(a,t,n,r,e,a)?a:(v.logProjectionError(x(),e,n),null)}(u,t,s,l,n.normal,S);if(n.normal&&!g)return null;const p=function(t,n,r,e,o,i){if(null==o)return null;const a=new Float32Array(o.length);return v.transformTangent(o,a,i),v.projectTangentFromPCPF(a,t,n,r,e,a)?a:(v.logProjectionError(x(),e,n),null)}(u,t,s,l,n.tangent,S);if(n.tangent&&!p)return null;if(o){const t=c.negate(w,o);P.translate(u,u,t)}return{position:u,normal:g,tangent:p}}(t,t.vertexSpace,n.origin,r);case"georeferenced":return"local"===n.type?function({vertexAttributes:t,spatialReference:n,transform:r},{origin:e},i,l){const c=T(n,l);if(!f.computeTranslationToOriginAndRotation(n,i,S,c))return v.logProjectionError(x(),n,c),null;const s=1/j(n,l,2);a.scale(S,S,[s,s,s]);const u=a.invert(E,S),{position:g,normal:p,tangent:m}=function(t,n,r){if(!n)return t;if(!r){const{position:r,normal:e,tangent:o}=t;return{position:P.translate(new Float64Array(r.length),r,n),tangent:o,normal:e}}const e=F(t,r.localMatrix);return P.translate(e.position,e.position,n),e}(t,e,r),h=new Float64Array(g.length),y=function(t,n,r,e,o){const i=v.projectToPCPF(t,n,e,o);if(!i)return v.logProjectionError(x(),n,o),null;const a=new Float64Array(i.length);return P.transformMat4(a,i,r),a}(g,n,u,h,c);if(!y)return null;const A=o.normalFromMat4(R,u),w=function(t,n,r,e,o,i,a){if(null==t)return null;const l=a??new Float32Array(t.length);return v.projectNormalToPCPF(t,n,r,e,o,l)?(P.transformMat3(l,l,i),l):(v.logProjectionError(x(),r,o),null)}(p,g,n,h,c,A,p!==t.normal?p:void 0);if(!w&&p)return null;const d=function(t,n,r,e,o,i,a){if(null==t)return null;const l=a??new Float32Array(t.length);return v.projectTangentToPCPF(t,n,r,e,o,l)?(P.transformMat3(l,l,i,4),l):(v.logProjectionError(x(),r,o),null)}(m,g,n,h,c,A,m!==t.tangent?m:void 0);return!d&&m?null:{position:y,normal:w,tangent:d}}(t,t.vertexSpace,n.origin,r):function({vertexAttributes:t,transform:n,spatialReference:r},{origin:e},o,i){const s=j(r,i,3),u=e||!y(s)?a.copy(S,n?.localMatrix??l.IDENTITY):null;u&&h(u,r,i,3);const{position:f,normal:g,tangent:p}=u?F(t,u):t,m=i?.allowBufferReuse,v=m?f:new Float64Array(f.length);let x=f;if(e&&(x=P.translate(v,x,e)),o){const t=c.negate(w,o);x=P.translate(v,x,t)}return{position:x!==t.position||m?x:x.slice(),normal:g!==t.normal||m?g:g?.slice(),tangent:p!==t.tangent||m?p:p?.slice()}}(t,t.vertexSpace,n.origin,r)}},t.getUnitToSpatialReferenceScaleConversion=A,t.projectPointToVertexSpace=function(t,n,{vertexSpace:r,spatialReference:e}){if("georeferenced"===r.type){const o=t;if(!g.projectPointToVector(n,o,e))return!1;const{origin:i}=r;return c.subtract(t,o,i),!0}const o=u.getSphericalPCPF(e),i=t;if(!g.projectPointToVector(n,i,o))return!1;const{origin:l}=r,s=d;if(!f.computeTranslationToOriginAndRotation(e,l,s,o))return!1;const p=a.invert(d,s);return null!=p&&(c.transformMat4(t,i,p),!0)},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});