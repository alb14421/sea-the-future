// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../rest/support/ClassBreaksDefinition","../rest/support/generateRendererUtils"],function(e,n,t){"use strict";const l=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,i=new Set(["esriFieldTypeDate","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeOID","esriFieldTypeBigInteger"]),a=new Set(["esriFieldTypeTimeOnly","esriFieldTypeDateOnly"]),u=["min","max","avg","stddev","count","sum","variance","nullcount","median"];function o(e){return null==e||"string"==typeof e&&!e?"<Null>":e}function r(e){const n=null!=e.normalizationField||null!=e.normalizationType,t=null!=e.minValue||null!=e.maxValue,l=!!e.sqlExpression&&e.supportsSQLExpression;return!n&&!t&&!l}function s(e){const{values:n,useSampleStdDev:t,supportsNullCount:l,outStatisticTypes:i}=e;let a=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,o=null,r=null,s=null,d=null,m=0;const f=null==e.minValue?-1/0:e.minValue,p=null==e.maxValue?1/0:e.maxValue;for(const e of n)Number.isFinite(e)?e>=f&&e<=p&&(o=null===o?e:o+e,a=Math.min(a,e),u=Math.max(u,e),m++):"string"==typeof e&&m++;if(m&&null!=o){r=o/m;let e=0;for(const t of n)Number.isFinite(t)&&t>=f&&t<=p&&(e+=(t-r)**2);d=t?m>1?e/(m-1):0:m>0?e/m:0,s=Math.sqrt(d)}else a=null,u=null;const v={avg:r,count:m,max:u,min:a,stddev:s,sum:o,variance:d};return l&&(v.nullcount=n.length-m),!e.percentileParams||i?.include?.length&&!i.include.includes("median")||i?.exclude?.length&&i.exclude.includes("median")||(v.median=c(n,e.percentileParams)),v}function c(e,n){const{fieldType:t,value:l,orderBy:i,isDiscrete:a}=n,u=d(t,"desc"===i);if(0===(e=[...e].filter(e=>null!=e).sort((e,n)=>u(e,n))).length)return null;if(l<=0)return e[0];if(l>=1)return e[e.length-1];const o=(e.length-1)*l,r=Math.floor(o),s=r+1,c=o%1,m=e[r],f=e[s];return s>=e.length||a||"string"==typeof m||"string"==typeof f?m:m*(1-c)+f*c}function d(e,n){if(e){if(i.has(e))return F(n);if(a.has(e))return y(n,!1);if("esriFieldTypeTimestampOffset"===e)return function(e){return e?g:v}(n);const t=y(n,!0);if("esriFieldTypeString"===e)return t;if("esriFieldTypeGUID"===e||"esriFieldTypeGlobalID"===e)return(e,n)=>t(b(e),b(n))}const t=n?1:-1,l=F(n),u=y(n,!0),o=p(n);return(e,n)=>"number"==typeof e&&"number"==typeof n?l(e,n):"string"==typeof e&&"string"==typeof n?u(e,n):o(e,n)??t}const m=(e,n)=>null==e?null==n?0:1:null==n?-1:null,f=(e,n)=>null==e?null==n?0:-1:null==n?1:null;function p(e){return e?m:f}const v=(e,n)=>f(e,n)??(e===n?0:new Date(e).getTime()-new Date(n).getTime()),g=(e,n)=>m(e,n)??(e===n?0:new Date(n).getTime()-new Date(e).getTime()),T=(e,n)=>f(e,n)??(e===n?0:e<n?-1:1),h=(e,n)=>m(e,n)??(e===n?0:e<n?1:-1);function y(e,n){if(!n)return e?h:T;const t=p(e);return e?(e,n)=>{const l=t(e,n);return null!=l?l:(e=e.toUpperCase())>(n=n.toUpperCase())?-1:e<n?1:0}:(e,n)=>{const l=t(e,n);return null!=l?l:(e=e.toUpperCase())<(n=n.toUpperCase())?-1:e>n?1:0}}const V=(e,n)=>m(e,n)??n-e,x=(e,n)=>f(e,n)??e-n;function F(e){return e?V:x}function b(e){return e.slice(24,36)+e.slice(19,23)+e.slice(16,18)+e.slice(14,16)+e.slice(11,13)+e.slice(9,11)+e.slice(6,8)+e.slice(4,6)+e.slice(2,4)+e.slice(0,2)}function I(e){return"coded-value"!==e?.type?[]:e.codedValues.map(e=>e.code)}function D(e,n,l){const i=S({field:n.field,normalizationType:n.normalizationType,normalizationField:n.normalizationField,classificationMethod:n.classificationMethod,standardDeviationInterval:n.standardDeviationInterval,definedInterval:n.definedInterval,breakCount:n.numClasses||5});return e=function(e,n,t){const l=n??-1/0,i=t??1/0;return e.filter(e=>Number.isFinite(e)&&e>=l&&e<=i)}(e,n.minValue,n.maxValue),t.createGenerateRendererClassBreaks({definition:i,values:e,normalizationTotal:n.normalizationTotal},l)}function S(e){const{breakCount:t,field:l,normalizationField:i,normalizationType:a}=e,u=e.classificationMethod||"equal-interval",o="standard-deviation"===u?e.standardDeviationInterval||1:void 0,r="defined-interval"===u?e.definedInterval:void 0;return new n({breakCount:t,classificationField:l,classificationMethod:u,normalizationField:"field"===a?i:void 0,normalizationType:a,standardDeviationInterval:o,definedInterval:r})}function z(e,n,t=!1){const{field:l,classificationMethod:i,standardDeviationInterval:a,definedInterval:u,normalizationType:o,normalizationField:c,normalizationTotal:d,minValue:m,maxValue:f}=n,p=n.numBins||10;let v=null,g=null,T=null;if(i&&"equal-interval"!==i||o){const{classBreaks:n}=D(e,{field:l,normalizationType:o,normalizationField:c,normalizationTotal:d,classificationMethod:i,standardDeviationInterval:a,definedInterval:u,minValue:m,maxValue:f,numClasses:p},null!=m&&null!=f?[m,f]:void 0);v=n[0]?.minValue,g=n[n.length-1]?.maxValue,T=n.map(e=>[e.minValue,e.maxValue])}else{if(null!=m&&null!=f)v=m,g=f;else{const n=s({values:e,minValue:m,maxValue:f,useSampleStdDev:!o,supportsNullCount:r({normalizationType:o,normalizationField:c,minValue:m,maxValue:f})});v=n.min??null,g=n.max??null}T=C(v??0,g??0,p)}if(t&&T.length){const e=T.at(-1)[1];T.push([e,e])}return{min:v,max:g,intervals:T}}function N(e,n){let t=-1;for(let l=e.length-1;l>=0;l--)if(n>=e[l][0]){t=l;break}return t}function C(e,n,t){const l=(n-e)/t,i=[];let a,u=e;for(let e=1;e<=t;e++)a=u+l,a=Number(a.toFixed(16)),i.push([u,e===t?n:a]),u=a;return i}e.binIndex=N,e.calculateClassBreaks=D,e.calculateHistogram=function(e,n){const t=z(e,n);if(null==t.min&&null==t.max)return{bins:[],minValue:t.min,maxValue:t.max,normalizationTotal:n.normalizationTotal};const l=t.intervals,i=t.min??0,a=t.max??0,u=l.map((e,n)=>({minValue:l[n][0],maxValue:l[n][1],count:0}));for(const n of e)if(null!=n&&n>=i&&n<=a){const e=N(l,n);e>-1&&u[e].count++}return{bins:u,minValue:i,maxValue:a,normalizationTotal:n.normalizationTotal}},e.calculatePercentile=c,e.calculateStatistics=s,e.calculateStringStatistics=function(e){const{outStatisticTypes:n}=e,t=e.returnDistinct?[...new Set(e.values)]:e.values,l=t.filter(e=>null!=e).sort(),i=l.length,a={count:i,min:l[0],max:l[i-1]};return e.supportsNullCount&&(a.nullcount=t.length-i),!e.percentileParams||n?.include?.length&&!n.include.includes("median")||n?.exclude?.length&&n.exclude.includes("median")||(a.median=c(t,e.percentileParams)),a},e.calculateUniqueValuesCount=function(e){const n={};for(let t of e)(null==t||"string"==typeof t&&""===t.trim())&&(t=null),null==n[t]?n[t]={count:1,data:t}:n[t].count++;return{count:n}},e.createClassBreaksDefinition=S,e.createUVResult=function(e,n,t,l){const i=e.count,a=[];if(t&&n){const e=[],t=I(n[0]);for(const i of t)if(n[1]){const t=I(n[1]);for(const a of t)if(n[2]){const t=I(n[2]);for(const n of t)e.push(`${o(i)}${l}${o(a)}${l}${o(n)}`)}else e.push(`${o(i)}${l}${o(a)}`)}else e.push(i);for(const n of e)i.hasOwnProperty(n)||(i[n]={data:n,count:0})}for(const e in i){const n=i[e];a.push({value:n.data,count:n.count,label:n.label})}return{uniqueValueInfos:a}},e.getAttributeComparator=d,e.getBinParams=z,e.getEqualIntervalBins=C,e.getNormalizedValue=function(e,n,t,l){let i=null;switch(n){case"log":0!==e&&(i=Math.log(e)*Math.LOG10E);break;case"percent-of-total":Number.isFinite(l)&&0!==l&&(i=e/l*100);break;case"field":Number.isFinite(t)&&0!==t&&(i=e/t);break;case"natural-log":e>0&&(i=Math.log(e));break;case"square-root":e>0&&(i=e**.5)}return i},e.isNullCountSupported=r,e.processNullValue=o,e.processSummaryStatisticsResult=function(e,n,t){let l;for(l in e)n?.include?.length&&!n.include.includes(l)||n?.exclude?.length&&n.exclude.includes(l)?delete e[l]:u.includes(l)&&(Number.isFinite(e[l])||(e[l]=null));return t?(["avg","stddev","variance"].forEach(n=>{null!=e[n]&&(e[n]=Math.ceil(e[n]??0))}),e):e},e.resolveCBResult=function(e,n){let t=e.classBreaks;const i=t.length,a=t[0]?.minValue,u=t[i-1]?.maxValue,o="standard-deviation"===n,r=l;return t=t.map(e=>{const n=e.label,t={minValue:e.minValue,maxValue:e.maxValue,label:n};if(o&&n){const e=n.match(r),l=e?.map(e=>+e.trim())??[];2===l.length?(t.minStdDev=l[0],t.maxStdDev=l[1],l[0]<0&&l[1]>0&&(t.hasAvg=!0)):1===l.length&&(n.includes("<")?(t.minStdDev=null,t.maxStdDev=l[0]):n.includes(">")&&(t.minStdDev=l[0],t.maxStdDev=null))}return t}),{minValue:a,maxValue:u,classBreakInfos:t,normalizationTotal:e.normalizationTotal}},e.statisticTypes=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});