// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../core/Logger","../core/MapUtils","../core/promiseUtils","../core/SetUtils","./sharedTemplates/templateDefinitions/templateDefinitionUtils","../layers/support/layerUtils","../rest/sharedTemplates/querySharedTemplates","../undoredo/support/Services"],function(e,t,r,a,n,i,s,o,l){"use strict";const u=()=>t.getLogger("esri.editing.templateUtils");function p(e){return f(e)&&"definition"in e}function f(e){return null!=e&&"templateId"in e}const c=e=>null==e||"object"!=typeof e?[]:[..."templates"in e&&Array.isArray(e.templates)?e.templates:[],..."types"in e&&Array.isArray(e.types)?e.types.flatMap(e=>e.templates):[]];function d(e,t){return s.isSubtypeSublayer(t)&&t.parent?e.tablesAndLayersLookup.get(t.parent):s.isFeatureLayer(t)?e.tablesAndLayersLookup.get(t):null}function y(e){const t=new Map;for(const a of e)r.getOrCreateMapValue(t,a.subtypeCode??1/0,()=>[]).push(a);return t}e.getAllStandardFeatureTemplatesForLayer=c,e.getServiceInfoForLayer=d,e.getTemplatesForLayers=async function(e,t,i){if(null==t)return e.map(e=>({layer:e,templates:c(e)}));const p=await async function(e,t){const r=await l.getServices(t).load(),a=new Set;for(const t of e)n.addMaybe(a,d(r,t));return await Promise.all(Array.from(a).map(e=>e.featureService.load())),a}(e,t);a.throwIfAborted(i);const f=new Map,m=Array.from(p).map(e=>async function({serviceInfo:e,out:t,signal:n}){const{featureService:i,layersAndTables:l}=e,u=await async function({featureService:e,layers:t,signal:a}){if(!e.capabilities?.editing.supportsSharedTemplates)return new Map;const n=new Map(t.map(e=>[e.layerId,e])),i=await o.querySharedTemplates({featureService:e,query:{layers:Array.from(n.keys())},requestOptions:{signal:a}}),s=new Map;for(const e of i)for(const t of e.layerIds)n.has(t)&&r.getOrCreateMapValue(s,n.get(t),()=>[]).push(e);return s}({featureService:i,layers:l.toArray(),signal:n});a.throwIfAborted(n);for(const[e,r]of u.entries())if(0!==r.length)if(s.isSubtypeGroupLayer(e)){const a=y(r),n=[],i=a.get(1/0)??n;for(const r of e.sublayers){const e=a.get(r.subtypeCode)??n;t.set(r,[...e,...i])}}else t.set(e,r)}({serviceInfo:e,out:f,signal:i})),g=await Promise.allSettled(m);for(const e of g.filter(e=>"rejected"===e.status))u().warn("Failed to fetch shared templates for service. Will use standard templates if available.",e.reason);return e.map(e=>({layer:e,templates:f.get(e)??c(e)}))},e.isLoadedSharedTemplate=function(e){return p(e)&&null!=e?.definition},e.isSharedFeatureTemplate=function(e){return p(e)&&"feature"===e?.type&&(null==e.definition||i.isFeatureTemplateDefinition(e.definition))},e.isSharedGroupTemplate=function(e){return p(e)&&"group"===e?.type&&(null==e.definition||i.isGroupTemplateDefinition(e.definition))},e.isSharedPresetTemplate=function(e){return p(e)&&"preset"===e?.type&&(null==e.definition||i.isPresetTemplateDefinition(e.definition))},e.isSharedTemplate=p,e.isSharedTemplateMetadata=function(e){return f(e)&&!("definition"in e)},e.isSharedTemplateOrMetadata=f,e.isStandardFeatureTemplate=function(e){return null!=e&&"prototype"in e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});