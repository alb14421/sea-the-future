// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../chunks/tslib.es6","../../request","../../core/Accessor","../../core/handleUtils","../../core/MapUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../templateUtils","./support/sharedTemplateErrors","../../layers/support/layerUtils","../../undoredo/support/Services","../../webmap/utils"],function(e,t,r,o,a,i,s,l,n,c,d,p,u,h,y,m,f,w,v,S){"use strict";const _=new Map;function b(e){return null!=e&&e.subscribers.size>0}function T(){return{resolver:n.createResolver(),subscribers:new Set}}function k(e,t){return`${e.url}/${t}`}function g(e){return async({featureService:t,layerIds:r})=>{if(!e.map)throw new f.SharedTemplateLayerUnavailableError(r);const o=new Set(r),{allLayers:a,allTables:i}=e.map,s=a.concat(i).find(e=>e.url===t.url&&function(e){return w.isFeatureLayer(e)||w.isSubtypeGroupLayer(e)}(e)&&o.has(e.layerId));if(null==s)throw new f.SharedTemplateLayerUnavailableError(r);return s}}function N(e){return async t=>{const{map:r}=e;if(!S.isWebMap(r)||!r.utilityNetworks)return null;for(const e of r.utilityNetworks)if(e.featureServiceUrl===t.url)return e.load();return null}}t.SharedTemplateProvider=class extends a{constructor(e){super(e),this._abortController=null,this._cache=new Map,this._pending=new Map,this._utilityNetworkLookupHelperCache=new Map,this.layerResolver=null,this.makeSharedTemplateFromJSON=null,this.utilityNetworkResolver=null,this.view=null}initialize(){this.addHandles(c.watch(()=>this.view.spatialReference,()=>this._reset()))}destroy(){this._abortController=l.abortMaybe(this._abortController)}async getTemplates({templateIds:e,featureService:t,signal:r}){const o=this._cache,a=this._pending,i=[],s=new Set,l=new Set,c=Symbol();for(const r of new Set(e)){const e=k(t,r);if(o.has(e))i.push(o.get(e));else if(a.has(e)){const t=a.get(e);t.subscribers.add(c),l.add(t)}else s.add(r),a.set(e,T())}if(i.length===e.length)return i;const d=()=>{for(const{subscribers:e}of l)e.delete(c)},p=n.onAbort(r,d);try{const e=await this._loadTemplates({templateIds:Array.from(s),featureService:t,signal:r}),o=await Promise.all(Array.from(l).map(({resolver:e})=>e.promise));i.push(...e),i.push(...o)}catch(e){d();for(const r of s){const o=k(t,r),i=a.get(o);i?.resolver.reject(e),a.delete(o)}throw e}finally{p?.remove()}return n.throwIfAborted(r),i}async _loadTemplates({templateIds:e,featureService:t,signal:r}){if(0===e.length)return[];const a=this._cache,i=this._pending,s=this._abortController=new AbortController,l=n.onAbort(r,()=>{for(const r of e)if(b(i.get(k(t,r))))return;s.abort()}),c=await async function({templateIds:e,featureService:t,spatialReference:r,signal:a}){const i=`${t.url}/sharedTemplates/templates`,s=await o(i,{query:{f:"json",outSR:r,ids:e.join(",")},signal:a}).catch(t=>{throw n.throwIfAbortError(t),new f.SharedTemplateRequestError(e,t)});return s.data?.templates??[]}({featureService:t,templateIds:e,signal:s.signal,spatialReference:this.view.spatialReference});if(c.length<e.length)throw new f.SharedTemplateMissingTemplatesError(e,c);const d=await Promise.all(c.map(e=>this._makeTemplate({json:e,featureService:t})));for(const e of d){const o=k(t,e.templateId),s=i.get(o);!r?.aborted||b(s)?(a.set(o,e),s?.resolver.resolve(e)):s?.resolver.reject(n.createAbortError()),i.delete(o)}return l?.remove(),d}async _makeTemplate({json:e,featureService:t}){const{view:r}=this,o=this.makeSharedTemplateFromJSON(e);o.featureService=t,o.view=r;const{layerIds:a,subtypeCode:i}=o;try{o.layer=await this.layerResolver({featureService:t,layerIds:a,subtypeCode:i})}catch(e){throw new f.SharedTemplateLayerResolverError(o.templateId,e)}if(m.isSharedGroupTemplate(o)&&o.definition?.createUtilityNetworkAssociations){let e=null;try{e=await this.utilityNetworkResolver(t)}catch(e){throw new f.SharedTemplateUtilityNetworkResolverError(o.templateId,e)}if(e){o.definition.utilityNetwork=await this._getOrCreateUtilityNetworkLookupHelper(e);const t=e.associationsTable;o.definition.utilityNetworkAssociationsTable=t,v.getServices(r).additionalLayers.add(t)}}if(m.isSharedPresetTemplate(o)&&o.definition){o.definition.spatialReference=r.spatialReference;for(const e of o.definition.allParts)e.geometry&&(e.geometry.spatialReference=r.spatialReference)}if(m.isSharedFeatureTemplate(o)&&o.definition?.defaultValues){const e=o.definition.defaultValues,t={},{fieldsIndex:r}=o.layer;for(const a in o.definition.defaultValues)t[r.get(a)?.name??a]=e[a];o.definition.defaultValues=t}return o}async _getOrCreateUtilityNetworkLookupHelper(t){const r=this._utilityNetworkLookupHelperCache.get(t);if(r)return r;const{UtilityNetworkLookupHelper:o}=await new Promise((t,r)=>e(["../../networks/support/UtilityNetworkLookupHelper"],t,r)),a=await new o({utilityNetwork:t}).load();this._utilityNetworkLookupHelperCache.set(t,a);const s=i.makeHandle(()=>{a.destroy(),this._utilityNetworkLookupHelperCache.delete(t)});return t.addHandles(s),this.addHandles(s),a}_reset(){this._abortController?.abort(),this._cache.clear(),this._pending.clear()}},r.__decorate([d.property()],t.SharedTemplateProvider.prototype,"_abortController",void 0),r.__decorate([d.property()],t.SharedTemplateProvider.prototype,"_cache",void 0),r.__decorate([d.property()],t.SharedTemplateProvider.prototype,"_pending",void 0),r.__decorate([d.property({constructOnly:!0})],t.SharedTemplateProvider.prototype,"layerResolver",void 0),r.__decorate([d.property({constructOnly:!0})],t.SharedTemplateProvider.prototype,"makeSharedTemplateFromJSON",void 0),r.__decorate([d.property({constructOnly:!0})],t.SharedTemplateProvider.prototype,"utilityNetworkResolver",void 0),r.__decorate([d.property({constructOnly:!0})],t.SharedTemplateProvider.prototype,"view",void 0),t.SharedTemplateProvider=r.__decorate([y.subclass("esri.editing.sharedTemplates.SharedTemplateProvider")],t.SharedTemplateProvider),t.getSharedTemplateProvider=function(e,r){return s.getOrCreateMapValue(_,e,()=>{const o=new t.SharedTemplateProvider({layerResolver:r?.layerResolver??g(e),makeSharedTemplateFromJSON:r.makeSharedTemplateFromJSON,utilityNetworkResolver:r?.utilityNetworkResolver??N(e),view:e});return e.addHandles(i.makeHandle(()=>{_.delete(e),o.destroy()})),o})},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});