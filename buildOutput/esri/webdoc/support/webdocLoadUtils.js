// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../Viewpoint","../../core/Error","../../core/Logger","../../geometry/support/webMercatorUtils","../../portal/Portal","../../portal/support/jsonContext","../../rest/geometryService/project","../../rest/support/ProjectParameters"],function(e,t,r,o,n,a,i,s,c,l){"use strict";function p(t,r,o){const n={context:{...o,layerContainerType:"operational-layers"}};return t.portalItem&&(n.context.portal=t.portalItem.portal||i.getDefault()),new Promise((t,r)=>e(["../../layers/support/layersCreator"],t,r)).then(({populateOperationalLayers:e})=>{const o=[],a=r.operationalLayers;a?.length&&o.push(e(t.layers,a,n));const i={...n,context:{...n.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"},s=r.tables;return s?.length&&o.push(e(t.tables,s,i)),Promise.allSettled(o).then(()=>{})})}t.loadFromSource=function(t,i){return i.resourceInfo?p(i,i.resourceInfo,{origin:t.origin}):i.portalItem?.id?async function(t,i,u){if(await u.load().catch(e=>{throw new o(`${t.name}:load-portal-item`,"Failed to load portal item",{error:e})}),u.type!==t.itemType)throw new o(`${t.name}:invalid-portal-item`,`Invalid portal item type '${u.type}', expected '${t.itemType}'`,{type:u.type});const m=await u.fetchData();i.resourceInfo=m;const y=s.createForItemRead(u,t.origin);await function(e,t,r,o){const n=function(e,t){const r=e.parseVersion(t.version||"",e.name);return e.currentVersion.validate(r),t.version=`${r.major}.${r.minor}`,t}(e,r);return t.read(n,o),p(t,n,o)}(t,i,m,y),i.resourceReferences={portalItem:u,paths:y.readResourcePaths};const f=await async function(t,o,n){const i=t?.viewpoint?.targetGeometry;if(i)return null;const s=await async function(t,r,o){const n=t?.spatialReference,i=r?.extent;if(!n||!i)return null;if(n.isWGS84)return i.clone();if(n.isWebMercator)return a.geographicToWebMercator(i);const{getGeometryServiceURL:s}=await new Promise((t,r)=>e(["../../portal/support/geometryServiceUtils"],t,r));try{const e=await s(r),t=new l({geometries:[i],outSpatialReference:n});return(await c.project(e,t))[0]}catch(e){o.error("Error projecting item's extent:",e)}return null}(t,o,n);return s?new r({targetGeometry:s}):null}(i.initialViewProperties,u,n.getLogger(i));if(f){const e=i.initialViewProperties?.clone()??t.createInitialViewProperties();e.viewpoint=f,i.initialViewProperties=e}}(t,i,i.portalItem):Promise.resolve()},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});