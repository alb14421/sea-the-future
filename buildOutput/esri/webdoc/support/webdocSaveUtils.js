// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../core/Error","../../core/MultiOriginJSONSupport","../../core/reactiveUtils","../../core/urlUtils","../../core/accessorSupport/originUtils","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../layers/support/arcgisLayerUrl","../../layers/support/layerUtils","../../portal/Portal","../../portal/PortalItem","../../portal/support/jsonContext","../../portal/support/portalItemUtils","../../rest/geometryService/project","../../rest/support/ProjectParameters","../../support/basemapUtils","./resourceUtils","./saveUtils"],function(e,t,r,a,o,i,n,s,l,p,c,d,u,y,w,m,f,h,v,g,T){"use strict";const b=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map(e=>e.toLowerCase());async function S(e,t,r){const a=w.createForItemWrite(t,r,!0),o=e.write({},a);return await Promise.all(a.resources.pendingOperations),{json:o,jsonContext:a}}function _(e,t){if(t.type!==e.itemType)throw new r(`${e.name}:portal-item-wrong-type`,`Portal item needs to have type "${e.itemType}"`)}async function K(e,t){if("linkchart"===e.name)return;if(!t.basemap?.baseLayers.length)throw new r(`${e.name}:save`,"Map does not have a valid basemap with a base layer.");let a=null;if(await o.whenOnce(()=>{const e=v.findSpatialReference(t.initialViewProperties,t.basemap);return a=e.spatialReference,!e.updating}),!l.equals(a,t.initialViewProperties.spatialReference))throw new r(`${e.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:t.initialViewProperties.spatialReference,actual:a})}function R(e){const t=[];return e.basemap&&t.push(e.basemap.load()),e.ground&&t.push(e.ground.load()),Promise.allSettled(t).then(()=>{})}async function O(t,r){r.extent=await async function(t,r){const a=r.clone().normalize();let o;if(a.length>1)for(const e of a)o?e.width>o.width&&(o=e):o=e;else o=a[0];return async function(t,r){const a=r.spatialReference;if(a.isWGS84)return r.clone();if(a.isWebMercator)return p.webMercatorToGeographic(r);const{getGeometryServiceURL:o}=await new Promise((t,r)=>e(["../../portal/support/geometryServiceUtils"],t,r)),i=await o(t),n=new h({geometries:[r],outSpatialReference:s.WGS84});return(await f.project(i,n))[0]}(t,o)}(t.portalItem,t.initialViewProperties.viewpoint.targetGeometry),await async function(e,t){m.addTypeKeyword(t,W),await function(e){const t=N(e).map(e=>e.load()).toArray();return Promise.allSettled(t).then(()=>{})}(e),function(e,t){m.hasTypeKeyword(t,P)||m.hasTypeKeyword(t,L)||m.hasTypeKeyword(t,M)||m.hasTypeKeyword(t,j)||!V(e)?m.removeTypeKeyword(t,A):m.addTypeKeyword(t,A)}(e,t),function(e,t){V(e)?m.addTypeKeyword(t,I):m.removeTypeKeyword(t,I)}(e,t),function(e,t){!m.hasTypeKeyword(t,C)&&function(e){return N(e).filter(e=>"group"!==e.type).every(t=>t.loaded&&function(e,t){return d.isLayerWithFeatureLayerSource(t)&&t.capabilities.operations.supportsSync||function(e){return d.isFeatureCollectionLayer(e)||"map-notes"===e.type||"route"===e.type}(t)&&!t.portalItem||function(e){return("tile"===e.type||"vector-tile"===e.type)&&(e.capabilities.operations.supportsExportTiles||function(e){return"tile"===e.type&&c.isServerOrServicesAGOLUrl(e.url)&&b.some(t=>e.url?.toLowerCase().includes("/"+t+"/"))}(e)||v.isDeveloperBasemapLayer(e))}(t)&&!function(e){return"vector-tile"===e.type&&Object.keys(e.sourceNameToSource).length>1}(t)&&t.spatialReference.equals(e.initialViewProperties.spatialReference)}(e,t))}(e)?m.addTypeKeyword(t,U):m.removeTypeKeyword(t,U)}(e,t),function(e,t){v.hasDeveloperBasemapLayer(e.basemap)?m.addTypeKeyword(t,D):m.removeTypeKeyword(t,D)}(e,t),function(e,t){e.utilityNetworks?.length?m.addTypeKeyword(t,E):m.removeTypeKeyword(t,E)}(e,t),function(e,t){e.ipsInfo?m.addTypeKeyword(t,G):m.removeTypeKeyword(t,G)}(e,t),function(e,t){m.toggleTypeKeyword(t,m.typeKeyword.CHARTS,T.hasCharts(e))}(e,t),t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter((e,t,r)=>r.indexOf(e)===t))}(t,r)}const W=m.typeKeyword.JSAPI,P="CollectorDisabled",A="Collector",I="Data Editing",C="OfflineDisabled",U="Offline",L="Workforce Project",M="Workforce Worker",j="Workforce Dispatcher",D=m.typeKeyword.DEVELOPER_BASEMAP,E="UtilityNetwork",G="IPS";function N(e){return e.allLayers.concat(e.allTables)}function V(e){return N(e).some(e=>e.loaded&&d.isLayerWithFeatureLayerSource(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&("subtype-group"!==e.type||e.sublayers.some(e=>e.editingEnabled)))}async function k(e,t){const{item:r,authenticated:a}=e;return r?.id&&r.typeKeywords?.includes("useOnly")?r.portal.portalHostname!==t.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(a||await r.reload(),{copyAllowed:"admin"===r.itemControl||"update"===r.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function x(e,t,r,a){const o=e.portal,{item:n}=t,{folder:s,copyAllResources:l}=a;let p=!1;if(l&&n?.id&&i.hasSameCanonicalPortal(n.portal.url,o.url)&&parseInt(n.portal.currentVersion,10)>=2023){const{total:e}=await n.fetchResources();p=!!e}if(p){const t=await n.copy({copyResources:"all",folder:s});e.id=t.id,e.portal=t.portal;const a=e.toJSON();await e.load(),e.read(a),await e.update({data:r})}else await o.user.addItem({item:e,folder:s,data:r});return p}function B(e,t,r,o,s){a.MultiOriginJSONSupport.prototype.read.call(t,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{origin:e.origin,ignoreDefaults:!0,url:r.itemUrl?i.urlToObject(r.itemUrl):void 0}),n.updateOrigins(s),t.resourceInfo=o}t.createJSON=S,t.initializeNewItem=x,t.isCopyAllowed=k,t.save=async function(e,t,a){a??={},function(e,t){if(!t.portalItem)throw new r(`${e.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");_(e,t.portalItem)}(e,t),await o.whenOnce(()=>!t.updatingFromView),await t.load(),await R(t),await T.beforeSave(t),await K(e,t);const i=t.portalItem,{json:n,jsonContext:s}=await S(t,i,e.origin);return T.evaluateWriteErrors(s,{errorName:`${e.name}:save`},a),await O(t,i),await async function(e,t,r,a,o){await r.update({data:a}),B(e,t,r,a,o)}(e,t,i,n,s),await Promise.all([t.updateItemThumbnail(),g.saveResources(t.resourceReferences,s)]),i},t.saveAs=async function(e,t,a,i){i??={};const n=function(e,t){let r=y.from(t);return r.id&&(r=r.clone(),r.id=null),r.type||(r.type=e.itemType),r.portal||(r.portal=u.getDefault()),_(e,r),r}(e,a);await o.whenOnce(()=>!t.updatingFromView),await t.load(),await R(t),await T.beforeSave(t),await K(e,t);const{json:s,jsonContext:l}=await S(t,n,e.origin);T.evaluateWriteErrors(l,{errorName:`${e.name}:save`},i),await async function(e,t){m.removeTypeKeyword(t,P),m.removeTypeKeyword(t,"FieldMapsDisabled"),m.removeTypeKeyword(t,m.typeKeyword.METADATA),m.removeTypeKeyword(t,C),m.removeTypeKeyword(t,"Offline Map Areas"),m.removeTypeKeyword(t,j),m.removeTypeKeyword(t,L),m.removeTypeKeyword(t,M),await O(e,t)}(t,n);const p=t.getThumbnailState();return await async function(e,t,a,o,i,n){const s=t.portalItem,l={item:s,authenticated:!(!s?.id||!s.portal.user)},p=a.portal;await p.signIn();const{copyAllowed:c,itemReloaded:d}=await k(l,p);if(l.authenticated||=d,!c)throw new r(`${e.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const u=await x(a,l,o,n);return t.portalItem=a,B(e,t,a,o,i),u}(e,t,n,s,l,i)&&(t.resourceReferences.portalItem=n),t.restoreThumbnailFromState(p),await Promise.all([t.updateItemThumbnail(),g.saveResources(t.resourceReferences,l)]),n},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});