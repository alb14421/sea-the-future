// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../arcade/arcadeEnvironment","../arcade/Dictionary","../arcade/executionError","./languageUtils","../core/Error","../core/Logger","../core/MapUtils","../portal/Portal","../rest/translate","../rest/support/TranslateContent","../rest/support/TranslateParameters","../rest/support/TranslateResult","../support/guards"],function(t,e,r,n,s,a,o,c,i,l,u,h,d,f){"use strict";class p{constructor(t,e){this.portal=t,this._debugLog=e}async translate(t){this.portal.loaded||await this.portal.load();const e=this.portal.helperServices?.aiUtilityServices;if(null==e)return{success:!1};const r=e.url+e.translateUtility;try{return t.requestSource??="arcade",{success:!0,results:(await l.translate(r,t,{authMode:"no-prompt"})).map(t=>t.toJSON())}}catch(t){return null!=this._debugLog&&(t instanceof Error||t instanceof a)&&this._debugLog(`TranslateText error: ${t.message}`),o.getLogger("esri.arcade.functions.aiServices").error(t),{success:!1}}}}class g{constructor(t,e,r){this._parameters=t,this._maxTotalContentSize=e,this._maxContentsLength=r,this._requests=[],this._normalizedContents=new Map,this._contentsTotalSize=0}tryAdd(t){const e=new Set(t.filter(t=>!this._normalizedContents.has(t.text)).map(t=>t.text));if(this._requests.length+e.size>this._maxContentsLength)return null;let r=0;for(const t of e)r+=t.length;if((r+this._contentsTotalSize)*(this._parameters.to.length??1)>this._maxTotalContentSize)return null;const n=this._requests.length;for(const{key:e,text:r}of t)c.getOrCreateMapValue(this._normalizedContents,r,()=>[]).push({batchIdx:n,key:e});return this._requests.push(t),this._contentsTotalSize+=r,n}async send(t){const e=[],r=[];let n=0;for(const[t,s]of this._normalizedContents)e.push(new u({key:String(n++),text:t})),r.push(s);const s=new h(this._parameters);s.contents=e;const a=await t.translate(s);if(!a.success)return Array.from(this._requests,()=>a);const o=Array.from(this._requests,()=>({success:!0,results:[]}));for(const t of a.results){const e=Number(t.key);for(const n of r[e])o[n.batchIdx].results.push({...t,key:n.key})}return o}}function y(t){const e=[...new Set(t.to)].sort(),r=t.from??null,n=t.portalUrl,s=t.translator,a=t.apiKey??null;return JSON.stringify([e,r,n,s,a])}async function _(t,e,r){try{return(await t.yieldFor(r))[e]}catch{return{success:!1}}}class m{constructor(t,e,{maxTotalContentSize:r=5e4,maxContentsLength:n=1e3}={}){this._executor=t,this._service=e,this._openBatches=new Map,this._maxTotalContentSize=r,this._maxContentsLength=n}create(t){return{translate:async e=>{const r=y(e),{contents:n,to:s,from:a,translator:o,portalUrl:c,apiKey:i}=e;if(null==s)return{success:!1};if(null==n||n.every(t=>0===t.text.length))return{success:!1};const l=this._openBatches.get(r);if(null!=l){const e=l.data.tryAdd(n);if(null!=e)return await _(t,e,l);l.send()}const u=new g({to:s,from:a,translator:o,portalUrl:c,apiKey:i},this._maxTotalContentSize,this._maxContentsLength),h=u.tryAdd(n);if(null!=h){const e=this._executor.openBatch(u,{open:t=>{this._openBatches.set(r,t)},execute:t=>t.send(this._service),close:t=>{this._openBatches.get(r)===t&&this._openBatches.delete(r)}});return await _(t,h,e)}return await this._service.translate(e)}}}}function x(t){"async"===t.mode&&(t.functions[e.toSymbolId("TranslateText")]=function(e,a){return t.standardFunctionAsync(e,a,async(t,e,a)=>{if(s.pcCheck(a,2,3,t,e),!f.isString(a[0])&&!f.isArray(a[0])&&!s.isImmutableArray(a[0]))throw new n.ArcadeExecutionError(t,"InvalidParameter",e);const o=s.toStringArray(a[0]);if(!f.isString(a[1])&&!f.isArray(a[1])&&!s.isImmutableArray(a[1]))throw new n.ArcadeExecutionError(t,"InvalidParameter",e);const c=s.toStringArray(a[1]);let l=null;if(a.length>=3){if(!f.isString(a[2]))throw new n.ArcadeExecutionError(t,"InvalidParameter",e);l=a[2]}const g=o.map((t,e)=>new u({key:String(e),text:t})),_=t.services?.portal??i.getDefault(),m=new h({to:c,contents:g,from:l,portalUrl:_.restUrl.replace(/\/sharing\/rest$/,"")}),x=new Map;let S=null;if(null!=t.lrucache){const e=t.lrucache;S??=y(m),m.contents=m.contents?.filter(t=>{const r=e.getCachedTranslation(S,t.text);return null==r||(x.set(t.key,{...r,key:t.key,text:t.text}),!1)})}if(m.contents?.length){const e=t.services?.translation??new p(_,t.console),s=await e.translate(m);if(!s.success)return new r({__proto__:null,success:!1});for(const e of s.results){const r=m.contents?.find(t=>t.key===e.key)?.text;if(null==r)throw new n.ArcadeExecutionError(null,"NeverReach",null);x.set(e.key,e),null!=t.lrucache&&(S??=y(m),t.lrucache.setCachedTranslation(S,r,{detectedLanguage:e.detectedLanguage,translation:e.translation}))}}const w=Array.from(g,e=>{const s=d.fromJSON(x.get(e.key));if(null==s)throw new n.ArcadeExecutionError(null,"NeverReach",null);return s.text=e.text,r.convertJsonToArcade(s.toJSON(),t.timeZone??"system",!0)});return new r({__proto__:null,success:!0,results:w})})})}const S=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:m,PortalTranslationService:p,getTranslateParametersKey:y,registerFunctions:x},Symbol.toStringTag,{value:"Module"}));t.AiFunctions=S,t.BatchTranslationServiceFactory=m,t.PortalTranslationService=p,t.getTranslateParametersKey=y,t.registerFunctions=x});