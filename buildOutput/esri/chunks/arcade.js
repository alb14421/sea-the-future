// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../arcade/arcadeCompiler","../arcade/arcadeEnvironment","../arcade/ArcadeModuleResolver","../arcade/arcadeRuntime","../arcade/executionError","../arcade/parser","../arcade/treeAnalysis","../arcade/functions/geomsync","../arcade/functions/track","../core/has","../core/maybe"],function(e,r,t,n,c,s,i,a,o,u,l,d,p){"use strict";const f=new Set(["feature","angle","bearing","centroid","envelopeintersects","extent","geometry","ringisclockwise","trackgeometrywindow"]),m=new Set(["TrackAccelerationAt","TrackAccelerationWindow","TrackCurrentAcceleration","TrackCurrentDistance","TrackCurrentSpeed","TrackDistanceAt","TrackDistanceWindow","TrackSpeedAt","TrackSpeedWindow"].map(e=>n.toSymbolId(e))),S=new Set([...m,"TrackCurrentTime","TrackDuration","TrackFieldWindow","TrackGeometryWindow","TrackIndex","TrackStartTime","TrackWindow"].map(e=>n.toSymbolId(e)));let y=!1,w=!1,b=null,A=[],x=!1;function h(e,r){if(!0===r.useAsync||!0===e.isAsync)return function(e,r){if(null===b)throw new i.ArcadeExecutionError(null,"AsyncNotEnabled",null);if(d("esri-csp-restrictions"))return b.prepareScript(e,r);try{return t.compileScript(e,r,!0)}catch(t){if("esri.arcade.arcadeuncompilableerror"===t.declaredRootClass)return b.prepareScript(e,r);throw t}}(e,r);if(d("esri-csp-restrictions"))return s.prepareScript(e,r);try{return t.compileScript(e,r)}catch(t){if("esri.arcade.arcadeuncompilableerror"===t.declaredRootClass)return s.prepareScript(e,r);throw t}}function k(e){s.extend(e),t.extend(e,"sync"),null===b?A.push(e):(t.extend(e,"async"),b.extend(e))}function T(e,r=[]){return a.parseScript(e,r)}function F(e,r,t=[]){return E(a.parseScript(e,t),r)}function E(e,r){if(!0===r.useAsync||!0===e.isAsync){if(null===b)throw new i.ArcadeExecutionError(null,"AsyncNotEnabled",null);return b.executeScript(e,r)}return s.executeScript(e,r)}function M(e,r){return o.referencesMember(e,r)}function g(e,r){return o.referencesFunction(e,r)}function I(e,r=!1){return void 0===r&&(r=!1),o.findLiteralMemberAccesses(e).map(({varId:e,memberId:r})=>`${e}.${r}`)}function G(e){return o.findExpectedFieldLiterals(e)}function D(e,r=[]){return void 0===e.usesGeometry&&o.findScriptDependencies(e,r),!0===e.usesGeometry}let U=null;function v(){return U||(U=C(),U)}async function C(){return await u.loadOperators(),w=!0,!0}let P=null;function L(){return null!==P||(P=O()),P}async function O(){await t.enableAsyncSupport(),b=await new Promise((r,t)=>e(["../arcade/arcadeAsyncRuntime"],r,t));for(const e of A)b.extend(e),t.extend(e,"async");return A=null,!0}function R(){return y}function W(){return!!b}function _(){return w}let $,j=null;function z(){return j||(j=N(),j)}async function N(){await L();const[r,n,c,s,i,a]=await Promise.all([new Promise((r,t)=>e(["../arcade/featureSetUtils"],r,t)),new Promise((r,t)=>e(["../arcade/functions/featuresetbase"],r,t)),new Promise((r,t)=>e(["../arcade/functions/featuresetgeom"],r,t)),new Promise((r,t)=>e(["../arcade/functions/featuresetstats"],r,t)),new Promise((r,t)=>e(["../arcade/functions/featuresetstring"],r,t)),new Promise((r,t)=>e(["../arcade/functions/knowledgegraph"],r,t))]);return Z=r,b.extend([n,c,s,i,a]),t.extend([n,c,s,i,a],"async"),y=!0,!0}function V(){return $??=l.loadOperators().then(()=>{x=!0})}function q(e,r=[]){return void 0===e.usesFeatureSet&&o.findScriptDependencies(e,r),!0===e.usesFeatureSet}function B(e,r=[]){return void 0===e.isAsync&&o.findScriptDependencies(e,r),!0===e.isAsync}async function H(e,r,t=[],n=!1,c=null){return J(new Set,e,r,t,n,c)}async function J(e,r,t,n=[],c=!1,s=null){const i="string"==typeof r?T(r):r,a=[];return i&&(!1===_()&&(D(i)||c)&&a.push(v()),!1===W()&&(!0===i.isAsync||t)&&a.push(L()),!1===R()&&(q(i)||function(e,r){if(r){for(const t of r)if(M(e,t))return!0;return!1}return!1}(i,n))&&a.push(z()),x||function(e){return o.findFunctionCalls(e).some(e=>m.has(e))}(i)&&a.push(V())),a.length&&await Promise.all(a),await Q(e,i,s,t,c),!0}function K(e,r=[]){return void 0===e.usesModules&&o.findScriptDependencies(e,r),!0===e.usesModules}async function Q(e,r,t=null,n=!1,s=!1){const a=o.findModuleImports(r);null===t&&a.length>0&&(t=c.ArcadeModuleResolver.getDefault()),r.loadedModules={};for(const c of a){p.assertIsSome(t);const a=t.normalizeModuleUri(c.source);if(e.has(a.uri))throw new i.ArcadeExecutionError(null,"CircularModules",null);e.add(a.uri);const o=await t.fetchModule(a);await J(e,o,n,[],s,t),e.delete(a.uri),o.isAsync&&(r.isAsync=!0),o.usesFeatureSet&&(r.usesFeatureSet=!0),o.usesGeometry&&(r.usesGeometry=!0),r.loadedModules[c.libname]={uri:a.uri,script:o}}}function X(e){if(D(e))return!0;const r=o.findFunctionCalls(e);let t=!1;for(let e=0;e<r.length;e++)if(f.has(r[e])){t=!0;break}return t}function Y(e,r){const t=null==r?null:new Set(r.map(e=>e.toLowerCase()));return o.findLiteralMemberAccesses(e).some(({varId:e,memberId:r})=>"$view"===e&&(null==t||t.has(r)))}let Z=null;function ee(){return Z}function re(e){return o.findFunctionCalls(e).some(e=>S.has(e))}const te=Object.freeze(Object.defineProperty({__proto__:null,_loadScriptDependenciesImpl:J,compileScript:h,enableAsyncSupport:L,enableAsyncSupportImpl:O,enableFeatureSetSupport:z,enableFeatureSetSupportImpl:N,enableGeometrySupport:v,enableGeometrySupportImpl:C,executeScript:E,extend:k,extractExpectedFieldLiterals:G,extractFieldLiterals:I,featureSetUtils:ee,isAsyncEnabled:W,isFeatureSetSupportEnabled:R,isGeometryEnabled:_,loadDependentModules:Q,loadScriptDependencies:H,loadTrackGeometryOperators:V,parseAndExecuteScript:F,parseScript:T,referencesFunction:g,referencesMember:M,scriptIsAsync:B,scriptTouchesGeometry:X,scriptUsesFeatureSet:q,scriptUsesGeometryEngine:D,scriptUsesModules:K,scriptUsesTrack:re,scriptUsesViewProperties:Y},Symbol.toStringTag,{value:"Module"}));r._loadScriptDependenciesImpl=J,r.arcade=te,r.compileScript=h,r.enableAsyncSupport=L,r.enableAsyncSupportImpl=O,r.enableFeatureSetSupport=z,r.enableFeatureSetSupportImpl=N,r.enableGeometrySupport=v,r.enableGeometrySupportImpl=C,r.executeScript=E,r.extend=k,r.extractExpectedFieldLiterals=G,r.extractFieldLiterals=I,r.featureSetUtils=ee,r.isAsyncEnabled=W,r.isFeatureSetSupportEnabled=R,r.isGeometryEnabled=_,r.loadDependentModules=Q,r.loadScriptDependencies=H,r.loadTrackGeometryOperators=V,r.parseAndExecuteScript=F,r.parseScript=T,r.referencesFunction=g,r.referencesMember=M,r.scriptIsAsync=B,r.scriptTouchesGeometry=X,r.scriptUsesFeatureSet=q,r.scriptUsesGeometryEngine=D,r.scriptUsesModules=K,r.scriptUsesTrack=re,r.scriptUsesViewProperties=Y});