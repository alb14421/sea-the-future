// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","./tslib.es6","./SimpleGeometryCursor","./Geometry","./MultiPathImpl","./Envelope","./Point2D","./OperatorDensify"],function(t,e,s,i,n,r,a,l){"use strict";class h extends s.GeometryCursor{constructor(t,e,s,i){super(),this.m_pline=null,this.m_point=new r.Point,this.m_stack=[],this.m_resultstack=[],this.m_callCount=0,this.m_progressTracker=i,this.m_geoms=t,this.m_maxDeviation=e,this.m_bRemoveDegenerateParts=s}tock(){return!0}getRank(){return 1}next(){const t=this.m_geoms.next();return null===t?null:(i.throwIfMesh(t),this.generalize(t))}getGeometryID(){return this.m_geoms.getGeometryID()}generalize(t){const s=t.getGeometryType();if(i.isPoint(s))return t;if(s===i.GeometryType.enumEnvelope){const e=new n.Polygon({vd:t.getDescription()});return e.addEnvelope(t,!1),this.generalize(e)}if(i.isSegment(s)){const e=new n.Polyline({vd:t.getDescription()});return e.addSegment(t,!0),this.generalize(e)}if(i.isMultiPath(s)||i.throwNotImplementedException(""),t.isEmpty()||this.m_maxDeviation<=0)return t;const r=(new l.OperatorDensify).execute(t,0,.05*this.m_maxDeviation,0,this.m_progressTracker);t.hasNonLinearSegments()&&(this.m_maxDeviation*=.95);const h=r,o=t.createInstance();o.getGeometryType()===i.GeometryType.enumPolygon&&o.setFillRule(t.getFillRule()),this.m_xy=h.getAttributeStreamRef(0);{const t={stack:[],error:void 0,hasError:!1};try{const s=new n.Line;this.m_pline=s,e.__addDisposableResource(t,a.makeScopedCall(()=>{this.m_pline=null},!1),!1);for(let t=0,e=h.getPathCount();t<e;t++)this.generalizePath(h.getImpl(),t,o.getImpl())}catch(e){t.error=e,t.hasError=!0}finally{e.__disposeResources(t)}}return this.m_resultstack.length=0,this.m_stack.length=0,o}generalizePath(t,e,s){if(t.getPathSize(e)<2)return;this.m_resultstack.length=0,this.m_stack.length=0;const i=t.getPathStart(e),n=t.getPathEnd(e)-1,r=t.isClosedPath(e),l=t.isClosedPathInXYPlane(e);let h=0,o=-1;this.m_stack.push(r?i:n),this.m_stack.push(i);let m=!1,c=!1;for(!this.m_bRemoveDegenerateParts&&l&&(m=!0,c=!0);this.m_stack.length>1;){const e=this.m_stack.at(-1);this.m_stack.pop();const s=this.m_stack.at(-1);let i=t.getXY(e);this.m_pline.setStartXY(i),i=t.getXY(s),this.m_pline.setEndXY(i);const r=[Number.NaN];let a=this.findGreatestDistance(e,s,n,r);a>=0&&(m?m=!1:(c&&r[0]>h&&(h=r[0],o=a),r[0]<=this.m_maxDeviation&&(a=-1))),a>=0?(this.m_stack.push(a),this.m_stack.push(e)):this.m_resultstack.push(e)}r||this.m_resultstack.push(this.m_stack[0]);const u=this.m_resultstack.length;if(u===t.getPathSize(e)&&u===this.m_stack.length)s.addPath(t,e,!0);else if(this.m_resultstack.length>0){if(this.m_bRemoveDegenerateParts&&this.m_resultstack.length<=2){if(r||1===this.m_resultstack.length)return;if(a.Point2D.distance(t.getXY(this.m_resultstack[0]),t.getXY(this.m_resultstack[1]))<=this.m_maxDeviation)return}if(c&&o>=0&&h<=this.m_maxDeviation){const t=this.m_resultstack.at(-1)>o;this.m_resultstack.push(o),t&&(this.m_resultstack[this.m_resultstack.length-2]=a.swap(this.m_resultstack[this.m_resultstack.length-1],this.m_resultstack[this.m_resultstack.length-1]=this.m_resultstack[this.m_resultstack.length-2]))}for(let e=0,i=this.m_resultstack.length;e<i;e++)t.getPointByVal(this.m_resultstack[e],this.m_point),0===e?s.startPathPoint(this.m_point):s.lineToPoint(this.m_point);if(r){for(let t=this.m_resultstack.length;t<3;t++)s.lineToPoint(this.m_point);s.closePathWithLine()}}}findGreatestDistance(t,e,s,i){let n=e-1;e<=t&&(n=s);let r=-1,l=0;const h=new a.Point2D;for(let e=t+1;e<=n;e++){this.m_xy.queryPoint2D(2*e,h);const t=h.x,s=h.y,i=this.m_pline.getClosestCoordinate(h,!1);h.assign(this.m_pline.getCoord2D(i)),h.x-=t,h.y-=s;const n=h.length();n>l&&(r=e,l=n),this.m_callCount++}return i[0]=l,r}}t.OperatorGeneralize=class{getOperatorType(){return 10204}supportsCurves(){return!0}accelerateGeometry(t,e,s){return!1}canAccelerateGeometry(t){return!1}executeMany(t,e,s,i){return new h(t,e,s,i)}execute(t,e,s,n){return t||i.throwInvalidArgumentException("null param is not allowed."),new h(null,e,s,n).generalize(t)}}});