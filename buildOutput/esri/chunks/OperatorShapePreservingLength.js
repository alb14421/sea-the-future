// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","./Geometry","./ProjectionTransformation","./MultiPathImpl","./Point2D","./Envelope","./Envelope2D","./OperatorDensify","./OperatorClip"],function(e,t,n,o,s,r,i,a,c){"use strict";function g(){return{m_pGcs:new s.Point2D,m_xyz:new r.Point3D,m_factor:Number.NaN,m_geoLength:Number.NaN,setValues:m,setLength:u,assign:p}}function m(e,t,n,o){this.m_factor=e,this.m_pGcs.assign(t),this.m_xyz.assign(o),this.m_geoLength=n}function u(e){this.m_geoLength=e}function p(e){this.m_pGcs.assign(e.m_pGcs),this.m_xyz.assign(e.m_xyz),this.m_factor=e.m_factor,this.m_geoLength=e.m_geoLength}function h(e,t,o,s){s.assign(n.curvToCart(e,t,o))}function y(e,t,n){const o=e,s=new r.Point3D;s.setSub(t,n);const i=s.length();return 2*o*Math.asin(i/(2*o))}e.OperatorShapePreservingLength=class{getOperatorType(){return 10315}supportsCurves(){return!0}accelerateGeometry(e,t,n){return!1}canAccelerateGeometry(e){return!1}_ExecuteShapePreservingLength(e,t,o,s,r){if(e.hasNonLinearSegments()&&(e=(new a.OperatorDensify).execute(e,0,t.getTolerance(0),0,r)),t.isPannable()){let s=90,a=-90;if(1===o.getUnit().getUnitToBaseFactor()&&(s*=Math.PI/180,a*=Math.PI/180),2===t.getCoordinateSystemType()){let e=null;const o=[0,0,0,0];e=t.getPECoordSys(),o[0]=0,o[1]=s,o[2]=0,o[3]=a,n.peCSTransformations.geogToProj(e,2,o),s=o[1],a=o[3]}const g=new i.Envelope2D;e.queryEnvelope(g),g.ymin=a,g.ymax=s,e=(new c.OperatorClip).execute(e,g,t,r)}else{const o=t.getPCSHorizon();if((e=(new n.OperatorIntersection).execute(e,o,t,r))===o){const t=e.clone();e=t}}return e.isEmpty()?0:this._ExecuteIterativeApproach(e,t,o,s,1,r)}_ExecuteIterativeApproach(e,o,i,a,c,m){const u=n.makeSpheroidData();i.querySpheroidData(u);const p=u.majorSemiAxis,l=u.e2,P=i.getUnit().getUnitToBaseFactor(),x=s.makeStructArray(g,40),_=s.makePrimitiveArray(40,Number.NaN),f=g(),S=g();let D;const d=[0,0,0,0],C=o.getPECoordSys(),E=new s.Point2D,w=new s.Point2D,T=new s.Point2D,v=new s.Point2D,N=new s.Point2D;let G=0;const L=e.querySegmentIterator();for(;L.nextPath();)for(;L.hasNextSegment();){const e=L.nextSegment();E.assign(e.getStartXY()),w.assign(e.getEndXY()),2===o.getCoordinateSystemType()?(d[0]=E.x,d[1]=E.y,d[2]=w.x,d[3]=w.y,n.peCSTransformations.projToGeog(C,2,d),T.x=d[0]*P,T.y=d[1]*P,v.x=d[2]*P,v.y=d[3]*P):(T.setCoordsPoint2D(E),v.setCoordsPoint2D(w),T.scale(P),v.scale(P));const s=new r.Point3D,i=new r.Point3D;h(p,l,T,s),h(p,l,v,i);let a=y(p,s,i);f.setValues(0,T,Number.NaN,s),S.setValues(1,v,a,i),D=c,x[0].assign(S),_[0]=c;let g=0;for(;;){g>128&&t.throwInternalErrorException("iterations exceeded");const s=.5*(f.m_factor+S.m_factor),i=e.getCoord2D(s);2===o.getCoordinateSystemType()?(d[0]=i.x,d[1]=i.y,n.peCSTransformations.projToGeog(C,1,d),N.x=d[0]*P,N.y=d[1]*P):(N.setCoordsPoint2D(i),N.scale(P)),T.setCoordsPoint2D(f.m_pGcs),v.setCoordsPoint2D(S.m_pGcs);const m=new r.Point3D;h(p,l,N,m);const u=y(p,f.m_xyz,m),E=y(p,S.m_xyz,m);a=S.m_geoLength,Number.isNaN(a)&&(a=y(p,f.m_xyz,S.m_xyz));const w=u+E,L=D===c&&w>=20&&Math.abs(w-a)>1e-8*(a+w);if(g+2<40&&(L||Math.abs(w-a)>0&&D>0))S.setLength(E),x[g].assign(S),S.setValues(s,N,u,m),x[++g].assign(S),L?(D=c,_[g]=c):(D--,_[g-1]=D,_[g]=D);else{if(G+=w,0===g)break;f.assign(S),S.assign(x[--g]),D=_[g]}}}return G}execute(e,s,r){if(s&&0!==s.getCoordinateSystemType()||t.throwInvalidArgumentException(""),e.isEmpty()||e.getDimension()<1)return 0;let i=null;const a=s.getGCS();a!==s&&(i=n.createEx(s,a,null));const c=e.getGeometryType();if(c===t.GeometryType.enumEnvelope){const t=new o.Polygon;return t.addEnvelope(e,!1),this._ExecuteShapePreservingLength(t,s,a,i,r)}if(t.isSegment(c)){const t=new o.Polyline;return t.addSegment(e,!0),this._ExecuteShapePreservingLength(t,s,a,i,r)}return this._ExecuteShapePreservingLength(e,s,a,i,r)}}});