// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../core/Cyclical","../core/mathUtils","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","./vec42","../core/libs/gl-matrix-2/factories/vec4f64","../core/libs/gl-matrix-2/math/common","../geometry/ellipsoidUtils","../geometry/Extent","../geometry/Polygon","../geometry/SpatialReference","../geometry/support/coordsUtils","../geometry/support/lineSegment","../geometry/support/plane","../geometry/support/ray","./sphere","../geometry/support/webMercatorUtils","../views/3d/state/Frustum","../views/3d/state/NearFarHeuristic","../views/3d/state/utils/viewUtils","../views/3d/support/cameraUtilsInternal","../views/3d/support/earthUtils","../views/3d/support/mathUtils"],function(e,t,r,n,a,o,s,i,c,l,u,d,m,p,h,g,f,y,M,T,v,b,x,C,R,w){"use strict";const A=s.fromValues(0,0,1),P=o.normalize(s.create(),s.fromValues(1,1,1)),S=new t.Cyclical(-180,180),E=a.create(),U=s.create(),I=s.create();function q(e,t,a,s=C.createDirectionUp()){o.cross(U,e,A),0===o.dot(U,U)&&o.cross(U,e,P),n.fromRotation(E,-r.deg2rad(t),e),n.rotate(E,E,-r.deg2rad(a),U);const{up:i,direction:c}=s;return o.cross(i,U,e),o.normalize(i,i),o.transformMat4(i,i,E),o.normalize(c,e),o.negate(c,c),o.transformMat4(c,c,E),s}function D(e,t,r,n){const a=U,s=I;return o.normalize(a,e),o.cross(I,a,A),0===o.dot(I,I)&&o.cross(I,a,P),o.cross(s,I,a),C.directionToHeadingTilt(t,r,n,a,s)}function H(e,t,n,a){const i={eye:s.create(),up:null,tilt:a,heading:n},c=U;c[0]=e[0],c[1]=e[2],c[2]=-e[1];const l=t,u=r.deg2rad(n),d=r.deg2rad(a),m=Math.sin(u),p=Math.cos(u),h=Math.sin(d),g=Math.cos(d),f=o.length(c);let y;if(Math.abs(d)<1e-8)y=l+f;else{const e=f/h,t=r.asinClamped(l/e),n=Math.PI-d-t;y=e*Math.sin(n)}const M=g*l,T=l*l*(h*h),v=p*p*T,b=y-M,x=b*b,C=v*(v+x-c[1]*c[1]);if(C<0)return o.scale(i.eye,c,y/f),i.tilt=0,F(i,e);const R=Math.sqrt(C),w=c[1]*b,A=v+x;let P;if(P=p>0?-R+w:R+w,Math.abs(A)<1e-8)return f<1e-8?(i.eye[0]=0,i.eye[1]=0,i.eye[2]=l):o.scale(i.eye,c,y/f),i.tilt=0,k(i.eye),F(i,e);i.eye[1]=P/A;const S=m*m*T,E=h*l,I=p*E*i.eye[1],q=i.eye[1]*i.eye[1],D=1-q,H=Math.sqrt(D),z=v*q+S-2*I*H*b+D*x;return Math.abs(z)<1e-8?(o.scale(i.eye,c,y/f),i.tilt=0,k(i.eye),F(i,e)):(i.eye[0]=(D*(y*c[0]-M*c[0])-E*H*(c[0]*i.eye[1]*p+c[2]*m))/z,i.eye[2]=(D*(y*c[2]-M*c[2])-E*H*(c[2]*i.eye[1]*p-c[0]*m))/z,o.scale(i.eye,i.eye,y),k(i.eye),F(i,e))}function k(e){const t=e[1];e[1]=-e[2],e[2]=t}function F(e,t){const r=q(t,e.heading,e.tilt);return e.up=r.up,e}function z(e,t,n){const a=o.length(t),s=Math.sqrt(n*n+a*a-2*n*a*Math.cos(Math.PI-e)),i=r.asinClamped(n/(s/Math.sin(e)));return r.rad2deg(e-i)}function L(e,t,n){const a=r.deg2rad(e),s=o.length(t);return r.asinClamped(n/(s/Math.sin(a)))+a}function N(e,n,a,o,s){let i,c,l,m;const h=n.latitude,g=u.getReferenceEllipsoid(e.spatialReference).radius,f=n.longitude,y=R.getLonDeltaForDistance(h,a,g)/2;i=f-y,c=f+y;const M=r.deg2rad(h),v=(1+Math.sin(M))/(1-Math.sin(M)),b=(v+1)*Math.tan(o/g/2),x=b*b;function C(e){const r=Math.PI/2;return(e=t.cyclical2PI.normalize(e,-r))>r&&(e=Math.PI-e),e}if(l=1.5*Math.PI-2*Math.atan(.5*(b+Math.sqrt(4*v+x))),m=l+o/g,l=C(l),m=C(m),m<l){const e=m;m=l,l=e}if(l=Math.max(r.rad2deg(l),-90),m=Math.min(r.rad2deg(m),90),c=S.monotonic(i,c),c-i>180){const e=(c-i-180)/2;i+=e,c-=e}const w=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:p.WGS84;return s?(s.xmin=i,s.ymin=l,s.xmax=c,s.ymax=m,s.spatialReference=w):s=new d(i,l,c,m,w),e.spatialReference&&e.spatialReference.isWebMercator&&T.geographicToWebMercator(s,!1,s),s}function O(e,t){const{renderCoordsHelper:n}=e,a=e.state.camera.clone(),c=new v.Frustum(n);a.near=b.minNearDistanceInMeters,c.update(a);const u=n.getAltitude(t),d=e.spatialReference,p=n.referenceEllipsoid.radius,g=a.eye,T=1+o.distance(g,t)/(p+u),R=Math.sqrt(T*T-1),{minCurvature:A,maxCurvature:P,minSamples:S,maxSamples:E}=V,U=function(e){const{renderCoordsHelper:t,state:{camera:r}}=e,{center:n,eye:a}=r,o=Math.abs(t.getAltitude(n)),s=Math.abs(Math.PI/2-x.viewAngle(t,n,a));return M.fromRadius(B,t.referenceEllipsoid.radius+o),M.cameraFrustumCoverage(B,s,r.distance,r.fovY)}(e),I=r.clamp((R-A)/(P-A),0,1),q=Math.round(r.lerp(S,E,I)),D=a.aboveGround,H=c.planes[5],k=[],F=f.fromPositionAndNormal(s.ZEROS,_,f.create()),z=f.fromPositionAndNormal(s.ZEROS,G,f.create());i.set(K,0,0,0,0);const L=e=>{};for(let e=0;e<4;e++){const t=1===e&&!D||3===e&&D?1-U:0,a=1===e&&D||3===e&&!D?U:1,i=c.lines[e],l=c.lines[3===e?0:e+1];for(let c=0;c<q;c++){const d=c/q,m=1===e?1-(1-d)**2:3===e?d**2:d,p=0===c?0:r.lerp(t,a,m),h=o.lerp(Z,i.origin,l.origin,p),M=w.slerp(i.direction,l.direction,p,j);n.intersectManifoldClosestSilhouette(y.wrap(h,M),u,Y),C.clampLineSegmentToPlane(Y,g,Y,H),k.push(s.clone(Y)),0!==k.length&&L(o.sqrDist(k.at(-1),Y));const T=(f.isPointInside(F,Y)?1:0)|(f.isPointInside(z,Y)?2:0);K[T]=1}}k.length>2&&o.sqrDist(k[0],k.at(-1));const N=i.squaredLength(K)>1?function(e,t){const r=[];for(const n of e)r.push(...W(n,t));return r}(W(k,F),z):[k],O=function(e,t,r){const n=2*l.getEpsilon();return e.map(e=>{const a=[];let o=!1;for(const s of e)t.fromRenderCoords(s,Y,r),Math.abs(s[0])<n&&Math.abs(s[1])<n?(a.push([null,Y[1]]),a.push([null,Y[1]]),o=!0):a.push([Y[0],Y[1]]);if(o)for(let e=0;e<a.length;e++){const t=a[e];if(null!=t[0])continue;const r=a[e+1],n=a.at(0===e?-1:e-1);t[0]=n[0],e++;const o=a.at(e===a.length-1?0:e+1);r[0]=o[0]}return a.push(a[0]),h.isClockwise(a)||a.reverse(),a})}(N,n,d);return new m({rings:O,spatialReference:d})}function W(e,t){const r=[],n=[],a=l.getEpsilon();for(let i=0;i<e.length;i++){const c=e[i],l=i===e.length-1?e[0]:e[i+1],u=g.fromPoints(c,l,J),d=f.intersectLineOrRay(t,u.origin,u.vector,0,Y);switch(d){case 2:r.push(c);break;case 3:n.push(c);break;case 0:case 1:{const[e,i,l]=0===d?[1,r,n]:[-1,n,r],u=f.getNormal(t),m=o.scaleAndAdd(s.create(),Y,u,e*a),p=o.scaleAndAdd(s.create(),Y,u,e*-a);i.push(c),i.push(m),l.push(p)}}}const i=[];return r.length&&i.push(r),n.length&&i.push(n),i}const V={minCurvature:r.deg2rad(5),maxCurvature:r.deg2rad(50),minSamples:1,maxSamples:6},_=s.fromValues(1,0,0),G=s.fromValues(0,1,0),j=s.create(),Z=s.create(),Y=s.create(),B=M.create(),J=g.create(),K=c.create(),Q=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:D,eyeForCenterWithHeadingTilt:H,eyeTiltToLookAtTilt:L,headingTiltToDirectionUp:q,lookAtTiltToEyeTilt:z,toArea:O,toExtent:N},Symbol.toStringTag,{value:"Module"}));e.cameraUtilsSpherical=Q,e.directionToHeadingTilt=D,e.eyeForCenterWithHeadingTilt=H,e.eyeTiltToLookAtTilt=L,e.headingTiltToDirectionUp=q,e.lookAtTiltToEyeTilt=z,e.toArea=O,e.toExtent=N});