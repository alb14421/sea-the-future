// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","./Envelope2D","./Geometry","./MultiPathImpl","./Envelope","./Point2D","./tslib.es6","./Transformation2D","./OperatorClip","./OperatorDensify","./SimpleGeometryCursor","./OperatorDefinitions"],function(e,t,s,n,r,i,o,a,m,l,h,g){"use strict";class u{constructor(e){if(this.m_geom=this.m_sr=null,e){if(e.move)return this.m_geom=e.move.m_geom,e.move.m_geom=null,this.m_sr=e.move.m_sr,void(e.move.m_sr=null);if(e.copy)return this.m_geom=e.copy.m_geom?e.copy.m_geom.clone():null,void(this.m_sr=e.copy.m_sr);e.geom&&(this.m_geom=e.geom),e.sr&&(this.m_sr=e.sr)}}getGeometry(){return this.m_geom}getSpatialReference(){return this.m_sr}setGeometry(e){this.m_geom=e}setSpatialReference(e){this.m_sr=e}equals(e,t){const s=e;return!(!this.m_sr&&s.m_sr||this.m_sr&&!s.m_sr||!this.m_geom&&s.m_geom||this.m_geom&&!s.m_geom||this.m_sr&&s.m_sr&&!this.m_sr.equals(s.m_sr)||this.m_geom&&s.m_geom&&!this.m_geom.equals(s.m_geom,t))}clone(){let e=null;return this.m_geom&&(e=this.m_geom.clone()),new u({geom:e,sr:this.m_sr})}hasGeom(){return!!this.m_geom}}class c{constructor(e){this.m_factor=1,this.m_wkid=0,this.m_peUnit=null,e&&(this.m_peUnit=e,this.m_factor=e.getUnitFactor(),this.m_wkid=e.getCode(),this.m_wkid<0&&(this.m_wkid=0))}getName(){return this.m_peUnit?this.m_peUnit.getName():""}getID(){return this.m_wkid}getConversionFactor(e){return this.getUnitType()!==e.getUnitType()&&s.throwInvalidArgumentException("unit type mismatch"),this.getUnitToBaseFactor()/e.getUnitToBaseFactor()}getUnitToBaseFactor(){return this.m_factor}getHashCode(){return i.hashCombine(i.hashInt32(this.getUnitType()),i.hashInt32(this.getUnitToBaseFactor()))}equals(e){return!!e&&this.getUnitType()===e.getUnitType()&&this.getUnitToBaseFactor()===e.getUnitToBaseFactor()&&this.getID()===e.getID()&&this.getName()===e.getName()}static isValidWkid(e){return!1}}const p={330:104878,500:104879,1300:104899,1450:104986,2230:104988,3800:104978,5e3:104919,6200:104906,8200:104909,9500:104927,9600:104977,1e4:[104911,104936],11e3:104941,11080:104872,11100:104907,12e3:104920,12400:104995,13e3:104948,14e3:[104923,104989],15e3:[104913,104954],15100:104976,16e3:[104926,104931],18e3:[104922,104982],21e3:104947,21500:104877,27e3:[104950,104957],29e3:104964,3e4:104921,31e3:104949,33e3:104946,4e4:[104914,104967],40600:104897,41900:104937,42e3:104951,43100:104993,49300:104924,50100:104939,54e3:104955,58200:104981,59500:104930,74e3:104961,77e3:104956,79e3:104962,83500:104910,85e3:104917,88800:104934,89200:104985,96e3:104997,104e3:104963,106500:104898,11e4:104938,133e3:104932,135e3:104983,17e4:104965,198200:104987,198630:104935,208e3:104966,235800:104952,249400:104929,252100:104980,255e3:104973,47e4:104972,529800:104942,531e3:104996,56e4:104928,561400:104979,578900:104945,584700:104959,593e3:104970,606e3:104999,718e3:104933,745700:104984,761400:104953,763500:104994,764e3:104940,788900:104958,1188300:104998,1195e3:104969,1352600:104968,1560800:104874,1562090:104915,1737400:104903,1821460:104918,1821490:104876,2409300:104912,2410300:104873,2439400:104974,2439700:104900,2575e3:104943,2631200:104875,2632345:104916,3393400:104904,3396190:[104905,104971],6051e3:104901,6051800:104902,637e4:104128,6370997:[4052,37008],6371e3:4035,6371007:4047,6371228:[4053,10346],6376045:[8042,8043],6376523:[4027,4901,4902],6376896:37007,6378135:[4122,4322,4324,4720,4985,4987],6378136:[4740,4923,7678,7680,9474,9475,104017,104018],6378137:[3823,3824,3888,3889,4017,4019,4023,4031,4040,4046,4055,4074,4075,4080,4081,4121,4126,4130,4133,4140,4141,4148,4151,4152,4163,4166,4167,4170,4171,4172,4173,4176,4180,4189,4190,4258,4269,4283,4318,4319,4326,4463,4466,4469,4470,4480,4482,4483,4490,4557,4558,4612,4617,4619,4624,4627,4659,4661,4667,4669,4670,4674,4686,4687,4693,4694,4702,4737,4742,4747,4749,4750,4755,4756,4757,4758,4759,4761,4762,4763,4764,4765,4883,4885,4887,4889,4893,4895,4898,4907,4909,4921,4925,4927,4929,4931,4933,4935,4937,4939,4941,4943,4945,4947,4949,4951,4953,4955,4957,4959,4961,4963,4965,4967,4971,4975,4977,4979,4981,4983,4989,4997,4999,5012,5013,5245,5246,5251,5252,5263,5264,5323,5324,5340,5342,5353,5354,5359,5360,5364,5365,5370,5371,5372,5373,5380,5381,5392,5393,5488,5489,5545,5546,5592,5593,5885,5886,6134,6135,6310,6311,6318,6319,6321,6322,6324,6325,6364,6365,6667,6668,6705,6706,6782,6783,6980,6982,6983,6987,6989,6990,7034,7035,7036,7037,7038,7039,7040,7041,7042,7072,7073,7084,7085,7086,7087,7133,7135,7136,7138,7139,7372,7373,7657,7659,7661,7663,7665,7685,7686,7797,7798,7816,7843,7844,7880,7881,7885,7886,7900,7901,7902,7903,7904,7905,7906,7907,7908,7909,7910,7911,7912,7915,7917,7919,7921,7923,7925,7927,7929,7931,8085,8086,8231,8232,8235,8237,8239,8240,8244,8246,8248,8249,8251,8252,8254,8255,8399,8403,8426,8427,8449,8542,8544,8545,8684,8685,8698,8699,8817,8818,8860,8888,8899,8900,8901,8902,8906,8907,8916,8918,8920,8922,8924,8926,8928,8930,8932,8934,8936,8938,8940,8942,8944,8946,8948,8949,8972,8973,8974,8975,8976,8977,8978,8979,8980,8981,8982,8983,8984,8985,8986,8987,8988,8989,8990,8991,8992,8993,8994,8995,8996,8997,8998,8999,9e3,9002,9003,9005,9006,9008,9009,9011,9012,9013,9014,9016,9017,9018,9019,9053,9054,9055,9056,9057,9059,9060,9061,9062,9063,9064,9065,9066,9067,9068,9069,9071,9072,9074,9075,9139,9140,9147,9148,9152,9153,9183,9184,9293,9294,9299,9308,9309,9332,9333,9364,9372,9379,9380,9384,9453,9469,9470,9546,9547,9695,9696,9701,9702,9739,9754,9755,9758,9763,9776,9777,9778,9779,9781,9782,9783,9784,9866,9871,9939,9964,9969,9974,9989,9990,10175,10177,10178,10185,10191,10196,10204,10209,10214,10219,10224,10229,10237,10272,10277,10283,10284,10298,10299,10300,10304,10305,10307,10309,10310,10311,10312,10327,10328,10413,10414,10468,10474,10475,10570,10571,10605,10606,10623,10628,10638,10639,10670,10671,10672,10673,10689,10690,10724,10725,10738,10739,10761,10762,10780,10781,10784,10785,10799,10800,20033,20040,20041,20045,20046,104009,104010,104011,104012,104013,104014,104015,104016,104019,104020,104021,104022,104024,104027,104028,104050,104100,104107,104108,104110,104111,104114,104115,104116,104117,104118,104119,104120,104121,104122,104123,104124,104129,104133,104134,104137,104141,104142,104143,104144,104145,104179,104180,104181,104182,104183,104184,104185,104186,104199,104223,104257,104258,104259,104260,104286,104287,104602,104613,104644,104645,104646,104647,104653,104804,104896,104991],6378140:4610,6378145:[4025,4276,4760,4891,37001],6378150:37003,6378155:[37004,37207],6378160:[3821,4003,4021,4036,4202,4203,4237,4238,4291,4618,4708,5527,37231,104023,104136],6378166:37002,6378200:[4020,4229,4286,4303,4706],6378245:[4024,4147,4164,4178,4179,4191,4200,4205,4214,4284,4317,4555,4676,4677,4678,4991,4993,5560,5561,37257,104135],6378270:[4732,37005,37229],6378273:[4054,10345],6378300:[4029,4168,4174],6378388:[4022,4123,4153,4154,4158,4159,4160,4161,4165,4181,4182,4183,4184,4185,4192,4194,4195,4196,4199,4204,4207,4208,4215,4218,4221,4224,4225,4230,4231,4233,4235,4236,4247,4248,4249,4254,4255,4259,4264,4265,4271,4272,4274,4285,4287,4288,4292,4297,4309,4311,4313,4316,4472,4475,4611,4614,4615,4616,4621,4622,4623,4625,4626,4628,4629,4630,4631,4632,4633,4636,4637,4639,4641,4642,4643,4644,4645,4646,4658,4660,4662,4663,4664,4665,4668,4672,4673,4684,4688,4689,4690,4691,4692,4698,4704,4705,4707,4709,4710,4711,4712,4714,4715,4716,4718,4719,4721,4722,4724,4725,4727,4728,4729,4730,4733,4734,4735,4739,4741,4753,4754,4802,4803,4806,4809,4810,4823,4824,4900,5524,6883,8428,8430,8431,9248,9251,9253,9403,9893,10158,10249,10252,10635,10636,10735,10736,10758,37201,37204,37205,37212,37213,37214,37215,37216,37217,37218,37219,37221,37222,37224,37226,37227,37230,37232,37233,37234,37235,37237,37238,37241,37242,37245,37246,37247,37249,37250,37251,37253,37259,104104,104106,104125,104126,104127,104130,104138,104248],6378523:104786,24764e3:104960,25559e3:104944,60268e3:104925,71492e3:104908,6957e5:104975,6377397.155:[3819,3906,4004,4120,4124,4125,4149,4150,4156,4162,4211,4219,4257,4262,4280,4289,4294,4295,4301,4306,4308,4312,4314,4613,4666,4745,4746,4801,4804,4805,4808,4813,4814,4815,4818,4820,4904,5132,5228,5229,5681,5830,8351,9267,10268,37255,104101,104102,104105,104131,104648,104696,104697,104990,104992],6377563.396:[4001,4188,4277,4278,4279],6377340.189:[4002,4299,4300],6377492.018:[4005,4273,4817],6377483.865280418:[4006,4293],6378293.645208759:[4007,4157,4302,4738,5464],6378206.4:[4008,4127,4128,4129,4135,4136,4137,4138,4139,4169,4216,4242,4253,4267,4608,4609,4638,4675,4683,4695,4717,4723,4726,4995,5451,5467,37220,37239,37243,37252,37260,104e3,104109,104112,104113,104132],6378450.047:[4009,4268],6378300.789:[4010,4281],6378249.2:[4011,4014,4155,4193,4206,4213,4223,4226,4227,4228,4252,4261,4266,4275,4282,4296,4304,4310,4315,4671,4807,4811,4816,4821,37223,37225,104139,104140,104261,104304],6378249.145:[4012,4013,4132,4134,4142,4143,4175,4197,4198,4201,4209,4210,4212,4220,4222,4232,4234,4246,4250,4251,4256,4260,4263,4270,4305,4307,4600,4601,4602,4603,4604,4605,4606,4607,4620,4679,4680,4696,4697,4699,4700,4701,4703,4713,4731,4736,4743,4744,4812,4819,6881,6882,6892,6894,8694,37206,37208,37211,37228,37240,37254,104025,104026,104103,104305],6377276.345:[4015,4131,4144,4239,4240,4244,4682,5233,6207,37202,104256,104664,104693],6377298.556:[4016,4298],6377304.063:[4018,4245],6378298.3:[4028,4903],6378136.2:4032,6378136.3:4033,6378249.144808011:[4034,4241],20922931.8:[4042,4243],6377301.243:[4044,4145,37203],6377299.151:[4045,4146],6377019.27:[4657,10256,10260,10265],6378306.3696:[4748,4752],6377295.664:[4751,37006],6378136.5:[7682,7683],6371008.7714:104047,6378418.941:[104700,104726,104760],6378586.581:[104701,104743],6378505.809:104702,6378544.823:104703,6378490.569:104704,6378470.757:[104705,104776],6378403.701:[104706,104750],6378434.181:[104707,104724,104739,104764],6378454.907:104708,6378400.653:104709,6378567.378:104710,6378546.957:[104711,104717,104780],6378476.853:[104712,104736],6378411.321:[104713,104728],6378647.541:[104714,104715],6378514.953:[104716,104782],6378421.989:[104718,104770],6378481.425:[104719,104753,104774,104781],6378518.001:[104720,104725],6378521.049:[104721,104723,104731,104745,104748],6378464.661:104722,6378436.619:104727,6378574.389:[104729,104730],6378472.281:[104732,104756],6378498.189:[104733,104746],6378449.421:[104734,104766],6378525.621:[104735,104754],6378466.185:104737,6378496.665:104738,6378643.579:104740,6378559.758:104741,6378414.369:[104742,104763,104772],6378441.801:104744,6378502.761:[104747,104759,104773,104775],6378617.061:104749,6378624.681:[104751,104765],6378468.623:104752,6378445.763:[104755,104758,104761],6378670.401:104757,6378438.753:104762,6378543.909:104767,6378605.783:104768,6378540.861:104769,6378443.325:[104771,104784],6378548.481:104777,6378463.746:104778,6378426.561:104779,6378453.688:104783,6378530.193:104785,6378376.271:[104800,104828],6378471.92:104801,6378472.931:104802,6378411.351:104803,6378380.991:104805,6378414.96:104806,6378345.09:[104807,104819,104844,104870],6378412.542:104808,6378470.401:104809,6378376.331:104810,6378379.031:104811,6378407.621:104812,6378376.811:[104813,104827],6378313.92:104814,6378414.93:104815,6378413.021:104816,6378380.381:104817,6378530.851:104818,6378591.521:104820,6378378.881:104821,6378408.481:[104822,104832],6378375.601:[104823,104838],6378408.041:104824,6378655.071:104825,6378409.151:104826,6378315.7:[104829,104840,104845,104851],6378285.86:[104830,104835,104859],6378379.301:104831,6378560.121:104833,6378531.821:104834,6378500.6:104836,6378376.041:104837,6378406.601:104839,6378438.991:104841,6378345.42:104842,6378593.86:104843,6378381.271:[104846,104847],6378413.671:104848,6378344.377:104849,6378563.891:104850,6378408.091:104852,6378377.671:104853,6378472.751:104854,6378412.511:104855,6378407.281:104856,6378534.451:104857,6378406.051:104858,6378532.921:104860,6378380.091:104861,6378408.941:104862,6378624.171:104863,6378377.411:104864,6378474.591:104865,6378407.141:104866,6378376.871:104867,6378375.251:104868,6378405.971:104869,6378437.651:104871};class d extends c{constructor(e){if("number"==typeof e)return super(),this.m_factor=e,void(this.m_wkid=0);super(e)}getUnitType(){return 1}convertFromRadians(e){return e/this.getUnitToBaseFactor()}convertToRadians(e){return e*this.getUnitToBaseFactor()}}class _{constructor(e,t,n){void 0===e?(this.x=new i.ECoordinate,this.y=new i.ECoordinate,this.z=new i.ECoordinate):e instanceof r.Point3D?(this.x=new i.ECoordinate(e.x),this.y=new i.ECoordinate(e.y),this.z=new i.ECoordinate(e.z)):e instanceof i.ECoordinate?(this.x=e.clone(),this.y=t.clone(),this.z=n.clone()):s.throwInvalidArgumentException("EPoint3D constructor")}dotProduct(e){return this.x.mulE(e.x).addE(this.y.mulE(e.y)).addE(this.z.mulE(e.z))}crossProduct(e){return new _(this.y.mulE(e.z).subE(this.z.mulE(e.y)),this.z.mulE(e.x).subE(this.x.mulE(e.z)),this.x.mulE(e.y).subE(this.y.mulE(e.x)))}crossProductVector(e){const t=this.y.mulE(e.z).subE(e.y.mulE(this.z)),s=e.x.mulE(this.z).subE(this.x.mulE(e.z)),n=this.x.mulE(e.y).subE(e.x.mulE(this.y));return new _(t,s,n)}sqrLength(){return this.x.mulE(this.x).addE(this.y.mulE(this.y)).addE(this.z.mulE(this.z))}length(){return this.sqrLength().sqrt()}static distance(e,t){return e.sub(t).length()}negate(){return new _(this.x.negate(),this.y.negate(),this.z.negate())}add(e){return new _(this.x.addE(e.x),this.y.addE(e.y),this.z.addE(e.z))}sub(e){return new _(this.x.subE(e.x),this.y.subE(e.y),this.z.subE(e.z))}subThis(e){return this.x.subThisE(e.x),this.y.subThisE(e.y),this.z.subThisE(e.z),this}addThis(e){return this.x.addThisE(e.x),this.y.addThisE(e.y),this.z.addThisE(e.z),this}mul(e){return new _(this.x.mulE(e),this.y.mulE(e),this.z.mulE(e))}div(e){return new _(this.x.divE(e),this.y.divE(e),this.z.divE(e))}eq(e){return this.x.eq(e.x)&&this.y.eq(e.y)&&this.z.eq(e.z)}isZero(){return this.x.isZero()&&this.y.isZero()&&this.z.isZero()}value(){return r.Point3D.construct(this.x.value(),this.y.value(),this.z.value())}}class f{constructor(e){if(this.m_origin=new r.Point3D,this.m_normal=new r.Point3D,this.m_axisX=new r.Point3D,this.m_axisY=new r.Point3D,!e)return this.m_origin=new r.Point3D,this.m_normal=new r.Point3D(0,0,1),this.m_axisX=new r.Point3D(1,0,0),void(this.m_axisY=new r.Point3D(0,1,0));e.pt0&&e.pt1&&e.pt2?this.setFromPoints(e.pt0,e.pt1,e.pt2):s.geometryReleaseAssert(0,`unimplemented constructor options ${JSON.stringify(e)}`)}assign(e){return s.geometryReleaseAssert(0),this}set(e,t,n,r){s.geometryReleaseAssert(0)}setFromPoints(e,t,s){let n=t.sub(e);const r=s.sub(e);this.m_normal=n.crossProductVector(r);let i=!0;if(this.m_normal.isZero()){if(i=!1,n.isZero()&&(n=r),n.isZero()){const t=0,s=1;return this.m_normal.setCoords(t,t,s),this.m_axisX.setCoords(s,t,t),this.m_axisY.setCoords(t,s,t),this.m_origin=e,!1}this.m_axisX=n.getUnitVector(),this.m_normal=this.m_axisX.createAPerpendicular()}else this.m_normal.normalizeThis(),this.m_axisX=n.getUnitVector();return this.m_axisY=this.m_normal.crossProductVector(this.m_axisX),this.m_origin=e,i}getCoord(e,t){return s.geometryReleaseAssert(0),{}}getCoord2D(e){return s.geometryReleaseAssert(0),{}}getCoordX(e,t){return s.geometryReleaseAssert(0),0}getCoordY(e,t){return s.geometryReleaseAssert(0),0}getCoordZ(e,t){return s.geometryReleaseAssert(0),0}setPreferredAxisX(e){s.geometryReleaseAssert(0)}getOrigin(){return s.geometryReleaseAssert(0),{}}getNormal(){return s.geometryReleaseAssert(0),{}}getAxisX(){return this.m_axisX.clone()}getAxisY(){return this.m_axisY.clone()}setAxisX(e,t=!1){s.geometryReleaseAssert(0)}setAxisY(e,t=!1){s.geometryReleaseAssert(0)}recalculateAxisY(){s.geometryReleaseAssert(0)}setOrigin(e){s.geometryReleaseAssert(0)}setNormal(e,t){s.geometryReleaseAssert(0)}intersect(e,t){return s.geometryReleaseAssert(0),!1}intersectLine(e){return s.geometryReleaseAssert(0),0}intersectLineEx(e,t){return s.geometryReleaseAssert(0),0}closestCoordinate(e){const t=e.sub(this.m_origin),s=new i.Point2D;return s.x=t.dotProduct(this.m_axisX),s.y=t.dotProduct(this.m_axisY),s}projectVector(e){return s.geometryReleaseAssert(0),{}}signedDistance(e){return s.geometryReleaseAssert(0),0}distance(e){return s.geometryReleaseAssert(0),0}}function y(e,t){return!1}function x(e,t,n,r,o=100,a=y){let m,l,h,g,u,c,p,d,_;s.geometryReleaseAssert(r>0);let f,x,P,E=0,S=0;const C=i.goldenRatio();t>n&&(n=i.swap(t,t=n));const I=e(t),v=e(n);I<v?(m=l=h=t,g=u=c=I):(m=l=h=n,g=u=c=v);let T=0;for(;T<o&&(P=.5*(n-t),_=t+P,f=r*(Math.abs(m)+.25),x=2*f,!(a(m,g)||Math.abs(m-_)<=x-P));++T){if(Math.abs(S)>f){const e=(m-l)*(g-c);let s=(m-h)*(g-u),r=(m-h)*s-(m-l)*e;s=2*(s-e),s>0&&(r=-r),s=Math.abs(s);const o=S;S=E,Math.abs(r)>=Math.abs(s*o*.5)||r<=s*(t-m)||r>=s*(n-m)?(S=m>=_?t-m:n-m,E=i.goldenRatio()*S):(E=r/s,d=m+E,(d-t<x||n-d<x)&&(E=_-m<0?-Math.abs(f):Math.abs(f)))}else S=m>=_?t-m:n-m,E=S*C;d=m+E,p=e(d),p<g?(d>=m?t=m:n=m,h=l,l=m,m=d,c=u,u=g,g=p):(d<m?t=d:n=d,p<=u||l===m?(h=l,l=d,c=u,u=p):(p<=c||h===m||h===l)&&(h=d,c=p))}return i.makePair(m,g)}function P(e,t,s){return e>s?e-=Math.ceil((e-s)/i.geometry2Pi)*i.geometry2Pi:e<t&&(e+=Math.ceil((t-e)/i.geometry2Pi)*i.geometry2Pi),e}function E(e,t,s){return function(e,t,s){const n=s.x,r=s.y;return S(e,t,Math.cos(n),Math.sin(n),Math.cos(r),Math.sin(r),0)}(e,t,s)}function S(e,t,s,n,i,o,a){const m=e/Math.sqrt(1-t*o*o),l=m+a,h=l*i*s,g=l*i*n,u=(m*(1-t)+a)*o;return r.Point3D.construct(h,g,u)}function C(e,t,s){const n=new i.ECoordinate,r=new i.ECoordinate,o=new i.ECoordinate,a=new i.ECoordinate;n.setCos(s.x),r.setSin(s.x),o.setCos(s.y),a.setSin(s.y);const m=a.negate().mulE(a.mul(t)).add(1).sqrt(),l=new i.ECoordinate(e).divE(m),h=l.mulE(o).mulE(n),g=l.mulE(o).mulE(r),u=l.mul(1-t).mulE(a);return new _(h,g,u)}function I(e,t,s){const n=s.x,r=s.y,o=s.z,a=Math.atan2(r,n),m=Math.sqrt(n*n+r*r),l=Math.atan2(o,(1-t)*m);return i.Point2D.construct(a,l)}function v(e,t,s){const n=1-t,r=e/Math.sqrt(i.sqr(s.x)+i.sqr(s.y)+i.sqr(s.z)/n);return s.mul(r)}function T(e,t,s,n,i){const o=E(e,t,s),a=E(e,t,n);return I(0,t,r.Point3D.lerp(o,a,i))}function D(e,t,s){const n=new r.Point3D;return n.setCrossProductVector(t,s),Math.abs(Math.atan2(n.length(),t.dotProduct(s)))*e}function w(t,n,a,m,l,h=0,g){if(2===h||3===h)return function(e,t,s,n,o,a=!1,m){const l=v(e,t,s);if(a){const a=new f({pt0:new r.Point3D(0,0,0),pt1:n,pt2:o}),h=a.closestCoordinate(s),g=a.closestCoordinate(n),u=a.closestCoordinate(o),c=i.Point2D.getClosestCoordinate(g,u,h),p=v(e,t,r.Point3D.lerp(n,o,c)),d=r.Point3D.distance(p,l);return m&&m.assign(p),i.makePair(c,d)}const h=s=>{const i=v(e,t,r.Point3D.lerp(n,o,s));return r.Point3D.distance(i,l)},g=r.Point3D.distance(n,o);if(g>0){const s=A(e,g),{first:a,second:l}=x(h,0,1,s);return m&&m.assign(v(e,t,r.Point3D.lerp(n,o,a))),i.makePair(a,l)}{const e=r.Point3D.distance(s,n);return m&&m.assign(s),i.makePair(.5,e)}}(t,n,a,m,l,3===h,g);const u=I(0,n,a),c=i=>{const a=I(0,n,r.Point3D.lerp(m,l,i));return function(t,n,i,a,m){switch(s.geometryReleaseAssert(i.isFinite()&&a.isFinite()),m){case 0:return function(t,s,n,r){const i={stack:[],error:void 0,hasError:!1};try{const a=o.__addDisposableResource(i,new e.PeDoubleClass,!1);return e.peLineType.geodeticDistance(t,s,n.x,n.y,r.x,r.y,a,null,null,e.peDefs.PE_LINETYPE_GEODESIC),a.val}catch(e){i.error=e,i.hasError=!0}finally{o.__disposeResources(i)}}(t,n,i,a);case 1:return function(t,s,n){const r={stack:[],error:void 0,hasError:!1};try{const i=o.__addDisposableResource(r,new e.PeDoubleClass,!1);return e.peLineType.greatEllipticDistance(t,s,n.x,n.y,n.x,n.y,i,null,null),i.val}catch(e){r.error=e,r.hasError=!0}finally{o.__disposeResources(r)}}(t,n,i);case 2:case 3:{const e=E(t,n,i),s=E(t,n,a);return r.Point3D.distance(e,s)}default:s.throwNotImplementedException("")}}(t,n,u,a,h)},p=r.Point3D.distance(m,l);if(p>0){const e=A(t,p),{first:s,second:o}=x(c,0,1,e);return g&&g.assign(v(t,n,r.Point3D.lerp(m,l,s))),i.makePair(s,o)}{const e=c(0);return g&&g.assign(m),i.makePair(.5,e)}}function b(e,t,s,r,o,a){if(a[0]=Number.NaN,a[1]=Number.NaN,Math.abs(s.x-r.x)>Math.PI)return 0;if(Math.abs(s.y)>i.geometryHalfPi||Math.abs(r.y)>i.geometryHalfPi)return 0;if((Math.abs(s.y)===i.geometryHalfPi||Math.abs(r.y)===i.geometryHalfPi)&&s.x!==r.x)return 0;if(Math.abs(o)>=i.geometryHalfPi)return 0;if(s.y>0&&r.y>0&&s.y>o&&r.y>o||s.y<0&&r.y<0&&s.y<o&&r.y<o)return 0;const m=n.EPoint2D.constructPoint2D(s),l=n.EPoint2D.constructPoint2D(r),h=C(1,t,m),g=C(1,t,l),u=h.crossProductVector(g);if(u.z.isZero())return i.Envelope1D.construct(s.y,r.y).containsCoordinate(o)?(a[0]=s.x,1):0;const c=u.x.divE(u.z.negate()),p=u.y.divE(u.z.negate()),d=c.mulE(c).addE(p.mulE(p)).sqrt();if(d.isZero()||c.isZero()&&p.isZero())return 0===o?(a[0]=s.x,a[1]=r.x,2):0;const _=(1-t)*Math.tan(o)/d.value();if(Math.abs(_)>1)return 0;const f=Math.acos(_),y=Math.atan2(p.value(),c.value()),x=y-f;let E=y+f;const S=Math.min(s.x,r.x),I=Math.max(s.x,r.x);P(x,S,I),0!==o?P(E,S,I):E=x;let v=0;return S<=x&&x<=I&&(a[v]=x,v++),E!==x&&S<=E&&E<=I&&(a[v]=E,v++),v}function G(e,t){t[0]>.5*Math.PI?(e[0]+=Math.PI,t[0]=Math.PI-t[0]):t[0]<.5*-Math.PI&&(e[0]-=Math.PI,t[0]=-Math.PI-t[0]),s.geometryReleaseAssert(t[0]>=.5*-Math.PI&&t[0]<=.5*Math.PI)}function N(e,t){if(0===t)return 0;const s=Math.sin(t);let n=s,r=s;if(0!==e){n/=1-e*s*s;const t=Math.sqrt(e);r=s*i.atanhUOverU(t*s)}return n+r}function H(e,t){return(1-t)*e}function A(e,t){if(0!==t){const s=e*i.geographyEpsFactor()/t;return Math.min(s,1e-10)}return 0}class F{constructor(e){this.m_currentShift=63n,this.m_currentElt=0n,this.m_iCurrentElt=-1,this.m_parent=e,this.m_aiSetElts=e.m_bits.flatMap((e,t)=>t)}next(){if(this.m_currentShift++,64n===this.m_currentShift){if(this.m_iCurrentElt++,this.m_iCurrentElt===this.m_aiSetElts.length)return F.npos();this.m_currentShift=0n,this.m_currentElt=this.m_parent.m_bits[this.m_aiSetElts[this.m_iCurrentElt]]}for(;this.m_currentShift<63n&&!(this.m_currentElt&1n<<this.m_currentShift);)this.m_currentShift++;return this.m_currentElt&1n<<this.m_currentShift?64*this.m_aiSetElts[this.m_iCurrentElt]+Number(this.m_currentShift):this.next()}static npos(){return Number.MAX_SAFE_INTEGER}}function V(e){return 1n<<(0x3fn&BigInt(e))}function R(e){return e>>6}class k{constructor(e){this.m_bits=[],void 0!==e&&e.copy&&(this.m_bits=e.copy.m_bits.slice())}assignMove(){return this}assignCopy(){return this}hasBit(e){const t=V(e),s=R(e);return void 0!==this.m_bits[s]&&!!(this.m_bits[s]&t)}setBit(e){const t=V(e),s=R(e);void 0===this.m_bits[s]&&(this.m_bits[s]=0n),this.m_bits[s]|=t}clearBit(e){}flipBit(e){const t=V(e),s=R(e);return void 0===this.m_bits[s]&&(this.m_bits[s]=0n),this.m_bits[s]^=t,0n!==(this.m_bits[s]&t)}clear(){this.m_bits.length=0}isZero(){let e=0;return this.m_bits.forEach(t=>{e|=t?2:1}),!(2&e)}equals(e){if(this===e)return!0;if(this.m_bits.length!==e.m_bits.length)return!1;let t=0;return this.m_bits.forEach((s,n)=>{t|=s===e.m_bits[n]?2:1}),!(1&t||(e.m_bits.forEach((e,s)=>{t|=e===this.m_bits[s]?2:1}),1&t))}notEquals(e){return!this.equals(e)}assignOr(e){return e.m_bits.forEach((e,t)=>{void 0===this.m_bits[t]?this.m_bits[t]=e:this.m_bits[t]|=e}),this}assignSubtract(e){return e.m_bits.forEach((e,t)=>{void 0!==this.m_bits[t]&&(this.m_bits[t]&=~e)}),this}assignAnd(e){return e.m_bits.forEach((e,t)=>{void 0!==this.m_bits[t]&&(this.m_bits[t]&=e)}),this}assignXor(e){return e.m_bits.forEach((e,t)=>{void 0===this.m_bits[t]?this.m_bits[t]=e:this.m_bits[t]^=e}),this}getHashCode(){return this.m_bits.reduce((e,t)=>i.hashCombineInt64(e,t),i.hashInt32(0))}getUnorderedBitIterator(){return new F(this)}}class M{constructor(e,t){this.m_map=new Map,this.m_hf=e,this.m_ef=t}add(e){const t=this.m_hf(e);if(!this.m_map.has(t))return this.m_map.set(t,e),this;const s=this.m_map.get(t);return s instanceof Array?s.find(t=>this.m_ef(t,e))||s.push(e):this.m_ef(s,e)||this.m_map.set(t,[s,e]),this}clear(){this.m_map.clear()}delete(e){return!1}has(e){const t=this.m_hf(e);if(!this.m_map.has(t))return!1;const s=this.m_map.get(t);return s instanceof Array?void 0!==s.find(t=>this.m_ef(t,e)):this.m_ef(s,e)}get(e){const t=this.m_hf(e),s=this.m_map.get(t);if(void 0!==s)return s instanceof Array?s.find(t=>this.m_ef(t,e)):s}get size(){let e=0;for(const t of this.m_map.values())e+=t instanceof Array?t.length:1;return e}forEach(e,t){}[Symbol.iterator](){return(new Set)[Symbol.iterator]()}entries(){return(new Set).entries()}keys(){return(new Set).keys()}values(){return(new Set).values()}get[Symbol.toStringTag](){return"ValueSet"}}class U extends r.Comparator{constructor(e){super(),this.m_bufferLeft=new n.SegmentBuffer,this.m_bufferRight=new n.SegmentBuffer,this.m_intervalLeft=i.Envelope1D.constructEmpty(),this.m_intervalRight=i.Envelope1D.constructEmpty(),this.m_yScanline=Number.NaN,this.m_helper=e}compare(e,t,s){const n=t,r=e.getElement(s);this.m_helper.querySegmentXY(n,this.m_bufferLeft),this.m_helper.querySegmentXY(r,this.m_bufferRight);const i=this.m_bufferLeft.get(),o=this.m_bufferRight.get();if(this.m_intervalLeft.setCoords(i.getStartX(),i.getEndX()),this.m_intervalRight.setCoords(o.getStartX(),o.getEndX()),this.m_intervalLeft.vmax<this.m_intervalRight.vmin)return-1;if(this.m_intervalLeft.vmin>this.m_intervalRight.vmax)return 1;const a=i.getStartY()===i.getEndY(),m=o.getStartY()===o.getEndY();if(a||m){if(a&&m)return 0;if(i.getStartY()===o.getStartY()&&i.getStartX()===o.getStartX())return a?1:-1;if(i.getEndY()===o.getEndY()&&i.getEndX()===o.getEndX())return a?-1:1}let l=i.intersectionOfYMonotonicWithAxisX(this.m_yScanline,this.m_intervalLeft.vmin),h=o.intersectionOfYMonotonicWithAxisX(this.m_yScanline,this.m_intervalRight.vmin);if(l===h){const e=i.getEndY(),t=o.getEndY(),s=Math.min(e,t);let n=.5*(s+this.m_yScanline);n===this.m_yScanline&&(n=s),l=i.intersectionOfYMonotonicWithAxisX(n,this.m_intervalLeft.vmin),h=o.intersectionOfYMonotonicWithAxisX(n,this.m_intervalRight.vmin)}return l<h?-1:l>h?1:0}setY(e){this.m_yScanline=e}}class O{constructor(e){this.m_segmentBuffer=new n.SegmentBuffer,this.m_point=i.Point2D.getNAN(),this.m_parent=e}setPointXY(e){this.m_point.assign(e)}compare(e,t){const s=e.getElement(t);this.m_parent.querySegmentXY(s,this.m_segmentBuffer);const n=this.m_segmentBuffer.get(),r=new i.Envelope1D;if(r.setCoords(n.getStartX(),n.getEndX()),this.m_point.x<r.vmin)return-1;if(this.m_point.x>r.vmax)return 1;const o=n.intersectionOfYMonotonicWithAxisX(this.m_point.y,this.m_point.x);return this.m_point.x<o?-1:this.m_point.x>o?1:0}}var B,q;function Y(e,t){return{parentage:e,rank:t}}function X(e,t){const s=e.length;if(s!==t.length)return!1;const n=e[0].parentage;if(n!==t[0].parentage)return!1;if(-1===n)return!0;for(let n=1;n<s;++n)if(e[n].parentage!==t[n].parentage)return!1;return!0}function L(e,t,s){s.length=0;let r=!1;{let i=e.getHalfEdgeVertexIterator(t);for(;i!==n.nullHandle;){const t=e.getVertexFromVertexIterator(i),n=e.getShape().getSegmentRank(t),o=e.getShape().getSegmentParentage(t);r||=o>=0,s.push(Y(o,n)),i=e.incrementVertexIterator(i)}}{let i=e.getHalfEdgeVertexIterator(e.getHalfEdgeTwin(t));for(;i!==n.nullHandle;){const t=e.getVertexFromVertexIterator(i),n=e.getShape().getSegmentRank(t),o=e.getShape().getSegmentParentage(t);r||=o>=0,s.push(Y(o,n)),i=e.incrementVertexIterator(i)}}r&&s.sort((e,t)=>e.rank>t.rank?-1:e.rank<t.rank?1:e.parentage<t.parentage?-1:e.parentage>t.parentage?1:0),-1===s[0].parentage&&(s.length=1)}!function(e){e[e.enumInputModeBuildGraph=0]="enumInputModeBuildGraph",e[e.enumInputModeSimplifyAlternate=1]="enumInputModeSimplifyAlternate",e[e.enumInputModeSimplifyWinding=2]="enumInputModeSimplifyWinding"}(B||(B={})),function(e){e[e.enumSegmentParentageBreakNode=1]="enumSegmentParentageBreakNode",e[e.enumPathBreakNode=2]="enumPathBreakNode"}(q||(q={}));class z{constructor(){this.m_shape=null,this.m_clusterData=new r.StridedIndexTypeCollection(8),this.m_clusterVertices=new r.StridedIndexTypeCollection(2),this.m_firstCluster=n.nullHandle,this.m_lastCluster=n.nullHandle,this.m_halfEdgeData=new r.StridedIndexTypeCollection(8),this.m_chainData=new r.StridedIndexTypeCollection(8),this.m_chainAreas=null,this.m_chainPerimeters=null,this.m_universeChain=-1,this.m_simplifiedGeometry=-1,this.m_edgeIndices=[],this.m_clusterIndices=[],this.m_chainIndices=[],this.m_bBuildGeometryParentageSets=!1,this.m_chainBitSetIndex=-1,this.m_edgeBitSetIndex=-1,this.m_edgeBitSetIndexLeft=-1,this.m_emptyBitSet=null,this.m_geometryMapID=null,this.m_uniqueBitSets=null,this.m_chainBitSets=[],this.m_edgeBitSets=[],this.m_checkDirtyPlanesweepTolerance=Number.NaN,this.m_geometryIDIndex=-1,this.m_clusterIndex=-1,this.m_halfEdgeIndex=-1,this.m_tmpHalfEdgeParentageIndex=-1,this.m_tmpHalfEdgeParentageIndexLeft=-1,this.m_tmpHalfEdgeWindingNumberIndex=-1,this.m_tmpHalfEdgeOddEvenNumberIndex=-1,this.m_segmentParentageIndex=-1,this.m_segmentIndexHe=-1,this.m_clusterBreakNodeIndex=-1,this.m_universeGeomID=-1,this.m_pointCount=0,this.m_progressCounter=0,this.m_bBuildChains=!0,this.m_bDirtyCheckFailed=!1}setCheckDirtyPlanesweepTolerance(e){this.m_checkDirtyPlanesweepTolerance=e}dirtyCheckFailed(){return this.m_bDirtyCheckFailed}getShape(){return this.m_shape}setEditShape(e,t,s=!0,n=!1){n?this.setEditShapeImpl3D_(e,B.enumInputModeBuildGraph,null,t,!1):this.setEditShapeImpl_(e,B.enumInputModeBuildGraph,null,t,s)}setAndSimplifyEditShapeAlternate(e,t,n=null,r=!1){const i=[];i.push(t),this.m_simplifiedGeometry=t,r?this.setEditShapeImpl3D_(e,B.enumInputModeSimplifyAlternate,i,n,!1):this.setEditShapeImpl_(e,B.enumInputModeSimplifyAlternate,i,n,e.getGeometryType(t)===s.GeometryType.enumPolygon)}setAndSimplifyEditShapeWinding(e,t,s=null){const n=[];n.push(t),this.m_simplifiedGeometry=t,this.setEditShapeImpl_(e,B.enumInputModeSimplifyWinding,n,s,!0)}removeShape(){null!==this.m_shape&&(-1!==this.m_geometryIDIndex&&(this.m_shape.removeGeometryUserIndex(this.m_geometryIDIndex),this.m_geometryIDIndex=-1),-1!==this.m_clusterIndex&&(this.m_shape.removeUserIndex(this.m_clusterIndex),this.m_clusterIndex=-1),-1!==this.m_halfEdgeIndex&&(this.m_shape.removeUserIndex(this.m_halfEdgeIndex),this.m_halfEdgeIndex=-1),-1!==this.m_tmpHalfEdgeParentageIndex&&(this.deleteUserIndexForHalfEdges(this.m_tmpHalfEdgeParentageIndex),this.m_tmpHalfEdgeParentageIndex=-1),-1!==this.m_tmpHalfEdgeParentageIndexLeft&&(this.deleteUserIndexForHalfEdges(this.m_tmpHalfEdgeParentageIndexLeft),this.m_tmpHalfEdgeParentageIndexLeft=-1),-1!==this.m_tmpHalfEdgeWindingNumberIndex&&(this.deleteUserIndexForHalfEdges(this.m_tmpHalfEdgeWindingNumberIndex),this.m_tmpHalfEdgeWindingNumberIndex=-1),-1!==this.m_tmpHalfEdgeOddEvenNumberIndex&&(this.deleteUserIndexForHalfEdges(this.m_tmpHalfEdgeOddEvenNumberIndex),this.m_tmpHalfEdgeOddEvenNumberIndex=-1),-1!==this.m_segmentParentageIndex&&(this.deleteUserIndexForHalfEdges(this.m_segmentParentageIndex),this.m_segmentParentageIndex=-1),-1!==this.m_segmentIndexHe&&(this.deleteUserIndexForHalfEdges(this.m_segmentIndexHe),this.m_segmentIndexHe=-1),-1!==this.m_clusterBreakNodeIndex&&(this.deleteUserIndexForClusters(this.m_clusterBreakNodeIndex),this.m_clusterBreakNodeIndex=-1),this.deleteEdgeBitSets_(),this.deleteChainBitSets_(),this.m_emptyBitSet=null,this.m_geometryMapID=null,this.m_shape=null,this.m_clusterData.deleteAll(!0),this.m_clusterVertices.deleteAll(!0),this.m_firstCluster=n.nullHandle,this.m_lastCluster=n.nullHandle,this.m_halfEdgeData.deleteAll(!0),this.m_edgeIndices.length=0,this.m_clusterIndices.length=0,this.m_chainIndices.length=0,this.m_chainData.deleteAll(!0),this.m_universeChain=n.nullHandle,this.m_chainAreas=null)}getClusterHalfEdge(e){return this.m_clusterData.getField(e,2)}queryXY(e,t){const s=this.getClusterVertexIndex_(e);t.assign(this.m_shape.getXYWithIndex(s))}queryXYZ(e,t){s.geometryReleaseAssert(0)}getClusterParentage(e){return this.m_clusterData.getField(e,1)}getFirstCluster(){return this.m_firstCluster}getPrevCluster(e){return this.m_clusterData.getField(e,3)}getNextCluster(e){return this.m_clusterData.getField(e,4)}getClusterChain(e){return this.m_clusterData.getField(e,6)}getClusterVertexIterator(e){return this.m_clusterData.getField(e,7)}incrementVertexIterator(e){return this.m_clusterVertices.getField(e,1)}getVertexFromVertexIterator(e){return this.m_clusterVertices.getField(e,0)}getClusterUserIndex(e,t){const s=this.getClusterIndex_(e),n=this.m_clusterIndices[t];return n.size()<=s?-1:n.read(s)}setClusterUserIndex(e,t,s){const n=this.getClusterIndex_(e),r=this.m_clusterIndices[t];r.size()<=n&&r.resize(this.m_clusterData.size(),-1),r.write(n,s)}hasClusterUserIndexFlags(e,t,s){if(-1===t)return!1;const n=this.getClusterUserIndex(e,t);return-1!==n&&0!==(s&n)}setClusterUserIndexFlags(e,t,s){const n=this.getClusterIndex_(e),r=this.m_clusterIndices[t];r.size()<=n&&r.resize(this.m_clusterData.size(),-1);let i=r.read(n);-1===i&&(i=0),r.write(n,s|i)}clearClusterUserIndexFlags(e,t,s){const n=this.getClusterIndex_(e),r=this.m_clusterIndices[t];r.size()<=n&&r.resize(this.m_clusterData.size(),-1);let i=r.read(n);-1===i&&(i=0),r.write(n,~s&i)}createUserIndexForClusters(e=-1){const t=new r.AttributeStreamOfInt32(this.m_clusterData.capacity(),e);for(let e=0,s=this.m_clusterIndices.length;e<s;e++)if(null===this.m_clusterIndices[e])return this.m_clusterIndices[e]=t,e;return this.m_clusterIndices.push(t),this.m_clusterIndices.length-1}deleteUserIndexForClusters(e){this.m_clusterIndices[e]=null}getHalfEdgeOrigin(e){return this.m_halfEdgeData.getField(e,1)}getHalfEdgeTo(e){return this.getHalfEdgeOrigin(this.getHalfEdgeTwin(e))}getHalfEdgeTwin(e){return this.m_halfEdgeData.getField(e,4)}getHalfEdgePrev(e){return this.m_halfEdgeData.getField(e,5)}getHalfEdgeNext(e){return this.m_halfEdgeData.getField(e,6)}getHalfEdgeChain(e){return this.m_halfEdgeData.getField(e,2)}getHalfEdgeFaceParentage(e){return this.getChainParentage(this.getHalfEdgeChain(e))}getHalfEdgeVertexIterator(e){return this.m_halfEdgeData.getField(e,7)}getHalfEdgeFromXY(e,t){this.queryXY(this.getHalfEdgeOrigin(e),t)}getHalfEdgeToXY(e,t){this.queryXY(this.getHalfEdgeTo(e),t)}isHalfEdgeCurve(e){return-1!==this.m_segmentIndexHe&&-1!==this.getHalfEdgeUserIndex(e,this.m_segmentIndexHe)}getHalfEdgeFromXYZ(e,t){s.geometryReleaseAssert(0)}getHalfEdgeToXYZ(e,t){s.geometryReleaseAssert(0)}getHalfEdgeParentage(e){return this.m_halfEdgeData.getField(e,3)&z.c_EdgeParentageMask}getHalfEdgeUserIndex(e,t){const s=this.getHalfEdgeIndex_(e),n=this.m_edgeIndices[t];return n.size()<=s?-1:n.read(s)}setHalfEdgeUserIndex(e,t,s){const n=this.getHalfEdgeIndex_(e),r=this.m_edgeIndices[t];r.size()<=n&&r.resize(this.m_halfEdgeData.size(),-1),r.write(n,s)}createUserIndexForHalfEdges(e){void 0===e&&(e=-1);const t=new r.AttributeStreamOfInt32(this.m_halfEdgeData.capacity(),e);for(let e=0,s=this.m_edgeIndices.length;e<s;e++)if(null===this.m_edgeIndices[e])return this.m_edgeIndices[e]=t,e;this.m_edgeIndices.push(t);const n=this.m_edgeIndices.length-1;return s.geometryReleaseAssert(n>=0&&n<=Number.MAX_SAFE_INTEGER),n}deleteUserIndexForHalfEdges(e){this.m_edgeIndices[e]=null}deleteEdgesBreakFaces_(e){for(let t=0,s=e.length;t<s;t++){const s=e[t],r=this.getHalfEdgeChain(s),i=this.getHalfEdgeTwin(s),o=this.getHalfEdgeChain(i);this.setChainHalfEdge_(r,n.nullHandle),this.setChainHalfEdge_(o,n.nullHandle),this.updateVertexToHalfEdgeConnection_(s,!0),this.deleteEdgeImpl_(s)}}doesHalfEdgeBelongToAPolygonInterior(e,t){return s.geometryReleaseAssert(0),!1}doesHalfEdgeBelongToAPolygonExterior(e,t){return s.geometryReleaseAssert(0),!1}doesHalfEdgeBelongToAPolygonBoundary(e,t){return s.geometryReleaseAssert(0),!1}doesHalfEdgeBelongToAPolylineInterior(e,t){return s.geometryReleaseAssert(0),!1}doesHalfEdgeBelongToAPolylineExterior(e,t){return s.geometryReleaseAssert(0),!1}doesClusterBelongToAPolygonInterior(e,t){return s.geometryReleaseAssert(0),!1}doesClusterBelongToAPolygonExterior(e,t){return s.geometryReleaseAssert(0),!1}doesClusterBelongToAPolygonBoundary(e,t){return s.geometryReleaseAssert(0),!1}getFirstChain(){return this.m_universeChain}getChainHalfEdge(e){return this.m_chainData.getField(e,1)}getChainParentage(e){return this.m_chainData.getField(e,2)}getChainParent(e){return this.m_chainData.getField(e,3)}getChainFirstIsland(e){return this.m_chainData.getField(e,4)}getChainNextInParent(e){return this.m_chainData.getField(e,5)}getChainNext(e){return this.m_chainData.getField(e,7)}getChainArea(e){const t=this.getChainIndex_(e);let s=this.m_chainAreas.read(t);return Number.isNaN(s)&&(this.updateChainAreaAndPerimeter_(e),s=this.m_chainAreas.read(t)),s}getChainPerimeter(e){return s.geometryReleaseAssert(0),0}getChainUserIndex(e,t){const s=this.getChainIndex_(e),n=this.m_chainIndices[t];return n.size()<=s?-1:n.read(s)}setChainUserIndex(e,t,s){const n=this.getChainIndex_(e),r=this.m_chainIndices[t];r.size()<=n&&r.resize(this.m_chainData.size(),-1),r.write(n,s)}createUserIndexForChains(){const e=new r.AttributeStreamOfInt32(this.m_chainData.capacity(),-1);for(let t=0,s=this.m_chainIndices.length;t<s;t++)if(null===this.m_chainIndices[t])return this.m_chainIndices[t]=e,t;return this.m_chainIndices.push(e),this.m_chainIndices.length-1}deleteUserIndexForChains(e){this.m_chainIndices[e]=null}extractPolygonFromChainAndIslands(e,t,r,i){const o=t===n.nullHandle?e.createGeometry(s.GeometryType.enumPolygon):t,a=new n.SegmentBuffer;this.extractPolygonPathFromChain_(e,o,r,i,a);for(let t=this.getChainFirstIsland(r);t!==n.nullHandle;t=this.getChainNextInParent(t))this.extractPolygonPathFromChain_(e,o,t,i,a);return o}getGeometryID(e){const t=this.m_shape.getGeometryUserIndex(e,this.m_geometryIDIndex);return s.geometryReleaseAssert(t>=0),1<<Math.min(t,31)}getClusterFromVertex(e){return this.m_shape.getUserIndex(e,this.m_clusterIndex)}getHalfEdgeFromVertex(e){return this.m_shape.getUserIndex(e,this.m_halfEdgeIndex)}buildGeometryParentageSets(){this.m_bBuildGeometryParentageSets=!0}getChainBitSet(e){if(s.geometryReleaseAssert(this.m_bBuildGeometryParentageSets),-1===this.m_chainBitSetIndex)return this.getEmptySet();const t=this.getChainUserIndex(e,this.m_chainBitSetIndex);s.geometryReleaseAssert(t>=0);let n=this.m_chainBitSets.at(t);return n||(n=this.getEmptySet()),n}getChainBoundaryBitSet(e){s.geometryReleaseAssert(this.m_bBuildGeometryParentageSets);const t=new k,r=e=>{const s=this.getChainHalfEdge(e);let n=s;do{const e=this.getEdgeBitSet_(n);null!==e&&t.assignOr(e);const s=this.getEdgeBitSet_(this.getHalfEdgeTwin(n));null!==s&&t.assignOr(s),n=this.getHalfEdgeNext(n)}while(n!==s)};r(e);for(let t=this.getChainFirstIsland(e);t!==n.nullHandle;t=this.getChainNextInParent(t))r(e);return t}getChainPolygons(e){return s.geometryReleaseAssert(0),[]}getGeometriesFromBits(e){if(!this.m_bBuildGeometryParentageSets||null===e)return[];if(null===this.m_geometryMapID){this.m_geometryMapID=new Map;for(let e=this.m_shape.getFirstGeometry();e!==n.nullHandle;e=this.m_shape.getNextGeometry(e))this.m_geometryMapID.set(this.m_shape.getGeometryUserIndex(e,this.m_geometryIDIndex),e)}const t=[],r=e.getUnorderedBitIterator();for(let e=r.next();e!==F.npos();e=r.next())s.geometryReleaseAssert(this.m_geometryMapID.has(e)),t.push(this.m_geometryMapID.get(e));return t}getVertexDominant(e,t){if(t===n.nullHandle)return e;const s=this.getClusterFromVertex(e);return this.getVertexDominantFromCluster(s,t)}getVertexDominantFromCluster(e,t){if(t!==n.nullHandle){let s=n.nullHandle;for(let r=this.getClusterVertexIterator(e);r!==n.nullHandle;r=this.incrementVertexIterator(r)){const e=this.getVertexFromVertexIterator(r);s===n.nullHandle&&(s=e);const i=this.m_shape.getPathFromVertex(e);if(this.m_shape.getGeometryFromPath(i)===t){s=e;break}}return s}{const t=this.getClusterVertexIterator(e);return t!==n.nullHandle?this.getVertexFromVertexIterator(t):n.nullHandle}}isBreakNode(e){return this.hasClusterUserIndexFlags(e,this.m_clusterBreakNodeIndex,q.enumSegmentParentageBreakNode)}setBreakNode(e,t){s.geometryReleaseAssert(-1!==this.m_clusterBreakNodeIndex),t?this.setClusterUserIndexFlags(e,this.m_clusterBreakNodeIndex,q.enumSegmentParentageBreakNode):this.clearClusterUserIndexFlags(e,this.m_clusterBreakNodeIndex,q.enumSegmentParentageBreakNode)}isStrongPathNode(e){return this.hasClusterUserIndexFlags(e,this.m_clusterBreakNodeIndex,q.enumPathBreakNode)}setStrongPathNode(e,t){if(-1===this.m_clusterBreakNodeIndex){if(!t)return;this.m_clusterBreakNodeIndex=this.createUserIndexForClusters()}t?this.setClusterUserIndexFlags(e,this.m_clusterBreakNodeIndex,q.enumPathBreakNode):this.clearClusterUserIndexFlags(e,this.m_clusterBreakNodeIndex,q.enumPathBreakNode)}getSegmentParentage(e){if(-1===this.m_segmentParentageIndex)return-1;const t=this.getHalfEdgeUserIndex(e,this.m_segmentParentageIndex);return t>=0?t:-1}isCrossroadAhead(e){const t=this.getHalfEdgeNext(e);if(this.isStrongPathNode(this.getHalfEdgeOrigin(t)))return!0;const s=this.getHalfEdgeTwin(t),n=this.getHalfEdgeNext(s);return e!==this.getHalfEdgeTwin(n)}isCrossroadBehind(e){return s.geometryReleaseAssert(0),!1}getHalfEdgeConnector(e,t){const s=this.getClusterHalfEdge(e);if(s===n.nullHandle)return n.nullHandle;let r=s,i=n.nullHandle,o=n.nullHandle;do{if(this.getHalfEdgeTo(r)===t)return r;if(i===n.nullHandle){if(i=this.getClusterHalfEdge(t),i===n.nullHandle)return n.nullHandle;o=i}if(this.getHalfEdgeTo(o)===e)return r=this.getHalfEdgeTwin(o),r;r=this.getHalfEdgeNext(this.getHalfEdgeTwin(r)),o=this.getHalfEdgeNext(this.getHalfEdgeTwin(o))}while(r!==s&&o!==i);return n.nullHandle}querySegmentXY(e,t){if(-1!==this.m_segmentIndexHe){let s=this.getHalfEdgeUserIndex(e,this.m_segmentIndexHe);if(-1!==s){if(-2!==s){const e=this.m_shape.getSegmentFromIndex(s);t.copyFrom(e,!0)}else{s=this.getHalfEdgeUserIndex(this.getHalfEdgeTwin(e),this.m_segmentIndexHe);const n=this.m_shape.getSegmentFromIndex(s);t.copyFrom(n,!0),t.get().reverse()}return}}t.createLine();const s=t.get(),n=i.Point2D.getNAN();this.getHalfEdgeFromXY(e,n),s.setStartXY(n),this.getHalfEdgeToXY(e,n),s.setEndXY(n)}isCurveEdge(e){return-1!==this.m_segmentIndexHe&&-1!==this.getHalfEdgeUserIndex(e,this.m_segmentIndexHe)}compareEdgeAnglesCurveHelper_(e,t,r){const o=new n.SegmentBuffer,a=new n.SegmentBuffer;this.querySegmentXY(e,o),this.querySegmentXY(t,a);const m=o.get(),l=a.get();if(m.equals(l))return 0;const h=new i.Point2D;this.getHalfEdgeFromXY(e,h);const g=new i.Point2D;this.getHalfEdgeToXY(e,g);const u=new i.Point2D;return this.getHalfEdgeToXY(t,u),s.geometryReleaseAssert(!g.isEqualPoint2D(u)),n.compareConnectedSegments(m,l)}compareEdgeAnglesHelper_(e,t,s){if(e===t)return 0;if(this.isHalfEdgeCurve(e)||this.isHalfEdgeCurve(t))return this.compareEdgeAnglesCurveHelper_(e,t,s);const n=i.Point2D.getNAN();this.getHalfEdgeToXY(e,n);const r=i.Point2D.getNAN();if(this.getHalfEdgeToXY(t,r),n.isEqualPoint2D(r))return 0;const o=i.Point2D.getNAN();this.getHalfEdgeFromXY(e,o);const a=i.Point2D.getNAN();a.setSub(n,o);const m=i.Point2D.getNAN();return m.setSub(r,o),!s||m.y>=0&&a.y>0?i.Point2D.compareVectors(a,m):0}compareEdgeAngles_(e,t){return this.compareEdgeAnglesHelper_(e,t,!1)}compareEdgeAnglesForPair_(e,t){return this.compareEdgeAnglesHelper_(e,t,!0)}compareEdgeAngles3D_(e,t){return s.geometryReleaseAssert(0),0}compareEdgeAnglesForPair3D_(e,t){return s.geometryReleaseAssert(0),0}dbgDumpChains_(){}dbgDumpChainToPolygon_(e,t){}deleteEdgeInternal_(e){const t=this.getHalfEdgeChain(e),r=this.getHalfEdgeTwin(e),i=this.getHalfEdgeChain(r);s.geometryReleaseAssert(i===t),s.geometryReleaseAssert(e===this.getHalfEdgeNext(r)||r===this.getHalfEdgeNext(e));let o=this.getHalfEdgeNext(e);o===r&&(o=this.getHalfEdgeNext(o),o===e&&(o=n.nullHandle));const a=this.getChainIndex_(t),m=this.m_chainAreas.read(a);Number.isNaN(m)||(this.setChainArea_(t,Number.NaN),this.setChainPerimeter_(t,Number.NaN));const l=this.getChainHalfEdge(t);l!==e&&l!==r||this.setChainHalfEdge_(t,o),this.updateVertexToHalfEdgeConnection_(e,!0),this.deleteEdgeImpl_(e)}getFirstUnvisitedHalfEdgeOnCluster_(e,t,s){let r=t!==n.nullHandle?t:this.getClusterHalfEdge(e);if(r===n.nullHandle)return n.nullHandle;const i=r;for(;;){if(1!==this.getHalfEdgeUserIndex(r,s))return r;const e=this.getHalfEdgeNext(this.getHalfEdgeTwin(r));if(e===i)return n.nullHandle;r=e}}removeSpikes_(){let e=!1;const t=this.createUserIndexForHalfEdges();for(let s=this.getFirstCluster();s!==n.nullHandle;s=this.getNextCluster(s)){let r=n.nullHandle;for(;;){let i=this.getFirstUnvisitedHalfEdgeOnCluster_(s,r,t);if(i===n.nullHandle)break;r=this.getHalfEdgeNext(this.getHalfEdgeTwin(i));let o=i;for(;;){const s=this.getHalfEdgeNext(o),a=this.getHalfEdgePrev(o),m=this.getHalfEdgeTwin(o);if(a===m){if(this.deleteEdgeInternal_(o),e=!0,r!==o&&r!==m||(r=n.nullHandle),o===i||a===i){if(i=s,o===i||a===i)break;o=s;continue}}else this.setHalfEdgeUserIndex(o,t,1);if(o=s,o===i)break}}}return this.deleteUserIndexForHalfEdges(t),e}progress_(e,t=!1){}newCluster_(){const e=this.m_clusterData.newElement();return this.m_clusterData.setField(e,1,0),e}newHalfEdgePair_(){const e=this.m_halfEdgeData.newElement();this.m_halfEdgeData.setField(e,2,0),this.m_halfEdgeData.setField(e,3,0);const t=this.m_halfEdgeData.newElement();return this.m_halfEdgeData.setField(t,2,0),this.m_halfEdgeData.setField(t,3,0),this.setHalfEdgeTwin_(e,t),this.setHalfEdgeTwin_(t,e),e}newChain_(){const e=this.m_chainData.newElement();return this.m_chainData.setField(e,2,0),e}deleteChain_(e){return s.geometryReleaseAssert(0),0}getClusterIndex_(e){return this.m_clusterData.elementToIndex(e)}setClusterVertexIterator_(e,t){this.m_clusterData.setField(e,7,t)}setClusterHalfEdge_(e,t){this.m_clusterData.setField(e,2,t)}setClusterParentage_(e,t){this.m_clusterData.setField(e,1,t)}setPrevCluster_(e,t){this.m_clusterData.setField(e,3,t)}setNextCluster_(e,t){this.m_clusterData.setField(e,4,t)}setClusterVertexIndex_(e,t){this.m_clusterData.setField(e,5,t)}getClusterVertexIndex_(e){return this.m_clusterData.getField(e,5)}setClusterChain_(e,t){this.m_clusterData.setField(e,6,t)}addClusterToExteriorChain_(e,t){this.setClusterChain_(t,e)}getHalfEdgeIndex_(e){return this.m_halfEdgeData.elementToIndex(e)}setHalfEdgeOrigin_(e,t){this.m_halfEdgeData.setField(e,1,t)}setHalfEdgeTwin_(e,t){this.m_halfEdgeData.setField(e,4,t)}setHalfEdgePrev_(e,t){this.m_halfEdgeData.setField(e,5,t)}setHalfEdgeNext_(e,t){this.m_halfEdgeData.setField(e,6,t)}setHalfEdgeChain_(e,t){this.m_halfEdgeData.setField(e,2,t)}setHalfEdgeParentage_(e,t){this.m_halfEdgeData.setField(e,3,t)}getHalfEdgeParentageMask_(e){return this.m_halfEdgeData.getField(e,3)}setHalfEdgeVertexIterator_(e,t){this.m_halfEdgeData.setField(e,7,t)}updateVertexToHalfEdgeConnectionHelper_(e,t){const s=t?n.nullHandle:e;for(let t=this.getHalfEdgeVertexIterator(e);t!==n.nullHandle;t=this.incrementVertexIterator(t)){const e=this.getVertexFromVertexIterator(t);this.m_shape.setUserIndex(e,this.m_halfEdgeIndex,s)}}updateVertexToHalfEdgeConnection_(e,t){e!==n.nullHandle&&(this.updateVertexToHalfEdgeConnectionHelper_(e,t),this.updateVertexToHalfEdgeConnectionHelper_(this.getHalfEdgeTwin(e),t))}getChainIndex_(e){return this.m_chainData.elementToIndex(e)}setChainHalfEdge_(e,t){this.m_chainData.setField(e,1,t)}setChainParentage_(e,t){this.m_chainData.setField(e,2,t)}setChainParent_(e,t){this.m_chainData.setField(e,3,t);const s=this.getChainFirstIsland(t);this.setChainNextInParent_(e,s),this.setChainFirstIsland_(t,e)}setChainFirstIsland_(e,t){this.m_chainData.setField(e,4,t)}setChainNextInParent_(e,t){this.m_chainData.setField(e,5,t)}setChainPrev_(e,t){this.m_chainData.setField(e,6,t)}setChainNext_(e,t){this.m_chainData.setField(e,7,t)}setChainArea_(e,t){const s=this.getChainIndex_(e);this.m_chainAreas.write(s,t)}setChainPerimeter_(e,t){const s=this.getChainIndex_(e);this.m_chainPerimeters.write(s,t)}updateChainAreaAndPerimeter_(e){const t=this.m_shape.hasCurves(),s=new i.KahanSummator(0),r=new i.KahanSummator(0),o=this.getChainHalfEdge(e),a=i.Point2D.getNAN(),m=i.Point2D.getNAN(),l=i.Point2D.getNAN();this.getHalfEdgeFromXY(o,a),m.setCoordsPoint2D(a);let h=o;do{this.getHalfEdgeToXY(h,l),t&&this.isCurveEdge(h)||r.pe(i.Point2D.distance(m,l)),this.getHalfEdgeChain(this.getHalfEdgeTwin(h))!==e&&s.pe((l.x-a.x-(m.x-a.x))*(l.y-a.y+(m.y-a.y))*.5),m.setCoordsPoint2D(l),h=this.getHalfEdgeNext(h)}while(h!==o);if(t){const t=new n.SegmentBuffer;h=o;do{this.getHalfEdgeToXY(h,l);const n=this.isCurveEdge(h);if(n&&(this.querySegmentXY(h,t),r.pe(t.get().calculateLength2D())),this.getHalfEdgeChain(this.getHalfEdgeTwin(h))!==e&&n){const e=t.get().calculateArea2DHelper();s.pe(e)}h=this.getHalfEdgeNext(h)}while(h!==o)}const g=this.getChainIndex_(e);this.m_chainAreas.write(g,s.getResult()),this.m_chainPerimeters.write(g,r.getResult())}getChainTopmostEdge_(e){return s.geometryReleaseAssert(0),0}planeSweepParentage_(e,t){const s=new U(this),o=new r.Treap;o.setCapacity(Math.trunc(this.m_pointCount/2)),o.setComparator(s);const a=[],m=this.createUserIndexForHalfEdges();let l=null;const h=i.Point2D.getNAN();for(let i=this.getFirstCluster();i!==n.nullHandle;i=this.getNextCluster(i)){this.progress_(t);const g=this.getClusterHalfEdge(i);if(g!==n.nullHandle){if(a.length=0,!this.tryOptimizedInsertion_(o,m,a,i,g)){this.queryXY(i,h),s.setY(h.y);let e=g;do{const t=this.getHalfEdgeUserIndex(e,m);-1!==t&&(o.deleteNode(t),this.setHalfEdgeUserIndex(e,m,r.StridedIndexTypeCollection.impossibleIndex2())),e=this.getHalfEdgeNext(this.getHalfEdgeTwin(e))}while(g!==e);e=g;do{if(-1===this.getHalfEdgeUserIndex(e,m)){const t=o.addElement(e);a.push(t)}e=this.getHalfEdgeNext(this.getHalfEdgeTwin(e))}while(g!==e)}for(let t=a.length-1;t>=0;t--){const s=a[t],n=o.getElement(s),r=this.getHalfEdgeTwin(n);this.setHalfEdgeUserIndex(r,m,s),this.planeSweepParentagePropagateParentage_(o,s,e)}}else if(this.getClusterChain(i)===n.nullHandle){null===l&&(l=new O(this)),this.queryXY(i,h),l.setPointXY(h);const e=o.searchLowerBound(l);let t=this.m_universeChain;if(-1!==e){let s=o.getElement(e);this.getHalfEdgeChain(s)===this.getHalfEdgeChain(this.getHalfEdgeTwin(s))&&(s=this.getLeftSkipPolylines_(o,e)),s!==n.nullHandle&&(t=this.getHalfEdgeChain(s))}this.addClusterToExteriorChain_(t,i)}}this.deleteUserIndexForHalfEdges(m)}planeSweepParentagePropagateParentage_(e,t,r){const i=e.getElement(t),o=this.getHalfEdgeChain(i);if(this.getChainParent(o)!==n.nullHandle)return;const a=this.getLeftSkipPolylines_(e,t),m=this.getHalfEdgeTwin(i),l=this.getHalfEdgeChain(m);let h=this.getChainParent(o),g=this.getChainParent(l);if(a===n.nullHandle)h===n.nullHandle&&(l===o?(this.setChainParent_(l,this.m_universeChain),g=this.m_universeChain,h=g):(g===n.nullHandle&&(this.setChainParent_(l,this.m_universeChain),g=this.m_universeChain),this.setChainParent_(o,l),h=l));else{const e=this.getHalfEdgeChain(a);if(g===n.nullHandle){if(this.getChainArea(e)<=0){const t=this.getChainParent(e);this.setChainParent_(l,t),g=t}else this.setChainParent_(l,e),g=e;l===o&&(h=g)}}h===n.nullHandle&&(this.trySetChainParentFromTwin_(o,l),h=this.getChainParent(o)),s.geometryReleaseAssert(h!==n.nullHandle),r===B.enumInputModeBuildGraph?this.propagateParentageBuildGraph_(e,t,i,a):r===B.enumInputModeSimplifyWinding?this.propagateParentageWinding_(e,t,i,a,m,o,l):r===B.enumInputModeSimplifyAlternate&&this.propagateParentageAlternate_(e,t,i,a,m,o,l)}propagateParentageBuildGraph_(e,t,s,r){let i,o=t;r===n.nullHandle?(o=e.getNext(o),i=this.getHalfEdgeChain(s)):i=this.getHalfEdgeChain(r);let a=null,m=this.getChainParentage(i);for(this.m_bBuildGeometryParentageSets&&(a=this.getChainBitSet(i));-1!==o;o=e.getNext(o)){const t=e.getElement(o),s=this.getHalfEdgeTwin(t);i=this.getHalfEdgeChain(t);const n=this.getHalfEdgeChain(s);if(this.m_bBuildGeometryParentageSets){let e=this.getChainBitSet(n);e=new k({copy:e}),e.assignOr(a),this.setChainBitSet_(n,e);let s=this.getChainBitSet(i);const r=this.getLeftEdgeBitSet_(t),o=new k({copy:a});if(o.assignSubtract(r),o.isZero())break;s=new k({copy:s}),s.assignOr(o),this.setChainBitSet_(i,s),a=s}const r=this.getChainParentage(n),l=r|m;l!==r&&this.setChainParentage_(n,l);let h=this.getChainParentage(i);const g=m&~this.getHalfEdgeUserIndex(t,this.m_tmpHalfEdgeParentageIndexLeft);if(g&&(h|=g,this.setChainParentage_(i,h)),0===g)break;m=h}}propagateParentageWinding_(e,t,r,i,o,a,m){if(a===m)return;let l=this.getHalfEdgeUserIndex(r,this.m_tmpHalfEdgeWindingNumberIndex);l+=this.getHalfEdgeUserIndex(o,this.m_tmpHalfEdgeWindingNumberIndex);let h=0;const g=[],u=[];u.push(0);for(let r=e.getFirst();r!==t;r=e.getNext(r)){const t=e.getElement(r),i=this.getHalfEdgeTwin(t),o=this.getHalfEdgeChain(t),a=this.getHalfEdgeChain(i);if(o!==a){let e=this.getHalfEdgeUserIndex(t,this.m_tmpHalfEdgeWindingNumberIndex);e+=this.getHalfEdgeUserIndex(i,this.m_tmpHalfEdgeWindingNumberIndex),h+=e;let r=!1;0!==g.length&&g.at(-1)===a&&(u.pop(),g.pop(),r=!0),s.geometryReleaseAssert(this.getChainParent(a)!==n.nullHandle),r&&this.getChainParent(a)===o||(u.push(h),g.push(o))}}if(h+=l,0!==g.length&&g.at(-1)===m&&(u.pop(),g.pop()),0!==h){if(0===u.at(-1)){const e=this.m_simplifiedGeometry,t=this.getGeometryID(e);this.setChainParentage_(a,t)}}else if(0!==u.at(-1)){const e=this.m_simplifiedGeometry,t=this.getGeometryID(e);this.setChainParentage_(a,t)}}propagateParentageAlternate_(e,t,s,r,i,o,a){const m=this.m_simplifiedGeometry,l=this.getGeometryID(m);if(r===n.nullHandle)this.setChainParentage_(a,this.m_universeGeomID),1&this.getHalfEdgeUserIndex(s,this.m_tmpHalfEdgeOddEvenNumberIndex)?this.setChainParentage_(o,l):this.setChainParentage_(o,this.m_universeGeomID);else{const e=this.getChainParentage(a);if(0===e){const e=this.getHalfEdgeChain(r),t=this.getChainParentage(e);this.setChainParentage_(a,t),1&this.getHalfEdgeUserIndex(s,this.m_tmpHalfEdgeOddEvenNumberIndex)?this.setChainParentage_(o,t===l?this.m_universeGeomID:l):this.setChainParentage_(o,t)}else 1&this.getHalfEdgeUserIndex(s,this.m_tmpHalfEdgeOddEvenNumberIndex)?this.setChainParentage_(o,e===l?this.m_universeGeomID:l):this.setChainParentage_(o,e)}}tryOptimizedInsertion_(e,t,s,i,o){let a=o,m=-1,l=n.nullHandle,h=0;do{if(2===h)return!1;const e=this.getHalfEdgeUserIndex(a,t);if(-1!==e){if(-1!==m)return!1;m=e}else{if(l!==n.nullHandle)return!1;l=a}h++,a=this.getHalfEdgeNext(this.getHalfEdgeTwin(a))}while(o!==a);return l!==n.nullHandle&&-1!==m&&(this.setHalfEdgeUserIndex(e.getElement(m),t,r.StridedIndexTypeCollection.impossibleIndex2()),e.setElement(m,l),s.push(m),!0)}trySetChainParentFromTwin_(e,t){const s=this.getChainArea(e);if(0===s)return!1;const r=this.getChainArea(t);if(s>0&&r<0||s<0&&r>0)return this.setChainParent_(e,t),!0;{const s=this.getChainParent(t);if(s!==n.nullHandle)return this.setChainParent_(e,s),!0}return!1}createHalfEdges_(e,t){this.m_halfEdgeIndex=this.m_shape.createUserIndex();for(let r=0,i=t.size();r<i;r++){const i=t.read(r),o=this.m_shape.getUserIndex(i,this.m_clusterIndex),a=this.m_shape.getPathFromVertex(i),m=this.m_shape.getGeometryFromPath(a),l=this.m_shape.getGeometryType(m);if(s.isMultiPath(l)){const t=this.m_shape.getNextVertex(i);if(t===n.nullHandle)continue;const r=this.m_shape.getUserIndex(t,this.m_clusterIndex);if(o===r)continue;const a=this.newHalfEdgePair_(),h=this.getHalfEdgeTwin(a),g=this.m_clusterVertices.newElement();this.m_clusterVertices.setField(g,0,i),this.m_clusterVertices.setField(g,1,-1),this.setHalfEdgeVertexIterator_(a,g),this.m_shape.setUserIndex(i,this.m_halfEdgeIndex,a),this.setHalfEdgeOrigin_(a,o);const u=this.getClusterHalfEdge(o);if(u===n.nullHandle)this.setClusterHalfEdge_(o,a),this.setHalfEdgePrev_(a,h),this.setHalfEdgeNext_(h,a);else{const e=this.getHalfEdgePrev(u);this.setHalfEdgePrev_(u,h),this.setHalfEdgeNext_(h,u),this.setHalfEdgeNext_(e,a),this.setHalfEdgePrev_(a,e)}this.setHalfEdgeOrigin_(h,r);const c=this.getClusterHalfEdge(r);if(c===n.nullHandle)this.setClusterHalfEdge_(r,h),this.setHalfEdgeNext_(a,h),this.setHalfEdgePrev_(h,a);else{const e=this.getHalfEdgePrev(c);this.setHalfEdgePrev_(c,a),this.setHalfEdgeNext_(a,c),this.setHalfEdgeNext_(e,h),this.setHalfEdgePrev_(h,e)}const p=this.getGeometryID(m);if(e===B.enumInputModeBuildGraph){const e=l===s.GeometryType.enumPolygon?p:0;if(this.setHalfEdgeUserIndex(h,this.m_tmpHalfEdgeParentageIndex,0),this.setHalfEdgeUserIndex(a,this.m_tmpHalfEdgeParentageIndex,e),this.setHalfEdgeUserIndex(h,this.m_tmpHalfEdgeParentageIndexLeft,e),this.setHalfEdgeUserIndex(a,this.m_tmpHalfEdgeParentageIndexLeft,0),this.m_bBuildGeometryParentageSets){const e=new k,t=this.m_shape.getGeometryUserIndex(m,this.m_geometryIDIndex);e.setBit(t),this.setEdgeBitSet_(a,e),this.setEdgeBitSet_(h,null),this.setLeftEdgeBitSet_(h,e),this.setLeftEdgeBitSet_(a,null)}}else if(e===B.enumInputModeSimplifyWinding){const e=this.m_shape.getXY(i),s=this.m_shape.getXY(t);let n=0,r=0;e.compare(s)<0?n=1:r=-1,this.setHalfEdgeUserIndex(a,this.m_tmpHalfEdgeWindingNumberIndex,n),this.setHalfEdgeUserIndex(h,this.m_tmpHalfEdgeWindingNumberIndex,r)}else e===B.enumInputModeSimplifyAlternate&&(this.setHalfEdgeUserIndex(a,this.m_tmpHalfEdgeOddEvenNumberIndex,1),this.setHalfEdgeUserIndex(h,this.m_tmpHalfEdgeOddEvenNumberIndex,1));const d=l===s.GeometryType.enumPolygon?z.c_EdgeBitMask:0;this.setHalfEdgeParentage_(a,p|d),this.setHalfEdgeParentage_(h,p|d)}}if(this.m_shape.hasCurves()){this.m_segmentIndexHe=this.createUserIndexForHalfEdges();for(let e=0,s=t.size();e<s;e++){const s=t.read(e);if(this.m_shape.getSegment(s)){const e=this.m_shape.getUserIndex(s,this.m_halfEdgeIndex);e!==n.nullHandle&&(this.setHalfEdgeUserIndex(e,this.m_segmentIndexHe,this.m_shape.getVertexIndex(s)),this.setHalfEdgeUserIndex(this.getHalfEdgeTwin(e),this.m_segmentIndexHe,-2))}}}}mergeVertexListsOfEdges_(e,t){{const s=this.getHalfEdgeVertexIterator(t);if(s!==n.nullHandle){const r=this.getHalfEdgeVertexIterator(e);this.m_clusterVertices.setField(s,1,r),this.setHalfEdgeVertexIterator_(e,s),this.setHalfEdgeVertexIterator_(t,n.nullHandle)}}const s=this.getHalfEdgeTwin(e),r=this.getHalfEdgeTwin(t);{const e=this.getHalfEdgeVertexIterator(r);if(e!==n.nullHandle){const t=this.getHalfEdgeVertexIterator(s);this.m_clusterVertices.setField(e,1,t),this.setHalfEdgeVertexIterator_(s,e),this.setHalfEdgeVertexIterator_(r,n.nullHandle)}}if(-1!==this.m_segmentIndexHe){let n=this.getHalfEdgeUserIndex(e,this.m_segmentIndexHe);if(-1!==n){if(-2===n){const s=this.getHalfEdgeUserIndex(t,this.m_segmentIndexHe);this.setHalfEdgeUserIndex(e,this.m_segmentIndexHe,s)}if(n=this.getHalfEdgeUserIndex(s,this.m_segmentIndexHe),-2===n){const e=this.getHalfEdgeUserIndex(r,this.m_segmentIndexHe);this.setHalfEdgeUserIndex(s,this.m_segmentIndexHe,e)}}}}sortHalfEdgesByAngle_(e){const t=[];for(let s=this.getFirstCluster();s!==n.nullHandle;s=this.getNextCluster(s)){t.length=0;const r=this.getClusterHalfEdge(s);if(r!==n.nullHandle){let o=r;do{t.push(o),o=this.getHalfEdgeNext(this.getHalfEdgeTwin(o))}while(o!==r);if(t.length>1){let o=!0;t.length>2?(t.sort((e,t)=>this.compareEdgeAngles_(e,t)),t.push(t[0])):this.compareEdgeAnglesForPair_(t[0],t[1])>0?t[1]=i.swap(t[0],t[0]=t[1]):o=!1;let a=t[0],m=a,l=this.getHalfEdgeTo(m),h=this.getHalfEdgeTwin(m),g=n.nullHandle;for(let s=1,r=t.length;s<r;s++){const r=t[s],i=this.getHalfEdgeTwin(r),o=this.getHalfEdgeOrigin(i);if(o!==l||r===m)this.updateVertexToHalfEdgeConnection_(g,!1),g=n.nullHandle,m=r,l=o,h=i;else{if(e===B.enumInputModeBuildGraph){const e=this.getHalfEdgeParentageMask_(m)|this.getHalfEdgeParentageMask_(r);if(this.setHalfEdgeParentage_(m,e),this.setHalfEdgeParentage_(h,e),this.setHalfEdgeUserIndex(m,this.m_tmpHalfEdgeParentageIndex,this.getHalfEdgeUserIndex(m,this.m_tmpHalfEdgeParentageIndex)|this.getHalfEdgeUserIndex(r,this.m_tmpHalfEdgeParentageIndex)),this.setHalfEdgeUserIndex(h,this.m_tmpHalfEdgeParentageIndex,this.getHalfEdgeUserIndex(h,this.m_tmpHalfEdgeParentageIndex)|this.getHalfEdgeUserIndex(i,this.m_tmpHalfEdgeParentageIndex)),this.setHalfEdgeUserIndex(m,this.m_tmpHalfEdgeParentageIndexLeft,this.getHalfEdgeUserIndex(m,this.m_tmpHalfEdgeParentageIndexLeft)|this.getHalfEdgeUserIndex(r,this.m_tmpHalfEdgeParentageIndexLeft)),this.setHalfEdgeUserIndex(h,this.m_tmpHalfEdgeParentageIndexLeft,this.getHalfEdgeUserIndex(h,this.m_tmpHalfEdgeParentageIndexLeft)|this.getHalfEdgeUserIndex(i,this.m_tmpHalfEdgeParentageIndexLeft)),this.m_bBuildGeometryParentageSets){let e,t,s;e=this.getEdgeBitSet_(m),t=this.getEdgeBitSet_(r),s=new k({copy:e}),s.assignOr(t),this.setEdgeBitSet_(m,s),e=this.getEdgeBitSet_(h),t=this.getEdgeBitSet_(i),s=new k({copy:e}),s.assignOr(t),this.setEdgeBitSet_(h,s),e=this.getLeftEdgeBitSet_(m),t=this.getLeftEdgeBitSet_(r),s=new k({copy:e}),s.assignOr(t),this.setLeftEdgeBitSet_(m,s),e=this.getLeftEdgeBitSet_(h),t=this.getLeftEdgeBitSet_(i),s=new k({copy:e}),s.assignOr(t),this.setLeftEdgeBitSet_(h,s)}}else if(-1!==this.m_tmpHalfEdgeWindingNumberIndex){const e=this.getHalfEdgeUserIndex(m,this.m_tmpHalfEdgeWindingNumberIndex)+this.getHalfEdgeUserIndex(r,this.m_tmpHalfEdgeWindingNumberIndex),t=this.getHalfEdgeUserIndex(h,this.m_tmpHalfEdgeWindingNumberIndex)+this.getHalfEdgeUserIndex(i,this.m_tmpHalfEdgeWindingNumberIndex);this.setHalfEdgeUserIndex(m,this.m_tmpHalfEdgeWindingNumberIndex,e),this.setHalfEdgeUserIndex(h,this.m_tmpHalfEdgeWindingNumberIndex,t)}else if(-1!==this.m_tmpHalfEdgeOddEvenNumberIndex){const e=this.getHalfEdgeUserIndex(m,this.m_tmpHalfEdgeOddEvenNumberIndex)+this.getHalfEdgeUserIndex(r,this.m_tmpHalfEdgeOddEvenNumberIndex),t=this.getHalfEdgeUserIndex(h,this.m_tmpHalfEdgeOddEvenNumberIndex)+this.getHalfEdgeUserIndex(i,this.m_tmpHalfEdgeOddEvenNumberIndex);this.setHalfEdgeUserIndex(m,this.m_tmpHalfEdgeOddEvenNumberIndex,e),this.setHalfEdgeUserIndex(h,this.m_tmpHalfEdgeOddEvenNumberIndex,t)}this.mergeVertexListsOfEdges_(m,r),this.deleteEdgeImpl_(r),g=m,t[s]=n.nullHandle,r===a&&(t[0]=n.nullHandle,a=n.nullHandle)}}if(this.updateVertexToHalfEdgeConnection_(g,!1),g=n.nullHandle,!o){a=n.nullHandle;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(s!==n.nullHandle){a=s;break}}r!==a&&this.setClusterHalfEdge_(s,a);continue}a=n.nullHandle;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(s===n.nullHandle)continue;if(a===n.nullHandle){a=s,m=a,l=this.getHalfEdgeTo(m),h=this.getHalfEdgeTwin(m);continue}if(s===m)continue;const r=this.getHalfEdgeTwin(s),i=this.getHalfEdgeOrigin(r);this.setHalfEdgeNext_(h,s),this.setHalfEdgePrev_(s,h),m=s,l=i,h=r}this.setClusterHalfEdge_(s,a)}}}}sortHalfEdgesByAngle3D_(e){s.geometryReleaseAssert(0)}buildChains_(e){this.m_universeChain=this.newChain_(),this.setChainHalfEdge_(this.m_universeChain,n.nullHandle);let t=this.m_universeChain;const s=this.createUserIndexForHalfEdges();for(let e=this.getFirstCluster();e!==n.nullHandle;e=this.getNextCluster(e)){const r=this.getClusterHalfEdge(e);if(r!==n.nullHandle){let e=r;do{if(1!==this.getHalfEdgeUserIndex(e,s)){const n=this.newChain_();this.setChainHalfEdge_(n,e),this.setChainPrev_(n,t),this.setChainNext_(t,n);let r=null;this.m_bBuildGeometryParentageSets&&(r=new k),t=n;let i=0,o=e;do{-1!==this.m_tmpHalfEdgeParentageIndex&&(i|=this.getHalfEdgeUserIndex(o,this.m_tmpHalfEdgeParentageIndex)),this.m_bBuildGeometryParentageSets&&r.assignOr(this.getEdgeBitSet_(o)),this.setHalfEdgeChain_(o,n),this.setHalfEdgeUserIndex(o,s,1),o=this.getHalfEdgeNext(o)}while(o!==e);this.m_bBuildGeometryParentageSets&&this.setChainBitSet_(n,r),this.setChainParentage_(n,i)}e=this.getHalfEdgeNext(this.getHalfEdgeTwin(e))}while(e!==r)}}this.m_chainAreas=new r.AttributeStreamOfDbl(this.m_chainData.size(),Number.NaN),this.m_chainPerimeters=new r.AttributeStreamOfDbl(this.m_chainData.size(),Number.NaN),this.setChainArea_(this.m_universeChain,Number.POSITIVE_INFINITY),this.setChainPerimeter_(this.m_universeChain,Number.POSITIVE_INFINITY),this.deleteUserIndexForHalfEdges(s)}simplify_(e){s.geometryReleaseAssert(0)}simplifyAlternate_(){s.geometryReleaseAssert(0)}simplifyWinding_(){s.geometryReleaseAssert(0)}setEditShapeImpl_(e,t,o,a,m){this.removeShape(),this.m_bBuildChains=m,this.m_shape=e,this.m_geometryIDIndex=this.m_shape.createGeometryUserIndex();let l=this.m_shape.getTotalPointCount();if(o){l=0;for(let e=0,t=o.length;e<t;e++)l+=this.m_shape.getPointCount(o[e])}const h=new r.AttributeStreamOfInt32(0);let g=0,u=0;{let e=null!=o?o[0]:this.m_shape.getFirstGeometry(),t=1;for(;e!==n.nullHandle;){this.m_shape.setGeometryUserIndex(e,this.m_geometryIDIndex,u++);for(let t=this.m_shape.getFirstPath(e);t!==n.nullHandle;t=this.m_shape.getNextPath(t)){let e=this.m_shape.getFirstVertex(t);for(let s=0,n=this.m_shape.getPathSize(t);s<n;s++)h.add(e),e=this.m_shape.getNextVertex(e)}s.isPoint(this.m_shape.getGeometryType(e))||(g+=this.m_shape.getPathCount(e)),null!=o?(e=t<o.length?o[t]:n.nullHandle,t++):e=this.m_shape.getNextGeometry(e)}}this.m_universeGeomID=1<<Math.min(u,31),this.m_pointCount=h.size(),this.m_shape.sortVerticesSimpleByY(h,0,this.m_pointCount),this.m_clusterVertices.setCapacity(this.m_pointCount),this.progress_(a,!0),this.m_clusterData.setCapacity(this.m_pointCount+10),this.m_halfEdgeData.setCapacity(2*this.m_pointCount+32),this.m_chainData.setCapacity(Math.max(32,g)),this.m_clusterIndex=this.m_shape.createUserIndex();const c=i.Point2D.getNAN();let p=0;const d=i.Point2D.getNAN();for(let e=0;e<=this.m_pointCount;e++){if(e<this.m_pointCount){const t=h.read(e);this.m_shape.queryXY(t,d)}else d.setNAN();if(!c.isEqualPoint2D(d)){if(p<e){const t=this.newCluster_();let s=n.nullHandle,r=-1;for(let n=p;n<e;n++){r=h.read(n),this.m_shape.setUserIndex(r,this.m_clusterIndex,t);const e=this.m_clusterVertices.newElement();this.m_clusterVertices.setField(e,0,r),this.m_clusterVertices.setField(e,1,s),s=e;const i=this.m_shape.getPathFromVertex(r),o=this.m_shape.getGeometryFromPath(i),a=this.getGeometryID(o);this.setClusterParentage_(t,this.getClusterParentage(t)|a)}this.setClusterVertexIterator_(t,s),this.setClusterVertexIndex_(t,this.m_shape.getVertexIndex(r)),this.m_lastCluster!==n.nullHandle&&this.setNextCluster_(this.m_lastCluster,t),this.setPrevCluster_(t,this.m_lastCluster),this.m_lastCluster=t,this.m_firstCluster===n.nullHandle&&(this.m_firstCluster=t)}p=e,c.setCoordsPoint2D(d)}}if(this.m_shape.hasSegmentParentage()){-1===this.m_clusterBreakNodeIndex&&(this.m_clusterBreakNodeIndex=this.createUserIndexForClusters());for(let e=0;e<this.m_pointCount;e++){const t=h.read(e);if(this.m_shape.getSegmentParentageBreakVertex(t)){const e=this.getClusterFromVertex(t);this.setBreakNode(e,!0)}}}this.progress_(a,!0);{let e=null!=o?o[0]:this.m_shape.getFirstGeometry(),t=1;for(;e!==n.nullHandle;){for(let t=this.m_shape.getFirstPath(e);t!==n.nullHandle;t=this.m_shape.getNextPath(t)){if(this.m_shape.isStrongPathStart(t)){const e=this.m_shape.getFirstVertex(t),s=this.getClusterFromVertex(e);this.setStrongPathNode(s,!0)}if(this.m_shape.isStrongPathEnd(t)){const e=this.m_shape.isClosedPath(t)?this.m_shape.getFirstVertex(t):this.m_shape.getLastVertex(t),s=this.getClusterFromVertex(e);this.setStrongPathNode(s,!0)}}null!=o?(e=t<o.length?o[t]:n.nullHandle,t++):e=this.m_shape.getNextGeometry(e)}}if(t===B.enumInputModeBuildGraph&&(this.m_tmpHalfEdgeParentageIndex=this.createUserIndexForHalfEdges(),this.m_tmpHalfEdgeParentageIndexLeft=this.createUserIndexForHalfEdges()),t===B.enumInputModeSimplifyWinding&&(this.m_tmpHalfEdgeWindingNumberIndex=this.createUserIndexForHalfEdges()),t===B.enumInputModeSimplifyAlternate&&(this.m_tmpHalfEdgeOddEvenNumberIndex=this.createUserIndexForHalfEdges()),this.createHalfEdges_(t,h),this.dbgNavigate_(),this.sortHalfEdgesByAngle_(t),!Number.isNaN(this.m_checkDirtyPlanesweepTolerance)&&!this.checkStructureAfterDirtySweep_())return this.m_bDirtyCheckFailed=!0,void this.cleanSetEditShapeImpl_();this.buildChains_(t),-1!==this.m_tmpHalfEdgeParentageIndex&&(this.deleteUserIndexForHalfEdges(this.m_tmpHalfEdgeParentageIndex),this.m_tmpHalfEdgeParentageIndex=-1),this.m_bBuildChains&&this.planeSweepParentage_(t,a),-1!==this.m_tmpHalfEdgeParentageIndexLeft&&(this.deleteUserIndexForHalfEdges(this.m_tmpHalfEdgeParentageIndexLeft),this.m_tmpHalfEdgeParentageIndexLeft=-1),this.dbgChkChainParents_(),this.dbgDumpChains_(),this.mergeSegmentParentage_(),this.dbgNavigate_(),this.dbgDumpChains_(),this.cleanSetEditShapeImpl_()}setEditShapeImpl3D_(e,t,n,r,i){s.geometryReleaseAssert(0)}cleanSetEditShapeImpl_(){-1!==this.m_tmpHalfEdgeParentageIndex&&(this.deleteUserIndexForHalfEdges(this.m_tmpHalfEdgeParentageIndex),this.m_tmpHalfEdgeParentageIndex=-1),-1!==this.m_tmpHalfEdgeParentageIndexLeft&&(this.deleteUserIndexForHalfEdges(this.m_tmpHalfEdgeParentageIndexLeft),this.m_tmpHalfEdgeParentageIndexLeft=-1),-1!==this.m_tmpHalfEdgeWindingNumberIndex&&(this.deleteUserIndexForHalfEdges(this.m_tmpHalfEdgeWindingNumberIndex),this.m_tmpHalfEdgeWindingNumberIndex=-1),-1!==this.m_tmpHalfEdgeOddEvenNumberIndex&&(this.deleteUserIndexForHalfEdges(this.m_tmpHalfEdgeOddEvenNumberIndex),this.m_tmpHalfEdgeOddEvenNumberIndex=-1)}cleanSetEditShapeImpl3D_(){s.geometryReleaseAssert(0)}dbgNavigate_(){}dbgChkChainParents_(){}deleteEdgeImpl_(e){const t=this.getHalfEdgeNext(e),s=this.getHalfEdgePrev(e),r=this.getHalfEdgeTwin(e),i=this.getHalfEdgeNext(r),o=this.getHalfEdgePrev(r);t!==r&&(this.setHalfEdgeNext_(o,t),this.setHalfEdgePrev_(t,o)),s!==r&&(this.setHalfEdgeNext_(s,i),this.setHalfEdgePrev_(i,s));const a=this.getHalfEdgeOrigin(e);this.getClusterHalfEdge(a)===e&&(i!==e?this.setClusterHalfEdge_(a,i):this.setClusterHalfEdge_(a,n.nullHandle));const m=this.getHalfEdgeOrigin(r);this.getClusterHalfEdge(m)===r&&(t!==r?this.setClusterHalfEdge_(m,t):this.setClusterHalfEdge_(m,n.nullHandle)),this.m_halfEdgeData.deleteElement(e),this.m_halfEdgeData.deleteElement(r)}getLeftSkipPolylines_(e,t){let s=t;for(;;){if(s=e.getPrev(s),-1===s)return n.nullHandle;{const t=e.getElement(s);if(this.getHalfEdgeChain(t)!==this.getHalfEdgeChain(this.getHalfEdgeTwin(t)))return t}}}checkStructureAfterDirtySweep_(){const e=i.sqr(this.m_checkDirtyPlanesweepTolerance),t=new i.Point2D,s=new i.Point2D,r=new i.Point2D,o=new i.Point2D,a=new i.Point2D;for(let i=this.getFirstCluster();i!==n.nullHandle;i=this.getNextCluster(i)){const m=this.getClusterHalfEdge(i);if(m!==n.nullHandle){let n=m;this.getHalfEdgeFromXY(n,t),this.getHalfEdgeToXY(n,s),r.setSub(s,t);let i=r.sqrLength();do{const m=n;if(n=this.getHalfEdgeNext(this.getHalfEdgeTwin(n)),n!==m){this.getHalfEdgeToXY(n,o),a.setSub(o,t);const m=a.sqrLength(),l=a.crossProduct(r),h=l*l/(m*i);if(Math.min(m,i)*h<=e&&a.dotProduct(r)>=0)return!1;r.assign(a),i=m,s.assign(o)}}while(n!==m)}}return!0}extractPolygonPathFromChain_(e,t,s,i,o){const a=this.m_shape.hasSegmentParentage(),m=this.getChainHalfEdge(s);let l=m,h=n.nullHandle;const g=new r.Point;do{const r=this.getHalfEdgeTwin(l);if(this.getHalfEdgeChain(r)!==s){let s=n.nullHandle;const r=this.getHalfEdgeOrigin(l);if(i===n.nullHandle){const e=this.getClusterVertexIterator(r);s=this.getVertexFromVertexIterator(e)}else for(let e=this.getClusterVertexIterator(r);e!==n.nullHandle;e=this.incrementVertexIterator(e)){const t=this.getVertexFromVertexIterator(e);s===n.nullHandle&&(s=t);const r=this.m_shape.getPathFromVertex(t);if(this.m_shape.getGeometryFromPath(r)===i){s=t;break}}let m;if(h===n.nullHandle&&(h=e.insertPath(t,n.nullHandle),e.setClosedPath(h,!0)),this.m_shape===e?m=e.addVertex(h,s):(this.m_shape.queryPoint(s,g),m=e.addPoint(h,g)),this.isHalfEdgeCurve(l)&&(this.querySegmentXY(l,o),e.setSegmentToIndex(e.getVertexIndex(m),o.get().clone())),a){const t=this.getSegmentParentage(l);e.setSegmentParentageAndBreak(m,t,this.isBreakNode(r))}}l=this.getHalfEdgeNext(l)}while(l!==m)}mergeSegmentParentage_(){if(!this.m_shape.hasSegmentParentage())return;s.geometryReleaseAssert(-1!==this.m_clusterBreakNodeIndex),s.geometryReleaseAssert(-1===this.m_segmentParentageIndex);for(let e=this.getFirstCluster();e!==n.nullHandle;e=this.getNextCluster(e)){let t=0;const s=this.getClusterHalfEdge(e);if(s!==n.nullHandle){let e=s;do{t++,e=this.getHalfEdgeNext(this.getHalfEdgeTwin(e))}while(e!==s&&t<3)}2!==t&&this.setBreakNode(e,!0)}let e=[],t=[];this.m_segmentParentageIndex=this.createUserIndexForHalfEdges();const r=this.createUserIndexForHalfEdges();for(let s=this.getFirstCluster();s!==n.nullHandle;s=this.getNextCluster(s)){const o=this.getClusterHalfEdge(s);if(o!==n.nullHandle){let s=!1,n=o;do{let o=n;for(;-1===this.getHalfEdgeUserIndex(o,r);){const n=this.getHalfEdgeNext(o),a=this.getHalfEdgeTwin(o);L(this,o,t);const m=t.at(-1).parentage;if(!s){const t=this.getHalfEdgeOrigin(o);if(!this.isBreakNode(t)){const t=this.getHalfEdgePrev(o);o!==t&&(L(this,t,e),s=!0)}}if(s&&!X(t,e)){const e=this.getHalfEdgeOrigin(o);this.setBreakNode(e,!0)}e=i.swap(t,t=e),s=!0;const l=this.getHalfEdgeOrigin(n);this.isBreakNode(l)&&(s=!1),this.setHalfEdgeUserIndex(o,this.m_segmentParentageIndex,m),this.setHalfEdgeUserIndex(a,this.m_segmentParentageIndex,m),this.setHalfEdgeUserIndex(o,r,1),this.setHalfEdgeUserIndex(a,r,1),o=n}n=this.getHalfEdgeNext(this.getHalfEdgeTwin(n))}while(n!==o)}}this.deleteUserIndexForHalfEdges(r)}registerNewBitSet(e){return null===this.m_uniqueBitSets&&(this.m_uniqueBitSets=new M(e=>e.getHashCode(),(e,t)=>e.equals(t)),this.m_uniqueBitSets.add(this.getEmptySet())),null===e?this.getEmptySet():this.m_uniqueBitSets.has(e)?this.m_uniqueBitSets.get(e):(this.m_uniqueBitSets.add(e),e)}getLeftEdgeBitSet_(e){const t=this.getHalfEdgeUserIndex(e,this.m_edgeBitSetIndexLeft);return s.geometryReleaseAssert(t>=0),s.geometryReleaseAssert(this.m_edgeBitSets.at(t)),this.m_edgeBitSets.at(t)}getEdgeBitSet_(e){const t=this.getHalfEdgeUserIndex(e,this.m_edgeBitSetIndex);return s.geometryReleaseAssert(t>=0),this.m_edgeBitSets.at(t)}setEdgeBitSet_(e,t){s.geometryReleaseAssert(this.m_bBuildGeometryParentageSets),t=this.registerNewBitSet(t),-1===this.m_edgeBitSetIndex&&(this.m_edgeBitSetIndex=this.createUserIndexForHalfEdges());const n=this.getHalfEdgeUserIndex(e,this.m_edgeBitSetIndex);-1!==n?this.m_edgeBitSets[n]=t:(this.setHalfEdgeUserIndex(e,this.m_edgeBitSetIndex,this.m_edgeBitSets.length),this.m_edgeBitSets.push(t))}setLeftEdgeBitSet_(e,t){s.geometryReleaseAssert(this.m_bBuildGeometryParentageSets),t=this.registerNewBitSet(t),-1===this.m_edgeBitSetIndexLeft&&(this.m_edgeBitSetIndexLeft=this.createUserIndexForHalfEdges());const n=this.getHalfEdgeUserIndex(e,this.m_edgeBitSetIndexLeft);-1!==n?this.m_edgeBitSets[n]=t:(this.setHalfEdgeUserIndex(e,this.m_edgeBitSetIndexLeft,this.m_edgeBitSets.length),this.m_edgeBitSets.push(t))}setChainBitSet_(e,t){s.geometryReleaseAssert(this.m_bBuildGeometryParentageSets),t=this.registerNewBitSet(t),-1===this.m_chainBitSetIndex&&(this.m_chainBitSetIndex=this.createUserIndexForChains());const n=this.getChainUserIndex(e,this.m_chainBitSetIndex);-1!==n?this.m_chainBitSets[n]=t:(this.setChainUserIndex(e,this.m_chainBitSetIndex,this.m_chainBitSets.length),this.m_chainBitSets.push(t))}getEmptySet(){return this.m_emptyBitSet||(this.m_emptyBitSet=new k),this.m_emptyBitSet}deleteEdgeBitSets_(){-1!==this.m_edgeBitSetIndex&&(this.deleteUserIndexForHalfEdges(this.m_edgeBitSetIndex),this.m_edgeBitSetIndex=-1),-1!==this.m_edgeBitSetIndexLeft&&(this.deleteUserIndexForHalfEdges(this.m_edgeBitSetIndexLeft),this.m_edgeBitSetIndexLeft=-1),this.m_edgeBitSets.length=0,this.m_uniqueBitSets=null}deleteChainBitSets_(){-1!==this.m_chainBitSetIndex&&(this.deleteUserIndexForChains(this.m_chainBitSetIndex),this.m_chainBitSetIndex=-1,this.m_chainBitSets.length=0)}dbgPrintEdge_(e){}dbgVerifyEdgeSegment(e){}}z.c_EdgeParentageMask=~(1<<31),z.c_EdgeBitMask=1<<31;class W{freeNode_(e){this.m_listNodes.deleteElement(e)}newNode_(){return this.m_listNodes.newElement()}freeList_(e){this.m_lists.deleteElement(e)}newList_(){return this.m_lists.newElement()}Init_(e){s.geometryReleaseAssert(0)}constructor(e){this.m_listNodes=new r.StridedIndexTypeCollection(2),this.m_listOfLists=W.st_nullNode(),this.m_bAllowNavigationBetweenLists=!0,void 0===e&&(e=!0),this.m_bAllowNavigationBetweenLists=e,this.m_lists=new r.StridedIndexTypeCollection(this.m_bAllowNavigationBetweenLists?4:2)}createList(){const e=this.newList_();return this.m_bAllowNavigationBetweenLists&&(this.m_lists.setField(e,3,this.m_listOfLists),this.m_listOfLists!==W.st_nullNode()&&this.m_lists.setField(this.m_listOfLists,2,e),this.m_listOfLists=e),e}deleteList(e){let t=this.getFirst(e);for(;t!==W.st_nullNode();){const e=t;t=this.getNext(t),this.freeNode_(e)}if(this.m_bAllowNavigationBetweenLists){const t=this.m_lists.getField(e,2),s=this.m_lists.getField(e,3);t!==W.st_nullNode()?this.m_lists.setField(t,3,s):this.m_listOfLists=s,s!==W.st_nullNode()&&this.m_lists.setField(s,2,t)}this.freeList_(e)}reserveLists(e){this.m_lists.setCapacity(e)}addElement(e,t){this.m_lists.getField(e,0);const s=this.m_lists.getField(e,1),n=this.newNode_();return s!==W.st_nullNode()?(this.m_listNodes.setField(s,1,n),this.m_lists.setField(e,1,n)):(this.m_lists.setField(e,0,n),this.m_lists.setField(e,1,n)),this.m_listNodes.setField(n,0,t),n}reserveNodes(e){this.m_listNodes.setCapacity(e)}deleteElementDirect(e,t,s){t!==W.st_nullNode()?(this.m_listNodes.setField(t,1,this.m_listNodes.getField(s,1)),this.m_lists.getField(e,1)===s&&this.m_lists.setField(e,1,t)):(this.m_lists.setField(e,0,this.m_listNodes.getField(s,1)),this.m_lists.getField(e,1)===s&&this.m_lists.setField(e,1,W.st_nullNode())),this.freeNode_(s)}deleteElementSearch(e,t){let s=-1,n=this.getFirst(e);for(;n!==t;)s=n,n=this.getNext(n);this.deleteElementDirect(e,s,t)}concatenateLists(e,t){const s=this.m_lists.getField(e,1),n=this.m_lists.getField(t,0);if(n!==W.st_nullNode()&&(s!==W.st_nullNode()?(this.m_listNodes.setField(s,1,n),this.m_lists.setField(e,1,this.m_lists.getField(t,1))):(this.m_lists.setField(e,0,n),this.m_lists.setField(e,1,this.m_lists.getField(t,1)))),this.m_bAllowNavigationBetweenLists){const e=this.m_lists.getField(t,2),s=this.m_lists.getField(t,3);e!==W.st_nullNode()?this.m_lists.setField(e,3,s):this.m_listOfLists=s,s!==W.st_nullNode()&&this.m_lists.setField(s,2,e)}return this.freeList_(t),e}getElement(e){return this.m_listNodes.getField(e,0)}getData(e){return this.getElement(e)}setElement(e,t){s.geometryReleaseAssert(0)}getNext(e){return this.m_listNodes.getField(e,1)}getFirst(e){return this.m_lists.getField(e,0)}getFirstElement(e){const t=this.getFirst(e);return this.getElement(t)}static st_nullNode(){return-1}clear(){this.m_listNodes.deleteAll(!0),this.m_lists.deleteAll(!0),this.m_listOfLists=W.st_nullNode()}isEmpty(e){return s.geometryReleaseAssert(0),!1}getNodeCount(){return this.m_listNodes.size()}getListCount(){return this.m_lists.size()}getFirstList(){return this.m_listOfLists}getNextList(e){return this.m_lists.getField(e,3)}}function j(e=-1){return{m_value:e,m_line:new n.Line,m_segment:null,m_segmentInfo:new n.SegmentTypeInfo(-1),m_env:new i.Envelope1D(0,0),m_dxdy:55555555,m_bHorizontal:!1,m_bCurve:!1}}class Z extends r.Comparator{constructor(e,t,s){super(!0),this.m_bIntersectionDetected=!1,this.m_nonSimpleResult=new g.NonSimpleResult,this.m_tempSimpleEdge1=j(),this.m_tempSimpleEdge2=j(),this.m_prev1=n.nullHandle,this.m_prev2=n.nullHandle,this.m_vertex1=n.nullHandle,this.m_vertex2=n.nullHandle,this.m_currentNode=-1,this.m_prevX1=Number.NaN,this.m_prevX2=Number.NaN,this.m_prevY=Number.NaN,this.m_prevX=0,this.m_sweepY=Number.NaN,this.m_sweepX=0,this.m_ptSweep=new i.Point2D,this.m_simpleEdgesCache=[],this.m_simpleEdgesRecycle=[],this.m_cOutstandingConstructedEdges=0,this.m_shape=e,this.m_bShapeHasSegments=this.m_shape.hasCurves(),this.m_tolerance=t,this.m_tolerance10=10*t,this.m_bIsSimple=s;const r=Math.trunc(Math.min(3*e.getTotalPointCount()/2,67)),o=Math.min(7,r);this.m_simpleEdgesCache.length=o}tryGetCachedEdge_(e){const t=this.m_simpleEdgesCache[(e&i.indexTypeMax())%this.m_simpleEdgesCache.length];return t&&t.m_value===e?t:null}tryDeleteCachedEdge_(e){const t=(e&i.indexTypeMax())%this.m_simpleEdgesCache.length,s=this.m_simpleEdgesCache[t];s&&s.m_value===e&&(this.m_simpleEdgesRecycle.push(s),this.m_simpleEdgesCache[t]=null)}tryCreateCachedEdge_(e){const t=(e&i.indexTypeMax())%this.m_simpleEdgesCache.length;let s=this.m_simpleEdgesCache[t];return s?null:(0===this.m_simpleEdgesRecycle.length?(s=j(),this.m_cOutstandingConstructedEdges++):s=this.m_simpleEdgesRecycle.pop(),s.m_value=e,this.m_simpleEdgesCache[t]=s,s)}initSimpleEdge_(e,t){this.m_bShapeHasSegments&&this.initSimpleEdgeHelper_(e,t)||e.m_bCurve||(this.m_shape.queryLineConnector(t,e.m_line,!0),e.m_segment=e.m_line,e.m_env.setCoordsNoNAN(e.m_line.getStartX(),e.m_line.getEndX()),e.m_env.vmax+=this.m_tolerance,e.m_line.orientBottomUp(),e.m_bHorizontal=e.m_line.getEndY()===e.m_line.getStartY(),e.m_bHorizontal||(e.m_dxdy=(e.m_line.getEndX()-e.m_line.getStartX())/(e.m_line.getEndY()-e.m_line.getStartY())))}initSimpleEdgeHelper_(e,t){if(e.m_segment=this.m_shape.getSegment(t),e.m_segmentInfo=this.m_shape.getOriginalSegmentInfo(t),e.m_bCurve=null!==e.m_segment,e.m_bCurve){const t=e.m_segment.clone();return t.orientBottomUp(),e.m_segment=t,e.m_env=e.m_segment.queryInterval(0,0),e.m_env.vmax+=this.m_tolerance,!0}return!1}compareTwoSegments_(e,t){const s=e.getStartXY(),n=e.getEndXY(),r=t.getStartXY(),o=t.getEndXY();if(this.m_ptSweep.setCoords(this.m_sweepX,this.m_sweepY),s.isEqualPoint2D(r)&&this.m_sweepY===s.y){this.m_ptSweep.assign(n.compare(o)<0?n:o);const s=e.intersectionOfYMonotonicWithAxisX(this.m_ptSweep.y,this.m_ptSweep.x),r=t.intersectionOfYMonotonicWithAxisX(this.m_ptSweep.y,this.m_ptSweep.x);if(Math.abs(s-r)>this.m_tolerance)return s<r?-1:1}const a=s.compare(r)<0?r:s,m=n.compare(o)<0?n:o;let l=0,h=0;for(let s=1;s<5;s++){i.lerpPoint2D(a,m,s/5,this.m_ptSweep);const n=e.intersectionOfYMonotonicWithAxisX(this.m_ptSweep.y,this.m_ptSweep.x),r=t.intersectionOfYMonotonicWithAxisX(this.m_ptSweep.y,this.m_ptSweep.x),o=Math.abs(n-r);o>l&&(l=o,h=n<r?-1:1)}return 0===h?this.errorCracking():h}compareNonHorizontal_(e,t){if(e.m_line.getStartY()===t.m_line.getStartY()&&e.m_line.getStartX()===t.m_line.getStartX())return e.m_line.getEndY()===t.m_line.getEndY()&&e.m_line.getEndX()===t.m_line.getEndX()?this.m_bIsSimple?this.errorCoincident():0:this.compareNonHorizontalUpperEnd_(e,t);if(e.m_line.getEndY()===t.m_line.getEndY()&&e.m_line.getEndX()===t.m_line.getEndX())return this.compareNonHorizontalLowerEnd_(e,t);const s=this.compareNonHorizontalLowerEnd_(e,t),n=this.compareNonHorizontalUpperEnd_(e,t);return s<0&&n<0?-1:s>0&&n>0?1:this.errorCracking()}compareHorizontal1Case1_(e,t){if(e.getEndX()>t.getEndX()){if(t.getEndX()>t.getStartX()&&t.getEndY()-t.getStartY()<2*this.m_tolerance&&e.isIntersectingPoint(t.getEndXY(),this.m_tolerance,!0))return this.errorCracking()}else if((t.getEndY()-t.getStartY())/(t.getEndX()-t.getStartX())*(e.getEndX()-e.getStartX())<this.m_tolerance10&&t.isIntersectingPoint(e.getEndXY(),this.m_tolerance,!0))return this.errorCracking();return 1}compareHorizontal1Case2_(e,t){if(e.getStartX()<t.getStartX()){if(t.getEndX()>t.getStartX()&&t.getEndY()-t.getStartY()<2*this.m_tolerance&&e.isIntersectingPoint(t.getEndXY(),this.m_tolerance,!0))return this.errorCracking()}else if((t.getEndY()-t.getStartY())/(t.getEndX()-t.getStartX())*(e.getStartX()-e.getEndX())<this.m_tolerance10&&t.isIntersectingPoint(e.getStartXY(),this.m_tolerance,!0))return this.errorCracking();return-1}compareHorizontal1Case3_(e,t){const s=i.Point2D.getNAN();s.setSub(t.getEndXY(),t.getStartXY()),s.rightPerpendicularThis(),s.normalize();const n=i.Point2D.getNAN();n.setSub(e.getStartXY(),t.getStartXY());const r=i.Point2D.getNAN();r.setSub(e.getEndXY(),t.getStartXY());const o=n.dotProduct(s),a=r.dotProduct(s),m=Math.abs(o),l=Math.abs(a);if(m<l){if(m<this.m_tolerance10&&t.isIntersectingPoint(e.getStartXY(),this.m_tolerance,!0))return this.errorCracking()}else if(l<this.m_tolerance10&&t.isIntersectingPoint(e.getEndXY(),this.m_tolerance,!0))return this.errorCracking();return o<0&&a<0?-1:o>0&&a>0?1:this.errorCracking()}compareHorizontal1_(e,t){return e.getStartY()===t.getStartY()&&e.getStartX()===t.getStartX()?this.compareHorizontal1Case1_(e,t):e.getEndY()===t.getEndY()&&e.getEndX()===t.getEndX()?this.compareHorizontal1Case2_(e,t):this.compareHorizontal1Case3_(e,t)}compareHorizontal2_(e,t){return e.getEndY()===t.getEndY()&&e.getEndX()===t.getEndX()&&e.getStartY()===t.getStartY()&&e.getStartX()===t.getStartX()?this.m_bIsSimple?this.errorCoincident():0:this.errorCracking()}compareNonHorizontalLowerEnd_(e,t){let s=1;if(e.m_line.getStartY()<t.m_line.getStartY()){s=-1;const n=e;e=t,t=n}const n=e.m_line,r=t.m_line,i=n.getStartX()-r.getStartX(),o=t.m_dxdy*(n.getStartY()-r.getStartY()),a=this.m_tolerance10;return i<o-a?-s:i>o+a?s:r.isIntersectingPoint(n.getStartXY(),this.m_tolerance,!0)?this.errorCracking():i<o?-s:s}compareNonHorizontalUpperEnd_(e,t){let s=1;if(t.m_line.getEndY()<e.m_line.getEndY()){s=-1;const n=e;e=t,t=n}const n=e.m_line,r=t.m_line,i=n.getEndX()-r.getStartX(),o=t.m_dxdy*(n.getEndY()-r.getStartY()),a=this.m_tolerance10;return i<o-a?-s:i>o+a?s:r.isIntersectingPoint(n.getEndXY(),this.m_tolerance,!0)?this.errorCracking():i<o?-s:s}errorCoincident(){return this.m_bIntersectionDetected=!0,this.m_nonSimpleResult=new g.NonSimpleResult(7,this.m_vertex1,this.m_vertex2),-1}errorCracking(){if(this.m_bIntersectionDetected=!0,this.m_bIsSimple){const e=6;this.m_nonSimpleResult=new g.NonSimpleResult(e,this.m_vertex1,this.m_vertex2)}else this.m_prev1=n.nullHandle,this.m_prev2=n.nullHandle,this.m_vertex1=n.nullHandle,this.m_vertex2=n.nullHandle;return-1}compareSegments_(e,t,s,r){if(s.m_env.vmax<r.m_env.vmin)return-1;if(r.m_env.vmax<s.m_env.vmin)return 1;if(!s.m_bCurve&&!r.m_bCurve){let e=s.m_bHorizontal?1:0;return e|=r.m_bHorizontal?2:0,0===e?this.compareNonHorizontal_(s,r):1===e?this.compareHorizontal1_(s.m_line,r.m_line):2===e?-1*this.compareHorizontal1_(r.m_line,s.m_line):this.compareHorizontal2_(s.m_line,r.m_line)}if(this.m_bIntersectionDetected)return-1;const i=this.m_prevY===this.m_sweepY&&this.m_prevX===this.m_sweepX;let o,a;if(i&&e===this.m_prev1?o=this.m_prevX1:(o=Number.NaN,this.m_prev1=n.nullHandle),i&&t===this.m_prev2?a=this.m_prevX2:(a=Number.NaN,this.m_prev2=n.nullHandle),this.m_prevY=this.m_sweepY,this.m_prevX=this.m_sweepX,Number.isNaN(o)){this.m_prev1=e;const t=s.m_segment.intersectionOfYMonotonicWithAxisX(this.m_sweepY,this.m_sweepX);o=t,this.m_prevX1=t}if(Number.isNaN(a)){this.m_prev2=t;const e=r.m_segment.intersectionOfYMonotonicWithAxisX(this.m_sweepY,this.m_sweepX);a=e,this.m_prevX2=e}const m=n.isIntersectingEx(!0,!0,s.m_segment,r.m_segment,this.m_tolerance,!0);return 0!==m?2===m?this.m_bIsSimple?this.errorCoincident():s.m_segmentInfo.equals(r.m_segmentInfo)?0:this.errorCracking():this.errorCracking():Math.abs(o-a)<=this.m_tolerance?this.compareTwoSegments_(s.m_segment,r.m_segment):o<a?-1:o>a?1:0}clearIntersectionDetectedFlag(){this.m_bIntersectionDetected=!1}intersectionDetected(){return this.m_bIntersectionDetected}getLastComparedNode(){return this.m_currentNode}getResult(){return this.m_nonSimpleResult}setSweepY(e,t){this.m_sweepY=e,this.m_sweepX=t,this.m_prev1=n.nullHandle,this.m_prev2=n.nullHandle,this.m_vertex1=n.nullHandle,this.m_vertex2=n.nullHandle}compare(e,t,s){if(this.m_bIntersectionDetected)return-1;const n=e.getElement(s),r=t;return this.m_currentNode=s,this.compareSegments(r,r,n,n)}compareSegments(e,t,s,n){let r=this.tryGetCachedEdge_(e);null===r?this.m_vertex1===t?r=this.m_tempSimpleEdge1:(this.m_vertex1=t,r=this.tryCreateCachedEdge_(e),null===r&&(r=this.m_tempSimpleEdge1,this.m_tempSimpleEdge1.m_value=e),this.initSimpleEdge_(r,t)):this.m_vertex1=t;let i=this.tryGetCachedEdge_(s);return null===i?this.m_vertex2===n?i=this.m_tempSimpleEdge2:(this.m_vertex2=n,i=this.tryCreateCachedEdge_(s),null===i&&(i=this.m_tempSimpleEdge2,this.m_tempSimpleEdge2.m_value=s),this.initSimpleEdge_(i,n)):this.m_vertex2=n,this.compareSegments_(t,n,r,i)}onDelete(e){this.tryDeleteCachedEdge_(e)}onSet(e){this.tryDeleteCachedEdge_(e)}onEndSearch(e){this.tryDeleteCachedEdge_(e)}onAddUniqueElementFailed(e){this.tryDeleteCachedEdge_(e)}}class Q{constructor(e,t){this.m_bIntersectionDetected=!1,this.m_pointOfInterest=i.Point2D.getNAN(),this.m_line1=new n.Line,this.m_seg1=null,this.m_env=i.Envelope1D.constructEmpty(),this.m_vertex1=-1,this.m_currentNode=-1,this.m_minDist=Number.MAX_VALUE,this.m_shape=e,this.m_tolerance=t}getCurrentNode(){return this.m_currentNode}clearIntersectionDetectedFlag(){this.m_bIntersectionDetected=!1,this.m_minDist=Number.MAX_VALUE}intersectionDetected(){return this.m_bIntersectionDetected}setPoint(e){this.m_pointOfInterest.assign(e)}compare(e,t){const s=e.getElement(t);return this.compareVertex(e,t,s)}compareVertex(e,s,r){let o,a=this.m_shape.getSegment(r),m=!0;if(null==a)this.m_shape.queryLineConnector(r,this.m_line1,!0),this.m_env.setCoordsNoNAN(this.m_line1.getStartX(),this.m_line1.getEndX()),a=this.m_line1,o=this.m_line1.getStartY()===this.m_line1.getEndY();else{const e=t.Envelope2D.constructEmpty();a.queryLooseEnvelope(e),e.queryIntervalX(this.m_env),o=0===e.height(),m=!1}if(this.m_pointOfInterest.x+this.m_tolerance<this.m_env.vmin)return-1;if(this.m_pointOfInterest.x-this.m_tolerance>this.m_env.vmax)return 1;if(o)return this.m_currentNode=s,this.m_bIntersectionDetected=!0,0;let l=0;if(m){n.orientBottomUp(this.m_line1);const e=this.m_line1.getStartXY(),t=new i.Point2D;t.setSub(this.m_line1.getEndXY(),e),t.rightPerpendicularThis();const s=new i.Point2D;s.setSub(this.m_pointOfInterest,e),l=t.dotProduct(s),l/=t.length()}else l=a.intersectionOfYMonotonicWithAxisX(this.m_pointOfInterest.y,this.m_pointOfInterest.x)-this.m_pointOfInterest.x;return l<10*-this.m_tolerance?-1:l>10*this.m_tolerance?1:(a.isIntersectingPoint(this.m_pointOfInterest,this.m_tolerance)&&(Math.abs(l)<this.m_minDist&&(this.m_currentNode=s,this.m_minDist=l),this.m_bIntersectionDetected=!0),l<0?-1:l>0?1:0)}}class K{constructor(e,t){this.m_lists=new W(!1),this.m_hash=t,this.m_hashBuckets=new Int32Array(e),this.m_hashBuckets.fill(K.st_nullNode()),this.m_bitFilter=new Int32Array(10*e+31>>5)}reserveElements(e){this.m_lists.reserveLists(Math.min(this.m_hashBuckets.length,e)),this.m_lists.reserveNodes(e)}addElement(e,t){void 0===t&&(t=this.m_hash.getHash(e));const s=t%(this.m_bitFilter.length<<5);this.m_bitFilter[s>>5]|=1<<(31&s);const n=t%this.m_hashBuckets.length;let r=this.m_hashBuckets[n];return r===W.st_nullNode()&&(r=this.m_lists.createList(),this.m_hashBuckets[n]=r),this.m_lists.addElement(r,e)}deleteElement(e,t){void 0===t&&(t=this.m_hash.getHash(e));const n=t%this.m_hashBuckets.length,r=this.m_hashBuckets[n];r===W.st_nullNode()&&s.throwInvalidArgumentException("");let i=this.m_lists.getFirst(r),o=W.st_nullNode();for(;i!==W.st_nullNode();){const t=this.m_lists.getData(i),s=this.m_lists.getNext(i);t===e?(this.m_lists.deleteElementDirect(r,o,i),this.m_lists.getFirst(r)===W.st_nullNode()&&(this.m_lists.deleteList(r),this.m_hashBuckets[n]=W.st_nullNode())):o=i,i=s}}getFirstInBucket(e){const t=e%(this.m_bitFilter.length<<5);if(!(this.m_bitFilter[t>>5]&1<<(31&t)))return W.st_nullNode();const s=e%this.m_hashBuckets.length,n=this.m_hashBuckets[s];return n===W.st_nullNode()?W.st_nullNode():this.m_lists.getFirst(n)}getNextInBucket(e){return this.m_lists.getNext(e)}findNode(e){const t=this.m_hash.getHash(e);let s=this.getFirstInBucket(t);for(;s!==W.st_nullNode();){const t=this.m_lists.getData(s);if(this.m_hash.equal(t,e))return s;s=this.m_lists.getNext(s)}return W.st_nullNode()}deleteNode(e){const t=this.getElement(e),n=this.m_hash.getHash(t)%this.m_hashBuckets.length,r=this.m_hashBuckets[n];r===W.st_nullNode()&&s.throwInvalidArgumentException(""),this.m_lists.deleteElementSearch(r,e),this.m_lists.getFirst(r)===W.st_nullNode()&&(this.m_lists.deleteList(r),this.m_hashBuckets[n]=W.st_nullNode())}getElement(e){return this.m_lists.getData(e)}static st_nullNode(){return W.st_nullNode()}clear(){s.geometryReleaseAssert(0)}size(){return this.m_lists.getNodeCount()}dbgPrintBucketHistogram(){}}function $(e,t,s,n,r){const i=new ne(r);return i.m_shape=e,i.m_sqrTolerance=t*t,i.m_cellSize=2*t,i.m_invCellSize=1/i.m_cellSize,i.m_geometry=s,i.m_bTrackChanges=n,i.m_bHasSegmentParentage=e.hasSegmentParentage(),i.clusterNonReciprocal()}function J(e,t,s,n,r){const i=e-s,o=t-n;return i*i+o*o<=r}function ee(e,t,s,n,r,o){const a={pt:new i.Point2D,weight:0,rank:0,bMerged:!1},m=s+r;let l=!1,h=e.x;e.x!==t.x&&(n===o&&(h=(e.x*s+t.x*r)/m),l=!0);let g=e.y;return e.y!==t.y&&(n===o&&(g=(e.y*s+t.y*r)/m),l=!0),n!==o?n>o?(a.rank=n,a.weight=s,a.pt=e):(a.rank=o,a.weight=r,a.pt=t):(a.pt.setCoords(h,g),a.weight=m,a.rank=n),a.bMerged=l,a}function te(e,t){const s=i.hashForClustering(e);return i.hashForClustering2(s,t)}class se{constructor(e,t,s,n,r){this.m_workPt=new i.Point2D,this.m_shape=e,this.m_sqrTolerance=s,this.m_invCellSize=n,this.m_origin=t.clone(),this.m_hashValues=r}getHash(e){return this.m_shape.getUserIndex(e,this.m_hashValues)}calculateHashFromVertex(e){this.m_shape.queryXY(e,this.m_workPt);const t=this.m_workPt.x-this.m_origin.x,s=Math.trunc(t*this.m_invCellSize+.5),n=this.m_workPt.y-this.m_origin.y;return te(s,Math.trunc(n*this.m_invCellSize+.5))}equal(e,t){return s.geometryReleaseAssert(0),!1}}class ne{constructor(e){this.m_origin=i.Point2D.getNAN(),this.m_sqrTolerance=0,this.m_cellSize=0,this.m_invCellSize=0,this.m_geometry=n.nullHandle,this.m_bucketArray=i.makePrimitiveArray(4,Number.NaN),this.m_bucketHash=i.makePrimitiveArray(4,Number.NaN),this.m_dbgCandidateCheckCount=0,this.m_nsr=new g.NonSimpleResult,this.m_hashValues=-1,this.m_newClusters=-1,this.m_bTrackChanges=!1,this.m_bHasSegmentParentage=!1,this.m_shape=null,this.m_clusters=new W,this.m_hashFunction=null,this.m_hashTable=null,this.m_progressCounter=0,this.m_progressTracker=e}progress_(){}collectClusterCandidates(e,t){const s=i.Point2D.getNAN();this.m_shape.queryXY(e,s);const n=(s.x-this.m_origin.x)*this.m_invCellSize,r=(s.y-this.m_origin.y)*this.m_invCellSize,o=Math.trunc(n),a=Math.trunc(r);let m=0;for(let e=0;e<=1;e+=1)for(let t=0;t<=1;t+=1){const s=te(o+e,a+t),n=this.m_hashTable.getFirstInBucket(s);n!==K.st_nullNode()&&(this.m_bucketArray[m]=n,this.m_bucketHash[m]=s,m++)}for(let e=m-1;e>=1;e--){const t=this.m_bucketArray[e];for(let s=e-1;s>=0;s--)if(t===this.m_bucketArray[s]){this.m_bucketHash[s]=-1,m--,e!==m&&(this.m_bucketHash[e]=this.m_bucketHash[m],this.m_bucketArray[e]=this.m_bucketArray[m]);break}}for(let n=0;n<m;n++)this.collectNearestNeighbourCandidates(e,this.m_bucketHash[n],s,this.m_bucketArray[n],t)}collectNearestNeighbourCandidates(e,t,s,n,r){const o=i.Point2D.getNAN();for(let i=n;i!==K.st_nullNode();i=this.m_hashTable.getNextInBucket(i)){const n=this.m_hashTable.getElement(i);e===n||-1!==t&&this.m_shape.getUserIndex(n,this.m_hashValues)!==t||(this.m_shape.queryXY(n,o),J(s.x,s.y,o.x,o.y,this.m_sqrTolerance)&&r.push(i))}}mergeClusters(e,t,s){let n=this.m_shape.getUserIndex(e,this.m_newClusters);const i=this.m_shape.getUserIndex(t,this.m_newClusters);-1===n&&(n=this.m_clusters.createList(),this.m_clusters.addElement(n,e),this.m_shape.setUserIndex(e,this.m_newClusters,n)),-1===i?this.m_clusters.addElement(n,t):this.m_clusters.concatenateLists(n,i),this.m_shape.setUserIndex(t,this.m_newClusters,r.StridedIndexTypeCollection.impossibleIndex2());const o=this.mergeVertices(e,t);if(s){const t=this.m_hashFunction.calculateHashFromVertex(e);this.m_shape.setUserIndex(e,this.m_hashValues,t)}return o}mergeVertices(e,t){const s=i.Point2D.getNAN();this.m_shape.queryXY(e,s);const n=i.Point2D.getNAN();this.m_shape.queryXY(t,n);const r=this.m_shape.getRank(e),o=this.m_shape.getRank(t),a=this.m_shape.getWeight(e),m=this.m_shape.getWeight(t);let l,h,g,u,c=!1;if(r===o?(l=r,h=a+m,g=s.x,s.x!==n.x&&(g=(s.x*a+n.x*m)/h,c=!0),u=s.y,s.y!==n.y&&(u=(s.y*a+n.y*m)/h,c=!0)):(r>o?(g=s.x,u=s.y,h=a,l=r):(g=n.x,u=n.y,h=m,l=o),c=!s.equals(n)),c&&(this.m_shape.setXYMonotonic(e,g,u),this.m_bTrackChanges&&this.m_shape.setGeometryModifiedWithVertex(e,!0),this.m_bHasSegmentParentage)){const s=this.m_shape.getSegmentParentageBreakVertex(e)||this.m_shape.getSegmentParentageBreakVertex(t);this.m_shape.setSegmentParentageBreakVertex(e,s),this.m_shape.setSegmentParentageBreakVertex(t,s)}return this.m_shape.setWeight(e,h),this.m_shape.setRank(e,l),c}needsClustering(){const e={stack:[],error:void 0,hasError:!1};try{o.__addDisposableResource(e,i.makeScopedCall(()=>{this.m_hashTable=null,this.m_hashFunction=null,this.m_shape.removeUserIndex(this.m_hashValues),this.m_shape.removeUserIndex(this.m_newClusters)}),!1);const t=this.m_shape.getSelectedCount(),s=this.m_shape.getEnvelope2D(this.m_progressTracker);this.m_origin.assign(s.getLowerLeft());const a=Math.max(s.height(),s.width())/(i.intMax()-1);this.m_cellSize<a&&(this.m_cellSize=a,this.m_invCellSize=1/this.m_cellSize),this.m_clusters.clear(),this.m_clusters.reserveLists(this.m_shape.getSelectedCount()/3+1),this.m_clusters.reserveNodes(this.m_shape.getSelectedCount()/3+1),this.m_hashValues=this.m_shape.createUserIndex(),this.m_newClusters=this.m_shape.createUserIndex(),this.m_hashFunction=new se(this.m_shape,this.m_origin,this.m_sqrTolerance,this.m_invCellSize,this.m_hashValues),this.m_hashTable=new K(4*t/3,this.m_hashFunction),this.m_hashTable.reserveElements(this.m_shape.getSelectedCount());let m=!1;for(let e=0;e<2;e++){const t=[],s=this.m_shape.queryVertexIteratorOnSelection(this.m_geometry);for(let i=s.next();i!==n.nullHandle;i=s.next()){if(this.progress_(),e>0&&this.m_shape.getUserIndex(i,this.m_newClusters)===r.StridedIndexTypeCollection.impossibleIndex2())continue;let s;if(0===e?(s=this.m_hashFunction.calculateHashFromVertex(i),this.m_shape.setUserIndex(i,this.m_hashValues,s)):s=this.m_shape.getUserIndex(i,this.m_hashValues),this.collectClusterCandidates(i,t),0!==t.length){for(let e=0,s=t.length;e<s;e++){this.progress_();const s=t[e],n=this.m_hashTable.getElement(s);if(this.m_hashTable.deleteNode(s),!this.m_shape.isEqualXY(i,n))return this.m_nsr=new g.NonSimpleResult(5,this.m_shape.getVertexIndex(i),this.m_shape.getVertexIndex(n)),m=!0,m;this.mergeClusters(i,n,!1)}t.length=0}0===e&&this.m_hashTable.addElement(i,s)}}return m}catch(t){e.error=t,e.hasError=!0}finally{o.__disposeResources(e)}}clusterNonReciprocal(){const e=this.m_shape.getSelectedCount(),t=this.m_shape.getEnvelope2D(this.m_progressTracker);this.m_origin=t.getLowerLeft();const s=Math.max(t.height(),t.width())/(i.intMax()-1);this.m_cellSize<s&&(this.m_cellSize=s,this.m_invCellSize=1/this.m_cellSize),this.m_clusters.clear(),this.m_clusters.reserveLists(Math.trunc(this.m_shape.getSelectedCount()/3+1)),this.m_clusters.reserveNodes(Math.trunc(this.m_shape.getSelectedCount()/3+1)),this.m_hashValues=this.m_shape.createUserIndex(),this.m_newClusters=this.m_shape.createUserIndex(),this.m_hashFunction=new se(this.m_shape,this.m_origin,this.m_sqrTolerance,this.m_invCellSize,this.m_hashValues),this.m_hashTable=new K(Math.trunc(4*e/3),this.m_hashFunction),this.m_hashTable.reserveElements(this.m_shape.getSelectedCount());let o=!1;{const e=this.m_shape.queryVertexIteratorOnSelection(this.m_geometry);for(let t=e.next();t!==n.nullHandle;t=e.next()){this.progress_();const e=this.m_hashFunction.calculateHashFromVertex(t);this.m_shape.setUserIndex(t,this.m_hashValues,e),this.m_hashTable.addElement(t,e)}}{const e=[],t=this.m_shape.queryVertexIteratorOnSelection(this.m_geometry);for(let s=t.next();s!==n.nullHandle;s=t.next()){if(this.m_shape.getUserIndex(s,this.m_newClusters)===r.StridedIndexTypeCollection.impossibleIndex2())continue;let t=this.m_shape.getUserIndex(s,this.m_hashValues);this.m_hashTable.deleteElement(s,t);let n=!1;for(;this.collectClusterCandidates(s,e),0!==e.length;){let t=0;for(let n=0,r=e.length;n<r;n++){this.progress_();const i=e[n],o=this.m_hashTable.getElement(i);this.m_hashTable.deleteNode(i);const a=n+1===r;t|=this.mergeClusters(s,o,a)?1:0}if(n||=0!==t,o||=0!==t,e.length=0,!t)break}n&&(t=this.m_shape.getUserIndex(s,this.m_hashValues)),this.m_hashTable.addElement(s,t)}e.length=0}return o&&this.applyClusterPositions_(),this.m_hashTable=null,this.m_hashFunction=null,this.m_shape.removeUserIndex(this.m_hashValues),this.m_shape.removeUserIndex(this.m_newClusters),o}applyClusterPositions_(){const e=i.Point2D.getNAN();for(let t=this.m_clusters.getFirstList();t!==W.st_nullNode();t=this.m_clusters.getNextList(t)){let s=this.m_clusters.getFirst(t);const n=this.m_clusters.getElement(s);this.m_shape.queryXY(n,e);const r=this.m_shape.getRank(n),i=this.m_shape.getWeight(n);for(s=this.m_clusters.getNext(s);s!==W.st_nullNode();s=this.m_clusters.getNext(s)){const t=this.m_clusters.getElement(s);if(this.m_bTrackChanges?this.m_shape.isEqualXYPoint2D(t,e)||(this.m_shape.setXYMonotonicPoint2D(t,e),this.m_shape.setGeometryModifiedWithVertex(t,!0)):this.m_shape.setXYMonotonicPoint2D(t,e),this.m_bHasSegmentParentage){const e=this.m_shape.getSegmentParentageBreakVertex(n)||this.m_shape.getSegmentParentageBreakVertex(t);this.m_shape.setSegmentParentageBreakVertex(n,e),this.m_shape.setSegmentParentageBreakVertex(t,e)}this.m_shape.setWeight(t,i),this.m_shape.setRank(t,r)}}}}class re{constructor(){this.m_inputParts=[],this.m_resultParts1=[],this.m_resultParts2=[],this.m_resultSegments=[],this.m_freeSegments=[],this.m_inputSegments=[],this.m_param1=[],this.m_param2=[],this.m_tolerance=0,this.m_toleranceZ=0,this.m_point=new r.Point,this.m_pointWeight=1,this.m_maxDensifyLimit=0,this.m_pointRank=0,this.m_changed1=!1,this.m_changed2=!1,this.m_adaptiveDensify=!1}clear(){this.freeAllResultSegments(),this.m_inputSegments.length=0,this.m_inputParts.length=0,this.m_resultParts1.length=0,this.m_resultParts2.length=0,this.m_param1.length=0,this.m_param2.length=0,this.m_adaptiveDensify=!1,this.m_changed1=!1,this.m_changed2=!1}newIntersectionPart_(e,t,s,n,r,i,o,a,m,l){return function(e,t,s,n,r,i,o,a,m,l){return{segmentIndex:e,weightStart:t,rankStart:s,weightEnd:n,rankEnd:r,weightInterior:i,rankInterior:o,segmentParentage:l,u:ie(a,m)}}(e,t,s,n,r,i,o,a,m,l)}pushSegment(e,t,s,n,r,i,o,a,m,l){return this.m_inputParts.push(this.newIntersectionPart_(this.m_inputSegments.length,t,s,n,r,i,o,a,m,l)),this.m_inputSegments.push(e),this.m_inputParts.length-1}getResultSegmentCount(e){return this.m_adaptiveDensify?0===e?this.m_param1.length-1:this.m_param2.length-1:0===e?this.m_resultParts1.length:this.m_resultParts2.length}getResultPart_(e,t){return 0===e?this.m_resultParts1[t]:this.m_resultParts2[t]}getResultSegment(e,t){return this.m_resultSegments[this.getResultPart_(e,t).segmentIndex].get()}getSegmentChanged(e){return 0===e?this.m_changed1:this.m_changed2}getResultSegmentStartPointWeight(e,t){return this.getResultPart_(e,t).weightStart}getResultSegmentStartPointRank(e,t){return this.getResultPart_(e,t).rankStart}getResultSegmentSegmentParentage(e,t){return this.getResultPart_(e,t).segmentParentage}getResultSegmentStartPointIsBreak(e,t){return this.getResultPart_(e,t).u.bBreakStart}getResultSegmentEndPointWeight(e,t){return this.getResultPart_(e,t).weightEnd}getResultSegmentEndPointRank(e,t){return this.getResultPart_(e,t).rankEnd}getResultSegmentEndPointIsBreak(e,t){return this.getResultPart_(e,t).u.bBreakEnd}getResultSegmentInteriorRank(e,t){return this.getResultPart_(e,t).rankInterior}getResultSegmentInteriorWeight(e,t){return this.getResultPart_(e,t).weightInterior}getResultPoint(){return this.m_point}getResultPointWeight(){return this.m_pointWeight}getResultPointRank(){return this.m_pointRank}getResultPointChanged(){return this.m_changed2}intersectLines(e,t){2!==this.m_inputSegments.length&&s.throwInternalErrorException(""),this.m_changed1=!1,this.m_changed2=!1,this.m_tolerance=e;const r=i.sqr(e*re.c_smallToleranceFactor);let o=!1;const a=this.m_inputParts[0],m=this.m_inputParts[1],l=this.m_inputSegments[a.segmentIndex],h=this.m_inputSegments[m.segmentIndex];if(t||5&n.isIntersecting(!0,l,h,e,!0)){const t=n.intersect(!0,l,h,null,this.m_param1,this.m_param2,e);0===t&&s.throwInternalErrorException("");const g=new Array(t);for(let e=0;e<t;++e)g[e]=i.Point2D.getNAN();const u=new Float64Array(t),c=new Int32Array(t),p=new Array(t),d=new Array(t);for(let e=0;e<t;++e)p[e]=oe(),d[e]=oe();for(let e=0;e<t;e++){const t=this.m_param1[e],s=this.m_param2[e];let n,_=a.rankInterior,f=a.weightInterior;0===t?(_=a.rankStart,f=a.weightStart,n=a.u.bBreakStart):1===t?(_=a.rankEnd,f=a.weightEnd,n=a.u.bBreakEnd):(this.m_changed1=!0,n=!1);let y,x=m.rankInterior,P=m.weightInterior;0===s?(x=m.rankStart,P=m.weightStart,y=m.u.bBreakStart):1===s?(x=m.rankEnd,P=m.weightEnd,y=m.u.bBreakEnd):(this.m_changed2=!0,y=!1);const E=_,S=x;let C=1,I=0,v=i.Point2D.getNAN();if(E===S){const n=l.getCoord2D(t),o=h.getCoord2D(s);C=f+P;const a=P/C;I=_,i.lerpPoint2D(n,o,a,v);const m=i.Point2D.sqrDistance(v,n),g=i.Point2D.sqrDistance(v,o);p[e].bBigMove=m>r,d[e].bBigMove=g>r,this.m_changed1||n.equals(v)||(this.m_changed1=!0),this.m_changed2||o.equals(v)||(this.m_changed2=!0)}else if(E>S){v=l.getCoord2D(t);const n=h.getCoord2D(s);C=f,I=_;const o=i.Point2D.sqrDistance(v,n);p[e].bBigMove=!1,d[e].bBigMove=o>r,this.m_changed2||n.equals(v)||(this.m_changed2=!0)}else{v=h.getCoord2D(s),C=P,I=x;const n=l.getCoord2D(t),o=i.Point2D.sqrDistance(v,n);p[e].bBigMove=o>r,d[e].bBigMove=!1,this.m_changed1||n.equals(v)||(this.m_changed1=!0)}g[e].assign(v),u[e]=C,c[e]=I,p[e].bIsBreak=n||y,d[e].bIsBreak=n||y,o||=p[e].bBigMove||d[e].bBigMove}const _=a.rankInterior,f=a.weightInterior;let y=0,x=-1;for(let s=0;s<=t;s++){const n=s<t?this.m_param1[s]:1;if(n!==y){const r=this.allocResultSegment(),o=this.m_resultSegments[r];let m,h,d,P;l.queryCut(y,n,o,!1),o.get().snapControlPoints(e*e);let E=!1,S=!1,C=!1,I=!1,v=!1,T=i.Point2D.getNAN(),D=i.Point2D.getNAN();-1!==x?(h=c[x],m=u[x],E=p[x].bBigMove,T.assign(g[x]),C=p[x].bIsBreak,v=!0):(m=a.weightStart,h=a.rankStart,T=o.get().getStartXY(),C=a.u.bBreakStart),s<t?(P=c[s],d=u[s],S=p[s].bBigMove,D.assign(g[s]),I=p[s].bIsBreak,v=!0):(d=a.weightEnd,P=a.rankEnd,D=o.get().getEndXY(),I=a.u.bBreakEnd),v&&o.get().setCoordsForIntersector(T,D,!0),this.m_resultParts1.push(this.newIntersectionPart_(r,m,h,d,P,f,_,C,I,a.segmentParentage));const w=this.m_resultParts1.at(-1);w.u.bBigMoveStart=E,w.u.bBigMoveEnd=S,y=n,x=s}else-1===x&&(x=s)}const P=i.makePrimitiveArray(t,0);for(let e=0;e<t;e++)P[e]=e;t>2?(P.sort((e,t)=>this.m_param2[e]<this.m_param2[t]?-1:this.m_param2[e]>this.m_param2[t]?1:0),i.numericSort(this.m_param2)):2===t&&this.m_param2[0]>this.m_param2[1]&&(this.m_param2[1]=i.swap(this.m_param2[0],this.m_param2[0]=this.m_param2[1]),P[1]=i.swap(P[0],P[0]=P[1]));const E=m.rankInterior,S=m.weightInterior;y=0,x=-1;for(let s=0;s<=t;s++){const n=s<t?this.m_param2[s]:1;if(n!==y){const r=this.allocResultSegment(),o=this.m_resultSegments[r];let a,l,p,_;h.queryCut(y,n,o,!1),o.get().snapControlPoints(e*e);let f=i.Point2D.getNAN(),C=i.Point2D.getNAN(),I=!1,v=!1,T=!1,D=!1,w=!1;if(-1!==x){const e=P[x];a=u[e],l=c[e],f.assign(g[e]),T=d[e].bBigMove,I=d[e].bIsBreak,w=!0}else a=m.weightStart,l=m.rankStart,f=o.get().getStartXY(),I=m.u.bBreakStart;if(s!==t){const e=P[s];p=u[e],_=c[e],C.assign(g[e]),D=d[e].bBigMove,v=d[e].bIsBreak,w=!0}else p=m.weightEnd,_=m.rankEnd,C=o.get().getEndXY(),v=m.u.bBreakEnd;w&&o.get().setCoordsForIntersector(f,C,!0),this.m_resultParts2.push(this.newIntersectionPart_(r,a,l,p,_,S,E,I,v,m.segmentParentage));const b=this.m_resultParts2.at(-1);b.u.bBigMoveStart=T,b.u.bBigMoveEnd=D,y=n,x=s}else-1===x&&(x=s)}return o?3:2}return 0}intersectLines3D(e,t,n,r){return s.geometryReleaseAssert(0),1}intersect2D(e,t){const n=this.m_inputParts[0],r=this.m_inputParts[1],i=this.m_inputSegments[n.segmentIndex].getGeometryType(),o=this.m_inputSegments[r.segmentIndex].getGeometryType();return i!==s.GeometryType.enumLine||o!==s.GeometryType.enumLine?new he(this).intersectCurves(e,t):this.intersectLines(e,t)}intersect2DEx(e,t,n,r,o){this.m_point.assignCopy(t),1!==this.m_inputSegments.length&&s.throwInternalErrorException(""),this.m_tolerance=e,this.m_changed1=!1,this.m_changed2=!1;const a=i.sqr(e*re.c_smallToleranceFactor);let m=!1;const l=this.m_inputParts[0],h=this.m_inputSegments[l.segmentIndex];if(o||h.isIntersectingPoint(t.getXY(),e,!0)){this.m_param1=i.makePrimitiveArray(16,Number.NaN);const s=h.getClosestCoordinate(t.getXY(),!1);this.m_param1[0]=s;let o=l.rankInterior,g=l.weightInterior;0===s?(o=l.rankStart,g=l.weightStart):1===s?(o=l.rankEnd,g=l.weightEnd):this.m_changed1=!0;let u=o;const c=n,p=r;u===c&&h.isCurve()&&(u=c+1);let d=1,_=0;const f=new i.Point2D;if(u===c){const e=h.getCoord2D(s),n=t.getXY();d=g+p,_=o;const r=p/d;i.lerpPoint2D(e,n,r,f),this.m_changed1||e.equals(f)||(this.m_changed1=!0),this.m_changed2||n.equals(f)||(this.m_changed2=!0),m=i.Point2D.sqrDistance(f,e)>a}else u>c?(f.assign(h.getCoord2D(s)),d=g,_=o,this.m_changed2||f.equals(t.getXY())||(this.m_changed2=!0)):(f.assign(h.getCoord2D(s)),d=p,_=c,this.m_changed1||f.equals(t.getXY())||(this.m_changed1=!0),m=i.Point2D.sqrDistance(f,t.getXY())>a);let y=0,x=-1;const P=1;for(let t=0;t<=P;t++){const s=t<P?this.m_param1[0]:1;if(s!==y){const n=this.allocResultSegment(),r=this.m_resultSegments[n];h.queryCut(y,s,r),r.get().snapControlPoints(e*e);let i=l.weightStart,o=l.weightEnd,a=l.rankStart,m=l.rankEnd;const g=l.rankInterior,u=l.weightInterior;let c=l.u.bBreakStart,p=l.u.bBreakEnd;-1!==x&&(i=d,a=_,c=!0,r.get().setCoordsForIntersector(f,r.get().getEndXY(),!0)),t!==P&&(o=d,m=_,p=!0,r.get().setCoordsForIntersector(r.get().getStartXY(),f,!0)),y=s,this.m_resultParts1.push(this.newIntersectionPart_(n,i,a,o,m,u,g,c,p,l.segmentParentage))}x=t}return this.m_point.setXY(f),this.m_pointWeight=d,this.m_pointRank=_,m?3:2}return 0}intersect3D(e,t,n,r){return s.geometryReleaseAssert(0),1}intersect3DEx(e,t,n,r,i,o,a){return s.geometryReleaseAssert(0),1}getTolerance(){return this.m_tolerance}freeAllResultSegments(){this.m_resultSegments.length=0,this.m_freeSegments.length=0}freeResultSegment(e){this.m_freeSegments.push(e)}allocResultSegment(){if(this.m_freeSegments.length)return this.m_freeSegments.pop();const e=new n.SegmentBuffer,t=this.m_resultSegments.length;return this.m_resultSegments.push(e),t}allocResultSegmentFromBuffer(e){if(this.m_freeSegments.length)return this.m_freeSegments.pop();const t=new n.SegmentBuffer({copy:e}),s=this.m_resultSegments.length;return this.m_resultSegments.push(t),s}allocResultSegmentFromSegment(e){if(this.m_freeSegments.length)return this.m_freeSegments.pop();const t=new n.SegmentBuffer({segment:e}),s=this.m_resultSegments.length;return this.m_resultSegments.push(t),s}}function ie(e,t){return{bBigMoveStart:!1,bBigMoveEnd:!1,bBreakStart:e,bBreakEnd:t}}function oe(){return{bBigMove:!1,bIsBreak:!1}}re.maxWeight=.1*Number.MAX_VALUE,re.c_smallToleranceFactor=.01,re.c_maxGeometryTypeToRankDelta=8;let ae=class{constructor(){this.start=null,this.end=null,this.equalEdge=null,this.segmentIndex=-1,this.segmentParentage=-1,this.weight=0,this.rank=0}hasSegment(){return this.segmentIndex>=0}transferAttributes(e,t,s){if(1===t.getDescription().getAttributeCount())return;const n=e.parent.m_resultSegments[this.segmentIndex].get().getStartXY(),i=e.parent.m_resultSegments[this.segmentIndex].get().getEndXY(),o=new r.Point;t.queryStart(o),s?(o.setXY(n),e.parent.m_resultSegments[this.segmentIndex].get().setStart(o)):(o.setXY(i),e.parent.m_resultSegments[this.segmentIndex].get().setEnd(o)),t.queryEnd(o),s?(o.setXY(i),e.parent.m_resultSegments[this.segmentIndex].get().setEnd(o)):(o.setXY(n),e.parent.m_resultSegments[this.segmentIndex].get().setStart(o))}copyFromWhenOverlap(e,t,s){this.equalEdge=t,t.equalEdge=this,this.segmentIndex=e.parent.allocResultSegmentFromBuffer(e.parent.m_resultSegments[t.segmentIndex]),this.segmentParentage=t.segmentParentage,this.weight=t.weight,this.rank=t.rank,s?(this.start.copyFrom(t.start),this.end.copyFrom(t.end)):(this.start.copyFrom(t.end),this.end.copyFrom(t.start),e.parent.m_resultSegments[this.segmentIndex].get().reverse())}getEnd(){return this.end}getNextInChain(){return this.end.nextInChain}getPrevInChain(){return this.start.prevInChain}};class me{constructor(){this.hash=0,this.pt=new i.Point2D,this.prevInChain=null,this.nextInChain=null,this.prevInHash=null,this.nextInHash=null,this.prevEqual=null,this.nextEqual=null,this.weight=0,this.rank=0,this.bBigMove=!1,this.bIsBreak=!1}copyFrom(e){this.pt.assign(e.pt),this.weight=e.weight,this.rank=e.rank,this.bBigMove=e.bBigMove,this.bIsBreak=e.bIsBreak}nextNode(){return this.nextInChain?this.nextInChain.end:null}prevNode(){return this.prevInChain?this.prevInChain.start:null}equalListHead(){let e=this;for(;null!==e.prevEqual;e=e.prevEqual);return e}}function le(e,t,s,n){return{edge1:e,edge2:t,recursion:s,bIsIntersecting:n}}class he{constructor(e){this.m_pairs=[],this.m_chainOrigin1=null,this.m_chainOrigin2=null,this.m_newNodes=[],this.m_hashTableOfEquals=[],this.m_hashTableOfEqualsSize=0,this.m_origin=new i.Point2D,this.m_cell=new i.Point2D,this.parent=e}addSegment(e,t,n,r,i,o,a,m,l,h,g){const u=this.newNode(this.parent.m_resultSegments[e].get().getStartXY(),n,r,l),c=this.newNode(this.parent.m_resultSegments[e].get().getEndXY(),i,o,h);this.newEdge(u,c,e,a,m,g),null===this.m_chainOrigin1?this.m_chainOrigin1=u:null===this.m_chainOrigin2?this.m_chainOrigin2=u:s.geometryReleaseAssert(0)}intersectCurvesHelper(e,t,r,o,a){const m=this.getSegment(e).get(),l=this.getSegment(t).get();if(m.isDegenerate(0)||l.isDegenerate(0))return 0;const h=this.tryOverlapIntersectCurves(e,t,r,o);if(0!==h)return h;const g=i.sqr(.01*r);let u=!1,c=this.processSharpCorners(m,l,r,a>4);const p=c>0;if(!p){const e=!0;if(!(o||5&n.isIntersectingEx(!0,!1,m,l,r,e)))return 0;c=n.intersect(!0,m,l,null,this.parent.m_param1,this.parent.m_param2,r)}0===c&&s.throwInternalErrorException("");const d=m.getGeometryType(),_=l.getGeometryType(),f=i.makeObjectArray(i.Point2D,c),y=i.makeObjectArray(i.Point2D,c),x=i.makePrimitiveArray(c,Number.NaN),P=i.makePrimitiveArray(c,Number.NaN),E=i.makePrimitiveArray(c,Number.NaN),S=i.makePrimitiveArray(c,Number.NaN),C=i.makeStructArray(oe,c),I=i.makeStructArray(oe,c);let v=!1,T=!1;for(let s=0;s<c;s++){const n=this.parent.m_param1[s],o=this.parent.m_param2[s];let a=e.rank,h=e.weight,c=!0,D=!1;0===n?(a=e.start.rank,h=e.start.weight,D=e.start.bIsBreak):1===n?(a=e.end.rank,h=e.end.weight,D=e.end.bIsBreak):(v=!0,c=!1);let w=t.rank,b=t.weight,G=!1,N=!0;0===o?(w=t.start.rank,b=t.start.weight,G=t.start.bIsBreak):1===o?(w=t.end.rank,b=t.end.weight,G=t.end.bIsBreak):(T=!0,N=!1);let H=a,A=w;if(H===A&&(H*=re.c_maxGeometryTypeToRankDelta,A*=re.c_maxGeometryTypeToRankDelta,H+=ge(d,m,!1),A+=ge(_,l,!1)),c&&N&&A===H){const e=m.getCoord2D(n),t=l.getCoord2D(o);e.equals(t)&&(A=H-1)}let F=1,V=0,R=1,k=0;const M=new i.Point2D,U=new i.Point2D,O=m.getCoord2D(n),B=l.getCoord2D(o);if(p&&i.Point2D.distance(O,B)>r)M.setCoordsPoint2D(O),U.setCoordsPoint2D(B),F=h,R=b,V=a,k=w,C[s].bBigMove=!1,I[s].bBigMove=!1,D=!0,G=!0;else if(H===A){R=F=h+b,k=V=a;const e=b/F;i.lerpPoint2D(O,B,e,M),U.setCoordsPoint2D(M);const t=i.Point2D.sqrDistance(M,O),n=i.Point2D.sqrDistance(M,B);C[s].bBigMove=t>g,I[s].bBigMove=n>g,v||O.equals(M)||(v=!0),T||B.equals(U)||(T=!0)}else if(H>A){M.setCoordsPoint2D(O),U.setCoordsPoint2D(M),R=F=h,k=V=a;const e=i.Point2D.sqrDistance(M,B);C[s].bBigMove=!1,I[s].bBigMove=e>g,T||B.equals(U)||(T=!0)}else{U.setCoordsPoint2D(B),M.setCoordsPoint2D(U),R=F=b,k=V=w;const e=i.Point2D.sqrDistance(M,O);C[s].bBigMove=e>g,I[s].bBigMove=!1,v||O.equals(M)||(v=!0)}f[s].assign(M),y[s].assign(U),x[s]=F,P[s]=R,E[s]=V,S[s]=k,C[s].bIsBreak=D||G,I[s].bIsBreak=D||G,u||=C[s].bBigMove||I[s].bBigMove,s>0&&(n!==this.parent.m_param1[s-1]&&o!==this.parent.m_param2[s-1]||(E[s]<=E[s-1]?(f[s].assign(y[s-1]),x[s]=P[s-1],E[s]=S[s-1],y[s].assign(y[s-1]),P[s]=P[s-1],S[s]=S[s-1],C[s].bBigMove||=C[s-1].bBigMove,I[s].bBigMove||=I[s-1].bBigMove,C[s].bIsBreak||=C[s-1].bIsBreak,I[s].bIsBreak||=I[s-1].bIsBreak):(f[s-1].assign(f[s]),x[s-1]=x[s],E[s-1]=E[s],y[s-1].assign(y[s]),P[s-1]=P[s],S[s-1]=S[s],C[s-1].bBigMove||=C[s].bBigMove,I[s-1].bBigMove||=I[s].bBigMove,C[s-1].bIsBreak||=C[s].bIsBreak,I[s-1].bIsBreak||=I[s].bIsBreak)))}if(!(v||T||2!==c||d===s.GeometryType.enumLine&&_===s.GeometryType.enumLine)){if(this.processDoublyConnectedEdges(e,t,a+1,r))return this.parent.m_changed1=!0,this.parent.m_changed2=!0,2;s.geometryReleaseAssert(0)}this.parent.m_changed1||=v,this.parent.m_changed2||=T;let D=e,w=e.end.weight,b=e.end.rank,G=e.end.bBigMove,N=e.end.bIsBreak,H=0,A=-1;for(let t=0;t<=c;t++){const s=t<c?this.parent.m_param1[t]:1;if(s!==H){const n=this.parent.allocResultSegment(),o=this.parent.m_resultSegments[n];let a,l,h,g;m.queryCut(H,s,o,!1),o.get().snapControlPoints(r*r);let u=!1,p=!1,d=!1,_=!1;const y=new i.Point2D,P=new i.Point2D;-1!==A?(l=E[A],a=x[A],d=C[A].bBigMove,u=C[A].bIsBreak,y.assign(f[A])):(a=e.start.weight,l=e.start.rank,d=e.start.bBigMove,u=e.start.bIsBreak,y.assign(o.get().getStartXY())),t<c?(g=E[t],h=x[t],_=C[t].bBigMove,p=C[t].bIsBreak,P.assign(f[t])):(h=w,g=b,_=G,p=N,P.assign(o.get().getEndXY()));let S=D;s<1&&(this.splitEdgeInPlace(D),S=D.getNextInChain()),this.updateSegmentOnly(D,n),0===D.start.hash||D.start.pt.equals(y)||(this.m_newNodes.push(D.start),this.removeNodeFromHash(D.start),D.start.hash=0),0===D.end.hash||D.end.pt.equals(P)||(this.m_newNodes.push(D.end),this.removeNodeFromHash(D.end),D.end.hash=0),D.start.pt.assign(y),D.end.pt.assign(P),D.start.bBigMove||=d,D.end.bBigMove||=_,D.start.bIsBreak||=u,D.end.bIsBreak||=p,D.start.weight=a,D.start.rank=l,D.end.weight=h,D.end.rank=g,D=S,H=s,A=t}else-1===A&&(A=t)}const F=D.getNextInChain(),V=[];V.length=c;for(let e=0;e<c;e++)V[e]=e;c>2?(V.sort((e,t)=>i.standardNumericCompare(this.parent.m_param2[e],this.parent.m_param2[t])),this.parent.m_param2.sort(i.standardNumericCompare)):2===c&&this.parent.m_param2[0]>this.parent.m_param2[1]&&(this.parent.m_param2[1]=i.swap(this.parent.m_param2[0],this.parent.m_param2[0]=this.parent.m_param2[1]),V[1]=i.swap(V[0],V[0]=V[1])),D=t,w=t.end.weight,b=t.end.rank,G=t.end.bBigMove,N=t.end.bIsBreak,H=0,A=-1;for(let e=0;e<=c;e++){const s=e<c?this.parent.m_param2[e]:1;if(s!==H){const n=this.parent.allocResultSegment(),o=this.parent.m_resultSegments[n];let a,m,h,g;l.queryCut(H,s,o,!1),o.get().snapControlPoints(r*r);const u=new i.Point2D,p=new i.Point2D;let d=!1,_=!1,f=!1,x=!1;if(-1!==A){const e=V[A];a=P[e],m=S[e],u.assign(y[e]),f=I[e].bBigMove,d=I[e].bIsBreak}else a=t.start.weight,m=t.start.rank,f=t.start.bBigMove,d=t.start.bIsBreak,u.assign(o.get().getStartXY());if(e!==c){const t=V[e];h=P[t],g=S[t],p.assign(y[t]),x=I[t].bBigMove,_=I[t].bIsBreak}else h=w,g=b,x=G,_=N,p.assign(o.get().getEndXY());let E=D;s<1&&(this.splitEdgeInPlace(D),E=D.getNextInChain()),this.updateSegmentOnly(D,n),0===D.start.hash||D.start.pt.equals(u)||(this.m_newNodes.push(D.start),this.removeNodeFromHash(D.start),D.start.hash=0),0===D.end.hash||D.end.pt.equals(p)||(this.m_newNodes.push(D.end),this.removeNodeFromHash(D.end),D.end.hash=0),D.start.pt.assign(u),D.end.pt.assign(p),D.start.bBigMove||=f,D.end.bBigMove||=x,D.start.bIsBreak||=d,D.end.bIsBreak||=_,D.start.weight=a,D.start.rank=m,D.end.weight=h,D.end.rank=g,D=E,H=s,A=e}else-1===A&&(A=e)}const R=D.getNextInChain();return this.postProcessResultPartsForCurves(e,F,t,R,a+1),u?3:2}intersectCurves(e,n){2!==this.parent.m_inputSegments.length&&s.throwInternalErrorException(""),this.parent.m_changed1=!1,this.parent.m_changed2=!1,this.parent.m_tolerance=e,this.m_hashTableOfEqualsSize=0,this.m_hashTableOfEquals=i.makeNullArray(16);const r=t.Envelope2D.constructEmpty();for(let e=0;e<2;e++){const s=this.parent.allocResultSegmentFromSegment(this.parent.m_inputSegments[this.parent.m_inputParts[e].segmentIndex]),n=t.Envelope2D.constructEmpty();this.parent.m_inputSegments[this.parent.m_inputParts[e].segmentIndex].queryLooseEnvelope(n),r.mergeEnvelope2D(n);const i=this.parent.m_inputParts[e];this.addSegment(s,0,i.weightStart,i.rankStart,i.weightEnd,i.rankEnd,i.weightInterior,i.rankInterior,i.u.bBreakStart,i.u.bBreakEnd,i.segmentParentage)}r.inflateCoords(100*e,100*e),this.m_origin.assign(r.getLowerLeft()),this.m_cell.setCoords(2*e,2*e),this.m_pairs.push(le(this.m_chainOrigin1.nextInChain,this.m_chainOrigin2.nextInChain,0,n));let o=0,a=!0;for(;this.m_pairs.length;){const t=this.m_pairs.at(-1);this.m_pairs.pop(),s.geometryReleaseAssert(t.recursion>=0),s.geometryReleaseAssert(t.recursion<=256),this.clusterNodes(e);const n=this.intersectCurvesHelper(t.edge1,t.edge2,e,t.bIsIntersecting,t.recursion);a&&(a=!1,o=n)}for(let e=0;e<2;e++){const t=0===e?this.parent.m_resultParts1:this.parent.m_resultParts2;for(let s=(0===e?this.m_chainOrigin1:this.m_chainOrigin2).nextInChain;null!=s;s=s.getNextInChain())t.push(this.parent.newIntersectionPart_(s.segmentIndex,s.start.weight,s.start.rank,s.end.weight,s.end.rank,s.weight,s.rank,s.start.bIsBreak,s.end.bIsBreak,s.segmentParentage)),t.at(-1).u.bBigMoveStart=s.start.bBigMove,t.at(-1).u.bBigMoveEnd=s.end.bBigMove}return o}tryOverlapIntersectCurves(e,t,r,o){const a=this.parent.m_resultSegments[e.segmentIndex].get(),m=this.parent.m_resultSegments[t.segmentIndex].get(),l=a.getStartXY().equals(m.getStartXY())&&a.getEndXY().equals(m.getEndXY()),h=a.getStartXY().equals(m.getEndXY())&&a.getEndXY().equals(m.getStartXY());if(!l&&!h)return 0;const g=n.isExactOverlap2d(a,m,!0);if(0!==g&&n.isIdenticalType(a,m)&&e.segmentParentage===t.segmentParentage){let e=!1;if(g>0)e=a.equals(m);else{s.geometryReleaseAssert(-1===g);const t=new n.SegmentBuffer({segment:m});t.get().reverse(),e=a.equals(t.get())}if(e)return 1}const u=r*re.c_smallToleranceFactor;let c=!1;if(0===g){const e=[.5,.25,.75,.125,.375,.625,.875,.5625,.3125];for(let t=0,s=e.length;t<s;++t){const s=e[t],n=new i.Point2D;a.queryCoord2D(s,n);const o=m.getClosestCoordinate(n,!1),l=new i.Point2D;m.queryCoord2D(o,l);const h=i.Point2D.distance(n,l);if(h>r)return 0;c||=h>u}for(let t=0,s=e.length;t<s;++t){const s=e[t],n=new i.Point2D;m.queryCoord2D(s,n);const o=a.getClosestCoordinate(n,!1),l=new i.Point2D;a.queryCoord2D(o,l);const h=i.Point2D.distance(n,l);if(h>r)return 0;c||=h>u}}let p=e.rank,d=t.rank;return p===d&&(p*=re.c_maxGeometryTypeToRankDelta,d*=re.c_maxGeometryTypeToRankDelta,p+=ge(a.getGeometryType(),a,!0),d+=ge(m.getGeometryType(),m,!0)),p>d?(t.copyFromWhenOverlap(this,e,l),t.transferAttributes(this,a,l)):d>p?(e.copyFromWhenOverlap(this,t,l),e.transferAttributes(this,m,l)):e.segmentParentage<=t.segmentParentage?(e.weight=e.weight+t.weight,t.copyFromWhenOverlap(this,e,l),t.transferAttributes(this,a,l)):(t.weight=e.weight+t.weight,e.copyFromWhenOverlap(this,t,l),e.transferAttributes(this,m,l)),c?3:2}postProcessResultPartsForCurves(e,t,n,r,o){o===i.shortMax()&&s.throwInternalErrorException("curve_helper");for(let s=e;s!==t;s=s.getNextInChain())this.updateSegmentToNodes(s);for(let e=n;e!==r;e=e.getNextInChain())this.updateSegmentToNodes(e);for(let a=e;a!==t;a=a.getNextInChain()){const e=a.end.pt.sub(a.start.pt);for(let t=n;t!==r;t=t.getNextInChain()){let n=0;if(a.start.pt.equals(t.start.pt)&&a.end.pt.equals(t.end.pt)?n=1:a.start.pt.equals(t.end.pt)&&a.end.pt.equals(t.start.pt)&&(n=-1),!n){let n=a.start.pt.equals(t.start.pt)?1:0;if(n||(n=a.end.pt.equals(t.end.pt)?2:0,n||(n=a.end.pt.equals(t.start.pt)?3:0,n||(n=a.start.pt.equals(t.end.pt)?4:0))),n){const r=t.end.pt.sub(t.start.pt),i=e.dotProduct(r);let m;switch(n){case 1:case 2:m=i>0;break;case 3:case 4:m=i<0;break;default:s.throwInternalErrorException("post_process_result_parts_for_curves_")}m&&this.m_pairs.push(le(a,t,o,!1))}continue}const r=this.parent.m_resultSegments[a.segmentIndex],m=this.parent.m_resultSegments[t.segmentIndex],l=[.5,.25,.75];for(let e=0,t=l.length;e<t;++e){const t=l[e],s=new i.Point2D;r.get().queryCoord2D(t,s);const o=m.get().getClosestCoordinate(s,!1),a=new i.Point2D;if(m.get().queryCoord2D(o,a),i.Point2D.distance(s,a)>this.parent.m_tolerance){n=0;break}}if(!n){this.m_pairs.push(le(a,t,o,!1));continue}for(let e=0,t=l.length;e<t;++e){const t=l[e],s=new i.Point2D;m.get().queryCoord2D(t,s);const o=r.get().getClosestCoordinate(s,!1),a=new i.Point2D;if(r.get().queryCoord2D(o,a),i.Point2D.distance(s,a)>this.parent.m_tolerance){n=0;break}}if(!n){this.m_pairs.push(le(a,t,o,!1));continue}a.equalEdge=t,t.equalEdge=a;let h=a.rank,g=t.rank;h===g&&(h*=re.c_maxGeometryTypeToRankDelta,g*=re.c_maxGeometryTypeToRankDelta,h+=ge(r.get().getGeometryType(),r.get(),!0),g+=ge(m.get().getGeometryType(),m.get(),!0)),h>g||h===g&&a.segmentParentage<=t.segmentParentage?(r.copyTo(m,!1),t.segmentParentage=a.segmentParentage,-1===n&&m.get().reverse()):(m.copyTo(r,!1),a.segmentParentage=t.segmentParentage,-1===n&&r.get().reverse());break}}this.updateAttachedEdgesAfterNodeChange(e.start),t&&this.updateAttachedEdgesAfterNodeChange(t.start),this.updateAttachedEdgesAfterNodeChange(n.start),r&&this.updateAttachedEdgesAfterNodeChange(r.start)}processDoublyConnectedEdges(e,t,r,o){r===i.shortMax()&&s.throwInternalErrorException("curve_helper");const a=this.getSegment(e).get(),m=this.getSegment(t).get(),l=a.getStartXY().equals(m.getStartXY())&&a.getEndXY().equals(m.getEndXY())?1:a.getEndXY().equals(m.getStartXY())&&a.getStartXY().equals(m.getEndXY())?-1:0;if(0!==l){const s=new n.SegmentBuffer;a.queryCut(0,.5,s),s.get().snapControlPoints(o*o);const i=new n.SegmentBuffer;a.queryCut(.5,1,i),i.get().snapControlPoints(o*o),this.splitEdgeInPlace(e),e.end.pt=s.get().getEndXY(),e.segmentIndex=this.parent.allocResultSegmentFromBuffer(s),e.getNextInChain().segmentIndex=this.parent.allocResultSegmentFromBuffer(i);let h=m.getClosestCoordinate(e.end.pt,!1);return Math.abs(h-.5)>.2&&(h=.5),m.queryCut(0,h,s),s.get().snapControlPoints(o*o),m.queryCut(h,1,i),i.get().snapControlPoints(o*o),this.splitEdgeInPlace(t),t.end.pt=s.get().getEndXY(),t.segmentIndex=this.parent.allocResultSegmentFromBuffer(s),t.getNextInChain().segmentIndex=this.parent.allocResultSegmentFromBuffer(i),l>0?(this.m_pairs.push(le(e,t,r,!1)),this.m_pairs.push(le(e.getNextInChain(),t.getNextInChain(),r,!1))):(this.m_pairs.push(le(e,t.getNextInChain(),r,!1)),this.m_pairs.push(le(e.getNextInChain(),t,r,!1))),!0}return!1}newNode(e,t,s,n){const r=new me;return this.m_newNodes.push(r),r.pt=e,r.rank=s,r.weight=t,r.bIsBreak=n,r}newEdge(e,t,s,n,r,i){const o=new ae;return o.start=e,o.end=t,e.nextInChain=o,t.prevInChain=o,o.segmentIndex=s,o.segmentParentage=i,o.rank=r,o.weight=n,o}splitEdgeInPlace(e){e.segmentIndex=-1;const t=new ae,s=new me;this.m_newNodes.push(s),s.pt.setNAN(),s.nextInChain=t,s.prevInChain=e,s.prevInHash=null,s.nextInHash=null,s.prevEqual=null,s.nextEqual=null,s.weight=e.weight,s.rank=e.rank,s.bIsBreak=!1,s.bBigMove=!1,t.start=s,t.segmentIndex=-1,t.end=e.end,t.end.prevInChain=t,t.rank=e.rank,t.weight=e.weight,t.segmentParentage=e.segmentParentage,e.end=s,e.equalEdge&&(e.equalEdge.equalEdge=null),e.equalEdge=null}updateSegmentOnly(e,t){e.segmentIndex=t}updateAttachedEdgesAfterNodeChange(e){for(let t=e.equalListHead();null!==t;t=t.nextEqual)this.updateAttachedEdgesAfterNodeChangeImpl(t)}updateAttachedEdgesAfterNodeChangeImpl(e){const t=e.prevInChain;if(t&&t.hasSegment()){const s=this.getSegment(t).get();e.pt.equals(s.getEndXY())||(s.setCoordsForIntersector(t.start.pt,t.end.pt,!1),s.ensureXYMonotone())}const s=e.nextInChain;if(s&&s.hasSegment()){const t=this.getSegment(s).get();e.pt.equals(t.getStartXY())||(t.setCoordsForIntersector(s.start.pt,s.end.pt,!1),t.ensureXYMonotone())}}updateSegmentToNodes(e){const t=this.getSegment(e).get();e.start.pt.equals(t.getStartXY())&&e.end.pt.equals(t.getEndXY())||(t.setCoordsForIntersector(e.start.pt,e.end.pt,!1),t.ensureXYMonotone()),this.updateAttachedEdgesAfterNodeChange(e.start),this.updateAttachedEdgesAfterNodeChange(e.end)}getSegment(e){return this.parent.m_resultSegments[e.segmentIndex]}clusterNodes(e){let t=!1;const s=[],n=[],r=[];for(let e=0,t=this.m_newNodes.length;e<t;e++){const s=this.m_newNodes[e];if(null===s)continue;let n=s;for(let r=e+1;r<t;r++){const e=this.m_newNodes[r];null!==e&&s.pt.equals(e.pt)&&(n.nextInHash=e,e.prevInHash=n,n=e,this.m_newNodes[r]=null)}}for(let o=0,a=this.m_newNodes.length;o<a;o++){const a=this.m_newNodes[o];if(null==a)continue;for(a.hash=this.calculateHash(a.pt);;){const o=i.makeNullArray(4),m=this.hashTableBinsToCheck(a,o);for(let t=0;t<m;t++)if(null!==o[t])for(let m=o[t];null!==m;){const t=m.nextInHash;i.Point2D.distance(a.pt,m.pt)<=e&&(s.push(m),this.removeNodeFromHash(m),m.hash=0,r.push(m),n.push(m)),m=t}let l=!1;for(const e of s)if(!a.pt.equals(e.pt)){const s=ee(a.pt,e.pt,a.weight,a.rank,e.weight,e.rank);a.pt.assign(s.pt),a.weight=s.weight,a.rank=s.rank,l=!0,t=!0}if(s.length=0,!l)break;a.hash=this.calculateHash(a.pt)}r.push(a),n.push(a);for(let e=a.nextInHash;null!==e;){e.prevInHash=null;const t=e.nextInHash;e.nextInHash=null,r.push(e),n.push(e),e=t}const m=a.hash;let l=null,h=null;for(const e of n)a!==e&&(e.hash=m,e.pt.assign(a.pt),e.rank=a.rank,e.weight=a.weight),e.prevInHash=l,l&&(l.nextInHash=e),e.prevEqual=h,e.nextEqual=null,h&&(h.nextEqual=e),h=e,l=e;const g=m%this.m_hashTableOfEquals.length;l.nextInHash=this.m_hashTableOfEquals[g],null!==this.m_hashTableOfEquals[g]&&(this.m_hashTableOfEquals[g].prevInHash=l),this.m_hashTableOfEquals[g]=n[0],this.m_hashTableOfEqualsSize+=n.length,n.length=0,this.rehashIfNeeded()}if(this.m_newNodes.length=0,t)for(const e of r)this.updateAttachedEdgesAfterNodeChange(e)}rehashIfNeeded(){if(2*this.m_hashTableOfEqualsSize>this.m_hashTableOfEquals.length){const e=this.m_hashTableOfEquals;this.m_hashTableOfEquals=i.makeNullArray(2*e.length),this.m_hashTableOfEqualsSize=0;for(const t of e){let e=t;for(;e;){const t=e.nextInHash;e.nextInHash=null,e.prevInHash=null,this.addNodeToHashImpl(e),e=t}}}}addNodeToHashImpl(e){const t=e.hash%this.m_hashTableOfEquals.length,s=this.m_hashTableOfEquals[t];e.nextInHash=s,null!==s&&(s.prevInHash=e),this.m_hashTableOfEquals[t]=e,this.m_hashTableOfEqualsSize++}removeNodeFromHash(e){const t=e.hash%this.m_hashTableOfEquals.length,s=e.prevInHash,n=e.nextInHash;s?s.nextInHash=n:this.m_hashTableOfEquals[t]=n,n&&(n.prevInHash=s),this.m_hashTableOfEqualsSize--,e.prevInHash=null,e.nextInHash=null}hashTableBinsToCheck(e,t){const s=(e.pt.x-this.m_origin.x)/this.m_cell.x,n=(e.pt.y-this.m_origin.y)/this.m_cell.y,r=i.intMax()-1,o=Math.round(i.snap(s,-2147483646,r)),a=Math.round(i.snap(n,-2147483646,r));let m=o|a<<32;m=i.hashInt32(m),t[0]=this.m_hashTableOfEquals[m%this.m_hashTableOfEquals.length];let l=o+1|a<<32;l=i.hashInt32(l);let h=1;t[1]=this.m_hashTableOfEquals[l%this.m_hashTableOfEquals.length],t[1]!==t[0]&&(h=2);let g=o+1|a+1<<32;g=i.hashInt32(g),t[h]=this.m_hashTableOfEquals[g%this.m_hashTableOfEquals.length];for(let e=0;e<h;e++)if(t[h]===t[e]){h--;break}h++;let u=o|a+1<<32;u=i.hashInt32(u),t[h]=this.m_hashTableOfEquals[u%this.m_hashTableOfEquals.length];for(let e=0;e<h;e++)if(t[h]===t[e]){h--;break}return h++,h}calculateHash(e){const t=(e.x-this.m_origin.x)/this.m_cell.x,s=(e.y-this.m_origin.y)/this.m_cell.y,n=i.intMax()-1;let r=Math.round(i.snap(t,-2147483646,n))|Math.round(i.snap(s,-2147483646,n))<<32;return r=i.hashInt32(r),0===r&&(r=1),r}processSharpCorners(e,t,s,r){if(this.parent.m_param1.length=0,this.parent.m_param2.length=0,e.getStartXY().equals(t.getStartXY())){const i=[0,0],o=[0,0],a=n.checkSharpCorner(e,t,0,0,s,2,i,o,r);if(a){this.parent.m_param1.push(0),this.parent.m_param2.push(0);for(let e=0;e<a;e++)this.parent.m_param1.push(i[e]),this.parent.m_param2.push(o[e]);return a+1}}if(e.getEndXY().equals(t.getEndXY())){const i=[0,0],o=[0,0],a=n.checkSharpCorner(e,t,1,1,s,2,i,o,r);if(a){for(let e=0;e<a;e++)this.parent.m_param1.push(i[e]),this.parent.m_param2.push(o[e]);return this.parent.m_param1.push(1),this.parent.m_param2.push(1),a+1}}if(e.getStartXY().equals(t.getEndXY())){const i=[0,0],o=[0,0],a=n.checkSharpCorner(e,t,0,1,s,2,i,o,r);if(a){this.parent.m_param1.push(0),this.parent.m_param2.push(1);for(let e=0;e<a;e++)this.parent.m_param1.push(i[e]),this.parent.m_param2.push(o[e]);return a+1}}if(e.getEndXY().equals(t.getStartXY())){const i=[0,0],o=[0,0],a=n.checkSharpCorner(e,t,1,0,s,2,i,o,r);if(a){for(let e=0;e<a;e++)this.parent.m_param1.push(i[e]),this.parent.m_param2.push(o[e]);return this.parent.m_param1.push(1),this.parent.m_param2.push(0),a+1}}return 0}}function ge(e,t,n){let r=0;switch(e){case s.GeometryType.enumLine:r=0;break;case s.GeometryType.enumBezier:r=2;break;case s.GeometryType.enumRationalBezier2:r=3;break;case s.GeometryType.enumBezier2:r=1;break;case s.GeometryType.enumEllipticArc:r=0===t.projectionBehavior()?5:4;break;default:s.throwInternalErrorException("")}return n?5-r:r}class ue extends Z{constructor(e){super(e.m_shape,e.m_tolerance,!1),this.m_parent=e}compare(e,t,s){if(this.m_bIntersectionDetected)return-1;const n=e.getElement(s),r=this.m_parent.getEdgeOriginVertices(t),i=this.m_parent.m_edgeVertices.getFirstElement(r),o=this.m_parent.getEdgeOriginVertices(n),a=this.m_parent.m_edgeVertices.getFirstElement(o);return this.m_currentNode=s,this.compareSegments(t,i,n,a)}}class ce extends Q{constructor(e){super(e.m_shape,e.m_tolerance),this.m_parent=e}compare(e,t){if(this.m_bIntersectionDetected)return-1;const s=e.getElement(t),n=this.m_parent.getEdgeOriginVertices(s),r=this.m_parent.m_edgeVertices.getFirstElement(n);return this.m_currentNode=t,this.compareVertex(e,t,r)}}class pe extends r.Comparator{constructor(e){super(),this.pt1=i.Point2D.getNAN(),this.pt2=i.Point2D.getNAN(),this.m_shape=e}compare(e,t,s){this.m_shape.queryXY(t,this.pt1);const n=e.getElement(s);return this.m_shape.queryXY(n,this.pt2),this.pt1.compare(this.pt2)}}class de{constructor(e){this.m_point=i.Point2D.getNAN(),this.m_pt=i.Point2D.getNAN(),this.m_shape=e}setPoint(e){this.m_point.setCoordsPoint2D(e)}compare(e,t){const s=e.getElement(t);return this.m_shape.queryXY(s,this.m_pt),this.m_point.compare(this.m_pt)}}class _e{constructor(e,t){this.m_shape=null,this.m_progressTracker=null,this.m_edges=new r.StridedIndexTypeCollection(8),this.m_clusters=new r.StridedIndexTypeCollection(5),this.m_clusterVertices=new W(!1),this.m_edgeVertices=new W(!1),this.m_helperPoint=new r.Point,this.m_eventQ=new r.Treap,this.m_sweepStructure=new r.Treap,this.m_bComplications=!1,this.m_sweepComparator=null,this.m_tempEdgeBuffer=[],this.m_modifiedClusters=[],this.m_edgesToInsertInSweepStructure=[],this.m_prevNeighbour=-1,this.m_nextNeighbour=-1,this.m_bContinuingSegmentChainOptimization=!1,this.m_progressCounter=0,this.m_segmentIntersector=new re,this.m_segBuf1=new n.SegmentBuffer,this.m_segBuf2=new n.SegmentBuffer,this.m_sweepPoint=new i.Point2D(0,0),this.m_tolerance=0,this.m_toleranceSqr=0,this.m_sweepPointCluster=-1,this.m_vertexClusterIndex=-1,this.m_bCracked=!1,this.m_bSweepPointClusterWasModified=!1,this.m_progressTracker=e,this.m_bTrackChanges=t}hadComplications(){return this.m_bComplications}sweep(e,t){const s=new a.Transformation2D;s.setSwapCoordinates(),e.applyTransformation(s),this.setEditShape_(e),this.m_bCracked=!1,this.m_tolerance=t,this.m_toleranceSqr=t*t;let n=this.sweepImpl_();return e.applyTransformation(s),n||(this.fillEventQueuePass2(),n=this.sweepImpl_()||n),this.m_shape.removeUserIndex(this.m_vertexClusterIndex),this.m_shape=null,this.m_bCracked}sweepVertical(e,t){this.setEditShape_(e),this.m_bCracked=!1,this.m_tolerance=t,this.m_toleranceSqr=t*t,this.m_bComplications=!1;let s=this.sweepImpl_();if(!this.m_bComplications){const r=e.filterClosePoints(t,!0,!1,this.m_bTrackChanges,n.nullHandle);this.m_bComplications=1===r,s||=1===r}return-1!==this.m_vertexClusterIndex&&(this.m_shape.removeUserIndex(this.m_vertexClusterIndex),this.m_vertexClusterIndex=-1),this.m_shape=null,s}getEdgeCluster(e,t){return this.m_edges.getField(e,0+t)}setEdgeCluster_(e,t,s){this.m_edges.setField(e,0+t,s)}getEdgeOriginVertices(e){return this.m_edges.getField(e,2)}setEdgeOriginVertices_(e,t){this.m_edges.setField(e,2,t)}getNextEdgeEx(e,t){return this.m_edges.getField(e,3+t)}setNextEdgeEx_(e,t,s){this.m_edges.setField(e,3+t,s)}getEdgeSweepNode(e){return this.m_edges.getField(e,7)}setEdgeSweepNode_(e,t){this.m_edges.setField(e,7,t)}getNextEdge(e,t){const s=this.getEdgeEnd(e,t);return this.m_edges.getField(e,3+s)}setNextEdge_(e,t,s){const n=this.getEdgeEnd(e,t);this.m_edges.setField(e,3+n,s)}getPrevEdge(e,t){const s=this.getEdgeEnd(e,t);return this.m_edges.getField(e,5+s)}setPrevEdge_(e,t,s){const n=this.getEdgeEnd(e,t);this.m_edges.setField(e,5+n,s)}getClusterVertices(e){return this.m_clusters.getField(e,0)}setClusterVertices_(e,t){this.m_clusters.setField(e,0,t)}getClusterSweepEdgeList(e){return this.m_clusters.getField(e,2)}setClusterSweepEdgeList_(e,t){this.m_clusters.setField(e,2,t)}getClusterFirstEdge(e){return this.m_clusters.getField(e,1)}setClusterFirstEdge_(e,t){this.m_clusters.setField(e,1,t)}getClusterEventQNode(e){return this.m_clusters.getField(e,3)}setClusterEventQNode_(e,t){this.m_clusters.setField(e,3,t)}newCluster_(e){const t=this.m_clusters.newElement(),s=this.m_clusterVertices.createList();return this.setClusterVertices_(t,s),e!==n.nullHandle&&(this.m_clusterVertices.addElement(s,e),this.m_shape.setUserIndex(e,this.m_vertexClusterIndex,t)),t}deleteCluster_(e){this.m_clusters.deleteElement(e)}addVertexToCluster_(e,t){const s=this.getClusterVertices(e);this.m_clusterVertices.addElement(s,t),this.m_shape.setUserIndex(t,this.m_vertexClusterIndex,e)}newEdge_(e){const t=this.m_edges.newElement(),s=this.m_edgeVertices.createList();return this.setEdgeOriginVertices_(t,s),-1!==e&&this.m_edgeVertices.addElement(s,e),t}addVertexToEdge_(e,t){const s=this.getEdgeOriginVertices(e);this.m_edgeVertices.addElement(s,t)}deleteEdge_(e){this.m_edges.deleteElement(e);const t=this.m_edgesToInsertInSweepStructure.findIndex(t=>t===e);t>=0&&i.unorderedPop(this.m_edgesToInsertInSweepStructure,t)}addEdgeToCluster(e,t){-1===this.getEdgeCluster(e,0)?this.setEdgeCluster_(e,0,t):-1===this.getEdgeCluster(e,1)?this.setEdgeCluster_(e,1,t):s.throwInternalErrorException(""),this.addEdgeToClusterImpl_(e,t)}addEdgeToClusterImpl_(e,t){const s=this.getClusterFirstEdge(t);if(-1!==s){const n=this.getNextEdge(s,t);this.setPrevEdge_(n,t,e),this.setNextEdge_(e,t,n),this.setNextEdge_(s,t,e),this.setPrevEdge_(e,t,s)}else this.setPrevEdge_(e,t,e),this.setNextEdge_(e,t,e),this.setClusterFirstEdge_(t,e)}getEdgeEnd(e,t){return this.getEdgeCluster(e,0)===t?0:1}mergeClusters_(e,t){this.dbgCheckCluster_(e),this.dbgCheckCluster_(t);const s=this.getClusterEventQNode(t);-1!==s&&(this.m_eventQ.deleteNode(s),this.setClusterEventQNode_(t,-1));let n=this.getClusterFirstEdge(e),r=this.getClusterFirstEdge(t);if(-1!==r){let s=r,i=r,o=!1;do{this.dbgCheckEdge_(s),o=!1;const n=this.getEdgeEnd(s,t),a=this.getNextEdgeEx(s,n);if(this.getEdgeCluster(s,n+1&1)===e){this.disconnectEdge_(s);const e=this.getEdgeOriginVertices(s);if(this.m_edgeVertices.deleteList(e),this.deleteEdge_(s),s===a){r=-1;break}r===s&&(r=this.getClusterFirstEdge(t),i=a,o=!0)}s=a}while(s!==i||o);if(-1!==r){do{const n=this.getEdgeEnd(s,t),r=this.getNextEdgeEx(s,n);this.setEdgeCluster_(s,n,e),s=r}while(s!==i);if(n=this.getClusterFirstEdge(e),-1!==n){const t=this.getNextEdge(n,e),s=this.getNextEdge(r,e);t===n?(this.setClusterFirstEdge_(e,r),this.addEdgeToClusterImpl_(n,e),this.setClusterFirstEdge_(e,n)):s===r&&this.addEdgeToClusterImpl_(r,e),this.setNextEdge_(r,e,t),this.setPrevEdge_(t,e,r),this.setNextEdge_(n,e,s),this.setPrevEdge_(s,e,n)}else this.setClusterFirstEdge_(e,r)}}const i=this.getClusterVertices(e),o=this.getClusterVertices(t);for(let t=this.m_clusterVertices.getFirst(o);-1!==t;t=this.m_clusterVertices.getNext(t)){const s=this.m_clusterVertices.getElement(t);this.m_shape.setUserIndex(s,this.m_vertexClusterIndex,e)}this.m_clusterVertices.concatenateLists(i,o),this.deleteCluster_(t),this.dbgCheckCluster_(e)}mergeEdges_(e,t){this.dbgCheckEdge_(e),this.dbgCheckEdge_(t);const s=this.getEdgeCluster(e,0),n=this.getEdgeCluster(e,1),r=this.getEdgeCluster(t,0),i=this.getEdgeCluster(t,1),o=this.getEdgeOriginVertices(e),a=this.getEdgeOriginVertices(t);if(this.m_edgeVertices.concatenateLists(o,a),t===this.getClusterFirstEdge(s)&&this.setClusterFirstEdge_(s,e),t===this.getClusterFirstEdge(n)&&this.setClusterFirstEdge_(n,e),this.disconnectEdge_(t),this.deleteEdge_(t),!(s===r&&n===i||n===r&&s===i)){const e=this.getClusterXY(s),t=this.getClusterXY(r);e.isEqualPoint2D(t)?(s!==r&&this.mergeClusters_(s,r),n!==i&&this.mergeClusters_(n,i)):(n!==r&&this.mergeClusters_(n,r),s!==i&&this.mergeClusters_(s,i))}this.dbgCheckEdge_(e)}disconnectEdge_(e){const t=this.getEdgeCluster(e,0),s=this.getEdgeCluster(e,1);this.disconnectEdgeFromCluster_(e,t),this.disconnectEdgeFromCluster_(e,s)}disconnectEdgeFromCluster_(e,t){const s=this.getNextEdge(e,t),n=this.getPrevEdge(e,t),r=this.getClusterFirstEdge(t);s!==e?(this.setNextEdge_(n,t,s),this.setPrevEdge_(s,t,n),r===e&&this.setClusterFirstEdge_(t,s)):this.setClusterFirstEdge_(t,-1)}applyIntersectorToEditShape_(e,t,s){let n=this.m_edgeVertices.getFirst(e);const r=this.m_edgeVertices.getElement(n),i=this.getClusterFromVertex(r),o=this.m_shape.getNextVertex(r),a=this.getClusterFromVertex(o),m=this.m_shape.getXY(r),l=this.m_shape.getXY(o);let h=!1,g=!1;const u=t.getResultSegment(s,0).getStartXY(),c=t.getResultSegment(s,t.getResultSegmentCount(s)-1).getEndXY();m.equals(u)||(h=!0),l.equals(c)||(g=!0),this.m_shape.splitSegmentWithIntersector(r,t,s,!0,!0);const p=this.m_bTrackChanges&&t.getSegmentChanged(s);for(p&&this.m_shape.setGeometryModifiedWithVertex(r,!0),n=this.m_edgeVertices.getNext(n);-1!==n;n=this.m_edgeVertices.getNext(n)){const e=this.m_edgeVertices.getElement(n),r=this.getClusterFromVertex(e)===i;this.m_shape.splitSegmentWithIntersector(e,t,s,r,!0),p&&this.m_shape.setGeometryModifiedWithVertex(e,!0)}if(h&&this.updateClusterXY(!0,i,u,t.getResultSegmentStartPointWeight(s,0),t.getResultSegmentStartPointRank(s,0)),g){const e=t.getResultSegmentCount(s)-1;this.updateClusterXY(!0,a,c,t.getResultSegmentEndPointWeight(s,e),t.getResultSegmentEndPointRank(s,e))}}createEdgesAndClustersFromSplitEdge_(e,t,s){this.dbgCheckNewEdgesArray_();const n=this.getEdgeOriginVertices(e),i=this.getEdgeCluster(e,0),o=this.getEdgeCluster(e,1);let a=this.newEdge_(-1);this.m_edgesToInsertInSweepStructure.push(a);const m=r.StridedIndexTypeCollection.impossibleIndex3();this.setEdgeSweepNode_(a,m),this.m_tempEdgeBuffer.push(a),this.addEdgeToCluster(a,i);const l=t.getResultSegmentCount(s);for(let e=1;e<l;e++){const e=this.newCluster_(-1);this.m_modifiedClusters.push(e),this.m_tempEdgeBuffer.push(e),this.addEdgeToCluster(a,e);const t=this.newEdge_(-1);this.m_edgesToInsertInSweepStructure.push(t),this.setEdgeSweepNode_(t,m),this.m_tempEdgeBuffer.push(t),this.addEdgeToCluster(t,e),a=t}this.addEdgeToCluster(a,o);for(let e=this.m_edgeVertices.getFirst(n);-1!==e;e=this.m_edgeVertices.getNext(e)){let t=this.m_edgeVertices.getElement(e);if(this.getClusterFromVertex(t)===i){let e=0;const s=this.m_tempEdgeBuffer.length;do{if(e>0){const s=this.m_tempEdgeBuffer[e-1];this.addVertexToCluster_(s,t)}const s=this.m_tempEdgeBuffer[e];e+=2,this.addVertexToEdge_(s,t),t=this.m_shape.getNextVertex(t)}while(e<s)}else{let e=this.m_tempEdgeBuffer.length-1;do{if(e<this.m_tempEdgeBuffer.length-2){const s=this.m_tempEdgeBuffer[e+1];this.addVertexToCluster_(s,t)}const s=this.m_tempEdgeBuffer[e];e-=2,this.addVertexToEdge_(s,t),t=this.m_shape.getNextVertex(t)}while(e>=0)}}this.m_tempEdgeBuffer.length=0,this.dbgCheckNewEdgesArray_()}getVertexFromClusterIndex(e){const t=this.getClusterVertices(e);return this.m_clusterVertices.getFirstElement(t)}getClusterFromVertex(e){return this.m_shape.getUserIndex(e,this.m_vertexClusterIndex)}processSplitHelper1_(e,t,s){const n=this.getEdgeCluster(t,0),i=this.getClusterXY(n),o=this.getEdgeCluster(t,1),a=this.getClusterXY(o),m=s.getResultSegmentCount(e);let l=s.getResultSegment(e,0);const h=l.getStartXY();if(i.isEqualPoint2D(h)||(this.m_bComplications||i.compare(this.m_sweepPoint)*h.compare(this.m_sweepPoint)<0&&(this.m_bComplications=!0),this.getAffectedEdges(n,this.m_tempEdgeBuffer),this.m_modifiedClusters.push(n)),!this.m_bComplications&&m>1){const e=i.compare(a),t=l.getEndXY();(i.compare(t)!==e||t.compare(a)!==e||t.compare(this.m_sweepPoint)<0)&&(this.m_bComplications=!0)}l=s.getResultSegment(e,m-1);const g=l.getEndXY();a.isEqualPoint2D(g)||(this.m_bComplications||a.compare(this.m_sweepPoint)*g.compare(this.m_sweepPoint)<0&&(this.m_bComplications=!0),this.getAffectedEdges(o,this.m_tempEdgeBuffer),this.m_modifiedClusters.push(o)),this.m_tempEdgeBuffer.push(t);for(let e=0,s=this.m_tempEdgeBuffer.length;e<s;e++){const s=this.m_tempEdgeBuffer[e],n=this.getEdgeSweepNode(s);r.StridedIndexTypeCollection.isValidElement(n)&&(this.m_sweepStructure.deleteNode(n),this.setEdgeSweepNode_(s,-1));const i=r.StridedIndexTypeCollection.impossibleIndex3();s!==t&&this.getEdgeSweepNode(s)!==i&&(this.m_edgesToInsertInSweepStructure.push(s),this.setEdgeSweepNode_(s,i))}this.m_tempEdgeBuffer.length=0}checkAndFixIntersection_(e,t){const s=this.m_sweepStructure.getElement(e);return this.m_sweepComparator.compare(this.m_sweepStructure,s,t),!!this.m_sweepComparator.intersectionDetected()&&(this.m_sweepComparator.clearIntersectionDetectedFlag(),this.fixIntersection_(e,t),!0)}fixIntersection_(e,t){this.m_bCracked=!0;const s=this.m_sweepStructure.getElement(e),n=this.m_sweepStructure.getElement(t);let r=null,i=null;const o=this.getEdgeOriginVertices(s),a=this.m_edgeVertices.getFirstElement(o),m=this.getEdgeOriginVertices(n),l=this.m_edgeVertices.getFirstElement(m);this.m_shape.querySegment(a,this.m_segBuf1,!1,!1),r=this.m_segBuf1.get();const h=this.m_shape.getNextVertex(a),g=this.m_shape.getWeight(a),u=this.m_shape.getSegmentParentageBreakVertex(a),c=this.m_shape.getWeight(h),p=this.m_shape.getSegmentParentageBreakVertex(h),d=this.m_shape.getSegmentWeight(a),_=this.m_shape.getRank(a),f=this.m_shape.getRank(h),y=this.m_shape.getSegmentRank(a),x=this.m_shape.getSegmentParentage(a);this.m_shape.querySegment(l,this.m_segBuf2,!1,!1),i=this.m_segBuf2.get();const P=this.m_shape.getNextVertex(l),E=this.m_shape.getWeight(l),S=this.m_shape.getSegmentParentageBreakVertex(l),C=this.m_shape.getWeight(P),I=this.m_shape.getSegmentParentageBreakVertex(P),v=this.m_shape.getSegmentWeight(l),T=this.m_shape.getRank(l),D=this.m_shape.getRank(P),w=this.m_shape.getSegmentRank(l),b=this.m_shape.getSegmentParentage(l);this.m_segmentIntersector.pushSegment(r,g,_,c,f,d,y,u,p,x),this.m_segmentIntersector.pushSegment(i,E,T,C,D,v,w,S,I,b),3===this.m_segmentIntersector.intersect2D(this.m_tolerance,!0)&&(this.m_bComplications=!0),this.splitEdge_(s,n,-1,this.m_segmentIntersector),this.m_segmentIntersector.clear()}fixIntersectionPointSegment_(e,t){this.m_bCracked=!0;const s=this.m_sweepStructure.getElement(t);let n=null;const r=this.getEdgeOriginVertices(s),i=this.m_edgeVertices.getFirstElement(r);this.m_shape.querySegment(i,this.m_segBuf1,!1,!1),n=this.m_segBuf1.get();const o=this.m_shape.getNextVertex(i),a=this.m_shape.getWeight(i),m=this.m_shape.getSegmentParentageBreakVertex(i),l=this.m_shape.getWeight(o),h=this.m_shape.getSegmentParentageBreakVertex(o),g=this.m_shape.getSegmentWeight(i),u=this.m_shape.getRank(i),c=this.m_shape.getRank(o),p=this.m_shape.getSegmentRank(i),d=this.m_shape.getSegmentParentage(i),_=this.getClusterFirstVertex(e);this.m_segmentIntersector.pushSegment(n,a,u,l,c,g,p,m,h,d),this.m_shape.queryPoint(_,this.m_helperPoint);const f=this.m_shape.getWeight(_),y=this.m_shape.getRank(_);this.m_segmentIntersector.intersect2DEx(this.m_tolerance,this.m_helperPoint,y,f,!0),this.splitEdge_(s,-1,e,this.m_segmentIntersector),this.m_segmentIntersector.clear()}insertNewEdges_(){if(0===this.m_edgesToInsertInSweepStructure.length)return!0;this.dbgCheckNewEdgesArray_();let e=!0,t=0;const s=this.m_edgesToInsertInSweepStructure.length,n=Math.max(2*s+200,this.m_sweepStructure.size()+200);for(;this.m_edgesToInsertInSweepStructure.length;){if(this.m_edgesToInsertInSweepStructure.length>Math.max(100,this.m_shape.getTotalPointCount())||t>n){this.m_edgesToInsertInSweepStructure.length=0,this.m_bComplications=!0,e=!1;break}const s=this.m_edgesToInsertInSweepStructure.at(-1);this.m_edgesToInsertInSweepStructure.pop(),this.setEdgeSweepNode_(s,-1);const i=this.isEdgeOnSweepLine_(s);r.StridedIndexTypeCollection.isValidElement(i)?(this.insertNewEdgeToSweepStructure_(s,i),t++):i!==r.StridedIndexTypeCollection.impossibleIndex2()&&(e=!1),this.m_bContinuingSegmentChainOptimization=!1}return e}insertNewEdgeToSweepStructure_(e,t){let s;if(this.m_bContinuingSegmentChainOptimization?(s=this.m_sweepStructure.addElementAtPosition(this.m_prevNeighbour,this.m_nextNeighbour,e,!0,!0),this.m_bContinuingSegmentChainOptimization=!1):s=this.m_sweepStructure.addUniqueElement(e),-1===s){const t=this.m_sweepStructure.getDuplicateElement(),s=this.m_sweepStructure.getElement(t);return this.mergeEdges_(s,e),!1}if(this.setEdgeSweepNode_(e,s),this.m_sweepComparator.intersectionDetected()){this.m_sweepComparator.clearIntersectionDetectedFlag();const e=this.m_sweepComparator.getLastComparedNode();return this.m_prevNeighbour===e&&(this.m_prevNeighbour=-1),this.m_nextNeighbour===e&&(this.m_nextNeighbour=-1),this.fixIntersection_(e,s),!0}return!1}isEdgeOnSweepLine_(e){const t=this.getEdgeCluster(e,0),s=this.getEdgeCluster(e,1),n=this.getClusterXY(t),o=this.getClusterXY(s);if(i.Point2D.sqrDistance(n,o)<=this.m_toleranceSqr)return this.m_bComplications=!0,-1;const a=n.compare(this.m_sweepPoint),m=o.compare(this.m_sweepPoint);return a<=0&&m>0?s:m<=0&&a>0?t:a>0&&m>0?r.StridedIndexTypeCollection.impossibleIndex2():-1}fillEventQueue(){const e=new r.AttributeStreamOfInt32(0),t=this.m_shape.queryVertexIteratorOnSelection();for(let s=t.next();s!==n.nullHandle;s=t.next())-1!==this.m_shape.getUserIndex(s,this.m_vertexClusterIndex)&&e.add(s);this.m_shape.sortVerticesSimpleByY(e,0,e.size()),this.progress_(!0),this.m_eventQ.clear(),this.m_eventQ.setCapacity(e.size()),this.m_eventQ.setComparator(new pe(this.m_shape));const s=i.Point2D.getNAN();s.setNAN();let o=-1;for(let t=0,n=e.size();t<n;t++){const n=e.read(t);if(this.m_shape.getXY(n).isEqualPoint2D(s)){const e=this.m_shape.getUserIndex(n,this.m_vertexClusterIndex);this.mergeClusters_(o,e);continue}o=this.getClusterFromVertex(n),this.m_shape.queryXY(n,s);const r=this.m_eventQ.addBiggestElement(n);this.setClusterEventQNode_(o,r)}}fillEventQueuePass2(){const e=new r.AttributeStreamOfInt32(0);for(let t=this.m_eventQ.getFirst();-1!==t;t=this.m_eventQ.getNext(t)){const s=this.m_eventQ.getElement(t);e.add(s)}this.m_eventQ.clear(),this.m_shape.sortVerticesSimpleByY(e,0,e.size()),this.progress_(!0);for(let t=0,s=e.size();t<s;t++){const s=e.read(t),n=this.getClusterFromVertex(s),r=this.m_eventQ.addBiggestElement(s);this.setClusterEventQNode_(n,r)}}getAffectedEdges(e,t){const s=this.getClusterFirstEdge(e);if(-1===s)return;let n=s;do{const s=this.getEdgeSweepNode(n);r.StridedIndexTypeCollection.isValidElement(s)&&t.push(n),n=this.getNextEdge(n,e)}while(n!==s)}updateClusterXY(e,t,s,n,r){const i=this.getClusterVertices(t);for(let t=this.m_clusterVertices.getFirst(i);-1!==t;t=this.m_clusterVertices.getNext(t)){const i=this.m_clusterVertices.getElement(t);this.m_shape.setXYMonotonicPoint2D(i,s),this.m_shape.setWeight(i,n),this.m_shape.setRank(i,r),e&&this.m_bTrackChanges&&this.m_shape.setGeometryModifiedWithVertex(i,!0),this.m_shape.setSegmentParentageBreakVertex(i,!0)}}splitEdge_(e,t,s,n){this.dbgCheckEdge_(e),-1!==t&&this.dbgCheckEdge_(t),this.disconnectEdge_(e),-1!==t&&this.disconnectEdge_(t),this.processSplitHelper1_(0,e,n),-1!==t&&this.processSplitHelper1_(1,t,n),-1!==s&&n.getResultPointChanged()&&this.m_modifiedClusters.push(s);for(let e=0,t=this.m_modifiedClusters.length;e<t;e++){const t=this.m_modifiedClusters[e],s=this.getClusterEventQNode(t);-1!==s&&(this.m_eventQ.deleteNode(s),this.setClusterEventQNode_(t,-1))}const r=this.getEdgeOriginVertices(e),i=-1!==t?this.getEdgeOriginVertices(t):-1;if(this.applyIntersectorToEditShape_(r,n,0),-1!==i)this.applyIntersectorToEditShape_(i,n,1);else{const e=n.getResultPoint().getXY();this.updateClusterXY(n.getResultPointChanged(),s,e,n.getResultPointWeight(),n.getResultPointRank())}this.createEdgesAndClustersFromSplitEdge_(e,n,0),-1!==t&&this.createEdgesAndClustersFromSplitEdge_(t,n,1),this.m_edgeVertices.deleteList(r),this.deleteEdge_(e),-1!==t&&(this.m_edgeVertices.deleteList(i),this.deleteEdge_(t));for(let e=0,t=this.m_modifiedClusters.length;e<t;e++){const t=this.m_modifiedClusters[e];t===this.m_sweepPointCluster&&(this.m_bSweepPointClusterWasModified=!0);let s=this.getClusterEventQNode(t);if(-1===s){const e=this.getClusterFirstVertex(t);if(s=this.m_eventQ.addUniqueElement(e),-1===s){const e=this.m_eventQ.getDuplicateElement(),s=this.m_eventQ.getElement(e),n=this.getClusterFromVertex(s);this.mergeClusters_(n,t)}else this.setClusterEventQNode_(t,s)}}this.m_modifiedClusters.length=0}getClusterXY(e){const t=this.getClusterFirstVertex(e);return this.m_shape.getXY(t)}getClusterFirstVertex(e){const t=this.getClusterVertices(e);return this.m_clusterVertices.getFirstElement(t)}dbgCheckEdge_(e){}dbgCheckCluster_(e){}dbgCheckNewEdgesArray_(){}dbgSaveSweepStructure_(e){}sweepImpl_(){this.progress_(!0),this.m_bSweepPointClusterWasModified=!1,this.m_sweepPointCluster=-1,null===this.m_sweepComparator&&(this.m_sweepStructure.disableBalancing(),this.m_sweepComparator=new ue(this),this.m_sweepStructure.setComparator(this.m_sweepComparator));const e=[];let t=null,s=null;this.m_prevNeighbour=-1,this.m_nextNeighbour=-1,this.m_bContinuingSegmentChainOptimization=!1;const n=r.StridedIndexTypeCollection.impossibleIndex2(),i=r.StridedIndexTypeCollection.impossibleIndex3();for(let r=this.m_eventQ.getFirst();-1!==r;){this.progress_(),this.dbgCheckSweepStructure_(),this.m_bContinuingSegmentChainOptimization=!1,this.m_prevNeighbour=-1,this.m_nextNeighbour=-1;const o=this.m_eventQ.getElement(r);this.m_sweepPointCluster=this.getClusterFromVertex(o),this.m_shape.queryXY(o,this.m_sweepPoint),this.m_sweepComparator.setSweepY(this.m_sweepPoint.y,this.m_sweepPoint.x);let a=!1;{const t=this.getClusterFirstEdge(this.m_sweepPointCluster);if(a=-1===t,!a){let s=t;do{const t=this.getEdgeSweepNode(s);-1===t?(this.m_edgesToInsertInSweepStructure.push(s),this.setEdgeSweepNode_(s,i)):t!==i&&e.push(t),s=this.getNextEdge(s,this.m_sweepPointCluster)}while(s!==t)}}if(!this.m_sweepStructure.isAutoBalancing()&&(this.m_sweepStructure.getMaxDepthEver()>4||this.m_edgesToInsertInSweepStructure.length>10)&&this.m_sweepStructure.enableBalancing(),e.length>0){this.m_bContinuingSegmentChainOptimization=1===e.length&&1===this.m_edgesToInsertInSweepStructure.length;for(let t=0,s=e.length;t<s;t++){const s=this.m_sweepStructure.getElement(e[t]);this.setEdgeSweepNode_(s,n)}let t=n,s=n;for(let r=0,i=e.length;r<i;r++){const i=e[r];if(t===n){const e=this.m_sweepStructure.getPrev(i);if(-1!==e){const s=this.m_sweepStructure.getElement(e);this.getEdgeSweepNode(s)!==n&&(t=e)}else t=-1}if(s===n){const e=this.m_sweepStructure.getNext(i);if(-1!==e){const t=this.m_sweepStructure.getElement(e);this.getEdgeSweepNode(t)!==n&&(s=e)}else s=-1}if(t!==n&&s!==n)break}for(let t=0,s=e.length;t<s;t++){const s=e[t],n=this.m_sweepStructure.getElement(s);this.m_sweepStructure.deleteNode(s),this.setEdgeSweepNode_(n,-1)}e.length=0,this.m_prevNeighbour=t,this.m_nextNeighbour=s,-1!==t&&-1!==s?this.m_bContinuingSegmentChainOptimization||this.checkAndFixIntersection_(t,s):-1===t&&-1===s&&(this.m_bContinuingSegmentChainOptimization=!1)}else a&&(null===t&&(t=new ce(this)),t.setPoint(this.m_sweepPoint),this.m_sweepStructure.searchUpperBound(t),t.intersectionDetected()&&(t.clearIntersectionDetectedFlag(),this.fixIntersectionPointSegment_(this.m_sweepPointCluster,t.getCurrentNode())));const m=this.m_bContinuingSegmentChainOptimization;!this.insertNewEdges_()&&m&&-1!==this.m_prevNeighbour&&-1!==this.m_nextNeighbour&&this.checkAndFixIntersection_(this.m_prevNeighbour,this.m_nextNeighbour),this.m_bSweepPointClusterWasModified?(this.m_bSweepPointClusterWasModified=!1,null===s&&(s=new de(this.m_shape)),s.setPoint(this.m_sweepPoint),r=this.m_eventQ.searchUpperBound(s)):r=this.m_eventQ.getNext(r)}return this.m_bCracked}setEditShape_(e){this.m_shape=e,this.m_vertexClusterIndex=this.m_shape.createUserIndex(),this.m_edges.setCapacity(e.getSelectedCount()+32),this.m_clusters.setCapacity(e.getSelectedCount()),this.m_clusterVertices.reserveLists(e.getSelectedCount()),this.m_clusterVertices.reserveNodes(e.getSelectedCount()),this.m_edgeVertices.reserveLists(e.getSelectedCount()+32),this.m_edgeVertices.reserveNodes(e.getSelectedCount()+32);for(let t=this.m_shape.getFirstGeometry();t!==n.nullHandle;t=this.m_shape.getNextGeometry(t))if(s.isMultiPath(this.m_shape.getGeometryType(t)))for(let s=this.m_shape.getFirstPath(t);s!==n.nullHandle;s=this.m_shape.getNextPath(s)){const t=this.m_shape.getPathSize(s),r=this.m_shape.getFirstVertex(s);if(r===n.nullHandle)continue;let i=this.m_shape.getNextVertex(r);if(i===n.nullHandle||i===r)continue;let o=-1;e.selected(r)&&(o=this.newCluster_(r));let a=-1;-1!==o&&e.selected(i)&&(a=this.newEdge_(r),this.addEdgeToCluster(a,o));let m=a;for(let e=0,s=t-2;e<s;e++){const e=this.m_shape.getNextVertex(i);let t=-1;if(this.m_shape.selected(i)){const s=this.newCluster_(i);-1!==m&&this.addEdgeToCluster(m,s),this.m_shape.selected(e)&&(t=this.newEdge_(i),this.addEdgeToCluster(t,s))}m=t,i=e}if(this.m_shape.isClosedPath(s)){const e=this.m_shape.getNextVertex(i);if(this.m_shape.selected(i)){const t=this.newCluster_(i);if(-1!==m&&this.addEdgeToCluster(m,t),this.m_shape.selected(e)){const e=this.newEdge_(i);this.addEdgeToCluster(e,t),this.addEdgeToCluster(e,o)}}}else{let e=-1;this.m_shape.selected(i)&&(e=this.newCluster_(i),-1!==m&&this.addEdgeToCluster(m,e))}}else for(let e=this.m_shape.getFirstPath(t);e!==n.nullHandle;e=this.m_shape.getNextPath(e)){let t=this.m_shape.getFirstVertex(e);for(let s=0,n=this.m_shape.getPathSize(e);s<n;s++)this.m_shape.selected(t)&&this.newCluster_(t),t=this.m_shape.getNextVertex(t)}this.fillEventQueue()}progress_(e=!1){}dbgCheckSweepStructure_(){}}function fe(e,t,s){return{vertex0:e,vertex1:t,dir:s}}class ye{constructor(e){this.m_shape=null,this.m_spikes=[],this.m_points=new r.AttributeStreamOfInt32(0),this.m_pointsIndex=-1,this.m_dissolvedEdges=0,this.m_progressTracker=e}executeImpl_(e,t){if(this.m_shape=e,e.getPathCount(t)<2&&e.getPointCount(t)<6)return;this.m_points.resize(0);for(let s=e.getFirstPath(t);s!==n.nullHandle;s=e.getNextPath(s)){let t=e.getFirstVertex(s);for(let n=0,r=e.getPathSize(s);n<r;n++,t=e.getNextVertex(t))this.m_points.add(t)}this.m_pointsIndex=e.createUserIndex();for(let t=0,s=this.m_points.size();t<s;++t)e.setUserIndex(this.m_points.read(t),this.m_pointsIndex,t);e.sortVerticesSimpleByY(this.m_points,0,this.m_points.size());let r=this.m_points.read(0);const i=e.getXY(r);let o=1,a=0;const m=[];for(let t=1;t<this.m_points.size();t++){const s=this.m_points.read(t);if(s===n.nullHandle)continue;if(-1===e.getUserIndex(s,this.m_pointsIndex))continue;const l=e.getXY(s);if(l.isEqualPoint2D(i))o++;else{if(o>1){for(let s=a;s<t;s++){const t=this.m_points.read(s);if(-1===e.getUserIndex(t,this.m_pointsIndex))continue;const n=e.getNextVertex(t),r=e.getPrevVertex(t);if(t!==n&&!e.isEqualXYPoint2D(n,i)){const e=fe(t,n,1);m.push(e)}if(t!==r&&r!==n&&!e.isEqualXYPoint2D(r,i)){const e=fe(t,r,-1);m.push(e)}}m.length>0&&this.processBunch_(m,i)}r=s,i.assign(l),o=1,a=t}}if(0===this.m_dissolvedEdges)return e.removeUserIndex(this.m_pointsIndex),void(this.m_pointsIndex=-1);let l=e.getPointCount(t);for(let t=0;t<this.m_points.size();t++){const s=this.m_points.read(t);if(s===n.nullHandle)continue;if(-1!==e.getUserIndex(s,this.m_pointsIndex)){e.setUserIndex(s,this.m_pointsIndex,-1);continue}const r=e.getPathFromVertex(s);e.getFirstVertex(r)===s&&e.setFirstVertex(r,n.nullHandle),e.freeVertex(s),this.m_points.write(t,n.nullHandle),l--}const h=e.createPathUserIndex();let g=e.getPathCount(t);for(let r=0,i=this.m_points.size();r<i;++r){if(this.m_points.read(r)===n.nullHandle)continue;let i=this.m_points.read(r);if(-1!==e.getUserIndex(i,this.m_pointsIndex))continue;let o=e.getPathFromVertex(i),a=-1;if(2===e.getPathUserIndex(o,h)){o=n.nullHandle;for(let t=e.getNextVertex(i);t!==i;t=e.getNextVertex(t)){const s=e.getPathFromVertex(t);if(2!==e.getPathUserIndex(s,h)){o=s,i=t;break}}o===n.nullHandle&&(o=e.insertPath(t,n.nullHandle),e.setClosedPath(o,!0),g++),s.geometryReleaseAssert(o!==n.nullHandle)}e.setPathUserIndex(o,h,2),a=e.getFirstVertex(o);let m=0,l=!1,u=i;do{a===u&&(l=!0),e.setUserIndex(u,this.m_pointsIndex,1);const t=e.getPathFromVertex(u);t!==o&&(2!==e.getPathUserIndex(t,h)&&(e.setPathUserIndex(t,h,1),e.setFirstVertex(t,n.nullHandle)),e.setPathToVertex(u,o)),m++,u=e.getNextVertex(u)}while(u!==i);l||e.setFirstVertex(o,i),e.setPathSize(o,m)}for(let s=e.getFirstPath(t);s!==n.nullHandle;){const t=e.getNextPath(s);1!==e.getPathUserIndex(s,h)&&e.getFirstVertex(s)!==n.nullHandle||(e.removePathOnly(s),g--),s=t}e.setGeometryVertexCount(t,l),e.setGeometryPathCount(t,g),e.removePathUserIndex(h),e.removeUserIndex(this.m_pointsIndex),this.m_pointsIndex=-1,e.dbgVerifyVertexCounts(),e.filterClosePoints(0,!0,!1,!1,t)}processBunch_(e,t){e.sort((e,s)=>{const n=this.m_shape.getXY(e.vertex1).sub(t),r=this.m_shape.getXY(s.vertex1).sub(t),o=i.Point2D.compareVectors(n,r);return 0===o?e.dir<s.dir?-1:1:o});let s=0;const n=this.m_shape.getXY(e[0].vertex1);let r=1;const o=this.m_shape.hasCurves();for(let t=1,i=e.length;t<i;t++){const a=this.m_shape.getXY(e[t].vertex1);if(!(a.isEqualPoint2D(n)&&(r++,t+1<i))){if(2===r){const t=e[s],n=e[s+1],r=t.dir;if(r!==n.dir){let e=!0;if(o&&(e=!this.m_shape.isCurve(1===t.dir?t.vertex0:t.vertex1)&&!this.m_shape.isCurve(1===n.dir?n.vertex0:n.vertex1)),e){if(1===r){const e=t.vertex0,s=n.vertex0;this.m_shape.setNextVertex(e,s),this.m_shape.setPrevVertex(s,e),this.m_shape.getPrevVertex(e)===s&&(this.m_shape.setUserIndex(e,this.m_pointsIndex,-1),this.m_shape.setUserIndex(s,this.m_pointsIndex,-1));const r=t.vertex1,i=n.vertex1;this.m_shape.setPrevVertex(r,i),this.m_shape.setNextVertex(i,r),this.m_shape.getNextVertex(r)===i&&(this.m_shape.setUserIndex(r,this.m_pointsIndex,-1),this.m_shape.setUserIndex(i,this.m_pointsIndex,-1))}else{const e=t.vertex0,s=n.vertex0;this.m_shape.setPrevVertex(e,s),this.m_shape.setNextVertex(s,e),this.m_shape.getNextVertex(e)===s&&(this.m_shape.setUserIndex(e,this.m_pointsIndex,-1),this.m_shape.setUserIndex(s,this.m_pointsIndex,-1));const r=t.vertex1,i=n.vertex1;this.m_shape.setNextVertex(r,i),this.m_shape.setPrevVertex(i,r),this.m_shape.getPrevVertex(r)===i&&(this.m_shape.setUserIndex(r,this.m_pointsIndex,-1),this.m_shape.setUserIndex(i,this.m_pointsIndex,-1))}this.m_dissolvedEdges+=2}}}n.assign(a),s=t,r=1}}e.length=0}}function xe(e){for(let t=e.getFirstGeometry();t!==n.nullHandle;t=e.getNextGeometry(t))if(s.isMultiPath(e.getGeometryType(t)))return!0;return!1}function Pe(e,t,s,n,r){if(!xe(t))return!1;let i=new Se(r);if(i.m_shape=t,i.m_tolerance=s,i.m_bAllowCoincident=e,i.m_bNeedsNonSimpleResult=null!==n,i.needsCrackingImpl_())return n&&n.assign(i.m_nonSimpleResult),!0;const o=new a.Transformation2D;o.setSwapCoordinates(),t.applyTransformation(o),i=new Se(r),i.m_shape=t,i.m_tolerance=s,i.m_bAllowCoincident=e,i.m_bNeedsNonSimpleResult=null!==n;const m=i.needsCrackingImpl_();return t.applyTransformation(o),!!m&&(n&&n.assign(i.m_nonSimpleResult),!0)}function Ee(e,t){return{t:e,index:t}}class Se{crackBruteForce_(){let e=this.crackBruteForceImpl_();if(!e&&this.m_shape.hasCurves()){const t=new a.Transformation2D;t.setSwapCoordinates(),this.m_shape.applyTransformation(t),e=this.crackBruteForceImpl_(),this.m_shape.applyTransformation(t)}return e}crackBruteForceImpl_(){let e=!1;const i=new n.SegmentBuffer,o=new n.SegmentBuffer,a=t.Envelope2D.constructEmpty(),m=t.Envelope2D.constructEmpty(),l=!1,h=new r.Point,g=new re,u=this.m_shape.getTotalPointCount(),c=u*u*2,p=this.m_shape.queryVertexIteratorOnSelection();for(let t=p.next();t!==n.nullHandle;t=p.next()){const r=this.m_shape.getGeometryType(p.currentGeometry());let u=1,d=1,_=1,f=0,y=0,x=0;const P=this.m_shape.getSegmentParentage(t);let E=!1,S=!1,C=null,I=!1;if(s.isPoint(r))u=this.m_shape.getWeight(t),f=this.m_shape.getRank(t);else{if(C=this.getSegment_(t,i),null===C)continue;const e=this.m_shape.getVertexIndex(t);u=this.m_shape.getWeightWithIndex(e),f=this.m_shape.getRankWithIndex(e),_=this.m_shape.getSegmentWeightWithIndex(e),x=this.m_shape.getSegmentRankWithIndex(e),E=this.m_shape.getSegmentParentageBreakVertex(t);{const e=this.m_shape.getNextVertex(t);d=this.m_shape.getWeight(e),y=this.m_shape.getRank(e),S=this.m_shape.getSegmentParentageBreakVertex(e)}if(C.queryLooseEnvelope(a),a.inflateCoords(this.m_tolerance,this.m_tolerance),C.isDegenerate(this.m_tolerance)){if(!C.isDegenerate(0))continue;I=!0,C=null}}const v=new n.VertexIterator({copy:p});let T=v.next();T!==n.nullHandle&&(T=v.next());let D=0;for(;T!==n.nullHandle;T=v.next()){if(0!==D){D--;continue}if(this.m_shape.getTotalPointCount()>c)return e;this.progress_();const r=this.m_shape.getGeometryType(v.currentGeometry());let w=null,b=!1,G=0,N=0,H=0,A=0,F=0,V=0,R=!1,k=!1;const M=this.m_shape.getSegmentParentage(T);if(s.isPoint(r))G=this.m_shape.getWeight(T),A=this.m_shape.getRank(T);else{if(w=this.getSegment_(T,o),null===w)continue;const e=this.m_shape.getVertexIndex(T);G=this.m_shape.getWeightWithIndex(e),A=this.m_shape.getRankWithIndex(e),H=this.m_shape.getSegmentWeightWithIndex(e),V=this.m_shape.getSegmentRankWithIndex(e),R=this.m_shape.getSegmentParentageBreakVertex(T);{const e=this.m_shape.getNextVertex(T);N=this.m_shape.getWeight(e),F=this.m_shape.getRank(e),k=this.m_shape.getSegmentParentageBreakVertex(e)}if(w.queryLooseEnvelope(m),w.isDegenerate(this.m_tolerance)){if(!w.isDegenerate(0))continue;b=!0,w=null}}let U=0,O=0;if(null!==C&&null!==w)a.isIntersectingNe(m)&&0!==n.isIntersectingEx(!0,!0,C,w,this.m_tolerance,!0)&&(g.pushSegment(C,u,f,d,y,_,x,E,S,P),g.pushSegment(w,G,A,N,F,H,V,R,k,M),g.intersect2D(this.m_tolerance,!0),e||=g.getSegmentChanged(0)||g.getSegmentChanged(1),U=g.getResultSegmentCount(0),O=g.getResultSegmentCount(1),U+O>0&&(this.m_shape.splitSegmentWithIntersector(t,g,0,!0,!0),this.m_shape.splitSegmentWithIntersector(T,g,1,!0,!0),this.m_bTrackChanges&&(g.getSegmentChanged(0)&&this.m_shape.setGeometryModifiedWithVertex(t,!0),g.getSegmentChanged(1)&&this.m_shape.setGeometryModifiedWithVertex(T,!0))),O>1&&(D+=O-1),g.clear());else if(null!==C){const s=this.m_shape.getXY(T);if(a.contains(s)){if(g.pushSegment(C,u,f,d,y,_,x,E,S,P),this.m_shape.queryPoint(T,h),g.intersect2DEx(this.m_tolerance,h,A,G,l),e||=g.getSegmentChanged(0)||g.getResultPointChanged(),U=g.getResultSegmentCount(0),U>0)if(this.m_bTrackChanges&&(g.getSegmentChanged(0)&&this.m_shape.setGeometryModifiedWithVertex(t,!0),g.getSegmentChanged(1)&&this.m_shape.setGeometryModifiedWithVertex(T,!0)),this.m_shape.splitSegmentWithIntersector(t,g,0,!0,!0),b){let e=n.nullHandle;for(let t=this.m_shape.getNextVertex(T);t!==n.nullHandle&&t!==T&&(w=this.getSegment_(t,o),e=t,null!=w&&w.isDegenerate(0));t=this.m_shape.getNextVertex(t));for(let t=T;t!==n.nullHandle&&(this.m_shape.setPoint(t,g.getResultPoint(),!0),t!==e);t=this.m_shape.getNextVertex(t));}else this.m_shape.setPoint(T,g.getResultPoint(),!0);g.clear()}}else{if(null===w)continue;{const s=this.m_shape.getXY(t);if(m.inflateCoords(this.m_tolerance,this.m_tolerance),m.contains(s)){if(g.pushSegment(w,G,A,N,F,H,V,R,k,M),this.m_shape.queryPoint(t,h),g.intersect2DEx(this.m_tolerance,h,f,u,l),e||=g.getSegmentChanged(0)||g.getResultPointChanged(),O=g.getResultSegmentCount(0),O>0)if(this.m_bTrackChanges&&(g.getSegmentChanged(0)&&this.m_shape.setGeometryModifiedWithVertex(T,!0),g.getSegmentChanged(1)&&this.m_shape.setGeometryModifiedWithVertex(t,!0)),this.m_shape.splitSegmentWithIntersector(T,g,0,!0,!0),D+=O-1,I){let e=n.nullHandle;for(let s=this.m_shape.getNextVertex(t);s!==n.nullHandle&&s!==t&&(w=this.getSegment_(s,o),e=s,null!=w&&w.isDegenerate(0));s=this.m_shape.getNextVertex(s));for(let s=t;s!==n.nullHandle&&(this.m_shape.setPoint(s,g.getResultPoint(),!0),s!==e);s=this.m_shape.getNextVertex(s));}else this.m_shape.setPoint(t,g.getResultPoint(),!0);g.clear()}}}if(U+O!==0&&0!==U){let e=!1;for(;C=this.getSegment_(t,i),null!=C&&(C.queryEnvelope(a),C.isDegenerate(this.m_tolerance));){if(!(U>1)){e=!0;break}t=p.next(),U--,s.geometryReleaseAssert(t!==n.nullHandle)}if(e)break}}}return e}crackerPlaneSweep_(){return this.planesweep_()}planesweep_(){return new _e(this.m_progressTracker,this.m_bTrackChanges).sweep(this.m_shape,this.m_tolerance)}needsCrackingImpl_(){let e=!1;const t=new r.AttributeStreamOfInt32(0);t.resize(this.m_shape.getSelectedCount());const o=this.m_shape.queryVertexIteratorOnSelection();for(let e=0,s=o.next();s!==n.nullHandle;++e,s=o.next())t.write(e,s);this.m_shape.sortVerticesSimpleByY(t,0,t.size()),t.add(n.nullHandle);const a=this.m_shape.createUserIndex(),m=this.m_shape.createUserIndex();this.m_sweepComparator=new Z(this.m_shape,this.m_tolerance,!this.m_bAllowCoincident),this.m_sweepStructure.setComparator(this.m_sweepComparator);let l=null;const h=[],u=[];let c=0;const p=new i.Point2D;for(let r=t.read(c++);r!==n.nullHandle;){this.m_shape.queryXY(r,p);let o=!1;do{let e=this.m_shape.getNextVertex(r),s=this.m_shape.getPrevVertex(r);o||=e!==n.nullHandle||s!==n.nullHandle,e===n.nullHandle||this.m_shape.selected(e)||(e=n.nullHandle),s===n.nullHandle||this.m_shape.selected(s)||(s=n.nullHandle),e!==n.nullHandle&&this.m_shape.compareVerticesSimpleY(r,e)<0&&(u.push(r),u.push(e)),s!==n.nullHandle&&this.m_shape.compareVerticesSimpleY(r,s)<0&&(u.push(s),u.push(s));const i=this.m_shape.getUserIndex(r,a);-1!==i&&(h.push(i),this.m_shape.setUserIndex(r,a,-1));const l=this.m_shape.getUserIndex(r,m);-1!==l&&(h.push(l),this.m_shape.setUserIndex(r,m,-1)),r=t.read(c++)}while(r!==n.nullHandle&&this.m_shape.isEqualXYPoint2D(r,p));if(!o&&(null===l&&(l=new Q(this.m_shape,this.m_tolerance)),l.setPoint(p),this.m_sweepStructure.searchUpperBound(l),l.intersectionDetected())){e=!0,this.m_bNeedsNonSimpleResult&&(s.throwInternalErrorException("needsCrackingIMpl_"),this.m_nonSimpleResult=new g.NonSimpleResult(6,-1,-1));break}let d=1===h.length&&2===u.length;const _=32;h.length>_&&i.numericSort(h);let f=-1,y=-1;if(!d)for(let t=0,s=h.length;t<s;t++){const s=h[t],n=this.m_sweepStructure.getPrev(s);if(-1!==n&&-1===h.indexOf(n))if(-1===f)f=n;else{if(e=!0,!this.m_bNeedsNonSimpleResult)break;this.m_nonSimpleResult=new g.NonSimpleResult(6,-1,-1)}const r=this.m_sweepStructure.getNext(s);if(-1!==r&&-1===h.indexOf(r))if(-1===y)y=r;else{if(e=!0,!this.m_bNeedsNonSimpleResult)break;this.m_nonSimpleResult=new g.NonSimpleResult(6,-1,-1)}if(-1!==f&&-1!==y)break}if(e&&!this.m_bNeedsNonSimpleResult)break;if(this.m_sweepComparator.setSweepY(p.y,p.x),!d){for(let e=0,t=h.length;e<t;e++){const t=h[e];this.m_sweepStructure.deleteNode(t)}h.length=0}if(!d&&-1!==f&&-1!==y&&this.checkForIntersections_(f,y)){e=!0,this.m_bNeedsNonSimpleResult&&(this.m_nonSimpleResult=this.m_sweepComparator.getResult());break}for(let t=0,s=u.length;t<s;t+=2){const s=u[t],n=u[t+1];let r;if(d?(r=this.m_sweepStructure.replaceElementAtPosition(h[0],s,!0,!0),h.length=0,d=!1):r=this.m_sweepStructure.addElement(s),this.m_sweepComparator.intersectionDetected()){this.m_bNeedsNonSimpleResult&&(this.m_nonSimpleResult=this.m_sweepComparator.getResult()),e=!0;break}-1===this.m_shape.getUserIndex(n,a)?this.m_shape.setUserIndex(n,a,r):this.m_shape.setUserIndex(n,m,r)}if(e)break;u.length=0}return this.m_shape.removeUserIndex(a),this.m_shape.removeUserIndex(m),e}checkForIntersections_(e,t){const s=this.m_sweepStructure.getElement(e);this.m_sweepComparator.compare(this.m_sweepStructure,s,t);const n=this.m_sweepComparator.intersectionDetected();return this.m_sweepComparator.clearIntersectionDetectedFlag(),n}getSegment_(e,t){return Se.st_getSegment(this.m_shape,e,t)}static st_getSegment(e,t,s){return e.querySegment(t,s,!1,!1)?s.get():null}dbgPrintSweepEdge(e){}dbgPrintSweepStructure(){}dbgSaveSweepStructure(e=null){}dbgCheckSweepStructure(){}progress_(e=!1){this.m_progressCounter++}crackAWithBMultiPath_(e,o,a){const m=t.Envelope2D.constructEmpty();e.queryLooseEnvelope(m);const l=t.Envelope2D.constructEmpty();if(o.queryLooseEnvelope(l),l.inflateCoords(a,a),!l.isIntersecting(m))return e;const h=e.getImpl(),g=h.getAccelerators();let u=null,c=null;g&&(c=g.getQuadTree()),function(e,t){const s=e.getPointCount();return!(s<16)&&2*s+Math.log(s)/Math.log(2)*1*t<1*s*t}(e,s.vertexCount(o))&&(u=r.buildQuadTree(h,l),c=u);const p=c?c.getIteratorForQT():null,d=o.querySegmentIterator(),_=e.querySegmentIterator(),f=i.makePrimitiveArray(15,Number.NaN),y=[];for(;d.nextPath();)for(;d.hasNextSegment();){const e=d.nextSegment();if(c){p.resetIterator(e,a);for(let t=p.next();-1!==t;t=p.next()){this.progress_();const s=c.getElement(t);if(_.resetToVertex(s,-1),_.hasNextSegment()){const t=_.nextSegment().intersect(e,null,f,null,a);for(let e=0;e<t;e++){const t=f[e];if(0===t||1===t)continue;const s=Ee(t,_.getStartPointIndex());y.push(s)}}}}else{const s=t.Envelope2D.constructEmpty();if(e.queryLooseEnvelope(s),s.inflateCoords(a,a),!m.isIntersecting(s))continue;for(_.resetToFirstPath();_.nextPath();)for(;_.hasNextSegment();){const n=_.nextSegment(),r=t.Envelope2D.constructEmpty();if(n.queryLooseEnvelope(r),!r.isIntersecting(s))continue;const i=n.intersect(e,null,f,null,a);for(let e=0;e<i;e++){const t=f[e];if(0===t||1===t)continue;const s=Ee(t,_.getStartPointIndex());y.push(s)}}}}if(0===y.length)return e;y.sort((e,t)=>e.index<t.index?-1:e.index>t.index?1:e.t<t.t?-1:e.t>t.t?1:0);const x=e.createInstance();for(x.getGeometryType()===s.GeometryType.enumPolygon&&x.setFillRule(e.getFillRule()),_.resetToFirstPath();_.nextPath()&&!_.hasNextSegment(););s.geometryReleaseAssert(_.hasNextSegment());let P=_.nextSegment();const E=new n.SegmentBuffer;let S=-1;for(let e=0,t=y.length;e<t;){const n=y[e].index;let r=e+1;for(;r<t&&y[r].index===n;)++r;for(;_.getStartPointIndex()<n;){this.progress_();const e=_.hasNextSegment(),t=_.getPathIndex();if((e||!_.isClosingSegment()||_.isCurve())&&(s.geometryReleaseAssert(null!==P),x.addSegment(P,S!==t)),S=t,!e){for(_.isPathClosed();_.nextPath()&&!_.hasNextSegment(););s.geometryReleaseAssert(_.hasNextSegment())}P=_.nextSegment()}let i=0;for(let t=e;t<r;t++){const e=y[t].t;if(e===i)continue;s.geometryReleaseAssert(null!==P),P.queryCut(i,e,E),i=e;const n=_.getPathIndex();x.addSegment(E.get(),S!==n),S=n}const o=_.hasNextSegment();if((o||!_.isClosingSegment()||_.isCurve())&&(s.geometryReleaseAssert(null!=P),P.queryCut(i,1,E),x.addSegment(E.get(),!1)),o)P=_.nextSegment();else{for(;_.nextPath()&&!_.hasNextSegment(););P=_.hasNextSegment()?_.nextSegment():null}e=r}if(null!==P){const e=_.getPathIndex();(_.hasNextSegment()||!_.isClosingSegment()||_.isCurve())&&x.addSegment(P,S!==e),S=e}let C=_.hasNextSegment();for(;;){if(!C){for(;_.nextPath()&&(C=_.hasNextSegment(),!C););if(!C)break}P=_.nextSegment();const e=_.getPathIndex();C=_.hasNextSegment(),(C||!_.isClosingSegment()||_.isCurve())&&x.addSegment(P,S!==e),S=e}return x}constructor(e){this.m_shape=null,this.m_progressTracker=null,this.m_nonSimpleResult=new g.NonSimpleResult,this.m_tolerance=0,this.m_sweepComparator=null,this.m_progressCounter=0,this.m_bTrackChanges=!1,this.m_bNeedsNonSimpleResult=!1,this.m_bAllowCoincident=!0,this.m_sweepStructure=new r.Treap,this.m_progressTracker=e}}Se.s_bForceBruteForce=!0;class Ce{constructor(e,t){this.m_monotoneParts=i.makeObjectArray(n.SegmentBuffer,16),this.m_xOrds=i.makePrimitiveArray(16,Number.NaN),this.m_inputPoint=i.Point2D.getNAN(),this.m_miny=0,this.m_maxy=0,this.m_windnum=0,this.m_bAlternate=e,this.m_tolerance=t,this.m_toleranceSqr=t*t,this.m_bTestBorder=!!t,this.m_bBreak=!1}_DoOne(e){if(!this.m_bTestBorder&&(this.m_bAlternate&&this.m_inputPoint.equals(e.getStartXY())||this.m_inputPoint.equals(e.getEndXY())))return void(this.m_bBreak=!0);if(e.getStartY()===this.m_inputPoint.y&&e.getStartY()===e.getEndY()){if(this.m_bAlternate&&!this.m_bTestBorder){const t=Math.min(e.getStartX(),e.getEndX()),s=Math.max(e.getStartX(),e.getEndX());this.m_inputPoint.x>t&&this.m_inputPoint.x<s&&(this.m_bBreak=!0)}return}let t=!1;const s=Math.max(e.getStartX(),e.getEndX());if(this.m_inputPoint.x>s)t=!0;else if(this.m_inputPoint.x>=Math.min(e.getStartX(),e.getEndX())){const n=e.intersectionOfYMonotonicWithAxisX(this.m_inputPoint.y,s);t=!Number.isNaN(n)&&n<=this.m_inputPoint.x}if(t){if(this.m_inputPoint.y===e.getStartY()){if(this.m_inputPoint.y<e.getEndY())return}else if(this.m_inputPoint.y===e.getEndY()&&this.m_inputPoint.y<e.getStartY())return;this.m_bAlternate?this.m_windnum^=1:this.m_windnum+=e.getStartY()>e.getEndY()?1:-1}}_Result(){return!!this.m_windnum}testBorder(e){const t=e.getClosestCoordinate(this.m_inputPoint,!1),s=e.getCoord2D(t);return i.Point2D.sqrDistance(s,this.m_inputPoint)<=this.m_toleranceSqr}setInputPoint(e){this.m_inputPoint.setCoordsPoint2D(e),this.m_miny=e.y-this.m_tolerance,this.m_maxy=e.y+this.m_tolerance}processSegment(e){const t=e.queryInterval(0,1);if(t.vmin>this.m_maxy||t.vmax<this.m_miny)return!1;if(this.m_bTestBorder&&this.testBorder(e))return!0;if(t.vmin>this.m_inputPoint.y||t.vmax<this.m_inputPoint.y)return!1;let n=0;if(e.isCurve()&&(0===this.m_monotoneParts.length&&(this.m_monotoneParts.length=128),n=e.getMonotonicParts(this.m_monotoneParts,!0),s.geometryReleaseAssert(this.m_monotoneParts.length>=n)),n>0)for(let e=0;e<n;e++){const t=this.m_monotoneParts[e].get(),s=i.Envelope1D.construct(t.getStartY(),t.getEndY());if(!(s.vmin>this.m_inputPoint.y||s.vmax<this.m_inputPoint.y)&&(this._DoOne(t),this.m_bBreak))return!0}else if(this._DoOne(e),this.m_bBreak)return!0;return!1}result(){return s.geometryReleaseAssert(0),2}}function Ie(e,n,r){if(e.isEmpty())return 0;const i=t.Envelope2D.constructEmpty();if(e.queryLooseEnvelope(i),i.inflateCoords(r,r),!i.contains(n))return 0;const o=e.getImpl().getAccelerators();if(o){o.getRasterizedGeometry()&&s.geometryReleaseAssert(0);const i=o.getQuadTree();if(i)return function(e,s,n,r){const i=new t.Envelope2D;e.queryLooseEnvelope(i),i.inflateCoords(r,r);const o=0===e.getFillRule(),a=new Ce(o,r);a.setInputPoint(n);const m=i.clone();m.xmax=n.x+r,m.ymin=n.y-r,m.ymax=n.y+r;const l=e.getImpl().querySegmentIterator(),h=s.getIterator(m,r);for(let e=h.next();-1!==e;e=h.next())if(l.resetToVertex(s.getElement(e),-1),l.hasNextSegment()){const e=l.nextSegment();if(a.processSegment(e))return-1}return a._Result()?1:0}(e,i,n,r)}return function(e,t,s){const n=0===e.getFillRule(),r=new Ce(n,s);r.setInputPoint(t);const i=e.getImpl().querySegmentIterator();for(;i.nextPath();)for(;i.hasNextSegment();){const e=i.nextSegment();if(r.processSegment(e))return-1}return r._Result()?1:0}(e,n,r)}function ve(e,t){const s=e.getPointCount();return!(s<16)&&2*s+Math.log(s)/Math.log(2)*1*t<1*s*t}class Te{getDirection_(e){return this.m_shape.getNextVertex(this.getEnd1(e))===this.getEnd2(e)}getEnd_(e){const t=this.getEnd1(e),s=this.getEnd2(e);return this.m_shape.getNextVertex(t)===s?s:t}constructor(e){this.m_end1Nodes=[],this.m_end2Nodes=[],this.m_directions=[],this.m_shape=e,this.m_firstFree=-1}getSegment(e){return this.m_shape.getSegment(this.getStart(e))}isBottomUp(e){let t=this.getEnd1(e),n=this.getEnd2(e);this.m_shape.getPrevVertex(t)===n&&(n=i.swap(t,t=n));const r=i.Point2D.getNAN(),o=i.Point2D.getNAN();return this.m_shape.queryXY(t,r),this.m_shape.queryXY(n,o),s.geometryReleaseAssert(!r.equals(o)),r.y<o.y}getStart(e){const t=this.getEnd1(e),s=this.getEnd2(e);return this.m_shape.getNextVertex(t)===s?t:s}getEnd1(e){return this.m_end1Nodes[e]}getEnd2(e){return this.m_end2Nodes[e]}freeEdge(e){this.m_end1Nodes[e]=this.m_firstFree,this.m_firstFree=e}newEdge(e){if(-1!==this.m_firstFree){const t=this.m_firstFree;return this.m_firstFree=this.m_end1Nodes[t],this.m_end1Nodes[t]=e,this.m_end2Nodes[t]=this.m_shape.getNextVertex(e),t}const t=this.m_end1Nodes.length;return this.m_end1Nodes.push(e),this.m_end2Nodes.push(this.m_shape.getNextVertex(e)),t}getShape(){return this.m_shape}getPath(e){return this.m_shape.getPathFromVertex(this.getEnd1(e))}}let De=class extends r.Comparator{constructor(e){super(),this.m_line1=new n.Line,this.m_line2=new n.Line,this.m_leftElm=-1,this.m_leftx=0,this.m_seg1=null,this.m_helper=e}compare(e,t,n){const r=e.getElement(n),i=this.m_helper.m_edges;let o;this.m_leftElm===t?o=this.m_leftx:(this.m_seg1=i.getSegment(t),this.m_seg1?o=this.m_seg1.intersectionOfYMonotonicWithAxisX(this.m_helper.m_yScanline,0):(i.getShape().queryLineConnector(i.getStart(t),this.m_line1,!0),this.m_seg1=this.m_line1,o=this.m_line1.intersectionOfYMonotonicWithAxisX(this.m_helper.m_yScanline,0)),this.m_leftx=o,this.m_leftElm=t);let a,m=i.getSegment(r);if(m?a=m.intersectionOfYMonotonicWithAxisX(this.m_helper.m_yScanline,0):(i.getShape().queryLineConnector(i.getStart(r),this.m_line2,!0),m=this.m_line2,a=this.m_line2.intersectionOfYMonotonicWithAxisX(this.m_helper.m_yScanline,0)),o===a){const e=i.isBottomUp(t),n=i.isBottomUp(r),l=e?this.m_seg1.getEndY():this.m_seg1.getStartY(),h=n?m.getEndY():m.getStartY(),g=Math.min(l,h);let u=.5*(g+this.m_helper.m_yScanline);u===this.m_helper.m_yScanline&&(u=g),o=this.m_seg1.intersectionOfYMonotonicWithAxisX(u,0),a=m.intersectionOfYMonotonicWithAxisX(u,0),o===a&&s.throwNonSimpleGeometryException("")}return o<a?-1:o>a?1:0}reset(){this.m_leftElm=-1}};class we{constructor(e){this.m_node=-1,this.m_index=0,this.m_sortedVertices=e.m_sortedVertices,this.m_sortedVerticesArray=e.m_sortedVerticesArray,this.m_sortedVertices&&(this.m_node=this.m_sortedVertices.getFirst(this.m_sortedVertices.getFirstList()))}next(){if(this.m_sortedVertices){const e=this.m_node;if(-1===e)return n.nullHandle;const t=this.m_sortedVertices.getData(e);return this.m_node=this.m_sortedVertices.getNext(e),t}if(this.m_index<this.m_sortedVerticesArray.size()){const e=this.m_sortedVerticesArray.read(this.m_index);return this.m_index++,e}return n.nullHandle}}class be{constructor(e){this.m_edges=null,this.m_shape=null,this.m_AET=new r.Treap,this.m_yScanline=0,this.m_geometry=n.nullHandle,this.m_unknownRingOrientationCount=-1,this.m_sortedVertices=null,this.m_sortedVerticesArray=null,this.m_unknownNodes=[],this.m_node1UserIndex=-1,this.m_node2UserIndex=-1,this.m_pathOrientationIndex=-1,this.m_pathParentageIndex=-1,this.m_pathParentsIndex=-1,this.m_progressCounter=0,this.m_bFixSelfTangency=!1,this.m_progressTracker=e,this.m_AET.disableBalancing(),this.m_sweepComparator=new De(this),this.m_AET.setComparator(this.m_sweepComparator)}fixRingOrientation_(){const e=this.fixRingOrientationImplMain_();return-1===this.m_pathOrientationIndex||this.fixRingOrientationImplSimplify_(),e}fixRingOrientationForMp2sp_(){return this.fixRingOrientationImplMain_(),-1===this.m_pathOrientationIndex?-1:this.fixRingOrientationImplMp2sp_()}processBunchForRingOrientationTest_(e){return this.processBunchForRingOrientationTestOddEven_(e)}processBunchForRingOrientationTestOddEven_(e){let t=!1;if(this.m_edges||(this.m_edges=new Te(this.m_shape)),this.m_unknownNodes.length=0,this.processBunchForRingOrientationRemoveEdges_(e),!this.m_AET.isAutoBalancing()){let t=0;for(let s=0,n=e.length;s<n;s++)-1!==e[s]&&t++;(t>10||this.m_AET.getMaxDepthEver()>4)&&this.m_AET.enableBalancing()}for(let t=0,s=e.length;t<s;t++){const s=e[t];s!==n.nullHandle&&this.insertEdge_(s,-1)}for(let e=0;e<this.m_unknownNodes.length&&this.m_unknownRingOrientationCount>0;e++){const i=this.m_unknownNodes[e],o=this.m_AET.getElement(i),a=this.m_edges.getPath(o),m=this.m_shape.getPathUserIndex(a,this.m_pathOrientationIndex);let l=n.nullHandle;if(0===m){let e=this.m_AET.getPrev(i),n=i,o=!1;for(;e!==r.Treap.st_nullNode();){const t=this.m_AET.getElement(e),s=this.m_edges.getPath(t);if(0!==this.m_shape.getPathUserIndex(s,this.m_pathOrientationIndex)){l=s;break}n=e,e=this.m_AET.getPrev(e)}if(e===r.Treap.st_nullNode())o=!0,e=n;else{const t=this.m_AET.getElement(e);o=this.m_edges.isBottomUp(t),e=this.m_AET.getNext(e),o=!o}do{const r=this.m_AET.getElement(e),i=this.m_edges.getPath(r);if(0===this.m_shape.getPathUserIndex(i,this.m_pathOrientationIndex)){if(o!==this.m_edges.isBottomUp(r)){const e=this.m_shape.getFirstVertex(i);this.m_shape.reverseRingInternal(e),this.m_shape.setLastVertex(i,this.m_shape.getPrevVertex(e)),t=!0}if(this.m_shape.setPathUserIndex(i,this.m_pathOrientationIndex,o?3:2),!o){let e=this.m_shape.getPathUserIndex(l,this.m_pathOrientationIndex);2===e?(l=this.m_shape.getPathUserIndex(l,this.m_pathParentsIndex),e=this.m_shape.getPathUserIndex(l,this.m_pathOrientationIndex),s.geometryReleaseAssert(3===e)):s.geometryReleaseAssert(3===e);const t=this.m_shape.getPathUserIndex(l,this.m_pathParentageIndex);this.m_shape.setPathUserIndex(l,this.m_pathParentageIndex,i),this.m_shape.setPathUserIndex(i,this.m_pathParentageIndex,t),this.m_shape.setPathUserIndex(i,this.m_pathParentsIndex,l)}if(this.m_unknownRingOrientationCount--,!this.m_unknownRingOrientationCount)return t}l=i,n=e,e=this.m_AET.getNext(e),o=!o}while(n!==i)}}return t}processBunchForRingOrientationRemoveEdges_(e){for(let t=0,s=e.length;t<s;t++){const s=e[t],r=this.m_shape.getUserIndex(s,this.m_node1UserIndex),i=this.m_shape.getUserIndex(s,this.m_node2UserIndex);if(-1!==r){const e=this.m_AET.getElement(r);this.m_edges.freeEdge(e),this.m_shape.setUserIndex(s,this.m_node1UserIndex,-1)}if(-1!==i){const e=this.m_AET.getElement(i);this.m_edges.freeEdge(e),this.m_shape.setUserIndex(s,this.m_node2UserIndex,-1)}let o=-1;-1!==r&&-1!==i?(this.m_AET.deleteNode(r),this.m_AET.deleteNode(i),e[t]=n.nullHandle):o=-1!==r?r:i,-1!==o&&(this.insertEdge_(s,o)||this.m_AET.deleteNode(o),e[t]=n.nullHandle)}}dbgVerifyRingOrientation_(){}insertEdge_(e,t){const s=i.Point2D.getNAN(),n=i.Point2D.getNAN();this.m_shape.queryXY(e,s);const r=this.m_shape.getNextVertex(e);this.m_shape.queryXY(r,n);let o=!1;if(s.y<n.y){o=!0;const s=this.m_edges.newEdge(e);let n;-1===t?n=this.m_AET.addElement(s):(n=t,this.m_AET.setElement(n,s)),-1===this.m_shape.getUserIndex(r,this.m_node1UserIndex)?this.m_shape.setUserIndex(r,this.m_node1UserIndex,n):this.m_shape.setUserIndex(r,this.m_node2UserIndex,n);const i=this.m_shape.getPathFromVertex(e);0===this.m_shape.getPathUserIndex(i,this.m_pathOrientationIndex)&&this.m_unknownNodes.push(n)}const a=this.m_shape.getPrevVertex(e);if(this.m_shape.queryXY(a,n),s.y<n.y){o=!0;const s=this.m_edges.newEdge(a);let n;-1===t?n=this.m_AET.addElement(s):(n=t,this.m_AET.setElement(n,s)),-1===this.m_shape.getUserIndex(a,this.m_node1UserIndex)?this.m_shape.setUserIndex(a,this.m_node1UserIndex,n):this.m_shape.setUserIndex(a,this.m_node2UserIndex,n);const r=this.m_shape.getPathFromVertex(e);0===this.m_shape.getPathUserIndex(r,this.m_pathOrientationIndex)&&this.m_unknownNodes.push(n)}return o}fixRingSelfTangency_(){const e=[],t=[];let r=-1,o=-1;const a=new i.Point2D;let m=n.nullHandle,l=n.nullHandle,h=-1;const g=new we(this);for(let s=g.next();s!==n.nullHandle;s=g.next()){const n=new i.Point2D;this.m_shape.queryXY(s,n);const g=this.m_shape.getPathFromVertex(s);a.equals(n)&&l===g?(-1===o&&(r=this.m_shape.createPathUserIndex(),this.m_shape.fillPathUserIndexForGeometry(this.m_geometry,r,-1),o=this.m_shape.createUserIndex(),this.m_shape.fillUserIndexForGeometry(this.m_geometry,o,-1)),-1===h&&(h=t.length,this.m_shape.setUserIndex(m,o,h),t.push(1),-1===this.m_shape.getPathUserIndex(g,r)&&(this.m_shape.setPathUserIndex(g,r,m),e.push(g))),this.m_shape.setUserIndex(s,o,h),t[t.length-1]++):(h=-1,a.assign(n)),m=s,l=g}if(0===e.length)return!1;s.geometryReleaseAssert(-1!==r);for(let s=0,n=e.length;s<n;s++){const n=e[s];let i=this.m_shape.getPathUserIndex(n,r);const a=this.m_shape.getUserIndex(i,o),m=[],l=[];m.push(i),l.push(a);for(let e=this.m_shape.getNextVertex(i);e!==i;e=this.m_shape.getNextVertex(e)){const s=e,n=this.m_shape.getUserIndex(s,o);if(-1!==n){if(0===l.length){l.push(n),m.push(s);continue}if(l.at(-1)===n){const r=m.at(-1);this.m_shape.peelALoopIntoAPath(r,s),this.m_shape.setUserIndex(e,o,-1),t[n]--,1===t[n]&&(t[n]=0,l.pop(),m.pop()),i=r,e=r}else m.push(e),l.push(n)}}}return this.m_shape.removePathUserIndex(r),this.m_shape.removeUserIndex(o),this.m_shape.dbgVerifyVertexCounts(),!0}progress_(e=!1){}fixRingOrientationImplMain_(){const e={stack:[],error:void 0,hasError:!1};try{let t,s=!1;const a=o.__addDisposableResource(e,i.makeScopedCall(()=>{this.m_sortedVerticesArray=null}),!1);if(null===this.m_sortedVertices){const e=this.m_shape.getPointCount(this.m_geometry);t=new r.AttributeStreamOfInt32(0);for(let e=this.m_shape.getFirstPath(this.m_geometry);e!==n.nullHandle;e=this.m_shape.getNextPath(e)){let s=this.m_shape.getFirstVertex(e);for(let n=0,r=this.m_shape.getPathSize(e);n<r;n++)t.add(s),s=this.m_shape.getNextVertex(s)}this.m_shape.sortVerticesSimpleByY(t,0,e),this.progress_(!0),this.m_sortedVerticesArray=t}else a.bForget=!0;if(this.m_bFixSelfTangency&&(s=this.fixRingSelfTangency_()),1===this.m_shape.getPathCount(this.m_geometry)){const e=this.m_shape.getFirstPath(this.m_geometry),t=this.m_shape.getRingArea(e);if(this.m_shape.setExterior(e,!0),t<0){const t=this.m_shape.getFirstVertex(e);return this.m_shape.reverseRingInternal(t),this.m_shape.setLastVertex(e,this.m_shape.getPrevVertex(t)),!0}return!1}this.m_shape.dbgVerifyCurves(),this.m_pathOrientationIndex=this.m_shape.createPathUserIndex(),this.m_pathParentageIndex=this.m_shape.createPathUserIndex(),this.m_pathParentsIndex=this.m_shape.createPathUserIndex();for(let e=this.m_shape.getFirstPath(this.m_geometry);e!==n.nullHandle;e=this.m_shape.getNextPath(e))this.m_shape.setPathUserIndex(e,this.m_pathOrientationIndex,0),this.m_shape.setPathUserIndex(e,this.m_pathParentageIndex,-1),this.m_shape.setPathUserIndex(e,this.m_pathParentsIndex,-1);const m=[];this.m_yScanline=Number.NaN;const l=i.Point2D.getNAN();this.m_unknownRingOrientationCount=this.m_shape.getPathCount(this.m_geometry),this.m_node1UserIndex=this.m_shape.createUserIndexUninitialized(),this.m_shape.fillUserIndexForGeometry(this.m_geometry,this.m_node1UserIndex,-1),this.m_node2UserIndex=this.m_shape.createUserIndexUninitialized(),this.m_shape.fillUserIndexForGeometry(this.m_geometry,this.m_node2UserIndex,-1);const h=new we(this);for(let e=h.next();e!==n.nullHandle&&(this.progress_(),this.m_shape.queryXY(e,l),l.y!==this.m_yScanline&&m.length&&(s=this.processBunchForRingOrientationTest_(m)||s,this.m_sweepComparator.reset(),m.length=0),m.push(e),this.m_yScanline=l.y,0!==this.m_unknownRingOrientationCount);e=h.next());return this.m_unknownRingOrientationCount>0&&(s=this.processBunchForRingOrientationTest_(m)||s,m.length=0),this.m_shape.removeUserIndex(this.m_node1UserIndex),this.m_shape.removeUserIndex(this.m_node2UserIndex),this.dbgVerifyRingOrientation_(),s}catch(t){e.error=t,e.hasError=!0}finally{o.__disposeResources(e)}}fixRingOrientationImplSimplify_(){const e=[];for(let t=this.m_shape.getFirstPath(this.m_geometry);t!==n.nullHandle;)if(this.progress_(),3===this.m_shape.getPathUserIndex(t,this.m_pathOrientationIndex)){this.m_shape.setExterior(t,!0);for(let s=this.m_shape.getPathUserIndex(t,this.m_pathParentageIndex);s!==n.nullHandle;){const n=this.m_shape.getPathUserIndex(s,this.m_pathParentageIndex);e.push(s),this.m_shape.setExterior(s,!1),this.m_shape.setPathUserIndex(s,this.m_pathParentageIndex,t),s=n}let s=t,i=e.length;for(let e=this.m_shape.getNextPath(t);i>0&&e!==n.nullHandle;e=this.m_shape.getNextPath(e),--i){if(this.m_shape.getPathUserIndex(e,this.m_pathParentageIndex)!==t){s=n.nullHandle;break}s=e}if(0!==i){s=t;for(let t=0,n=e.length;t<n;t++){const n=e[t];this.m_shape.setPathUserIndex(n,this.m_pathParentageIndex,r.c_deadBeef),this.m_shape.movePath(this.m_geometry,this.m_shape.getNextPath(s),n),s=n}}e.length=0,t=this.m_shape.getNextPath(s)}else t=this.m_shape.getNextPath(t);this.m_shape.removePathUserIndex(this.m_pathOrientationIndex),this.m_shape.removePathUserIndex(this.m_pathParentageIndex),this.m_shape.removePathUserIndex(this.m_pathParentsIndex)}fixRingOrientationImplMp2sp_(){const e=this.m_shape.createPathUserIndex();let t=0;const s=[];for(let i=this.m_shape.getFirstPath(this.m_geometry);i!==n.nullHandle;)if(this.progress_(),3===this.m_shape.getPathUserIndex(i,this.m_pathOrientationIndex)){this.m_shape.setExterior(i,!0),this.m_shape.setPathUserIndex(i,e,t),t++;for(let e=this.m_shape.getPathUserIndex(i,this.m_pathParentageIndex);e!==n.nullHandle;){const t=this.m_shape.getPathUserIndex(e,this.m_pathParentageIndex);s.push(e),this.m_shape.setExterior(e,!1),this.m_shape.setPathUserIndex(e,this.m_pathParentageIndex,i),e=t}let o=i,a=s.length,m=t;for(let t=this.m_shape.getNextPath(i);a>0&&t!==n.nullHandle;t=this.m_shape.getNextPath(t),--a){if(this.m_shape.getPathUserIndex(t,this.m_pathParentageIndex)!==i){o=n.nullHandle;break}o=t,this.m_shape.setPathUserIndex(t,e,-m),m++}if(0!==a){o=i,m=t;for(let t=0,n=s.length;t<n;t++){const n=s[t];this.m_shape.setPathUserIndex(n,e,-m),m++,this.m_shape.setPathUserIndex(n,this.m_pathParentageIndex,r.c_deadBeef)}o=i}t=m,s.length=0,i=this.m_shape.getNextPath(o)}else i=this.m_shape.getNextPath(i);return this.m_shape.removePathUserIndex(this.m_pathOrientationIndex),this.m_shape.removePathUserIndex(this.m_pathParentageIndex),this.m_shape.removePathUserIndex(this.m_pathParentsIndex),e}}function Ge(e,t,s,n,r,i){const o=new Ne(i);return o.m_shape=e,o.m_geometry=t,o.m_knownSimpleResult=s,o.m_bFixSelfTangency=n,o.m_polylineDegeneracies=r,o.m_bHasSegmentParentage=e.hasSegmentParentage(),o.m_bHasSegments=e.hasCurves(),o.simplify_()}class Ne{constructor(e){this.m_shape=null,this.m_geometry=n.nullHandle,this.m_sortedVertices=new r.IndexMultiDCList,this.m_bunchEdgeEndPoints=[],this.m_bunchEdgeCenterPoints=[],this.m_bunchEdgeIndices=[],this.m_sorterSegmentBuffer1=null,this.m_sorterSegmentBuffer2=null,this.m_knownSimpleResult=-1,this.m_sortedVerticesListIndex=-1,this.m_polylineDegeneracies=n.nullHandle,this.m_userIndexSortedIndexToVertex=-1,this.m_userIndexSortedAngleIndexToVertex=-1,this.m_nextVertexToProcess=-1,this.m_firstCoincidentVertex=-1,this.m_progressCounter=0,this.m_bFixSelfTangency=!1,this.m_bHasSegmentParentage=!1,this.m_bHasSegments=!1,this.m_progressTracker=e}compareAngles_(e,t){return this.m_bHasSegments?this.compareAnglesCurves_(e,t):this.compareAnglesLines_(e,t)}compareAnglesLines_(e,t){const n=this.m_bunchEdgeEndPoints[e],r=new i.Point2D;this.m_shape.queryXY(n,r);const o=new i.Point2D,a=this.m_bunchEdgeEndPoints[t];if(this.m_shape.queryXY(a,o),r.equals(o))return 0;const m=this.m_bunchEdgeCenterPoints[e],l=new i.Point2D;this.m_shape.queryXY(m,l);const h=this.m_bunchEdgeCenterPoints[t],g=new i.Point2D;this.m_shape.queryXY(h,g);const u=new i.Point2D;u.setSub(r,l);const c=new i.Point2D;return c.setSub(o,g),(u.isZero()||c.isZero())&&s.throwNonSimpleGeometryException(""),i.Point2D.compareVectors(u,c)}compareAnglesCurves_(e,t){const s=this.m_bunchEdgeEndPoints[e],r=this.m_bunchEdgeEndPoints[t],i=this.m_bunchEdgeCenterPoints[e],o=this.m_bunchEdgeCenterPoints[t],a=this.m_shape.getNextVertex(i)===s,m=this.m_shape.getNextVertex(o)===r,l=a?this.m_shape.isCurve(i):this.m_shape.isCurve(s),h=m?this.m_shape.isCurve(o):this.m_shape.isCurve(r);return l||h?(this.m_sorterSegmentBuffer1||(this.m_sorterSegmentBuffer1=new n.SegmentBuffer),this.m_sorterSegmentBuffer2||(this.m_sorterSegmentBuffer2=new n.SegmentBuffer),a?this.m_shape.querySegment(i,this.m_sorterSegmentBuffer1,!1,!0):(this.m_shape.querySegment(s,this.m_sorterSegmentBuffer1,!1,!0),this.m_sorterSegmentBuffer1.get().reverse()),m?this.m_shape.querySegment(o,this.m_sorterSegmentBuffer2,!1,!0):(this.m_shape.querySegment(r,this.m_sorterSegmentBuffer2,!1,!0),this.m_sorterSegmentBuffer2.get().reverse()),n.compareConnectedSegments(this.m_sorterSegmentBuffer1.get(),this.m_sorterSegmentBuffer2.get())):this.compareAnglesLines_(e,t)}beforeRemoveVertex_(e,t){const s=this.m_shape.getUserIndex(e,this.m_userIndexSortedIndexToVertex);if(this.m_nextVertexToProcess===s&&(this.m_nextVertexToProcess=this.m_sortedVertices.getNext(this.m_nextVertexToProcess)),this.m_firstCoincidentVertex===s&&(this.m_firstCoincidentVertex=this.m_sortedVertices.getNext(this.m_firstCoincidentVertex)),this.m_sortedVertices.deleteElement(this.m_sortedVerticesListIndex,s),this.removeAngleSortInfo_(e),t){const t=this.m_shape.getPathFromVertex(e);if(t!==n.nullHandle&&this.m_shape.getFirstVertex(t)===e){const s=this.m_shape.getNextVertex(e);if(s!==e){if(this.m_shape.getPathFromVertex(s)===t)return void this.m_shape.setFirstVertex(t,s);{const s=this.m_shape.getPrevVertex(e);if(s!==e&&this.m_shape.getPathFromVertex(s)===t)return void this.m_shape.setFirstVertex(t,s)}}this.m_shape.setFirstVertex(t,n.nullHandle),this.m_shape.setLastVertex(t,n.nullHandle)}}}processBunch_(){let e=!1;const t=new i.Point2D(0,0);for(;;){this.m_bunchEdgeEndPoints.length=0,this.m_bunchEdgeCenterPoints.length=0,this.m_bunchEdgeIndices.length=0;let s=this.m_firstCoincidentVertex,n=0,i=!0;for(;s!==this.m_nextVertexToProcess;){const e=this.m_sortedVertices.getData(s);i&&(this.m_shape.queryXY(e,t),i=!1);const o=this.m_shape.getPrevVertex(e),a=this.m_shape.getNextVertex(e);this.m_shape.getUserIndex(o,this.m_userIndexSortedAngleIndexToVertex)!==r.c_deadBeef&&(this.m_bunchEdgeEndPoints.push(o),this.m_shape.setUserIndex(o,this.m_userIndexSortedAngleIndexToVertex,r.c_deadBeef),this.m_bunchEdgeCenterPoints.push(e),this.m_bunchEdgeIndices.push(n++)),this.m_shape.getUserIndex(a,this.m_userIndexSortedAngleIndexToVertex)!==r.c_deadBeef&&(this.m_bunchEdgeEndPoints.push(a),this.m_shape.setUserIndex(a,this.m_userIndexSortedAngleIndexToVertex,r.c_deadBeef),this.m_bunchEdgeCenterPoints.push(e),this.m_bunchEdgeIndices.push(n++)),s=this.m_sortedVertices.getNext(s)}if(this.m_bunchEdgeEndPoints.length<2){1===this.m_bunchEdgeEndPoints.length&&this.m_shape.setUserIndex(this.m_bunchEdgeEndPoints[0],this.m_userIndexSortedAngleIndexToVertex,-1);break}this.m_bunchEdgeIndices.sort((e,t)=>this.compareAngles_(e,t));for(let e=0,t=this.m_bunchEdgeIndices.length;e<t;e++){const t=this.m_bunchEdgeIndices[e],s=this.m_bunchEdgeEndPoints[t];this.m_shape.setUserIndex(s,this.m_userIndexSortedAngleIndexToVertex,e)}const o=this.processCrossOvers_(t);for(let e=0,t=this.m_bunchEdgeIndices.length;e<t;e++){const t=this.m_bunchEdgeIndices[e];if(-1===t)continue;const s=this.m_bunchEdgeEndPoints[t];this.m_shape.setUserIndex(s,this.m_userIndexSortedAngleIndexToVertex,-1)}if(!o)break;e=!0}return e}processCrossOvers_(e){let t=!1,s=!0;for(;s;){s=!1;let n=0;-1===this.m_bunchEdgeIndices[n]&&(n=this.getNextEdgeIndex_(n));let r=this.getNextEdgeIndex_(n);for(let i=0,o=this.m_bunchEdgeIndices.length;i<o&&-1!==n&&-1!==r&&n!==r;i++){const i=this.m_bunchEdgeIndices[n],o=this.m_bunchEdgeIndices[r],a=this.m_bunchEdgeEndPoints[i],m=this.m_bunchEdgeEndPoints[o];let l=this.m_shape.getNextVertex(a),h=!1;this.m_shape.isEqualXYPoint2D(l,e)||(l=this.m_shape.getPrevVertex(a),h=!0);let g=this.m_shape.getNextVertex(m),u=!1;this.m_shape.isEqualXYPoint2D(g,e)||(g=this.m_shape.getPrevVertex(m),u=!0);const c=h?this.m_shape.getPrevVertex(l):this.m_shape.getNextVertex(l),p=u?this.m_shape.getPrevVertex(g):this.m_shape.getNextVertex(g);let d=!1;(this.removeSpike_(l)||this.removeSpike_(g)||this.removeSpike_(a)||this.removeSpike_(m)||this.removeSpike_(c)||this.removeSpike_(p))&&(d=!0),l!==g&&(!d&&this.m_shape.isEqualXY(a,m)&&(d=this.resolveOverlap_(h,u,l,a,g,m)),!d&&this.m_shape.isEqualXY(c,p)&&(d=this.resolveOverlap_(!h,!u,l,c,g,p)),!d&&this.m_shape.isEqualXY(a,p)&&(d=this.resolveOverlap_(h,!u,l,a,g,p)),!d&&this.m_shape.isEqualXY(c,m)&&(d=this.resolveOverlap_(!h,u,l,c,g,m))),d&&(t=!0),s||=d,n=d?this.getNextEdgeIndex_(n):r,r=this.getNextEdgeIndex_(n)}}if(!t){let s=0;-1===this.m_bunchEdgeIndices[s]&&(s=this.getNextEdgeIndex_(s));let n=this.getNextEdgeIndex_(s);for(let r=0,i=this.m_bunchEdgeIndices.length;r<i&&-1!==s&&-1!==n&&s!==n;r++){const r=this.m_bunchEdgeIndices[s],i=this.m_bunchEdgeIndices[n],o=this.m_bunchEdgeEndPoints[r],a=this.m_bunchEdgeEndPoints[i];let m=this.m_shape.getNextVertex(o);this.m_shape.isEqualXYPoint2D(m,e)||(m=this.m_shape.getPrevVertex(o));let l=this.m_shape.getNextVertex(a);this.m_shape.isEqualXYPoint2D(l,e)||(l=this.m_shape.getPrevVertex(a));const h=this.getDirection_(m,o),g=this.getDirection_(l,a),u=h?this.m_shape.getPrevVertex(m):this.m_shape.getNextVertex(m),c=g?this.m_shape.getPrevVertex(l):this.m_shape.getNextVertex(l),p=this.detectAndResolveCrossOver_(h,g,o,m,u,a,l,c);1!==p?0===p?(s=this.getNextEdgeIndex_(s),n=this.getNextEdgeIndex_(s)):(s=this.getPrevEdgeIndex_(s),n=this.getNextEdgeIndex_(s)):t=!0}}return t}simplify_(){this.m_shape.getGeometryType(this.m_geometry)===s.GeometryType.enumPolygon&&1===this.m_shape.getFillRule(this.m_geometry)&&new Ds(this.m_progressTracker).planarSimplifyNoCrackingAndCluster(this.m_bFixSelfTangency,this.m_shape,this.m_geometry,0);let e=!1;this.m_userIndexSortedIndexToVertex=-1,this.m_userIndexSortedAngleIndexToVertex=-1,this.m_userIndexSortedAngleIndexToVertex=this.m_shape.createUserIndexUninitialized();const t=this.m_shape.getPointCount(this.m_geometry),o=new r.AttributeStreamOfInt32(0);this.m_shape.dbgVerifyMonotone();for(let e=this.m_shape.getFirstPath(this.m_geometry);e!==n.nullHandle;e=this.m_shape.getNextPath(e)){let t=this.m_shape.getFirstVertex(e);for(let s=0,n=this.m_shape.getPathSize(e);s<n;s++)this.m_shape.setUserIndex(t,this.m_userIndexSortedAngleIndexToVertex,-1),o.add(t),t=this.m_shape.getNextVertex(t)}this.m_shape.sortVerticesSimpleByY(o,0,t),this.progress_(!0),this.m_userIndexSortedIndexToVertex=this.m_shape.createUserIndexUninitialized(),this.m_sortedVertices.reserveNodes(t),this.m_sortedVerticesListIndex=this.m_sortedVertices.createList(0);for(let e=0;e<t;e++){const t=o.read(e),s=this.m_sortedVertices.addElement(this.m_sortedVerticesListIndex,t);this.m_shape.setUserIndex(t,this.m_userIndexSortedIndexToVertex,s)}this.m_nextVertexToProcess=-1,this.cleanupSpikes_()&&(e=!0);let a=0,m=!1;do{m=!1,this.m_nextVertexToProcess=-1,this.m_firstCoincidentVertex=this.m_sortedVertices.getFirst(this.m_sortedVerticesListIndex);const t=new i.Point2D(0,0);this.m_firstCoincidentVertex!==r.IndexMultiDCList.st_nullNode()&&this.m_shape.queryXY(this.m_sortedVertices.getData(this.m_firstCoincidentVertex),t);let n=0,o=this.m_firstCoincidentVertex;for(;o!==r.IndexMultiDCList.st_nullNode()&&(o=this.m_sortedVertices.getNext(o),o!==r.IndexMultiDCList.st_nullNode());){this.progress_();const e=this.m_sortedVertices.getData(o),s=i.Point2D.getNAN();if(this.m_shape.queryXY(e,s),t.equals(s))n++;else{if(n>0){this.m_nextVertexToProcess=o;const e=this.processBunch_();o=this.m_nextVertexToProcess,o!==r.IndexMultiDCList.st_nullNode()&&this.m_shape.queryXY(this.m_sortedVertices.getData(o),s),e&&(m=!0)}t.setCoordsPoint2D(s),this.m_firstCoincidentVertex=o,n=0}}this.m_nextVertexToProcess=-1,n>0&&this.processBunch_()&&(m=!0),a++>10&&s.throwInternalErrorException(""),m&&this.fixOrphanVertices_(),this.cleanupSpikes_()&&(m=!0),e||=m}while(m);return this.m_shape.dbgVerifyMonotone(),this.m_shape.dbgVerifyCurves(),this.m_shape.removeUserIndex(this.m_userIndexSortedIndexToVertex),this.m_shape.removeUserIndex(this.m_userIndexSortedAngleIndexToVertex),e=function(e,t,s,n,r){const i=new be(r);return i.m_shape=e,i.m_geometry=t,i.m_sortedVertices=s,i.m_bFixSelfTangency=n,i.fixRingOrientation_()}(this.m_shape,this.m_geometry,this.m_sortedVertices,this.m_bFixSelfTangency,this.m_progressTracker)||e,this.m_shape.dbgVerifyCurves(),e}getDirection_(e,t){return this.m_shape.getNextVertex(t)!==e}detectAndResolveCrossOver_(e,t,s,n,r,o,a,m){if(n===a)return this.removeAngleSortInfo_(s),this.removeAngleSortInfo_(o),-1;const l=this.m_shape.getUserIndex(s,this.m_userIndexSortedAngleIndexToVertex),h=this.m_shape.getUserIndex(r,this.m_userIndexSortedAngleIndexToVertex),g=this.m_shape.getUserIndex(o,this.m_userIndexSortedAngleIndexToVertex),u=this.m_shape.getUserIndex(m,this.m_userIndexSortedAngleIndexToVertex),c=i.makePrimitiveArray(8,Number.NaN),p=i.makePrimitiveArray(4,Number.NaN);c[0]=0,p[0]=l,c[1]=0,p[1]=h,c[2]=1,p[2]=g,c[3]=1,p[3]=u;for(let e=1;e<4;e++){const t=p[e],s=c[e];let n=e-1;for(;n>=0&&p[n]>t;)p[n+1]=p[n],c[n+1]=c[n],n--;p[n+1]=t,c[n+1]=s}let d=0;if(c[0]&&(d|=1),c[1]&&(d|=2),c[2]&&(d|=4),c[3]&&(d|=8),5!==d&&10!==d)return 0;if(e!==t&&(m=i.swap(o,o=m)),e)this.m_shape.setNextVertex(m,n),this.m_shape.setPrevVertex(n,m),this.m_shape.setNextVertex(r,a),this.m_shape.setPrevVertex(a,r),this.m_bHasSegmentParentage&&(this.m_shape.setSegmentParentageBreakVertex(n,!0),this.m_shape.setSegmentParentageBreakVertex(a,!0));else{if(this.m_shape.setPrevVertex(m,n),this.m_shape.setNextVertex(n,m),this.m_shape.setPrevVertex(r,a),this.m_shape.setNextVertex(a,r),this.m_bHasSegmentParentage){const e=this.m_shape.getSegmentParentage(n),t=this.m_shape.getSegmentParentage(a);this.m_shape.setSegmentParentageAndBreak(n,t,!0),this.m_shape.setSegmentParentageAndBreak(a,e,!0)}if(this.m_bHasSegments){const e=this.m_shape.getVertexIndex(n),t=this.m_shape.getVertexIndex(a),s=this.m_shape.getSegmentFromIndex(e);this.m_shape.setSegmentToIndex(e,null);const r=this.m_shape.getSegmentFromIndex(t);this.m_shape.setSegmentToIndex(t,null),this.m_shape.setSegmentToIndex(e,r),this.m_shape.setSegmentToIndex(t,s)}}return 1}resolveOverlap_(e,t,s,n,r,i){return this.resolveOverlapOddEven_(e,t,s,n,r,i)}resolveOverlapOddEven_(e,t,s,n,r,o){if(e!==t){e||(r=i.swap(s,s=r),o=i.swap(n,n=o));const t=this.m_shape.getNextVertex(r),a=this.m_shape.getNextVertex(s);if(this.m_shape.setNextVertex(s,t),this.m_shape.setPrevVertex(t,s),this.m_shape.setNextVertex(r,a),this.m_shape.setPrevVertex(a,r),this.m_bHasSegments){const e=this.m_shape.getVertexIndex(s),t=this.m_shape.getVertexIndex(r),n=this.m_shape.getSegmentFromIndex(e);this.m_shape.setSegmentToIndex(e,null);const i=this.m_shape.getSegmentFromIndex(t);this.m_shape.setSegmentToIndex(t,null),this.m_shape.setSegmentToIndex(e,i),this.m_shape.setSegmentToIndex(t,n)}if(this.m_bHasSegmentParentage){const e=this.m_shape.getSegmentParentage(s),t=this.m_shape.getSegmentParentage(r);this.m_shape.setSegmentParentageAndBreak(s,t,!0),this.m_shape.setSegmentParentageAndBreak(r,e,!0),this.m_shape.setSegmentParentageBreakVertex(n,!0),this.m_shape.setSegmentParentageBreakVertex(o,!0)}this.removeSpike_(r)}else{const i=e?s:n,a=t?r:o,m=e?n:s,l=t?o:r;let h=null;if(this.m_bHasSegments){const e=this.m_shape.getVertexIndex(l);h=this.m_shape.getSegmentFromIndex(e),this.m_shape.setSegmentToIndex(e,null);const t=this.m_shape.getVertexIndex(a);this.m_shape.setSegmentToIndex(t,null);const s=this.m_shape.getVertexIndex(i);this.m_shape.setSegmentToIndex(s,null)}let g=-1;this.m_bHasSegmentParentage&&(g=this.m_shape.getSegmentParentage(l));let u=!1;this.m_shape.setNextVertex(i,a),this.m_shape.setNextVertex(a,i),this.m_shape.setPrevVertex(m,l),this.m_shape.setPrevVertex(l,m);let c=l;for(;c!==a;){const e=this.m_shape.getPrevVertex(c),t=this.m_shape.getNextVertex(c);if(this.m_shape.setPrevVertex(c,t),this.m_shape.setNextVertex(c,e),u||=c===i,this.m_bHasSegments&&c!==i){const e=this.m_shape.getVertexIndex(t),s=h;h=this.m_shape.getSegmentFromIndex(e),null!==s&&s.reverse(),this.m_shape.setSegmentToIndex(e,s)}if(this.m_bHasSegmentParentage){const e=this.m_shape.getSegmentParentage(t);this.m_shape.setSegmentParentagePreserveBreak(t,g),g=e}c=t}let p=null;if(!u){const e=this.m_shape.getPrevVertex(a),t=this.m_shape.getNextVertex(a);if(this.m_shape.setPrevVertex(a,t),this.m_shape.setNextVertex(a,e),this.m_bHasSegments){const e=this.m_shape.getVertexIndex(a);p=this.m_shape.getSegmentFromIndex(e),this.m_shape.setSegmentToIndex(e,null)}}let d=-1,_=-1;if(this.m_bHasSegmentParentage&&(d=u?this.m_shape.getSegmentParentage(i):this.m_shape.getSegmentParentage(a),_=this.m_shape.getSegmentParentage(m)),this.transferVertexData_(a,i),this.beforeRemoveVertex_(a,!0),this.m_shape.removeVertexInternal(a,!0),this.removeAngleSortInfo_(i),this.transferVertexData_(l,m),this.beforeRemoveVertex_(l,!0),this.m_shape.removeVertexInternal(l,!0),this.removeAngleSortInfo_(m),this.m_bHasSegmentParentage&&(this.m_shape.setSegmentParentageAndBreak(i,d,!0),this.m_shape.setSegmentParentageAndBreak(m,_,!0)),p){const e=this.m_shape.getVertexIndex(i);this.m_shape.setSegmentToIndex(e,p)}}return!0}cleanupSpikes_(){let e=!1;for(let t=this.m_shape.getFirstPath(this.m_geometry);t!==n.nullHandle;){const s=this.m_shape.getNextPath(t);let r=this.m_shape.getFirstVertex(t);for(let s=0,i=this.m_shape.getPathSize(t);s<i&&i>1;){this.progress_();const{v:o,bModified:a}=this.checkAndCleanupSpike_(t,r);if(o===n.nullHandle)break;a?(e=!0,r=o,s=0,i=this.m_shape.getPathSize(t)):(r=o,s++)}t=s}return e}checkAndCleanupSpike_(e,t){const s={v:n.nullHandle,bModified:!1};let r=this.m_shape.getPrevVertex(t),i=this.m_shape.getNextVertex(t),o=n.nullHandle,a=n.nullHandle;for(;this.m_shape.isEqualXY(r,i)&&(o=r,a=i,i!==t);)r=this.m_shape.getPrevVertex(r),i=this.m_shape.getNextVertex(i);if(o===n.nullHandle)return s.v=i,s;s.bModified=!0;for(let e=this.m_shape.getNextVertex(o);this.beforeRemoveVertex_(e,!1),e!==a;e=this.m_shape.getNextVertex(e));if(o===t)return this.m_polylineDegeneracies!==n.nullHandle?this.m_shape.movePath(this.m_polylineDegeneracies,n.nullHandle,e):this.m_shape.removePath(e),s.v=n.nullHandle,s;{const e=this.m_shape.peelALoopIntoAPath(o,a);this.m_polylineDegeneracies!==n.nullHandle?this.m_shape.movePath(this.m_polylineDegeneracies,n.nullHandle,e):this.m_shape.removePath(e)}return s.v=o,s}removeSpike_(e){let t=this.m_shape.getPrevVertex(e),s=this.m_shape.getNextVertex(e),r=n.nullHandle,i=n.nullHandle;for(;this.m_shape.isEqualXY(t,s)&&(r=t,i=s,s!==e);)t=this.m_shape.getPrevVertex(t),s=this.m_shape.getNextVertex(s);if(r===n.nullHandle)return!1;if(this.m_shape.peelALoop(r,i),this.m_bHasSegmentParentage&&(this.m_shape.setSegmentParentageBreakVertex(r,!0),this.m_shape.setSegmentParentageBreakVertex(i,!0)),this.removeAngleSortInfo_(r),this.m_polylineDegeneracies===n.nullHandle)for(let e=this.m_shape.getNextVertex(i);;){const t=this.m_shape.getNextVertex(e);if(this.removeAngleSortInfo_(e),this.beforeRemoveVertex_(e,!0),this.m_shape.setSegmentToIndex(this.m_shape.getVertexIndex(e),null),this.m_shape.removeVertexInternal(e,!1),e===i)break;e=t}else{for(let e=i;;){const t=this.m_shape.getNextVertex(e);if(this.removeAngleSortInfo_(e),this.beforeRemoveVertex_(e,!1),e=t,e===i)break}const e=[!1];this.m_shape.insertClosedPath(this.m_polylineDegeneracies,n.nullHandle,i,i,e)}return!0}fixOrphanVertices_(){let e=0;for(let e=this.m_sortedVertices.getFirst(this.m_sortedVertices.getFirstList());-1!==e;e=this.m_sortedVertices.getNext(e)){const t=this.m_sortedVertices.getData(e);this.m_shape.setPathToVertex(t,n.nullHandle)}let t=0;for(let s=this.m_shape.getFirstPath(this.m_geometry);s!==n.nullHandle;){const r=this.m_shape.getFirstVertex(s);if(r===n.nullHandle||this.m_shape.getPathFromVertex(r)!==n.nullHandle){const e=s;s=this.m_shape.getNextPath(s),this.m_shape.removePathOnly(e);continue}this.m_shape.setPathToVertex(r,s);let i=1;for(let e=this.m_shape.getNextVertex(r);e!==r;e=this.m_shape.getNextVertex(e))this.m_shape.setPathToVertex(e,s),i++;this.m_shape.setRingAreaValid(s,!1),this.m_shape.setPathSize(s,i),this.m_shape.setLastVertex(s,this.m_shape.getPrevVertex(r)),t+=i,e++,s=this.m_shape.getNextPath(s)}for(let s=this.m_sortedVertices.getFirst(this.m_sortedVertices.getFirstList());-1!==s;s=this.m_sortedVertices.getNext(s)){const r=this.m_sortedVertices.getData(s);if(this.m_shape.getPathFromVertex(r)!==n.nullHandle)continue;const i=[!1],o=this.m_shape.insertClosedPath(this.m_geometry,n.nullHandle,r,r,i);t+=this.m_shape.getPathSize(o),e++}this.m_shape.setGeometryPathCount(this.m_geometry,e),this.m_shape.setGeometryVertexCount(this.m_geometry,t);let s=0;for(let e=this.m_shape.getFirstGeometry();e!==n.nullHandle;e=this.m_shape.getNextGeometry(e))s+=this.m_shape.getPointCount(e);this.m_shape.setTotalPointCount(s)}getNextEdgeIndex_(e){if(-1===e)return-1;for(let t=0,s=this.m_bunchEdgeIndices.length-1;t<s;t++)if(e=(e+1)%this.m_bunchEdgeIndices.length,-1!==this.m_bunchEdgeIndices[e])return e;return-1}getPrevEdgeIndex_(e){if(-1===e)return-1;for(let t=0,s=this.m_bunchEdgeIndices.length-1;t<s;t++)if(e=(this.m_bunchEdgeIndices.length+e-1)%this.m_bunchEdgeIndices.length,-1!==this.m_bunchEdgeIndices[e])return e;return-1}transferVertexData_(e,t){const s=this.m_shape.getUserIndex(t,this.m_userIndexSortedIndexToVertex),n=this.m_shape.getUserIndex(t,this.m_userIndexSortedAngleIndexToVertex);this.m_shape.transferAllDataToTheVertex(e,t),this.m_shape.setUserIndex(t,this.m_userIndexSortedIndexToVertex,s),this.m_shape.setUserIndex(t,this.m_userIndexSortedAngleIndexToVertex,n)}removeAngleSortInfo_(e){const t=this.m_shape.getUserIndex(e,this.m_userIndexSortedAngleIndexToVertex);-1!==t&&(this.m_bunchEdgeIndices[t]=-1,this.m_shape.setUserIndex(e,this.m_userIndexSortedAngleIndexToVertex,-1))}progress_(e=!1){}}function He(e,o,a,m,l,h=!0){switch(Ae(m)){case 0:break;case 1:s.throwInvalidArgumentException("relation string length has to be 9 characters");break;default:s.throwInvalidArgumentException("relation string")}if(h){const t=function(e,t,s){return function(e){return"T*F**FFF*"===e}(e)?3:function(e){return"FF*FF****"===e}(e)?4:function(e,t,s){return!(0===t&&0===s||(2===t&&2===s?"F***T****"!==e:2!==t&&1!==t||0!==s||"F**T*****"!==e))}(e,t,s)?8:function(e,t,s){return t>s?"T*****T**"===e:1===t&&1===s&&"0********"===e}(e,t,s)?16:function(e){return"T**FF*FF*"===e}(e)?64:function(e){return"T*****FF*"===e}(e)?1:function(e,t,s){return t===s&&(1!==t?"T*T***T**"===e:"1*T***T**"===e)}(e,t,s)?32:0}(m,e.getDimension(),o.getDimension());if(0!==t)return Ze(e,o,a,t,l)}let g=0;if("number"==typeof a)g=a;else{const s=t.Envelope2D.constructEmpty();e.queryEnvelope(s);const n=t.Envelope2D.constructEmpty();o.queryEnvelope(n);const i=t.Envelope2D.constructEmpty();i.setCoords({env2D:s}),i.mergeEnvelope2D(n),g=r.calculateToleranceFromGeometryForRel(a,i,!1)}const u=Xe(e,g),c=Xe(o,g);if(u.isEmpty()||c.isEmpty())return function(e,r,o){const a=i.makePrimitiveArray(9,-1);if(e.isEmpty()&&r.isEmpty())return Oe(a,o);let m,l=!1;e.isEmpty()?(m=r,l=!0):m=e,a[0]=-1,a[1]=-1,a[3]=-1,a[4]=-1,a[6]=-1,a[7]=-1,a[8]=2;const h=m.getGeometryType();if(s.isMultiPath(h))if(h===s.GeometryType.enumPolygon)if(0!==m.calculateArea2D())a[2]=2,a[5]=1;else{a[5]=-1;const e=t.Envelope2D.constructEmpty();m.queryEnvelope(e),a[2]=e.height()||e.width()?1:0}else{const e=0!==m.calculateLength2D();a[2]=e?1:0,a[5]=n.hasNonEmptyBoundary(m)?0:-1}else a[2]=0,a[5]=-1;return l&&Ye(a),Oe(a,o)}(u,c,m);const p=u.getGeometryType(),d=c.getGeometryType();let _=!1;switch(p){case s.GeometryType.enumPolygon:switch(d){case s.GeometryType.enumPolygon:_=function(e,s,i,o,a){const m=new qe;m.resetMatrix_(),m.setPredicates_(o),m.setAreaAreaPredicates_();const l=t.Envelope2D.constructEmpty(),h=t.Envelope2D.constructEmpty();e.queryEnvelope(l),s.queryEnvelope(h);let g=!1;if(Ke(l,h,i)&&(m.areaAreaDisjointPredicates_(e,s),g=!0),g||$e(e,s),!g){const t=new n.EditShape,o=t.addGeometry(e),l=t.addGeometry(s);m.setEditShapeCrackAndCluster_(t,new r.CombinedTolerance(i,0),a),m.computeMatrixTopoGraphHalfEdges_(o,l),m.m_topoGraph.removeShape()}return Oe(m.m_matrix,m.m_scl)}(u,c,g,m,l);break;case s.GeometryType.enumPolyline:_=Fe(u,c,g,m,l);break;case s.GeometryType.enumPoint:_=ke(u,c,g,m);break;case s.GeometryType.enumMultiPoint:_=Ve(u,c,g,m,l)}break;case s.GeometryType.enumPolyline:switch(d){case s.GeometryType.enumPolygon:_=Fe(c,u,g,Le(m),l);break;case s.GeometryType.enumPolyline:_=function(e,s,i,o,a){const m=new qe;m.resetMatrix_(),m.setPredicates_(o),m.setLineLinePredicates_();const l=t.Envelope2D.constructEmpty(),h=t.Envelope2D.constructEmpty();e.queryEnvelope(l),s.queryEnvelope(h);let g=!1;if(Ke(l,h,i)&&(m.lineLineDisjointPredicates_(e,s),g=!0),g||$e(e,s),!g){const t=new n.EditShape,o=t.addGeometry(e),l=t.addGeometry(s);m.setEditShapeCrackAndCluster_(t,new r.CombinedTolerance(i,0),a),m.m_clusterIndexA=m.m_topoGraph.createUserIndexForClusters(),m.m_clusterIndexB=m.m_topoGraph.createUserIndexForClusters(),Be(o,m.m_topoGraph,m.m_clusterIndexA),Be(l,m.m_topoGraph,m.m_clusterIndexB),m.computeMatrixTopoGraphHalfEdges_(o,l),m.m_topoGraph.deleteUserIndexForClusters(m.m_clusterIndexA),m.m_topoGraph.deleteUserIndexForClusters(m.m_clusterIndexB),m.m_topoGraph.removeShape()}return Oe(m.m_matrix,m.m_scl)}(u,c,g,m,l);break;case s.GeometryType.enumPoint:_=Me(u,c,g,m,l);break;case s.GeometryType.enumMultiPoint:_=Re(u,c,g,m,l)}break;case s.GeometryType.enumPoint:switch(d){case s.GeometryType.enumPolygon:_=ke(c,u,g,Le(m));break;case s.GeometryType.enumPolyline:_=Me(c,u,g,Le(m),l);break;case s.GeometryType.enumPoint:_=function(e,t,s,n){const r=e.getXY(),o=t.getXY(),a=i.makePrimitiveArray(9,-1);return i.Point2D.sqrDistance(r,o)<=s*s?a[0]=0:(a[2]=0,a[6]=0),a[8]=2,Oe(a,n)}(u,c,g,m);break;case s.GeometryType.enumMultiPoint:_=Ue(c,u,g,Le(m))}break;case s.GeometryType.enumMultiPoint:switch(d){case s.GeometryType.enumPolygon:_=Ve(c,u,g,Le(m),l);break;case s.GeometryType.enumPolyline:_=Re(c,u,g,Le(m),l);break;case s.GeometryType.enumMultiPoint:_=function(e,s,i,o,a){const m=new qe;m.resetMatrix_(),m.setPredicates_(o),m.setPointPointPredicates_();const l=new t.Envelope2D,h=new t.Envelope2D;e.queryEnvelope(l),s.queryEnvelope(h);let g=!1;if(Ke(l,h,i)&&(m.pointPointDisjointPredicates_(),g=!0),!g){const t=new n.EditShape,o=t.addGeometry(e),l=t.addGeometry(s);m.setEditShapeCrackAndCluster_(t,new r.CombinedTolerance(i,0),a),m.computeMatrixTopoGraphClusters_(o,l),m.m_topoGraph.removeShape()}return Oe(m.m_matrix,m.m_scl)}(u,c,g,m,l);break;case s.GeometryType.enumPoint:_=Ue(u,c,g,m)}break;default:_=!1}return _}function Ae(e){if(9!==e.length)return 1;for(let t=0;t<9;t++){const s=e[t];if("*"!==s&&"T"!==s&&"F"!==s&&"0"!==s&&"1"!==s&&"2"!==s)return 2}return 0}function Fe(e,s,i,o,a){const m=new qe;m.resetMatrix_(),m.setPredicates_(o),m.setAreaLinePredicates_();const l=t.Envelope2D.constructEmpty(),h=t.Envelope2D.constructEmpty();e.queryEnvelope(l),s.queryEnvelope(h);let g=!1;if(Ke(l,h,i)&&(m.areaLineDisjointPredicates_(e,s),g=!0),g||$e(e,s),!g){const t=new n.EditShape,o=t.addGeometry(e),l=t.addGeometry(s);m.setEditShapeCrackAndCluster_(t,new r.CombinedTolerance(i,0),a),m.m_clusterIndexB=m.m_topoGraph.createUserIndexForClusters(),Be(l,m.m_topoGraph,m.m_clusterIndexB),m.computeMatrixTopoGraphHalfEdges_(o,l),m.m_topoGraph.deleteUserIndexForClusters(m.m_clusterIndexB),m.m_topoGraph.removeShape()}return Oe(m.m_matrix,m.m_scl)}function Ve(e,s,i,o,a){const m=new qe;m.resetMatrix_(),m.setPredicates_(o),m.setAreaPointPredicates_();const l=t.Envelope2D.constructEmpty(),h=t.Envelope2D.constructEmpty();e.queryEnvelope(l),s.queryEnvelope(h);let g=!1;if(Ke(l,h,i)&&(m.areaPointDisjointPredicates_(e),g=!0),g||$e(e,s),!g){const t=new n.EditShape,o=t.addGeometry(e),l=t.addGeometry(s);m.setEditShapeCrackAndCluster_(t,new r.CombinedTolerance(i,0),a),m.computeMatrixTopoGraphClusters_(o,l),m.m_topoGraph.removeShape()}return Oe(m.m_matrix,m.m_scl)}function Re(e,s,i,o,a){const m=new qe;m.resetMatrix_(),m.setPredicates_(o),m.setLinePointPredicates_();const l=t.Envelope2D.constructEmpty(),h=t.Envelope2D.constructEmpty();e.queryEnvelope(l),s.queryEnvelope(h);let g=!1;if(Ke(l,h,i)&&(m.linePointDisjointPredicates_(e),g=!0),g||$e(e,s),!g){const t=new n.EditShape,o=t.addGeometry(e),l=t.addGeometry(s);m.setEditShapeCrackAndCluster_(t,new r.CombinedTolerance(i,0),a),m.m_clusterIndexA=m.m_topoGraph.createUserIndexForClusters(),Be(o,m.m_topoGraph,m.m_clusterIndexA),m.computeMatrixTopoGraphClusters_(o,l),m.m_topoGraph.deleteUserIndexForClusters(m.m_clusterIndexA),m.m_topoGraph.removeShape()}return Oe(m.m_matrix,m.m_scl)}function ke(e,s,n,r,i){const o=new qe;o.resetMatrix_(),o.setPredicates_(r),o.setAreaPointPredicates_();const a=t.Envelope2D.constructEmpty();e.queryEnvelope(a);const m=s.getXY();let l=!1;if(Je(m,a,n)&&(o.areaPointDisjointPredicates_(e),l=!0),!l){const s=Qt(e,m,n);if(1===s)o.m_matrix[0]=0,o.m_matrix[2]=2,o.m_matrix[3]=-1,o.m_matrix[5]=1,o.m_matrix[6]=-1;else if(2===s)if(o.m_matrix[6]=-1,0!==e.calculateArea2D())o.m_matrix[0]=-1,o.m_matrix[3]=0,o.m_matrix[2]=2,o.m_matrix[5]=1;else{o.m_matrix[0]=0,o.m_matrix[3]=-1,o.m_matrix[5]=-1;const s=t.Envelope2D.constructEmpty();e.queryEnvelope(s),o.m_matrix[2]=s.height()||s.width()?1:-1}else o.areaPointDisjointPredicates_(e)}return Oe(o.m_matrix,r)}function Me(e,s,r,i,o){const a=new qe;a.resetMatrix_(),a.setPredicates_(i),a.setLinePointPredicates_();const m=t.Envelope2D.constructEmpty();e.queryEnvelope(m);let l=!1;if(Je(s.getXY(),m,r)&&(a.linePointDisjointPredicates_(e),l=!0),!l){let t=null,i=!1,m=!1;if((a.m_performPredicates[0]||a.m_performPredicates[6])&&(Ze(e,s,r,4,o)?(a.m_matrix[0]=-1,a.m_matrix[6]=0):(a.m_performPredicates[0]&&(t=n.calculate(e),m=!Ze(t,s,r,4,o),i=!0,a.m_matrix[0]=m?-1:0),a.m_matrix[6]=-1)),a.m_performPredicates[3]&&(null!==t&&t.isEmpty()?a.m_matrix[3]=-1:(i||(null==t&&(t=n.calculate(e)),m=!Ze(t,s,r,4,o),i=!0),a.m_matrix[3]=m?0:-1)),a.m_performPredicates[5])if(null!==t&&t.isEmpty())a.m_matrix[5]=-1;else if(i&&!m)a.m_matrix[5]=0;else{null===t&&(t=n.calculate(e));const i=Ze(t,s,r,3,o);a.m_matrix[5]=i?-1:0}if(a.m_performPredicates[2])if(0!==e.calculateLength2D())a.m_matrix[2]=1;else{const t=new n.MultiPoint({vd:e.getDescription()});t.addPoints(e,0,e.getPointCount());const i=Ze(t,s,r,3,o);a.m_matrix[2]=i?-1:0}}return Oe(a.m_matrix,a.m_scl)}function Ue(e,s,n,r,o){const a=new qe;a.resetMatrix_(),a.setPredicates_(r),a.setPointPointPredicates_();const m=t.Envelope2D.constructEmpty();e.queryEnvelope(m);const l=s.getXY(),h=new i.Point2D;let g=!1;if(Je(l,m,n)&&(a.pointPointDisjointPredicates_(),g=!0),!g){let t=!1,s=!0;const r=n*n;for(let n=0;n<e.getPointCount()&&(e.queryXY(n,h),i.Point2D.sqrDistance(h,l)<=r?t=!0:s=!1,!t||s);n++);t?(a.m_matrix[0]=0,a.m_matrix[2]=s?-1:0,a.m_matrix[6]=-1):(a.m_matrix[0]=-1,a.m_matrix[2]=0,a.m_matrix[6]=0)}return Oe(a.m_matrix,r)}function Oe(e,t){for(let s=0;s<9;s++)switch(t[s]){case"T":if(-1===e[s])return!1;break;case"F":if(-1!==e[s])return!1;break;case"0":if(0!==e[s])return!1;break;case"1":if(1!==e[s])return!1;break;case"2":if(2!==e[s])return!1}return!0}function Be(e,t,s){const r=t.getGeometryID(e);for(let e=t.getFirstCluster();e!==n.nullHandle;e=t.getNextCluster(e)){if(0===(t.getClusterParentage(e)&r))continue;const i=t.getClusterHalfEdge(e);if(i===n.nullHandle){t.setClusterUserIndex(e,s,0);continue}let o=i,a=0;do{const e=o;0!==(t.getHalfEdgeParentage(e)&r)&&a++,o=t.getHalfEdgeNext(t.getHalfEdgeTwin(e))}while(o!==i);t.setClusterUserIndex(e,s,a)}}class qe{nullFunc(){return s.throwInternalErrorException("should not be called"),!1}constructor(){this.m_clusterIndexA=-1,this.m_clusterIndexB=-1,this.m_visitedIndex=-1,this.m_topoGraph=new z,this.m_matrix=i.makePrimitiveArray(9,0),this.m_maxDim=i.makePrimitiveArray(9,0),this.m_performPredicates=i.makePrimitiveArray(9,!1),this.m_scl="",this.m_predicateCount=0,this.m_predicatesHalfEdge=this.nullFunc,this.m_predicatesCluster=this.nullFunc}resetMatrix_(){this.m_matrix.fill(-2),this.m_maxDim.fill(-2)}setPredicates_(e){this.m_scl=e;for(let e=0;e<9;e++)"*"!==this.m_scl[e]?(this.m_performPredicates[e]=!0,this.m_predicateCount++):this.m_performPredicates[e]=!1}setRemainingPredicatesToFalse_(){for(let e=0;e<9;e++)this.m_performPredicates[e]&&-2===this.m_matrix[e]&&(this.m_matrix[e]=-1,this.m_performPredicates[e]=!1)}isPredicateKnown_(e){return!(-2===this.m_matrix[e]||(-1===this.m_matrix[e]?(this.m_performPredicates[e]=!1,this.m_predicateCount--,0):"T"!==this.m_scl[e]&&"F"!==this.m_scl[e]&&this.m_matrix[e]<this.m_maxDim[e]||(this.m_performPredicates[e]=!1,this.m_predicateCount--,0)))}setAreaAreaPredicates_(){this.m_predicatesHalfEdge=this.areaAreaPredicates_,this.m_maxDim[0]=2,this.m_maxDim[1]=1,this.m_maxDim[2]=2,this.m_maxDim[3]=1,this.m_maxDim[4]=1,this.m_maxDim[5]=1,this.m_maxDim[6]=2,this.m_maxDim[7]=1,this.m_maxDim[8]=2,this.m_performPredicates[8]&&(this.m_matrix[8]=2,this.m_performPredicates[8]=!1,this.m_predicateCount--)}setAreaLinePredicates_(){this.m_predicatesHalfEdge=this.areaLinePredicates_,this.m_predicatesCluster=this.areaPointPredicates_,this.m_maxDim[0]=1,this.m_maxDim[1]=0,this.m_maxDim[2]=2,this.m_maxDim[3]=1,this.m_maxDim[4]=0,this.m_maxDim[5]=1,this.m_maxDim[6]=1,this.m_maxDim[7]=0,this.m_maxDim[8]=2,this.m_performPredicates[8]&&(this.m_matrix[8]=2,this.m_performPredicates[8]=!1,this.m_predicateCount--)}setLineLinePredicates_(){this.m_predicatesHalfEdge=this.lineLinePredicates_,this.m_predicatesCluster=this.linePointPredicates_,this.m_maxDim[0]=1,this.m_maxDim[1]=0,this.m_maxDim[2]=1,this.m_maxDim[3]=0,this.m_maxDim[4]=0,this.m_maxDim[5]=0,this.m_maxDim[6]=1,this.m_maxDim[7]=0,this.m_maxDim[8]=2,this.m_performPredicates[8]&&(this.m_matrix[8]=2,this.m_performPredicates[8]=!1,this.m_predicateCount--)}setAreaPointPredicates_(){this.m_predicatesCluster=this.areaPointPredicates_,this.m_maxDim[0]=0,this.m_maxDim[1]=-1,this.m_maxDim[2]=2,this.m_maxDim[3]=0,this.m_maxDim[4]=-1,this.m_maxDim[5]=1,this.m_maxDim[6]=0,this.m_maxDim[7]=-1,this.m_maxDim[8]=2,this.m_performPredicates[1]&&(this.m_matrix[1]=-1,this.m_performPredicates[1]=!1,this.m_predicateCount--),this.m_performPredicates[4]&&(this.m_matrix[4]=-1,this.m_performPredicates[4]=!1,this.m_predicateCount--),this.m_performPredicates[7]&&(this.m_matrix[7]=-1,this.m_performPredicates[7]=!1,this.m_predicateCount--),this.m_performPredicates[8]&&(this.m_matrix[8]=2,this.m_performPredicates[8]=!1,this.m_predicateCount--)}setLinePointPredicates_(){this.m_predicatesCluster=this.linePointPredicates_,this.m_maxDim[0]=0,this.m_maxDim[1]=-1,this.m_maxDim[2]=1,this.m_maxDim[3]=0,this.m_maxDim[4]=-1,this.m_maxDim[5]=0,this.m_maxDim[6]=0,this.m_maxDim[7]=-1,this.m_maxDim[8]=2,this.m_performPredicates[1]&&(this.m_matrix[1]=-1,this.m_performPredicates[1]=!1,this.m_predicateCount--),this.m_performPredicates[4]&&(this.m_matrix[4]=-1,this.m_performPredicates[4]=!1,this.m_predicateCount--),this.m_performPredicates[7]&&(this.m_matrix[7]=-1,this.m_performPredicates[7]=!1,this.m_predicateCount--),this.m_performPredicates[8]&&(this.m_matrix[8]=2,this.m_performPredicates[8]=!1,this.m_predicateCount--)}setPointPointPredicates_(){this.m_predicatesCluster=this.pointPointPredicates_,this.m_maxDim[0]=0,this.m_maxDim[1]=-1,this.m_maxDim[2]=0,this.m_maxDim[3]=-1,this.m_maxDim[4]=-1,this.m_maxDim[5]=-1,this.m_maxDim[6]=0,this.m_maxDim[7]=-1,this.m_maxDim[8]=2,this.m_performPredicates[1]&&(this.m_matrix[1]=-1,this.m_performPredicates[1]=!1,this.m_predicateCount--),this.m_performPredicates[3]&&(this.m_matrix[3]=-1,this.m_performPredicates[3]=!1,this.m_predicateCount--),this.m_performPredicates[4]&&(this.m_matrix[4]=-1,this.m_performPredicates[4]=!1,this.m_predicateCount--),this.m_performPredicates[5]&&(this.m_matrix[5]=-1,this.m_performPredicates[5]=!1,this.m_predicateCount--),this.m_performPredicates[7]&&(this.m_matrix[7]=-1,this.m_performPredicates[7]=!1,this.m_predicateCount--),this.m_performPredicates[8]&&(this.m_matrix[8]=2,this.m_performPredicates[8]=!1,this.m_predicateCount--)}areaAreaDisjointPredicates_(e,t){this.m_matrix[0]=-1,this.m_matrix[1]=-1,this.m_matrix[3]=-1,this.m_matrix[4]=-1,this.areaGeomContainsOrDisjointPredicates_(e,this.m_performPredicates[2]?2:-1,this.m_scl[2],this.m_performPredicates[5]?5:-1,this.m_scl[5]),this.areaGeomContainsOrDisjointPredicates_(t,this.m_performPredicates[6]?6:-1,this.m_scl[6],this.m_performPredicates[7]?7:-1,this.m_scl[7])}areaGeomContainsOrDisjointPredicates_(e,s,n,r,i){const o=-1!==s,a=-1!==r;if(o||a)if(("T"!==n&&"F"!==n&&o||"T"!==i&&"F"!==i&&a)&&0===e.calculateArea2D()){if(a&&(this.m_matrix[r]=-1),o){const n=t.Envelope2D.constructEmpty();e.queryEnvelope(n),this.m_matrix[s]=n.height()||n.width()?1:0}}else o&&(this.m_matrix[s]=2),a&&(this.m_matrix[r]=1)}areaAreaContainsPredicates_(e){this.m_matrix[2]=2,this.m_matrix[3]=-1,this.m_matrix[4]=-1,this.m_matrix[5]=1,this.m_matrix[6]=-1,this.m_matrix[7]=-1,this.areaGeomContainsOrDisjointPredicates_(e,this.m_performPredicates[0]?0:-1,this.m_scl[0],this.m_performPredicates[1]?1:-1,this.m_scl[1])}areaAreaWithinPredicates_(e){this.areaAreaContainsPredicates_(e),Ye(this.m_matrix)}areaLineDisjointPredicates_(e,t){if(this.m_matrix[0]=-1,this.m_matrix[1]=-1,this.m_matrix[3]=-1,this.m_matrix[4]=-1,this.m_performPredicates[6]){const e=this.m_scl[6],s="T"===e||"F"===e||0!==t.calculateLength2D();this.m_matrix[6]=s?1:0}if(this.m_performPredicates[7]){const e=n.hasNonEmptyBoundary(t);this.m_matrix[7]=e?0:-1}this.areaGeomContainsOrDisjointPredicates_(e,this.m_performPredicates[2]?2:-1,this.m_scl[2],this.m_performPredicates[5]?5:-1,this.m_scl[5])}areaLineContainsPredicates_(e,t){if(this.m_performPredicates[0]){const e=this.m_scl[0],s="T"===e||"F"===e||0!==t.calculateLength2D();this.m_matrix[0]=s?1:0}if(this.m_performPredicates[1]){const e=n.hasNonEmptyBoundary(t);this.m_matrix[1]=e?0:-1}this.m_matrix[2]=2,this.m_matrix[3]=-1,this.m_matrix[4]=-1,this.m_matrix[5]=1,this.m_matrix[6]=-1,this.m_matrix[7]=-1}areaPointDisjointPredicates_(e){this.m_matrix[0]=-1,this.m_matrix[3]=-1,this.m_matrix[6]=0,this.areaGeomContainsOrDisjointPredicates_(e,this.m_performPredicates[2]?2:-1,this.m_scl[2],this.m_performPredicates[5]?5:-1,this.m_scl[5])}areaPointContainsPredicates_(e){this.m_matrix[0]=0,this.m_matrix[2]=2,this.m_matrix[3]=-1,this.m_matrix[5]=1,this.m_matrix[6]=-1}lineLineDisjointPredicates_(e,t){if(this.m_matrix[0]=-1,this.m_matrix[1]=-1,this.m_matrix[3]=-1,this.m_matrix[4]=-1,this.m_performPredicates[2]){const t=this.m_scl[2],s="T"===t||"F"===t||0!==e.calculateLength2D();this.m_matrix[2]=s?1:0}if(this.m_performPredicates[5]){const t=n.hasNonEmptyBoundary(e);this.m_matrix[5]=t?0:-1}if(this.m_performPredicates[6]){const e=this.m_scl[6],s="T"===e||"F"===e||0!==t.calculateLength2D();this.m_matrix[6]=s?1:0}if(this.m_performPredicates[7]){const e=n.hasNonEmptyBoundary(t);this.m_matrix[7]=e?0:-1}}linePointDisjointPredicates_(e){if(this.m_matrix[0]=-1,this.m_matrix[3]=-1,this.m_performPredicates[2]){const t=this.m_scl[2],s="T"===t||"F"===t||0!==e.calculateLength2D();this.m_matrix[2]=s?1:0}if(this.m_performPredicates[5]){const t=n.hasNonEmptyBoundary(e);this.m_matrix[5]=t?0:-1}this.m_matrix[6]=0}pointPointDisjointPredicates_(){this.m_matrix[0]=-1,this.m_matrix[2]=0,this.m_matrix[6]=0}areaAreaPredicates_(e,t,s){let n=!0;if(this.m_performPredicates[0]){this.interiorAreaInteriorArea_(e,t,s);const r=this.isPredicateKnown_(0);n&&=r}if(this.m_performPredicates[1]){this.interiorAreaBoundaryArea_(e,t,1);const s=this.isPredicateKnown_(1);n&&=s}if(this.m_performPredicates[2]){this.interiorAreaExteriorArea_(e,t,s,2);const r=this.isPredicateKnown_(2);n&&=r}if(this.m_performPredicates[3]){this.interiorAreaBoundaryArea_(e,s,3);const t=this.isPredicateKnown_(3);n&&=t}if(this.m_performPredicates[4]){this.boundaryAreaBoundaryArea_(e,t,s);const r=this.isPredicateKnown_(4);n&&=r}if(this.m_performPredicates[5]){this.boundaryAreaExteriorArea_(e,t,s,5);const r=this.isPredicateKnown_(5);n&&=r}if(this.m_performPredicates[6]){this.interiorAreaExteriorArea_(e,s,t,6);const r=this.isPredicateKnown_(6);n&&=r}if(this.m_performPredicates[7]){this.boundaryAreaExteriorArea_(e,s,t,7);const r=this.isPredicateKnown_(7);n&&=r}return n}areaLinePredicates_(e,t,s){let n=!0;if(this.m_performPredicates[0]){this.interiorAreaInteriorLine_(e,t,s);const r=this.isPredicateKnown_(0);n&&=r}if(this.m_performPredicates[1]){this.interiorAreaBoundaryLine_(e,t,s,this.m_clusterIndexB);const r=this.isPredicateKnown_(1);n&&=r}if(this.m_performPredicates[2]){this.interiorAreaExteriorLine_(e,t,s);const r=this.isPredicateKnown_(2);n&&=r}if(this.m_performPredicates[3]){this.boundaryAreaInteriorLine_(e,t,s,this.m_clusterIndexB);const r=this.isPredicateKnown_(3);n&&=r}if(this.m_performPredicates[4]){this.boundaryAreaBoundaryLine_(e,t,s,this.m_clusterIndexB);const r=this.isPredicateKnown_(4);n&&=r}if(this.m_performPredicates[5]){this.boundaryAreaExteriorLine_(e,t,s);const r=this.isPredicateKnown_(5);n&&=r}if(this.m_performPredicates[6]){this.exteriorAreaInteriorLine_(e,t);const s=this.isPredicateKnown_(6);n&&=s}if(this.m_performPredicates[7]){this.exteriorAreaBoundaryLine_(e,t,s,this.m_clusterIndexB);const r=this.isPredicateKnown_(7);n&&=r}return n}lineLinePredicates_(e,t,s){let n=!0;if(this.m_performPredicates[0]){this.interiorLineInteriorLine_(e,t,s,this.m_clusterIndexA,this.m_clusterIndexB);const r=this.isPredicateKnown_(0);n&&=r}if(this.m_performPredicates[1]){this.interiorLineBoundaryLine_(e,t,s,this.m_clusterIndexA,this.m_clusterIndexB,1);const r=this.isPredicateKnown_(1);n&&=r}if(this.m_performPredicates[2]){this.interiorLineExteriorLine_(e,t,s,2);const r=this.isPredicateKnown_(2);n&&=r}if(this.m_performPredicates[3]){this.interiorLineBoundaryLine_(e,s,t,this.m_clusterIndexB,this.m_clusterIndexA,3);const r=this.isPredicateKnown_(3);n&&=r}if(this.m_performPredicates[4]){this.boundaryLineBoundaryLine_(e,t,s,this.m_clusterIndexA,this.m_clusterIndexB);const r=this.isPredicateKnown_(4);n&&=r}if(this.m_performPredicates[5]){this.boundaryLineExteriorLine_(e,t,s,this.m_clusterIndexA,5);const r=this.isPredicateKnown_(5);n&&=r}if(this.m_performPredicates[6]){this.interiorLineExteriorLine_(e,s,t,6);const r=this.isPredicateKnown_(6);n&&=r}if(this.m_performPredicates[7]){this.boundaryLineExteriorLine_(e,s,t,this.m_clusterIndexB,7);const r=this.isPredicateKnown_(7);n&&=r}return n}areaPointPredicates_(e,t,s){let n=!0;if(this.m_performPredicates[0]){this.interiorAreaInteriorPoint_(e,t);const s=this.isPredicateKnown_(0);n&&=s}if(this.m_performPredicates[2]){this.interiorAreaExteriorPoint_(e,t);const s=this.isPredicateKnown_(2);n&&=s}if(this.m_performPredicates[3]){this.boundaryAreaInteriorPoint_(e,t,s);const r=this.isPredicateKnown_(3);n&&=r}if(this.m_performPredicates[5]){this.boundaryAreaExteriorPoint_(e,t);const s=this.isPredicateKnown_(5);n&&=s}if(this.m_performPredicates[6]){this.exteriorAreaInteriorPoint_(e,t);const s=this.isPredicateKnown_(6);n&&=s}return n}linePointPredicates_(e,t,s){let n=!0;if(this.m_performPredicates[0]){this.interiorLineInteriorPoint_(e,t,s,this.m_clusterIndexA);const r=this.isPredicateKnown_(0);n&&=r}if(this.m_performPredicates[2]){this.interiorLineExteriorPoint_(e,t,s,this.m_clusterIndexA);const r=this.isPredicateKnown_(2);n&&=r}if(this.m_performPredicates[3]){this.boundaryLineInteriorPoint_(e,t,s,this.m_clusterIndexA);const r=this.isPredicateKnown_(3);n&&=r}if(this.m_performPredicates[5]){this.boundaryLineExteriorPoint_(e,t,s,this.m_clusterIndexA);const r=this.isPredicateKnown_(5);n&&=r}if(this.m_performPredicates[6]){this.exteriorLineInteriorPoint_(e,t,s);const r=this.isPredicateKnown_(6);n&&=r}return n}pointPointPredicates_(e,t,s){let n=!0;if(this.m_performPredicates[0]){this.interiorPointInteriorPoint_(e,t,s);const r=this.isPredicateKnown_(0);n&&=r}if(this.m_performPredicates[2]){this.interiorPointExteriorPoint_(e,t,s,2);const r=this.isPredicateKnown_(2);n&&=r}if(this.m_performPredicates[6]){this.interiorPointExteriorPoint_(e,s,t,6);const r=this.isPredicateKnown_(6);n&&=r}return n}interiorAreaInteriorArea_(e,t,s){if(2===this.m_matrix[0])return;const n=this.m_topoGraph.getHalfEdgeFaceParentage(e);0!==(n&t)&&0!==(n&s)&&(this.m_matrix[0]=2)}interiorAreaBoundaryArea_(e,t,s){if(1===this.m_matrix[s])return;const n=this.m_topoGraph.getHalfEdgeFaceParentage(e),r=this.m_topoGraph.getHalfEdgeFaceParentage(this.m_topoGraph.getHalfEdgeTwin(e));0!==(n&t)&&0!==(r&t)&&(this.m_matrix[s]=1)}interiorAreaExteriorArea_(e,t,s,n){if(2===this.m_matrix[n])return;const r=this.m_topoGraph.getHalfEdgeFaceParentage(e);0!==(r&t)&&0===(r&s)&&(this.m_matrix[n]=2)}boundaryAreaBoundaryArea_(e,t,s){if(1===this.m_matrix[4])return;const n=this.m_topoGraph.getHalfEdgeParentage(e);if(0===(n&t)||0===(n&s)){if(0!==this.m_matrix[4]&&1!==this.m_topoGraph.getHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgePrev(this.m_topoGraph.getHalfEdgeTwin(e)),this.m_visitedIndex)){const n=this.m_topoGraph.getHalfEdgeTo(e),r=this.m_topoGraph.getClusterParentage(n);if(0!==(r&t)&&0!==(r&s))return void(this.m_matrix[4]=0)}}else this.m_matrix[4]=1}boundaryAreaExteriorArea_(e,t,s,n){if(1===this.m_matrix[n])return;const r=this.m_topoGraph.getHalfEdgeFaceParentage(e),i=this.m_topoGraph.getHalfEdgeFaceParentage(this.m_topoGraph.getHalfEdgeTwin(e));0===(r&s)&&0===(i&s)&&(this.m_matrix[n]=1)}interiorAreaInteriorLine_(e,t,s){if(1===this.m_matrix[0])return;const n=this.m_topoGraph.getHalfEdgeFaceParentage(e),r=this.m_topoGraph.getHalfEdgeFaceParentage(this.m_topoGraph.getHalfEdgeTwin(e));0!==(n&t)&&0!==(r&t)&&(this.m_matrix[0]=1)}interiorAreaBoundaryLine_(e,t,s,n){if(0!==this.m_matrix[1]&&1!==this.m_topoGraph.getHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgePrev(this.m_topoGraph.getHalfEdgeTwin(e)),this.m_visitedIndex)){const r=this.m_topoGraph.getHalfEdgeTo(e),i=this.m_topoGraph.getClusterParentage(r);if(0===(i&t)&&0!==(this.m_topoGraph.getHalfEdgeFaceParentage(e)&t)){const e=this.m_topoGraph.getClusterUserIndex(r,n);if(0!==(i&s)&&e%2!=0)return void(this.m_matrix[1]=0)}}}interiorAreaExteriorLine_(e,t,s){2!==this.m_matrix[2]&&0!==(this.m_topoGraph.getHalfEdgeParentage(e)&t)&&(this.m_matrix[2]=2)}boundaryAreaInteriorLine_(e,t,s,n){if(1===this.m_matrix[3])return;const r=this.m_topoGraph.getHalfEdgeParentage(e);if(0===(r&t)||0===(r&s)){if(0!==this.m_matrix[3]&&1!==this.m_topoGraph.getHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgePrev(this.m_topoGraph.getHalfEdgeTwin(e)),this.m_visitedIndex)){const r=this.m_topoGraph.getHalfEdgeTo(e),i=this.m_topoGraph.getClusterParentage(r);if(0!==(i&t)){const e=this.m_topoGraph.getClusterUserIndex(r,n);if(0!==(i&s)&&e%2==0)return void(this.m_matrix[3]=0)}}}else this.m_matrix[3]=1}boundaryAreaBoundaryLine_(e,t,s,n){if(0!==this.m_matrix[4]&&1!==this.m_topoGraph.getHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgePrev(this.m_topoGraph.getHalfEdgeTwin(e)),this.m_visitedIndex)){const r=this.m_topoGraph.getHalfEdgeTo(e),i=this.m_topoGraph.getClusterParentage(r);if(0!==(i&t)){const e=this.m_topoGraph.getClusterUserIndex(r,n);if(0!==(i&s)&&e%2!=0)return void(this.m_matrix[4]=0)}}}boundaryAreaExteriorLine_(e,t,s){if(1===this.m_matrix[5])return;const n=this.m_topoGraph.getHalfEdgeParentage(e);0!==(n&t)&&0===(n&s)&&(this.m_matrix[5]=1)}exteriorAreaInteriorLine_(e,t){if(1===this.m_matrix[6])return;const s=this.m_topoGraph.getHalfEdgeFaceParentage(e),n=this.m_topoGraph.getHalfEdgeFaceParentage(this.m_topoGraph.getHalfEdgeTwin(e));0===(s&t)&&0===(n&t)&&(this.m_matrix[6]=1)}exteriorAreaBoundaryLine_(e,t,s,n){if(0!==this.m_matrix[7]&&1!==this.m_topoGraph.getHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgePrev(this.m_topoGraph.getHalfEdgeTwin(e)),this.m_visitedIndex)){const r=this.m_topoGraph.getHalfEdgeTo(e),i=this.m_topoGraph.getClusterParentage(r);if(0===(i&t)&&0===(this.m_topoGraph.getHalfEdgeFaceParentage(e)&t)){const e=this.m_topoGraph.getClusterUserIndex(r,n);if(0!==(i&s)&&e%2!=0)return void(this.m_matrix[7]=0)}}}interiorLineInteriorLine_(e,t,s,n,r){if(1===this.m_matrix[0])return;const i=this.m_topoGraph.getHalfEdgeParentage(e);if(0===(i&t)||0===(i&s)){if(0!==this.m_matrix[0]&&1!==this.m_topoGraph.getHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgePrev(this.m_topoGraph.getHalfEdgeTwin(e)),this.m_visitedIndex)){const i=this.m_topoGraph.getHalfEdgeTo(e),o=this.m_topoGraph.getClusterParentage(i);if(0!==(o&t)&&0!==(o&s)){const e=this.m_topoGraph.getClusterUserIndex(i,n),t=this.m_topoGraph.getClusterUserIndex(i,r);if(e%2==0&&t%2==0)return void(this.m_matrix[0]=0)}}}else this.m_matrix[0]=1}interiorLineBoundaryLine_(e,t,s,n,r,i){if(0!==this.m_matrix[i]&&1!==this.m_topoGraph.getHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgePrev(this.m_topoGraph.getHalfEdgeTwin(e)),this.m_visitedIndex)){const o=this.m_topoGraph.getHalfEdgeTo(e),a=this.m_topoGraph.getClusterParentage(o);if(0!==(a&t)&&0!==(a&s)){const e=this.m_topoGraph.getClusterUserIndex(o,n),t=this.m_topoGraph.getClusterUserIndex(o,r);if(e%2==0&&t%2!=0)return void(this.m_matrix[i]=0)}}}interiorLineExteriorLine_(e,t,s,n){if(1===this.m_matrix[n])return;const r=this.m_topoGraph.getHalfEdgeParentage(e);0!==(r&t)&&0===(r&s)&&(this.m_matrix[n]=1)}boundaryLineBoundaryLine_(e,t,s,n,r){if(0!==this.m_matrix[4]&&1!==this.m_topoGraph.getHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgePrev(this.m_topoGraph.getHalfEdgeTwin(e)),this.m_visitedIndex)){const i=this.m_topoGraph.getHalfEdgeTo(e),o=this.m_topoGraph.getClusterParentage(i);if(0!==(o&t)&&0!==(o&s)){const e=this.m_topoGraph.getClusterUserIndex(i,n),t=this.m_topoGraph.getClusterUserIndex(i,r);if(e%2!=0&&t%2!=0)return void(this.m_matrix[4]=0)}}}boundaryLineExteriorLine_(e,t,s,n,r){if(0!==this.m_matrix[r]&&1!==this.m_topoGraph.getHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgePrev(this.m_topoGraph.getHalfEdgeTwin(e)),this.m_visitedIndex)){const t=this.m_topoGraph.getHalfEdgeTo(e);if(0===(this.m_topoGraph.getClusterParentage(t)&s)&&this.m_topoGraph.getClusterUserIndex(t,n)%2!=0)return void(this.m_matrix[r]=0)}}interiorAreaInteriorPoint_(e,t){if(0!==this.m_matrix[0]&&0===(this.m_topoGraph.getClusterParentage(e)&t)){const s=this.m_topoGraph.getClusterChain(e);if(0!==(this.m_topoGraph.getChainParentage(s)&t))return void(this.m_matrix[0]=0)}}interiorAreaExteriorPoint_(e,t){2!==this.m_matrix[2]&&0!==(this.m_topoGraph.getClusterParentage(e)&t)&&(this.m_matrix[2]=2)}boundaryAreaInteriorPoint_(e,t,s){if(0===this.m_matrix[3])return;const n=this.m_topoGraph.getClusterParentage(e);0===(n&t)||0===(n&s)||(this.m_matrix[3]=0)}boundaryAreaExteriorPoint_(e,t){1!==this.m_matrix[5]&&0!==(this.m_topoGraph.getClusterParentage(e)&t)&&(this.m_matrix[5]=1)}exteriorAreaInteriorPoint_(e,t){if(0!==this.m_matrix[6]&&0===(this.m_topoGraph.getClusterParentage(e)&t)){const s=this.m_topoGraph.getClusterChain(e);if(0===(this.m_topoGraph.getChainParentage(s)&t))return void(this.m_matrix[6]=0)}}interiorLineInteriorPoint_(e,t,s,n){if(0===this.m_matrix[0])return;const r=this.m_topoGraph.getClusterParentage(e);0===(r&t)||0===(r&s)||this.m_topoGraph.getClusterUserIndex(e,n)%2!=0||(this.m_matrix[0]=0)}interiorLineExteriorPoint_(e,t,s,n){if(1!==this.m_matrix[2])if(-1===this.m_topoGraph.getClusterHalfEdge(e)){if(0!==this.m_matrix[2]&&0===(this.m_topoGraph.getClusterParentage(e)&s))return void(this.m_matrix[2]=0)}else this.m_matrix[2]=1}boundaryLineInteriorPoint_(e,t,s,n){if(0===this.m_matrix[3])return;const r=this.m_topoGraph.getClusterParentage(e);0===(r&t)||0===(r&s)||this.m_topoGraph.getClusterUserIndex(e,n)%2==0||(this.m_matrix[3]=0)}boundaryLineExteriorPoint_(e,t,s,n){if(0===this.m_matrix[5])return;const r=this.m_topoGraph.getClusterParentage(e);0===(r&t)||0!==(r&s)||this.m_topoGraph.getClusterUserIndex(e,n)%2==0||(this.m_matrix[5]=0)}exteriorLineInteriorPoint_(e,t,s){if(0===this.m_matrix[6])return;const n=this.m_topoGraph.getClusterParentage(e);0!==(n&t)||0===(n&s)||(this.m_matrix[6]=0)}interiorPointInteriorPoint_(e,t,s){if(0===this.m_matrix[0])return;const n=this.m_topoGraph.getClusterParentage(e);0===(n&t)||0===(n&s)||(this.m_matrix[0]=0)}interiorPointExteriorPoint_(e,t,s,n){if(0===this.m_matrix[n])return;const r=this.m_topoGraph.getClusterParentage(e);0===(r&t)||0!==(r&s)||(this.m_matrix[n]=0)}computeMatrixTopoGraphHalfEdges_(e,t){let s=!1;const r=this.m_topoGraph.getGeometryID(e),i=this.m_topoGraph.getGeometryID(t);this.m_visitedIndex=this.m_topoGraph.createUserIndexForHalfEdges();for(let e=this.m_topoGraph.getFirstCluster();e!==n.nullHandle;e=this.m_topoGraph.getNextCluster(e)){const t=this.m_topoGraph.getClusterHalfEdge(e);if(t===n.nullHandle){if(null!==this.m_predicatesCluster&&(s=this.m_predicatesCluster(e,r,i),s))break;continue}let o=t;do{let e=o;if(1!==this.m_topoGraph.getHalfEdgeUserIndex(e,this.m_visitedIndex))do{if(s=this.m_predicatesHalfEdge(e,r,i),s)break;this.m_topoGraph.setHalfEdgeUserIndex(e,this.m_visitedIndex,1),e=this.m_topoGraph.getHalfEdgeNext(e)}while(e!==o&&!s);if(s)break;o=this.m_topoGraph.getHalfEdgeNext(this.m_topoGraph.getHalfEdgeTwin(e))}while(o!==t);if(s)break}s||this.setRemainingPredicatesToFalse_(),this.m_topoGraph.deleteUserIndexForHalfEdges(this.m_visitedIndex)}computeMatrixTopoGraphClusters_(e,t){let s=!1;const r=this.m_topoGraph.getGeometryID(e),i=this.m_topoGraph.getGeometryID(t);for(let e=this.m_topoGraph.getFirstCluster();e!==n.nullHandle&&(s=this.m_predicatesCluster(e,r,i),!s);e=this.m_topoGraph.getNextCluster(e));s||this.setRemainingPredicatesToFalse_()}setEditShape_(e,t){this.m_topoGraph.setEditShape(e,t)}setEditShapeCrackAndCluster_(e,t,r){let i=0;if(e.hasCurves()){const s=new ms,n=e.getEnvelope2D(r),o=is(t.total(),n);i=as(o,0),ss(e,o,t.total(),0,s,null,r),s.clearStitcher(e)}hs(e,t.add(i),r,!1,!1),e.filterClosePoints(0,!0,!0,!1,n.nullHandle);for(let t=e.getFirstGeometry();t!==n.nullHandle;t=e.getNextGeometry(t))e.getGeometryType(t)===s.GeometryType.enumPolygon&&Ge(e,t,-1,!1,n.nullHandle,r);this.setEditShape_(e,r)}}function Ye(e){const t=e[1],s=e[2],n=e[5];e[1]=e[3],e[2]=e[6],e[5]=e[7],e[3]=t,e[6]=s,e[7]=n}function Xe(e,i,o){const a=e.getGeometryType();if(s.isSegment(a)){const t=new n.Polyline({vd:e.getDescription()});return t.addSegment(e,!0),t}if(a===s.GeometryType.enumEnvelope){const s=e,o=t.Envelope2D.constructEmpty();if(e.queryEnvelope(o),o.height()<=i&&o.width()<=i){const t=new r.Point({vd:e.getDescription()});return s.getCenter(t),t}if(o.height()<=i||o.width()<=i){const t=new n.Polyline({vd:e.getDescription()}),i=new r.Point;return s.queryCornerByVal(0,i),t.startPathPoint(i),s.queryCornerByVal(2,i),t.lineToPoint(i),t}const a=new n.Polygon({vd:e.getDescription()});return a.addEnvelope(s,!1),a}return e}function Le(e){return`${e[0]}${e[3]}${e[6]}${e[1]}${e[4]}${e[7]}${e[2]}${e[5]}${e[8]}`}class ze{nullFunc(){return s.throwInternalErrorException("should not be called"),!1}constructor(e,n,i,o=!1){this.m_bDone=!1,this.m_tolerance=0,this.m_elementHandle=-1,this.m_query=t.Envelope2D.constructEmpty(),this.m_envInter=t.Envelope2D.constructEmpty(),this.m_quadTree=null,this.m_intersector=null,this.m_function=this.nullFunc;const a=e.getAccelerators();let m=null;null!=a&&(m=o?a.getQuadTreeForPaths():a.getQuadTree());const l=n.getAccelerators();let h=null;if(null!=l&&(h=o?l.getQuadTreeForPaths():l.getQuadTree()),null===m&&null===h&&!o){const o=e.getPointCount(),a=n.getPointCount();if(o>10&&a>10){const l=t.Envelope2D.constructEmpty(),g=t.Envelope2D.constructEmpty(),u=t.Envelope2D.constructEmpty();e.queryLooseEnvelope(l),n.queryLooseEnvelope(g),l.inflateCoords(i,i),g.inflateCoords(i,i),u.setCoords({env2D:l}),u.intersect(g),o>=a?m=s.isMultiPath(e.getGeometryType())?r.buildQuadTree(e,u):r.buildQuadTreeMpt(e,u):h=s.isMultiPath(n.getGeometryType())?r.buildQuadTree(n,u):r.buildQuadTreeMpt(n,u)}}this.construct_(e,m,n,h,i,o)}next(){if(this.m_bQuadTree){if(this.m_bDone)return!1;for(;this.m_function(););return!this.m_bDone}return!!this.m_intersector&&this.m_intersector.next()}getRedElement(){return this.m_bQuadTree?this.m_bSwapElements?this.m_quadTree.getElement(this.m_elementHandle):s.isMultiPath(this.m_queryType)?this.m_bPaths?this.m_pathIndex:this.m_segIter.getStartPointIndex():this.m_pointIndex:this.m_bSwapElements?this.m_intersector.getBlueElement(this.m_intersector.getHandleB()):this.m_intersector.getRedElement(this.m_intersector.getHandleA())}getBlueElement(){return this.m_bQuadTree?this.m_bSwapElements?s.isMultiPath(this.m_queryType)?this.m_bPaths?this.m_pathIndex:this.m_segIter.getStartPointIndex():this.m_pointIndex:this.m_quadTree.getElement(this.m_elementHandle):this.m_bSwapElements?this.m_intersector.getRedElement(this.m_intersector.getHandleA()):this.m_intersector.getBlueElement(this.m_intersector.getHandleB())}getRedEnvelope(){return this.m_bPaths||s.throwInvalidCallException(""),this.m_bQuadTree?this.m_bSwapElements?this.m_quadTree.getElementExtent(this.m_elementHandle):this.m_query:this.m_bSwapElements?this.m_intersector.getBlueEnvelope(this.m_intersector.getHandleB()):this.m_intersector.getRedEnvelope(this.m_intersector.getHandleA())}getBlueEnvelope(){return this.m_bPaths||s.throwInvalidCallException(""),this.m_bQuadTree?this.m_bSwapElements?this.m_query:this.m_quadTree.getElementExtent(this.m_elementHandle):this.m_bSwapElements?this.m_intersector.getRedEnvelope(this.m_intersector.getHandleA()):this.m_intersector.getBlueEnvelope(this.m_intersector.getHandleB())}construct_(e,n,i,o,a,m){const l=t.Envelope2D.constructEmpty(),h=t.Envelope2D.constructEmpty();e.queryLooseEnvelope(l),i.queryLooseEnvelope(h),l.inflateCoords(a,a),h.inflateCoords(a,a),this.m_envInter.setCoords({env2D:l}),this.m_envInter.intersect(h),this.m_multiVertexImplA=e,this.m_multiVertexImplB=i;const g=e.getGeometryType(),u=i.getGeometryType();this.m_bPaths=m,this.m_pathIndex=-1,this.m_pointIndex=-1,this.m_bSwapElements=!1,this.m_queryType=s.GeometryType.enumUnknown,this.m_bQuadTree=!1,null!==n&&(this.m_bDone=!1,this.m_tolerance=a,this.m_quadTree=n,this.m_qtIter=this.m_quadTree.getIteratorForQT(),this.m_bQuadTree=!0,this.m_bSwapElements=!0,s.isMultiPath(u)?(this.m_queryType=u,this.m_function=this.nextPath_,m?this.m_pathIndex=i.getPathCount():this.m_segIter=i.querySegmentIterator()):(this.m_queryType=u,this.m_function=this.nextPoint_,this.m_pointIndex=i.getPointCount())),this.m_bQuadTree||null!==o&&(this.m_bDone=!1,this.m_tolerance=a,this.m_quadTree=o,this.m_qtIter=this.m_quadTree.getIteratorForQT(),this.m_bQuadTree=!0,this.m_bSwapElements=!1,s.isMultiPath(g)?(this.m_queryType=g,this.m_function=this.nextPath_,m?this.m_pathIndex=e.getPathCount():this.m_segIter=e.querySegmentIterator()):(this.m_queryType=g,this.m_function=this.nextPoint_,this.m_pointIndex=e.getPointCount())),this.m_bQuadTree||(m&&s.isMultiPath(g)&&s.isMultiPath(u)?this.m_intersector=r.getEnvelope2DIntersectorForParts(e,i,a):s.isMultiPath(g)&&s.isMultiPath(u)?(this.m_intersector=r.getEnvelope2DIntersector(e,i,a),this.m_bSwapElements=!1):s.isMultiPath(g)&&!s.isMultiPath(u)?(this.m_intersector=r.getEnvelope2DIntersectorMpthMpt(e,i,a),this.m_bSwapElements=!1):!s.isMultiPath(g)&&s.isMultiPath(u)?(this.m_intersector=r.getEnvelope2DIntersectorMpthMpt(i,e,a),this.m_bSwapElements=!0):(this.m_intersector=r.getEnvelope2DIntersectorMptMpt(e,i,a),this.m_bSwapElements=!1))}nextPath_(){return this.m_bPaths?-1===--this.m_pathIndex?(this.m_bDone=!0,!1):(this.m_bSwapElements?this.m_multiVertexImplB.queryPathEnvelope(this.m_pathIndex,this.m_query):this.m_multiVertexImplA.queryPathEnvelope(this.m_pathIndex,this.m_query),this.m_qtIter.resetIterator(this.m_query,this.m_tolerance),this.m_function=this.iterate_,!0):this.m_segIter.nextPath()?(this.m_function=this.nextSegment_,!0):(this.m_bDone=!0,!1)}nextSegment_(){if(!this.m_segIter.hasNextSegment())return this.m_function=this.nextPath_,!0;const e=this.m_segIter.nextSegment(),s=new t.Envelope2D;return e.queryLooseEnvelope(s),!s.isIntersecting(this.m_envInter)||(this.m_qtIter.resetIterator(e,this.m_tolerance),this.m_function=this.iterate_,!0)}nextPoint_(){if(-1===--this.m_pointIndex)return this.m_bDone=!0,!1;const e=new i.Point2D;if(this.m_bSwapElements){const t=this.m_multiVertexImplB.getXY(this.m_pointIndex);e.setCoordsPoint2D(t)}else{const t=this.m_multiVertexImplA.getXY(this.m_pointIndex);e.setCoordsPoint2D(t)}return!this.m_envInter.contains(e)||(this.m_qtIter.resetIterator(t.Envelope2D.construct(e.x,e.y,e.x,e.y),this.m_tolerance),this.m_function=this.iterate_,!0)}iterate_(){return this.m_elementHandle=this.m_qtIter.next(),-1===this.m_elementHandle&&(s.isMultiPath(this.m_queryType)?(this.m_function=this.m_bPaths?this.nextPath_:this.nextSegment_,!0):(this.m_function=this.nextPoint_,!0))}}function We(e){return 2===e?1:1===e?2:128===e?64:64===e?128:e}function je(e,s,n){let i;if(e instanceof ji||null===e){const o=t.Envelope2D.constructEmpty();o.setCoords({env2D:s}),o.mergeEnvelope2D(n),i=r.calculateToleranceFromGeometryForRel(e,o,!1)}else i=e;return i}function Ze(e,o,a,l,h){if(e.isEmpty()||o.isEmpty())return 4===l;s.throwIfMesh(e),s.throwIfMesh(o);let g=e.getGeometryType(),u=o.getGeometryType();if(g===s.GeometryType.enumEnvelope){if(u===s.GeometryType.enumEnvelope)return function(e,s,n,r){if(e.isEmpty()||s.isEmpty())return 4===r;const i=t.Envelope2D.constructEmpty();e.queryEnvelope(i);const o=t.Envelope2D.constructEmpty();s.queryEnvelope(o);const a=je(n,i,o);switch(r){case 4:return Ke(i,o,a);case 2:return Tt(o,i,a,!1);case 128:return Tt(o,i,a,!0);case 1:return Tt(i,o,a,!1);case 64:return Tt(i,o,a,!0);case 3:return vt(i,o,a);case 8:return function(e,s,n){if(e.height()<=n||e.width()<=n||s.height()<=n||s.width()<=n)return!1;const r=new t.Envelope2D;return r.setCoords({env2D:e}),r.inflateCoords(-n,-n),r.intersect(s),!(!r.isEmpty()&&r.height()>n&&r.width()>n||(r.setCoords({env2D:e}),r.inflateCoords(n,n),r.intersect(s),r.isEmpty()))}(i,o,a);case 32:return function(e,s,n){if(e.height()<=n||e.width()<=n||s.height()<=n||s.width()<=n)return!1;if(bt(e,s,n))return!1;if(bt(s,e,n))return!1;const r=new t.Envelope2D;return r.setCoords({env2D:e}),r.inflateCoords(-n,-n),r.intersect(s),!r.isEmpty()&&(r.height()>n||r.width()>n)}(i,o,a);case 16:return!1}return!1}(e,o,a,l);if(u===s.GeometryType.enumPoint)return Qe(o,e,a,We(l))}else if(g===s.GeometryType.enumPoint){if(u===s.GeometryType.enumEnvelope)return Qe(e,o,a,l);if(u===s.GeometryType.enumPoint)return function(e,s,n,o){if(e.isEmpty()||s.isEmpty())return 4===o;const a=e.getXY(),m=s.getXY();let l;if(n instanceof ji||null===n){const e=t.Envelope2D.constructEmpty();e.setCoords({pt:a}),e.merge(m),l=r.calculateToleranceFromGeometryForRel(n,e,!1)}else l=n;switch(o){case 4:return function(e,t,s){return i.Point2D.sqrDistance(e,t)>s*s}(a,m,l);case 2:case 128:return It(m,a,l);case 1:case 64:return It(a,m,l);case 3:return Ct(a,m,l)}return!1}(e,o,a,l)}const c=t.Envelope2D.constructEmpty();e.queryEnvelope(c);const p=t.Envelope2D.constructEmpty();o.queryEnvelope(p);const d=je(a,c,p);if(Ke(c,p,d))return 4===l;let _=!1,f=null,y=null,x=null,P=null;switch(s.isSegment(g)?(f=new n.Polyline({vd:e.getDescription()}),f.addSegment(e,!0),x=f,g=s.GeometryType.enumPolyline):x=e,s.isSegment(u)?(y=new n.Polyline({vd:o.getDescription()}),y.addSegment(o,!0),P=y,u=s.GeometryType.enumPolyline):P=o,g!==s.GeometryType.enumEnvelope&&u!==s.GeometryType.enumEnvelope?(x.getDimension()<P.getDimension()||g===s.GeometryType.enumPoint&&u===s.GeometryType.enumMultiPoint)&&(l=We(l)):g!==s.GeometryType.enumPolygon&&u!==s.GeometryType.enumEnvelope&&(l=We(l)),g){case s.GeometryType.enumPolygon:switch(u){case s.GeometryType.enumPolygon:_=function(e,t,s,n,r){switch(n){case 4:return function(e,t,s){return $e(e,t,0,!0),1===Dt(e,t,s,!0)}(e,t,s);case 2:return ht(t,e,s,r);case 128:return gt(t,e,s);case 1:return ht(e,t,s,r);case 64:return gt(e,t,s);case 3:return lt(e,t,s,r);case 8:return function(e,t,s){return $e(e,t),Bt(e,t,s,null)}(e,t,s);case 32:return function(e,t,s,n){return $e(e,t),qt(e,t,s,n)}(e,t,s,r)}return!1}(x,P,d,l,h);break;case s.GeometryType.enumPolyline:_=et(x,P,d,l,h);break;case s.GeometryType.enumPoint:_=tt(x,P,d,l);break;case s.GeometryType.enumMultiPoint:_=st(x,P,d,l);break;case s.GeometryType.enumEnvelope:_=nt(x,P,d,l,h)}break;case s.GeometryType.enumPolyline:switch(u){case s.GeometryType.enumPolygon:_=et(P,x,d,l,h);break;case s.GeometryType.enumPolyline:_=function(e,s,r,i,o){switch(i){case 4:return function(e,t,s){$e(e,t);const n=e.getImpl(),r=t.getImpl();return!new ze(n,r,s,!0).next()||!Rt(e,t,s)}(e,s,r);case 2:return _t(s,e,r,o);case 128:return ft(s,e,r,o);case 1:return _t(e,s,r,o);case 64:return ft(e,s,r,o);case 3:return function(e,s,n,r){const i=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty();return e.queryEnvelope(i),s.queryEnvelope(o),!!vt(i,o,n)&&($e(e,s),!!Ht(e,s,n)||(e.hasNonLinearSegments()||s.hasNonLinearSegments()?He(e,s,n,"**F**FFF*",r,!1):Ft(e,s,n,!1)))}(e,s,r,o);case 8:return function(e,s,r,i){$e(e,s);const o=[],a=kt(e,s,r,o);if(-2===a){const n=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty(),a=t.Envelope2D.constructEmpty();let l,h;if(e.queryEnvelope(n),s.queryEnvelope(o),n.inflateCoords(1e3*r,1e3*r),o.inflateCoords(1e3*r,1e3*r),a.setCoords({env2D:n}),a.intersect(o),e.getPointCount()>10){if(l=m.clip$1(e,a,r,0,i),l.isEmpty())return!1}else l=e;if(s.getPointCount()>10){if(h=m.clip$1(s,a,r,0,i),h.isEmpty())return!1}else h=s;return He(l,h,r,"F********",i,!1)}if(0!==a)return!1;const l=new n.MultiPoint;for(let e=0;e<o.length;e+=2){const t=o[e],s=o[e+1];l.addXY(t,s)}const h=e.getBoundary(),g=s.getBoundary();return h.addPoints(g,0,g.getPointCount()),!h.isEmpty()&&xt(h,l,r)}(e,s,r,o);case 32:return function(e,s,n,r){$e(e,s);const i=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty();e.queryEnvelope(i),s.queryEnvelope(o);const a=Nt(i,o,n),l=Nt(o,i,n),h=e.hasNonLinearSegments(),g=s.hasNonLinearSegments(),u=kt(e,s,n,null);if(-1===u)return!1;if(1===u){if(a&&l)return!0;if(!h&&!g)return a&&!l?!Vt(s,e,n,!1):l&&!a?!Vt(e,s,n,!1):!Vt(e,s,n,!1)&&!Vt(s,e,n,!1)}const c=t.Envelope2D.constructEmpty(),p=t.Envelope2D.constructEmpty(),d=t.Envelope2D.constructEmpty();let _,f;c.setCoords({env2D:i}),c.inflateCoords(1e3*n,1e3*n),p.setCoords({env2D:o}),p.inflateCoords(1e3*n,1e3*n),d.setCoords({env2D:c}),d.intersect(p);let y="";if(y+="1*",a){if(s.getPointCount()>10){if(f=m.clip$1(s,d,n,0,r),f.isEmpty())return!1}else f=s;y+="****"}else f=s,y+="T***";if(l){if(e.getPointCount()>10){if(_=m.clip$1(e,d,n,0,r),_.isEmpty())return!1}else _=e;y+="***"}else _=e,y+="T**";return He(_,f,n,y,r,!1)}(e,s,r,o);case 16:return function(e,s,r,i){$e(e,s);const o=[],a=kt(e,s,r,o);if(-2===a){const n=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty(),a=t.Envelope2D.constructEmpty();let l,h;if(e.queryEnvelope(n),s.queryEnvelope(o),n.inflateCoords(1e3*r,1e3*r),o.inflateCoords(1e3*r,1e3*r),a.setCoords({env2D:n}),a.intersect(o),e.getPointCount()>10){if(l=m.clip$1(e,a,r,0,i),l.isEmpty())return!1}else l=e;if(s.getPointCount()>10){if(h=m.clip$1(s,a,r,0,i),h.isEmpty())return!1}else h=s;return He(l,h,r,"0********",i,!1)}if(0!==a)return!1;const l=new n.MultiPoint;for(let e=0;e<o.length;e+=2){const t=o[e],s=o[e+1];l.addXY(t,s)}const h=e.getBoundary(),g=s.getBoundary();return h.addPoints(g,0,g.getPointCount()),!!h.isEmpty()||!xt(h,l,r)}(e,s,r,o)}return!1}(x,P,d,l,h);break;case s.GeometryType.enumPoint:_=rt(x,P,d,l);break;case s.GeometryType.enumMultiPoint:_=it(x,P,d,l);break;case s.GeometryType.enumEnvelope:_=ot(x,P,d,l,h)}break;case s.GeometryType.enumPoint:switch(u){case s.GeometryType.enumPolygon:_=tt(P,x,d,l);break;case s.GeometryType.enumPolyline:_=rt(P,x,d,l);break;case s.GeometryType.enumMultiPoint:_=at(P,x,d,l)}break;case s.GeometryType.enumMultiPoint:switch(u){case s.GeometryType.enumPolygon:_=st(P,x,d,l);break;case s.GeometryType.enumPolyline:_=it(P,x,d,l);break;case s.GeometryType.enumMultiPoint:_=function(e,s,n,r){switch(r){case 4:return function(e,t,s){const n=e,r=t,o=new ze(n,r,s,!1),a=s*s,m=new i.Point2D,l=new i.Point2D;for(;o.next();){const e=o.getRedElement(),t=o.getBlueElement();if(n.queryXY(e,m),r.queryXY(t,l),i.Point2D.sqrDistance(m,l)<=a)return!1}return!0}(e,s,n);case 2:case 128:return xt(s,e,n);case 1:case 64:return xt(e,s,n);case 3:return function(e,s,n){const r=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty();return e.queryEnvelope(r),s.queryEnvelope(o),!!vt(r,o,n)&&(!!function(e,t,s){if(e.getPointCount()!==t.getPointCount())return!1;const n=new i.Point2D,r=new i.Point2D;let o=!0;const a=s*s;for(let s=0;s<e.getPointCount();s++)if(e.queryXY(s,n),t.queryXY(s,r),i.Point2D.sqrDistance(n,r)>a){o=!1;break}return!!o}(e,s,n)||At(e,s,n,!1,!0,!1))}(e,s,n);case 32:return function(e,t,s){return At(e,t,s,!1,!1,!0)}(e,s,n)}return!1}(x,P,d,l);break;case s.GeometryType.enumPoint:_=at(x,P,d,l);break;case s.GeometryType.enumEnvelope:_=mt(x,P,d,l)}break;case s.GeometryType.enumEnvelope:switch(u){case s.GeometryType.enumPolygon:_=nt(P,x,d,l,h);break;case s.GeometryType.enumPolyline:_=ot(P,x,d,l,h);break;case s.GeometryType.enumMultiPoint:_=mt(P,x,d,l)}}return _}function Qe(e,s,n,i,o){if(e.isEmpty()||s.isEmpty())return 4===i;const a=e.getXY(),m=t.Envelope2D.constructEmpty();s.queryEnvelope(m);const l=function(e,s,n){let i;if(e instanceof ji||null===e){const o=t.Envelope2D.constructEmpty();o.setCoords({pt:s}),o.mergeEnvelope2D(n),i=r.calculateToleranceFromGeometryForRel(e,o,!1)}else i=e;return i}(n,a,m);switch(i){case 4:return Je(a,m,l);case 2:case 128:return function(e,s,n){if(s.height()<=n||s.width()<=n)return!1;const r=t.Envelope2D.constructEmpty();return r.setCoords({env2D:s}),r.inflateCoords(-n,-n),r.containsExclusive(e)}(a,m,l);case 1:case 64:return!1;case 3:return function(e,s,n){const r=new t.Envelope2D;return r.setCoords({pt:e}),vt(r,s,n)}(a,m,l);case 8:return function(e,s,n){if(s.height()<=n||s.width()<=n)return!1;const r=new t.Envelope2D,i=new t.Envelope2D;return r.setCoords({env2D:s}),r.inflateCoords(n,n),!!r.contains(e)&&(i.setCoords({env2D:s}),i.inflateCoords(-n,-n),!i.containsExclusive(e))}(a,m,l)}return!1}function Ke(e,s,n){const r=t.Envelope2D.constructEmpty();return r.setCoords({env2D:s}),r.inflateCoords(n,n),!e.isIntersecting(r)}function $e(e,t,n,r=!1){const i=e.getGeometryType(),o=t.getGeometryType();if(s.isMultiVertex(i)){const t=e.getImpl().getAccelerators();if(null!==t){const e=t.getRasterizedGeometry();s.geometryReleaseAssert(null===e)}}if(s.isMultiVertex(o)){const e=t.getImpl().getAccelerators();if(null!==e){const t=e.getRasterizedGeometry();s.geometryReleaseAssert(null===t)}}return 0}function Je(e,s,n,r){const i=t.Envelope2D.constructEmpty();return i.setCoords({env2D:s}),i.inflateCoords(n,n),!i.contains(e)}function et(e,s,o,a,l){switch(a){case 4:return function(e,t,s){return $e(e,t,0,!0),1===Dt(e,t,s,!0)}(e,s,o);case 1:return function(e,s,i,o){const a=t.Envelope2D.constructEmpty(),l=t.Envelope2D.constructEmpty();return e.queryEnvelope(a),s.queryEnvelope(l),!!bt(a,l,i)&&($e(e,s),function(e,s,i,o){const a=[!1],l=wt(e,s,i,a);if(a[0])return l;const h=t.Envelope2D.constructEmpty();let g;if(s.queryEnvelope(h),h.inflateCoords(1e3*i,1e3*i),e.getPointCount()>10){if(g=m.clip$1(e,h,i,0,o),g.isEmpty())return!1}else g=e;return function(e,s,i,o){const a=new qe;a.resetMatrix_(),a.setPredicates_("T*****F**"),a.setAreaLinePredicates_();const m=t.Envelope2D.constructEmpty(),l=t.Envelope2D.constructEmpty();e.queryEnvelope(m),s.queryEnvelope(l);let h=!1;if(Ke(m,l,i)&&(a.areaLineDisjointPredicates_(e,s),h=!0),h||$e(e,s),h)return Oe(a.m_matrix,a.m_scl);const g=new n.EditShape,u=g.addGeometry(e),c=g.addGeometry(s);return a.setEditShapeCrackAndCluster_(g,new r.CombinedTolerance(i,0),o),0!==g.getPointCount(u)&&(a.computeMatrixTopoGraphHalfEdges_(u,c),a.m_topoGraph.removeShape(),Oe(a.m_matrix,a.m_scl))}(g,s,i,o)}(e,s,i,o))}(e,s,o,l);case 64:return function(e,s,n){const r=t.Envelope2D.constructEmpty(),i=t.Envelope2D.constructEmpty();return e.queryEnvelope(r),s.queryEnvelope(i),!!bt(r,i,n)&&($e(e,s),2===Dt(e,s,n,!1))}(e,s,o);case 8:return ut(e,s,o,l);case 16:return function(e,s,n){return $e(e,s),function(e,s,n,r){const o=e.getImpl(),a=s.getImpl(),l=o.querySegmentIterator(),h=a.querySegmentIterator(),g=i.makePrimitiveArray(2,Number.NaN),u=i.makePrimitiveArray(2,Number.NaN),c=new ze(o,a,n);let p=!1;for(;c.next();){const e=c.getRedElement(),t=c.getBlueElement();l.resetToVertex(e,-1),h.resetToVertex(t,-1);const s=l.nextSegment(),r=h.nextSegment();let i=0;if(zt(s,r)?!p&&r.isIntersecting(s,n)&&(p=!0):i=r.intersect(s,null,u,g,n),2===i)p=!0;else if(i){const e=g[0],t=u[0];if(e>0&&e<1&&t>0&&t<1)return!0;p=!0}}if(!p)return!1;const d=t.Envelope2D.constructEmpty(),_=t.Envelope2D.constructEmpty(),f=t.Envelope2D.constructEmpty(),y=t.Envelope2D.constructEmpty(),x=t.Envelope2D.constructEmpty();if(e.queryEnvelope(d),s.queryEnvelope(_),Nt(_,d,n)){let t,i;if(f.setCoords({env2D:d}),f.inflateCoords(1e3*n,1e3*n),y.setCoords({env2D:_}),y.inflateCoords(1e3*n,1e3*n),x.setCoords({env2D:f}),x.intersect(y),e.getPointCount()>10){if(t=m.clip$1(e,x,n,0,r),t.isEmpty())return!1}else t=e;if(s.getPointCount()>10){if(i=m.clip$1(s,x,n,0,r),i.isEmpty())return!1}else i=s;return He(t,i,n,"T********",r,!1)}return He(e,s,n,"T*****T**",r,!1)}(e,s,n,null)}(e,s,o)}return!1}function tt(e,t,s,n,r){switch(n){case 4:return function(e,t,s){return 0===Zt(e,t,s)}(e,t,s);case 1:case 64:return function(e,t,s){return function(e,t,s){return 1===Qt(e,t,s)}(e,t.getXY(),s)}(e,t,s);case 8:return function(e,t,s){return function(e,t,s){return 2===Qt(e,t,s)}(e,t.getXY(),s)}(e,t,s)}return!1}function st(e,s,r,o,a){switch(o){case 4:return function(e,s,r){$e(e,s);const o=function(e,s,r){const o=t.Envelope2D.constructEmpty();e.queryEnvelope(o),o.inflateCoords(r,r);const a=new i.Point2D,m=e.getImpl(),l=new n.Polygon;let h=e,g=!1,u=!1,c=!1;for(let t=0;t<s.getPointCount();t++){if(s.queryXY(t,a),o.contains(a)){const e=Qt(h,a,r);if(1===e)return u=!0,4;if(2===e)return 4;c=!0}else c=!0;g||(!ve(e,s.getPointCount()-1)||null!==m.getAccelerators()&&null!=m.getAccelerators().getQuadTree()?h=e:(e.copyTo(l),l.getImpl().buildQuadTreeAccelerator(1),h=l),g=!0)}return u?c?4:2:1}(e,s,r);return 1===o}(e,s,r);case 1:return ct(e,s,r,!1);case 64:return ct(e,s,r,!0);case 8:return function(e,s,r){$e(e,s);const o=t.Envelope2D.constructEmpty();e.queryEnvelope(o),o.inflateCoords(r,r);const a=new i.Point2D;let m=!1;const l=e.getImpl(),h=new n.Polygon;let g=e,u=!1;for(let t=0;t<s.getPointCount();t++){if(s.queryXY(t,a),o.contains(a)){const e=Qt(g,a,r);if(2===e)m=!0;else if(1===e)return!1}u||(!ve(e,s.getPointCount()-1)||null!==l.getAccelerators()&&null!==l.getAccelerators().getQuadTree()?g=e:(e.copyTo(h),h.getImpl().buildQuadTreeAccelerator(1),g=h),u=!0)}return!!m}(e,s,r);case 16:return function(e,s,r){$e(e,s);const o=new t.Envelope2D,a=new t.Envelope2D,m=new t.Envelope2D;e.queryEnvelope(o),s.queryEnvelope(m),a.setCoords({env2D:o}),a.inflateCoords(r,r);let l=!1,h=!1;const g=new i.Point2D,u=e.getImpl(),c=new n.Polygon;let p=e,d=!1;for(let t=0;t<s.getPointCount();t++){if(s.queryXY(t,g),a.contains(g)){const e=Qt(p,g,r);0===e?h=!0:1===e&&(l=!0)}else h=!0;if(l&&h)return!0;d||(!ve(e,s.getPointCount()-1)||null!==u.getAccelerators()&&null!==u.getAccelerators().getQuadTree()?p=e:(e.copyTo(c),c.getImpl().buildQuadTreeAccelerator(1),p=c),d=!0)}return!1}(e,s,r)}return!1}function nt(e,s,r,i,o){if(function(e,s,n){$e(e,s);const r=t.Envelope2D.constructEmpty(),i=t.Envelope2D.constructEmpty();return e.queryEnvelope(r),s.queryEnvelope(i),!bt(i,r,n)&&(0===Qt(e,i.getLowerLeft(),0)&&!i.contains(e.getXY(0))&&!Ot(e,i,n))}(e,s,r))return 4===i;if(4===i)return!1;switch(i){case 2:return pt(e,s,r,!1);case 128:return pt(e,s,r,!0);case 1:return dt(e,s,r,!1,o);case 64:return dt(e,s,r,!0,o);case 3:return function(e,s,r,i){const o=new t.Envelope2D,a=new t.Envelope2D;if(e.queryEnvelope(o),s.queryEnvelope(a),!vt(o,a,r))return!1;const m=new n.Polygon;return m.addEnvelope(s,!1),lt(e,m,r,i)}(e,s,r,o);case 8:return function(e,s,r,i){$e(e,s);const o=new t.Envelope2D,a=new t.Envelope2D;if(e.queryEnvelope(o),s.queryEnvelope(a),bt(a,o,r))return!1;if(a.height()<=r||a.width()<=r)return!1;const m=new n.Polygon;return m.addEnvelope(s,!1),Bt(e,m,r,i)}(e,s,r,o);case 32:return function(e,s,r,i){$e(e,s);const o=new t.Envelope2D,a=new t.Envelope2D;if(e.queryEnvelope(o),s.queryEnvelope(a),bt(a,o,r))return!1;if(a.height()<=r||a.width()<=r)return!1;const m=new n.Polygon;return m.addEnvelope(s,!1),qt(e,m,r,i)}(e,s,r,o);case 16:return!1}return!1}function rt(e,t,s,n,r){switch(n){case 4:return function(e,t,s){return $e(e,t),!Ut(e,t.getXY(),s)}(e,t,s);case 1:case 64:return function(e,t,s){return $e(e,t),function(e,t,s){return Ut(e,t,s)&&!Lt(e,t,s)}(e,t.getXY(),s)}(e,t,s);case 8:return function(e,t,s){return $e(e,t),Lt(e,t.getXY(),s)}(e,t,s)}return!1}function it(e,s,r,o,a){switch(o){case 4:return function(e,t,s){return $e(e,t),!Mt(e,t,s,!1)}(e,s,r);case 1:case 64:return function(e,s,n){const r=t.Envelope2D.constructEmpty(),i=t.Envelope2D.constructEmpty();if(e.queryEnvelope(r),s.queryEnvelope(i),!bt(r,i,n))return!1;$e(e,s);const o=Mt(e,s,n,!0);if(!o)return o;const a=e.getBoundary();return a.isEmpty()?o:!xt(a,s,n)}(e,s,r);case 8:return function(e,t,s){$e(e,t);const r=e.getImpl(),i=t.getImpl(),o=new n.MultiPoint,a=new ze(r,i,s,!1),m=r.querySegmentIterator();let l=!1;for(;a.next();){const e=a.getRedElement(),t=a.getBlueElement();m.resetToVertex(e,-1);const n=m.nextSegment(),r=i.getXY(t);n.isIntersectingPoint(r,s)&&(l=!0,o.addPoint2D(r))}if(!l)return!1;const h=e.getBoundary();return!h.isEmpty()&&xt(h,o,s)}(e,s,r);case 16:return function(e,t,s){$e(e,t);const r=e.getImpl(),o=t.getImpl(),a=o.getPointCount(),m=i.makePrimitiveArray(a,!1),l=new ze(r,o,s,!1),h=r.querySegmentIterator();let g=!1;for(;l.next();){const e=l.getRedElement(),t=l.getBlueElement();h.resetToVertex(e,-1);const n=h.nextSegment(),r=o.getXY(t);n.isIntersectingPoint(r,s)&&(g=!0,m[t]=!0)}if(!g)return!1;let u=!1;for(let e=0;e<a;e++)if(!m[e]){u=!0;break}if(!u)return!1;const c=e.getBoundary();if(c.isEmpty())return!0;const p=new n.MultiPoint;for(let e=0;e<a;e++)m[e]&&p.addPoint2D(o.getXY(e));return!xt(c,p,s)}(e,s,r)}return!1}function ot(e,r,o,a,m){if(function(e,s,n){const r=t.Envelope2D.constructEmpty(),i=t.Envelope2D.constructEmpty();e.queryEnvelope(r),s.queryEnvelope(i);const o=function(e,s,n){const r=t.Envelope2D.constructEmpty();return r.setCoords({env2D:e}),r.inflateCoords(n,n),r.containsEnvelope(s)?1073741824:r.isIntersecting(s)?e.isIntersecting(s)?e.xmin<s.xmin&&s.xmax<e.xmax?s.ymin<e.ymin&&s.ymax>e.ymax?0:1073741824:e.ymin<s.ymin&&s.ymax<e.ymax?s.xmin<e.xmin&&s.xmax>e.xmax?0:1073741824:0:0:4}(i,r,n);return 0===o?!Ot(e,i,n):4===o}(e,r,o))return 4===a;if(4===a)return!1;switch(a){case 2:return yt(e,r,o,!1);case 128:return yt(e,r,o,!0);case 1:case 64:case 32:return!1;case 3:return function(e,s,n){const r=new t.Envelope2D,i=new t.Envelope2D;return e.queryEnvelope(r),s.queryEnvelope(i),!(i.height()>n&&i.width()>n)&&vt(r,i,n)}(e,r,o);case 8:return function(e,r,o,a){const m=new t.Envelope2D,l=new t.Envelope2D;if(e.queryEnvelope(m),r.queryEnvelope(l),l.height()<=o||l.width()<=o)return!1;const h=new t.Envelope2D,g=new t.Envelope2D;if(h.setCoords({env2D:l}),g.setCoords({env2D:l}),h.inflateCoords(o,o),g.inflateCoords(-o,-o),g.containsEnvelope(m)||!m.isIntersecting(h))return!1;const u=e.getImpl().querySegmentIterator();u.stripAttributes();const c=e.getImpl().getAccelerators();let p=null,d=null;null!==c&&(p=c.getQuadTree(),null!==p&&(d=p.getIterator(l,o))),d||u.nextPath()||s.throwInternalErrorException("relational_operations");let _=!1,f=null;const y=new i.Point2D,x=new i.Point2D,P=e.hasNonLinearSegments();let E=!1;for(;;){if(null!==d){const e=d.next();if(-1===e)break;u.resetToVertex(p.getElement(e),-1),f=u.nextSegment()}else{for(;!u.hasNextSegment()&&u.nextPath(););if(!u.hasNextSegment())break;f=u.nextSegment()}if(P&&f.getGeometryType()!==s.GeometryType.enumLine){const e=new t.Envelope2D;if(f.queryEnvelope(e),g.containsEnvelope(e))return!1;if(h.isIntersecting(e)){E=!0;break}}else{y.assign(f.getStartXY()),x.assign(f.getEndXY());let e=g.clipLine(y,x);if(0!==e)return!1;_||(e=h.clipLine(y,x),0!==e&&(_=!0))}}if(!E)return _;const S=new n.Polygon;return S.addEnvelope(l,!1),ut(S,e,o,a)}(e,r,o,m);case 16:return function(e,r,o){const a=new t.Envelope2D,m=new t.Envelope2D;if(e.queryEnvelope(a),r.queryEnvelope(m),m.height()<=o||m.width()<=o)return!1;const l=new t.Envelope2D;if(l.setCoords({env2D:m}),l.inflateCoords(o,o),l.containsEnvelope(a))return!1;const h=new t.Envelope2D;if(h.setCoords({env2D:m}),h.inflateCoords(-o,-o),!h.isIntersecting(a))return!1;const g=e.getImpl().querySegmentIterator();g.stripAttributes();const u=e.getImpl().getAccelerators();let c=null,p=null;if(null!==u&&(c=u.getQuadTree(),null!==c&&(p=c.getIterator(m,o))),!p){const e=g.nextPath();s.geometryReleaseAssert(e)}let d=!1,_=null;const f=new i.Point2D,y=new i.Point2D;let x=null,P=null,E=null,S=null;for(e.hasNonLinearSegments()&&(x=new n.Line,P=new n.Line,E=new n.Line,S=new n.Line,h.querySide(0,x),h.querySide(1,P),h.querySide(2,E),h.querySide(3,S));;){if(null!==p){const e=p.next();if(-1===e)break;g.resetToVertex(c.getElement(e),-1),_=g.nextSegment()}else{for(;!g.hasNextSegment()&&g.nextPath(););if(!g.hasNextSegment())break;_=g.nextSegment()}if(_.getGeometryType()===s.GeometryType.enumLine){if(f.assign(_.getStartXY()),y.assign(_.getEndXY()),0!==h.clipLine(f,y)){d=!0;break}}else{if(x.isIntersecting(_,o)){d=!0;break}if(P.isIntersecting(_,o)){d=!0;break}if(E.isIntersecting(_,o)){d=!0;break}if(S.isIntersecting(_,o)){d=!0;break}}}return d&&!0}(e,r,o)}return!1}function at(e,t,s,n,r){switch(n){case 4:return Et(e,t,s);case 2:case 128:return function(e,t,s){return Pt(e,t,s)}(e,t,s);case 1:case 64:return function(e,t,s){return!Et(e,t,s)}(e,t,s);case 3:return Pt(e,t,s)}return!1}function mt(e,s,n,r,o){switch(r){case 4:return function(e,s,n){const r=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty();if(e.queryEnvelope(r),s.queryEnvelope(o),bt(o,r,n))return!1;const a=t.Envelope2D.constructEmpty();a.setCoords({env2D:o}),a.inflateCoords(n,n);const m=new i.Point2D;for(let t=0;t<e.getPointCount();t++)if(e.queryXY(t,m),a.contains(m))return!1;return!0}(e,s,n);case 2:return St(e,s,n,!1);case 128:return St(e,s,n,!0);case 1:case 64:return!1;case 3:return function(e,s,n){const r=new t.Envelope2D,i=new t.Envelope2D;return e.queryEnvelope(r),s.queryEnvelope(i),!(i.height()>n||i.width()>n)&&vt(r,i,n)}(e,s,n);case 8:return function(e,s,n){const r=new t.Envelope2D,o=new t.Envelope2D,a=new t.Envelope2D;if(s.queryEnvelope(r),r.height()<=n||r.width()<=n)return!1;o.setCoords({env2D:r}),a.setCoords({env2D:r}),o.inflateCoords(n,n),a.inflateCoords(-n,-n);const m=new i.Point2D;let l=!1;for(let t=0;t<e.getPointCount();t++)if(e.queryXY(t,m),o.contains(m)){if(a.containsExclusive(m))return!1;l=!0}return l}(e,s,n);case 16:return function(e,s,n){const r=new t.Envelope2D,o=new t.Envelope2D;if(e.queryEnvelope(r),s.queryEnvelope(o),bt(o,r,n))return!1;if(o.height()<=n||o.width()<=n)return!1;const a=new t.Envelope2D,m=new t.Envelope2D;a.setCoords({env2D:o}),a.inflateCoords(-n,-n),m.setCoords({env2D:o}),m.inflateCoords(n,n);const l=new i.Point2D;let h=!1,g=!1;for(let t=0;t<e.getPointCount();t++)if(e.queryXY(t,l),!h&&a.containsExclusive(l)&&(h=!0),g||m.contains(l)||(g=!0),h&&g)return!0;return!1}(e,s,n)}return!1}function lt(e,s,n,r){const i=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty();if(e.queryEnvelope(i),s.queryEnvelope(o),!vt(i,o,n))return!1;if($e(e,s),Ht(e,s,n))return!0;const a=e.calculateLength2D(),m=s.calculateLength2D(),l=Math.max(e.getPointCount(),s.getPointCount());return!(Math.abs(a-m)>4*l*n)&&(e.hasNonLinearSegments()||s.hasNonLinearSegments()?He(e,s,n,"**F**FFF*",r,!1):Ft(e,s,n,!0))}function ht(e,s,n,r){const i=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty();return e.queryEnvelope(i),s.queryEnvelope(o),!!bt(i,o,n)&&($e(e,s),Yt(e,s,n,r))}function gt(e,s,n,r){const i=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty();return e.queryEnvelope(i),s.queryEnvelope(o),!!bt(i,o,n)&&($e(e,s),2===Dt(e,s,n,!1))}function ut(e,s,n,r){return $e(e,s),function(e,s,n,r){const o=e.getImpl(),a=s.getImpl(),l=o.querySegmentIterator(),h=a.querySegmentIterator(),g=i.makePrimitiveArray(2,Number.NaN),u=i.makePrimitiveArray(2,Number.NaN),c=new ze(o,a,n);let p=!1;for(;c.next();){const e=c.getRedElement(),t=c.getBlueElement();l.resetToVertex(e,-1),h.resetToVertex(t,-1);const s=l.nextSegment(),r=h.nextSegment();let i=0;if(zt(s,r)?!p&&r.isIntersecting(s,n)&&(p=!0):i=r.intersect(s,null,u,g,n),2===i)p=!0;else if(i){const e=g[0],t=u[0];if(e>0&&e<1&&t>0&&t<1)return!1;p=!0}}if(!p)return!1;const d=t.Envelope2D.constructEmpty(),_=t.Envelope2D.constructEmpty(),f=t.Envelope2D.constructEmpty();let y,x;if(e.queryEnvelope(d),s.queryEnvelope(_),d.inflateCoords(1e3*n,1e3*n),_.inflateCoords(1e3*n,1e3*n),f.setCoords({env2D:d}),f.intersect(_),e.getPointCount()>10){if(y=m.clip$1(e,f,n,0,r),y.isEmpty())return!1}else y=e;if(s.getPointCount()>10){if(x=m.clip$1(s,f,n,0,r),x.isEmpty())return!1}else x=s;return He(y,x,n,"F********",r,!1)}(e,s,n,r)}function ct(e,s,r,o,a){const m=t.Envelope2D.constructEmpty(),l=t.Envelope2D.constructEmpty();if(e.queryEnvelope(m),s.queryEnvelope(l),!bt(m,l,r))return!1;$e(e,s);let h=!1;const g=new i.Point2D,u=e.getImpl(),c=new n.Polygon;let p=e,d=!1;for(let t=0;t<s.getPointCount();t++){if(s.queryXY(t,g),!m.contains(g))return!1;const n=Qt(p,g,r);if(1===n)h=!0;else if(0===n)return!1;if(o&&2===n)return!1;d||(!ve(e,s.getPointCount()-1)||null!==u.getAccelerators()&&null!==u.getAccelerators().getQuadTree()?p=e:(e.copyTo(c),c.getImpl().buildQuadTreeAccelerator(1),p=c),d=!0)}return h}function pt(e,s,n,r,i){const o=t.Envelope2D.constructEmpty(),a=t.Envelope2D.constructEmpty();return e.queryEnvelope(o),s.queryEnvelope(a),r?Gt(a,o,n):bt(a,o,n)}function dt(e,s,r,i,o){const a=t.Envelope2D.constructEmpty(),m=t.Envelope2D.constructEmpty();if(e.queryEnvelope(a),s.queryEnvelope(m),!bt(a,m,r))return!1;$e(e,s);const l=new n.Polygon;return l.addEnvelope(s,!1),i?2===Dt(e,l,r,!1):Yt(e,l,r,o)}function _t(e,s,n,r){const i=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty();return e.queryEnvelope(i),s.queryEnvelope(o),!!bt(i,o,n)&&($e(e,s),e.hasNonLinearSegments()||s.hasNonLinearSegments()?He(e,s,n,"******FF*",r,!1):Vt(s,e,n,!1))}function ft(e,s,n,r){const i=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty();return e.queryEnvelope(i),s.queryEnvelope(o),!!bt(i,o,n)&&($e(e,s),He(e,s,n,"T**FF*FF*",r,!1))}function yt(e,r,i,o,a){const m=t.Envelope2D.constructEmpty(),l=t.Envelope2D.constructEmpty();if(e.queryEnvelope(m),r.queryEnvelope(l),l.height()<=i||l.width()<=i)return!1;if(o)return Gt(l,m,i);if(!bt(l,m,i))return!1;const h=t.Envelope2D.constructEmpty();h.setCoords({env2D:l}),h.inflateCoords(-i,-i);const g=t.Envelope2D.constructEmpty();if(g.setCoords({env2D:l}),g.inflateCoords(i,i),h.containsEnvelope(m))return!0;const u=e.getImpl().querySegmentIterator();u.stripAttributes(),u.nextPath()||s.throwInternalErrorException("relational_operations");let c,p,d,_,f,y,x=!1;const P=e.hasNonLinearSegments();for(P&&(d=new n.Line,_=new n.Line,f=new n.Line,y=new n.Line,h.querySide(0,d),h.querySide(1,_),h.querySide(2,f),h.querySide(3,y));;){for(;!u.hasNextSegment()&&u.nextPath(););if(!u.hasNextSegment())break;const e=u.nextSegment();if(P&&e.getGeometryType()!==s.GeometryType.enumLine){if(e.isIntersecting(d,i)){x=!0;break}if(e.isIntersecting(_,i)){x=!0;break}if(e.isIntersecting(f,i)){x=!0;break}if(e.isIntersecting(y,i)){x=!0;break}}else if(c=e.getStartXY(),p=e.getEndXY(),0!==h.clipLine(c,p)){x=!0;break}}return x}function xt(e,s,n,r){const i=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty();return e.queryEnvelope(i),s.queryEnvelope(o),!!bt(i,o,n)&&At(s,e,n,!0,!1,!1)}function Pt(e,s,n,r){const i=t.Envelope2D.constructEmpty(),o=t.Envelope2D.constructEmpty();return e.queryEnvelope(i),s.queryEnvelope(o),vt(i,o,n)}function Et(e,t,s,n){return Xt(e,t.getXY(),s)}function St(e,s,n,r,o){const a=t.Envelope2D.constructEmpty(),m=t.Envelope2D.constructEmpty();if(e.queryEnvelope(a),s.queryEnvelope(m),m.height()<=n||m.width()<=n)return!1;if(r)return Gt(m,a,n);if(!bt(m,a,n))return!1;let l=!1;const h=t.Envelope2D.constructEmpty(),g=t.Envelope2D.constructEmpty();h.setCoords({env2D:m}),g.setCoords({env2D:m}),h.inflateCoords(-n,-n),g.inflateCoords(n,n);const u=new i.Point2D;for(let t=0;t<e.getPointCount();t++){if(e.queryXY(t,u),!g.contains(u))return!1;h.containsExclusive(u)&&(l=!0)}return l}function Ct(e,t,s,n){return i.Point2D.sqrDistance(e,t)<=s*s}function It(e,t,s,n){return Ct(e,t,s)}function vt(e,t,s,n){return bt(e,t,s)&&bt(t,e,s)}function Tt(e,s,n,r,i){if(e.height()<=n||e.width()<=n)return!1;if(r)return Gt(e,s,n);if(!bt(e,s,n))return!1;const o=t.Envelope2D.constructEmpty();return o.setCoords({env2D:e}),o.inflateCoords(-n,-n),o.intersect(s),!o.isEmpty()}function Dt(e,r,o,a,m){const l=new i.Point2D,h=new i.Point2D,g=t.Envelope2D.constructEmpty(),u=t.Envelope2D.constructEmpty(),c=e.getImpl(),p=r.getImpl(),d=p.getGeometryType(),_=new ze(c,p,o,!0);if(!_.next())return 1;if(Rt(e,r,o))return a?4:0;const f=new n.Polygon;let y=e;const x=new n.Polygon;let P=null;d===s.GeometryType.enumPolygon&&(P=r);const E=d===s.GeometryType.enumPolygon?i.makePrimitiveArray(c.getPathCount(),!1):[],S=i.makePrimitiveArray(p.getPathCount(),!1);let C=!1,I=!1,v=!1,T=!1,D=!1,w=!1;do{if(v&&D||T&&w)break;if(v&&T)break;const t=_.getRedElement(),n=_.getBlueElement();if(!S[n]&&(h.assign(r.getXY(r.getPathStart(n))),g.setCoords({env2D:_.getRedEnvelope()}),g.inflateCoords(o,o),g.contains(h))){if(0!==Qt(y,h,0)){if(T=!0,a)return 4}else w=!0;S[n]=!0}if(d===s.GeometryType.enumPolygon&&!E[t]&&(l.assign(e.getXY(e.getPathStart(t))),u.setCoords({env2D:_.getBlueEnvelope()}),u.inflateCoords(o,o),u.contains(l))){if(0!==Qt(P,l,0)){if(v=!0,a)return 4}else D=!0;E[t]=!0}if(C||(!ve(e,r.getPathCount()-1)||null!==c.getAccelerators()&&null!==c.getAccelerators().getQuadTree()?y=e:(e.copyTo(f),f.getImpl().buildQuadTreeAccelerator(1),y=f),C=!0),d===s.GeometryType.enumPolygon&&!I){const t=r;!ve(t,e.getPathCount()-1)||null!==p.getAccelerators()&&null!==p.getAccelerators().getQuadTree()?P=r:(t.copyTo(x),x.getImpl().buildQuadTreeAccelerator(1),P=x),I=!0}}while(_.next());if(!v&&!T)return 1;if(!D||!w){if(d===s.GeometryType.enumPolygon)for(let e=0,t=c.getPathCount();e<t;e++)if(!E[e]){D=!0;break}for(let e=0,t=p.getPathCount();e<t;e++)if(!S[e]){w=!0;break}}return v&&D||T&&w||v&&T?4:T?2:3}function wt(e,r,i,o,a){o[0]=!1;const m=e.getImpl(),l=r.getImpl(),h=m.querySegmentIterator(),g=l.querySegmentIterator(),u=[0,0],c=[0,0],p=new ze(m,l,i);let d=!1;for(;p.next();){const e=p.getRedElement(),t=p.getBlueElement();h.resetToVertex(e,-1),g.resetToVertex(t,-1);const s=h.nextSegment(),n=g.nextSegment();let r=0;if(zt(s,n)?!d&&n.isIntersecting(s,i)&&(d=!0):r=n.intersect(s,null,c,u,i),0!==r&&(d=!0,1===r)){const e=u[0],t=c[0];if(e>0&&e<1&&t>0&&t<1)return o[0]=!0,!1}}if(!d){o[0]=!0;const a=t.Envelope2D.constructEmpty();e.queryEnvelope(a),a.inflateCoords(i,i);const h=new n.Polygon;let g=e,u=!1;for(let n=0,i=r.getPathCount();n<i;n++)if(r.getPathSize(n)>0){const i=t.Envelope2D.constructEmpty();if(r.queryPathEnvelope(n,i),!a.isIntersecting(i))return!1;{const e=Ie(g,r.getXY(r.getPathStart(n)),0);if(s.geometryReleaseAssert(-1!==e),0===e)return!1}u||(!ve(e,r.getPathCount()-1)||null!==m.getAccelerators()&&null!==m.getAccelerators().getQuadTree()?g=e:(e.copyTo(h),h.getImpl().buildQuadTreeAccelerator(1),g=h),u=!0)}if(1===e.getPathCount()||r.getGeometryType()===s.GeometryType.enumPolyline)return!0;const c=r,p=t.Envelope2D.constructEmpty();c.queryEnvelope(p),p.inflateCoords(i,i);const d=new n.Polygon;let _=c,f=!1;for(let n=0,r=e.getPathCount();n<r;n++)if(e.getPathSize(n)>0){const r=t.Envelope2D.constructEmpty();if(e.queryPathEnvelope(n,r),p.isIntersecting(r)){const t=Ie(_,e.getXY(e.getPathStart(n)),0);if(s.geometryReleaseAssert(-1!==t),1===t)return!1}f||(!ve(c,e.getPathCount()-1)||null!==l.getAccelerators()&&null!==l.getAccelerators().getQuadTree()?_=c:(c.copyTo(d),d.getImpl().buildQuadTreeAccelerator(1),_=d),f=!0)}return!0}return!1}function bt(e,s,n){const r=t.Envelope2D.constructEmpty();return r.setCoords({env2D:e}),r.inflateCoords(n,n),r.containsEnvelope(s)}function Gt(e,s,n){const r=t.Envelope2D.constructEmpty();return r.setCoords({env2D:s}),r.inflateCoords(n,n),e.containsExclusiveEnvelope(r)}function Nt(e,s,n){const r=t.Envelope2D.constructEmpty();return r.setCoords({env2D:s}),r.inflateCoords(n,n),!(r.contains(e.getLowerLeft())&&r.contains(e.getLowerRight())&&r.contains(e.getUpperLeft())&&r.contains(e.getUpperRight()))}function Ht(e,t,s,n){if(e.getPathCount()!==t.getPathCount()||e.getPointCount()!==t.getPointCount())return!1;if(e.hasNonLinearSegments()||t.hasNonLinearSegments())return e.equals(t);const r=new i.Point2D,o=new i.Point2D;let a=!0;const m=s*s;for(let s=0;s<e.getPathCount();s++){if(e.getPathEnd(s)!==t.getPathEnd(s)){a=!1;break}for(let n=e.getPathStart(s);n<t.getPathEnd(s);n++)if(e.queryXY(n,r),t.queryXY(n,o),i.Point2D.sqrDistance(r,o)>m){a=!1;break}if(!a)break}return!!a}function At(e,t,s,n,r,o,a){const m=e.getImpl(),l=t.getImpl(),h=m.getPointCount(),g=l.getPointCount(),u=i.makePrimitiveArray(h,!1),c=r||o?i.makePrimitiveArray(g,!1):[],p=s*s,d=new ze(m,l,s);for(;d.next();){const e=d.getRedElement(),t=d.getBlueElement(),s=m.getXY(e),n=l.getXY(t);i.Point2D.sqrDistance(s,n)<=p&&(u[e]=!0,(r||o)&&(c[t]=!0))}let _=!1,f=!1;for(let e=0;e<h;e++){const t=u[e];if(_||=!t,f||=t,(r||n)&&_)return!1}if(n)return!0;let y=!1,x=!1;for(let e=0;e<g;e++){const t=c[e];if(y||=!t,x||=t,r&&y)return!1}return!!r||_&&f&&y&&x}function Ft(e,t,s,n){return Vt(e,t,s,n)&&Vt(t,e,s,n)}function Vt(e,n,o,a){if(s.throwIfCurves(e),s.throwIfCurves(n),n.isEmpty())return!1;let m=!0;const l=i.makePrimitiveArray(2,Number.NaN),h=i.makePrimitiveArray(2,Number.NaN),g=[],u=new jt;let c;const p=t.Envelope2D.constructEmpty(),d=t.Envelope2D.constructEmpty(),_=t.Envelope2D.constructEmpty();e.queryEnvelope(p),n.queryEnvelope(d),p.inflateCoords(o,o),d.inflateCoords(o,o),_.setCoords({env2D:p}),_.intersect(d);const f=e.getImpl().querySegmentIterator(),y=n.getImpl().querySegmentIterator(),x=n.getImpl().getAccelerators();let P=null,E=null,S=null,C=null;if(null!==x&&(P=x.getQuadTree(),E=x.getQuadTreeForPaths(),null!==E&&(C=E.getIteratorForQT())),null===P){const t=e.getPointCount(),s=n.getPointCount();t>10&&s>10&&(P=r.buildQuadTree(n.getImpl(),_))}for(null!==P&&(S=P.getIteratorForQT());f.nextPath();)for(;f.hasNextSegment();){let e=f.nextSegment();if(e.queryEnvelope(p),!p.isIntersecting(_))return m=!1,!1;if(null!==C&&(C.resetIterator(p,o),-1===C.next()))continue;let t=0,n=null;if(null!=S)S.resetIterator(e,o);else if(y.resetToFirstPath(),!y.nextPath())return m=!1,!1;do{if(t=0,null!==S){const s=S.next();if(-1===s)return m=!1,!1;y.resetToVertex(P.getElement(s),-1),n=y.nextSegment(),t=e.intersect(n,null,l,h,o)}else{for(;!y.hasNextSegment();)if(!y.nextPath())return m=!1,!1;n=y.nextSegment(),n.queryEnvelope(d),d.inflateCoords(o,o),p.isIntersecting(d)&&(t=e.intersect(n,null,l,h,o))}}while(2!==t||0!==l[0]||a&&!(h[0]<=h[1]));let i=Number.NaN,x=!1;do{let s=!1;if(1===l[1]){if(!f.hasNextSegment()){x=!0;break}e=f.nextSegment(),s=!0}if(1===h[1]&&h[0]<=h[1]){if(-1===i)break;if(i=1,!y.hasNextSegment())break;n=y.nextSegment(),s=!0}if(0===h[1]&&h[0]>h[1]){if(1===i)break;if(Number.isNaN(i)){if(!y.hasPreviousSegment())break;y.previousSegment(),i=-1}if(!y.hasPreviousSegment())break;n=y.previousSegment(),s=!0}if(!s)break;t=e.intersect(n,null,l,h,o)}while(2===t&&(!a||h[0]<=h[1]));if(x)continue;const E=e.calculateLength2D();e.queryEnvelope(p),g.length=0,u.m_overlapEvents.length=0;let I=!1,v=!1,T=0;const D=r.calculateToleranceFromGeometryForRel(null,p,!0);for(null!==S?S.resetIterator(e,o):(y.resetToFirstPath(),y.nextPath()||s.throwInternalErrorException("relational_operations"));;){if(t=0,null!==S){const s=S.next();if(-1===s)break;y.resetToVertex(P.getElement(s),-1),n=y.nextSegment(),t=e.intersect(n,null,l,h,o)}else{for(;!y.hasNextSegment()&&y.nextPath(););if(!y.hasNextSegment())break;n=y.nextSegment(),n.queryEnvelope(d),d.inflateCoords(o,o),p.isIntersecting(d)&&(t=e.intersect(n,null,l,h,o))}if(2===t&&(!a||h[0]<=h[1])){const e=f.getStartPointIndex(),t=f.getPathIndex(),s=y.getStartPointIndex(),n=y.getPathIndex();if(c=Wt(e,t,l[0],l[1],s,n,h[0],h[1]),u.m_overlapEvents.push(c),g.push(g.length),!(I||c.m_scalarA0<T&&c.m_scalarA1<T))if(0===T&&E*(c.m_scalarA0-T)>o)I=!0;else if(0!==T&&E*(c.m_scalarA0-T)>D)I=!0;else if(T=c.m_scalarA1,E*(1-T)<=o||1===T){v=!0;break}}}if(!v){if(!I)return m=!1,!1;g.length>1&&g.sort((e,t)=>u.compareOverlapEvents(e,t)),T=0;for(let e=0;e<u.m_overlapEvents.length;e++)if(c=u.m_overlapEvents[g[e]],!(c.m_scalarA0<T&&c.m_scalarA1<T)){if(0===T&&E*(c.m_scalarA0-T)>o)return m=!1,!1;if(0!==T&&E*(c.m_scalarA0-T)>D)return m=!1,!1;if(T=c.m_scalarA1,E*(1-T)<=o||1===T)break}if(E*(1-T)>o)return m=!1,!1;g.length=0,u.m_overlapEvents.length=0}}return m}function Rt(e,t,s){const n=e.getImpl(),r=t.getImpl(),i=n.querySegmentIterator(),o=r.querySegmentIterator(),a=new ze(n,r,s);for(;a.next();){const e=a.getRedElement(),t=a.getBlueElement();i.resetToVertex(e,-1),o.resetToVertex(t,-1);const n=i.nextSegment();if(o.nextSegment().isIntersecting(n,s))return!0}return!1}function kt(e,t,s,n){const r=e.getImpl(),o=t.getImpl(),a=r.querySegmentIterator(),m=o.querySegmentIterator(),l=i.makePrimitiveArray(2,Number.NaN),h=new ze(r,o,s);let g=!1,u=-1;for(;h.next();){const e=h.getRedElement(),t=h.getBlueElement();a.resetToVertex(e,-1),m.resetToVertex(t,-1);const r=a.nextSegment(),o=m.nextSegment();let c=0;if(zt(r,o)){if(o.isIntersecting(r,s))return-2}else c=r.intersect(o,null,l,null,s);if(c)if(2===c){const e=r.calculateLength2D(),t=l[0];if(e*(l[1]-t)>s)return u=1,u;g=!0}else if(u=0,n){const e=l[0],t=new i.Point2D;r.queryCoord2D(e,t),n.push(t.x),n.push(t.y)}}return g?-2:u}function Mt(e,t,s,n){const r=e.getImpl(),o=t,a=o.getPointCount(),m=n?i.makePrimitiveArray(a,!1):[],l=new ze(r,o,s,!1),h=r.querySegmentIterator();for(;l.next();){const e=l.getRedElement(),t=l.getBlueElement();h.resetToVertex(e,-1);const r=h.nextSegment(),i=o.getXY(t);if(r.isIntersectingPoint(i,s)){if(!n)return!0;m[t]=!0}}if(!n)return!1;for(let e=0;e<a;e++)if(!m[e])return!1;return!0}function Ut(e,s,n){const r=new i.Point2D,o=n*n,a=e.querySegmentIterator(),m=e.getImpl().getAccelerators();if(null!==m){const e=m.getQuadTree();if(null!==e){const m=t.Envelope2D.constructEmpty();m.setCoords({pt:s});const l=e.getIterator(m,n);for(let t=l.next();-1!==t;t=l.next())if(a.resetToVertex(e.getElement(t),-1),a.hasNextSegment()){const e=a.nextSegment(),t=e.getClosestCoordinate(s,!1);if(e.queryCoord2D(t,r),i.Point2D.sqrDistance(s,r)<=o)return!0}return!1}}const l=t.Envelope2D.constructEmpty();for(;a.nextPath();)for(;a.hasNextSegment();){const e=a.nextSegment();if(e.queryEnvelope(l),l.inflateCoords(n,n),!l.contains(s))continue;const t=e.getClosestCoordinate(s,!1);if(e.queryCoord2D(t,r),i.Point2D.sqrDistance(s,r)<=o)return!0}return!1}function Ot(e,r,o,a){const m=e.querySegmentIterator(),l=e.getImpl().getAccelerators(),h=e.hasNonLinearSegments();let g=null,u=null,c=null,p=null;if(null!==l){const e=l.getQuadTree();if(null!==e){const i=e.getIterator(r,o);h&&(g=new n.Line,u=new n.Line,c=new n.Line,p=new n.Line,r.querySide(0,g),r.querySide(1,u),r.querySide(2,c),r.querySide(3,p));const a=t.Envelope2D.constructEmpty();a.setCoords({env2D:r}),a.inflateCoords(o,o);for(let t=i.next();-1!==t;t=i.next())if(m.resetToVertex(e.getElement(t),-1),m.hasNextSegment()){const e=m.nextSegment();if(e.getGeometryType()===s.GeometryType.enumLine){const t=e.getStartXY(),s=e.getEndXY();if(a.clipLine(t,s))return!0;continue}if(r.contains(e.getStartXY())||r.contains(e.getEndXY()))return!0;if(e.isIntersecting(g,o))return!0;if(e.isIntersecting(u,o))return!0;if(e.isIntersecting(c,o))return!0;if(e.isIntersecting(p,o))return!0}return!1}}if(h){g=new n.Line,u=new n.Line,c=new n.Line,p=new n.Line,r.querySide(0,g),r.querySide(1,u),r.querySide(2,c),r.querySide(3,p);const t=e.querySegmentIterator();for(;t.nextPath();)for(;t.hasNextSegment();){const e=t.nextSegment();if(r.contains(e.getStartXY())||r.contains(e.getEndXY()))return!0;if(e.isIntersecting(g,o))return!0;if(e.isIntersecting(u,o))return!0;if(e.isIntersecting(c,o))return!0;if(e.isIntersecting(p,o))return!0}}else{const s=t.Envelope2D.constructEmpty();s.setCoords({env2D:r}),s.inflateCoords(o,o);const n=e.getImpl(),a=n.getAttributeStreamRef(0),m=new i.Point2D;for(let e=0,t=n.getPathCount();e<t;e++){let t=!0;const r=new i.Point2D,o=new i.Point2D,l=new i.Point2D,h=n.getPathStart(e),g=new i.Point2D;for(let i=h,u=n.getPathEnd(e);i<u;i++)if(t)a.queryPoint2D(2*i,r),g.assign(r),t=!1;else{if(a.queryPoint2D(2*i,m),o.setCoordsPoint2D(r),l.setCoordsPoint2D(m),s.clipLine(o,l))return!0;r.assign(m)}if(n.isClosedPath(e)&&!t&&(o.setCoordsPoint2D(r),l.setCoordsPoint2D(g),s.clipLine(o,l)))return!0}}return!1}function Bt(e,s,n,o){const a=e.getImpl(),l=s.getImpl(),h=[0],g=r.isAtLeastWeakSimple(a.getIsSimple(0,h))&&r.isAtLeastWeakSimple(l.getIsSimple(0,h)),u=a.querySegmentIterator(),c=l.querySegmentIterator(),p=i.makePrimitiveArray(2,0),d=i.makePrimitiveArray(2,0),_=new ze(a,l,n);let f=!1;for(;_.next();){const e=_.getRedElement(),t=_.getBlueElement();u.resetToVertex(e,-1),c.resetToVertex(t,-1);const s=u.nextSegment(),r=c.nextSegment();let i=0;if(zt(s,r)){if(r.isIntersecting(s,n)){f=!0;break}}else i=r.intersect(s,null,d,p,n);if(2===i){const e=p[0],t=p[1],r=s.calculateLength2D();if(g&&(t-e)*r>n)return!1;f=!0}else if(i){const e=p[0],t=d[0];if(e>0&&e<1&&t>0&&t<1)return!1;f=!0}}if(!f)return!1;const y=t.Envelope2D.constructEmpty(),x=t.Envelope2D.constructEmpty(),P=t.Envelope2D.constructEmpty();let E,S;if(e.queryEnvelope(y),s.queryEnvelope(x),y.inflateCoords(1e3*n,1e3*n),x.inflateCoords(1e3*n,1e3*n),P.setCoords({env2D:y}),P.intersect(x),e.getPointCount()>10){if(E=m.clip$1(e,P,n,0,o),E.isEmpty())return!1}else E=e;if(s.getPointCount()>10){if(S=m.clip$1(s,P,n,0,o),S.isEmpty())return!1}else S=s;return He(E,S,n,"F********",o,!1)}function qt(e,s,n,o){const a=e.getImpl(),l=s.getImpl(),h=[0],g=r.isAtLeastWeakSimple(a.getIsSimple(0,h))&&r.isAtLeastWeakSimple(l.getIsSimple(0,h)),u=t.Envelope2D.constructEmpty(),c=t.Envelope2D.constructEmpty(),p=t.Envelope2D.constructEmpty();e.queryEnvelope(u),s.queryEnvelope(c);let d=!1;const _=Nt(u,c,n),f=Nt(c,u,n),y=a.querySegmentIterator(),x=l.querySegmentIterator(),P=i.makePrimitiveArray(2,Number.NaN),E=i.makePrimitiveArray(2,Number.NaN),S=new ze(a,l,n);for(;S.next();){const e=S.getRedElement(),t=S.getBlueElement();y.resetToVertex(e,-1),x.resetToVertex(t,-1);const s=y.nextSegment(),r=x.nextSegment();let i=0;if(zt(s,r)){if(r.isIntersecting(s,n))break}else i=r.intersect(s,null,E,P,n);if(2===i){const e=P[0],t=P[1],r=s.calculateLength2D();if(g&&(t-e)*r>n&&(d=!0,_&&f))return!0}else if(i){const e=P[0],t=E[0];if(e>0&&e<1&&t>0&&t<1)return!0}}const C=t.Envelope2D.constructEmpty(),I=t.Envelope2D.constructEmpty();let v,T;C.setCoords({env2D:u}),C.inflateCoords(1e3*n,1e3*n),I.setCoords({env2D:c}),I.inflateCoords(1e3*n,1e3*n),p.setCoords({env2D:C}),p.intersect(I);let D="";if(D+=d?"**":"T*",_){if(s.getPointCount()>10){if(T=m.clip$1(s,p,n,0,o),T.isEmpty())return!1}else T=s;D+="****"}else T=s,D+="T***";if(f){if(e.getPointCount()>10){if(v=m.clip$1(e,p,n,0,o),v.isEmpty())return!1}else v=e;D+="***"}else v=e,D+="T**";return He(v,T,n,D,o,!1)}function Yt(e,s,i,o){const a=[!1],l=wt(e,s,i,a);if(a[0])return l;const h=t.Envelope2D.constructEmpty();let g;if(s.queryEnvelope(h),h.inflateCoords(1e3*i,1e3*i),e.getPointCount()>10){if(g=m.clip$1(e,h,i,0,o),g.isEmpty())return!1}else g=e;const u=function(e,s,i,o){const a=new qe;a.resetMatrix_(),a.setPredicates_("T*****F**"),a.setAreaAreaPredicates_();const m=t.Envelope2D.constructEmpty(),l=t.Envelope2D.constructEmpty();e.queryEnvelope(m),s.queryEnvelope(l);let h=!1;if(Ke(m,l,i)&&(a.areaAreaDisjointPredicates_(e,s),h=!0),h||$e(e,s),h)return Oe(a.m_matrix,a.m_scl);let g=new n.EditShape,u=g.addGeometry(e),c=g.addGeometry(s),p=null,d=0;if(e.hasNonLinearSegments()||s.hasNonLinearSegments()){p=new ms;const e=is(i,g.getEnvelope2D(o));d=as(e,0),ss(g,e,i,0,p,null,o)}hs(g,new r.CombinedTolerance(i,0).add(d),o,!1,!1);const _=g.getGeometry(c).getBoundary();if(g.filterClosePoints(0,!0,!0,!1,n.nullHandle),Ge(g,u,-1,!1,n.nullHandle,o),0===g.getPointCount(u))return!1;Ge(g,c,-1,!1,n.nullHandle,o),a.setEditShape_(g,o);const f=0===g.getPointCount(c);if(!f){a.computeMatrixTopoGraphHalfEdges_(u,c),a.m_topoGraph.removeShape();const e=Oe(a.m_matrix,a.m_scl);if(!e)return e}const y=g.getGeometry(u);return g=new n.EditShape,u=g.addGeometry(y),c=g.addGeometry(_),a.setEditShape_(g,o),a.m_predicateCount=0,a.resetMatrix_(),a.setPredicates_(f?"T*****F**":"******F**"),a.setAreaLinePredicates_(),a.computeMatrixTopoGraphHalfEdges_(u,c),a.m_topoGraph.removeShape(),Oe(a.m_matrix,a.m_scl)}(g,s,i,o);return u}function Xt(e,t,s,n){const r=new i.Point2D,o=s*s;for(let s=0;s<e.getPointCount();s++)if(e.queryXY(s,r),i.Point2D.sqrDistance(r,t)<=o)return!1;return!0}function Lt(e,t,s){const n=e.getBoundary();return!n.isEmpty()&&!Xt(n,t,s)}function zt(e,t){return e.getGeometryType()!==s.GeometryType.enumLine||t.getGeometryType()!==s.GeometryType.enumLine}function Wt(e,t,s,n,r,i,o,a){return{m_ivertexA:e,m_ipathA:t,m_scalarA0:s,m_scalarA1:n,m_ivertexB:r,m_ipathB:i,m_scalarB0:o,m_scalarB1:a}}class jt{constructor(){this.m_overlapEvents=[]}compareOverlapEvents(e,t){const s=this.m_overlapEvents[e],n=this.m_overlapEvents[t];if(s.m_ipathA<n.m_ipathA)return-1;if(s.m_ipathA===n.m_ipathA){if(s.m_ivertexA<n.m_ivertexA)return-1;if(s.m_ivertexA===n.m_ivertexA){if(s.m_scalarA0<n.m_scalarA0)return-1;if(s.m_scalarA0===n.m_scalarA0){if(s.m_scalarA1<n.m_scalarA1)return-1;if(s.m_scalarA1===n.m_scalarA1&&s.m_ivertexB<n.m_ivertexB)return-1}}}return 1}}function Zt(e,t,s){const n=function(e,t,s){return t.isEmpty()?0:Ie(e,t.getXY(),s)}(e,t,s);return n?1===n?1:2:0}function Qt(e,t,s){const n=Ie(e,t,s);return n?1===n?1:2:0}function Kt(e,n,r,i,o){if(e.getGeometryType()===s.GeometryType.enumPolygon)!function(e,t,s,n,r){for(let i=0;i<s;i++)r[i]=Qt(e,t[i],n)}(e,n,r,i,o);else if(e.getGeometryType()===s.GeometryType.enumEnvelope){const s=t.Envelope2D.constructEmpty();e.queryEnvelope(s),function(e,t,s,n,r){if(e.isEmpty()){for(let e=0;e<s;e++)r[e]=0;return}const i=e.clone();i.inflateCoords(.5*-n,.5*-n);const o=e.clone();o.inflateCoords(.5*n,.5*n);for(let e=0;e<s;e++)i.contains(t[e])?r[e]=1:o.contains(t[e])?r[e]=2:r[e]=0}(s,n,r,i,o)}else s.throwInvalidCallException("")}function $t(e,n,i,o,a){const m=e.getGeometryType();m===s.GeometryType.enumPolyline?function(e,n,i,o,a){const m=e.getImpl(),l=m.getAccelerators();let h=null;l&&(h=l.getRasterizedGeometry());let g=i;for(let e=0;e<i;e++)a[e]=1,h&&s.geometryReleaseAssert(0);if(g){if(l){let e=null;null!==l&&null!==l.getQuadTree()&&(e=l.getQuadTree());const s=m.getPointCount();if(null===e&&s>20&&s*i>4*s+Math.log(s)*i&&(e=r.buildQuadTree(m)),e){let s=null;const r=m.querySegmentIterator(),l=new t.Envelope2D;for(let t=0;t<i&&g;t++)if(1===a[t]){l.setCoords(n[t]),null===s?s=e.getIterator(l,o):s.resetIterator(l,o);let i=-1;for(let m=s.next();-1!==m;m=s.next()){if(r.resetToVertex(e.getElement(m),i),i=r.getPathIndex(),r.nextSegment().isIntersectingPoint(n[t],o)){a[t]=2,g--;break}a[t]=0}}return}}const e=m.querySegmentIterator();for(;e.nextPath()&&g;)for(;e.hasNextSegment()&&g;){const t=e.nextSegment();for(let e=0;e<i&&g;e++)1===a[e]&&t.isIntersectingPoint(n[e],o)&&(a[e]=2,g--)}}for(let e=0;e<i;e++)1===a[e]&&(a[e]=0)}(e,n,i,o,a):s.isSegment(m)?s.geometryReleaseAssert(0):s.throwInvalidCallException("")}function Jt(){return Number.isNaN(this.radius.value())}function es(e,t,s,n){return{pt:e.clone(),t,err:s,checkCount:n}}class ts{constructor(e,t,s,r,o){this.m_left=e,this.m_tracker=o,this.m_eps=s,this.m_trackerCounter=0,this.m_tolerance=r,this.m_circleCheckCounter=0,this.m_bReversedLeft=!1,this.m_leftArc={ptStart:new i.Point2D,ptEnd:new i.Point2D,center:new n.EPoint2D,radius:new i.ECoordinate,fcenter:new n.MPPoint2D,fradius2:new i.MPValue,maxError:Number.NaN,isLine:Jt}}closeToCircularArc(e,t,s,r,o,a){if(this.m_circleCheckCounter++,a.maxError=0,!ts.checkSweepAngle(e,t))return!1;if(a.ptStart.setCoordsPoint2D(s),a.ptEnd.setCoordsPoint2D(o),e.isCircular()){const t=e;return a.fradius2=i.MPValue.constructDouble(t.getSemiMajorAxis()).mulDouble(t.getSemiMajorAxis()),a.radius.set(t.getSemiMajorAxis()),a.fcenter.assignPoint2D(t.getCenter()),a.center.set(t.getCenter()),!0}const m=a.ptEnd.sub(a.ptStart).clone();if(m.leftPerpendicularThis(),m.normalize(),Math.abs(m.dotProduct(r.sub(a.ptStart)))<=this.m_eps)return!!this.confirmIsLine(a,m)&&(a.radius.set(Number.NaN),a.center.setCoords(0,0),!0);{const s=a.ptEnd.sub(a.ptStart),n=r.sub(a.ptStart),i=s.crossProduct(n);if(0===i)return!1;const o=.5*s.sqrLength(),m=.5*n.sqrLength();let l=o*n.y-m*s.y;l/=i;let h=s.x*m-n.x*o;h/=i;const g=Math.sqrt(l*l+h*h);if(4*Number.EPSILON*g>this.m_eps)return!1;const u=l+a.ptStart.x,c=h+a.ptStart.y;a.radius.set(g),a.center.setCoords(u,c);const p=this.maxCircleApproximationError(e,t,a);if(p>this.m_eps)return a.maxError=p,!1}const l=(new n.MPPoint2D).assignPoint2D(a.ptStart),h=(new n.MPPoint2D).assignPoint2D(a.ptEnd).sub(l),g=(new n.MPPoint2D).assignPoint2D(r).sub(l),u=h.crossProduct(g);if(u.isZero())return!1;const c=h.sqrLength().mulDouble(.5),p=g.sqrLength().mulDouble(.5),d=c.mul(g.y).sub(p.mul(h.y)),_=h.x.mul(p).sub(g.x.mul(c)),f=d.mul(d).add(_.mul(_)),y=u.clone();y.invertThis(),a.fradius2=f.mul(y).mul(y),a.fcenter.setCoords(d.mul(y).add(l.x),_.mul(y).add(l.y)),a.center.setWithEps(a.fcenter.asPoint2D()),a.radius.setWithEps(Math.sqrt(a.fradius2.toDouble()));const x=n.EPoint2D.constructPoint2D(a.ptStart).subE(a.center),P=n.EPoint2D.constructPoint2D(a.ptEnd).subE(a.center);if(!x.dotProduct(P).gt(i.s_zero))return!1;const E=this.maxCircleApproximationError(e,t,a);return a.maxError=E,E<=this.m_eps}static checkSweepAngle(e,t){if(e.getGeometryType()===s.GeometryType.enumEllipticArc){const s=e,r=n.tToParametricAngle(s,t.vmin),o=n.tToParametricAngle(s,t.vmax);return!(Math.abs(o-r)>.5*i.geometryHalfPi)}return!0}confirmIsLine(e,t){const s=e.ptEnd.sub(e.ptStart);return!(Math.abs(t.dotProduct(s.mul(.25)))>this.m_eps||Math.abs(t.dotProduct(s.mul(.75)))>this.m_eps)}maxCircleApproximationError(e,t,n){const r=[.25,.75],o=[.1,.25,.75,.9];let a,m;e.getGeometryType()===s.GeometryType.enumEllipticArc?(a=r,m=r.length):(a=o,m=o.length);let l=0;for(let s=0;s<m;++s){const r=new i.Point2D;e.queryCoord2D(i.lerp(t.vmin,t.vmax,a[s]),r);const o=r.sub(n.center.value()).length(),m=Math.abs(o-n.radius.value());m>l&&(l=m)}return l}approximateWithCirclesImpl(e,t){let s=1;t&&t.push(0);const n=i.makePrimitiveArray(9,Number.NaN);let r;e?r=this.m_left.getMonotonicPartParams(n.length,n):(n[0]=0,n[1]=1,r=2);const o=[],a=[],m=new i.Point2D(0,0);for(let e=1;e<r;e++){const r=new i.Envelope1D(n[e-1],n[e]);for(this.m_bReversedLeft=!ts.goodOrientation(this.m_left,r),this.m_bReversedLeft?(o.push(es(m,r.vmin,0,0)),o.push(es(m,r.vmax,0,0))):(o.push(es(m,r.vmax,0,0)),o.push(es(m,r.vmin,0,0))),o[0].pt=this.m_left.getCoord2D(o[0].t),o[1].pt=this.m_left.getCoord2D(o[1].t);o.length>1;){this.progress_();const e=o.at(-1);let n=e.checkCount,r=e.err;const m=e.pt.clone(),l=e.t,h=o[o.length-2].t,g=.5*(l+h),u=this.m_left.getCoord2D(g);if(r<=this.m_eps||n>=5){const e=new i.Envelope1D;if(e.setCoords(l,h),this.closeToCircularArc(this.m_left,e,m,u,o[o.length-2].pt,this.m_leftArc)){t&&(this.m_bReversedLeft?a.push(l):t.push(h)),s++,o.pop();continue}n=0,r=this.m_leftArc.maxError}e.t=g,e.pt.setCoordsPoint2D(u),r*=.125,n++,e.err=r,e.checkCount=n,o.push(es(m,l,r,n))}this.m_bReversedLeft&&t&&(t.length=t.length+a.length,i.memcpy(t,a.reverse(),t.length-a.length,0,a.length),a.length=0),o.length=0}return s}approximateWithCirclesImplPolyline(e){const t=new n.Polyline,s=[];if(!this.approximateWithCirclesImpl(!0,s))return t;let r=0;const o=this.m_left.getStartXY();t.startPath(o);for(let a=1;a<s.length;++a)if(e)t.lineTo(this.m_left.getCoord2D(s[a]));else{const e=new i.Point2D;this.m_left.queryCoord2D(s[a],e);const m=new i.Point2D;this.m_left.queryCoord2D(.5*(s[a]+r),m);const l=new n.EllipticArc;l.constructCircularArcThreePoint(o,e,m),t.addSegment(l,!1),o.assign(e),r=s[a]}return t}static goodOrientation(e,t){const s=e.getCoord2D(t.vmin),n=e.getCoord2D(t.vmax);return s.compare(n)<0}progress_(e=!1){}}function ss(e,t,s,n,r,i,o){!function(e,t,s,n,r,i){e.hasCurves()?(e.setCurveStitcherPointer(n),n.m_impl=new ls(i,!1,null),n.m_impl.buildMonotonicCurveParentage(e,t,s,r)):n.m_impl=null}(e,t,s,r,i,o),us(e,s,o)}function ns(e,t,s,n,r,i,o,a){e.hasCurves()?(e.setCurveStitcherPointer(i),i.m_impl=new ls(a,!0,r),i.m_impl.buildMonotonicCurveParentage(e,t,s,o),us(e,s,a)):i.m_impl=null}function rs(e){if(!e.hasSegmentParentage())return;const t=e.queryVertexIteratorOnSelection();for(let s=t.next();s!==n.nullHandle;s=t.next())if(!e.getSegmentParentageBreakVertex(s)){e.getPathFromVertex(s);const t=e.getPrevVertex(s),r=t!==n.nullHandle?e.getSegmentParentage(t):-1,i=e.getSegmentParentage(s);-1!==i&&-1!==r&&i!==r&&e.setSegmentParentageBreakVertex(s,!0)}}function is(e,s){return s||(s=t.Envelope2D.constructEmpty()),function(e,t){let s=t.isEmpty()?e:r.calculateToleranceFromGeometryForOp(null,t,!0).total();return s>e&&(s=e),.125*s}(e,s)}function os(e,t){return.125*e}function as(e,t){return 3*e+3*t}class ms{constructor(){this.m_impl=null}stitchCurves(e,t,s,n){this.m_impl&&(this.m_impl.stitchCurves(e,t,s),n&&this.clearStitcher(e))}clearStitcher(e){this.m_impl&&(this.m_impl.clearStitcher(e),this.m_impl=null)}getOriginalVertexIndex(e,t){return this.m_impl.getOriginalVertexIndex(e,t)}getOriginalSegmentTypeInfo(e){return this.m_impl.getOriginalSegmentTypeInfo(e)}}class ls{constructor(e,t,s){this.m_originalPlanarSegments=[],this.m_progressTracker=null,this.m_nsr=null,this.m_progressTracker=e,this.m_nsr=s,this.m_tolerance=0,this.m_originalVertexIndex=-1,this.m_type=1,this.m_progressCounter=0,this.m_bIsSimple=t,this.m_densificationDeviation=NaN,this.m_maxSegmentsPerCurve=-1}buildMonotonicCurveParentage(e,t,i,o){const a=!1;if(!e.hasCurves())return;s.geometryReleaseAssert(!e.hasSegmentParentage()),this.m_originalPlanarSegments.length=0,this.m_bIsSimple&&(this.m_originalVertexIndex=e.createUserIndex()),this.m_tolerance=i;const m=new r.Point,l=new n.SegmentBuffer,h=[],u=[],c=[];for(let r=e.getFirstGeometry();r!==n.nullHandle;r=e.getNextGeometry(r))for(let o=e.getFirstPath(r);o!==n.nullHandle;o=e.getNextPath(o)){let r=e.getPathSize(o),p=e.getFirstVertex(o),d=0,_=-1;for(let f=0;f<r;f++){let y=e.getNextVertex(p);if(!e.querySegment(p,l,!0,!1)){p=y;continue}if(0===d){_=e.getVertexIndex(p);const t=ls.regularizeCurve(e,l.get(),p,i);if(t>=0){this.m_nsr&&0===this.m_nsr.m_reason&&this.m_nsr.assign(new g.NonSimpleResult(13,_,-1)),d=t,r=e.getPathSize(o),y=e.getNextVertex(p);const n=e.querySegment(p,l,!0,!1);s.geometryReleaseAssert(n)}}else d--;const x=e.getVertexIndex(p);let P;-1!==this.m_originalVertexIndex&&e.setUserIndex(p,this.m_originalVertexIndex,_),e.setSegmentToIndex(x,null);let E=!1;switch(l.get().getGeometryType()){case s.GeometryType.enumEllipticArc:case s.GeometryType.enumRationalBezier2:P=n.approximationWithQuadraticRationalBeziers(l.get(),t,i,a,!0,u,c,h),E=!0;break;default:{const e=!this.m_bIsSimple||!l.get().isMonotoneQuickAndDirty();P=n.approximationWithBeziers(l.get(),t,i,e,a,u,h)}}const S=this.m_originalPlanarSegments.length;if(e.setSegmentParentageAndBreak(p,S,!0),!u[1].isNAN()){let t=null;t=E?new n.QuadraticRationalBezier({points:u,weights:c}):new n.CubicBezier({cp:u}),t.snapControlPoints(i*i),e.setSegmentToIndex(x,t)}const C=E?2:3;for(let t=1,s=P,r=C;t<s;++t,r+=C){l.get().queryCoord(h[t],m);const s=e.insertVertex(o,y,m);if(-1!==this.m_originalVertexIndex&&e.setUserIndex(s,this.m_originalVertexIndex,_),!u[r+1].isNAN())if(E){const t=new n.QuadraticRationalBezier({points:u.slice(r),weights:c.slice(r)});t.snapControlPoints(i*i),e.setSegmentToIndex(e.getVertexIndex(s),t)}else{const t=new n.CubicBezier({cp:u.slice(r)});t.snapControlPoints(i*i),e.setSegmentToIndex(e.getVertexIndex(s),t)}e.setSegmentParentageAndBreak(s,S,!1)}P>1&&(f+=P-1,r=e.getPathSize(o)),this.m_originalPlanarSegments.push(l.releaseSegment()),p=y}}}buildLinearSegmentParentage(e,t,i,o,a){if(this.m_type=0,this.m_densificationDeviation=t,this.m_maxSegmentsPerCurve=o,!e.hasCurves())return;s.geometryReleaseAssert(!e.hasSegmentParentage()),this.m_tolerance=i,this.m_originalPlanarSegments=[],this.m_bIsSimple&&(this.m_originalVertexIndex=e.createUserIndex());const m=new r.Point,l=new n.SegmentBuffer,h=new n.Densificator(0,t,0,this.m_progressTracker,!1,o),g=[];for(let t=e.getFirstGeometry();t!==n.nullHandle;t=e.getNextGeometry(t))for(let r=e.getFirstPath(t);r!==n.nullHandle;r=e.getNextPath(r)){let t=e.getPathSize(r),n=e.getFirstVertex(r);for(let o=0;o<t;o++){let o=e.getNextVertex(n);if(!e.querySegment(n,l,!0,!1)){n=o;continue}if(ls.regularizeCurve(e,l.get(),n,i)>=0){t=e.getPathSize(r),o=e.getNextVertex(n);const i=e.querySegment(n,l,!0,!1);s.geometryReleaseAssert(i)}const a=e.getVertexIndex(n);-1!==this.m_originalVertexIndex&&e.setUserIndex(n,this.m_originalVertexIndex,a),e.setSegmentToIndex(a,null),g.length=0,h.densifySegment(l.get(),g),this.progress_();const u=this.m_originalPlanarSegments.length;e.setSegmentParentageAndBreak(n,u,!0);for(let t=1,s=g.length-1;t<s;++t){l.get().queryCoord(g[t],m);const s=e.insertVertex(r,o,m);e.setSegmentParentageAndBreak(s,u,!1),-1!==this.m_originalVertexIndex&&e.setUserIndex(s,this.m_originalVertexIndex,a)}this.m_originalPlanarSegments.push(l.releaseSegment()),n=o}}e.clearSegments()}stitchCurves(e,t,s){ls.st_stitchCurvesImpl(this,e,t,s,!1)}clearStitcher(e){this.m_originalPlanarSegments.length=0,-1!==this.m_originalVertexIndex&&(e.removeUserIndex(this.m_originalVertexIndex),this.m_originalVertexIndex=-1),e.deleteSegmentParentage()}static st_verifyParentage(e){ls.st_stitchCurvesImpl(null,e,n.nullHandle,0,!0)}getOriginalVertexIndex(e,t){return-1!==this.m_originalVertexIndex&&t!==n.nullHandle?e.getUserIndex(t,this.m_originalVertexIndex):-1}getOriginalSegmentTypeInfo(e){if(-1!==e){const t=this.m_originalPlanarSegments[e];switch(t.getGeometryType()){case s.GeometryType.enumEllipticArc:return 0===t.projectionBehavior()?0:1;case s.GeometryType.enumBezier:return 2;case s.GeometryType.enumBezier2:return 3;case s.GeometryType.enumLine:return-1;case s.GeometryType.enumRationalBezier2:return 4;default:s.throwNotImplementedException("")}}return-1}progress_(e=!1){this.m_progressCounter++}processSpanSmartTe_(e,t,r,o,a,m,l){if(t===r&&0===o)return s.geometryReleaseAssert(e.getNextVertex(t)===n.nullHandle),e.setSegmentToIndex(e.getVertexIndex(t),null),void e.setSegmentParentageAndBreak(t,-1);const h=e.getNextVertex(t),g=e.getXY(t),u=e.getXY(r);let c,p=0;{let t=2,n=g;for(let s=h;s!==r;s=e.getNextVertex(s)){const r=e.getXY(s);p+=i.Point2D.distance(r,n),n=r,t++}p+=i.Point2D.distance(u,n),s.geometryReleaseAssert(t===o)}if(null===a)return e.setSegmentToIndex(e.getVertexIndex(t),null),void e.removeVertices(h,r);const d=l;let _=a.getClosestCoordinate(g,!1),f=a.getClosestCoordinate(u,!1);const y=a.calculateLength2D();let x=a.tToLength(_),P=a.tToLength(f);const E=Math.abs(x)>10*d&&Math.abs(x-y)>10*d,S=Math.abs(P)>10*d&&Math.abs(P-y)>10*d,C=e=>{const t=e.calculateLength2D();return Math.abs(t-p)>Math.max(.2*p,4*d)?null:e};let I=a.isClosed();if(!I){const e=i.Point2D.distance(a.getStartXY(),a.getEndXY());e<=d&&y>5*e&&(I=!0)}if(I){let n,m,l=new i.Point2D;if(2===o)l=i.Point2D.lerp(g,u,.5),n=a.getClosestCoordinate(l,!1),m=a.tToLength(n);else{let s=e.getNextNthVertex(t,(o-1)/2);l=e.getXY(s),n=a.getClosestCoordinate(l,!1),m=a.tToLength(n);let r=Math.abs(m)>10*d&&Math.abs(m-y)>10*d;if(!r&&(o-1>=4&&(s=e.getNextNthVertex(t,(o-1)/4),n=a.getClosestCoordinate(l,!1),m=a.tToLength(n),r=Math.abs(m)>10*d&&Math.abs(m-y)>10*d),!r))return}let h=!1;const p=x===P;if(p){const s=0;let n=2,r=4;o-1<=4&&(n=s+1,r=s+2);const m=g,l=e.getXY(e.getNextNthVertex(t,n)),u=e.getXY(e.getNextNthVertex(t,r));h=-i.Point2D.orientationNonRobust(m,l,u)*i.sign(a.calculateArea2DHelper())>0}else S?E?h=m>x:m<P?(x=0,_=0):(x=y,_=1):m>x?(P=y,f=1):(P=0,f=0);if(p)c=a.clone(),c.dropAllAttributes(),h||c.reverse(),s.geometryReleaseAssert(g.equals(u));else{let e=!1;_>f&&(e=!0,[_,f]=[f,_]),c=a.cut(_,f,!0),c.getDescription().getAttributeCount(),e&&c.reverse()}c.setCoordsForIntersector(g,u,!1),c=C(c),c&&(this.removeSpanBetween(e,t,r),e.setSegmentToIndex(e.getVertexIndex(t),c))}else if(E||S){if((!E||!S)&&i.Point2D.distance(a.getStartXY(),a.getEndXY())<10*d){const s=[i.makePair(_,f),i.makePair(_,f),i.makePair(_,f)];E?(s[1].second=0,s[2].second=1):(s[1].first=1,s[2].first=0);const n=[null,null,null],o=[0,0,0];let m=Number.MAX_VALUE,l=0;for(let e=0;e<3;e++){let t=!1;if(s[e].first>s[e].second){t=!0;const n=s[e].first;s[e].first=s[e].second,s[e].second=n}n[e]=a.cut(s[e].first,s[e].second,!0),n[e].dropAllAttributes(),t&&n[e].reverse(),n[e].setCoordsForIntersector(g,u,!1),o[e]=n[e].calculateLength2D();const r=Math.abs(p-o[e]);r<m&&(m=r,l=e)}return c=n[l],c=C(c),void(c&&(this.removeSpanBetween(e,t,r),e.setSegmentToIndex(e.getVertexIndex(t),c)))}let s=!1;_>f&&(s=!0,[_,f]=[f,_]),c=a.cut(_,f,!0),c.dropAllAttributes(),s&&c.reverse(),c.setCoordsForIntersector(g,u,!1),c=C(c),c&&(this.removeSpanBetween(e,t,r),e.setSegmentToIndex(e.getVertexIndex(t),c))}else{if(c=a.clone(),c.dropAllAttributes(),x>P&&c.reverse(),p<Math.max(.75*y,y-this.m_densificationDeviation*(o-1))){const e=_>f?f:_,t=c.tToLength(e)+p;let s=c.lengthToT(t);s=i.snap(s,e,1),c=c.cut(e,s,!0)}c.setCoordsForIntersector(g,u,!1),c=C(c),c&&(this.removeSpanBetween(e,t,r),e.setSegmentToIndex(e.getVertexIndex(t),c))}}processSpanCurves_(e,t,r,i,o,a,m){if(t===r&&0===i)return s.geometryReleaseAssert(e.getNextVertex(t)===n.nullHandle),e.setSegmentToIndex(e.getVertexIndex(t),null),void e.setSegmentParentageAndBreak(t,-1);const l=e.getNextVertex(t);{let t=2;for(let s=l;s!==r;s=e.getNextVertex(s))t++;s.geometryReleaseAssert(t===i)}if(null===o)return e.setSegmentToIndex(e.getVertexIndex(t),null),void e.removeVertices(l,r);const h=e.getXY(t),g=e.getXY(r);if(o.isClosed()){if(h.isEqualPoint2D(g)&&h.isEqualPoint2D(o.getStartXY())){let s;if(s=this.verifySegmentFitnessCurves(e,t,r,i,o,a,m)){const n=o.clone();return n.dropAllAttributes(),s<0&&n.reverse(),this.removeSpanBetween(e,t,r),void e.setSegmentToIndex(e.getVertexIndex(t),n)}}}else if(h.isEqualPoint2D(o.getStartXY())){if(g.isEqualPoint2D(o.getEndXY())){const n=o.clone();n.dropAllAttributes();const l=this.verifySegmentFitnessCurves(e,t,r,i,n,a,m);if(l)return s.geometryReleaseAssert(l>0),this.removeSpanBetween(e,t,r),void e.setSegmentToIndex(e.getVertexIndex(t),n)}}else if(g.isEqualPoint2D(o.getStartXY())&&h.isEqualPoint2D(o.getEndXY())){const n=o.getReversed();n.dropAllAttributes();const l=this.verifySegmentFitnessCurves(e,t,r,i,n,a,m);if(l)return s.geometryReleaseAssert(l>0),this.removeSpanBetween(e,t,r),void e.setSegmentToIndex(e.getVertexIndex(t),n)}this.processSpanSplitSegmentCurves(e,t,r,i,o,a,m)}processSpan_(e,t,s,n,r,i,o){return 0===this.m_type?void this.processSpanSmartTe_(e,t,s,n,r,i,o):void this.processSpanCurves_(e,t,s,n,r,i,o)}processSpanSplitSegmentCurves(e,t,s,n,r,o,a){if(r.isLine())return;if(this.fitSegmentToSpanCurves(e,t,s,n,r,o,a))return;const m=a*a;let l=n,h=t;const g=e.getXY(t);let u=r.getClosestCoordinate(g,!1);const c=r.getCoord2D(u);let p=!1;const d=i.Point2D.sqrDistance(g,c);if(d>m){const n=e.getNextVertex(t);if(this.approximateSpanSectionCurves(e,t,r,o,a),n===s)return;h=n,p=!0,l-=1}let _=s;const f=e.getXY(s);u=r.getClosestCoordinate(f,!1);const y=r.getCoord2D(u);let x=!1;const P=i.Point2D.sqrDistance(f,y);if(P>m){const t=e.getPrevVertex(s);if(this.approximateSpanSectionCurves(e,t,r,o,a),t===h)return;_=t,x=!0,l-=1}if((p||x)&&this.fitSegmentToSpanCurves(e,h,_,l,r,o,a))return;let E=!1;if(!p&&d>0){const s=e.getNextVertex(t);if(this.approximateSpanSectionCurves(e,t,r,o,a),s===_)return;h=s,p=!0,E=!0,l-=1}if(!x&&P>0){const t=e.getPrevVertex(s);if(this.approximateSpanSectionCurves(e,t,r,o,a),t===h)return;_=t,x=!0,E=!0,l-=1}if(E&&this.fitSegmentToSpanCurves(e,h,_,l,r,o,a))return;let S=h;for(;;){const t=e.getNextVertex(S);if(this.approximateSpanSectionCurves(e,S,r,o,a),S=t,S===_)return}}fitSegmentToSpanCurves(e,t,s,r,o,a,m){const l=[];l.push(e.getXY(t));let h=t;const g=new n.SegmentBuffer;for(;;){e.querySegment(h,g,!1,!0);const t=[.1,.25,.4,.5,.6,.75,.9,1];let n=0;for(const e of t)(2===r||1&n)&&l.push(g.get().getCoord2D(e)),n++;if(h=e.getNextVertex(h),h===s)break}const u=(()=>{let e=l[0].compare(l.at(-1));if(0===e){const t=new i.KahanSummator(0);!function(e,t,s){if(s.reset(),t<3)return;const n=e[0].clone(),r=n.x,o=n.y,a=e[1].clone(),m=new i.Point2D;for(let r=2;r<t;r++)m.assign(e[r]),s.pe((m.x-n.x)*(a.y-o)),n.assign(a),a.assign(m);s.pe((r-n.x)*(a.y-o))}(l,l.length,t),e=t.getResult()>=0?-1:1}return e>0})();u&&l.reverse();const c=o.clone();if(c.dropAllAttributes(),u&&c.reverse(),c.setSegmentFromCoordsForStitcher(l,l.length),u&&c.reverse(),c.snapControlPoints(this.m_tolerance*this.m_tolerance),this.verifySegmentFitnessCurves(e,t,s,r,c,a,m)){this.removeSpanBetween(e,t,s);const n=e.getVertexIndex(t);return e.setSegmentToIndex(n,c),!0}return!1}approximateSpanSectionCurves(e,t,o,a,m){const l=new n.SegmentBuffer;if(!e.querySegment(t,l,!0,!1))return;const h=o.getGeometryType();if(h!==l.get().getGeometryType()){if(h===s.GeometryType.enumEllipticArc){if(l.get().getGeometryType()!==s.GeometryType.enumRationalBezier2)return;if(0===o.projectionBehavior()){const s=[];!function(e,t,s,r,i){const o=n.minTolerance(t),a=Math.max(4*o,s);new ts(t,null,a,Number.NaN,i).approximateWithCirclesImpl(!1,r)}(0,l.get(),m,s,this.m_progressTracker);const o=e.getNextVertex(t),a=e.getPathFromVertex(t),h=new r.Point;let g=t;for(let t=1,r=s.length;t<r;t++){const r=s[t],m=l.get().getCoord2D(s[t-1]),u=l.get().getCoord2D(i.lerp(s[t-1],r,.5));l.get().queryCoord(r,h);const c=h.getXY(),p=new n.EllipticArc;p.constructCircularArcThreePoint(m,c,u);let d=n.nullHandle;r<1&&(d=e.insertVertex(a,o,h)),e.setSegmentToIndex(e.getVertexIndex(g),p),g=d}return}{const s=i.makeObjectArray(i.Point2D,3);l.get().queryControlPoints(s);const r=[0,0,0];l.get().queryWeights(r);const o=n.calculateStandardWeight(r),a=new n.EllipticArc;return n.nurbs2ToArc128(s,o*o,null,!1,a),void e.setSegmentToIndex(e.getVertexIndex(t),a)}}s.throwInternalErrorException("approximate_span_section_")}}verifySegmentFitnessCurves(e,t,s,r,o,a,m){const l=e.getXY(t),h=e.getXY(s);if(!l.isEqualPoint2D(o.getStartXY())||!h.isEqualPoint2D(o.getEndXY()))return 0;let g=0;if(o.isClosed()){const e=o.getCoord2D(.1).sub(l);g=o.getCoord2D(.7).sub(l).crossProduct(e)>=0?1:-1}const u=i.makePrimitiveArray(n.Segment.s_maxMonotonicPartParams,Number.NaN);let c=o.getMonotonicPartParams(u.length,u);c--;const p=new n.Line,d=[1,.5,.75,.25];let _=0,f=t;const y=l.clone();for(;;){const t=e.getNextVertex(f);let n=e.getSegment(f);null===n&&(e.queryLineConnector(f,p,!0),n=p);for(let e=t===s?1:0;e<d.length;e++){const t=n.getCoord2D(d[e]);if(!o.isCloserThanDistance(t,i.Envelope1D.unit(),m))return 0}if(c>1)for(let e=1;e<c;){const t=o.getCoord2D(u[e]);n.isCloserThanDistance(t,i.Envelope1D.unit(),m)?(u[c-1]=i.swap(u[e],u[e]=u[c-1]),c--):e++}if(g){const e=n.getCoord2D(.25);_+=e.sub(l).crossProduct(y.sub(l)),y.assign(e),e.assign(n.getCoord2D(.75)),_+=e.sub(l).crossProduct(y.sub(l)),y.assign(e)}if(f=t,f===s)return c>1?0:g?_<0?-g:g:1}}removeSpanBetween(e,t,s){e.setSegmentToIndex(e.getVertexIndex(t),null);const n=e.getNextVertex(t);n!==s&&e.removeVertices(n,s)}static st_stitchCurvesImpl(e,t,r,i,o){if(!t.hasSegmentParentage())return;rs(t);let a=r===n.nullHandle?t.getFirstGeometry():r;for(;a!==n.nullHandle;)if(s.isLinear(t.getGeometryType(a))){for(let r=t.getFirstPath(a);r!==n.nullHandle;r=t.getNextPath(r)){let a=t.getPathSize(r);const m=t.isClosedPath(r);m&&(a+=1);let l=t.getFirstVertex(r);const h=t.getSegmentParentage(l);if(m){if(-1!==h&&!t.getSegmentParentageBreakVertex(l)){let e=t.getPrevVertex(l);const n=l;for(let r=0;;r++){const i=t.getSegmentParentage(e);if(h!==i){s.geometryReleaseAssert(-1===i);break}if(l=e,t.getSegmentParentageBreakVertex(e))break;if(e===n){l=n,t.setSegmentParentageBreakVertex(l,!0);break}e=t.getPrevVertex(e),s.geometryReleaseAssert(r<a)}}}else s.geometryReleaseAssert(-1===h||t.getSegmentParentageBreakVertex(l));let g=l;for(let r=0;r<a&&g!==n.nullHandle;){const m=t.getSegmentParentage(g);if(-1===m){if(r++,g=t.getNextVertex(g),g===l)break;continue}let h=0,u=n.nullHandle;const c=g;h=1;let p=t.getNextVertex(c);for(;r<a&&p!==n.nullHandle;){r++,u=p,h++;const e=t.getSegmentParentage(p);if(-1===e||t.getSegmentParentageBreakVertex(p))break;s.geometryReleaseAssert(e===m),p=t.getNextVertex(p)}if(u===n.nullHandle){s.geometryReleaseAssert(0);break}if(!o){const s=e.m_originalPlanarSegments[m];e.processSpan_(t,c,u,h,s,m,i)}if(g=u,g===l)break}}if(r!==n.nullHandle)break;a=t.getNextGeometry(a)}else a=r===n.nullHandle?t.getNextGeometry(a):n.nullHandle}static st_stitchCurvesFromLinesImpl(e,t,r,i,o){let a=r===n.nullHandle?t.getFirstGeometry():r;for(;a!==n.nullHandle;){for(let r=t.getFirstPath(a);r!==n.nullHandle;r=t.getNextPath(r)){let a=t.getPathSize(r);t.isClosedPath(r)&&(a+=1);let m=!0,l=!1;const h=t.getFirstVertex(r);let g=h;for(let r=0;r<a&&g!==n.nullHandle;){let u=t.getSegmentParentage(g);if(-1===u||m){m=!1,r++,g=t.getNextVertex(g),l=!0;continue}let c,p,d=0;if(l?(c=t.getPrevVertex(g),p=g,s.geometryReleaseAssert(c!==n.nullHandle),s.geometryReleaseAssert(p!==c),s.geometryReleaseAssert(-1===t.getSegmentParentage(c)||h===c)):(c=g,p=t.getNextVertex(c),r++,s.geometryReleaseAssert(p!==n.nullHandle),s.geometryReleaseAssert(p!==c),u=t.getSegmentParentage(p)),d=2,l=!1,-1===u||t.getSegmentParentageBreakVertex(p)){g=p;continue}let _=t.getNextVertex(p);for(r++;r<a&&_!==n.nullHandle;){p=_,d++;const e=t.getSegmentParentage(_);if(-1===e||t.getSegmentParentageBreakVertex(_))break;s.geometryReleaseAssert(e===u),r++,_=t.getNextVertex(_)}if(!o){const s=e.m_originalPlanarSegments[u];e.processSpan_(t,c,p,d,s,u,i)}g=p}}if(r!==n.nullHandle)break;a=t.getNextGeometry(a)}}static st_stitchCurvesFromCurvesImpl(e,t,r,i,o){let a=r===n.nullHandle?t.getFirstGeometry():r;for(;a!==n.nullHandle;)if(s.isLinear(t.getGeometryType(a))){for(let r=t.getFirstPath(a);r!==n.nullHandle;r=t.getNextPath(r)){let a=t.getPathSize(r);const m=t.isClosedPath(r);m&&(a+=1);let l=t.getFirstVertex(r);if(m){if(-1!==t.getSegmentParentage(l)){let e=l;for(let s=0;!t.getSegmentParentageBreakVertex(e);s++){if(s===a){l=t.getFirstVertex(r),t.setSegmentParentageBreakVertex(e,!0);break}e=t.getPrevVertex(e)}}}else s.geometryReleaseAssert(-1===t.getSegmentParentage(l)||t.getSegmentParentageBreakVertex(l));let h=l;for(let r=0;r<a&&h!==n.nullHandle;){const m=t.getSegmentParentage(h);if(-1===m){r++,h=t.getNextVertex(h);continue}let l=0,g=n.nullHandle;const u=h;l=1;let c=t.getNextVertex(u);for(;r<a&&c!==n.nullHandle;){r++,g=c,l++;const e=t.getSegmentParentage(c);if(-1===e||t.getSegmentParentageBreakVertex(c))break;s.geometryReleaseAssert(e===m),c=t.getNextVertex(c)}if(g===n.nullHandle)break;if(!o){const s=e.m_originalPlanarSegments[m];e.processSpan_(t,u,g,l,s,m,i)}h=g}}if(r!==n.nullHandle)break;a=t.getNextGeometry(a)}else a=r===n.nullHandle?t.getNextGeometry(a):n.nullHandle}static regularizeCurve(e,t,s,r){let o=t.snapControlPoints(r*r);if(o){const n=e.getVertexIndex(s),r=t.clone();e.setSegmentToIndex(n,r)}if(t.getGeometryType()===n.CubicBezier.type){const n=[],a=t.calculateSpecialPointsForCracking(r,n);if(a>0){const m=[];if(a>1)for(let e=0;e<a;e++)if(m.push(t.getCoord2D(n[e])),e>0){const t=(Math.abs(m[e].x)+Math.abs(m[e].y))*i.geomEpsFactor(),s=i.Point2D.distance(m[e-1],m[e]);if(s<t&&s>0){const t=new i.Point2D;i.lerpPoint2D(m[e-1],m[e],.5,t),m[e-1]=t,m[e]=t}}e.splitSegment(s,n,a),o=e.snapControlPoints(s,a+1,r*r)||o;for(let t=0;t<a;t++)s=e.getNextVertex(s),e.setSegmentParentageBreakVertex(s,!0);return a}}return o?0:-1}}function hs(e,t,s,n,r){return new ps(e,s,t,n,r).do_()}function gs(e,t,s=1,n=1,i=1,o=1){if(n>o)return e;if(o>n)return t;const a=new r.Point;return function(e,t,s,n,r,i,o,a,m){const l=e.equals(t);if(n>i)return o.assignCopy(e),m[0]=n,a[0]=s,l;if(i>n)return o=t,m[0]=i,a[0]=r,l;o.assignCopy(e);const h=ee(e.getXY(),t.getXY(),s,n,r,i);o.setXY(h.pt),a[0]=h.weight,m[0]=h.rank}(e,t,s,n,i,o,a,[0],[0]),a}function us(e,t,s){return ps.fixCurveTwoPointLoops(e,t,s)}function cs(e){return r.adjustToleranceForTEClustering(e)}class ps{constructor(e,t,s,n,r){this.m_shape=e,this.m_progressTracker=t,this.m_tolerance=s,this.m_bFilterDegenerateSegments=n,this.m_bTrackChanges=r,this.m_progressCounter=0}do_(){const e=new r.CombinedTolerance(this.m_tolerance.tolerance,this.m_tolerance.resolution),t=cs(e);let o=r.adjustToleranceForTECracking(e);const a=1.00001*o;o*=1.000001;let m=!1;const l=this.m_shape.getTotalPointCount()+10>30?1e3:(this.m_shape.getTotalPointCount()+10)*(this.m_shape.getTotalPointCount()+10),h=this.m_shape.hasPointFeatures();for(let e=0;;e++){this.m_shape.dbgCheckSelection(),e>l&&s.throwInternalErrorException("crack_and_cluster_iteration_exceeded"),this.m_shape.dbgVerifyMonotone();let r=-1;0===e&&(r=this.firstCrack_(),m||=r>0);const i=this.cluster_(t);if(this.m_shape.dbgVerifyMonotone(),m||=i,this.m_bFilterDegenerateSegments){const e=0!==this.m_shape.filterClosePoints(t,!0,!1,this.m_bTrackChanges,n.nullHandle);m||=e,this.m_shape.dbgVerifyMonotone()}const g=this.m_shape.snapControlPointsOnSelection(a*a);m||=g,this.m_shape.dbgCheckSelection();let u=!1;if((0===e&&-1===r||h||Pe(!0,this.m_shape,o,null,this.m_progressTracker))&&(u=this.crack_(a),m||=u,this.m_shape.dbgVerifyMonotone()),!u&&!ps.fixCurveTwoPointLoops(this.m_shape,t,this.m_progressTracker)){this.m_shape.dbgVerifyMonotone();break}}return m&&function(e){if(!e.hasSegmentParentage())return;rs(e);const t=new r.AttributeStreamOfInt32(0),s=e.queryVertexIteratorOnSelection();for(let e=s.next();e!==n.nullHandle;e=s.next())t.add(e);if(0===t.size())return;e.sortVerticesSimpleByY(t,0,t.size()),t.add(n.nullHandle);const o=i.Point2D.getNAN();e.queryXY(t.read(0),o);let a=0;const m=i.Point2D.getNAN();for(let s=1,r=t.size();s<r;s++){{const r=t.read(s);r!==n.nullHandle?e.queryXY(r,m):m.setNAN()}if(!m.isEqualPoint2D(o)){if(s-a>1){let r=!1;for(let n=a;n<s;++n){const s=t.read(n);if(e.getSegmentParentageBreakVertex(s)){r=!0;break}}if(!r){const o=(t,s,r)=>{const i=e.getPrevVertex(t),o=e.getNextVertex(t);i!==n.nullHandle?s.assign(e.getXY(i)):s.setNAN(),o!==n.nullHandle?r.assign(e.getXY(o)):r.setNAN()},m=new i.Point2D,l=new i.Point2D;o(t.read(a),m,l);for(let e=a+1;e<s;++e){const s=t.read(e);if(s===n.nullHandle)continue;const a=new i.Point2D,h=new i.Point2D;o(s,a,h);const g=(e,t)=>!!(e.equals(t)||e.isNAN()&&t.isNAN());if(!(g(a,m)&&g(h,l)||g(h,m)&&g(a,l))){r=!0;break}}}if(r)for(let n=a;n<s;++n)e.setSegmentParentageBreakVertex(t.read(n),!0)}o.setCoordsPoint2D(m),a=s}}}(this.m_shape),m}cluster_(e){return $(this.m_shape,e,n.nullHandle,this.m_bTrackChanges,this.m_progressTracker)}crack_(e){return function(e,t,s,n){if(!xe(e))return!1;const r=new Se(n);r.m_shape=e,r.m_tolerance=t,r.m_bTrackChanges=s;let i=!1;const o=e.hasCurves()?5:15;return i=e.getTotalPointCount()<o?r.crackBruteForce_():r.crackerPlaneSweep_(),i}(this.m_shape,e,this.m_bTrackChanges,this.m_progressTracker)}static fixCurveTwoPointLoops(e,t,o){if(!e.hasCurves())return!1;e.dbgVerifyCurves();const a=e.createUserIndexUninitialized(),m=new r.AttributeStreamOfInt32(0),l=e.queryVertexIteratorOnSelection();for(let t=l.next();t!==n.nullHandle;t=l.next())m.add(t),e.setUserIndex(t,a,-1);if(0===m.size())return!1;m.add(n.nullHandle),e.sortVerticesSimpleByY(m,0,m.size()-1);let h=0;const g=e.getXY(m.read(h)),u=new i.Point2D(Number.NaN,Number.NaN),c=[];for(let t=1,s=m.size();t<s;++t){const s=m.read(t),r=s!==n.nullHandle?e.getXY(s):u;if(r.equals(g))continue;const o=[];for(let s=h;s<t;s++){const t=m.read(s),r=e.getPrevVertex(t);if(r!==n.nullHandle&&-1===e.getUserIndex(r,a)){const t=ds(e.getXY(r),e.getSegment(r));0!==i.Point2D.sqrDistance(g,t.otherPt)&&(t.vert=r,t.dir=-1,o.push(t)),e.setUserIndex(r,a,1)}const l=e.getNextVertex(t);if(l!==n.nullHandle&&-1===e.getUserIndex(t,a)){const s=ds(e.getXY(l),e.getSegment(t));0!==i.Point2D.sqrDistance(g,s.otherPt)&&(s.vert=t,s.dir=1,o.push(s)),e.setUserIndex(t,a,1)}}if(o.length>1){o.sort((e,t)=>fs(e,t));const e=ds(u.clone(),null);o.push(e);let t=0;for(let e=1,s=o.length;e<s;e++)if(!o[e].otherPt.equals(o[e-1].otherPt)){if(e-t>1&&null!==o[t].seg){let s=!1;const n=t;for(let r=t+1;r<e;r++)if(!_s(o[n],o[r])){s=!0;break}if(s)for(let s=t;s<e&&null!==o[s].seg;s++)c.push(o[s].vert)}t=e}}h=t,g.setCoordsPoint2D(r)}for(const n of c){const r=e.getSegment(n);s.geometryReleaseAssert(null!==r);const o=e.getXY(n),a=e.getXY(e.getNextVertex(n));if(i.Point2D.distance(o,a)<3*t)e.setSegmentToIndex(e.getVertexIndex(n),null);else{const t=r.lengthToT(.5*r.calculateLength2D());e.splitSegment(n,[t],1)}}return e.removeUserIndex(a),c.length>0}firstCrack_(){const e=this.m_shape.getEnvelope2D(this.m_progressTracker),t=r.calculateToleranceFromGeometryForOp(null,e,!0).total();if(4*t<this.m_tolerance.total()){let e=!1;const s=1.1*t,r=t,i=this.cluster_(s);e||=i;let o=0;this.m_bFilterDegenerateSegments&&(o=this.m_shape.filterClosePoints(0,!0,!1,this.m_bTrackChanges,n.nullHandle));const a=this.crack_(r);return e||=a,e?1:o?2:0}return-1}progress_(e=!1){this.m_progressCounter++,!e&&4095&this.m_progressCounter||(this.m_progressCounter=0)}}function ds(e,t){return{otherPt:e,seg:t,vert:-1,dir:0}}function _s(e,t){if(s.geometryReleaseAssert(e.otherPt.equals(t.otherPt)),null===e.seg)return null===t.seg;if(null===t.seg)return!1;const n=e.seg.getGeometryType();if(n!==t.seg.getGeometryType())return!1;if(n===s.GeometryType.enumBezier){const s=e.seg,n=t.seg;let r=s.getControlPoint1(),o=s.getControlPoint2();-1===e.dir&&(o=i.swap(r,r=o));let a=n.getControlPoint1(),m=n.getControlPoint2();return-1===t.dir&&(m=i.swap(a,a=m)),r.equals(a)&&o.equals(m)}if(n===s.GeometryType.enumRationalBezier2){const s=e.seg,n=t.seg,r=s.getControlPoint1(),o=n.getControlPoint1();if(!r.equals(o))return!1;const a=[0,0,0];s.queryWeights(a),-1===e.dir&&(a[2]=i.swap(a[0],a[0]=a[2]));const m=[0,0,0];return n.queryWeights(m),-1===t.dir&&(m[2]=i.swap(m[0],m[0]=m[2])),a[0]===m[0]&&a[1]===m[1]&&a[2]===m[2]}s.throwInternalErrorException("")}function fs(e,t){const s=e.otherPt.compare(t.otherPt);return 0!==s?s:function(e,t){if(null===e.seg||null===t.seg)return null!==e.seg?-1:null!==t.seg?1:0;const s=e.seg.getGeometryType(),n=t.seg.getGeometryType();return s<n?-1:s>n?1:0}(e,t)}var ys=s.isMultiPath,xs=s.isSegment,Ps=s.getDimensionFromType;function Es(e,t,n,i,o,a,m){const l=new Ds(o);l.m_bOGCOutput=!0;const h=e.getGeometryType()===s.GeometryType.enumPolygon&&1===e.getFillRule()&&!r.isAtLeastWeakSimple(i);return l.planarSimplifyImpl_(e,t,h,n,i,o,a,m)}function Ss(e,t,s,n,r,i,o,a){return new Ds(i).planarSimplifyImpl_(e,t,s,n,r,i,o,a)}function Cs(e,t,n){return function(e,t,n){const r=e.createInstance(),o=i.makeObjectArray(i.Point2D,100),a=new Array(100),m=e.getPointCount();let l=!0;const h=2===t.getDimension();1!==t.getDimension()&&2!==t.getDimension()&&s.throwInternalErrorException("");for(let s=0;s<m;){const i=e.queryCoordinates(o,o.length,s,-1)-s;h?Kt(t,o,i,n.total(),a):$t(t,o,i,n.total(),a);let m=0;for(let t=0;t<i;t++)0===a[t]&&(l&&(l=!1,r.addPoints(e,0,s)),m!==t&&r.addPoints(e,s+m,s+t),m=t+1);l||m===i||r.addPoints(e,s+m,s+i),s+=i}return l?e:r}(e,t,n)}function Is(e,t,n){return function(e,t,n){if(e.isEmpty())return e.createInstance();if(t.isEmpty())return e.createInstance();const r=[new i.Point2D],o=[0],a=2===t.getDimension();return 1!==t.getDimension()&&2!==t.getDimension()&&s.throwInternalErrorException(""),r[0]=e.getXY(),a?Kt(t,r,1,n.total(),o):$t(t,r,1,n.total(),o),0!==o[0]?e:e.createInstance()}(e,t,n)}function vs(e,t,i,o,a,m=!1){0===t&&s.throwInvalidArgumentException("not enough geometries to dissolve");let l=0;for(let s=0,n=t;s<n;s++)l=Math.max(e[s].getDimension(),l);if(2===l||1===l)return new Ds(o).dissolveMultiPaths_(l,!1,e,t,i,a,m);let h=0,g=-1;for(let s=0,n=t;s<n;s++)e[s].getDimension()===l&&(-1===g&&(g=s),e[s].isEmpty()||(g=s,h++));if(h<2)return bs(e[g]);const u=r.Envelope3D.constructEmpty(),c=new n.EditShape;let p=n.nullHandle;for(let s=0,i=t;s<i;s++)if(e[s].getDimension()===l&&!e[s].isEmpty()){p===n.nullHandle?p=c.addGeometry(bs(e[s])):c.appendGeometry(p,bs(e[s]));const t=r.Envelope3D.constructEmpty();e[s].queryLooseEnvelope(t),u.mergeEnv3D(t)}const d=r.calculateToleranceFromGeometryForOp(i,u.getEnvelope2D(),!0),_=new Ds(o);if(m){const e=r.calculateZToleranceFromGeometryForOpEnv1D(i,u.getEnvelopeZs(),!0);return _.planarSimplify3DImpl_(c,d,e,0,!0)}return _.m_bOGCOutput=!0,_.planarSimplifyMultiPoints(c,d,!1,-1)}function Ts(e,t,i,o,a,m=!1){t<2&&s.throwInvalidArgumentException("not enough geometries to dissolve");let l=0;for(let s=0,n=t;s<n;s++)l=Math.max(e[s].getDimension(),l);if(2===l||1===l)return new Ds(o).dissolveMultiPaths_(l,!0,e,t,i,a,m);const h=r.Envelope3D.constructEmpty(),g=new n.EditShape;let u=n.nullHandle,c=0,p=-1;for(let s=0,i=t;s<i;s++)if(e[s].getDimension()===l&&(-1===p&&(p=s),!e[s].isEmpty())){p=s,u===n.nullHandle?u=g.addGeometry(bs(e[s])):g.appendGeometry(u,bs(e[s]));const t=r.Envelope3D.constructEmpty();e[s].queryLooseEnvelope(t),h.mergeEnv3D(t),c++}if(c<2)return bs(e[p]);const d=0===l?i:null,_=r.calculateToleranceFromGeometryForOp(d,h.getEnvelope2D(),!0),f=new Ds(o);if(m){const e=r.calculateZToleranceFromGeometryForOpEnv1D(d,h.getEnvelopeZs(),!0);return f.m_bOGCOutput=!0,f.planarSimplify3DImpl_(g,_,e,0,!0)}return f.planarSimplifyMultiPoints(g,_,!0,-1)}class Ds{constructor(e){this.m_topoGraph=null,this.m_maskLookup=[],this.m_dummyPt1=i.Point2D.getNAN(),this.m_dummyPt2=i.Point2D.getNAN(),this.m_fromEdgeForPolylines=n.nullHandle,this.m_progressCounter=0,this.m_bOGCOutput=!1,this.m_progressTracker=e}linesToPolygonsImpl(e,t){let s=0,r=0,i=null;if(e.hasCurves()){i=new ms;const n=e.getEnvelope2D(this.m_progressTracker);r=os(t.total());const o=is(t.total(),n);s=as(o,r),ss(e,o,t.total(),0,i,null,this.m_progressTracker)}this.setEditShapeCrackAndCluster(e,t.add(s));const o=this.m_topoGraph.createUserIndexForChains(),a=this.m_topoGraph.getFirstChain();this.m_topoGraph.setChainUserIndex(a,o,1);for(let e=this.m_topoGraph.getChainFirstIsland(a);e!==n.nullHandle;e=this.m_topoGraph.getChainNextInParent(e))this.m_topoGraph.setChainUserIndex(e,o,1);const m=[];for(let t=this.m_topoGraph.getFirstChain();t!==n.nullHandle;t=this.m_topoGraph.getChainNext(t)){if(1===this.m_topoGraph.getChainUserIndex(t,o))continue;this.m_topoGraph.setChainUserIndex(t,o,1);for(let e=this.m_topoGraph.getChainFirstIsland(t);e!==n.nullHandle;e=this.m_topoGraph.getChainNextInParent(e))this.m_topoGraph.setChainUserIndex(e,o,1);if(0===this.m_topoGraph.getChainArea(t))continue;const s=this.m_topoGraph.extractPolygonFromChainAndIslands(e,n.nullHandle,t,n.nullHandle);null!=i&&i.stitchCurves(e,s,r,!1);const a=e.getGeometry(s);m.push(a)}return new h.SimpleGeometryCursor(m)}autoCompleteImpl(e,t,s){let r=0,i=0,o=null;if(e.hasCurves()){o=new ms;const t=e.getEnvelope2D(this.m_progressTracker);i=os(s.total());const n=is(s.total(),t);r=as(n,i),ss(e,n,s.total(),0,o,null,this.m_progressTracker)}this.setEditShapeCrackAndCluster(e,s.add(r));const a=this.m_topoGraph.getGeometryID(t),m=this.m_topoGraph.createUserIndexForChains(),l=this.m_topoGraph.getFirstChain();this.m_topoGraph.setChainUserIndex(l,m,1);for(let e=this.m_topoGraph.getChainFirstIsland(l);e!==n.nullHandle;e=this.m_topoGraph.getChainNextInParent(e))this.m_topoGraph.setChainUserIndex(e,m,1);const g=[];for(let t=this.m_topoGraph.getFirstChain();t!==n.nullHandle;t=this.m_topoGraph.getChainNext(t)){if(1===this.m_topoGraph.getChainUserIndex(t,m))continue;this.m_topoGraph.setChainUserIndex(t,m,1);for(let e=this.m_topoGraph.getChainFirstIsland(t);e!==n.nullHandle;e=this.m_topoGraph.getChainNextInParent(e))this.m_topoGraph.setChainUserIndex(e,m,1);if(0!==this.m_topoGraph.getChainParentage(t))continue;const s=this.m_topoGraph.getChainHalfEdge(t);let r=s,l=!1;do{const e=this.m_topoGraph.getHalfEdgeTwin(r);if(this.m_topoGraph.getHalfEdgeChain(e)!==t&&0!==(this.m_topoGraph.getHalfEdgeParentage(r)&a)){l=!0;break}r=this.m_topoGraph.getHalfEdgeNext(r)}while(r!==s);if(!l)continue;if(0===this.m_topoGraph.getChainArea(t))continue;const h=this.m_topoGraph.extractPolygonFromChainAndIslands(e,n.nullHandle,t,n.nullHandle);null!==o&&o.stitchCurves(e,h,i,!1);const u=e.getGeometry(h);g.push(u)}return new h.SimpleGeometryCursor(g)}setEditShape(e,t=!1){null===this.m_topoGraph&&(this.m_topoGraph=new z),this.m_topoGraph.setEditShape(e,this.m_progressTracker,!0,t)}setEditShapeCrackAndCluster(e,t){hs(e,t,this.m_progressTracker,!0,!1);for(let t=e.getFirstGeometry();t!==n.nullHandle;t=e.getNextGeometry(t))e.getGeometryType(t)===s.GeometryType.enumPolygon&&Ge(e,t,-1,this.m_bOGCOutput,n.nullHandle,this.m_progressTracker);this.setEditShape(e)}setHalfEdgeOrientations_(e,t){const s=this.m_topoGraph.getShape();for(let r=s.getFirstGeometry();r!==n.nullHandle;r=s.getNextGeometry(r))if(r===t)for(let t=s.getFirstPath(r);t!==n.nullHandle;t=s.getNextPath(t)){let r=s.getFirstVertex(t);if(r===n.nullHandle)continue;let i=s.getNextVertex(r);for(;i!==n.nullHandle;){const t=this.m_topoGraph.getClusterFromVertex(r),o=this.m_topoGraph.getClusterFromVertex(i),a=this.m_topoGraph.getHalfEdgeConnector(t,o);if(a!==n.nullHandle){const t=this.m_topoGraph.getHalfEdgeTwin(a);this.m_topoGraph.setHalfEdgeUserIndex(a,e,1),this.m_topoGraph.setHalfEdgeUserIndex(t,e,2)}r=i,i=s.getNextVertex(r)}}}flushVertices_(e,t){const s=this.m_topoGraph.getShape(),r=s.hasSegmentParentage(),i=new n.SegmentBuffer,o=s.insertPath(e,n.nullHandle);t.push(t[0]);const a=t.length;let m=n.nullHandle;for(let e=0;e<a;e++){const n=t[e];if(m=s.addVertex(o,n),!r)continue;const l=this.m_topoGraph.getClusterFromVertex(n);if(e>0&&this.m_topoGraph.isBreakNode(l)&&s.setSegmentParentageBreakVertex(m,!0),e<a-1){const n=this.m_topoGraph.getHalfEdgeConnector(l,this.m_topoGraph.getClusterFromVertex(t[e+1])),r=this.m_topoGraph.getSegmentParentage(n);s.setSegmentParentageAndBreak(m,r,e>0||this.m_topoGraph.isBreakNode(l)),this.m_topoGraph.isHalfEdgeCurve(n)&&(this.m_topoGraph.querySegmentXY(n,i),s.setSegmentToIndex(s.getVertexIndex(m),i.get().clone()))}}if(r){const e=this.m_topoGraph.getClusterFromVertex(t[a-1]);this.m_topoGraph.isBreakNode(e)&&s.setSegmentParentageBreakVertex(m,!0)}s.setClosedPath(o,!0)}processPolygonCuts_(e,t,r,i){const o=this.m_topoGraph.getGeometryID(r),a=this.m_topoGraph.getGeometryID(i),m=[],l=this.m_topoGraph.getShape(),h=this.m_topoGraph.createUserIndexForHalfEdges();for(let r=this.m_topoGraph.getFirstCluster();r!==n.nullHandle;r=this.m_topoGraph.getNextCluster(r)){const i=this.m_topoGraph.getClusterHalfEdge(r);if(i===n.nullHandle)continue;let g=i;do{if(1!==this.m_topoGraph.getHalfEdgeUserIndex(g,h)){let n=g,r=g,i=!1,u=0;do{if(this.m_topoGraph.setHalfEdgeUserIndex(n,h,1),i||0!==(this.m_topoGraph.getHalfEdgeParentage(n)&a)&&0!==(this.m_topoGraph.getHalfEdgeFaceParentage(n)&o)&&(r=n,i=!0),i){const t=this.m_topoGraph.getHalfEdgeOrigin(n),s=this.m_topoGraph.getClusterVertexIterator(t),r=this.m_topoGraph.getVertexFromVertexIterator(s);m.push(r),-1!==e&&0!==(this.m_topoGraph.getHalfEdgeParentage(n)&a)&&(u|=this.m_topoGraph.getHalfEdgeUserIndex(n,e))}n=this.m_topoGraph.getHalfEdgeNext(n)}while(n!==r);if(i&&this.m_topoGraph.getChainArea(this.m_topoGraph.getHalfEdgeChain(r))>0){const e=l.createGeometry(s.GeometryType.enumPolygon);this.flushVertices_(e,m),-1!==t&&l.setGeometryUserIndex(e,t,u)}m.length=0}g=this.m_topoGraph.getHalfEdgeNext(this.m_topoGraph.getHalfEdgeTwin(g))}while(g!==i)}this.m_topoGraph.deleteUserIndexForHalfEdges(h)}cutPolygonPolyline_(e,t,s,r){this.m_topoGraph.removeSpikes_();let i=-1;-1!==e&&(i=this.m_topoGraph.createUserIndexForHalfEdges(),this.setHalfEdgeOrientations_(i,s)),this.processPolygonCuts_(i,e,t,s),-1!==i&&(this.m_topoGraph.deleteUserIndexForHalfEdges(i),i=-1);const o=this.m_topoGraph.getShape();for(let e=o.getFirstGeometry();e!==n.nullHandle;e=o.getNextGeometry(e))e!==t&&e!==s&&r.push(e);r.sort((e,t)=>{const s=o.getFirstPath(e),n=o.getRingArea(s),r=o.getFirstPath(t),i=o.getRingArea(r);return n<i?-1:n>i?1:0})}cut(e,t,n,r,i){const o=this.m_topoGraph.getShape().getGeometryType(n),a=this.m_topoGraph.getShape().getGeometryType(r),m=s.getDimensionFromType(o),l=s.getDimensionFromType(a);if(2!==m||1!==l){if(1===m&&1===l)return void new Ns(this,e,t,n,r,i).Do();s.throwInternalErrorException("")}else this.cutPolygonPolyline_(t,n,r,i)}progress_(e=!1){}isGoodParentage(e){return e>=0&&e<this.m_maskLookup.length&&this.m_maskLookup[e]}normalizeInputGeometry(e){const t=e.getGeometryType();if(t===s.GeometryType.enumEnvelope){const t=new n.Polygon({vd:e.getDescription()});return e.isEmpty()||t.addEnvelope(e,!1),t}if(t===s.GeometryType.enumPoint){const t=new n.MultiPoint({vd:e.getDescription()});return e.isEmpty()||t.add(e),t}if(s.isSegment(t)){const t=new n.Polyline({vd:e.getDescription()});return e.isEmpty()||t.addSegment(e,!0),t}return t!==s.GeometryType.enumMultiPoint&&t!==s.GeometryType.enumPolyline&&t!==s.GeometryType.enumPolygon&&s.throwInvalidArgumentException("Unexpected geometry type"),e}dissolveNonSimplePolygons(e,t,r,i){s.geometryReleaseAssert(t>0);const o=new n.EditShape;let a=0,m=-1;for(let s=0,n=t;s<n;s++)2===e[s].getDimension()&&(-1===m&&(m=s),e[s].isEmpty()||(a++,o.addGeometry(e[s])));return 0===a?(s.geometryReleaseAssert(m>=0),this.normalizeInputGeometry(e[m])):this.planarSimplifyPolygons(o,r,!0,!1,-1,!0)}dissolveMultiPaths_(e,o,a,m,l,h,g){s.geometryReleaseAssert(e>=1&&e<=2),s.geometryReleaseAssert(m>0);const u=8&h?1:2,c=r.Envelope3D.constructEmpty();let p=0,d=-1,_=!0;for(let t=0,n=m;t<n;t++)if(a[t].getDimension()===e&&(-1===d&&(d=t),!a[t].isEmpty())){d=t,p++;const n=r.Envelope3D.constructEmpty();if(a[t].queryLooseEnvelope(n),c.mergeEnv3D(n),2===e&&_&&a[t].getGeometryType()===s.GeometryType.enumPolygon)if(16&h){const e=[0],s=a[t].getImpl().getIsSimple(0,e),n=this.m_bOGCOutput?5===s:r.isAtLeastPlanarSimple(s);_&&=n}else{const e=r.isAtLeastWeakSimpleGeom(a[t],0);_&&=e}}if(p<2&&(s.geometryReleaseAssert(d>=0),0===p||!(16&h)))return this.normalizeInputGeometry(a[d]);if(!_){const e=r.calculateToleranceFromGeometryForOp(o?null:l,c.getEnvelope2D(),!0);return this.dissolveNonSimplePolygons(a,m,e,h)}const f=a.slice(0,m),y=r.calculateToleranceFromGeometryForOp(l,c.getEnvelope2D(),!0),x=10*r.adjustToleranceForTEClustering(y);let P=new r.CombinedTolerance(0,0);if(g&&(P=r.calculateZToleranceFromGeometryForOpEnv1D(l,c.getEnvelopeZs(),!0)),1===p&&1===e&&2===u&&!o)return g?(s.geometryReleaseAssert(0),{}):this.m_bOGCOutput?Es(f[d],y,!1,-1,this.m_progressTracker,u,!1):Ss(f[d],y,!1,!1,-1,this.m_progressTracker,u,!1);const E=new r.Envelope2DIntersector;E.startConstruction();let S=2===e?3:4,C=0;for(let n=0,i=m;n<i;n++){if(f[n].getDimension()!==e||f[n].isEmpty())continue;let i=f[n].getGeometryType();if(i!==s.GeometryType.enumEnvelope){if(s.isSegment(i)?(f[n]=this.normalizeInputGeometry(f[n]),i=s.GeometryType.enumPolyline):s.geometryReleaseAssert(s.isMultiPath(i)),1===e){s.geometryReleaseAssert(i===s.GeometryType.enumPolyline);let e=-1;if(g)s.geometryReleaseAssert(0,"3d not implemented yet");else{const t=[0];e=f[n].getImpl().getIsSimple(y.total(),t)}if(this.m_bOGCOutput?5!==e:!r.isAtLeastPlanarSimple(e))if(o)S=-1;else{g?s.geometryReleaseAssert(0,"3d not implemented yet"):this.m_bOGCOutput?f[n]=Es(f[n],y,!1,-1,this.m_progressTracker,u,!1):f[n]=Ss(f[n],y,!1,!1,-1,this.m_progressTracker,u,!1);const e=[0];s.geometryReleaseAssert(r.isAtLeastPlanarSimple(f[n].getImpl().getIsSimple(y.total(),e)))}}else{s.geometryReleaseAssert(i===s.GeometryType.enumPolygon);const e=[0],t=f[n].getImpl().getIsSimple(0,e);s.geometryReleaseAssert(r.isAtLeastWeakSimple(t))}const a=f[n].getImpl();for(let e=0,s=a.getPathCount();e<s;e++){const s=t.Envelope2D.constructEmpty();a.queryLoosePathEnvelope(e,s),s.inflateCoords(x,x),E.addEnvelope(C,s),C++}}else{s.geometryReleaseAssert(i===s.GeometryType.enumEnvelope);const e=t.Envelope2D.constructEmpty();f[n].queryLooseEnvelope(e),e.inflateCoords(x,x),E.addEnvelope(C,e),C++,S=-1}}E.endConstruction();const I=C,v=i.makePrimitiveArray(I,-2147483647),T=i.makePrimitiveArray(I,-1);let D=0;d=-1,C=0;for(let t=0,n=m;t<n;t++){if(f[t].getDimension()!==e)continue;if(-1===d&&(d=t),f[t].isEmpty())continue;d=t,D++;const n=f[t].getGeometryType();if(s.isMultiPath(n))for(let e=0,s=f[t].getPathCount();e<s;e++)T[C]=t,v[C]=-e-1,C++;else s.geometryReleaseAssert(n===s.GeometryType.enumEnvelope),T[C]=t,v[C]=-1,C++}if(D<2&&2===e)return s.geometryReleaseAssert(d>=0),this.normalizeInputGeometry(f[d]);let w=I;for(;E.next()&&w>0;){this.progress_();const e=E.getHandleA(),t=E.getHandleB(),s=E.getElement(e),n=E.getElement(t);T[s]!==T[n]&&(v[s]<0&&(w--,v[s]=-(v[s]+1)),v[n]<0&&(w--,v[n]=-(v[n]+1)))}const b=new n.EditShape;let G,N=!1,H=0;for(let t=0,r=m;t<r;t++){if(f[t].getDimension()!==e||f[t].isEmpty())continue;const r=f[t].getGeometryType(),i=H;let o=0,a=0;const m=s.isMultiPath(r)?f[t]:null;for(let e=i,n=v.length;e<n&&T[e]===t;e++)v[e]>=0&&(o++,a+=m?m.getPathSize(v[e]):s.vertexCount(f[t])),H++;if(a>.95*s.vertexCount(f[t])){b.addGeometry(this.normalizeInputGeometry(f[t]));for(let e=i;e<H;e++)v[e]<0&&(v[e]=-(v[e]+1))}else{if(0===o){N=!0;continue}{N=!0,s.geometryReleaseAssert(s.isMultiPath(r)),s.geometryReleaseAssert(null!=m);const e=new n.Polygon({vd:f[t].getDescription()}),o=new n.Polyline({vd:f[t].getDescription()}),a=r===s.GeometryType.enumPolygon?e:o;for(let e=i;e<H;e++)v[e]>=0&&a.addPath(m,v[e],!0);b.addGeometry(a)}}}if(b.getFirstGeometry()!==n.nullHandle){const t=2===e,s=o?r.calculateToleranceFromGeometryForOp(null,c.getEnvelope2D(),!0):y;let i=new r.CombinedTolerance(0,0);if(g&&(i=o?r.calculateZToleranceFromGeometryForOpEnv1D(null,c.getEnvelopeZs(),!0):P),2===e&&!(2&h)){b.collapseAllGeometriesToFirst();let e=0,t=null;if(b.hasCurves()&&!b.hasSegmentParentage()){t=new ms;const n=b.getEnvelope2D(this.m_progressTracker);e=os(s.total()),ss(b,is(s.total(),n),s.total(),0,t,null,this.m_progressTracker)}!function(e,t,s,n){s>0&&$(e,s,t,!1,n),new ye(n).executeImpl_(e,t)}(b,b.getFirstGeometry(),s.total(),this.m_progressTracker),null!==t&&t.stitchCurves(b,n.nullHandle,e,!0)}if(g)G=this.planarSimplify3DImpl_(b,s,i,u,!0);else if(2===e)G=this.planarSimplifyPolygons(b,s,t,o,-1,!1);else{const e={unsplitBehavior:0,allCrossRoadsImpassable:!1,ogcRule:!1};e.ogcRule=this.m_bOGCOutput,e.allCrossRoadsImpassable=!0,e.unsplitBehavior=u,G=this.planarSimplifyPolylines(b,s,o,e,-1)}if(!N){const e=[0];S=G.getImpl().getIsSimple(s.total(),e)}}else s.geometryReleaseAssert(N),s.geometryReleaseAssert(d>=0),G=2===e?new n.Polygon({vd:f[d].getDescription()}):new n.Polyline({vd:f[d].getDescription()});if(N){let e=0;for(let t=0,n=v.length;t<n;t++){const n=T[t];if(!(n<0)&&v[t]<0){const r=f[n].getGeometryType(),i=s.isMultiPath(r)?f[n]:null;if(i){const s=-(v[t]+1);e+=i.getPathSize(s)}else e+=4}}G.reserve(G.getPointCount()+e);for(let e=0,t=v.length;e<t;e++){const t=T[e];if(!(t<0)&&v[e]<0){const n=f[t].getGeometryType(),r=s.isMultiPath(n)?f[t]:null;if(r){const t=-(v[e]+1);G.addPath(r,t,!0)}else n===s.GeometryType.enumEnvelope?G.addEnvelope(f[t],!1):(s.geometryReleaseAssert(s.isSegment(n)),G.addSegment(f[t],!0))}}}let A=0;if(2===e?-1!==S&&(S=3,A=o?0:y.total()):(s.geometryReleaseAssert(1===e),o||-1===S||(A=y.total())),g||G.getImpl().setIsSimple(S,A),!o&&N)if(2===e){if(!g)return(new Xs).execute(G,l,!1,this.m_progressTracker);s.geometryReleaseAssert(0,"3d not yet implemented")}else 1===e&&1!==u&&(g?(s.geometryReleaseAssert(0),G={}):G=function(e,t,r,i){const o=new Ds(i),a=new n.EditShape,m=a.addGeometry(t),l=o.planarSimplifyNoCrackingAndCluster(e,a,m,r);return s.geometryReleaseAssert(l,"planar_simplify_no_cracking_and_cluster"),a.getGeometry(m)}(this.m_bOGCOutput,G,u,this.m_progressTracker),G.getImpl().setIsSimple(S,A));return G}dissolveTopoGraphCommonEdges_(){const e=this.m_topoGraph.createUserIndexForHalfEdges(),t=[];for(let s=this.m_topoGraph.getFirstCluster();s!==n.nullHandle;s=this.m_topoGraph.getNextCluster(s)){const r=this.m_topoGraph.getClusterHalfEdge(s);let i=r;if(r!==n.nullHandle)do{if(this.progress_(),1!==this.m_topoGraph.getHalfEdgeUserIndex(i,e)){const s=this.m_topoGraph.getHalfEdgeTwin(i);this.m_topoGraph.setHalfEdgeUserIndex(s,e,1),this.m_topoGraph.setHalfEdgeUserIndex(i,e,1);const n=this.m_topoGraph.getHalfEdgeFaceParentage(i);if(this.isGoodParentage(n)){const e=this.m_topoGraph.getHalfEdgeFaceParentage(s);this.isGoodParentage(e)&&t.push(i)}}i=this.m_topoGraph.getHalfEdgeNext(this.m_topoGraph.getHalfEdgeTwin(i))}while(i!==r)}this.m_topoGraph.deleteUserIndexForHalfEdges(e),this.m_topoGraph.deleteEdgesBreakFaces_(t)}chooseVertexByOrder(e,t,r,o){let a=i.indexTypeMax(),m=n.nullHandle;for(let s=this.m_topoGraph.getClusterVertexIterator(e);s!==n.nullHandle;s=this.m_topoGraph.incrementVertexIterator(s)){const e=this.m_topoGraph.getVertexFromVertexIterator(s),n=t.getUserIndex(e,r);n>=0&&n<a&&(a=n,m=e)}s.geometryReleaseAssert(m!==n.nullHandle);let l=t.getUserIndex(m,o);return l>0&&(t.setUserIndex(m,o,--l),0===l&&t.setUserIndex(m,r,-1)),m}chooseVertexFromCluster_(e,t){return this.m_topoGraph.getVertexDominantFromCluster(e,t)}chooseVertexFromVertexCluster_(e,t){return this.m_topoGraph.getVertexDominant(e,t)}collectPolygonPathsPreservingFrom_(e,t,r,i,o){const a=this.m_topoGraph.getShape();if(a.getGeometryType(e)!==s.GeometryType.enumPolygon)return;const m=a.hasSegmentParentage(),l=new n.SegmentBuffer;for(let s=a.getFirstPath(e);s!==n.nullHandle;s=a.getNextPath(s)){const e=a.getFirstVertex(s);this.m_topoGraph.getClusterFromVertex(e);const h=this.m_topoGraph.getHalfEdgeFromVertex(e);if(h===n.nullHandle)continue;const g=this.m_topoGraph.getHalfEdgeUserIndex(h,r);if(1===g||2===g)continue;const u=this.m_topoGraph.getHalfEdgeFaceParentage(h);if(!this.isGoodParentage(u)){this.m_topoGraph.setHalfEdgeUserIndex(h,r,2);continue}this.m_topoGraph.setHalfEdgeUserIndex(h,r,1);const c=a.insertPath(t,n.nullHandle);a.setClosedPath(c,!0);let p=h,d=e,_=this.m_topoGraph.getClusterFromVertex(d),f=1;do{this.progress_();const e=this.chooseVertexFromVertexCluster_(d,o),t=a.addVertex(c,e);if(this.m_topoGraph.isHalfEdgeCurve(p)&&(this.m_topoGraph.querySegmentXY(p,l),a.setSegmentToIndex(a.getVertexIndex(t),l.get().clone())),m){const e=this.m_topoGraph.getSegmentParentage(p);a.setSegmentParentageAndBreak(t,e,this.m_topoGraph.isBreakNode(_))}let s,h;-1!==i&&this.m_topoGraph.setClusterUserIndex(_,i,1),this.m_topoGraph.setHalfEdgeUserIndex(p,r,1),p=this.m_topoGraph.getHalfEdgeNext(p);do{s=1===f?a.getNextVertex(d):a.getPrevVertex(d),h=s!==n.nullHandle?this.m_topoGraph.getClusterFromVertex(s):n.nullHandle}while(h===_);const g=this.m_topoGraph.getHalfEdgeOrigin(p);if(g!==h){do{s=1===f?a.getPrevVertex(d):a.getNextVertex(d),h=s!==n.nullHandle?this.m_topoGraph.getClusterFromVertex(s):n.nullHandle}while(h===_);if(g!==h){h=g;const e=this.m_topoGraph.getClusterVertexIterator(h);s=this.m_topoGraph.getVertexFromVertexIterator(e)}else f=-f}_=h,d=s}while(p!==h)}}topoOperationPolygonPolygonHelper_(e,t,s,r,i,o){this.progress_(!0),e!==n.nullHandle&&this.collectPolygonPathsPreservingFrom_(e,s,i,o,r),t!==n.nullHandle&&this.collectPolygonPathsPreservingFrom_(t,s,i,o,r);const a=new n.SegmentBuffer,m=this.m_topoGraph.getShape();m.dbgVerifyCurves();const l=m.hasSegmentParentage();for(let e=this.m_topoGraph.getFirstCluster();e!==n.nullHandle;e=this.m_topoGraph.getNextCluster(e)){const t=this.m_topoGraph.getClusterHalfEdge(e);if(t===n.nullHandle)continue;let h=t;do{this.progress_();const e=this.m_topoGraph.getHalfEdgeUserIndex(h,i);if(1!==e&&2!==e){const e=this.m_topoGraph.getHalfEdgeFaceParentage(h);if(this.isGoodParentage(e)){const e=m.insertPath(s,n.nullHandle);m.setClosedPath(e,!0);let t=h;do{const s=this.m_topoGraph.getHalfEdgeVertexIterator(t);let h=n.nullHandle;if(s!==n.nullHandle)h=this.m_topoGraph.getVertexFromVertexIterator(s);else{const e=this.m_topoGraph.getHalfEdgeVertexIterator(this.m_topoGraph.getHalfEdgeTwin(t));h=this.m_topoGraph.getVertexFromVertexIterator(e),h=m.getNextVertex(h)}const g=this.chooseVertexFromVertexCluster_(h,r),u=m.addVertex(e,g);if(l){const e=this.m_topoGraph.getSegmentParentage(t),s=this.m_topoGraph.getHalfEdgeOrigin(t);m.setSegmentParentageAndBreak(u,e,this.m_topoGraph.isBreakNode(s))}if(this.m_topoGraph.isHalfEdgeCurve(t)&&(this.m_topoGraph.querySegmentXY(t,a),m.setSegmentToIndex(m.getVertexIndex(u),a.get().clone())),this.m_topoGraph.setHalfEdgeUserIndex(t,i,1),-1!==o){const e=this.m_topoGraph.getClusterFromVertex(g);this.m_topoGraph.setClusterUserIndex(e,o,1)}t=this.m_topoGraph.getHalfEdgeNext(t)}while(t!==h)}else this.m_topoGraph.setHalfEdgeUserIndex(h,i,2)}h=this.m_topoGraph.getHalfEdgeNext(this.m_topoGraph.getHalfEdgeTwin(h))}while(h!==t)}}topoOperationPolygonPolygon_(e,t,r,i=!1){this.dissolveTopoGraphCommonEdges_();const o=this.m_topoGraph.getShape(),a=o.createGeometry(s.GeometryType.enumPolygon),m=this.m_topoGraph.createUserIndexForHalfEdges();return this.topoOperationPolygonPolygonHelper_(e,t,a,r,m,-1),this.m_topoGraph.deleteUserIndexForHalfEdges(m),i||Ge(o,a,3,this.m_bOGCOutput,n.nullHandle,this.m_progressTracker),a}topoOperationPolyline_(e,t){const s={unsplitBehavior:0,allCrossRoadsImpassable:!1,ogcRule:!1};return s.ogcRule=t,s.unsplitBehavior=0,this.topoOperationPolylineSimplifyOrPolylineTopoHelper_(n.nullHandle,e,!1,s).first}topoOperationMultiPoint_(){const e=this.m_topoGraph.getShape(),t=e.createGeometry(s.GeometryType.enumMultiPoint),r=e.insertPath(t,n.nullHandle);for(let t=this.m_topoGraph.getFirstCluster();t!==n.nullHandle;t=this.m_topoGraph.getNextCluster(t)){const s=this.m_topoGraph.getClusterParentage(t);if(this.isGoodParentage(s)){let s=n.nullHandle;for(let r=this.m_topoGraph.getClusterVertexIterator(t);r!==n.nullHandle;r=this.m_topoGraph.incrementVertexIterator(r)){const t=this.m_topoGraph.getVertexFromVertexIterator(r);s===n.nullHandle&&(s=t);const i=e.getGeometryFromPath(e.getPathFromVertex(t)),o=this.m_topoGraph.getGeometryID(i);if(this.isGoodParentage(o)){s=t;break}}e.addVertex(r,s)}}return t}intersection(e,t){const r=this.m_topoGraph.getShape().getGeometryType(e),i=this.m_topoGraph.getShape().getGeometryType(t),o=s.getDimensionFromType(r),a=s.getDimensionFromType(i),m=this.m_topoGraph.getGeometryID(e),l=this.m_topoGraph.getGeometryID(t);s.geometryReleaseAssert(m>=0),s.geometryReleaseAssert(l>=0),this.m_maskLookup.length=0,this.m_maskLookup.length=1+(m|l),this.m_maskLookup[m|l]=!0;let h=n.nullHandle;return this.m_topoGraph.getShape().getVertexDescription().getAttributeCount()>1&&(h=e),2===o&&2===a?this.topoOperationPolygonPolygon_(e,t,h):1===o&&a>0||1===a&&o>0?this.topoOperationPolyline_(h,this.m_bOGCOutput):0===o||0===a?this.topoOperationMultiPoint_():void s.throwInternalErrorException("")}topoOperationPolygonPolygonEx(e,t,r){const i=this.m_topoGraph.getShape(),o=i.createGeometry(s.GeometryType.enumPolygon),a=i.createGeometry(s.GeometryType.enumPolyline),m=i.createGeometry(s.GeometryType.enumMultiPoint);this.dissolveTopoGraphCommonEdges_();let l=n.nullHandle;const h=this.m_topoGraph.createUserIndexForHalfEdges(),g=this.m_topoGraph.createUserIndexForClusters();i.dbgVerifyCurves(),this.topoOperationPolygonPolygonHelper_(e,t,o,r,h,g),i.dbgVerifyCurves();const u=i.hasSegmentParentage(),c=new n.SegmentBuffer;for(let e=this.m_topoGraph.getFirstCluster();e!==n.nullHandle;e=this.m_topoGraph.getNextCluster(e)){const t=this.m_topoGraph.getClusterHalfEdge(e);if(t===n.nullHandle)continue;let s=t;do{let t=this.m_topoGraph.getHalfEdgeUserIndex(s,h),o=this.m_topoGraph.getHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgeTwin(s),h),m=t|o;if(2===m){let l=this.m_topoGraph.getHalfEdgeParentage(s);if(this.isGoodParentage(l)){const p=i.insertPath(a,n.nullHandle);let d=s;const _=this.chooseVertexFromCluster_(e,r);let f=i.addVertex(p,_);if(u){const e=this.m_topoGraph.getSegmentParentage(s),t=this.m_topoGraph.getHalfEdgeOrigin(s);i.setSegmentParentageAndBreak(f,e,this.m_topoGraph.isBreakNode(t))}this.m_topoGraph.isHalfEdgeCurve(s)&&(this.m_topoGraph.querySegmentXY(s,c),i.setSegmentToIndex(i.getVertexIndex(f),c.get().clone())),this.m_topoGraph.setClusterUserIndex(e,g,1);do{this.progress_();const e=this.m_topoGraph.getHalfEdgeTo(d),n=this.chooseVertexFromCluster_(e,r);if(f=i.addVertex(p,n),u){const e=this.m_topoGraph.getSegmentParentage(s),t=this.m_topoGraph.getHalfEdgeOrigin(s);i.setSegmentParentageAndBreak(f,e,this.m_topoGraph.isBreakNode(t))}if(this.m_topoGraph.setHalfEdgeUserIndex(d,h,1),this.m_topoGraph.setHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgeTwin(d),h,1),this.m_topoGraph.setClusterUserIndex(e,g,1),d=this.m_topoGraph.getHalfEdgeNext(d),t=this.m_topoGraph.getHalfEdgeUserIndex(d,h),o=this.m_topoGraph.getHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgeTwin(d),h),m=t|o,2!==m)break;if(l=this.m_topoGraph.getHalfEdgeParentage(d),!this.isGoodParentage(l)){this.m_topoGraph.setHalfEdgeUserIndex(d,h,1),this.m_topoGraph.setHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgeTwin(d),h,1);break}this.m_topoGraph.isHalfEdgeCurve(s)&&d!==s&&(this.m_topoGraph.querySegmentXY(s,c),i.setSegmentToIndex(i.getVertexIndex(f),c.get().clone()))}while(d!==s)}else this.m_topoGraph.setHalfEdgeUserIndex(s,h,1),this.m_topoGraph.setHalfEdgeUserIndex(this.m_topoGraph.getHalfEdgeTwin(s),h,1)}s=this.m_topoGraph.getHalfEdgeNext(this.m_topoGraph.getHalfEdgeTwin(s))}while(s!==t)}for(let e=this.m_topoGraph.getFirstCluster();e!==n.nullHandle;e=this.m_topoGraph.getNextCluster(e)){if(this.progress_(),1===this.m_topoGraph.getClusterUserIndex(e,g))continue;const t=this.m_topoGraph.getClusterParentage(e);if(this.isGoodParentage(t)){l===n.nullHandle&&(l=i.insertPath(m,n.nullHandle));const t=this.m_topoGraph.getClusterVertexIterator(e);let s=n.nullHandle;if(t!==n.nullHandle){s=this.m_topoGraph.getVertexFromVertexIterator(t);const e=this.chooseVertexFromVertexCluster_(s,r);i.addVertex(l,e)}}}this.m_topoGraph.deleteUserIndexForClusters(g),this.m_topoGraph.deleteUserIndexForHalfEdges(h),i.dbgVerifyCurves(),Ge(i,o,3,this.m_bOGCOutput,n.nullHandle,this.m_progressTracker);const p=[n.nullHandle,n.nullHandle,n.nullHandle];return p[0]=m,p[1]=a,p[2]=o,p}topoOperationPolylinePolylineOrPolygonEx(e,t){const s={unsplitBehavior:0,allCrossRoadsImpassable:!1,ogcRule:!1};return s.ogcRule=t,s.unsplitBehavior=0,this.topoOperationPolylineSimplifyOrPolylineTopoHelper_(n.nullHandle,e,!0,s)}topoOperationMultiPoint(){const e=this.m_topoGraph.getShape(),t=e.createGeometry(s.GeometryType.enumMultiPoint),r=e.insertPath(t,n.nullHandle);for(let t=this.m_topoGraph.getFirstCluster();t!==n.nullHandle;t=this.m_topoGraph.getNextCluster(t)){const s=this.m_topoGraph.getClusterParentage(t);if(this.isGoodParentage(s)){let s=n.nullHandle;for(let r=this.m_topoGraph.getClusterVertexIterator(t);r!==n.nullHandle;r=this.m_topoGraph.incrementVertexIterator(r)){const t=this.m_topoGraph.getVertexFromVertexIterator(r);s===n.nullHandle&&(s=t);const i=e.getGeometryFromPath(e.getPathFromVertex(t)),o=this.m_topoGraph.getGeometryID(i);if(this.isGoodParentage(o)){s=t;break}}e.addVertex(r,s)}}return t}intersectionEx(e,t){const r=this.m_topoGraph.getShape().getGeometryType(e),i=this.m_topoGraph.getShape().getGeometryType(t),o=Ps(r),a=Ps(i),m=this.m_topoGraph.getGeometryID(e),l=this.m_topoGraph.getGeometryID(t);s.geometryReleaseAssert(m>=0),s.geometryReleaseAssert(l>=0),this.m_maskLookup.length=0,this.m_maskLookup.length=1+(m|l),this.m_maskLookup[m|l]=!0;let h=n.nullHandle;if(this.m_topoGraph.getShape().getVertexDescription().getAttributeCount()>1&&(h=e),2===o&&2===a)return this.topoOperationPolygonPolygonEx(e,t,h);if(1===o&&a>0||1===a&&o>0){const{first:e,second:t}=this.topoOperationPolylinePolylineOrPolygonEx(h,this.m_bOGCOutput);return[t,e]}if(0===o||0===a){const e=[];return e.push(this.topoOperationMultiPoint()),e}s.throwInternalErrorException("")}getCombinedHalfEdgeParentage(e){return this.m_topoGraph.getHalfEdgeParentage(e)|this.m_topoGraph.getHalfEdgeFaceParentage(e)|this.m_topoGraph.getHalfEdgeFaceParentage(this.m_topoGraph.getHalfEdgeTwin(e))}prevailingDirection(e,t){const s=this.getCombinedHalfEdgeParentage(t),r=this.m_topoGraph.getHalfEdgeOrigin(t),o=this.m_topoGraph.getHalfEdgeTo(t);let a=0,m=0;for(let i=this.m_topoGraph.getClusterVertexIterator(r);i!==n.nullHandle;i=this.m_topoGraph.incrementVertexIterator(i)){const r=this.m_topoGraph.getVertexFromVertexIterator(i),l=e.getPathFromVertex(r),h=e.getGeometryFromPath(l),g=this.m_topoGraph.getGeometryID(h),u=e.getFirstVertex(l),c=0!==(g&s);c&&u===r&&(this.m_fromEdgeForPolylines=t);const p=e.getNextVertex(r);if(p!==n.nullHandle&&this.m_topoGraph.getClusterFromVertex(p)===o){if(a++,c){if(this.m_fromEdgeForPolylines===n.nullHandle&&u===p){const e=this.m_topoGraph.getHalfEdgeNext(t);this.isGoodParentage(this.getCombinedHalfEdgeParentage(e))&&(this.m_fromEdgeForPolylines=e)}m++}}else{const s=e.getPrevVertex(r);if(s!==n.nullHandle&&this.m_topoGraph.getClusterFromVertex(s)===o&&(a--,c)){if(this.m_fromEdgeForPolylines===n.nullHandle&&u===s){const e=this.m_topoGraph.getHalfEdgeNext(t);this.isGoodParentage(this.getCombinedHalfEdgeParentage(e))&&(this.m_fromEdgeForPolylines=e)}m--}}}return this.m_topoGraph.queryXY(r,this.m_dummyPt1),this.m_topoGraph.queryXY(o,this.m_dummyPt2),(0!==m?m:a)*i.Point2D.distance(this.m_dummyPt1,this.m_dummyPt2)}tryMoveThroughCrossroadBackwards(e,t){const s=this.m_topoGraph.getHalfEdgePrev(e),r=this.m_topoGraph.getHalfEdgeTwin(s);if(!t){if(this.m_topoGraph.isStrongPathNode(this.m_topoGraph.getHalfEdgeOrigin(e)))return n.nullHandle;const t=this.m_topoGraph.getHalfEdgeTwin(e);if(r===this.m_topoGraph.getHalfEdgeNext(t))return s}let i=r,o=n.nullHandle;for(;i!==e;){const e=this.getCombinedHalfEdgeParentage(i);if(this.isGoodParentage(e)){if(o!==n.nullHandle)return n.nullHandle;o=this.m_topoGraph.getHalfEdgeTwin(i)}i=this.m_topoGraph.getHalfEdgeTwin(this.m_topoGraph.getHalfEdgePrev(i))}return o}tryMoveThroughCrossroadForward(e,t){const s=this.m_topoGraph.getHalfEdgeNext(e),r=this.m_topoGraph.getHalfEdgeTwin(s);if(!t){const t=this.m_topoGraph.getHalfEdgeTwin(e);if(this.m_topoGraph.isStrongPathNode(this.m_topoGraph.getHalfEdgeOrigin(t)))return n.nullHandle;if(r===this.m_topoGraph.getHalfEdgePrev(t))return s}let i=r,o=n.nullHandle;for(;i!==e;){const e=this.getCombinedHalfEdgeParentage(i);if(this.isGoodParentage(e)){if(o!==n.nullHandle)return n.nullHandle;o=this.m_topoGraph.getHalfEdgeTwin(i)}i=this.m_topoGraph.getHalfEdgeTwin(this.m_topoGraph.getHalfEdgeNext(i))}return o}isOnALoop(e,t){let n=e;const r=2*this.m_topoGraph.getShape().getTotalPointCount()+10;for(let s=0;s<r;s++){if(1===this.m_topoGraph.getHalfEdgeUserIndex(n,t))return!1;const s=this.m_topoGraph.getHalfEdgeNext(n);if(s===this.m_topoGraph.getHalfEdgeTwin(n))return!1;if(n=s,n===e)return!0}s.throwInternalErrorException("is_on_a_loop_")}restorePolylineParts(e,t,r,o,a,m,l,h,g,u){s.geometryReleaseAssert(a===n.nullHandle&&m>=0&&l>=0||-1===m&&-1===l),s.geometryReleaseAssert(-1===h&&1!==u.unsplitBehavior||-1!==h&&1===u.unsplitBehavior);const c=u.ogcRule,p=u.allCrossRoadsImpassable,d=1===u.unsplitBehavior,_=0===u.unsplitBehavior,f=this.m_topoGraph.getShape(),y=f.hasSegmentParentage();let x=e,P=this.m_topoGraph.getHalfEdgeTwin(x);const E=new n.SegmentBuffer;this.m_fromEdgeForPolylines=n.nullHandle;let S=this.prevailingDirection(f,x),C=x,I=n.nullHandle,v=!1,T=!1,D=!1;if(!d)for(;;){const t=this.m_topoGraph.getHalfEdgePrev(x);if(t===P){D=!0;break}const s=this.m_topoGraph.getHalfEdgeNext(P);if(this.m_topoGraph.isStrongPathNode(this.m_topoGraph.getHalfEdgeOrigin(s))){v=!0;break}if(this.m_topoGraph.getHalfEdgeTwin(t)!==s){if(p){v=!0;break}if(x=this.tryMoveThroughCrossroadBackwards(x,!0),x===n.nullHandle){v=!0;break}P=this.m_topoGraph.getHalfEdgeTwin(x)}else x=t,P=s;if(1===this.m_topoGraph.getHalfEdgeUserIndex(x,r)){D=!0;break}if(x===e){I=e,T=!0;break}const i=this.getCombinedHalfEdgeParentage(x);if(!this.isGoodParentage(i))break;C=x,S+=this.prevailingDirection(f,x)}if(I===n.nullHandle){for(x=e,P=this.m_topoGraph.getHalfEdgeTwin(x),I=x;;){const e=this.m_topoGraph.getHalfEdgeNext(x),t=this.m_topoGraph.isStrongPathNode(this.m_topoGraph.getHalfEdgeOrigin(e));if(t){v=!0;break}if(e===P){D=!0;break}if(-1!==h){const e=this.m_topoGraph.getHalfEdgeOrigin(P);if(1===this.m_topoGraph.getClusterUserIndex(e,h)){v=!0;break}}const s=this.m_topoGraph.getHalfEdgePrev(P);if(this.m_topoGraph.getHalfEdgeTwin(e)!==s){if(t||p){v=!0;break}if(x=this.tryMoveThroughCrossroadForward(x,!0),x===n.nullHandle){v=!0;break}P=this.m_topoGraph.getHalfEdgeTwin(x)}else x=e,P=s;if(1===this.m_topoGraph.getHalfEdgeUserIndex(x,r)){D=!0;break}const i=this.getCombinedHalfEdgeParentage(x);if(!this.isGoodParentage(i))break;I=x,S+=this.prevailingDirection(f,x)}const t=this.m_topoGraph.getHalfEdgeOrigin(C);T=this.m_topoGraph.getHalfEdgeTo(I)===t}else if(this.m_fromEdgeForPolylines!==n.nullHandle){C=e,I=this.tryMoveThroughCrossroadBackwards(C,!1),s.geometryReleaseAssert(I!==n.nullHandle);const t=this.m_topoGraph.getHalfEdgeTwin(C);this.m_topoGraph.getHalfEdgeNext(t)}let w=T;T||D||g&&(w=this.isOnALoop(e,r),w||(w=this.isOnALoop(P,r)));const b=S>=0;let G=!1;w&&v&&(T?(G=c,b&&(G||d||_)&&C!==e&&(s.geometryReleaseAssert(!d),C=e,G=!1)):(d||b&&_)&&(C=e));let N=0;for(x=C;P=this.m_topoGraph.getHalfEdgeTwin(x),this.m_topoGraph.setHalfEdgeUserIndex(x,r,1),this.m_topoGraph.setHalfEdgeUserIndex(P,r,1),N++,x!==I;)x=p?this.m_topoGraph.getHalfEdgeNext(x):this.tryMoveThroughCrossroadForward(x,!1);b||(I=i.swap(C,C=I),I=this.m_topoGraph.getHalfEdgeTwin(I),C=this.m_topoGraph.getHalfEdgeTwin(C));let H=f.insertPath(t,n.nullHandle);x=C;const A=this.m_topoGraph.getHalfEdgeOrigin(C);let F;F=-1!==m?this.chooseVertexByOrder(A,f,m,l):this.chooseVertexFromCluster_(A,a),this.m_topoGraph.isStrongPathNode(A)&&f.setStrongPathStart(H,!0);let V=f.addVertex(H,F),R=V;-1!==o&&this.m_topoGraph.setClusterUserIndex(A,o,1);let k=0;const M=G?Math.trunc((N+1)/2):-1;let U=n.nullHandle,O=!0,B=n.nullHandle;for(;;){if(y){const e=this.m_topoGraph.getSegmentParentage(x),t=this.m_topoGraph.getHalfEdgeOrigin(x);f.setSegmentParentageAndBreak(R,e,O||this.m_topoGraph.isBreakNode(t))}O=!1,this.m_topoGraph.isHalfEdgeCurve(x)&&(this.m_topoGraph.querySegmentXY(x,E),f.setSegmentToIndex(f.getVertexIndex(R),E.get().clone())),U!==n.nullHandle&&-1!==l&&f.addToUserIndex(U,l,-1);const e=p?this.m_topoGraph.getHalfEdgeNext(x):this.tryMoveThroughCrossroadForward(x,!1),s=this.m_topoGraph.getHalfEdgeTo(x);let r;if(r=-1!==m?this.chooseVertexByOrder(s,f,m,l):this.chooseVertexFromCluster_(s,a),V=f.addVertex(H,r),B=s,-1!==o&&this.m_topoGraph.setClusterUserIndex(s,o,1),y&&this.m_topoGraph.isBreakNode(s)&&f.setSegmentParentageBreakVertex(V,!0),U=r,k++,G&&k===M&&(H=f.insertPath(t,n.nullHandle),V=f.addVertex(H,r),O=!0,-1!==l&&f.addToUserIndex(r,l,-1),U=n.nullHandle),x===I)break;x=e,R=V}B!==n.nullHandle&&this.m_topoGraph.isStrongPathNode(B)&&f.setStrongPathEnd(H,!0)}topoOperationPolylineSimplify_(e,t){return this.topoOperationPolylineSimplifyOrPolylineTopoHelper_(e,n.nullHandle,!1,t).first}topoOperationPolylineSimplifyOrPolylineTopoHelper_(e,t,r,o){s.geometryReleaseAssert(t===n.nullHandle||e===n.nullHandle);const a=this.m_topoGraph.getShape(),m=t=>e===n.nullHandle?t===n.nullHandle?a.getFirstGeometry():a.getNextGeometry(t):t===n.nullHandle?e:n.nullHandle,l=a.createGeometry(s.GeometryType.enumPolyline);let h=-1;r&&(h=this.m_topoGraph.createUserIndexForClusters());const g=this.m_topoGraph.createUserIndexForHalfEdges(),u=t===n.nullHandle?a.createUserIndex():-1,c=t===n.nullHandle?a.createUserIndex():-1;let p=-1;if(1===o.unsplitBehavior){p=this.m_topoGraph.createUserIndexForClusters();for(let e=m(n.nullHandle);e!==n.nullHandle;e=m(e))for(let t=a.getFirstPath(e);t!==n.nullHandle;t=a.getNextPath(t)){{const e=a.getFirstVertex(t),s=this.m_topoGraph.getClusterFromVertex(e);this.m_topoGraph.setClusterUserIndex(s,p,1)}if(!a.isClosedPath(t)){const e=a.getLastVertex(t),s=this.m_topoGraph.getClusterFromVertex(e);this.m_topoGraph.setClusterUserIndex(s,p,1)}}}if(t===n.nullHandle){let e=0;for(let t=m(n.nullHandle);t!==n.nullHandle;t=m(t))for(let s=a.getFirstPath(t);s!==n.nullHandle;s=a.getNextPath(s))if(a.isClosedPath(s)){let t=a.getFirstVertex(s);for(let n=0,r=a.getPathSize(s);n<r;n++,t=a.getNextVertex(t))a.setUserIndex(t,u,e++),a.setUserIndex(t,c,2)}else{const t=a.getFirstVertex(s);a.setUserIndex(t,u,e++),a.setUserIndex(t,c,1);let n=a.getNextVertex(t);for(let t=1,r=a.getPathSize(s)-1;t<r;++t)a.setUserIndex(n,u,e++),a.setUserIndex(n,c,2),n=a.getNextVertex(n);a.setUserIndex(n,u,e++),a.setUserIndex(n,c,1)}}for(let e=m(n.nullHandle);e!==n.nullHandle;e=m(e))for(let s=a.getFirstPath(e);s!==n.nullHandle;s=a.getNextPath(s)){let e=a.getFirstVertex(s);for(let r=0,i=a.getPathSize(s);r<i;r++,e=a.getNextVertex(e)){const s=this.m_topoGraph.getHalfEdgeFromVertex(e);if(s===n.nullHandle)continue;if(1===this.m_topoGraph.getHalfEdgeUserIndex(s,g))continue;const i=this.getCombinedHalfEdgeParentage(s);if(this.isGoodParentage(i)){const e=0===r;this.restorePolylineParts(s,l,g,h,t,u,c,p,e,o)}}}let d=n.nullHandle;if(r){d=a.createGeometry(s.GeometryType.enumMultiPoint);let e=n.nullHandle;for(let s=this.m_topoGraph.getFirstCluster();s!==n.nullHandle;s=this.m_topoGraph.getNextCluster(s))if(this.progress_(),1!==this.m_topoGraph.getClusterUserIndex(s,h)){const r=this.m_topoGraph.getClusterParentage(s);if(this.isGoodParentage(r)){e===n.nullHandle&&(e=a.insertPath(d,n.nullHandle));const r=this.m_topoGraph.getClusterVertexIterator(s);if(r!==n.nullHandle){let n;this.m_topoGraph.getVertexFromVertexIterator(r),n=-1!==u?this.chooseVertexByOrder(s,a,u,c):this.chooseVertexFromCluster_(s,t),a.addVertex(e,n)}}}}return-1!==c&&a.removeUserIndex(c),-1!==u&&a.removeUserIndex(u),-1!==h&&a.removeUserIndex(h),this.m_topoGraph.deleteUserIndexForHalfEdges(g),i.makePair(l,d)}difference(e,t){const r=this.m_topoGraph.getShape().getGeometryType(e),i=this.m_topoGraph.getShape().getGeometryType(t),o=s.getDimensionFromType(r),a=s.getDimensionFromType(i);if(o>a)return e;const m=this.m_topoGraph.getGeometryID(e),l=this.m_topoGraph.getGeometryID(t);if(this.m_maskLookup.length=0,this.m_maskLookup.length=1+(m|l),this.m_maskLookup[m]=!0,2===o&&2===a){let s=n.nullHandle;return this.m_topoGraph.getShape().getVertexDescription().getAttributeCount()>1&&(s=e),this.topoOperationPolygonPolygon_(e,t,s)}if(1===o&&2===a){const t={unsplitBehavior:0,allCrossRoadsImpassable:!1,ogcRule:!1};return t.ogcRule=this.m_bOGCOutput,t.unsplitBehavior=0,this.topoOperationPolylineSimplifyOrPolylineTopoHelper_(e,n.nullHandle,!1,t).first}if(1===o&&1===a){const t={unsplitBehavior:0,allCrossRoadsImpassable:!0,ogcRule:!1};return t.ogcRule=this.m_bOGCOutput,t.unsplitBehavior=0,this.topoOperationPolylineSimplifyOrPolylineTopoHelper_(e,n.nullHandle,!1,t).first}if(0===o)return this.topoOperationMultiPoint_();s.throwInternalErrorException("")}symmetricDifference(e,t){const r=this.m_topoGraph.getShape().getGeometryType(e),i=this.m_topoGraph.getShape().getGeometryType(t),o=Ps(r),a=Ps(i),m=this.m_topoGraph.getGeometryID(e),l=this.m_topoGraph.getGeometryID(t);return s.geometryReleaseAssert(m>=0),s.geometryReleaseAssert(l>=0),this.m_maskLookup.length=0,this.m_maskLookup.length=1+(m|l),this.m_maskLookup[m]=!0,this.m_maskLookup[m]=!0,this.m_maskLookup[l]=!0,2===o&&2===a?this.topoOperationPolygonPolygon_(e,t,n.nullHandle):1===o&&1===a?this.topoOperationPolyline_(n.nullHandle,this.m_bOGCOutput):0===o&&0===a?this.topoOperationMultiPoint():void s.throwInternalErrorException("")}planarSimplifyNoCrackingAndCluster(e,t,r,i){this.m_bOGCOutput=e,this.m_topoGraph=new z;const o=t.getFillRule(r),a=t.getGeometryType(r);if(1!==o||a===s.GeometryType.enumMultiPoint?this.m_topoGraph.setAndSimplifyEditShapeAlternate(t,r,this.m_progressTracker):this.m_topoGraph.setAndSimplifyEditShapeWinding(t,r,this.m_progressTracker),this.m_topoGraph.dirtyCheckFailed())return!1;this.m_topoGraph.setCheckDirtyPlanesweepTolerance(Number.NaN);const m=this.m_topoGraph.getGeometryID(r);if(s.geometryReleaseAssert(m>=0),this.m_maskLookup.length=0,this.m_maskLookup.length=m+1,this.m_maskLookup[m]=!0,t.getGeometryType(r)===s.GeometryType.enumPolygon||1===o&&t.getGeometryType(r)!==s.GeometryType.enumMultiPoint){t.setFillRule(r,0);const s=this.topoOperationPolygonPolygon_(r,n.nullHandle,n.nullHandle);if(t.swapGeometry(s,r),t.removeGeometry(s),1===o&&this.m_bOGCOutput)return this.planarSimplifyNoCrackingAndCluster(e,t,r,i)}else if(t.getGeometryType(r)===s.GeometryType.enumPolyline){const e={unsplitBehavior:0,allCrossRoadsImpassable:!1,ogcRule:!1};e.ogcRule=this.m_bOGCOutput,e.allCrossRoadsImpassable=!0,e.unsplitBehavior=i;const s=this.topoOperationPolylineSimplify_(t.getFirstGeometry(),e);t.swapGeometry(s,r),t.removeGeometry(s)}else if(t.getGeometryType(r)===s.GeometryType.enumMultiPoint){const e=this.topoOperationMultiPoint_();t.swapGeometry(e,r),t.removeGeometry(e)}else s.throwInternalErrorException("");return!0}unsplitPolylineExact(e){return s.geometryReleaseAssert(0),new n.Polyline}planarSimplifyPolylines(e,t,r,i,o){for(let t=e.getFirstGeometry();t!==n.nullHandle;t=e.getNextGeometry(t)){const n=e.getGeometryType(t);s.geometryReleaseAssert(n===s.GeometryType.enumPolyline)}let a=0,m=0,l=null;if(e.hasCurves()&&!e.hasSegmentParentage()){l=new ms;const s=e.getEnvelope2D(this.m_progressTracker);m=os(t.total());const n=is(t.total(),s);a=as(n,m),ss(e,n,t.total(),0,l,null,this.m_progressTracker)}{const s=cs(t.add(a));e.filterClosePoints(s,!1,!1,!1,n.nullHandle)}if(this.m_topoGraph=new z,4!==o&&5!==o)if(null===l&&r){const s=new _e(this.m_progressTracker,!1);s.sweepVertical(e,t.total()),s.hadComplications()?(hs(e,t,this.m_progressTracker,!0,!1),r=!1):this.m_topoGraph.setCheckDirtyPlanesweepTolerance(t.total())}else hs(e,t.add(a),this.m_progressTracker,!0,!1),r=!1;else r=!1;e.removeSelection(),e.collapseAllGeometriesToFirst();const h=e.getFirstGeometry();if(this.m_topoGraph.setAndSimplifyEditShapeAlternate(e,h,this.m_progressTracker),this.m_topoGraph.dirtyCheckFailed())return s.geometryReleaseAssert(r&&null===l),this.m_topoGraph.removeShape(),this.m_topoGraph=null,this.planarSimplifyPolylines(e,t,!1,i,-1);this.m_topoGraph.setCheckDirtyPlanesweepTolerance(Number.NaN);const g=this.m_topoGraph.getGeometryID(h);s.geometryReleaseAssert(g>=0),this.m_maskLookup.length=0,this.m_maskLookup.length=g+1,this.m_maskLookup[g]=!0;const u=this.topoOperationPolylineSimplify_(e.getFirstGeometry(),i);null!==l&&l.stitchCurves(e,u,m,!0);const c=e.getGeometry(u);return r||c.getImpl().setIsSimple(4,t.total()),c}planarSimplifyMultiPoints(e,t,r,i){for(let t=e.getFirstGeometry();t!==n.nullHandle;t=e.getNextGeometry(t)){const n=e.getGeometryType(t);s.geometryReleaseAssert(n===s.GeometryType.enumMultiPoint)}this.m_topoGraph=new z,4!==i&&5!==i?(hs(e,t,this.m_progressTracker,!0,!1),r=!1):r=!1,e.removeSelection(),e.collapseAllGeometriesToFirst();const o=e.getFirstGeometry();if(this.m_topoGraph.setAndSimplifyEditShapeAlternate(e,o,this.m_progressTracker),this.m_topoGraph.dirtyCheckFailed())return s.geometryReleaseAssert(r),this.m_topoGraph.removeShape(),this.m_topoGraph=null,this.planarSimplifyMultiPoints(e,t,!1,-1);this.m_topoGraph.setCheckDirtyPlanesweepTolerance(Number.NaN);const a=this.m_topoGraph.getGeometryID(o);s.geometryReleaseAssert(a>=0),this.m_maskLookup.length=0,this.m_maskLookup.length=a+1,this.m_maskLookup[a]=!0;const m=this.topoOperationMultiPoint(),l=e.getGeometry(m);return r||l.getImpl().setIsSimple(4,t.total()),l}planarSimplifyPolygons(e,t,r,i,o,a){for(let t=e.getFirstGeometry();t!==n.nullHandle;t=e.getNextGeometry(t)){const n=e.getGeometryType(t);s.geometryReleaseAssert(n===s.GeometryType.enumPolygon||n===s.GeometryType.enumPolyline&&r)}let m=0,l=0,h=null;if(e.hasCurves()&&!e.hasSegmentParentage()){h=new ms;const s=e.getEnvelope2D(this.m_progressTracker);l=os(t.total());const n=is(t.total(),s);m=as(n,l),ss(e,n,t.total(),0,h,null,this.m_progressTracker)}if(a){hs(e,t.add(m),this.m_progressTracker,!0,!1);for(let t=e.getFirstGeometry();t!==n.nullHandle;t=e.getNextGeometry(t))e.getGeometryType(t)===s.GeometryType.enumPolygon&&Ge(e,t,-1,!1,n.nullHandle,this.m_progressTracker)}if(this.m_topoGraph=new z,a||4===o||5===o)i=!1;else if(null===h&&i){const s=new _e(this.m_progressTracker,!1);s.sweepVertical(e,t.total()),s.hadComplications()?(hs(e,t,this.m_progressTracker,!0,!1),i=!1):this.m_topoGraph.setCheckDirtyPlanesweepTolerance(t.total())}else hs(e,t.add(m),this.m_progressTracker,!0,!1),i=!1;e.removeSelection(),e.collapseAllGeometriesToFirst();const g=e.getFirstGeometry();if(r?this.m_topoGraph.setAndSimplifyEditShapeWinding(e,g,this.m_progressTracker):this.m_topoGraph.setAndSimplifyEditShapeAlternate(e,g,this.m_progressTracker),this.m_topoGraph.dirtyCheckFailed())return s.geometryReleaseAssert(i&&null===h),this.m_topoGraph.removeShape(),this.m_topoGraph=null,this.planarSimplifyPolygons(e,t,r,!1,-1,!1);this.m_topoGraph.setCheckDirtyPlanesweepTolerance(Number.NaN);const u=this.m_topoGraph.getGeometryID(g);s.geometryReleaseAssert(u>=0),this.m_maskLookup.length=0,this.m_maskLookup.length=u+1,this.m_maskLookup[u]=!0,e.setFillRule(g,0);const c=this.m_bOGCOutput&&r,p=c;let d=this.topoOperationPolygonPolygon_(g,n.nullHandle,n.nullHandle,p);c&&(this.m_topoGraph.removeShape(),this.m_topoGraph=null,e.removeGeometry(g),this.m_topoGraph=new z,this.m_topoGraph.setAndSimplifyEditShapeAlternate(e,d,this.m_progressTracker),d=this.topoOperationPolygonPolygon_(d,n.nullHandle,n.nullHandle,!1)),null!==h&&h.stitchCurves(e,d,l,!0);const _=e.getGeometry(d);return _.setFillRule(0),i?_.getImpl().setIsSimple(3,0):(_.getImpl().setIsSimple(4,t.total()),_.getImpl().updateOGCFlagsProtected()),_}planarSimplify3DImpl_(e,t,n,r,i){return s.geometryReleaseAssert(0),{}}planarSimplifyImpl_(e,t,i,o,a,m,l,h){if(e.isEmpty())return e.clone();const g=e.getGeometryType(),u=new n.EditShape,c=u.addGeometry(e);if(r.isAtLeastWeakSimple(a)&&g===s.GeometryType.enumPolygon&&(i=!1,u.setFillRule(c,0)),h&&(e.hasAttribute(1)&&u.replaceNaNs(1,0),u.removeNaNVertices()),g===s.GeometryType.enumPolygon||g===s.GeometryType.enumPolyline&&i)return this.planarSimplifyPolygons(u,t,i,o,a,!1);if(g===n.Polyline.type){const e={unsplitBehavior:0,allCrossRoadsImpassable:!0,ogcRule:!1};return e.ogcRule=this.m_bOGCOutput,e.unsplitBehavior=l,this.planarSimplifyPolylines(u,t,o,e,a)}if(g===s.GeometryType.enumMultiPoint)return this.planarSimplifyMultiPoints(u,t,o,a);s.throwInternalErrorException("what else?")}}function ws(e,t,i,o){const a=e.getGeometryType();if(a===s.GeometryType.enumEnvelope){const t=new n.Polygon({vd:e.getDescription()});return e.isEmpty()||t.addEnvelope(e,!1),t}if(a===s.GeometryType.enumPoint&&("|"===o||"^"===o)){const t=new n.MultiPoint({vd:e.getDescription()});return e.isEmpty()||t.add(e),t}if(a===s.GeometryType.enumLine){const t=new n.Polyline({vd:e.getDescription()});return e.isEmpty()||t.addSegment(e,!0),t}if(a===s.GeometryType.enumMultiPoint&&"-"===o&&t.getGeometryType()===s.GeometryType.enumPoint){const t=new r.Point({vd:e.getDescription()});return e.isEmpty()||e.getPointByVal(0,t),t}if(a===s.GeometryType.enumMultiPoint&&"&"===o&&t.getGeometryType()===s.GeometryType.enumPoint){const t=new r.Point({vd:e.getDescription()});return e.isEmpty()||e.getPointByVal(0,t),t}return e}function bs(e){const t=e.getGeometryType();if(t===s.GeometryType.enumEnvelope){const t=new n.Polygon({vd:e.getDescription()});return e.isEmpty()||t.addEnvelope(e,!1),t}if(t===s.GeometryType.enumPoint){const t=new n.MultiPoint({vd:e.getDescription()});return e.isEmpty()||t.add(e),t}if(xs(t)){const t=new n.Polyline({vd:e.getDescription()});return e.isEmpty()||t.addSegment(e,!0),t}return t!==s.GeometryType.enumMultiPoint&&t!==s.GeometryType.enumPolyline&&t!==s.GeometryType.enumPolygon&&s.throwInvalidArgumentException("Unexpected geometry type"),e}function Gs(e,t,r,i){const o=r===n.nullHandle?e.getClusterHalfEdge(t):r;let a=o;s.geometryReleaseAssert(e.getHalfEdgeOrigin(o)===t);do{i(a),a=e.getHalfEdgeNext(e.getHalfEdgeTwin(a))}while(a!==o)}class Ns{constructor(e,t,s,r,i,o){this.m_rParent=e,this.m_rTopoGraph=e.m_topoGraph,this.m_rShape=this.m_rTopoGraph.getShape(),this.m_IDCuttee=this.m_rTopoGraph.getGeometryID(r),this.m_IDCutter=this.m_rTopoGraph.getGeometryID(i),this.m_IDBoth=this.m_IDCuttee|this.m_IDCutter,this.m_bConsiderTouch=t,this.m_sideIndex=s,this.m_cuttee=r,this.m_cutter=i,this.m_rCutHandles=o,this.m_cutteeBreadcrumbsIndex=this.m_rShape.createUserIndexUninitialized(),this.m_clusterParentageIndex=this.m_rShape.createUserIndexUninitialized();for(let e=this.m_rShape.getFirstPath(this.m_cuttee);e!==n.nullHandle;e=this.m_rShape.getNextPath(e)){let t=0;const s=this.m_rShape.getPathSize(e);for(let n=this.m_rShape.getFirstVertex(e);t<s;t++,n=this.m_rShape.getNextVertex(n))this.m_rShape.setUserIndex(n,this.m_clusterParentageIndex,this.m_rTopoGraph.getClusterParentage(this.m_rTopoGraph.getClusterFromVertex(n)))}}Do(){this.cutPolylinePolyline_(),this.m_rShape.removeUserIndex(this.m_cutteeBreadcrumbsIndex),this.m_rShape.removeUserIndex(this.m_clusterParentageIndex)}setTbd(e){return 8|e}classifyStandardCut(e,t,s,r){const i=this.m_rShape.getPrevVertex(e),o=this.m_rShape.getNextVertex(e),a=i===n.nullHandle?n.nullHandle:this.m_rTopoGraph.getHalfEdgeConnector(t,this.m_rTopoGraph.getClusterFromVertex(i)),m=o===n.nullHandle?n.nullHandle:this.m_rTopoGraph.getHalfEdgeConnector(t,this.m_rTopoGraph.getClusterFromVertex(o)),l=this.m_rTopoGraph.getHalfEdgeConnector(t,this.m_rTopoGraph.getClusterFromVertex(s)),h=this.m_rTopoGraph.getHalfEdgeConnector(t,this.m_rTopoGraph.getClusterFromVertex(r));let g=1,u=32,c=32;if(Gs(this.m_rTopoGraph,t,h,e=>{e===l&&(g=2),e===a&&(u=g),e===m&&(c=g)}),this.m_bConsiderTouch)32!==u&&this.m_rShape.setUserIndex(i,this.m_cutteeBreadcrumbsIndex,this.m_rShape.getUserIndex(i,this.m_cutteeBreadcrumbsIndex)|u),32!==c&&this.m_rShape.setUserIndex(e,this.m_cutteeBreadcrumbsIndex,this.m_rShape.getUserIndex(e,this.m_cutteeBreadcrumbsIndex)|c);else{if(32===u||32===c)return 1;if(u===c&&a!==l&&a!==h&&m!==l&&m!==h)return 1;this.m_rShape.setUserIndex(i,this.m_cutteeBreadcrumbsIndex,this.m_rShape.getUserIndex(i,this.m_cutteeBreadcrumbsIndex)|u),this.m_rShape.setUserIndex(e,this.m_cutteeBreadcrumbsIndex,this.m_rShape.getUserIndex(e,this.m_cutteeBreadcrumbsIndex)|c)}return 0}classifyTouchCut(e,t,s,r){const i=this.m_rShape.getPrevVertex(e),o=this.m_rShape.getNextVertex(e),a=i===n.nullHandle?n.nullHandle:this.m_rTopoGraph.getHalfEdgeConnector(t,this.m_rTopoGraph.getClusterFromVertex(i)),m=o===n.nullHandle?n.nullHandle:this.m_rTopoGraph.getHalfEdgeConnector(t,this.m_rTopoGraph.getClusterFromVertex(o)),l=s===n.nullHandle?n.nullHandle:this.m_rTopoGraph.getHalfEdgeConnector(t,this.m_rTopoGraph.getClusterFromVertex(s)),h=r===n.nullHandle?n.nullHandle:this.m_rTopoGraph.getHalfEdgeConnector(t,this.m_rTopoGraph.getClusterFromVertex(r));if(!this.m_bConsiderTouch){let t;return(t=l===a||h===a)?this.m_rShape.setUserIndex(e,this.m_cutteeBreadcrumbsIndex,this.setTbd(this.m_rShape.getUserIndex(e,this.m_cutteeBreadcrumbsIndex))):(t=l===m||h===m)&&this.m_rShape.setUserIndex(i,this.m_cutteeBreadcrumbsIndex,this.setTbd(this.m_rShape.getUserIndex(i,this.m_cutteeBreadcrumbsIndex))),t?0:1}if(a===n.nullHandle)return this.m_rShape.setUserIndex(e,this.m_cutteeBreadcrumbsIndex,this.setTbd(this.m_rShape.getUserIndex(e,this.m_cutteeBreadcrumbsIndex))),0;if(m===n.nullHandle)return this.m_rShape.setUserIndex(i,this.m_cutteeBreadcrumbsIndex,this.setTbd(this.m_rShape.getUserIndex(i,this.m_cutteeBreadcrumbsIndex))),0;if(a===m)return this.m_rShape.setUserIndex(i,this.m_cutteeBreadcrumbsIndex,this.setTbd(this.m_rShape.getUserIndex(i,this.m_cutteeBreadcrumbsIndex))),this.m_rShape.setUserIndex(e,this.m_cutteeBreadcrumbsIndex,this.setTbd(this.m_rShape.getUserIndex(e,this.m_cutteeBreadcrumbsIndex))),0;if(h!==n.nullHandle){if(a===h)return this.m_rShape.setUserIndex(e,this.m_cutteeBreadcrumbsIndex,this.setTbd(this.m_rShape.getUserIndex(e,this.m_cutteeBreadcrumbsIndex))),0;if(m===h)return this.m_rShape.setUserIndex(i,this.m_cutteeBreadcrumbsIndex,this.setTbd(this.m_rShape.getUserIndex(i,this.m_cutteeBreadcrumbsIndex))),0;let s=1;Gs(this.m_rTopoGraph,t,h,t=>{if(t===a){const e=this.m_rShape.getUserIndex(i,this.m_cutteeBreadcrumbsIndex)|s;this.m_rShape.setUserIndex(i,this.m_cutteeBreadcrumbsIndex,e),s=2}else if(t===m){const t=this.m_rShape.getUserIndex(e,this.m_cutteeBreadcrumbsIndex)|s;this.m_rShape.setUserIndex(e,this.m_cutteeBreadcrumbsIndex,t),s=2}})}else{if(a===l)return this.m_rShape.setUserIndex(e,this.m_cutteeBreadcrumbsIndex,this.setTbd(this.m_rShape.getUserIndex(e,this.m_cutteeBreadcrumbsIndex))),0;if(m===l)return this.m_rShape.setUserIndex(i,this.m_cutteeBreadcrumbsIndex,this.setTbd(this.m_rShape.getUserIndex(i,this.m_cutteeBreadcrumbsIndex))),0;let s=2;Gs(this.m_rTopoGraph,t,l,t=>{if(t===a){const e=this.m_rShape.getUserIndex(i,this.m_cutteeBreadcrumbsIndex)|s;this.m_rShape.setUserIndex(i,this.m_cutteeBreadcrumbsIndex,e),s=1}else if(t===m){const t=this.m_rShape.getUserIndex(e,this.m_cutteeBreadcrumbsIndex)|s;this.m_rShape.setUserIndex(e,this.m_cutteeBreadcrumbsIndex,t),s=1}})}return 0}classifyCutVertex(e,t){let s=0,r=0;for(let i=this.m_rTopoGraph.getClusterVertexIterator(t);i!==n.nullHandle;i=this.m_rTopoGraph.incrementVertexIterator(i)){const o=this.m_rTopoGraph.getVertexFromVertexIterator(i);if(this.m_rShape.getGeometryFromVertex(o)===this.m_cutter){r++;const i=this.m_rShape.getPrevVertex(o),a=this.m_rShape.getNextVertex(o);i===n.nullHandle||a===n.nullHandle?s+=this.classifyTouchCut(e,t,i,a):s+=this.classifyStandardCut(e,t,i,a)}}r&&s===r&&!this.m_bConsiderTouch&&this.m_rShape.setUserIndex(e,this.m_clusterParentageIndex,this.m_IDCuttee)}cutPolylinePolyline_(){this.m_rShape.getGeometryType(this.m_cuttee),this.m_rShape.getGeometryType(this.m_cutter),this.m_rParent.m_maskLookup.length=0,this.m_rParent.m_maskLookup.length=this.m_IDBoth+1,this.m_rParent.m_maskLookup[this.m_IDBoth]=!0;for(let e=this.m_rShape.getFirstPath(this.m_cuttee);e!==n.nullHandle;e=this.m_rShape.getNextPath(e)){const t=this.m_rShape.getPathSize(e);let s=this.m_rShape.getFirstVertex(e);for(let e=0;e<t;++e,s=this.m_rShape.getNextVertex(s))this.m_rShape.setUserIndex(s,this.m_cutteeBreadcrumbsIndex,0);s=this.m_rShape.getFirstVertex(e);for(let e=0;e<t;++e,s=this.m_rShape.getNextVertex(s)){const e=this.m_rTopoGraph.getClusterFromVertex(s);this.m_rTopoGraph.getClusterParentage(e)===this.m_IDBoth&&this.classifyCutVertex(s,e)}}const e=(e,t)=>{let s=this.m_rShape.getUserIndex(e,this.m_cutteeBreadcrumbsIndex);const n=this.m_rTopoGraph.getHalfEdgeConnector(this.m_rTopoGraph.getClusterFromVertex(e),this.m_rTopoGraph.getClusterFromVertex(t));return(this.m_rTopoGraph.getHalfEdgeParentage(n)&this.m_IDBoth)===this.m_IDBoth&&(s|=4),s};for(let t=this.m_rShape.getFirstPath(this.m_cuttee);t!==n.nullHandle;t=this.m_rShape.getNextPath(t)){let s=this.m_rShape.getFirstVertex(t);const n=this.m_rShape.isClosedPath(t),r=this.m_rShape.getPathSize(t)+(n?1:0);let i=1,o=32;for(let t=this.m_rShape.getNextVertex(s);i<r;++i,s=t,t=this.m_rShape.getNextVertex(t)){const n=e(s,t);this.m_rShape.getUserIndex(s,this.m_clusterParentageIndex)===this.m_IDBoth&&(o=n),32!==o&&this.m_rShape.setUserIndex(s,this.m_cutteeBreadcrumbsIndex,o|n)}s=this.m_rShape.getLastVertex(t);let a=32;i=1;for(let t=this.m_rShape.getPrevVertex(s);i<r;++i,s=t,t=this.m_rShape.getPrevVertex(t)){const n=e(t,s);this.m_rShape.getUserIndex(s,this.m_clusterParentageIndex)===this.m_IDBoth&&(a=n),32!==a&&this.m_rShape.setUserIndex(t,this.m_cutteeBreadcrumbsIndex,a|n)}}let t=n.nullHandle,r=n.nullHandle,i=32;const o=this.m_rShape.hasSegmentParentage(),a=new n.SegmentBuffer;for(let e=this.m_rShape.getFirstPath(this.m_cuttee);e!==n.nullHandle;e=this.m_rShape.getNextPath(e)){const m=this.m_rShape.isClosedPath(e),l=this.m_rShape.getPathSize(e)+(m?1:0);let h=1,g=this.m_rShape.getFirstVertex(e),u=n.nullHandle,c=!0;for(let e=this.m_rShape.getNextVertex(g);h<l;++h,e=this.m_rShape.getNextVertex(e)){let m=this.m_rShape.getUserIndex(g,this.m_cutteeBreadcrumbsIndex);8===m?m=3:(m&=-9,4&m?m=4:3&~m||(m=3)),m!==i?(t!==n.nullHandle&&(u=this.m_rShape.addVertex(r,g),o&&this.m_rTopoGraph.isBreakNode(this.m_rTopoGraph.getClusterFromVertex(g))&&this.m_rShape.setSegmentParentageBreakVertex(u,!0),this.m_rCutHandles.push(t),this.m_rShape.setGeometryUserIndex(t,this.m_sideIndex,i)),t=this.m_rShape.createGeometry(s.GeometryType.enumPolyline),r=this.m_rShape.insertPath(t,n.nullHandle),i=m,c=!0):this.m_rShape.getUserIndex(g,this.m_clusterParentageIndex)===this.m_IDBoth&&4!==m&&(u=this.m_rShape.addVertex(r,g),o&&this.m_rTopoGraph.isBreakNode(this.m_rTopoGraph.getClusterFromVertex(g))&&this.m_rShape.setSegmentParentageBreakVertex(u,!0),r=this.m_rShape.insertPath(t,n.nullHandle),c=!0),u=this.m_rShape.addVertex(r,g);const l=this.m_rTopoGraph.getClusterFromVertex(g);!c&&o&&this.m_rTopoGraph.isBreakNode(l)&&this.m_rShape.setSegmentParentageBreakVertex(u,!0);const h=this.m_rTopoGraph.getHalfEdgeFromVertex(g);if(o){const e=this.m_rTopoGraph.getSegmentParentage(h);this.m_rShape.setSegmentParentageAndBreak(u,e,c||this.m_rTopoGraph.isBreakNode(l))}this.m_rTopoGraph.isHalfEdgeCurve(h)&&(this.m_rTopoGraph.querySegmentXY(h,a),this.m_rShape.setSegmentToIndex(this.m_rShape.getVertexIndex(u),a.get().clone())),g=e,c=!1}u=this.m_rShape.addVertex(r,g),o&&this.m_rTopoGraph.isBreakNode(this.m_rTopoGraph.getClusterFromVertex(g))&&this.m_rShape.setSegmentParentageBreakVertex(u,!0),this.m_rCutHandles.push(t),this.m_rShape.setGeometryUserIndex(t,this.m_sideIndex,i),t=n.nullHandle,r=n.nullHandle,i=32}}}function Hs(e,i,o,a,m){if(a&&(a.m_reason=0,a.m_vertexIndex1=-1,a.m_vertexIndex2=-1),e.isEmpty())return 5;const l=e.getGeometryType();if(l===s.GeometryType.enumPoint)return Fs(e,a);const h=r.calculateToleranceFromGeometryForOpFromGeom(i,e,!1).total();if(l===s.GeometryType.enumEnvelope){const s=e,n=t.Envelope2D.constructEmpty();return s.queryEnvelope(n),n.isDegenerate(h)?(a&&(a.m_reason=4,a.m_vertexIndex1=-1,a.m_vertexIndex2=-1),0):5}if(s.isSegment(l)){const t=e,s=new n.Polyline({vd:t.getDescription()});return s.addSegment(t,!0),Hs(s,i,o,a,m)}const g=e.getImpl().getIsSimple(h,[0]);let u=o?-1:g;if(-1!==u)return u;const c=new Ys(e,i,u,m,!1);return l===s.GeometryType.enumMultiPoint?u=c.multipointIsSimpleAsFeature():l===s.GeometryType.enumPolyline?u=c.polylineIsSimpleAsFeature():l===s.GeometryType.enumPolygon?u=c.polygonIsSimpleAsFeature():s.throwInternalErrorException(""),e.getImpl().setIsSimple(u,h),a&&a.assign(c.m_nonSimpleResult),u}function As(e,i,o,a){if(e.isEmpty())return e;const m=e.getGeometryType();if(m===s.GeometryType.enumPoint){const t=new g.NonSimpleResult;if(Fs(e,t),3===t.m_reason){const t=e.clone();return t.replaceNaNs(1,0),t}return 2===t.m_reason?e.createInstance():e}if(m===s.GeometryType.enumEnvelope){const s=r.calculateToleranceFromGeometryForOpFromGeom(i,e,!0).total(),n=e,o=t.Envelope2D.constructEmpty();return n.queryEnvelope(o),o.isDegenerate(s)?n.createInstance():e}if(s.isSegment(m)){const t=e,s=new n.Polyline({vd:t.getDescription()});return s.addSegment(t,!0),As(s,i,o,a)}s.throwIfGeometryCollectionType(m);const l=r.calculateToleranceFromGeometryForOpFromGeom(i,e,!1).total(),h=e.getImpl().getIsSimple(l,[0]),u=o?-1:h;if(r.isAtLeastPlanarSimple(u)){if(m===s.GeometryType.enumPolygon&&0!==e.getFillRule()){const t=e.clone();return t.setFillRule(0),t}return e}if((m===s.GeometryType.enumMultiPoint||m===s.GeometryType.enumPolyline)&&u>=1)return e;const c=new Ys(e,i,u,a,!1);let p;return m===s.GeometryType.enumMultiPoint?p=c.multipointSimplifyAsFeature():m===s.GeometryType.enumPolyline?p=c.polylineSimplifyAsFeature():m===s.GeometryType.enumPolygon?p=c.polygonSimplifyAsFeature():s.throwInternalErrorException(""),p}function Fs(e,t){const s=e.getX(),n=e.getY();if(!Number.isFinite(s)||!Number.isFinite(n))return t&&(t.m_reason=2,t.m_vertexIndex1=-1,t.m_vertexIndex2=-1),0;if(e.hasAttribute(1)){const s=e.getZ();if(!Number.isFinite(s))return t&&(t.m_reason=Number.isNaN(s)?3:2,t.m_vertexIndex1=-1,t.m_vertexIndex2=-1),0}return 5}class Vs{constructor(){this.m_segment=null,this.m_vertexIndex=-1,this.m_pathIndex=-1,this.m_flags=0}setReversed(e){this.m_flags&=-2,this.m_flags=this.m_flags|(e?1:0)}getReversed(){return!!(1&this.m_flags)}getRightSide(){return this.getReversed()?0:1}}function Rs(e,t,s,n,r){return{x:e,y:t,ipath:s,ivertex:n,ipolygon:r}}function ks(e,t){return e.x===t.x&&e.y===t.y&&e.ipath===t.ipath&&e.ivertex===t.ivertex&&e.ipolygon===t.ipolygon}function Ms(e,t){e.x=t.x,e.y=t.y,e.ipath=t.ipath,e.ivertex=t.ivertex,e.ipolygon=t.ipolygon}function Us(e,t,s,n,r,i){return{x:e,y:t,ipath:s,ivertex:n,bBoundary:r,bEndPoint:i}}function Os(e,t){e.x=t.x,e.y=t.y,e.ipath=t.ipath,e.ivertex=t.ivertex,e.bBoundary=t.bBoundary,e.bEndPoint=t.bEndPoint}class Bs extends r.Comparator{constructor(e){super(),this.m_helper=e}compare(e,t,s){const n=e.getElement(s),r=this.m_helper.m_xy.read(2*t)-this.m_helper.m_xy.read(2*n);return r<0?-1:r>0?1:0}}class qs extends r.Comparator{constructor(e){super(),this.m_helper=e}compare(e,t,s){const n=e.getElement(s),r=this.m_helper.m_edges[t],i=this.m_helper.m_edges[n],o=r.getReversed(),a=i.getReversed();let m=r.m_segment.intersectionOfYMonotonicWithAxisX(this.m_helper.m_yScanline,0),l=i.m_segment.intersectionOfYMonotonicWithAxisX(this.m_helper.m_yScanline,0);if(m===l){const e=o?r.m_segment.getStartY():r.m_segment.getEndY(),t=a?i.m_segment.getStartY():i.m_segment.getEndY(),s=Math.min(e,t);let n=.5*(s-this.m_helper.m_yScanline)+this.m_helper.m_yScanline;n===this.m_helper.m_yScanline&&(n=s),m=r.m_segment.intersectionOfYMonotonicWithAxisX(n,0),l=i.m_segment.intersectionOfYMonotonicWithAxisX(n,0)}return m<l?-1:m>l?1:0}}class Ys{constructor(e,t,s,n,i){this.m_multiVertexGeom=null,this.m_edges=[],this.m_freeEdges=[],this.m_lineEdgesRecycle=[],this.m_newEdges=[],this.m_recycledSegIter=null,this.m_crossOverHelperList=new r.IndexMultiDCList,this.m_progressTracker=null,this.m_progressCounter=0,this.m_AET=new r.Treap,this.m_xyToNode1=null,this.m_xyToNode2=null,this.m_pathOrientations=null,this.m_pathParentage=null,this.m_xy=null,this.m_pairs=[],this.m_pairIndices=null,this.m_pathsForOGCTests=[],this.m_curveStitcher=null,this.m_editShape=null,this.m_multiPathStitcher=null,this.m_nonSimpleResult=new g.NonSimpleResult,this.m_progressCounter=0,this.m_progressTracker=n,this.m_geometry=e,this.m_knownSimpleResult=s,this.m_sr=t;const o=r.calculateToleranceFromGeometryForOpFromGeom(t,e,!1);this.m_toleranceIsSimple=o,this.m_toleranceIsSimpleClustering=r.adjustToleranceForTEClustering(o),this.m_toleranceIsSimpleCracking=r.adjustToleranceForTECracking(o),this.m_toleranceSimplify=r.calculateToleranceFromGeometryForOpFromGeom(t,e,!0),this.m_description=this.m_geometry.getDescription(),this.m_attributeCount=this.m_description.getAttributeCount(),this.m_bOGCRestrictions=i,this.m_bPlanarSimplify=this.m_bOGCRestrictions,this.m_unknownOrientationPathCount=-1,this.m_yScanline=0,this.m_progressCounter=0}isSimplePlanarImpl(){if(this.m_bPlanarSimplify=!0,!this.checkStructure())return 0;const e=this.m_geometry.getGeometryType();return s.isMultiPath(e)&&!this.checkDegenerateSegments(!1)?0:this._CheckClustering()?s.isMultiPath(e)?this._CheckCracking()?this.m_geometry.getGeometryType()===s.GeometryType.enumPolyline?this.checkSelfIntersectionsPolylinePlanar()?4:0:this._CheckSelfIntersections()?this._CheckValidRingOrientation():0:0:5:0}isSimplePlanarImpl3D(){return s.geometryReleaseAssert(0),7}generateSortedPairs(e){let t=null;s.isMultiPath(e.getGeometryType())&&(t=e);const n=(this.m_bPlanarSimplify||this.m_bOGCRestrictions)&&null!==t,o=e.getPointCount();this.m_xy=e.getAttributeStreamRef(0),this.m_pairs.length=0,this.m_pairIndices=new r.AttributeStreamOfInt32(0),n&&(this.m_pathsForOGCTests.length=0);let a=0;for(let e=0;e<o;e++)if(this.m_pairs.push(2*e),this.m_pairs.push(2*e+1),this.m_pairIndices.add(2*e),this.m_pairIndices.add(2*e+1),n){for(;e>=t.getPathEnd(a);)a++;this.m_pathsForOGCTests.push(a)}const m=new r.BucketSort,l={parent:this,workPt:new i.Point2D,userSort(e,t,s){s.sort(e,t,(e,t)=>this.parent.compareVerticesForPlanarClustering(e,t,n))},getValue(e){const t=this.parent.m_pairs[e],s=t>>1;return this.parent.m_xy.queryPoint2D(2*s,this.workPt),this.workPt.y+(1&t?this.parent.m_toleranceIsSimpleClustering:-this.parent.m_toleranceIsSimpleClustering)}};m.sort(this.m_pairIndices,0,2*o,l)}_TestToleranceDistancePlanar(e,t){const s=this.m_xy.read(2*e),n=this.m_xy.read(2*e+1),r=this.m_xy.read(2*t),i=this.m_xy.read(2*t+1);return!J(s,n,r,i,this.m_toleranceIsSimpleClustering*this.m_toleranceIsSimpleClustering)||0!==this.m_geometry.getDimension()&&s===r&&n===i}checkStructure(){const e=this.m_geometry.getGeometryType();if(s.isMultiPath(e)){const e=this.m_geometry.getImpl(),t=this.m_geometry.getGeometryType()===s.GeometryType.enumPolygon?3:2;for(let s=0,n=e.getPathCount();s<n;s++)if(e.getPathSize(s)<t){if(e.hasNonLinearSegments()&&e.hasNonLinearSegmentsPath(s)&&e.getPathSize(s)>0)continue;return this.m_nonSimpleResult=new g.NonSimpleResult(1,s,0),!1}}if(s.isMultiVertex(e)){const e=this.m_geometry.getImpl(),t=e.getAttributeStreamRef(0);for(let s=0,n=e.getPointCount();s<n;s++)if(!t.readPoint2D(2*s).isFinite())return this.m_nonSimpleResult=new g.NonSimpleResult(2,s,0),!1;if(this.m_geometry.hasAttribute(1)){const t=e.getAttributeStreamRef(1);for(let s=0,n=e.getPointCount();s<n;s++){const e=t.read(s);if(!Number.isFinite(e))return Number.isNaN(e)?this.m_nonSimpleResult=new g.NonSimpleResult(3,s,0):this.m_nonSimpleResult=new g.NonSimpleResult(2,s,0),!1}}}return!0}checkDegenerateSegments(e){const t=this.m_geometry.getImpl(),s=t.querySegmentIterator(),n=t.hasAttribute(1),i=n?r.calculateZToleranceFromGeometryForOpFromGeom(this.m_sr,t,!1).total():0,o=t.hasNonLinearSegments(),a=this.m_toleranceIsSimple.total();for(;s.nextPath();)for(;s.hasNextSegment();){const t=s.nextSegment();let r=t.calculateLowerLength2D();if(!(r>a||o&&t.isCurve()&&(r=t.calculateLength2D(),r>a))){if(e&&n){const e=t.getStartAttributeAsDbl(1,0),s=t.getEndAttributeAsDbl(1,0);if(Math.abs(s-e)>i)continue}return this.m_nonSimpleResult=new g.NonSimpleResult(4,s.getStartPointIndex(),-1),!1}}return!0}checkDegenerateSegments3D(){return s.geometryReleaseAssert(0),!1}_CheckClustering(){const e=this.m_geometry.getImpl();this.generateSortedPairs(e);const t=e.getPointCount();this.m_AET.clear(),this.m_AET.setComparator(new Bs(this)),this.m_AET.setCapacity(t);for(let e=0,s=2*t;e<s;e++){this.progress_();const t=this.m_pairIndices.read(e),s=this.m_pairs[t],n=s>>1;if(1&s){const e=this.m_AET.search(n),t=this.m_AET.getPrev(e),s=this.m_AET.getNext(e);if(this.m_AET.deleteNode(e),t!==r.Treap.st_nullNode()&&s!==r.Treap.st_nullNode()&&!this._TestToleranceDistancePlanar(this.m_AET.getElement(t),this.m_AET.getElement(s)))return this.m_nonSimpleResult=new g.NonSimpleResult(5,this.m_AET.getElement(t),this.m_AET.getElement(s)),!1}else{const e=this.m_AET.addElement(n),t=this.m_AET.getPrev(e);if(t!==r.Treap.st_nullNode()&&!this._TestToleranceDistancePlanar(this.m_AET.getElement(t),n))return this.m_nonSimpleResult=new g.NonSimpleResult(5,n,this.m_AET.getElement(t)),!1;const s=this.m_AET.getNext(e);if(s!==r.Treap.st_nullNode()&&!this._TestToleranceDistancePlanar(this.m_AET.getElement(s),n))return this.m_nonSimpleResult=new g.NonSimpleResult(5,n,this.m_AET.getElement(s)),!1}}return!0}_CheckCracking(){const e=this.m_geometry.getImpl(),t=e.getPointCount();return!e.hasNonLinearSegments()&&t<10?this._CheckCrackingBrute():this._CheckCrackingPlanesweep()}_CheckCrackingPlanesweep(){if(this.m_editShape=new n.EditShape,this.m_editShape.addGeometry(this.m_geometry),this.m_editShape.hasCurves()){this.m_curveStitcher=new ms;const e=t.Envelope2D.constructEmpty();this.m_geometry.queryEnvelope(e);const s=is(this.m_toleranceSimplify.total(),e),n=new g.NonSimpleResult;if(ns(this.m_editShape,s,this.m_toleranceSimplify.total(),0,n,this.m_curveStitcher,null,this.m_progressTracker),0!==n.m_reason)return this.m_editShape=null,this.m_nonSimpleResult.assign(n),!1}const e=new g.NonSimpleResult;return Pe(!1,this.m_editShape,this.m_toleranceIsSimpleCracking,e,this.m_progressTracker)?(null!=this.m_curveStitcher?(e.m_vertexIndex1=this.m_curveStitcher.getOriginalVertexIndex(this.m_editShape,e.m_vertexIndex1),e.m_vertexIndex2=this.m_curveStitcher.getOriginalVertexIndex(this.m_editShape,e.m_vertexIndex2),this.m_curveStitcher=null):(e.m_vertexIndex1=this.m_editShape.getVertexIndex(e.m_vertexIndex1),e.m_vertexIndex2=this.m_editShape.getVertexIndex(e.m_vertexIndex2)),this.m_editShape=null,this.m_nonSimpleResult.assign(e),!1):(null==this.m_curveStitcher&&(this.m_editShape=null),!0)}_CheckCrackingBrute(){const e=this.m_geometry.getImpl(),t=e.querySegmentIterator(),s=e.querySegmentIterator();for(;t.nextPath();)for(;t.hasNextSegment();){const e=t.nextSegment();if(!t.isLastSegmentInPath()||!t.isLastPath()){s.resetTo(t);do{for(;s.hasNextSegment();){const r=s.nextSegment(),i=n.isIntersecting(!0,e,r,this.m_toleranceIsSimpleCracking,!0);if(i){const e=2===i?7:6;return this.m_nonSimpleResult=new g.NonSimpleResult(e,t.getStartPointIndex(),s.getStartPointIndex()),!1}}}while(s.nextPath())}}return!0}_CheckSelfIntersections(){let e=this.m_geometry.getImpl();null!==this.m_curveStitcher&&(this.m_multiPathStitcher=this.m_editShape.getGeometry(this.m_editShape.getFirstGeometry()),e=this.m_multiPathStitcher.getImpl(),this.generateSortedPairs(e)),this.m_edges.length=0,this.m_lineEdgesRecycle.length=0,this.m_recycledSegIter=e.querySegmentIterator(),this.m_recycledSegIter.setCirculator(!0);const t=[],s=e.getPointCount();let n=Number.NaN,r=0;for(let e=0,i=2*s;e<i;e++){this.progress_();const s=this.m_pairIndices.read(e),i=this.m_pairs[s];if(1&i)continue;const o=i>>1,a=this.m_xy.read(2*o),m=this.m_xy.read(2*o+1);if(t.length&&(a!==n||m!==r)){if(!this.processBunchForSelfIntersectionTest(t))return!1;t.length=0}t.push(o),n=a,r=m}return!!this.processBunchForSelfIntersectionTest(t)}checkSelfIntersectionsPolylinePlanar(){const e=this.m_geometry.getImpl(),t=[];for(let s=0,n=e.getPathCount();s<n;s++)t.push(e.isClosedPathInXYPlane(s));const s={x:-1,y:-1,ipath:-1,ivertex:-1,bBoundary:!1,bEndPoint:!1};let n,r,i;{const o=this.m_pairIndices.read(0),a=this.m_pairs[o]>>1,m=this.m_xy.readPoint2D(2*a),l=this.m_pathsForOGCTests[a];n=t[l],r=e.getPathStart(l),i=e.getPathEnd(l)-1,s.bEndPoint=a===r||a===i,this.m_bOGCRestrictions?s.bBoundary=!n&&s.bEndPoint:s.bBoundary=s.bEndPoint,s.ipath=l,s.x=m.x,s.y=m.y,s.ivertex=a}for(let o=1,a=this.m_pairIndices.size();o<a;o++){const a=this.m_pairIndices.read(o),m=this.m_pairs[a];if(1&m)continue;const l=m>>1,h=this.m_xy.readPoint2D(2*l),u=this.m_pathsForOGCTests[l];let c;u!==s.ipath&&(n=t[u],r=e.getPathStart(u),i=e.getPathEnd(u)-1);const p=l===r||l===i;c=this.m_bOGCRestrictions?!n&&p:p;const d=Us(h.x,h.y,u,l,c,p);if(d.x===s.x&&d.y===s.y)if(this.m_bOGCRestrictions){if(!(d.bBoundary&&s.bBoundary||d.ipath===s.ipath&&d.bEndPoint&&s.bEndPoint))return this.m_nonSimpleResult=new g.NonSimpleResult(10,d.ivertex,s.ivertex),!1}else if(!d.bEndPoint||!s.bEndPoint)return this.m_nonSimpleResult=new g.NonSimpleResult(7,d.ivertex,s.ivertex),!1;Os(s,d)}return!0}checkSelfIntersectionsPolylinePlanar3D(e){return s.geometryReleaseAssert(0),!1}checkSelfIntersectionsPolygonsOGC(){const e=this.m_geometry.getImpl(),t=[];let s=-1,n=!1;for(let r=0,i=e.getPathCount();r<i;r++)e.isExteriorRingOGC(r)&&(n=!1,s++,r<i-1&&(e.isExteriorRingOGC(r+1)||(n=!0))),t.push(n?s:-1);const o={x:-1,y:-1,ipath:-1,ivertex:-1,ipolygon:-1};{const e=this.m_pairIndices.read(0),s=this.m_pairs[e]>>1,n=this.m_xy.readPoint2D(2*s),r=this.m_pathsForOGCTests[s];o.ipath=r,o.x=n.x,o.y=n.y,o.ivertex=s,o.ipolygon=t[r]}const a=[];for(let e=1,s=this.m_pairIndices.size();e<s;e++){const s=this.m_pairIndices.read(e),n=this.m_pairs[s];if(1&n)continue;const r=n>>1,i=this.m_xy.readPoint2D(2*r),m=this.m_pathsForOGCTests[r],l=Rs(i.x,i.y,m,r,t[m]);if(l.x===o.x&&l.y===o.y){if(l.ipath===o.ipath)return this.m_nonSimpleResult=new g.NonSimpleResult(11,l.ivertex,o.ivertex),!1;t[l.ipath]>=0&&t[l.ipath]===t[o.ipath]&&(0!==a.length&&ks(a.at(-1),o)||a.push({...o}),a.push(l))}Ms(o,l)}if(0===a.length)return!0;const m=new r.IndexMultiDCList(!0);t.fill(-1);let l=-1;const h=new i.Point2D;for(let e=0,s=a.length;e<s;e++){const s=a[e];s.x===h.x&&s.y===h.y||(l=m.createList(0),h.x=s.x,h.y=s.y);let n=t[s.ipath];-1===n&&(n=m.createList(2),t[s.ipath]=n),m.addElement(n,l),m.addElement(l,n)}const u=[];for(let e=m.getFirstList();-1!==e;e=m.getNextList(e)){const s=m.getListData(e);if(1&s||!(2&s))continue;let n=-1;for(u.push(e),u.push(-1);u.length;){const e=u.at(-1);u.pop();const t=u.at(-1);u.pop();const s=m.getListData(t);if(1&s){n=2&s?t:e;break}m.setListData(t,1|s);for(let s=m.getFirst(t);-1!==s;s=m.getNext(s)){const n=m.getData(s);n!==e&&(u.push(n),u.push(t))}}if(-1!==n){const e=t.indexOf(n);return this.m_nonSimpleResult=new g.NonSimpleResult(12,e,-1),!1}}return!0}_CheckValidRingOrientation(){const e=null!==this.m_multiPathStitcher?this.m_multiPathStitcher.getImpl():this.m_geometry.getImpl();if(e.calculateArea2D()<=0)return this.m_nonSimpleResult=new g.NonSimpleResult(8,1===e.getPathCount()?1:-1,-1),0;if(1===e.getPathCount())return this.m_bOGCRestrictions&&!this.checkSelfIntersectionsPolygonsOGC()?0:4;this.m_pathOrientations=new r.AttributeStreamOfInt8(e.getPathCount(),0),this.m_pathParentage=new r.AttributeStreamOfInt32(e.getPathCount(),-1);let t=-1,s=0;for(let n=0,r=e.getPathCount();n<r;n++){const r=e.calculateRingArea2D(n);if(this.m_pathOrientations.write(n,r<0?0:8),r>0)t=n,s=r;else{if(0===r)return this.m_nonSimpleResult=new g.NonSimpleResult(8,n,-1),0;if((t<0||s<Math.abs(r))&&(this.m_nonSimpleResult=new g.NonSimpleResult(9,n,-1),this.m_bOGCRestrictions))return 0;this.m_pathParentage.write(n,t)}}this.m_unknownOrientationPathCount=e.getPathCount(),this.m_newEdges.length=0;const n=e.getPointCount();this.m_yScanline=Number.NaN;const i=[];this.m_xyToNode1=new r.AttributeStreamOfInt32(n,r.Treap.st_nullNode()),this.m_xyToNode2=new r.AttributeStreamOfInt32(n,r.Treap.st_nullNode()),this.m_freeEdges.length=0,this.m_AET.clear(),this.m_AET.setComparator(new qs(this));for(let e=0,t=2*n;this.m_unknownOrientationPathCount>0&&e<t;e++){const t=this.m_pairIndices.read(e),s=this.m_pairs[t];if(1&s)continue;const n=s>>1,r=this.m_xy.read(2*n+1);if(r!==this.m_yScanline&&i.length){if(!this.processBunchForRingOrientationTest(i))return 0;i.length=0}i.push(n),this.m_yScanline=r}return this.m_unknownOrientationPathCount>0&&!this.processBunchForRingOrientationTest(i)?0:this.m_bOGCRestrictions?0!==this.m_nonSimpleResult.m_reason?0:this.checkSelfIntersectionsPolygonsOGC()?5:0:0===this.m_nonSimpleResult.m_reason?4:3}processBunchForSelfIntersectionTest(e){if(1===e.length)return!0;for(let t=0,s=e.length;t<s;t++){const s=e[t];this.m_recycledSegIter.resetToVertex(s,-1);const n=this.m_recycledSegIter.previousSegment();this.m_edges.push(this.createEdge(n,s,this.m_recycledSegIter.getPathIndex(),!0)),this.m_recycledSegIter.nextSegment();const r=this.m_recycledSegIter.nextSegment();this.m_edges.push(this.createEdge(r,s,this.m_recycledSegIter.getPathIndex(),!1))}this.m_edges.sort((e,t)=>this.edgeAngleCompare(e,t));let t=this.m_crossOverHelperList.getFirstList();-1===t&&(t=this.m_crossOverHelperList.createList(0)),this.m_crossOverHelperList.reserveNodes(this.m_edges.length);for(let e=0,s=this.m_edges.length;e<s;e++)this.m_crossOverHelperList.addElement(t,e);let s=!0,n=-1,r=-1;for(;s;){s=!1;let e=this.m_crossOverHelperList.getFirst(t);if(-1===e)break;let i=this.m_crossOverHelperList.getNext(e);for(;-1!==i;){const o=this.m_crossOverHelperList.getData(e),a=this.m_crossOverHelperList.getData(i);if(n=this.m_edges[o].m_vertexIndex,r=this.m_edges[a].m_vertexIndex,n!==r)e=i,i=this.m_crossOverHelperList.getNext(e);else if(s=!0,this.m_crossOverHelperList.deleteElement(t,e),e=this.m_crossOverHelperList.getPrev(i),i=this.m_crossOverHelperList.deleteElement(t,i),-1===i||-1===e)break}}const i=this.m_crossOverHelperList.getListSize(t);if(this.m_crossOverHelperList.clear(t),i>0)return this.m_nonSimpleResult=new g.NonSimpleResult(7,n,r),!1;for(let t=0,s=e.length;t<s;t++)this.recycleEdge(this.m_edges[t]);return this.m_edges.length=0,!0}processBunchForRingOrientationTest(e){for(let t=0,s=e.length;t<s;t++){const s=e[t];let n=this.m_xyToNode1.read(s);if(n!==r.Treap.st_nullNode()){const e=this.m_AET.getElement(n);this.m_freeEdges.push(e),this.m_AET.deleteNode(n),this.recycleEdge(this.m_edges[e]),this.m_edges[e]=null,this.m_xyToNode1.write(s,r.Treap.st_nullNode())}if(n=this.m_xyToNode2.read(s),n!==r.Treap.st_nullNode()){const e=this.m_AET.getElement(n);this.m_freeEdges.push(e),this.m_AET.deleteNode(n),this.recycleEdge(this.m_edges[e]),this.m_edges[e]=null,this.m_xyToNode2.write(s,r.Treap.st_nullNode())}}for(let t=0,s=e.length;t<s;t++){const s=e[t];this.m_recycledSegIter.resetToVertex(s,-1);const n=this.m_recycledSegIter.previousSegment();if(n.getStartY()>n.getEndY()){const e=this.m_recycledSegIter.getStartPointIndex(),t=this.createEdge(n,s,this.m_recycledSegIter.getPathIndex(),!0);let i;this.m_freeEdges.length>0?(i=this.m_freeEdges.at(-1),this.m_freeEdges.pop(),this.m_edges[i]=t):(i=this.m_edges.length,this.m_edges.push(t));const o=this.m_AET.addElement(i);this.m_xyToNode1.read(e)===r.Treap.st_nullNode()?this.m_xyToNode1.write(e,o):this.m_xyToNode2.write(e,o),3&this.m_pathOrientations.read(this.m_recycledSegIter.getPathIndex())||this.m_newEdges.push(o)}this.m_recycledSegIter.nextSegment();const i=this.m_recycledSegIter.nextSegment();if(i.getStartY()<i.getEndY()){const e=this.m_recycledSegIter.getEndPointIndex(),t=this.createEdge(i,s,this.m_recycledSegIter.getPathIndex(),!1);let n;this.m_freeEdges.length>0?(n=this.m_freeEdges.at(-1),this.m_freeEdges.pop(),this.m_edges[n]=t):(n=this.m_edges.length,this.m_edges.push(t));const o=this.m_AET.addElement(n);this.m_xyToNode1.read(e)===r.Treap.st_nullNode()?this.m_xyToNode1.write(e,o):this.m_xyToNode2.write(e,o),3&this.m_pathOrientations.read(this.m_recycledSegIter.getPathIndex())||this.m_newEdges.push(o)}}for(let e=0,t=this.m_newEdges.length;e<t&&this.m_unknownOrientationPathCount>0;e++){const t=this.m_newEdges[e],s=this.m_AET.getElement(t),n=this.m_edges[s].m_pathIndex;if(!(3&this.m_pathOrientations.read(n))){let e=-1,s=this.m_AET.getPrev(t),n=t,i=0;{let t=-1,o=null,a=-1,m=0;for(;s!==r.Treap.st_nullNode()&&(t=this.m_AET.getElement(s),o=this.m_edges[t],a=o.m_pathIndex,m=this.m_pathOrientations.read(a),!(3&m));)n=s,s=this.m_AET.getPrev(s);s===r.Treap.st_nullNode()?(i=1,s=n):(e=1==(3&m)?a:this.m_pathParentage.read(a),i=o.getRightSide()?0:1,s=this.m_AET.getNext(s))}do{const t=this.m_AET.getElement(s),r=this.m_edges[t],o=r.m_pathIndex;let a=this.m_pathOrientations.read(o);if(!(3&a)){if(i!==r.getRightSide())return this.m_nonSimpleResult=new g.NonSimpleResult(8,o,-1),!1;const t=i&&!r.getReversed()?1:2;if(a=-4&a|t,this.m_pathOrientations.write(o,a),2===t&&0===this.m_nonSimpleResult.m_reason){const t=this.m_pathParentage.read(o);if(t!==e&&(this.m_nonSimpleResult=new g.NonSimpleResult(9,o,t),this.m_bOGCRestrictions))return!1}if(this.m_unknownOrientationPathCount--,!this.m_unknownOrientationPathCount)return!0}e=1==(3&a)?o:this.m_pathParentage.read(o),n=s,s=this.m_AET.getNext(s),i=i?0:1}while(n!==t)}}return this.m_newEdges.length=0,!0}createEdge(e,t,n,r){let i;return e.getGeometryType()===s.GeometryType.enumLine?i=this.createEdgeLine(e):(i=new Vs,i.m_segment=e.clone()),i.m_vertexIndex=t,i.m_pathIndex=n,i.m_flags=0,i.setReversed(r),i}createEdgeLine(e){let t;return this.m_lineEdgesRecycle.length>0?(t=this.m_lineEdgesRecycle.at(-1),this.m_lineEdgesRecycle.pop(),e.copyTo(t.m_segment)):(t=new Vs,t.m_segment=e.clone()),t}recycleEdge(e){e.m_segment.getGeometryType()===s.GeometryType.enumLine&&this.m_lineEdgesRecycle.push(e)}static isShortSegment(e,t,s,n){let r=e.calculateLowerLength2D();if(r<=s){let i=!0;if(e.isCurve()&&(r=e.calculateLength2D(),i=r<=s),i){if(t){let t=e.getEndAttributeAsDbl(1,0);Number.isNaN(t)&&(t=0);let s=e.getStartAttributeAsDbl(1,0);return Number.isNaN(s)&&(s=0),Math.abs(s-t)<=n}return!0}return!1}return!1}static isShortSegmentPoints(e,t,s,n,o){if(s){const s=e.getXYZ(),i=t.getXYZ();return r.isCoincidentForClustering(s,i,n,o)}{const s=e.getXY(),r=t.getXY();return i.Point2D.sqrDistance(s,r)<=n*n}}removeDegenerateSegmentsFromCurvedPath(e,t,n,o){const a=e.hasAttribute(1),m=e.querySegmentIterator();m.resetToPath(t),s.geometryReleaseAssert(m.nextPath());const l=this.m_toleranceSimplify.total();let h=!1,g=!0;const u=new r.Point,c=new r.Point,p=new i.Point2D;for(;m.hasNextSegment();){this.progress_();const e=m.nextSegment();if(Ys.isShortSegment(e,a,l,n))if(h){if(e.queryEnd(c),Ys.isShortSegmentPoints(u,c,a,l,n))continue;g&&(o.startPathPoint(u),g=!1),e.queryEnd(u),o.lineToPoint(u),h=!1}else p.assign(e.getStartXY()),e.queryStart(u),h=!0;else if(h)if(e.isCurve()){const t=e.clone();if(t.setCoordsForIntersector(p,e.getEndXY(),!1),t.setStart(u),Ys.isShortSegment(t,a,l,n))continue;o.addSegment(t,g),g=!1,h=!1}else{if(e.queryEnd(c),Ys.isShortSegmentPoints(u,c,a,l,n))continue;g&&(o.startPathPoint(u),g=!1),o.lineToPoint(c),h=!1}else o.addSegment(e,g),g=!1}if(g)return;if(!h)return;e.isClosedPath(t)?e.getPointByVal(e.getPathStart(t),u):e.getPointByVal(e.getPathEnd(t)-1,u);const d=o.querySegmentIterator();d.resetToLastPath(),d.resetToLastSegment();const _=o.getDescription().getAttributeCount()>1;for(s.geometryReleaseAssert(d.previousPath());d.hasPreviousSegment();){const e=d.previousSegment();if(e.isCurve()){const t=e.clone();if(t.setCoordsForIntersector(e.getStartXY(),u.getXY(),!1),!Ys.isShortSegment(t,a,l,n)){_&&t.setEnd(u);const e=d.getEndPointIndex();for(let t=o.getPointCount()-1;t>=e;t--)o.removePoint(t);return void o.addSegment(t,!1)}}else if(e.queryStart(c),!Ys.isShortSegmentPoints(c,u,a,l,n)){const e=d.getEndPointIndex();for(let t=o.getPointCount()-1;t>=e;t--)o.removePoint(t);return void o.lineToPoint(u)}}o.removePath(o.getPathCount()-1)}multipointIsSimpleAsFeature(){if(!this.checkStructure())return 0;const e=this.m_geometry.getImpl();this.m_multiVertexGeom=e;const t=e.getPointCount(),s=i.makePrimitiveArray(t,0);for(let e=0;e<t;e++)s[e]=e;s.sort((e,t)=>this.compareVerticesMultiPoint(e,t));for(let e=1;e<t;e++)if(0===this.compareVerticesMultiPoint(s[e-1],s[e]))return this.m_nonSimpleResult=new g.NonSimpleResult(5,s[e-1],s[e]),0;return 1}polylineIsSimpleAsFeature(){return this.checkStructure()&&this.checkDegenerateSegments(!0)?1:0}polygonIsSimpleAsFeature(){return this.isSimplePlanarImpl()}multipointSimplifyAsFeature(){let e=this.m_geometry.getImpl();const t=Ys.hasNanZs(e);let s,n=this.m_geometry;t&&(s=this.m_geometry.clone(),e=s.getImpl(),s.replaceNaNs(1,r.VertexDescription.getDefaultValue(1)),n=s),this.m_multiVertexGeom=e;const o=e.getPointCount(),a=i.makePrimitiveArray(o,0);for(let e=0;e<o;e++)a[e]=e;a.sort((e,t)=>this.compareVerticesMultiPoint(e,t));const m=new Array(o);m.fill(!1);let l=-1;for(let t=0;t<o;t++){const s=a[t];e.getXY(s).isFinite()&&((l<0||0!==this.compareVerticesMultiPoint(l,s))&&(m[s]=!0),l=s)}const h=this.m_geometry.createInstance();let g=0,u=0;for(let e=0;e<o;e++)m[e]?u=e+1:(g<u&&h.addPoints(n,g,u),g=e+1);return g<u&&h.addPoints(n,g,u),h.getImpl().setIsSimple(1,this.m_toleranceSimplify.total()),h}polylineSimplifyAsFeature(){const e=this.m_geometry.getImpl(),t=e.querySegmentIterator(),s=e.querySegmentIterator(),n=this.m_geometry.createInstance(),o=this.m_geometry,a=e.hasAttribute(1),m=a?r.calculateZToleranceFromGeometryForOpFromGeom(this.m_sr,e,!0).total():0,l=[],h=[];let g=null;a&&(g=e.getAttributeStreamRef(1));const u=new r.Point,c=e.hasNonLinearSegments(),p=this.m_toleranceSimplify.total();for(;t.nextPath();){if(s.nextPath(),e.getPathSize(t.getPathIndex())<2)continue;if(c&&e.hasNonLinearSegmentsPath(t.getPathIndex())){this.removeDegenerateSegmentsFromCurvedPath(e,t.getPathIndex(),m,n);continue}s.resetToLastSegment();let r=0,d=0,_=!0,f=!0;for(;t.hasNextSegment();){this.progress_();const n=t.nextSegment(),o=s.previousSegment();if(t.getStartPointIndex()>s.getStartPointIndex())break;if(_){const s=t.getStartPointIndex();e.getXY(s).isNAN()||(_=!1,l.push(s))}if(f){const t=s.getEndPointIndex();e.getXY(t).isNAN()||(h.push(t),f=!1)}if(!_){const s=l.at(-1),o=t.getEndPointIndex();if(o-s>1){const t=new i.Point2D;t.setSub(e.getXY(s),e.getXY(o)),r=t.length()}else r=n.calculateLength2D();if(r>p)l.push(o),r=0;else if(a){let e=g.read(s);Number.isNaN(e)&&(e=0);let t=g.read(o);Number.isNaN(t)&&(t=0),Math.abs(t-e)>m&&(l.push(o),r=0)}}if(!f){const t=h.at(-1),n=s.getStartPointIndex();if(n-t>1){const s=new i.Point2D;s.setSub(e.getXY(t),e.getXY(n)),d=s.length()}else d=o.calculateLength2D();if(d>p)h.push(n),d=0;else if(a){let e=g.read(t);Number.isNaN(e)&&(e=0);let s=g.read(n);Number.isNaN(s)&&(s=0),Math.abs(s-e)>m&&(h.push(n),d=0)}}}if(l.length>0&&h.length>0&&(l.at(-1)<h.at(-1)?l.length>h.length?l.pop():h.pop():(l.at(-1)===h.at(-1)||h.pop(),h.pop())),h.length+l.length>=2){let e=!1;for(let t=0,s=l.length;t<s;t++)o.getPointByVal(l[t],u),e?n.lineToPoint(u):(n.startPathPoint(u),e=!0);for(let t=h.length-1;t>0;t--)o.getPointByVal(h[t],u),e?n.lineToPoint(u):(n.startPathPoint(u),e=!0);o.isClosedPath(t.getPathIndex())?n.closePathWithLine():h.length>0&&(o.getPointByVal(h[0],u),n.lineToPoint(u))}l.length=0,h.length=0}return a&&n.replaceNaNs(1,0),n.getImpl().setIsSimple(1,p),n}polygonSimplifyAsFeature(){return this.simplifyPlanar()}simplifyPlanar(){if(1===this.m_geometry.getFillRule()&&!r.isAtLeastWeakSimple(this.m_knownSimpleResult))return Ss(this.m_geometry,this.m_toleranceSimplify,!0,!1,this.m_knownSimpleResult,this.m_progressTracker,0,!0);const e=new n.EditShape;if(e.addGeometry(this.m_geometry),this.m_geometry.hasAttribute(1)&&e.replaceNaNs(1,0),e.removeNaNVertices(),0!==e.getTotalPointCount()){let n=null,i=0,o=0;if(e.hasCurves()){n=new ms;const s=t.Envelope2D.constructEmpty();this.m_geometry.queryEnvelope(s);const r=is(this.m_toleranceSimplify.total(),s);i=os(this.m_toleranceSimplify.total()),o=as(r,i),ss(e,r,this.m_toleranceSimplify.total(),0,n,null,this.m_progressTracker)}r.isAtLeastWeakSimple(this.m_knownSimpleResult)||hs(e,this.m_toleranceSimplify.add(o),this.m_progressTracker,!0,!1),this.m_geometry.getGeometryType()===s.GeometryType.enumPolygon&&Ge(e,e.getFirstGeometry(),this.m_knownSimpleResult,!1,-1,this.m_progressTracker),null!==n&&n.stitchCurves(e,e.getFirstGeometry(),i,!0)}const i=e.getGeometry(e.getFirstGeometry());return i.getGeometryType()===s.GeometryType.enumPolygon&&(i.getImpl().updateOGCFlagsProtected(),i.setFillRule(0)),i.getImpl().setIsSimple(4,this.m_toleranceSimplify.total()),i}progress_(){}static hasNanZs(e){if(e.hasAttribute(1)){const t=e.getAttributeStreamRef(1);for(let s=0,n=e.getPointCount();s<n;s++){const e=t.read(s);if(Number.isNaN(e))return!0}}return!1}compareVerticesForPlanarClustering(e,t,s){if(e===t)return 0;const n=this.m_pairs[e],r=this.m_pairs[t],o=n>>1,a=r>>1,m=this.m_xy.readPoint2D(2*o);m.y+=1&n?this.m_toleranceIsSimpleClustering:-this.m_toleranceIsSimpleClustering;const l=this.m_xy.readPoint2D(2*a);l.y+=1&r?this.m_toleranceIsSimpleClustering:-this.m_toleranceIsSimpleClustering;const h=m.compare(l);if(0===h&&s){const e=this.m_pathsForOGCTests[o]-this.m_pathsForOGCTests[a];return i.sign(e)}return h}compareVerticesMultiPoint(e,t){if(e===t)return 0;const s=this.m_multiVertexGeom.getXY(e),n=this.m_multiVertexGeom.getXY(t),o=!s.isFinite(),a=!n.isFinite();if(o||a)return o<a?-1:o>a?1:0;if(s.y<n.y)return-1;if(s.y>n.y)return 1;if(s.x<n.x)return-1;if(s.x>n.x)return 1;for(let s=1;s<this.m_attributeCount;s++){const n=this.m_description.getSemantics(s),o=r.VertexDescription.getComponentCount(n);for(let s=0;s<o;s++){const r=this.m_multiVertexGeom.getAttributeAsDbl(n,e,s),o=this.m_multiVertexGeom.getAttributeAsDbl(n,t,s),a=i.compareWithNANs(r,o);if(0!==a)return a}}return 0}edgeAngleCompare(e,t){if(e===t)return 0;const s=e.m_segment.getTangent(e.getReversed()?1:0);e.getReversed()&&s.negateThis();const n=t.m_segment.getTangent(t.getReversed()?1:0);t.getReversed()&&n.negateThis();const r=s.getQuarter(),i=n.getQuarter();if(i===r){const e=s.crossProduct(n);return e<0?1:e>0?-1:0}return r<i?-1:1}}class Xs{getOperatorType(){return 10103}accelerateGeometry(e,t,s){return!1}canAccelerateGeometry(e){return!1}supportsCurves(){return!0}isSimpleAsFeature(e,t,s,n,i){const o=Hs(e,t,s,n,i);return r.isAtLeastSimpleAsFeature(e.getGeometryType(),o)}isSimplePlanarDONOTUSE(e,i,o,a,m){const l=function(e,i,o,a,m){if(a&&(a.m_reason=0,a.m_vertexIndex1=-1,a.m_vertexIndex2=-1),e.isEmpty())return 5;const l=e.getGeometryType();if(l===s.GeometryType.enumPoint)return Fs(e,a);const h=r.calculateToleranceFromGeometryForOpFromGeom(i,e,!1).total();if(l===s.GeometryType.enumEnvelope){const s=e,n=new t.Envelope2D;return s.queryEnvelope(n),n.isDegenerate(h)?(a&&(a.m_reason=4,a.m_vertexIndex1=-1,a.m_vertexIndex2=-1),0):5}if(s.isSegment(l)){const t=e,s=new n.Polyline({vd:t.getDescription()});return s.addSegment(t,!0),Hs(s,i,o,a,m)}const g=e.getImpl().getIsSimple(h,[0]);let u=o?-1:g;if(r.isAtLeastPlanarSimple(u)||0===u)return u;const c=new Ys(e,i,u,m,!1);return l===s.GeometryType.enumMultiPoint||l===s.GeometryType.enumPolyline||l===s.GeometryType.enumPolygon?u=c.isSimplePlanarImpl():s.throwInternalErrorException(""),e.getImpl().setIsSimple(u,h),a&&a.assign(c.m_nonSimpleResult),u}(e,i,o,a,m);return r.isAtLeastPlanarSimple(l)}executeMany(e,t,s,n){return new Ls(e,t,s,n)}execute(e,t,n,r){const i=new h.SimpleGeometryCursor([e]),o=this.executeMany(i,t,n,r).next();return o||s.throwInternalErrorException("null geometry"),o}}class Ls extends h.GeometryCursor{constructor(e,t,s,n){super(),this.m_progressTracker=n,this.m_bForceSimplify=s,this.m_index=-1,this.m_inputGeometryCursor=e,this.m_spatialReference=t}next(){const e=this.m_inputGeometryCursor.next();return e?(this.m_index=this.m_inputGeometryCursor.getGeometryID(),this.simplify(e)):null}getGeometryID(){return this.m_index}tock(){return!1}getRank(){return 1}simplify(e){if(e||s.throwInvalidArgumentException(""),e.getGeometryType()===s.GeometryType.enumGeometryCollection){const t=n.generateGeometryCursor(e,-1),s=(new Xs).executeMany(t,this.m_spatialReference,this.m_bForceSimplify,this.m_progressTracker),r=e.createInstance();for(let e=s.next();null!=e;e=s.next())r.addGeometry(e);return r}return As(e,this.m_spatialReference,this.m_bForceSimplify,this.m_progressTracker)}}class zs{constructor(e,t,n,r){this.m_intersectorGeom=null,this.m_sr=null,this.m_dimensionMask=-1,this.m_progressTracker=null,this.m_intersectorGeomType=s.GeometryType.enumUnknown,this.m_geomIntersectorEmptyGeom=null,this.m_intersectorGeom=e,this.m_sr=t,this.m_dimensionMask=n,this.m_progressTracker=r,this.m_intersectorGeomType=e.getGeometryType()}intersect(e){const o=this.tryFastImplementation(e);if(null!==o)return o;const a=r.getMergedExtent(this.m_intersectorGeom,e),l=r.calculateToleranceFromGeometryForOp(this.m_sr,a,!0).total(),h=t.Envelope2D.constructEmpty();this.m_intersectorGeom.queryEnvelope(h);const g=t.Envelope2D.constructEmpty();e.queryEnvelope(g),h.inflateCoords(2*l,2*l),h.intersect(g),h.inflateCoords(100*l,100*l);let u=m.clip$1(this.m_intersectorGeom,h,0,0,this.m_progressTracker),c=m.clip$1(e,h,0,0,this.m_progressTracker);return e.getDimension()>this.m_intersectorGeom.getDimension()&&(u=i.swap(c,c=u)),function(e,i,o,a){const m=t.Envelope2D.constructEmpty();e.queryEnvelope(m);const l=t.Envelope2D.constructEmpty();i.queryEnvelope(l);const h=t.Envelope2D.constructEmpty();h.setCoords({env2D:m}),h.mergeEnvelope2D(l);const g=r.calculateToleranceFromGeometryForOp(o,h,!0),u=new t.Envelope2D(l),c=r.adjustToleranceForTEClustering(g);if(u.inflateCoords(c,c),!m.isIntersecting(u)){if(e.getDimension()<=i.getDimension())return ws(bs(e.createInstance()),e,0,"&");if(e.getDimension()>i.getDimension())return ws(bs(i.createInstance()),e,0,"&")}const p=new Ds(a),d=new n.EditShape,_=d.addGeometry(bs(e)),f=d.addGeometry(bs(i));let y=0,x=0,P=null;if(d.hasCurves()){P=new ms;const e=d.getEnvelope2D(a);x=os(g.total());const t=is(g.total(),e);y=as(t,x),ss(d,t,g.total(),0,P,null,a)}p.setEditShapeCrackAndCluster(d,g.add(y));const E=p.intersection(_,f);null!==P&&P.stitchCurves(d,E,x,!0);const S=ws(d.getGeometry(E),e,0,"&");return ys(S.getGeometryType())&&(S.getImpl().setIsSimple(4,g.total()),S.getGeometryType()===s.GeometryType.enumPolygon&&S.getImpl().updateOGCFlagsProtected()),S}(c,u,this.m_sr,this.m_progressTracker)}intersectEx(e){const o=this.tryFastImplementation(e);if(null!==o){const t=[];return t.length=3,t[o.getDimension()]=o,this.prepareVector(e.getDescription(),this.m_dimensionMask,t)}const a=r.getMergedExtent(this.m_intersectorGeom,e),l=r.calculateToleranceFromGeometryForOp(this.m_sr,a,!0).total(),h=t.Envelope2D.constructEmpty();this.m_intersectorGeom.queryEnvelope(h);const g=t.Envelope2D.constructEmpty();e.queryEnvelope(g),h.inflateCoords(2*l,2*l),h.intersect(g),h.inflateCoords(100*l,100*l);let u=m.clip$1(this.m_intersectorGeom,h,0,0,this.m_progressTracker),c=m.clip$1(e,h,0,0,this.m_progressTracker);e.getDimension()>this.m_intersectorGeom.getDimension()&&(u=i.swap(c,c=u));const p=function(e,i,o,a){const m=new Array(3),l=t.Envelope2D.constructEmpty();e.queryEnvelope(l);const h=t.Envelope2D.constructEmpty();i.queryEnvelope(h);const g=t.Envelope2D.constructEmpty();g.setCoords({env2D:l}),g.mergeEnvelope2D(h);const u=r.calculateToleranceFromGeometryForOp(o,g,!0),c=new t.Envelope2D(h),p=r.adjustToleranceForTEClustering(u);if(c.inflateCoords(p,p),!l.isIntersecting(c)){if(e.getDimension()<=i.getDimension()){const t=ws(bs(e.createInstance()),e,0,"&");return m[t.getDimension()]=t,m}if(e.getDimension()>i.getDimension()){const t=ws(bs(i.createInstance()),e,0,"&");return m[t.getDimension()]=t,m}}const d=new Ds(a),_=new n.EditShape,f=_.addGeometry(bs(e)),y=_.addGeometry(bs(i));let x=0,P=0,E=null;if(_.hasCurves()){E=new ms;const e=_.getEnvelope2D(a);P=os(u.total());const t=is(u.total(),e);x=as(t,P),ss(_,t,u.total(),0,E,null,a)}d.setEditShapeCrackAndCluster(_,u.add(x)),_.dbgVerifyCurves();const S=d.intersectionEx(f,y);for(const t of S){null!==E&&E.stitchCurves(_,t,P,!1);const n=ws(_.getGeometry(t),e,0,"&");ys(n.getGeometryType())&&(n.getImpl().setIsSimple(4,u.total()),n.getGeometryType()===s.GeometryType.enumPolygon&&n.getImpl().updateOGCFlagsProtected()),m[n.getDimension()]=n}return null!==E&&E.clearStitcher(_),m}(c,u,this.m_sr,this.m_progressTracker);return this.prepareVector(e.getDescription(),this.m_dimensionMask,p)}init(e,t,n,r=null){s.geometryReleaseAssert(0)}static intersectPoints(e,t,s){const n=r.getMergedExtent(e,t);return o=e,a=t,m=r.calculateToleranceFromGeometryForOp(s,n,!0),o.isEmpty()||a.isEmpty()?o.createInstance():function(e,t,s){const n=r.adjustToleranceForTEClustering(e);return J(t.getX(),t.getY(),s.getX(),s.getY(),i.sqr(n))}(m,o,a)?new r.Point({copy:gs(o,a)}):o.createInstance();var o,a,m}tryFastImplementation(e){const i=e.getGeometryType();if(this.m_intersectorGeomType===s.GeometryType.enumPoint&&i===s.GeometryType.enumPoint){const t=zs.intersectPoints(e,this.m_intersectorGeom,this.m_sr);if(-1!==this.m_dimensionMask){const e=new n.MultiPoint({vd:t.getDescription()});return t.isEmpty()||e.add(t),e}return t}if(i===s.GeometryType.enumEnvelope&&this.m_intersectorGeomType===s.GeometryType.enumEnvelope&&(-1===this.m_dimensionMask||4===this.m_dimensionMask)){const t=e,s=this.m_intersectorGeom,n=new r.Envelope({copy:t});return n.intersect(s),n}const o=r.getMergedExtent(e,this.m_intersectorGeom),a=r.calculateToleranceFromGeometryForOp(this.m_sr,o,!0),l=e.isEmpty(),h=this.m_intersectorGeom.isEmpty();let g=l||h;if(!g){const n=function(e,n,r){const i=new t.Envelope2D;e.queryEnvelope(i);const o=new t.Envelope2D;n.queryEnvelope(o);const a=new t.Envelope2D(o);if(a.inflate(2*r),!a.isIntersecting(i))return 4;const m=e.getGeometryType(),l=n.getGeometryType();if(m===s.GeometryType.enumEnvelope&&i.containsEnvelope(a))return 1;if(l===s.GeometryType.enumEnvelope){const e=new t.Envelope2D(i);if(e.inflate(2*r),o.containsEnvelope(e))return 2}return 0}(this.m_intersectorGeom,e,a.total());if(4===n)g=!0;else{if(2&n)return this.m_intersectorGeom;if(1&n)return e}}if(g){const t=s.getDimensionFromType(i),n=s.getDimensionFromType(this.m_intersectorGeomType);return t<n?zs.ReturnEmpty(e,l):t>n||0===t&&i===s.GeometryType.enumMultiPoint&&this.m_intersectorGeomType===s.GeometryType.enumPoint?this.ReturnEmptyIntersector():zs.ReturnEmpty(e,l)}if(i===s.GeometryType.enumEnvelope&&0===s.getDimensionFromType(this.m_intersectorGeomType)||this.m_intersectorGeomType===s.GeometryType.enumEnvelope&&0===s.getDimensionFromType(i)){const n=i===s.GeometryType.enumEnvelope?e:this.m_intersectorGeom,r=i===s.GeometryType.enumEnvelope?this.m_intersectorGeom:e,o=t.Envelope2D.constructEmpty();return n.queryEnvelope(o),m.clip$1(r,o,a.total(),0,this.m_progressTracker)}if(0===s.getDimensionFromType(i)&&s.getDimensionFromType(this.m_intersectorGeomType)>0||s.getDimensionFromType(i)>0&&0===s.getDimensionFromType(this.m_intersectorGeomType)){if(i===s.GeometryType.enumMultiPoint)return Cs(e,this.m_intersectorGeom,a);if(i===s.GeometryType.enumPoint)return Is(e,this.m_intersectorGeom,a);if(this.m_intersectorGeomType===s.GeometryType.enumMultiPoint)return Cs(this.m_intersectorGeom,e,a);if(this.m_intersectorGeomType===s.GeometryType.enumPoint)return Is(this.m_intersectorGeom,e,a);s.throwInternalErrorException("")}return null}ReturnEmptyIntersector(){return null===this.m_geomIntersectorEmptyGeom&&(this.m_geomIntersectorEmptyGeom=this.m_intersectorGeom.createInstance()),this.m_geomIntersectorEmptyGeom}static ReturnEmpty(e,t){return t?e:e.createInstance()}prepareVector(e,t,s){let r=0;return 1&t?(s[0]||(s[0]=new n.MultiPoint({vd:e})),r++):s.shift(),2&t?(s[r]||(s[r]=new n.Polyline({vd:e})),r++):s.splice(r,1),4&t?s[r]||(s[r]=new n.Polygon({vd:e})):s.splice(r,1),new h.SimpleGeometryCursor(s)}}class Ws extends h.GeometryCursor{constructor(e,t,n,r,i){super(),this.m_smallCursor=null,this.m_progressTracker=r,this.m_geomIntersector=t.next(),this.m_intersector=new zs(this.m_geomIntersector,n,i,r),this.m_index=-1,this.m_inputGeoms=e,this.m_dimensionMask=i,-1!==this.m_dimensionMask&&(this.m_dimensionMask<=0||this.m_dimensionMask>7)&&s.throwInvalidArgumentException("bad dimension mask")}next(){if(!this.m_geomIntersector)return null;let e;if(null!==this.m_smallCursor){if(e=this.m_smallCursor.next(),e)return e;this.m_smallCursor=null}for(;e=this.m_inputGeoms.next();)return s.throwIfMesh(e),this.m_index=this.m_inputGeoms.getGeometryID(),-1===this.m_dimensionMask?this.m_intersector.intersect(e):(this.m_smallCursor=this.m_intersector.intersectEx(e),this.m_smallCursor.next());return null}getGeometryID(){return this.m_index}tock(){return!0}getRank(){return 1}}class js{getOperatorType(){return 1e4}accelerateGeometry(e,t,i){if(!this.canAccelerateGeometry(e))return!1;r.calculateToleranceFromGeometryForOpFromGeom(t,e,!0);let o=0;return e.getGeometryType()!==s.GeometryType.enumPolygon&&e.getGeometryType()!==s.GeometryType.enumPolyline||!n.canUseQuadTree(e)||0===i||(o|=e.getImpl().buildQuadTreeAccelerator(i)?1:0),!!o}canAccelerateGeometry(e){return n.canUseQuadTree(e)}supportsCurves(){return!0}executeMany(e,t,s,n,r=-1){return new Ws(e,t,s,n,r)}execute(e,t,n,r){if(e.getGeometryType()===s.GeometryType.enumPoint&&t.getGeometryType()===s.GeometryType.enumPoint)return zs.intersectPoints(e,t,n);const i=new h.SimpleGeometryCursor([e]),o=new h.SimpleGeometryCursor([t]),a=this.executeMany(i,o,n,r,-1).next();return a||s.throwInternalErrorException("null output"),a}}function Zs(e,t,s){return t.m_projector.project(e,s)}function Qs(e,t,s,n,r){return e.m_projector.transformInPlaceZ(t,null,s,n,null,r)}function Ks(e,i,o,a){if(e&&i&&i.isPannable()||s.throwInvalidArgumentException("fold_into_360_range_geodetic"),e.isEmpty())return e;if(4===o)return $s(e,i,a);let m=e;const l=m.getGeometryType();if(s.isMultiPath(l)){m=_r(e,i);const s=new t.Envelope2D;m.queryEnvelope(s);const n=r.calculateToleranceFromGeometryForOp(i,s,!1).total(),a=i.getPannableExtent();let l=Math.floor((s.xmin-a.xmin)/a.width())*a.width()+a.xmin,h=m;for(;l<s.xmax;)l>s.xmin+n&&l<s.xmax-n&&(h=pr(h,i,o,!0,l)),l+=a.width();m=h}else{if(l===s.GeometryType.enumEnvelope){const e=new n.Polygon({vd:m.getDescription()});return e.addEnvelope(m,!1),Ks(e,i,o,a)}if(s.isSegment(l)){const e=new n.Polyline({vd:m.getDescription()});return e.addSegment(m,!0),Ks(e,i,o,a)}}return $s(m,i,a)}function $s(e,t,r){if(e&&t&&t.isPannable()||s.throwInvalidArgumentException(""),e.isEmpty())return e;let i;const o=e.getGeometryType();if(o===s.GeometryType.enumEnvelope){const t=new n.Polygon({vd:e.getDescription()});t.addEnvelope(e,!1),i=t}else if(s.isSegment(o)){const t=new n.Polyline({vd:e.getDescription()});t.addSegment(e,!0),i=t}else i=e;const a=_r(i,t);return a.isEmpty()?a:lr(a,t,0,a!==e,0,r)}function Js(e,t,s,n){const o=t.getXYGridRange(),a=e.hasAttribute(1),l=e.hasAttribute(2);let h=new i.Envelope1D,g=new i.Envelope1D;a&&(h=t.getZGridRange()),l&&(g=t.getMGridRange());let u=(new m.OperatorClip).execute(e,o,s,n);if(a){const t=u.queryInterval(1,0);h.contains(t)||(e===u&&(u=u.clone()),r.snapCoordinate(u,h,1,0))}if(l){const t=u.queryInterval(2,0);g.contains(t)||(e===u&&(u=u.clone()),r.snapCoordinate(u,g,2,0))}return u}class en{constructor(e){this.m_inputPCSHorizonClipOption=0,this.m_outputPCSHorizonClipOption=0,this.m_bDontGeonormalizePolygon=!1,this.m_bClipOutCurvedPoles=!1,this.m_bNormalizeOutputGeometry=!1,this.m_bDontHackPolesInGeogToGeog=!1,this.m_centralMeridianOfOutputGCS=0,this.m_densificationStepInput=0,e||s.throwInvalidArgumentException(""),this.m_projTransform=e,this.m_bClipOutCurvedPoles=!1;const t=this.m_projTransform.getExtendedParamsImpl();this.m_bNormalizeOutputGeometry=t.normalizeResultGeometry,this.m_bNormalizeOutputGeometry&&(t.legacyHorizonClipping?this.m_bNormalizeOutputGeometry=!1:this.m_projTransform.getOutputSR().isPannable()||(this.m_bNormalizeOutputGeometry=!1)),t.clipWithInputHorizon?(this.m_inputPCSHorizonClipOption=0,!t.legacyHorizonClipping&&this.m_projTransform.getInputSR().isPannable()&&(this.m_inputPCSHorizonClipOption=this.m_bNormalizeOutputGeometry?4:2)):this.m_inputPCSHorizonClipOption=1,t.clipWithOutputHorizon?(this.m_outputPCSHorizonClipOption=0,!t.legacyHorizonClipping&&this.m_projTransform.getOutputSR().isPannable()&&(this.m_outputPCSHorizonClipOption=this.m_bNormalizeOutputGeometry?4:2)):this.m_outputPCSHorizonClipOption=1,this.m_centralMeridianOfOutputGCS=t.centralMeridianOfOutputGCS,this.m_densificationStepInput=t.densificationStep;const n=this.m_projTransform.getExtendedParamsInternal();this.m_bDontGeonormalizePolygon=n.hasFlag(2147483648),this.m_bDontHackPolesInGeogToGeog=n.hasFlag(1073741824),this.m_bClipOutCurvedPoles=n.hasFlag(536870912)}project(e,t){if(this.m_projTransform.isIdentity()||e.isEmpty())return e;const n=e.getGeometryType();if(n===s.GeometryType.enumPoint)return this.projectPoint(e,t);const r=this.m_projTransform.getInputSR().getCoordinateSystemType(),i=this.m_projTransform.getOutputSR().getCoordinateSystemType(),o=this.m_projTransform.getInputSR(),a=this.m_projTransform.getOutputSR();if(0===r&&r===i){const t=sn(o,a),s=e.clone();return s.applyTransformation(t),s}switch(n){case s.GeometryType.enumPolyline:case s.GeometryType.enumPolygon:return this.projectMultiPath(e,t);case s.GeometryType.enumMultiPoint:return this.projectMultiPoint(e,t);case s.GeometryType.enumEnvelope:return this.projectEnvelope(e,t);case s.GeometryType.enumGeometryCollection:return this.projectGeometryCollection(e,t);default:s.throwInternalErrorException("")}}projectPoint(e,t){const s=[e.getXY()];let n,r=null;(n=e.hasAttribute(1))&&(r=[e.getZ()]),this.transformInPlaceZ(s,r,1,s,r,null);const i=e.clone();return i.setXY(s[0]),n&&i.setZ(r[0]),i}projectMultiPoint(e,t){let r=new n.MultiPoint({copy:e});const i=this.m_projTransform.getInputSR(),o=this.m_projTransform.getOutputSR(),a=i.getCoordinateSystemType(),m=o.getCoordinateSystemType();if(3===a&&s.geometryReleaseAssert(0),r=Sr(r,i,this.m_inputPCSHorizonClipOption,t),r.isEmpty())return r;2===a&&Dr(i,0,r),Ar(this.m_projTransform,r,!1);let l=0;3===m&&s.geometryReleaseAssert(0);const h=2===m;return h?l=o.getCentralMeridian():Number.isNaN(this.m_centralMeridianOfOutputGCS)||(l=this.m_centralMeridianOfOutputGCS),h&&0!==this.m_outputPCSHorizonClipOption||(r=lr(r,ki(o),l,!1,0,t)),h&&(r=ir(r,o,this.m_outputPCSHorizonClipOption,t),Ir(o,r,this.m_bNormalizeOutputGeometry),r.isEmpty()),r}projectMultiPath(e,t){const n=e.getGeometryType();return n===s.GeometryType.enumPolygon?this.projectPolygon(e,t):n===s.GeometryType.enumPolyline?this.projectPolyline(e,t):void s.throwInternalErrorException("project_multi_path_")}projectEnvelope(e,t){this.m_projTransform.getInputSR(),this.m_projTransform.getOutputSR();const s=this.m_projTransform.isVertical()&&e.hasAttribute(1);let n=i.Envelope1D.constructEmpty();if(s&&(n=e.queryInterval(1,0)),n.width()>0){const s=e.clone();s.setInterval(1,0,n.vmin,n.vmin);const r=this.projectEnvelopeHelper(s,t);s.setInterval(1,0,n.vmax,n.vmax);const i=this.projectEnvelopeHelper(s,t);return r.merge(i),r}return this.projectEnvelopeHelper(e,t)}projectPolygon(e,r){s.geometryReleaseAssert(e.getGeometryType()===s.GeometryType.enumPolygon),s.geometryReleaseAssert(!this.m_projTransform.isIdentity()),s.geometryReleaseAssert(!e.isEmpty());const i=this.m_projTransform.getInputSR(),o=this.m_projTransform.getOutputSR(),a=i.getCoordinateSystemType(),h=o.getCoordinateSystemType(),g=new n.Polygon({copy:e});3===a&&s.geometryReleaseAssert(0),3===h&&s.geometryReleaseAssert(0);const u=2===a,c=2===h,p=u?i.getGCS():i,d=c?o.getGCS():o,_=!c&&!this.m_bDontHackPolesInGeogToGeog;let f=!1,y=Sr(g,i,this.m_inputPCSHorizonClipOption,r);if(y.isEmpty())return y;let x=this.m_densificationStepInput;const P=!Number.isNaN(x);let E;P&&(y=(new l.OperatorDensify).execute(y,x,0,0,r));let S=c?o.getPCSInfo():null,C=Number.NaN;u&&(C=i.getCentralMeridian());const I=null!==o.getGCSSplitLines();if(this.m_bDontGeonormalizePolygon){const e=y;if(u&&(Gr(i,C,e),P)){const e=i.getUnitsPerMillimeter();x*=i.getGCS().getUnitsPerMillimeter()/e}if(Vr(this.m_projTransform,e,_),P){const e=i.getGCS().getUnitsPerMillimeter();x*=o.getGCS().getUnitsPerMillimeter()/e}E=e}else{let e=new n.Polyline({vd:y.getDescription()});if(e.addAndExplicitlyOpenAllPaths(y,!1),u){if(Gr(i,C,e),P){const e=i.getUnitsPerMillimeter();x*=i.getGCS().getUnitsPerMillimeter()/e}if(this.m_bClipOutCurvedPoles){const s=i.getPCSInfo(),n=s.getSouthPoleGeometry()===ho.PE_POLE_LINE_CURVED,o=s.getNorthPoleGeometry()===ho.PE_POLE_LINE_CURVED;if(n||o){const s=t.Envelope2D.constructEmpty();e.queryLooseEnvelope(s),s.inflateCoords(1,1);const i=89.9999*p.getOneDegreeGCSUnit();n&&(s.ymin=-i),o&&(s.ymax=i),e=m.clipPolesOut(e,s,p,0,0,r)}}}if(Vr(this.m_projTransform,e,_),P){const e=ki(i).getUnitsPerMillimeter();x*=ki(o).getUnitsPerMillimeter()/e}let s=Number.NaN;c?(S=o.getPCSInfo(),s=o.getCentralMeridian()):Number.isNaN(this.m_centralMeridianOfOutputGCS)||(s=this.m_centralMeridianOfOutputGCS);let a=tn(i)|tn(o),l=10*d.getTolerance(0);this.m_bDontHackPolesInGeogToGeog&&(a=3,l=10*d.getTolerance(0)),E=function(e,t,s,n,r,i,o,a,m){return new Rn(e,null,s,t,n,r,o,a,i).geoNormalizePolygonGeometry(m)}(y,i,e,d,s,r,a,l,this.m_bNormalizeOutputGeometry),a=0}if(I&&(s.geometryReleaseAssert(!o.isPannable()),E=sr(E,o,r)),c){if(!f){const e=d.getPannableExtent().width();if(E.queryInterval(0,0).width()>=e-10*d.getTolerance(0)){const e=S.getNorthPoleLocation(),t=S.getSouthPoleLocation(),s=S.getNorthPoleGeometry(),n=S.getSouthPoleGeometry();let r=0;s===ho.PE_POLE_POINT&&e!==ho.PE_POLE_OUTSIDE_BOUNDARY&&(r=1),n===ho.PE_POLE_POINT&&t!==ho.PE_POLE_OUTSIDE_BOUNDARY&&(r|=2),f||=0!==r}}E=ir(E,o,this.m_outputPCSHorizonClipOption,r),P&&(E=(new l.OperatorDensify).execute(E,x,0,0,r)),Tr(o,E,this.m_bNormalizeOutputGeometry)}return E.isEmpty()||f&&(E=(new Xs).execute(E,o,!1,r)),E}projectPolyline(e,t){s.geometryReleaseAssert(e.getGeometryType()===s.GeometryType.enumPolyline),s.geometryReleaseAssert(!this.m_projTransform.isIdentity()),s.geometryReleaseAssert(!e.isEmpty());const r=this.m_projTransform.getInputSR(),i=this.m_projTransform.getOutputSR(),o=r.getCoordinateSystemType(),a=i.getCoordinateSystemType(),m=new n.Polyline({copy:e});3===o&&s.geometryReleaseAssert(0),3===a&&s.geometryReleaseAssert(0);const h=2===o,g=2===a;h&&r.getGCS();const u=g?i.getGCS():i,c=!g&&!this.m_bDontHackPolesInGeogToGeog;let p=Sr(m,r,this.m_inputPCSHorizonClipOption,t);if(p.isEmpty())return p;let d=Number.NaN;h&&(d=r.getCentralMeridian());const _=null!==i.getGCSSplitLines();let f=this.m_densificationStepInput;const y=!Number.isNaN(f);let x;if(y&&(p=(new l.OperatorDensify).execute(p,f,0,0,t)),this.m_bDontGeonormalizePolygon){if(h&&(Gr(r,d,p),y)){const e=r.getUnitsPerMillimeter();f*=r.getGCS().getUnitsPerMillimeter()/e}if(Vr(this.m_projTransform,p,c),y){const e=r.getGCS().getUnitsPerMillimeter();f*=i.getGCS().getUnitsPerMillimeter()/e}x=p}else{const e=new n.Polyline({vd:p.getDescription()});if(e.addAndExplicitlyOpenAllPaths(p,!1),h&&(Gr(r,d,e),y)){const e=r.getUnitsPerMillimeter();f*=r.getGCS().getUnitsPerMillimeter()/e}if(Vr(this.m_projTransform,e,c),y){const e=r.getGCS().getUnitsPerMillimeter();f*=i.getGCS().getUnitsPerMillimeter()/e}let s=Number.NaN;g?s=i.getCentralMeridian():Number.isNaN(this.m_centralMeridianOfOutputGCS)||(s=this.m_centralMeridianOfOutputGCS);let o=tn(r)|tn(i),a=10*u.getTolerance(0);this.m_bDontHackPolesInGeogToGeog&&(o=3,a=0),x=function(e,t,s,n,r,i,o,a,m){return new Rn(e,null,s,t,n,r,o,a,i).geoNormalizePolylineGeometry(m)}(p,r,e,u,s,t,o,a,this.m_bNormalizeOutputGeometry),o=0}return _&&(s.geometryReleaseAssert(!i.isPannable()),x=sr(x,i,t)),g&&(x=ir(x,i,this.m_outputPCSHorizonClipOption,t),y&&(x=(new l.OperatorDensify).execute(x,f,0,0,t)),Tr(i,x,this.m_bNormalizeOutputGeometry)),x.isEmpty(),x}projectGeometryCollection(e,t){return s.geometryReleaseAssert(0),{}}projectEnvelopeHelper(e,s){const i=(e.height()+e.width())/400;if(0!==i){const o=(new l.OperatorDensify).execute(e,i,0,0,s),a=this.projectMultiPath(o,s),m=new r.Envelope({vd:e.getDescription()});if(a.isEmpty()){const i=Math.min(e.height(),e.width()),a=r.calculateToleranceFromGeometryForOpFromGeom(this.m_projTransform.getInputSR(),e,!0).total();if(i>100*a){const e=t.Envelope2D.constructEmpty(),s=r.calculateToleranceFromGeometryForOp(this.m_projTransform.getOutputSR(),e,!0).total(),n=this.m_projTransform.getInputSR().getOneMeter()/this.m_projTransform.getOutputSR().getOneMeter();if(i>100*Math.max(a,s*n))return m}const l=new n.Polyline;l.addAndExplicitlyOpenAllPaths(o,!1),this.projectMultiPath(l,s).queryEnvelope(m);const h=new n.MultiPoint({vd:e.getDescription()});h.reserve(4);const g=new r.Point;for(let t=0;t<4;t++)e.queryCornerByVal(t,g),h.add(g);const u=this.projectMultiPoint(h,s),c=new r.Envelope;return u.queryEnvelope(c),m.merge(c),m}return a.queryEnvelope(m),m}{const t=e.getCenterXY(),n=new r.Point(t),i=this.projectPoint(n,s),o=new r.Envelope({vd:e.getDescription()});if(i.isEmpty())o.setEmpty();else{e.copyTo(o);const t=i.getXY();o.setCoords(t.x,t.y,t.x,t.y)}return o}}transformInPlace(e,t,n,r){return s.geometryReleaseAssert(0),0}transformInPlaceZ(e,t,n,r,o,a){if(this.m_projTransform.isIdentity())return e!==r&&i.assignObjectArray(r,e,n),t!==o&&i.memcpy(o,t,0,0,n),n;const m=this.m_projTransform,l=m.getInputSR(),h=m.getOutputSR(),g=l.getCoordinateSystemType(),u=h.getCoordinateSystemType();if(0===g&&g===u)return sn(l,h).transformPoints2D(e,n,r),m.isVertical()&&s.geometryReleaseAssert(0),n;3===g&&s.throwNotImplementedException("image: transform_in_place_"),3===u&&s.throwNotImplementedException("image: transform_in_place_"),function(e,t,n,r,o){const a=r.getCoordinateSystemType();if(2===a){if(0===o)n!==e&&i.assignObjectArray(n,e,t),function(e,t,n){const r=e.getPCSHorizon();if(r.getGeometryType()===s.GeometryType.enumPolygon){const s=e.getDefaultPrecisionSR().getTolerance(0),i=r;for(let e=0;e<n;e++)1!==Qt(i,t[e],s)&&t[e].setNAN();return}if(r.getGeometryType()===s.GeometryType.enumEnvelope){const e=r;for(let s=0;s<n;s++)e.contains(t[s])||t[s].setNAN();return}s.throwInvalidArgumentException("")}(r,n,t);else if(n!==e&&i.assignObjectArray(n,e,t),r.isPannable()){const e=r.getTolerance(0);!function(e,t,s,n){for(let r=0;r<t;r++){if(e[r].y<s.ymin||e[r].y>s.ymax){e[r].setNAN();continue}const t=e[r].x;e[r].x=ur(t,s,n)}}(n,t,r.getPannableExtent(),e),hr(n,t,r,0)}}else{s.geometryReleaseAssert(1===a);const i=r.getTolerance(0),o=r.getPannableExtent();for(let s=0;s<t;s++)n[s].assign(Er(e[s],o,i))}}(e,n,r,l,this.m_inputPCSHorizonClipOption),o!==t&&i.memcpy(o,t,0,0,n),2===g&&Nr(l,0,r,n),Ur(this.m_projTransform,r,o,n,!1);let c=0;const p=2===u;if(p?c=h.getCentralMeridian():Number.isNaN(this.m_centralMeridianOfOutputGCS)||(c=this.m_centralMeridianOfOutputGCS),p&&0!==this.m_outputPCSHorizonClipOption||hr(r,n,h.getGCS(),c),p){if(!mr(r,n,h,this.m_outputPCSHorizonClipOption))for(let e=0;e<n;++e)r[e].setNAN();Cr(h,r,n,!1)}let d=n;for(let e=0;e<n;++e)r[e].isNAN()&&(o&&(o[e]=Number.NaN),d--);return d}}function tn(e){if(2!==e.getCoordinateSystemType())return 0;let t=0;const s=e.getPCSInfo(),n=s.getNorthPoleLocation(),r=s.getSouthPoleLocation(),i=s.getNorthPoleGeometry(),o=s.getSouthPoleGeometry();return i===ho.PE_POLE_POINT&&n!==ho.PE_POLE_OUTSIDE_BOUNDARY&&(t=1),o===ho.PE_POLE_POINT&&r!==ho.PE_POLE_OUTSIDE_BOUNDARY&&(t|=2),t}function sn(e,t){const s=e.getHorzUnitFactor(),n=t.getHorzUnitFactor();let r=1,i=1;const o=20015077/180;1===e.getUnit().getUnitType()&&(r=o),1===t.getUnit().getUnitType()&&(i=o);const m=s/n*(r!==i?r/i:1),l=new a.Transformation2D;return l.setScaleCoords(m,m),l}let nn=class{getOperatorType(){return 10300}supportsCurves(){return!0}accelerateGeometry(e,t,s){return!1}canAccelerateGeometry(e){return!1}executeMany(e,t,s){return!t||t.isIdentity()?e:new rn(e,t,s)}execute(e,t,s){return t.isIdentity()?e:Zs(e,t,s)}transform(e,t,s,n,r=!0){return r?function(e,t,s,n){e.m_projector.transformInPlaceZ(t,null,s,n,null,null);const r=n.slice(0,s).filter(e=>!e.isNAN());for(let e=0,t=r.length;e<t;++e)n[e].assign(r[e]);return r.length}(e,t,s,n):Qs(e,t,s,n,null)}transform3D(e,t,n,r,i=!0){return s.geometryReleaseAssert(0),0}foldInto360Range(e,t){return $s(e,t,null)}foldInto360RangeGeodetic(e,t,s){return Ks(e,t,s,null)}normalizeGeometryEx(e,t,o,m,l=0){return function(e,t,o,m,l){if(!t.isPannable()||e.isEmpty())return e;const h=e.getGeometryType();h===s.GeometryType.enumGeometryCollection&&s.throwNotImplementedException("not yet impl for geometry collection");const g=t.getPannableExtent();Number.isNaN(o)&&(o=g.getCenterX());const u=g.width(),c=.5*u,p=l>0,d=e.queryInterval(0,0);if(!p&&d.width()<c||!s.isMultiVertex(e.getGeometryType())){const t=d.getCenter();if(Math.abs(t-o)<=c)return e;{const s=new a.Transformation2D,n=o-t,r=i.round(n/u)*u;s.setShiftCoords(r,0);const m=e.clone();return m.applyTransformation(s),m}}if(h===s.GeometryType.enumPolygon){let s=new n.Polyline({vd:e.getDescription()});s.addAndExplicitlyOpenAllPaths(e,!1),p&&(s=on(s,t,2,l,Number.NaN,null,!0));const a=[];if(!m){{let o=e;p&&(o=new n.Polygon,o.add(s,!1));const m=function(e,t,s){const n=Ti();t.querySpheroidData(n);const o=t.getGCS()!==t?t.getSRToGCSTransform():null,a=i.makeObjectArray(i.Point2D,100),m=new r.Point3D(0,0,0),l=e.getPointCount(),h=t.getGCS().getUnit().getUnitToBaseFactor();for(let t=0,s=l;t<s;){const r=Math.min(100,s-t);e.queryCoordinates(a,r,t,t+r),o&&(new nn).transform(o,a,r,a,!1);for(let e=0;e<r;e++){if(a[e].isNAN())continue;a[e].scale(h);const t=E(n.majorSemiAxis,n.e2,a[e]);m.addThis(t)}t+=r}const g=I(n.majorSemiAxis,n.e2,m);g.scale(1/h);const u=e;if(!new Gn(t.getGCS(),g).project(u))return 0;s.length=e.getPathCount();const c=u.calculateArea2D()<0;for(let t=0,n=e.getPathCount();t<n;t++){const e=u.calculateRingArea2D(t),n=c?e<0:e>0;s[t]=n}return c?-1:1}(e,t,a);if(m)m<0&&s.reverseAllPaths();else{const e=o.getPathCount();for(let t=0;t<e;t++)a.push(o.calculateRingArea2D(t)>0)}}m=a}return new Rn(null,m,s,null,t,o,3,0,null).geoNormalizePolygonGeometry(!0)}if(h===s.GeometryType.enumPolyline){let s=new n.Polyline({vd:e.getDescription()});return s.addAndExplicitlyOpenAllPaths(e,!1),p&&(s=on(s,t,2,l,Number.NaN,null,!0)),new Rn(null,null,s,null,t,o,3,0,null).geoNormalizePolylineGeometry(!0)}if(h===s.GeometryType.enumMultiPoint){const t=e,s=t.getAttributeStreamRef(0);let n,r=null,a=o,m=0;const l=.1*u;for(let o=0,h=t.getPointCount();o<h;o++){const t=s.read(2*o);let h=t-a;if(Math.abs(h)>c&&(h=i.round(h/u)*u,m-=h,Math.abs(m)<l&&(m=0)),0!==m){r||(n=e.clone(),r=n.getAttributeStreamRef(0));const s=t+m;r.write(2*o,s)}a=t}return r?(n.notifyModified(),n):e}s.throwInternalErrorException("")}(e,t,o,m,l)}normalizeGeometry(e,t,n){return function(e,t,n){if(!t.isPannable()||e.isEmpty())return e;const r=t.getPannableExtent().width(),o=.5*r,m=e.queryInterval(0,0);if(m.width()<o||!s.isMultiVertex(e.getGeometryType())){if(Number.isNaN(n))return e;const t=m.getCenter();if(Math.abs(t-n)<=o)return e;{const s=new a.Transformation2D,o=n-t,m=i.round(o/r)*r;s.setShiftCoords(m,0);const l=e.clone();return l.applyTransformation(s),l}}const l=e.getGeometryType(),h=e,g=h.getAttributeStreamRef(0),u=e.clone(),c=u.getAttributeStreamRef(0);let p=0,d=0,_=0,f=s.isMultiPath(l)?0:-1;const y=i.Envelope1D.constructEmpty();let x=!1;for(let e=0,t=h.getPointCount();e<t;e++){const t=g.read(2*e);e===d&&(s.isMultiPath(l)?(0===f&&Number.isNaN(n)&&(x=!0),f>0&&Number.isNaN(n)&&(n=y.getCenter(),x=!1),d=h.getPathEnd(f),f++):d=h.getPointCount(),Number.isNaN(n)?_=t:(_=n,p=0));let a=t-_;Math.abs(a)>o&&(a=i.round(a/r)*r,p-=a,Math.abs(p)<.1*r&&(p=0));const m=t+p;c.write(2*e,m),x&&y.mergeCoordinate(m),_=t}return u.notifyModified(),u}(e,t,n)}clipToSpatialReference(e,n,r,i=0){return function(e,n,r,i){const o=n.getCoordinateSystemType();if(0===o){const t=new Zi;return n.queryPrecisionDescriptor(t),Js(e,t,n,r)}let a=e;2!==i&&3!==i||!n.isPannable()||(a=$s(a,n,r));const l=new Zi;if(n.queryPrecisionDescriptor(l),a=Js(a,l,n,r),0===i||a.isEmpty())return a;if(1===o){if(1===i){const e=new t.Envelope2D;a.queryLooseEnvelope(e);const s=n.getPannableExtent(),i=.01*s.width();return s.xmin=e.xmin-i,s.xmax=e.xmax+i,(new m.OperatorClip).execute(a,s,n,r)}return a}if(2===o){const e=n.getPCSHorizon();if(1===i||2===i){const t=(new js).execute(a,e,n,r);return t===e?t.clone():t}return a}if(3===o)return a;s.throwInternalErrorException("missing implementation")}(e,n,r,i)}};class rn extends h.GeometryCursor{constructor(e,t,n){super(),this.m_projTrans=t,this.m_progressTracker=n,this.m_index=-1,e||s.throwInvalidArgumentException(""),this.m_inputGeoms=e}next(){const e=this.m_inputGeoms.next();return null!=e?(s.throwIfCurves(e),s.throwIfMesh(e),this.m_index=this.m_inputGeoms.getGeometryID(),Zs(e,this.m_projTrans,this.m_progressTracker)):null}getGeometryID(){return this.m_index}tock(){return!0}getRank(){return 1}}function on(e,t,r,i,o,a,m=!1){e||s.throwInvalidArgumentException("Geometry.Geodetic_densify.densify");let l=e.getGeometryType();if(s.throwIfMesh(e),e.isEmpty()||s.isPoint(l))return e;const h=new gn;h.m_sr=t,h.m_gcs=t.getGCS(),h.m_transform=h.m_gcs!==t?t.getSRToGCSTransform():null,h.m_progressTracker=a;const g=Ti();let u,c,p;if(h.m_gcs.querySpheroidData(g),h.m_a=g.majorSemiAxis,h.m_eSquared=g.e2,h.m_rpu=h.m_gcs.getUnit().getUnitToBaseFactor(),h.m_gcsTolerance=h.m_gcs.getTolerance(0),h.m_radTolerance=h.m_gcsTolerance*h.m_rpu,h.m_maxLength=i,h.m_maxDeviation=o,h.m_curveType=r,l===s.GeometryType.enumEnvelope){const t=new n.Polygon({vd:e.getDescription()});t.addEnvelope(e,!1),u=t,l=s.GeometryType.enumPolygon}else if(s.isSegment(l)){const t=new n.Polyline({vd:e.getDescription()});t.addSegment(e,!0),u=t,l=s.GeometryType.enumPolyline}else u=e;if(4!==h.m_curveType){if(s.geometryReleaseAssert(s.isMultiPath(l)),c=h.replaceCurvesWithLinesAndProjectToGCSAsMultiPoint_(u),c.isEmpty())return c;c=an(h.m_rpu,c);let e=h.geodeticDensify(c);m||(e=(new nn).foldInto360RangeGeodetic(e,h.m_gcs,h.m_curveType)),p=h.m_transform&&!h.m_transform.isIdentity()?(new nn).execute(e,h.m_transform.getInverse(),a):e}else{let e;if(s.geometryReleaseAssert(s.isMultiPath(l)),t.isPannable())e=_r(u,t);else{const s=t.getPCSHorizon();e=(new js).execute(u,s,t,a),e===s&&(e=s.clone())}if(c=e,c.isEmpty())return c;p=h.shapePreservingDensify(c)}return p}function an(e,s){const n=new t.Envelope2D;if(s.queryLooseEnvelope(n),n.width()*e<Math.PI)return s;let o=!1;const a=s.querySegmentIterator(),m=new i.Point2D,l=new i.Point2D;for(;a.nextPath();)for(;a.hasNextSegment();){const t=a.nextSegment();if(m.setCoordsPoint2D(t.getStartXY()),l.setCoordsPoint2D(t.getEndXY()),m.scale(e),l.scale(e),Math.abs(m.x-l.x)>Math.PI){if(!mn(m,l)){o=!0;break}if(Math.abs(m.x-l.x)>2*Math.PI){o=!0;break}}}if(!o)return s;const h=s.createInstance();h.reserve(s.getPointCount());const g=s.getDescription().getAttributeCount()>1,u=new i.Point2D,c=new i.Point2D,p=new i.Point2D(0,0),d=new i.Point2D(0,0),_=new r.Point;for(a.resetToFirstPath();a.nextPath();){let t=Number.NaN,s=0;for(;a.hasNextSegment();){const n=a.nextSegment();if(m.setCoordsPoint2D(n.getStartXY()),l.setCoordsPoint2D(n.getEndXY()),m.scale(e),l.scale(e),Number.isNaN(t)?(s=Cn(m.x,Number.NaN,s),p.setCoordsPoint2D(m)):p.setCoordsPoint2D(d),t=p.x,mn(m,l)){if(l.x-m.x>2*Math.PI)for(;l.x-m.x>2*Math.PI;)l.x-=2*Math.PI;else if(l.x-m.x<2*-Math.PI)for(;l.x-m.x<2*-Math.PI;)l.x+=2*Math.PI;s=Cn(l.x,Number.NaN,s),d.setCoordsPoint2D(l)}else u.setCoordsPoint2D(l),wn(u),s=Cn(u.x,t,s),d.setCoords(s+u.x,u.y);if(Math.abs(d.x-l.x)<.5&&d.setCoordsPoint2D(l),g)n.queryCoord(0,_),c.setCoordsPoint2D(p),c.scale(1/e),_.setXY(c),a.isFirstSegmentInPath()?h.startPathPoint(_):h.lineToPoint(_),a.isLastSegmentInPath()&&!a.isPathClosed()&&(n.queryCoord(1,_),c.setCoordsPoint2D(d),c.scale(1/e),_.setXY(c),h.lineToPoint(_));else{a.isFirstSegmentInPath()&&h.insertPath2D(-1,null,0,0,!0);const t=h.getPathCount()-1;c.setCoordsPoint2D(p),c.scale(1/e),h.insertPoint2D(t,-1,c),a.isLastSegmentInPath()&&!a.isPathClosed()&&(c.setCoordsPoint2D(d),c.scale(1/e),h.insertPoint2D(t,-1,c))}}}return h}function mn(e,t){return!(!ao(e.y,i.geometryHalfPi)||!ao(t.y,i.geometryHalfPi))||!(!ao(e.y,-i.geometryHalfPi)||!ao(t.y,-i.geometryHalfPi))}function ln(e,t){return!(!ao(e.y,i.geometryHalfPi)||ao(t.y,i.geometryHalfPi))||!(!ao(e.y,-i.geometryHalfPi)||ao(t.y,-i.geometryHalfPi))}function hn(e,t){return!(!ao(t.y,i.geometryHalfPi)||ao(e.y,i.geometryHalfPi))||!(!ao(t.y,-i.geometryHalfPi)||ao(e.y,-i.geometryHalfPi))}class gn{constructor(){this.m_sr=null,this.m_gcs=null,this.m_transform=null,this.m_progressTracker=null,this.m_a=0,this.m_eSquared=0,this.m_rpu=0,this.m_gcsTolerance=0,this.m_radTolerance=0,this.m_maxLength=0,this.m_maxDeviation=0,this.m_curveType=0}geodeticDensify(e){const t=e.createInstance(),s=e.querySegmentIterator(),r=[],o=[],a=new n.SegmentBuffer,m=e.getDescription().getAttributeCount()>1;for(;s.nextPath();){const e=[0];for(;s.hasNextSegment();){const n=s.nextSegment(),l=n.getStartXY(),h=n.getEndXY();l.scale(this.m_rpu),h.scale(this.m_rpu);const g=new i.Point2D,u=new i.Point2D,c=l.compare(h)>0;En(c,l,h,g,u),r.length=0,o.length=0,this.m_maxLength>0?pn(this.m_a,this.m_eSquared,this.m_curveType,g,u,this.m_maxLength,this.m_maxDeviation,this.m_radTolerance,null,null,m?o:null,r,e):dn(),c&&Pn(null,null,m?o:null,r),r[0].setCoordsPoint2D(n.getStartXY()),r.at(-1).setCoordsPoint2D(n.getEndXY());const p=1/this.m_rpu;for(let e=1,t=r.length-1;e<t;e++)r[e].scale(p);if(m){const e=Sn(c,n,a);cn(s.isFirstSegmentInPath(),s.isLastSegmentInPath()&&!s.isPathClosed(),n,e,o,r,t)}else un(s.isFirstSegmentInPath(),s.isLastSegmentInPath()&&!s.isPathClosed(),r,t)}}return t}shapePreservingDensify(e){const t=e.createInstance(),s=e.querySegmentIterator(),r=[],i=[],o=new n.SegmentBuffer,a=e.getDescription().getAttributeCount()>1;for(;s.nextPath();)for(;s.hasNextSegment();){const e=s.nextSegment(),n=e.getStartXY(),m=e.getEndXY(),l=n.compare(m)>0,h=Sn(l,e,o);r.length=0,i.length=0,xn(this.m_a,this.m_eSquared,this.m_rpu,h,this.m_sr,this.m_maxLength,this.m_maxDeviation,a?i:null,r),l&&Pn(null,null,a?i:null,r),a?cn(s.isFirstSegmentInPath(),s.isLastSegmentInPath()&&!s.isPathClosed(),e,h,i,r,t):un(s.isFirstSegmentInPath(),s.isLastSegmentInPath()&&!s.isPathClosed(),r,t)}return t}replaceCurvesWithLinesAndProjectToGCSAsMultiPoint_(e){const t=e.hasNonLinearSegments();if((!this.m_transform||this.m_transform.isIdentity())&&(e=_r(e,this.m_gcs),!t))return e;const s=e.createInstance();s.reserveParts(e.getPointCount(),e.getPathCount());for(let t=0,i=e.getPathCount();t<i;++t){let i=new n.MultiPoint;const o=e.getPathStart(t),a=e.getPathEnd(t);i.addPoints(e,o,a);const m=e.isClosedPath(t);let l=!1;if(m&&a-o===1&&e.hasNonLinearSegmentsPath(t)){const t=new r.Point;e.getPointByVal(o,t),i.add(t),l=!0}if(this.m_transform&&!this.m_transform.isIdentity()){if(m&&!l){const t=new r.Point;e.getPointByVal(o,t),i.add(t)}if(i=(new nn).execute(i,this.m_transform,this.m_progressTracker),m&&i.getPointCount()>1){const e=i.getXY(0),t=i.getXY(i.getPointCount()-1);e.equals(t)&&i.removePoint(i.getPointCount()-1)}}i.getPointCount()>1&&(s.addPathMultiPoint(i,0,-1,!0),m&&s.closePathWithLine())}return s}}function un(e,t,s,n){e&&n.insertPath2D(-1,null,0,0,!0);const r=n.getPathCount()-1;n.insertPointsFromPoints(r,-1,s,0,s.length-1,!0),t&&n.insertPoint2D(r,-1,s.at(-1))}function cn(e,t,s,n,i,o,a){a.reserve(a.getPointCount()+o.length-1);const m=new r.Point;if(s.queryStart(m),e?a.startPathPoint(m):a.lineToPoint(m),o.length>2){const e=n.calculateLength2D();for(let t=1;t<o.length-1;t++){const s=n.lengthToT(i[t]*e);n.queryCoord(s,m),m.setXY(o[t]),a.lineToPoint(m)}}t&&(s.queryEnd(m),a.lineToPoint(m))}function pn(t,s,n,r,a,m,l,h,g,u,c,p,d){const _={stack:[],error:void 0,hasError:!1};try{const f=o.__addDisposableResource(_,new e.PeDoubleClass,!1),y=o.__addDisposableResource(_,new e.PeDoubleClass,!1),x=o.__addDisposableResource(_,new e.PeDoubleClass,!1);e.peLineType.geodeticDistance(t,s,r.x,r.y,a.x,a.y,x,f,y,n);const P=x.val,E=f.val,S=y.val;let C=E,I=S;C<0&&(C+=2*Math.PI),I<0&&(I+=2*Math.PI),g&&(g[0]=C),u&&(u[0]=I);let v=Number.NaN,T=Number.NaN;if(null!==c){const n=e.peMath.q90(t,s),i=e.peMath.q(t,s,r.y);v=(n-i)/P,T=(n+i)/P}const D=ln(r,a),w=hn(r,a),b=D||w,G=function(e,t,s){return!(!Dn(e,t,s)||ao(e.y,i.geometryHalfPi)||ao(e.y,-i.geometryHalfPi)||ao(t.y,i.geometryHalfPi)||ao(t.y,-i.geometryHalfPi))}(r,a,h),N=o.__addDisposableResource(_,new i.SimpleDisposableArray(new e.PeDoubleClass,new e.PeDoubleClass),!1),H=new i.Point2D,A=new i.Point2D,F=new i.Point2D;d[0]=Cn(r.x,Number.NaN,d[0]);let V=d[0];if(P<=m)return p.push(r.clone()),d[0]=Cn(a.x,Number.NaN,d[0]),null!=c&&c.push(0),b?(D&&In(r,a,c,p),w&&vn(r,a,c,p)):G?Tn(r,a,E,v,T,c,p):l>0&&(A.setCoords(r.x-V,r.y),H.setCoords(a.x-d[0],a.y),V=_n()),p.push(a.clone()),P;const R=1+Math.ceil(P/m),k=P/(R-1),M=new i.Point2D;p.push(r.clone()),M.setCoordsPoint2D(r),A.setCoords(r.x-d[0],r.y),null!==c&&c.push(0);for(let i=1;i<R;i++){let o;if(i<R-1){const a=i*k;e.peLineType.geodeticCoordinate(t,s,r.x,r.y,a,E,N.at(0),N.at(1),n),H.setCoords(N.at(0).val,N.at(1).val),d[0]=Cn(H.x,M.x,d[0]),F.setCoords(d[0]+H.x,H.y),o=i/(R-1)}else d[0]=Cn(a.x,Number.NaN,d[0]),H.setCoords(a.x-d[0],a.y),F.setCoordsPoint2D(a),o=1;b?(1===i&&D&&In(r,F,c,p),i===R-1&&w&&vn(M,a,c,p)):G?Dn(M,F,h)&&(r.x<a.x?M.x>F.x&&(d[0]+=2*Math.PI,F.setCoords(d[0]+H.x,H.y)):M.x<F.x&&(d[0]-=2*Math.PI,F.setCoords(d[0]+H.x,H.y)),Tn(M,F,E,v,T,c,p)):l>0&&_n(),p.push(F.clone()),null!=c&&c.push(o),M.setCoordsPoint2D(F),A.setCoordsPoint2D(H),V=d[0]}return P}catch(e){_.error=e,_.hasError=!0}finally{o.__disposeResources(_)}}function dn(e,t,n,r,i,o,a,m,l,h){s.geometryReleaseAssert(0)}function _n(e,t,n,r,i,o,a,m,l,h,g,u,c,p,d){return s.geometryReleaseAssert(0),0}function fn(e,t,s,n){const i=E(e,t,s),o=E(e,t,n);return r.Point3D.distance(i,o)}function yn(t,n,o,a,m,l,h,g){const u=new Array,c=i.makeObjectArray(Array,8);let p=2,d=m.getCoord2D(l);c[0][0]=d.x,c[0][1]=d.y,d=m.getCoord2D(h),c[1][0]=d.x,c[1][1]=d.y;const _=t=>{if(null!==o){const n=e.peCSTransformations.projToGeog(o,t,c);s.geometryReleaseAssert(n===t)}for(const e of c)e[0]*=a,e[1]*=a};_(2),u.push(E(t,n,new i.Point2D(c[0][0],c[0][1]))),u.push(E(t,n,new i.Point2D(c[1][0],c[1][1])));let f=r.Point3D.distance(u[0],u[1]);if(f>g)return f;let y=0;for(p=3;p<=17;){const e=1/(p-1);let o=0;for(let t=1;t<p;++t)if(1&t){const s=i.lerp(l,h,t*e);m.queryCoord2D(s,d),c[o][0]=d.x,c[o][1]=d.y,o++}_(o);let a=1;for(let e=0;e<o;++e)u.splice(a,0,E(t,n,new i.Point2D(c[e][0],c[e][1]))),a++;a=0;let x=u[a];a++;let P=0;for(;a!==u.length;++a){const e=u[a];P+=r.Point3D.distance(x,e),x=e}if(P>g)return P;if(y=P-f,s.geometryReleaseAssert(y>=0||Math.abs(y)<1e-14*P),y<0&&(y=0),f=P,P+y<=g)return P+y;p=2*p-1}return f+y}function xn(t,n,r,o,a,m,l,h,g){const u=o.isCurve(),c=function(e,t){return e*Math.sqrt(1-t)}(t,n)*Math.PI*179/180;let p=m;m>0&&!(m>c)||(p=c);const d=l,_=d>0;let f=Number.NaN;_&&(f=function(e,t,s){const n=s/(2*H(e,t)),r=n*n;return s*(1-r*(.16666666666666666-.008333333333333333*r))}(t,n,d));const y=1===a.getCoordinateSystemType();let x=null;y||(x=a.getPECoordSys());const P=a.getTolerance(0),S=o.getStartXY(),C=o.getEndXY(),I=new i.Point2D,v=new i.Point2D;if(y)I.setCoordsPoint2D(S),I.scale(r),v.setCoordsPoint2D(C),v.scale(r);else{const t=[S.x,S.y,C.x,C.y];e.peCSTransformations.projToGeog(x,2,t),I.setCoords(t[0],t[1]),I.scale(r),v.setCoords(t[2],t[3]),v.scale(r)}let D=0,b=0;const G=[],N=[],A=[];G.push(C.clone()),N.push(v.clone()),A.push(1),g.push(S.clone()),null!==h&&h.push(b);const F=a.isPannable(),V=S.clone(),R=[.5,.33333333333333337,.6666666666666666,.16666666666666669,.8333333333333333];let k=5;u||(_?(R[0]=.5,R[1]=.25,R[2]=.75,k=3):k=1),s.geometryReleaseAssert(p>0);const M=t=>{if(t=t.clone(),null!==x){const s=[t.x,t.y];e.peCSTransformations.projToGeog(x,1,s),t.setCoords(s[0],s[1])}return t.scale(r),t};for(;N.length>0;){const e=G.at(-1).clone();v.assign(N.at(-1));const m=A.at(-1);let l=!1,c=Number.NaN;const d=yn(t,n,x,r,o,b,m,p);let S=p>=d&&Math.abs(I.y-v.y)<.9*Math.PI;y&&S&&(S=Math.abs(I.x-v.x)<.9*Math.PI);const C=new i.Point2D,H=new i.Point2D;let U=!1;if(!_&&S&&S&&(U=!0),o.calculateSubLength(b,m)<=P&&(U=!0),!U)for(let h=0;h<k;h++){const g=i.lerp(b,m,R[h]),p=new i.Point2D;o.queryCoord2D(g,p);const d=M(p);if(0===h&&(c=g,C.setCoordsPoint2D(p),H.setCoordsPoint2D(d),!S)){l=!0;break}if(s.geometryReleaseAssert(_),y&&Math.abs(I.x-d.x)>=Math.PI){l=!0;break}let x=new i.Point2D,P=new i.Point2D;u?(x=i.Point2D.lerp(V,e,R[h]),P=M(x)):(x=p.clone(),P=d.clone());const D=T(t,n,I,v,R[h]),G=D.clone();if(y?(G.x/=r,G.y/=r):(G.x/=r,G.y/=r,Qs(a.getGCSToSRTransform(),[G],1,[G],null)),G.isNAN()){const e=E(t,n,d),s=E(t,n,I),r=E(t,n,v),{second:i}=w(t,n,e,s,r,2,null);if(i>f){l=!0;break}}else{if(F){const e=a.getPannableExtent().width(),t=i.lerp(o.getStartX(),o.getEndX(),.5);for(;G.x<t-.5*e;)G.x+=e;for(;G.x>=t+.5*e;)G.x-=e}const e=o.getClosestCoordinateOnInterval(G,new i.Envelope1D(b,m),-1);let s=o.getCoord2D(e);s=M(s);let r=fn(t,n,s,D);if(r>f){if(r<4*f){const e=E(t,n,s),i=E(t,n,I),o=E(t,n,v),{second:a}=w(t,n,e,i,o,2,null);r=a}if(r>f){l=!0;break}}else if(u){let e=E(t,n,d);const s=E(t,n,I),r=E(t,n,v);let{second:i}=w(t,n,e,s,r,3,null);if(i<=f){e=E(t,n,P);const{second:o}=w(t,n,e,s,r,3,null);i=o}if(i>f){l=!0;break}}}}l?(G.push(C.clone()),N.push(H.clone()),A.push(c)):(G.pop(),N.pop(),A.pop(),g.push(e.clone()),D+=d,null!==h&&h.push(D),V.setCoordsPoint2D(e),I.setCoordsPoint2D(v),b=m)}if(null!==h){const e=1/D;for(let t=0;t<h.length;t++)h[t]*=e}}function Pn(e,t,s,n){if(n.reverse(),null!==s&&s.reverse(),e){const s=e[0],n=t[0];e[0]=n,t[0]=s}}function En(e,t,s,n,r){e?(n.setCoordsPoint2D(s),r.setCoordsPoint2D(t)):(n.setCoordsPoint2D(t),r.setCoordsPoint2D(s))}function Sn(e,t,s){return e?(s.create(t.getGeometryType()),t.copyTo(s.get()),s.get().reverse(),s.get()):t}function Cn(e,t,s){if(Number.isNaN(t)){for(;s-e>Math.PI;)s-=2*Math.PI;for(;e-s>Math.PI;)s+=2*Math.PI;return s}return s+e-t>Math.PI?s-=2*Math.PI:t-(s+e)>Math.PI&&(s+=2*Math.PI),s}function In(e,t,s,n){if(e.y>0){const r=new i.Point2D;r.setCoords(t.x,i.geometryHalfPi),ao(e.x,r.x)||ao(t.y,r.y)||(n.push(r),null!==s&&s.push(0))}else{const r=new i.Point2D;r.setCoords(t.x,-i.geometryHalfPi),ao(e.x,r.x)||ao(t.y,r.y)||(n.push(r),null!==s&&s.push(0))}}function vn(e,t,s,n){if(t.y>0){const r=new i.Point2D;r.setCoords(e.x,i.geometryHalfPi),ao(t.x,r.x)||ao(e.y,r.y)||(n.push(r),null!==s&&s.push(1))}else{const r=new i.Point2D;r.setCoords(e.x,-i.geometryHalfPi),ao(t.x,r.x)||ao(e.y,r.y)||(n.push(r),null!==s&&s.push(1))}}function Tn(e,t,s,n,r,o,a){if(l=oo,0===(m=s)||Math.abs(m)<=l){if(i.geometryHalfPi-e.y>0){const t=new i.Point2D;t.setCoords(e.x,i.geometryHalfPi),a.push(t),null!==o&&o.push(n)}if(i.geometryHalfPi-t.y>0){const e=new i.Point2D;e.setCoords(t.x,i.geometryHalfPi),a.push(e),null!==o&&o.push(n)}}else{if(i.geometryHalfPi+e.y>0){const t=new i.Point2D;t.setCoords(e.x,-i.geometryHalfPi),a.push(t),null!==o&&o.push(r)}if(i.geometryHalfPi+t.y>0){const e=new i.Point2D;e.setCoords(t.x,-i.geometryHalfPi),a.push(e),null!==o&&o.push(r)}}var m,l}function Dn(e,t,s){return Math.abs(Math.abs(e.x-t.x)-Math.PI)<=s}function wn(e){if(e.x<-Math.PI)for(;e.x<-Math.PI;)e.x+=2*Math.PI;else if(e.x>Math.PI)for(;e.x>Math.PI;)e.x-=2*Math.PI}function bn(e,s,n,i,o){const l=new t.Envelope2D;n.queryEnvelope(l);const h=r.calculateToleranceFromGeometryForOpFromGeom(null,n,!0).total();if(s.xmin-l.xmin<=h&&l.xmax-s.xmax<=h)return n;const g=s.width();let u=0;for(;s.xmin+u*g<l.xmin;)u++;for(;s.xmin+u*g>l.xmin;)u--;const c=u*g,p=new a.Transformation2D;p.setShiftCoords(-c,0);const d=n;d.applyTransformation(p);const _=new t.Envelope2D;d.queryEnvelope(_);let f=null;if(_.xmax>s.xmax){let n=0;const i=new t.Envelope2D;i.setCoords({env2D:s}),i.ymin-=1,i.ymax+=1;let a=d;for(;i.xmin<_.xmax;){_.xmax>i.xmax&&(a=pr(a,e,2,!0,i.xmax));const t=r.getMergedExtentEnv2D(a,i),l=r.calculateToleranceFromGeometryForOp(null,t,!0).total(),h=m.clip$1(a,i,l,Number.NaN,o);null===f?f=h===a?h.clone():h:(p.setShiftCoords(-n*g,0),h.applyTransformation(p),f.add(h,!1)),n++,i.xmin=i.xmax,i.xmax=s.xmax+n*g}}else f=d;return f}class Gn{constructor(e,t){this.m_basisX=new r.Point3D,this.m_basisY=new r.Point3D,this.m_normal=new r.Point3D,s.geometryReleaseAssert(1===e.getCoordinateSystemType()),this.m_gcs=e;const n=Ti();e.querySpheroidData(n),this.m_a=n.majorSemiAxis,this.m_e2=n.e2,this.m_rpu=e.getUnit().getUnitToBaseFactor(),this.m_curvCenterRad=t.mul(this.m_rpu);const o=this.m_curvCenterRad.x,a=this.m_curvCenterRad.y,m=Math.cos(o),l=Math.sin(o),h=Math.cos(a),g=Math.sin(a);this.m_cartCenter3D=function(e,t,s,n,r,i){return S(e,t,s,n,r,i,0)}(this.m_a,this.m_e2,m,l,h,g),this.m_normal.setCoordsPoint3D(this.m_cartCenter3D),this.m_d=this.m_cartCenter3D.length(),this.m_normal.divThis(this.m_d),r.Point3D.selectRightHandedBasisFromNormal(this.m_normal,this.m_basisX,this.m_basisY),this.m_northPolePcs=this.projectPoint(i.Point2D.construct(0,.5*Math.PI/this.m_rpu)),this.m_southPolePcs=this.projectPoint(i.Point2D.construct(0,.5*-Math.PI/this.m_rpu))}project(e){const t=e.getGeometryType();if(s.isMultiVertex(t)){s.throwIfCurves(e);const t=e;return this.projectMultiVertex(t)}s.throwInvalidArgumentException("Gnomonic.project")}unproject(e,o,a){const m=e.getGeometryType();if(s.isMultiVertex(m)){s.throwIfCurves(e);let l=e;const h=[];if(m===s.GeometryType.enumPolygon){const e=l.getPathCount();for(let t=0;t<e;t++){const e=l.calculateRingArea2D(t);h.push(e)}}return this.unprojectMultiVertex(o,l),s.isMultiPath(m)?(function(e,t,s){const n=e.getPannableExtent(),r=i.Point2D.construct(0,0);n.centerAt(r);const o=n.width(),a=.5*o,m=new i.Point2D;m.setNAN();let l=Number.NaN;for(let e=0;e<s.getPathCount();e++)for(let t=s.getPathStart(e);t<s.getPathEnd(e);t++){const r=s.getXY(t),i=ao(r.y,n.ymax)||ao(n.ymin,r.y);t===s.getPathStart(e)?(m.setNAN(),l=0):m.isNAN()||i||(l=An(r.x,m.x,a,o,l)),r.x+=l,s.setXYNoCurves(t,r),i||m.setCoordsPoint2D(r)}s.getImpl().notifyModifiedFlags(2001)}(this.m_gcs,0,l),function(e,o,a,m,l){const h=m.getGeometryType(),g=o.getPannableExtent();let u=m,c=!1,p=!1;if(h===s.GeometryType.enumPolygon){const s=new t.Envelope2D,a=i.Point2D.construct(0,0);s.setCoords({env2D:g}),s.centerAt(a),c=function(e,s,r,o,a){const m=function(e,s){const r=new t.Envelope2D;s.queryEnvelope(r);const o=ao(e.ymax,r.ymax),a=ao(e.ymin,r.ymin),m=o||a;return!!m&&(function(e,s){const r=new n.Polygon,o=new t.Envelope2D;for(let t=0;t<s.getPathCount();t++){s.queryPathEnvelope(t,o);let n=ao(e.ymax,o.ymax),a=ao(e.ymin,o.ymin);if(!n&&!a){r.addPath(s,t,!0);continue}r.insertPath2D(-1,null,0,0,!0);const m=s.getPathStart(t),l=s.getPathEnd(t),h=l-m;let g=-1;for(g=m;g<l;g++){const t=s.getXY(g);if(n=ao(e.ymax,t.y),a=ao(e.ymin,t.y),!n&&!a)break}let u=g,c=!1,p=Number.NaN;do{const o=s.getXY(u);n=ao(e.ymax,o.y),a=ao(e.ymin,o.y);const l=m+(u+1-m)%h;if(n||a){let n=i.Point2D.construct(p,o.y);r.insertPoint2D(t,-1,n);const a=s.getXY(l),m=ao(e.ymax,a.y),h=ao(e.ymin,a.y);m||h||(n=i.Point2D.construct(a.x,o.y),c?r.setXYNoCurves(r.getPointCount()-1,n):r.insertPoint2D(t,-1,n)),c=!0}else r.insertPoint2D(t,-1,o),p=o.x,c=!1;u=l}while(u!==g)}s.setEmpty(),s.add(r,!1)}(e,s),m)}(r,o),l=function(e,t,s,r,i){const o=[],a=[],m=.5*s.width();for(let n=0;n<r.getPathCount();n++){const l=r.getXY(r.getPathStart(n)),h=r.getXY(r.getPathEnd(n)-1),g=e[n]<0;if(Math.abs(l.x-h.x)>m){const e=Nn(g,t,s,n,r,i);o.push(e),a.push(n)}else if(!g&&r.calculateRingArea2D(n)<0){const e=Hn(t,s,n,r,i);o.push(e),a.push(n)}}if(0===o.length)return!1;const l=new n.Polygon({vd:r.getDescription()});let h=0,g=a[h];for(let e=0;e<r.getPathCount();e++)e===g?(l.add(o[h],!1),h++,h<a.length&&(g=a[h])):l.addPath(r,e,!0);return r.setEmpty(),r.add(l,!1),!0}(e,s,r,o,a);return m||l}(e,o,s,u,l);const m=function(e,s,n,i){const o=new t.Envelope2D;n.queryEnvelope(o);const a=r.calculateToleranceFromGeometryForOpFromGeom(null,n,!0).total();if(s.xmin-o.xmin<=a&&o.xmax-s.xmax<=a)return n;const m=n.createInstance();let l=n.createInstance();const h=new t.Envelope2D,g=n.getPathCount();for(let t=0;t<g;t++)n.queryPathEnvelope(t,h),s.xmin-h.xmin<=a&&h.xmax-s.xmax<=a?m.addPath(n,t,!0):(l.setEmpty(),l.addPath(n,t,!0),l=bn(e,s,l,0,i),m.add(l,!0));return m}(o,s,u,l);m!==u&&(p=!0),u=m}else u=(new nn).foldInto360RangeGeodetic(u,o,2);h===s.GeometryType.enumPolygon&&(c||p)&&(u=(new Xs).execute(u,o,!1,l)),u!==m&&(m.setEmpty(),m.add(u,!1))}(h,this.m_gcs,0,l,a)):l=lr(l,this.m_gcs,0,!0,0,a),l}s.throwInvalidArgumentException("Gnomonic.unproject")}projectPoint(e){const t=e.mul(this.m_rpu),s=E(this.m_a,this.m_e2,t),n=this.m_normal.dotProduct(s);if(n<=0)return i.Point2D.construct(Number.NaN,Number.NaN);const r=this.m_d/n,o=s.mul(r).sub(this.m_cartCenter3D),a=new i.Point2D;return a.x=this.m_basisX.dotProduct(o),a.y=this.m_basisY.dotProduct(o),a}unprojectPoint(e){const t=this.m_cartCenter3D.add(this.m_basisX.mul(e.x).add(this.m_basisY.mul(e.y)));return I(this.m_a,this.m_e2,t).divide(this.m_rpu)}projectMultiVertex(e){const t=e.getImpl();let s=!0;const n=new i.Point2D,r=new i.Point2D;for(let e=0,i=t.getPointCount();e<i;e++)t.queryXY(e,n),n.y*this.m_rpu>.5*Math.PI?r.assign(this.m_northPolePcs):n.y*this.m_rpu<.5*-Math.PI?r.assign(this.m_southPolePcs):r.assign(this.projectPoint(n)),t.setXYNoCurves(e,r),r.isNAN()&&(s=!1);return t.notifyModifiedFlags(2001),s}unprojectMultiVertex(e,t){const s=t.getImpl(),n=e*e,r=!this.m_northPolePcs.isNAN(),o=!this.m_southPolePcs.isNAN();for(let e=0,t=s.getPointCount();e<t;e++){const t=s.getXY(e);let a=new i.Point2D;r&&i.Point2D.sqrDistance(t,this.m_northPolePcs)<=n?(a.setCoords(this.m_curvCenterRad.x,.5*Math.PI),a.scale(1/this.m_rpu)):o&&i.Point2D.sqrDistance(t,this.m_southPolePcs)<=n?(a.setCoords(this.m_curvCenterRad.x,.5*-Math.PI),a.scale(1/this.m_rpu)):a=this.unprojectPoint(t),s.setXYNoCurves(e,a)}s.notifyModifiedFlags(2001)}}function Nn(e,s,o,l,h,g){const u=new n.Polygon,c=new n.Polygon,p=new a.Transformation2D,d=h.getXY(h.getPathStart(l)),_=h.getXY(h.getPathEnd(l)-1),f=o.width(),y=.5*f,x=new t.Envelope2D;h.queryEnvelope(x);const P=Math.ceil(x.width()/f)+1;let E,S;d.x>_.x?(E=-f,S=e?o.ymin:o.ymax):(E=f,S=e?o.ymax:o.ymin),p.setShiftCoords(E,0),u.addPath(h,l,!0),c.add(u,!1);const C=new r.Point;for(let e=0;e<P;e++)c.applyTransformation(p),c.getPointByVal(0,C),u.lineToPoint(C),u.addSegmentsFromPath(c,0,0,c.getSegmentCount()-1,!1);const I=u.getXY(0),v=u.getXY(u.getPointCount()-1);I.y=S,v.y=S,u.lineTo(v);const T=new i.Point2D;for(T.setCoordsPoint2D(v),T.x-=.5*E;Math.abs(T.x-I.x)>y;)u.lineTo(T),T.x-=.5*E;u.lineTo(I);const D=o.getCenter().x,w=new t.Envelope2D;u.queryEnvelope(w);let b=0;const G=w.getCenter().x;G-D>y?b=-Math.ceil((G-D-y)/f):D-G>y&&(b=Math.ceil((D-G-y)/f)),0!==b&&(p.setShiftCoords(b*f,0),u.applyTransformation(p));const N=new n.EditShape,H=N.addGeometry(u);dr(N,H,s,0,2,!0,o.xmin),dr(N,H,s,0,2,!0,o.xmax);const A=N.getGeometry(H),F=r.getMergedExtentEnv2D(A,o);F.inflateCoords(0,1);const V=r.calculateToleranceFromGeometryForOp(null,F,!0);return m.clip$1(A,o,V.total(),Number.NaN,g)}function Hn(e,s,o,l,h){const g=s.width(),u=.5*g,c=s.getCenter().x,p=new t.Envelope2D;l.queryPathEnvelope(o,p);let d,_=0,f=p.getCenter().x;if(f-c>u?_=-Math.ceil((f-c-u)/g):c-f>u&&(_=Math.ceil((c-f-u)/g)),0!==_){const e=new a.Transformation2D;e.setShiftCoords(_*g,0),l.getImpl().applyTransformationToPath(e,o),l.queryPathEnvelope(o,p),f=p.getCenter().x}const y=new t.Envelope2D;s.containsExclusiveEnvelope(p)?(d=!1,y.setCoords({env2D:s})):(d=!0,y.setCoords({env2D:s}),y.xmin-=g,y.xmax+=g);let x=l.createInstance();x.addPathPoint2D(null,0,!0);const P=new i.Point2D;if(P.setCoords(y.xmin,y.ymin),x.insertPoint2D(0,-1,P),P.setCoords(y.xmin,y.ymax),x.insertPoint2D(0,-1,P),P.setCoords(.5*(y.xmin+y.xmax),y.ymax),x.insertPoint2D(0,-1,P),P.setCoords(y.xmax,y.ymax),x.insertPoint2D(0,-1,P),P.setCoords(y.xmax,y.ymin),x.insertPoint2D(0,-1,P),P.setCoords(.5*(y.xmin+y.xmax),y.ymin),x.insertPoint2D(0,-1,P),d){x.addPath(l,o,!0);const t=new a.Transformation2D;f<c?t.setShiftCoords(g,0):t.setShiftCoords(-g,0),l.getImpl().applyTransformationToPath(t,o),x.addPath(l,o,!0);const i=new n.EditShape,u=i.addGeometry(x);dr(i,u,e,0,2,!0,s.xmin),dr(i,u,e,0,2,!0,s.xmax),x=i.getGeometry(u);const p=r.getMergedExtentEnv2D(x,s);p.inflateCoords(0,1);const d=r.calculateToleranceFromGeometryForOp(null,p,!0).total();x=m.clip$1(x,s,d,Number.NaN,h)}else x.addPath(l,o,!0);return x}function An(e,t,s,n,r){return r+e-t>s?r-=n:t-(r+e)>s&&(r+=n),r}function Fn(e,t,s,o,a,m){const l=t.getAttributeStreamRef(0),h=t.getPointCount();let g=!1;const u=new i.Point2D;for(let e=0;e<h;++e){if(l.queryPoint2D(2*e,u),1&m&&u.y>=s){g=!0;break}if(2&m&&u.y<=-s){g=!0;break}}if(!g)return!1;let c=!1;e&&(c=t.getImpl().isClosedPathInXYPlane(0));const p=new n.EditShape,d=p.addGeometry(t),_=p.getFirstPath(d);let f=-1,y=!0;const x=new i.Point2D,P=new r.Point;let E=n.nullHandle;const S=Vn*a/360;for(let e=p.getFirstVertex(_);e!==n.nullHandle;e=p.getNextVertex(e)){p.queryXY(e,u);let t=1&m&&u.y>=s?1:0;if(t|=2&m&&u.y<=-s?2:0,f>0&&f!==t){if(x.x!==u.x){const t=p.getPrevVertex(e);p.queryPoint(t,P);const s=p.insertVertex(_,e,P);x.x=u.x,p.setXY(s,x)}if(c){let t=E!==n.nullHandle?p.getNextVertex(E):p.getFirstVertex(_);const s=p.getPrevVertex(e);for(;t!==s;)t=p.removeVertex(t,!1);if(E!==n.nullHandle){const e=p.getXY(E),t=p.getXY(s);if(Math.abs(e.x-t.x)>S){p.queryPoint(E,P);const n=p.insertVertex(_,s,P);e.x=i.lerp(e.x,t.x,.5),p.setXY(n,e)}}}E=n.nullHandle}if(t&&(u.y=i.copySign(o,u.y),p.setXY(e,u),!y&&f!==t))if(u.x!==x.x){p.queryPoint(e,P);const t=p.insertVertex(_,e,P);p.setXYCoords(t,x.x,u.y),E=t}else E=e;f=t,x.assign(u),y=!1}if(c){if(E!==n.nullHandle){let e=p.getNextVertex(E);for(;e!==n.nullHandle;)e=p.removeVertex(e,!1)}const e=p.getFirstVertex(_);let t=p.getLastVertex(_);const s=p.getXY(e),r=p.getXY(t);if(!s.equals(r)&&(p.queryPoint(e,P),t=p.insertVertex(_,n.nullHandle,P),Math.abs(s.x-r.x)>S)){const e=p.insertVertex(_,t,P);s.x=i.lerp(s.x,r.x,.5),p.setXY(e,s)}}return t.assignCopy(p.getGeometry(d)),!0}const Vn=210;class Rn{constructor(e,t,n,r,i,o,a,m,l){this.m_bAdjustedAtPoles=0,this.m_inputPoly=n,this.m_progressTracker=l,this.m_originalGeometry=e,this.m_originalSR=r,this.m_polygonRingFlags=t,this.m_pannableSR=i,this.m_poleSnappingTolerance=m,this.m_poleFlags=a,this.m_bAdjustedAtPoles=0,this.m_pannableExtent=function(e,t){const s=e.getPannableExtent();return Number.isNaN(t)||s.centerAtCoords(t,0),s}(this.m_pannableSR,o),this.m_centralLongitude=Number.isNaN(o)?this.m_pannableExtent.getCenterX():o,this.m_width360=this.m_pannableExtent.width(),this.m_degree=this.m_width360/360,this.m_GCSLargeDelta=Vn*this.m_degree,s.geometryReleaseAssert(null===this.m_originalGeometry&&null===this.m_originalSR||null!==this.m_originalGeometry&&null!==this.m_originalSR)}geonormalizeRing(e,t,o,a,m,l,h){let g=o;const u=new n.Polyline({vd:this.m_inputPoly.getDescription()});u.addPath(this.m_inputPoly,e,!0),0!==this.m_poleFlags&&(this.m_bAdjustedAtPoles|=Fn(!0,u,this.m_pannableExtent.ymax-this.m_poleSnappingTolerance,this.m_pannableExtent.ymax,this.m_pannableExtent.width(),this.m_poleFlags)?1:0,this.m_bAdjustedAtPoles&&(g=!1));let c=-1;g&&(c=this.m_originalGeometry.getPathStart(e));const p=u.getAttributeStreamRef(0),d=u.getPointCount();let _=0,f=p.read(0),y=0;const x=3*this.m_pannableSR.getTolerance(0);let P=!1;const E=new i.Point2D,S=new i.Point2D;let C=!1;const I=u.hasNonLinearSegments(),v=new i.Point2D;for(let e=1;e<d;++e){p.queryPoint2D(2*e,v);const t=v.x;let n=t+_;const o=n-f;if(v.x=n,Math.abs(o)>this.m_GCSLargeDelta){if(g){const t=c+e-1,s=c+(e+1<d?e:0),n=l.read(2*t),r=(l.read(2*s)-n)*a;Math.abs(o-r)>1*this.m_degree&&(g=!1)}g||(_-=i.copySign(this.m_width360,n-f),n=t+_,++y,C=0!==_,v.x=n)}else P||r.isAngleTooSharp(E,S,v,x)&&(P=!0);C&&(I&&s.throwInternalErrorException("error in geonormalize_ring_ for curves"),p.write(2*e,n)),f=n,E.setCoordsPoint2D(S),S.setCoordsPoint2D(v)}y&&u.notifyModified();const T=u.getXY(0),D=u.getXY(d-1);if(i.Point2D.distance(T,D)<x){const e=this.finalizeGeoNormalizeClosedRing(u,P,m);h.add(e,!1)}else{t<0&&(null!==this.m_originalGeometry?(s.geometryReleaseAssert(null!==this.m_originalGeometry),t=this.m_originalGeometry.calculateRingArea2D(e)>0?1:0):t=1);const n=this.finalizeGeoNormalizeOpenedRing(t>0,u);h.add(n,!1)}}geoNormalizePolygonGeometry(e){s.geometryReleaseAssert(this.m_originalSR&&this.m_originalGeometry||!this.m_originalGeometry&&!this.m_originalSR),s.geometryReleaseAssert(this.m_pannableSR.isPannable());let r=null,i=Number.NaN;const o=!!this.m_originalSR&&this.m_originalSR.isPannable();o&&(r=this.m_originalGeometry.getAttributeStreamRef(0),i=this.m_width360/this.m_originalSR.getPannableExtent().width()),this.m_bAdjustedAtPoles=0;const a=new n.Polygon({vd:this.m_inputPoly.getDescription()});for(let t=0,s=this.m_inputPoly.getPathCount();t<s;++t){const s=this.m_polygonRingFlags?this.m_polygonRingFlags[t]?1:0:-1;this.geonormalizeRing(t,s,o,i,e,r,a)}const h=this.m_pannableSR.getTolerance(0),g=this.m_pannableExtent.width()/180;Pr(a,this.m_pannableExtent,.1*h,!1);const u=t.Envelope2D.constructEmpty();if(u.setCoords({env2D:this.m_pannableExtent}),e){let e=!0;for(let s=0;s<2;s++){e=!0;const s=t.Envelope2D.constructEmpty();for(let t=0,n=a.getPathCount();t<n;t++)if(a.queryPathEnvelope(t,s),!(u.xmin<=s.xmin&&u.xmax>=s.xmax||s.xmin>=u.xmax||s.xmax<=u.xmin)){e=!1;break}if(e)break;u.move(.5*this.m_width360,0)}e||u.setCoords({env2D:this.m_pannableExtent})}let c=m.clip$1(a,u,h,g,this.m_progressTracker),p=a!==c;const d=this.m_originalGeometry?this.m_originalGeometry.calculateArea2D():1,_=c.calculateArea2D();let f=0;if(_>0&&d<0)f=1;else if(_<=0&&d>0)if(0===_){if(this.m_originalSR){let e=Number.NaN;2===this.m_originalSR.getCoordinateSystemType()?e=this.m_originalSR.getPCSHorizon().calculateArea2D():1===this.m_originalSR.getCoordinateSystemType()&&(e=this.m_originalSR.getPannableExtent().getArea()),d>.99*e&&(f=-1)}}else f=-1;if(0!==f){const e=function(e,t){let s=new n.Polygon({vd:e});s.addEnvelope(t,!1);const r=t.width()/180;return s=(new l.OperatorDensify).execute(s,r,0,0,null),s}(c.getDescription(),u);e.add(c,!1),p=!0,c=e}return p&&(c=(new Xs).execute(c,this.m_pannableSR,!1,this.m_progressTracker)),c}geoNormalizePolylineGeometry(e){s.geometryReleaseAssert(this.m_pannableSR.isPannable());let r=null;const o=this.m_originalSR&&this.m_originalSR.isPannable();let l=1;o&&(s.geometryReleaseAssert(this.m_originalGeometry),l=this.m_width360/this.m_originalSR.getPannableExtent().width(),r=this.m_originalGeometry.getAttributeStreamRef(0));const h=this.m_pannableExtent.width(),g=h*i.doubleEps()*4;let u=e,c=Number.NaN;const p=i.Envelope1D.constructEmpty();this.m_bAdjustedAtPoles=0;let d=new n.Polyline({vd:this.m_inputPoly.getDescription()});for(let e=0,m=this.m_inputPoly.getPathCount();e<m;++e){let m=o;const _=new n.Polyline({vd:this.m_inputPoly.getDescription()});_.addPath(this.m_inputPoly,e,!0);const f=this.m_inputPoly.isClosedPath(e);0!==this.m_poleFlags&&(this.m_bAdjustedAtPoles|=Fn(f,_,this.m_pannableExtent.ymax-this.m_poleSnappingTolerance,this.m_pannableExtent.ymax,h,this.m_poleFlags)?1:0,this.m_bAdjustedAtPoles&&(m=!1));let y=-1;const x=_.getPointCount();let P=!1;m&&(y=this.m_originalGeometry.getPathStart(e),P=this.m_originalGeometry.isClosedPath(e));const E=_.getAttributeStreamRef(0);let S=0,C=E.read(0),I=0;const v=new i.Point2D,T=new i.Point2D;let D=!1;const w=_.hasNonLinearSegments(),b=new i.Point2D;for(let e=1;e<x;++e){E.queryPoint2D(2*e,b);const t=b.x;let n=t+S;const o=n-C;if(b.x=n,Math.abs(o)>this.m_GCSLargeDelta){if(m){const t=y+e-1;let s=y;(!P||e+1<x)&&(s+=e);const n=r.read(2*t),i=(r.read(2*s)-n)*l;Math.abs(o-i)>1*this.m_degree&&(m=!1)}m||(S-=i.copySign(this.m_width360,n-C),n=t+S,++I,D=0!==S,b.x=n)}D&&(w&&s.throwInternalErrorException("error in geonormalize_ring_ for curves"),E.write(2*e,n)),C=n,v.setCoordsPoint2D(T),T.setCoordsPoint2D(b)}if(I&&_.notifyModified(),u){let e=!1;if(!_.isEmpty()){const n=t.Envelope2D.constructEmpty();if(_.queryEnvelope(n),n.width()>=h||n.ymin<=this.m_pannableExtent.ymin||n.ymax>=this.m_pannableExtent.ymax)e=!0;else{if(Number.isNaN(c)){const e=this.m_centralLongitude-.5*h;c=n.xmin,c+=Math.round((e-n.xmin)/h)*h,c>e&&(c-=h),s.geometryReleaseAssert(c<=e),c<e&&(c+=h),s.geometryReleaseAssert(c>=e)}let t=Math.round((c-n.xmin)/h)*h;if(n.xmin+t>c+g&&(t-=h),n.xmin+t<c-g&&(t+=h),p.mergeCoordinate(n.xmin+t),p.mergeCoordinate(n.xmax+t),e=p.width()>=h,!e){const e=new a.Transformation2D;e.setShiftCoords(t,0),_.applyTransformation(e)}}}d.add(_,!1),e&&(d=(()=>{const e=new n.Polyline({vd:d.getDescription()});for(let t=0,s=d.getPathCount();t<s;++t){const s=new n.Polyline({vd:d.getDescription()});s.addPath(d,t,!0);const r=lr(s,this.m_pannableSR,this.m_centralLongitude,!0,0,this.m_progressTracker);e.add(r,!1)}return e})(),u=!1)}else{const e=lr(_,this.m_pannableSR,this.m_centralLongitude,!0,0,this.m_progressTracker);d.add(e,!1)}}if(u)return d;const _=this.m_pannableSR.getTolerance(0),f=this.m_pannableExtent.width()/180;return Pr(d,this.m_pannableExtent,.1*_,!1),m.clip$1(d,this.m_pannableExtent,_,f,this.m_progressTracker)}finalizeGeoNormalizeOpenedRing(e,r){const o=r.getPointCount(),m=r.getXY(0),l=r.getXY(o-1);{const e=Math.abs(l.x-m.x),t=Math.round(e/this.m_width360)*this.m_width360;s.geometryReleaseAssert(Math.abs(e-t)<this.m_pannableSR.getTolerance(0))}const h=i.sign(l.x-m.x),g=t.Envelope2D.constructEmpty();r.queryLooseEnvelope(g);const u=this.m_pannableExtent.getCenterX();let c=0,p=u-this.m_width360,d=u+this.m_width360;if(h>=0){let e=Math.ceil((p-g.xmin)/this.m_width360);for(e*=this.m_width360;p>g.xmin+e;)e+=this.m_width360;for(;p<g.xmax+e;)e-=this.m_width360;for(c=e,g.width()>720&&(d=p+360*Math.ceil(g.width()/360));d<g.xmax;)d+=this.m_width360}else{let e=Math.ceil((d-g.xmax)/this.m_width360);for(e*=this.m_width360;d<g.xmax+e;)e-=this.m_width360;for(;d>g.xmin+e;)e+=this.m_width360;for(c=e,g.width()>720&&(p=d-360*Math.ceil(g.width()/360));p>g.xmin;)p-=this.m_width360}const _=Math.round(Math.abs(l.x-m.x)/this.m_width360)*this.m_width360,f=h*_,y=g.clone();y.move(c,0);const x=new i.Point2D(0,0),P=new a.Transformation2D;P.setShiftCoords(c,0),r.applyTransformation(P);const E=new n.Polyline({vd:r.getDescription()});E.add(r,!1),x.assign(r.getXY(o-1));let S=0,C=E.getXY(0).x;for(;h>0?y.xmax<d:y.xmin>p;)y.move(f,0),P.xd=f,r.applyTransformation(P),C+=f,this.m_pannableExtent.xmin<=C&&this.m_pannableExtent.xmax>=C&&(S=E.getPointCount()-1),r.setXY(0,x),x.assign(r.getXY(o-1)),E.addSegmentsFromPath(r,0,0,o-1,!1);const I=new n.Polygon({vd:E.getDescription()});I.add(E,!1);const v=E.getXY(0),T=E.getXY(E.getPointCount()-1),D=h<0?e:!e,w=I.getPointCount()-1;if(D){const e=new i.Point2D(T.x,this.m_pannableExtent.ymax);I.lineTo(e);const t=new i.Point2D(this.m_pannableExtent.getCenterX(),this.m_pannableExtent.ymax);I.lineTo(t);const s=new i.Point2D(v.x,this.m_pannableExtent.ymax);I.lineTo(s)}else{const e=new i.Point2D(T.x,this.m_pannableExtent.ymin);I.lineTo(e);const t=new i.Point2D(this.m_pannableExtent.getCenterX(),this.m_pannableExtent.ymin);I.lineTo(t);const s=new i.Point2D(v.x,this.m_pannableExtent.ymin);I.lineTo(s)}if(I.interpolateAttributesPath(0,w,0),I.getImpl().changeRingStartPoint(S),_>this.m_width360){const e=new n.Polygon({copy:I});P.setShiftCoords(this.m_width360,0),e.applyTransformation(P),I.add(e,!1)}return I}finalizeGeoNormalizeClosedRing(e,r,o){const m=new n.Polygon({vd:e.getDescription()});if(m.add(e,!1),m.hasNonLinearSegments()&&(()=>{const e=m.getPointCount()-2;return m.getSegmentType(e)!==s.GeometryType.enumLine})()){const e=new n.SegmentBuffer,t=m.getPointCount()-2;m.getSegmentBuffer(t,e,!1),m.removePointFromPath(0,t+1),m.closeLastPathWithSegment(e.get())}else m.removePointFromPath(0,m.getPointCount()-1);const l=t.Envelope2D.constructEmpty();m.queryLooseEnvelope(l);let h=Math.ceil((this.m_pannableExtent.xmin-l.xmin)/this.m_width360);for(h*=this.m_width360;this.m_pannableExtent.xmin>l.xmin+h;)h+=this.m_width360;for(;this.m_pannableExtent.xmin<l.xmax+h;)h-=this.m_width360;if(h+=this.m_width360,0!==h){l.move(h,0);const e=new a.Transformation2D;e.setShiftCoords(h,0),m.applyTransformation(e)}if(this.m_pannableExtent.xmin<=l.xmin&&this.m_pannableExtent.xmax>=l.xmax){if(r){const e=m.calculateArea2D(),t=(new Xs).execute(m,this.m_pannableSR,!0,this.m_progressTracker);if(t!==m){const s=t.calculateArea2D();i.sign(e)!==i.sign(s)&&t.reverseAllPaths(),m.assignMove(t)}}let e;if(e=o?new n.Polygon({copy:m}):new n.Polygon({move:m}),o)for(;l.xmin<this.m_pannableExtent.xmax;){l.move(this.m_width360,0);const t=new a.Transformation2D;t.setShiftCoords(this.m_width360,0),m.applyTransformation(t),e.add(m,!1)}return e}let g=new n.Polygon({vd:e.getDescription()});g.add(m,!1);const u=r||l.width()>this.m_width360-10*this.m_pannableSR.getTolerance(0);for(;l.xmin<this.m_pannableExtent.xmax;){l.move(this.m_width360,0);const e=new a.Transformation2D;e.setShiftCoords(this.m_width360,0),m.applyTransformation(e),g.add(m,!1)}if(u){const e=g.calculateArea2D();g.setFillRule(1),g=(new Xs).execute(g,this.m_pannableSR,!0,this.m_progressTracker);const t=g.calculateArea2D();i.sign(e)!==i.sign(t)&&g.reverseAllPaths()}return g}geonormalize_ring_(e,t,n,r,i,o,a){s.geometryReleaseAssert(0)}}function kn(e){s.geometryReleaseAssert(0);const t=function(e){const t=new jr({},!0);return t.m_WKID=e,t}(e),n=new Mn;return n.setVertProj_(t),n}class Mn{constructor(){this.m_hashCode=0,this.m_peVertSysVal=null,this.m_verticalUnit=new yi,this.m_verticalShift=0,this.m_userVerticalWKID=0,this.m_bIsDepth=!1}getType(){return s.geometryReleaseAssert(0),0}getID(){return s.geometryReleaseAssert(0),0}getLatestID(){return this.m_peVertSysVal?this.m_peVertSysVal.getLatestID():0}getOldID(){return this.m_peVertSysVal?this.m_peVertSysVal.getOldID():0}getText(){return s.geometryReleaseAssert(0),""}getTextExtended(e){return s.geometryReleaseAssert(0),""}getText2(e){return s.geometryReleaseAssert(0),""}getUnit(){return s.geometryReleaseAssert(0),{}}equals(e){return s.geometryReleaseAssert(0),!1}equalForProjection(e){return s.geometryReleaseAssert(0),!1}getPeVertcsCopy(){return s.geometryReleaseAssert(0),{}}getOneMeter(){return 1/this.m_verticalUnit.getUnitToBaseFactor()}getUnitToBaseFactor(){return s.geometryReleaseAssert(0),0}isDepth(){return s.geometryReleaseAssert(0),!1}getVerticalShift(){return s.geometryReleaseAssert(0),0}isCustomWkid(){return!!this.m_peVertSysVal&&this.m_peVertSysVal.isCustomWkid()}getHashCode(){return this.m_hashCode}setVertProj_(e){this.m_peVertSysVal=e}getPEVerticalCoordSys(){return this.m_peVertSysVal?this.m_peVertSysVal.m_peVertcs:null}}function Un(e,t,s,r,i){if(e.equals(t))return!1;if(r){let s=1,n=0,o=1,a=1,m=0,l=1;Number.isNaN(e.m_heightMetersPerUnit)||(s=e.m_heightMetersPerUnit,n=e.m_heightZ0,o=e.m_heightSign,a=t.m_heightMetersPerUnit,m=t.m_heightZ0,l=t.m_heightSign);const h=o*l*s/a;for(let e=0;e<i;e++)r[e]=(r[e]-n)*h+m}let o=1,a=0;if(Number.isNaN(e.m_XYToRadians)||(o=e.m_XYToRadians/t.m_XYToRadians,a=e.m_PrimeMeridianDegrees-t.m_PrimeMeridianDegrees,0!==a&&(a=n.convertToRadians(a),a/=t.m_XYToRadians)),Array.isArray(s)){const e=s;for(let t=0;t<i;t++)e[t][0]=e[t][0]*o+a,e[t][1]=e[t][1]*o}else{const e=s;for(let t=0;t<i;t++){const s=t<<1;e[s]=e[s]*o+a,e[s+1]=e[s+1]*o}}return!0}function On(){return{m_heightMetersPerUnit:0,m_heightSign:0,m_heightZ0:0,m_XYToRadians:0,m_PrimeMeridianDegrees:0,assign(e){this.m_heightMetersPerUnit=e.m_heightMetersPerUnit,this.m_heightSign=e.m_heightSign,this.m_heightZ0=e.m_heightZ0,this.m_XYToRadians=e.m_XYToRadians,this.m_PrimeMeridianDegrees=e.m_PrimeMeridianDegrees},equals(e){return i.isEqualNonIEEE(this.m_heightSign,e.m_heightSign)&&i.isEqualNonIEEE(this.m_heightMetersPerUnit,e.m_heightMetersPerUnit)&&i.isEqualNonIEEE(this.m_heightZ0,e.m_heightZ0)&&i.isEqualNonIEEE(this.m_XYToRadians,e.m_XYToRadians)&&i.isEqualNonIEEE(this.m_PrimeMeridianDegrees,e.m_PrimeMeridianDegrees)},initFromGcsAndVcsPe(e,t){this.m_heightSign=1,this.m_heightMetersPerUnit=Number.NaN,this.m_heightZ0=0,this.m_XYToRadians=Number.NaN,this.m_PrimeMeridianDegrees=Number.NaN,t&&s.geometryReleaseAssert(0),e&&(this.m_XYToRadians=e.getUnit().getUnitFactor(),this.m_PrimeMeridianDegrees=e.getPrimem().getLongitude())},initFromGcsAndVcs(e,t){const s=e?e.getPECoordSys():null,n=t?t.getPEVerticalCoordSys():null;this.initFromGcsAndVcsPe(s,n)},processUnitParams(e){Number.isNaN(this.m_heightMetersPerUnit)&&(this.m_heightMetersPerUnit=e.m_heightMetersPerUnit,this.m_heightSign=e.m_heightSign,this.m_heightZ0=e.m_heightZ0),Number.isNaN(this.m_XYToRadians)&&(this.m_XYToRadians=e.m_XYToRadians,this.m_PrimeMeridianDegrees=e.m_PrimeMeridianDegrees)}}}class Bn{constructor(t){this.m_constantsLoaded=-1,this.m_isUsable=-1,this.m_inputSR=null,this.m_outputSR=null,this.m_inputSRHorz=null,this.m_outputSRHorz=null,this.m_inputVCS=null,this.m_outputVCS=null,this.m_hashCode=0,this.m_areaOfUse=new r.Envelope,this.m_inputUnitParams=On(),this.m_outputUnitParams=On(),s.geometryReleaseAssert(t),this.m_geogTran=t,this.m_vertTran=null,this.m_latestID=e.peFactory.getCode(this.m_geogTran),this.m_latestID<0&&(this.m_latestID=0);const n=this.m_geogTran.getGeogcs1();e.peFactory.getCode(n);const i=this.m_geogTran.getGeogcs2();e.peFactory.getCode(i),this.initUnitParams()}getLatestId(){return this.m_latestID}getText(){return this.m_geogTran?this.m_geogTran.toString():(s.geometryReleaseAssert(0),"")}getGeogtran(){return this.m_geogTran}getVerttran(){return null}loadConstants(t){let n=this.m_constantsLoaded;if(-1===n){if(!t){this.m_geogTran||s.throwInternalErrorException("vcs not impl");const n=this.m_geogTran.getParameters();null!==n[e.peDefs.PE_PARM_ND]&&(t=0===n[e.peDefs.PE_PARM_ND].getValue())}n=this.m_geogTran.loadConstants()?1:0,this.m_constantsLoaded=n}return 0!==n}isUsable(){let e=this.m_isUsable;return-1===e&&(this.m_geogTran?this.m_isUsable=e=this.m_geogTran?1:0:this.m_isUsable=e=this.m_vertTran?1:0),1===e}getInputSr(e){return this.updateSrs(),e?this.m_inputSR:this.m_inputSRHorz}getOutputSr(e){return this.updateSrs(),e?this.m_outputSR:this.m_outputSRHorz}getHashCode(){let e=this.m_hashCode;return 0===e&&(e=this.m_latestID>0?i.hashInt32(this.m_latestID):i.hashString(this.getText()),0===e&&(e=345),this.m_hashCode=e),e}isGeogtran(){return null!==this.m_geogTran}prepareOrThrow(){}getName(){return this.isGeogtran()?this.getGeogtran().getName():(s.throwNotImplementedException("vcs not impl"),"")}updateSrs(){if(this.m_inputSR||this.m_inputVCS)return;let e,t,n,r,i,o;if(this.m_geogTran){const s=this.m_geogTran.getGeogcs1(),a=mi(s),m=this.m_geogTran.getGeogcs2(),l=mi(m);let h=-1,g=-1;h=a.getVcsCode(),g=l.getVcsCode(),n=Ai(s,null,0,1),r=Ai(m,null,0,1),h>0&&g>0?(i=kn(h),o=kn(g),e={},t={}):(e=n,t=r)}else s.geometryReleaseAssert(0);this.m_inputSR||this.m_inputVCS||(this.m_inputSR=e,this.m_outputSR=t,this.m_inputSRHorz=n,this.m_outputSRHorz=r,this.m_inputVCS=i,this.m_outputVCS=o)}initUnitParams(){if(this.m_inputUnitParams.m_heightSign=1,this.m_inputUnitParams.m_heightMetersPerUnit=Number.NaN,this.m_inputUnitParams.m_heightZ0=0,this.m_outputUnitParams.m_heightSign=1,this.m_outputUnitParams.m_heightMetersPerUnit=Number.NaN,this.m_outputUnitParams.m_heightZ0=0,this.m_inputUnitParams.m_XYToRadians=Number.NaN,this.m_inputUnitParams.m_PrimeMeridianDegrees=Number.NaN,this.m_outputUnitParams.m_XYToRadians=Number.NaN,this.m_outputUnitParams.m_PrimeMeridianDegrees=Number.NaN,this.m_vertTran)s.geometryReleaseAssert(0);else if(this.m_geogTran){const e=this.m_geogTran;let t=e.getGeogcs1();this.m_inputUnitParams.m_XYToRadians=t.getUnit().getUnitFactor(),this.m_inputUnitParams.m_PrimeMeridianDegrees=t.getPrimem().getLongitude(),t=e.getGeogcs2(),this.m_outputUnitParams.m_XYToRadians=t.getUnit().getUnitFactor(),this.m_outputUnitParams.m_PrimeMeridianDegrees=t.getPrimem().getLongitude()}}}function qn(e,t,s,n,r,i,o){let a=null;t&&(a=t.getPEVerticalCoordSys());let m=null;e&&(m=e.getPECoordSys());let l=null;n&&(l=n.getPEVerticalCoordSys());let h=null;if(s&&(h=s.getPECoordSys()),!(m||a||h||l))return!1;const g=On();g.initFromGcsAndVcsPe(m,a);const u=On();return u.initFromGcsAndVcsPe(h,l),Un(g,u,r,i,o)}function Yn(e,t,s,n,r,i,o,a){const m=t,l=e,h=On();h.initFromGcsAndVcsPe(l,m),a.assign(n?s.m_outputUnitParams:s.m_inputUnitParams),a.processUnitParams(h),h.processUnitParams(a),o>0&&Un(h,a,r,i,o)}function Xn(e,t,s,n,r,i,o,a,m){const l=On(),h=On();l.assign(s?t.m_inputUnitParams:t.m_outputUnitParams),h.assign(r?n.m_outputUnitParams:n.m_inputUnitParams),l.processUnitParams(e),h.processUnitParams(l),l.processUnitParams(h),a>0&&Un(l,h,i,o,a),m.assign(h)}function Ln(t,s,n,r,i,o,a){const m=s.getVerttran(),l=s.getGeogtran();if(a.assign(n?s.m_inputUnitParams:s.m_outputUnitParams),a.processUnitParams(t),o>0){s.prepareOrThrow();const t=n?e.peDefs.PE_TRANSFORM_2_TO_1:e.peDefs.PE_TRANSFORM_1_TO_2;m?kr():Mr(l,o,r,i,t)}}class zn{supportsCurves(){return!0}accelerateGeometry(e,t,s){return Wn(e,t,s)}canAccelerateGeometry(e){return jn(e)}}function Wn(e,t,i){if(!jn(e))return!1;r.calculateToleranceFromGeometryForRelGeom(t,e,!1);let o=0;const a=e.getGeometryType();return s.isMultiPath(a)&&n.canUseQuadTree(e)&&0!==i&&(o|=e.getImpl().buildQuadTreeAccelerator(i)?1:0),s.isMultiPath(a)&&n.canUseQuadTreeForPaths(e)&&0!==i&&(o|=e.getImpl().buildQuadTreeForPathsAccelerator(i)?1:0),o>0}function jn(e){return n.canUseQuadTree(e)||n.canUseQuadTreeForPaths(e)}class Zn extends zn{getOperatorType(){return 8}execute(e,t,s,n){return Ze(e,t,s,1,n)}}class Qn{getOperatorType(){return 10002}supportsCurves(){return!0}accelerateGeometry(e,t,s){return!1}canAccelerateGeometry(e){return!1}executeMany(e,t,s,n){return new Kn(e,t,s,n)}execute(e,t,s,n){return this.executeMany(new h.SimpleGeometryCursor([e]),new h.SimpleGeometryCursor([t]),s,n).next()}}class Kn extends h.GeometryCursor{constructor(e,t,s,r){super(),this.m_progressTracker=r,this.m_index=-1,this.m_inputGeoms=e,this.m_spatialReference=s;const i=t.next();this.m_geomSubtractor=i||new n.Polygon}next(){const e=this.m_inputGeoms.next();return e?(s.throwIfMesh(e),s.throwIfGeometryCollection(e),this.m_index=this.m_inputGeoms.getGeometryID(),function(e,o,a,l){if(e.isEmpty()||o.isEmpty())return e;const h=e.getDimension(),g=o.getDimension();if(h>g)return e;const u=e.getGeometryType(),c=o.getGeometryType(),p=new t.Envelope2D,d=new t.Envelope2D,_=new t.Envelope2D;e.queryEnvelope(p),o.queryEnvelope(d),_.setCoords({env2D:p}),_.mergeEnvelope2D(d);const f=r.calculateToleranceFromGeometryForOp(a,_,!0),y=r.adjustToleranceForTEClustering(f),x=new t.Envelope2D;if(x.setCoords({env2D:p}),x.inflateCoords(y,y),!x.isIntersecting(d))return e;if(1===h&&2===g){const i=function(e,i,o,a,m){const l=new r.Envelope;e.queryEnvelope(l);const h=new t.Envelope2D;i.queryEnvelope(h),l.merge(h);const g=.1*l.width(),u=.1*l.height();l.inflateCoords(g,u);const c=new n.Polygon;c.addEnvelope(l,!1);const p=c.getImpl();if(o===s.GeometryType.enumPolygon){const e=i.getImpl();p.add(e,!0)}else p.addEnvelope(i,!0);return new zs(c,a,-1,m).tryFastImplementation(e)}(e,o,c,a,l);if(i)return i}if(u===s.GeometryType.enumPoint){let a;switch(s.isSegment(c)?(a=new n.Polyline({vd:o.getDescription()}),a.addSegment(o,!0)):a=o,c){case s.GeometryType.enumPolygon:return function(e,t,s){return 0===Zt(t,e,s.total())?e:e.createInstance()}(e,a,f);case s.GeometryType.enumPolyline:return function(e,s,n){const o=e.getXY(),a=s.querySegmentIterator(),m=r.adjustToleranceForTEClustering(n),l=m*m;for(;a.nextPath();)for(;a.hasNextSegment();){const s=a.nextSegment(),r=new t.Envelope2D;if(s.queryEnvelope(r),r.inflateCoords(m,m),!r.contains(o))continue;if(s.isIntersectingPoint(o,n.total()))return e.createInstance();let h=s.getStartXY();if(i.Point2D.sqrDistance(o,h)<=l)return e.createInstance();if(h=s.getEndXY(),i.Point2D.sqrDistance(o,h)<=l)return e.createInstance()}return e}(e,a,f);case s.GeometryType.enumMultiPoint:return function(e,t,s){const n=t.getImpl().getAttributeStreamRef(0),o=t.getPointCount(),a=e.getXY(),m=r.adjustToleranceForTEClustering(s),l=m*m,h=new i.Point2D;for(let t=0;t<o;t++)if(n.queryPoint2D(2*t,h),i.Point2D.sqrDistance(h,a)<=l)return e.createInstance();return e}(e,a,f);case s.GeometryType.enumEnvelope:return function(e,s,n){const r=new t.Envelope2D;s.queryEnvelope(r),r.inflate(n.total());const i=e.getXY();return r.contains(i)?e.createInstance():e}(e,a,f);case s.GeometryType.enumPoint:return function(e,t,s){const n=r.adjustToleranceForTEClustering(s),o=n*n,a=e.getXY(),m=t.getXY();return i.Point2D.sqrDistance(a,m)<=o?e.createInstance():e}(e,a,f);default:s.throwInvalidArgumentException("invalid shape type")}}else if(u===s.GeometryType.enumMultiPoint)switch(c){case s.GeometryType.enumPolygon:return function(e,s,n){const r=new t.Envelope2D;s.queryEnvelope(r),r.inflate(n.total());const o=e.getPointCount();let a=!1;const m=i.makePrimitiveArray(o,!1),l=new i.Point2D;for(let t=0;t<o;t++)e.queryXY(t,l),r.contains(l)&&0!==Qt(s,l,n.total())&&(a=!0,m[t]=!0);if(!a)return e;const h=e.createInstance();for(let t=0;t<o;t++)m[t]||h.addPoints(e,t,t+1);return h}(e,o,f);case s.GeometryType.enumEnvelope:return function(e,s,n){const r=new t.Envelope2D;s.queryEnvelope(r),r.inflate(n.total());const o=e.getPointCount();let a=!1;const m=i.makePrimitiveArray(o,!1),l=new i.Point2D;for(let t=0;t<o;t++)e.queryXY(t,l),r.contains(l)&&(a=!0,m[t]=!0);if(!a)return e;const h=e.createInstance();for(let t=0;t<o;t++)m[t]||h.addPoints(e,t,t+1);return h}(e,o,f);case s.GeometryType.enumPoint:return function(e,t,s){const n=e.getImpl().getAttributeStreamRef(0),o=e.getPointCount(),a=t.getXY();let m=!1;const l=i.makePrimitiveArray(o,!1),h=r.adjustToleranceForTEClustering(s),g=h*h,u=new i.Point2D;for(let e=0;e<o;e++)n.queryPoint2D(2*e,u),i.Point2D.sqrDistance(u,a)<=g&&(m=!0,l[e]=!0);if(!m)return e;const c=e.createInstance();for(let t=0;t<o;t++)l[t]||c.addPoints(e,t,t+1);return c}(e,o,f)}const P=new t.Envelope2D(p);return P.inflate(100*f.total()),function(e,i,o,a){if(e.isEmpty()||i.isEmpty()||e.getDimension()>i.getDimension())return ws(bs(e),e,0,"-");const m=new t.Envelope2D;e.queryEnvelope(m);const l=new t.Envelope2D;i.queryEnvelope(l);const h=new t.Envelope2D;h.setCoords({env2D:m}),h.mergeEnvelope2D(l);const g=r.calculateToleranceFromGeometryForOp(o,h,!0),u=l.clone(),c=r.adjustToleranceForTEClustering(g);if(u.inflateCoords(c,c),!m.isIntersecting(u))return ws(bs(e),e,0,"-");const p=new Ds(a),d=new n.EditShape,_=d.addGeometry(bs(e)),f=d.addGeometry(bs(i));let y=0,x=0,P=null;if(d.hasCurves()){P=new ms;const e=d.getEnvelope2D(a);x=os(g.total());const t=is(g.total(),e);y=as(t,x),ss(d,t,g.total(),0,P,null,a)}p.setEditShapeCrackAndCluster(d,g.add(y));const E=p.difference(_,f);null!==P&&P.stitchCurves(d,E,x,!0);const S=ws(d.getGeometry(E),e,0,"-");return ys(S.getGeometryType())&&(S.getImpl().setIsSimple(4,g.total()),S.getGeometryType()===s.GeometryType.enumPolygon&&S.getImpl().updateOGCFlagsProtected()),S}(e,m.clip$1(o,P,0,0,l),a,l)}(e,this.m_geomSubtractor,this.m_spatialReference,this.m_progressTracker)):null}getGeometryID(){return this.m_index}tock(){return!0}getRank(){return 1}}class $n{getOperatorType(){return 10001}supportsCurves(){return!0}accelerateGeometry(e,t,s){return!1}canAccelerateGeometry(e){return!1}executeMany(e,t,s,n=0){return new er(e,t,s,n)}execute(e,t,n,r){const i=new h.SimpleGeometryCursor([e,t]),o=new er(i,n,r,0).next();return o||s.throwInternalErrorException("null output"),o}}class Jn{constructor(){this.binVertexCount=0,this.geometries=[]}addPair(e){this.binVertexCount+=e.vertexCount,this.geometries.push(e)}sort(){this.geometries.sort((e,t)=>function(e,t){return i.Point2D.compareZorder(e.location,t.location)?-1:e.location.equals(t.location)?0:1}(e,t))}geomCount(){return this.geometries.length}geomPairs(){return this.geometries}clear(){this.binVertexCount=0,this.geometries.length=0}getBinVertexCount(){return this.binVertexCount}}class er extends h.GeometryCursor{constructor(e,t,s,n,r=!1){super(),this.m_index=-1,this.m_currentDim=-1,this.m_bDone=!1,this.m_unionBins=[],this.m_readyGeoms=i.makeNullArray(4),this.m_dimGeomCounts=i.makePrimitiveArray(4,0),this.m_addedGeoms=0,this.m_maxDimension=-1,this.m_bHadGeometry=i.makePrimitiveArray(4,!1),this.m_complexUnionGeoms=i.makeNullArray(4),this.m_totalNonEmptyGeomCounters=i.makePrimitiveArray(4,0),this.m_progressTracker=s,this.m_bUnionAllDimensions=!!(4&n),this.m_bPreserveAllPathEnds=!!(8&n),this.m_inputGeoms=e,this.m_spatialReference=t,this.m_options=n,this.m_bIs3D=r}next(){if(this.m_bDone&&this.m_currentDim===this.m_maxDimension)return null;for(;!this.step_(););if(-1===this.m_maxDimension)return null;if(this.m_bUnionAllDimensions){if(-1===this.m_currentDim)for(let e=0;e<=this.m_maxDimension;e++)if(this.m_bHadGeometry[e]){this.m_complexUnionGeoms[e]=this.getResultGeometry(e);for(let t=e+1;t<=this.m_maxDimension;t++)this.m_complexUnionGeoms[t]=this.getResultGeometry(t),this.m_bHadGeometry[t]&&!this.m_complexUnionGeoms[t].isEmpty()&&(this.m_bIs3D?s.geometryReleaseAssert(0):this.m_complexUnionGeoms[e]=(new Qn).execute(this.m_complexUnionGeoms[e],this.m_complexUnionGeoms[t],this.m_spatialReference,this.m_progressTracker))}for(;this.m_currentDim++,(this.m_currentDim>this.m_maxDimension||this.m_currentDim<0)&&s.throwInternalErrorException(""),!this.m_bHadGeometry[this.m_currentDim];);if(this.m_index++,0===this.m_currentDim&&this.m_complexUnionGeoms[this.m_currentDim].getGeometryType()===s.GeometryType.enumPoint){const e=new n.MultiPoint({vd:this.m_complexUnionGeoms[this.m_currentDim].getDescription()});return this.m_complexUnionGeoms[this.m_currentDim].isEmpty()||e.add(this.m_complexUnionGeoms[this.m_currentDim]),e}return this.m_complexUnionGeoms[this.m_currentDim]}return this.m_index=0,this.m_currentDim=this.m_maxDimension,this.getResultGeometry(this.m_maxDimension)}getGeometryID(){return this.m_index}getRank(){return 1}tock(){return this.step_()}getResultGeometry(e){return this.m_readyGeoms[e]}finishDim(e,t,i){let o=t;if(!i)return 16&this.m_options?(o=vs([o],1,this.m_spatialReference,this.m_progressTracker,this.m_options,this.m_bIs3D),o):o;if(1&this.m_options)return o;if(1===e)if(8&this.m_options||!(16&this.m_options||this.m_totalNonEmptyGeomCounters[e]>1))1===this.m_totalNonEmptyGeomCounters[e]&&(this.m_bIs3D?s.geometryReleaseAssert(0):o=(new Xs).execute(o,this.m_spatialReference,!1,this.m_progressTracker));else{o=vs([o],1,this.m_spatialReference,this.m_progressTracker,16|this.m_options,this.m_bIs3D);const e=[0],t=o.getImpl().getIsSimple(0,e);s.geometryReleaseAssert(this.m_bIs3D||r.isAtLeastPlanarSimple(t))}else this.m_bIs3D?s.geometryReleaseAssert(0):o=(new Xs).execute(o,this.m_spatialReference,!1,this.m_progressTracker);if(0===e&&o.getGeometryType()===s.GeometryType.enumPoint){const e=new n.MultiPoint({vd:o.getDescription()});o.isEmpty()||e.add(o),o=e}return o}static getLevel(e){const t=s.vertexCount(e);let n=t>0?(Math.log(t)-Math.log(32))/Math.log(4):0;return n<0&&(n=0),Math.floor(n)}step_(){if(this.m_bDone)return!0;let e;if(this.m_inputGeoms?(e=this.m_inputGeoms.next(),null===e?(this.m_bDone=!0,this.m_inputGeoms=null):(this.checkAndThrow(e),e.isEmpty()||this.m_totalNonEmptyGeomCounters[e.getDimension()]++)):e=null,null!==e){const t=e.getDimension();this.m_bHadGeometry[t]=!0,(t>=this.m_maxDimension||this.m_bUnionAllDimensions)&&(this.addGeom(t,!1,e),t>this.m_maxDimension&&!this.m_bUnionAllDimensions&&this.removeAllBinsWithLowerDimension(t))}if(this.m_addedGeoms>0)for(let e=0;e<=this.m_maxDimension;e++){for(;this.m_dimGeomCounts[e]>1;){const t=this.collectGeometriesToUnion(e);if(null===t)break;{let s;s=1&this.m_options?vs(t,t.length,this.m_spatialReference,this.m_progressTracker,this.m_options,this.m_bIs3D):Ts(t,t.length,this.m_spatialReference,this.m_progressTracker,8|this.m_options,this.m_bIs3D),this.addGeom(e,!0,s)}}if(this.m_bDone&&(s.geometryReleaseAssert(this.m_dimGeomCounts[e]<=1),0!==this.m_dimGeomCounts[e])){const t=this.m_unionBins[e].entries().next().value,s=t[1].geomPairs()[0].geom,n=t[1].geomPairs()[0].bUnioned;this.m_unionBins[e].clear(),this.m_readyGeoms[e]=this.finishDim(e,s,n)}}return this.m_bDone}addGeom(e,n,r){const o={geom:null,vertexCount:-1,bUnioned:!1,location:new i.Point2D};o.geom=r;const a=s.vertexCount(r);o.vertexCount=a;const m=t.Envelope2D.constructEmpty();r.queryEnvelope(m),o.location=a>0?m.getCenter():new i.Point2D(0,0);const l=er.getLevel(r);if(e+1>this.m_unionBins.length)for(;this.m_unionBins.length<Math.max(2,e+1);)this.m_unionBins.push(new Map);let h=null;const g=this.m_unionBins[e].get(l);g&&(h=g),null===h&&(h=new Jn,this.m_unionBins[e].set(l,h)),o.bUnioned=n,h.addPair(o),this.m_dimGeomCounts[e]++,this.m_addedGeoms++,this.m_maxDimension=Math.max(this.m_maxDimension,e)}removeAllBinsWithLowerDimension(e){for(let t=0;t<e;t++)this.m_unionBins[t].clear(),this.m_addedGeoms-=this.m_dimGeomCounts[t],this.m_dimGeomCounts[t]=0}collectGeometriesToUnion(e){if(1&this.m_options&&!this.m_bDone)return null;let t=null;const s=[];for(const t of this.m_unionBins[e].keys())s.push(t);i.numericSort(s);for(let n=0;n<s.length;n++){if(-1===s[n])continue;const r=this.m_unionBins[e].get(s[n]);{const i=5e3,o=4,a=r.getBinVertexCount()>i&&r.geomCount()>=o;if(this.m_bDone||a){for(let r=0;r<n;r++){if(-1===s[r])continue;const n=this.m_unionBins[e].get(s[r]);n.sort(),this.m_dimGeomCounts[e]-=n.geomCount(),this.m_addedGeoms-=n.geomCount();for(const e of n.geomPairs())t||(t=new Array),t.push(e.geom);n.clear(),this.m_unionBins[e].delete(s[r]),s[r]=-1}r.sort(),this.m_dimGeomCounts[e]-=r.geomCount(),this.m_addedGeoms-=r.geomCount();for(const e of r.geomPairs())t||(t=new Array),t.push(e.geom);if(r.clear(),this.m_unionBins[e].delete(s[n]),s[n]=-1,!this.m_bDone)break}}}return t}checkAndThrow(e){this.m_bIs3D&&(e.getDimension()>1&&s.throwInvalidGeometryTypeFor3DOps(),e.hasAttribute(1)||s.throwInvalidArgumentException("Geometry must have Zs")),s.throwIfMesh(e)}}class tr extends zn{getOperatorType(){return 3}execute(e,t,s,n=null){return Ze(e,t,s,4,n)}}function sr(e,o,m){const l=o.getGCSSplitLines();if(null===l)return e;const h=o.getGCS(),g=h.getPannableExtent().width(),u=t.Envelope2D.constructEmpty();e.queryLooseEnvelope(u);const c=i.Envelope1D.constructEmpty();u.queryIntervalX(c);const p=l.querySegmentIterator();let d=null;const _=new a.Transformation2D;for(;p.nextPath();)for(;p.hasNextSegment();){const e=p.nextSegment(),t=e.queryInterval(0,0),s=i.Envelope1D.constructEmpty();s.setCoordsFromEnvelope(t);let r=0;for(;s.vmax>c.vmin;)s.move(-g),r--;for(;s.vmin<=c.vmax;){if(s.isIntersecting(c)){null===d&&(d=new n.Polyline);const t=new n.Line({start:e.getStartXY(),end:e.getEndXY()});0!==r&&(_.setShiftCoords(r*g,0),t.applyTransformation(_)),d.addSegment(t,!0)}s.move(g),++r}}if(null!==d){const t=r.calculateToleranceFromGeometryForOpFromGeom(h,d,!0);return function(e,t,n,r){const i=t.getGeometryType();if(s.isMultiPath(i))return new Se(r).crackAWithBMultiPath_(e,t,n);s.throwNotImplementedException("crack_A_with_B")}(e,d,r.adjustToleranceForTEClustering(t),m)}return e}function nr(t,s,n){let r=t.getName();return Xi(r)||(n||s>0?(r=t.toString(e.peDefs.PE_STR_NAME_CANON|e.peDefs.PE_STR_AUTH_NONE),r=r.toLocaleUpperCase("en-US")):r=t.toString(e.peDefs.PE_STR_AUTH_TOP)),r}function rr(t,n=-1){if((n>1||n<-1)&&s.throwInvalidArgumentException("verbosity"),-1===n)return t.toString();{const s=0===n?e.peDefs.PE_STR_AUTH_TOP:e.peDefs.PE_STR_AUTH_ALL;return t.toString(s)}}function ir(e,n,i,o){if(e.isEmpty()||1===i)return e;const l=e.getGeometryType();if(l===s.GeometryType.enumPoint){const t=e,s=t.getXY();return 0===mr([s],1,n,i)||s.isNAN()?t.setEmpty():t.setXY(s),e}if(l===s.GeometryType.enumMultiPoint){const t=e,s=e.createInstance(),o=t.getPointCount();s.reserve(o);const a=t.getAttributeStreamRef(0),m=t.getDescription().getAttributeCount()>1,l=new r.Point,h=Float64Array.from(a.getArray());if(mr(h,o,n,i)>0)for(let e=0,n=2*o;e<n;e+=2)Number.isNaN(h[e])||(m?(t.getPointByVal(e>>1,l),l.setXYCoords(h[e],h[e+1]),s.add(l)):s.addXY(h[e],h[e+1]));return s}let h=e;const g=n.getOneDegreeGCSUnit(),u=90*g,c=180*g,p=360*g,d=n.getCentralMeridian(),_=.5*g,f=t.Envelope2D.constructEmpty();h.queryEnvelope(f);const y=n.getGCSHorizon(),x=n.getGCSHorisonIsInclusive(),P=y.getGeometryType()===s.GeometryType.enumEnvelope,E=t.Envelope2D.constructEmpty();y.queryEnvelope(E);const S=n.getGCS();if(2!==i&&4!==i||(E.xmin=d-c,E.xmax=E.xmin+p),4===i){if(!(f.width()>p-g)){const e=t.Envelope2D.constructEmpty();e.setCoords({xmin:f.xmin-g,ymin:E.ymin,xmax:f.xmax+g,ymax:E.ymax}),h=(new m.OperatorClip).execute(h,e,S,o);let s=Math.floor((d-f.getCenterX())/p);for(f.move(s*p,0);f.xmin>E.xmax;)s-=1,f.move(-p,0);for(;f.xmin<E.xmin;)s+=1,f.move(p,0);if(0!==s){const e=new a.Transformation2D;e.setShiftCoords(s*p,0),h.applyTransformation(e)}return h}i=2}if(2===i&&(E.xmin=d-c,E.xmax=E.xmin+p),f.ymin<-u||f.ymax>u){const e=t.Envelope2D.constructEmpty();if(e.setCoords({xmin:f.xmin-g,ymin:-u,xmax:f.xmax+g,ymax:u}),h=(new m.OperatorClip).execute(h,e,S,o),h.isEmpty())return h;h.queryEnvelope(f)}if(x&&(E.ymax<f.ymin||E.ymin>f.ymax))return h.createInstance();f.width()>p&&(h=yr(h,d-c,p,S,!0,0,!0,o),h.queryEnvelope(f));let C=(I=f.xmin,v=f.xmax,T=E.xmin,D=E.xmax,I>=T&&v<=D?0:fr(.5*(v+I),T,D,p));var I,v,T,D;if(0!==C&&f.move(C,0),f.xmax>E.xmax||f.xmin<E.xmin){if(f.xmax>E.xmax)for(;f.xmin>=E.xmax;)f.move(-p,0),C-=p;for(;f.xmin<E.xmax-p;)f.move(p,0),C+=p}const w=r.calculateToleranceFromGeometryForRelGeom(S,y,!1);if(0!==C){const e=new a.Transformation2D;e.setShiftCoords(C,0),h.applyTransformation(e),C=0}if(x){if(P&&E.containsEnvelope(f))return h;const e=new Array(2);for(let t=0;t<2;t++){let n;if(P?n=s.isMultiPath(l)?m.clip$1(h,E,w,_,o):m.clip$1(h,E,w,0,o):(n=(new js).execute(h,y,S,o),n===y&&(n=n.clone())),E.xmin<=f.xmin&&E.xmax>=f.xmax)return n;if(E.xmin>=f.xmin&&E.xmax<=f.xmax)return n;if(e[t]=n,0===t){f.move(-p,0);const e=new a.Transformation2D;e.setShiftCoords(-p,0),h.applyTransformation(e)}}return s.isMultiPath(l)?e[0].add(e[1],!1):s.throwInternalErrorException("intersect_with_GCS_horizon: unexpected geometry type"),e[0]}{if(E.ymax<f.ymin||E.ymin>f.ymax)return h;let e=0;for(;!h.isEmpty()&&f.xmax>E.xmin;){if(0!==e){const t=new a.Transformation2D;t.setShiftCoords(e,0),h.applyTransformation(t)}if((new tr).execute(h,y,S,o)||(h=(new Qn).execute(h,y,S,o),y===h&&(h=h.clone())),0!==e){const t=new a.Transformation2D;t.setShiftCoords(-e,0),h.applyTransformation(t)}e-=p,f.move(-p,0)}return h}}function or(t,s,a,m,l,h){const g={stack:[],error:void 0,hasError:!1};try{if(2===h)return function(e,t,s,o,a){if(Math.abs(s.x-o.x)>Math.PI)return Number.NaN;if(Math.abs(s.y)>i.geometryHalfPi||Math.abs(o.y)>i.geometryHalfPi)return Number.NaN;if((Math.abs(s.y)===i.geometryHalfPi||Math.abs(o.y)===i.geometryHalfPi)&&s.x!==o.x)return Number.NaN;const{first:m,second:l}=i.minMax(s.x,o.x);let h=a;if(h=P(h,m,l),!i.Envelope1D.construct(s.x,o.x).containsCoordinate(h))return Number.NaN;const g=n.EPoint2D.constructPoint2D(s),u=n.EPoint2D.constructPoint2D(o),c=C(1,t,g),p=C(1,t,u),d=c.crossProductVector(p);if(d.z.isZero())return s.y;const _=d.x.divE(d.z.negate()),f=d.y.divE(d.z.negate()),y=_.mulE(_).addE(f.mulE(f)).sqrt();if(y.isZero()||_.isZero()&&f.isZero())return s.y;const x=Math.atan2(f.value(),_.value());let S=Math.atan2(y.value()*Math.cos(x-h),1-t);const I=E(1,t,i.Point2D.construct(h,S)),v=r.Point3D.construct(I.x,I.y,-I.z),T=d.value().dotProduct(I),D=d.value().dotProduct(v);return Math.abs(D)<Math.abs(T)&&(S=-S),S}(0,s,a,m,l);if(Math.abs(a.x-m.x)>=Math.PI||!Yr(a.x,m.x,l))return Number.NaN;a.x>m.x&&(m=i.swap(a,a=m));const u=o.__addDisposableResource(g,new e.PeDoubleClass,!1),c=o.__addDisposableResource(g,new e.PeDoubleClass,!1),p=o.__addDisposableResource(g,new e.PeDoubleClass,!1),d=a.clone();e.peLineType.geodeticDistance(t,s,a.x,a.y,m.x,m.y,c,u,null,h);const _=c.val;let f=0,y=1;for(;_*(y-f)>1e-12*t;){const n=.5*(f+y);if(e.peLineType.geodeticCoordinate(t,s,a.x,a.y,_*n,u.val,c,p,h),d.x=c.val,d.y=p.val,d.x===l)return d.y;if(Yr(a.x,d.x,l))y=n;else{if(!Yr(m.x,d.x,l))return Number.NaN;f=n}}return d.y}catch(e){g.error=e,g.hasError=!0}finally{o.__disposeResources(g)}}function ar(e,t,s,n){for(let r=0,i=0;r<n;r++,i+=2)t[s+r].x=e[i],t[s+r].y=e[i+1]}function mr(e,n,o,a){if(0===n||1===a)return n;const m=function(e,t){let s;if(Array.isArray(e)){const n=e;s=new Float64Array(2*t);for(let e=0,r=0;e<t;e++,r+=2)s[r]=n[e].x,s[r+1]=n[e].y}else s=e;return s}(e,n);if(2===a){const t=o.getPannableExtentInGCS();let s=n;for(let e=0,r=2*n;e<r;e+=2)(m[e+1]>t.ymax||m[e+1]<t.ymin)&&(m[e]=Number.NaN,s--);return s?(xr(m,n,t.xmin,t.width(),!0),e!==m&&ar(m,e,0,n),s):0}const l=o.getOneDegreeGCSUnit(),h=90*l,g=180*l,u=360*l;let c=n;for(let e=0,t=2*n;e<t;e+=2)(m[e+1]>h||m[e+1]<-h)&&(m[e]=Number.NaN,c--);if(!c)return 0;const p=t.Envelope2D.constructEmpty();p.setFromPoints(m,n);const d=o.getGCSHorizon(),_=o.getGCSHorisonIsInclusive(),f=d.getGeometryType()===s.GeometryType.enumEnvelope,y=t.Envelope2D.constructEmpty();if(d.queryEnvelope(y),_&&(y.ymax<p.ymin||y.ymin>p.ymax))return 0;if(_)if(xr(m,n,y.getCenterX()-g,u,!0),c=n,f)for(let e=0,t=2*n;e<t;e+=2)y.containsCoords(m[e],m[e+1])||(m[e]=Number.NaN,c--);else{const e=r.calculateToleranceFromGeometryForRelGeom(o.getGCS(),d,!1),t=new i.Point2D;for(let s=0,r=2*n;s<r;s+=2)t.setCoords(m[s],m[s+1]),0!==Qt(d,t,e)||(m[s]=Number.NaN,c--)}else{xr(m,n,-g,u,!0),c=n;const e=r.calculateToleranceFromGeometryForRelGeom(o.getGCS(),d,!1),t=new i.Point2D;for(let s=0,r=2*n;s<r;s+=2){t.setCoords(m[s],m[s+1]),t.isNAN()&&c--;const n=fr(t.x,y.xmin,y.xmax,u);t.x+=n,0!==Qt(d,t,e)&&(m[s]=Number.NaN,c--)}}return c>0&&Array.isArray(e)&&ar(m,e,0,n),c}function lr(e,t,n,r,i,o){if(t.isPannable()||s.throwInvalidArgumentException("fold_into_360_degree_range"),e.isEmpty())return e;let a,m;if(2===t.getCoordinateSystemType()){const e=t.getPannableExtent();m=e.xmin,a=e.width()}else{const e=t.getOneDegreeGCSUnit();a=360*e,m=n-180*e}return yr(e,m,a,t,r,i,!0,o)}function hr(e,t,s,n){let r,i;if(2===s.getCoordinateSystemType()){const e=s.getPannableExtent();r=e.xmin,i=e.width()}else{const e=s.getOneDegreeGCSUnit();i=360*e,r=n-180*e}xr(e,t,r,i)}function gr(e,t){const s=t.width();let n=i.fmod(e-t.vmin,s);return n<0&&(n+=s),t.snapClip(n+t.vmin)}function ur(e,t,s){return e>t.xmax&&e-t.xmax<s?t.xmax:e<t.xmin&&t.xmin-e<s?t.xmin:e}function cr(e,t,s){if(e[0]<t.vmin||e[0]>t.vmax||s&&e[0]===t.vmax){const s=t.width();return e[0]+=Math.ceil((t.vmin-e[0])/s)*s,e[0]=t.snapClip(e[0]),!0}return!1}function pr(e,t,s,i,o){const a=new n.EditShape,m=a.addGeometry(e);return dr(a,m,t,r.calculateToleranceFromGeometryForRelGeom(t,e,!1),s,i,o),a.getGeometry(m)}function dr(t,r,a,m,l,h,g){const u={stack:[],error:void 0,hasError:!1};try{s.geometryReleaseAssert(wi()),a.isPannable()||s.throwInvalidCallException("insert_geodetic_points");const c=a.getPannableExtent(),p=a.getGCS(),d=Ti();p.querySpheroidData(d);const _=p.getUnit().getUnitToBaseFactor(),f=d.majorSemiAxis,y=d.e2;let x=0;const P=new i.Envelope1D;c.queryIntervalX(P);let E=null;const S=i.makePrimitiveArray(4,Number.NaN);2===a.getCoordinateSystemType()?(E=a.getPECoordSys(),h?(S[0]=gr(g,P),S[1]=c.getCenterY(),e.peCSTransformations.projToGeog(E,1,S),x=S[0]*_):(S[0]=c.getCenterX(),S[1]=g,e.peCSTransformations.projToGeog(E,1,S),x=S[1]*_)):x=g*_,h||0===x||2===l||s.throwInvalidCallException("insert_geodetic_points: 1");const C=o.__addDisposableResource(u,new e.PeDoubleClass,!1),I=new i.Point2D,v=new i.Point2D,T=new i.Point2D,D=new i.Point2D,w=new i.Point2D,G=new i.Point2D;for(let s=t.getFirstPath(r);s!==n.nullHandle;s=t.getNextPath(s)){const r=t.getFirstVertex(s);t.queryXY(r,T);let o=!1;const u=t.getNextVertex(r);for(let s=u;s!==n.nullHandle;s=t.getNextVertex(s)){if(s===u){if(o)break;o=!0}if(t.queryXY(s,D),h&&(m<g-T.x&&D.x-g>m||m<g-D.x&&T.x-g>m)||!h&&(0!==g||m<-T.y&&D.y>m||m<-D.y&&T.y>m))do{if(Math.abs(T.x-D.x)>=.5*P.width())break;2===a.getCoordinateSystemType()?(S[0]=gr(T.x,P),S[1]=T.y,S[2]=gr(D.x,P),S[3]=D.y,br(E,2,S,0),w.x=S[0]*_,w.y=S[1]*_,G.y=S[3]*_):(w.x=T.x*_,w.y=T.y*_,G.y=D.y*_),G.x=(D.x-T.x)*Math.PI*2/P.width()+w.x;let n=0;const r=i.makeObjectArray(i.Point2D,2);if(h){if(v.x=x,v.y=or(f,y,w,G,x,l),Number.isNaN(v.y))break;r[0]=v,n=1}else if(2===l){const e=[0,0];if(n=b(0,y,w,G,x,e),!n)break;r[0].x=e[0],r[0].y=x,2===n&&(r[1].x=e[1],r[1].y=x)}else{if(v.x=Xr(f,y,w,G,l),Number.isNaN(v.x))break;v.y=0,r[0]=v,n=1}let o=-1;for(let m=0;m<n;m++){e.peLineType.geodeticDistance(f,y,w.x,w.y,G.x,G.y,C,null,null,l);const n=C.val;e.peLineType.geodeticDistance(f,y,w.x,w.y,r[m].x,r[m].y,C,null,null,l);const u=C.val;2===a.getCoordinateSystemType()?(S[0]=r[m].x/_,S[1]=r[m].y/_,e.peCSTransformations.geogToProj(E,1,S),h?(I.y=S[1],I.x=g):(I.x=Lr(S[0],T.x,D.x,P),I.y=g)):h?(I.x=g,I.y=r[m].y/_):(I.x=Lr(r[m].x/_,T.x,D.x,P),I.y=g);const c=n>0?i.snap(u/n,0,1):.5;if(0===c||1===c)continue;if(o>c)continue;const p=t.getPrevVertex(s);t.splitSegment(p,[c],1);const d=t.getNextVertex(p);t.setXYCoords(d,I.x,I.y),o=c}}while(0);T.setCoordsPoint2D(D)}}}catch(e){u.error=e,u.hasError=!0}finally{o.__disposeResources(u)}}function _r(e,n){s.geometryReleaseAssert(n.isPannable());const i=n.getPannableExtent();if(e.getGeometryType()===s.GeometryType.enumPoint){const t=e.getY();return i.ymin<=t&&t<=i.ymax?e:e.createInstance()}const o=t.Envelope2D.constructEmpty();e.queryEnvelope(o);const a=t.Envelope2D.constructEmpty();a.setCoords({env2D:i}),a.xmin=o.xmin,a.xmax=o.xmax,a.inflateCoords(.01*a.height(),0);const l=r.calculateToleranceFromGeometryForRel(n,o,!1);let h;return h=a.containsEnvelope(o)?e:m.clip$1(e,a,l,0,null),h}function fr(e,t,s,n){const r=.5*(s+t);return i.round((r-e)/n)*n}function yr(e,r,o,l,h,g,u,c){const p=e.getGeometryType(),d=i.Envelope1D.constructEmpty();d.setCoords(r,r+o);const _=[0];if(p===s.GeometryType.enumPoint){const t=e;if(_[0]=t.getX(),cr(_,d,u)){const t=h?e:e.clone();return t.setX(_[0]),t}return e}const f=t.Envelope2D.constructEmpty();if(e.queryEnvelope(f),f.isEmpty())return e;if(p===s.GeometryType.enumMultiPoint){const t=h?e:e.clone(),s=t.getImpl(),n=s.getAttributeStreamRef(0),r=2*s.getPointCount();let i=!1;for(let e=0;e<r;e+=2)_[0]=n.read(e),cr(_,d,u)&&(n.write(e,_[0]),i=!0);return i&&s.notifyModifiedFlags(2001),t}const y=i.Envelope1D.constructEmpty();if(f.queryIntervalX(y),d.contains(y))return d.vmax,y.vmax,e;const x=t.Envelope2D.constructEmpty();if(x.setCoords({env2D:f}),0===y.width()){let t=y.vmin;t+=Math.ceil((d.vmin-t)/o)*o,t=d.snapClip(t);const s=h?e:e.clone();return s.setAttributeBasic(0,0,t),s}if(p===s.GeometryType.enumEnvelope){const t=h?e:e.clone();return f.intersect(x),t.setEnvelope(f),t}const P=.1*Math.max(f.height(),f.width())*1;x.inflateCoords(0,P);let E=e;const S=l.getTolerance(0),C=new a.Transformation2D;for(;;){const e=Math.floor((y.vmin-r)/o),t=Math.ceil((y.vmax-r)/o);if(!(t-e>3))break;{const n=Math.floor(.5*(t+e));x.xmin=f.xmin-P,x.xmax=r+o*n;const i=m.clip$1(E,x,S,g,c);x.xmin=x.xmax,x.xmax=f.xmax+P;const a=m.clip$1(E,x,S,g,c);C.setShiftCoords((n-t)*o,0),a.applyTransformation(C),p===s.GeometryType.enumPolygon?E=(new $n).execute(i,a,l,c):(E=i,E.add(a,!1)),E.queryEnvelope(f),f.queryIntervalX(y)}}x.xmin=r,x.xmax=r+o;const I=t.Envelope2D.constructEmpty();I.setCoords({env2D:x}),I.inflateCoords(S,0);const v=Math.floor((f.xmin-x.xmin)/o)*o;let T;v?(x.move(v,0),C.setShiftCoords(-v,0)):C.setIdentity(),T=p===s.GeometryType.enumPolyline?new n.Polyline({vd:E.getDescription()}):new n.Polygon({vd:E.getDescription()});const D=t.Envelope2D.constructEmpty(),w=t.Envelope2D.constructEmpty();for(;f.xmax>x.xmin;){const e=m.clip$1(E,x,S,0,c);e.queryEnvelope(w);let t=!1;t=p===s.GeometryType.enumPolyline?!e.isEmpty()&&(w.width()>S||w.height()>S):!e.isEmpty()&&(p!==s.GeometryType.enumPolygon||w.width()>S),t&&(e.applyTransformation(C),e.queryEnvelope(w),T.queryEnvelope(D),D.inflateCoords(S,S),D.isIntersecting(w)&&p===s.GeometryType.enumPolygon?T=(new $n).execute(T,e,l,c):T.add(e,!1)),x.move(o,0),C.shiftCoords(-o,0)}return T}function xr(e,t,s,n,r=!0){const o=new i.Envelope1D;o.setCoords(s,s+n);const a=[0];if(Array.isArray(e)){const s=e;for(let e=0;e<t;e++)o.containsRightExclusive(s[e].x)||(a[0]=s[e].x,cr(a,o,r),s[e].x=a[0])}else{const s=e;for(let e=0;e<t;e++){const t=e<<1;o.containsRightExclusive(s[t])||(a[0]=s[t],cr(a,o,r),s[t]=a[0])}}}function Pr(e,n,r,i=!0){if(e.isEmpty())return;const o=e.getGeometryType();if(!i||o!==s.GeometryType.enumPolygon)if(s.isMultiVertex(o)){let t=!1;if(s.isMultiPath(o)&&e.hasNonLinearSegments()){const i=e.getImpl(),o=i.getAttributeStreamRef(0),a=i.getSegmentFlagsStreamRef();s.geometryReleaseAssert(null!==a);for(let e=0,s=i.getPathCount();e<s;e++){let s=!0;const m=i.isClosedPath(e),l=i.getPathEnd(e);m&&i.getPathSize(e)>0&&(s=1==(31&a.read(l-1)));for(let m=i.getPathStart(e);m<l;m++)if(1==(31&a.read(m))){if(s){const e=o.read(2*m),s=ur(e,n,r);s!==e&&(t=!0,o.write(2*m,s))}s=!0}else s=!1}}else{const s=e.getImpl(),i=s.getAttributeStreamRef(0);for(let e=0,o=s.getPointCount();e<o;e++){const s=i.read(2*e),o=ur(s,n,r);o!==s&&(t=!0,i.write(2*e,o))}}t&&e.getImpl().notifyModifiedFlags(2001)}else if(o===s.GeometryType.enumEnvelope){const s=e,i=t.Envelope2D.constructEmpty();s.queryEnvelope(i),i.xmin=ur(i.xmin,n,r),i.xmax=ur(i.xmax,n,r),s.setEnvelope(i)}else if(o===s.GeometryType.enumPoint){const t=e;t.setX(ur(t.getX(),n,r))}else s.throwInternalErrorException("")}function Er(e,t,s){const n=new i.Point2D;return n.x=ur(e.x,t,s),n.y=e.y,n}function Sr(n,o,a,l){const h=n.getGeometryType();s.geometryReleaseAssert(h===s.GeometryType.enumPolygon||h===s.GeometryType.enumPolyline||h===s.GeometryType.enumMultiPoint);const g=o.getCoordinateSystemType();if(2===g){let g=n;if(0===a){const a=function(s,n){if(n.isEmpty())return 0;const r=s.getPECoordSys();if(r.getProjection().getCode()===e.peDefs.PE_PRJ_AZIMUTHAL_EQUIDISTANT){const o=Ti();s.querySpheroidData(o);const a=r.getParameters();if(null===a[e.peDefs.PE_PARM_LAM0])return 0;if(null===a[e.peDefs.PE_PARM_PHI0])return 0;const m=[a[e.peDefs.PE_PARM_LAM0].getValue(),a[e.peDefs.PE_PARM_PHI0].getValue()];e.peCSTransformations.geogToProj(r,1,m);const l=new i.Point2D(m[0],m[1]),h=t.Envelope2D.constructEmpty();n.queryEnvelope(h);const g=i.makeObjectArray(i.Point2D,4);h.queryCorners(g);let u=0;const c=s.getOneMeter();let p=Math.max(o.majorSemiAxis,o.minorSemiAxis)*Math.PI,d=Math.min(o.majorSemiAxis,o.minorSemiAxis)*Math.PI;d-=p/180,p*=c,d*=c;for(let e=0;e<4;e++){const t=i.Point2D.distance(g[e],l);if(t>p)u++;else if(t>d)return-1}if(0===u)return 1;if(4===u){const e=t.Envelope2D.constructEmpty();return e.setCoords({center:l,width:p,height:p}),h.isIntersectingNe(e)?-1:0}return-1}return-1}(o,n);if(0===a)return n.createInstance();if(1===a)return n;const h=o.getPCSHorizon(),u=h.getGeometryType(),c=o.getDefaultPrecisionSR();if(u===s.GeometryType.enumEnvelope){const e=t.Envelope2D.constructEmpty();h.queryEnvelope(e);const s=r.calculateToleranceFromGeometryForRel(c,e,!1);g=m.clip$1(n,e,s,5e4*o.getOneMeterPCSUnit(),l)}else(new Zn).execute(h,n,c,l)||(g=(new js).execute(g,h,c,l),g===h&&(g=g.clone()))}else if(o.isPannable()){const e=t.Envelope2D.constructEmpty();g.queryEnvelope(e);const n=o.getPannableExtent();n.containsEnvelope(e)||(Pr(g,n,o.getTolerance(0)),2!==a&&4!==a||(g=_r(g,o)),4!==a?g=lr(g,o,0,!0,1e5*o.getOneMeterPCSUnit(),l):h===s.GeometryType.enumPolygon&&e.width()>2*n.width()&&(g=yr(g,-2*n.width(),2*n.width(),o,!0,0,!0,l)))}return g}if(s.geometryReleaseAssert(1===g),h===s.GeometryType.enumMultiPoint)return Pr(n,o.getPannableExtent(),o.getTolerance(0)),n;{const e=t.Envelope2D.constructEmpty();n.queryEnvelope(e);let r=n;const i=o.getPannableExtent();if(e.ymin<i.ymin||e.ymax>i.ymax){const s=Math.max(1,e.calculateToleranceFromEnvelope()),n=new t.Envelope2D(e.xmin-s,i.ymin,e.xmax+s,i.ymax);if(r=(new m.OperatorClip).execute(r,n,o,l),r.isEmpty())return r}return h===s.GeometryType.enumPolygon&&e.width()>2*i.width()&&(r=yr(r,-2*i.width(),2*i.width(),o,!0,0,!0,l)),r}}function Cr(t,s,n,r){if(!n)return;const o=t.getPECoordSys();if(1===n){const n=[s[0].x,s[0].y];if(e.peCSTransformations.geogToProj(o,1,n),r){const{first:e,second:r}=t.m_peCoordSysVal.getGeogToProjFactors();n[0]=e*(s[0].x-t.getCentralMeridian())+r}return void s[0].setCoords(n[0],n[1])}const a=t.isPannable(),m=a?t.getPannableExtent().width():0,l=179*m/360;let h=0;a&&(h=t.getCentralMeridian());const g=new Float64Array(512);for(let u=0;u<n;){for(let e=u;e<n&&s[e].isNAN();++e)u++;let c=Math.min(256,n-u);if(c>0){for(let e=1,t=u+1;e<c;++e,++t)if(s[t].isNAN()){c=e;break}for(let e=0;e<c;++e){const t=e<<1;g[t]=s[u+e].x,g[t+1]=s[u+e].y}if(e.peCSTransformations.geogToProj(o,c,g),r){const{first:e,second:n}=t.m_peCoordSysVal.getGeogToProjFactors();for(let t=0;t<c;++t)g[t<<1]=e*(s[u+t].x-h)+n}if(a)for(let e=0,t=u;e<c;e++,t++){const n=e<<1,r=g[n],o=i.sign(r),a=s[t].x-h;o*i.sign(a)<0&&Math.abs(r)>l&&(g[n]-=o*m)}ar(g,s,u,c),u+=c}}}function Ir(t,n,r){s.geometryReleaseAssert(!r||t.isPannable());const o=n.getPointCount();if(!o)return;const a=n.getImpl(),m=a.getAttributeStreamRef(0),l=t.getPECoordSys();let h=0;const g=m.readRange(0,2*o);let u=()=>{e.peCSTransformations.geogToProj(l,o,g)};const c=t.isPannable()&&!r,p=c?t.getPannableExtent().width():0,d=179*p/360;if(t.isPannable()&&(h=t.getCentralMeridian(),r)){const s=t.m_peCoordSysVal.getGeogToProjFactors(),n=s.first,r=s.second;u=()=>{e.peCSTransformations.geogToProj(l,o,g);for(let e=0;e<o;e++){const t=e<<1,s=m.read(t),i=n*(s-h)+r;g[t]=i}}}if(u(),c)for(let e=0;e<o;e++){const t=e<<1,s=g[t],n=i.sign(s),r=m.read(t)-h;n*i.sign(r)<0&&Math.abs(s)>d&&(g[t]+=-n*p)}m.writeRangeFromArray(0,2*o,g,!0,1),a.notifyModifiedFlags(2001)}function vr(e,t,n){switch(t.getGeometryType()){case s.GeometryType.enumLine:return void function(e,t,s){const n=[t.getStartXY(),t.getEndXY()];Cr(e,n,2,s),t.setStartXY(n[0]),t.setEndXY(n[1]),t.normalizeAfterEndpointChange()}(e,t,n);case s.GeometryType.enumBezier:return void function(e,t,s){const n=i.makeObjectArray(i.Point2D,4);t.queryControlPoints(n),Or(e,n,4,s),t.setControlPoints(n)}(e,t,n);case s.GeometryType.enumEllipticArc:return void function(e,t,s){if(0===t.projectionBehavior())!function(e,t,s){qr(!0,e,0,t,s)}(e,t,s);else{const n=t.isClosed()&&t.isMajor(),r=[t.getStartXY(),n?t.getCenter():t.getEndXY()],i=[r[0].clone(),r[1].clone()];Or(e,i,2,s);const o=new a.Transformation2D;o.initializeFromTwoPointsArray(r,i),t.applyTransformation(o);const m=n?0:1;t.setCoordsForIntersector(i[0],i[m],!1)}}(e,t,n);case s.GeometryType.enumBezier2:case s.GeometryType.enumRationalBezier2:return void s.geometryReleaseAssert(0);default:s.throwInternalErrorException("")}}function Tr(t,o,a){if(!o.hasNonLinearSegments())return void Ir(t,o,a);if(s.geometryReleaseAssert(!a||t.isPannable()),o.isEmpty())return;const m=t.getPECoordSys(),l=t.isPannable(),h=l?t.getPannableExtent().width():0,g=179*h/360;let u=0;l&&(u=t.getCentralMeridian());const c=o.createInstance();c.reserveParts(o.getPointCount(),o.getPathCount());const p=o.getImpl(),d=new n.SegmentBuffer;for(let s=0,n=o.getPathCount();s<n;++s)if(p.hasNonLinearSegmentsPath(s)){let e=!0,n=-1;const o=p.getPathStart(s),m=o+p.getSegmentCountPath(s);p.isClosedPath(s)&&(n=m-1);const l=new i.Point2D;for(let s=o;s<m;++s){if(p.getSegmentBuffer(s,d,!1),vr(t,d.get(),a),e||d.get().getStartXY().equals(l)||d.get().moveTo(l),s!==n)c.addSegment(d.get(),e);else{if(e){const e=new r.Point;d.get().queryStart(e),c.startPathPoint(e)}c.closeLastPathWithSegment(d.get())}l.assign(d.get().getEndXY()),e=!1}}else{const t=1024;let n,r=p.getPathSize(s),a=Math.min(r,t);c.insertPath(-1,o,s,!0);const d=p.getAttributeStreamRef(0),_=c.getAttributeStreamRef(0);for(let o=p.getPathStart(s),c=p.getPathEnd(s);o<c;){if(n=d.readRange(o,a),e.peCSTransformations.geogToProj(m,a,n),l)for(let e=0;e<a;e++){const t=e<<1,s=n[t],r=i.sign(s),o=d.read(2*(0+e))-u;r*i.sign(o)<0&&Math.abs(s)>g&&(n[t]+=-r*h)}_.writeRangeFromArray(o,a,n,!0,1),o+=a,r-=a,a=Math.min(r,t)}}o.assignMove(c)}function Dr(e,t,s){let n=s.getPointCount();if(!n)return;const r=s.getImpl(),o=r.getAttributeStreamRef(0);let a=Math.min(n,1e3),m=0;const l=e.getPECoordSys();Number.isNaN(t)&&(t=0);const h=e.isPannable(),g=e.getOneDegreeGCSUnit(),u=360*g,c=179*g;let p;for(;n;){if(p=o.readRange(2*m,2*a),br(l,a,p,t),h)for(let e=0;e<a;e++){const s=e<<1,n=p[s]-t,r=i.sign(n),a=o.read(2*(m+e));r*i.sign(a)<0&&Math.abs(n)>c&&(p[s]+=-r*u)}o.writeRangeFromArray(2*m,2*a,p,!0,1),m+=a,n-=a,a=Math.min(n,1e3)}r.notifyModifiedFlags(2001)}function wr(e,t,n){switch(n.getGeometryType()){case s.GeometryType.enumLine:return void function(e,t,s){const n=[s.getStartXY(),s.getEndXY()];Nr(e,t,n,2),s.setStartXY(n[0]),s.setEndXY(n[1]),s.normalizeAfterEndpointChange()}(e,t,n);case s.GeometryType.enumBezier:return void function(e,t,s){const n=i.makeObjectArray(i.Point2D,4);s.queryControlPoints(n),Br(e,t,n,4),s.setControlPoints(n)}(e,t,n);case s.GeometryType.enumEllipticArc:return void function(e,t,s){if(0===s.projectionBehavior())!function(e,t,s){qr(!1,e,t,s,!1)}(e,t,s);else{const n=s.isClosed()&&s.isMajor(),r=[s.getStartXY(),n?s.getCenter():s.getEndXY()],i=[r[0].clone(),r[1].clone()];Br(e,t,i,2);const o=new a.Transformation2D;o.initializeFromTwoPointsArray(r,i),s.applyTransformation(o);const m=n?0:1;s.setCoordsForIntersector(i[0],i[m],!1)}}(e,t,n);case s.GeometryType.enumBezier2:case s.GeometryType.enumRationalBezier2:return void s.geometryReleaseAssert(0);default:s.throwInternalErrorException("")}}function br(t,n,r,i){const o=e.peCSTransformations.projToGeogCenter(t,n,r,i);for(let e=0;e<n;++e){const t=e<<1;s.geometryReleaseAssert(Number.isFinite(r[t]+r[t+1]))}return o}function Gr(e,t,s){if(!s.hasNonLinearSegments())return void Dr(e,t,s);if(s.isEmpty())return;const o=e.getPECoordSys();Number.isNaN(t)&&(t=0);const a=e.isPannable(),m=e.getOneDegreeGCSUnit(),l=360*m,h=179*m,g=s.createInstance();g.reserveParts(s.getPointCount(),s.getPathCount());const u=s.getImpl(),c=new n.SegmentBuffer;for(let n=0,m=s.getPathCount();n<m;++n)if(u.hasNonLinearSegmentsPath(n)){let s=!0,o=-1;const a=u.getPathStart(n),m=a+u.getSegmentCountPath(n);u.isClosedPath(n)&&(o=m-1);const l=new i.Point2D;for(let n=a;n<m;++n){if(u.getSegmentBuffer(n,c,!1),wr(e,t,c.get()),s||c.get().getStartXY().equals(l)||c.get().moveTo(l),n!==o)g.addSegment(c.get(),s);else{if(s){const e=new r.Point;c.get().queryStart(e),g.startPathPoint(e)}g.closeLastPathWithSegment(c.get())}l.assign(c.get().getEndXY()),s=!1}}else{const e=1e3;let r,m=u.getPathSize(n),c=Math.min(m,e);g.insertPath(-1,s,n,!0);const p=u.getAttributeStreamRef(0),d=g.getAttributeStreamRef(0);for(let s=u.getPathStart(n),g=u.getPathEnd(n);s<g;){if(r=p.readRange(2*s,2*c),br(o,c,r,t),a)for(let e=0;e<c;e++){const n=e<<1,o=r[n]-t,a=i.sign(o),m=p.read(2*s);a*i.sign(m)<0&&Math.abs(o)>h&&(r[n]+=-a*l)}d.writeRangeFromArray(2*s,2*c,r,!0,1),s+=c,m-=c,c=Math.min(m,e)}}s.assignMove(g)}function Nr(e,t,s,n){const r=e.getPECoordSys();Number.isNaN(t)&&(t=0);const o=e.isPannable(),a=e.getOneDegreeGCSUnit(),m=360*a,l=179*a,h=new Float64Array(512);for(let e=0;e<n;){for(let t=e;t<n&&s[t].isNAN();++t)e++;let a=Math.min(256,n-e);if(a>0){for(let t=1,n=e+1;t<a;++t,++n)if(s[n].isNAN()){a=t;break}for(let t=0;t<a;t++){const n=t<<1;h[n]=s[e+t].x,h[n+1]=s[e+t].y}if(br(r,a,h,t),o)for(let n=0,r=e;n<a;++n,++r){const e=n<<1,o=s[r].x,a=h[e]-t,g=i.sign(a);g*i.sign(o)<0&&Math.abs(a)>l&&(h[e]-=g*m)}for(let t=0;t<a;t++){const n=t<<1;s[e+t].x=h[n],s[e+t].y=h[n+1]}e+=a}}}function Hr(e,t,n,r){s.geometryReleaseAssert(0)}function Ar(e,t,s){let n=t.getPointCount();if(!n)return!1;const r=t.getImpl(),o=r.getAttributeStreamRef(0);let a=null;const m=e.getInputSR(),l=e.getOutputSR();m.getVCS(),l.getVCS();const h=m.getOneDegreeGCSUnit(),g=l.getOneDegreeGCSUnit(),u=e.isVertical();u&&t.hasAttribute(1)&&(a=r.getAttributeStreamRef(1));const c=e.getDatumTransformation(),p=!!c&&1===c.getType();if(p||null===a||(Hr(a.getArray()),a=null),!c||0===c.count()){const e=m.getGcsUnitFactor()/l.getGcsUnitFactor(),t=(m.getPrimeMeridian()-l.getPrimeMeridian())*g,s=-90*h,a=90*h;let u=0;const c=o.getArray(),p=[0];for(let e=1,t=2*n;e<t;)p[0]=c[e],u|=i.querySnap(p,s,a)?1:0,c[e]=p[0],e+=2;if(0!==t||1!==e){u=1;const s=o.getArray();for(let r=0,i=2*n;r<i;){let n=s[r];n*=e,n+=t,s[r]=n,s[r+1]*=e,r+=2}}return 0!==u&&r.notifyModifiedFlags(2001),!!u}let d=Math.min(n,1e3);const _=i.makePrimitiveArray(d,Number.NaN),f=i.makePrimitiveArray(d,Number.NaN);let y=null;null!==a&&(y=new Float64Array(d));let x=0,P=Number.NaN,E=Number.NaN;const S=360*g,C=g/h;s&&(E=90*g,P=89.9*h,f.fill(0));let I=!0,v=0;for(;n;){let e=!1;const t=o.readRange(2*x,2*d);for(let e=0;e<d;e++)_[e]=t[e<<1];if(s)for(let s=0;s<d;s++){const n=1+(s<<1),r=Math.abs(t[n])-P;if(r>0){const o=t[n];t[n]=i.copySign(P,o),f[s]=i.copySign(r,o),e=!0}}const r=t[0];if(p){const e=c;y&&a.queryRange(x,d,y,!0,1),e.transform(!1,t,y,d),y&&a.writeRangeFromArray(x,d,y,!0,1)}else c.transform(!1,t,d);I&&(v=t[0]-C*r,I=!1);for(let e=0;e<d;e++){const s=e<<1,n=t[s]-_[e]*C-v;Math.abs(n)>200&&(t[s]+=n>0?-S:S)}if(e){for(let e=0;e<d;e++)if(f[e]){const s=1+(e<<1);t[s]+=C*f[e],t[s]>E?t[s]=E:t[s]<-E&&(t[s]=-E)}f.fill(0)}o.writeRangeFromArray(2*x,2*d,t,!0,1),u&&a&&a.writeRangeFromArray(x,d,y,!0,1),x+=d,n-=d,d=Math.min(n,1e3)}return r.notifyModifiedFlags(2001),!0}function Fr(e,t,n){switch(t.getGeometryType()){case s.GeometryType.enumLine:return function(e,t,s){const n=[t.getStartXY(),t.getEndXY()];let r=null;t.hasAttribute(1)&&(r=[0,0],r[0]=t.getAttributeAsDbl(0,1,0),r[1]=t.getAttributeAsDbl(1,1,0));const i=Ur(e,n,r,2,s);return t.setStartXY(n[0]),t.setEndXY(n[1]),r&&(t.setStartAttribute(1,0,r[0]),t.setEndAttribute(1,0,r[1])),t.normalizeAfterEndpointChange(),i}(e,t,n);case s.GeometryType.enumBezier:return function(e,t,s){const n=i.makeObjectArray(i.Point2D,4);t.queryControlPoints(n);let r=null;t.hasAttribute(1)&&(r=[0,0,0,0],r[0]=t.getAttributeAsDbl(0,1,0),r[3]=t.getAttributeAsDbl(1,1,0),r[1]=i.lerp(r[0],r[3],.5),r[2]=r[1]);const o=Ur(e,n,r||null,n.length,s);return t.setControlPoints(n),r&&(t.setStartAttribute(1,0,r[0]),t.setEndAttribute(1,0,r[3])),t.normalizeAfterEndpointChange(),o}(e,t,n);case s.GeometryType.enumEllipticArc:return function(e,t,s){if(0===t.projectionBehavior())return function(e,t,s){const n=[t.getStartXY(),t.getEndXY(),t.getInteriorPoint(),t.getCenter()];let r=4;t.isDegenerateToLine()&&(r=2);const o=[0,0,0,0];let a=null;if(t.hasAttribute(1)){a=o,a[0]=t.getAttributeAsDbl(0,1,0),a[1]=t.getAttributeAsDbl(1,1,0);const e=i.lerp(a[0],a[1],.5);a[2]=e,a[3]=e}const m=t.getStartXY().equals(t.getEndXY())&&!t.isDegenerateToLine(),l=Ur(e,n,a,r,s);return m?t.constructCircleCenterAndPoint(n[3],n[0],!t.isClockwise()):t.isDegenerateToLine()?t.constructLineCircularArc(n[0],n[1]):t.constructCircularArcThreePoint(n[0],n[1],n[2]),a&&(t.setStartAttribute(1,0,a[0]),t.setEndAttribute(1,0,a[1])),l}(e,t,s);const n=t.getStartXY().equals(t.getEndXY()),r=i.makeObjectArray(i.Point2D,3),o=i.makeObjectArray(i.Point2D,3);let m=null;r[0].assign(t.getStartXY()),r[1].assign(n?t.getCenter():t.getEndXY());let l=!1;t.hasAttribute(1)&&(m=[0,0,0],m[0]=t.getAttributeAsDbl(0,1,0),m[1]=t.getAttributeAsDbl(1,1,0),m[2]=i.lerp(m[0],m[1],.5),n&&(m[1]=m[2])),o[0].setCoordsPoint2D(r[0]),o[1].setCoordsPoint2D(r[1]);const h=new a.Transformation2D;if(n||t.isDegenerateToLine())l=Ur(e,o,m,2,s),h.initializeFromTwoPoints(r[0],r[1],o[0],o[1]);else{const n=new i.Point2D;t.queryCoord2D(.5,n),r[2].setCoordsPoint2D(n),o[2].setCoordsPoint2D(n),l=Ur(e,o,m,3,s),h.setFromTwoTriangles(r,o)}return h.isIdentity()||(t.applyTransformation(h),t.setStartXY(o[0]),t.setEndXY(n?o[0]:o[1]),t.normalizeAfterEndpointChange()),m&&(t.setStartAttribute(1,0,m[0]),t.setEndAttribute(1,0,n?m[0]:m[1])),l}(e,t,n);case s.GeometryType.enumBezier2:case s.GeometryType.enumRationalBezier2:return s.geometryReleaseAssert(0),!1;default:s.throwInternalErrorException("")}}function Vr(e,t,s){if(!t.hasNonLinearSegments())return Ar(e,t,s);if(t.isEmpty())return!1;const o=t.createInstance();o.reserveParts(t.getPointCount(),t.getPathCount());const a=t.getImpl(),m=new n.SegmentBuffer;for(let n=0,l=t.getPathCount();n<l;++n){let t=!0,l=-1;const h=a.getPathStart(n),g=h+a.getSegmentCountPath(n);a.isClosedPath(n)&&(l=g-1);const u=new i.Point2D;for(let n=h;n<g;++n){if(a.getSegmentBuffer(n,m,!1),Fr(e,m.get(),s),t||m.get().getStartXY().equals(u)||m.get().moveTo(u),n!==l)o.addSegment(m.get(),t);else{if(t){const e=new r.Point;m.get().queryStart(e),o.startPathPoint(e)}o.closeLastPathWithSegment(m.get())}u.assign(m.get().getEndXY()),t=!1}}return t.assignMove(o),!0}function Rr(e,t,s,n,r,o){if(e.isIdentityGeogToGeog()){const s=90*e.getInputSR().getOneDegreeGCSUnit();let r=0;const o=[0];for(let e=0;e<n;e++)o[0]=t[e].y,r|=i.querySnap(o,-s,s)?1:0,t[e].y=o[0];return r}const a=e.getInputSR(),m=e.getOutputSR(),l=a.getVCS(),h=m.getVCS(),g=a.getOneDegreeGCSUnit(),u=90*g,c=m.getOneDegreeGCSUnit(),p=e.isVertical(),d=e.getDatumTransformation(),_=!!d&&1===d.getType();if(p||(s=null),!d||0===d.count()){let e=0;const r=[0];for(let s=0;s<n;s++)r[0]=t[s].y,e|=i.querySnap(r,-u,u)?1:0,t[s].y=r[0];return e|=qn(a.getGCS(),l,m.getGCS(),h,t,s,n)?1:0,e}_||null===s||Hr();let f=Math.min(n,1024);const y=i.makePrimitiveArray(f,Number.NaN),x=i.makePrimitiveArray(f,Number.NaN);let P=0,E=Number.NaN,S=Number.NaN;const C=360*c,I=c/g;r&&(S=90*c,E=89.9*g);let v=!0,T=0,D=n;for(;D;){let e=!1;for(let e=0;e<f;e++)y[e]=t[e+P].x;if(r)for(let s=0;s<f;s++){const n=Math.abs(t[s+P].y)-E;if(n>0){const r=t[s+P].y;t[s+P].y=i.copySign(E,r),x[s]=i.copySign(n,r),e=!0}}const n=t[0].x;_?d.transform(!1,t,s,f):d.transform(!1,t,f),v&&(T=t[0].x-I*n,v=!1);for(let e=0;e<f;e++){const s=t[P+e].x-y[e]*I-T;Math.abs(s)>200&&(s>0?t[P+e].x-=C:t[P+e].x+=C)}if(e){for(let e=0;e<f;e++)x[e]&&(t[P+e].y+=I*x[e],t[P+e].y>S?t[P+e].y=S:t[P+e].y<-S&&(t[P+e].y=-S));x.fill(0,0,f)}P+=f,D-=f,f=Math.min(D,1024)}return 1}function kr(e,t,n,r,i){return s.geometryReleaseAssert(0),0}function Mr(e,t,n,r,o){s.geometryReleaseAssert(null===r),s.geometryReleaseAssert(t<2147483647);const a=Array.isArray(n);let m;m=a?i.point2DArrayToFloat64Array(n):n;const l=lo.geogToGeog(e,t,m,null,o);return a&&i.float64ArrayToPoint2DArray2(m,n),l}function Ur(e,t,s,n,r,i){let o=0,a=!0,m=0;for(let i=0;i<n;++i)t[i].isNAN()?a||(o|=Rr(e,t.slice(m,i-m),s?s.slice(m,i-m):null,i-m,r),m=i,a=!0):a&&(m=i,a=!1);return a||(o|=Rr(e,0===m?t:t.slice(m),s?0===m?s:s.slice(m):null,n-m,r)),0!==o}function Or(e,t,s,n){Cr(e,t,s,n)}function Br(e,s,n,r){Nr(e,s,n,r);const i=new t.Envelope2D;i.setFromPoints(n,r);const o=e.getOneDegreeGCSUnit(),a=360*o,m=180*o;if(i.width()>m){for(let e=0;e<r;e++)for(;n[e].x<s;)n[e].x+=a;if(i.setFromPoints(n,r),i.xmax>m+s)for(let e=0;e<r;e++)n[e].x-=a}}function qr(e,t,s,n,r){const o=i.makeObjectArray(i.Point2D,3);let a=0,m=!1,l=!1;const h=n.isDegenerateToLine();h?(o[0].assign(n.getStartXY()),o[1].assign(n.getEndXY()),o[2].setCoords(0,0),a=2):n.isClosed()&&n.isMajor()?(m=!0,l=!n.isClockwise(),o[0].assign(n.getStartXY()),o[1].assign(n.getCenter()),o[2].setCoords(0,0),a=2):(o[0].assign(n.getStartXY()),o[1].assign(n.getEndXY()),o[2].assign(n.getInteriorPoint()),a=3),e?Or(t,o,a,r):Br(t,s,o,a),h?n.constructLineCircularArc(o[0],o[1]):m?n.constructCircleCenterAndPoint(o[1],o[0],l):n.constructCircularArcThreePoint(o[0],o[1],o[2])}function Yr(e,t,s){const r=n.convertToDegrees(e),i=n.convertToDegrees(t),o=n.shorterArcDistance(r,i),a=n.shorterArcDistance(r,n.convertToDegrees(s));return 0===a||o>0&&a>0&&a<=o||o<0&&a<0&&a>=o}function Xr(t,n,r,a,m){const l={stack:[],error:void 0,hasError:!1};try{const h=r.clone(),g=a.clone();if(2===m){const e=[0,0];return b(0,n,h,g,0,e),e[0]}if(h.y>g.y){const e=new i.Point2D;e.assign(h),h.assign(g),g.assign(e)}const u=o.__addDisposableResource(l,new e.PeDoubleClass,!1),c=o.__addDisposableResource(l,new e.PeDoubleClass,!1),p=o.__addDisposableResource(l,new e.PeDoubleClass,!1),d=new i.Envelope1D;if(d.setCoords(h.y,g.y),!d.containsCoordinate(0)||Math.abs(h.x-g.x)>=Math.PI)return Number.NaN;if(h.x===g.x)return h.x;e.peLineType.geodeticDistance(t,n,h.x,h.y,g.x,g.y,c,u,null,m);const _=c.val;let f=0,y=1;const x=h.clone();for(;_*(y-f)>1e-12*t;){const r=.5*(f+y);if(e.peLineType.geodeticCoordinate(t,n,h.x,h.y,_*r,u.val,c,p,m),x.x=c.val,x.y=p.val,d.setCoords(h.y,x.y),0===x.y)return x.x;if(d.containsCoordinate(0))y=r;else{if(d.setCoords(g.y,x.y),!d.containsCoordinate(0))return s.geometryReleaseAssert(!1),Number.NaN;f=r}}return x.x}catch(e){l.error=e,l.hasError=!0}finally{o.__disposeResources(l)}}function Lr(e,t,s,n){const r=new i.Envelope1D;r.setCoords(t,s);const o=n.width();let a=Math.floor((e-t)/o)*o+e;const m=r.getCenter();for(;Math.abs(a-m)>Math.abs(a+o-m);)a+=o;return a}class zr extends h.GeometryCursor{constructor(){super(),this.m_geometryDeque=[],this.m_index=-1}next(){if(this.m_geometryDeque.length>0){this.m_index++;const e=this.m_geometryDeque[0];return this.m_geometryDeque.shift(),e}return null}getGeometryID(){return this.m_index}tick(e){this.m_geometryDeque.push(e)}tock(){return!0}getRank(){return 1}}class Wr{constructor(n,r=!0){this.m_PCSHorizon=null,this.m_GCSHorizon=null,this.m_GCSSplitLines=null,this.m_bGCSHorisonIsInclusive=!1,this.m_oneMeterPCS=0,this.m_oneDegreeGCS=0,this.m_gcsUnitFactor=0,this.m_northPole=i.Point2D.getNAN(),this.m_southPole=i.Point2D.getNAN(),this.m_polesUpdated=0,this.m_domain=t.Envelope2D.constructEmpty(),this.m_primeMeridian=Number.NaN,this.m_geogToProjFactor=1,this.m_geogToProjOffset=0,this.m_geogToProjFactorsUpdated=0,this.m_oneMillimeter=0,this.m_centralMeridian=0,this.m_pPCSInfoNoDomain=null,this.m_oldWKID=-1973,this.m_vcsWKID=-1,this.m_bIsPannable=!1,this.m_bCached=!1,this.m_pannableExtent=t.Envelope2D.constructEmpty(),this.m_pannableExtentGCS=t.Envelope2D.constructEmpty(),this.m_areaOfUse=null,this.m_canonicalWkt="",this.m_peCoordSys=n,this.m_WKID=e.peFactory.getCode(n),this.m_WKID<=0?(this.m_WKID=0,this.m_canonicalWkt=nr(n,0,!0),this.m_hashCode=i.hashString(this.m_canonicalWkt)):this.m_hashCode=i.nextRand(this.m_WKID);const o=this.m_peCoordSys.getType();this.m_csType=o===e.peDefs.PE_TYPE_PROJCS?2:1,s.geometryReleaseAssert(o===e.peDefs.PE_TYPE_PROJCS||o===e.peDefs.PE_TYPE_GEOGCS),o===e.peDefs.PE_TYPE_PROJCS&&(n.loadConstants()||s.throwInvalidArgumentException("PeProjcs.loadConstants failed"));const a=o===e.peDefs.PE_TYPE_GEOGCS?this.m_peCoordSys:this.m_peCoordSys.getGeogcs();o!==e.peDefs.PE_TYPE_GEOGCS&&e.peFactory.getCode(a),this.m_unit=function(t){const n=mo(null);return t.getType()===e.peDefs.PE_TYPE_PROJCS||t.getType()===e.peDefs.PE_TYPE_GEOGCS?n.reset(t.getUnit()):s.throwInvalidArgumentException("PE_coord_sys"),n.get()||s.throwInternalErrorException("cannot create units from coord sys"),function(t){return t.getType()===e.peDefs.PE_TYPE_LINUNIT?new yi(t):t.getType()===e.peDefs.PE_TYPE_ANGUNIT?new d(t):void s.throwInvalidArgumentException("peUnit")}(n.get())}(n),this.m_primeMeridian=a.getPrimem().getLongitude();{const e=a.getUnit().getUnitFactor();this.m_gcsUnitFactor=e;let t=Math.PI/(180*e);Math.abs(t-1)<1e-10&&(t=1),this.m_oneDegreeGCS=t}if(o===e.peDefs.PE_TYPE_PROJCS){const e=this.m_peCoordSys,t=e.getUnit().getUnitFactor();this.m_oneMeterPCS=1/t,this.m_oneMillimeter=.001/t,this.m_pPCSInfoNoDomain=ho.generate(e,ho.PE_PCSINFO_OPTION_NONE),this.m_pPCSInfoNoDomain||s.throwInternalErrorException("cannot create pcs info"),this.m_bIsPannable=this.m_pPCSInfoNoDomain.isPannableRectangle(),this.m_centralMeridian=this.m_pPCSInfoNoDomain.getCentralMeridian()}else{this.m_bIsPannable=!0,this.m_polesUpdated=1,this.m_oneMeterPCS=0;const e=1/a.getUnit().getUnitFactor(),t=a.getDatum().getSpheroid().getAxis();this.m_oneMillimeter=.001/t*e,this.m_centralMeridian=0}this.m_bIsPannable&&(this.updateGCSHorizon(),this.updatePCSHorizon(),this.updatePoles(),this.updateDomain(),this.updatePannableExtent(),this.updatePannableExtentGCS())}[Symbol.dispose](){}getHashCode(){return this.m_hashCode}getPCSHorizonPannable(){return this.m_PCSHorizon}getGCSHorizonPannable(){return this.m_GCSHorizon}getPCSInfo(){return s.geometryReleaseAssert(this.m_pPCSInfoNoDomain),this.m_pPCSInfoNoDomain}getCentralMeridian(){return this.m_centralMeridian}updateGCSHorizon(){if(this.m_peCoordSys.getType()!==e.peDefs.PE_TYPE_PROJCS)return;let o=!0;const l=this.m_peCoordSys,h=l.getGeogcs(),g=l.horizonGcsGenerate();if(!g)return;s.geometryReleaseAssert(g.length>0);const u=g[0].getNump(),c=g[0].getKind();let p,d;o=g[0].getInclusive()>0;const _=this.getOneDegreeGCSUnit(),f=90*_,y=360*_,x=370*_,P=180*_*e.peDefs.PE_HORIZON_DELTA/Math.PI,E=t.Envelope2D.constructEmpty();let S=null;if(u>1)for(let t=1;t<u;t++)if(g[t].getKind()===e.peDefs.PE_HORIZON_LINE){S||(S=new n.Polyline);const e=g[t].getCoord();S.startPathCoords(e[0][0],e[0][1]),S.lineToCoords(e[1][0],e[1][1])}if(c===e.peDefs.PE_HORIZON_RECT){const e=g[0].getCoord();if(E.setFromPoints([new i.Point2D(e[0][0],e[0][1]),new i.Point2D(e[1][0],e[1][1])],2),Math.abs(E.ymax-f)<1e-7*P&&(E.ymax=f),Math.abs(E.ymin+f)<1e-7*P&&(E.ymin=-f),E.width()>x){const e=-400*_,t=e+5*y;E.setCoords({xmin:e,ymin:E.ymin,xmax:t,ymax:E.ymax})}const t=new r.Envelope({env2D:E});this.m_GCSHorizon||(this.m_GCSHorizon=t,this.m_bGCSHorisonIsInclusive=o)}else{let r=this.getPCSInfo().isGcsHorizonMultiOverlap();const l=Ai(h,null,0,1),c=[],x=new i.Envelope1D;for(let s=0;s<u;s++){if(g[s].getKind()!==e.peDefs.PE_HORIZON_POLY)continue;p=g[s].getSize();const n=g[s].getCoord(),r=t.Envelope2D.constructEmpty();r.setFromPoints(i.coordinateArrayToPoint2DArray(n),p),c.push(new i.Envelope1D(r.xmin,r.xmax)),r.width(),x.merge(c.at(-1))}let P=!1;const E=new i.Envelope1D;x.width()>y&&c.length>1?(E.vmin=this.getCentralMeridian()-y,E.vmax=E.vmin+2*y,P=!0,r=!0):(E.vmin=x.vmin,E.vmax=E.vmin+y);const C=e=>{let t=0;for(;c[e].vmin+t<E.vmin;)t+=y;for(;c[e].vmax+t-y>E.vmin;)t-=y;return t};let I=new n.Polygon;if(r){const t=new zr,s=(new $n).executeMany(t,l,null);for(let r=0;r<u;r++){if(g[r].getKind()!==e.peDefs.PE_HORIZON_POLY)continue;p=g[r].getSize();const o=g[r].getCoord();d=g[r].getInclusive()>0;const m=new n.Polygon;if(m.addPathPoint2D(i.coordinateArrayToPoint2DArray(o),p-1,!0),P){const e=C(r),s=c[r].clone();s.move(e);let n=e;const i=new a.Transformation2D;do{i.setShiftCoords(n,0);const e=m.clone();e.applyTransformation(i),t.tick(e),t.tock(),n+=y,s.move(y)}while(s.vmin<E.vmax)}else t.tick(m),s.tock()}I=s.next()}else{I=new n.Polygon;for(let t=0;t<u;t++){if(g[t].getKind()!==e.peDefs.PE_HORIZON_POLY)continue;p=g[t].getSize();const r=g[t].getCoord();if(d=g[t].getInclusive()>0,s.geometryReleaseAssert(d===o),P){const e=new n.Polygon;e.addPathPoint2D(i.coordinateArrayToPoint2DArray(r),p-1,!0);const s=C(t),o=c[t].clone();o.move(s);let m=s;const l=new a.Transformation2D;do{if(0!==m){l.setShiftCoords(m,0);const t=new n.Polygon({copy:e});t.applyTransformation(l),I.addPath(t,0,!0)}else I.addPath(e,0,!0);m+=y,o.move(y)}while(o.vmin<E.vmax)}else I.addPathPoint2D(i.coordinateArrayToPoint2DArray(r),p-1,!0)}}P&&(I=(new m.OperatorClip).execute(I,new t.Envelope2D(E.vmin,-f-_,E.vmax,f+_),l,null)),o?(new js).accelerateGeometry(I,l,1):(new Qn).accelerateGeometry(I,l,1),(new tr).accelerateGeometry(I,l,1),null===this.m_GCSHorizon&&(this.m_GCSHorizon=I,this.m_bGCSHorisonIsInclusive=o,this.m_GCSSplitLines=S)}}updateAreaOfUse(){return null}updatePCSHorizon(){if(this.m_peCoordSys.getType()!==e.peDefs.PE_TYPE_PROJCS)return;const o=this.m_peCoordSys.horizonPcsGenerate();if(!o)return;let a;this.getPCSInfo();const m=o[0].getKind();o[0].getInclusive();const h=t.Envelope2D.constructEmpty(),g=o[0].getNump();let u=!1;if(m===e.peDefs.PE_HORIZON_RECT){const e=o[0].getCoord();h.setFromPoints(i.coordinateArrayToPoint2DArray(e),2),a=new r.Envelope({env2D:h})}else{let t=-1;for(let s=0;s<g;s++)o[s].getKind()===e.peDefs.PE_HORIZON_POLY&&(t=s);s.geometryReleaseAssert(t>=0);const r=o[t].getSize()-1,m=o[t].getCoord(),l=new n.Polygon;a=l,l.addPathPoint2D(i.coordinateArrayToPoint2DArray(m),r,!0),u=!0}if(this.getPCSInfo().isDensificationNeeded()){s.geometryReleaseAssert(m!==e.peDefs.PE_HORIZON_RECT);const t=1e5*this.getOneMeterPCSUnit();a=(new l.OperatorDensify).execute(a,t,0,0,null)}if(u){{const e=new r.Envelope;a.queryEnvelope(e),a.calculateArea2D(),a.calculateLength2D(),a.getExteriorRingCount()}(new js).accelerateGeometry(a,null,1)}null===this.m_PCSHorizon&&(this.m_PCSHorizon=a)}updatePannableExtent(){const n=this.m_peCoordSys.getType();if(n===e.peDefs.PE_TYPE_PROJCS){const n=this.m_peCoordSys,r=this.getPCSInfo().getCentralMeridian(),i=n.getGeogcs();i||s.throwInternalErrorException("");const o=[r+1/i.getUnit().getUnitFactor()*Math.PI,0];e.peCSTransformations.geogToProj(n,1,o);const a=o[0],m=n.getParameters()[e.peDefs.PE_PARM_X0].getValue(),l=this.getPCSHorizon(),h=t.Envelope2D.constructEmpty();l.queryEnvelope(h);const g=Math.abs(a-m),u=g+m,c=-1*g+m,p=h.ymax,d=h.ymin;this.m_pannableExtent.setCoords({xmin:c,ymin:d,xmax:u,ymax:p})}else if(n===e.peDefs.PE_TYPE_GEOGCS){const e=1/this.m_peCoordSys.getUnit().getUnitFactor()*Math.PI;this.m_pannableExtent.setCoords({xmin:-e,ymin:-e/2,xmax:e,ymax:e/2})}else s.throwInternalErrorException("")}updatePannableExtentGCS(){const n=this.m_peCoordSys.getType();if(n===e.peDefs.PE_TYPE_PROJCS){const e=this.m_peCoordSys,n=this.m_centralMeridian,r=e.getGeogcs();r||s.throwInternalErrorException("");const i=1/r.getUnit().getUnitFactor()*Math.PI,o=this.getGCSHorizon(),a=t.Envelope2D.constructEmpty();o.queryEnvelope(a),this.m_pannableExtentGCS.setCoords({xmin:n-i,ymin:a.ymin,xmax:n+i,ymax:a.ymax})}else if(n===e.peDefs.PE_TYPE_GEOGCS){const e=1/this.m_peCoordSys.getUnit().getUnitFactor()*Math.PI;this.m_pannableExtentGCS.setCoords({xmin:-e,ymin:-e/2,xmax:e,ymax:e/2})}else s.throwInternalErrorException("")}updateDomain(){if(1===this.m_csType){const e=400*this.getOneDegreeGCSUnit();this.m_domain=t.Envelope2D.construct(-e,-e,e,e)}else{s.geometryReleaseAssert(2===this.m_csType);const e=ho.generate(this.m_peCoordSys,ho.PE_PCSINFO_OPTION_DOMAIN);e||s.throwInternalErrorException("generate pcs info failed");const n=new t.Envelope2D(e.getDomainMinx(),e.getDomainMiny(),e.getDomainMaxx(),e.getDomainMaxy());this.m_domain.isEmpty()&&this.m_domain.setCoords({env2D:n})}}updatePoles(){if(this.m_peCoordSys.getType()===e.peDefs.PE_TYPE_PROJCS){const t=90*this.getOneDegreeGCSUnit(),s=[[0,t],[0,-t]];e.peCSTransformations.geogToProj(this.m_peCoordSys,2,s);const n=this.getPCSInfo().getNorthPoleLocation()!==ho.PE_POLE_OUTSIDE_BOUNDARY,r=this.getPCSInfo().getSouthPoleLocation()!==ho.PE_POLE_OUTSIDE_BOUNDARY;this.m_polesUpdated||(n&&this.m_northPole.setCoords(s[0][0],s[0][1]),r&&this.m_southPole.setCoords(s[1][0],s[1][1]),this.m_polesUpdated=1)}else this.m_polesUpdated=1}updateGeogToProjFactors(){if(this.m_peCoordSys.getType()===e.peDefs.PE_TYPE_PROJCS){const t=this.getOneDegreeGCSUnit(),n=this.m_pPCSInfoNoDomain.getCentralMeridian(),r=[0,0,0,0];r[0]=n,r[1]=0,r[2]=n+t,r[3]=0;const i=e.peCSTransformations.geogToProj(this.m_peCoordSys,2,r);s.geometryReleaseAssert(2===i);const o=(r[2]-r[0])/t,a=r[0];0===this.m_geogToProjFactorsUpdated&&(this.m_geogToProjFactor=o,this.m_geogToProjOffset=a,this.m_geogToProjFactorsUpdated=1)}else this.m_geogToProjFactorsUpdated=1}getOneMeterPCSUnit(){return this.m_oneMeterPCS}getOneDegreeGCSUnit(){return this.m_oneDegreeGCS}getGcsUnitFactor(){return this.m_gcsUnitFactor}getUnitsPerMillimeter(){return this.m_oneMillimeter}getGCSSplitLines(){return this.m_bIsPannable?null:(this.m_GCSHorizon||this.updateGCSHorizon(),this.m_GCSSplitLines)}getGCSHorizon(){return this.m_bIsPannable?this.getGCSHorizonPannable():(null!==this.m_GCSHorizon||this.updateGCSHorizon(),this.m_GCSHorizon)}getGCSHorisonIsInclusive(){return this.m_bIsPannable||this.getGCSHorizon(),this.m_bGCSHorisonIsInclusive}getPCSHorizon(){return this.m_bIsPannable?this.getPCSHorizonPannable():(null!==this.m_PCSHorizon||this.updatePCSHorizon(),this.m_PCSHorizon)}getPole(e){return this.m_bIsPannable||0!==this.m_polesUpdated||this.updatePoles(),e?this.m_southPole:this.m_northPole}getGeogToProjFactors(){return 0===this.m_geogToProjFactorsUpdated&&this.updateGeogToProjFactors(),i.makePair(this.m_geogToProjFactor,this.m_geogToProjOffset)}getDomainXY(){if(this.m_bIsPannable)return this.m_domain.clone();let e=!1;return e=this.m_domain.isEmpty(),e&&this.updateDomain(),this.m_domain.clone()}getPrimeMeridian(){return this.m_primeMeridian}getLatestID(){return this.m_WKID}getOldID(){let e=this.m_oldWKID;if(e<0){if(e=0,this.m_WKID>0){const t=[0],n=[0];(function(e,t,s,n){return t<=0?(s[0]=0,n[0]=0,!1):(s[0]=t,n[0]=t,!0)})(this.m_peCoordSys.getType(),this.m_WKID,t,n)||s.throwInternalErrorException("query_code_change"),e=t[0]}this.m_oldWKID=e}return e}isCustomWkid(){return!1}isPannable(){return this.m_bIsPannable}getPannableExtent(){return this.m_pannableExtent.clone()}getPannableExtentGCS(){return this.m_pannableExtentGCS.clone()}getAreaOfUse(){return null!==this.m_areaOfUse?this.m_areaOfUse:this.updateAreaOfUse()}getVcsCode(){return 0}saveMemory(){}getCSType(){return this.m_csType}getUnit(){return this.m_unit}setCached(){this.m_bCached=!0}getCached(){return this.m_bCached}static equal(e,t){return!1}static equal_for_projection(e,t){return!1}}class jr{constructor(e,t=!0){this.m_oneMeter=0,this.m_WKID=-1,this.m_oldWKID=-1,this.m_canonicalWkt="not yet implemented",this.m_model=0,this.m_unit=new yi,this.m_cached=!1}setCached(e=!0){this.m_cached=e}getCached(){return this.m_cached}getOneMeterUnit(){return 0}getLatestID(){return this.m_WKID}getOldID(){let e=this.m_oldWKID;return e<0&&(e=0,this.m_WKID>0&&(e=this.m_WKID),this.m_oldWKID=e),e}getModel(){return 0}isCustomWkid(){return!1}getVerticalUnit(){return this.m_unit}static equal(e,t){return!1}static equal_for_projection(e,t){return!1}}function Zr(e,n,r,i){return function(e,n,r,i,o){return wi()||s.throwProjectionEngineNotLoadedException("cannot create projection transformation"),n.hasVCS()&&r.hasVCS()?(s.geometryReleaseAssert(0),{}):function(e,n,r,i){e&&n||s.throwInvalidArgumentException("!inputSR || !outputSR");const o=e.getLatestID(),a=n.getLatestID();if(3857===o&&4326===a){if(e.m_bDefaultDescriptor&&n.m_bDefaultDescriptor)return pi()}else if(4326===o&&3857===a&&e.m_bDefaultDescriptor&&n.m_bDefaultDescriptor)return ui||(ui=pi().getInverse()),ui;const m=t.Envelope2D.constructEmpty();m.setCoords({env2D:r});const l=e.getCoordinateSystemType(),h=n.getCoordinateSystemType();if(0===l||0===h)return ei(e,n);if(i){const t=i.find(0,e.getGCS(),n.getGCS());if(t)return ei(e,n,t)}const g=e.getGCS().getLatestID(),u=n.getGCS().getLatestID();if(g>0&&g===u)return ei(e,n);const c=new li(e,n,r);{const e=function(e){if(hi.has(e.getHashCode()))return hi.get(e.getHashCode())}(c);if(e)return e}const p=$r(0,e,n,m,1,!0);return function(e,t){return hi.set(e.getHashCode(),t),t}(c,ei(e,n,p.length?p[0]:void 0))}(n,r,i,o)}(0,e,n,r,i)}function Qr(e,t,s,n){return Kr(!0,e,t,s,n)}function Kr(e,t,n,r,i,o){return wi()||s.throwProjectionEngineNotLoadedException("cannot create projection transformation"),new ri(e?2:1,t,n,r,i,o)}function $r(e,t,n,r,i,o=!1){if(t&&n||s.throwInvalidArgumentException(""),wi()||s.throwProjectionEngineNotLoadedException("cannot obtain geotransformation list"),1===e&&t.hasVCS()&&n.hasVCS())return s.throwNotImplementedException("hv xform not impl"),[];{const e=Co(t,n,r,i,o),s=[];for(const t of e)s.push(t);return s}}function Jr(){return{centralMeridianOfOutputGCS:Number.NaN,densificationStep:Number.NaN,clipWithInputHorizon:!0,clipWithOutputHorizon:!0,legacyHorizonClipping:!1,normalizeResultGeometry:!1,equals(e){return i.isEqualNonIEEE(this.centralMeridianOfOutputGCS,e.centralMeridianOfOutputGCS)&&i.isEqualNonIEEE(this.densificationStep,e.densificationStep)&&this.clipWithInputHorizon===e.clipWithInputHorizon&&this.clipWithOutputHorizon===e.clipWithOutputHorizon&&this.legacyHorizonClipping===e.legacyHorizonClipping&&this.normalizeResultGeometry===e.normalizeResultGeometry}}}function ei(e,t,s,n,r){return new ri(1,e,t,s,n,r)}function ti(){return{flagsMask:0,setFlag(e,t){t?this.flagsMask|=e:this.flagsMask&=~e},hasFlag(e){return 0!==(this.flagsMask&e)}}}function si(){return{m_extendedParams:Jr(),m_extendedParamsInternal:ti()}}function ni(){return si()}let ri=class e{constructor(e,t,n,r,i,o){let a,m;this.m_datumTran=null,this.m_bIdentity=!0,this.m_bIdentityGeogToGeog=!0,this.m_bVertical=!1,this.m_bNormalize=!1,t&&n||s.throwInvalidArgumentException("!inputSR || !outputSR"),r&&0===r.getType()&&(r.m_bReadOnly=!0),this.m_bNormalize=!1,1!==e&&(a=t.getVCS(),m=n.getVCS(),this.m_bVertical=null!=a&&null!=m),this.m_inputSR=t,this.m_outputSR=n,this.m_bIdentity=!1,this.m_bIdentityGeogToGeog=!1,s.geometryReleaseAssert(!this.m_params),i&&(this.m_params=si(),this.m_params.m_extendedParams=i),o&&(this.m_params||(this.m_params=si()),this.m_params.m_extendedParamsInternal=o);let l=!1;const h=null!=r,g=t.getCoordinateSystemType(),u=n.getCoordinateSystemType();if(n.isPannable()&&0!==g&&i){const e=i.centralMeridianOfOutputGCS;if(!Number.isNaN(e)&&n.isPannable()){const t=n.getPannableExtent(),s=t.getCenterX();if(s!==e){const n=Math.ceil(t.width());e+n!==s+n&&(l=!0)}}}const c=i&&i.normalizeResultGeometry;if(t.equals(n))return this.m_bIdentity=!l,this.m_bIdentityGeogToGeog=!0,void this.updateProjector();const p=!h&&t.equalForProjection(n,this.m_bVertical);this.m_bIdentity=p&&!l,this.m_bIdentity?this.m_bIdentityGeogToGeog=!0:0!==g&&0!==u&&(c&&this.m_outputSR.isPannable()&&(this.m_bNormalize=c),this.m_datumTran=r||null,this.m_bIdentityGeogToGeog=(!this.m_datumTran||0===this.m_datumTran.count())&&this.m_inputSR.getGCS().equalForProjection(this.m_outputSR.getGCS(),this.m_bVertical)),this.updateProjector()}getInputSR(){return this.m_inputSR}getOutputSR(){return this.m_outputSR}getDatumTransformation(){return this.m_datumTran}getInverse(){const t=new e(1,this.m_outputSR,this.m_inputSR,this.m_datumTran?.createInverse());return t.m_bIdentity=this.m_bIdentity,t.m_bVertical=this.m_bVertical,t.m_bIdentityGeogToGeog=this.m_bIdentityGeogToGeog,t.updateProjector(),t}isIdentity(){return this.m_bIdentity}getExtendedParams(){return this.m_params?this.m_params.m_extendedParams:ni().m_extendedParams}equals(e){return s.geometryReleaseAssert(0),!1}isVertical(){return this.m_bVertical}isMatchingTransformation(e,t){return s.geometryReleaseAssert(0),!1}getGeographicTransformations(){return this.m_datumTran}getExtendedParamsImpl(){return this.m_params?this.m_params.m_extendedParams:ni().m_extendedParams}getExtendedParamsInternal(){return this.m_params?this.m_params.m_extendedParamsInternal:ni().m_extendedParamsInternal}isIdentityGeogToGeog(){return this.m_bIdentityGeogToGeog}normalizeOutput(){return this.m_bNormalize}updateProjector(){this.m_projector=new en(this)}};const ii=new Map,oi=new Map,ai=new Map;function mi(t){let s=t.getCode();if(s>0)return fi(s)||_i(e.peFactory.coordsys(s));const n=t.getName();if(oi.has(n)){const e=oi.get(n);if(e&&e.deref()){const s=e.deref();if(s.m_peCoordSys.isEqual(t))return s}}return s=e.peFactory.getCode(t),_i(s>0?e.peFactory.coordsys(s):t)}class li{constructor(e,t,s){this.m_hashCode=-1,e&&(this.m_inputSR=e,this.m_outputSR=t,this.m_env=s.clone(),this.m_hashCode=this.m_inputSR.getHashCode(),this.m_hashCode=i.hashCombine(this.m_hashCode,this.m_outputSR.getHashCode()),this.m_env.isEmpty()||(this.m_hashCode=i.hashCombine(this.m_hashCode,i.hashDouble(this.m_env.xmin)),this.m_hashCode=i.hashCombine(this.m_hashCode,i.hashDouble(this.m_env.xmax)),this.m_hashCode=i.hashCombine(this.m_hashCode,i.hashDouble(this.m_env.ymin)),this.m_hashCode=i.hashCombine(this.m_hashCode,i.hashDouble(this.m_env.ymax))))}getHashCode(){return this.m_hashCode}equals(e){return!(this.m_inputSR&&!e.m_inputSR||!this.m_inputSR&&e.m_inputSR)&&this.m_env.equals(e.m_env)&&this.m_inputSR.equals(e.m_inputSR)&&this.m_outputSR.equals(e.m_outputSR)}clear(){this.m_inputSR=void 0,this.m_outputSR=void 0,this.m_hashCode=-1,this.m_env=void 0}}const hi=new Map;let gi,ui,ci;function pi(){return gi||(gi=Qr(Qi(),$i())),gi}const di=new Map;function _i(e){const t=mo(e),s=e.getCode();if(s>0){const e=fi(s);if(e)return e}const n=e.getName();let r=oi.get(n);if(r){const t=r.deref();if(t&&t.m_peCoordSys.isEqual(e))return t}const i=new Wr(t.release());if(s>0)return i.setCached(),ii.set(s,new WeakRef(i)),oi.set(n,new WeakRef(i)),i;const o=nr(e,0,!1);if(r=ai.get(o),r){const e=r.deref();if(e)return e}return i.setCached(),ai.set(o,new WeakRef(i)),i}function fi(e){const t=ii.get(e);if(t)return t.deref()}class yi extends c{constructor(t){return void 0===t?(super(),this.m_wkid=9001,void(this.m_peUnit=null)):"number"==typeof t?(super(),this.m_factor=t,void(this.m_wkid=0)):(super(t),void(t||(this.m_factor=1,this.m_wkid=9001,this.m_peUnit=(ci||(ci=e.peFactory.unit(9001)),ci))))}getUnitType(){return 0}convertFromMeters(e){return e/this.getUnitToBaseFactor()}convertToMeters(e){return e*this.getUnitToBaseFactor()}}const xi=["0","1","2","3","4","5","6","7","8","9","b","c","d","e","f","g","h","j","k","m","n","p","q","r","s","t","u","v","w","x","y","z"];function Pi(e,t,n,r,i){s.geometryReleaseAssert(r>>5<i.length);let o=t,a=n;for(let t=r;t>=0;t-=2){const s=31&t,n=.5*(a+o);e>=n?(i[t>>5]|=1<<s,o=n):a=n}}let Ei=new Set;const Si=2147483645n,Ci=9007199254740990n,Ii="operation is not supported for unknown coordinate systems";var vi;function Ti(){return{majorSemiAxis:0,e2:0,minorSemiAxis:0,flattening:0,isSphere(){return 0===this.e2}}}function Di(e){po=e,s.geometryReleaseAssert(po)}function wi(){return!!e.peFactory}function bi(){return!!po}function Gi(){return!!e.peFactory||!!po}function Ni(e,t,n){return s.geometryReleaseAssert(Gi()),no(e,void 0===t?0:t,0,!1)}function Hi(t,n){s.geometryReleaseAssert(Gi());const r=new ji;let i;return wi()?(i=function(t){const n=mo(e.peFactory.fromString(e.peDefs.PE_TYPE_COORDSYS,t));return n.get()||s.throwInvalidWktException(t),mi(n.release())}(t),r.setHorzProj_(i),r.m_vertcs=null,r.m_userWKID=i.getLatestID()):(i=_o(t),r.m_unit=i.isPCS?new yi(i.metersOrRadiansPerUnit):new d(i.metersOrRadiansPerUnit)),eo(r.m_precisionDescriptor,i,null,1),r.m_bDefaultDescriptor=!0,r.m_userWKT=t,r.calculateHashCode(),r.initDbgName(),r}function Ai(e,t,n,r,i=!0){let o=null;return t&&(s.geometryReleaseAssert(0),o={}),function(e,t,n,r,i){e||s.throwInvalidArgumentException("!PE_coord_sys");const o=new ji;let a;return a=i?mi(e):new Wr(e,!1),eo(o.m_precisionDescriptor,a,t,r),o.m_bDefaultDescriptor=!0,o.setHorzProj_(a),o.m_vertcs=t,o.m_userWKID=a.getLatestID(),o.calculateHashCode(),o.initDbgName(),o}(e,o,0,r,i)}function Fi(e,t,n=!1){3===e.getCoordinateSystemType()&&s.throwInvalidArgumentException("image spatial reference cannot be altered");const r=new ji,i=e;return r.m_peCoordSysVal=i.m_peCoordSysVal,r.m_vertcs=i.m_vertcs,r.m_unit=i.m_unit,r.m_precisionDescriptor.assign(t),r.m_localZToXYFactor=i.m_localZToXYFactor,(Number.isNaN(r.m_precisionDescriptor.m_falseX)||Number.isNaN(r.m_precisionDescriptor.m_falseY))&&(r.m_precisionDescriptor.m_falseX=i.m_precisionDescriptor.m_falseX,r.m_precisionDescriptor.m_falseY=i.m_precisionDescriptor.m_falseY),r.m_precisionDescriptor.snapPrecision(),r.m_precisionDescriptor.fixTolerance(),r.m_userWKID=i.m_userWKID,r.m_precisionDescriptor.equals(i.m_precisionDescriptor)?r.m_bDefaultDescriptor=i.m_bDefaultDescriptor:r.m_bDefaultDescriptor=!1,n&&(r.m_bDefaultDescriptor=!0),r.calculateHashCode(),r.initDbgName(),r}function Vi(e,t,n){void 0===t&&(t=1),(t<=0||!Number.isFinite(t))&&s.throwInvalidArgumentException(""),e||1===t||s.throwInvalidArgumentException("null Unit has to have z_to_xy_factor equal to 1");const r=new ji;r.m_unit=e;const i=e||new yi(9001);return so(r.m_precisionDescriptor,i,null,1),r.m_bDefaultDescriptor=!0,Number.isNaN(r.m_precisionDescriptor.m_falseX)&&s.throwInvalidArgumentException("NAN false X/Y are not allowed here"),r.m_localZToXYFactor=t,r.calculateHashCode(),r.initDbgName(),r}function Ri(e,t){return e.snapGeometry(t)}function ki(e){const t=e.getCoordinateSystemType();return 1===t?e:(3===t&&s.geometryReleaseAssert(0),e.getGCS())}function Mi(t){return s.geometryReleaseAssert(Gi()),bi()?function(t){return s.geometryReleaseAssert(bi()),!!po(t).isPCS||(n=t,e.peFactory&&s.throwInvalidCallException("pe has been loaded. no-pe methods should not be used at this point."),io||yo(),io.has(n));var n}(t):function(t){if(di.has(t))return di.get(t);{const s=function(t){return null!==mo(e.peFactory.coordsys(t)).get()}(t);return di.set(t,s),s}}(t)}function Ui(t){if(wi())return null!==mo(e.peFactory.fromString(e.peDefs.PE_TYPE_COORDSYS,t)).get();try{return _o(t),!0}catch(e){}return!1}let Oi;function Bi(){return Oi||(Oi=(()=>{const e=Math.trunc(Math.random()*i.intMax()),t=Date.now();return`|abba_000|${e.toString(16)}|${t.toString(16)}|`})()),Oi}!function(e){e[e.utmDefault=0]="utmDefault",e[e.utmNorthSouth=1]="utmNorthSouth"}(vi||(vi={}));let qi=0;function Yi(e=""){let t=`${Bi()}${qi++}`;return""!==e&&(t+=`|${e}`),t}function Xi(e){return e.startsWith(Bi())}let Li,zi,Wi,ji=class t{destroy(){var e;e=this.m_peCoordSysVal,oi.delete(e.m_peCoordSys.getName()),ai.delete(nr(e.m_peCoordSys,0,!1)),1===this.getCoordinateSystemType()||2===this.getCoordinateSystemType()?this.getPECoordSys().destroy():s.throwInternalErrorException("SpatialReference.destroy")}constructor(){this.m_vertcs=null,this.m_peCoordSysVal=null,this.m_userWKID=0,this.m_userWKT=null,this.m_geogSpatialReference=null,this.m_srToGcs=null,this.m_gcsToSr=null,this.m_defaultPrecisionSR=null,this.m_localZToXYFactor=-1,this.m_precisionDescriptor=new Zi,this.m_hashCode=0,this.m_bDefaultDescriptor=!1,Ji(this.m_precisionDescriptor),Ei&&Ei.add(new WeakRef(this))}attachToPe(){(this.m_userWKID>0?Ni(this.m_userWKID):Hi(this.m_userWKT)).copyTo(this,!1)}copyTo(e,t=!0){(t||e.m_bDefaultDescriptor)&&(e.m_bDefaultDescriptor=this.m_bDefaultDescriptor,e.m_precisionDescriptor.assign(this.m_precisionDescriptor)),e.m_defaultPrecisionSR=null,e.m_gcsToSr=this.m_gcsToSr,e.m_geogSpatialReference=this.m_geogSpatialReference,e.m_hashCode=this.m_hashCode,e.m_localZToXYFactor=this.m_localZToXYFactor,e.m_peCoordSysVal=this.m_peCoordSysVal,e.m_srToGcs=this.m_srToGcs,e.m_userWKID=this.m_userWKID,e.m_userWKT=this.m_userWKT,e.m_vertcs=this.m_vertcs,e.m_unit=this.m_unit}getHashCode(){return this.m_hashCode}getHashCodeHorizontal(){let e=0;return e=this.m_peCoordSysVal?this.m_peCoordSysVal.getHashCode():this.m_unit?this.m_unit.getHashCode():305419891,e}updateTransform(e){if(1===this.getCoordinateSystemType())return Qr(this,this,null);let t=e?this.m_srToGcs:this.m_gcsToSr;if(t)return t;const s=this.getGCS();t=e?Qr(this,s,null):Qr(s,this,null);const n=t;return(e?this.m_srToGcs:this.m_gcsToSr)||(e?this.m_srToGcs=n:this.m_gcsToSr=n,t)}getHashCodeVertical(){return this.m_vertcs?this.m_vertcs.getHashCode():0}calculateHashCode(){let e=this.getHashCodeHorizontal();const t=this.getHashCodeVertical(),s=this.m_precisionDescriptor.getHashCode();e=i.hashCombine(e,t),this.m_hashCode=i.hashCombine(e,s)}initDbgName(){}setHorzProj_(e){this.m_peCoordSysVal=e,this.m_unit=this.m_peCoordSysVal.getUnit()}getTolerance(e=0){return this.m_precisionDescriptor.getTolerance(e)}getResolution(e=0){return this.m_precisionDescriptor.getResolution(e)}getPECoordSys(){return this.m_peCoordSysVal?this.m_peCoordSysVal.m_peCoordSys:null}getPCSInfo(){return this.throwIfNotGCSOrPCS(),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getPCSInfo()}getCentralMeridian(){return this.throwIfNotGCSOrPCS(),1===this.getCoordinateSystemType()?0:this.getPCSInfo().getCentralMeridian()}getCoordinateSystemType(){const t=this.getPECoordSys();if(t)switch(t.getType()){case e.peDefs.PE_TYPE_GEOGCS:return 1;case e.peDefs.PE_TYPE_PROJCS:return 2;default:return 0}else{if((this.m_userWKID>0||this.m_userWKT)&&this.m_unit instanceof yi)return 2;if(this.m_unit instanceof d)return 1}return 0}getID(){return this.m_userWKID}getLatestID(){return this.m_peCoordSysVal?this.m_peCoordSysVal.getLatestID():this.m_userWKID}getOldID(){return this.m_peCoordSysVal?this.m_peCoordSysVal.getOldID():this.m_userWKID}getVerticalID(){return s.throwNotImplementedException("vcs not implemented"),0}getLatestVerticalID(){return this.m_vertcs?this.m_vertcs.getLatestID():0}getOldVerticalID(){return s.throwNotImplementedException("vcs not implemented"),0}getPEVerticalCoordSys(){return null}getPole(e){return this.throwIfNotGCSOrPCS(),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getPole(e)}getText(){const e=this.getPECoordSys();return e?rr(e):this.m_userWKT??""}getTextExtended(e){const t=this.getPECoordSys();return t?this.getPEVerticalCoordSys()?(this.getPEVerticalCoordSys(),s.geometryReleaseAssert(0),""):rr(t,e):this.m_userWKT??""}getText2(t=-1){const n=this.getPECoordSys();return n?function(t,n){(n>1||n<-1)&&s.throwInvalidArgumentException("verbosity");let r=e.peDefs.PE_STR_FMT_WKT2;return-1!==n&&(r|=0===n?e.peDefs.PE_STR_AUTH_TOP:e.peDefs.PE_STR_AUTH_ALL),t.toString(r)}(n,t):this.m_userWKT??""}getUnit(){return this.m_unit}getUnitsPerMillimeter(){return this.m_peCoordSysVal?this.m_peCoordSysVal.getUnitsPerMillimeter():this.m_unit instanceof yi?.001/this.m_unit.getUnitToBaseFactor():this.m_unit instanceof d?.001/(_o(this.m_userWKT??this.m_userWKID).semiMajor*this.m_unit.getUnitToBaseFactor()):(s.throwInvalidCallException("sr object not in valid state"),0)}getAuthorityName(){return this.getPECoordSys()?(s.geometryReleaseAssert(0),""):""}getVerticalUnit(){return s.throwNotImplementedException("vcs not implemented"),{}}getVCS(){return this.m_vertcs}hasVCS(){return!1}getGCSHorisonIsInclusive(){return this.throwIfNotGCSOrPCS(),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getGCSHorisonIsInclusive()}getGCSHorizon(){return this.throwIfNotGCSOrPCS(),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getGCSHorizon()}getGCS(){const e=this.getCoordinateSystemType();if(0===e)s.throwInvalidCallException(Ii);else{if(1===e)return this;3===e&&s.throwInvalidCallException("image cs not supported")}if(this.m_geogSpatialReference)return this.m_geogSpatialReference;let t;if(this===Qi()||this===Ki())t=$i();else{s.geometryReleaseAssert(this.m_peCoordSysVal);const e=this.m_peCoordSysVal.m_peCoordSys.getGeogcs();e||s.throwInternalErrorException(""),t=Ai(e,this.m_vertcs,0,this.m_precisionDescriptor.getPrecision(),this.m_peCoordSysVal.getCached())}return this.m_geogSpatialReference?t=this.m_geogSpatialReference:this.m_geogSpatialReference=t,t}getGCSSplitLines(){return this.throwIfNotGCSOrPCS(),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getGCSSplitLines()}toGCS(e,t){if(0===e.length)return 0;e.length>t.length&&s.throwInvalidArgumentException("coordsSrc.size() > coordsDst.size()");const n=this.getCoordinateSystemType();if(0===n&&s.throwInvalidCallException(Ii),1===n)return i.assignObjectArray(t,e,e.length),e.length;s.geometryReleaseAssert(this.m_peCoordSysVal);const r=this.getSRToGCSTransform();return(new nn).transform(r,e,e.length,t)}toGeohash(e,t=8){const s=e.clone();s.scale(9102===this.getGCS().getUnit().getID()?1:this.getGCS().getUnit().getUnitToBaseFactor()/Math.PI*180),s.x<-180?(s.x=i.fmod(s.x,360),s.x<-180&&(s.x+=360)):s.x>180&&(s.x=i.fmod(s.x,360),s.x>180&&(s.x-=360)),s.y>90&&(s.y=90),s.y<-90&&(s.y=-90);const n=5*t,r=new Uint32Array(4);return Pi(s.x,-180,180,n-1,r),Pi(s.y,-90,90,n-2,r),function(e,t,s){const n=i.makePrimitiveArray(t,"R");let r=0,o=0;for(let s=0;s<t;s++){let i=e[r]>>o&31;if(o+=5,o>31){const t=37-o;i&=(1<<t)-1,o-=32,r++,i|=(e[r]&(1<<o)-1)<<t}const a=xi[i];n[t-1-s]=a}return s>t?n.push(..."0".repeat(s-t)):s<t&&(n.length=s),n.join("")}(r,t,t)}isPannable(){const e=this.getCoordinateSystemType();return 0!==e&&3!==e&&(s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.isPannable())}getPannableExtent(){return this.isPannable()||s.throwInvalidArgumentException("!is_pannable"),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getPannableExtent()}getPannableExtentInGCS(){return this.isPannable()||s.throwInvalidArgumentException("!is_pannable"),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getPannableExtentGCS()}throwIfNotGCSOrPCS(){const e=this.getCoordinateSystemType();1!==e&&2!==e&&s.throwInvalidArgumentException("Not a GCS or PCS")}getDomainXY(){return this.throwIfNotGCSOrPCS(),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getDomainXY()}getFullWorldExtent(){return this.throwIfNotGCSOrPCS(),this.isPannable()?this.getPannableExtent():this.getDomainXY()}queryPrecisionDescriptor(e){if(e.assign(this.m_precisionDescriptor),Number.isNaN(e.m_falseX))if(wi()||s.throwProjectionEngineNotLoadedException("cannot query precision descriptor"),s.geometryReleaseAssert(null!==this.m_peCoordSysVal),2!==this.m_precisionDescriptor.m_precision){const t=this.m_peCoordSysVal.getDomainXY();e.m_falseX=t.xmin,e.m_falseY=t.ymin}else e.m_falseX=-Number.MAX_VALUE,e.m_falseY=-Number.MAX_VALUE}queryPrecisionDescriptorWithoutFalseXY(e){e.assign(this.m_precisionDescriptor),e.m_falseX=Number.NaN,e.m_falseY=Number.NaN}queryDefaultPrecisionDescriptorWithoutFalseXY(e){if(this.m_bDefaultDescriptor)e.assign(this.m_precisionDescriptor);else{const t=this.getCoordinateSystemType();0===t?so(e,this.m_unit,this.m_vertcs,this.m_precisionDescriptor.getPrecision()):3===t?s.throwNotImplementedException("image cs"):eo(e,this.m_peCoordSysVal,this.m_vertcs,this.m_precisionDescriptor.getPrecision())}e.m_falseX=Number.NaN,e.m_falseY=Number.NaN}horizontalEqual(e){return(t=this.m_peCoordSysVal)===(s=e.m_peCoordSysVal)||null!==t&&null!==s&&t.m_csType===s.m_csType&&(0===t.m_WKID&&0===s.m_WKID?t.m_hashCode===s.m_hashCode&&t.m_canonicalWkt===s.m_canonicalWkt:t.m_WKID===s.m_WKID);var t,s}verticalEqual(e){return null!==this.m_vertcs==(null!==e.m_vertcs)&&(!this.m_vertcs||this.m_vertcs.equals(e.m_vertcs))}equals(e){const t=e;if(this===t)return!0;if(!this.horizontalEqual(t)||!this.verticalEqual(t))return!1;if(!t.m_peCoordSysVal){if(s.geometryReleaseAssert(!this.m_peCoordSysVal),null!==this.m_unit!=(null!==t.m_unit))return!1;if(this.m_unit&&!this.m_unit.equals(t.m_unit))return!1;if(this.m_localZToXYFactor!==t.m_localZToXYFactor)return!1}if(!this.m_bDefaultDescriptor||!t.m_bDefaultDescriptor){if(this.m_peCoordSysVal){if(!this.m_precisionDescriptor.equalsWithoutFalseXY(t.m_precisionDescriptor))return!1;s.geometryReleaseAssert(t.m_peCoordSysVal);let e=this.m_precisionDescriptor.m_falseX,n=this.m_precisionDescriptor.m_falseY;if(Number.isNaN(e)){const t=this.m_peCoordSysVal.getDomainXY();e=t.xmin,n=t.ymin}let r=t.m_precisionDescriptor.m_falseX,i=t.m_precisionDescriptor.m_falseY;if(Number.isNaN(r)){const e=t.m_peCoordSysVal.getDomainXY();r=e.xmin,i=e.ymin}return e===r&&n===i}return this.m_precisionDescriptor.equals(t.m_precisionDescriptor)}return!0}equalForProjection(e,t){if(this===e)return!0;const s=this.getCoordinateSystemType(),n=e.getCoordinateSystemType();if(0===s||0===n)return 0===s&&0===n?(!t||this.getZToXYFactor()===e.getZToXYFactor())&&(!this.getUnit()||!e.getUnit()||this.getUnit().equals(e.getUnit())):3!==s&&3!==n&&(null===this.getUnit()||null===e.getUnit()||(!t||this.getZToXYFactor()===e.getZToXYFactor())&&this.getUnit().equals(e.getUnit()));if(s!==n)return!1;if(3===s)return this.equals(e);if((r=this.m_peCoordSysVal)===(i=e.m_peCoordSysVal)||null!==r&&null!==i&&r.m_csType===i.m_csType&&(0===r.m_WKID&&0===i.m_WKID?1===r.m_csType?r.m_peCoordSys.isEqual(i.m_peCoordSys):r.m_peCoordSys===i.m_peCoordSys:r.m_WKID===i.m_WKID)){if(!t)return!0;if(null!==this.m_vertcs==(null!==e.m_vertcs))return!this.m_vertcs||this.m_vertcs.equalForProjection(e.m_vertcs)}var r,i;return!1}equalHorizontal(e){return this.horizontalEqual(e)}equalVertical(e){return s.geometryReleaseAssert(0),!1}equalVerticalVCS(e){return s.geometryReleaseAssert(0),!1}convergenceAngle(e){return s.geometryReleaseAssert(0),0}getPeCoordsysCopy(){if(this.m_peCoordSysVal){const e=this.m_peCoordSysVal.m_peCoordSys;return e||s.throwInternalErrorException("cannot clone coord sys"),e}return null}getPeVertcsCopy(){return s.geometryReleaseAssert(0),0}throwIfLocal(){0===this.getCoordinateSystemType()&&s.throwInvalidArgumentException(Ii)}getPrimeMeridian(){return this.throwIfLocal(),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getPrimeMeridian()}getSRToGCSTransform(){return this.updateTransform(!0)}getGCSToSRTransform(){return this.updateTransform(!1)}getOneMeter(){return 1e3*this.getUnitsPerMillimeter()}getOneMeterPCSUnit(){return this.throwIfNotGCSOrPCS(),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getOneMeterPCSUnit()}getDefaultPrecisionSR(){if(this.m_bDefaultDescriptor)return this;if(null===this.m_defaultPrecisionSR){const e=new Zi;this.queryDefaultPrecisionDescriptorWithoutFalseXY(e),this.m_defaultPrecisionSR=Fi(this,e,!0)}return this.m_defaultPrecisionSR}getPCSHorizon(){return this.throwIfNotGCSOrPCS(),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getPCSHorizon()}getHorzUnitFactor(){return this.m_unit?this.m_unit.getUnitToBaseFactor():1}querySpheroidData(e){this.throwIfNotGCSOrPCS(),s.geometryReleaseAssert(this.m_peCoordSysVal);const t=this.getGCS().getPECoordSys().getDatum().getSpheroid(),n=t.getFlattening();var r,i,o;i=t.getAxis(),o=n,(r=e).majorSemiAxis=i,r.minorSemiAxis=i*(1-o),r.e2=o*(2-o),r.flattening=o}getAreaOfUse(){0===this.getCoordinateSystemType()&&s.throwInvalidCallException(""),s.geometryReleaseAssert(this.m_peCoordSysVal);const e=this.m_peCoordSysVal.getAreaOfUse();return null===e?new u:new u({geom:e.clone(),sr:Ni(4326)})}getZToXYFactor(){return 1}isCustomWkid(){return!1}getOneDegreeGCSUnit(){return this.throwIfNotGCSOrPCS(),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getOneDegreeGCSUnit()}getGcsUnitFactor(){return this.throwIfNotGCSOrPCS(),s.geometryReleaseAssert(this.m_peCoordSysVal),this.m_peCoordSysVal.getGcsUnitFactor()}snapGeometry(e){if(e.isEmpty())return!1;if(2===this.m_precisionDescriptor.getPrecision())return!1;const t=e.getGeometryType();if(s.isMultiVertex(t))return this.snapMultiVertex_(e);if(t===s.GeometryType.enumPoint)return this.snapPoint_(e);if(t===s.GeometryType.enumEnvelope)return this.snapEnvelope_(e);if(s.isSegment(t))return this.snapSegment_(e);if(t===s.GeometryType.enumGeometryCollection){const t=e;let s=!1;for(let e=0,n=t.getGeometryCount();e<n;++e)s=this.snapGeometry(t.getGeometry(e))||s;return s}s.throwInternalErrorException("what else?")}snapMultiVertex_(e){if(s.geometryReleaseAssert(!e.isEmpty()),s.geometryReleaseAssert(2!==this.m_precisionDescriptor.getPrecision()),s.isMultiPath(e.getGeometryType())){const t=e;if(t.hasNonLinearSegments())return this.snapGeometryWithCurves_(t)}const t=e.getImpl(),n=t.getDescription();let r=!1;for(let e=0,s=n.getAttributeCount();e<s;e++){const s=n.getSemantics(e),i=t.getAttributeStreamRef(s);r=this.snapAttributes(s,i,0,t.getPointCount())||r}return r&&t.notifyModifiedFlags(2001),r}snapPoint_(e){return!1}snapEnvelope_(e){return!1}snapSegment_(e){s.geometryReleaseAssert(!e.isEmpty()),s.geometryReleaseAssert(2!==this.m_precisionDescriptor.getPrecision());const t=new Zi;this.queryPrecisionDescriptor(t);const n=e.getStartXY(),r=new i.Point2D;r.x=ro(n.x,t.getFalseX(),t.getGridUnitsXY()),r.y=ro(n.y,t.getFalseY(),t.getGridUnitsXY());let o=!r.equals(n);const a=e.getEndXY(),m=new i.Point2D;m.x=ro(a.x,t.getFalseX(),t.getGridUnitsXY()),m.y=ro(a.y,t.getFalseY(),t.getGridUnitsXY()),o||=!m.equals(a),o&&e.changeEndPoints2D(r,m);const l=(t,s,n)=>{let r=!1;{const o=e.getStartAttributeAsDbl(t,0),a=ro(o,s,n),m=!i.isEqualNonIEEE(a,o);r||=m,m&&e.setStartAttribute(t,0,a)}{const o=e.getEndAttributeAsDbl(t,0),a=ro(o,s,n),m=!i.isEqualNonIEEE(a,o);r||=m,m&&e.setEndAttribute(t,0,a)}return r};let h=o?1:0;return e.hasAttribute(1)&&(h|=l(1,t.getFalseZ(),t.getGridUnitsZ())?1:0),e.hasAttribute(2)&&(h|=l(2,t.getFalseM(),t.getGridUnitsM())?1:0),!!h}snapGeometryWithCurves_(e){s.geometryReleaseAssert(!e.isEmpty()),s.geometryReleaseAssert(2!==this.m_precisionDescriptor.getPrecision());const t=e.createInstance(),i=new n.SegmentBuffer;let o=0;for(let s=0,n=e.getPathCount();s<n;++s){const n=e.getSegmentCountPath(s);if(0===n){if(t.addPath(e,s,!0),1===t.getPathSize(s)){const e=new r.Point;t.getPointByVal(t.getPointCount()-1,e),o|=this.snapGeometry(e)?1:0,t.setPointByVal(t.getPointCount()-1,e)}continue}const a=e.isClosedPath(s);for(let r=0,m=a?n-1:n;r<m;++r)e.getSegmentFromPath(s,r,i,!1),o|=this.snapGeometry(i.get())?1:0,t.addSegment(i.get(),0===r);a&&(e.getSegmentFromPath(s,n-1,i,!1),o|=this.snapGeometry(i.get())?1:0,1===n?t.addPathFromClosedSegment(i.get(),!1):t.closeLastPathWithSegment(i.get()))}return o&&t.copyTo(e),!!o}snapAttributes(e,s,n,r){let o=!1;const a=new Zi;if(this.queryPrecisionDescriptor(a),0===e){const e=s;for(let s=n;s<r;s++){const n=e.read(2*s),r=t.s_SnapValue(n,a.getFalseX(),a.getGridUnitsXY()),i=e.read(2*s+1),m=t.s_SnapValue(i,a.getFalseY(),a.getGridUnitsXY());o=o||r!==n||m!==i,o&&(e.write(2*s,r),e.write(2*s+1,m))}}else if(1===e){const e=s;for(let s=n;s<r;s++){const n=e.read(s),r=t.s_SnapValue(n,a.getFalseZ(),a.getGridUnitsZ());o=o||!i.isEqualNonIEEE(r,n),o&&e.write(s,r)}}else if(2===e){const e=s;for(let s=n;s<r;s++){const n=e.read(s),r=t.s_SnapValue(n,a.getFalseM(),a.getGridUnitsM());o=o||!i.isEqualNonIEEE(r,n),o&&e.write(s,r)}}return o}static s_SnapValue(e,t,s){return i.round((e-t)*s)/s+t}};class Zi{constructor(){const e=Ci,t=.001,s=1e-4*Number(e)*.5;this.m_precision=1,this.m_falseX=-s,this.m_falseY=-s,this.m_unitsXY=Number(e)/(2*s),this.m_falseM=-1e5,this.m_unitsM=1e4,this.m_falseZ=-1e5,this.m_unitsZ=1e4,this.m_toleranceXY=t,this.m_toleranceM=t,this.m_toleranceZ=t}getHashCode(){let e=7777,t=7777;return t=i.hashCombine(t,this.m_falseM),t=i.hashCombine(t,this.m_unitsM),e=i.hashCombine(e,this.m_unitsXY),t=i.hashCombine(t,this.m_toleranceXY),e=i.hashCombine(e,this.m_falseZ),t=i.hashCombine(t,this.m_toleranceZ),e=i.hashCombine(e,this.m_unitsZ),t=i.hashCombine(t,this.m_toleranceM),e=i.hashCombine(e,this.m_precision),i.hashCombine(e,t)}clone(){const e=new Zi;return e.m_falseX=this.m_falseX,e.m_falseY=this.m_falseY,e.m_unitsXY=this.m_unitsXY,e.m_falseZ=this.m_falseZ,e.m_unitsZ=this.m_unitsZ,e.m_falseM=this.m_falseM,e.m_unitsM=this.m_unitsM,e.m_toleranceXY=this.m_toleranceXY,e.m_toleranceZ=this.m_toleranceZ,e.m_toleranceM=this.m_toleranceM,e.m_precision=this.m_precision,e}assign(e){return this.m_falseX=e.m_falseX,this.m_falseY=e.m_falseY,this.m_unitsXY=e.m_unitsXY,this.m_falseZ=e.m_falseZ,this.m_unitsZ=e.m_unitsZ,this.m_falseM=e.m_falseM,this.m_unitsM=e.m_unitsM,this.m_toleranceXY=e.m_toleranceXY,this.m_toleranceZ=e.m_toleranceZ,this.m_toleranceM=e.m_toleranceM,this.m_precision=e.m_precision,this}initialize2D(e,t){}getTolerance(e){switch(e){case 0:return this.m_toleranceXY;case 1:return this.m_toleranceZ;case 2:return this.m_toleranceM;default:return 0}}getResolution(e){if(2===this.m_precision)return 0;switch(e){case 0:return 1/this.m_unitsXY;case 1:return 1/this.m_unitsZ;case 2:return 1/this.m_unitsM;default:return 0}}getFalseX(){return this.m_falseX}getFalseY(){return this.m_falseY}getFalseZ(){return this.m_falseZ}getFalseM(){return this.m_falseM}getGridUnitsXY(){return this.m_unitsXY}getGridUnitsZ(){return this.m_unitsZ}getGridUnitsM(){return this.m_unitsM}getPrecision(){return this.m_precision}static getLimit32(){return 2147483645}static getLimit64(){return 9007199254740990n}static getLimitFloat(){return 0}getXYGridRange(){const e=new t.Envelope2D;switch(this.m_precision){case 0:{const t=Zi.getLimit32()/this.getGridUnitsXY();e.setCoords({xmin:this.getFalseX(),ymin:this.getFalseY(),xmax:this.getFalseX()+t,ymax:this.getFalseY()+t})}break;case 1:{const t=Number(Zi.getLimit64())/this.getGridUnitsXY();e.setCoords({xmin:this.getFalseX(),ymin:this.getFalseY(),xmax:this.getFalseX()+t,ymax:this.getFalseY()+t})}break;case 2:e.setCoords({xmin:-Number.MAX_VALUE,ymin:-Number.MAX_VALUE,xmax:Number.MAX_VALUE,ymax:Number.MAX_VALUE});break;default:e.setEmpty(),s.throwInternalErrorException("")}return e}getZGridRange(){const e=new i.Envelope1D;switch(this.m_precision){case 0:{const t=Zi.getLimit32()/this.getGridUnitsZ();e.setCoords(this.getFalseZ(),this.getFalseZ()+t)}break;case 1:{const t=Number(Zi.getLimit64())/this.getGridUnitsZ();e.setCoords(this.getFalseZ(),this.getFalseZ()+t)}break;case 2:e.setCoords(-Number.MAX_VALUE,Number.MAX_VALUE);break;default:e.setEmpty(),s.throwInternalErrorException("")}return e}getMGridRange(){const e=new i.Envelope1D;switch(this.m_precision){case 0:{const t=Zi.getLimit32()/this.getGridUnitsM();e.setCoords(this.getFalseM(),this.getFalseM()+t)}break;case 1:{const t=Number(Zi.getLimit64())/this.getGridUnitsM();e.setCoords(this.getFalseM(),this.getFalseM()+t)}break;case 2:e.setCoords(-Number.MAX_VALUE,Number.MAX_VALUE);break;default:e.setEmpty(),s.throwInternalErrorException("")}return e}setTolerance(e,t){switch(t<0&&s.throwInvalidArgumentException("tol < 0"),Number.isFinite(t)||s.throwInvalidArgumentException("tol is not finite"),e){case 0:this.m_toleranceXY=t;break;case 1:this.m_toleranceZ=t;break;case 2:this.m_toleranceM=t;break;default:s.throwInvalidArgumentException("cannot set tolerance for this attribute")}}setGridParams(e,t,n){Number.isFinite(e)&&Number.isFinite(t)&&Number.isFinite(n)||s.throwInvalidArgumentException("grid params are not finite"),n<1&&s.throwInvalidArgumentException("grid units cannot be smaller than 1.0"),this.m_falseX=e,this.m_falseY=t,this.m_unitsXY=n}setZParams(e,t){Number.isFinite(e)&&Number.isFinite(t)||s.throwInvalidArgumentException("grid params are not finite"),t<1&&s.throwInvalidArgumentException("grid units cannot be smaller than 1.0"),this.m_falseZ=e,this.m_unitsZ=t}setMParams(e,t){Number.isFinite(e)&&Number.isFinite(t)||s.throwInvalidArgumentException("grid params are not finite"),t<1&&s.throwInvalidArgumentException("grid units cannot be smaller than 1.0"),this.m_falseM=e,this.m_unitsM=t}setPrecision(e){}equals(e){return this===e||i.isEqualNonIEEE(this.m_falseX,e.m_falseX)&&i.isEqualNonIEEE(this.m_falseY,e.m_falseY)&&this.equalsWithoutFalseXY(e)}snapPrecision(){if(2===this.m_precision)return;const e=(e,t,s,n)=>{if(!Number.isFinite(t)||!Number.isFinite(s))return s;if(s<1)return 1;if(!n)return s;const r=Number(e)/s;return Math.trunc((t+r-t)*s)>e&&(s=e/(t+r-t)),Math.max(1,s)},t=Number(0===this.m_precision?Si:Ci);this.m_unitsXY=e(t,this.m_falseX,this.m_unitsXY,!0),this.m_unitsXY=e(t,this.m_falseY,this.m_unitsXY,!0),this.m_unitsZ=e(t,this.m_falseZ,this.m_unitsZ,!1),this.m_unitsM=e(t,this.m_falseM,this.m_unitsM,!1)}verifyPrecision(){if(2===this.m_precision)return!0;const e=(e,t,s,n)=>{if(s<1)return!1;if(!Number.isFinite(t)||!Number.isFinite(s))return!1;if(!n)return!0;const r=Number(e)/s;return!(BigInt((t+r-t)*s)>e)},t=0===this.m_precision?Si:Ci;return!!(e(t,this.m_falseX,this.m_unitsXY,!0)&&e(t,this.m_falseY,this.m_unitsXY,!0)&&e(t,this.m_falseZ,this.m_unitsZ,!1)&&e(t,this.m_falseM,this.m_unitsM,!1))}fixTolerance(){2!==this.m_precision&&(this.m_toleranceXY=Math.max(2/this.m_unitsXY,this.m_toleranceXY),this.m_toleranceZ=Math.max(2/this.m_unitsZ,this.m_toleranceZ),this.m_toleranceM=Math.max(2/this.m_unitsM,this.m_toleranceM),(Number.isNaN(this.m_falseX)||Number.isNaN(this.m_falseY))&&(this.m_falseX=this.m_falseY=Number.NaN))}equalsWithoutFalseXY(e){return this===e||this.m_unitsXY===e.m_unitsXY&&this.m_falseZ===e.m_falseZ&&this.m_unitsZ===e.m_unitsZ&&this.m_falseM===e.m_falseM&&this.m_unitsM===e.m_unitsM&&this.m_toleranceXY===e.m_toleranceXY&&this.m_toleranceZ===e.m_toleranceZ&&this.m_toleranceM===e.m_toleranceM&&this.m_precision===e.m_precision}setBestXyDomainFromEnvelope(e,t){}setBestZDomainFromZRange(e,t,s){}setBestMDomainFromMRange(e,t,s){}}function Qi(){return(!Li||wi()&&null===Li.getPECoordSys())&&(Li=no(3857,0,0,!0)),Li}function Ki(){return(!zi||wi()&&null===zi.getPECoordSys())&&(zi=no(102100,0,0,!0)),zi}function $i(){return(!Wi||wi()&&null===Wi.getPECoordSys())&&(Wi=no(4326,0,0,!0)),Wi}function Ji(e){e.m_falseX=0,e.m_falseY=0,e.m_unitsXY=1,e.m_falseZ=0,e.m_unitsZ=1,e.m_falseM=0,e.m_unitsM=1,e.m_toleranceXY=100*i.doubleEps(),e.m_toleranceZ=100*i.doubleEps(),e.m_toleranceM=100*i.doubleEps(),e.m_precision=2}function eo(e,t,n,r){const i=t instanceof Wr;Ji(e),e.m_precision=r,e.m_falseX=Number.NaN,e.m_falseY=Number.NaN;const o=1e-4,a=.001,m=i?t.m_csType:t.isPCS?2:1;if(1===m){const s=(0===r?1/18e5:1e-9)*(i?t.getOneDegreeGCSUnit():Math.PI/t.metersOrRadiansPerUnit/180);e.m_unitsXY=1/s}else if(2===m){const s=(0===r?a:o)*(i?t.getOneMeterPCSUnit():1/t.metersOrRadiansPerUnit);e.m_unitsXY=1/s}else s.throwInvalidArgumentException("unrecognized cs type");e.m_falseM=-1e5,e.m_unitsM=1/(0===r?a:o),e.m_unitsM=Math.max(1,e.m_unitsM),e.m_unitsXY=Math.max(1,e.m_unitsXY);let l=0,h=0;0!==r&&1!==r||(l=2/e.m_unitsXY,h=2/e.m_unitsM),e.m_toleranceXY=Math.max(l,i?t.getUnitsPerMillimeter():2===m?.001/t.metersOrRadiansPerUnit:.001/(t.semiMajor*t.metersOrRadiansPerUnit)),e.m_toleranceM=Math.max(a,h),to(e,n)}function to(e,t){const s=1e-4,n=.001;if(e.m_falseZ=-1e5,t){const r=(0===e.m_precision?n:s)*t.getOneMeter();e.m_unitsZ=1/r}else e.m_unitsZ=1/(0===e.m_precision?n:s);e.m_unitsZ=Math.max(1,e.m_unitsZ);let r=0;0!==e.m_precision&&1!==e.m_precision||(r=2/e.m_unitsZ),e.m_toleranceZ=Math.max(t?t.getOneMeter()*n:n,r)}function so(e,t,s,n){Ji(e),e.m_precision=n;const r=0===n?Si:Ci,i=1e-4,o=.001;let a=1,m=1,l=.001;t&&(m=t.getUnitToBaseFactor()),t&&1===t.getUnitType()?(a=400*Math.PI/180,l=8.983152841195215e-9*Math.PI/180/m):(a=(0===n?o:i)*Number(r)*.5,l=o/m),a/=m,e.m_falseX=-a,e.m_falseY=-a,e.m_unitsXY=Number(r)/(2*a),e.m_falseM=-1e5,e.m_unitsM=1/(0===n?o:i),e.m_unitsM=Math.max(1,e.m_unitsM),e.snapPrecision();let h=0,g=0;0!==e.m_precision&&1!==e.m_precision||(g=2/e.m_unitsM,h=2/e.m_unitsXY),e.m_toleranceXY=Math.max(h,l),e.m_toleranceM=Math.max(o,g),to(e,s)}function no(t,n,r,i){if(!i&&n<=0){if(3857===t)return Qi();if(102100===t)return Ki();if(4326===t)return $i()}const o=new ji;let a,m=null;return wi()?(a=function(t){t<=0&&s.throwInvalidWkidException(t);{const e=fi(t);if(e)return e}const n=mo(e.peFactory.coordsys(t));n.get()||s.throwInvalidWkidException(t);const r=_i(n.release());return r.getLatestID()!==t&&ii.set(t,new WeakRef(r)),r}(t),n>0?m=null:n=0,o.setHorzProj_(a),o.m_vertcs=m):(a=_o(t),o.m_unit=a.isPCS?new yi(a.metersOrRadiansPerUnit):new d(a.metersOrRadiansPerUnit)),eo(o.m_precisionDescriptor,a,m,1),o.m_bDefaultDescriptor=!0,o.m_userWKID=t,o.calculateHashCode(),o.initDbgName(),o}function ro(e,t,s){return i.round((e-t)*s)/s+t}let io=null;const oo=3552713678800501e-30;function ao(e,t){return function(e,t,s){return e===t||Math.abs(e-t)<=s*(1+(Math.abs(e)+Math.abs(t))/2)}(e,t,oo)}function mo(e){return{_this:e,get(){return this._this},reset(e){this._this=e},release(){const e=this._this;return this._this=null,e}}}let lo,ho,go,uo,co;e.PeDoubleClass=void 0,e.peFactory=void 0,e.peDefs=void 0,e.peCSTransformations=void 0,e.peLineType=void 0,e.peMath=void 0;let po=null;function _o(t){s.geometryReleaseAssert(po);const n=po(t);return n.semiMajor=n.isPCS?Number.NaN:function(t){if(e.peFactory&&s.throwInvalidCallException("pe has been loaded. no-pe methods should not be used at this point."),"string"==typeof t){const e=t.match(fo);e&&2===e.length||s.throwInvalidArgumentException("bad gcs wkt");const n=Number.parseFloat(e[1]);return Number.isFinite(n)||s.throwInvalidArgumentException("bad gcs wkt"),n}return io||yo(),io.has(t)||s.throwInvalidCallException("gcs wkid not found"),io.get(t)}(t),n}const fo=/(?:ELLIPSOID|SPHEROID)\["(?:\w|[-()])+",(\d+\.\d+)/;function yo(){io=new Map;for(const e in p){const t=Number.parseFloat(e),s=p[e];if(Array.isArray(s))for(const e of s)io.set(e,t);else io.set(s,t)}!function(){for(const e in p)delete p[e]}()}function xo(e,t){return new So(e,t)}const Po=i.hashInt32(0),Eo=i.hashInt32(1);let So=class t{constructor(e,s){if(e instanceof t)return this.m_geogTranWrapper=e.m_geogTranWrapper,this.m_bInverted=s?!e.m_bInverted:e.m_bInverted,void(this.m_hashCode=i.hashCombine(this.m_geogTranWrapper.getHashCode(),this.m_bInverted?Eo:Po));this.m_geogTranWrapper=new Bn(e),this.m_bInverted=s,this.m_hashCode=i.hashCombine(this.m_geogTranWrapper.getHashCode(),this.m_bInverted?Eo:Po)}getID(){return this.m_geogTranWrapper.getLatestId()}getLatestID(){return this.m_geogTranWrapper.getLatestId()}getText(){return this.m_geogTranWrapper.getText()}getTextExtended(t){if(!this.m_geogTranWrapper.getGeogtran())return"";if(-1===t)return this.m_geogTranWrapper.getGeogtran().toString();{const s=0===t?e.peDefs.PE_STR_AUTH_TOP:e.peDefs.PE_STR_AUTH_ALL;return this.m_geogTranWrapper.getGeogtran().toString(s)}}getText2(t=-1){let s=e.peDefs.PE_STR_FMT_WKT2;return-1!==t&&(s|=0===t?e.peDefs.PE_STR_AUTH_TOP:e.peDefs.PE_STR_AUTH_ALL),this.m_geogTranWrapper.getGeogtran().toString(s)}getName(){return this.m_geogTranWrapper&&this.m_geogTranWrapper.getGeogtran()?this.m_geogTranWrapper.getGeogtran().getName():""}getInputSpatialReference(){return this.m_bInverted?this.m_geogTranWrapper.getOutputSr(!1):this.m_geogTranWrapper.getInputSr(!1)}getOutputSpatialReference(){return this.m_bInverted?this.m_geogTranWrapper.getInputSr(!1):this.m_geogTranWrapper.getOutputSr(!1)}getInverse(){return new t(this,!0)}isInverted(){return this.m_bInverted}getHashCode(){return this.m_hashCode}GetPeGeogtran(){return this.m_geogTranWrapper.getGeogtran()}equals(e){const t=e;return t===this||this.m_bInverted===t.m_bInverted&&(this.GetPeGeogtran()===t.GetPeGeogtran()||this.getID()===t.getID()&&!(0===this.getID()&&!this.GetPeGeogtran().isEqual(t.GetPeGeogtran())))}referencesMissingData(){return!!this.m_geogTranWrapper&&!this.m_geogTranWrapper.isUsable()}getWrapper(){return this.m_geogTranWrapper}};function Co(e,t,n,o,a){const m=e.getGCS(),l=t.getGCS(),h=m.getPECoordSys(),g=l.getPECoordSys();let u=null;if(!n.isEmpty()){const t=n.clone();if(!t.isEmpty()&&2===e.getCoordinateSystemType()){let s=new r.Envelope({env2D:t});const n=Qr(e,m,null);s=(new nn).execute(s,n,null),s.queryEnvelope(t)}if(!t.isEmpty()){const e=h.getPrimem().getLongitude(),s=h.getUnit().getUnitFactor();u=new co(t.xmin,t.ymin,t.xmax,t.ymax,e,s)}}let c=o;c>=i.intMax()&&(c=0);const p=[];let d=go.PE_GTLIST_OPTS_COMMON;a||(d&=~go.PE_GTLIST_OPTS_USABLE);for(let e=0;e<2;e++){p.length=0;const e=c,t=go.getGTlist(h,g,2,d,u,e);let n=!1;if(t&&t.length>0)for(let e=0,r=t.length;e<r;e++){const r=Io([t[e]]);if(s.geometryReleaseAssert(r),a&&r.referencesMissingData())n=!0;else if(p.push(r),o>0&&p.length===o)break}if(!n)break;0===c||(c=0)}return u&&u.destroy(),p}function Io(e){s.geometryReleaseAssert(null!==e);const t=new To,n=e[0].getSteps();if(n){const s=e[0].getEntries();for(let e=0;e<n;e++){const n=0!==s[e].getDirection(),r=xo(s[e].getGeogtran(),n);t.add(r)}return t.create()}return null}let vo=class{constructor(e,t,s,n){this.m_bReadOnly=!0,this.m_name="",this.m_fastTrack=-1,this.m_bNameIsSet=!1,this.m_transforms=e,t&&(this.m_name=t,this.m_bNameIsSet=!0),this.m_inputSr=s,this.m_outputSr=n}getType(){return 0}getName(){if(this.m_bNameIsSet)return this.m_name;if(0===this.m_transforms.length)return"";let e="";for(const t of this.m_transforms)e.length>0&&(e+=" + "),t.isInverted()&&(e+="~"),e+=t.getName();return e}count(){return this.m_transforms.length}createInverse(){return this.getInverse()}getHashCode(){let e=1973;for(let t=0;t<this.m_transforms.length;t++)e=i.hashCombine(e,this.m_transforms[t].getHashCode());return e}equals(e){return s.geometryReleaseAssert(0),!1}referencesMissingData(){if(0===this.m_transforms.length)return!1;for(const e of this.m_transforms)if(e.referencesMissingData())return!0;return!1}isMatchingTransformation(e,t){return s.geometryReleaseAssert(0),!1}validateTransformation(e,t){return s.geometryReleaseAssert(0),!1}nameIsSet(){return s.geometryReleaseAssert(0),!1}getInputSpatialReference(){return this.m_inputSr}getOutputSpatialReference(){return this.m_outputSr}getStep(e){return(e<0||e>this.count())&&s.throwOutOfRangeException(""),this.m_transforms[e]}getInverse(){const e=new To;return e.addSteps(this,!0),e.setInputSpatialReference(this.m_outputSr),e.setOutputSpatialReference(this.m_inputSr),e.create()}transform(t,s,r){if(0===this.count())return;let o=this.m_inputSr,a=this.m_outputSr;if(t&&(a=i.swap(o,o=a)),0===this.m_transforms.length)return void qn(o,null,a,null,s,null,r);let m=this.m_fastTrack;if(1===m)return void n.forEachDir(t,this.m_transforms,n=>{!function(t,s,n,r,i){const o=t.getVerttran(),a=t.getGeogtran();if(i>0){t.prepareOrThrow();const r=s?e.peDefs.PE_TRANSFORM_2_TO_1:e.peDefs.PE_TRANSFORM_1_TO_2;o?kr():Mr(a,i,n,null,r)}}(n.getWrapper(),t!==n.isInverted(),s,0,r)});const l=On();-1===m&&l.initFromGcsAndVcs(o,null);const h=On();let g=t?this.m_transforms.length-1:0;const u=t?-1:1;for(let e=0,n=this.m_transforms.length;e<n;e++,g+=u){if(0===e){const e=this.m_transforms[g];Yn(o.getPECoordSys(),null,e.getWrapper(),t!==e.isInverted(),s,null,r,h),-1===m&&(l.equals(h)||(m=0)),l.assign(h)}else{const e=this.m_transforms[g-u],n=this.m_transforms[g];Xn(l,e.getWrapper(),t!==e.isInverted(),n.getWrapper(),t!==n.isInverted(),s,null,r,h),-1===m&&(l.equals(h)||(m=0)),l.assign(h)}const n=this.m_transforms[g];Ln(l,n.getWrapper(),t!==n.isInverted(),s,null,r,h),l.assign(h)}const c=this.m_transforms[g-u];!function(e,t,s,n,r,i,o,a){const m=On();m.assign(s?t.m_inputUnitParams:t.m_outputUnitParams),m.processUnitParams(e);let l=null;n&&(l=n.getPECoordSys());const h=On();h.initFromGcsAndVcsPe(l,null),h.processUnitParams(m),m.processUnitParams(h),a>0&&Un(m,h,i,null,a)}(l,c.getWrapper(),t!==c.isInverted(),a,0,s,0,r),-1===m&&(h.initFromGcsAndVcs(a,null),l.equals(h)||(m=0)),this.m_fastTrack=0===m?0:1}};class To{constructor(){this.m_transforms=[],this.m_inputGCS=null,this.m_outputGCS=null,this.m_name="",this.m_bNameIsSet=!1}getInputSpatialReference(){return null!==this.m_inputGCS?this.m_inputGCS:this.count()>0?this.m_transforms[0].getInputSpatialReference():null}setInputSpatialReference(e){this.m_inputGCS=e?e.getGCS():null}getOutputSpatialReference(){return null!==this.m_outputGCS?this.m_outputGCS:this.count()>0?this.m_transforms.at(-1).getOutputSpatialReference():null}setOutputSpatialReference(e){this.m_outputGCS=e?e.getGCS():null}getName(){if(this.m_bNameIsSet)return this.m_name;if(0===this.m_transforms.length)return"";let e="";for(const t of this.m_transforms)e.length>0&&(e+=" + "),t.isInverted()&&(e+="~"),e+=t.getName();return e}count(){return this.m_transforms.length}getStep(e){return(e<0||e>this.count())&&s.throwOutOfRangeException(""),this.m_transforms[e]}setStep(e,t){s.geometryReleaseAssert(0)}add(e){this.m_transforms.push(e)}addSteps(e,t){if(t)for(let t=e.count()-1;t>=0;--t)this.add(e.getStep(t).getInverse());else for(let t=0;t<e.count();++t)this.add(e.getStep(t))}clear(){this.m_transforms=[],this.m_name="",this.m_bNameIsSet=!1,this.m_inputGCS=null,this.m_outputGCS=null}remove(e){s.geometryReleaseAssert(0)}create(){const e=this.getInputSpatialReference(),t=this.getOutputSpatialReference(),s=new vo(this.m_transforms,this.m_bNameIsSet?this.m_name:null,e,t);return s.m_bReadOnly=!0,this.clear(),s}}const Do=Object.freeze(Object.defineProperty({__proto__:null,SpatialReference:ji,SpatialReferencePrecisionDescriptor:Zi,create:Ni,createFromWKT:Hi,createImplFromPe:Ai,createLocal:Vi,createWithNewPrecision:Fi,createWithNewVCS:function(e,t,s){return{}},getGCS:ki,getTempName:Yi,hasNoPe:bi,hasPe:wi,injectNoPe:Di,injectPe:function(t){if(e.peFactory)return;!function(t){const n=t;e.peFactory=n.PeFactory,s.geometryReleaseAssert(e.peFactory),co=n.PeGCSExtent,s.geometryReleaseAssert(co),e.peLineType=n.PeLineType,s.geometryReleaseAssert(e.peLineType),e.peMath=n.PeMath,s.geometryReleaseAssert(e.peMath),e.PeDoubleClass=n.PeDouble,s.geometryReleaseAssert(e.PeDoubleClass),e.peDefs=n.PeDefs,s.geometryReleaseAssert(e.peDefs),e.peCSTransformations=n.PeCSTransformations,s.geometryReleaseAssert(e.peCSTransformations),lo=n.PeGTTransformations,s.geometryReleaseAssert(lo),ho=n.PePCSInfo,s.geometryReleaseAssert(ho),go=n.PeGTlistExtended,s.geometryReleaseAssert(go),e.peFactory.initialize(),uo=n.PeGTlistExtendedEntry,s.geometryReleaseAssert(uo),e.peDefs.PE_TYPE_ANGUNIT=512,e.peDefs.PE_STR_AUTH_ALL=2,ho.PE_POLE_LINE_STRAIGHT=2,ho.PE_POLE_LINE_CURVED=3,e.peDefs.PE_PARM_LAM0=2,e.peDefs.PE_PARM_PHI0=6,e.peDefs.PE_PRJ_AZIMUTHAL_EQUIDISTANT=43032,e.peDefs.PE_PRJ_LAMBERT_AZIMUTHAL_EQAREA=43033,e.peDefs.PE_PRJ_ALBERS=43007,e.peDefs.PE_PRJ_CYLINDRICAL_EQAREA=43034,e.peDefs.PE_TYPE_VERTCS=8,e.peDefs.PE_LINETYPE_GEODESIC=0,e.peDefs.PE_LINETYPE_LOXODROME=1,e.peDefs.PE_LINETYPE_GREAT_ELLIPTIC=2,e.peDefs.PE_LINETYPE_NORMAL_SECTION=3,go.PE_GTLIST_OPTS_USABLE=1,po=null}(t);const n=Ei;Ei=null,n.forEach(e=>{const t=e.deref();t&&t.attachToPe()})},isInitialized:Gi,isTempName:Xi,isValidWkid:Mi,isValidWkt:Ui,makeSpheroidData:Ti,snapGeometry:Ri,webMercator:Qi,webMercator102100:Ki,wgs84:$i},Symbol.toStringTag,{value:"Module"})),wo=Object.freeze(Object.defineProperty({__proto__:null,OperatorProject:nn},Symbol.toStringTag,{value:"Module"})),bo=Object.freeze(Object.defineProperty({__proto__:null,CompositeGeographicTransformation:vo,CompositeGeographicTransformationEditor:To,createImpl:Io,queryGtListImpl:Co},Symbol.toStringTag,{value:"Module"})),Go=Object.freeze(Object.defineProperty({__proto__:null,GeographicTransformation:So,create:function(t,n){const r=e.peFactory.geogtran(t);return r||s.throwInvalidWkidException(t),new So(r,n)},createFromPe:xo,createFromWKT:function(t,n){const r=e.peFactory.fromString(e.peDefs.PE_TYPE_GEOGTRAN,t);return r||s.throwInvalidWktException(t),new So(r,n)}},Symbol.toStringTag,{value:"Module"})),No=Object.freeze(Object.defineProperty({__proto__:null,ProjectionTransformation:ri,create:function(e,s,n){return Zr(e,s,t.Envelope2D.constructEmpty(),n)},createEx:Qr,createFromAoi:Zr,createImplEx:Kr,makeExtendedParams:Jr,makeExtendedParamsInternal:ti,queryTransformationList:$r},Symbol.toStringTag,{value:"Module"}));e.CompositeGeographicTransformation=bo,e.CurveStitcher=ms,e.GeographicTransformation=Go,e.Gnomonic=Gn,e.IndexMultiList=W,e.ListeningGeometryCursor=zr,e.MapGeometry=u,e.OperatorContains=Zn,e.OperatorDifference=Qn,e.OperatorDisjoint=tr,e.OperatorIntersection=js,e.OperatorProject=nn,e.OperatorProject$1=wo,e.OperatorSimpleRelation=zn,e.OperatorSimplify=Xs,e.OperatorUnion=$n,e.PEGeogToGeogStable=Ur,e.PEGeogToProj=Cr,e.PEGeogToProjSimple=function(t,s){const n=s.getPointCount();if(!n)return;const r=s.getImpl(),i=r.getAttributeStreamRef(0),o=t;e.peCSTransformations.geogToProj(o,n,i.getArray()),r.notifyModifiedFlags(2001)},e.PEProjToGeogCenterPoint2D=Nr,e.PE_EQ=ao,e.ProjectionTransformation=No,e.SpatialReference=Do,e.SpatialReferencePrecisionDescriptor=Zi,e.TopoGraph=z,e.TopologicalOperations=Ds,e.UnorderedBitIterator=F,e.accelerateGeometry=Wn,e.applySplitLines=sr,e.areaBetweenParallelsAndMeridiansOfUnitSpheroid=function(e,t,s,n,r){n=i.snap(n,-i.geometryHalfPi,i.geometryHalfPi),r=i.snap(r,-i.geometryHalfPi,i.geometryHalfPi);const o=i.geometryHalfPi-.03;let a;a=n>o&&r>o||n<-o&&r<-o?function(e,t,s){let n=1;if(t<0&&(n=-1,t=-t,s=-s),0!==e){const r=e*e,o=r*e,a=[1,(1+11*e)/12,(1+118*e+241*r)/360,(1+1089*e+10419*r+8651*o)/20160,(1+9836*e+318246*r+1027436*o+o*e*458881)/1814400],m=t=>{let s=0;const n=i.sqr(t)/(e-1);for(let e=a.length-1;e>=0;--e)s=a[e]+s*n;return s*=-i.sqr(t/(1-e)),s},l=m(i.geometryHalfPi-t);return(m(i.geometryHalfPi-s)-l)*n}{const e=i.geometryHalfPi-t,r=i.geometryHalfPi-s,o=-4*i.sqr(Math.sin(e/2));return(-4*i.sqr(Math.sin(r/2))-o)*n}}(e,n,r):N(e,r)-N(e,n);const m=function(e){return 1-e}(e);return.5*(s-t)*a*m},e.autoComplete=function(e,t,s,n){return new Ds(n).autoCompleteImpl(e,t,s)},e.brentMinimization=x,e.buildSegmentParentage=ss,e.buildSegmentParentageForIsSimple=ns,e.calculateLargeRadius=function(e,t){return e/Math.sqrt(1-t)},e.calculateSmallRadius=H,e.calculateTightRadiusInMeters=function(t,s,n,r){const i={stack:[],error:void 0,hasError:!1};try{const a=[n.x],m=[n.y-r],l=[n.x],h=[n.y+r];G(a,m),G(l,h);const g=o.__addDisposableResource(i,new e.PeDoubleClass,!1),u=o.__addDisposableResource(i,new e.PeDoubleClass,!1);return e.peLineType.greatEllipticDistance(t,s,n.x,n.y,a[0],m[0],g,null,null),e.peLineType.greatEllipticDistance(t,s,n.x,n.y,l[0],h[0],u,null,null),Math.min(g.val,u.val)}catch(e){i.error=e,i.hasError=!0}finally{o.__disposeResources(i)}},e.canAccelerateGeometry=jn,e.cartToCurv=I,e.checkEndForPoleTouch=hn,e.checkForWithinPole=mn,e.checkStartForPoleTouch=ln,e.clipGeometryFromTopAndBottom=_r,e.closestCoordinate=w,e.create$2=Ni,e.create$5=function(e){return new yi},e.createEx=Qr,e.createFromWKT$2=Hi,e.createImplEx=Kr,e.createLocal=Vi,e.createWithNewPrecision=Fi,e.curvToCart=E,e.densificationDeviationFromTolerance=is,e.densify=on,e.execute=hs,e.execute$1=Ge,e.executeMp2sp=function(e,t,s){const n=new be(s);return n.m_shape=e,n.m_geometry=t,n.m_sortedVertices=null,n.m_bFixSelfTangency=!1,n.fixRingOrientationForMp2sp_()},e.extraToleranceForCrackingAndClustering=as,e.foldGeometry=yr,e.foldInto360NoUnion=bn,e.geodeticDensifySegment=function(e,t,s,n,r,o,a,m,l,h,g,u){const c=new i.Point2D,p=new i.Point2D,d=n.compare(r)>0;En(d,n,r,c,p);const _=pn(e,t,s,c,p,o,a,m,l,h,null,g,u);return d&&Pn(l,h,null,g),_},e.getTempName=Yi,e.hasPe=wi,e.injectNoPe$1=Di,e.insertGeodeticPointsEditShape=dr,e.isPoint2DInPolygon2D=Qt,e.isSimpleOGC=function e(i,o,a,m,l){if(m&&(m.m_reason=0,m.m_vertexIndex1=-1,m.m_vertexIndex2=-1),i.isEmpty())return 5;const h=i.getGeometryType();if(h===s.GeometryType.enumPoint)return Fs(i,m);const g=r.calculateToleranceFromGeometryForOpFromGeom(o,i,!1).total();if(h===s.GeometryType.enumEnvelope){const e=i,s=new t.Envelope2D;return e.queryEnvelope(s),s.isDegenerate(g)?(m&&(m.m_reason=4,m.m_vertexIndex1=-1,m.m_vertexIndex2=-1),0):5}if(s.isSegment(h)){const t=i,s=new n.Polyline({vd:t.getDescription()});return s.addSegment(t,!0),e(s,o,a,m,l)}s.throwIfGeometryCollectionType(h),s.isMultiVertex(h)||s.throwNotImplementedException("OGC simplify is not implemented for this geometry type");const u=i.getImpl().getIsSimple(g,[0]);let c=a?-1:u;if(5===c||0===c)return c;const p=new Ys(i,o,c,l,!0);return h===s.GeometryType.enumMultiPoint||h===s.GeometryType.enumPolyline||h===s.GeometryType.enumPolygon?(c=p.isSimplePlanarImpl(),r.isAtLeastPlanarSimple(c)&&(c=5)):s.throwInternalErrorException(""),i.getImpl().setIsSimple(c,g),m&&m.assign(p.m_nonSimpleResult),c},e.isValidWkid$1=Mi,e.isValidWkid$2=function(e){return!1},e.isValidWkt$1=Ui,e.linesToPolygons=function(e,t,s){return new Ds(s).linesToPolygonsImpl(e,t)},e.makeExtendedParams=Jr,e.makeExtendedParamsInternal=ti,e.makeSpheroidData=Ti,e.needsCrackingAndClustering=function(e,t,s){const i=r.adjustToleranceForTEClustering(t),o=r.adjustToleranceForTECracking(t);return!!function(e,t,s,n,r){const i=new ne(r);return i.m_shape=e,i.m_sqrTolerance=t*t,i.m_cellSize=2*t,i.m_invCellSize=1/i.m_cellSize,i.m_geometry=s,i.m_bTrackChanges=!1,i.needsClustering()}(e,i,n.nullHandle,0,s)||Pe(!0,e,o,null,s)},e.normalizeMultiPathGcs=an,e.normalizeX=gr,e.planarSimplify=Ss,e.processCurves=function(e,t,i,o){if(!s.isMultiPath(e.getGeometryType()))return e;const a=e.getImpl();if(!a.hasNonLinearSegments())return e;const m=e.createInstance();m.getGeometryType()===s.GeometryType.enumPolygon&&m.setFillRule(e.getFillRule()),new n.EditShape;const l=new r.Point,h=new n.SegmentBuffer,g=[],u=[],c=[],p=e.getDescription().getAttributeCount()>1,d=a.querySegmentIterator();for(;d.nextPath();){let e=!0;for(;d.hasNextSegment();){const r=d.isClosingSegment(),o=d.nextSegment();if(!o.isCurve()){m.addSegment(o,e,r),e=!1;continue}let a,_=!1;const f=!0,y=!0;switch(o.getGeometryType()){case s.GeometryType.enumEllipticArc:case s.GeometryType.enumRationalBezier2:a=n.approximationWithQuadraticRationalBeziers(o,t,i,f,y,u,c,g),_=!0;break;default:a=n.approximationWithBeziers(o,t,i,!0,f,u,g)}const x=_?2:3;u[1].isNAN()?(h.createLine(),h.get().construct(u[0],u[x])):_?(h.createQuadraticRationalBezier(),h.get().constructArrayWeights(u,c)):(h.createCubicBezier(),h.get().constructPoints(u)),p&&e&&(o.queryCoord(g[0],l),h.get().setStart(l)),p&&(o.queryCoord(g[1],l),h.get().setEnd(l)),m.addSegment(h.get(),e,r&&1===a),e=!1;for(let e=1,t=a,s=x;e<t;++e,s+=x)u[s+1].isNAN()?(h.createLine(),h.get().construct(u[s],u[s+x])):_?(h.createQuadraticRationalBezier(),h.get().constructArrayWeights(u.slice(s),c.slice(s))):(h.createCubicBezier(),h.get().constructPoints(u.slice(s))),p&&(o.queryCoord(g[e+1],l),h.get().setEnd(l)),m.addSegment(h.get(),!1,r&&e+1===t)}}return m},e.processWithPCSHorizon=Sr,e.projectMultiPathVerticesPCSToGCS=function(e,s,r,i){const o=new n.MultiPoint({vd:s.getDescription()});let a;o.addPoints(s,0,-1),a=(new nn).execute(o,e,i);const m=s.getPointCount();if(r.setEmpty(),e.getInputSR().isPannable()){if(m!==a.getPointCount())return!1;const n=new t.Envelope2D;s.queryEnvelope(n);const i=new t.Envelope2D;a.queryEnvelope(i);const o=n.width(),l=i.width();if(0!==o&&0!==l){const t=l/o,s=e.getOutputSR().getPannableExtent().width()/e.getInputSR().getPannableExtent().width();if(Math.abs(t/s-1)>1e-10)return!1}else if(0!==o||0!==l)return!1;r.add(s,!1);for(let e=0;e<m;e++){const t=a.getXY(e);r.setXY(e,t)}return!0}return!1},e.projectPointsToGCS=function(e,t,s,n){const r=e.getSRToGCSTransform();return(new nn).transform(r,t,s,n,!1)},e.querySinglePartCount=function(e){if(e.isEmpty())return 0;switch(e.getGeometryType()){case s.GeometryType.enumMultiPoint:return e.getImpl().getPointCount();case s.GeometryType.enumPolyline:return e.getImpl().getPathCount();case s.GeometryType.enumPolygon:return e.getImpl().getOGCPolygonCount();case s.GeometryType.enumGeometryCollection:return e.getGeometryCount()}return 1},e.relate=Ze,e.relate$1=He,e.s_IntToPublicCutSide=function(e){switch(e){case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 0:return 0;default:s.geometryReleaseAssert(0,"unrecognized cut side")}return 3},e.simplifyOGC=function e(i,o,a,m){if(i.isEmpty())return i;const l=i.getGeometryType();if(l===s.GeometryType.enumPoint){const e=new g.NonSimpleResult;if(Fs(i,e),3===e.m_reason){const e=i.clone();return e.replaceNaNs(1,0),e}return 2===e.m_reason?i.createInstance():i}if(l===s.GeometryType.enumEnvelope){const e=i,s=new t.Envelope2D;e.queryEnvelope(s);const n=r.calculateToleranceFromGeometryForOpFromGeom(o,i,!0).total();return s.isDegenerate(n)?e.createInstance():i}if(s.isSegment(l)){const t=i,s=new n.Polyline({vd:t.getDescription()});return s.addSegment(t,!0),e(s,o,a,m)}s.throwIfGeometryCollectionType(l),s.isMultiVertex(l)||s.throwNotImplementedException("OGC simplify is not implemented for this geometry type");const h=r.calculateToleranceFromGeometryForOpFromGeom(o,i,!1).total(),u=i.getImpl().getIsSimple(h,[0]),c=a?-1:u;if(5===c){if(l===s.GeometryType.enumPolygon&&0!==i.getFillRule()){const e=i.clone();return e.setFillRule(0),e}return i}return Es(i,r.calculateToleranceFromGeometryForOpFromGeom(o,i,!0),!1,c,m,0,!0)},e.snapGeometry=Ri,e.sphericalDistance=D,e.sphericalDistancePointToSegment=function(e,t,s,n,i){const o=s.getUnitVector(),a=n.getUnitVector(),m=t.getUnitVector(),l=new r.Point3D;if(l.setCrossProductVector(o,a),!l.isZero()){l.normalizeThis();const t=m.sub(l.mul(l.dotProduct(m)));if(!t.isZero()){t.normalizeThis();const s=o.add(a).mul(.5);if(s.dotProduct(t)>s.dotProduct(o)){const s=Math.abs(l.dotProduct(m)),n=Math.asin(s);return i.assign(t.getUnitVector().mul(e)),n*e}}}const h=D(1,o,m),g=D(1,a,m);return h<=g?(i.assign(s),h*e):(i.assign(n),g*e)},e.stitchingDensificationDeviationFromTolerance=os,e.symmetricDifference=function(e,i,o,a){if(e.getDimension()>i.getDimension())return ws(bs(e),e,0,"^");if(e.getDimension()<i.getDimension())return ws(bs(i),e,0,"^");if(e.isEmpty())return ws(bs(i),e,0,"^");if(i.isEmpty())return ws(bs(e),e,0,"^");const m=new t.Envelope2D;e.queryEnvelope(m);const l=new t.Envelope2D;i.queryEnvelope(l);const h=new t.Envelope2D;h.setCoords({env2D:m}),h.mergeEnvelope2D(l);const g=r.calculateToleranceFromGeometryForOp(o,h,!0),u=new Ds(a),c=new n.EditShape,p=c.addGeometry(bs(e)),d=c.addGeometry(bs(i));let _=0,f=null;if(c.hasCurves()){f=new ms;const e=c.getEnvelope2D(a);_=os(g.total()),ss(c,is(g.total(),e),g.total(),0,f,null,a)}u.setEditShapeCrackAndCluster(c,g);const y=u.symmetricDifference(p,d);null!==f&&f.stitchCurves(c,y,_,!0);const x=ws(c.getGeometry(y),e,0,"^");return ys(x.getGeometryType())&&(x.getImpl().setIsSimple(4,g.total()),x.getGeometryType()===s.GeometryType.enumPolygon&&x.getImpl().updateOGCFlagsProtected()),x},e.testPointsInArea2D=Kt,e.transformInPlace=Qs,e.validateSclString=Ae});