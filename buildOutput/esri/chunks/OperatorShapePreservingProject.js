// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","./SimpleGeometryCursor","./Geometry","./Envelope","./Envelope2D","./MultiPathImpl","./Point2D","./Transformation2D","./ProjectionTransformation","./OperatorClip"],function(t,e,i,s,n,o,r,h,m,a){"use strict";function l(t){const e=t.getInputSR(),i=t.getOutputSR();let s=!1;do{if(e.equals(i)){s=!1;break}if(!g(e)||!g(i)){s=!1;break}if(2===e.getCoordinateSystemType()){s=!0;break}if(2===i.getCoordinateSystemType()){s=!0;break}const n=t.getGeographicTransformations();if(null!==n&&n.count()>0){s=!0;break}}while(0);return s}class c{constructor(t,e,i,s){this.m_horizon2Env=new n.Envelope2D,this.m_horizon2=t,this.m_sr=e,this.m_bInclusive2=i,this.m_pannableExtent=s.clone(),this.m_segIter=null,this.m_qtIter=null,null!==t?(t.queryEnvelope(this.m_horizon2Env),this.m_gcs360=s.width(),this.m_gcs180=.5*this.m_gcs360,this.m_gcs90=.25*this.m_gcs360,this.m_pannableFactor=1,this.m_horizon2Env.width()-this.m_gcs360>0&&(this.m_pannableFactor+=Math.ceil((this.m_horizon2Env.width()-this.m_gcs360)/this.m_gcs360)),this.m_period=this.m_gcs360):(this.m_horizon2Env.setEmpty(),this.m_gcs360=Number.NaN,this.m_gcs180=Number.NaN,this.m_gcs90=Number.NaN,this.m_pannableFactor=Number.NaN,this.m_period=Number.NaN),this.m_gcsTolerance=null!=e?e.getTolerance(0):Number.NaN}isPointStartInHorizon(t,e){if(!this.m_horizon2)return!0;let n=y(new s.Point(t),this.m_horizon2,!0,this.m_period);do{const e=t.clone();if(e.x-=n*this.m_period,this.m_horizon2.getGeometryType()===i.GeometryType.enumPolygon){let t;if(t=this.m_horizon2Env.contains(e)?m.isPoint2DInPolygon2D(this.m_horizon2,e,0):0,this.m_bInclusive2){if(0===t)return!1}else if(1===t)return!1}else{const t=this.m_horizon2Env.contains(e);if(this.m_bInclusive2){if(!t)return!1}else if(t)return!1}}while(this.m_horizon2Env.xmin+ ++n*this.m_period<t.x);return!0}isAdjoiningLineInHorizon(t,e,s){if(!this.m_horizon2)return!0;const h=new r.Point2D,m=new r.Point2D;C(t,e,this.m_gcs90,this.m_gcs180,this.m_gcs360,h,m);const a=Math.max(h.x,m.x),l=new o.Line;l.setStart2D(h),l.setEnd2D(m);let c=y(l,this.m_horizon2,!0,this.m_period);do{const t=h.clone(),e=m.clone();if(t.x-=c*this.m_period,e.x-=c*this.m_period,this.m_horizon2.getGeometryType()===i.GeometryType.enumPolygon){const s=new o.Line;s.setStartXY(t),s.setEndXY(e);const r=new n.Envelope2D,h=new n.Envelope2D;if(s.queryEnvelope(r),h.setCoords({env2D:r}),h.inflateCoords(this.m_gcsTolerance,this.m_gcsTolerance),this.m_horizon2Env.isIntersecting(h)){const t=this.m_horizon2.getImpl(),e=t.getAccelerators();null!==e&&null!==e.getRasterizedGeometry()&&i.geometryReleaseAssert(0);{let i=null;if(null!==e&&(i=e.getQuadTree()),null!==i){this.m_qtIter||(this.m_qtIter=i.getIteratorForQT()),this.m_qtIter.resetIterator(s,this.m_gcsTolerance),this.m_segIter||(this.m_segIter=t.querySegmentIterator());for(let t=this.m_qtIter.next();-1!==t;t=this.m_qtIter.next()){const e=i.getElement(t);if(this.m_segIter.resetToVertex(e,-1),this.m_segIter.nextSegment().isIntersecting(s,this.m_gcsTolerance))return!1}}else for(this.m_segIter||(this.m_segIter=t.querySegmentIterator()),this.m_segIter.resetToFirstPath();this.m_segIter.nextPath();)for(;this.m_segIter.hasNextSegment();){const t=this.m_segIter.nextSegment(),e=new n.Envelope2D;if(t.queryEnvelope(e),e.isIntersecting(h)&&t.isIntersecting(s,this.m_gcsTolerance))return!1}}}}else if(this.m_bInclusive2){const i=this.m_horizon2Env.contains(t),s=this.m_horizon2Env.contains(e);if(i&&s)return!0}else{const i=this.m_horizon2Env.clone();if(i.inflateCoords(this.m_gcsTolerance,this.m_gcsTolerance),0!==i.clipLine(t,e))return!1}}while(this.m_horizon2Env.xmin+ ++c*this.m_period<a);return!this.m_bInclusive2}isEnvelopeInHorizon(t,e){if(!this.m_horizon2)return!0;const i=new s.Envelope({env2D:t});let n=y(i,this.m_horizon2,!0,this.m_period);do{const s=t.clone();if(s.move(-n*this.m_period,0),i.setCoords(s.xmin,s.ymin,s.xmax,s.ymax),!F(i,this.m_horizon2,this.m_sr,this.m_bInclusive2,e))return!1}while(this.m_horizon2Env.xmin+ ++n*this.m_period<t.xmax);return!0}}class u{constructor(t,e,i){this.m_splitLines2=null,this.m_scalars=[],this.m_splitIter=null,this.m_splitLines2=t,this.m_transform1=e,this.m_pannableExtent=i.clone(),this.m_gcs360=i.width(),this.m_gcs180=.5*this.m_gcs360,this.m_gcs90=.25*this.m_gcs360,null!==e?(this.m_gcsTolerance=this.m_transform1.getOutputSR().getTolerance(0),this.m_halfGcsTolerance=.5*this.m_gcsTolerance,this.m_gcsToleranceSq=this.m_gcsTolerance*this.m_gcsTolerance):(this.m_gcsTolerance=Number.NaN,this.m_halfGcsTolerance=Number.NaN,this.m_gcsToleranceSq=Number.NaN)}hasSplitLines(){return null!=this.m_splitLines2}getSplitLineFactorEx(t,e,i,s,h,m){const a=new r.Point2D,l=new r.Point2D;C(s,h,this.m_gcs90,this.m_gcs180,this.m_gcs360,a,l);const c=new o.Line;for(c.setStartXY(a),c.setEndXY(l),this.m_splitIter?this.m_splitIter.resetToFirstPath():this.m_splitIter=this.m_splitLines2.getImpl().querySegmentIterator();this.m_splitIter.nextPath();)for(;this.m_splitIter.hasNextSegment();){const s=this.m_splitIter.nextSegment(),o=.5*(s.getStartX()+s.getEndX());S(this.m_gcs180,this.m_gcs360,o,c);const r=new n.Envelope2D;c.queryEnvelope(r),r.inflateCoords(this.m_gcsTolerance,this.m_gcsTolerance);const h=new n.Envelope2D;if(s.queryEnvelope(h),r.isIntersecting(h)&&(this.m_scalars.length<2&&(this.m_scalars.length=2),1===c.intersect(s,null,this.m_scalars,null,this.m_gcsTolerance)&&this.m_scalars[0]>0&&this.m_scalars[0]<1)){const n=G(e,i,this.m_scalars[0]),o=P(t.getCoord2D(n),this.m_transform1);return s.isIntersectingPoint(o,this.m_halfGcsTolerance)?n:this.getSplitLineFactor(t,e,i,s,m)}}return-1}getSplitLineFactor(t,e,i,s,n){let h=e,m=i;const a=.5*(s.getStartX()+s.getEndX()),l=new o.Line,c=t.getCoord2D(h),u=t.getCoord2D(m),f=P(c,this.m_transform1),g=P(u,this.m_transform1);for(;h<m;){const e=new r.Point2D,i=new r.Point2D;C(f,g,this.m_gcs90,this.m_gcs180,this.m_gcs360,e,i),l.setStartXY(e),l.setEndXY(i),S(this.m_gcs180,this.m_gcs360,a,l);const n=r.Point2D.sqrDistance(l.getStartXY(),l.getEndXY());if(n<=this.m_gcsToleranceSq)break;if(Number.isNaN(n))return Number.NaN;let o=G(h,m,this.m_scalars[0]);if(h<o&&o<m||(o=.5*(m+h)),h===o||o===m)return o;const p=t.getCoord2D(o),d=P(p,this.m_transform1),_=new r.Point2D;C(f,d,this.m_gcs90,this.m_gcs180,this.m_gcs360,e,_),l.setStartXY(e),l.setEndXY(_),S(this.m_gcs180,this.m_gcs360,a,l);let T=l.intersect(s,null,this.m_scalars,null,this.m_halfGcsTolerance);if(0!==T){if(1===this.m_scalars[0])return o;m=o,u.setCoordsPoint2D(p),g.setCoordsPoint2D(d)}else{if(C(d,g,this.m_gcs90,this.m_gcs180,this.m_gcs360,_,i),l.setStartXY(_),l.setEndXY(i),S(this.m_gcs180,this.m_gcs360,a,l),T=l.intersect(s,null,this.m_scalars,null,this.m_halfGcsTolerance),0===T)return o;if(0===this.m_scalars[0])return o;h=o,c.setCoordsPoint2D(p),f.setCoordsPoint2D(d)}}return.5*(m+h)}}class f{constructor(){this.m_bPrepared=!1,this.m_bNeedsShapePreservingProject=!1,this.m_inputTransform=null,this.m_transform1=null,this.m_transform2=null,this.m_extentFrom=null,this.m_horizon1=null,this.m_horizon2=null,this.m_pannableExtentFrom=new n.Envelope2D,this.m_pannableExtentTo=new n.Envelope2D,this.m_pannableExtentGcsTo=new n.Envelope2D,this.m_bClipTopBottomFrom=!1,this.m_bNeedsGeoTransform=!1,this.m_bIsPannableFrom=!1,this.m_bIsPannableTo=!1,this.m_bInclusive1=!1,this.m_bInclusive2=!1,this.m_bSrFromIsPcs=!1,this.m_bSrToIsPcs=!1,this.m_fromTolerance=Number.NaN,this.m_toTolerance=Number.NaN,this.m_gcsToTolerance=Number.NaN,this.m_aFrom=Number.NaN,this.m_mpuFrom=Number.NaN,this.m_rpuFrom=Number.NaN,this.m_rpuGcsTo=Number.NaN,this.m_aTo=Number.NaN,this.m_mpuTo=Number.NaN,this.m_stages=0}prepare(t,e,s){this.m_bPrepared&&i.throwInvalidCallException(""),t||i.throwInvalidArgumentException("");const n=t.getInputSR(),o=t.getOutputSR();g(n)&&g(o)||i.throwInvalidArgumentException("shape preserving project requires PCS or GCS");const r=n.getCoordinateSystemType(),h=o.getCoordinateSystemType();this.m_bSrFromIsPcs=2===r,this.m_bSrToIsPcs=2===h;let a=null,l=null,c=null,u=null;this.m_bSrFromIsPcs?(a=n,c=n.getGCS(),this.m_aFrom=w(c),this.m_mpuFrom=v(a),this.m_rpuFrom=Number.NaN):(c=n,this.m_rpuFrom=N(c),this.m_aFrom=Number.NaN),this.m_bSrToIsPcs?(l=o,u=o.getGCS(),this.m_aTo=w(u),this.m_mpuTo=v(l)):(u=o,this.m_aTo=Number.NaN,this.m_mpuTo=Number.NaN),this.m_rpuGcsTo=N(u);const f=t.getGeographicTransformations();this.m_bNeedsGeoTransform=null!==f&&f.count()>0;const p=n.equals(o);if(this.m_bNeedsShapePreservingProject=!p&&(this.m_bSrFromIsPcs||this.m_bSrToIsPcs||this.m_bNeedsGeoTransform),!this.m_bNeedsShapePreservingProject)return this.m_inputTransform=t,this.m_extentFrom=e?e.clone():null,void(this.m_bPrepared=!0);if(this.m_bIsPannableFrom=n.isPannable(),this.m_bIsPannableTo=o.isPannable(),this.m_bIsPannableFrom&&(this.m_pannableExtentFrom=n.getPannableExtent()),this.m_bIsPannableTo&&(this.m_pannableExtentTo=o.getPannableExtent()),this.m_bSrToIsPcs){this.m_pannableExtentGcsTo=u.getPannableExtent();const t=l.getCentralMeridian(),e=this.m_pannableExtentGcsTo.getCenter();e.x=t,this.m_pannableExtentGcsTo.centerAt(e)}else this.m_pannableExtentGcsTo=this.m_pannableExtentTo.clone();this.m_fromTolerance=n.getTolerance(0),this.m_toTolerance=o.getTolerance(0),this.m_gcsToTolerance=u.getTolerance(0);{const i=t.getExtendedParams(),n=i.clipWithInputHorizon,o=i.clipWithOutputHorizon;n&&this.setHorizon1(t,e,s),o&&this.setHorizon2(t,s),this.checkAndSetStages(t,s)}const d=m.makeExtendedParamsInternal();d.setFlag(1073741824,!0),d.setFlag(536870912,!0);const _=m.makeExtendedParams();if(_.clipWithInputHorizon=!1,_.clipWithOutputHorizon=!1,1===this.m_stages)this.m_transform1=m.createImplEx(!1,n,o,f,_,d);else if(2===this.m_stages){d.setFlag(2147483648,!0),this.m_transform1=m.createImplEx(!1,n,u,f,_,d);const t=m.makeExtendedParamsInternal();this.m_transform2=m.createImplEx(!1,u,o,null,_,t)}else{i.geometryReleaseAssert(null!=l),_.centralMeridianOfOutputGCS=l.getCentralMeridian(),this.m_transform1=m.createImplEx(!1,n,u,f,_,d);const t=m.makeExtendedParamsInternal();t.setFlag(2147483648,!0),this.m_transform2=m.createImplEx(!1,u,o,null,_,t)}this.m_inputTransform=t,this.m_extentFrom=e?e.clone():null,this.m_bPrepared=!0}execute(t,e,s,n){return this.m_bPrepared||i.throwInvalidCallException(""),i.geometryReleaseAssert(!t.hasAttribute(10)),this.execute_(t,e,s,n)}checkIfNeedsReset(t,e){return i.geometryReleaseAssert(0),!1}setHorizon1(t,e,i){const o=t.getInputSR();let r,h=null;const m=new n.Envelope2D;if(this.m_bSrFromIsPcs){r=!0,h=o.getPCSHorizon(),h.queryEnvelope(m),this.m_bIsPannableFrom&&(h=new s.Envelope({xmin:this.m_pannableExtentFrom.xmin,ymin:m.ymin,xmax:this.m_pannableExtentFrom.xmax,ymax:m.ymax}));let t=!1;null!=e&&(t=function(t,e,i,s,n,o,r){const h=[!1];return x(t,i,e,!0,n,o,!0,Number.NaN,h,r),h[0]}(e,h,o,0,this.m_bIsPannableFrom,this.m_pannableExtentFrom,i)),t||(this.m_horizon1=h,this.m_bInclusive1=true)}else this.m_bClipTopBottomFrom=!0,this.m_bInclusive1=!0}setHorizon2(t,e){const i=t.getOutputSR();if(1===i.getCoordinateSystemType())return this.m_horizon2=null,void(this.m_bInclusive2=!1);let o=null;const r=new n.Envelope2D,h=i.getGCSHorisonIsInclusive();o=i.getGCSHorizon(),o.queryEnvelope(r);const m=i.getCentralMeridian();if(this.m_bIsPannableTo){const t=new s.Envelope({xmin:this.m_pannableExtentGcsTo.xmin,ymin:r.ymin,xmax:this.m_pannableExtentGcsTo.xmax,ymax:r.ymax});t.centerAt(m,0),o=t}this.m_horizon2=o,this.m_bInclusive2=h}checkAndSetStages(t,e){const s=t.getOutputSR().getGCSSplitLines();if(this.m_horizon2||s){if(this.m_horizon2.getGeometryType()===i.GeometryType.enumEnvelope){const t=new n.Envelope2D;this.m_horizon2.queryEnvelope(t);const e=t.width(),i=t.height();e>=r.geometry2Pi/this.m_rpuGcsTo&&i>=Math.PI/this.m_rpuGcsTo&&(this.m_horizon2=null)}if(this.m_horizon2||s){if(null!==this.m_horizon2&&!this.m_bNeedsGeoTransform&&!this.m_bSrFromIsPcs){const e=t.getOutputSR().getGCS();return t.getInputSR().equals(e)?(this.m_horizon1=this.m_horizon2,this.m_bInclusive1=this.m_bInclusive2,this.m_bClipTopBottomFrom=!1,this.m_horizon2=null,this.m_bInclusive2=!1,void(this.m_stages=1)):void(this.m_stages=2)}this.m_stages=3}else this.m_stages=1}else this.m_stages=1}execute_(t,e,s,n){if(!this.m_bNeedsShapePreservingProject)return(new m.OperatorProject).execute(t,this.m_inputTransform,n);if(!t)return null;i.throwIfMesh(t),i.throwIfCurves(t);let r,h=t.getGeometryType();return i.isSegment(h)?(r=function(t){const e=new o.Polyline({vd:t.getDescription()});return e.addSegment(t,!0),e}(t),h=i.GeometryType.enumPolyline):r=t,r.isEmpty()?r:i.isMultiPath(h)?this.executeEx(t,e,s,n):(new m.OperatorProject).execute(t,this.m_inputTransform,n)}executeEx(t,e,s,n){let o;t.hasNonLinearSegments()&&i.throwNotImplementedException(""),o=this.m_bIsPannableFrom?(new m.OperatorProject).foldInto360Range(t,this.m_transform1.getInputSR()):t;let r,h=s;return h>0||(h=100*this.m_toTolerance),r=1===this.m_stages?this.executeGood(o,e,h,n):2===this.m_stages?this.executeBad(o,e,h,n):this.executeUgly(o,e,h,n),this.filterOverDensification(r,this.m_inputTransform.getOutputSR(),h,n)}executeGood(t,e,i,s){const n=i*i;let o,r;return o=e>0?this.getMinLengthInSrFrom(e):this.getMinLengthInSrFrom(1e-5),r=this.m_bClipTopBottomFrom?m.clipGeometryFromTopAndBottom(t,this.m_transform1.getInputSR()):I(t,this.m_transform1.getInputSR(),this.m_horizon1,this.m_bInclusive1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,!0,Number.NaN,s),r=m.applySplitLines(r,this.m_transform1.getOutputSR(),s),r=p(r,this.m_transform1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,this.m_bIsPannableTo,this.m_pannableExtentTo,null,null,0,null,o,n,s),r=(new m.OperatorProject).execute(r,this.m_transform1,s),r}executeBad(t,e,i,s){let n;n=e>0?e*(Math.PI/180/this.m_rpuGcsTo):Math.PI/180/this.m_rpuGcsTo*1e-5;const o=i*i;let r;return r=this.m_bClipTopBottomFrom?m.clipGeometryFromTopAndBottom(t,this.m_transform1.getInputSR()):t,r=(new m.OperatorProject).execute(r,this.m_transform1,s),r=I(r,this.m_transform2.getInputSR(),this.m_horizon2,this.m_bInclusive2,!0,this.m_pannableExtentGcsTo,!0,Number.NaN,s),r=m.applySplitLines(r,this.m_transform2.getOutputSR(),s),r=p(r,this.m_transform2,!0,this.m_pannableExtentGcsTo,this.m_bIsPannableTo,this.m_pannableExtentTo,null,null,0,null,n,o,s),r=(new m.OperatorProject).execute(r,this.m_transform2,s),r}executeUgly(t,e,i,s){const n=i*i;let o;o=e>0?this.getMinLengthInSrFrom(e):this.getMinLengthInSrFrom(1e-5);let r=null;r=this.m_bClipTopBottomFrom?m.clipGeometryFromTopAndBottom(t,this.m_transform1.getInputSR()):I(t,this.m_transform1.getInputSR(),this.m_horizon1,this.m_bInclusive1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,!0,Number.NaN,s);let h=r;const a=new c(this.m_horizon2,this.m_transform2.getInputSR(),this.m_bInclusive2,this.m_pannableExtentGcsTo),l=this.m_transform2.getOutputSR().getGCSSplitLines(),f=new u(l,this.m_transform1,this.m_pannableExtentGcsTo);if(r=p(r,this.m_transform1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,this.m_bIsPannableTo,this.m_pannableExtentTo,this.m_transform2,a,this.m_pannableExtentGcsTo,f,o,n,s),null!==r){h=null,r=(new m.OperatorProject).execute(r,this.m_transform1,s);const t=Math.PI/180/this.m_rpuGcsTo*2;return r=I(r,this.m_transform2.getInputSR(),this.m_horizon2,this.m_bInclusive2,!0,this.m_pannableExtentGcsTo,!1,t,s),r=(new m.OperatorProject).execute(r,this.m_transform2,s),r}let g=Number.NaN;g=i>0?i:100*this.m_toTolerance,g/=this.m_rpuGcsTo*this.m_aTo/this.m_mpuTo;const d=g*g;let _;return r=p(h,this.m_transform1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,!0,this.m_pannableExtentGcsTo,null,null,0,null,o,d,s),h=null,r=(new m.OperatorProject).execute(r,this.m_transform1,s),_=e>0?e*(Math.PI/180/this.m_rpuGcsTo):Math.PI/180/this.m_rpuGcsTo*1e-5,r=I(r,this.m_transform2.getInputSR(),this.m_horizon2,this.m_bInclusive2,!0,this.m_pannableExtentGcsTo,!1,Number.NaN,s),r=m.applySplitLines(r,this.m_transform2.getOutputSR(),s),r=p(r,this.m_transform2,!0,this.m_pannableExtentGcsTo,this.m_bIsPannableTo,this.m_pannableExtentTo,null,null,0,null,_,n,s),r=(new m.OperatorProject).execute(r,this.m_transform2,s),r}getMinLengthInSrFrom(t){let e;return e=this.m_bSrFromIsPcs?this.m_aFrom*(t*Math.PI/180)/this.m_mpuFrom:t*Math.PI/180*(1/this.m_rpuFrom),e}filterOverDensification(t,e,n,h){let a=function(t,e){if(t.isEmpty()||!t.hasAttribute(10))return t;const i=e*e;let n=t.getAttributeStreamRef(10),h=!1;const m=new o.Line,a=[];let l=!1;for(let e=0,s=t.getPathCount();e<s;e++){const s=t.getPathStart(e),o=t.getPathEnd(e),c=t.isClosedPath(e);if(!(o>s))continue;{const t=c?s:o-1;0===n.read(s)&&0===n.read(t)||(h||(n=n.clone(),h=!0),n.write(s,0),n.write(t,0))}const u=c?o+1:o;let f=s;for(let e=s;e<u;e++){const c=e===o?s:e;if(0===n.read(c)){if(e-f>1){a.push({from:f,to:e});const c=new r.Point2D;for(;a.length>0;){const e=a.at(-1);a.pop(),m.setStartXY(t.getXY(e.from));const u=e.to===o?s:e.to;m.setEndXY(t.getXY(u));let f=i,g=-1;for(let i=e.from+1,s=e.to;i<s;i++){const e=t.getXY(i),s=m.getClosestCoordinate(e,!1);m.queryCoord2D(s,c);const n=r.Point2D.sqrDistance(c,e);f<n&&(f=n,g=i)}g>=0?(h||(n=n.clone(),h=!0),n.write(g,0),g-e.from>1&&a.push({from:e.from,to:g}),e.to-g>1&&a.push({from:g,to:e.to})):l=!0}}f=c}}}if(!l)return t;const c=function(t,e){const i=t.createInstance(),n=new s.Point;for(let s=0,o=t.getPathCount();s<o;s++){let o=!0,r=0,h=0;const m=t.getPathStart(s),a=t.getPathEnd(s);let l=!0;for(let c=m;c<a;c++)1===e.read(c)?(!l&&h>0&&(i.addSegmentsFromPath(t,s,r-m,h,o),h=0),l=!0):l?(l=!1,t.getPointByVal(c,n),o?(i.startPathPoint(n),o=!1):i.lineToPoint(n),r=c):h++;h>0&&i.addSegmentsFromPath(t,s,r-m,h,o)}return i}(t,n);return c.dropAttribute(10),c}(t,n);return a.dropAttribute(10),a!==t&&a.getGeometryType()===i.GeometryType.enumPolygon&&(a=(new m.OperatorSimplify).execute(a,e,!1,h)),a}}function g(t){if(!t)return!1;const e=t.getCoordinateSystemType();return 2===e||1===e}function p(t,e,i,s,n,r,h,m,a,l,c,u,f){const g=t.createInstance();g.addAttribute(10);const p=t.querySegmentIterator(),P=[],T=[],S=new o.SegmentBuffer,I=t.getDescription().getAttributeCount()>1,x=new z(e,i,s,n,r,h,m,l,c,u,I?T:null,P,f);for(;p.nextPath();)for(;p.hasNextSegment();){const t=p.nextSegment(),e=t.getStartXY(),i=t.getEndXY(),s=e.compare(i)>0,n=D(s,t,S);if(P.length=0,T.length=0,!x.densifySegment(p.isFirstSegmentInPath(),n))return null;s&&b(I?T:null,P),P.at(-1).setCoordsPoint2D(t.getEndXY());const o=g.getPointCount();if(I){const e=D(s,t,S);_(p.isFirstSegmentInPath(),p.isLastSegmentInPath()&&!p.isPathClosed(),t,e,T,P,g)}else d(p.isFirstSegmentInPath(),p.isLastSegmentInPath()&&!p.isPathClosed(),P,g);if(x.needsPostFiltering()){g.addAttribute(10);const t=g.getAttributeStreamRef(10);for(let e=1,i=P.length-1;e<i;e++)t.write(e+o,1)}}return g}function d(t,e,i,s){t&&s.insertPath2D(-1,null,0,0,!0);const n=s.getPathCount()-1;e?s.insertPointsFromPoints(n,-1,i,0,i.length,!0):s.insertPointsFromPoints(n,-1,i,0,i.length-1,!0)}function _(t,e,i,n,o,r,h){h.reserve(h.getPointCount()+r.length-1);const m=new s.Point;if(i.queryStart(m),t?h.startPathPoint(m):h.lineToPoint(m),r.length>2){const t=n.calculateLength2D();for(let e=1;e<r.length-1;e++){const i=n.lengthToT(o[e]*t);n.queryCoord(i,m),m.setXY(r[e]),h.lineToPoint(m)}}e&&(i.queryEnd(m),h.lineToPoint(m))}function P(t,e){const i=e.getInputSR(),s=e.getOutputSR(),n=new r.Point2D;2===i.getCoordinateSystemType()?(n.setCoordsPoint2D(t),m.PEProjToGeogCenterPoint2D(i,0,[n],1)):n.setCoordsPoint2D(t);const o=new r.Point2D;o.setCoordsPoint2D(n),m.PEGeogToGeogStable(e,[o],null,1,!1);const h=new r.Point2D;return 2===s.getCoordinateSystemType()?(h.setCoordsPoint2D(o),m.PEGeogToProj(s,[h],1,!1)):h.setCoordsPoint2D(o),h}function T(t,e,i,s,n,o,h,m){if(n){const n=o.width(),a=.5*n;if(s){const s=.25*n;let o=!1;const l=new r.Point2D,c=new r.Point2D;if(Math.abs(t.y)===s?(l.setCoords(i.x,t.y),c.setCoordsPoint2D(i),o=!0):Math.abs(i.y)===s&&(c.setCoords(t.x,i.y),l.setCoordsPoint2D(t),o=!0),Math.abs(e.y)===s&&(o||(l.setCoordsPoint2D(t),c.setCoordsPoint2D(i),o=!0),l.x=e.x),o)return E(e,l,a,n,h),E(e,c,a,n,m),!0}let l=0;t.x-e.x>a&&i.x-e.x>a?l-=n:e.x-t.x>a&&e.x-i.x>a&&(l+=n),Math.abs(e.x-(t.x+l))<a?(h.setCoordsPoint2D(t),E(h,i,a,n,m),h.x+=l,m.x+=l):(h.setCoordsPoint2D(i),E(h,t,a,n,m),h.x+=l,m.x+=l)}else h.setCoordsPoint2D(t),m.setCoordsPoint2D(i);return!1}function D(t,e,i){return t?(i.create(e.getGeometryType()),e.copyTo(i.get()),i.get().reverse(),i.get()):e}function b(t,e){e.reverse(),null!==t&&t.reverse()}function S(t,e,i,s){const n=.5*(s.getStartX()+s.getEndX());if(n-i>t){const t=new h.Transformation2D;t.setShiftCoords(-e,0),s.applyTransformation(t)}else if(i-n>t){const t=new h.Transformation2D;t.setShiftCoords(e,0),s.applyTransformation(t)}}function I(t,e,i,s,o,r,m,a,l){const c=[!1];m&&x(t,e,i,s,o,r,!0,a,c,l);let u=t;return c[0]||(u=x(u,e,i,s,o,r,!1,a,null,l)),u=function(t,e,i,s){let o;if(!e)return t;const r=i.getCenter().x,m=i.width(),a=.5*m,l=new n.Envelope2D;t.queryEnvelope(l);const c=l.getCenter().x;let u=0;if(c-r>a?u=-Math.ceil((c-r-a)/m)*m:r-c>a&&(u=Math.ceil((r-c-a)/m)*m),0!==u){o=s?t:t.clone();const e=new h.Transformation2D;e.setShiftCoords(u,0),o.applyTransformation(e)}else o=t;return o}(u,o,r,u!==t),u}function x(t,e,s,o,r,l,c,u,f,g){if(c&&(f[0]=!1),null==s)return t;const p=new n.Envelope2D,d=new n.Envelope2D;s.queryEnvelope(p),t.queryEnvelope(d);const _=t.getGeometryType(),P=s.getGeometryType(),T=e.getTolerance(0);if(!r){if(c)return f[0]=F(t,s,e,o,g),null;let n;return n=o?P===i.GeometryType.enumEnvelope?a.clip$1(t,p,T,u,g):(new m.OperatorIntersection).execute(t,s,e,g):(new m.OperatorDifference).execute(t,s,e,g),n===s&&(n=s.clone()),n}const D=l.width(),b=D*Math.ceil(p.width()/D);let S=null;if(o){let l=y(t,s,r,b),I=0;const x=new h.Transformation2D;do{let r=null;if(P===i.GeometryType.enumEnvelope){const i=s.clone();if(x.setShiftCoords(l*b,0),i.applyTransformation(x),c){if(f[0]=F(t,i,e,o,g),!f[0])return null}else{const e=new n.Envelope2D;i.queryEnvelope(e),r=a.clip$1(t,e,T,u,g)}}else{const i=t.clone();if(x.setShiftCoords(-l*b,0),i.applyTransformation(x),c){if(f[0]=F(i,s,e,o,g),!f[0])return null}else r=(new m.OperatorIntersection).execute(i,s,e,g),r===s&&(r=s.clone())}if(!c){if(r.isEmpty())continue;if(_===i.GeometryType.enumPolygon){const t=new n.Envelope2D;if(r.queryEnvelope(t),t.width()<=T)continue}P===i.GeometryType.enumEnvelope&&(x.setShiftCoords(-l*b,0),r===t&&(r=r.clone()),r.applyTransformation(x)),null===S?S=r===t?r.clone():r:S.add(r,!1)}I++}while(p.xmin+ ++l*b<d.xmax);if(c)return null;null===S&&(S=t.createInstance()),_===i.GeometryType.enumPolygon&&I>1&&D-d.width()<=10*T&&(S=(new m.OperatorSimplify).execute(S,e,!0,g))}else{let i=y(t,s,r,b);if(S=t.clone(),0!==i){const t=new h.Transformation2D;t.setShiftCoords(-i*b,0),S.applyTransformation(t)}do{if(c){if(f[0]=F(S,s,e,o,g),!f[0])return null}else if(S=(new m.OperatorDifference).execute(S,s,e,g),S===s&&(S=s.clone()),S.isEmpty())break;const t=new h.Transformation2D;t.setShiftCoords(-b,0),S.applyTransformation(t)}while(p.xmin+ ++i*b<d.xmax);if(c)return null;if(!S.isEmpty()&&0!==i){const t=new h.Transformation2D;t.setShiftCoords(i*b,0),S.applyTransformation(t)}}return S}function F(t,e,s,o,r){let h;if(e.getGeometryType()===i.GeometryType.enumPolygon)h=o?m.relate(e,t,s,64,r):m.relate(e,t,s,4,r);else if(o){const i=new n.Envelope2D,s=new n.Envelope2D;e.queryEnvelope(i),t.queryEnvelope(s),h=i.containsEnvelope(s)}else h=m.relate(e,t,s,4,r);return h}function y(t,e,i,s){if(!i)return 0;let o=0;const r=new n.Envelope2D;e.queryEnvelope(r);const h=new n.Envelope2D;t.queryEnvelope(h);const m=r.xmin+s;for(;m+s+o*s>h.xmin;)o--;for(;m+o*s<h.xmin;)o++;return o}function E(t,e,i,s,n){e.x-t.x>i?n.setCoords(e.x-s,e.y):t.x-e.x>i?n.setCoords(e.x+s,e.y):n.setCoordsPoint2D(e)}function C(t,e,i,s,n,o,r){Math.abs(t.y)===i?(o.setCoords(e.x,t.y),r.setCoordsPoint2D(e)):Math.abs(e.y)===i?(o.setCoordsPoint2D(t),r.setCoords(t.x,e.y)):(o.setCoordsPoint2D(t),E(o,e,s,n,r))}function N(t){return t.getUnit().getUnitToBaseFactor()}function v(t){return t.getUnit().getUnitToBaseFactor()}function w(t){return t.getPECoordSys().getDatum().getSpheroid().getAxis()}function G(t,e,i){return i<=.5?t+(e-t)*i:e-(e-t)*(1-i)}class z{checkSegment(){for(let t=0;t<this.n;t++){if(null!==this.pSplitLines2Info&&this.pSplitLines2Info.hasSplitLines()&&!this.bCheckIfNoDensificationNeededForCurve){const t=this.pSplitLines2Info.getSplitLineFactorEx(this.rectifiedSegment,this.leftFactor,this.rightFactor,this.leftGcsToDensifiedPoint,this.rightGcsToDensifiedPoint,this.progressTracker);if(Number.isNaN(t))return-1;if(-1!==t&&this.leftFactor<t&&t<this.rightFactor)return this.cutFactor=t,this.cutFromDensifiedPoint.assign(this.rectifiedSegment.getCoord2D(this.cutFactor)),this.cutToDensifiedPoint.assign(P(this.cutFromDensifiedPoint,this.transform)),this.cutGcsToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.cutToDensifiedPoint.assign(P(this.cutGcsToDensifiedPoint,this.transform2)),this.midFactor=this.cutFactor,this.midFromDensifiedPoint.setCoordsPoint2D(this.cutFromDensifiedPoint),this.midToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.midGcsToDensifiedPoint.setCoordsPoint2D(this.cutGcsToDensifiedPoint),1}if(this.cutFactor=G(this.leftFactor,this.rightFactor,this.scalars[t]),this.cutFromDensifiedPoint.assign(this.rectifiedSegment.getCoord2D(this.cutFactor)),this.cutToDensifiedPoint.assign(P(this.cutFromDensifiedPoint,this.transform)),null!==this.transform2&&(this.cutGcsToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.cutToDensifiedPoint.assign(P(this.cutGcsToDensifiedPoint,this.transform2))),0===t&&(this.midFactor=this.cutFactor,this.midFromDensifiedPoint.setCoordsPoint2D(this.cutFromDensifiedPoint),this.midToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.midGcsToDensifiedPoint.setCoordsPoint2D(this.cutGcsToDensifiedPoint)),this.bIsPannableFrom&&!this.bCheckIfNoDensificationNeededForCurve&&Math.abs(this.leftFromDensifiedPoint.x-this.rightFromDensifiedPoint.x)>=.25*this.pannableExtentFrom.width())return 1;let e;if(this.bCheckIfNoDensificationNeededForCurve){const t=this.projCurveSegment.get().getClosestCoordinate(this.cutToDensifiedPoint,!1),i=this.projCurveSegment.get().getCoord2D(t);e=r.Point2D.sqrDistance(this.cutToDensifiedPoint,i)}else{const i=new r.Point2D,s=new r.Point2D,n=T(this.leftToDensifiedPoint,this.cutToDensifiedPoint,this.rightToDensifiedPoint,this.bSrToIsGcs,this.bIsPannableTo,this.pannableExtentTo,i,s);this.line.setStartXY(i),this.line.setEndXY(s);const o=this.line.getClosestCoordinate(this.cutToDensifiedPoint,!0);if(n||t>0||Math.abs(o-this.scalars[t])<.3){const t=this.line.getCoord2D(o);e=r.Point2D.sqrDistance(this.cutToDensifiedPoint,t)}else e=2*this.maxDeviationInSrToSq,this.bNeedPostFiltering=!0}if(e>this.maxDeviationInSrToSq)return this.bCheckIfNoDensificationNeededForCurve=!1,1}return 0}constructor(t,e,i,s,h,m,a,l,c,u,f,g,p){this.leftFromDensifiedPoint=new r.Point2D,this.rightFromDensifiedPoint=new r.Point2D,this.cutFromDensifiedPoint=new r.Point2D,this.midFromDensifiedPoint=new r.Point2D,this.leftToDensifiedPoint=new r.Point2D,this.rightToDensifiedPoint=new r.Point2D,this.cutToDensifiedPoint=new r.Point2D,this.midToDensifiedPoint=new r.Point2D,this.line=new o.Line,this.leftGcsToDensifiedPoint=new r.Point2D,this.rightGcsToDensifiedPoint=new r.Point2D,this.cutGcsToDensifiedPoint=new r.Point2D,this.midGcsToDensifiedPoint=new r.Point2D,this.bSrToIsGcs=!1,this.bIsCurve=!1,this.leftFactor=0,this.rightFactor=0,this.bIsFirstInPath=!1,this.rectifiedSegment=null,this.transform=null,this.bIsPannableFrom=!1,this.pannableExtentFrom=new n.Envelope2D,this.bIsPannableTo=!1,this.bNeedPostFiltering=!1,this.pannableExtentTo=new n.Envelope2D,this.transform2=null,this.pHorizon2Info=null,this.pSplitLines2Info=null,this.minLengthInSrFrom=0,this.maxDeviationInSrToSq=0,this.cutFactor=0,this.midFactor=0,this.pDensifiedFactors=null,this.pDensifiedPoints=[],this.rightFromDensifiedPointsStack=[],this.rightToDensifiedPointsStack=[],this.rightGcsToDensifiedPointsStack=[],this.rightFactorsStack=[],this.projCurveSegment=new o.SegmentBuffer,this.n=0,this.bCheckIfNoDensificationNeededForCurve=!1,this.scalars=r.makePrimitiveArray(7,Number.NaN),this.progressTracker=p,this.transform=t,this.bIsPannableFrom=e,this.pannableExtentFrom.assign(i),this.bIsPannableTo=s,this.pannableExtentTo.assign(h),this.transform2=m,this.pHorizon2Info=a,this.pSplitLines2Info=l,this.minLengthInSrFrom=c,this.maxDeviationInSrToSq=u,this.pDensifiedFactors=f,this.pDensifiedPoints=g,this.progressTracker=p,this.bNeedPostFiltering=!1}needsPostFiltering(){return this.bNeedPostFiltering}densifySegment(t,e){if(this.bIsFirstInPath=t,this.rectifiedSegment=e,this.leftGcsToDensifiedPoint.setNAN(),this.rightGcsToDensifiedPoint.setNAN(),this.cutGcsToDensifiedPoint.setNAN(),this.midGcsToDensifiedPoint.setNAN(),this.bSrToIsGcs=null!=this.transform2?1===this.transform2.getOutputSR().getCoordinateSystemType():1===this.transform.getOutputSR().getCoordinateSystemType(),this.bIsCurve=this.rectifiedSegment.isCurve(),this.leftFactor=0,this.rightFactor=1,this.leftFromDensifiedPoint.assign(this.rectifiedSegment.getStartXY()),this.rightFromDensifiedPoint.assign(this.rectifiedSegment.getEndXY()),this.leftToDensifiedPoint.assign(P(this.leftFromDensifiedPoint,this.transform)),this.rightToDensifiedPoint.assign(P(this.rightFromDensifiedPoint,this.transform)),null!==this.transform2&&(this.leftGcsToDensifiedPoint.setCoordsPoint2D(this.leftToDensifiedPoint),this.rightGcsToDensifiedPoint.setCoordsPoint2D(this.rightToDensifiedPoint),this.leftToDensifiedPoint.assign(P(this.leftGcsToDensifiedPoint,this.transform2)),this.rightToDensifiedPoint.assign(P(this.rightGcsToDensifiedPoint,this.transform2)),this.bIsFirstInPath&&!this.pHorizon2Info.isPointStartInHorizon(this.leftGcsToDensifiedPoint,this.progressTracker)))return!1;this.rightFromDensifiedPointsStack.length=0,this.rightToDensifiedPointsStack.length=0,this.rightGcsToDensifiedPointsStack.length=0,this.rightFactorsStack.length=0,this.rightFromDensifiedPointsStack.push(this.rightFromDensifiedPoint.clone()),this.rightToDensifiedPointsStack.push(this.rightToDensifiedPoint.clone()),this.rightFactorsStack.push(this.rightFactor),null!=this.transform2&&this.rightGcsToDensifiedPointsStack.push(this.rightGcsToDensifiedPoint.clone()),null!==this.pDensifiedPoints&&this.pDensifiedPoints.push(this.leftFromDensifiedPoint.clone()),null!==this.pDensifiedFactors&&this.pDensifiedFactors.push(this.leftFactor),this.bIsCurve?this.rectifiedSegment.getGeometryType()===i.GeometryType.enumBezier?this.n=7:this.n=5:this.n=3,function(t,e){for(let i=0;i<t;i++){let s=Math.ceil(i/2)/(t+1);i%2!=0&&(s=-s);const n=.5+s;e[i]=n}}(this.n,this.scalars);const s=this.rectifiedSegment.calculateLength2D();if(this.bCheckIfNoDensificationNeededForCurve=!1,this.bIsCurve){const t=new o.Polyline({vd:this.rectifiedSegment.getDescription()});let e=(new m.OperatorProject).execute(t,this.transform,this.progressTracker);if(null!==this.transform2){const t=new n.Envelope2D;if(e.queryEnvelope(t),!this.pHorizon2Info.isEnvelopeInHorizon(t,this.progressTracker))return!1;e=(new m.OperatorProject).execute(e,this.transform2,this.progressTracker)}e.getSegmentBuffer(0,this.projCurveSegment,!1),this.bCheckIfNoDensificationNeededForCurve=!0}for(;this.rightFromDensifiedPointsStack.length>0;){let t=!1;if(this.cutFactor=Number.NaN,this.midFactor=Number.NaN,this.midFromDensifiedPoint.setNAN(),this.midToDensifiedPoint.setNAN(),(this.rightFactor-this.leftFactor)*s>this.minLengthInSrFrom){const e=this.checkSegment();if(-1===e)return!1;t=0!==e}if(t)this.rightFromDensifiedPoint.setCoordsPoint2D(this.midFromDensifiedPoint),this.rightToDensifiedPoint.setCoordsPoint2D(this.midToDensifiedPoint),this.rightFactor=this.midFactor,this.rightFromDensifiedPointsStack.push(this.rightFromDensifiedPoint.clone()),this.rightToDensifiedPointsStack.push(this.rightToDensifiedPoint.clone()),this.rightFactorsStack.push(this.rightFactor),null!==this.transform2&&(this.rightGcsToDensifiedPoint.setCoordsPoint2D(this.midGcsToDensifiedPoint),this.rightGcsToDensifiedPointsStack.push(this.rightGcsToDensifiedPoint.clone()));else{if(null!==this.transform2&&!this.pHorizon2Info.isAdjoiningLineInHorizon(this.leftGcsToDensifiedPoint,this.rightGcsToDensifiedPoint,this.progressTracker))return!1;if(this.rightFromDensifiedPointsStack.pop(),this.rightToDensifiedPointsStack.pop(),this.rightFactorsStack.pop(),null!==this.transform2&&this.rightGcsToDensifiedPointsStack.pop(),null!==this.pDensifiedPoints&&this.pDensifiedPoints.push(this.rightFromDensifiedPoint.clone()),null!==this.pDensifiedFactors&&this.pDensifiedFactors.push(this.rightFactor),this.rightFromDensifiedPointsStack.length>0){this.leftFromDensifiedPoint.setCoordsPoint2D(this.rightFromDensifiedPoint),this.leftToDensifiedPoint.setCoordsPoint2D(this.rightToDensifiedPoint),this.leftFactor=this.rightFactor;const t=this.rightFromDensifiedPointsStack.at(-1),e=this.rightToDensifiedPointsStack.at(-1);if(this.rightFromDensifiedPoint.setCoordsPoint2D(t),this.rightToDensifiedPoint.setCoordsPoint2D(e),this.rightFactor=this.rightFactorsStack.at(-1),null!==this.transform2){this.leftGcsToDensifiedPoint.setCoordsPoint2D(this.rightGcsToDensifiedPoint);const t=this.rightGcsToDensifiedPointsStack.at(-1);this.rightGcsToDensifiedPoint.setCoordsPoint2D(t)}}}}return!0}}class k extends e.GeometryCursor{constructor(t,e,s,n,o,r){super(),this.m_spp=null,this.m_index=-1,t||i.throwInvalidArgumentException(""),this.m_progressTracker=r,this.m_geometries=t,this.m_geometriesExtent=e?e.clone():null,this.m_transform=s,this.m_minSegmentLengthInDegrees=n,this.m_maxDeviationInSrTo=o}tock(){return!0}getRank(){return 1}next(){this.m_spp||(this.m_spp=new f,this.m_spp.prepare(this.m_transform,this.m_geometriesExtent,this.m_progressTracker));const t=this.m_geometries.next();return i.throwIfMesh(t),i.throwIfCurves(t),null!=t?(this.m_index=this.m_geometries.getGeometryID(),this.m_spp.execute(t,this.m_minSegmentLengthInDegrees,this.m_maxDeviationInSrTo,this.m_progressTracker)):null}getGeometryID(){return this.m_index}}t.OperatorShapePreservingProject=class{getOperatorType(){return 10315}supportsCurves(){return!1}accelerateGeometry(t,e,i){return!1}canAccelerateGeometry(t){return!1}executeMany(t,e,i,s,n,o){return l(i)?new k(t,e,i,s,n,o):(new m.OperatorProject).executeMany(t,i,o)}execute(t,e,i,s,n){if(!l(e))return(new m.OperatorProject).execute(t,e,n);const o=new f;return o.prepare(e,null,n),o.execute(t,i,s,n)}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});