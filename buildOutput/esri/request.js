// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","./config","./kernel","./core/Error","./core/has","./core/lang","./core/MapUtils","./core/promiseUtils","./core/urlUtils","./layers/support/arcgisLayerUrl","./portal/support/urlUtils","./support/apiKeyUtils","./support/requestUtils"],function(e,r,t,s,o,n,a,i,l,u,c,d,p){"use strict";const h=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));async function f(r,t){r instanceof URL&&(r=r.toString()),t?.query instanceof URLSearchParams&&(t.query=l.queryToObject(t.query.toString().replaceAll("+"," ")));const s=l.isDataProtocol(r),n=l.isBlobProtocol(r);n||s||(r=l.normalize(r));const c={url:r,requestOptions:{...t}},d=e=>({data:e,getAllHeaders:T,getHeader:T,httpStatus:200,requestOptions:c.requestOptions,url:c.url}),p=l.getInterceptor(r,g.internalInterceptors);if(p){const e=await A(p,c);if(null!=e)return d(e)}let h=l.getInterceptor(r);if(h){const e=await A(h,c);if(null!=e)return d(e);h.after||h.error||(h=null)}if(r=c.url,"image"===(t=c.requestOptions).responseType&&(o("host-webworker")||o("host-node")))throw v("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),c);if("head"===t.method){if(t.body)throw v("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),c);if(s||n)throw v("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),c)}if(await async function(){o("host-webworker")&&(!m&&globalThis.invokeStaticMessage?m=await new Promise((r,t)=>e(["./core/workers/request"],r,t)):y=!0)}(),m)return m.execute(r,t);const f=new AbortController,w=i.onAbort(t,()=>f.abort()),b={controller:f,credential:void 0,credentialToken:void 0,fetchOptions:void 0,hasToken:!1,interceptor:h,params:c,redoRequest:!1,useIdentity:g.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},q=t.useRequestQueue?async function(r){const t=function(e){let r,t;return"string"==typeof e?(r=l.getOrigin(e,!0),t=u.isHostedAgolService(e)):(r=e.origin,t=u.isHostedAgolService(e.toString())),null==r?null:{origin:r,isHosted:t}}(r.params.url);if(!t)return L(r);const{QueueProcessor:s}=await new Promise((r,t)=>e(["./core/QueueProcessor"],r,t)),n=a.getOrCreateMapValue(U,t.origin,()=>{const e=t.isHosted?o("request-queue-concurrency-hosted"):o("request-queue-concurrency-non-hosted");return new s({concurrency:e,process:e=>{if(i.isAborted(e.params.requestOptions))throw v("",i.createAbortError("Request canceled"),e.params);return L(e)}})});return n.push(r)}(b):L(b),S=await q.finally(()=>w?.remove());return h?.after?.(S),S}let m,y=!1;const g=r.request,w="FormData"in globalThis,b=new Set([499,498,403,401]),q=new Set(["COM_0056","COM_0057","SB_0008"]),S=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],T=()=>null,O=Symbol();function k(e){const r=l.getOrigin(e);return!r||r.endsWith(".arcgis.com")||f._corsServers.includes(r)||l.isTrustedServer(r)}function v(e,r,t,o){let a;const l={url:t.url,requestOptions:t.requestOptions,getAllHeaders:T,getHeader:T,ssl:!1};if(r instanceof s)return r.details?(r.details=n.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=l,r;if(r){const e=o&&(()=>Array.from(o.headers)),t=o&&(e=>o.headers.get(e)),s=o?.status,n=r.message;n&&(a=n),e&&t&&(l.getAllHeaders=e,l.getHeader=t),l.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||s||0,l.subCode=r.subcode,l.messageCode=r.messageCode,"string"==typeof r.details?(l.messages=[r.details],a??=r.details):(l.messages=r.details,a??=l.messages?.[0]),l.raw=O in r?r[O]:r}return a??="Error",i.isAbortError(r)?i.createAbortError():new s(e,a,l)}async function P(){t.id||await new Promise((r,t)=>e(["./identity/IdentityManager"],e=>r(h(e)),t))}function C(e){return S.some(r=>r.test(e))}async function x(e){let r=e.params.url,s=p.getPreferredUrl(r);const n=e.params.requestOptions,a=e.fetchOptions??{},u=l.isBlobProtocol(r)||l.isDataProtocol(r),d=n.responseType||"json",h=u?0:null!=n.timeout?n.timeout:g.timeout;let m=!1;if(!u){e.useSSL&&(r=l.toHTTPS(r));let i={...n.query};e.credentialToken&&(i.token=e.credentialToken);let u=l.objectToQuery(i);o("esri-url-encodes-apostrophe")&&(u=u.replaceAll("'","%27"));const d=s.length+1+u.length;let h;m="delete"===n.method||"post"===n.method||"put"===n.method||!!n.body||d>g.maxUrlLength;const f=n.useProxy||!!l.getProxyRule(r);if(f){const e=l.getProxyUrl(r);h=e.path,!m&&h.length+1+d>g.maxUrlLength&&(m=!0),e.query&&(i={...e.query,...i})}if("HEAD"===a.method&&(m||f)){if(m){if(d>g.maxUrlLength)throw v("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params);throw v("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params)}if(f)throw v("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}if(m?(a.method="delete"===n.method?"DELETE":"put"===n.method?"PUT":"POST",n.body?r=l.addQueryParameters(r,i):(a.body=l.objectToQuery(i),a.headers||(a.headers={}),a.headers["Content-Type"]="application/x-www-form-urlencoded")):r=l.addQueryParameters(r,i),f&&(e.useProxy=!0,r=`${h}?${r}`),i.token&&w&&a.body instanceof FormData&&!c.isSecureProxyService(r)&&a.body.set("token",i.token),n.hasOwnProperty("withCredentials"))e.withCredentials=n.withCredentials;else if(!l.hasSameOrigin(r,l.getAppUrl()))if(l.isTrustedServer(r))e.withCredentials=!0;else if(t.id){const s=t.id.findServerInfo(r);s?.webTierAuth&&(e.withCredentials=!0)}e.withCredentials&&(a.credentials="include",p.isNoCorsRequestRequired(r)&&await p.sendNoCorsRequest(m?l.addQueryParameters(r,i):r)),s=p.getPreferredUrl(r)}let y,b,q=0,S=!1;h>0&&(q=setTimeout(()=>{S=!0,e.controller.abort()},h));try{if("native-request-init"===n.responseType)b=a,b.url=s,n.signal?b.signal=n.signal:delete b.signal;else if("image"!==n.responseType||"default"!==a.cache||"GET"!==a.method||m||function(e){if(e)for(const r of Object.getOwnPropertyNames(e))if(e[r])return!0;return!1}(n.headers)||!u&&!e.useProxy&&g.proxyUrl&&!k(r)){if(f._beforeFetch&&await f._beforeFetch(r,a),y=await fetch(s,a),f._afterFetch&&await f._afterFetch(y),e.useProxy||function(e){const r=l.getOrigin(e);r&&!f._corsServers.includes(r)&&f._corsServers.push(r)}(r),"native"===n.responseType)b=y;else if("HEAD"!==a.method)if(y.ok){switch(d){case"array-buffer":b=await y.arrayBuffer();break;case"blob":case"image":b=await y.blob();break;default:b=await y.text()}if(q&&(clearTimeout(q),q=0),"json"===d||"xml"===d||"document"===d)if(b)switch(d){case"json":b=JSON.parse(b);break;case"xml":b=E(b,"application/xml");break;case"document":b=E(b,"text/html")}else b=null;if(b){if("array-buffer"===d||"blob"===d){const e=y.headers.get("Content-Type");if(e&&/application\/json|text\/plain/i.test(e)&&b["blob"===d?"size":"byteLength"]<=750)try{const e=await new Response(b).json();e.error&&(b=e)}catch{}}"image"===d&&b instanceof Blob&&(b=await R(URL.createObjectURL(b),e,!0))}}else{b=await y.text();try{b=JSON.parse(b)}catch{}}}else b=await R(s,e)}catch(t){if("AbortError"===t.name){if(S)throw p.createTimeoutError();throw i.createAbortError("Request canceled")}if(!(!y&&t instanceof TypeError&&g.proxyUrl)||n.body||"delete"===n.method||"head"===n.method||"post"===n.method||"put"===n.method||e.useProxy||k(r))throw t;e.redoRequest=!0,l.addProxyRule({proxyUrl:g.proxyUrl,urlPrefix:l.getOrigin(r)??""})}finally{q&&clearTimeout(q)}return[y,b]}async function A(e,r){if(null!=e.responseData)return e.responseData;if(e.headers&&(r.requestOptions.headers={...r.requestOptions.headers,...e.headers}),e.query&&(r.requestOptions.query={...r.requestOptions.query,...e.query}),e.before){let t,o;try{o=await e.before(r)}catch(e){t=v("request:interceptor",e,r)}if((o instanceof Error||o instanceof s)&&(t=v("request:interceptor",o,r)),t)throw e.error&&e.error(t),t;return o}}function E(e,r){let t;try{t=(new DOMParser).parseFromString(e,r)}catch{}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}f._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"],f._beforeFetch=void 0,f._afterFetch=void 0;const U=new Map;async function L(e){let r,s;await async function(e){const r=e.params.url,s=e.params.requestOptions,o=e.controller.signal,n=s.body;let a=null,l=null;if(w&&"HTMLFormElement"in globalThis&&(n instanceof FormData?a=n:n instanceof HTMLFormElement&&(a=new FormData(n))),"string"==typeof n&&(l=n),e.fetchOptions={cache:s.cacheBust?"no-cache":"default",credentials:"same-origin",headers:s.headers||{},method:"head"===s.method?"HEAD":"GET",mode:"cors",priority:g.priority,redirect:"follow",signal:o},(a||l)&&(e.fetchOptions.body=a||l),(y||"anonymous"===s.authMode)&&(e.useIdentity=!1),e.hasToken=!!(/token=/i.test(r)||s.query?.token||a?.get("token")),!e.hasToken){const t=d.getApiKey(r);t&&(s.query??={},s.query.token=t,e.hasToken=!0)}if(e.useIdentity&&!e.hasToken&&!e.credential&&!e.credentialToken&&!C(r)&&!i.isAborted(o)){let n;"immediate"===s.authMode?(await P(),n=await t.id.getCredential(r,{signal:o})):"no-prompt"===s.authMode?(await P(),n=await t.id.getCredential(r,{prompt:!1,signal:o}).catch(()=>{})):t.id&&(n=t.id.findCredential(r)),n&&(e.credential=n,e.credentialToken=n.token,e.useSSL=!!n.ssl)}}(e);try{do{[r,s]=await x(e)}while(!await H(e,r,s))}catch(t){const s=v("request:server",t,e.params,r);throw s.details.ssl=e.useSSL,e.interceptor?.error&&e.interceptor.error(s),s}const o=e.params.url;if(s)if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(o)){if(!e.hasToken&&!e.credentialToken&&s.user?.username&&!l.isTrustedServer(o)){const e=l.getOrigin(o,!0);e&&g.trustedServers.push(e)}Array.isArray(s.authorizedCrossOriginNoCorsDomains)&&p.registerNoCorsDomains(s.authorizedCrossOriginNoCorsDomains)}else"json"===(e.params.requestOptions.responseType||"json")&&p.setPreferredHost(o,s);const n=e.credential;if(n&&t.id){const e=t.id.findServerInfo(n.server);let r=e?.owningSystemUrl;if(r){r=r.replace(/\/?$/,"/sharing");const e=t.id.findCredential(r,n.userId);e&&-1===t.id._getIdenticalSvcIdx(r,e)&&e.resources.unshift(r)}}return{data:s,getAllHeaders:r?()=>Array.from(r.headers):T,getHeader:r?e=>r.headers.get(e):T,httpStatus:r?.status??200,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}}async function H(e,r,s){if(e.redoRequest)return e.redoRequest=!1,!1;const o=e.params.requestOptions;if(!r||"native"===o.responseType||"native-request-init"===o.responseType)return!0;let n,a;if(s&&(s.error&&"object"==typeof s.error?n=s.error:"error"===s.status&&Array.isArray(s.messages)&&(n={...s},n[O]=s,n.details=s.messages)),!n&&!r.ok)throw n=new Error(`Unable to load ${r.url} status: ${r.status}`),n[O]=s,n;let i,l=null;n&&(a=Number(n.code),l=n.hasOwnProperty("subcode")?Number(n.subcode):null,i=n.messageCode,i=i?.toUpperCase());const u=o.authMode;if(403===a&&(4===l||n.message?.toLowerCase().includes("ssl")&&!n.message.toLowerCase().includes("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&("no-prompt"!==u||498===a)&&void 0!==a&&b.has(a)&&!C(e.params.url)&&(403!==a||(!i||!q.has(i))&&(null==l||2===l&&e.credentialToken))){await P();try{const r=await t.id.getCredential(e.params.url,{error:v("request:server",n,e.params),credential:e.credential,prompt:"no-prompt"!==u,signal:e.controller.signal,token:e.credentialToken});return e.credential=r,e.credentialToken=r.token,e.useSSL=e.useSSL||r.ssl,!1}catch(r){if("no-prompt"===u)return e.credential=void 0,e.credentialToken=void 0,!1;n=r}}if(n)throw n;return!0}function R(e,r,t=!1){const s=r.controller.signal,o=new Image;return r.withCredentials?o.crossOrigin="use-credentials":o.crossOrigin="anonymous",o.alt="",o.fetchPriority=g.priority,o.src=e,p.loadImageAsync(o,e,t,s)}return f});