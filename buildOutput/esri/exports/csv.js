// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../core/Logger","../layers/support/Field"],function(e,t,n){"use strict";function i(e){return Object.keys(e.attributes).map(t=>{const i=e.attributes[t];return"objectid"===t.toLowerCase()||"fid"===t.toLowerCase()?new n({name:t,alias:t,type:"oid"}):new n("number"==typeof i?{name:t,alias:t,type:"double"}:{name:t,alias:t,type:"string"})})}function r(e){if(!e.fields){const t=e.features[0];if(t.layer){e.fields=t.layer.fields;const n=Object.keys(t.attributes),i=e.fields.filter(e=>n.includes(e.name));e.fields=i}else e.fields=i(t)}return e}function o(e){return e.map(({attributes:e})=>e)}function a(e){const{delimiter:t,fields:n=[],outFields:i=[]}=e,r=t||",",o=n.map(e=>e.name);return e=>{let t="";return o.filter(e=>i.includes(e)).forEach(i=>{const o=n.find(({name:e})=>e===i);let a=e[i]||"";if("date"===o?.type&&(a=new Date(a).toString()),o?.domain&&"coded-value"===o.domain.type){const e=o.domain.codedValues.find(e=>a===e.code);e&&(a=e.name)}"string"==typeof a&&a.includes(r)&&(a=`"${a}"`),t+=`${a}${r}`}),`${t}\r\n`}}e.attributeToString=a,e.convertFeaturesToCSV=async function(e,{includeGeometry:i=!0,delimiter:l=",",outFields:s=["*"]}={}){e=r(e),i&&"point"!==e.geometryType&&t.getLogger("esri.exports.csv").warn(`The input geometry ${e.geometryType} is not supported. Geometry will be excluded from export.`);const{features:u}=e;if(!u.length)return null;let d=e.fields;const[c]=s;"*"===c&&(s=d.map(e=>e.name)),i&&"point"===e.geometryType&&(d.some(e=>"x"===e.name||"y"===e.name)||(d=[...d,new n({name:"lon",alias:"Longitude",type:"double"}),new n({name:"lat",alias:"Latitude",type:"double"})],s=[...s,"lon","lat"]),u.forEach(({attributes:e,geometry:t})=>{e.lon="point"===t?.type?t.longitude:null,e.lat="point"===t?.type?t.latitude:null})),d=d.filter(e=>s.includes(e.name));const m=l||",",f=o(u),p=d.map(e=>e.name).join(m),y=a({delimiter:m,outFields:s||d.map(e=>e.name),fields:d});let g=`${p}${m}\r\n`;f.forEach(e=>{g+=y(e)});const b=new RegExp(`${m}\r\n\\s*$`,"g");return g.replace(b,"")},e.extractAttributes=o,e.extractFieldsFromFeature=i,e.validateFeatureSetFields=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});