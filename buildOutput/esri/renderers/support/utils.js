// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/arrayUtils","../../core/Logger","../../core/MapUtils","../../intl/date","../../layers/support/fieldUtils","./numberUtils","../visualVariables/support/ColorStop","../../smartMapping/support/utils","../../symbols/support/utils","../../widgets/Legend/support/colorRampUtils","../../widgets/Legend/support/heatmapRampUtils"],function(e,l,t,o,a,i,n,r,s,u,f,m){"use strict";const d={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},p=a.convertDateFormatToIntlOptions("short-date");async function c(e,l,t){o.getOrCreateMapValue(e,l,()=>[]).push(...t)}async function y(e,l,t){const a=o.getOrCreateMapValue(e,l,()=>new Map);for(const e of t)a.set(e.value,e.color)}function g(e){let l=e.minValue,t=e.maxValue;const o=e.isFirstBreak?"":"> ",a="percent-of-total"===e.normalizationType?"%":"";return l=null==l?"":n.format(l),t=null==t?"":n.format(t),o+l+a+" â€“ "+t+a}function b(e,l){return"normalizationField"in e&&e.normalizationField?{type:"normalized-field",field:e.field,normalizationField:e.normalizationField}:"field"in e&&e.field?h(e.field):"valueExpression"in e&&e.valueExpression?{type:"expression",expression:e.valueExpression,title:e.valueExpressionTitle,returnType:l}:null}function h(e){return{type:"field",field:e}}function v(e){return"color"===e.type}e.calculateDateFormatInterval=function(e){const l=e.map(e=>new Date(e)),t=l.length;let o=1/0,a=null;for(let e=0;e<t-1;e++){const i=l[e];let n=1/0,r=null;for(let o=e+1;o<t;o++){const e=l[o],t=(i.getFullYear()!==e.getFullYear()?"year":i.getMonth()!==e.getMonth()&&"month")||i.getDate()!==e.getDate()&&"day"||i.getHours()!==e.getHours()&&"hour"||i.getMinutes()!==e.getMinutes()&&"minute"||i.getSeconds()!==e.getSeconds()&&"second"||"millisecond",a=d[t];a<n&&(n=a,r=t)}n<o&&(o=n,a=r)}return a},e.createClassBreakLabel=g,e.createColorStops=function(e){const{values:l,colors:t,labelIndexes:o,isDate:i}=e;return l.map((e,s)=>{let u=null;if(!o||o.includes(s)){const t=i?a.formatDate(e):n.format(e);t&&(u=function(e,l,t){let o="";return 0===l?o="< ":l===t&&(o="> "),o+e}(t,s,l.length-1))}return new r({value:e,color:t[s],label:u})})},e.createUniqueValueLabel=function(e){const{value:l,domain:t,fieldInfo:o,dateFormatOptions:a}=e;let r=String(l);const u=t&&"codedValues"in t&&t.codedValues?t.getName(l):null;return u?r=u:null!=l&&o&&(s.isAnyDateField(o)||i.isTimeOnlyField(o))?r=s.formatAnyDate(l,a??{fieldType:o.type}):"number"==typeof l&&(r=n.format(l)),r},e.dateFormatIntervalOptions={millisecond:"long-month-day-year-long-time",second:"long-month-day-year-long-time",minute:"long-month-day-year-short-time",hour:"long-month-day-year-short-time",day:"long-month-day-year",month:"long-month-day-year",year:"year"},e.getAttribute=b,e.getAttributes=function(e,t){const o=[];if("class-breaks"===e.type||"heatmap"===e.type)o.push(b(e,"number"));else if("unique-value"===e.type){const l=e.authoringInfo;if(l&&"relationship"===l.type){if(l.field1&&l.field2){const e=l.field1.field,t=l.field2.field,a=l.field1.normalizationField,i=l.field2.normalizationField;o.push(b({field:e,normalizationField:a})),o.push(b({field:t,normalizationField:i}))}}else{const l=e.uniqueValueInfos?.[0];let t=null;if(l?.value){const e=typeof l.value;"string"!==e&&"number"!==e||(t=e)}o.push(b(e,t)),[e.field2,e.field3].forEach(e=>e&&o.push(h(e)))}}else"attributes"in e&&e.attributes?.forEach(e=>o.push(b(e,"number")));const a=t?t(e):"visualVariables"in e?e.visualVariables:null;return a&&a.forEach(e=>o.push(b(e,"number"))),l.unique(o.filter(l.isSome),(e,l)=>"field"===e.type&&"field"===l.type?e.field===l.field:"normalized-field"===e.type&&"normalized-field"===l.type?e.field===l.field&&e.normalizationField===l.normalizationField:"expression"===e.type&&"expression"===l.type&&e.expression===l.expression)},e.getColorsForRendererValues=async function(e){const l=new Map;if(!e)return l;if("unique-value"!==e.type||e.authoringInfo?.type)if("class-breaks"===e.type){const t=e.classBreakInfos.map(e=>({value:e.minValue,color:u.getColorFromSymbol(e.symbol,null)})).reverse(),{field:o,valueExpression:a}=e;await y(l,o??a,t)}else"simple"===e.type&&await y(l,"default",[{value:"default",color:u.getColorFromSymbol(e.symbol,null)}]);else{const t=(e.uniqueValueInfos??[]).map(e=>({value:e.value,color:u.getColorFromSymbol(e.symbol,null)})),{field:o,field2:a,field3:i,valueExpression:n,fieldDelimiter:r}=e,s=[o,a,i].filter(Boolean).join(r||"");(s||n)&&await y(l,s||n,t)}if("defaultSymbol"in e&&e.defaultSymbol&&await y(l,"default",[{value:"default",color:u.getColorFromSymbol(e.defaultSymbol,null)}]),"visualVariables"in e&&e.visualVariables){const t=e.visualVariables.filter(e=>"color"===e.type);for(const e of t){const t=await f.getRampStops(e)??[];await y(l,e.field||e.valueExpression,t)}}return l},e.getColorsFromRenderer=async function(e){const t=new Map;if(!e)return t;if("visualVariables"in e&&e.visualVariables)for(const l of e.visualVariables)if(v(l)){const e=(await f.getRampStops(l)??[]).map(e=>e.color);await c(t,l.field||l.valueExpression,e)}if("heatmap"===e.type){const l=m.getHeatmapRampStops(e).map(e=>e.color);await c(t,e.field||e.valueExpression,l)}else if("pie-chart"===e.type){for(const l of e.attributes)await c(t,l.field||l.valueExpression,[l.color]);await c(t,"default",[e?.othersCategory?.color,u.getColorFromSymbol(e.backgroundFillSymbol,null)])}else if("dot-density"===e.type){for(const l of e.attributes)await c(t,l.field||l.valueExpression,[l.color]);await c(t,"default",[e.backgroundColor])}else if("unique-value"===e.type)if("predominance"===e.authoringInfo?.type)for(const l of e.uniqueValueInfos??[])await c(t,l.value.toString(),[u.getColorFromSymbol(l.symbol,null)]);else{const l=(e.uniqueValueInfos??[]).map(e=>u.getColorFromSymbol(e.symbol,null)),{field:o,field2:a,field3:i,valueExpression:n}=e;(o||n)&&await c(t,o||n,l),a&&await c(t,a,l),i&&await c(t,i,l)}else if("class-breaks"===e.type){const l=e.classBreakInfos.map(e=>u.getColorFromSymbol(e.symbol,null)),{field:o,valueExpression:a}=e;await c(t,o??a,l)}else"simple"===e.type&&await c(t,"default",[u.getColorFromSymbol(e.symbol,null)]);return"defaultSymbol"in e&&e.defaultSymbol&&await c(t,"default",[u.getColorFromSymbol(e.defaultSymbol,null)]),t.forEach((e,o)=>{const a=l.unique(e.filter(Boolean),(e,l)=>JSON.stringify(e)===JSON.stringify(l));t.set(o,a)}),t},e.setLabelsForClassBreaks=function(e){const l=e.classBreakInfos,o=e.normalizationType;let a=[];if(l?.length)if("standard-deviation"!==e.classificationMethod)if(e.round){a.push(l[0].minValue);for(const e of l)a.push(e.maxValue);a=n.round(a),l.forEach((e,l)=>{e.label=g({minValue:0===l?a[0]:a[l],maxValue:a[l+1],isFirstBreak:0===l,normalizationType:o})})}else l.forEach((e,l)=>{e.label=g({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===l,normalizationType:o})});else t.getLogger("esri.renderers.support.utils").warn("setLabelsForClassBreaks","cannot set labels for class breaks generated using 'standard-deviation' method.")},e.timelineDateFormatOptions=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});