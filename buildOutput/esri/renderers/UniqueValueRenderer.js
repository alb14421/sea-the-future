// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../chunks/tslib.es6","../core/Error","../core/lang","../core/Logger","../core/object","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../core/accessorSupport/diffUtils","../core/accessorSupport/ensureType","../layers/support/fieldUtils","../portal/Portal","./Renderer","./mixins/VisualVariablesMixin","./support/commonProperties","./support/RendererLegendOptions","./support/UniqueValue","./support/UniqueValueClass","./support/UniqueValueGroup","./support/UniqueValueInfo","../support/loadArcade","../chunks/persistableUrlUtils","../symbols/WebStyleSymbol","../symbols/support/styleUtils","../symbols/support/typeUtils"],function(e,t,s,l,i,o,r,u,a,n,d,p,c,f,h,y,_,m,b,g,v,V,q,I,S,w,U,F,O,G){"use strict";var x;const D="uvInfos-watcher",E="uvGroups-watcher",j=h.ensureType(S);function M(e){return null!=e&&""!==e&&("string"!=typeof e||""!==e.trim()&&"<null>"!==e.toLowerCase())||(e=null),e+""}return e.default=x=class extends(b.VisualVariablesMixin(m)){constructor(e){super(e),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this._isInfosSource=null,this.type="unique-value",this.backgroundFillSymbol=null,this.orderByClassesEnabled=!1,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(e,t){if(!e&&!t)return;if(!e||!t)return{type:"complete",oldValue:e,newValue:t};let s=!1;const l={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let i=0;i<t.length;i++){const o=e.find(e=>e.value===t[i].value);o?f.diff(o,t[i])?(l.changed.push({type:"complete",oldValue:o,newValue:t[i]}),s=!0):l.unchanged.push({oldValue:o,newValue:t[i]}):(l.added.push(t[i]),s=!0)}for(let i=0;i<e.length;i++)t.find(t=>t.value===e[i].value)||(l.removed.push(e[i]),s=!0);return s?l:void 0}},this._set("uniqueValueInfos",[]),this._set("uniqueValueGroups",[])}get _cache(){return{compiledFunc:null}}set field(e){this._set("field",e),this._updateFieldDelimiter(),this._updateUniqueValues()}castField(e){return null==e||"function"==typeof e?e:h.ensureString(e)}writeField(e,t,l,o){"string"==typeof e?t[l]=e:o?.messages?o.messages.push(new s("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):i.getLogger(this).error(".field: cannot write field to JSON since it's not a string value")}set field2(e){this._set("field2",e),this._updateFieldDelimiter(),this._updateUniqueValues()}set field3(e){this._set("field3",e),this._updateUniqueValues()}set valueExpression(e){this._set("valueExpression",e),this._updateUniqueValues()}set defaultSymbol(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}set fieldDelimiter(e){this._set("fieldDelimiter",e),this._updateUniqueValues()}readPortal(e,t,s){return s.portal||_.getDefault()}readStyleOrigin(e,t,s){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const e=U.fromJSON(t.styleUrl,s);return Object.freeze({styleUrl:e})}}writeStyleOrigin(e,t,s,l){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=U.toJSON(e.styleUrl,l))}set uniqueValueGroups(e){this.styleOrigin?i.getLogger(this).error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueGroups",e),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}set uniqueValueInfos(e){this.styleOrigin?i.getLogger(this).error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}addUniqueValueInfo(e,t){if(this.styleOrigin)return void i.getLogger(this).error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let s;s="object"==typeof e?j(e):new S({value:e,symbol:G.ensureType(t)}),this.uniqueValueInfos?.push(s),this._valueInfoMap[M(s.value)]=s,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}removeUniqueValueInfo(e){if(this.styleOrigin)return void i.getLogger(this).error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");const t=this.uniqueValueInfos;if(t)for(let s=0;s<t.length;s++){const l=t[s];if(String(l.value)===String(e)){delete this._valueInfoMap[M(e)],t.splice(s,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}async getUniqueValueInfo(e,t){let s=t;return this.valueExpression&&null==t?.arcade&&(s={...s,arcade:await w.loadArcade()}),this._getUniqueValueInfo(e,s)}getSymbol(e,t){if(this.valueExpression&&null==t?.arcade)return void i.getLogger(this).error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const s=this._getUniqueValueInfo(e,t);return s?.symbol||this.defaultSymbol}async getSymbolAsync(e,t){let s=t;if(this.valueExpression&&null==s?.arcade){const e=await w.loadArcade(),{arcadeUtils:t}=e;t.hasGeometryOperations(this.valueExpression)&&await t.enableGeometryOperations(),s={...s,arcade:e}}const l=this._getUniqueValueInfo(e,s);return l?.symbol||this.defaultSymbol}get symbols(){const e=[];for(const t of this.uniqueValueInfos??[])t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables?.reduce((e,t)=>e+t.getAttributeHash(),"")??""}getMeshHash(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),s=this.uniqueValueInfos?.reduce((e,t)=>e+t.getMeshHash(),"");return`${e}.${t}.${s}.${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}.${this.valueExpression}`}clone(){const e=new x({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:l.clone(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:l.clone(this.visualVariables),legendOptions:l.clone(this.legendOptions),authoringInfo:l.clone(this.authoringInfo),backgroundFillSymbol:l.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=l.clone(this.uniqueValueInfos),s=l.clone(this.uniqueValueGroups);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(l.clone(this.styleOrigin))),Object.freeze(t),Object.freeze(s)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e._set("uniqueValueGroups",s),e._isInfosSource=this._isInfosSource,e._watchUniqueValueInfosAndGroups(),e}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(e,t){const s=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(s)}async collectSymbolFields(e,t){const s=[...this.symbols.map(s=>s.collectRequiredFields(e,t)),y.collectArcadeFieldNames(e,t,this.valueExpression)];y.collectField(e,t,this.field),y.collectField(e,t,this.field2),y.collectField(e,t,this.field3),await Promise.all(s)}populateFromStyle(){return O.fetchStyle(this.styleOrigin,{portal:this.portal}).then(e=>{const t=[];return this._valueInfoMap={},e?.data&&Array.isArray(e.data.items)&&e.data.items.forEach(s=>{const l=new F({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:s.name});this.defaultSymbol||s.name!==e.data.defaultItem||(this.defaultSymbol=l,this._isDefaultSymbolDerived=!0);const i=new S({value:s.name,symbol:l});t.push(i),this._valueInfoMap[M(s.name)]=i}),this._set("uniqueValueInfos",Object.freeze(t)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&this.uniqueValueInfos?.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateFieldDelimiter(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",",")}_updateUniqueValues(){null!=this._isInfosSource&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())}_updateValueInfoMap(){this._valueInfoMap={};const{uniqueValueInfos:e}=this;if(e)for(const t of e)this._valueInfoMap[M(t.value)]=t}_watchUniqueValueInfosAndGroups(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()}_watchUniqueValueInfos(){this.removeHandles(D);const{uniqueValueInfos:e}=this;if(e){const t=[];for(const s of e)t.push(r.watch(()=>({symbol:s.symbol,value:s.value,label:s.label,description:s.description}),(e,t)=>{e!==t&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)},{sync:!0}));this.addHandles(t,D)}}_watchUniqueValueGroups(){this.removeHandles(E);const{uniqueValueGroups:e}=this;if(e){const t=[];for(const s of e){t.push(r.watch(()=>({classes:s.classes}),(e,t)=>{e!==t&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}));for(const e of s.classes??[])t.push(r.watch(()=>({symbol:e.symbol,values:e.values,label:e.label,description:e.description}),(e,t)=>{e!==t&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}))}this.addHandles(t,E)}}_updateInfosFromGroups(){if(!this.uniqueValueGroups)return this._set("uniqueValueInfos",null),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const e=[],{field:t,field2:s,field3:l,fieldDelimiter:i,uniqueValueGroups:o,valueExpression:r}=this;if(!t&&!r)return this._set("uniqueValueInfos",e),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const u=!(!t||!s);for(const t of o)for(const o of t.classes??[]){const{symbol:t,label:r,values:a,description:n}=o;for(const o of a??[]){const{value:a,value2:d,value3:p}=o,c=[a];s&&c.push(d),l&&c.push(p);const f=u?c.join(i||""):c[0]??void 0;e.push(new S({symbol:t,label:r,value:f,description:n}))}}this._set("uniqueValueInfos",e),this._updateValueInfoMap(),this._watchUniqueValueInfos()}_updateGroupsFromInfos(e=!1){if(!this.uniqueValueInfos)return this._set("uniqueValueGroups",null),void this._watchUniqueValueGroups();const{field:t,field2:s,valueExpression:l,fieldDelimiter:i,uniqueValueInfos:o}=this;if(!t&&!l||!o.length)return this._set("uniqueValueGroups",[]),void this._watchUniqueValueGroups();const r=!(!t||!s),u=o.map(e=>{const{symbol:t,label:s,value:l,description:o}=e,[u,a,n]=r?l?.toString()?.split(i||"")||[]:[l];return new q({symbol:t,label:s,description:o,values:[new V({value:u,value2:a,value3:n})]})}),a=[new I({classes:u})];e&&Object.freeze(a),this._set("uniqueValueGroups",a),this._watchUniqueValueGroups()}_getUniqueValueInfo(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)}_getUnqiueValueInfoForExpression(e,t){const{viewingMode:s,scale:l,spatialReference:i,arcade:o,timeZone:r}=t??{};let u=this._cache.compiledFunc;const a=o.arcadeUtils;if(!u){const e=a.createSyntaxTree(this.valueExpression);u=a.createFunction(e),this._cache.compiledFunc=u}const n=a.executeFunction(u,a.createExecContext(e,a.getViewInfo({viewingMode:s,scale:l,spatialReference:i}),r));return this._valueInfoMap[M(n)]}_getUnqiueValueInfoForFields(e){const t=this.field,s=e.attributes;let l;if(this.field2){const e=this.field2,i=this.field3,o=[];t&&o.push(s[t]),e&&o.push(s[e]),i&&o.push(s[i]),l=o.join(this.fieldDelimiter||"")}else t&&(l=s[t]);return this._valueInfoMap[M(l)]}static fromPortalStyle(e,t){const s=new x(t?.properties);s._set("styleOrigin",Object.freeze({styleName:e})),s._set("portal",t?.portal||_.getDefault());const l=s.populateFromStyle();return l.catch(t=>{i.getLogger(this.prototype).error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",t)}),l}static fromStyleUrl(e,t){const s=new x(t?.properties);s._set("styleOrigin",Object.freeze({styleUrl:e}));const l=s.populateFromStyle();return l.catch(t=>{i.getLogger(this.prototype).error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",t)}),l}},t.__decorate([u.property({readOnly:!0})],e.default.prototype,"_cache",null),t.__decorate([n.enumeration({uniqueValue:"unique-value"})],e.default.prototype,"type",void 0),t.__decorate([u.property(g.rendererBackgroundFillSymbolProperty)],e.default.prototype,"backgroundFillSymbol",void 0),t.__decorate([u.property({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],e.default.prototype,"field",null),t.__decorate([a.cast("field")],e.default.prototype,"castField",null),t.__decorate([c.writer("field")],e.default.prototype,"writeField",null),t.__decorate([u.property({type:String,value:null,json:{write:!0}})],e.default.prototype,"field2",null),t.__decorate([u.property({type:String,value:null,json:{write:!0}})],e.default.prototype,"field3",null),t.__decorate([u.property({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],e.default.prototype,"orderByClassesEnabled",void 0),t.__decorate([u.property({type:String,value:null,json:{write:!0}})],e.default.prototype,"valueExpression",null),t.__decorate([u.property({type:String,json:{write:!0}})],e.default.prototype,"valueExpressionTitle",void 0),t.__decorate([u.property({type:v,json:{write:!0}})],e.default.prototype,"legendOptions",void 0),t.__decorate([u.property({type:String,json:{write:!0}})],e.default.prototype,"defaultLabel",void 0),t.__decorate([u.property(o.deepMerge({...g.rendererSymbolProperty},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],e.default.prototype,"defaultSymbol",null),t.__decorate([u.property({type:String,value:null,json:{write:!0}})],e.default.prototype,"fieldDelimiter",null),t.__decorate([u.property({type:_,readOnly:!0})],e.default.prototype,"portal",void 0),t.__decorate([d.reader("portal",["styleName"])],e.default.prototype,"readPortal",null),t.__decorate([u.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],e.default.prototype,"styleOrigin",void 0),t.__decorate([d.reader("styleOrigin",["styleName","styleUrl"])],e.default.prototype,"readStyleOrigin",null),t.__decorate([c.writer("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],e.default.prototype,"writeStyleOrigin",null),t.__decorate([u.property({type:[I],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(e,t,s)=>{const l=t.uniqueValueGroups||function(e){const{field1:t,field2:s,field3:l,fieldDelimiter:i,uniqueValueInfos:o,valueExpression:r}=e,u=!(!t||!s);return[{classes:(o??[]).map(e=>{const{symbol:o,label:a,value:n,description:d}=e,[p,c,f]=u?n?.toString()?.split(i||"")||[]:[n],h=[];return(t||r)&&h.push(p),s&&h.push(c),l&&h.push(f),{symbol:o,label:a,values:[h],description:d}})}]}(t);return l.map(e=>I.fromJSON(e,s))}},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],e.default.prototype,"uniqueValueGroups",null),t.__decorate([u.property({type:[S],json:{read:!1,write:{isRequired:!0,overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0,isRequired:!0}}}}})],e.default.prototype,"uniqueValueInfos",null),e.default=x=t.__decorate([p.subclass("esri.renderers.UniqueValueRenderer")],e.default),e.default});