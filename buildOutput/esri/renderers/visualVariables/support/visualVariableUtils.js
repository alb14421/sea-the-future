// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../Color","../../../Graphic","../../../core/compilerUtils","../../../core/Logger","../../support/lengthUtils","./sizeVariableUtils"],function(e,n,i,a,t,r,l){"use strict";const s=()=>t.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),o=e=>s().warn(`The visualVariable should be an instance of esri.renderers.visualVariables.${e}`),c=()=>s().error("Use of arcade expressions requires an arcade context"),u=new i,f=Math.PI;function d(e,i,a){const t="visualVariables"in e?e.visualVariables?.find(e=>"color"===e.type):e;if(!t)return;if("esri.renderers.visualVariables.ColorVariable"!==t.declaredClass)return void o("ColorVariable");const r="number"==typeof i,s=r?null:i,u=s?.attributes;let f=r?i:null;const d=t.field,{ipData:p,hasExpression:b}=t.cache;let v=t.cache.compiledFunc;if(!d&&!b){const e=t.stops;return e&&e[0]&&e[0].color}if("number"!=typeof f)if(b){if(null==a?.arcade)return void c();const e={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},n=a.arcade.arcadeUtils,i=n.getViewInfo(e),r=n.createExecContext(s,i,a.timeZone);if(!v){const e=n.createSyntaxTree(t.valueExpression);v=n.createFunction(e),t.cache.compiledFunc=v}f=n.executeFunction(v,r)}else u&&(f=u[d]);const m=t.normalizationField,h=null!=u&&null!=m?parseFloat(u[m]):void 0;if(null!=f&&(!m||r||!isNaN(h)&&0!==h)){l.isValidNumber(h)&&!r&&(f/=h);const e=g(f,p);if(e){const i=e[0],r=e[1],l=i===r?t.stops[i].color:n.blendColors(t.stops[i].color,t.stops[r].color,e[2],null!=a?a.color:void 0);return new n(l)}}}function p(e,n,i){const a="visualVariables"in e?e.visualVariables?.find(e=>"opacity"===e.type):e;if(!a)return;if("esri.renderers.visualVariables.OpacityVariable"!==a.declaredClass)return void o("OpacityVariable");const t="number"==typeof n,r=t?null:n,s=r?.attributes;let u=t?n:null;const f=a.field,{ipData:d,hasExpression:p}=a.cache;let b=a.cache.compiledFunc;if(!f&&!p){const e=a.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof u)if(p){if(null==i?.arcade)return void c();const e={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},n=i.arcade.arcadeUtils,t=n.getViewInfo(e),l=n.createExecContext(r,t,i.timeZone);if(!b){const e=n.createSyntaxTree(a.valueExpression);b=n.createFunction(e),a.cache.compiledFunc=b}u=n.executeFunction(b,l)}else s&&(u=s[f]);const v=a.normalizationField,m=null!=s&&null!=v?parseFloat(s[v]):void 0;if(null!=u&&(!v||t||!isNaN(m)&&0!==m)){l.isValidNumber(m)&&!t&&(u/=m);const e=g(u,d);if(e){const n=e[0],i=e[1];if(n===i)return a.stops[n].opacity;{const t=a.stops[n].opacity;return t+(a.stops[i].opacity-t)*e[2]}}}}function b(e,n,i){const a="visualVariables"in e?e.visualVariables?.find(e=>"rotation"===e.type):e;if(!a)return;if("esri.renderers.visualVariables.RotationVariable"!==a.declaredClass)return void o("RotationVariable");const t=a.axis||"heading",r="heading"===t&&"arithmetic"===a.rotationType?90:0,l="heading"===t&&"arithmetic"===a.rotationType?-1:1,s="number"==typeof n?null:n,u=s?.attributes,f=a.field,{hasExpression:d}=a.cache;let p=a.cache.compiledFunc,b=null;if(!f&&!d)return b;if(d){if(null==i?.arcade)return void c();const e={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},n=i.arcade.arcadeUtils,t=n.getViewInfo(e),r=n.createExecContext(s,t,i.timeZone);if(!p){const e=n.createSyntaxTree(a.valueExpression);p=n.createFunction(e),a.cache.compiledFunc=p}b=n.executeFunction(p,r)}else u&&(b=u[f]);return b="number"!=typeof b||isNaN(b)?null:r+l*b,b}function v(e,n,i){const a="visualVariables"in e?e.visualVariables?.find(e=>"size"===e.type):e;if(!a)return;if("esri.renderers.visualVariables.SizeVariable"!==a.declaredClass)return void o("SizeVariable");const t=function(e,n,i){const a="number"==typeof n,t=a?null:n,r=t?.attributes;let s=a?n:null;const{isScaleDriven:o}=e.cache;let u=e.cache.compiledFunc;if(o){const n=null!=i?i.scale:void 0,a=null!=i?i.view:void 0;s=null==n||"3d"===a?function(e){let n=null,i=null;const a=e.stops;return a?(n=a[0].value,i=a[a.length-1].value):(n=e.minDataValue||0,i=e.maxDataValue||0),(n+i)/2}(e):n}else if(!a)switch(e.inputValueType){case"expression":{if(null==i?.arcade)return void c();const n={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},a=i.arcade.arcadeUtils,r=a.getViewInfo(n),l=a.createExecContext(t,r,i.timeZone);if(!u){const n=a.createSyntaxTree(e.valueExpression);u=a.createFunction(n),e.cache.compiledFunc=u}s=a.executeFunction(u,l);break}case"field":r&&(s=r[e.field]);break;case"unknown":s=null}if(!l.isValidNumber(s))return null;if(a||!e.normalizationField)return s;const f=r?parseFloat(r[e.normalizationField]):null;return l.isValidNumber(f)&&0!==f?s/f:null}(a,n,i),r=V(t,a,n,i,a.cache.ipData);return null==r||isNaN(r)?void 0:r}function m(e,n,i){return null==e?null:l.isSizeVariable(e)?v(e,n,i):l.isValidNumber(e)?e:null}function h(e,n,i){return l.isValidNumber(i)&&e>i?i:l.isValidNumber(n)&&e<n?n:e}function V(e,n,i,a,t){switch(n.transformationType){case"additive":return function(e,n,i,a){const t=m(n.minSize,i,a)||n.minDataValue;return null==e&&null==t?null:(e??0)+(t??0)}(e,n,i,a);case"constant":return function(e,n,i){const a=e.stops;let t=a?.length&&a[0].size;return null==t&&(t=e.minSize),m(t,n,i)}(n,i,a);case"clamped-linear":return function(e,n,i,a){const t=m(n.minSize,i,a);if(null==e)return t;const{minDataValue:r,maxDataValue:l}=n;if(null==r||null==l)return null;const s=(e-r)/(l-r),o=m(n.maxSize,i,a),c=null!=a?a.shape:void 0;if(e<=r)return t;if(e>=l)return o;if(null==t||null==o)return null;if("area"===n.scaleBy&&c){const e="circle"===c,n=e?f*(t/2)**2:t*t,i=n+s*((e?f*(o/2)**2:o*o)-n);return e?2*Math.sqrt(i/f):Math.sqrt(i)}return t+s*(o-t)}(e,n,i,a);case"proportional":return function(e,n,i,a){const t=m(n.minSize,i,a);if(null==e||null==t)return t;const r=null!=a?a.shape:void 0,{minDataValue:l}=n;if(null==l)return null;const s=e/l,o=m(n.maxSize,i,a);let c=null;return c="circle"===r?2*Math.sqrt(s*(t/2)**2):"square"===r||"diamond"===r||"image"===r?Math.sqrt(s*t**2):s*t,h(c,t,o)}(e,n,i,a);case"stops":return function(e,n,i,a,t){if(null==e)return null;const[r,l,s]=g(e,t);if(r===l)return m(n.stops?.[r].size,i,a);{const e=m(n.stops?.[r].size,i,a),t=m(n.stops?.[l].size,i,a);return null==e||null==t?null:e+(t-e)*s}}(e,n,i,a,t);case"real-world-size":return function(e,n,i,a){const t=(a?.resolution??1)*r.meterIn[n.valueUnit],l=m(n.minSize,i,a),s=m(n.maxSize,i,a),{valueRepresentation:o}=n;if(null==e)return l;let c=null;return c="area"===o?2*Math.sqrt(e/f)/t:"radius"===o||"distance"===o?2*e/t:e/t,h(c,l,s)}(e,n,i,a);case"identity":return e;case"unknown":return null}}function g(e,n){if(!n)return;let i=0,a=n.length-1;return n.some((n,t)=>e<n?(a=t,!0):(i=t,!1)),[i,a,(e-n[i])/(n[a]-n[i])]}e.getAllSizes=function(e,n,i){const t=["proportional","proportional","proportional"];for(const r of e){const e=r.useSymbolValue?"symbol-value":v(r,n,i)??"proportional";switch(r.axis){case"width":t[0]=e;break;case"depth":t[1]=e;break;case"height":t[2]=e;break;case"width-and-depth":t[0]=e,t[1]=e;break;case"all":case void 0:case null:t[0]=e,t[1]=e,t[2]=e;break;default:a.neverReached(r.axis)}}return t},e.getColor=d,e.getOpacity=p,e.getRotationAngle=b,e.getSize=v,e.getSizeForValue=V,e.getSizeFromNumberOrVariable=m,e.getSizeRangeAtScale=function(e,n,i){const{isScaleDriven:a}=e.cache;if(!(a&&"3d"===i||n))return null;const t={scale:n,view:i};let r=m(e.minSize,u,t),l=m(e.maxSize,u,t);if(null!=r||null!=l){if(r>l){const e=l;l=r,r=e}return{minSize:r,maxSize:l}}},e.getVisualVariableValues=function(e,n,i){if(!e.visualVariables)return;const a=[],t=[],r=[],l=[],s=[];for(const n of e.visualVariables)switch(n.type){case"color":t.push(n);break;case"opacity":r.push(n);break;case"rotation":s.push(n);break;case"size":l.push(n)}return t.forEach(e=>{const t=d(e,n,i);a.push({variable:e,value:t})}),r.forEach(e=>{const t=p(e,n,i);a.push({variable:e,value:t})}),s.forEach(e=>{const t=b(e,n,i);a.push({variable:e,value:t})}),l.forEach(e=>{const t=v(e,n,i);a.push({variable:e,value:t})}),a},e.viewScaleRE=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});