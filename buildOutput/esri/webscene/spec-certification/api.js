// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../Basemap","../../Ground","../../WebScene","../../core/has","../../core/accessorSupport/ensureType","../../core/accessorSupport/extensions/serializableProperty/type","../../layers/GroupLayer","../../layers/KMLLayer","../../layers/mixins/operationalLayerModuleMap","../../layers/mixins/operationalLayers","../../layers/support/Sublayer","../../layers/support/source/DataLayerSource","../../layers/support/source/MapLayerSource","../InitialViewProperties","./utils","../support/analysisUtils","../support/SlideElements"],function(e,t,n,r,a,s,y,i,p,o,u,l,c,f,m,d,b,w,N){"use strict";async function g(e,t,n){switch(t.typeName){case"array":await async function(e,t,n){t.elementType.isRequired=t.isRequired,await g(`${e}[]`,t.elementType,n)}(e,t,n);break;case"union":await async function(e,t,n){const r=[];for(const a of t.types)if("native"!==a.type.typeName&&t.key){const t=`${e}<${T(a.type,a.value)}>`;await g(t,a.type,n)}else r.push(a.type);if(r.length){const a=r.map(e=>M(n,e));t.nullable&&a.push("null"),a.sort(),n.addProperty({type:a.join("|"),name:e,default:t.default,required:t.isRequired})}}(e,t,n);break;case"json":await S(e,t,n);break;case"native":await async function(e,t,n){n.addProperty({name:e,type:M(n,t),default:t.default,required:t.isRequired})}(e,t,n);break;case"enum":await async function(e,t,n){const r=t.values.slice();t.nullable&&r.push(null),n.currentClass?.typeValue&&"type"===e?n.addProperty({name:e,type:"string",enum:`"${n.currentClass.typeValue}"`,required:t.isRequired}):n.addProperty({name:e,type:M(n,t),enum:v(r).map(e=>"string"==typeof e?`"${e}"`:`${e}`).join("|"),default:t.default,required:t.isRequired})}(e,t,n)}}function v(e){const t=e.slice();return t.sort(),t}function T(e,t){if("json"===e.typeName){const t=e.type.__accessorMetadata__,n=t?.type,r=n&&$(n),a=r?.type,s=a||n?.type;if(s&&Array.isArray(s)&&1===s.length&&"string"==typeof s[0])return a?s[0]:L(n,s[0])}return t}async function h(e,t){return e.type===a&&"layers"===t?j("web-scene/operational-layers","operational-layers"):e.type===a&&"tables"===t?j("web-scene/tables","tables"):e.type!==n||"baseLayers"!==t&&"baseMapLayers"!==t?e.type===n&&"elevationLayers"===t||e.type===r&&"layers"===t?j("web-scene/ground","ground"):e.type===p&&"layers"===t?j("web-scene/operational-layers","operational-layers",e=>e!==p):e.type!==N&&e.type!==d||"analyses"!==t?e.type!==f.JoinTableDataSource||"leftTableSource"!==t&&"rightTableSource"!==t?null:C({key:"type",base:null,typeMap:{"data-layer":f.DataLayerSource,"map-layer":m.MapLayerSource}}):{typeName:"array",elementType:{typeName:"union",key:"type",types:await Promise.all(Object.entries(w.webSceneAnalysisRegistry).map(async([e,t])=>({type:{typeName:"json",type:await t()},value:e})))}}:j("web-scene/basemap","basemap")}async function k(e,t,n){const r=function(e){const t=$(e);return t?.types?C(t.types):!t?.type&&e.types?C(e.types):(n=R(function(e){const t=$(e),n=A(e),r=t?.type,a=P(r||e.type);return t&&void 0!==t.default&&"function"!=typeof t.default&&(a.default=L(e,t.default)),n?.allowNull&&(a.nullable=!0),n?.isRequired&&(a.isRequired=!0),a}(e)),n.nullable&&"native"===n.typeName?{typeName:"union",key:null,isRequired:n.isRequired,types:[{value:null,type:n}],nullable:!0}:n);var n}(n),a=await h(e,t);return a?(a.isRequired=r.isRequired,a):r}async function S(e,t,n){const r=t.type.__accessorMetadata__,a=n.getDeclaredClass(t.type);if(!r)return e&&n.addProperty({name:e,type:"unknown"}),null;let s=a,y=null;t.layerContainerType&&(s+=`--${t.layerContainerType}`);const i=e?.match(/<([^>]+)>$/);i&&(s+=`--${i[1]}`,y=i[1]),t.type===c&&(s+=`--${n.currentClass?.name}`,y=n.currentClass?.name);const p=n.seen.get(s);if(p&&e)return n.addProperty({name:e,type:p,required:t.isRequired}),p;const o={type:t.type,name:a,id:s,properties:[]};e&&(n.addProperty({name:e,type:o,required:t.isRequired}),o.typeValue=y),n.push(e,o);for(const e in r){const a=r[e],s=A(a);if(!s?.enabled)continue;if(s.layerContainerTypes&&t.layerContainerType&&!s.layerContainerTypes.includes(t.layerContainerType))continue;if(t.type===c){const e="esri/layers/TileLayer"===n.stack[n.stack.length-2].klass.name;if(e&&c.test.isMapImageLayerOverridePolicy(s.overridePolicy)||!e&&c.test.isTileImageLayerOverridePolicy(s.overridePolicy))continue}const y=s.target;if("string"==typeof y||null==y){const r=await k(t,e,a);if(!r)continue;await g("string"==typeof y?y:e,r,n)}else await q(t,y,n)}return n.pop()}async function q(e,t,n){for(const r in t){let a=await h(e,r);if(!a){const e=t[r];a=e.types?C(e.types):P(e.type),a.default=e.default,a.isRequired=e.isRequired,a=R(a)}await g(r,a,n)}}async function j(e,t,n){const r={typeName:"union",key:"layerType",types:[]};for(const a in l.supportedTypes[e]){if("web-scene/operational-layers"===e&&"ArcGISTiledElevationServiceLayer"===a)continue;const s=await u.typeModuleMap[a]();s&&(n&&!n(s)||s!==o&&r.types.push({type:{typeName:"json",layerContainerType:t,type:s},value:a}))}return 0===r.types.length?null:{typeName:"array",elementType:1===r.types.length?r.types[0].type:r}}function M(e,t){switch(t.typeName){case"array":return`${M(e,t.elementType)}[]`;case"union":{const n=t.types.map(t=>M(e,t.type));return t.nullable&&n.push("null"),n.sort(),`${n.join(" | ")}`}case"native":switch(t.type){case Number:return"number";case y.Integer:return"integer";case String:return"string";case Boolean:return"boolean";case Object:return"object";case y.Null:return"null";default:return"unknown"}case"json":return e.getDeclaredClass(t.type);case"enum":return"string"}}function R(e){if("array"===e.typeName)return e.elementType=R(e.elementType),e;const t=function(e){if("json"!==e.typeName)return null;const t=e.type.__accessorMetadata__,n=t?.type,r=n&&$(n),a=r?.type,s=a||n?.type;return s&&Array.isArray(s)&&"string"==typeof s[0]?a||n.type.map(e=>L(n,e)):null}(e);return t?{typeName:"union",key:"type",nullable:e.nullable,isRequired:e.isRequired,types:t.map(t=>({value:t,type:e}))}:e}function C(e){if(Array.isArray(e))return{typeName:"array",elementType:C(e[0])};const t=[];for(const n in e.typeMap){const r=e.typeMap[n];t.push({type:P(r),value:O(r)?null:n})}return{typeName:"union",key:"string"==typeof e.key?e.key:"type",types:t}}function L(e,t){const n=A(e);if(n&&null!=(r=n.writer)&&r.isJSONMapWriter){const e={value:""};return n.writer?.(t,e,"value"),e.value}var r;return t}function P(e){return e?y.isLongFormType(e)?_(e):Array.isArray(e)?"string"==typeof e[0]||"number"==typeof e[0]?{typeName:"enum",values:e}:e.length>1?{typeName:"union",key:null,types:e.map(e=>({type:P(e),value:null}))}:{typeName:"array",elementType:P(e[0])}:i.isCollection(e)?function(e){const t=e.prototype.itemType?.Type;if(!t)return{typeName:"array",elementType:{typeName:"native",type:null}};if("function"==typeof t)return{typeName:"array",elementType:P(t)};if(t.typeMap){const e=[];for(const n in t.typeMap){const r=t.typeMap[n];e.push({type:P(r),value:O(r)?null:n})}return{typeName:"array",elementType:{typeName:"union",key:"string"==typeof t.key?t.key:"type",types:e}}}}(e):O(e)?{typeName:"native",type:e}:function(e){let t=e;for(;t;){if(t.prototype&&("esri.core.JSONSupport"===t.prototype.declaredClass||"esri.core.MultiOriginJSONSupport"===t.prototype.declaredClass))return!0;t=Object.getPrototypeOf(t)}return!1}(e)?{typeName:"json",type:e}:{typeName:"native",type:null}:{typeName:"native",type:null}}function _(e){switch(e.type){case"native":return{typeName:"native",type:e.value};case"array":return{typeName:"array",elementType:P(e.value)};case"one-of":return{typeName:"union",key:null,types:e.values.map(e=>({type:_(e),value:null}))}}}function O(e){return e===String||e===Boolean||e===Number||e===y.Integer||e===Object||e===y.Null}function $(e){if(!e.json)return null;const t=e.json.origins,n=e.json,r=t?.["web-scene"],a=t?.["web-document"];return r||a||n||null}function A(e){if(!e.json)return null;const t=e.json.origins,n=e.json.write,r=t?.["web-scene"]?.write,a=t?.["web-document"]?.write;return r||a||n||null}e.scan=async function(e){const n={stack:[],error:void 0,hasError:!1};try{const r=t.__addDisposableResource(n,new b.ScanContext,!1);return await S(null,{typeName:"json",type:e},r)}catch(e){n.error=e,n.hasError=!0}finally{t.__disposeResources(n)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});