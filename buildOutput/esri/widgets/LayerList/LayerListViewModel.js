// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/Collection","../../core/Evented","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../linkChart/utils","./ListItem","./support/layerListUtils"],function(e,t,i,s,a,r,o,l,n,d,c,h){"use strict";const p="view-layers",m="map-layers",y="layer-views",u="layer-list-mode",_=t.ofType(c);let v=class extends i.EventedAccessor{constructor(e){super(e),this.checkPublishStatusEnabled=!1,this.listItemCreatedFunction=null,this.listModeDisabled=!1,this.operationalItems=new _,this.view=null}initialize(){this.addHandles([s.watch(()=>!0===this.view?.ready,()=>this._viewHandles(),s.initial),s.watch(()=>[this.listItemCreatedFunction,this.checkPublishStatusEnabled,this.listModeDisabled],()=>this._recompileList()),s.watch(()=>d.isLinkChartView(this.view)?this.view.inGeographicLayout:null,()=>this._compileList())],"view")}destroy(){this._removeAllItems(),this.view=null}get state(){const{view:e}=this;return e?.ready?"ready":e?"loading":"disabled"}get totalItems(){return this.operationalItems.flatten(e=>e.children).length}triggerAction(e,t){e&&!e.disabled&&this.emit("trigger-action",{action:e,item:t})}moveListItem(e,t,i,s){const a=e?.layer;if(!a||"subtype-sublayer"===a.type||"sublayer"===a.type)return;const r=this.view?.map?.layers,o=t?h.getItemLayers(t):r,l=i?h.getItemLayers(i):r;if(!o||!l)return;const{operationalItems:n}=this,d=t?.children||n,c=i?.children||n,p=l.length-s;e.parent=i||null,d.remove(e),o.remove(a),c.includes(e)||c.add(e,p),l.includes(a)||l.add(a,p),this._compileList()}_createLayerViewHandles(e){this.removeHandles(y),this._compileList(),e&&this.addHandles(e.on("change",()=>this._compileList()),y)}_createMapLayerHandles(e){this.removeHandles(m),this._compileList(),e&&this.addHandles(e.on("change",()=>this._compileList()),m)}_createListItem(e){const{view:t,listItemCreatedFunction:i,checkPublishStatusEnabled:s,listModeDisabled:a}=this;return new c({checkPublishStatusEnabled:s,listModeDisabled:a,layer:e,listItemCreatedFunction:i,view:t})}_removeAllItems(){this.operationalItems.destroyAll()}_getViewableLayers(e){return e?this.listModeDisabled?e:e.filter(e=>"hide"!==h.findLayerListMode(e)):void 0}_watchLayersListMode(e){this.removeHandles(u),e&&!this.listModeDisabled&&this.addHandles(s.watch(()=>e.filter(e=>"listMode"in e).map(e=>e.listMode).toArray(),()=>this._compileList()),u)}_compileList(){const e=this.view?.map?.layers,t=d.isLinkChartView(this.view)&&!this.view.inGeographicLayout?e?.filter(({type:e})=>"link-chart"===e):e;this._watchLayersListMode(t);const i=this._getViewableLayers(t);i?.length?(this._createNewItems(i),this._removeItems(i),this._sortItems(i)):this._removeAllItems()}_createNewItems(e){const{operationalItems:t}=this;e.forEach(e=>{t.some(t=>t.layer===e)||t.add(this._createListItem(e))})}_removeItems(e){const{operationalItems:t}=this,i=[];t.forEach(t=>{t&&e&&e.includes(t.layer)||i.push(t)}),t.destroyMany(i)}_sortItems(e){const{operationalItems:t}=this;t.sort((t,i)=>{const s=e.indexOf(t.layer),a=e.indexOf(i.layer);return s>a?-1:s<a?1:0})}_recompileList(){this._removeAllItems(),this._compileList()}_viewHandles(){const{view:e}=this;this.removeHandles([m,y,p]),e?.ready?this.addHandles([s.watch(()=>this.view?.map?.allLayers,e=>this._createMapLayerHandles(e),s.initial),s.watch(()=>this.view?.allLayerViews,e=>this._createLayerViewHandles(e),s.initial)],p):this._removeAllItems()}};return e.__decorate([a.property()],v.prototype,"checkPublishStatusEnabled",void 0),e.__decorate([a.property()],v.prototype,"listItemCreatedFunction",void 0),e.__decorate([a.property({nonNullable:!0})],v.prototype,"listModeDisabled",void 0),e.__decorate([a.property({type:_})],v.prototype,"operationalItems",void 0),e.__decorate([a.property({readOnly:!0})],v.prototype,"state",null),e.__decorate([a.property()],v.prototype,"totalItems",null),e.__decorate([a.property()],v.prototype,"view",void 0),v=e.__decorate([n.subclass("esri.widgets.LayerList.LayerListViewModel")],v),v});