// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../chunks/tslib.es6","../intl","../core/domUtils","../core/Evented","../core/events","../core/has","../core/lang","../core/Logger","../core/maybe","../core/Promise","../core/promiseUtils","../core/reactiveUtils","../core/uuid","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/subclass","../core/accessorSupport/tracking","../core/accessorSupport/tracking/SimpleTrackingTarget","../libs/maquette-advanced-projector/projector","../chunks/componentsUtils","./support/jsxWidgetSupport","./support/symbols","./support/tests","./support/vnodeCache","./support/widgetUtils","../intl/messages","../intl/locale"],function(e,t,r,s,o,i,n,d,a,c,l,h,p,u,y,_,g,v,m,b,f,w,S,C,R,j,E){"use strict";var N;let P=0;function k(e,t){const r=Object.prototype.hasOwnProperty;for(const s in t)r.call(t,s)&&r.call(e,s)&&(null!=e[s]&&null!=t[s]&&"object"==typeof e[s]&&"object"==typeof t[s]?k(e[s],t[s]):e[s]=t[s]);return e}const T=m.createAdvancedProjector({postProcessProjectionOptions(e){const t=e.eventHandlerInterceptor,r=/capture$/i;e.eventHandlerInterceptor=(e,s,o,i)=>{const n=t?.(e,s,o,i),d=r.test(e);if(!((e=e.replace(r,"")).toLowerCase()in o)||d){const t=e[2].toLowerCase()+e.slice(3),r=e=>n?.call(o,e);o.addEventListener(t,r,d);const s=()=>o.removeEventListener(t,r,d),a=i.afterRemoved;i.afterRemoved=e=>{a?.(e),s()}}return n}},handleInterceptedEvent(e,t,r,s){const{eventPhase:o,type:i}=s,n=o===Event.CAPTURING_PHASE;let d=`on${i}${n?"capture":""}`;const a=t.properties;(a&&d in a||(d=`on${i[0].toUpperCase()}${i.slice(1)}${n?"Capture":""}`,a&&d in a))&&(C.clearVNodeCache(),e.scheduleRender(),a[d].call(a.bind||r,s))}});let I=!1,L=class extends(c.EsriPromiseMixin(s.EventedAccessor)){static{this[N]=!0}constructor(e,t){super(e,t),this._attached=!1,this._projector=T,this._readyForTrueRender=!1,this.key=this,this.autoRenderingEnabled=!0,this._loadLocale=l.debounce(async()=>{if(this._messageBundleProps?.length){const e=await Promise.allSettled(this._messageBundleProps.map(async({bundlePath:e,propertyName:t})=>{if(this.destroyed)return;let r=await j.fetchMessageBundle(e);this.destroyed||(this.uiStrings&&Object.keys(this.uiStrings)&&(r=k(n.clone(r),this.uiStrings)),this[t]=r)}));if(this.destroyed)return;for(const t of e)"rejected"===t.status&&d.getLogger(this).error("widget-intl:locale-error",this.declaredClass,t.reason)}await this.loadLocale()}),this.addHandles(S.registerAlive()),b.commitAssetPath();const r="esri-widget-uid-"+p.generateUUID(),s=this.render.bind(this);this._trackingTarget=new v.SimpleTrackingTarget(()=>{this.autoRenderingEnabled&&this.scheduleRender()});const o=()=>({vnodeSelector:"div",properties:{key:`${r}-hidden`,class:"",styles:{display:"none"}},domNode:null,children:void 0,text:void 0}),i=()=>{if(!this._readyForTrueRender||this.destroyed)return null;const e=s()??o(),t=e.properties??={};if(t.key??=r,f.isWidgetConstructor(e.vnodeSelector)){if(!this.visible)return o()}else this.visible?t.styles||(t.styles={}):(t.class="",t.styles={display:"none"}),t.styles.display??="";let i=0;return e.children?.forEach(e=>{f.isWidgetConstructor(e.vnodeSelector)||(e.properties??={},e.properties.key??=`${this.id}--${i++}`)}),f.processWidgets(this,e)};this.render=()=>{if(I)return i();let e=C.getVNodeCache(this)??null;if(e)return e;this._trackingTarget.clear(),I=!0;try{e=g.runTracked(this._trackingTarget,i)}catch(e){throw d.getLogger(this).error(e),e}finally{I=!1}return e&&C.setVNodeCache(this,e),e};const a=this.beforeFirstRender();a?this._resourcesFetch=a.then(()=>{this.destroyed||(this._readyForTrueRender=!0,this._postInitialize())}):(this._resourcesFetch=Promise.resolve().then(()=>{this.destroyed||this._postInitialize()}),this._readyForTrueRender=!0),this.addResolvingPromise(this._resourcesFetch),S.registerLoading(this._resourcesFetch)}normalizeCtorArgs(e,t){const r={...e};return t&&(r.container=t),r}postInitialize(){}beforeFirstRender(){const e=this.loadDependencies();return this._messageBundleProps?.length||e?Promise.all([e,this._loadLocale()]).then(()=>{}).catch(l.throwIfNotAbortError):null}loadDependencies(){return null}loadLocale(){return null}destroy(){this.destroyed||(a.destroyMaybe(this._trackingTarget),a.destroyMaybe(this.viewModel),this._detach(this.container),this._set("container",null),this.render=()=>null,this._projector=null,C.deleteVNodeCache(this))}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return r.byId(e)}get destroyed(){return super.destroyed}get domNode(){return this.container}set domNode(e){this.container=e}get icon(){return null}set icon(e){this._overrideIfSome("icon",e)}get id(){return this._get("id")||this.container?.id||Date.now().toString(16)+"-widget-"+P++}set id(e){e&&this._set("id",e)}get label(){return this.declaredClass.split(".").pop()}set label(e){this._overrideIfSome("label",e)}get renderable(){return this._resourcesFetch}get visible(){return this._get("visible")}set visible(e){this._set("visible",e)}get[(N=w.widgetSymbol,w.widgetTestDataSymbol)](){return{projector:this._projector}}static{this.vnodeSelector="div"}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(C.deleteVNodeCache(this),this._projector.scheduleRender())}classes(...e){return R.classes.apply(this,e)}renderNow(){C.deleteVNodeCache(this),this._projector.renderNow()}_postInitialize(){if(this.destroyed)return;this.scheduleRender(),this._delegatedEventNames?.length&&this.addHandles(h.watch(()=>this.viewModel,(e,t)=>{t&&this.removeHandles("delegated-events"),e&&o.isEventedOrEventTarget(e)&&this.addHandles(this._delegatedEventNames.map(t=>o.on(e,t,e=>{this.emit(t,e)})),"delegated-events")},h.syncAndInitial)),this.postInitialize();const e=async()=>{await this._loadLocale().catch(l.throwIfNotAbortError),this.scheduleRender()};this.addHandles([E.onLocaleChange(e),h.watch(()=>this.uiStrings,e)]),this.addHandles(h.when(()=>this.container,e=>{this.destroyed||this._attach(e)},{initial:!0,once:!0}))}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){this._attached&&(this._projector.detach(this.render),this._attached=!1),e?.parentNode?.removeChild(e)}};return e.__decorate([u.property()],L.prototype,"_readyForTrueRender",void 0),e.__decorate([u.property({value:null})],L.prototype,"container",null),e.__decorate([y.cast("container")],L.prototype,"castContainer",null),e.__decorate([u.property()],L.prototype,"icon",null),e.__decorate([u.property()],L.prototype,"id",null),e.__decorate([u.property()],L.prototype,"label",null),e.__decorate([u.property()],L.prototype,"renderable",null),e.__decorate([u.property()],L.prototype,"uiStrings",void 0),e.__decorate([u.property()],L.prototype,"viewModel",void 0),e.__decorate([u.property({value:!0})],L.prototype,"visible",null),e.__decorate([u.property()],L.prototype,"key",void 0),e.__decorate([u.property()],L.prototype,"children",void 0),e.__decorate([u.property()],L.prototype,"afterCreate",void 0),e.__decorate([u.property()],L.prototype,"afterUpdate",void 0),e.__decorate([u.property()],L.prototype,"afterRemoved",void 0),L=e.__decorate([_.subclass("esri.widgets.Widget")],L),L});