// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../core/Error","../../core/handleUtils","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../views/draw/support/HighlightHelper","../../views/support/HighlightDefaults","./UpdateRecordWorkflowData","./Workflow","./workflowUtils","../FeatureForm/FeatureFormViewModel"],function(e,t,r,a,o,i,s,d,l,n,c,p,u,h,m,w,f){"use strict";var g;const y={exit:Symbol()};e.UpdateRecordWorkflow=class extends m{static{g=this}constructor(e){super(e),this._highlightHelper=null,this.fullFeature=null,this.type="update-table-record"}initialize(){const{data:e}=this,{edits:t}=e,{view:i}=e.viewModel,s=t.feature;i&&(this._highlightHelper=new p({view:i,highlightName:u.temporaryHighlightName}),this.addHandles(a.makeHandle(()=>this._highlightHelper?.removeAll())));const d=new AbortController;this.addHandles(a.abortHandle(d)),this._updatingHandles.addPromise(w.fetchFullFeatures([s],s.sourceLayer,e.viewModel.view.spatialReference,d.signal).then(([e])=>{o.isAborted(d)||(this._onFullFeatureLoaded(e),this._initializeFeatureFormViewModel())},e=>this.cancel({force:!0,error:new r("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:e}})})))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){return this.data.edits.modified}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get shouldShowAttachments(){return this.editorItem.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return this.editorItem.capabilities.update.attachments.enabled}get reliesOnOwnerAdminPrivileges(){const e=this.editorItem.capabilities;return e.update.reliesOnOwnerAdminPrivileges||e.delete.reliesOnOwnerAdminPrivileges}stageDelete(){this.data.edits.stageDelete()}async enter(){this._configureAttachmentsViewModel()}exit(e){this.removeHandles(y.exit)}async start(){return await super.start(),null}_configureAttachmentsViewModel(){const{data:e,fullFeature:t}=this,{attachmentsCapabilities:r,viewModel:o}=e,{attachmentsViewModel:s}=o,d=e.readOnly?{editing:!1}:r;s.set({capabilities:d,graphic:t,filesEnabled:!1,mode:"view"}),this.addHandles([a.makeHandle(()=>s.fileInfos.removeAll()),i.watch(()=>s.mode,e=>{switch(e){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}})],y.exit)}_initializeFeatureFormViewModel(){const{association:e,edits:t,formTemplate:r,viewModel:{view:a},readOnly:o}=this.data,s=this._featureFormViewModel=new f({activeAssociation:e,editType:"UPDATE",feature:this.fullFeature,formTemplate:r,highlightHelper:this._highlightHelper,map:a?.map,spatialReference:a.spatialReference,timeZone:a?.timeZone,disabled:o});s.callbacks={...this.data.featureFormCallbacks,showAllRelatedRecords:e=>s.relationshipId=e.relationshipId,viewAssociatedLayers:e=>s.associationId=e.associationId,viewAssociatedFeatures:e=>s.associatedLayer=e.associatedLayer};const{initialFeature:d}=t;d&&s.overrideInitialFeature(d),this.addHandles([s.on("value-change",()=>{t.updateAttributes(s.getValues()),this.fullFeature.attributes=t.feature.attributes}),i.watch(()=>a?.timeZone,e=>s.timeZone=e)])}_onFullFeatureLoaded(e){this.fullFeature=e;const{edits:t}=this.data;t.updateAttributes(e.attributes),t.trackChanges()}static async create(e){const t=new g({data:await h.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}static _createWorkflowSteps(e){const{attachmentsViewModel:t}=e.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){t.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){t.mode="view"}}]}static{this._onCommitFactory=e=>async t=>{const{edits:r}=t,{feature:a}=r;if(!a)return;const o=a.sourceLayer,i=a.clone();if(!r.attributesModified||r.stagedForDelete){const e=o.objectIdField;if(i.attributes={[e]:a.getAttribute(e)},"scene"===o.type&&null!=o.infoFor3D){const e=o.associatedLayer?.globalIdField;null!=e&&i.setAttribute(e,a.getAttribute(e))}}r.geometryModified&&!r.stagedForDelete||(i.geometry=null);const s=r.stagedForDelete?"deleteFeatures":"updateFeatures";await e(o,{[s]:[i]})}}},t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"_featureFormViewModel",void 0),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"editorItem",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"featureFormViewModel",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"fullFeature",void 0),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"hasPendingEdits",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"layer",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"parent",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"parentLayer",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"shouldShowAttachments",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"shouldAllowAttachmentEditing",null),t.__decorate([s.property()],e.UpdateRecordWorkflow.prototype,"reliesOnOwnerAdminPrivileges",null),e.UpdateRecordWorkflow=g=t.__decorate([c.subclass("esri.widgets.Editor.UpdateRecordWorkflow")],e.UpdateRecordWorkflow),e.handleKeys=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});