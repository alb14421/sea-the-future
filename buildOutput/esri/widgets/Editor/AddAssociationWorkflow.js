// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../core/Error","../../core/handleUtils","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../../rest/featureService/utils","../../views/draw/support/HighlightHelper","../../views/support/HighlightDefaults","./AddAssociationWorkflowData","./Workflow","./workflowUtils","../FeatureForm/UtilityNetworkAssociationAddAssociationViewModel","../support/UtilityNetworkAssociations/utils/getFeatureTitle"],function(e,t,o,i,s,a,r,d,l,n,c,u,p,w,y,A,h,f,g,_){"use strict";var k;const m={exit:Symbol()};e.AddAssociationWorkflow=class extends h{static{k=this}constructor(e){super(e),this._utilityNetworkAssociationAddAssociationViewModel=new g,this._highlightHelper=null,this.sourceFeatureItem=null,this.type="add-association"}initialize(){const{data:e}=this,{view:t}=e.viewModel;t&&(this._highlightHelper=new w({view:t,highlightName:y.temporaryHighlightName}),this.addHandles(i.makeHandle(()=>this._highlightHelper?.removeAll())));const o=new AbortController;this.addHandles(i.abortHandle(o)),this._updatingHandles.addPromise(this._setup(o))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get utilityNetworkAssociationAddAssociationViewModel(){return this._utilityNetworkAssociationAddAssociationViewModel}get hasPendingEdits(){return!!this._utilityNetworkAssociationAddAssociationViewModel.selectedFeature}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get reliesOnOwnerAdminPrivileges(){return this.editorItem.capabilities.create.reliesOnOwnerAdminPrivileges}async enter(){this._addHandles()}exit(){this.removeHandles(m.exit)}async start(){return await super.start(),null}async _setup(e){const{data:t}=this,{feature:i}=t;try{const[o]=await f.fetchFullFeatures([i],i.sourceLayer,t.viewModel.view.spatialReference,e.signal);if(s.isAborted(e))return;const a=o.sourceLayer&&"getFeatureTitle"in o.sourceLayer?await o.sourceLayer.getFeatureTitle(o):_.getFeatureTitle(o);if(s.isAborted(e))return;this.sourceFeatureItem={feature:i,label:a},this._initializeUtilityNetworkAssociationAddAssociationViewModel()}catch(e){await this.cancel({force:!0,error:new o("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:e}})})}}_initializeUtilityNetworkAssociationAddAssociationViewModel(){const{viewModel:{view:e},utilityNetwork:t,associationType:o}=this.data,i=this._utilityNetworkAssociationAddAssociationViewModel;i.graphic=this.sourceFeatureItem.feature,i.map=e?.map,i.utilityNetwork=t,i.layer=this.layer,i.associationType=o,i.highlightHelper=this._highlightHelper,t.networkSystemLayers.loadAssociationsTable()}_addHandles(){const e=this._utilityNetworkAssociationAddAssociationViewModel;this.addHandles([a.watch(()=>e.selectedLayer,e=>{e&&this.go("add-association-select-feature")}),a.watch(()=>e.selectedFeature,e=>{e&&this.go("add-association-create-association")})],m.exit)}static async create(e){const t=new k({data:await A.create(e),onCommit:this._onCommitFactory(e.applyEditsFeatureService)});return t._set("steps",this._createWorkflowSteps(t)),t}static _createWorkflowSteps(e){return[{id:"add-association-select-layer",async setUp(){const{utilityNetworkAssociationAddAssociationViewModel:t}=e.data.viewModel;t&&(t.selectedLayer=null,t.selectedFeature=null,t.association=null)},async tearDown(){}},{id:"add-association-select-feature",async setUp(){const{utilityNetworkAssociationAddAssociationViewModel:t}=e.data.viewModel;t&&(t.selectedFeature=null,t.association=null)},async tearDown(){}},{id:"add-association-create-association",async setUp(){},async tearDown(){}}]}static{this._onCommitFactory=e=>async t=>{const{feature:i,utilityNetwork:s,associationInput:a}=t,{utilityNetworkAssociationAddAssociationViewModel:r}=t.viewModel,{association:d}=r;await s.networkSystemLayers.loadAssociationsTable();const l=s?.generateAddAssociations([d]);if(!l)throw new o("editor:failed-to-add-association","Could not create payload needed to add association");const n=i.sourceLayer,c=u.isSubtypeSublayer(n)&&n.parent?n.parent:n,w=p.createFeatureServices([c]),y=w.values().next().value?.featureService;if(!y)throw new o("editor:failed-to-delete-association","Could not retrieve feature service needed to delete association");await(y?.load());const A=s?.gdbVersion??void 0;await e(y,[l],{gdbVersion:A}),await a.refresh()}}},t.__decorate([r.property()],e.AddAssociationWorkflow.prototype,"_utilityNetworkAssociationAddAssociationViewModel",void 0),t.__decorate([r.property()],e.AddAssociationWorkflow.prototype,"_featureFormViewModel",void 0),t.__decorate([r.property()],e.AddAssociationWorkflow.prototype,"editorItem",null),t.__decorate([r.property()],e.AddAssociationWorkflow.prototype,"featureFormViewModel",null),t.__decorate([r.property()],e.AddAssociationWorkflow.prototype,"utilityNetworkAssociationAddAssociationViewModel",null),t.__decorate([r.property()],e.AddAssociationWorkflow.prototype,"sourceFeatureItem",void 0),t.__decorate([r.property()],e.AddAssociationWorkflow.prototype,"hasPendingEdits",null),t.__decorate([r.property()],e.AddAssociationWorkflow.prototype,"layer",null),t.__decorate([r.property()],e.AddAssociationWorkflow.prototype,"parent",null),t.__decorate([r.property()],e.AddAssociationWorkflow.prototype,"parentLayer",null),t.__decorate([r.property()],e.AddAssociationWorkflow.prototype,"reliesOnOwnerAdminPrivileges",null),e.AddAssociationWorkflow=k=t.__decorate([c.subclass("esri.widgets.Editor.AddAssociationWorkflow")],e.AddAssociationWorkflow),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});