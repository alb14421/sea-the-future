// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/arrayUtils","../../core/Error","../../core/handleUtils","../../core/Promise","../../core/promiseUtils","../../core/ReactiveMap","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/subclass","./Edits","./workflowUtils"],function(e,t,r,o,s,i,a,n,l,u,d,p,c){"use strict";let h=class extends s.EsriPromise{constructor(e){super(e),this.editorItems=[],this.features=[],this.parent=null,this.selectedFeature=null,this.sketchOptions=null,this.snappingManager=null,this.viewModel=null,this._editorItemsByLayer=new a,this._fullFeatures=new Map,this._pendingEdits=new a}initialize(){const e=new AbortController;this.addResolvingPromise(this._initializeFullFeatures(e.signal).then(t=>{i.throwIfAborted(e.signal),this._initializeEdits(t)}).catch(e=>{if(i.isAbortError(e))throw new r("update-features-workflow:full-features-aborted","Fetching of full features was aborted.");throw e})),this.addHandles(o.abortHandle(e)),this._initializeEditorItemsByLayer()}get fullFeatures(){return Array.from(this._fullFeatures.values())}get layers(){return t.unique(this.features.map(e=>e.sourceLayer).filter(t.isSome))}set timeZone(e){this._set("timeZone",e),this._pendingEdits.forEach(t=>{t.timeZone=e})}getEditorItemForLayer(e){return this._editorItemsByLayer.get(e)}getFeatureTitle(e){return this._pendingEdits.get(e)?.displayTitle}getPendingEditsForFeature(e){return this._pendingEdits.get(this._fullFeatures.get(e)??e)}isSubmittable(e){const t=this._pendingEdits.get(e);return!!t&&(t.submittable||t.isAssociation)}stageDelete(){for(const e of this._pendingEdits.values())e.stageDelete()}_initializeEditorItemsByLayer(){for(const e of this.editorItems)this._editorItemsByLayer.set(e.layer,e)}_initializeEdits(e){const{timeZone:t}=this;for(const r of e){const e=new p({feature:r,timeZone:t});e.trackChanges(),this._pendingEdits.set(r,e)}}async _initializeFullFeatures(e){const{spatialReference:t}=this.viewModel.view,o=this._fullFeatures,s=c.groupFeaturesByLayer(this.features),i=Array.from(s.entries()).map(async([s,i])=>{const a=await c.fetchFullFeatures(i,s,t,e);if(a.length!==i.length)throw new r("editor:update-features-workflow:fetch-full-features-incomplete","Failed to fetch full features for one or more of the provided features.");const n=s.objectIdField,l=(e,t)=>e.attributes[n]>t.attributes[n]?1:-1,u=i.sort(l),d=a.sort(l);for(let e=0;e<u.length;e++)o.set(u[e],d[e]);return a});return(await Promise.all(i)).flat()}};return e.__decorate([n.property({constructOnly:!0})],h.prototype,"editorItems",void 0),e.__decorate([n.property({constructOnly:!0})],h.prototype,"features",void 0),e.__decorate([n.property()],h.prototype,"fullFeatures",null),e.__decorate([n.property()],h.prototype,"layers",null),e.__decorate([n.property()],h.prototype,"parent",void 0),e.__decorate([n.property()],h.prototype,"selectedFeature",void 0),e.__decorate([n.property({constructOnly:!0})],h.prototype,"sketchOptions",void 0),e.__decorate([n.property()],h.prototype,"snappingManager",void 0),e.__decorate([n.property()],h.prototype,"timeZone",null),e.__decorate([n.property()],h.prototype,"viewModel",void 0),e.__decorate([n.property()],h.prototype,"_fullFeatures",void 0),h=e.__decorate([d.subclass("esri.widgets.Editor.UpdateFeaturesWorkflowData")],h),h});