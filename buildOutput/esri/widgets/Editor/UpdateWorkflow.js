// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../chunks/tslib.es6","../../Graphic","../../core/Error","../../core/handleUtils","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/Queue","../../core/reactiveUtils","../../core/SetUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../layers/support/editableLayers","../../layers/support/layerUtils","../../rest/featureService/utils","../../views/draw/support/HighlightHelper","../../views/input/InputManager","../../views/interactive/sketch/SketchOptions","../../views/support/HighlightDefaults","./CreateFeaturesWorkflow","./UpdateFeatureWorkflow","./UpdateRecordWorkflow","./UpdateWorkflowData","./Workflow","./workflowUtils","../Feature/support/featureUtils"],function(e,t,a,i,o,r,s,n,l,d,c,p,u,h,w,f,g,v,y,k,m,_,b,W,A,C,F,S,M){"use strict";var I;let E=I=class extends F{constructor(e){super(e),this._workflowStack=new l(c.last),this._sketchStack=new l(c.last),this.data=void 0,this.type="update"}destroy(){this._drainWorkflowStack(e=>e.cancel({force:!0}))}get activeEditorItem(){return this.activeWorkflow?.data.editorItem??void 0}get activeFeatureFormViewModel(){return this.activeWorkflow?.featureFormViewModel}get activeUtilityNetworkAssociationAddAssociationViewModel(){return"add-association"===this.activeWorkflow?.type?this.activeWorkflow.utilityNetworkAssociationAddAssociationViewModel:null}get activeSketchViewModel(){return this._sketchStack.peek()?.viewModel}get canDeleteAssociation(){const{activeFeatureFormViewModel:e}=this;if(!this.activeWorkflow||!this.data.viewModel.view?.map||!e)return!1;const{activeAssociation:t,feature:a}=e;return!(!t||!a?.sourceLayer||!g.isFeatureLayer(a?.sourceLayer)&&!g.isSubtypeSublayer(a?.sourceLayer))}get activeWorkflow(){return this._workflowStack.last()}get updating(){return this._updatingHandles.updating||!!this.activeWorkflow?.updating}get hasPreviousStep(){const e=this.activeWorkflow?.featureFormViewModel;return this._stepIndex>0||this.nestedWorkflowCount>1||null!=e?.relationshipId||"view"!==this.data.viewModel.attachmentsViewModel.mode||null!=e?.associationId||null!=e?.associatedLayer}get hasUpdatableCandidates(){const{candidates:e,viewModel:t}=this.data;return e.some(({layer:e})=>t.findEditorItemForLayer(e)?.supportsUpdateWorkflow)}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){return!!this.activeEditorItem?.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return!!this.activeEditorItem?.capabilities.update.attachments.enabled}get hasPendingEdits(){return Array.from(this._workflowStack).some(e=>e.hasPendingEdits)}get helpMessage(){return this.activeWorkflow?.helpMessage?this.activeWorkflow.helpMessage:"awaiting-feature-to-update"===this.stepId?"select":void 0}get reliesOnOwnerAdminPrivileges(){return this.activeWorkflow?.reliesOnOwnerAdminPrivileges??!1}get hasInvalidFormTemplate(){return!!this.activeEditorItem?.hasInvalidFormTemplate}async back(e=()=>Promise.resolve(!0)){const{activeWorkflow:t}=this,a=t?.featureFormViewModel;if(a?.activeRelationshipInput){const e=a.activeRelationshipInput;if(e.activeCategory)return void(e.activeCategory=null);if(null!=a.relationshipId)return void(a.relationshipId=null);if(e.showAllEnabled)return void(e.showAllEnabled=!1)}if("add-association"===t?.type){const{activeUtilityNetworkAssociationAddAssociationViewModel:e}=this;if(e?.filterOptionsVisible)return void(e.filterOptionsVisible=!1);e?.featureSpatialItems.length&&e.reset()}if(null==a?.associatedLayer)if(null==a?.associationId)if("create-features"===t?.type&&t.hasPreviousStep)await t.previous({cancelCurrentStep:!0});else if(t){if(t.hasPendingEdits&&!a?.disabled&&!await e())return;t.hasPreviousStep?await t.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else a.associationId=null;else a.associatedLayer=null}async cancelActiveWorkflow(e){await(this.activeWorkflow?.cancel(e)),await this._popWorkflow()}async commit(){await this._drainWorkflowStack(e=>e.commit()),await super.commit()}static create(e){const{viewModel:t,snappingManager:a,startAt:i,addAttachmentsCallback:o,applyEditsCallback:r,applyEditsFeatureServiceCallback:s}=e,n=e.sketchOptions??new m,l=new I({data:new C({addAttachmentsCallback:o,applyEditsCallback:r,applyEditsFeatureServiceCallback:s,sketchOptions:n,snappingManager:a,viewModel:t}),onCommit:async()=>{}});return l._set("steps",this._createWorkflowSteps(l,i)),l}async save(){const{activeFeatureFormViewModel:e}=this;if(e){if(e.submit(),!e.submittable||e.pendingSubtypeChoice)return;const t=e.getValues();if(e.validateContingencyConstraints(t,{includeIncompleteViolations:!0}).length>0)return}this.nestedWorkflowCount>1?(await(this.activeWorkflow?.commit()),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(e){try{const t=this._createNestedCreateFeaturesWorkflow(e);await this._pushWorkflow(t)}catch(e){throw new i("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:e})}}async startUpdating(e,t,a=!1){try{const i=await this._createNestedUpdateWorkflow(e,a,t);await this._pushWorkflow(i)}catch(e){throw new i("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:e})}}async startAddAssociation(e,t,a){try{const i=await this._createNestedAddAssociationWorkflow(e,t,a);await this._pushWorkflow(i)}catch(e){throw new i("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:e})}}async deleteActiveFeature(){const{activeWorkflow:e}=this;if(!e)throw new i("editor:nothing-to-delete","There is no feature to delete");const t=S.isUpdateRecordWorkflow(e);t?(e.stageDelete(),e.data.edits.feature===this.data.rootFeature&&this._removeRootFeatureFromCandidates()):await e.cancel(),this.nestedWorkflowCount<2?t?await this.commit():await this.cancel({force:!0}):(t&&await e.commit(),await this._popWorkflow(),await this._returnToPageWithContent())}async deleteActiveAssociation(){if(!this.canDeleteAssociation)throw new i("editor:nothing-to-delete","There is no association to delete");await this._deleteActiveAssociation(),await this._popWorkflow(),await this._returnToPageWithContent()}async cancelAll(){await this._drainWorkflowStack(e=>e.cancel({force:!0}))}async _deleteActiveAssociation(){const{activeFeatureFormViewModel:e,data:t}=this,{activeAssociation:a,feature:o}=e,{applyEditsFeatureServiceCallback:r,viewModel:s}=t,{sourceLayer:n}=o,l=g.isSubtypeSublayer(n)&&n.parent?n.parent:n,d=v.createFeatureServices([l]),c=d.values().next().value?.featureService;if(!c)throw new i("editor:failed-to-delete-association","Could not retrieve feature service needed to delete association");await(c?.load());const p=s.view.map,u=M.findUtilityNetwork(p,l);await(u?.networkSystemLayers.loadAssociationsTable());const h=u?.generateDeleteAssociations([a]);if(!h)throw new i("editor:failed-to-delete-association","Could not create payload needed to delete association");const w=u?.gdbVersion??void 0;await r(c,[h],{gdbVersion:w,globalIdUsed:!0})}_removeRootFeatureFromCandidates(){const{candidates:e,rootFeature:t}=this.data;if(0===e.length||!t)return;const a=e.indexOf(t);a>-1&&e.splice(a,1)}async _returnToPageWithContent(){const{activeFeatureFormViewModel:e}=this;if(!e?.activeAssociationInput)return;const{activeAssociationInput:t,associationId:a}=e;await t.refresh(),t.associatedLayer&&!t.associatedFeatures?.length&&(e.associatedLayer=null),null==a||t.associatedFeatureInfos.size||(e.associationId=null)}_createNestedCreateFeaturesWorkflow(e){const{relatedLayer:t}=e,{addAttachmentsCallback:a,applyEditsCallback:o,applyEditsFeatureServiceCallback:r,sketchOptions:s,snappingManager:n,viewModel:l}=this.data;if(!f.isEditableLayer(t))throw new i("editor:unsupported-layer","Editing is not supported on the provided layer");const d=this._getCreationInfoForNestedCreateFeaturesWorkflow(e),c=d.template||d.initialFeature?"creating-features":"awaiting-feature-creation-info",p="create-features"!==this.activeWorkflow?.type&&"add-association"!==this.activeWorkflow?.type?this.activeWorkflow:void 0;return b.create({addAttachmentsCallback:a,applyEditsCallback:o,applyEditsFeatureServiceCallback:r,creationInfo:d,isNested:!0,parent:p,sketchOptions:s,snappingManager:n,startAt:c,viewModel:l})}_getCreationInfoForNestedCreateFeaturesWorkflow(e){const{relatedLayer:t}=e;if(!f.isEditableLayer(t)||g.isSubtypeGroupLayer(t))throw new i("editor:unsupported-layer","Editing is not supported on the provided layer");const{viewModel:o}=this.data,r={layer:t,maxFeatures:1},s=this._makeRelatedRecordAttributes(e),n=o.getTemplatesForLayer(t);return n?.length>0?(r.attributeOverrides=s,1===n.length&&(r.template=n[0])):r.initialFeature=new a({sourceLayer:t,attributes:s}),r}async _createNestedUpdateWorkflow(e,t,a){const i=g.isTable(e.sourceLayer)?A.UpdateRecordWorkflow:W.UpdateFeatureWorkflow,{applyEditsCallback:o,applyEditsFeatureServiceCallback:r,sketchOptions:s,snappingManager:n,viewModel:l}=this.data,c="create-features"!==this.activeWorkflow?.type&&"add-association"!==this.activeWorkflow?.type?this.activeWorkflow:void 0,p=await i.create({association:a,feature:e,parent:c,sketchOptions:s,snappingManager:n,viewModel:l,readOnly:t,applyEdits:o,applyEditsFeatureService:r,featureFormCallbacks:{addRelatedRecord:async e=>await this._updatingHandles.addPromise(this.startCreatingRelatedRecord(e)),editRelatedRecord:async({relatedFeature:e,readOnly:t})=>await this._updatingHandles.addPromise(this.startUpdating(e,void 0,t)),selectAssociatedFeature:async({feature:e,association:a})=>await this._updatingHandles.addPromise(this.startUpdating(e,a,t)),addAssociation:async e=>await this._updatingHandles.addPromise(this.startAddAssociation(e.feature,e.utilityNetwork,e.associationType))}});return await d.whenOnce(()=>!p.updating),p}async _createNestedAddAssociationWorkflow(t,a,i){const{AddAssociationWorkflow:o}=await new Promise((t,a)=>e(["./AddAssociationWorkflow"],t,a)),{applyEditsCallback:r,applyEditsFeatureServiceCallback:s,viewModel:n}=this.data,l="create-features"!==this.activeWorkflow?.type&&"add-association"!==this.activeWorkflow?.type?this.activeWorkflow:void 0,c=this.activeFeatureFormViewModel?.activeAssociationInput,p=await o.create({utilityNetwork:a,associationType:i,feature:t,parent:l,viewModel:n,associationInput:c,applyEdits:r,applyEditsFeatureService:s});return await d.whenOnce(()=>!p.updating),p}async _drainWorkflowStack(e){const t=this._workflowStack,a=[];for(const i of t){const t=e(i).finally(()=>i.destroy());this._updatingHandles.addPromise(t),a.push(t)}await Promise.all(a),this._workflowStack.clear(),this._sketchStack.clear()}_makeRelatedRecordAttributes(e){const{parentFeature:t,relatedLayer:a,relationshipId:i}=e;if(!M.isGraphicForRelatableFeatureSupportedLayer(t))return;const o=a.relationships?.find(e=>e.id===i);if(!o)return void this._logContinuingWithoutRelationshipWarning("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if("origin"===o.role)return void this._logContinuingWithoutRelationshipWarning("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const r=t.sourceLayer;o.relatedTableId!==r.layerId&&this._logContinuingWithoutRelationshipWarning("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const s=r.relationships?.find(e=>e.id===i);if(!s)return void this._logContinuingWithoutRelationshipWarning("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const n=U(r,s),l=t.getAttribute(n);l||this._logContinuingWithoutRelationshipWarning("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field.");const d=U(a,o);return{[d]:l}}async _popWorkflow(){this._workflowStack.pop()?.destroy(),this._sketchStack.pop();const e=await this._reconcileWorkflowStack();if(e.failureCount>0)throw new i("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",e)}async _pushWorkflow(e){const t=this._workflowRequiresSketchViewModel(e);this.activeWorkflow?.exit({removeSketchHandles:t});const a=this._sketchStack,o=await(e?.start()),r=a.peek();o?(r?.exit(),a.push(o)):a.push(this._cloneSketchController(r)),this._workflowStack.push(e);const s=await this._reconcileWorkflowStack();if(s.failureCount>0)throw new i("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",s)}async _reconcileWorkflowStack(){const e=this._workflowStack,t=this._sketchStack;try{const a=e.peek();return await(a?.enter()),await(t.peek()?.enter()),{activeWorkflow:a,failureCount:0}}catch(a){e.pop().destroy(),t.pop();const{activeWorkflow:i,failureCount:o}=await this._reconcileWorkflowStack();return{activeWorkflow:i,failureCount:o+1}}}_cloneSketchController(e){return{enter:e?.enter??(async()=>{}),exit:e?.exit??(async()=>{}),viewModel:e?.viewModel}}_workflowRequiresSketchViewModel(e){const{type:t}=e;return"update-feature"===t||"create-features"===t&&!g.isTable(e.data.creationInfo?.layer)}static _createWorkflowSteps(e,t="awaiting-feature-to-update"){const{data:a}=e,r={"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:t}=a.viewModel,i=a.viewModel.view;i.activeTool=null;let r=null;e.addHandles(o.makeHandle(()=>{r=s.abortMaybe(r)}),this.id),a.rootFeature=null,a.candidates=[];const l=i.on("immediate-click",async o=>{const s=n.createResolver();e._updatingHandles.addPromise(s.promise);try{t.location=o.mapPoint,t.visible=!0,r?.abort();const{editorItems:s}=a.viewModel;r=new AbortController;const l=await o.defer(()=>new Promise((e,t)=>{n.onAbort(r?.signal,()=>t(n.createAbortError())),e(S.fetchCandidates(s,i,o,r?.signal))}));if(n.throwIfAborted(r),a.candidates=l.filter(e=>"fulfilled"===e.status).flatMap(e=>e.value).filter(e=>!e.isAggregate),t.visible=1===a.candidates.length,0===a.candidates.length)return;o.stopPropagation(),1===a.candidates.length?(a.rootFeature=a.candidates[0],e.go("editing-existing-feature").catch(()=>{}).then(()=>t.visible=!1)):e.next()}finally{s.resolve()}},k.ViewEventPriorities.TOOL),c=d.when(()=>null!=i.activeTool,()=>e.cancel({force:!0}),{once:!0});i.focus(),e.addHandles([l,c],this.id)},async tearDown(){0===a.candidates.length&&(a.viewModel.spinnerViewModel.visible=!1),e.removeHandles(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){a.rootFeature=null;const{view:t}=a.viewModel;if(!t)return;const i=new y({view:t,highlightName:_.temporaryHighlightName});e.addHandles([d.watch(()=>a.rootFeature,(e,t)=>{i.remove(t),i.add(e)},d.sync),o.makeHandle(()=>i.removeAll())],this.id)},async tearDown(){e.removeHandles(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:t,viewModel:a}=e.data;if(!t)throw new i("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await e.startUpdating(t),a.spinnerViewModel.visible=!1;const o=n.debounce(async()=>{await d.whenOnce(()=>!e.updating),e.previous()});e.addHandles([d.watch(()=>e.nestedWorkflowCount,(e,t)=>{0===e&&0!==t&&o()},d.sync)],this.id)},async tearDown(){await e.cancelAll(),e.removeHandles(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){a.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){a.viewModel.attachmentsViewModel.mode="view"}})};return S.createWorkflowSteps(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],t,r)}_logContinuingWithoutRelationshipWarning(e,t){r.getLogger(this).warn(`editor:${e}`,t,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature.")}};function U(e,{keyField:t}){return e.getField(t)?.name??t}return t.__decorate([p.property()],E.prototype,"activeEditorItem",null),t.__decorate([p.property()],E.prototype,"activeFeatureFormViewModel",null),t.__decorate([p.property()],E.prototype,"activeUtilityNetworkAssociationAddAssociationViewModel",null),t.__decorate([p.property()],E.prototype,"activeSketchViewModel",null),t.__decorate([p.property()],E.prototype,"canDeleteAssociation",null),t.__decorate([p.property()],E.prototype,"activeWorkflow",null),t.__decorate([p.property()],E.prototype,"updating",null),t.__decorate([p.property()],E.prototype,"data",void 0),t.__decorate([p.property()],E.prototype,"hasPreviousStep",null),t.__decorate([p.property()],E.prototype,"hasUpdatableCandidates",null),t.__decorate([p.property()],E.prototype,"nestedWorkflowCount",null),t.__decorate([p.property()],E.prototype,"shouldShowAttachments",null),t.__decorate([p.property()],E.prototype,"shouldAllowAttachmentEditing",null),t.__decorate([p.property()],E.prototype,"hasPendingEdits",null),t.__decorate([p.property()],E.prototype,"helpMessage",null),t.__decorate([p.property()],E.prototype,"reliesOnOwnerAdminPrivileges",null),t.__decorate([p.property()],E.prototype,"hasInvalidFormTemplate",null),E=I=t.__decorate([w.subclass("esri.widgets.Editor.UpdateWorkflow")],E),E});