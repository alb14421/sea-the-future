// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/arrayUtils","../../core/Collection","../../core/Error","../../core/Logger","../../core/maybe","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../../support/elevationInfoUtils","../BatchAttributeForm/BatchAttributeFormViewModel","./UpdateFeaturesWorkflowData","./Workflow","./workflowUtils","./support/SketchController"],function(e,t,r,o,i,a,s,n,l,d,u,c,p,h,y,f,w){"use strict";var g;const m=()=>i.getLogger("esri.widgets.Editor.UpdateFeaturesWorkflow");let _=g=class extends y{constructor(e){super(e),this.type="update-features",this._formViewModel=null,this._sketchController=null}async initialize(){this._initializeFormViewModel();try{await this._updatingHandles.addPromise((async()=>{const{fullFeatures:e}=await this.data.when();this._formViewModel.features=new r(e),await this._initializeVisuals(e)})())}catch(e){this.cancel({force:!0,error:new o("update-features-workflow:initialize","Failed to initialize the workflow data.",e)})}}destroy(){this._sketchController=a.destroyMaybe(this._sketchController),this._formViewModel.destroy()}get features(){return this.data.features}get formViewModel(){return this._formViewModel}get hasPendingEdits(){const{data:e}=this;return e.features.some(t=>!!e.getPendingEditsForFeature(t)?.modified)}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get selectedFeature(){return this.data.selectedFeature}get sketchViewModel(){return this._sketchController?.viewModel}get updating(){return this._updatingHandles.updating||this._formViewModel.updating||!!this._sketchController?.updating}async commit(){const{data:e,_formViewModel:t}=this;for(const r of e.fullFeatures)v(e.getPendingEditsForFeature(r),t.getValues(r));await super.commit()}static create(e){const{applyEdits:r,applyEditsFeatureService:o,...i}=e,a=t.unique(e.features.map(e=>e.sourceLayer??e.layer)).map(t=>e.viewModel.editorItems.find(e=>e.layer===t)).filter(t.isSome),s=new g({data:new h({...i,editorItems:a}),onCommit:F(e.applyEdits)});return s._set("steps",[{id:"editing-features",async setUp(){},async tearDown(){}}]),s}async deleteAndCommit(){return this.data.stageDelete(),this.commit()}enter(){throw new Error("Method not implemented.")}exit(e){throw new Error("Method not implemented.")}async reset(){}async save(){const{formViewModel:e}=this;e.submit(),e.valid&&await super.save()}async start(){await super.start(),await s.whenOnce(()=>!this.updating)}_initializeFormViewModel(){const{data:e}=this,t=e.viewModel.view,r=e.getEditorItemForLayer(b(e)),o=new p({editType:"UPDATE",map:t?.map,readOnly:!1===r?.capabilities.update.attributes,spatialReference:t?.spatialReference,timeZone:e.timeZone});this._formViewModel=o,this.addHandles(o.on("value-change",t=>{for(const r of t.features)e.getPendingEditsForFeature(r)?.setAttribute(t.fieldName,t.value);this._sketchController?.notifyAttributesChanged(t)}))}async _initializeHighlights(e,t,r){const o=await f.whenEditorLayerView(r,t);this.addHandles(o.highlight(e))}async _initializeSketchController(e,t,r){const o=new w.SketchController({sourceLayer:t,view:r,features:e});this._sketchController=o,await s.whenOnce(()=>!o.updating);const{data:i}=this;await o.startUpdatingFeatures(e,e=>{const t=[];for(const{feature:r,geometry:o}of e)i.getPendingEditsForFeature(r)?.updateGeometry(o),t.push(r);this._formViewModel.notifyGeometriesChanged(t)},()=>{m().warnOnce("editor:batch-update-visual-variables","UpdateFeaturesWorkflow does not currently support modifying visual variables through the scale and rotate tools.")})}async _initializeVisuals(e){const{data:t}=this,{view:r}=t.viewModel;if(!r)return;const o=b(t);if(u.isTable(o))return;const i=t.getEditorItemForLayer(o);return!i?.capabilities.update.geometry||"3d"===r?.type&&c.hasEffectiveFeatureExpressionInfo(o.elevationInfo)?this._initializeHighlights(e,o,r):this._initializeSketchController(e,o,r)}};function F(e){return async t=>{const r=b(t),o=[],i=[];for(const e of t.fullFeatures){const r=t.getPendingEditsForFeature(e),a=r?.stagedForDelete;if(!r?.modified&&!a)continue;const s=e.clone();if(!r?.attributesModified||a){const t=e.sourceLayer;if(!t){m().warn("Feature has no sourceLayer. It will not be included in any applyEdits payload.");continue}const r=t.objectIdField;if(s.attributes={[r]:e.getAttribute(r)},"scene"===t.type&&null!=t.infoFor3D){const r=t.associatedLayer?.globalIdField;null!=r&&s.setAttribute(r,e.getAttribute(r))}}r?.geometryModified&&!a||(s.geometry=null),a?i.push(s):o.push(s)}if(o.length+i.length===0)return void m().warn("No edits to apply. Workflow will finish without sending an applyEdits request.");const a={updateFeatures:o.length>0?o:void 0,deleteFeatures:i.length>0?i:void 0};await e(r,a)}}function b(e){if(e.layers.length>1)throw f.makeMultipleSourceLayersError();return e.layers[0]}function v(e,t){if(!e||!e.feature)return;const{attributes:r}=e.feature;Object.keys(t).some(e=>t[e]!==r[e])&&e.updateAttributes(t)}return e.__decorate([n.property()],_.prototype,"features",null),e.__decorate([n.property()],_.prototype,"formViewModel",null),e.__decorate([n.property()],_.prototype,"hasPendingEdits",null),e.__decorate([n.property()],_.prototype,"parent",null),e.__decorate([n.property()],_.prototype,"parentLayer",null),e.__decorate([n.property()],_.prototype,"selectedFeature",null),e.__decorate([n.property()],_.prototype,"sketchViewModel",null),e.__decorate([n.property()],_.prototype,"type",void 0),e.__decorate([n.property()],_.prototype,"updating",null),e.__decorate([n.property()],_.prototype,"_formViewModel",void 0),e.__decorate([n.property()],_.prototype,"_sketchController",void 0),_=g=e.__decorate([d.subclass("esri.widgets.Editor.UpdateFeaturesWorkflow")],_),_});