// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../chunks/tslib.es6","../../Graphic","../../core/Error","../../core/handleUtils","../../core/has","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/uuid","../../core/accessorSupport/decorators/property","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../editing/templateUtils","../../layers/GraphicsLayer","../../layers/support/layerUtils","../../support/guards","../../symbols/support/symbolUtils","../../views/draw/support/helpMessageUtils","../../views/draw/support/HighlightHelper","../../views/interactive/sketch/SketchOptions","../../views/interactive/snapping/FeatureSnappingLayerSource","../../views/support/HighlightDefaults","./CreateFeaturesWorkflowData","./modelUploadUtils","./Workflow","./workflowUtils","../FeatureForm/FeatureFormViewModel","../Sketch/SketchViewModel"],function(e,t,a,i,r,s,n,o,l,d,c,u,p,h,m,f,w,g,y,v,_,F,b,M,I,V,k,S,C,T){"use strict";var H;const A=Symbol(),U=Symbol(),P=Symbol(),E=Symbol(),L={point:["point"],multipoint:["multipoint"],polygon:["polygon","freehandPolygon","rectangle","circle"],polyline:["polyline","freehandPolyline"],mesh:[],multipatch:[]};let O=H=class extends k{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this.data=void 0,this.isNested=!1,this._getDrawMeshHelpMessage=void 0,this._webStyleCache=new Map,this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._featureFormViewModel=new C,this._sketchViewModel=null,this._attachmentFileInfos=new Map,this._isActive=!0}initialize(){this.isNested&&(this._isActive=!1),this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){if(this.pendingFeatures.some(e=>!!this.data.getEditsForPendingFeature(e)?.modified))return!0;const{creationInfo:e,upload:t}=this.data,a=this._sketchViewModel,{activeComponent:i}=a,r=a.createGraphic?.geometry?.type;return!("polyline"!==r&&"polygon"!==r&&"multipoint"!==r||"draw-2d"!==i?.type&&"draw-3d"!==i?.type)&&i.drawOperation.committedVertices.length>0||!(!t||"pending"!==t.state&&"success"!==t.state)||!!e?.geometryToPlace}get hasPreviousStep(){return this._stepIndex>0||"update-pending"===this.createFeatureState&&!!this.data.selectedPendingFeature&&!this.parent&&!V.isModelUpload(this.data.creationInfo)}get helpMessage(){const{creationInfo:t,viewModel:a}=this.data;if("creating-features"!==this.stepId||!t)return;const i=t.layer.geometryType,r=this._sketchViewModel.createGraphic;if("mesh"===i){this._getDrawMeshHelpMessage||new Promise((t,a)=>e(["../../views/draw/support/helpMessageUtils3d"],t,a)).then(e=>{this._getDrawMeshHelpMessage=e.getDrawMeshHelpMessage});const{view:t}=a;return"3d"===t?.type?this._getDrawMeshHelpMessage?.(r,t):void 0}const s=this._sketchViewModel.activeCreateToolDrawMode,n=this._sketchViewModel.activeTool,o="rectangle"===n?"rectangle":"circle"===n?"circle":i;return v.getDrawHelpMessage(o,r?.geometry,s)}get layer(){return this.data.creationInfo?.layer}get numPendingFeatures(){return this.pendingFeatures.length}get numPendingFeaturesExcludingHidden(){return this.pendingFeatures.filter(e=>this.data.isDisplayable(e)).length}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){return this.data.editorItem?.capabilities.create.reliesOnOwnerAdminPrivileges??!1}get shouldShowAttachments(){return(this.data.selectedPendingFeature&&this.data.editorItem?.capabilities.create.attachments.enabled)??!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){}get availableCreateTools(){const e=this.data.creationInfo?.layer.geometryType,t=this.data.viewModel.view;if(!e)return[];if(this.data.creationInfo?.maxFeatures&&this.data.creationInfo.maxFeatures<=this.numPendingFeatures)return[];if(m.isSharedTemplateOrMetadata(this.data.fullTemplate)){const{tool:t}=S.createToolFromGeometryType(e,this.data.fullTemplate);return[t]}return"2d"!==t?.type&&"multipoint"===e?[]:[...L[e]]}get _attachmentsActive(){const e=this.data.viewModel.attachmentsViewModel.mode,t=this.stepId;return this.shouldShowAttachments&&("add"===e||"edit"===e||"adding-attachment"===t||"editing-attachment"===t)}async enter(){this._isActive=!0,"awaiting-feature-creation-info"!==this.stepId&&await this._updatingHandles.addPromise(this._setUpCreatingFeaturesStep())}exit(){this._isActive=!1,this.removeHandles([P])}async updatePendingFeature(e){if(e!==this.data.selectedPendingFeature)return this._sketchViewModel.cancel(),this._startUpdating({feature:e})}async start(){return await super.start(),w.isTable(this.data.creationInfo?.layer)?null:{enter:async()=>{},exit:async()=>{},viewModel:this._sketchViewModel}}async save(){const{featureFormViewModel:e}=this;if(e.pendingSubtypeChoice)return;e.submit(),this._stashValidationState();const t=this.data.selectedPendingFeature,a=this._hasValidationErrors(t)?t:this.data.pendingFeatures.find(e=>this._hasValidationErrors(e));return a?(await this._startUpdating({feature:a}),void e?.submit()):super.save()}back(e){return"update-pending"!==this.createFeatureState||!this.data.selectedPendingFeature||V.isModelUpload(this.data.creationInfo)||this._attachmentsActive||this.parent?super.back(e):this._clearSelectedFeature()}previous(e){return"update-pending"!==this.createFeatureState||!this.data.selectedPendingFeature||V.isModelUpload(this.data.creationInfo)||this._attachmentsActive?super.previous(e):this._clearSelectedFeature()}cancelFeature(e){this.data.isSharedTemplateWorkflow?n.getLogger(this).warn("Cannot cancel individual features created by shared templates."):(this.data.removePendingFeature(e),this.sketchViewModel.layer.graphics.remove(e))}static create(e){const{addAttachmentsCallback:t,applyEditsCallback:a,applyEditsFeatureServiceCallback:i,isNested:r,creationInfo:s,parent:n,snappingManager:o,startAt:l,viewModel:d}=e,u=e.sketchOptions??new F,p=s?.layer,h=p?d.findEditorItemForLayer(p):void 0,f=new H({data:new I({creationInfo:s,editorItem:h,parent:n,sketchOptions:u,snappingManager:o,viewModel:d}),isNested:r,onCommit:async e=>{const{creationInfo:r}=e;if(!r)return;f._sketchViewModel.cancel();const s=e.pendingFeatures.toArray(),{layer:n}=r,o=n.capabilities?.editing.supportsGlobalId&&"globalIdField"in n,l=f._attachmentFileInfos,{fullTemplate:u}=e,p=S.getServiceEditsFromWorkflowData(f.data),h=m.isSharedTemplate(u)&&p;if(o){if(function(e){for(const t of e){const{sourceLayer:e}=t;e&&"globalIdField"in e&&null!=e.globalIdField&&(t.attributes[e.globalIdField]??=c.generateBracedUUID())}}(s),h){let t=function(e,t){return e.map(e=>{const{addFeatures:a}=e;if(!a||0===a.length)return e;const i=[];for(const e of a){const a=t.get(e);if(a)for(const{file:t}of a)i.push({feature:e,attachment:{globalId:c.generateBracedUUID(),data:t}})}return i.length?{...e,addAttachments:i}:e})}(p,l);const a=await S.getServiceInfoForLayer(n,d.view);a&&(t=S.orderEditsByRelationshipDependencies({edits:t,serviceInfo:a,view:d.view,findOriginalFeature:t=>e.getEditsForPendingFeature(t)?.initialFeature??t})),await i(u.featureService,t,{globalIdUsed:!0,gdbVersion:u.layer.gdbVersion??void 0})}else{const e=function(e,t){const a=[];if(!t||0===t.size)return{addFeatures:e};for(const[e,i]of t)for(const{file:t}of i)a.push({feature:e,attachment:{globalId:c.generateBracedUUID(),data:t}});return a.length?{addFeatures:e,addAttachments:a}:{addFeatures:e}}(s,l);await a(n,e,{globalIdUsed:!0})}return}const w=h?await i(u.featureService,p,{gdbVersion:u.layer.gdbVersion??void 0}):[await a(n,{addFeatures:s})];w&&l.size>0&&await Promise.all(w.map(e=>{if(e?.addFeatureResults)return t(n,function(e,t,a,i){const r=[];return t.forEach((t,s)=>{if(!t.error){const n=e[s],o=i.get(n)||[];n.attributes[a.objectIdField]=t.objectId,o.forEach(({form:e})=>r.push({feature:n,attachment:e}))}}),r}(s,e.addFeatureResults,n,l))}))}});return f._set("steps",this._createWorkflowSteps(f,l)),f}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",r.makeHandle(()=>e.effect=t)}const t=e.opacity;return e.opacity=.7,r.makeHandle(()=>e.opacity=t)}async _initializeFullTemplateAndExecutorInfo(t){const{creationInfo:a}=t,{view:i}=t.viewModel;if(!a||!i)return null;const r=await S.getFullTemplateForCreationInfo(a,i);if(t.fullTemplate=r,r&&m.isSharedTemplate(r)){const{createTemplateExecutor:s}=await new Promise((t,a)=>e(["../../editing/sharedTemplates/executor/createTemplateExecutor"],t,a)),n={completionResults:[],executor:await s(r),serviceLayersById:await S.getServiceLayersById(a.layer,i)};t.templateExecutorInfo=n}return r}async _startCreating(){this.removeHandles(U);const{data:e}=this;if(!e.creationInfo)return;const t=this.data.creationInfo?.maxFeatures;if(t&&this.numPendingFeatures>=t)return this.sketchViewModel.cancel(),void(this.numPendingFeatures&&await this._startUpdating({feature:this.pendingFeatures.at(-1)}));this.createFeatureState="create-new",await S.startCreatingNewFeature(this._sketchViewModel,e,this._webStyleCache)}async _clearSelectedFeature(){const e=this._featureFormViewModel.pendingSubtypeChoice;e&&(e.resolve("undo"),await e.promise),this._stashValidationState(),this.sketchViewModel.cancel(),this.data.selectedPendingFeature=null,this._featureFormHandle=o.removeMaybe(this._featureFormHandle),this._featureFormViewModel.feature=null;const t=this.data.viewModel.attachmentsViewModel;"add"!==t.mode&&"edit"!==t.mode||await(this.data.viewModel.activeWorkflow?.previous())}_stashValidationState(){const e=this._featureFormViewModel.feature,t=e&&this.data.getEditsForPendingFeature(e);t&&(t.submittable=this._featureFormViewModel.submittable)}async _selectFeatureForUpdate({feature:e,initialFeature:t=e}){this._stashValidationState();const{data:a,pendingFeatures:i,_webStyleCache:s}=this;i.includes(e)||a.addPendingFeature(e,t),a.selectedPendingFeature=e;const{_featureFormViewModel:n,_sketchViewModel:l}=this,{creationInfo:c,viewModel:u}=a,{attachmentsViewModel:p,layerInfos:h,view:m}=u;if(!m||!c)return;o.removeMaybe(this._featureFormHandle);const f=e.sourceLayer,w=S.findLayerInfo(h,f),y=w?.formTemplate,v=m.spatialReference;n.set({editType:"INSERT",feature:e,formTemplate:y,spatialReference:v,map:m.map}),"add"!==p.mode&&"edit"!==p.mode||await(u.activeWorkflow?.previous()),p.graphic=e,p.fileInfos.removeAll(),p.mode="view",(this._attachmentFileInfos.get(e)||[]).forEach(({file:e,form:t})=>p.addFile(e,t)),await S.updateGraphicSymbolWhenRequired(e,s,"2d"===m.type?m.scale:null);const _=a.getEditsForPendingFeature(e);this._featureFormHandle=r.handlesGroup([n.on("value-change",async({fieldName:t,value:a})=>{if(_?.updateAttributes(n.getValues()),g.isNumber(a)){const e=this._visualVariableAttributes;e.size&&!e.size.isUpdatingInteractively&&t===e.size.field&&e.size.setInitialValue(a),e.rotation&&!e.rotation.isUpdatingInteractively&&t===e.rotation.field&&e.rotation.setInitialValue(a)}await S.updateGraphicSymbolWhenRequired(e,s,"2d"===m.type?m.scale:null)}),l.on(["update","undo","redo"],e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&null!=e.toolEventInfo&&S.isTerminalUpdateEventType(e.toolEventInfo.type))&&n.notifyFeatureGeometryChanged()}),d.watch(()=>n.feature?.sourceLayer,t=>e.sourceLayer=t),d.watch(()=>[n.feature,n.submittable],()=>this._stashValidationState())]),this.createFeatureState="update-pending"}async _startUpdating({feature:e,initialFeature:t=e}){await this._selectFeatureForUpdate({feature:e,initialFeature:t});const{_sketchViewModel:a,data:i}=this,{creationInfo:r,viewModel:s}=i,{view:n}=s;if(!n||!r)return;const o=e.sourceLayer??r.layer;return w.isTable(o)?void 0:(this._visualVariableAttributes=S.getVisualVariableAttributes(e),S.startUpdatingFeatureGeometry({graphic:e,sketchViewModel:a,sourceLayer:o,visualVariables:this._visualVariableAttributes,webStyleCache:this._webStyleCache}))}static _createWorkflowSteps(e,t="awaiting-feature-creation-info"){const{data:a}=e,i={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const{creationInfo:t,viewModel:i}=a,{view:r}=i;r&&(V.isModelUpload(t)?e.addHandles(await V.handleModelUpload({view:r,data:a,next:()=>e.next(),cancel:()=>i.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(a.parent&&t&&e.addHandles(i.restrictFeatureTemplatesViewModelToLayer(t.layer),this.id),e.addHandles(i.featureTemplatesViewModel.on("select",({item:t})=>{t&&(a.creationInfo={...a.creationInfo,layer:t.layer,template:t.template},e.next())}),this.id)))},async tearDown(){e.removeHandles(this.id)}}),"creating-features":()=>({id:"creating-features",async setUp(){e._isActive&&await e._setUpCreatingFeaturesStep()},async tearDown(t){const{viewModel:i}=a;t.canceled&&(e.removeHandles([P,A,U,E]),i.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}})},r=S.createWorkflowSteps(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],t,i);return S.avoidFeatureTemplateSelectionWithOnlyOneItem(a,r)}static _configureSketchViewModel(e){const{data:t}=e,a=e._webStyleCache,{creationInfo:i,viewModel:s}=t,{view:n}=s,c=e._sketchViewModel,u=[];if(!n)return r.makeHandle();if("2d"===n.type){i&&u.push(e._fadeExistingFeatures(i.layer));const t=l.debounce((e,t)=>Promise.all(e.map(e=>S.updateGraphicSymbolWhenRequired(e,a,t))));u.push(d.watch(()=>n.scale,e=>t(c.layer.graphics,e)))}const p=S.getCreationAttributes(t.fullTemplate,i?.attributeOverrides),h=d.watch(()=>c.createGraphic,i=>{i&&!e.hasHandles(U)&&e._updatingHandles.addPromise(S.setUpSketchCreateWatchers({creationAttributes:p,data:t,sketchViewModel:c,view:n,webStyleCache:a}).then(t=>e.addHandles(t,U)))});u.push(h,c.on("create",t=>e._updatingHandles.addPromise((async t=>{if("cancel"!==t.state&&"complete"!==t.state||e.removeHandles(U),"cancel"===t.state&&null!==n.activeTool&&n.activeTool!==e.sketchViewModel.activeComponent&&(await e._waitForActiveToolCleared(),await e._startCreating()),"complete"===t.state&&t.graphic){const a=await e._processEdits(t.graphic,{scale:"2d"===n.type?n.scale:null,useSourceLayer:!0,webStyleCache:e._webStyleCache});a&&(await e._waitForActiveToolCleared(),await e._startUpdating({feature:a}))}})(t))),c.on("update",a=>e._updatingHandles.addPromise((async a=>{const{attachmentsViewModel:r}=s,{_featureFormViewModel:o}=e;if(a.graphics.length>1)return void await e._clearSelectedFeature();const l=a.graphics[0];if("complete"===a.state){const{submittable:t}=o;if(e.numPendingFeatures!==i?.maxFeatures&&t||o.submit(),await e._clearSelectedFeature(),"add"!==r.mode&&"edit"!==r.mode||await(s.activeWorkflow?.previous()),!a.aborted&&n.activeTool===e.sketchViewModel.activeComponent&&(await e.sketchViewModel.wait(),"ready"===e.sketchViewModel.state&&"mesh"!==e.data.creationInfo?.layer.geometryType))return e._startCreating()}else{if("start"===a.state)return l.sourceLayer??=t.creationInfo?.layer,await S.setVisualVariablesAndElevationInfoForUpdate({sketchViewModel:c,graphic:l,visualVariables:e._visualVariableAttributes,webStyleCache:e._webStyleCache,sourceLayer:l.sourceLayer}),e._selectFeatureForUpdate({feature:l});if("active"===a.state){await e.updatePendingFeature(l);const t=e._visualVariableAttributes;S.visualVariableInteractiveUpdate(n,l,a,t)&&await S.updateGraphicSymbolWhenRequired(l,e._webStyleCache,"2d"===n.type?n.scale:null);const i=l.attributes,{rotation:r,size:s}=t;if(null!=r){const{field:e}=r;o.setValue(e,i[e])}if(null!=s){const{field:e}=s;o.setValue(e,i[e])}}}})(a))),c.on("delete",a=>e._updatingHandles.addPromise((async a=>{if(a.graphics.forEach(e=>{t.removePendingFeature(e)}),!V.isModelUpload(t.creationInfo))return e._startCreating()})(a))),d.when(()=>!e.numPendingFeatures,()=>e._updatingHandles.addPromise((async()=>{if(V.isModelUpload(t.creationInfo))try{await e.data.viewModel.back()}catch{}return e._startCreating()})())),r.makeHandle(()=>{c.cancel()}),function(e,t){let a=null;const i=()=>e.snappingOptions.featureSources,s=()=>{null!=a&&(i().remove(a),a=o.destroyMaybe(a))};return r.handlesGroup([d.watch(()=>{const e=t.creationInfo?.layer,a=i().find(t=>t.layer===e);return{hasFeatureLayerSource:!!a,enabled:a?.enabled??!1}},({hasFeatureLayerSource:t,enabled:r})=>{if(!t)return s();a??=(a=new b({layer:e.layer}),i().add(a),a),a.enabled=r},d.syncAndInitial),r.makeHandle(s)])}(c,t),...function(e){const t=e.viewModel.view;if(!t)return[];const a=[];if("3d"===t.type){const i=new _({view:t});a.push(d.watch(()=>e.selectedPendingFeature,(e,t)=>{i.remove(e),i.add(t)}),r.makeHandle(()=>i.destroy()))}const i=new _({view:t,highlightName:M.temporaryHighlightName});return a.push(d.watch(()=>e.temporaryHighlightFeature,e=>{i.removeAll(),i.add(e)}),r.makeHandle(()=>i.destroy())),a}(t));const m=r.handlesGroup(u);return c.addHandles(m),m}_initializeSketchViewModel(){const{data:e}=this,{view:t}=e.viewModel,a=new f({elevationInfo:e.creationInfo?.layer.elevationInfo,internal:!0,listMode:"hide",title:"createFeaturesWorkflow-internal"}),i=new T({layer:a,creationMode:"single",sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,defaultUpdateOptions:{multipleSelectionEnabled:!1},view:t});this._sketchViewModel=i,t?.map.add(a),this.addHandles([r.makeHandle(()=>{t?.destroyed||t?.map.remove(a),a.destroy()}),d.watch(()=>this.numPendingFeatures>0,e=>this._sketchViewModel.updateOnGraphicClick=e,d.initial)])}_hasValidationErrors(e){return!(!e||this.data.isSubmittable(e)&&!this._featureFormViewModel.validateContingencyConstraints(e.attributes,{includeIncompleteViolations:!0})?.length)}async _processEdits(e,t){const{data:a,_featureFormViewModel:i}=this,{layerInfos:r,view:s}=a.viewModel;i.editType="INSERT",i.map=s?.map,i.spatialReference=s?.spatialReference;const{templateExecutorInfo:n}=a;if(!n){const t=e.clone();return t.geometry=null,await this._addAndInitializeEdits(e,t),e}const o=this.sketchViewModel.layer;o.remove(e);const{executor:c}=n,u=c(e.geometry,"completion"),p=l.isPromiseLike(u)?await u:u;n.completionResults.push(p),S.setRelationshipFields(p.relationships),i.editType="INSERT",i.map=s?.map,i.spatialReference=s?.spatialReference,p.primary&&a.creationInfo?.attributeOverrides&&(p.primary.graphic.attributes={...p.primary.graphic.attributes,...a.creationInfo.attributeOverrides});for(const e of p.edits){let a=null;if(e.addFeatures)for(const i of e.addFeatures){const e=i.clone();e.geometry=null,null!=i.geometry&&(i.symbol=await y.getDisplayedSymbol(i,t),o.add(i)),i.sourceLayer!==a?.layer&&(a=S.findLayerInfo(r,i.sourceLayer));const s=!!p.associationGraphics?.has(i);await this._addAndInitializeEdits(i,e,a,s)}}return i.feature=null,await d.whenOnce(()=>!i.updating),p.edits.reduce((e,t)=>e+(t.addFeatures?.length??0),0)>1?null:p.primary?.graphic}async _addAndInitializeEdits(e,t,a,i=!1){const{data:r,_featureFormViewModel:s}=this,{layerInfos:n}=r.viewModel,o=r.addPendingFeature(e,t,{isAssociation:i});a??=S.findLayerInfo(n,e.sourceLayer),s.feature=e,s.formTemplate=a?.formTemplate,await d.whenOnce(()=>!s.updating),o.submittable=s.submittable}async _setUpCreatingFeaturesStep(){if(this.hasHandles(P))return;const{data:e,sketchViewModel:t}=this,{creationInfo:s,viewModel:n}=e,{attachmentsViewModel:l,view:c}=n;if(!c||!s?.layer)throw new i("missing-parameters","CreateFeaturesWorkflow requires a view and creationInfo.");const{initialFeature:u,layer:p}=s,h=[],f=[];this._featureFormHandle=o.removeMaybe(this._featureFormHandle),this._visualVariableAttributes={rotation:null,size:null},e.editorItem=n.findEditorItemForLayer(s.layer),s.template&&(null==e.fullTemplate&&await this._initializeFullTemplateAndExecutorInfo(e),f.push(r.makeHandle(()=>{e.templateExecutorInfo&&(e.templateExecutorInfo.completionResults=[])}))),t.allowDeleteKey=!e.isSharedTemplateWorkflow,S.prepareAttachmentsForCreateFeaturesWorkflow(l),h.push(d.watch(()=>l.mode,e=>{switch(e){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}));const g=S.showProgressCursor(c);h.push(g);const y=w.isTable(s.layer),{template:v}=s,_=!v||m.isStandardFeatureTemplate(v)||m.isSharedTemplateOrMetadata(v)&&"feature"===v.type,F=y&&_;try{if(F){const t=u??new a({attributes:S.getCreationAttributes(e.fullTemplate,s.attributeOverrides),sourceLayer:p}),i=await this._processEdits(t);i&&await this._startUpdating({feature:i})}else h.push(H._configureSketchViewModel(this)),u?(V.isModelUpload(s)&&s.geometryToPlace&&(u.attributes=S.getCreationAttributes(e.fullTemplate,s.attributeOverrides)),t.layer.add(u),await this._startUpdating({feature:u})):await this._startCreating()}finally{g.remove()}const b=r.makeHandle(()=>{for(const a of e.pendingFeatures)t.layer.remove(a),e.removePendingFeature(a)}),M=d.watch(()=>c?.timeZone,e=>{this._featureFormViewModel.timeZone=e,this.data.timeZone=e},d.initial),I=r.makeHandle(()=>{V.isModelUpload(s)&&n.cancelWorkflow({warnIfNoWorkflow:!1})});this._featureFormHandle&&h.push(this._featureFormHandle),this.addHandles(h,this._handleKeys.beforeCommit),this.addHandles(f,this._handleKeys.afterCommit),this.addHandles([r.makeHandle(()=>l.fileInfos.removeAll()),r.handlesGroup(h),r.handlesGroup(f),I,b,M],P)}async _waitForActiveToolCleared(){const e=this.data.viewModel.view;if(null==e?.activeTool)return;const t=new AbortController;this.addHandles(r.abortHandle(t),E),await d.whenOnce(()=>null==e?.activeTool,t.signal),t.abort()}};return t.__decorate([u.property()],O.prototype,"createFeatureState",void 0),t.__decorate([u.property()],O.prototype,"data",void 0),t.__decorate([u.property({constructOnly:!0})],O.prototype,"isNested",void 0),t.__decorate([u.property()],O.prototype,"featureFormViewModel",null),t.__decorate([u.property()],O.prototype,"hasPendingEdits",null),t.__decorate([u.property()],O.prototype,"hasPreviousStep",null),t.__decorate([u.property()],O.prototype,"_getDrawMeshHelpMessage",void 0),t.__decorate([u.property()],O.prototype,"helpMessage",null),t.__decorate([u.property()],O.prototype,"layer",null),t.__decorate([u.property()],O.prototype,"parent",null),t.__decorate([u.property()],O.prototype,"parentLayer",null),t.__decorate([u.property()],O.prototype,"keyboardCancellationEnabled",null),t.__decorate([u.property()],O.prototype,"reliesOnOwnerAdminPrivileges",null),t.__decorate([u.property()],O.prototype,"shouldShowAttachments",null),t.__decorate([u.property()],O.prototype,"shouldAllowAttachmentEditing",null),t.__decorate([u.property()],O.prototype,"sketchViewModel",null),t.__decorate([u.property()],O.prototype,"availableCreateTools",null),t.__decorate([u.property()],O.prototype,"_attachmentsActive",null),O=H=t.__decorate([h.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],O),O});