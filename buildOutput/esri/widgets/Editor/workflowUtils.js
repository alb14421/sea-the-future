// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../Color","../../Graphic","../../core/arrayUtils","../../core/asyncUtils","../../core/has","../../core/Error","../../core/handleUtils","../../core/lang","../../core/Logger","../../core/MapUtils","../../core/promiseUtils","../../core/reactiveUtils","../../core/screenUtils","../../core/accessorSupport/diffUtils","../../editing/templateUtils","../../editing/sharedTemplates/SharedTemplateProvider","../../layers/GraphicsLayer","../../layers/support/fieldUtils","../../layers/support/layerUtils","../../renderers/support/clickToleranceUtils","../../renderers/support/lengthUtils","../../renderers/support/typeUtils","../../renderers/visualVariables/support/sizeVariableUtils","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../symbols/support/symbolConversion","../../symbols/support/symbolUtils","../../undoredo/support/Services","../../views/3d/layers/graphics/GraphicState","../../views/draw/DrawingMode","../../views/support/drapedUtils","../../views/support/hitTestSelectUtils","./support/dependencySort","../Sketch/support/sketchUtils"],function(e,t,r,a,n,i,o,s,l,c,u,d,p,f,y,h,m,b,g,w,v,S,I,T,F,k,A,U,V,O,L,M,x,G,P,C,E){"use strict";const z=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function D(e){return null!=e&&"update-features"===e.type}function q(e){return null!=e&&"update"===e.type}function R(e){const t=e&&"renderer"in e?e.renderer:null;if(!H(t))return{rotation:null,size:null};const r=t.getVisualVariablesForType("rotation").filter(e=>(!e.axis||"heading"===e.axis)&&e.field&&!e.valueExpression),a=t.getVisualVariablesForType("size").filter(e=>e.field&&!e.useSymbolValue&&!e.valueExpression&&"real-world-size"===F.getTransformationType(e));return{rotation:1===r.length?r[0]:null,size:1===a.length?a[0]:null}}function j(e){const t=e.sourceLayer;if(!(t&&"renderer"in t&&H(t.renderer)))return{rotation:null,size:null};const{rotation:r,size:a}=R(t);let n=null,i=null;if(r){const e=t.fields?.filter(e=>e.name===r.field),a=1===e?.length?e[0]:null;n=W(r,a)}if(a){const e=t.fields?.filter(e=>e.name===a.field),r=1===e?.length?e[0]:null;i=B(a,r)}return{rotation:n,size:i}}function W(e,t){const r="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,a=t?.type??"double",n={initial:0,current:0};return{field:e.field,fieldType:a,getDefaultValue:()=>Promise.resolve(0),getValue:e=>(n.current=n.initial-r*e,N((n.current+360)%360,a)),setInitialValue:e=>{n.initial=e,n.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}function B(t,r){const a=t.axis,n=r?.type??"double",i={initial:0,current:0},o=I.meterIn[t.valueUnit]??1;let s;return s="area"===t.valueRepresentation?e=>(e*o/2)**2*Math.PI:"radius"===t.valueRepresentation||"distance"===t.valueRepresentation?e=>e*o/2:e=>e*o,{field:t.field,fieldType:n,getDefaultValue:async(t,r)=>N(s(await async function(t,r,a){if(null==r)return 0;const{symbol:n}=V.to3D(r);if(null==n||"web-style"===n.type||"cim"===n.type)return 0;const i=n.symbolLayers.at(0);if(!i)return 0;switch(i.type){case"icon":{const{computeIconLayerResourceSize:t}=await new Promise((t,r)=>e(["../../symbols/support/symbolLayerUtils"],t,r));return Math.min(he.icon,(await t(i,he.icon))[0])||he.icon}case"text":return he.text;case"line":return he.line;case"object":{const{computeObjectLayerResourceSize:r}=await new Promise((t,r)=>e(["../../symbols/support/symbolLayerUtils"],t,r));return function(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}(await r(i,t.scale/he.viewScaleSizeFactor),a)}case"path":case"extrude":return t.scale/he.viewScaleSizeFactor;default:return 0}}(r,t,a)),n),getValue:(e,t)=>(i.initial||(i.initial=t.pixelSizeAt(t.center)),i.current=i.initial*e,N(i.current,n)),setInitialValue:e=>{i.initial=e,i.current=0},isUpdatingInteractively:!1,displayUnit:me(t.valueUnit),axis:t.axis}}function N(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function H(e){if(!T.isRenderer(e))return!1;switch(e?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}async function Z(e,t,r){const a=await O.getDisplayedSymbol(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t,scale:r});null!=h.diff(e.symbol,a)&&(e.symbol=a)}function Q(e,t){if(!e||!t)throw new Error("no geometry type");if("multipatch"===e)return{tool:"mesh",createOptions:{mode:"hybrid"}};const r=new Map;r.set("circle",{mode:"freehand"}),r.set("rectangle",{mode:"freehand"});const a={mode:x.defaultDrawingMode,optionsPerTool:r};if(m.isSharedTemplateOrMetadata(t)){const n=t.defaultTool,i=m.isSharedGroupTemplate(t)?t.definition?.inputGeometryType??e:e;switch(n){case"freehand":case"stream-line":return{tool:"polyline"===i?"freehandPolyline":"freehandPolygon",createOptions:a};case"autocomplete-freehand-polygons":case"stream-polygon":return{tool:"freehandPolygon",createOptions:a};case"autocomplete-polygons":case"difference-polygon":case"create-structures":case"polygon":case"trace":return{tool:"polygon"===i?"polygon":"polyline",createOptions:a};case"circle":return r.get("circle").preserveAspectRatio=!0,{tool:"circle",createOptions:a};case"ellipse":return r.get("circle").preserveAspectRatio=!1,{tool:"circle",createOptions:a};case"create-points-along-line":case"multipoint":return{tool:"multipoint",createOptions:a};case"line":case"radial-line":case"right-angle-line":case"split":case"two-point-line":return{tool:"polyline",createOptions:a};case"rectangle":case"regular-polygon":case"right-angle-polygon":return{tool:"rectangle",createOptions:a};case"elevation-point-from-contour":case"elevation-point-from-dem":case"parcel-seed":case"point":case"point-and-rotation":case"point-at-end-of-line":return{tool:"point",createOptions:a}}}else{const n=t.drawingTool;if("circle"===n||"ellipse"===n)return r.get("circle").preserveAspectRatio="circle"===n,{tool:"circle",createOptions:a};if("rectangle"===n)return{tool:"rectangle",createOptions:a};if("freehand"===n)return{tool:"polygon"===e?"freehandPolygon":"freehandPolyline",createOptions:a}}return{tool:e,createOptions:a}}function _({creationAttributes:e,data:t,sketchViewModel:r,view:a,webStyleCache:n}){const{creationInfo:i}=t,{fullTemplate:o}=t;if(!i||"2d"!==a?.type||m.isSharedGroupTemplate(o)||m.isSharedPresetTemplate(o))return null;const s=p.debounce(t=>se(r,i.layer,e,n,t));return f.watch(()=>a.scale,e=>s(e))}function $({data:e,sketchViewModel:t,view:a}){const{templateExecutorInfo:i}=e;if(!i)return null;const o=t.activeComponent;if(!a||!E.isDrawGraphicTool(o))return u.getLogger("esri.widgets.Editor.workflowUtils").error(new s("featureworkflow","Failed to set up template feedback.")),null;const c=new g({effect:"saturate(0.6) opacity(0.8)",listMode:"hide",title:"Shared Template Feedback Graphics"});a.map?.add(c);const{executor:d,serviceLayersById:y}=i,h=a.theme?.accentColor??new r([255,165,0,1]);return l.handlesGroup([f.on(()=>o,["cursor-update","vertex-add"],()=>{c.removeAll();const e=o.graphic?.geometry;if(!e||!function(e){switch(e.type){case"point":case"multipoint":return!0;case"polyline":return e.paths[0].length>1;case"polygon":{const t=e.rings[0];return n.equals(t.at(0),t.at(-1))?t.length>2:t.length>1}default:return!1}}(e))return;const t=d(e,"digitizing");if(!p.isPromiseLike(t))for(const e of t.edits){const t=y.get(e.id);if(t&&e.addFeatures&&0!==e.addFeatures.length)for(const r of t)if(!r.isTable)for(const t of e.addFeatures){const e=J(t,h);e&&c.add(e)}}}),l.makeHandle(()=>{a.map.remove(c),c.destroy()})])}function J(e,t){let r=null;switch(e.geometry?.type){case"point":case"multipoint":r=new U({angle:0,color:t,outline:new A({cap:"round",color:t,join:"round",miterLimit:1,style:"solid",width:1}),path:"undefined",size:8,style:"circle",xoffset:0,yoffset:0});break;case"polygon":r=new k({color:t,outline:new A({cap:"round",color:t,join:"round",miterLimit:1,style:"solid",width:3}),style:"none"});break;case"polyline":r=new A({cap:"round",color:t,join:"round",miterLimit:1,style:"solid",width:2});break;default:return null}return new a({geometry:e.geometry,symbol:r,attributes:{...e.attributes}})}async function K(e,t){const r=await L.getServices(t).load(),a=v.isSubtypeSublayer(e)?e.parent:e;return r.tablesAndLayersLookup.get(a)}function X(e){const t=e.objectIdField,r=e.globalIdField??"";return{id:e.layerId,identifierFields:{objectIdField:t,globalIdField:r},addFeatures:[],deleteAttachments:[],addAttachments:[],deleteFeatures:[],updateFeatures:[]}}function Y(e){const t=new Map;for(const r of e)t.set(r.layerId,r);return t}function ee(e,t){const r=new Map;for(const a of e)for(const e of a.relationships??[])if(r.set(re(a,e),""),t.has(e.relatedTableId)){const n=t.get(e.relatedTableId);if(n.length>0)for(const t of n[0].layer.relationships??[])if(t.id===e.id){r.set(re(a,e),t.keyField);break}}return r}function te(e,t,r){const a=[];for(const n of e){const e=n.layer.relationships??[],{uniqueId:i}=n;for(const o of e){const e=o.keyField;if("origin"===o.role){const s=r.get(o.relatedTableId);if(!s||0===s.length)continue;const l=re(n.layer,o),c=t.get(l);if(void 0===c||""===c)continue;switch(n.operationType){case"add":for(const t of s)t!==n&&("add"!==t.operationType&&"modify"!==t.operationType||t.after.attributes[c]===n.after.attributes[e]&&a.push([i,t.uniqueId]));break;case"modify":if(n.before.attributes[e]!==n.after.attributes[e])for(const t of s){const r=t.uniqueId;t!==n&&("delete"===t.operationType?t.before.attributes[c]===n.before.attributes[e]?a.push([r,i]):t.before.attributes[c]===n.after.attributes[e]&&a.push([i,r]):"add"===t.operationType?t.after.attributes[c]===n.after.attributes[e]?a.push([i,r]):t.after.attributes[c]===n.before.attributes[e]&&a.push([r,i]):"modify"===t.operationType&&(t.before.attributes[c]!==t.after.attributes[c]?t.after.attributes[c]===n.after.attributes[e]?a.push([i,r]):a.push([r,i]):a.push([i,r])))}break;case"delete":for(const t of s)t!==n&&("delete"!==t.operationType&&"modify"!==t.operationType||t.before.attributes[c]===n.before.attributes[e]&&a.push([t.uniqueId,i]))}}}}return a}function re(e,t){return`${e.layerId}:${t.id}`}function ae(e,t){return!!(t?.map&&"utilityNetworks"in t.map&&t.map.utilityNetworks?.length&&t.map.utilityNetworks.some(t=>!(!t.loaded||!e.url?.startsWith(t.featureServiceUrl)||e.layerId!==t.networkSystemLayers.associationsTableId)))}function ne(e,t,r){const a=[];for(const t of e)ae(t.layer,r)&&a.push(t);if(0===a.length)return;let n=[];for(const r of a){const a=r.layer;switch(r.operationType){case"delete":n=[...ie(r.before.attributes[a.fieldsIndex.get("fromglobalid").name],e),...ie(r.before.attributes[a.fieldsIndex.get("toglobalid").name],e)];for(const e of n)t.push([r.uniqueId,e.uniqueId]);break;case"add":n=[...ie(r.after.attributes[a.fieldsIndex.get("fromglobalid").name],e),...ie(r.after.attributes[a.fieldsIndex.get("toglobalid").name],e)];for(const e of n)t.push([e.uniqueId,r.uniqueId])}}}function ie(e,t){const r=[],a=t.filter(({layer:e})=>""!==e.globalIdField&&null!=e.globalIdField);for(const t of a){const a=t.layer.globalIdField;("before"in t&&t.before?.attributes[a]===e||"after"in t&&t.after?.attributes[a]===e)&&r.push(t)}return r}function oe(e,t={}){return m.isSharedGroupTemplate(e)||m.isSharedPresetTemplate(e)?{}:m.isStandardFeatureTemplate(e)?{...e.prototype.attributes,...t}:m.isSharedFeatureTemplate(e)?{...e.definition?.defaultValues,...t}:{...t}}async function se(e,t,r,n,i){const o=new a({sourceLayer:t,attributes:r}),{rotation:s,size:l}=j(o);let c=await O.getDisplayedSymbol(o,{useSourceLayer:!0,webStyleCache:n,scale:i}),u=!1;for(const t of[l,s])null!=t&&null==r[t.field]&&(r[t.field]=await t.getDefaultValue(c,e.view),u=!0);switch(u&&(c=await O.getDisplayedSymbol(o,{useSourceLayer:!0,webStyleCache:n,scale:i})),c?.type){case"simple-fill":case"polygon-3d":e.polygonSymbol=c;break;case"simple-line":case"line-3d":e.polylineSymbol=c;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":e.pointSymbol=c;break;case"mesh-3d":e.meshSymbol=c}le(e.tooltipOptions,l,s)}function le(e,t,r){e.visualVariables=null!=t||null!=r?{size:null!=t?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:null!=r?{valueType:r.fieldType,rotationType:r.rotationType??"geographic"}:null}:null}function ce(e){return w.fixFields(e.fieldsIndex,[e.objectIdField,w.getDisplayFieldName({displayField:"displayField"in e?e.displayField:null,fields:e.fields})])}async function ue(e){const{graphic:t,sketchViewModel:r,sourceLayer:a,visualVariables:n}=e;await de(e);const i={multipleSelectionEnabled:!1};return"point"===a.geometryType&&(i.enableRotation=null!=n.rotation,i.enableScaling=null!=n.size),r.update(t,i)}async function de(e){const{graphic:t,sketchViewModel:r,sourceLayer:a,visualVariables:n,webStyleCache:i}=e;let o=!1;const{rotation:s,size:l}=n;for(const e of[s,l]){if(null==e)continue;const a=t.getAttribute(e.field);if(null!=a)e.setInitialValue(a);else{const a=await e.getDefaultValue(t.symbol,r.view);e.setInitialValue(a),t.setAttribute(e.field,a),o=!0}}if(o){const e="2d"===r.view?.type?r.view.scale:null;await Z(t,i,e)}le(r.tooltipOptions,l,s),r.layer.elevationInfo=a.elevationInfo}function pe(e,t,r,a){if(null==t.geometry||"point"!==t.geometry?.type)return!1;const n=t.attributes;let i=!1;const o=a.rotation,s=null==(l=r.toolEventInfo)||"rotate-start"!==l.type&&"rotate"!==l.type&&"rotate-stop"!==l.type?null:l;var l;if(null!=o&&null!=s){const{field:r,getValue:a}=o;if("rotate-stop"===s.type)o.isUpdatingInteractively=!1,o.setInitialValue(t.getAttribute(r));else{o.isUpdatingInteractively=!0;const l=a(s.angle,e);l!==n[r]&&t.setAttribute(r,l),i=!0}}const c=a.size,u=function(e){return null==e||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}(r.toolEventInfo);if(null!=c&&null!=u){const{field:r,getValue:a}=c;if("scale-stop"===u.type)c.isUpdatingInteractively=!1,c.setInitialValue(t.getAttribute(r));else{c.isUpdatingInteractively=!0;const o=a(u.xScale,e);o!==n[r]&&t.setAttribute(r,o),i=!0}}return i}function fe(e,t,r){if("3d"===e.type){const a=new M.GraphicState({graphic:t});return l.handlesGroup([e.trackGraphicState(a),f.watch(()=>a.displaying,r)])}return f.watch(()=>t.visible,r)}async function ye(e,t){if("3d"===e.type){const r=new M.GraphicState({graphic:t}),a=e.trackGraphicState(r);await f.whenOnce(()=>r.displaying||r.error),a.remove()}else await f.whenOnce(()=>t.visible)}const he={icon:y.px2pt(24),text:y.px2pt(12),line:y.px2pt(1),viewScaleSizeFactor:100};function me(e){return"unknown"===e?null:e}const be=(e,t)=>{const r="subtype-sublayer"===t.type?t.parent:t;return e.whenLayerView(r)};function ge(e){const t=e.geometry;if("mesh"===t?.type){const r=e.cloneShallow();return r.attributes=c.clone(e.attributes),r.geometry=t.cloneShallow(),r.geometry.transform=t.transform?.clone()??null,r}return e.clone()}function we(e){for(const t of e){const{destinationGraphic:e,destinationField:r,sourceGraphic:a,sourceField:n}=t;e.setAttribute(r,a.getAttribute(n))}}t.appendAllUtilityNetworkAssociationRelationships=ne,t.avoidFeatureTemplateSelectionWithOnlyOneItem=function(e,t){e.viewModel.syncFeatureTemplates();const r=e.creationInfo;if("awaiting-feature-creation-info"===t[0].id&&r){const a=r.layer,n=e.viewModel.getTemplatesForLayer(a);1===n.length&&"scene"!==a.type&&(r.template=n[0],t.shift())}return t},t.canCreateInteractiveEditSession=function(e){return"createInteractiveEditSession"in e},t.cloneGraphicExceptMesh=ge,t.createLayerIdMap=Y,t.createRelationshipKeyMap=ee,t.createToolFromGeometryType=Q,t.createWorkflowSteps=function(e,t,r){let a=!1;return e.filter(e=>!!a||(a=e===t,a)).map(e=>r[e]())},t.fetchCandidates=async function(e,t,r,a){switch(t.type){case"3d":return async function(e,t,r,a){if(0===e.length)return[];const{updatable:i,graphicsByLayer:o}=await r.defer(async()=>{const{results:n}=await p.whenOrAbort(P.hitTestSelectSimilarDistance(t,r),a),i=new Map;P.filterGraphicHits(n).forEach(({graphic:e})=>(e=>{const t=e.layer,r=i.get(t);if(!r){const e=new Array;return i.set(t,e),e}return r})(e).push(e));const o=e.filter(({capabilities:e,layer:t})=>e.update.enabled&&i.has(t));return 0!==o.length&&r.stopPropagation(),{updatable:o,graphicsByLayer:i}});return p.whenOrAbort(Promise.allSettled(i.map(async({layer:e})=>{const t=o.get(e),r=ce(e);if(t.every(e=>w.featureHasFields(e,r)))return t;const i=[];for(const e of t){i.push(e.getObjectId());const t=Object.keys(e.attributes);n.addMany(r,t)}const s=e.createQuery();return s.returnGeometry=!1,s.objectIds=i,s.outFields=w.fixFields(e.fieldsIndex,r),e.queryFeatures(s,{signal:a}).then(({features:e})=>e)})),a)}(e,t,r,a);case"2d":return async function(e,t,r,a){if(0===e.length)return[];const{mapPoint:n}=r;if(null==n)return[];let i=null;const o=await r.defer(async()=>{const{results:n}=await p.whenOrAbort(t.hitTest(r),a);if(0===n.length)return[];const o=new Set;i=P.filterGraphicHits(n),i.forEach(({graphic:e})=>e&&o.add(e.layer));const s=e.filter(e=>o.has(e.layer)&&e.supportsUpdateWorkflow);return s.length>0&&r.stopPropagation(),s});return p.whenOrAbort(Promise.allSettled(o.map(async({layer:e})=>{const o=e.createQuery();o.returnGeometry=!0,o.outFields=ce(e);const s="renderer"in e?S.calculateTolerance({renderer:e.renderer,pointerType:r.pointerType}):0;o.geometry=G.createQueryGeometry(n,s,t),o.outSpatialReference=t.spatialReference;const{features:l}=await e.queryFeatures(o,{signal:a});return i?.forEach(({graphic:t})=>{t.layer!==e||l.some(e=>e.getObjectId()===t.getObjectId())||l.push(t)}),l})),a)}(e,t,r,a)}},t.fetchFullFeatures=async function(e,t,r,a){const i=t.createQuery();i.objectIds=e.map(e=>e.getObjectId()).filter(n.isSome),i.outFields=["*"],i.returnM=t.capabilities.data.supportsM,i.returnZ=t.capabilities.data.supportsZ,"scene"===t.type&&null!=t.infoFor3D||(i.outSpatialReference=r);const o=await t.queryFeatures(i,{signal:a});return p.throwIfAborted(a),o.features},t.findAllDependencies=te,t.findChangesByGlobalId=ie,t.findLayerInfo=function(e,t){return e?.find(e=>e.layer===t)},t.generateHashForRelationship=re,t.getCreationAttributes=oe,t.getFullTemplateForCreationInfo=async function(t,r){const{template:a}=t;if(null==a)return null;if(m.isSharedTemplate(a))return a.load();if(m.isSharedTemplateOrMetadata(a)){const t=(await new Promise((t,r)=>e(["../../editing/sharedTemplates/SharedTemplate"],e=>t(z(e)),r))).default,n=e=>t.fromJSON(e),i=b.getSharedTemplateProvider(r,{makeSharedTemplateFromJSON:n}),o=await i.getTemplates({templateIds:[a.templateId],featureService:a.featureService});if(0===o.length)throw new s("editor:failed-to-load-template","Unable to load the provided template");return o[0].load()}return a},t.getLayersFromWorkflow=function(e){if(null==e)return[];if(D(e))return e.data.layers;const t=q(e)?e.activeWorkflow:e,r=t?.layer;return r?[r]:[]},t.getRotationVariableAttribute=W,t.getServiceEditsFromWorkflowData=function(e){const t=e.templateExecutorInfo?.completionResults;return t?.length?(t.forEach(e=>we(e.relationships)),t.flatMap(e=>e.edits)):null},t.getServiceInfoForLayer=K,t.getServiceLayersById=async function(e,t){const r=await K(e,t);if(!r)return new Map;const a=new Map;for(const e of r.layersAndTables)d.getOrCreateMapValue(a,e.layerId,()=>[]).push(e);return a},t.getSizeVariableAttribute=B,t.getVisualVariableAttributes=j,t.getVisualVariablesForLayer=R,t.groupFeaturesByLayer=function(e){const t=new Map;for(const r of e){const e=r.sourceLayer,a=v.isSubtypeSublayer(e)?e.parent:e;d.getOrCreateMapValue(t,a,()=>[]).push(r)}return t},t.isBatchAttributeFormViewModel=function(e){return!!e&&"features"in e},t.isCreateFeaturesWorkflow=function(e){return null!=e&&"create-features"===e.type},t.isTerminalUpdateEventType=e=>e.includes("-stop")||e.includes("vertex-"),t.isUpdateFeaturesWorkflow=D,t.isUpdateRecordWorkflow=function(e){return null!=e&&e.type.includes("update-")&&"fullFeature"in e},t.isUpdateWorkflow=q,t.isUtilityNetworkAssociationsTable=ae,t.makeMultipleSourceLayersError=function(){return new s("editing:multiple-layers-not-supported","UpdateFeaturesWorkflow does not support updating features from multiple layers.")},t.orderEditsByRelationshipDependencies=function(e){const{edits:t,serviceInfo:r,view:a,findOriginalFeature:i}=e,o=Y(r.layersAndTables),l=r.layersAndTables.toArray(),{allEditData:c,editDataByLayerIdMap:u,editDataByIdMap:d}=function(e,t,r){const a=new Map,n=[],i=new Map;let o=1;for(const l of e){const e=[],c=t.get(l.id);if(!c)throw new s("featureworkflow",`Failed to prepare applyEdits payload. Layer with id ${l.id} not found.`);for(const t of l.addFeatures??[])e.push({uniqueId:"T"+o++,operationType:"add",layer:c,after:t});for(const t of l.deleteFeatures??[])e.push({uniqueId:"T"+o++,operationType:"delete",before:t,layer:c});for(const t of l.deleteAttachments??[])e.push({uniqueId:"T"+o++,operationType:"deleteAttachment",attachmentId:t,layer:c});for(const t of l.addAttachments??[])e.push({uniqueId:"T"+o++,operationType:"addAttachment",attachment:t,layer:c});for(const t of l.updateFeatures??[])e.push({uniqueId:"T"+o++,operationType:"modify",before:r(t),after:t,layer:c});a.set(c.layerId,e);for(const t of e)n.push(t),i.set(t.uniqueId,t)}return{allEditData:n,editDataByIdMap:i,editDataByLayerIdMap:a}}(t,o,i),p=te(c,ee(l,u),u);if(a&&ne(c,p,a),0===p.length)return t;const f=C.dependencySort(p,{continueOnCircularDependency:!0}).map(e=>d.get(e)).filter(n.isSome),y=new Map;for(const e of f)y.set(e.uniqueId,e);const h=[];for(const e of c)y.has(e.uniqueId)||h.push(e);const m=[];let b=null;for(const e of f){const{layer:t}=e;switch(null==b?b=X(t):b.id!==t.layerId&&(m.push(b),b=X(t)),e.operationType){case"add":case"modify":b.addFeatures.push(e.after);break;case"delete":b.deleteFeatures.push(e.before)}}null!==b&&m.push(b);for(const e of h){const t=e.layer.layerId,r=m.find(e=>e.id===t)??X(e.layer);switch(m.includes(r)||m.push(r),e.operationType){case"add":r.addFeatures.push(e.after);break;case"modify":r.updateFeatures.push(e.after);break;case"delete":r.deleteFeatures.push(e.before);break;case"deleteAttachment":r.deleteAttachments.push(e.attachmentId);break;case"addAttachment":r.addAttachments.push(e.attachment)}}for(const e of m)void 0!==e.deleteAttachments&&0===e.deleteAttachments.length&&delete e.deleteAttachments,void 0!==e.addAttachments&&0===e.addAttachments.length&&delete e.addAttachments;return m},t.prepareAttachmentsForCreateFeaturesWorkflow=function(e){e.filesEnabled=!0,e.mode="view",e.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}},t.setRelationshipFields=we,t.setUpGeometryUpdate=async function({feature:e,featureClone:t,visualVariableAttributes:r,sketchViewModel:a,view:n,onUpdate:i,webStyleCache:o,addUpdatingPromise:s,addHandle:c}){await Z(t,o,"2d"===n.type?n.scale:null);let u=null;if("2d"===a?.view?.type){const e=p.debounce(e=>Z(t,o,e));u=f.watch(()=>a?.view?.scale,t=>e(t))}const d=t.sourceLayer,y=be(n,d);await ue({graphic:t,sketchViewModel:a,sourceLayer:d,visualVariables:r,webStyleCache:o});let h=null;y.then(e=>h=e).catch(()=>{});const m=r.size,b=r.rotation,g=f.watch(()=>e.attributes,async e=>{let r=!1;for(const a in e){const n=e[a];n!==t.getAttribute(a)&&(t.setAttribute(a,n),null==m||m.isUpdatingInteractively||m.field!==a||m.setInitialValue(n),null==b||b.isUpdatingInteractively||b.field!==a||b.setInitialValue(n),(null==h||h.requiredFields.includes(a))&&(r=!0))}r&&await Z(t,o,"2d"===n.type?n.scale:null)}),w=a.on("update",async e=>{const t=e.graphics[0],u={graphic:t,sketchViewModel:a,sourceLayer:d,visualVariables:r,webStyleCache:o};if("complete"===e.state){if(null===n.activeTool)return ue(u);const e=new AbortController,t=l.abortHandle(e);return c(t),s(f.whenOnce(()=>null===n.activeTool,e.signal).then(async()=>{if(!e.signal.aborted)return e.abort(),ue(u)}))}pe(n,t,e,r)&&await Z(t,o,"2d"===n.type?n.scale:null),i(ge(t),e)}),v=a.on(["undo","redo"],e=>{i(ge(e.graphics[0]),e)});return l.handlesGroup([v,w,l.makeHandle(()=>a.cancel()),g,u])},t.setUpSketchCreateWatchers=async function(e){return l.handlesGroup([_(e),$(e)])},t.setVisualVariablesAndElevationInfoForUpdate=de,t.showProgressCursor=function(e){return e.acquireCursor("progress")},t.sizeDefaults=he,t.sizeVariableUnitToLengthUnit=me,t.startCreatingNewFeature=async function(e,t,r){const{creationInfo:a,fullTemplate:n}=t;if(!a)throw new s("featureworkflow","No creation info provided.");const i=a.layer,o=oe(n,a.attributeOverrides),{view:l}=e,c="2d"===l?.type;m.isSharedGroupTemplate(n)||m.isSharedPresetTemplate(n)||await se(e,i,o,r,c?l.scale:null);const{capabilities:u}=i;e.layer.elevationInfo=i.elevationInfo;const d=Q(i.geometryType,n);e.defaultCreateOptions={graphicProperties:{attributes:o,sourceLayer:i},mode:d.createOptions.mode,optionsPerTool:d.createOptions.optionsPerTool,preserveAspectRatio:d.createOptions.preserveAspectRatio,hasZ:u.data.supportsZ,defaultZ:(c?u.editing.zDefault:null)??e.defaultCreateOptions.defaultZ},null==a.geometryToPlace?await e.create(d.tool):await e.place(a.geometryToPlace,{graphicProperties:{attributes:o,sourceLayer:i}})},t.startUpdatingFeatureGeometry=ue,t.swapForEditingSession=async function(e,t,r){const a=e.view;e.layer.add(r);const n=t.sourceLayer,o=t.layer,s=t.getAttribute(o.objectIdField);let c=null;function u(e){c?.abort(),c=i.createTask(async t=>{const r=await be(a,n);p.throwIfAborted(t),r.setVisibility?.(s,e)})}return await ye(a,r),u(!1),l.handlesGroup([fe(a,r,e=>u(!e)),l.makeHandle(async()=>{u(!0);try{if(!a.destroyed){const e=await be(a,n).catch(()=>{});e&&!e.destroyed&&await f.whenOnce(()=>!e.updating)}}finally{e.layer.remove(r)}})])},t.updateGraphicSymbolWhenRequired=Z,t.visualVariableInteractiveUpdate=pe,t.whenEditorLayerView=be,t.whenGraphicDisplayed=ye,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});