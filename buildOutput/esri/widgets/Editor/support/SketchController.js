// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/arrayUtils","../../../core/Error","../../../core/handleUtils","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/SetUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../core/support/UpdatingHandles","../../../layers/GraphicsLayer","../../../views/interactive/sketch/SketchOptions","../workflowUtils","../../Sketch/SketchViewModel"],function(e,t,i,r,a,o,s,n,l,c,p,d,h,u,y,g,_,w){"use strict";const v=Symbol();function b({rotation:e,size:t},i){return{rotation:e?_.getRotationVariableAttribute(e,i.rotation):null,size:t?_.getSizeVariableAttribute(t,i.size):null}}e.SketchController=class extends i{constructor(e){super(e),this.features=[],this.sketchOptions=new g,this.snappingManager=null,this.sourceLayer=null,this.view=null,this.viewModel=null,this._sketchGraphics=new Map,this._sketchLayer=null,this._updatingHandles=new u.UpdatingHandles,this._visualVariableAttributes=new Map,this._visualVariablesForLayer=null,this._webStyleCache=new Map}async initialize(){this._visualVariablesForLayer=_.getVisualVariablesForLayer(this.sourceLayer),this._initializeSketchGraphics(),this._initializeSketchLayer(),await this._updatingHandles.addPromise(this._initializeSketchViewModel())}destroy(){const{_sketchLayer:e,view:t}=this;t?.destroyed||t?.map.remove(e),e.destroy(),this.viewModel.destroy()}get updating(){return this._updatingHandles.updating}async enter(){throw new Error("enter() not implemented")}async exit(){throw new Error("exit() not implemented")}notifyAttributesChanged({features:e,fieldName:t}){const i=this._webStyleCache,r=this.view.scale,a=this._updatingHandles;for(const o of e){const e=this._sketchGraphics.get(o),s=o.getAttribute(t);if(!e||e.getAttribute(t)===s)continue;e.setAttribute(t,s);const n=this._visualVariableAttributes.get(o);null==n?.size||n.size.isUpdatingInteractively||n.size.field!==t||n.size.setInitialValue(s),null==n?.rotation||n.rotation.isUpdatingInteractively||n.rotation.field!==t||n.rotation.setInitialValue(s),a.addPromise(_.updateGraphicSymbolWhenRequired(e,i,r))}}async startUpdatingFeatures(e,t,i){const{_sketchGraphics:a,sourceLayer:s,view:l,viewModel:c,_webStyleCache:p}=this,d=e.map(e=>a.get(e)).filter(r.isSome),h={};this.removeHandles(v),c.complete();let u=null;if(1===e.length){const t=e[0],r=this._visualVariableAttributes.get(t);(r?.rotation||r?.size)&&(await _.setVisualVariablesAndElevationInfoForUpdate({sketchViewModel:c,graphic:d[0],sourceLayer:s,visualVariables:r,webStyleCache:p}),"point"===s.geometryType&&(h.enableRotation=null!=r.rotation,h.enableScaling=null!=r.size,u=async e=>{const a=e.graphics[0];_.visualVariableInteractiveUpdate(l,a,e,r)&&(i?.([{feature:t,attributes:a.attributes}],e),this._updatingHandles.addPromise(_.updateGraphicSymbolWhenRequired(a,p,"2d"===l.type?l.scale:null)))}))}else h.tool="move";const y=()=>c.update(d,h),g=c.on("update",i=>{if("complete"===i.state){if(null===l.activeTool)return void y();const e=new AbortController,t=o.abortHandle(e);return this.addHandles(t,v),void this._updatingHandles.addPromise(n.whenOnce(()=>null===l.activeTool,e.signal).then(async()=>{e.signal.aborted||(e.abort(),await y())}))}const s=e.map(e=>{const t=a.get(e);return t?{feature:e,geometry:t.geometry}:null}).filter(r.isSome);t(s,i),u?.(i)});await y(),this.addHandles(g,v),c.addHandles(g)}_initializeSketchGraphics(){const{features:e,_sketchGraphics:t,sourceLayer:i,_visualVariableAttributes:r}=this,a=this._visualVariablesForLayer,o=a.rotation?.field,s=a.size?.field,n={rotation:o?i.getField(o):null,size:s?i.getField(s):null},l=!(!n.rotation&&!n.size);for(const i of e)t.set(i,i.clone()),l&&r.set(i,b(a,n))}_initializeSketchLayer(){const{view:e}=this,t=new y({elevationInfo:this.sourceLayer.elevationInfo,internal:!0,listMode:"hide",title:"SketchController layer"});this._sketchLayer=t,e.map.add(t),this._updatingHandles.addPromise(e.whenLayerView(t))}async _initializeSketchViewModel(){const{_sketchGraphics:e,view:t,_webStyleCache:i}=this,r=Array.from(e.entries()),a=new w({allowDeleteKey:!1,defaultUpdateOptions:{multipleSelectionEnabled:!1},layer:this._sketchLayer,sketchOptions:this.sketchOptions,snappingManager:this.snappingManager,updateOnGraphicClick:!1,view:this.view});this.viewModel=a;const o=s.debounce(e=>Promise.all(r.map(([,t])=>_.updateGraphicSymbolWhenRequired(t,i,e))));await o("2d"===t.type?t.scale:null),"2d"===t.type&&this.addHandles(n.watch(()=>t.scale,e=>o(e))),this.addHandles(await Promise.all(r.map(([e,t])=>_.swapForEditingSession(a,e,t))))}},t.__decorate([c.property()],e.SketchController.prototype,"features",void 0),t.__decorate([c.property()],e.SketchController.prototype,"sketchOptions",void 0),t.__decorate([c.property()],e.SketchController.prototype,"snappingManager",void 0),t.__decorate([c.property()],e.SketchController.prototype,"sourceLayer",void 0),t.__decorate([c.property()],e.SketchController.prototype,"updating",null),t.__decorate([c.property()],e.SketchController.prototype,"view",void 0),t.__decorate([c.property()],e.SketchController.prototype,"viewModel",void 0),t.__decorate([c.property()],e.SketchController.prototype,"_sketchGraphics",void 0),t.__decorate([c.property()],e.SketchController.prototype,"_sketchLayer",void 0),t.__decorate([c.property()],e.SketchController.prototype,"_visualVariablesForLayer",void 0),e.SketchController=t.__decorate([h.subclass("esri.widgets.Editor.support.SketchController")],e.SketchController),e.createSketchController=function({features:t,sketchOptions:i,snappingManager:r,view:o}){const s=new Set(t.map(e=>e.sourceLayer));if(1!==s.size)throw new a("editor:features-must-belong-to-same-layer","All features must belong to the same layer.");const n=l.first(s);return new e.SketchController({view:o,features:t,sketchOptions:i,snappingManager:r,sourceLayer:n})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});