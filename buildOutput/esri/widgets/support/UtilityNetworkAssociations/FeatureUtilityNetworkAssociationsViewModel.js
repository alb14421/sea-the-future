// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../Graphic","../../../core/Accessor","../../../core/Clonable","../../../core/Collection","../../../core/Identifiable","../../../core/MapUtils","../../../core/promiseUtils","../../../core/ReactiveMap","../../../core/reactiveUtils","../../../core/sql","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/support/featureQueryAll","../../../layers/support/layerUtils","../../../rest/networks/support/NetworkElement","../../../rest/support/FeatureSet","../../../rest/support/Query","../../Feature/FeatureUtilityNetworkAssociations/resources","../../Feature/support/featureUtils","./utils/getFeatureTitle"],function(t,e,o,r,a,s,i,n,c,l,u,d,y,p,h,_,f,b,g,w,A,F,C,m,I){"use strict";return t.default=class extends(a.ClonableMixin(i.IdentifiableMixin(r))){constructor(t){super(t),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.networkSourceIdsInUse=new Set,this.source="popup",this.description=null,this.graphic=null,this.layer=null,this.map=null,this.featureCount=0,this.associationTypes=null,this.showAllEnabled=!1,this.title=null,this.attachmentsFeatureCount=0,this.structureFeatureCount=0,this.contentFeatureCount=0,this.containerFeatureCount=0,this.connectivityFeatureCount=0,this._queryOpenAssociationType=async()=>{this.activeAssociationType&&await this._queryDebounced(this.activeAssociationType)},this._cancelQuery=()=>{const{_queryAbortController:t}=this;t&&t.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:t}=this;t&&t.abort(),this._queryFeatureCountAbortController=null},this._queryController=async t=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await c.ignoreAbortErrors(this._query(t)),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await c.ignoreAbortErrors(this._queryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryDebounced=c.debounce(this._queryController,100),this._queryFeatureCountDebounced=c.debounce(this._queryFeatureCountController,100)}initialize(){this.addHandles([u.watch(()=>[this.graphic,this.layer,this.map,this.associationTypes,this.objectId,this.globalId,this.canQuery],()=>{this.refresh()},u.initial),u.watch(()=>this.activeAssociationType,t=>{this._queryDebounced(t)},u.initial)])}destroy(){this._cancelQuery(),this._cancelQueryFeatureCount(),this._destroyAssociatedFeatureViewModels()}get supportsCacheHint(){return!!this.layer?.capabilities?.query?.supportsCacheHint}get canLoad(){return!!this.map&&!!this.associationTypes&&"string"==typeof this.globalId}get canQuery(){const t=this.layer?.capabilities?.query;return!!this.associationTypes&&"string"==typeof this.globalId&&!!t?.supportsPagination}set displayCount(t){this._set("displayCount",Math.max(t??3,0))}get displayCount(){return this._get("displayCount")}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){const{layer:t}=this;return t?.globalIdField}get activeAssociationType(){return this._get("activeAssociationType")}set activeAssociationType(t){t&&!this.associationTypes.includes(t)||this._set("activeAssociationType",t)}get state(){const{_queryAbortController:t,_queryFeatureCountAbortController:e,_queryPageAbortController:o,canQuery:r,_loaded:a,canLoad:s,source:i}=this;return e||s&&!a?"loading":t||o?"querying":!r||"popup"===i&&0===this.featureCount?"disabled":"ready"}get utilityNetwork(){const{layer:t,map:e}=this;if(!t?.loaded||!e)return null;const o=g.isSubtypeSublayer(t)?t.parent:t;return m.findUtilityNetwork(e,o)}get attachmentsAssociations(){return this._get("attachmentsAssociations")||new s}get structureAssociations(){return this._get("structureAssociations")||new s}get contentAssociations(){return this._get("contentAssociations")||new s}get containerAssociations(){return this._get("containerAssociations")||new s}get connectivityAssociations(){return this._get("connectivityAssociations")||new s}get associationFeatures(){return this._get("associationFeatures")||new l}get associationViewModels(){return this._get("associationViewModels")||new Map}async refresh(){await this._queryFeatureCountDebounced(),await this._queryOpenAssociationType()}getFeatureCountForAssociationType(t){switch(t){case"attachment":return this.attachmentsFeatureCount;case"structure":return this.structureFeatureCount;case"content":return this.contentFeatureCount;case"container":return this.containerFeatureCount;case"connectivity":return this.connectivityFeatureCount}}_destroyAssociatedFeatureViewModels(){this.associationViewModels.forEach(t=>t.destroyAll())}async _loadUtiltyNetworks(){const t=this.map;if(!t)return;await Promise.allSettled(t.utilityNetworks?.map(async t=>{await t.load()})??[]);const e=this.utilityNetwork;if(e){const o=t=>{if("layerId"in t&&e.isUtilityLayer(t)){const o=null!=t.layerId?e.getSourceIdByLayerId(t.layerId):null;null!=o&&this.networkSourceIdsInUse.add(o)}};this._set("networkSourceIdsInUse",new Set),t.allLayers.forEach(o),t.allTables.forEach(o)}}async _findLayersBySourceId(t){const{utilityNetwork:e,map:o}=this,r=t=>{const o=t;return!!t.url&&o.layerId===a&&t.url.replace(/\/\d+$/,"")===e?.featureServiceUrl};await(e?.load());const a=e.getLayerIdBySourceId(t),s=o.allLayers.filter(r),i=o.allTables.filter(r),n=s.concat(i).toArray();return await Promise.allSettled(n.map(t=>t.load())),n}_clearAssociations(){this.attachmentsAssociations.removeAll(),this.structureAssociations.removeAll(),this.contentAssociations.removeAll(),this.containerAssociations.removeAll(),this.connectivityAssociations.removeAll()}_clearFeatures(){this.associationFeatures.forEach(t=>t.removeAll()),this.associationFeatures.clear()}_getAssociationsByType(t){switch(t){case"attachment":return this.attachmentsAssociations;case"structure":return this.structureAssociations;case"connectivity":return this.connectivityAssociations;case"container":return this.containerAssociations;case"content":return this.contentAssociations}}async _queryLayer(t,e,o,r,a){const s=this._getFeatureQueryWhereClause(t,e,o,r),i=new F({where:s,outFields:["*"],cacheHint:this.supportsCacheHint}),n=A.fromJSON(await b.queryAllJSON(t,i,a));return n.features.forEach(e=>{e.layer=e.sourceLayer=g.isSubtypeGroupLayer(t)?t.findSublayerForFeature(e):t}),n.features}async _createAssociationFeatureObjects(t,e,o,r,a,s){if(0===t.length)return[];const i=new Map;for(const[t,o]of e){const e=await this._findLayersBySourceId(t);for(const t of e)(await this._queryLayer(t,o,r,a,s)).forEach(e=>{if("popup"===this.source?e.sourceLayer&&e.getEffectivePopupTemplate():e.sourceLayer){const o=i.get(e.attributes[t.globalIdField])??[];o.push(e),i.set(e.attributes[t.globalIdField],o)}})}const n=[];return await Promise.all(t.toArray().map(async t=>{const{fromNetworkElement:e,toNetworkElement:r}=t,a=e.globalId===o?r:e,s=i.get(a.globalId)??[];await Promise.all(s.map(async e=>{const o=this.utilityNetwork?.getTerminalById(a?.terminalId)?.name,r=e.sourceLayer&&"getFeatureTitle"in e.sourceLayer?await e.sourceLayer.getFeatureTitle(e):I.getFeatureTitle(e);n.push({title:r,feature:e,association:t,terminalName:o})}))})),n}_parseFeatureObjects(t,e){const o=new Map;t.forEach(t=>{const e=t?.feature,r=e.sourceLayer;n.getOrCreateMapValue(o,r,()=>new s).add(t)});for(const[t,r]of o)this._sortFeatureObjectsByTitle(r),e.set(t,r)}_sortFeatureObjectsByTitle(t){t.sort(this._compareByFeatureTitle)}_compareByFeatureTitle(t,e){return t.title.localeCompare(e.title,void 0,{numeric:!0})}async _queryAssociations(t){const{layer:e,globalId:o,associationTypes:r,utilityNetwork:a,canQuery:s}=this;if(await Promise.allSettled([e?.load(),a?.load()]),this._clearAssociations(),!(s&&e&&r&&a&&o))return;const i=g.isSubtypeSublayer(e)?e.parent:e,n=new w({globalId:o,networkSourceId:a.getSourceIdByLayerId(i.layerId)}),c=new Set;r.forEach(t=>{switch(t.type){case"attachment":case"structure":c.add("attachment");break;case"container":case"content":c.add("containment");break;case"connectivity":c.add("connectivity"),c.add("junction-junction-connectivity"),c.add("junction-edge-from-connectivity"),c.add("junction-edge-midspan-connectivity"),c.add("junction-edge-to-connectivity")}});const l=await(a?.queryAssociations({elements:[n],types:Array.from(c)},{signal:t?.signal})),u=new Map,d=new Map;r.forEach(t=>{d.set(t.type,t),u.set(t.type,[])}),l.forEach(t=>{const{toNetworkElement:e,fromNetworkElement:r}=t;switch(t.associationType){case"connectivity":case"junction-junction-connectivity":case"junction-edge-from-connectivity":case"junction-edge-midspan-connectivity":case"junction-edge-to-connectivity":if(r?.globalId===o){if(this._shouldDiscardNetworkElement(e,"connectivity",d))break;u.get("connectivity")?.push(e.globalId)}else{if(this._shouldDiscardNetworkElement(r,"connectivity",d))break;u.get("connectivity")?.push(r.globalId)}this.connectivityAssociations.add(t);break;case"containment":if(r?.globalId===o){if(this._shouldDiscardNetworkElement(e,"content",d))break;u.get("content")?.push(e.globalId),this.contentAssociations.add(t)}else{if(this._shouldDiscardNetworkElement(r,"container",d))break;u.get("container")?.push(r.globalId),this.containerAssociations.add(t)}break;case"attachment":if(r?.globalId===o){if(this._shouldDiscardNetworkElement(e,"attachment",d))break;u.get("attachment")?.push(e.globalId),this.attachmentsAssociations.add(t)}else{if(this._shouldDiscardNetworkElement(r,"structure",d))break;u.get("structure")?.push(r.globalId),this.structureAssociations.add(t)}}});const y=r.map(async e=>{const{associatedNetworkSourceId:o,associatedAssetGroup:r,associatedAssetType:a}=e,s=u.get(e.type),i=null!=r?await this._countAssociatedFeatures(o,s,r,a,t):s.length;switch(e.type){case"attachment":this._set("attachmentsFeatureCount",i);break;case"structure":this._set("structureFeatureCount",i);break;case"content":this._set("contentFeatureCount",i);break;case"container":this._set("containerFeatureCount",i);break;case"connectivity":this._set("connectivityFeatureCount",i)}});await Promise.allSettled(y)}async _countAssociatedFeatureCount(t,e,o,r,a){const s=this._getFeatureQueryWhereClause(t,e,o,r);return t.queryFeatureCount({where:s,outFields:["*"],returnGeometry:!1},{signal:a?.signal})}async _countAssociatedFeatures(t,e,o,r,a){if(0===e.length)return 0;const s=(await this._findLayersBySourceId(t)).map(async t=>this._countAssociatedFeatureCount(t,e,o,r,a));return(await Promise.all(s)).reduce((t,e)=>t+e,0)}async _queryAssociatedFeatures(t,e){const{layer:o,globalId:r,associationTypes:a,utilityNetwork:s,canQuery:i,associationFeatures:n}=this;if(await Promise.allSettled([o?.load(),s?.load()]),!(i&&o&&a&&s))return;const c=this._getAssociationsByType(t.type),{associatedAssetGroup:l,associatedAssetType:u}=t,d=new Map;c.forEach(t=>{const{fromNetworkElement:e,toNetworkElement:o}=t,{networkSourceId:a,elementGlobalId:s}=e.globalId===r?{networkSourceId:o.networkSourceId,elementGlobalId:o.globalId}:{networkSourceId:e.networkSourceId,elementGlobalId:e.globalId},i=d.get(a)||[];i.push(s),d.set(a,i)});const y=await this._createAssociationFeatureObjects(c,d,r,l,u,e);this._parseFeatureObjects(y,n)}async _queryFeatureCount(){await this._loadUtiltyNetworks();const{_queryFeatureCountAbortController:t,canQuery:e}=this;e?(await this._queryAssociations(t),this._set("featureCount",this.attachmentsFeatureCount+this.structureFeatureCount+this.contentFeatureCount+this.containerFeatureCount+this.connectivityFeatureCount)):this._set("featureCount",0)}async _query(t){if(!t)return;await this._loadUtiltyNetworks();const{_queryAbortController:e}=this;this._destroyAssociatedFeatureViewModels(),this._clearFeatures(),0!==this.featureCount&&(this.destroyed||await this._queryAssociatedFeatures(t,{signal:e?.signal}))}_shouldDiscardNetworkElement(t,e,o){if(!t)return!1;const{networkSourceIdsInUse:r}=this,{networkSourceId:a}=t,s=o.get(e)?.associatedNetworkSourceId,i=r.has(a);return null!=s&&s!==a||!i}_getFeatureQueryWhereClause(t,e,o,r){const a=t.globalIdField,s=t.fieldsIndex.get(C.featureUtilityNetworkFields.assetGroup),i=t.fieldsIndex.get(C.featureUtilityNetworkFields.assetType),n=null!=o,c=null!=r;return[a?d.sqlIn(a,e):null,n?`(${s?.name} = ${o})`:null,n&&c?`(${i?.name} = ${r})`:null].filter(Boolean).join(" AND ")}},e.__decorate([y.property()],t.default.prototype,"_loaded",void 0),e.__decorate([y.property()],t.default.prototype,"_queryAbortController",void 0),e.__decorate([y.property()],t.default.prototype,"_queryPageAbortController",void 0),e.__decorate([y.property()],t.default.prototype,"_queryFeatureCountAbortController",void 0),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"supportsCacheHint",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"canLoad",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"canQuery",null),e.__decorate([y.property()],t.default.prototype,"networkSourceIdsInUse",void 0),e.__decorate([y.property({constructOnly:!0})],t.default.prototype,"source",void 0),e.__decorate([y.property()],t.default.prototype,"description",void 0),e.__decorate([y.property({value:3})],t.default.prototype,"displayCount",null),e.__decorate([y.property({type:o})],t.default.prototype,"graphic",void 0),e.__decorate([y.property()],t.default.prototype,"layer",void 0),e.__decorate([y.property()],t.default.prototype,"map",void 0),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"objectId",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"objectIdField",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"globalId",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"globalIdField",null),e.__decorate([y.property()],t.default.prototype,"featureCount",void 0),e.__decorate([y.property()],t.default.prototype,"associationTypes",void 0),e.__decorate([y.property()],t.default.prototype,"activeAssociationType",null),e.__decorate([y.property()],t.default.prototype,"showAllEnabled",void 0),e.__decorate([y.property()],t.default.prototype,"state",null),e.__decorate([y.property()],t.default.prototype,"title",void 0),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"utilityNetwork",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"attachmentsFeatureCount",void 0),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"structureFeatureCount",void 0),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"attachmentsAssociations",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"structureAssociations",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"contentFeatureCount",void 0),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"containerFeatureCount",void 0),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"contentAssociations",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"containerAssociations",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"connectivityFeatureCount",void 0),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"connectivityAssociations",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"associationFeatures",null),e.__decorate([y.property({readOnly:!0})],t.default.prototype,"associationViewModels",null),t.default=e.__decorate([f.subclass("esri.widgets.support.UtilityNetworkAssociations.FeatureUtilityNetworkAssociationsViewModel")],t.default),t.default});