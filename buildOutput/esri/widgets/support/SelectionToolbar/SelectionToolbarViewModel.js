// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../core/deprecate","../../../core/Evented","../../../core/handleUtils","../../../core/Logger","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/support/layerUtils","../../../views/draw/support/layerUtils","../../../views/support/layerViewUtils","../Selector2D/SelectionOperation"],function(e,t,o,r,i,s,a,n,l,c,p,d,u,h,y){"use strict";let v=class extends o.EventedAccessor{constructor(e){super(e),this._operationHandlesGroup=null,this.activeOperation=null,this.continuousSelectionEnabled=!1,this.defaultLassoToolOptions={createTool:"polygon",mode:"hybrid",toolName:"lasso"},this.defaultOperationType="add",this.defaultPointToolOptions={createTool:"point",toolName:"point"},this.defaultRectangleToolOptions={createTool:"rectangle",toolName:"rectangle"},this.layerViewPreferenceEnabled=!0,this.persistSelection=!0,this.selectionManager=null,this.returnFeatureTitleFields=!1,this.returnGeometry=!0,this.selectOnComplete=!0,this.sources=null,this.toolConfigs=[]}initialize(){this.addHandles([a.watch(()=>this.effectiveSources,e=>{this.activeOperation&&(this.activeOperation.sources=e)})])}destroy(){this.activeOperation?.cancel(),this.activeOperation?.destroy(),this._operationHandlesGroup=s.removeMaybe(this._operationHandlesGroup)}get effectiveSelectionManager(){return this.selectionManager??this.view?.selectionManager}get effectiveSources(){const{layerViewPreferenceEnabled:e,sources:t,view:o}=this,r=t??this.effectiveSelectionManager?.sources;if(!r?.length)return[];const i=[];return r.forEach(t=>{if(h.isSelectableLayerView2D(t))i.push(t);else if(d.isKnowledgeGraphLayer(t)||d.isLinkChartLayer(t))(t.layers||[]).forEach(t=>{const r=o?u.findLayerView(o,t):void 0,s=e&&h.isSelectableLayerView2D(r)?r:t;i.push(s)});else if(e){const e=o?u.findLayerView(o,t):void 0,r=h.isSelectableLayerView2D(e)?e:t;i.push(r)}else i.push(t)}),i}get layers(){return t.deprecatedProperty(i.getLogger(this),"layers",{replacement:"Use SelectionToolbar.sources instead."}),this.sources}set layers(e){t.deprecatedProperty(i.getLogger(this),"layers",{replacement:"Use SelectionToolbar.sources instead."}),this.sources=e}get state(){return this.activeOperation?"active":this.view?.ready&&this.effectiveSources.length?"ready":"disabled"}activate(e){const{state:t}=this,o=e?.view||this.view,s=e?.sources||this.effectiveSources;if("disabled"===t||!o)return void i.getLogger(this).warn("Unable to start selection operation.");"active"===t&&this.cancel();const a=new CustomEvent("before-activate",{cancelable:!0,detail:{toolName:e?.toolName??null}});if(this.emit("before-activate",a),a.defaultPrevented)return;const n={type:this.defaultOperationType,persistSelection:this.persistSelection,returnFeatureTitleFields:this.returnFeatureTitleFields,returnGeometry:this.returnGeometry,selectOnComplete:this.selectOnComplete,selectionManager:this.effectiveSelectionManager,...e,sources:s,view:o},l=new y({...n});return this._operationHandlesGroup=r.handlesGroup([l.on("selection-change",e=>this.emit("selection-change",e)),l.once("complete",e=>this._onOperationComplete(e,n))]),this._set("activeOperation",l),l}activateTool(e){this.cancel();const t=this._getToolOptions(e);if(t)return this.activate(t);i.getLogger(this).warn("Unable to activate tool: unable to determine options.")}cancel(){this.activeOperation?.cancel(),this._set("activeOperation",null)}toggleTool(e){const{activeOperation:t}=this;if(t){const o=t.toolName;if(this.cancel(),o===e)return}return this.activateTool(e)}_onOperationComplete(e,t){this._operationHandlesGroup=s.removeMaybe(this._operationHandlesGroup),this.activeOperation?.destroy(),this._set("activeOperation",null),this.emit("complete",e),this.continuousSelectionEnabled&&!e.aborted&&this.activate(t)}_getToolOptions(e){return this.toolConfigs.find(t=>t.toolName===e)||("lasso"===e?this.defaultLassoToolOptions:"point"===e?this.defaultPointToolOptions:"rectangle"===e?this.defaultRectangleToolOptions:void 0)}};return e.__decorate([n.property({readOnly:!0})],v.prototype,"activeOperation",void 0),e.__decorate([n.property()],v.prototype,"continuousSelectionEnabled",void 0),e.__decorate([n.property()],v.prototype,"defaultLassoToolOptions",void 0),e.__decorate([n.property()],v.prototype,"defaultOperationType",void 0),e.__decorate([n.property()],v.prototype,"defaultPointToolOptions",void 0),e.__decorate([n.property()],v.prototype,"defaultRectangleToolOptions",void 0),e.__decorate([n.property()],v.prototype,"effectiveSelectionManager",null),e.__decorate([n.property()],v.prototype,"effectiveSources",null),e.__decorate([n.property()],v.prototype,"layers",null),e.__decorate([n.property()],v.prototype,"layerViewPreferenceEnabled",void 0),e.__decorate([n.property()],v.prototype,"persistSelection",void 0),e.__decorate([n.property()],v.prototype,"selectionManager",void 0),e.__decorate([n.property()],v.prototype,"returnFeatureTitleFields",void 0),e.__decorate([n.property()],v.prototype,"returnGeometry",void 0),e.__decorate([n.property()],v.prototype,"selectOnComplete",void 0),e.__decorate([n.property()],v.prototype,"sources",void 0),e.__decorate([n.property({readOnly:!0})],v.prototype,"state",null),e.__decorate([n.property()],v.prototype,"toolConfigs",void 0),e.__decorate([n.property()],v.prototype,"view",void 0),v=e.__decorate([p.subclass("esri.widgets.support.SelectionToolbar.SelectionToolbarViewModel")],v),v});