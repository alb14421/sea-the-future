// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../core/arrayUtils","../../../core/ReactiveMap","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","./FeatureItem","./ItemBase","../Selector2D/selectorUtils"],function(e,t,r,o,s,a,i,l,c,n){"use strict";let u=class extends c{constructor(e){super(e),this._onChangeController=null,this.featureItems=[],this.featureTitleMap=new r,this.groupLayerItem=null,this.layer=null}get effectiveObjectIds(){return this.objectIds.slice(0,this.maxVisibleFeatureCountPerLayer)}get maxVisibleFeatureCountExceeded(){const{viewModel:e}=this;return this.objectIds.length>e.maxVisibleFeatureCountPerLayer&&this.visibleTotal===e.maxVisibleFeatureCountPerLayer}get maxVisibleFeatureCountPerLayer(){return this.viewModel.maxVisibleFeatureCountPerLayer}get objectIds(){return this.viewModel.effectiveSelectionManager?.getSelection(this.layer)??[]}get total(){return this.objectIds.length}get visible(){return this.featureItems.some(e=>e.visible)}get visibleTotal(){return t.countIf(this.featureItems,e=>e.visible)}cancel(){this._onChangeController?.abort()}reset(){this.featureItems.forEach(e=>e.destroy()),this.featureItems=[]}async sync({controller:e,promises:r}){this.cancel();const o=new Map(this.featureItems.map(e=>[e.objectId,e])),s=new Map,a=[],i=[];for(const e of this.effectiveObjectIds){const t=o.get(e);t?s.set(e,t):(a.push(e),s.set(e,null))}if(this._onChangeController=e,a.length>0){const r=await this._createFeatureItems(a,e);t.addMany(i,r);for(const e of i)null!=e.objectId&&s.set(e.objectId,e)}e.signal.aborted||(this.featureItems=Array.from(s.values()).filter(t.isSome),r.push(this.syncTitles(i)))}async syncTitles(e=this.featureItems){const{layer:t}=this,r=e.map(e=>e.graphic);"getFeatureTitles"in t&&t.getFeatureTitles&&(await t.getFeatureTitles(r,{fetchMissingFields:!0})).forEach((e,t)=>this.featureTitleMap.set(t,e))}async _createFeatureItems(e,t){const{layer:r,layerView:o,viewModel:s}=this,a=new Map;if(o){const r=o.createQuery();r.objectIds=e,r.outFields=["*"],r.returnGeometry=!0;const s=await o.queryFeatures(r,t);for(const e of s.features){const t=e.getObjectId();null!=t&&a.set(t,e)}}if(t.signal.aborted)return[];const i=e.filter(e=>!a.has(e));if(i.length){const{view:e}=this,o=r.createQuery();o.objectIds=i,o.outSpatialReference=e?.spatialReference,o.outFields=e?n.getSuggestedQueryOutFields(r,e,!0):["*"],o.returnGeometry=!0;const s=await r.queryFeatures(o,t);for(const e of s.features){const t=e.getObjectId();null!=t&&a.set(t,e)}}return Array.from(a.values()).map(e=>new l({graphic:e,layer:r,layerItem:this,viewModel:s}))}};return e.__decorate([o.property()],u.prototype,"_onChangeController",void 0),e.__decorate([o.property()],u.prototype,"effectiveObjectIds",null),e.__decorate([o.property()],u.prototype,"featureItems",void 0),e.__decorate([o.property()],u.prototype,"featureTitleMap",void 0),e.__decorate([o.property()],u.prototype,"groupLayerItem",void 0),e.__decorate([o.property()],u.prototype,"layer",void 0),e.__decorate([o.property()],u.prototype,"maxVisibleFeatureCountExceeded",null),e.__decorate([o.property()],u.prototype,"maxVisibleFeatureCountPerLayer",null),e.__decorate([o.property()],u.prototype,"objectIds",null),e.__decorate([o.property()],u.prototype,"total",null),e.__decorate([o.property()],u.prototype,"visible",null),e.__decorate([o.property()],u.prototype,"visibleTotal",null),u=e.__decorate([i.subclass("esri.widgets.support.SelectionList.LayerItem")],u),u});