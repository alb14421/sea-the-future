// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../chunks/tslib.es6","../../core/arrayUtils","../../core/asyncUtils","../../core/maybe","../../core/reactiveUtils","../../core/uid","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/subclass","../Widget","../../chunks/componentsUtils","./globalCss","./LabeledSwitch","./widgetUtils","./decorators/messageBundle","./jsxFactory","./SnappingControls/SnappingControlsViewModel","./SnappingControls/snappingLayerListUtils","./SnappingControls/VisibleElements"],function(e,t,s,i,l,n,a,r,o,d,p,g,c,h,_,b,y,u,m,L,w){"use strict";const v=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),C="esri-snapping-controls",k={base:C,container:`${C}__container`,toggleBlock:`${C}__toggle-block`,layerListBlock:`${C}__layer-list-block`,layerList:`${C}__layer-list`,layerListFilter:`${C}__layer-list__filter`,layerListButton:`${C}__layer-list__button`,layerListItem:`${C}__layer-list__item`,layerListGroup:`${C}__layer-list__group`,nestedContainer:`${C}__nested-container`};let M=class extends g{constructor(e,t){super(e,t),this._defaultViewModel=null,this._layerListFilter=null,this._gridLoadTask=null,this.layerListOpen=!0,this.gridOptionsOpen=!1,this.messages=null,this.messagesCommon=null,this.snappingManager=null,this.visibleElements=new w,this._enableSnappingSwitchChange=e=>{this.snappingOptions.enabled=e},this._featureEnabledSwitchChange=e=>{this.snappingOptions.featureEnabled=e},this._gridEnabledSwitchChange=e=>{this.snappingOptions.gridEnabled=e,e&&this._startLoadGrid()},this._selfEnabledSwitchChange=e=>{this.snappingOptions.selfEnabled=e},this._onToggleLayersButtonClick=e=>{this.viewModel.toggleSnappingForAllLayers(!this.viewModel.allLayersEnabled),b.setFocus(e.target)};const{snappingOptions:s,view:i,viewModel:l}=e;this.viewModel=l??(this._defaultViewModel=new m({snappingOptions:s,view:i}))}normalizeCtorArgs(e){const{snappingOptions:t,view:s,viewModel:i,...l}=e;return l}destroy(){this.viewModel!==this._defaultViewModel&&(this._defaultViewModel=l.destroyMaybe(this._defaultViewModel))}loadDependencies(){return Promise.all([c.loadCalciteComponents({block:()=>new Promise((t,s)=>e(["../../chunks/index13"],t,s)),button:()=>new Promise((t,s)=>e(["../../chunks/index2"],t,s)),input:()=>new Promise((t,s)=>e(["../../chunks/index4"],t,s)),list:()=>new Promise((t,s)=>e(["../../chunks/index16"],t,s)),"list-item":()=>new Promise((t,s)=>e(["../../chunks/index20"],t,s)),checkbox:()=>new Promise((t,s)=>e(["../../chunks/index44"],t,s)),loader:()=>new Promise((t,s)=>e(["../../chunks/index32"],t,s))}),_.loadLabeledSwitchComponents()])}initialize(){this.addHandles(n.watch(()=>"2d"===this.view?.type&&!!this.view.grid,e=>{this.visibleElements.gridControls&&(this.snappingOptions.gridEnabled=e)}))}get _openAndReady(){return this.gridOptionsOpen&&this.snappingOptions.gridEnabled&&this.snappingOptions.enabled}get icon(){return"snap-to-point"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get snappingOptions(){return this.viewModel.snappingOptions}set snappingOptions(e){this.viewModel.snappingOptions=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}set viewModel(e){e!==this._get("viewModel")&&(null!=this._defaultViewModel&&this._defaultViewModel===e||(this._defaultViewModel=l.destroyMaybe(this._defaultViewModel)),this._set("viewModel",e))}render(){const{label:e}=this;return u.tsx("div",{"aria-label":e,class:this.classes(k.base,h.globalCss.widget)},u.tsx("div",{class:k.container},this._renderContent()))}_renderContent(){return[this._renderToggles(),this._renderLayerList(),"2d"===this.view?.type&&this.visibleElements.gridControls?this._renderGridOptions():null]}_renderToggles(){const{visibleElements:e,view:t}=this,i=[e.selfEnabledToggle?this._renderSelfEnabledToggle():null,e.featureEnabledToggle?this._renderFeatureEnabledToggle():null,e.gridEnabledToggle&&"2d"===t?.type?this._renderGridEnabledToggle():null].filter(s.isSome),l=[e.enabledToggle?this._renderEnabledToggle():null,i.length>0?u.tsx("div",{class:k.nestedContainer},i):null].filter(s.isSome);return 0===l.length?null:u.tsx("calcite-block",{class:k.toggleBlock,expanded:!0,heading:e.header?this.label:"",key:"toggle-block",label:this.label},l)}_renderEnabledToggle(){return u.tsx(_.LabeledSwitch,{checked:this.viewModel.snappingOptions.enabled,disabled:this._enabledToggleDisabled,key:`${this.id}__enabled-toggle`,label:this.messages.enableSnapping,onChange:this._enableSnappingSwitchChange})}_renderSelfEnabledToggle(){return u.tsx(_.LabeledSwitch,{checked:this.viewModel.snappingOptions.selfEnabled,disabled:this._secondaryElementsDisabled,key:`${this.id}__self-enabled-toggle`,label:this.messages.geometryGuides,onChange:this._selfEnabledSwitchChange})}_renderFeatureEnabledToggle(){return u.tsx(_.LabeledSwitch,{checked:this.viewModel.snappingOptions.featureEnabled,disabled:this._secondaryElementsDisabled,key:`${this.id}__feature-enabled-toggle`,label:this.messages.featureToFeature,onChange:this._featureEnabledSwitchChange})}_renderGridEnabledToggle(){return u.tsx(_.LabeledSwitch,{checked:this.viewModel.snappingOptions.gridEnabled,disabled:this._secondaryElementsDisabled,key:`${this.id}__grid-enabled-toggle`,label:this.messages.grid,onChange:this._gridEnabledSwitchChange})}_renderLayerList(){if(!this.visibleElements.layerList)return null;const{messages:e,viewModel:t}=this,s=t.layerListViewModel.operationalItems.length>9?u.tsx("calcite-input",{class:k.layerListFilter,clearable:!0,placeholder:e?.searchLayers,onCalciteInputInput:({currentTarget:{value:e}})=>{this._layerListFilter=""===e?null:new RegExp(e,"i")}}):null,i=this._secondaryElementsDisabled,l=this.layerListOpen&&!i,n=t.layerListViewModel.operationalItems?.find(e=>!!e.children.length);return u.tsx("calcite-block",{class:k.layerListBlock,collapsible:!0,disabled:this._secondaryElementsDisabled,expanded:l,heading:e.snappingLayers,key:"list-block",onCalciteBlockToggle:e=>this.layerListOpen=e.currentTarget.expanded},s,this._renderToggleLayersButton(),u.tsx("calcite-list",{class:k.layerList,displayMode:n?"nested":"flat",label:e?.snappingLayers,selectionMode:"none"},this._renderLayerListItemCollection(t.layerListViewModel.operationalItems)))}_renderGridOptions(){const{view:e,visibleElements:t,snappingManager:s,snappingOptions:i,_openAndReady:l}=this,{gridEnabled:n,enabled:a}=i;(l||"2d"===e?.type&&e.grid)&&this._startLoadGrid();const r=this._gridLoadTask?.value,o=r&&"2d"===e?.type&&u.tsx(r,{snappingManager:s,snappingOptions:i,view:e,visibleElements:t.gridControlsElements});return u.tsx("calcite-block",{class:k.layerListBlock,collapsible:!0,disabled:!n||!a,expanded:l,heading:this.messages.gridOptionsHeading,key:"grid-block",onCalciteBlockClose:()=>this.gridOptionsOpen=!1,onCalciteBlockOpen:()=>this.gridOptionsOpen=!0},o??u.tsx("calcite-loader",{label:this.messagesCommon.loading,scale:"s",text:this.messagesCommon.loading}))}_startLoadGrid(){!this._gridLoadTask&&this.visibleElements.gridControls&&"2d"===this.view?.type&&(this._gridLoadTask=i.createTask(async()=>(await new Promise((t,s)=>e(["./GridControls"],e=>t(v(e)),s))).default))}_renderLayerListItemCollection(e){const t=this._layerListFilter;return e.map(e=>{switch(t?L.itemTitleMatchesFilter(e,t):null){case"children":{const s=e.children.filter(e=>!1!==L.itemTitleMatchesFilter(e,t));return this._renderLayerListItemGroup(e,s)}case"self":case null:return this._renderLayerListItemOrGroup(e);case!1:return"self"===L.itemTitleMatchesFilter(e.parent,t)?this._renderLayerListItemOrGroup(e):null}}).toArray().filter(s.isSome)}_renderToggleLayersButton(){if(!this.visibleElements.layerListToggleLayersButton)return null;const{viewModel:{allLayersEnabled:e},messages:t}=this,s=e?t.disableAllLayers:t.enableAllLayers;return u.tsx("calcite-button",{appearance:"transparent",class:k.layerListButton,label:s,name:"layer-toggle",onclick:this._onToggleLayersButtonClick},s)}_renderLayerListItemOrGroup(e){if(e.children.length)return this._renderLayerListItemGroup(e);const{messages:{untitledLayer:t}}=this,s=e.title||t,i=()=>{this.viewModel.toggleSnappingForLayers([e.layer?.id],"enabled"!==e.enabled)};return u.tsx("calcite-list-item",{class:k.layerListItem,key:`${this.id}-list-item-${e.uid}`,label:s,onCalciteListItemSelect:e=>{e.stopPropagation(),i()}},u.tsx("calcite-checkbox",{checked:"enabled"===e.enabled,slot:"actions-start",onCalciteCheckboxChange:i}))}_renderLayerListItemGroup(e,t){const{messages:s}=this,{children:i,title:l}=e,n=l||s.untitledLayer,r=l&&""!==l?l:a.generateUID(),o=!!t?.length,d=t??i,p=()=>{this.viewModel.toggleSnappingForLayers(e.childLayerIds,"enabled"!==e.enabled)},g=d?.find(e=>!!e.children.length);return u.tsx("calcite-list-item",{class:k.layerListGroup,expanded:o,key:r,label:n,onCalciteListItemSelect:e=>{e.stopPropagation(),p()}},u.tsx("calcite-checkbox",{checked:"enabled"===e.enabled,indeterminate:"indeterminate"===e.enabled,slot:"actions-start",onCalciteCheckboxChange:p}),u.tsx("calcite-list",{displayMode:g?"nested":"flat",label:s?.snappingLayers,selectionMode:"none"},this._renderLayerListItemCollection(d)))}get _enabledToggleDisabled(){const e=this.snappingOptions;return e.enabledToggled||e.forceDisabled}get _secondaryElementsDisabled(){return this._enabledToggleDisabled||!this.snappingOptions.enabled}};return t.__decorate([r.property()],M.prototype,"_defaultViewModel",void 0),t.__decorate([r.property()],M.prototype,"_layerListFilter",void 0),t.__decorate([r.property()],M.prototype,"_gridLoadTask",void 0),t.__decorate([r.property()],M.prototype,"_openAndReady",null),t.__decorate([r.property()],M.prototype,"label",null),t.__decorate([r.property({type:Boolean,nonNullable:!0})],M.prototype,"layerListOpen",void 0),t.__decorate([r.property({type:Boolean,nonNullable:!0})],M.prototype,"gridOptionsOpen",void 0),t.__decorate([r.property(),y.messageBundle("esri/widgets/support/SnappingControls/t9n/SnappingControls")],M.prototype,"messages",void 0),t.__decorate([r.property(),y.messageBundle("esri/t9n/common")],M.prototype,"messagesCommon",void 0),t.__decorate([r.property()],M.prototype,"snappingOptions",null),t.__decorate([r.property()],M.prototype,"snappingManager",void 0),t.__decorate([r.property()],M.prototype,"view",null),t.__decorate([r.property()],M.prototype,"viewModel",null),t.__decorate([r.property({type:w,nonNullable:!0})],M.prototype,"visibleElements",void 0),t.__decorate([r.property()],M.prototype,"_enabledToggleDisabled",null),t.__decorate([r.property()],M.prototype,"_secondaryElementsDisabled",null),M=t.__decorate([p.subclass("esri.widgets.support.SnappingControls")],M),M});