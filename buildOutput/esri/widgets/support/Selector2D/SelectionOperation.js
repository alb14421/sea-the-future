// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../../chunks/tslib.es6","../../../core/asyncUtils","../../../core/Collection","../../../core/Evented","../../../core/handleUtils","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/screenUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/support/coordsUtils","../../../views/interactive/keybindings","../../../views/support/automaticLengthMeasurementUtils","./selectorUtils"],function(e,t,o,r,s,i,n,c,a,l,p,d,y,h,u,_,m,v,g,w){"use strict";let f=class extends s.EventedAccessor{constructor(e){super(e),this._completed=!1,this._isConstraintKeyDown=!1,this._processTask=null,this.createTool="rectangle",this.mode=null,this.persistSelection=!0,this.returnFeatureTitleFields=!1,this.returnGeometry=!0,this.selection=new r,this.selectionManager=null,this.selectOnComplete=!0,this.sources=null,this.toolName="",this.type="add",this._process=a.debounce(async(e,t)=>{const{callback:r,selector:s,completed:i}=e,n=o.createTask(async e=>{const{effectiveSelectionManager:t,returnFeatureTitleFields:o,returnGeometry:n,selection:c,sources:a,view:l}=this;if((a?.length||t.sources.length)&&l){if(s&&null!=a){const r=await w.getSelectionFromGeometry({returnFeatureTitleFields:o,returnGeometry:n,selector:s,signal:e,sources:a,view:l});if(c.removeAll(),c.addMany(r),i&&this.persistSelection)switch(this.effectiveType){case"remove":t.updateSelection({current:[],added:[],removed:r});break;case"replace":t.clear(),t.updateSelection({current:r,added:[],removed:[]});break;default:t.updateSelection({current:r,added:[],removed:[]})}}r&&r()}else c.removeAll()});return a.onAbort(t,()=>n.abort()),this._processTask=n,n.promise},100),this._onOperationFinish=this._onOperationFinish.bind(this)}initialize(){this._setup()}get _defaultMode(){return"polygon"===this.createTool?"click":"hybrid"}get _selectionArea(){const e=this._tool.coordinates;if(0===e.length)return;const t=l.createScreenPoint(),o=this.view.spatialReference,r=e=>{t.x=e[0],t.y=e[1];const o=this.view.toMap(t);return[o?.x??0,o?.y??0]};if(1===e.length||e.every(([t,o])=>t===e[0][0]&&o===e[0][1])){const[t,s]=r(e[0]);return new u({x:t,y:s,spatialReference:o})}const s=e.map(r);return 0!==s.length?(m.isClockwise(s)||s.reverse(),new _({spatialReference:o,rings:[s]})):void 0}get completed(){return this._completed}get effectiveSelectionManager(){return this.selectionManager??this.view.selectionManager}get effectiveType(){const e=this.type??"add";if(this._isConstraintKeyDown)switch(e){case"add":return"remove";case"remove":case"replace":return"add";default:return e}return e}get processingFinalSelection(){return!(!this._processTask||!this._tool?.drawOperation?.isCompleted)}cancel(){this.selection.removeAll(),this._onOperationFinish(!0)}destroy(){this._toolImportController=c.abortMaybe(this._toolImportController)}async _setup(){const{createTool:t,view:o}=this;if(await o.whenReady(),this.destroyed||this._toolImportController)return;const r=new AbortController;this._toolImportController=r;const[s,c]=await Promise.all([new Promise((t,o)=>e(["../../../views/draw/DrawScreenTool"],t,o)),g.loadAutomaticLengthMeasurementUtils()]);if(r.signal.aborted)return;const l=Symbol();try{this._tool=new s.DrawScreenTool({view:o,mode:this.mode??this._defaultMode,geometryType:t,cursor:"point"===t?"default":"crosshair",automaticLengthMeasurementUtils:c})}finally{this._toolImportController=null}this._tool?(this.selectOnComplete||this.addHandles(this._tool.on(["cursor-update","vertex-add","vertex-remove"],()=>{this._syncConstraintKeyDown(),a.ignoreAbortErrors(this._process({selector:this._selectionArea}))}),l),this.addHandles([o.on("key-down",e=>{if(!e.repeat)switch(e.key){case v.sketchKeys.constraint:this._tool.uniformSizeToggled=!0,e.stopPropagation();break;case v.sketchKeys.center:this._tool.centeredToggled=!0,e.stopPropagation()}}),o.on("key-up",e=>{switch(e.key){case v.sketchKeys.constraint:this._tool.uniformSizeToggled=!1,e.stopPropagation();break;case v.sketchKeys.center:this._tool.centeredToggled=!1,e.stopPropagation()}}),this.selection.on("change",({added:e,removed:t})=>this.emit("selection-change",{operationType:this.effectiveType,added:e,removed:t})),this._tool.on("complete",async e=>{this._syncConstraintKeyDown(),this.removeHandles(l),e.aborted?this.cancel():(this._tool.cursor="progress",await this._process({selector:this._selectionArea,callback:this._onOperationFinish,completed:!0}))})],l),this.addHandles(i.makeHandle(()=>o.tools.remove(this._tool))),o.addAndActivateTool(this._tool)):n.getLogger(this).warn("Unable to import Draw module. SelectionOperation failed to load.")}_syncConstraintKeyDown(){const{inputManager:e}=this.view;this._isConstraintKeyDown=v.selectionKeys.invertType.some(t=>e.isModifierKeyDown(t))}_onOperationFinish(e=!1){this.removeAllHandles(),this._processTask?.abort(),this.emit("complete",{aborted:e,operationType:this.effectiveType,selection:this.selection.toArray(),toolName:this.toolName}),this._completed=!0}};return t.__decorate([p.property()],f.prototype,"_completed",void 0),t.__decorate([p.property()],f.prototype,"_defaultMode",null),t.__decorate([p.property()],f.prototype,"_isConstraintKeyDown",void 0),t.__decorate([p.property()],f.prototype,"_processTask",void 0),t.__decorate([p.property()],f.prototype,"_selectionArea",null),t.__decorate([p.property()],f.prototype,"completed",null),t.__decorate([p.property({constructOnly:!0})],f.prototype,"createTool",void 0),t.__decorate([p.property()],f.prototype,"effectiveSelectionManager",null),t.__decorate([p.property()],f.prototype,"effectiveType",null),t.__decorate([p.property({constructOnly:!0})],f.prototype,"mode",void 0),t.__decorate([p.property()],f.prototype,"persistSelection",void 0),t.__decorate([p.property()],f.prototype,"processingFinalSelection",null),t.__decorate([p.property()],f.prototype,"returnFeatureTitleFields",void 0),t.__decorate([p.property()],f.prototype,"returnGeometry",void 0),t.__decorate([p.property({readOnly:!0})],f.prototype,"selection",void 0),t.__decorate([p.property({constructOnly:!0})],f.prototype,"selectionManager",void 0),t.__decorate([p.property({constructOnly:!0})],f.prototype,"selectOnComplete",void 0),t.__decorate([p.property()],f.prototype,"sources",void 0),t.__decorate([p.property({constructOnly:!0})],f.prototype,"toolName",void 0),t.__decorate([p.property({constructOnly:!0})],f.prototype,"type",void 0),t.__decorate([p.property({constructOnly:!0})],f.prototype,"view",void 0),f=t.__decorate([h.subclass("esri.widgets.support.Selector2D.SelectionOperation")],f),f});