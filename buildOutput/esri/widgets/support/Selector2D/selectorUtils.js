// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/arrayUtils","../../../core/promiseUtils","../../../layers/support/fieldUtils","../../../layers/support/layerUtils","../../../renderers/support/clickToleranceUtils","../../../views/support/drapedUtils","../../../views/support/layerViewUtils"],function(e,r,t,a,s,i,l,n,o){"use strict";async function c(e){const{candidates:r,layerViews:s,returnGeometry:i,selector:l,signal:n,view:o}=e;"point"!==l.type?await a.whenOrAbort(Promise.allSettled(s.map(async e=>{const a=function(e,r,t,a=!0){const s=e.createQuery();return s.outFields=["*"],s.geometry=y(r,e.layer,t),s.returnGeometry=a,s.outSpatialReference=t.spatialReference,s}(e,l,o,i),s=await e.queryFeatures(a,{signal:n});t.addMany(r,s.features)})),n):await async function({candidates:e,layerViews:r,selector:t,view:a}){const s=a.toScreen(t);if(!s)return;const i=r.map(e=>e.layer),{results:l}=await a.hitTest(s,{include:i});l.forEach(r=>{"graphic"in r&&r.graphic&&e.push(r.graphic)})}({candidates:r,layerViews:s,selector:l,view:o})}async function u(e){const{candidates:r,layers:s,returnFeatureTitleFields:i,returnGeometry:l,selector:n,signal:o,view:c}=e;await a.whenOrAbort(Promise.allSettled(s.map(async e=>{if("isTable"in e&&e.isTable)return;const a=function(e,r,t,a=!1,s=!0){const i=e.createQuery();return i.outFields=d(e,t,a),i.geometry=y(r,e,t),i.returnGeometry=s,i.outSpatialReference=t.spatialReference,i}(e,n,c,i,l),s=await e.queryFeatures(a,{signal:o});t.addMany(r,s.features)})),o)}function y(e,r,t){return"point"===e.type?n.createQueryGeometry(e,"renderer"in r?l.calculateTolerance({renderer:r.renderer}):0,t):e}function d(e,r,t){const{fields:a,fieldsIndex:i}=e,l=new Set([e.objectIdField]);"globalIdField"in e&&null!=e.globalIdField&&i.has(e.globalIdField)&&l.add(i.get(e.globalIdField).name);const n="displayField"in e?e.displayField:null,o=s.getDisplayFieldName({displayField:n,fields:a});if(null!=o&&i.has(o)&&l.add(o),"subtypeField"in e&&null!=e.subtypeField){const t=i.get(e.subtypeField)?.name;if(null!=t&&l.add(t),"utilityNetworks"in r.map&&r.map.utilityNetworks?.length){const e=i.get("assetgroup");e?.name&&l.add(e.name);const r=i.get("assettype");r?.name&&l.add(r.name)}}return(t||r.requiredFieldsOptions.featureTitleFields)&&"featureTitleFields"in e&&e.featureTitleFields&&e.featureTitleFields.forEach(e=>l.add(e)),Array.from(l.values())}async function p(r){const{candidates:t,graphicsLayers:a,selector:s}=r,i=a.flatMap(e=>e.graphics.toArray())??[];if(!i?.length||!s)return;const l=await new Promise((r,t)=>e(["../../../geometry/operators/intersectsOperator"],r,t));l.accelerateGeometry(s),i.forEach(e=>{e.geometry&&"mesh"!==e.geometry.type&&l.execute(s,e.geometry)&&t.push(e)})}r.collectSelectionFromFeatureLayerViews=c,r.collectSelectionFromFeatureLayers=u,r.collectSelectionFromGraphicsLayers=p,r.getSelectionFromGeometry=async function(e){const{returnFeatureTitleFields:r,returnGeometry:t,selector:s,signal:l,sources:n,view:y}=e;if(!n?.length)return[];const{layers:d,layerViews:g,graphicsLayers:m}=function(e){const r=[],t=[],a=[];return e.forEach(e=>{i.isFeatureLayer(e)||i.isSubtypeGroupLayer(e)||i.isSubtypeSublayer(e)?r.push(e):(i.isKnowledgeGraphLayer(e)||i.isLinkChartLayer(e))&&e.layers?.length?r.push(...e.layers.toArray()):i.isMapNotesLayer(e)&&e.sublayers?.length?a.push(...e.sublayers.toArray()):i.isGraphicsLayer(e)?a.push(e):o.isSelectableLayerView2D(e)&&t.push(e)}),{layers:r,layerViews:t,graphicsLayers:a}}(n),f=[];return await a.ignoreAbortErrors(a.whenOrAbort(Promise.all([u({candidates:f,layers:d,returnFeatureTitleFields:r,returnGeometry:t,selector:s,signal:l,view:y}),c({candidates:f,layerViews:g,returnGeometry:t,selector:s,signal:l,view:y}),p({candidates:f,graphicsLayers:m,selector:s})]),l)),f},r.getSuggestedQueryGeometry=y,r.getSuggestedQueryOutFields=d,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});