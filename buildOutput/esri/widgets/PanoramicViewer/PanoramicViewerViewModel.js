// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../chunks/tslib.es6","../../Camera","../../Ground","../../Map","../../request","../../core/Collection","../../core/Error","../../core/Evented","../../core/jsonMap","../../core/mathUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","../../core/support/UpdatingHandles","../../geometry/SpatialReference","../../layers/GraphicsLayer","../../layers/orientedImagery/transformations/utils","../../views/SceneView","../OrientedImageryViewer/utils","./constants","./PanoramicZoomConditions","./PanoramicZoomViewModel","./utils"],function(e,t,i,a,r,o,s,n,h,d,l,c,m,p,g,_,u,y,v,w,M,V,f,R,O,P,H,z,I,S){"use strict";const C=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),b="navigation",F="fov-constraint";let x=class extends h.EventedAccessor{constructor(t){super(t),this._startPosition=null,this._targetPosition=null,this._graphics=new f({elevationInfo:{mode:"relative-to-ground"}}),this._imageGraphic=null,this._loadController=null,this._map=new r({ground:new a({opacity:0,navigationConstraint:null}),layers:new s([this._graphics])}),this._zoomViewModel=null,this.autoLoad=!1,this.clickAction="none",this.imageSize=null,this.imageSource=null,this.navigationManager=null,this.navigationViewModel=null,this.pitch=90,this.state="ready",this.updatingHandles=new M.UpdatingHandles,this.yaw=0,this._addNavigationHandles=()=>{this.imageRenderer.basemapTerrain.suspended=!0,this.imageRenderer.constraints.tilt.max=180,this.removeHandles(b),this.addHandles([this.imageRenderer.on("mouse-wheel",this._handleWheel),this.imageRenderer.on("double-click",this._handleDoubleClick),this.imageRenderer.on("drag",this._handleDrag),this.imageRenderer.on("key-down",e=>{const t=e.key;["+","-","Shift","_","=","ArrowUp","ArrowDown","ArrowRight","ArrowLeft"].includes(t)&&e.stopPropagation()})],b)},this._addHFOVHandles=()=>{this.removeHandles(F),this.addHandles(p.watch(()=>[this.maxHFOV,this.minHFOV],()=>{this._zoomViewModel&&(this._zoomViewModel.panoramicZoomConditions=new z({view:this.imageRenderer,maxFOV:this.maxHFOV,minFOV:this.minHFOV}))},p.syncAndInitial),F)},this._addZoomHandles=()=>{this._zoomViewModel=new I({view:this.imageRenderer,panoramicZoomConditions:new z({maxFOV:this.maxHFOV,minFOV:this.minHFOV})});const e=this.imageRenderer.ui.find("zoom");e&&(e.viewModel=this._zoomViewModel),this._addHFOVHandles()},this._cancelLoadWithController=()=>{this._loadController?.abort(),this._loadController=null},this._handleDoubleClick=e=>{e.stopPropagation(),e.native.ctrlKey?this._zoomOut():this._zoomIn()},this._handleDrag=e=>{e.stopPropagation();const{action:t,x:i,y:a}=e;switch(t){case"start":this._startPosition=this._targetPosition={x:i,y:a};break;case"update":this._targetPosition={x:i,y:a},this._updateCameraHeadingAndTilt()}},this._handleImageClick=e=>{if("image-loaded"===this.state&&this.imageRenderer.ready)switch(this.clickAction){case"emit":e.stopPropagation(),this.emit("click",e);break;case"hittest":e.stopPropagation(),e.defer(async()=>{const t=await this.imageRenderer.hitTest(e.screenPoint,{include:this._graphics});t.results=t.results.filter(e=>"graphic"===e.type&&e.graphic!==this._imageGraphic),this.emit("hittest-response",t)});break;case"pixel-location":{if(e.stopPropagation(),!this.imageSize||!e.mapPoint)return void this.emit("pixel-location",null);const t=R.convertSphereVertexToPixelLocation(e.mapPoint,this.imageSize[0],this.imageSize[1]);this.emit("pixel-location",{...t,spatialReference:V.WebMercator});break}}},this._handleWheel=e=>{const t=e.deltaX??e.native.deltaX;e.stopPropagation(),t>0||e.deltaY>0?this._zoomOut():this._zoomIn()},this._loadNavigationManager=async()=>{if(!this.navigationManager||this.navigationManager?.destroyed){const t=await new Promise((t,i)=>e(["../OrientedImageryViewer/navigation/NavigationManagerPanoramic"],e=>t(C(e)),i)).then(e=>e.default);this.navigationManager=new t({viewModel:this.navigationViewModel})}return this.navigationManager},this._loadWithController=()=>{this._cancelLoadWithController(),this._loadController=new AbortController,this.loadImage(this._loadController)},this._zoomIn=()=>this._zoomViewModel?.zoomIn(),this._zoomOut=()=>this._zoomViewModel?.zoomOut(),this.addGraphic=(e,t)=>"image-loaded"===this.state&&!this._graphics.graphics.includes(e)&&(this._graphics.graphics.add(e,t),!0),this.addManyGraphics=e=>{if("image-loaded"!==this.state)return!1;const t=e.filter(e=>!this._graphics.graphics.includes(e));return this._graphics.graphics.addMany(t),!0},this.clearGraphics=()=>{this._graphics.graphics.removeAll()},this.clearImage=()=>{this.imageSize=null,this._removeImageSphere()},this.navigate=async(e,t)=>this.updatingHandles.addPromise(this.navigateInternal(e,t)),this.navigateInternal=async(e,t)=>{const i=await this._loadNavigationManager();return await i.navigate(e,t)},this.removeGraphic=e=>!("image-loaded"!==this.state||!this._graphics.graphics.includes(e)||(this._graphics.remove(e),0)),this.removeManyGraphics=e=>{if("image-loaded"!==this.state)return!1;const t=e.filter(e=>this._graphics.graphics.includes(e));return this._graphics.removeMany(t),!0},this._imageRenderer=new O({map:this._map,viewingMode:"local",camera:{position:H.defaultImageSphereCenter},environment:{atmosphereEnabled:!1,starsEnabled:!1,lighting:{type:"virtual"}},popupEnabled:!1,spatialReference:V.WebMercator,ui:{components:["zoom"]}})}destroy(){this._imageRenderer.destroy()}initialize(){this.state="initialized",this.addHandles([p.watch(()=>this.imageSource,()=>{this.imageSource&&this.autoLoad&&this._loadWithController()},p.syncAndInitial),p.watch(()=>this.fov,()=>{this._reloadCamera()},p.syncAndInitial),p.watch(()=>this.yaw,e=>{this.camera&&(this.camera.heading=e,this._reloadCamera())},p.syncAndInitial),p.watch(()=>this.pitch,e=>{this.camera&&(this.camera.tilt=e,this._reloadCamera())},p.syncAndInitial),p.when(()=>this.imageRenderer.ready,()=>{this._addNavigationHandles(),this._addZoomHandles()},p.syncAndInitial),p.watch(()=>this.clickAction,e=>{this.removeHandles("image-click-action"),"none"!==e&&this.addHandles(this.imageRenderer.on("click",this._handleImageClick))},p.syncAndInitial)],"default")}get camera(){return this.imageRenderer.destroying||this.imageRenderer.destroyed?null:this.imageRenderer.camera}set camera(e){!e||this.imageRenderer.destroying||this.imageRenderer.destroyed||(this.imageRenderer.camera=e.clone())}get fov(){return this.camera?.fov}set fov(e){Number.isFinite(e)&&this._zoomViewModel?.zoomTo(e)}get hfov(){if(!this.camera||!this.imageRenderer?.ready)return null;const{fov:e}=this.camera,{size:[t,i]}=this.imageRenderer,a=t/i,r=Math.atan(a);return 2*l.rad2deg(Math.atan(Math.tan(l.deg2rad(e/2))*Math.sin(r)))}get imageRenderer(){return this._imageRenderer}get maxHFOV(){const{size:[e,t]}=this.imageRenderer;return this.imageRenderer.ready?S.findDiagonalFOV(H.maxPanoramicViewerHFOV,e/t):H.maxPanoramicViewerHFOV}get minHFOV(){const{size:[e,t]}=this.imageRenderer;return this.imageRenderer.ready?S.findDiagonalFOV(H.minPanoramicViewerHFOV,e/t):H.minPanoramicViewerHFOV}get updating(){return this.updatingHandles.updating}get vfov(){if(!this.camera||!this.imageRenderer?.ready)return null;const{fov:e}=this.camera,{size:[t,i]}=this.imageRenderer,a=t/i,r=Math.atan(a);return 2*l.rad2deg(Math.atan(Math.tan(l.deg2rad(e/2))*Math.cos(r)))}async _loadImageInternal(e,t){let i;this.state="image-loading";try{i=(await o(e,{responseType:"image",...t})).data}catch(e){throw m.isAbortError(e)?this.state="image-load-aborted":this.state="image-load-error",e}return this._updateImageSphere(i,t)}_reloadCamera(){this.camera=this.camera?.clone()}_removeImageSphere(){this._imageGraphic&&(this._graphics.remove(this._imageGraphic),this._imageGraphic=c.destroyMaybe(this._imageGraphic)),this.state="ready",this.imageSize=null}_updateCameraHeadingAndTilt(){if(!this._startPosition||!this._targetPosition||!this.camera)return;const e=this.camera.heading+(this._startPosition.x-this._targetPosition.x)/this.imageRenderer.width*this.camera.fov;this.yaw=(e+360)%360;const t=this.camera.tilt-(this._startPosition.y-this._targetPosition.y)/this.imageRenderer.height*this.imageRenderer.camera.tilt;this.pitch=Math.min(179.5,Math.max(.5,t)),this._startPosition=this._targetPosition}async _updateImageSphere(e,t){return await m.waitTick(t),this._imageGraphic=S.meshToGraphic(S.createImageSphere(e)),this._graphics.add(this._imageGraphic),this.state="image-loaded",p.whenOnce(()=>this.imageRenderer.ready,t).then(()=>{const{size:[e,t]}=this.imageRenderer;this.fov=S.findDiagonalFOV(H.humanBinocularHFOV,e/t)}),this.imageSize=[e.width,e.height],this._imageGraphic.geometry}async loadImage(e){return this._removeImageSphere(),this.imageSource?this._loadImageInternal(this.imageSource,e):P.logAndThrow(this.declaredClass,new n(P.getMissingPropertyErrorName("panoramic-viewer"),P.getMissingPropertyErrorMessage("PanoramicViewerViewModel","imageSource")))}};return t.__decorate([g.property()],x.prototype,"_graphics",void 0),t.__decorate([g.property()],x.prototype,"_imageGraphic",void 0),t.__decorate([g.property()],x.prototype,"_imageRenderer",void 0),t.__decorate([g.property()],x.prototype,"_loadController",void 0),t.__decorate([g.property()],x.prototype,"_map",void 0),t.__decorate([g.property()],x.prototype,"_zoomViewModel",void 0),t.__decorate([g.property({type:Boolean})],x.prototype,"autoLoad",void 0),t.__decorate([g.property({type:i})],x.prototype,"camera",null),t.__decorate([v.enumeration(new d.JSONMap({emit:"emit",hittest:"hittest",none:"none","pixel-location":"pixel-location"}))],x.prototype,"clickAction",void 0),t.__decorate([g.property({type:Number})],x.prototype,"fov",null),t.__decorate([g.property({readOnly:!0})],x.prototype,"hfov",null),t.__decorate([g.property({readOnly:!0})],x.prototype,"imageRenderer",null),t.__decorate([g.property()],x.prototype,"imageSize",void 0),t.__decorate([g.property()],x.prototype,"imageSource",void 0),t.__decorate([g.property({readOnly:!0})],x.prototype,"maxHFOV",null),t.__decorate([g.property({readOnly:!0})],x.prototype,"minHFOV",null),t.__decorate([g.property()],x.prototype,"navigationViewModel",void 0),t.__decorate([g.property({type:Number})],x.prototype,"pitch",void 0),t.__decorate([g.property()],x.prototype,"state",void 0),t.__decorate([g.property()],x.prototype,"updatingHandles",void 0),t.__decorate([g.property()],x.prototype,"updating",null),t.__decorate([g.property({readOnly:!0})],x.prototype,"vfov",null),t.__decorate([g.property({type:Number})],x.prototype,"yaw",void 0),x=t.__decorate([w.subclass("esri.widgets.PanoramicViewer.PanoramicViewerViewModel")],x),x});