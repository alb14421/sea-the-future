// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../chunks/tslib.es6","../intl","../core/arrayUtils","../core/has","../core/Logger","../core/promiseUtils","../core/ReactiveMap","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/subclass","../layers/support/fieldUtils","../layers/support/layerUtils","../support/guards","./Widget","./Editor/components/Prompt","./Feature/support/featureUtils","./FeatureForm/css","./FeatureForm/featureFormUtils","./FeatureForm/FeatureFormViewModel","./FeatureForm/VisibleElements","../chunks/componentsUtils","./support/dateUtils","./support/globalCss","./support/Heading","./support/widgetUtils","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory","../intl/substitute","../intl/number"],function(e,t,i,s,n,a,o,r,l,d,u,p,c,m,h,_,v,g,y,b,C,f,F,w,x,I,k,R,O,N,M){"use strict";const L=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),T="data-field-name";let D=class extends h{constructor(e,t){super(e,t),this._associationsWidgetsMap=new r,this._attemptFocusOnNextRender=!1,this._dateComponentMap=new Map,this._inputsWithChanges=new Set,this._focusedFieldName=null,this._pendingSubtypeChoice=null,this._listObserverNode=null,this._listObserver=new IntersectionObserver(e=>{e.length&&e[0].isIntersecting&&this._incrementRelatedRecordPage()},{root:window.document}),this._prompt=null,this._featureFormUNAssociationList=null,this.groupDisplay="all",this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.messagesFeature=null,this.messagesTemplates=null,this.viewModel=new b,this.visibleElements=new C,this._onShowAllRelatedRecordsClick=e=>{const{feature:t,callbacks:i}=this;t&&i?.showAllRelatedRecords&&i.showAllRelatedRecords({parentFeature:t,relationshipId:e})},this._onAddRelatedRecordsClick=(e,t,i)=>{const{feature:s,callbacks:n}=this;let a=i;if(s&&n?.addRelatedRecord){if(c.isSubtypeGroupLayer(i)&&e.activeCategory){const t=e.activeCategory.value,s=i.findSublayerForSubtypeCode(t);s&&v.isRelatableFeatureSupportedLayer(s)&&(a=s)}n.addRelatedRecord({parentFeature:s,relatedLayer:a,relationshipId:t})}},this._onFormKeyDown=this._onFormKeyDown.bind(this),this._onFormSubmit=this._onFormSubmit.bind(this),this._onGroupToggle=this._onGroupToggle.bind(this),this._onComponentBlur=this._onComponentBlur.bind(this),this._onComponentFocus=this._onComponentFocus.bind(this),this._onComponentKeyDown=this._onComponentKeyDown.bind(this),this._afterComponentCreate=this._afterComponentCreate.bind(this),this._afterComponentCreateOrUpdate=this._afterComponentCreateOrUpdate.bind(this),this._afterDateComponentCreate=this._afterDateComponentCreate.bind(this),this._afterDateComponentCreateOrUpdate=this._afterDateComponentCreateOrUpdate.bind(this),this._afterRadioGroupCreateOrUpdate=this._afterRadioGroupCreateOrUpdate.bind(this),this._afterGroupCreate=this._afterGroupCreate.bind(this)}initialize(){this.addHandles([l.watch(()=>this.feature,()=>{this._inputsWithChanges.clear(),this._dateComponentMap.clear(),l.whenOnce(()=>!this.viewModel.updating).then(()=>{const e=this._getFocusableInput("forward");this._syncGroupInputStates(),this._focusedFieldName=e?.name||null,this._attemptFocusOnNextRender=!0})}),l.watch(()=>[this._featureFormUNAssociationList,this.visibleElements.associationDetails],([e,t])=>{e&&(e.visibleElements.associationDetails=t)},l.initial),l.watch(()=>this.groupDisplay,()=>this._syncGroupInputStates()),this.on("submit",e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach(e=>this._inputsWithChanges.add(e)),this._focusedFieldName=t,this._attemptFocusOnNextRender=!0,this.scheduleRender()}}),l.watch(()=>[this.viewModel.activeRelationshipInput,this._listObserverNode],()=>this._onObserverChange()),l.watch(()=>this.viewModel.activeAssociationInput,e=>{e&&this._featureFormUNAssociationList&&(this._featureFormUNAssociationList.associationInput=e,this._featureFormUNAssociationList.viewModel=e.viewModel)}),l.watch(()=>this.viewModel.inputs.filter(y.isUtilityNetworkAssociationInput),async e=>{this._featureFormUNAssociationList||await this._setUpUtilityNetworkAssociationList();for(const t of e)this._associationsWidgetsMap.has(t)||this._associationsWidgetsMap.set(t,await this._makeAssociationsWidget(t))})])}loadDependencies(){return f.loadCalciteComponents({block:()=>new Promise((t,i)=>e(["../chunks/index13"],t,i)),button:()=>new Promise((t,i)=>e(["../chunks/index2"],t,i)),chip:()=>new Promise((t,i)=>e(["../chunks/index11"],t,i)),combobox:()=>new Promise((t,i)=>e(["../chunks/index21"],t,i)),"combobox-item":()=>new Promise((t,i)=>e(["../chunks/index22"],t,i)),"combobox-item-group":()=>new Promise((t,i)=>e(["../chunks/index23"],t,i)),icon:()=>new Promise((t,i)=>e(["../chunks/index7"],t,i)),input:()=>new Promise((t,i)=>e(["../chunks/index4"],t,i)),"input-date-picker":()=>new Promise((t,i)=>e(["../chunks/index27"],t,i)),"input-message":()=>new Promise((t,i)=>e(["../chunks/index31"],t,i)),"input-number":()=>new Promise((t,i)=>e(["../chunks/index28"],t,i)),"input-time-picker":()=>new Promise((t,i)=>e(["../chunks/index29"],t,i)),"input-time-zone":()=>new Promise((t,i)=>e(["../chunks/index30"],t,i)),label:()=>new Promise((t,i)=>e(["../chunks/index5"],t,i)),list:()=>new Promise((t,i)=>e(["../chunks/index16"],t,i)),"list-item":()=>new Promise((t,i)=>e(["../chunks/index20"],t,i)),loader:()=>new Promise((t,i)=>e(["../chunks/index32"],t,i)),notice:()=>new Promise((t,i)=>e(["../chunks/index6"],t,i)),"radio-button":()=>new Promise((t,i)=>e(["../chunks/index35"],t,i)),"radio-button-group":()=>new Promise((t,i)=>e(["../chunks/index36"],t,i)),switch:()=>new Promise((t,i)=>e(["../chunks/index33"],t,i)),"text-area":()=>new Promise((t,i)=>e(["../chunks/index34"],t,i))})}destroy(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode)}get _relatedRecordsEnabled(){const{callbacks:e}=this;return!(!e||!(e.addRelatedRecord||e.editRelatedRecord||e.showAllRelatedRecords))}get _utilityNetworkAssociationsEnabled(){const{callbacks:e}=this;return!(!e?.viewAssociatedLayers||!e.viewAssociatedFeatures)}get _subtypes(){return c.getSubtypesFromLayer(this.layer)}get associationId(){return this.viewModel.associationId}set associationId(e){this.viewModel.associationId=e}get associatedLayer(){return this.viewModel.associatedLayer}set associatedLayer(e){this.viewModel.associatedLayer=e}get disabled(){return this.viewModel.disabled}set disabled(e){this.viewModel.disabled=e}get feature(){return this.viewModel.feature}set feature(e){this.viewModel.feature=e}get formTemplate(){return this.viewModel.formTemplate}set formTemplate(e){this.viewModel.formTemplate=e}get icon(){return"form-field"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get callbacks(){return this.viewModel.callbacks}set callbacks(e){this.viewModel.callbacks=e}get relationshipId(){return this.viewModel.relationshipId}set relationshipId(e){this.viewModel.relationshipId=e}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(e){this.viewModel.spatialReference=e}get strict(){return this.viewModel.strict}set strict(e){this.viewModel.strict=e}get timeZone(){return this.viewModel.timeZone}set timeZone(e){this.viewModel.timeZone=e}get showPrompt(){return e=>{this._prompt?.cancel?.(),this._prompt=e}}set showPrompt(e){this._overrideIfSome("showPrompt",e)}get clearPrompt(){return()=>this._prompt=null}set clearPrompt(e){this._overrideIfSome("clearPrompt",e)}getValues(){return this.viewModel.getValues()}submit(){return this.viewModel.submit()}render(){const{state:e}=this.viewModel;return O.tsx("div",{class:this.classes(g.css.base,w.globalCss.widget,w.globalCss.panel)},"ready"===e?this._renderForm():null)}_renderForm(){return O.tsx("div",null,O.tsx("form",{class:g.css.form,inert:!!this._prompt,novalidate:!0,onkeydown:this._onFormKeyDown,onsubmit:this._onFormSubmit},this._renderReadOnlyNotice(),this._renderHeader(),this._renderContent()),this._prompt?O.tsx(_.Prompt,{...this._prompt,headingLevel:this.headingLevel}):void 0)}_renderReadOnlyNotice(){const{disabled:e,messages:t}=this;if(e&&this.visibleElements.readOnlyNotice)return O.tsx("calcite-notice",{class:g.css.disabledNotice,icon:"read-only-non-editable",kind:"brand",open:!0,scale:"s",width:"full"},O.tsx("div",{slot:"message"},t.disabledForm))}_renderHeader(){const e=this.viewModel,{formTitle:t,formDescription:i}=e;if(!e.formHeaderVisible)return;const s=null!=t&&O.tsx(x.Heading,{key:"title",level:this.headingLevel},t),n=null!=i&&O.tsx("p",{class:g.css.description,key:"description"},i);return O.tsx("div",{class:g.css.formHeader},s,n)}_renderContent(){const{viewModel:e}=this;return e.activeRelationshipInput?this._renderRelationshipInput(e.activeRelationshipInput):e.activeAssociationInput?this._renderFeatureFormUtilityNetworkAssociationList():e.inputs.filter(s.isSome).filter(e=>e.visible).map(e=>this._renderInput(e))}_renderInput(e){return y.isGroupInput(e)?this._renderGroup(e):y.isFieldInput(e)?this._renderLabeledField(e):y.isRelationshipInput(e)?this._renderRelationshipInput(e):y.isTextElementInput(e)?this._renderTextElementInput(e):y.isUtilityNetworkAssociationInput(e)?this._renderUtilityNetworkAssociationsElementInput(e):void 0}_renderFeatureFormUtilityNetworkAssociationList(){return this._featureFormUNAssociationList?.render()}_selectAssociatedLayer(e){const{feature:t,callbacks:i}=this;t&&i?.viewAssociatedFeatures&&i.viewAssociatedFeatures({associatedLayer:e.layer})}async _selectAssociatedFeature(e){const{feature:t,callbacks:i}=this;t&&i?.selectAssociatedFeature&&await i.selectAssociatedFeature({parentFeature:t,...e})}_onAddAssociation(e){const{feature:t,callbacks:i}=this;t&&i?.addAssociation&&i.addAssociation(e)}async _setUpUtilityNetworkAssociationList(){if(!this._featureFormUNAssociationList){const t=(await new Promise((t,i)=>e(["./FeatureForm/FeatureFormUtilityNetworkAssociations/FeatureFormUtilityNetworkAssociationList"],e=>t(L(e)),i))).default;this._featureFormUNAssociationList=new t({onSelectLayer:this._selectAssociatedLayer.bind(this),onSelectFeature:this._selectAssociatedFeature.bind(this),onAddAssociation:this._onAddAssociation.bind(this)})}}async _makeAssociationsWidget(t){return new(0,(await new Promise((t,i)=>e(["./Feature/FeatureUtilityNetworkAssociations"],e=>t(L(e)),i))).default)({onSelectAssociationType:({viewModel:e,listType:i})=>{e.activeAssociationType=i;const{feature:s,callbacks:n}=this;s&&n?.viewAssociatedLayers&&n.viewAssociatedLayers({associationId:t.uid})},viewModel:t.associationsViewModel})}_renderUtilityNetworkAssociationsElementInput(e){if(this._utilityNetworkAssociationsEnabled)return this._associationsWidgetsMap.get(e)?.render()}_renderDescriptionOrEmpty(e,t){return null==e?null:O.tsx("div",{class:this.classes(g.css.description),id:t},e)}_renderGroup(e){const{formTemplate:t,headingLevel:i}=this,{description:s,id:n,inputs:a,label:o,open:r}=e,l=a.filter(e=>e.visible),d=this.viewModel.findField(this._focusedFieldName),u=d?.group===e,p="sequential"===this.groupDisplay;return O.tsx("calcite-block",{afterCreate:this._afterGroupCreate,class:this.classes(g.css.group,p?g.css.groupSequential:null,u?g.css.groupActive:null),collapsible:!0,"data-group":e,description:s||void 0,expanded:r,heading:o??"",headingLevel:t?.title?x.incrementHeadingLevel(i):i,id:n,key:n,onCalciteBlockToggle:({currentTarget:t})=>this._onGroupToggle(t,e)},l.map(e=>this._renderInput(e)))}_getFocusableInput(e,t){const i=y.flattenInputs(this.viewModel.inputs);let s;if("backward"===e&&i.reverse(),t)if(y.isGroupInput(t)){const e=t.inputs.find(e=>e.visible);s=e?i.indexOf(e):0}else{let n;if(y.isInputInGroupInput(t)&&!t.group.open){const i=t.group.inputs.filter(y.isFieldInput);n="forward"===e?i[i.length-1]:i[0]}else n=t;s=i.indexOf(n)+1}else s=0;for(let e=s;e<i.length;e++){const t=i[e];if(t.visible&&y.isFieldInput(t)){if(this.disabled&&t.inputType&&("switch"===t.inputType||"radio-buttons"===t.inputType))continue;return t}}return null}_renderLabeledField(e){const{dataType:t,feature:i,label:s,layer:n,required:a}=e,o={"aria-label":a?N.substitute(this.messages.requiredFieldLabel,{name:s}):s,class:g.css.label,key:`${n.id}-${i.uid}-${e.name}`},r=[O.tsx("div",{class:g.css.labelTextContent,key:"labelTextContainer"},s,a?O.tsx("span",{"aria-hidden":"true",title:this.messagesCommon.required},"*"):void 0),"unsupported"!==t?this._renderFieldInput(e):this._renderReadOnlyComponent(e),this._renderAuxiliaryText(e)];return"date"===t&&"coded-value"!==e.domain?.type?O.tsx("label",{...o},r):O.tsx("calcite-label",{...o},r)}_renderFieldInput(e){const{dataType:t,domain:i,inputType:s,name:n}=e,a=this.getCommonInputProps(e);if("coded-value"===i?.type){const t=this.viewModel.getFieldValueOptionsForField(n,this.messages.empty);return"switch"!==s||e.hasInvalidSwitchValue?"radio-buttons"===s?this._renderRadioButtonComponents(e,t.flat(),a):this._renderComboBoxComponent(e,t,a):this._renderSwitchComponent(e,a)}return"datetime-picker"===s||"date"===t?this._renderDateComponents(e,a):"number"===t?this._renderNumberComponent(e,a):this._renderStringComponent(e,a)}_renderStringComponent(e,t){return"text-area"===e.inputType?t.readOnly?O.tsx("calcite-input",{...t,loading:e.updating,type:"textarea",onCalciteInputInput:e=>this._saveValueFromComponent(e.currentTarget)}):O.tsx("calcite-text-area",{...t,resize:"vertical",onCalciteTextAreaInput:e=>this._saveValueFromComponent(e.currentTarget)}):O.tsx("calcite-input",{...t,loading:e.updating,type:"text",onCalciteInputInput:e=>this._saveValueFromComponent(e.currentTarget)})}_renderNumberComponent(e,t){const i=p.isIntegerField(e.field),s=i&&""!==t.value?Math.round(parseFloat(t.value)).toString():t.value;return O.tsx("calcite-input-number",{...t,integer:i,loading:e.updating,type:"number",value:s,onCalciteInputNumberInput:e=>this._saveValueFromComponent(e.currentTarget)})}_renderDateComponents(e,t){const{field:i}=e;switch(i.type){case"date":return this._renderDateFieldComponents(e,t);case"date-only":return this._renderDateOnlyFieldComponent(e,t);case"time-only":return this._renderTimeOnlyFieldComponent(e,t);case"timestamp-offset":return this._renderTimestampOffsetFieldComponents(e,t);default:return this._renderReadOnlyComponent(e,F.getLabelForDateFieldValue(i,t.value,{timeZone:this.timeZone,...F.getIntlOptionsForField(i)}))}}_renderDateOnlyFieldComponent(e,t){const{range:i,valid:s,value:n}=e,{class:a,key:o,readOnly:r}=t,{rawMax:l,rawMin:d}=i;return O.tsx("calcite-input-date-picker",{afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!s,class:a,"data-date-part":"date","data-field-name":t[T],key:`${o}-date-input`,max:m.isString(l)?l:void 0,min:m.isString(d)?d:void 0,numberingSystem:F.numberingSystem,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},onfocus:this._onComponentFocus,overlayPositioning:"fixed",readOnly:r,value:null!=n?`${n}`:void 0,onCalciteInputDatePickerChange:e=>this._saveValueFromDateComponent(e.currentTarget)})}_renderTimeOnlyFieldComponent(e,t){const{valid:i,value:s}=e,{class:n,key:a,readOnly:o}=t;return O.tsx("calcite-input-time-picker",{afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!i,class:n,"data-date-part":"time","data-field-name":t[T],key:`${a}-time-input`,numberingSystem:F.numberingSystem,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},onfocus:this._onComponentFocus,overlayPositioning:"fixed",readOnly:o,step:e.timeStep,value:null!=s?`${s}`:void 0,onCalciteInputTimePickerChange:e=>this._saveValueFromDateComponent(e.currentTarget)})}_renderTimestampOffsetFieldComponents(e,t){const{name:i,range:s,timeZone:n,valid:a,value:o}=e,{class:r,key:l,readOnly:d}=t,{rawMax:u,rawMin:p}=s,c={afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!a,numberingSystem:F.numberingSystem,overlayPositioning:"fixed",readOnly:d,[T]:i,onfocus:this._onComponentFocus},m=F.prepareISOFieldValueForDateComponents(u,n),h=F.prepareISOFieldValueForDateComponents(p,n),_=F.prepareISOFieldValueForDateComponents(o,n);return O.tsx("div",{class:g.css.dateInputContainer,key:`${l}-date-time-container`},O.tsx("calcite-input-date-picker",{...c,class:r,"data-date-part":"date",key:`${l}-date-input`,max:m?.date??void 0,min:h?.date??void 0,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},value:_.date??void 0,onCalciteInputDatePickerChange:e=>this._saveValueFromDateComponent(e.currentTarget)}),O.tsx("calcite-input-time-picker",{...c,class:r,"data-date-part":"time",key:`${l}-time-input`,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},step:e.timeStep,value:_.time??void 0,onCalciteInputTimePickerChange:e=>this._saveValueFromDateComponent(e.currentTarget)}),e.includeTimeOffset?O.tsx("calcite-input-time-zone",{...c,class:r,"data-date-part":"timeZone",disabled:d,key:`${l}-timezone-input`,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},value:_.timeZoneOffset??"0",onCalciteInputTimeZoneChange:e=>this._saveValueFromDateComponent(e.currentTarget)}):null)}_renderDateFieldComponents(e,t){const{includeTime:i,name:s,valid:n,value:a}=e,{class:o,key:r,max:l,min:d,readOnly:u}=t,{timeZone:p}=this,c={afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!n,numberingSystem:F.numberingSystem,overlayPositioning:"fixed",readOnly:u,[T]:s,onfocus:this._onComponentFocus},m=F.prepareUnixFieldValueForDateComponents(a,p),h=F.prepareUnixFieldValueForDateComponents(l,p),_=F.prepareUnixFieldValueForDateComponents(d,p);return O.tsx("div",{class:g.css.dateInputContainer,key:`${r}-date-time-container`},O.tsx("calcite-input-date-picker",{...c,class:o,"data-date-part":"date",key:`${r}-date-input`,max:h?.date??void 0,min:_?.date??void 0,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},value:m.date??void 0,onCalciteInputDatePickerChange:e=>this._saveValueFromDateComponent(e.currentTarget)}),i?O.tsx("calcite-input-time-picker",{...c,class:o,"data-date-part":"time",key:`${r}-time-input`,onblur:e=>{this._focusedFieldName=null,this._saveValueFromDateComponent(e.target)},step:1,value:m.time??void 0,onCalciteInputTimePickerChange:e=>this._saveValueFromDateComponent(e.currentTarget)}):null)}_renderReadOnlyComponent(e,t){const i=this.getCommonInputProps(e);return O.tsx("calcite-input",{...i,class:this.classes(g.css.fieldInput,g.css.inputDisabled),readOnly:!0,type:"text",value:null!=t?`${t}`:i.value})}_renderComboBoxComponent(e,t,i){const{value:s,name:n}=e,{viewModel:a,_inputsWithChanges:o}=this,r="INSERT"===a.editType,l=o.has(n),d=null==s&&(!r||l),u=r&&e.showNoValueOptionEnabled&&!l?()=>{}:i.onblur;return O.tsx("calcite-combobox",{...i,allowCustomValues:!1,clearDisabled:!0,onblur:u,overlayPositioning:"fixed",selectionMode:"single",onCalciteComboboxChange:({currentTarget:t})=>{d&&0===t.selectedItems.length?this._ignoreDeselectionOfNoValueOption(t):e.isSubtypeField&&0===t.selectedItems.length?t.value=`${e.value}`:this._saveValueFromComponent(t)}},this.renderComboboxOptionsList(e,t))}renderComboboxOptionsList(e,t){const{value:i,name:s}=e,{messages:n,messagesTemplates:a,viewModel:o,_inputsWithChanges:r}=this,[l,d,u]=t.map(e=>e.map(({name:e,value:t})=>O.tsx("calcite-combobox-item",{key:`#${t}`,selected:i===t,textLabel:e,value:`${t}`}))),p=[];d.length>0&&p.push(O.tsx("calcite-combobox-item-group",{key:"other",label:a.other},d)),u.length>0&&p.push(O.tsx("calcite-combobox-item-group",{key:"unsupported",label:n.subtypes.unsupportedDomainGroupTitle},u)),p.length>0?p.unshift(O.tsx("calcite-combobox-item-group",{key:"recommended",label:n.recommended},l)):p.push(...l);const c="INSERT"===o.editType,m=r.has(s),h=null==i&&(!c||m);return e.showNoValueOptionEnabled&&p.unshift(O.tsx("calcite-combobox-item",{key:"empty-option",selected:h,textLabel:e.showNoValueLabel||n.empty,value:""})),p}_renderRadioButtonComponents(e,t,i){const{name:s,value:n}=e,a=t.map(({name:e,value:t})=>this._renderRadioButtonComponent({key:e,label:e,name:s,value:t,selected:t===n,props:i}));if(e.showNoValueOptionEnabled){const t="",o=e.showNoValueLabel||this.messages.empty,r=n===t||null===n;a.unshift(this._renderRadioButtonComponent({key:"empty-option",label:o,name:s,value:t,selected:r,props:i}))}return O.tsx("calcite-radio-button-group",{afterCreate:this._afterRadioGroupCreateOrUpdate,afterUpdate:this._afterRadioGroupCreateOrUpdate,class:g.css.inputRadioGroup,"data-field-name":i[T],key:`${i.key}-radio-group`,layout:"vertical",name:i.key,required:i.required},a)}_renderSwitchComponent(e,t){const{value:i}=e,s=!!y.isFieldElementWithInputType(e.element,"switch")&&i===e.element.input.onValue;return O.tsx("calcite-switch",{...t,checked:s,class:g.css.inputSwitch,disabled:t.readOnly,onblur:()=>{this._focusedFieldName=null},onCalciteSwitchChange:e=>this._saveValueFromComponent(e.currentTarget)})}_renderRadioButtonComponent({key:e,name:t,value:i,selected:s,label:n,props:a}){return O.tsx("calcite-label",{class:g.css.inputRadioLabel,key:e,layout:"inline"},O.tsx("calcite-radio-button",{...a,afterCreate:void 0,afterUpdate:void 0,checked:s,class:g.css.inputRadio,disabled:a.readOnly,name:t,onblur:()=>{this._focusedFieldName=null},value:i,onCalciteRadioButtonChange:({currentTarget:e})=>{e.checked&&this._saveValueFromComponent(e)}}),n)}_renderAuxiliaryText(e){const t=e.name,i=this._inputsWithChanges.has(t)&&!e.submittable?y.getErrorMessageForFieldInput(e,this.messages,this.timeZone):null!=this.viewModel.contingencyConstraintViolations.get(t)?this.messages.validationErrors.valuesIncompatible:null!=e.valueExpressionExecutor&&e.valueExpressionExecutor.stale?this.messages.valueExpressionError:null;return null!=i?O.tsx("calcite-input-message",{icon:!0,status:"invalid"},i):this._inputsWithChanges.has(t)&&e.valueIsOutOfDomain?O.tsx("calcite-input-message",{icon:!0,status:"idle"},this.messages.subtypes.fieldOutOfSubtypeDomainWarning):this._renderDescriptionOrEmpty(e.description)}_renderShowAllRelatedRecordsListItem(e){if(!e.showAllActionVisible||!this.callbacks?.showAllRelatedRecords)return;const t=this.messages;return O.tsx("calcite-list-item",{description:N.substitute(t.totalCount,{count:e.featureCount}),key:"show-all-related-features",label:t.showAll,value:!0,onCalciteListItemSelect:()=>this._onShowAllRelatedRecordsClick(e.relationshipId)},O.tsx("calcite-icon",{icon:"list",scale:"s",slot:"content-end"}))}_renderAddRelatedRecordButton(e){const{canAddRelatedFeature:t,relationshipId:i,relatedLayer:s,editable:n}=e,{messages:a,callbacks:o,disabled:r}=this,l=!n||r;if(t&&o?.addRelatedRecord&&s&&!l)return O.tsx("calcite-button",{alignment:"center",appearance:"outline-fill",class:g.css.centeredButton,disabled:e.updating||!e.originHasValidKey,iconStart:"plus",key:`${i}-add-button`,onclick:()=>{!e.updating&&e.originHasValidKey&&this._onAddRelatedRecordsClick(e,i,s)},round:!0,scale:"s",width:"full"},e.relatedLayerIsTable?a.addRecord:a.addFeature)}_renderRelatedRecordListItem(e,t,i){const{feature:s,description:n,title:a}=e,{feature:o,callbacks:r}=this,{highlightHelper:l}=this.viewModel,d=l?()=>l.add(s):void 0,u=l?()=>l.remove(s):void 0;return O.tsx("calcite-list-item",{bind:this,description:n,key:`${t}-${s.uid}`,label:a,onmouseenter:d,onmouseleave:u,value:a,onCalciteListItemSelect:()=>{l?.removeAll(),r?.editRelatedRecord&&o&&r.editRelatedRecord({parentFeature:o,relationshipId:t,relatedFeature:s,readOnly:i})}},O.tsx("calcite-icon",{icon:y.getIconForFeature(s),slot:"content-start"}),O.tsx("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"}))}_renderRelationshipInput(e){if(!this._relatedRecordsEnabled)return;const{relationshipId:t,activeCategory:i}=e,s=i?null:this._renderDescriptionOrEmpty(e.description);return O.tsx("calcite-label",{class:this.classes(g.css.label,g.css.relatedRecordsLabel),key:`relationship-${t}-container`},O.tsx("div",null,this._renderRelatedRecordsHeaderContainer(e),s,this._renderRelationshipInputContent(e)),this._renderAddRelatedRecordButton(e))}_renderRelationshipInputContent(e){return e.featureCount>0?this._renderRelatedRecordsList(e):e.activeCategory&&0===e.featureCount?this._renderNoRelatedRecordsNotice():e.allCategories?.length?this._renderCategoryList(e):e.loaded?e.originHasValidKey?this._renderNoRelatedRecordsNotice():this._renderNoValidOriginKeyNotice(e):void 0}_renderCategoryList(e){return O.tsx("calcite-list",{displayMode:"flat",label:this.messages.relatedRecordsList,loading:e.updating},e.categories?.map(t=>this._renderCategory(e,t)),this._renderShowAllCategoriesListItem(e))}_renderCategory(e,t){const{count:i,name:s,value:n}=t,a=M.formatNumber(i);return O.tsx("calcite-list-item",{key:`${s}-${n}`,label:s,onCalciteListItemSelect:()=>this._selectCategory(e,t)},O.tsx("calcite-chip",{label:a,scale:"s",slot:"content-end"},a),O.tsx("calcite-icon",{flipRtl:!0,icon:"chevron-left",scale:"s",slot:"content-end"}))}_selectCategory(e,t){this.relationshipId=e.relationshipId,e.activeCategory=t}_renderShowAllCategoriesListItem(e){if(!e.showAllCategoriesVisible)return;const t=this.messages;return O.tsx("calcite-list-item",{description:N.substitute(t.totalCount,{count:e.allCategories?.length??0}),key:"show-all-categories",label:t.showAll,value:!0,onCalciteListItemSelect:()=>e.showAllEnabled=!0},O.tsx("calcite-icon",{icon:"list",scale:"s",slot:"content-end"}))}_renderRelatedRecordsHeaderContainer(e){const t=e.updating||!e.loaded;return O.tsx("div",{class:g.css.relatedRecordsHeader,key:`relationship-${e.relationshipId}-header`},O.tsx("span",null,e.label),t?O.tsx("calcite-loader",{inline:!0,key:"loader",label:this.messagesCommon?.loading,scale:"s",type:"indeterminate"}):void 0)}_renderRelatedRecordsList(e){const{relationshipId:t,editable:i}=e,{disabled:s}=this,n=!i||s;return O.tsx("calcite-list",{class:g.css.relatedRecordsList,label:this.messages?.relatedRecordsList},e.relatedFeatureInfos.map(e=>this._renderRelatedRecordListItem(e,t,n)),this._renderShowAllRelatedRecordsListItem(e),this._renderObserverNode())}_renderNoValidOriginKeyNotice(e){const{messages:t}=this,i=e.relatedLayerIsTable?t.noOriginKeyRecord:t.noOriginKeyFeature,s=e.relationship?.keyField,n=this.viewModel.findField(s),a=e.layer?.fieldsIndex.get(s),o=n?.label||a?.alias||s,r=N.substitute(i,{relatedLayerName:e.relatedLayer?.title,originKeyField:o});return O.tsx("calcite-notice",{icon:"information",kind:"brand",open:!0,scale:"s",width:"full"},O.tsx("div",{slot:"message"},r))}_renderNoRelatedRecordsNotice(){return O.tsx("calcite-notice",{icon:"information",kind:"brand",open:!0,scale:"s",width:"full"},O.tsx("div",{slot:"message"},this.messagesFeature.noRelatedFeatures))}_renderObserverNode(){if(this.viewModel.activeRelationshipInput?.showAllEnabled)return O.tsx("div",{afterCreate:this._afterListObserverCreated,afterRemoved:this._afterListObserverRemoved,bind:this,class:g.css.listObserver,key:"feature-observer"})}_renderTextElementInput(e){return O.tsx("div",{class:g.css.textElement,"data-testid":`text-element-${e.label}`,innerHTML:e.text,key:e.id})}getCommonInputProps(e){const{disabled:t}=this,{editable:i,hint:s,label:n,maxLength:a,minLength:o,name:r,range:{max:l,min:d},required:u,valid:p,value:c}=e,m=this._inputsWithChanges.has(r),h=!i||t;return{afterCreate:this._afterComponentCreate,afterUpdate:this._afterComponentCreateOrUpdate,"aria-invalid":p?"false":"true",class:this.classes(g.css.fieldInput,h?g.css.inputDisabled:null),status:m&&!p?"invalid":"idle",key:r,label:n,max:null!=l?l:void 0,min:null!=d?d:void 0,maxLength:a>-1?a:void 0,minLength:o>-1?o:void 0,placeholder:s??void 0,readOnly:h,required:u,value:null==c?"":`${c}`,onblur:this._onComponentBlur,onfocus:this._onComponentFocus,onkeydown:this._onComponentKeyDown,[T]:r}}_getFieldInputFromHTMLElement(e){return this.viewModel.findField(e.getAttribute(T))}_afterDateComponentCreate(e){const t=this._getFieldInputFromHTMLElement(e),i=e.dataset.datePart,s=this._dateComponentMap.get(t.name);if("valueAsDate"in e&&null!=e.value&&null!=t.value){const i=new ResizeObserver(()=>{switch(e.value=void 0,t.field.type){case"date":e.value=F.prepareUnixFieldValueForDateComponents(t.value,this.timeZone).date??"";break;case"timestamp-offset":e.value=F.prepareISOFieldValueForDateComponents(t.value,this.timeZone).date??"";break;default:e.value=`${t.value}`}i.unobserve(e)});i.observe(e)}if(null!=s)switch(i){case"date":s.date=e;break;case"time":s.time=e;break;case"timeZone":s.timeZone=e}else this._dateComponentMap.set(t.name,{[i]:e});this._afterDateComponentCreateOrUpdate(e)}_afterDateComponentCreateOrUpdate(e){this._afterComponentCreateOrUpdate(e)}_afterComponentCreate(e){const t=this._getFieldInputFromHTMLElement(e);y.isNumberFieldInput(t)&&null!=e.value&&"setNumberValue"in e&&e.setNumberValue({committing:!1,value:e.value,origin:"direct"}),this._afterComponentCreateOrUpdate(e)}_afterRadioGroupCreateOrUpdate(e){const t=e.selectedItem,i=e.querySelector("calcite-radio-button"),s=t||i;s&&this._afterComponentCreateOrUpdate(s)}_afterComponentCreateOrUpdate(e){const{viewModel:t}=this,i=this._getFieldInputFromHTMLElement(e),s=t.findField(this._focusedFieldName);this._attemptFocusOnNextRender&&s===i&&(this._attemptFocusOnNextRender=!1,y.isInputInGroupInput(i)&&(i.group.open=!0),I.setFocus(e))}async _afterGroupCreate(e){const t=this.viewModel.findGroup(e.id),i=this.viewModel.findField(this._focusedFieldName);i&&t&&y.isInputInThisGroupInput(i,t)&&(!i.editable||this.disabled)&&(await e.componentOnReady(),this._attemptFocusOnNextRender=!0,this.scheduleRender())}_onComponentFocus(e){const t=e.target,i=this._getFieldInputFromHTMLElement(t);this._focusedFieldName=i.name}_onComponentBlur(e){const t=e.target;this._focusedFieldName=null,"readOnly"in t&&t.readOnly||this._saveValueFromComponent(t)}_saveValueFromDateComponent(e){const{timeZone:t}=this,i=this._getFieldInputFromHTMLElement(e),s=i.field.type,{name:n,range:a}=i,o=this._dateComponentMap.get(n);if(!o)return;let r=this.viewModel.getValue(n),l=null;"date-only"===s?l=Array.isArray(e.value)?e.value[0]:e.value:"time-only"===s?(r=F.normalizeTimeOnlyString(r),l=F.normalizeTimeOnlyString(e.value)):l="timestamp-offset"===s?null!=e.value?F.getISOFieldValueFromDateComponents({dateComponent:o.date,timeComponent:o.time,timeZoneComponent:o.timeZone,oldValue:r,defaultTimeZone:t}):null:null!=e.value?F.getUnixFieldValueFromDateComponents({oldValue:r,dateComponent:o.date,timeComponent:o.time,timeZone:t,max:a.max,min:a.min}):null,null!==l&&e.value?r!==l&&this._updateFieldValue(n,l):this._updateFieldValue(n,null)}_saveValueFromComponent(e){const t=this._getFieldInputFromHTMLElement(e),i=this._parseValue(e),s=t.value;t.isSubtypeField&&y.subtypeChangeShouldPrompt(this.layer,s,i)?this._pendingSubtypeChoice||i===s||(this._pendingSubtypeChoice=this._handleSubtypeChoice(t,i)):this._updateFieldValue(t.name,i)}async _handleSubtypeChoice(e,t){const{value:i,name:s}=e,{messages:n,viewModel:a,messagesCommon:r,_subtypes:l}=this;if(this._updateFieldValue(s,t),!l?.length)return;const d=l.find(e=>e.code===t),u=l.find(e=>e.code===i)?.name??`${i}`;if(!d)return;const p=o.createResolver();a.pendingSubtypeChoice=p;let c="update-fields";const m=[{label:n.subtypes.useDefaultValuesOption,value:"update-fields"},{label:n.subtypes.keepCurrentValuesOption,value:"keep-existing"}],h={context:"info",title:n.subtypes.changeWarningTitle,message:N.substitute(n.subtypes.changeWarning,{originalType:u,newType:d.name}),radios:m,defaultRadioSelection:"update-fields",onRadioSelection:e=>c=e,actions:{primary:{label:r.apply,action:()=>p.resolve(c),type:"positive"},secondary:{label:r.cancel,type:"neutral",action:()=>p.resolve("undo")}},cancel:()=>p.reject()};try{switch(this.showPrompt(h),await p.promise){case"update-fields":a.applySubtypeDefaults(d),this._validateContingenciesForNonNullFields();break;case"keep-existing":this._validateContingenciesForNonNullFields();break;case"undo":this._updateFieldValue(e.name,i)}}finally{a.pendingSubtypeChoice=null,this.clearPrompt(),this._pendingSubtypeChoice=null}}_onComponentKeyDown({key:e,target:t}){const i=this._getFieldInputFromHTMLElement(t);"Enter"===e&&y.isInputInGroupInput(i)&&!i.group.open&&(i.group.open=!0)}_updateFieldValue(e,t){const i=this.viewModel.getValue(e);this.viewModel.setValue(e,t),this._inputsWithChanges.add(e),i!==t&&this.viewModel.fieldsWithContingentValues.has(e)&&this._validateContingenciesForNonNullFields()}_validateContingenciesForNonNullFields(){const e=Object.fromEntries(Object.entries(this.getValues()).filter(([e,t])=>null!=t));this.viewModel.validateContingencyConstraints(e)}_parseValue(e){const t=this._getFieldInputFromHTMLElement(e),i=e.value;return y.isFieldElementWithInputType(t.element,"switch")?e.checked?t.element.input.onValue:t.element.input.offValue:null==i||""===i?null:"number"===t.dataType?"-0"===i||"-0."===i||"-0,"===i?i:parseFloat(i):"date"===t.field.type?parseFloat(i):i}_ignoreDeselectionOfNoValueOption(e){const{firstChild:t,selectedItems:i}=e;0===i.length&&t&&"selected"in t?t.selected=!0:a.getLogger(this).warnOnce("Failed to override user attempt to deselect 'No value' option.")}_onGroupToggle(e,t){e.expanded?(t.open=!0,this._focusedFieldName=this._getFocusableInput("forward",t)?.name||null,this._attemptFocusOnNextRender=!0,"sequential"===this.groupDisplay&&this.viewModel.allGroupInputs.forEach(e=>{e!==t&&(e.open=!1)})):t.open=!1,this.scheduleRender()}_onFormSubmit(e){e.preventDefault()}_onFormKeyDown(e){"Enter"===e.key&&this.viewModel.submit()}_afterListObserverCreated(e){this.viewModel.activeRelationshipInput&&(this._listObserverNode=e)}_afterListObserverRemoved(){this._listObserverNode=null}_onObserverChange(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode);const e=this.viewModel.activeRelationshipInput;e&&this._listObserverNode&&e.showAllEnabled&&this._listObserver.observe(this._listObserverNode)}_incrementRelatedRecordPage(){const e=this.viewModel.activeRelationshipInput;e?.incrementPage()}_syncGroupInputStates(){if("sequential"!==this.groupDisplay)return;const e=this.viewModel.allGroupInputs;if(!e.length)return;const t=e.filter(e=>e.open);0===t.length?e[0].open=!0:t.length>1&&t.slice(1).forEach(e=>e.open=!1)}get test(){return{inputsWithChanges:this._inputsWithChanges,updateValue:this._saveValueFromComponent.bind(this)}}};return t.__decorate([d.property()],D.prototype,"_listObserverNode",void 0),t.__decorate([d.property()],D.prototype,"_relatedRecordsEnabled",null),t.__decorate([d.property()],D.prototype,"_utilityNetworkAssociationsEnabled",null),t.__decorate([d.property()],D.prototype,"_prompt",void 0),t.__decorate([d.property()],D.prototype,"_subtypes",null),t.__decorate([d.property()],D.prototype,"associationId",null),t.__decorate([d.property()],D.prototype,"associatedLayer",null),t.__decorate([d.property()],D.prototype,"disabled",null),t.__decorate([d.property()],D.prototype,"feature",null),t.__decorate([d.property()],D.prototype,"_featureFormUNAssociationList",void 0),t.__decorate([d.property()],D.prototype,"formTemplate",null),t.__decorate([d.property()],D.prototype,"groupDisplay",void 0),t.__decorate([d.property()],D.prototype,"headingLevel",void 0),t.__decorate([d.property()],D.prototype,"icon",null),t.__decorate([d.property()],D.prototype,"label",null),t.__decorate([d.property()],D.prototype,"layer",null),t.__decorate([d.property()],D.prototype,"map",null),t.__decorate([d.property(),k.messageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")],D.prototype,"messages",void 0),t.__decorate([d.property(),k.messageBundle("esri/t9n/common")],D.prototype,"messagesCommon",void 0),t.__decorate([d.property(),k.messageBundle("esri/widgets/Feature/t9n/Feature")],D.prototype,"messagesFeature",void 0),t.__decorate([d.property(),k.messageBundle("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],D.prototype,"messagesTemplates",void 0),t.__decorate([d.property()],D.prototype,"callbacks",null),t.__decorate([d.property()],D.prototype,"relationshipId",null),t.__decorate([d.property()],D.prototype,"spatialReference",null),t.__decorate([d.property()],D.prototype,"strict",null),t.__decorate([d.property()],D.prototype,"timeZone",null),t.__decorate([d.property()],D.prototype,"showPrompt",null),t.__decorate([d.property()],D.prototype,"clearPrompt",null),t.__decorate([d.property(),R.vmEvent(["value-change","submit"])],D.prototype,"viewModel",void 0),t.__decorate([d.property({type:C,nonNullable:!0})],D.prototype,"visibleElements",void 0),t.__decorate([d.property()],D.prototype,"test",null),D=t.__decorate([u.subclass("esri.widgets.FeatureForm")],D),D});