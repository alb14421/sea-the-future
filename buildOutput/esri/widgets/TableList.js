// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../chunks/tslib.es6","../core/Collection","../core/Identifiable","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","./LayerList/LayerListItem","./LayerList/support/layerListUtils","../chunks/componentsUtils","./support/globalCss","./support/listUtils","./support/widgetUtils","./support/decorators/messageBundle","./support/decorators/vmEvent","./support/jsxFactory","./TableList/css","./TableList/ListItem","./TableList/TableListViewModel","./TableList/TableListVisibleElements","./TableList/support/tableListUtils"],function(e,t,s,o,i,l,r,a,n,d,c,p,m,h,_,u,g,y,I,b,f,v,w,L,C){"use strict";const E="nested",F=s.ofType(v);let M=class extends(o.IdentifiableMixin(c)){constructor(e,t){super(e,t),this._rootListEl=null,this._focusRootFlowItem=!1,this._focusPanelFlowItem=!1,this._lastDragDetail=null,this._selectedDragItemLayerUid=null,this._rootGroupUid=`table-${this.uid}`,this.collapsed=!1,this.dragEnabled=!1,this.filterPlaceholder="",this.filterPredicate=null,this.filterText="",this.headingLevel=2,this.listItemCanGiveFunction=null,this.listItemCanReceiveFunction=null,this.messages=null,this.messagesCommon=null,this.minDragEnabledItems=m.minDragEnabledItems,this.minFilterItems=m.minFilterItems,this.selectedItems=new F,this.selectionMode="none",this.viewModel=new w,this.visibleElements=new L,this._canMove=({dragEl:e,fromEl:t,toEl:s},o)=>{const i="pull"===o?this.listItemCanGiveFunction:this.listItemCanReceiveFunction,l=C.getItem(e);if(!l?.sortable)return!1;const r=C.getItem(t),a=m.getLayerType(t),n=C.getItem(s),d=m.getLayerType(s),c=!!a&&!!d&&a===d,p={selected:l,from:r,to:n},h=t.group,_=s.group;return h&&_&&"function"==typeof i?i.call(null,p):c},this._onCalciteListOrderChange=e=>{const{_lastDragDetail:t}=this,{toEl:s,fromEl:o,dragEl:i,newIndex:l}=e;if(!o||!s||t?.newIndex===l&&t?.dragEl===i&&t?.toEl===s&&t?.fromEl===o)return;this._lastDragDetail=e,this._selectedDragItemLayerUid=i.value;const r=Array.from(o.children).filter(e=>e?.matches("calcite-list-item")).map(e=>e.value);C.sortTablesToIds(this.map?.tables,r)},this._onSelectedDragItemLayerUidChange=e=>{this._selectedDragItemLayerUid=e},this._onTriggerAction=(e,t)=>{this.triggerAction(e,t)},this._onPanelOpen=()=>{this._focusPanelFlowItem=!0}}initialize(){this.addHandles([i.on(()=>this.viewModel.tableItems,"change",()=>m.removeDestroyedListItems(this.selectedItems),i.initial),i.watch(()=>[this.filterPredicate,this._rootListEl],()=>m.setFilterPredicate(this._rootListEl,this.filterPredicate))])}loadDependencies(){return h.loadCalciteComponents({button:()=>new Promise((t,s)=>e(["../chunks/index2"],t,s)),flow:()=>new Promise((t,s)=>e(["../chunks/index14"],t,s)),"flow-item":()=>new Promise((t,s)=>e(["../chunks/index15"],t,s)),list:()=>new Promise((t,s)=>e(["../chunks/index16"],t,s)),notice:()=>new Promise((t,s)=>e(["../chunks/index6"],t,s))})}get _dragEnabled(){return this.viewModel.totalItems>=this.minDragEnabledItems&&this.dragEnabled}get _filterEnabled(){return this.viewModel.totalItems>=this.minFilterItems&&this.visibleElements.filter}get _visibleItems(){return this.tableItems?.filter(e=>!e.hidden&&(this.visibleElements.errors||!e.error))}get _openedPanelItems(){return this._visibleItems.filter(({hidden:e,panel:t})=>!e&&t?.open&&!t.disabled&&t.flowEnabled)}get icon(){return"table"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get listItemCreatedFunction(){return this.viewModel.listItemCreatedFunction}set listItemCreatedFunction(e){this.viewModel.listItemCreatedFunction=e}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get tableItems(){return this.viewModel.tableItems}get tables(){return this.viewModel.tables}set tables(e){this.viewModel.tables=e}triggerAction(e,t){return this.viewModel.triggerAction(e,t)}render(){const e=this.viewModel?.state,t={[_.globalCss.hidden]:"loading"===e,[_.globalCss.disabled]:"disabled"===e};return b.tsx("div",{class:this.classes(f.css.base,_.globalCss.widget,_.globalCss.panel,t)},this._renderItems())}_renderNoItemsMessage(){return b.tsx("div",{slot:"message"},this.messages.noItemsToDisplay)}_renderNoItems(){return b.tsx("div",{class:f.css.itemMessage,key:"esri-layer-list__no-items"},b.tsx("calcite-notice",{icon:"information",kind:"info",open:!0,width:"full"},this._renderNoItemsMessage()))}_renderPanelFlowItems(){const{_openedPanelItems:e}=this;return e.toArray().map(({title:t,panel:s},o)=>{const i=()=>this._handlePanelFlowItemBack(s);return b.tsx("calcite-flow-item",{afterCreate:this._focusPanelFlowItemNode,afterUpdate:this._focusPanelFlowItemNode,bind:this,description:t,heading:s.title,headingLevel:this.headingLevel,key:`flow-panel-${s.uid}`,selected:o===e.length-1,onCalciteFlowItemBack:e=>{e.preventDefault(),i()}},s.render(),b.tsx("calcite-button",{appearance:"transparent",onclick:i,slot:"footer-actions",width:"full"},this.messagesCommon.back))})}_handlePanelFlowItemBack(e){e.open=!1,this._focusRootFlowItem=!0}_focusRootFlowItemNode(e){this._focusRootFlowItem&&(this._focusRootFlowItem=!1,g.setFocus(e))}_focusPanelFlowItemNode(e){this._focusPanelFlowItem&&(this._focusPanelFlowItem=!1,g.setFocus(e))}_renderItems(){const{visible:e,collapsed:t,visibleElements:{closeButton:s,collapseButton:o,heading:i,flow:l},_dragEnabled:r,_visibleItems:a,_filterEnabled:n,_rootGroupUid:d,_openedPanelItems:c,selectionMode:p,messages:m,filterPlaceholder:h,filterText:_}=this,g=[b.tsx("calcite-flow-item",{afterCreate:this._focusRootFlowItemNode,afterUpdate:this._focusRootFlowItemNode,bind:this,closable:s,closed:!e,collapsed:t,collapsible:o,heading:i?m.widgetLabel:void 0,headingLevel:this.headingLevel,key:"root-flow-item",selected:!c.length,onCalciteFlowItemClose:()=>this.visible=!1},a?.length?null:this._renderNoItems(),b.tsx("calcite-list",{afterCreate:e=>{this._rootListEl=e},afterRemoved:()=>{this._rootListEl=null},canPull:e=>this._canMove(e,"pull"),canPut:e=>this._canMove(e,"put"),"data-layer-type":d,displayMode:E,dragEnabled:r,filterEnabled:n,filterPlaceholder:h,filterProps:u.calciteListFilterProps,filterText:n?_:"",group:d,key:"root-list",label:m.widgetLabel,selectionAppearance:"border",selectionMode:p,onCalciteListChange:e=>this._handleCalciteListChange(e),onCalciteListDragEnd:e=>this._handleCalciteListDragEnd(e.detail),onCalciteListFilter:e=>this.filterText=e.currentTarget?.filterText??"",onCalciteListOrderChange:e=>this._onCalciteListOrderChange(e.detail)},a.toArray().map(e=>this._renderItem(e)),n?b.tsx("div",{class:f.css.filterNoResults,slot:"filter-no-results"},b.tsx("calcite-notice",{kind:"info",open:!0,width:"full"},this._renderNoItemsMessage())):null)),this._renderPanelFlowItems()];return e?l?b.tsx("calcite-flow",{key:"root-flow"},g):g:null}_handleCalciteListDragEnd(e){const{fromEl:t,dragEl:s,oldIndex:o}=e;t.insertBefore(s,t.children[o])}_renderItem(e){return b.tsx(p,{canMove:this._canMove,css:f.css,displayMode:E,dragEnabled:this.dragEnabled,item:e,key:`layerListItem-${e.layer.uid}`,listModeDisabled:this.viewModel.listModeDisabled,messages:this.messages,messagesCommon:this.messagesCommon,rootGroupUid:this._rootGroupUid,selectedDragItemLayerUid:this._selectedDragItemLayerUid,selectedItems:this.selectedItems,selectionMode:this.selectionMode,visibleElements:this.visibleElements,onAction:this._onTriggerAction,onPanelOpen:this._onPanelOpen,onSelectedDragItemLayerUidChange:this._onSelectedDragItemLayerUidChange})}_handleCalciteListChange(e){const{selectionMode:t,selectedItems:s}=this;if("none"===t)return;const o=e.target.selectedItems.map(e=>C.getItem(e)).filter(Boolean);s.removeAll(),s.addMany(o)}};return t.__decorate([l.property()],M.prototype,"_rootListEl",void 0),t.__decorate([l.property()],M.prototype,"_focusRootFlowItem",void 0),t.__decorate([l.property()],M.prototype,"_focusPanelFlowItem",void 0),t.__decorate([l.property()],M.prototype,"_dragEnabled",null),t.__decorate([l.property()],M.prototype,"_filterEnabled",null),t.__decorate([l.property()],M.prototype,"_visibleItems",null),t.__decorate([l.property()],M.prototype,"_openedPanelItems",null),t.__decorate([l.property()],M.prototype,"collapsed",void 0),t.__decorate([l.property()],M.prototype,"dragEnabled",void 0),t.__decorate([l.property()],M.prototype,"filterPlaceholder",void 0),t.__decorate([l.property()],M.prototype,"filterPredicate",void 0),t.__decorate([l.property()],M.prototype,"filterText",void 0),t.__decorate([l.property()],M.prototype,"headingLevel",void 0),t.__decorate([l.property()],M.prototype,"icon",null),t.__decorate([l.property()],M.prototype,"label",null),t.__decorate([l.property()],M.prototype,"listItemCanGiveFunction",void 0),t.__decorate([l.property()],M.prototype,"listItemCanReceiveFunction",void 0),t.__decorate([l.property()],M.prototype,"listItemCreatedFunction",null),t.__decorate([l.property()],M.prototype,"map",null),t.__decorate([l.property(),y.messageBundle("esri/widgets/TableList/t9n/TableList")],M.prototype,"messages",void 0),t.__decorate([l.property(),y.messageBundle("esri/t9n/common")],M.prototype,"messagesCommon",void 0),t.__decorate([l.property()],M.prototype,"minDragEnabledItems",void 0),t.__decorate([l.property()],M.prototype,"minFilterItems",void 0),t.__decorate([l.property({type:F})],M.prototype,"selectedItems",void 0),t.__decorate([l.property()],M.prototype,"selectionMode",void 0),t.__decorate([l.property({readOnly:!0})],M.prototype,"tableItems",null),t.__decorate([l.property()],M.prototype,"tables",null),t.__decorate([I.vmEvent("trigger-action"),l.property({type:w})],M.prototype,"viewModel",void 0),t.__decorate([l.property({type:L,nonNullable:!0})],M.prototype,"visibleElements",void 0),M=t.__decorate([d.subclass("esri.widgets.TableList")],M),M});