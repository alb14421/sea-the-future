// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../Color","../../../core/colorUtils","../../../renderers/support/numberUtils","../../../smartMapping/renderers/support/referenceSizeUtils","../../../smartMapping/renderers/support/spikeUtils","../../../symbols/SimpleLineSymbol","../../../symbols/SimpleMarkerSymbol","../../../symbols/support/cimSymbolUtils","../../../symbols/support/previewCIMSymbol","../../../symbols/support/typeUtils","../../../symbols/support/utils","./utils","../../support/widgetUtils","../../../support/modeUtils"],function(e,l,t,i,o,n,r,s,a,u,c,m,p,y,f,b){"use strict";const S=[255,255,255],d=[200,200,200],g=[128,128,128];function h(e){"line-3d"===e.type?e.symbolLayers.forEach(e=>{e.material={color:g}}):e.symbolLayers.forEach(e=>{"icon"!==e.type||e.resource?.href?e.material={color:d}:(e.material={color:S},e.outline={color:g,size:1.5})})}function w(e){const l=b.isDarkMode();if("cim"===e.type)u.applyCIMSymbolColor(e,new t(d));else if(e.type.includes("line"))e.color=g;else if(e.color=l?g:S,"simple-marker"===e.type)if(e.outline){const l=e.outline?.color?.toHex();"#ffffff"===l&&(e.outline.color=g)}else e.outline={color:g,width:1.5}}function z(e){const l=e.minSize,t=(e.maxSize-l)/4,i=[];for(let e=0;e<5;e++)i.push(l+t*e);return i}async function v(e,l,t,i,n,r){const s=await V(e,l,t,n,r),a=await V(e,l,i,n,r),u=o.numDigits(t),c=u.fractional;let m=u.integer,p=null,y=null;t>0&&t<1&&(p=10**c,t*=p,m=o.numDigits(t).integer);for(let i=m-1;i>=0;i--){const u=10**i;let c=Math.floor(t/u)*u,m=Math.ceil(t/u)*u;null!=p&&(c/=p,m/=p);let f=(c+m)/2;[,f]=o.round([c,f,m],{indexes:[1]});const b=await V(e,l,c,n,r),S=await V(e,l,m,n,r),d=await V(e,l,f,n,r),g=o.percentChange(s,b,a,null),h=o.percentChange(s,S,a,null),w=o.percentChange(s,d,a,null);let z=g.previous<=20,v=h.previous<=20;if(z&&v&&(g.previous<=h.previous?(z=!0,v=!1):(v=!0,z=!1)),z?y=[c,b]:v?y=[m,S]:w.previous<=20&&(y=[f,d]),y)break}return y}async function V(l,t,i,o,n){const{getSize:r}=await new Promise((l,t)=>e(["../../../renderers/visualVariables/support/visualVariableUtils"],l,t));return r(l,i,{scale:o,view:n,shape:"simple-marker"===t.type?t.style:null})}l.getRampStops=async function(l,u,f,S,k,I,M){const C=u.legendOptions,x=C?.customValues,D=M||await async function(e,l){if("flow"===e.type)return y.getSymbolForFlowRenderer(e,l);if("pie-chart"===e.type)return new a({color:null,outline:e.outline?.width?e.outline:new s});let o=null,u=null;if("simple"===e.type)o=e.symbol;else if("class-breaks"===e.type){const l=e.classBreakInfos;o=l&&l[0]&&l[0].symbol,u=l.length>1}else if("unique-value"===e.type){const l=e.uniqueValueInfos;o=l?.[0]?.symbol,u=null!=l&&l.length>1}if(!o||function(e){return m.isSymbol3D(e)?e.symbolLayers?.some(e=>"fill"===e?.type)??!1:e?.type.includes("fill")??!1}(o))return null;if(o=o.clone(),l||u)if(o.type.includes("3d"))h(o);else if(y.getAuthoringInfoVisualVariableByTheme(e,"reference-size")&&"cim"===o.type)n.updateReferenceSizeSymbol(o,{color:l??("class-breaks"!==e.type?new t(d):null)});else if(y.getAuthoringInfoVisualVariableByTheme(e,"spike")&&"cim"===o.type){const e=new t(d),n=new t(g),s="CIMPointSymbol"===o.data.symbol?.type?o.data.symbol:null,a=!!s?.symbolLayers?.find(({type:e})=>"CIMSolidStroke"===e)?.colorLocked;let u,c=l??void 0;if(c){const l=i.getColorLuminance(c),t=b.isDarkMode();(!t&&l>225||t&&l<25)&&(c=e,u=a?n:e)}else c=e,u=a?n:e;r.updateSpikeSymbol(o,{color:c,strokeColor:u})}else w(o);return o}(l,f),T=u.stops,L=!!D,U=!!x,B=null!=u.minSize&&null!=u.maxSize,R=T&&T.length>1,A=!!u.target;if(!L||!U&&!(B||R&&!A))return;const P=p.isVolumetricSymbol(D);let q=!1,O=null,E=null;O=P&&!R?o.round([u.minDataValue,u.maxDataValue]):x??await async function(l,t,i,n){const r=(await new Promise((l,t)=>e(["../../../renderers/visualVariables/support/visualVariableUtils"],l,t))).getSizeRangeAtScale(l,i,n),s=r&&z(r);if(!r||!s)return;let a=s.map(e=>function(e,l,t){const i=t.minSize,o=t.maxSize,n=l.minDataValue,r=l.maxDataValue;let s;return s=e<=i?n:e>=o?r:(e-i)/(o-i)*(r-n)+n,s}(e,l,r));a=o.round(a);for(let e=1;e<a.length-1;e++){const o=await v(l,t,a[e],a[e-1],i,n);o&&(a[e]=o[0],s[e]=o[1])}return a}(u,D,S,k?.type);const F=l?.authoringInfo,H="univariate-color-size"===F?.type,W=H&&"above-and-below"===F?.univariateTheme,j=!!y.getAuthoringInfoVisualVariableByTheme(l,"reference-size"),G=!!y.getAuthoringInfoVisualVariableByTheme(l,"spike");if(!O&&R&&(O=T.map(e=>e.value),q=T.some(e=>!!e.label),"flow"===l.type&&(O=o.round(O)),q&&(E=T.map(e=>e.label))),P&&null!=O&&O?.length>2&&!W&&(O=[O[0],O[O.length-1]]),!O)return null;H&&5!==O?.length&&(O=z({minSize:O[0],maxSize:O[O.length-1]}));const J=P?function(e,l){const t=e?.authoringInfo,i="univariate-color-size"===t?.type;let o=[12,30];if(i){const e=l[0],t=l[l.length-1],i=12,n=30;o=l.map(l=>i+(l-e)/(t-e)*(n-i))}return i&&"below"===t?.univariateTheme&&o.reverse(),o}(l,O):null,K=p.getSymbolOutlineSize(D),N=q?null:function(e,l){const t=e.length-1;return e.map((e,i)=>y.createStopLabel(e,i,t,l))}(O,I);return(await Promise.all(O.map(async(e,t)=>{let i=P?J[t]:await V(u,D,e,S,k?.type),o=i;j&&(i*=24/u.maxSize||1,o=24);const s=function(e,l,t,i){"univariate-color-size"===t?.authoringInfo?.type&&"above-and-below"===t?.authoringInfo?.univariateTheme&&"class-breaks"===t.type&&(e=function(e,l){const t=e.classBreakInfos,i=t.length,o=i<2||!(l>=2)?t[0].symbol.clone():t[i-1].symbol.clone(),n=e.visualVariables?.some(e=>"color"===e.type);return n&&(o.type.includes("3d")?h(o):w(o)),o}(t,i));const o=e.clone();if(m.isSymbol3D(o))p.isVolumetricSymbol(o)||o.symbolLayers.forEach(e=>{"fill"!==e.type&&(e.size=l)});else if("esri.symbols.SimpleMarkerSymbol"===o.declaredClass)o.size=l;else if("esri.symbols.PictureMarkerSymbol"===o.declaredClass){const e=o.width,t=o.height;o.height=l,o.width=l*(e/t)}else"esri.symbols.SimpleLineSymbol"!==o.declaredClass?function(e){return"esri.symbols.TextSymbol"===e.declaredClass}(o)?o.font&&(o.font.size=l):"cim"===o.type&&y.getAuthoringInfoVisualVariableByTheme(t,"reference-size")?n.updateReferenceSizeSymbol(o,{innerDotSize:l,outerRingSize:24}):"cim"===o.type&&y.getAuthoringInfoVisualVariableByTheme(t,"spike")&&r.updateSpikeSymbol(o,{defaultHeight:l,primitiveOverrides:null}):o.width=l;return o}(D,i,l,t);return G&&"cim"===s.type&&(o=await c.getCIMSymbolPreviewSize(s)),{value:e,symbol:s,label:q?E[t]:N[t],size:o,outlineSize:K}}))).reverse()},l.getReferenceSizeSymbol=function(e,l,i,o){const r="class-breaks"===e.type,s=r?e.classBreakInfos?.[0]?.symbol?.clone():e.uniqueValueInfos?.[0]?.symbol?.clone();return s&&"type"in s&&"cim"===s.type?(n.updateReferenceSizeSymbol(s,{color:o??(r?null:new t(d)),innerDotSize:l*(24/i)||1,outerRingSize:24}),s):null},l.realWorldMaxSize=30,l.realWorldMinSize=12,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});