// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../chunks/tslib.es6","../../../Color","../../../intl","../../../kernel","../../../request","../../../core/Accessor","../../../core/arrayUtils","../../../core/Collection","../../../core/has","../../../core/jsonMap","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/screenUtils","../../../core/sql","../../../core/urlUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../layers/effects/EffectView","../../../layers/effects/jsonUtils","../../../layers/support/displayFilterUtils","../../../layers/support/ExportImageParameters","../../../layers/support/fieldUtils","../../../layers/support/layerUtils","../../../layers/support/rasterFormats/pixelRangeUtils","../../../renderers/support/jsonUtils","../../../renderers/support/rendererConversion","../../../renderers/visualVariables/SizeVariable","../../../renderers/visualVariables/support/SizeVariableLegendOptions","../../../smartMapping/renderers/support/referenceSizeUtils","../../../symbols/SimpleFillSymbol","../../../symbols/SimpleMarkerSymbol","../../../symbols/support/cimSymbolUtils","../../../symbols/support/renderUtils","../../../symbols/support/symbolUtils","../../../symbols/support/utils","./clusterUtils","./colorRampUtils","./heatmapRampUtils","./relationshipRampUtils","./sizeRampUtils","./utils","../../smartMapping/support/utils","../../../intl/messages","../../../intl/substitute"],function(e,t,l,i,s,r,n,a,o,u,c,d,y,h,p,f,m,g,b,S,_,w,v,L,C,E,F,I,R,V,D,T,x,z,P,M,O,A,k,U,B,H,N,q,$,W,G,j){"use strict";const J=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Q=new d.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),Z=new P({size:6,outline:{color:[128,128,128,.5],width:.5}}),K=new z({style:"solid"});function X(e){return"flow"===e.type}function Y(e){return"vector-field"===e.type}function ee(e){return"raster-colormap"===e.type}function te(e){return"raster-stretch"===e.type}function le(e){return"raster-shaded-relief"===e.type}function ie(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function se(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function re(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function ne(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function ae(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function oe(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function ue(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function ce(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function de(e){return"esri.renderers.PieChartRenderer"===e.declaredClass}function ye(e){return"esri.layers.SubtypeGroupLayer"===e.declaredClass}function he(e){return"esri.layers.MapImageLayer"===e.declaredClass}function pe(e){return"esri.layers.TileLayer"===e.declaredClass}function fe(e){return"esri.layers.ImageryLayer"===e.declaredClass}function me(e){return"esri.layers.ImageryTileLayer"===e.declaredClass}function ge(e){return"sublayers"in e}function be(e){return e&&"symbol"in e}async function Se(e,t){const l=await G.fetchMessageBundle("esri/widgets/Legend/t9n/Legend");return"previewTemplateAriaLabel"!==e||t||(e="previewAriaLabel"),j.substitute(l[e],{label:t})}const _e=new P({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let we={};return t.default=class extends a{constructor(e){super(e),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this._layerDefinitionExpression=null,this._layerDefinitionExpressionClause=null,this._layerDisplayFilterId=null,this._layerDisplayFilterClause=null,this.children=new u,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this.addHandles([f.on(()=>this.children,"change",t=>{const{added:l,removed:i}=t;l.forEach(t=>{const l=`activeLayerInfo-ready-watcher-${t.layer.uid}`;this.addHandles(f.watch(()=>t.ready,e,f.initial),l)}),i.forEach(e=>this.removeHandles(e.layer.uid)),e()})]),this.keepCacheOnDestroy||(we={})}destroy(){this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(we=null),this._layerDefinitionExpressionClause=null}get effectList(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new w.EffectView,t.effect=e.effect,t.endTransition(),t.scale=this.scale),t}get opacity(){const e=this.layer.opacity,t=this.parent?.opacity,l=this.layer.parent,i=l&&"uid"in l?this._getParentLayerOpacity(l):null;return null!=t?t*e:null!=i?i*e:e}get ready(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view?.scale??0}get isScaleDriven(){const e=this.layer;if(null===e)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction){if("cluster"===e.featureReduction.type)return!0;if("binning"===e.featureReduction.type&&"renderer"in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return"renderer"in e&&e.renderer?!!("displayFilterInfo"in e&&e.displayFilterInfo&&re(e.renderer))||this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(this.hideLayersNotInCurrentView&&!await this._isLayerInCurrentView())return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,e=>{if(F.isFeatureLayer(e))return this._getRendererLegendElements(e.renderer,{title:e.title});if(e.featureSet?.features.length){const t=e.layerDefinition,l=t?.drawingInfo,i=l&&R.fromJSON(l.renderer),s=Q.read(t.geometryType);return i?this._getRendererLegendElements(i,{title:e.name,geometryType:s}):(y.getLogger(this).warn("drawingInfo not available!"),null)}return null});try{const e=[],l=await Promise.allSettled(t);for(const t of l)if("fulfilled"===t.status)for(const l of t.value??[])e.push(l);this.legendElements=e,this.notifyChange("ready")}catch(e){y.getLogger(this).warn("error while building legend for layer!",e)}}async buildLegendElementsForRenderer(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(e){y.getLogger(this).warn("error while building legend for layer!",e)}}async buildLegendElementsForFeatureReduction(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getLegendElementsForFeatureReduction(e):[],this.notifyChange("ready")}catch(e){y.getLogger(this).warn("error while building legend for layer!",e)}}async buildLegendElementsForTools(){const e=this.layer;if(function(e){return"esri.layers.VoxelLayer"===e.declaredClass}(e))await this._constructLegendElementsForVoxelLayer();else if(function(e){return"esri.layers.WMTSLayer"===e.declaredClass}(e))this._constructLegendElementsForWMTSlayer();else if(function(e){return"esri.layers.WMSLayer"===e.declaredClass}(e))await this._constructLegendElementsForWMSSublayers();else if(function(e){return"esri.layers.BuildingSceneLayer"===e.declaredClass}(e))await this._constructLegendElementsForBuildingSceneLayer();else if(he(e)||pe(e)||ye(e))await this._constructLegendElementsForSublayers();else{this.removeHandles("imageryLayers-watcher");let t="default";if(fe(e)){const l=e;t=(l?.rasterFunction?.functionName||"default")+"_"+(e.bandIds?.length?e.bandIds.join(""):"###")}if(me(e)||"link-chart"===e.type)return;await this._getLegendLayers(`${e.uid}-${t}`).then(async t=>{this.legendElements=[],this.notifyChange("ready");const l=t.map(async t=>{if(fe(e)){const t=f.watch(()=>[e.rasterFunction,e.bandIds],()=>p.debounce(async()=>{we.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()})());this.addHandles(t,"imageryLayers-watcher")}const l=this._generateSymbolTableElementForLegendLayer(t);l?.infos.length&&(fe(e)&&(l.title=e.title),this.legendElements.push(l)),this.notifyChange("ready")});await Promise.allSettled(l)}).catch(e=>{y.getLogger(this).warn("Request to server for legend has failed!",e)})}}async _isLayerInCurrentView(){const e=this.layer,t=this.layerView,l=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!(l||t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;await f.whenOnce(()=>!t.updating);const i=l?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();return!i||(i.geometry=this.view.extent,0!==(l?"queryFeatureCount"in t&&await t.queryFeatureCount(i):"queryFeatureCount"in e&&await e.queryFeatureCount(i)))}_getParentLayerOpacity(e){let t=1;const l=e.parent;return l&&"uid"in l&&(t=this._getParentLayerOpacity(l)),e.opacity*t}_isGroupActive(){return this.children.some(e=>e.ready)}_isRendererScaleDriven(e){if("dot-density"===e.type)return!0;const t="valueExpression"in e?e.valueExpression:null;if(J.test(t))return!0;const l="visualVariables"in e?e.visualVariables:null;return!!l?.some(e=>this._isScaleDrivenSizeVariable(e))||this._hasScaleDrivenSymbols(e)}_hasScaleDrivenSymbols(e){switch(e.type){case"simple":return this._isScaleDrivenSymbol(e.symbol);case"class-breaks":return this._isScaleDrivenSymbol(e.defaultSymbol)||e.classBreakInfos.some(e=>this._isScaleDrivenSymbol(e.symbol));case"unique-value":return this._isScaleDrivenSymbol(e.defaultSymbol)||!!e.uniqueValueInfos?.some(e=>this._isScaleDrivenSymbol(e.symbol))}return!1}_isScaleDrivenSymbol(e){if("cim"===e?.type){const{primitiveOverrides:t,minScale:l,maxScale:i}=e.data,s=t?.some(e=>(e.valueExpressionInfo?.expression||"").includes("$view.scale"))??!1;return null!=l||null!=i||s}return!1}_isScaleDrivenSizeVariable(e){if(e&&"size"!==e.type)return!1;const t=e,l=t.minSize,i=t.maxSize;return!("object"!=typeof l||!l||!this._isScaleDrivenSizeVariable(l))||!("object"!=typeof i||!i||!this._isScaleDrivenSizeVariable(i))||J.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some(e=>this._isLayerScaleDriven(e));const t=e.parent;if(!1===e.loaded&&t&&he(t)&&"source"in e&&e.source&&"map-layer"===e.source.type)for(const l of t.sourceJSON.layers??[])if(l.id===e.source.mapLayerId&&(l.minScale>0||l.maxScale>0))return!0;return!1}async _constructLegendElementsForVoxelLayer(){this.legendElements=[],this.removeHandles("voxel-style-watcher"),this.removeHandles("voxel-current-variable");const e=this.layer;this.addHandles(f.watch(()=>e.currentVariableId,()=>this._constructLegendElementsForVoxelLayer()),"voxel-current-variable"),this.addHandles(f.watch(()=>e.getVariableStyles(),()=>this._constructLegendElementsForVoxelLayer()),"voxel-style-watcher");const t=e.getVariableStyle(null),l=[];if(t)if(t.uniqueValues?.length){const e=[];t.uniqueValues.forEach(t=>{t.enabled&&e.push({label:t.label||`${t.value}`,value:t.value,symbol:new z({color:t.color,outline:null})})}),e.length&&l.push({type:"symbol-table",title:t.label,infos:e})}else if(t.transferFunction){const{colorStops:e,stretchRange:i}=t.transferFunction,s=e.toArray().reverse(),r=i.map((e,t)=>`${0===t?$.specialCharsLessThan:$.specialCharsGreaterThan} ${W.formatNumberLabel(e)}`).reverse(),n=s.map(e=>({color:e.color,value:null,label:null}));n[0].label=r[0],n[n.length-1].label=r[1],l.push({type:"color-ramp",title:t.label,infos:n,preview:A.renderColorRampPreviewHTML(s.map(e=>e.color),{ariaLabel:await Se("previewColorRampAriaLabel")})})}await this._generatePreviewsForLegendElements(l,{opacity:e.opacity}),this.legendElements=l,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this.removeHandles("wmts-activeLayer-watcher");const e=this.layer.activeLayer;this.addHandles(f.watch(()=>{const{layer:e}=this;return e&&"activeLayer"in e&&e.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");const t=e.styleId?e.styles?.find(({id:t})=>t===e.styleId)?.legendUrl:void 0;t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}]),this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this.removeHandles("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this.addHandles(f.watch(()=>{const{layer:e}=this;return e&&"sublayers"in e&&e.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const l=this.layer,i=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");const s=this.sublayerIds?.map(e=>l.findSublayerById(e))?.filter(o.isSome)??[],r=s.length?s:e.toArray();for(const e of r){const l=f.watch(()=>[e.title,e.visible,e.legendEnabled],()=>this._constructLegendElementsForWMSSublayers());if(this.addHandles(l,"wms-sublayers-watcher"),!this.respectLayerVisibility||e.visible&&e.legendEnabled){const l=await this._generateSymbolTableElementForWMSSublayer(e,t);l?.infos.length&&i.unshift(l)}}return i}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const l=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter(e=>e);return{type:"symbol-table",title:e.title,infos:l}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){let l=e.legendUrl;if(!l)return;const i={type:"symbol-table",title:e.title||e.name||String(e.id??""),infos:[]};t&&(l=b.addQueryParameters(l,t));let s=null;const r=e.layer?.opacity;try{s=(await n(l,{responseType:"image"})).data,s&&(s.style.opacity=r)}catch{}return i.infos.push({src:l,preview:s,opacity:r}),i}_getLegendLayers(e,t){const l=we&&we[e];return l?Promise.resolve(l):this._legendRequest(t).then(t=>{const l=t.layers;return we[e]=l,l})}_legendRequest(e){const t=this.layer;let l={f:"json",dynamicLayers:e};if(fe(t)){const e=t.exportImageServiceParameters.rasterFunction;if(e&&(l.renderingRule=JSON.stringify(e.functionDefinition?.toJSON()||e.toJSON())),t.bandIds&&(l.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:e,viewId:i,customParameters:s}=t;l={raster:e,viewId:i,...l,...s}}}let i=t.url.replace(/(\/)+$/,"");if("version"in t&&+t.version>=10.01){const e=i.indexOf("?");e>-1?i=i.slice(0,e)+"/legend"+i.slice(e):i+="/legend"}else{const e=i.toLowerCase().indexOf("/rest/"),t=-1===e?i:i.slice(0,e)+i.slice(e+5);i="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+encodeURI(t)+"&returnbytes=true"}return n(i,{query:l}).then(e=>e.data)}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this.removeHandles("sublayers-watcher");const e=this.layer;this.addHandles(f.watch(()=>e.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(e){y.getLogger(this).warn("Request to server for legend has failed!",e)}}async _generateLegendElementsForBuildingSublayers(e,t){let l=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");const i=e.toArray();for(const e of i){const i=f.watch(()=>["renderer"in e&&e.renderer,e.opacity,e.title,e.visible],()=>this._constructLegendElementsForBuildingSceneLayer());if(this.addHandles(i,"sublayers-watcher"),!this.respectLayerVisibility||e.visible){const i=null!=e?.opacity?e.opacity:null,s=null!=i?i*t:t;if("building-group"===e.type){const t={type:"symbol-table",title:e.title,infos:[]},i=await this._generateLegendElementsForBuildingSublayers(e.sublayers,s);t.infos.push(...i),l=[t,...l]}else e.renderer&&(l=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:s,sublayer:e}),...l])}}return l.filter(e=>!!e&&(!("infos"in e)||!e.infos||e.infos.length>0))}async _constructLegendElementsForSublayers(){this.legendElements=[],this.removeHandles("sublayers-watcher");const e=this.layer;if(he(e)||pe(e)||ye(e)){this.addHandles(f.watch(()=>e.sublayers,()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(e){y.getLogger(this).warn("Request to server for legend has failed!",e)}}}async _generateLegendElementsForSublayers(e,t,l){const i=this.layer;let s=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");let r=e.toArray();!l&&this.sublayerIds&&this.sublayerIds.length&&(r=ye(i)?this.sublayerIds.map(e=>i.findSublayerForSubtypeCode(e)).filter(o.isSome):this.sublayerIds.map(e=>i.findSublayerById(e)).filter(o.isSome));for(const e of r){const i=f.watch(()=>[e.renderer,e.opacity,e.title,e.visible,e.legendEnabled],()=>this._constructLegendElementsForSublayers());if(this.addHandles(i,"sublayers-watcher"),!this.respectLayerVisibility||e.visible&&e.legendEnabled&&this._isSublayerInScale(e)){const i=null!=e?.opacity?e.opacity:null,r=null!=i?i*t:t,n=!ge(e)||e.originIdOf("renderer")>2&&!e.sublayers;if(e.renderer&&n)await e.load(),s=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:r,sublayer:e}),...s];else if(ge(e)){const t=await this._generateSymbolTableElementForSublayer(e,r,l);t&&s.unshift(t)}}}return s.filter(e=>!!e&&(!("infos"in e)||!e.infos||e.infos.length>0))}async _generateSymbolTableElementForSublayer(e,t,l){if(!l){l=new Map;const t=this.layer,i=e.source;let s=null;if(i&&("map-layer"!==i.type||i.mapLayerId!==e.id||i.gdbVersion&&i.gdbVersion!==("gdbVersion"in t&&t.gdbVersion))||e.originIdOf("renderer")>2||e.originIdOf("labelingInfo")>2||e.originIdOf("labelsVisible")>2){const e=new C.ExportImageParameters({layer:this.layer});s=e.hasDynamicLayers?e.dynamicLayers:null,e.destroy()}const r=s||`${t.uid}-default`;(await this._getLegendLayers(r,s)).forEach(e=>l.set(e.layerId,e))}const i=l.get(e.id);if((!i||i?.subLayerIds&&i.defaultVisibility)&&e.sublayers){const i=await this._generateLegendElementsForSublayers(e.sublayers,t,l);return{type:"symbol-table",title:e.title,infos:i}}return this._generateSymbolTableElementForLegendLayer(i,e,t)}_generateSymbolTableElementForLegendLayer(e,t,l){if(!e?.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const i=t?.renderer;let s=t?.title||e.layerName;if(i&&(!t||t?.originIdOf("renderer")>2)){const e=t?.title||this._getRendererTitle(i,t);e&&(s&&"string"!=typeof e&&"title"in e&&(e.title=s),s=e)}const r={type:"symbol-table",title:s,legendType:e.legendType||null,infos:[]},n=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return e.legendGroups&&e.legendGroups.length>0?e.legendGroups.forEach(t=>{const i={type:"symbol-table",title:t.heading,legendType:e.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(n.filter(e=>e.groupId===t.id),e.layerId,l)};i.infos?.length>0&&r.infos.push(i)}):r.infos=this._generateSymbolTableElementInfosForLegendLayer(n,e.layerId,l),r.infos.length>0?r:null}_generateSymbolTableElementInfosForLegendLayer(e,t,l){return e.map(e=>{let i=e.url;if(e.imageData&&e.imageData.length>0)i=`data:image/png;base64,${e.imageData}`;else{if(i.startsWith("http"))return null;i=r.addTokenParameter(`${this.layer.url}/${t}/images/${i}`)}return{label:e.label,src:i,opacity:l??this.opacity,width:e.width,height:e.height}}).filter(o.isSome)}_isSublayerInScale(e){const t=e.minScale||0,l=e.maxScale||0;return!(t>0&&t<this.scale||l>this.scale)}_isLegendLayerInScale(e,t){const l=t||this.layer;let i=null,s=null,r=!0;return!l.minScale&&0!==l.minScale||!l.maxScale&&0!==l.maxScale?(0===e.minScale&&l.tileInfo&&(i=l.tileInfo.lods[0].scale),0===e.maxScale&&l.tileInfo&&(s=l.tileInfo.lods[l.tileInfo.lods.length-1].scale)):(i=Math.min(l.minScale,e.minScale)||l.minScale||e.minScale,s=Math.max(l.maxScale,e.maxScale)),(i>0&&i<this.scale||s>this.scale)&&(r=!1),r}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&+this.layer.version<10.1||0===e.length)return e;const l=t.renderer,i=e.some(e=>e.values);let s=0,r=null;return i&&e.some((e,t)=>(e.values||(s=t,r=e,r.label||(r.label="others")),null!=r)),l?"unique-value"===l.type?r&&(e.splice(s,1),e.push(r)):"class-breaks"===l.type&&(r&&e.splice(s,1),l.legendOptions?.order||e.reverse(),r&&e.push(r)):r&&(e.splice(s,1),e.push(r)),e}async _getRendererLegendElements(e,t={}){if(!function(e,t){return ie(e)||se(e)||re(e)||ne(e)||ce(e)||de(e)?"2d"===t.type||V.isSupportedRenderer3D(e):te(e)||ee(e)||le(e)||ae(e)||oe(e)||ue(e)||Y(e)||X(e)}(e,this.view))return y.getLogger(this).warn(`Renderer of type '${e.type}' not supported!`),[];if(function(e){return ae(e)||oe(e)||ue(e)||function(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}(e)}(e))return this._constructPointCloudRendererLegendElements(e,t);if(ce(e))return this._constructDotDensityRendererLegendElements(e);const l=await this._loadRenderer(e);return de(l)?this._constructPieChartRendererLegendElements(l):this._constructRendererLegendElements(l,t)}async _getLegendElementsForFeatureReduction(e){let t=null;return"binning"===e.type?t=e.renderer:"cluster"===e.type&&(t=this._getClusterRenderer(e)),t?this._getRendererLegendElements(t):[]}_getPointCloudRendererTitle(e){return(e.legendOptions?.title||e.field)??""}async _constructPointCloudRendererLegendElements(e,t={}){const l=t.title,i=[];let s=null,r=null;if(ae(e))s={type:"symbol-table",title:l||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(e=>{s.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(Z,e.color)})});else if(oe(e)){const t=e.stops;let i=null;if(t?.length&&(1===t.length&&(i=t[0].color),!i)){const e=t[0].value,l=t[t.length-1].value;if(null!=e&&null!=l){const s=e+(l-e)/2;i=B.getColorFromPointCloudStops(s,t)}}s={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(Z,i||Z.color)}]};const n=B.getRampStopsForPointCloud(e.stops??[])??[];r={type:"color-ramp",title:l||this._getPointCloudRendererTitle(e),infos:n,preview:A.renderColorRampPreviewHTML(n.map(e=>e.color),{ariaLabel:await Se("previewColorRampAriaLabel")})}}else ue(e)&&(s={type:"symbol-table",title:l||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos?.forEach(e=>{s.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:this._getAppliedCloneSymbol(Z,e.color)})}));return s?.infos.length&&i.push(s),r?.infos.length&&i.push(r),await this._generatePreviewsForLegendElements(i,{opacity:this.opacity,symbolConfig:{applyColorModulation:!!e.colorModulation}}),i}async _getElementInfoForDotDensity(e,t){const{color:l,label:i,valueExpressionTitle:s}=t,{backgroundColor:r,outline:n,dotSize:a}=e,o=this.effectList,u=o?.effects.map(e=>e.toJSON()),c=v.effectFunctionsFromJSON(u),d=await Se("previewTemplateAriaLabel",i||s),y=a+"-"+l+"-"+r+"-"+(n&&JSON.stringify(n.toJSON()))+"-"+c,h=this._dotDensityUrlCache,p=h.has(y)?h.get(y):A.renderDotDensityPreviewHTML(e,l,{ariaLabel:d});h.set(y,p);const f={shape:{type:"image",x:0,y:0,width:p.width,height:p.height,src:p.src},fill:null,stroke:null,offset:[0,0]},m=O.renderSymbol([[f]],[p.width,p.height],{effectView:this.effectList,ariaLabel:d});return{opacity:1,src:p.src,preview:m,width:p.width,height:p.height}}async _constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),l=e.legendOptions?.unit,i={type:"symbol-table",title:{value:t&&Math.round(t),unit:l||""},infos:[]};for(const t of e.attributes){const l=await this._getElementInfoForDotDensity(e,t);l.label=t.label||t.valueExpressionTitle||t.field,i.infos.push(l)}return[i]}async _constructPieChartRendererLegendElements(e){const t=[];let l=null;const i=e.outline;e.attributes.forEach(e=>{const l=new P({color:e.color,outline:i}),s=e.label||e.valueExpressionTitle||e.field;t.push({label:s,symbol:l})});const s=t.length?[...t]:[];if(e.othersCategory?.color&&0!==e.othersCategory?.threshold){const s=new P({color:e.othersCategory.color,outline:i});l=e.othersCategory.label||"Other",t.push({label:l,symbol:s})}if(e.defaultColor?.a){const l=new P({color:e.defaultColor,outline:i});t.push({label:e.defaultLabel,symbol:l})}const r=await this._getVisualVariableLegendElements(e,this.layer)||[];if(t.length){r.unshift({type:"symbol-table",title:null,infos:t});const n=s.filter(e=>e.label!==l).map(e=>e.symbol.color).filter(Boolean),a=A.renderPieChartPreviewHTML(n,{holePercentage:e.holePercentage,backgroundColor:e.backgroundFillSymbol?.color,effectList:this.effectList,outline:i,ariaLabel:await Se("previewPieChartAriaLabel")});r.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(e,this.layer),infos:t,preview:a})}return await this._generatePreviewsForLegendElements(r,{opacity:this.layer.opacity,effectView:this.effectList}),r}async _getWhereClause(e,t,l){const i=await g.parseWhereClause(e,l),s=new Set,{field:r,field2:n,field3:a}=t;E.collectFields(s,l,[r,n,a]),await E.collectArcadeFieldNames(s,l,t.valueExpression);const o=new Set(Array.from(s,e=>e.toLowerCase())),u=i?.fieldNames.map(e=>e.toLowerCase());return u?.some(e=>!o.has(e))?null:i}async _processDefinitionExpression(e,t){if(!("definitionExpression"in e))return;const l=e.definitionExpression;l&&this.respectLayerDefinitionExpression?this._layerDefinitionExpression!==l&&(this._layerDefinitionExpressionClause=await this._getWhereClause(l,t,e.fieldsIndex)):this._layerDefinitionExpressionClause=null,this._layerDefinitionExpression=l}async _processDisplayFilter(e,t){if(!("displayFilterInfo"in e))return;const l=e.displayFilterInfo?L.getEffectiveDisplayFilter(e.displayFilterInfo,this.view):null;return l?.where?this._layerDisplayFilterId!==l?.id&&(this._layerDisplayFilterClause=await this._getWhereClause(l.where,t,e.fieldsIndex)):this._layerDisplayFilterClause=null,this._layerDisplayFilterId=l?.id,l}async _constructRendererLegendElements(e,t={}){const{title:l,sublayer:i}=t,s=i||this.layer,r=$.getAuthoringInfoVisualVariableByTheme(e,"reference-size"),n=$.getAuthoringInfoVisualVariableByTheme(e,"spike");let a=null;re(e)&&(await this._processDefinitionExpression(s,e),a=await this._processDisplayFilter(s,e)),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const o=await this._getVisualVariableLegendElements(e,s)||[],u={type:"symbol-table",title:l||this._getRendererTitle(e,s),infos:[]};let c=null,d=!1;const y=new Set;if(X(e)&&!this._hasSizeRamp){const t=await $.getSymbolForFlowRenderer(e);u.infos.push({label:null,symbol:t})}else if(function(e){const t="authoringInfo"in e?e?.authoringInfo:null;return"univariate-color-size"===t?.type}(e)){let t=l;const i=function(e){const t="authoringInfo"in e?e?.authoringInfo:null;return"univariate-color-size"===t?.type&&"above-and-below"===t?.univariateTheme}(e)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",s=o.findIndex(e=>"color-ramp"===e.type),r=-1!==s?o.splice(s,1)[0]:null,n=o.findIndex(e=>"size-ramp"===e.type),a=-1!==n?o.splice(n,1)[0]:null,u=[];r&&(t=r.title,u.push(r)),a&&(t=a.title,u.push(a)),u.length>0&&o.push({type:i,title:t,infos:u})}else if(ne(e)){const t=H.getHeatmapRampStops(e);o.push({type:"heatmap-ramp",title:l||this._getRendererTitle(e,s),infos:t,preview:A.renderColorRampPreviewHTML(t.map(e=>e.color),{effectList:this.effectList,ariaLabel:await Se("previewColorRampAriaLabel")})})}else if(re(e)){const t=e.authoringInfo;if(t&&"relationship"===t.type){const{numClasses:l,field1:i,field2:r}=t,n=t.focus;if(l&&i&&r){const t=[i,r];let a=N.getRotationAngleForFocus(n)||0;for(const e of t){const{field:t,normalizationField:l,label:i}=e,r=i||{field:this._getFieldAlias(t,s),normField:l&&this._getFieldAlias(l,s)},n=_e.clone();n.angle=a,u.infos.push({label:r,symbol:n}),y.add(n),a+=90}const c=N.getRelationshipRampElement({focus:n,numClasses:l,infos:e.uniqueValueInfos??[]});o.unshift(c)}}else if(fe(this.layer)||me(this.layer))e.uniqueValueInfos?.forEach(t=>{t.symbol&&this._checkClausesForUVR(e,t.value)&&u.infos.push({label:t.label||t.value,value:t.value,symbol:t.symbol})});else{const{field:t,field2:i,field3:n,fieldDelimiter:o,valueExpression:c,defaultSymbol:y}=e,h=!(!t&&!c||!i&&!n),p=this._layerDisplayFilterClause?a?.title:null,f=[];if(e.uniqueValueGroups?.forEach(l=>{const a={type:"symbol-table",title:p||l.heading,infos:[]};l.classes?.forEach(l=>{const{symbol:u,values:d}=l;if(u){const y=[],p=[];for(const e of d??[]){const{value:l,value2:r,value3:a}=e,u=[],d=[];(t||c)&&(u.push(l),d.push(this._getDomainName(t,l,s))),i&&(u.push(r),d.push(this._getDomainName(i,r,s))),n&&(u.push(a),d.push(this._getDomainName(n,a,s))),y.push(h?u.join(o||""):u[0]),p.push(d.join(" - "))}const f=y.join(", ");let m=l.label;if(!m){const e=p.filter(Boolean);m=e.length?e.join(", "):f}const g=u.clone();"cim"===g.type&&r&&x.updateReferenceSizeSymbol(g,{innerDotSize:8,outerRingSize:16}),y.some(t=>this._checkClausesForUVR(e,t))&&a.infos.push({label:m,value:f,symbol:g})}}),a.infos.length&&f.push(a)}),f.length){const t=f[0];if(1===f.length&&"title"in t&&!t.title){const e=t.infos?.filter(be)??[];u.infos.push(...e)}else y&&(f.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:y}]}),d=!0),u.infos.push(...f);l||e.legendOptions?.title||e.valueExpressionTitle||(u.title=null)}}e.defaultSymbol&&!d&&(u.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),d=!0)}else if(se(e)){if(!r&&!n){if(c=this._isUnclassedRenderer(e),!c||!this._hasSizeRamp){const t=e.classBreakInfos.filter(({symbol:e})=>e),l="ascending-values"===e.legendOptions?.order;for(const{label:e,minValue:i,maxValue:s,symbol:r}of t){const t={label:e||(c?null:`${i} - ${s}`),value:[i,s],symbol:r};l?u.infos.push(t):u.infos.unshift(t)}c&&(u.title=null),this._updateInfosForClassedSizeRenderer(e,u.infos)}e.defaultSymbol&&!c&&(u.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),d=!0)}}else if(te(e))if(me(this.layer)||function(e){return"esri.layers.WCSLayer"===e.declaredClass}(this.layer)){const t=await this._constructTileImageryStretchRendererElements(e);"stretch-ramp"===t.type?o.push(t):u.infos=t}else{const t=this.layer;let l,i;e.customStatistics?.length&&({min:l,max:i}=e.customStatistics[0]);let s=[],r=t.serviceRasterInfo;if(t.rasterFunction)try{r=await t.generateRasterInfo(t.rasterFunction)}catch{}const n=I.getPixelValueRange(r.pixelType);if(1===r.bandCount){const s=t.bandIds?.[0]||0;l=null!=l?l:r.statistics?r.statistics[s].min:n[0],i=null!=i?i:r.statistics?r.statistics[s].max:n[1],l||i?o.push(await this._getStretchLegendElements(e,{min:l,max:i})):this._getServerSideLegend()}else if(t.bandIds&&1===t.bandIds.length)l=null!=l?l:r.statistics?r.statistics[t.bandIds[0]].min:n[0],i=null!=i?i:r.statistics?r.statistics[t.bandIds[0]].max:n[1],l||i?o.push(await this._getStretchLegendElements(e,{min:l,max:i})):this._getServerSideLegend();else if(r.bandCount>=3){const{bandInfos:e}=r,{bandIds:l}=t;e.length>=r.bandCount?3===l?.length?(s=l.map(t=>e[t].name),u.infos=this._createSymbolTableElementMultiBand(s)):"lerc"===t.format?(s=[0,1,2].map(t=>e[t].name),u.infos=this._createSymbolTableElementMultiBand(s)):this._getServerSideLegend():"lerc"===t.format?(s=["band1","band2","band3"],u.infos=this._createSymbolTableElementMultiBand(s)):this._getServerSideLegend()}else this._getServerSideLegend()}else if(ee(e))e.colormapInfos.forEach(e=>{u.infos.push({label:e.label,value:e.value,symbol:this._getAppliedCloneSymbol(K,e.color)})});else if(ie(e)){let l=e.symbol;switch(t.geometryType){case"point":l="pointSymbol"in s?s.pointSymbol:null;break;case"polyline":l="lineSymbol"in s?s.lineSymbol:null;break;case"polygon":l="polygonSymbol"in s?s.polygonSymbol:null}const i=this._hasClusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;e.symbol&&i&&u.infos.push({label:e.label,symbol:l})}else if(Y(e)){e.outputUnit&&(this.title="("+e.toJSON().outputUnit+")"),u.title=e.attributeField;const t=e.getClassBreakInfos();t?.length?t.forEach(e=>{u.infos.push({label:e.minValue+" - "+e.maxValue,symbol:e.symbol})}):u.infos.push({label:e.attributeField,symbol:e.getDefaultSymbol()})}else le(e)&&o.push(await this._getStretchLegendElements(e,{min:0,max:255}));const h=e.defaultSymbol;!h||d||ie(e)||c&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||o.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:h}]}),u.infos.length&&o.unshift(u);const p=null==t.opacity?this.opacity:t.opacity,f=this._isTallSymbol("visualVariables"in e?e.visualVariables:null),m=fe(this.layer)||me(this.layer);return await this._generatePreviewsForLegendElements(o,{opacity:p,symbolConfig:{isTall:f,isSquareFill:m},effectView:this.effectList},{defaultSymbol:h,arrowMarkerSymbols:y}),e=null,o}_checkClausesForUVR(e,t){const l=function(e,t){const{field:l,field2:i,field3:s,fieldDelimiter:r,valueExpression:n}=e;if(!l)return null;const a=(l||n)&&(i||s)?t?.toString().split(r||""):[t],o=l?{[l]:a?.[0]}:null;return o&&(i&&(o[i]=a?.[1]),s&&(o[s]=a?.[2])),o}(e,t);return!l||(!this._layerDefinitionExpressionClause||this._layerDefinitionExpressionClause.testFeature(l))&&(!this._layerDisplayFilterClause||this._layerDisplayFilterClause.testFeature(l))}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){const t=e?.infos;return t?t.reduce((e,t)=>e.concat(this._getAllInfos(t)),[]):[e]}async _constructTileImageryStretchRendererElements(e){const t=this.layer,l=t.symbolizer.rasterInfo??t.raster.rasterInfo;let i,s;const r=e?.customStatistics?.length?e.customStatistics:l?.statistics;if(r)({min:i,max:s}=r[0]);else{const e=I.getPixelValueRange(l.pixelType);i=e[0],s=e[1]}if(t.hasStandardTime()&&(i=t.getStandardTimeValue(i),s=t.getStandardTimeValue(s)),1===l.bandCount||1===t.bandIds?.length)return this._getStretchLegendElements(e,{min:i,max:s});const n=(t?.bandIds?.length?t.bandIds:Array.from(Array(Math.min(l.bandCount,3)).keys())).map(e=>l.bandInfos[e].name);return n.length<3?n.push(n[1]):n.length>3&&n.splice(3),this._createSymbolTableElementMultiBand(n)}async _getStretchLegendElements(e,t){const l=e.colorRamp,i=B.getStretchRampStops(l,t);return{type:"stretch-ramp",title:"",infos:i,preview:A.renderColorRampPreviewHTML(i.map(e=>e.color),{ariaLabel:await Se("previewColorRampAriaLabel")})}}_getClusterSymbol(){const e=this.layer,t="featureReduction"in e&&e.featureReduction,l=t&&"symbol"in t&&t.renderer;return l&&!0!==l?.authoringInfo?.isAutoGenerated?null:t&&"symbol"in t?t.symbol:null}async _getSizeLegendElement(e,t,l,i){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:await q.getRampStops(l,t,await $.getMedianColor(l),this.scale,this.view,i,this._hasClusterSizeVariable?this._getClusterSymbol():null)}}_createSymbolTableElementMultiBand(e){const t=[],l=["red","green","blue"];return e.forEach((e,i)=>{t.push({label:{colorName:l[i],bandName:e},src:$.rgbImgSource[i],opacity:this.opacity??1})}),t}_updateInfosForClassedSizeRenderer(e,t){const l=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,i=e.classBreakInfos.some(e=>k.isVolumetricSymbol(e.symbol));if(l&&i){const l=q.realWorldMaxSize,i=q.realWorldMinSize,s=e.classBreakInfos.length,r=(l-i)/(s>1?s-1:s);t.forEach((e,t)=>{e.size=l-r*t})}}_isTallSymbol(e){let t=!1,l=!1;if(e)for(let i=0;i<e.length&&(!t||!l);i++){const s=e[i];"size"===s.type&&("height"===s.axis&&(t=!0),"width-and-depth"===s.axis&&(l=!0))}return t&&l}async _generatePreviewsForLegendElements(e,t,l){const i=[];for(const s of e)for(const e of s.infos??[])if("infos"in e&&e.infos&&i.push(this._generatePreviewsForLegendElements([e],t,l)),be(e)&&e.symbol&&!e.preview){let r=!0;if("cim"===e.symbol.type){const{minScale:t,maxScale:l}=e.symbol.data;(t&&t<this.scale||l&&l>this.scale)&&(r=!1)}r&&i.push(this._generateSymbolPreviewForInfo(e,{...t,clipBloomEffect:"theme"in s&&"spike"===s.theme,effectView:l?.arrowMarkerSymbols?.has(e.symbol)?null:t.effectView},l?{isDefault:e.symbol===l.defaultSymbol,applyScaleDrivenSize:!l.arrowMarkerSymbols?.has(e.symbol)}:void 0))}await Promise.all(i)}async _generateSymbolPreviewForInfo(t,l,i){try{let s=!i?.isDefault&&null==t.size&&this._hasSizeRamp?m.px2pt(22):t.size;if(this._scaleDrivenSizeVariable&&i?.applyScaleDrivenSize){const{getSize:l}=await new Promise((t,l)=>e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,l));s=l(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===t.symbol.type?t.symbol.style:null})}const r="cim"===t.symbol.type?{style:"legend",cimOptions:{allowScalingUp:!i?.isDefault&&this._hasSizeRamp||!(!this._scaleDrivenSizeVariable||!i?.applyScaleDrivenSize),viewParams:this.isScaleDriven?{viewingMode:"2d"===this.view?.type?"map":this.view?.viewingMode,scale:this.view?.scale}:null}}:{},n=t.label&&"string"!=typeof t.label?null:await Se("previewTemplateAriaLabel",t.label);t.preview=await A.renderPreviewHTML(t.symbol,{size:s,scale:!1,ariaLabel:n,...l,...r})}catch{t.preview=null,y.getLogger(this).warn(`Generating symbol preview failed for symbol type: ${t.symbol?.type}`)}}_getClusterRenderer(e){this._hasClusterSizeVariable=!1;const t="renderer"in this.layer?this.layer.renderer:null,l=e.renderer?.clone()||t?.clone(),i=U.getEffectiveClusterSizeVariable(e,this.layerView,this.view);if(i&&null!=l&&"visualVariables"in l){const t=l.visualVariables?.some(e=>"size"===e.type&&"outline"!==e.target&&!J.test(e.valueExpression));if(!t){if("clusterMinSize"in e&&"clusterMaxSize"in e){const{clusterMinSize:t,clusterMaxSize:l}=e;i.legendOptions=new T({showLegend:t!==l})}const t=l.visualVariables||[];l.visualVariables=t.concat([i]),this._hasClusterSizeVariable=!0}}return l}async _loadRenderer(e){const t=[],l=e.clone(),i=await $.getMedianColor(l);if(se(l)||re(l)){const e=(l.classBreakInfos||l.uniqueValueInfos).map(e=>this._fetchSymbol(e.symbol,i).then(t=>{e.symbol=t}).catch(()=>{e.symbol=null}));Array.prototype.push.apply(t,e)}return t.push(this._fetchSymbol(l.symbol||l.defaultSymbol,l.defaultSymbol?null:i).then(e=>{this._applySymbolToRenderer(l,e,ie(l))}).catch(()=>{this._applySymbolToRenderer(l,null,ie(l))})),await Promise.allSettled(t),l}_applySymbolToRenderer(e,t,l){l?e.symbol=t:e.defaultSymbol=t}async _fetchSymbol(e,t){if(!e)throw new Error;if("web-style"===e.type){const l=this._webStyleSymbolCache;try{const i=await e.fetchSymbol({cache:l});return this._getAppliedCloneSymbol(i,t)}catch{throw y.getLogger(this).warn("Fetching web-style failed!"),new Error}}return this._getAppliedCloneSymbol(e,t)}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;const l=e.clone(),s=t&&t.toRgba();return l.type.includes("3d")?this._applyColorTo3dSymbol(l,s):"cim"===l.type?M.applyCIMSymbolColor(l,t):l.color&&(l.color=new i(s||l.color)),l}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach(e=>{e&&(e.material||(e.material={}),e.material.color=new i(t))})}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||"vector-field"===e.type)return null;const l=e.visualVariables??[],i=[],s=[],r=[],n=$.getAuthoringInfoVisualVariableByTheme(e,"reference-size")??$.getAuthoringInfoVisualVariableByTheme(e,"spike");let a;if(2===n?.sizeStops?.length&&(se(e)||re(e))){const[e,t]=n.sizeStops;a=new D({field:n.field??void 0,normalizationField:n.normalizationField,minSize:h.clamp(e.size,10,100),maxSize:h.clamp(t.size,50,150),minDataValue:e.value,maxDataValue:t.value}),s.push(a)}for(const e of l)"color"===e.type?i.push(e):"size"===e.type?s.push(e):"opacity"===e.type&&r.push(e);const u=[...i,...s,...r];let c,d;if(0===i.length&&se(e)&&e.classBreakInfos&&1===e.classBreakInfos.length){const t=e.classBreakInfos[0];c=t&&t.symbol}if(0===i.length&&ie(e)&&(c=e.symbol),c)if(c.type.includes("3d")){const e=c.symbolLayers.at(0);"water"===e.type?null!=e.color&&(d=e.color):null!=e.material?.color&&(d=e.material.color)}else c.url||(d=c.color);const y=this.effectList;return(await Promise.all(u.map(async l=>{if(!l.legendOptions||!1!==l.legendOptions.showLegend){const i=X(e)?l.field:this._getRampTitle(l,t);let s=null;const r=$.getDateFormatOptions(t,l,this.view.timeZone);if("color"===l.type){const e=await B.getRampStops(l,null,r)??[];s={type:"color-ramp",title:i,infos:e,preview:A.renderColorRampPreviewHTML(e.map(e=>e.color),{effectList:y,ariaLabel:await Se("previewColorRampAriaLabel")})},this._hasColorRamp||(this._hasColorRamp=e.length>0)}else if("size"===l.type&&"outline"!==l.target)J.test(l.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=l):(s=await this._getSizeLegendElement(i,l,e,r),a===l&&"spike"===n?.theme&&(s.theme=n.theme),this._hasSizeRamp||(this._hasSizeRamp=!(null==s.infos||!s.infos.length)));else if("opacity"===l.type){const e=await B.getRampStops(l,d,r)??[];s={type:"opacity-ramp",title:i,infos:e,preview:A.renderColorRampPreviewHTML(e.map(e=>e.color),{effectList:y,ariaLabel:await Se("previewColorRampAriaLabel")})},this._hasOpacityRamp||(this._hasOpacityRamp=e.length>0)}return s?.infos?s:null}}))).filter(o.isSome)}_getDomainName(e,t,l){if(e&&"function"!=typeof e){const i="getField"in l&&l.getField?.(e),s=i&&"getFieldDomain"in l&&l.getFieldDomain?l.getFieldDomain(i.name,{excludeImpliedDomains:c("esri-widget-legacy-field-domain-calculation")}):null;return"coded-value"===s?.type?s.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,l=e.field;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type){const e=t.featureReduction,i="popupTemplate"in e&&e.popupTemplate,s=i&&i.fieldInfos;if(s)for(const e of s)if(e.fieldName===l)return"cluster_count"===l?e.label||{showCount:!0}:e.label}return{showCount:!0}}_getRampTitle(e,t){let l=e.field,i=e.normalizationField,s=!1,r=!1,n=!1,a=null;l="function"==typeof l?null:l,i="function"==typeof i?null:i;const o=e.legendOptions?.title;if(null!=o)a=o;else if(e.valueExpressionTitle)a=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo?.visualVariables){const e=t.renderer.authoringInfo.visualVariables;for(let t=0;t<e.length;t++){const l=e[t];if("color"===l.type){if("ratio"===l.style){s=!0;break}if("percent"===l.style){r=!0;break}if("percent-of-total"===l.style){n=!0;break}}}}a={field:l&&this._getFieldAlias(l,t),normField:i&&this._getFieldAlias(i,t),ratio:s,ratioPercent:r,ratioPercentTotal:n}}return a}_getRendererTitle(e,t){const l=e;if(l.legendOptions?.title)return l.legendOptions.title;if(l.valueExpressionTitle)return l.valueExpressionTitle;let i=l.field,s=null,r=null;if(se(l)&&(s=l.normalizationField,r="percent-of-total"===l.normalizationType),i="function"==typeof i?null:i,s="function"==typeof s?null:s,re(l)){const{field2:e,field3:s,fieldDelimiter:r}=l;let n=i&&this._getFieldAlias(i,t);return e&&(n=`<${n}>${r}<${this._getFieldAlias(e,t)}>`,s&&(n=`${n}${r}<${this._getFieldAlias(s,t)}>`)),n}let n=null;return(i||s)&&(n={field:i&&this._getFieldAlias(i,t),normField:s&&this._getFieldAlias(s,t),normByPct:r}),n}_getFieldAlias(e,t){const l="popupTemplate"in t?t.popupTemplate:null,i=l?.fieldInfos;let s=i?.find(t=>e===t.fieldName),r=null;"getField"in t&&t.getField?r=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(r=t.fieldsIndex.get(e));let n=null;const a="featureReduction"in t&&t.featureReduction;a&&(s??="popupTemplate"in a?a.popupTemplate?.fieldInfos?.find(t=>e?.toLowerCase()===t.fieldName?.toLowerCase()):void 0,"fields"in a&&a.fields&&(n=a.fields.find(t=>t.name?.toLowerCase()===e?.toLowerCase())));const o=s||r||n;let u=null;return o&&(u=s?.label||r?.alias||n?.alias||"name"in o&&o.name||"fieldName"in o&&o.fieldName||null),u}_isUnclassedRenderer(e){const t=e.visualVariables;let l=!1;return se(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&t&&(l=e.field?t.some(t=>!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField)):!!t.length),l}},l.__decorate([S.property()],t.default.prototype,"children",void 0),l.__decorate([S.property({readOnly:!0})],t.default.prototype,"effectList",null),l.__decorate([S.property()],t.default.prototype,"layerView",void 0),l.__decorate([S.property()],t.default.prototype,"layer",void 0),l.__decorate([S.property()],t.default.prototype,"legendElements",void 0),l.__decorate([S.property({readOnly:!0})],t.default.prototype,"opacity",null),l.__decorate([S.property()],t.default.prototype,"parent",void 0),l.__decorate([S.property({readOnly:!0,dependsOn:[]})],t.default.prototype,"ready",null),l.__decorate([S.property()],t.default.prototype,"hideLayersNotInCurrentView",void 0),l.__decorate([S.property()],t.default.prototype,"keepCacheOnDestroy",void 0),l.__decorate([S.property()],t.default.prototype,"respectLayerDefinitionExpression",void 0),l.__decorate([S.property()],t.default.prototype,"respectLayerVisibility",void 0),l.__decorate([S.property({readOnly:!0})],t.default.prototype,"scale",null),l.__decorate([S.property()],t.default.prototype,"sublayerIds",void 0),l.__decorate([S.property({readOnly:!0})],t.default.prototype,"isScaleDriven",null),l.__decorate([S.property()],t.default.prototype,"title",void 0),l.__decorate([S.property({readOnly:!0,dependsOn:["ready"],value:0})],t.default.prototype,"version",null),l.__decorate([S.property()],t.default.prototype,"view",void 0),t.default=l.__decorate([_.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],t.default),t.default});