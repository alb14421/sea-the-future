// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../intl","../../core/Accessor","../../core/Collection","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/get","../../views/2d/layers/features/layerAdapters/featureReductionUtils","./support/ActiveLayerInfo","../../intl/locale"],function(e,t,i,r,s,a,n,o,l,y,d,c,h,L,u){"use strict";const p="state",f="all-layer-views",_="legend-properties",v=s.ofType(L),w=new Set(["esri.layers.BuildingSceneLayer","esri.layers.CatalogLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.OrientedImageryLayer","esri.layers.ParquetLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.SubtypeGroupLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer","esri.layers.LinkChartLayer","esri.layers.catalog.CatalogFootprintLayer","esri.layers.catalog.CatalogDynamicGroupLayer","esri.layers.knowledgeGraph.KnowledgeGraphSublayer","esri.layers.KnowledgeGraphLayer"]),I="view.basemapView.baseLayerViews",g="view.groundView.layerViews",V="view.basemapView.referenceLayerViews",m=[I,g,"view.layerViews",V];return e.default=class extends r{constructor(e){super(e),this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new s,this.activeLayerInfos=new v,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this.addHandles(a.watch(()=>this.view,()=>this._viewHandles(),a.initial),"view"),this.addHandles(u.onLocaleChange(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this.view=null}get state(){return this.view?.ready?"ready":"disabled"}_viewHandles(){this.removeHandles(p),this.view&&this.addHandles(a.watch(()=>this.state,()=>this._stateHandles(),a.initial),p)}_stateHandles(){this._resetAll(),"ready"===this.state&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this.removeHandles([f,_]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this.removeHandles(e);const t=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],t?.parent&&t.parent.children.remove(t)}_watchPropertiesAndAllLayerViews(){const{view:e}=this;if(!e)return;const{allLayerViews:t}=e;t.length&&this._refresh(),this.addHandles(t.on("change",e=>this._allLayerViewsChangeHandle(e)),f),this.addHandles(a.watch(()=>[this.layerInfos,this.basemapLegendVisible,this.groundLegendVisible],()=>this._propertiesChangeHandle()),_)}_allLayerViewsChangeHandle(e){e.moved.length?this._propertiesChangeHandle():(e.removed.forEach(e=>this._destroyViewActiveLayerInfo(e.uid)),this._refresh())}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(e){const t=this.view;if(e.length<2||!t)return;const i=[];e.forEach(t=>{if(!t.parent){const r=t.layer.parent,s=r&&"uid"in r&&this._layerViewByLayerId[r.uid],a=s&&this._activeLayerInfosByLayerViewId[s.uid];a&&e.includes(a)&&(i.push(t),t.parent=a,a.children.add(t),this._sortActiveLayerInfos(a.children))}}),e.removeMany(i);const r={};t.allLayerViews.forEach((e,t)=>r[e.layer.uid]=t),e.sort((e,t)=>{const i=r[e.layer.uid]||0;return(r[t.layer.uid]||0)-i})}_generateLayerViews(){const e=[];return m.filter(this._filterLayerViews,this).map(e=>c.get(this,e)).filter(e=>null!=e).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){const t=!this.basemapLegendVisible&&(e===I||e===V),i=!this.groundLegendVisible&&e===g;return!t&&!i}_collectLayerViews(e,t){const i=r=>(r&&r.forEach(r=>{t.push(r),i(r[e])}),t);return i}_filterLayerViewsByLayerInfos(e){const t=this.layerInfos;return!t||!t.length||t.some(t=>this._hasLayerInfo(t,e))}_hasLayerInfo(e,t){const i=this._isLayerUIDMatching(e.layer,t.layer.uid);return i&&(this._layerInfosByLayerViewId[t.uid]=e),i}_isLayerUIDMatching(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))}_hasLayerUID(e,t){return e&&e.some(e=>this._isLayerUIDMatching(e,t))}_isLayerViewSupported(e){return!!w.has(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this.removeHandles(e.uid),this.addHandles(a.watch(()=>[e.legendEnabled,e.layer?.legendEnabled],()=>this._layerActiveHandle(e)),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this.removeHandles(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.layer?.legendEnabled}_buildActiveLayerInfo(e){const t=e.layer,i=e.uid,r=this._layerInfosByLayerViewId[i];let s=this._activeLayerInfosByLayerViewId[i];if(!s){const a=void 0!==r?.title&&r.layer.uid===t.uid;s=new L({layer:t,layerView:e,title:a?r.title:t.title,view:this.view??void 0,respectLayerDefinitionExpression:this.respectLayerDefinitionExpression,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:r?.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[i]=s}const n=t.parent&&"uid"in t.parent?this._layerViewByLayerId[t.parent?.uid]:null;if(s.parent=this._activeLayerInfosByLayerViewId[n?.uid],!this.hasHandles(i)){const r=[a.watch(()=>t.title,e=>this._titleHandle(e,s)),a.watch(()=>[t.opacity,"renderer"in t&&t.renderer,"pointSymbol"in t&&t.pointSymbol,"lineSymbol"in t&&t.lineSymbol,"polygonSymbol"in t&&t.polygonSymbol],()=>this._constructLegendElements(s)),a.when(()=>!0===this.view?.stationary,()=>this._scaleHandle(s),a.initial),a.watch(()=>e.layer?h.getEffectiveFeatureReduction(e.layer,e.view):null,()=>this._constructLegendElements(s)),a.watch(()=>e.updating,()=>{null!=e.layer&&null!=h.getEffectiveFeatureReduction(e.layer,e.view)&&this._constructLegendElements(s)}),a.watch(()=>"effect"in t&&t.effect,()=>this._constructLegendElements(s)),a.when(()=>this.view?.timeZone,()=>this._constructLegendElements(s),a.initial)];if(this.respectLayerVisibility){const i=a.watch(()=>e.legendEnabled,e=>this._legendEnabledHandle(e,s)),n=a.watch(()=>t.legendEnabled,e=>this._legendEnabledHandle(e,s));r.push(i,n)}if(this.respectLayerDefinitionExpression&&"definitionExpression"in t){const e=a.watch(()=>[t.definitionExpression,this.respectLayerDefinitionExpression],()=>{s.respectLayerDefinitionExpression=this.respectLayerDefinitionExpression,this._constructLegendElements(s)});r.push(e)}this.addHandles(r,i)}s.isScaleDriven||this._constructLegendElements(s),this._addActiveLayerInfo(s)}_titleHandle(e,t){t.title=e,this._constructLegendElements(t)}_legendEnabledHandle(e,t){e?this._addActiveLayerInfo(t):this._removeActiveLayerInfo(t)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){const{layerView:t,layer:i}=e;if(this._isLayerActive(t)&&!this.activeLayerInfos.includes(e)){const t=e.parent;if(t)t.children.includes(e)||t.children.push(e),this._sortActiveLayerInfos(t.children);else{const t=this.layerInfos?.some(e=>e.layer.uid===i.uid),r=i.parent;r&&"uid"in r&&this._layerViewByLayerId[r.uid]&&!t?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const e=[];this._activeLayerInfosWithNoParent.forEach(t=>{const i=t.layer.parent,r=i&&"uid"in i?this._layerViewByLayerId[i?.uid]:null,s=this._activeLayerInfosByLayerViewId[r?.uid];s&&(e.push(t),t.parent=s)}),e.length&&(this._activeLayerInfosWithNoParent.removeMany(e),e.forEach(e=>this._addActiveLayerInfo(e)))}}}_removeActiveLayerInfo(e){const t=e.parent;t?t.children.remove(e):this.activeLayerInfos.remove(e)}_constructLegendElements(e){const t=e.layer;"featureCollections"in t&&t.featureCollections?e.buildLegendElementsForFeatureCollections(t.featureCollections):"featureReduction"in t&&t.featureReduction&&"renderer"in t.featureReduction&&("binning"===t.featureReduction.type||"cluster"===t.featureReduction.type)&&(!this.view||t.featureReduction.maxScale<=this.view.scale)?e.buildLegendElementsForFeatureReduction(t.featureReduction):"renderer"in t&&t.renderer&&!("sublayers"in t)?e.buildLegendElementsForRenderer(t.renderer):"url"in t&&t.url&&"catalog"!==t.type&&"knowledge-graph"!==t.type?e.buildLegendElementsForTools():e.children.forEach(e=>this._constructLegendElements(e))}},t.__decorate([n.property({type:v})],e.default.prototype,"activeLayerInfos",void 0),t.__decorate([n.property()],e.default.prototype,"basemapLegendVisible",void 0),t.__decorate([n.property()],e.default.prototype,"groundLegendVisible",void 0),t.__decorate([n.property()],e.default.prototype,"hideLayersNotInCurrentView",void 0),t.__decorate([n.property()],e.default.prototype,"keepCacheOnDestroy",void 0),t.__decorate([n.property()],e.default.prototype,"respectLayerDefinitionExpression",void 0),t.__decorate([n.property()],e.default.prototype,"respectLayerVisibility",void 0),t.__decorate([n.property()],e.default.prototype,"layerInfos",void 0),t.__decorate([n.property({readOnly:!0})],e.default.prototype,"state",null),t.__decorate([n.property()],e.default.prototype,"view",void 0),e.default=t.__decorate([d.subclass("esri.widgets.Legend.LegendViewModel")],e.default),e.default});