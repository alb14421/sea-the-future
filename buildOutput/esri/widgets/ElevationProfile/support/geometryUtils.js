// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/mathUtils","../../../core/promiseUtils","../../../core/unitUtils","../../../core/libs/gl-matrix-2/math/vec2","../../../chunks/vec32","../../../geometry/Polyline","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/support/geodesicUtils","../../../support/elevationInfoUtils","./ProfileGenerationError"],function(e,t,n,r,o,i,s,a,c,l,u,f,h){"use strict";function p(e,t){const n=e/t.densificationMaxSamples;return Math.max(t.samplingDistance,n)}function d(e,t,n){if(null==t)return g(e);const r=e.spatialReference,o=t.mode,i=f.getElevationOffset(t,r);let s=null;switch(n.type){case"2d":s=function({hasZ:e},t,n){return"absolute-height"===t?e?([e,t,r])=>[e,t,r+n]:([e,t])=>[e,t,n]:null}(e,o,i);break;case"3d":s=function({spatialReference:e,hasZ:t},n,r,{elevationProvider:o}){const i=(t,n,r,i)=>o?.getElevation(t,n,r,e,i)??0;switch(n){case"on-the-ground":return([e,t])=>[e,t,i(e,t,0,"ground")];case"absolute-height":return t?([e,t,n])=>[e,t,n+r]:([e,t])=>[e,t,r];case"relative-to-ground":return t?([e,t,n])=>[e,t,n+i(e,t,n,"ground")+r]:([e,t])=>[e,t,i(e,t,0,"ground")+r];case"relative-to-scene":return t?([e,t,n])=>[e,t,n+i(e,t,n,"scene")+r]:([e,t])=>[e,t,i(e,t,0,"scene")+r];default:return null}}(e,o,i,n)}return null==s?g(e):new a({hasZ:!0,hasM:!1,spatialReference:r,paths:m(e.paths,s)})}function g(e){return e.hasZ?new a({hasZ:!1,hasM:!1,spatialReference:e.spatialReference,paths:m(e.paths,([e,t])=>[e,t])}):e}function m(e,t){const n=e.length,r=new Array(n);for(let o=0;o<n;++o){const n=e[o],i=n.length,s=new Array(n.length);r[o]=s;for(let e=0;e<i;++e)s[e]=t(n[e])}return r}function P(e){return null!=e&&"polyline"===e.type}function w(e,t,r,i,s){const{spatialReference:c,hasZ:l}=e,u={from:null,to:null,distance:0,azimuth:0,reverseAzimuth:0,spatialReference:c,metersPerSR:o.getMetersPerUnitForSR(c)},f=[],h=[];let p=0;for(let o=0;o<e.paths.length;++o){const a=e.paths[o],c=new Array,l=new Array;let d=0;for(let e=1;e<a.length;++e){const o=a[e-1],f=a[e],h=i(u,o,f);let g;for(g=d;g<h.distance&&!n.floatEqualUlp(g,h.distance);g+=t)c.push(s(h,g)),l.push((p+g)*r);d=g-h.distance,p+=h.distance,c.push(f),l.push(p*r)}f[o]=c,h[o]=l}return{densifiedPath:new a({spatialReference:c,hasZ:l,paths:f}),distances:h}}function y(e,t,n){return e.distance=0,u.inverseGeodeticSolver(e,t,n,e.spatialReference),e.from=t,e.to=n,e}function v(e,t,n){return e.from=t,e.to=n,e.distance=i.distance(n,t)*e.metersPerSR,e}function R({from:e,azimuth:t,spatialReference:n},r){return u.directGeodeticSolver([0,0],e,t,r,n)}function S({from:e,to:t,azimuth:r,distance:o,spatialReference:i},s){const a=s/o,c=[0,0,n.lerp(e[2],t[2],a)];return u.directGeodeticSolver(c,e,r,s,i),c}function b({from:e,to:t,distance:n},r){return i.lerp([0,0],e,t,r/n)}function M({from:e,to:t,distance:n},r){return s.lerp([0,0,0],e,t,r/n)}function A(e){return e.paths.reduce((e,t)=>e+t.length,0)}function G(e,t,n){return A(e)+Math.floor(t/n)+Math.max(0,e.paths.reduce(e=>1+e,0)-1)}t.countPoints=A,t.densifyPath=async function(t,n,i,s,a,f,g){let m,P,A;const U=t.spatialReference,Z=U.isGeographic||U.isWebMercator;let x=0;if(!Z){const{execute:n}=await new Promise((t,n)=>e(["../../../geometry/operators/lengthOperator"],t,n));r.throwIfAborted(g),x=n(t,{unit:"meters"}),r.throwIfAborted(g)}const j=1/o.getMetersPerUnitForSR(s);if(Z){await c.initializeProjection([{source:U,dest:s},{source:U,dest:l.WGS84}],g);const e=(E=t,u.isSupported(E.spatialReference)?E:c.project(E,l.WGS84));m=u.geodesicLengths([e],"meters")[0];const r=p(m,a);if(G(t,m,r)>f)throw new h.ProfileGenerationError("too-complex");const o=d(e,n,i);({densifiedPath:P,distances:A}=function(e,t,n){const{hasZ:r}=e;return w(e,t,n,y,r?S:R)}(o,r,j)),P=c.project(P,s)}else{await c.initializeProjection([{source:U,dest:s}],g),m=x;const e=p(m,a);if(G(t,m,e)>f)throw new h.ProfileGenerationError("too-complex");const o=d(t,n,i);({densifiedPath:P,distances:A}=function(e,t,n){const{hasZ:r}=e;return w(e,t,n,v,r?M:b)}(o,e,j)),r.throwIfAborted(g),P=c.project(P,s)}var E;return{densifiedPath:P,pathLength:m*j,distances:A}},t.isPolyline=P,t.isValidInputPath=function(e){return P(e)&&e.paths.length>0&&e.paths.every(e=>e.length>=2)},t.toAbsoluteHeightElevation=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});