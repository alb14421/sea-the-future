// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../Graphic","../../core/Accessor","../../core/asyncUtils","../../core/handleUtils","../../core/has","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../layers/GraphicsLayer","../../symbols/CIMSymbol","../../symbols/SimpleLineSymbol","../../views/input/InputManager","./support/geometryUtils","../Sketch/SketchViewModel"],function(t,e,i,s,o,n,a,r,l,c,h,p,d,u,_,y,v,g,m,I){"use strict";function b(t){if(m.isPolyline(t)){const e=t.clone();return e.paths=[e.paths[0].slice(0,-1)],e}return t}t.ElevationProfileInteraction=class extends s{constructor(t){super(t),this.state="ready",this._pendingStartOptions=null,this._previousInputInfo=null,this._shouldRemoveLastPoint=!1,this._sketchedGraphics=new WeakSet,this._creationToolPromise=null,this._updateToolPromise=null,this._updateDisabled=!1}initialize(){this.addHandles(c.watch(()=>({view:this.tool.viewModel.view,visible:this.tool.visible}),({view:t,visible:e})=>{null!=t&&e?this._attach(t):this._detach()},c.syncAndInitial),"view")}destroy(){this._detach()}get canStopCreating(){const t=this._geometry,e=this._shouldRemoveLastPoint?3:2;return m.isPolyline(t)&&t.paths.length>0&&t.paths[0].length>=e}get _input(){return this.tool.viewModel.input}set _input(t){this.tool.viewModel.input=t}get _geometry(){return this._input?.geometry}get _visibleAndEditable(){return this.tool.visible&&this.tool.editable}get _view(){return this.tool.viewModel.view}get test(){}start(t={mode:"sketch"}){if(!this.tool.editable)return;const e=this._view;if(null!=e&&e.ready)switch(this._pendingStartOptions=null,this._stopInteraction(),null==this._previousInputInfo&&this._storePreviousInput(this._input),this._setSketchedGraphic(null),t.mode){case"sketch":this._set("state","creating"),this._startCreationInteraction();break;case"select":this._set("state","selecting"),this._startSelectionInteraction()}else this._pendingStartOptions=t}stop(){this._pendingStartOptions=null,this._stopInteractionAndUpdate(),this._clearPreviousInput()}cancel(){this._pendingStartOptions=null,this._stopInteractionAndUpdate(),this._restorePreviousInput()}clear(){this._stopInteractionAndUpdate(),this._set("state","ready"),this._clearPreviousInput(),this._input=null,this._pendingStartOptions=null}isSketchedGraphic(t){return null!=t&&this._sketchedGraphics.has(t)}_attach(t){this._detach();const e={mode:"3d"===t.type?"relative-to-ground":"on-the-ground",offset:null};this._graphicsLayer=new _({listMode:"hide",internal:!0,elevationInfo:e,title:"Elevation info"});const i="2d"===t.type?new y({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[5,4],lineDashEnding:"FullGap",controlPointEnding:"NoConstraint"}],enable:!0,capStyle:"Butt",joinStyle:"Round",width:1.5,color:[0,0,0,255]},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",width:1.5,color:[255,255,255,255]}]}}}):new v({color:[0,0,0,0]});this._sketchVM=new I({layer:this._graphicsLayer,view:t,defaultCreateOptions:{mode:"click",hasZ:!1},updateOnGraphicClick:!1,defaultUpdateOptions:{reshapeOptions:{shapeOperation:"none"},enableRotation:!1,enableScaling:!1,enableMoveAllGraphics:!1,enableZ:!1,multipleSelectionEnabled:!1,toggleToolOnClick:!1,tool:"reshape"},polylineSymbol:i,activeLineSymbol:i}),this.addHandles([c.when(()=>t.ready,()=>{const t=this._pendingStartOptions;t&&this.start(t)},c.syncAndInitial),c.watch(()=>[this._input,this._visibleAndEditable],()=>this._update(),c.syncAndInitial),c.watch(()=>({map:t.map,graphicsLayer:this._graphicsLayer}),({map:t,graphicsLayer:e})=>{null!=t&&null!=e&&t.add(e),this._update()},c.syncAndInitial)],"main")}_detach(){this.removeHandles("main"),this._sketchVM=r.destroyMaybe(this._sketchVM),this._creationToolPromise=null,this._updateToolPromise=null;const t=this._view?.map,e=this._graphicsLayer;null!=t&&null!=e&&t.remove(e),this._graphicsLayer=r.destroyMaybe(this._graphicsLayer),this._shouldRemoveLastPoint=!1,this._set("state","ready")}_startCreationInteraction(){this._stopInteractionAndUpdate();const t=this._view,e=this._sketchVM;if(null==t||null==e)return;this._shouldRemoveLastPoint=!1;const s=e.on("create",t=>{const e=t.graphic;switch(t.state){case"complete":this._shouldRemoveLastPoint=!1,this._setSketchedGraphic(e),this._stopInteractionAndUpdate(),this._clearPreviousInput();break;case"cancel":this.cancel();break;case"active":this._setSketchedGraphic(e),"cursor-update"===t.toolEventInfo?.type&&(this._shouldRemoveLastPoint=!0);break;case"start":this._setSketchedGraphic(e)}});this.removeHandles("interaction"),this.addHandles(n.makeHandle(()=>{s.remove();const t=this.canStopCreating,o=this._geometry?.clone();e.cancel(),this._creationToolPromise=null,null!=o&&t?this._shouldRemoveLastPoint&&this._setSketchedGraphic(new i({geometry:b(o)})):this._input=null}),"interaction"),this._creationToolPromise=l.ignoreAbortErrors(e.create("polyline"))}_startReshapeInteraction(){this._stopInteraction();const t=this._view,e=this._sketchVM;if(null==t||null==e)return;const i=e.on("update",t=>{const e=t.graphics[0];switch(t.state){case"complete":this._setSketchedGraphic(e),this._stopInteractionAndUpdate(),this._clearPreviousInput();break;case"active":case"start":this._setSketchedGraphic(e)}});this.removeHandles("interaction"),this.addHandles(n.makeHandle(()=>{i.remove(),e.cancel(),this._updateToolPromise=null}),"interaction");const s=this._input;s&&(s.visible=!0,this._updateToolPromise=l.ignoreAbortErrors(e.update(s,{tool:"reshape"})))}_startSelectionInteraction(){this._stopInteraction();const t=this._view;if(null==t)return;const e=t.acquireCursor("crosshair","high");t.closePopup();let i=null;const s=n.makeHandle(()=>r.abortMaybe(i)),a=t.on("immediate-click",e=>{e.defer(async()=>{r.abortMaybe(i),i=o.createTask(async i=>{const{results:s}=await t.hitTest(e);l.throwIfAborted(i);const o=s.filter(t=>"graphic"===t.type).map(t=>t.graphic).find(t=>null!=t.geometry&&"polyline"===t.geometry.type);o&&(e.preventDefault(),e.stopPropagation(),this._input=o,this._clearPreviousInput(),this._stopInteractionAndUpdate())}),await i.promise})},g.ViewEventPriorities.TOOL),c=t.on("key-down",t=>{"Escape"===t.key&&this.cancel()});this.removeHandles("interaction"),this.addHandles([a,c,s,e],"interaction"),t.ready&&t.focus()}_stopInteraction(){this.removeHandles("interaction")}_stopInteractionAndUpdate(){this.hasHandles("interaction")&&(this._updateDisabled=!0,this._stopInteraction(),this._updateDisabled=!1,this._triggerUpdate())}_triggerUpdate(){this._set("state","ready"),this._update()}_update(){if(this._updateDisabled)return;const t=this.state;if("selecting"!==t){if(this._visibleAndEditable){if("creating"===t||"reshaping"===t&&this.isSketchedGraphic(this._input))return}else this.cancel();this._set("state",this._getNextState()),this._updateVisuals()}else this.stop()}_getNextState(){return null==this._input?"ready":this.isSketchedGraphic(this._input)?"creating"===this.state?"creating":this._visibleAndEditable?"reshaping":"reshaping-disabled":"selected"}_updateVisuals(){switch(this.state){case"creating":break;case"reshaping":this._startReshapeInteraction();break;case"reshaping-disabled":{this._stopInteractionAndUpdate();const t=this._input;null!=t&&this.isSketchedGraphic(t)&&(t.visible=!1);break}case"ready":case"selected":this._stopInteractionAndUpdate()}this._updateSketchedGraphic()}_storePreviousInput(t){this._previousInputInfo={graphic:t}}_restorePreviousInput(){const t=this._previousInputInfo;null!=t&&(this._clearPreviousInput(),this._input=t.graphic,this._triggerUpdate())}_clearPreviousInput(){this._previousInputInfo=null}_updateSketchedGraphic(){const t=this._graphicsLayer;if(null==t)return;const e=t.graphics,i=this._input;if(null!=i&&this.isSketchedGraphic(i)){if(-1===e.indexOf(i))e.removeAll(),e.add(i);else if(1!==e.length){const t=e.filter(t=>t!==i);e.removeMany(t)}}else e.removeAll()}_setSketchedGraphic(t){null!=t&&this._sketchedGraphics.add(t),this._input=t,this._updateSketchedGraphic()}},e.__decorate([h.property({nonNullable:!0})],t.ElevationProfileInteraction.prototype,"state",void 0),e.__decorate([h.property({nonNullable:!0})],t.ElevationProfileInteraction.prototype,"tool",void 0),e.__decorate([h.property()],t.ElevationProfileInteraction.prototype,"canStopCreating",null),e.__decorate([h.property()],t.ElevationProfileInteraction.prototype,"_graphicsLayer",void 0),e.__decorate([h.property()],t.ElevationProfileInteraction.prototype,"_sketchVM",void 0),e.__decorate([h.property()],t.ElevationProfileInteraction.prototype,"_input",null),e.__decorate([h.property()],t.ElevationProfileInteraction.prototype,"_geometry",null),e.__decorate([h.property()],t.ElevationProfileInteraction.prototype,"_visibleAndEditable",null),e.__decorate([h.property()],t.ElevationProfileInteraction.prototype,"_view",null),e.__decorate([h.property()],t.ElevationProfileInteraction.prototype,"_shouldRemoveLastPoint",void 0),t.ElevationProfileInteraction=e.__decorate([u.subclass("esri.widgets.ElevationProfile.ElevationProfileInteraction")],t.ElevationProfileInteraction),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});