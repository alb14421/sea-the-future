// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../Graphic","../../core/Accessor","../../core/arrayUtils","../../core/Collection","../../core/collectionUtils","../../core/Logger","../../core/LRUCache","../../core/maybe","../../core/memoize","../../core/reactiveUtils","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/decorators/subclass","../../layers/support/ElevationQueryTileCache","../../properties/defaultUnit","./ElevationProfileController","./ElevationProfileLineGround","./elevationProfileLineTypes","./ElevationProfileTool","./support/geometryUtils","./support/ProfileGenerationError","./support/profileUtils","./support/statisticsUtils"],function(e,t,i,r,o,l,n,s,a,p,u,c,h,d,y,_,f,v,g,m,b,U,P,w,C){"use strict";let E=class extends i{constructor(e){super(e),this.view=null,this.input=null,this._getEffectiveUnitsMemoized=p.memoize((e,t)=>({distance:e,elevation:t})),this.hoveredChartPosition=null,this.uniformChartScaling=!1,this.defaultUnit=null,this.queue=null,this._currentTileCache=null,this.error=null,this._defaultProfileLineGround=new g,this._userUnitOptions=null,this._userUnit=null,e?.profiles||(this.profiles=new o([this._defaultProfileLineGround]))}initialize(){this.addHandles(u.watch(()=>this.view,e=>{if(null==e)return void n.getLogger(this).warnOnce("no view. Widget will be disabled until a view is provided.");this.removeHandles(O);const t="3d"===e.type?e.resourceController:void 0;this.queue?.destroy(),this.queue=w.createProfileQueue(t?.scheduler);const i=t?.addUpdatingObject(this);i&&this.addHandles(i,O)},u.syncAndInitial)),this.tool=new b.ElevationProfileTool({viewModel:this}),this._controller=new v.ElevationProfileController({viewModel:this})}destroy(){this._defaultProfileLineGround=a.destroyMaybe(this._defaultProfileLineGround),this._controller=a.destroyMaybe(this._controller),this._currentTileCache=a.destroyMaybe(this._currentTileCache),this.tool=a.destroyMaybe(this.tool),this.queue=a.destroyMaybe(this.queue)}get profiles(){return this._get("profiles")}set profiles(e){const t=this._get("profiles"),i=e??new o;this._set("profiles",l.referenceSetter(i,t))}get state(){const e=this.view;return null!=e&&e.ready?this.tool.state:"disabled"}get progress(){let e=0,t=0;for(const i of this.visibleProfiles)e++,t+=i.progress;return e>0?t/e:0}set unitOptions(e){this._userUnitOptions=e,this._set("unitOptions",this._filteredOrAllUnits(this._userUnitOptions))}get unitOptions(){return this._filteredOrAllUnits(this._userUnitOptions)}set unit(e){this._userUnit=e?this._findSelectableUnit(e,this._userUnit):null,this.notifyChange("unit")}get unit(){return this._userUnit?(this._userUnit=this._findSelectableUnit(this._userUnit,this.defaultUnit),this._userUnit):this._findSelectableUnit(this.defaultUnit)}get effectiveUnits(){const e=C.getBoundsInMeters(this.visibleProfiles.map(e=>e.result)),t=c.adaptiveLengthUnit(e.maxDistance,"meters",this.unit),i=c.adaptiveVerticalLengthUnit(e.maxElevation,"meters",this.unit);return this._getEffectiveUnitsMemoized(t,i)}get highlightEnabled(){return this.tool.highlightEnabled}set highlightEnabled(e){this.tool.highlightEnabled=e}get hasVertices(){const e=this.input?.geometry;return U.isPolyline(e)&&e.paths.reduce((e,t)=>e+t.length,0)>0}get hoveredPoints(){return null!=this.input&&this.visible&&this.tool.editable?this.visibleProfiles.map(e=>{const t=e.hoveredPoint;return null!=t?{hoveredPoint:t,color:e.color}:null}).filter(r.isSome):[]}get statistics(){return C.mergeStatistics(this.visibleProfiles.map(e=>e.statistics))}get chartData(){if(null==this.input)return null;const{effectiveUnits:e,progress:t,statistics:i,visibleProfiles:r,uniformChartScaling:o}=this,l=r.filter(e=>e.hasZ).map(e=>({id:e.id,type:e.type,title:e.title,color:e.color,samples:e.samples,progress:e.progress,chartFillEnabled:e.chartFillEnabled,chartStrokeWidth:e.chartStrokeWidth,chartStrokeOffsetY:e.chartStrokeOffsetY,viewVisualizationEnabled:e.viewVisualizationEnabled}));return 0===l.length?null:{lines:l,effectiveUnits:e,statistics:i,refined:1===t,dynamicElevationRange:r.some(e=>"view"===e.type),uniformScaling:o}}get visibleProfiles(){return this.profiles.toArray().filter(e=>e.available&&e.visible)}get minDemResolutions(){const e=[];for(const{minDemResolution:t}of this.visibleProfiles)null!=t&&e.push(t);return e}get minDemResolution(){return r.min(this.minDemResolutions)}get errorState(){const e=this.input?.geometry;if(!U.isValidInputPath(e))return"no-valid-input";if(null!=this.error){if(P.isProfileGenerationError(this.error))switch(this.error.cause){case"too-complex":return"too-complex";case"invalid-geometry":return"invalid-geometry";case"invalid-elevation-info":return"invalid-elevation-info";case"elevation-query-error":return"no-valid-input"}return"unknown-error"}return 0===this.visibleProfiles.length?"no-visible-profiles":null==this.chartData&&1===this.progress?"refined-but-no-chart-data":"none"}get tileCache(){this._currentTileCache=a.destroyMaybe(this._currentTileCache);const e=this.view;if(null!=e&&"3d"===e?.type){const t=e.basemapTerrain?.elevationQueryCache;if(null!=t)return t}return null==this._currentTileCache&&(this._currentTileCache=new _.ElevationQueryTileCache(new s.LRUCache(20971520))),this._currentTileCache}get visible(){return this.tool.visible}set visible(e){this.tool.visible=e}get selectAvailable(){for(const e of this.view?.map?.allLayers??[]){if("graphics"===e.type&&!e.internal&&e.graphics.some(e=>"polyline"===e.geometry?.type))return!0;if("geometryType"in e&&"polyline"===e.geometryType)return!0}return!!this.view?.graphics?.some(e=>"polyline"===e.geometry?.type)}get inputIsSketched(){return this.tool.interaction.isSketchedGraphic(this.input)}get elevationProvider(){const e=this.view;return null!=e&&"3d"===e.type?e.elevationProvider:null}get updating(){const{progress:e}=this,t=!!this.queue?.updating;return e>0&&e<1||t}start(e){this.tool.interaction.start(e)}stop(){this.tool.interaction.stop()}cancel(){this.tool.interaction.cancel()}clear(){this.tool.interaction.clear()}_findSelectableUnit(e,t){const i=this.unitOptions;return null!=e&&i.includes(e)?e:t?this._findSelectableUnit(t):i[0]}_filteredOrAllUnits(e){const t=(null!=e?e:[]).filter(e=>c.measurementLengthUnits.includes(e));return 0===t.length?c.measurementLengthUnits.slice():t}};e.__decorate([h.property()],E.prototype,"view",void 0),e.__decorate([h.property({type:t})],E.prototype,"input",void 0),e.__decorate([h.property({type:m.ElevationProfileLineCollection,nonNullable:!0})],E.prototype,"profiles",null),e.__decorate([h.property({readOnly:!0})],E.prototype,"state",null),e.__decorate([h.property({readOnly:!0})],E.prototype,"progress",null),e.__decorate([h.property()],E.prototype,"unitOptions",null),e.__decorate([h.property()],E.prototype,"unit",null),e.__decorate([h.property({readOnly:!0})],E.prototype,"effectiveUnits",null),e.__decorate([h.property()],E.prototype,"hoveredChartPosition",void 0),e.__decorate([h.property()],E.prototype,"uniformChartScaling",void 0),e.__decorate([h.property()],E.prototype,"highlightEnabled",null),e.__decorate([h.property({readOnly:!0})],E.prototype,"hoveredPoints",null),e.__decorate([h.property({readOnly:!0})],E.prototype,"statistics",null),e.__decorate([h.property()],E.prototype,"chartData",null),e.__decorate([h.property()],E.prototype,"visibleProfiles",null),e.__decorate([h.property()],E.prototype,"minDemResolutions",null),e.__decorate([h.property({readOnly:!0})],E.prototype,"minDemResolution",null),e.__decorate([h.property({readOnly:!0})],E.prototype,"errorState",null),e.__decorate([h.property(f.defaultUnitPropertyMetadata)],E.prototype,"defaultUnit",void 0),e.__decorate([h.property()],E.prototype,"queue",void 0),e.__decorate([h.property()],E.prototype,"tileCache",null),e.__decorate([h.property()],E.prototype,"tool",void 0),e.__decorate([h.property()],E.prototype,"visible",null),e.__decorate([h.property()],E.prototype,"error",void 0),e.__decorate([h.property()],E.prototype,"selectAvailable",null),e.__decorate([h.property()],E.prototype,"inputIsSketched",null),e.__decorate([h.property()],E.prototype,"elevationProvider",null),e.__decorate([h.property()],E.prototype,"updating",null),e.__decorate([h.property()],E.prototype,"_defaultProfileLineGround",void 0),e.__decorate([h.property()],E.prototype,"_userUnitOptions",void 0),e.__decorate([h.property()],E.prototype,"_controller",void 0),e.__decorate([h.property()],E.prototype,"_userUnit",void 0),E=e.__decorate([y.subclass("esri.widgets.ElevationProfile.ElevationProfileViewModel")],E);const O=Symbol("updating-object");return E});