// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../chunks/tslib.es6","../core/arrayUtils","../core/Collection","../core/events","../core/handleUtils","../core/maybe","../core/promiseUtils","../core/reactiveUtils","../core/string","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/accessorSupport/decorators/subclass","../intl/locale","../portal/Portal","../properties/defaultUnit","../rest/support/Stop","../symbols/SimpleMarkerSymbol","./Search","./Widget","./Directions/css","./Directions/DirectionsSearchTool","./Directions/DirectionsViewModel","./Directions/DirectionsVisibleElements","./Directions/support/directionsUtils","./Search/support/locatorUtils","../chunks/componentsUtils","./support/globalCss","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],function(e,t,s,i,o,r,n,a,l,c,d,h,u,p,m,v,_,g,w,y,x,b,S,k,f,D,C,M,I,T,P,F){"use strict";function E(e){const{branchName:t,displayText:i,exitName:o,intersectingName:r,name:n,towardName:a}=e;if(null==i)return null;const l=[t,o,r,n,a].filter(s.isSome).sort((e,t)=>t.length-e.length).map(e=>c.escapeRegExpString(e));if(!l.length)return i;const d=new RegExp(l.join("|"),"g"),h=i.matchAll(d);let u=0;const p=[];for(const{0:e,index:t}of h)p.push(i.slice(u,t),F.tsx("span",{class:b.css.labelEmphasize,key:`maneuver-${t}`},e)),u=t+e.length;return p.push(i.slice(u)),F.tsx("span",null,p)}let L=class extends x{constructor(e,t){super(e,t),this._activeManeuver=null,this._placeholderStops=new i([new g,new g]),this._portalFolderCombobox=null,this._portalFolders=null,this._portalItemNameInput=null,this._portalUserName=null,this._printDocument=null,this._printDocumentParent=null,this._sections=null,this._stopsToSearches=new Map,this._printDocumentOpen=!1,this._currentFlowItem="primary",this._parentFlowItem="primary",this._saveState="initialized",this._searchTool=null,this.headingLevel=2,this.messages=null,this.messagesUnits=null,this.searchProperties={popupEnabled:!1,resultGraphicEnabled:!1},this.viewModel=new k,this.visibleElements=new f,this._solveRouteDebounced=a.debounce(()=>this._solveRoute())}initialize(){this.addHandles([l.watch(()=>this.viewModel.layer,()=>{try{this.viewModel.load()}catch{}},l.initial),l.watch(()=>this.viewModel.layer?.routeInfo,()=>{this._sections=this._getStopSections()},l.initial),l.watch(()=>this.viewModel.layer?.stops.toArray(),e=>{e&&this.view?.activeTool&&this._searchTool&&this.view.activeTool===this._searchTool&&!e.includes(this._searchTool.stop)&&(this.view.tools.remove(this._searchTool),this._searchTool=null)}),o.addEventListener(window,"beforeprint",this._beforePrint.bind(this)),o.addEventListener(window,"afterprint",this._afterPrint.bind(this))])}loadDependencies(){return M.loadCalciteComponents({accordion:()=>new Promise((t,s)=>e(["../chunks/index48"],t,s)),"accordion-item":()=>new Promise((t,s)=>e(["../chunks/index49"],t,s)),action:()=>new Promise((t,s)=>e(["../chunks/index12"],t,s)),"action-menu":()=>new Promise((t,s)=>e(["../chunks/index19"],t,s)).then(e=>e.index),"block-section":()=>new Promise((t,s)=>e(["../chunks/index50"],t,s)),button:()=>new Promise((t,s)=>e(["../chunks/index2"],t,s)),combobox:()=>new Promise((t,s)=>e(["../chunks/index21"],t,s)),"combobox-item":()=>new Promise((t,s)=>e(["../chunks/index22"],t,s)),flow:()=>new Promise((t,s)=>e(["../chunks/index14"],t,s)),"flow-item":()=>new Promise((t,s)=>e(["../chunks/index15"],t,s)),icon:()=>new Promise((t,s)=>e(["../chunks/index7"],t,s)),input:()=>new Promise((t,s)=>e(["../chunks/index4"],t,s)),"input-date-picker":()=>new Promise((t,s)=>e(["../chunks/index27"],t,s)),"input-time-picker":()=>new Promise((t,s)=>e(["../chunks/index29"],t,s)),label:()=>new Promise((t,s)=>e(["../chunks/index5"],t,s)),list:()=>new Promise((t,s)=>e(["../chunks/index16"],t,s)),"list-item":()=>new Promise((t,s)=>e(["../chunks/index20"],t,s)),loader:()=>new Promise((t,s)=>e(["../chunks/index32"],t,s)),notice:()=>new Promise((t,s)=>e(["../chunks/index6"],t,s)),panel:()=>new Promise((t,s)=>e(["../chunks/index51"],t,s)).then(e=>e.index),switch:()=>new Promise((t,s)=>e(["../chunks/index33"],t,s))})}destroy(){this._stopsToSearches.forEach(n.destroyMaybe)}get apiKey(){return this.viewModel.apiKey}set apiKey(e){this.viewModel.apiKey=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get icon(){return"right"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get lastRoute(){return this.viewModel.lastRoute}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get maxStops(){return this.viewModel.maxStops}set maxStops(e){this.viewModel.maxStops=e}get unit(){return this.defaultUnit}set unit(e){this._overrideIfSome("unit",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}acquireSearch(e){const{view:t}=this.viewModel;if(this._stopsToSearches.has(e)){const s=this._stopsToSearches.get(e);return s.view=t,this._overrideDefaultSources(s),s}const s=new y({icon:"",popupEnabled:!1,resultGraphicEnabled:!1,view:t,...this.searchProperties});return this._normalizeSearchSources(s),this.addHandles([l.on(()=>s.allSources,"change",()=>this._normalizeSearchSources(s)),s.on("search-clear",()=>{e.geometry=null,e.name=null,this.viewModel.layer?.removeResult()}),s.on("select-result",()=>{const t=s.selectedResult;e.geometry=t?.feature.geometry,e.name=t?.name,this._solveRouteDebounced()}),l.watch(()=>s.searchTerm,t=>{e.name=t}),m.onLocaleChange(()=>this._normalizeSearchSources(s))],s),this._stopsToSearches.set(e,s),s}getDirections(){return this.viewModel.getDirections()}render(){return F.tsx("div",{class:this.classes(b.css.base,I.globalCss.widget,I.globalCss.panel)},F.tsx("calcite-flow",null,this._renderPrimaryFlowItem(),this._renderDirectionsFlowItem(),this._renderEditFlowItem(),this._renderSaveFlowItem()),this._renderPrintDocument())}save(){return this.viewModel.save()}saveAs(e,t={}){return this.viewModel.saveAs(e,t)}zoomToRoute(){return this.viewModel.zoomToRoute()}_afterPrint(){this._printDocumentOpen&&this._printDocument&&this._printDocumentParent?.appendChild(this._printDocument)}_applyLocatorSourceOverrides({allSources:e}){for(const t of e)"url"in t&&t.url&&(t.language=m.getLocaleLanguage(),t.locationType??="street",C.isArcGISWorldGeocoder(t.url)&&this.apiKey&&null==t.apiKey&&(t.apiKey=this.apiKey,t.url=C.meteredArcGISLocatorUrl))}_beforePrint(){this._printDocumentOpen&&this._printDocument&&document.body.appendChild(this._printDocument)}_disposeSearch(e){if(!e||!this._stopsToSearches.has(e))return;const t=this._stopsToSearches.get(e);this.removeHandles(t),t.destroy(),this._stopsToSearches.delete(e)}_getEffectiveStops(){return this.viewModel.layer?.stops??this._placeholderStops}_getErrorDescription(){switch(this.viewModel.lastError?.name){case"directions-view-model:unable-to-route":return this.messages.errors.unableToRoute;case"directions-view-model:service-metadata-unavailable":return this.messages.errors.unableToLoadServiceMetadata;default:return this.messages.errors.unknownError}}_getNetworkFeatureName(e){switch(e.type){case"stop":switch(e.locationType){case"stop":default:return this.messages.networkFeatures.stops.stop;case"waypoint":return this.messages.networkFeatures.stops.waypoint;case"break":return this.messages.networkFeatures.stops.break}case"point-barrier":return this.messages.networkFeatures.pointBarrier;case"polyline-barrier":return this.messages.networkFeatures.polylineBarrier;case"polygon-barrier":return this.messages.networkFeatures.polygonBarrier}}_getRouteCostSummary(){const e=this.viewModel.layer?.routeInfo;if(!e)return null;const t=e.totalDistance??0,s=e.totalDuration??0,{messagesUnits:i,unit:o}=this;return{distance:D.formatDistance(i,t,o),duration:D.formatDuration(s)}}_getStopCostDescription(e){if(!e.directions.length)return;const{totalDistance:t,totalDuration:s}=e.directions.reduce((e,{lines:t})=>{for(const{distance:s,duration:i}of t)e.totalDistance+=s??0,e.totalDuration+=i??0;return e},{totalDistance:0,totalDuration:0}),{messagesUnits:i,unit:o}=this,r=D.formatDistance(i,t,o);return`${D.formatDuration(s)} (${r})`}_getStopSections(){if(!this.viewModel.layer)return null;const{directionPoints:e,directionLines:t,stops:s}=this.viewModel.layer;if(!e||!t)return null;const i=[];let o=null;for(const r of e){const{objectId:e,stopId:n}=r;if(null!=n){const e=s.find(({objectId:e})=>e===n);o&&o.stop===e||(o={stop:e,directions:[]},i.push(o));continue}if(null==o)continue;const a=t.toArray().filter(({directionPointId:t})=>t===e);0!==a.length&&o.directions.push({directionPoint:r,lines:a})}return i}_handleAddStopClick(){const e=new w;this.viewModel.layer?.stops.add(new g({symbol:e}))}_handleAutoSolveChange({target:e}){this.viewModel.autoSolve=e.checked}_handleCreatePolylineBarrierClick(){this.viewModel.create("polyline-barrier")}_handleClearRouteClick(){this._currentFlowItem="primary",this.viewModel.reset()}_handleCreateStopClick(){this.viewModel.create("stop")}_handleDeleteNetworkFeatureClick(e){this.viewModel.remove(e),this.viewModel.autoSolve&&this._solveRouteDebounced()}_handleDeleteStopClick(e){this._getEffectiveStops().remove(e),this._disposeSearch(e),this._solveRouteDebounced()}_handleDepartureDateChange({currentTarget:{value:e}}){Array.isArray(e)||(this.viewModel.departureIsoDate=e,this._solveRouteDebounced())}_handleDepartureTimeChange({currentTarget:{value:e}}){this.viewModel.departureIsoTime=e,this._solveRouteDebounced()}_handleDepartureTimeOptionChange({currentTarget:e}){const{selectedItems:t}=e;t.length&&(this.viewModel.departureOption=t[0].value,this._solveRouteDebounced())}_handleDirectionsFlowItemBackClick(e){e.stopPropagation(),this._currentFlowItem="primary"}_handleDirectionTurnItemSelect(e){this._activeManeuver===e?this.zoomToRoute():(this._activeManeuver=e,this.viewModel.centerAt(e.geometry))}_handleDirectionTurnPointerEnter(e){this.viewModel.highlight(e)}_handleDirectionTurnPointerLeave(){this.viewModel.clearHighlights()}_handleEditFlowItemBackClick(e){e.stopPropagation(),this.viewModel.stopEditing(),this._currentFlowItem="primary"}_handleEditingDoneClick(){this.viewModel.stopEditing(),this._currentFlowItem="primary"}_handleEditRouteClick(){this._currentFlowItem="edit",this.viewModel.startEditing()}_handleItemDetailsClick(){const e=this.viewModel.layer?.portalItem;e&&window.open(`${e.portal.url}/home/item.html?id=${e.id}`,"_blank")}_handleLocateStopClick(e){const{view:t}=this;if(!t)return;const s="directions-search-tool";this.removeHandles(s),this._searchTool=new S.DirectionsSearchTool({stop:e,view:t}),this.addHandles([this._searchTool.on("click",async t=>{if(t.mapPoint&&this._stopsToSearches.has(e)){const s=this._stopsToSearches.get(e),i=await s.search(t.mapPoint),o=i?.results?.[0].results?.[0];if(o){const{feature:t,name:i}=o;s.searchTerm=i,e.geometry=t.geometry}}this.removeHandles(s)}),r.makeHandle(()=>{this._searchTool&&(this.view?.tools.remove(this._searchTool),this._searchTool=null)})],s),t.addAndActivateTool(this._searchTool)}_handleOptimizeStopOrderToggle({target:{expanded:e}}){this.viewModel.routeParameters.findBestSequence=e,this._solveRouteDebounced()}_handlePanToStopClick(e){this.viewModel.centerAt(e)}_handlePreserveFirstStopChange({target:{checked:e}}){this.viewModel.routeParameters.preserveFirstStop=e,this._solveRouteDebounced()}_handlePreserveLastStopChange({target:{checked:e}}){this.viewModel.routeParameters.preserveLastStop=e,this._solveRouteDebounced()}_handlePrintDocumentAfterCreate(e){e.focus(),this._printDocument=e,this._printDocumentParent=e.parentElement}_handlePrintDocumentClick(){this._printDocumentOpen=!0}_handlePrintDocumentCloseClick(){this._printDocumentOpen=!1}_handlePrintDocumentKeyDown(e){"Escape"===e.key&&(this._printDocumentOpen=!1)}_handlePrintDocumentPrintClick(){document.body.classList.add(b.css.printMedia),window.print(),document.body.classList.remove(b.css.printMedia)}_handleResolveRouteClick(){this._solveRouteDebounced()}_handleReverseStopOrderClick(){this._getEffectiveStops().reverse(),this._solveRouteDebounced()}_handleSaveErrorCloseClick(){this._currentFlowItem=this._parentFlowItem}_handleSaveFlowItemBackClick(e){e.stopPropagation(),this._currentFlowItem=this._parentFlowItem}async _handleSaveLayerAs(){const e=v.getDefault();try{await e.signIn()}catch(e){if(a.isAbortError(e)||"identity-manager:user-aborted"===e.name)return;return this._parentFlowItem=this._currentFlowItem,this._currentFlowItem="save",void(this._saveState="connect-to-portal-error")}this._saveState="fetch-portal-information",this._parentFlowItem=this._currentFlowItem,this._currentFlowItem="save",this._portalUserName=e.user?.username;try{this._portalFolders=await(e.user?.fetchFolders())}catch{return void(this._saveState="fetch-portal-information-error")}this._saveState="save-layer"}_handleSaveLayerClick(){this.viewModel.layer?.save()}_handleSaveLayerButtonClick(){this._saveState="saving";const{layer:e}=this;if(!e||!this._portalFolders)return;const t=this._portalItemNameInput?.value,s=this._portalFolderCombobox?.value,i=this._portalFolders.find(({id:e})=>e===s);e.saveAs({title:t},{folder:i}).then(()=>{e.title=t,this._currentFlowItem=this._parentFlowItem}).catch(()=>{this._saveState="saving-error"})}_handleSaveLayerCancelClick(){this._currentFlowItem=this._parentFlowItem}_handleSaveLayerFolderCreate(e){this._portalFolderCombobox=e}_handleSaveLayerNameCreate(e){this._portalItemNameInput=e}_handleSignInClick(){this.viewModel.load().catch(()=>{})}_handleStopListReorder({detail:{dragEl:e,newIndex:t}}){this._getEffectiveStops().reorder(e.value,t),this._solveRouteDebounced()}_handleTravelModeChange({currentTarget:{selectedItems:e}}){e.length&&(this.viewModel.selectedTravelMode=e[0].value,this._solveRouteDebounced())}_handleViewDrivingDirectionsClick(){this._currentFlowItem="directions"}_normalizeSearchSources(e){this._overrideDefaultSources(e),this._applyLocatorSourceOverrides(e)}_overrideDefaultSources(e){for(const t of e.viewModel.defaultSources)t.autoNavigate=!1}_renderClearRouteAction(e){return F.tsx("calcite-action",{bind:this,icon:"trash",key:"clear-route",onclick:this._handleClearRouteClick,...e,text:this.messages.common.clear,textEnabled:!0})}_renderDeleteStopAction(e){return F.tsx("calcite-action",{icon:"trash",onclick:this._handleDeleteStopClick.bind(this,e),scale:"s",slot:"actions-end",text:this.messages.deleteStop,title:this.messages.deleteStop})}_renderDepartureTime(){const{DEPART_AT:e,NOW:t,UNSPECIFIED:s}=D.DepartureTimeOption;return F.tsx("calcite-label",{class:b.css.departureTime,key:"departure-time"},this.messages.departureTime,F.tsx("calcite-combobox",{bind:this,clearDisabled:!0,label:this.messages.departureTime,overlayPositioning:"fixed",selectionMode:"single-persist",onCalciteComboboxChange:this._handleDepartureTimeOptionChange},F.tsx("calcite-combobox-item",{heading:this.messages.leaveNow,key:t,label:this.messages.leaveNow,selected:this.viewModel.departureOption===t,value:t}),F.tsx("calcite-combobox-item",{heading:this.messages.departAt,key:e,label:this.messages.departAt,selected:this.viewModel.departureOption===e,value:e}),F.tsx("calcite-combobox-item",{heading:this.messages.timeUnspecified,key:s,label:this.messages.timeUnspecified,selected:this.viewModel.departureOption===s,value:s})))}_renderDepartureTimeOptions(){return this.viewModel.departureOption!==D.DepartureTimeOption.DEPART_AT?null:F.tsx("div",{class:b.css.departureTimeOptions},F.tsx("calcite-input-date-picker",{bind:this,scale:"s",value:this.viewModel.departureIsoDate,onCalciteInputDatePickerChange:this._handleDepartureDateChange}),F.tsx("calcite-input-time-picker",{bind:this,scale:"s",value:this.viewModel.departureIsoTime,onCalciteInputTimePickerClose:this._handleDepartureTimeChange}))}_renderDirectionsFlowItem(){if("directions"!==this._currentFlowItem)return null;const e=this._getRouteCostSummary();if(!this._sections||!e)return null;const{distance:t,duration:s}=e,{formattedEta:i}=this.viewModel,o=this._sections.at(0)?.stop.name??"",r=this._sections.at(-1)?.stop.name??"";return F.tsx("calcite-flow-item",{bind:this,key:"directions-flow-item",overlayPositioning:"fixed",selected:"directions"===this._currentFlowItem,onCalciteFlowItemBack:this._handleDirectionsFlowItemBackClick},F.tsx("div",{class:b.css.directionsHeader,slot:"header-content"},F.tsx("div",{class:b.css.headerStops},F.tsx("span",null,this.messages.from)," ",F.tsx("span",{class:b.css.directionsHeaderStopName},o),F.tsx("span",null,this.messages.to)," ",F.tsx("span",{class:b.css.directionsHeaderStopName},r)),F.tsx("div",{class:b.css.flexColumn},F.tsx("span",null,`${s} (${t})`),i?F.tsx("span",null,i):null)),this._renderRouteLayerActions({slot:"header-menu-actions"}),F.tsx("calcite-accordion",{class:b.css.accordion,iconPosition:"start",selectionMode:"single"},this._sections.map((e,t)=>this._renderDirectionSection(e,t))))}_renderDirectionSection(e,t){const{stop:s,directions:i}=e,{name:o}=s,r=0===t,n=this._getStopCostDescription(e);return F.tsx("calcite-accordion-item",{description:n,expanded:r,heading:o??"",key:`stop-${t}`},F.tsx("calcite-action",{icon:"zoom-to-object",onclick:this._handlePanToStopClick.bind(this,s),slot:"actions-end",text:this.messages.panToStop,title:this.messages.panToStop}),this._renderDirectionTurns(i))}_renderDirectionTurns(e){return F.tsx("calcite-list",{label:this.messages.drivingDirections,selectionMode:"none"},e.map((e,t)=>{const{directionPoint:s,lines:i}=e,o=i[0],{distance:r,duration:n}=o,a=D.formatDistance(this.messagesUnits,r??0,this.unit),l=D.formatDuration(n??0),c=a&&l?`${a} | ${l}`:`${a||l}`,d=E(s),h=D.getIconName(s.directionPointType);return F.tsx("calcite-list-item",{class:b.css.labelNoBottomMargin,key:`driving-direction-${t}`,onpointerenter:this._handleDirectionTurnPointerEnter.bind(this,o),onpointerleave:this._handleDirectionTurnPointerLeave.bind(this),onCalciteListItemSelect:this._handleDirectionTurnItemSelect.bind(this,o)},F.tsx("calcite-icon",{icon:h,slot:"content-start"}),F.tsx("div",{slot:"content"},F.tsx("calcite-label",{layout:"inline",scale:"s"},d),F.tsx("calcite-label",{layout:"inline",scale:"s"},c)))}))}_renderEditFlowItem(){return"edit"!==this._currentFlowItem?null:F.tsx("calcite-flow-item",{bind:this,heading:this.messages.editRoute,headingLevel:this.headingLevel,key:"edit-flow-item",loading:"routing"===this.viewModel.state,selected:"edit"===this._currentFlowItem,onCalciteFlowItemBack:this._handleEditFlowItemBackClick},F.tsx("div",{class:b.css.flexColumn,key:"edit-container"},F.tsx("div",{class:b.css.editToolbarContainer},F.tsx("calcite-label",{layout:"inline",scale:"s"},this.messages.automaticallySolve,F.tsx("calcite-switch",{bind:this,checked:this.viewModel.autoSolve,scale:"s",onCalciteSwitchChange:this._handleAutoSolveChange})),F.tsx("div",{class:b.css.editToolbar},F.tsx("calcite-action",{bind:this,disabled:!this.viewModel.layer||this.viewModel.layer.stops.length>=this.maxStops,icon:"flag",onclick:this._handleCreateStopClick,scale:"s",text:this.messages.networkFeatures.stops.stop,textEnabled:!0}),F.tsx("calcite-action",{bind:this,icon:"line",onclick:this._handleCreatePolylineBarrierClick,scale:"s",text:this.messages.barrier,textEnabled:!0}),F.tsx("calcite-action",{bind:this,class:b.css.solveRoute,disabled:this.viewModel.autoSolve,icon:"refresh",onclick:this._handleResolveRouteClick,scale:"s",text:this.messages.solve,textEnabled:!0}))),F.tsx("div",{class:b.css.selectedFeatureContainer},F.tsx("calcite-list",{label:this.messages.selectedNetworkFeatures,scale:"s",selectionMode:"none"},this.viewModel.selectedNetworkFeatures?.toArray().map((e,t)=>F.tsx("calcite-list-item",{description:this._getNetworkFeatureName(e),key:`network-feature-${t}`,label:e.name??e.objectId?.toString()??this.messages.unnamed},F.tsx("calcite-action",{icon:"trash",onclick:this._handleDeleteNetworkFeatureClick.bind(this,e),scale:"s",slot:"actions-end",text:this.messages.common.delete}))))),F.tsx("div",{class:b.css.editFooter},this._renderEditFooterContent())))}_renderEditFooterContent(){return this.viewModel.lastError?this._renderErrorNotice():F.tsx("calcite-button",{appearance:"outline-fill",bind:this,onclick:this._handleEditingDoneClick,width:"full"},this.messages.common.done)}_renderErrorNotice(){return F.tsx("calcite-notice",{icon:"exclamation-mark-circle",kind:"danger",open:!0},F.tsx("calcite-label",{class:b.css.labelNoBottomMargin,slot:"message"},this._getErrorDescription()))}_renderFooter(){if(!this.viewModel.layer)return F.tsx("div",{class:b.css.primaryFooter,key:"footer-missing-layer"},F.tsx("calcite-notice",{icon:"information",open:!0},F.tsx("calcite-label",{class:b.css.labelNoBottomMargin,slot:"message"},this.messages.missingLayer)));if("unauthenticated"===this.viewModel.state)return F.tsx("div",{class:b.css.primaryFooterCentered,key:"footer-sign-in"},F.tsx("calcite-label",null,this.messages.signInRequired),F.tsx("calcite-button",{bind:this,onclick:this._handleSignInClick},this.messages.common.auth.signIn));if("routing"===this.viewModel.state)return F.tsx("div",{class:this.classes(b.css.primaryFooter,b.css.primaryFooterLoader),key:"footer-routing"},F.tsx("calcite-loader",{label:this.messages.solve,scale:"s"}));if("error"===this.viewModel.state)return F.tsx("div",{class:b.css.primaryFooter,key:"footer-service-error"},this._renderErrorNotice());if(!this.viewModel.layer?.routeInfo)return F.tsx("div",{class:b.css.primaryFooter,key:"footer-unsolved-route"},F.tsx("calcite-notice",{icon:"information",open:!0},F.tsx("calcite-label",{class:b.css.labelNoBottomMargin,slot:"message"},this.messages.directionsPlaceholder)));const e=this._getRouteCostSummary();if(!e||!this.viewModel.layer?.directionPoints)return F.tsx("div",{class:b.css.primaryFooter,key:"footer-invalid-route"},F.tsx("calcite-notice",{icon:"exclamation-mark-triangle",kind:"danger",open:!0},F.tsx("calcite-label",{class:b.css.labelNoBottomMargin,slot:"message"},this.messages.invalidRoute)));const{distance:t,duration:s}=e,{formattedEta:i}=this.viewModel;return F.tsx("div",{class:b.css.routeItem,key:"footer-directions-summary"},F.tsx("button",{"aria-busy":"false","aria-label":this.messages.viewDrivingDirections,"aria-live":"polite",bind:this,class:b.css.routeItemButton,onclick:this._handleViewDrivingDirectionsClick,title:this.messages.viewDrivingDirections,type:"button"},F.tsx("div",{class:b.css.routeItemButtonContent},F.tsx("span",{class:b.css.routeItemLabel},`${s} (${t})`),F.tsx("span",{class:b.css.routeItemDescription},i)),F.tsx("calcite-icon",{flipRtl:!0,icon:"chevron-right",scale:"s"})),F.tsx("calcite-action-menu",{label:"test"},F.tsx("calcite-action",{icon:"ellipsis",key:"route-actions",slot:"trigger",text:"Route actions"}),this._renderRouteLayerActions()))}_renderInteractiveRouteActions(){return F.tsx("div",{class:b.css.actionContainer,key:b.css.actionContainer},F.tsx("calcite-button",{appearance:"outline",bind:this,class:b.css.addStopButton,disabled:this._getEffectiveStops().length>=this.maxStops,iconStart:"plus",kind:"neutral",label:this.messages.addStop,onclick:this._handleAddStopClick,title:this.messages.addStop,width:"half"},this.messages.addStop),this.visibleElements.editRouteButton?F.tsx("calcite-button",{appearance:"outline",bind:this,class:b.css.editRouteButton,disabled:"2d"!==this.viewModel.view?.type,iconStart:"pencil",kind:"neutral",label:this.messages.editRoute,onclick:this._handleEditRouteClick,title:this.messages.editRoute,width:"half"},this.messages.editRoute):null)}_renderLocateStopAction(e){if(null!=e.name||null!=e.geometry)return null;const t=this._getEffectiveStops().indexOf(e),s=!!this.view?.activeTool&&this.view.activeTool===this._searchTool&&this._searchTool.stop===e;return F.tsx("calcite-action",{active:s,icon:"crosshair",key:`stop-location-action-${t}`,onclick:this._handleLocateStopClick.bind(this,e),scale:"s",slot:"actions-end",text:this.messages.pickALocationOnTheMap,title:this.messages.pickALocationOnTheMap})}_renderOptimizeStopOrder(){const{routeParameters:e}=this.viewModel,{findBestSequence:t,preserveFirstStop:s,preserveLastStop:i}=e;return F.tsx("calcite-block-section",{bind:this,class:b.css.optimizeSection,text:this.messages.optimizeOrder,toggleDisplay:"switch",onCalciteBlockSectionToggle:this._handleOptimizeStopOrderToggle},t?[F.tsx("calcite-label",{class:b.css.optimizeSwitches,key:"preserve-first-stop",layout:"inline-space-between"},this.messages.preserveFirstStop,F.tsx("calcite-switch",{bind:this,checked:s,scale:"s",onCalciteSwitchChange:this._handlePreserveFirstStopChange})),F.tsx("calcite-label",{class:b.css.optimizeSwitches,key:"preserve-last-stop",layout:"inline-space-between"},this.messages.preserveLastStop,F.tsx("calcite-switch",{bind:this,checked:i,scale:"s",onCalciteSwitchChange:this._handlePreserveLastStopChange}))]:null)}_renderPrimaryFlowItem(){return F.tsx("calcite-flow-item",{key:"primary-flow-item",loading:"initializing"===this.viewModel.state,selected:"primary"===this._currentFlowItem},F.tsx("calcite-panel",{class:b.css.primaryFlowItem,disabled:!this.viewModel.layer||"unauthenticated"===this.viewModel.state||"error"===this.viewModel.state&&!this.viewModel.serviceDescription},this._renderStops(),this._renderInteractiveRouteActions(),this._renderSeparator(),this._renderRouteSolveOptions()),this._renderFooter())}_renderPrintDocument(){if(!this._printDocumentOpen)return null;const e=this._getRouteCostSummary();if(!this._sections||!e)return null;const{distance:t,duration:s}=e,{formattedEta:i}=this.viewModel,o=this._sections.at(0)?.stop.name??"",r=this._sections.at(-1)?.stop.name??"";return F.tsx("div",{afterCreate:this._handlePrintDocumentAfterCreate,bind:this,class:b.css.printDocument,onkeydown:this._handlePrintDocumentKeyDown,tabindex:0},F.tsx("div",{class:b.css.printBody},F.tsx("div",{class:b.css.printHeader},F.tsx("div",{class:b.css.printHeaderLabel},F.tsx("div",{class:b.css.headerStops},F.tsx("span",null,this.messages.from)," ",F.tsx("span",{class:b.css.directionsHeaderStopName},o),F.tsx("span",null,this.messages.to)," ",F.tsx("span",{class:b.css.directionsHeaderStopName},r))),F.tsx("div",{class:this.classes(b.css.printHeaderButtons,b.css.printHideOnPrint)},F.tsx("calcite-button",{class:b.css.printDocumentPrint,iconStart:"print",onclick:this._handlePrintDocumentPrintClick},this.messages.common.print),F.tsx("calcite-button",{appearance:"outline",bind:this,class:b.css.printDocumentClose,iconStart:"x-circle",onclick:this._handlePrintDocumentCloseClick},this.messages.common.close))),F.tsx("div",{class:b.css.directionsHeader},F.tsx("span",null,`${s} (${t})`),i?F.tsx("span",null,i):null),this._sections.map((e,t)=>this._renderPrintSection(e,t))))}_renderPrintManuever(e,t){const{directionPoint:s,lines:i}=e,{distance:o,duration:r}=i.at(0)??{},n=D.formatDistance(this.messagesUnits,o??0,this.unit),a=D.formatDuration(r??0),l=n&&a?`${n} | ${a}`:`${n||a}`,c=E(s),d=D.getIconName(s.directionPointType);return F.tsx("div",{class:this.classes(b.css.flexRow,b.css.printAvoidPageBreak),key:`direction-${t}`},F.tsx("calcite-icon",{icon:d}),F.tsx("div",{class:b.css.flexColumn},F.tsx("span",null,c),F.tsx("span",null,l)))}_renderPrintRouteAction(e){if(!this.visibleElements.printButton)return null;const t=!this.viewModel.layer?.routeInfo;return F.tsx("calcite-action",{bind:this,disabled:t,icon:"print",key:"print-route",onclick:this._handlePrintDocumentClick,...e,text:this.messages.common.print,textEnabled:!0})}_renderPrintSection({stop:e,directions:t},s){return F.tsx("div",{class:b.css.printSection,key:`section-${s}`},F.tsx("span",{class:b.css.directionsHeaderStopName},e.name??""),t.map((e,t)=>this._renderPrintManuever(e,t)))}_renderRouteLayerActions(e){return[this._renderClearRouteAction(e),this._renderSaveLayerAction(e),this._renderSaveLayerAsAction(e),this._renderPrintRouteAction(e),this._renderViewItemDetailsAction(e)]}_renderRouteSolveOptions(){return F.tsx("div",{class:b.css.marginInlineMedium,key:"route-solve-options"},this._renderTravelModes(),this._renderDepartureTime(),this._renderDepartureTimeOptions(),this._renderOptimizeStopOrder())}_renderSaveContent(){switch(this._saveState){case"initialized":return this._renderSaveInitialized();case"connect-to-portal":return this._renderSaveProcessing(this.messages.identity.lblSigning);case"connect-to-portal-error":return this._renderSaveError(this.messages.errors.authenticating);case"fetch-portal-information":return this._renderSaveProcessing(this.messages.processing.fetching);case"fetch-portal-information-error":return this._renderSaveError(this.messages.errors.fetching);case"save-layer":return this._renderSaveLayerSettings();case"saving":return this._renderSaveProcessing(this.messages.processing.saving);case"saving-error":return this._renderSaveError(this.messages.errors.saving)}}_renderSaveError(e){return F.tsx("calcite-panel",{class:b.css.paddingMedium,key:"save-layer-error"},F.tsx("div",{class:b.css.saveError},F.tsx("calcite-icon",{class:b.css.saveErrorIcon,icon:"exclamation-mark-triangle",scale:"l",textLabel:this.messages.common.errorMessage}),F.tsx("calcite-label",{class:b.css.saveErrorLabel},e)),F.tsx("calcite-button",{appearance:"outline",bind:this,onclick:this._handleSaveErrorCloseClick,slot:"footer-actions",width:"full"},this.messages.common.close))}_renderSaveInitialized(){return F.tsx("calcite-panel",{class:b.css.paddingMedium,key:"save-layer-initialized"})}_renderSaveFlowItem(){return"save"!==this._currentFlowItem?null:F.tsx("calcite-flow-item",{bind:this,heading:this.messages.saveLayer,headingLevel:this.headingLevel,key:"save-layer-flow-item",selected:"save"===this._currentFlowItem,onCalciteFlowItemBack:this._handleSaveFlowItemBackClick},this._renderSaveContent())}_renderSaveLayerAction(e){if(!this.visibleElements.saveButton)return null;const t=this.viewModel.layer,s=t?.routeInfo,i=t?.portalItem?.itemControl,o=!!s&&("admin"===i||"update"===i);return F.tsx("calcite-action",{bind:this,disabled:!o,icon:"save",key:"save-route",onclick:this._handleSaveLayerClick,...e,text:this.messages.common.save,textEnabled:!0})}_renderSaveLayerAsAction(e){if(!this.visibleElements.saveAsButton)return null;const t=!this.viewModel.layer?.routeInfo;return F.tsx("calcite-action",{disabled:t,icon:"save-as",key:"save-as-route",onclick:()=>{this._handleSaveLayerAs()},...e,text:this.messages.common.saveAs,textEnabled:!0})}_renderSaveLayerSettings(){if(null==this.layer||null==this._portalFolders||null==this._portalUserName)return this._renderSaveInitialized();const{stops:e}=this.layer,t=`${e.at(0).name} - ${e.at(-1).name}`,s=[F.tsx("calcite-combobox-item",{heading:`${this._portalUserName} (${this.messages.common.home})`,key:b.css.folderHome,selected:!0,value:b.css.folderHome}),...this._portalFolders.map(e=>F.tsx("calcite-combobox-item",{heading:e.title??"",key:`${b.css.folder}-${e.id}`,value:e.id}))];return F.tsx("calcite-panel",{key:"save-layer-panel"},F.tsx("div",{class:b.css.paddingMedium},F.tsx("calcite-label",null,this.messages.layerName,F.tsx("calcite-input",{afterCreate:this._handleSaveLayerNameCreate,bind:this,label:this.messages.layerName,value:t})),F.tsx("calcite-label",null,this.messages.saveInFolder,F.tsx("calcite-combobox",{afterCreate:this._handleSaveLayerFolderCreate,bind:this,clearDisabled:!0,label:this.messages.saveInFolder,overlayPositioning:"fixed",selectionMode:"single-persist"},s))),F.tsx("calcite-button",{bind:this,onclick:this._handleSaveLayerButtonClick,slot:"footer-actions",width:"full"},this.messages.common.save),F.tsx("calcite-button",{appearance:"outline",bind:this,onclick:this._handleSaveLayerCancelClick,slot:"footer-actions",width:"full"},this.messages.common.cancel))}_renderSaveProcessing(e){return F.tsx("calcite-panel",{class:b.css.marginInlineMedium,key:"save-layer-processing"},F.tsx("calcite-loader",{class:b.css.saveProcessLoader,label:e,text:e}))}_renderSeparator(){return F.tsx("div",{class:b.css.separator})}_renderStop(e){const t=this.acquireSearch(e);null!=e.name&&(t.searchTerm=e.name);const s=this._getEffectiveStops(),i=this._renderLocateStopAction(e),o=s.length>2&&this._renderDeleteStopAction(e);return F.tsx("calcite-list-item",{key:e,value:e},i,o,F.tsx("div",{class:b.css.stopItem,slot:"content"},t.render()))}_renderStops(){const e=this._getEffectiveStops();for(const t of this._stopsToSearches.keys())e.includes(t)||this._disposeSearch(t);return F.tsx("div",{class:b.css.stopContainer,key:b.css.stopContainer},F.tsx("calcite-list",{bind:this,class:b.css.stopList,dragEnabled:!0,label:this.messages.widgetLabel,scale:"s",onCalciteListOrderChange:this._handleStopListReorder},e.toArray().map(e=>this._renderStop(e))),2===e.length&&F.tsx("calcite-action",{bind:this,icon:"arrow-up-down",onclick:this._handleReverseStopOrderClick,scale:"s",text:this.messages.reverseStops,title:this.messages.reverseStops}))}_renderTravelMode(e){const{id:t,name:s}=e;return F.tsx("calcite-combobox-item",{heading:s,key:t,label:s,selected:this.viewModel.selectedTravelMode?.id===t,value:e})}_renderTravelModes(){return this.viewModel.travelModes.length?F.tsx("calcite-label",{key:"travel-modes"},this.messages.mode,F.tsx("calcite-combobox",{bind:this,clearDisabled:!0,label:this.messages.mode,overlayPositioning:"fixed",selectionMode:"single-persist",onCalciteComboboxChange:this._handleTravelModeChange},this.viewModel.travelModes.map(e=>this._renderTravelMode(e)))):null}_renderViewItemDetailsAction(e){return this.visibleElements.layerDetails?F.tsx("calcite-action",{bind:this,disabled:!this.viewModel.layer?.portalItem,icon:"launch",key:"open-route-details-link",onclick:this._handleItemDetailsClick,...e,text:this.messages.viewLayerDetails,textEnabled:!0}):null}async _solveRoute(){if(this.viewModel.updateDepartureTime(),!((this.viewModel.layer?.stops.filter(({geometry:e})=>!!e).length??0)<2))try{await this.viewModel.getDirections()}catch{}}};return t.__decorate([d.property()],L.prototype,"_printDocumentOpen",void 0),t.__decorate([d.property()],L.prototype,"_currentFlowItem",void 0),t.__decorate([d.property()],L.prototype,"_saveState",void 0),t.__decorate([d.property()],L.prototype,"_searchTool",void 0),t.__decorate([d.property()],L.prototype,"apiKey",null),t.__decorate([d.property(_.defaultUnitPropertyMetadata)],L.prototype,"defaultUnit",void 0),t.__decorate([d.property()],L.prototype,"goToOverride",null),t.__decorate([d.property()],L.prototype,"headingLevel",void 0),t.__decorate([d.property()],L.prototype,"icon",null),t.__decorate([d.property()],L.prototype,"label",null),t.__decorate([d.property({readOnly:!0})],L.prototype,"lastRoute",null),t.__decorate([d.property()],L.prototype,"layer",null),t.__decorate([d.property()],L.prototype,"maxStops",null),t.__decorate([d.property(),P.messageBundle("esri/widgets/Directions/t9n/Directions")],L.prototype,"messages",void 0),t.__decorate([d.property(),P.messageBundle("esri/core/t9n/Units")],L.prototype,"messagesUnits",void 0),t.__decorate([d.property()],L.prototype,"searchProperties",void 0),t.__decorate([d.property()],L.prototype,"unit",null),t.__decorate([d.property()],L.prototype,"view",null),t.__decorate([d.property({type:k})],L.prototype,"viewModel",void 0),t.__decorate([d.property({type:f,nonNullable:!0})],L.prototype,"visibleElements",void 0),L=t.__decorate([p.subclass("esri.widgets.Directions")],L),L});