// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/asyncUtils","../../core/Evented","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/support/UpdatingHandles","../../editing/templateUtils","../../layers/support/layerUtils","./featureTemplatesUtils","./TemplateItem","./TemplateItemGroup"],function(e,t,s,r,a,l,o,i,n,p,u,d,c,m,y,h,_){"use strict";const f=({layer:e})=>({key:e,label:e.title??""}),g=({layer:e})=>({key:e.geometryType,label:e.geometryType??""});let I=class extends s.EventedAccessor{constructor(e){super(e),this._allItems=[],this._updatingHandles=new d.UpdatingHandles,this._updateTask=null,this.disabled=!1,this.disabledItemFunction=null,this.filterFunction=null,this.selectedItem=null,this.templateInfos=null,this.view=null}initialize(){this._get("groupBy")||(this.groupBy="layer"),this.addHandles([l.watch(()=>[this.templateInfos,this.layers],([e],t)=>{e&&e===t?.at(0)||(this._updateTask=r.abortMaybe(this._updateTask),e?this._updateAllItems(e):this._getTemplatesAndUpdateAllItems())},l.syncAndInitial),l.watch(()=>this._groupByFunction,()=>{null==this.templateInfos&&(this._updateTask=r.abortMaybe(this._updateTask),this._getTemplatesAndUpdateAllItems())},l.sync),l.watch(()=>this.filterFunction,e=>{for(const t of this._allItems)y.isTemplateItemGroup(t)&&(t.filterFunction=e)},l.sync)])}set groupBy(e){if(this._set("groupBy",e),"function"!=typeof e)switch(e){case"layer":this._groupByFunction=f;break;case"geometry":this._groupByFunction=g;break;default:this._groupByFunction=null}else this._groupByFunction=t=>this._ensureGroupByObject(e(t))}get layers(){return this._get("layers")}set layers(e){const t="layers";if(this.removeHandles(t),e){const s=()=>this.notifyChange("state");this.addHandles(e.map(e=>l.when(()=>e.loadStatus,s)),t)}this._set("layers",e)}get state(){return this.updating?"loading":0!==this.layers.length||this.templateInfos?.length?"ready":"disabled"}get numberOfFeatureTemplates(){return this._allItems.reduce((e,t)=>y.isTemplateItemGroup(t)?e+t.allItems.length:e+1,0)}get items(){const{filterFunction:e}=this;return null==e?this._allItems:this._allItems.filter(t=>y.isTemplateItemGroup(t)?t.items.length>0:e(t))}get updating(){return this._updatingHandles.updating}refresh(){this.notifyChange("filterFunction");for(const e of this._allItems)y.isTemplateItemGroup(e)&&e.reapplyFilter()}select(e,{emit:t=!0}={}){const s=this.selectedItem,r=e?.clone()||null;this._set("selectedItem",r),t&&this.emit("select",{item:r,oldItem:s,template:r?.template??null})}_createItem(e,t){return new h({disabledFunction:this.disabledItemFunction,layer:t,template:e})}_ensureGroupByObject(e){return"string"==typeof e?{key:e,label:e}:e}_updateAllItems(e){const t=this._allItems;if(0===e.length)return function(e){for(const t of e){if(y.isTemplateItemGroup(t))for(const e of t.items)e.destroy();t.destroy()}}(t),void(this._allItems=[]);const[s,r]=y.mapItemsByTemplate(t),a=e=>{const t=s.get(e.template);return t?(s.delete(e.template),t):this._createItem(e.template,e.layer)},{filterFunction:l}=this,o=e.filter(b).map(e=>y.isTemplateGroupInfo(e)?new _({filterFunction:l,label:e.label,allItems:e.templateInfos.filter(b).map(e=>a(e))}):a(e));for(const e of[...s.values(),...r])e.destroy();this._allItems=o}async _getTemplatesFromLayers(e){const t=[],s={signal:e};await Promise.all(this.layers.map(async r=>{await y.loadLayerWithTemplates(r,s),a.throwIfAborted(e);const l=m.getEffectiveLayerCapabilities(r)?.operations;l?.supportsEditing&&l?.supportsAdd&&(m.isSubtypeGroupLayer(r)?t.push(...r.sublayers):t.push(r))}));const r=await c.getTemplatesForLayers(t,this.view,e);a.throwIfAborted(e);const l=y.makeTemplateItemInfos(r),o=this._groupByFunction;if(null==o)return l;const i=y.makeGroupItemInfos(l,o);return 1===i.length&&i[0].label===y.nullGroupBy.label?i[0].templateInfos:i}async _getTemplatesAndUpdateAllItems(){if(0===this.layers.length)return;const e=t.createTask(async e=>{const t=await this._getTemplatesFromLayers(e);a.throwIfAborted(e),this._updateAllItems(t)});this._updateTask=e,await this._updatingHandles.addPromise(e.promise)}};function b(e){return y.isTemplateGroupInfo(e)?e.templateInfos.some(b):!c.isSharedTemplateOrMetadata(e.template)||!1!==e.template.visible}return e.__decorate([o.property()],I.prototype,"_allItems",void 0),e.__decorate([o.property()],I.prototype,"_groupByFunction",void 0),e.__decorate([o.property()],I.prototype,"_updatingHandles",void 0),e.__decorate([o.property()],I.prototype,"disabled",void 0),e.__decorate([o.property()],I.prototype,"disabledItemFunction",void 0),e.__decorate([o.property({value:null})],I.prototype,"filterFunction",void 0),e.__decorate([o.property()],I.prototype,"groupBy",null),e.__decorate([o.property({value:[]})],I.prototype,"layers",null),e.__decorate([o.property()],I.prototype,"state",null),e.__decorate([o.property({readOnly:!0})],I.prototype,"numberOfFeatureTemplates",null),e.__decorate([o.property({readOnly:!0})],I.prototype,"items",null),e.__decorate([o.property({readOnly:!0})],I.prototype,"selectedItem",void 0),e.__decorate([o.property()],I.prototype,"templateInfos",void 0),e.__decorate([o.property()],I.prototype,"updating",null),e.__decorate([o.property()],I.prototype,"view",void 0),I=e.__decorate([u.subclass("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],I),I});