// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../intl","../../../core/Error","../../../core/has","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/unitUtils","../../../geometry/Polygon","../../../geometry/support/geometryUtils","../../../rest/support/FullTextSearch","../../../intl/substitute","../../../intl/date"],function(e,t,r,i,n,l,s,o,a,u,c,d,f){"use strict";const g=/https?:\/\/services.*\.arcgis\.com/i,y=/(?:\{([^}]+)\})/g,m=()=>l.getLogger("esri.widgets.Search.support.layerSearchUtils");function p(e,t){const{filter:r,withinViewEnabled:i}=e,n=t?.extent,l=r?.geometry;return l??(i&&n?n:void 0)}function h(e){return e&&e.includes("*")}async function x(e){e&&await e.load()}function F(e){return!(!e.fullText&&!e.where)}function v(e,t){const r=e?.indexes;return!(!r||!t?.length)&&r.filter(e=>"FullText"===e.indexType).some(e=>{const r=e.fields?.split(",").map(e=>e.trim().toLowerCase())||[];return t.every(e=>r.includes(e.toLowerCase()))})}function w({text:e,searchFields:t}){return e.trim().split(" ").filter(e=>!!e.trim()).map(e=>new c({onFields:t,searchTerm:e,searchType:"prefix"}))}function S(e){return e?.capabilities?.query?.supportsFullTextSearch??!1}function b(e){return e?.capabilities?.query?.supportsPagination??!1}function T(e){return e.displayField||e.layer.displayField||(t=e.layer,t?.fieldsIndex?.fields?.find(e=>"string"===e.type)?.name??"");var t}function $(e,t){return!(!e||!t?.length)&&t.every(t=>I(e,t))}function I(e,t){return!!e.getField(t)}function L(e){return e.replaceAll("'","''")}function R(e,t){const r=t?.where;return r?`(${e}) AND (${r})`:e}function E({searchTerm:e,layer:t,searchFields:r,filter:n,exactMatch:l,query:o,type:a}){const{definitionExpression:u,url:c}=t;let d="";return!o.fullText&&e&&r&&r.forEach(r=>{const o=t.getField(r),u=t.getFieldDomain?.(r,{excludeImpliedDomains:i("esri-widget-legacy-field-domain-calculation")}),f=u&&"coded-value"===u.type?function({codedValues:e},t,r){return s.mappedFind(e??[],e=>{const i=e.name,n=r?i:i.toLowerCase();return(r?t:t.toLowerCase())===n?e.code.toString():null})??null}(u,e,l):null,y=f||e||null;if(null!==y){const e=function({currentTerm:e,field:t,filter:r,exactMatch:i,url:n,type:l}){const s=t?.type,o=t?.name;if("string"===s||"date"===s||"global-id"===s){const t=g.test(n??""),s=t&&function(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}(e)?"N":"";return R(i&&"search"===l?`${o} = ${s}'${e}'`:t?`${o} LIKE ${s}'${e}%'`:`LOWER(${o}) LIKE ${s}'${e.toLowerCase()}%'`,r)}if("oid"===s||"small-integer"===s||"integer"===s||"single"===s||"double"===s){const t=Number(e);return isNaN(t)?null:R(`${o} = ${t}`,r)}return R(`${o} = ${e}`,r)}({currentTerm:y,field:o,filter:n,exactMatch:l,url:c,type:a});e&&(d+=function(e,t){return e?` OR (${t})`:`(${t})`}(d,e))}}),u&&d?`(${u}) AND (${d})`:u||d}function M(e,t,r){const n=e.sourceLayer,{attributes:l}=e,s=n.getFieldDomain?.(r,{feature:e,excludeImpliedDomains:i("esri-widget-legacy-field-domain-calculation")});if(t)return d.substitute(t,l);if(r&&l){const e=n.getField(r),t=(o=l)[a=r]??o[Object.keys(o).find(e=>e.toLowerCase()===a.toLowerCase())];return null==t?"":s&&"coded-value"===s.type?function(e,t){let r=null;const{codedValues:i}=e;return i&&i.length&&i.some(e=>e.code===t&&(r=e.name,!0)),r}(s,t)??"":"date"===e?.type?f.formatDate(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}var o,a;return""}e.createFullTextSearchInfos=w,e.getResults=function(e,t){const{exactMatch:i=!1,location:l,maxResults:s,spatialReference:c,source:d,sourceIndex:f,suggestResult:g,view:y}=e,{layer:R,filter:j,zoomScale:q}=d,C=y?.scale,D=p(d,y),A=t?.signal;return x(R).then(()=>{const e=R.popupTemplate;return e?e.getRequiredFields(R.fieldsIndex):null}).then(e=>{const{objectIdField:t,returnZ:p}=R,x=T(d);if(!I(R,x))throw m().error("invalid-field: displayField is invalid."),new r("getResults():invalid-field","displayField is invalid.");const N=e?.length?e:[x],O=d.outFields||N,k=h(O);if(O.includes(t)||k||O.push(t),R.floorInfo?.floorField&&O.push(R.floorInfo.floorField),!k&&!$(R,O))throw m().error("invalid-field: outField is invalid."),new r("getResults():invalid-field","outField is invalid.");const B=R.createQuery(),{orderByFields:P}=d;if(P&&(B.orderByFields=P),c){B.outSpatialReference=c;const e=1/o.getMetersPerUnitForSR(c);e&&(B.maxAllowableOffset=e)}const U="mesh"===R.geometryType||"multipatch"===R.geometryType,G=R.capabilities?.data?.supportsZ&&!U;if(B.returnZ=G&&!1!==p,B.returnGeometry=!0,B.multipatchOption=U?"xyFootprint":null,O&&(B.outFields=O),l)B.geometry=l;else if(g.key)B.objectIds=[g.key];else{const e=d.searchFields||[x];if(!$(R,e))throw m().error("invalid-field: search field is invalid."),new r("getResults():invalid-field","search field is invalid.");b(R)&&(B.num=s),D&&(B.geometry=D);const t=g.text?.trim();if(!t)return[];const n=g.text,{prefix:l="",suffix:o=""}=d,a=L(`${l}${n}${o}`);S(R)&&v(R,e)&&!i&&n&&(B.fullText=w({text:n,searchFields:e}));const u=E({searchTerm:a,layer:R,searchFields:e,filter:j,exactMatch:i,query:B,type:"search"});if(B.where=u,!F(B))return[]}return R.queryFeatures(B,{signal:A}).then(e=>function(e,t,r,i,l,s,o){return e.features.map(e=>function(e,t,r,i,l,s,o){const c=e.clone();c.layer=e.layer;const d=e.sourceLayer,f=d?.objectIdField,g=f?e.attributes[f]:null,y=M(e,r.searchTemplate,l);null!=s&&function(e){return null!=e&&null!=e.minScale&&null!=e.maxScale}(d)&&(d.minScale&&d.minScale<s?s=d.minScale:d.maxScale&&d.maxScale>s&&(s=d.maxScale));const m=c.geometry?u.createExtentFromGeometry(c.geometry,t??void 0,s??void 0):void 0,p="number"==typeof o&&m?u.scaleExtent(n.clone(m),t??void 0,o):m,h=e.clone();return h.layer=e.layer,null!=p&&(h.geometry=a.fromExtent(p)),{extent:p,target:h,feature:c,key:g,name:y,sourceIndex:i}}(e,t,r,i,l,s,o))}(e,y,d,f,x,C,q))})},e.getSuggestions=function(e,t){const{source:i,spatialReference:n,view:l,suggestTerm:s,maxSuggestions:o,sourceIndex:a,exactMatch:u}=e,{layer:c,filter:d}=i,f=t?.signal,g=p(i,l);return x(c).then(()=>{if(!b(c))return[];const e=T(i),t=i.searchFields||[e],l=[];i.suggestionTemplate?i.suggestionTemplate.replaceAll(y,(e,t)=>(l.push(t),e)):l.push(e);const p=h(l);l.includes(c.objectIdField)||p||l.push(c.objectIdField);const x=I(c,e),R=p||$(c,l),j=$(c,t);if(!x)throw m().error("invalid-field: displayField is invalid."),new r("getSuggestions():invalid-field","displayField is invalid.");if(!R)throw m().error("invalid-field: outField is invalid."),new r("getSuggestions():invalid-field","outField is invalid.");if(!j)throw m().error("invalid-field: search field is invalid."),new r("getSuggestions():invalid-field","search field is invalid.");const q=c.createQuery(),{orderByFields:C}=i;if(C&&(q.orderByFields=C),q.outSpatialReference=n,q.returnGeometry=!1,q.num=o,q.outFields=l,g&&(q.geometry=g),!s.trim())return[];const{prefix:D="",suffix:A=""}=i,N=L(`${D}${s}${A}`);S(c)&&v(c,t)&&!u&&s&&(q.fullText=w({text:s,searchFields:t}));const O=E({searchTerm:N,layer:c,searchFields:t,filter:d,exactMatch:u,query:q,type:"suggest"});return q.where=O,F(q)?c.queryFeatures(q,{signal:f}).then(t=>function(e,t,r,i){return e.features.map(e=>function(e,t,r,i){const n=e.sourceLayer,{attributes:l}=e,{objectIdField:s}=n,o=s?l[s]:null;return{text:M(e,t.suggestionTemplate,i),key:o,sourceIndex:r}}(e,t,r,i))}(t,i,a,e)):[]})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});