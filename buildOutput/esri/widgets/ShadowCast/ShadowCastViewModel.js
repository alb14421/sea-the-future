// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../Color","../../core/Accessor","../../core/arrayUtils","../../core/asyncUtils","../../core/has","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/screenUtils","../../core/timeUtils","../../core/accessorSupport/decorators/property","../../core/Logger","../../core/accessorSupport/decorators/subclass","../../core/libs/gl-matrix-2/factories/vec3f64","../../views/3d/support/earthUtils","../../views/3d/support/sunUtils","./DiscreteOptions","./DurationOptions","./ShadowTooltipViewModel","./ThresholdOptions","../support/traversalUtils"],function(e,t,r,i,o,s,n,a,l,p,d,c,u,h,_,y,f,g,v,m,w,T){"use strict";const D=[],O=_.create(),P=[],b=d.convertTime(1,"hours","milliseconds");let C=class extends r{constructor(e){super(e),this.view=null,this.tooltip=new m.ShadowTooltipViewModel({getDuration:(e,t)=>this.getDuration(e,t)}),this.startTimeOfDay=d.convertTime(10,"hours","milliseconds"),this.endTimeOfDay=d.convertTime(16,"hours","milliseconds"),this.visualizationType="threshold",this.thresholdOptions=new w,this.durationOptions=new v,this.discreteOptions=new g,this._running=!0,this._stopPreviewingTask=null,this._forcePreview=!1,this._autoRestoreForcePreviewEnabled=!0,this._utcOffset=null,this.date=new Date}initialize(){this.addHandles([l.watch(()=>({view:this.view,tooltipEnabled:this._tooltipEnabled}),({view:e,tooltipEnabled:t})=>{this.tooltip.view=e,this.tooltip.enabled=t},l.syncAndInitial),l.watch(()=>this._forcePreviewDependencies,()=>{n.abortMaybe(this._stopPreviewingTask),this._forcePreview=!0,this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=o.createTask(async e=>{await a.after(500,e),a.throwIfAborted(e),this._forcePreview=!1}))},l.syncAndInitial),l.watch(()=>({renderer:this.renderer,parameters:this._visualizationParameters}),e=>U(e.renderer,e.parameters),l.syncAndInitial),l.watch(()=>({renderer:this.renderer,lightDirections:this._lightDirections,lightDirectionsContext:this._lightDirectionsContext}),e=>U(e.renderer,{lightDirections:e.lightDirections,lightDirectionsContext:e.lightDirectionsContext}),l.syncAndInitial),l.watch(()=>({renderer:this.renderer,parameters:{enabled:this._running}}),e=>U(e.renderer,e.parameters),l.syncAndInitial),l.watch(()=>({renderer:this.renderer,parameters:{previewing:this._previewing}}),e=>U(e.renderer,e.parameters),l.syncAndInitial)])}destroy(){this.stop(),U(this.renderer,{enabled:!1}),n.destroyMaybe(this.tooltip)}get state(){return null!=this.view&&this.view.ready&&null!=this._referencePosition?"ready":"disabled"}set date(e){const t=new Date(e);t.setHours(0,0,0,0),this._set("date",t)}get utcOffset(){return this._utcOffset??this._utcOffsetAuto}set utcOffset(e){this._utcOffset=e}get testData(){}get _previewing(){const{view:e}=this;if(null==e?.allLayerViews)return!0;const{stationary:t,allLayerViews:r,graphicsView:i}=e;return this._forcePreview||!t||r.some(e=>z(e)&&e.updating)||!i?.suspended&&!!i?.updating}get _utcOffsetAuto(){const e=this._referencePosition;return null!=e?y.longitudeToTimezone(e[0],!1):0}get _dateUTCOffset(){let e=this.date;return e=d.offsetDateUTC(e,-e.getTimezoneOffset(),"minutes"),e=d.offsetDateUTC(e,-this.utcOffset,"hours"),e}get _startDateTimeUTC(){return d.offsetDateUTC(this._dateUTCOffset,this.startTimeOfDay)}get _endDateTimeUTC(){return d.offsetDateUTC(this._dateUTCOffset,this.endTimeOfDay)}get _referencePosition(){return this.view?.environmentManager?.referencePositionGeographic}get _durationInterval(){return this._duration>0?Math.floor(this._duration/254):255}get _interval(){const e=this._durationInterval;switch(this.visualizationType){case"threshold":case"duration":return e;case"discrete":return this.discreteOptions.interval||e}}get _intervalContext(){const{contextEnabled:e,contextOptions:{interval:t}}=this.thresholdOptions;return"threshold"===this.visualizationType&&e?t||this._durationInterval:-1}get _durationSampleCount(){return this._lightDirections.length}get _duration(){return this.endTimeOfDay-this.startTimeOfDay}get _lightDirections(){return this._calculateLightDirections(this._interval)}get _lightDirectionsContext(){return this._calculateLightDirections(this._intervalContext)}_calculateLightDirections(e){const{view:t}=this;if(null==t||e<=0)return D;const r="global"===t.viewingMode?O:this._referencePosition;if(null==r)return D;const i=f.computeDirectionsOverTime(this._startDateTimeUTC,this._endDateTimeUTC,e,r,t.state.viewingMode,255),o=i.length;P.length=0;const s=T.breadthFirstBinaryPartitioning(0,o,P),n=new Array(o);for(let e=0;e<o;++e)n[e]=i[s[e]];return n}get _tooltipEnabled(){return"ready"===this.state&&"discrete"!==this.visualizationType&&this._running&&!this._previewing}get _visualizationParameters(){if(!this._running)return null;switch(this.visualizationType){case"threshold":return this._thresholdVisualizationParameters;case"duration":return this._durationVisualizationParameters;case"discrete":return this._discreteVisualizationParameters}}get _thresholdVisualizationParameters(){const{value:e,color:r}=this.thresholdOptions,i=this._duration;return{visualization:2,thresholdColor:t.toUnitRGBA(r),threshold:i>0?e/this._duration:0,...this._thresholdDiscreteVisualizationParameters}}get _thresholdDiscreteVisualizationParameters(){const{contextOptions:{color:e},contextEnabled:r}=this.thresholdOptions;return r?{visualization:3,gradientColor:t.toUnitRGBA(e)}:{}}get _durationVisualizationParameters(){const{color:e,mode:r}=this.durationOptions,i=this._duration,o=i>0&&"hourly"===r?b/i:0,s=t.toUnitRGBA(e);return 0===o?{...this._discreteVisualizationParameters,gradientColor:s}:{bandedGradientColor:s,visualization:1,bandSize:o}}get _discreteVisualizationParameters(){return{gradientColor:t.toUnitRGBA(this.discreteOptions.color),visualization:0}}get _forcePreviewDependencies(){const{view:e}=this;if(null==e)return null;const t=e.slice.plane,r=e.allLayerViews.toArray().filter(z),o=r.map(e=>e.layer).filter(i.isSome),s=r.map(e=>e.suspended),n=o.map(e=>e.visible),a=o.map(e=>e.opacity),l=!!e.graphicsView?.suspended,p=o.filter(e=>"definitionExpression"in e).map(e=>e.definitionExpression),d=r.filter(e=>"filter"in e).map(e=>e.filter);return{slicePlane:t,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewSuspended:s,graphicsViewSuspended:l,layerVisibilities:n,layerOpacities:a,filters:d,definitionExpressions:p}}get renderer(){const{view:e}=this;if(null==e)return null;const t=e.stage;return null==t?null:t.renderer}start(){this.setRunning(!0)}stop(){this.setRunning(!1)}setRunning(e){this._running=e}async getDuration(e,t){const{view:r,renderer:i,_durationSampleCount:o}=this;if(null==r||null==i||0===o)return 0;const s=r.state.camera.screenToRender(p.createScreenPointArray(e.x,e.y),p.createRenderScreenPointArray());return i.readAccumulatedShadow(s)*this._duration}};function U(e,t){null!=e&&null!=t&&e.setParameters({shadowCast:t})}function z(e){if(e.suspended)return!1;switch(e.type){case"building-scene-3d":case"csv-3d":case"elevation-3d":case"feature-3d":case"geojson-3d":case"graphics-3d":case"integrated-mesh-3d":case"integrated-mesh-3dtiles":case"ogc-feature-3d":case"route-3d":case"scene-layer-3d":case"scene-layer-graphics-3d":case"stream-3d":case"wms-3d":case"catalog-footprint-3d":return!0;default:return!1}}return e.__decorate([c.property()],C.prototype,"state",null),e.__decorate([c.property()],C.prototype,"view",void 0),e.__decorate([c.property()],C.prototype,"tooltip",void 0),e.__decorate([c.property({type:Date,nonNullable:!0})],C.prototype,"date",null),e.__decorate([c.property({type:Number,nonNullable:!0})],C.prototype,"utcOffset",null),e.__decorate([c.property({type:Number,nonNullable:!0})],C.prototype,"startTimeOfDay",void 0),e.__decorate([c.property({type:Number,nonNullable:!0})],C.prototype,"endTimeOfDay",void 0),e.__decorate([c.property({type:["threshold","duration","discrete"],nonNullable:!0})],C.prototype,"visualizationType",void 0),e.__decorate([c.property({type:w,nonNullable:!0})],C.prototype,"thresholdOptions",void 0),e.__decorate([c.property({type:v,nonNullable:!0})],C.prototype,"durationOptions",void 0),e.__decorate([c.property({type:g,nonNullable:!0})],C.prototype,"discreteOptions",void 0),e.__decorate([c.property()],C.prototype,"_running",void 0),e.__decorate([c.property()],C.prototype,"_stopPreviewingTask",void 0),e.__decorate([c.property()],C.prototype,"_forcePreview",void 0),e.__decorate([c.property()],C.prototype,"_autoRestoreForcePreviewEnabled",void 0),e.__decorate([c.property()],C.prototype,"_previewing",null),e.__decorate([c.property()],C.prototype,"_utcOffset",void 0),e.__decorate([c.property()],C.prototype,"_utcOffsetAuto",null),e.__decorate([c.property()],C.prototype,"_dateUTCOffset",null),e.__decorate([c.property()],C.prototype,"_startDateTimeUTC",null),e.__decorate([c.property()],C.prototype,"_endDateTimeUTC",null),e.__decorate([c.property()],C.prototype,"_referencePosition",null),e.__decorate([c.property()],C.prototype,"_interval",null),e.__decorate([c.property()],C.prototype,"_intervalContext",null),e.__decorate([c.property()],C.prototype,"_durationSampleCount",null),e.__decorate([c.property()],C.prototype,"_duration",null),e.__decorate([c.property()],C.prototype,"_lightDirections",null),e.__decorate([c.property()],C.prototype,"_lightDirectionsContext",null),e.__decorate([c.property()],C.prototype,"_tooltipEnabled",null),e.__decorate([c.property()],C.prototype,"_visualizationParameters",null),e.__decorate([c.property()],C.prototype,"_thresholdVisualizationParameters",null),e.__decorate([c.property()],C.prototype,"_thresholdDiscreteVisualizationParameters",null),e.__decorate([c.property()],C.prototype,"_durationVisualizationParameters",null),e.__decorate([c.property()],C.prototype,"_discreteVisualizationParameters",null),e.__decorate([c.property()],C.prototype,"_forcePreviewDependencies",null),e.__decorate([c.property()],C.prototype,"renderer",null),C=e.__decorate([h.subclass("esri.widgets.ShadowCast.ShadowCastViewModel")],C),C});