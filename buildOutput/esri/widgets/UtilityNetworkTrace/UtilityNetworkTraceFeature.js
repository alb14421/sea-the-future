// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../chunks/tslib.es6","../../intl","../../core/Collection","../../core/reactiveUtils","../../core/throttle","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../intl/messages","../../layers/support/layerUtils","../../popup/content/AttachmentsContent","../../popup/content/Content","../../popup/content/CustomContent","../../popup/content/ExpressionContent","../../popup/content/FieldsContent","../../popup/content/MediaContent","../../popup/content/RelationshipContent","../../popup/content/TextContent","../../popup/content/UtilityNetworkAssociationsContent","../../support/actions/actionUtils","../Feature","../Spinner","../Widget","../Feature/resources","../Feature/support/FeatureContentMixin","../Features/css","../Features/FeaturesViewModel","../Popup/actions","../Popup/actionUtils","../../chunks/componentsUtils","../support/globalCss","../support/Heading","../support/widgetUtils","../support/decorators/messageBundle","../support/decorators/vmEvent","../support/jsxFactory","./UtilityNetworkTraceFeaturesDrillIn","../../intl/substitute"],function(e,t,i,o,s,n,r,a,l,d,c,u,p,h,g,_,w,m,v,y,f,M,F,b,x,C,k,A,I,T,W,N,S,L,P,B,U,E,H,O,D){"use strict";const V="features-spinner",R="esri-utility-network-trace",z={blockContainer:`${R}__block-container`,blockContent:`${R}__block-content`,featureContent:`${R}__feature-content`,paddingBottom:`${R}__pad-bottom`,paddingTop:`${R}__pad-top`};let Z=class extends(A.FeatureContentMixin(C)){constructor(e,t){super(e,t),this._actionBarMenuNode=null,this._drillInFlowItems=new o,this._drillInWidget=new O({flowItems:this._drillInFlowItems}),this._feature=null,this._featureMenuViewportNode=null,this._spinner=null,this._utilityNetworkTraceMessages=null,this.featureNavigationTop=!1,this.headerActions=new W.ActionsCollection,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.responsiveActionsEnabled=!1,this.viewModel=new T,this._renderAction=(e,t)=>{const i=this._getActionTitle(e),{type:o,active:s,uid:n,disabled:r,indicator:a}=e;return e.visible?H.tsx("calcite-action",{active:"toggle"===o&&e.value,appearance:"solid",bind:this,"data-action-uid":n,disabled:"zoom-to-feature"===e.id?!this.feature.geometry:r,icon:this._getActionIcon(e),indicator:a,key:`action-${t}`,loading:s,onclick:this._triggerAction,scale:"s",text:i,title:this._hideActionText?i:void 0},this._renderFallbackIcon(e)):null},this._renderAddNsoBlock=()=>{const{_utilityNetworkTraceMessages:e,messagesCommon:t}=this;return H.tsx("calcite-block",{class:z.blockContent,expanded:!this.feature,heading:e?.inputsStrings.addNonspatialOption},H.tsx("calcite-action",{icon:"x",onclick:()=>this.emit("close-un-trace-feature-block"),slot:"control",text:t.close}),H.tsx("calcite-notice",{icon:"information",kind:"info",open:!this.feature},H.tsx("div",{slot:"message"},e?.inputsStrings.addNonspatialHint)))},this._renderNoPopupErrorBlock=()=>{const{_utilityNetworkTraceMessages:e,messagesCommon:t}=this;return H.tsx("calcite-block",{description:void 0,expanded:!0,heading:"show-feature-info"===this.mode?t.warning:void 0},H.tsx("calcite-notice",{class:this.classes(z.paddingBottom,z.paddingTop),icon:"exclamation-mark-triangle",kind:"danger",open:!0},H.tsx("div",{slot:"message"},e.alertsStrings.noPopupConfigured)),"show-feature-info"===this.mode?H.tsx("calcite-action",{icon:"x",onclick:()=>this.emit("close-un-trace-feature-block"),slot:"control",text:t.close}):void 0)},this._displaySpinnerThrottled=n.throttle(()=>this._displaySpinner(),0),this.addHandles([this._displaySpinnerThrottled,s.watch(()=>this.viewModel?.active,e=>this._drillInWidget.closed=!e),s.watch(()=>this.viewModel?.view,(e,t)=>this._viewChange(e,t)),s.watch(()=>this.viewModel?.view?.ready,(e,t)=>this._viewReadyChange(e??!1,t??!1)),s.watch(()=>[this.viewModel?.waitingForResult,this.viewModel?.location],()=>{this._hideSpinner(),this._displaySpinnerThrottled()}),s.watch(()=>this.viewModel?.screenLocation,()=>this._closeOpenActionMenu()),s.watch(()=>this.selectedFeatureWidget,()=>this._destroyDrillInFlowItemWidgets()),s.watch(()=>{const e=this.selectedFeatureWidget?.viewModel;return[e?.title,e?.state]},()=>this._setTitleFromFeatureWidget()),s.watch(()=>{const e=this.selectedFeatureWidget?.viewModel;return[e?.content,e?.state]},()=>this._setContentFromFeatureWidget()),s.watch(()=>this.viewModel?.featureViewModels,()=>this._featureMenuViewportScrollTop()),this._drillInWidget.on("close",()=>{this.emit("close")}),this._drillInWidget.on("exit",()=>this._destroyDrillInFlowItemWidgets()),this._drillInWidget.on("open-feature",({feature:e})=>this._openRelatedFeature(e)),this._drillInWidget.on("zoom-to-feature",({featureWidget:e})=>N.zoomToLocation(this.viewModel,e)),this._drillInWidget.on("add-nso-trace-location",({featureWidget:e})=>this.emit("add-nso-trace-location",{featureWidget:e}))])}initialize(){(async()=>{this._utilityNetworkTraceMessages=await u.fetchMessageBundle("esri/widgets/UtilityNetworkTrace/t9n/UtilityNetworkTrace")})(),this._drillInWidget.mode=this.mode,this._drillInWidget.closable=!1}loadDependencies(){return S.loadCalciteComponents({action:()=>new Promise((t,i)=>e(["../../chunks/index12"],t,i)),"action-bar":()=>new Promise((t,i)=>e(["../../chunks/index46"],t,i)),"action-group":()=>new Promise((t,i)=>e(["../../chunks/index18"],t,i)).then(e=>e.index),block:()=>new Promise((t,i)=>e(["../../chunks/index13"],t,i)),flow:()=>new Promise((t,i)=>e(["../../chunks/index14"],t,i)),"flow-item":()=>new Promise((t,i)=>e(["../../chunks/index15"],t,i)),notice:()=>new Promise((t,i)=>e(["../../chunks/index6"],t,i))})}destroy(){this._destroyDrillInFlowItemWidgets(),this._destroySelectedFeatureWidget(),this._destroySpinner(),this._drillInWidget?.destroy()}get _hideActionText(){if(!this.responsiveActionsEnabled)return!1;const e=this.view?.widthBreakpoint;return"xsmall"===e||"small"===e||"medium"===e}get active(){return this.viewModel.active}get content(){return this.viewModel.content}set content(e){this.viewModel.content=e}get feature(){return this.viewModel.features.length?this.viewModel.features[0]:null}set feature(e){this.viewModel.features=e?[e]:[]}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get hasAssociationsPopupElement(){const e=p.isFeatureLayer(this.feature?.sourceLayer)?this.feature?.sourceLayer:void 0,t=p.isSubtypeSublayer(this.feature?.sourceLayer)?this.feature?.sourceLayer:void 0,i=e?.popupTemplate||t?.popupTemplate||null,o=i?.content;return!(Array.isArray(o)&&!o.some(e=>e instanceof M))}get hasPopupInfo(){const e=p.isFeatureLayer(this.feature?.sourceLayer)?this.feature?.sourceLayer:void 0,t=p.isSubtypeSublayer(this.feature?.sourceLayer)?this.feature?.sourceLayer:void 0;return!(!e?.popupTemplate&&!t?.popupTemplate)}get location(){return this.viewModel.location}set location(e){this.viewModel.location=e}get mode(){return this._get("mode")||"add-nso"}set mode(e){this._set("mode",e)}get promises(){return this.viewModel.promises}set promises(e){this.viewModel.promises=e}get selectedFeature(){return this.viewModel.selectedFeature}get selectedDrillInFeature(){const e=Array.from(this._drillInFlowItems).at(-1);if(!e)return null;const{flowType:t}=e;return"feature-association"===t||"feature-relationship"===t?e.graphic??null:null}get selectedFeatureWidget(){const{_feature:e,headingLevel:t,_drillInFlowItems:i,timeZone:o}=this,{selectedFeatureViewModel:s}=this.viewModel,n={title:!1};return s?(e?(e.viewModel=s,e.visibleElements=n):this._feature=new b({flowItems:i,headingLevel:t+1,timeZone:o,viewModel:s,visibleElements:n}),this._feature):null}get timeZone(){return this.viewModel.timeZone}set timeZone(e){this.viewModel.timeZone=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}open(e){this.removeHandles("selected-index"),this.viewModel.open({features:[e]})}triggerAction(e){return this.viewModel.triggerAction(e)}render(){return H.tsx("div",{bind:this,class:this.classes(I.css.base,L.globalCss.widget,L.globalCss.panel,z.blockContainer)},"add-nso"===this.mode?this._renderAddNsoBlock():void 0,this.feature?this.hasPopupInfo?this._renderContentContainer():this._renderNoPopupErrorBlock():void 0)}_renderActionBar(){return this.viewModel.allActions?.length?H.tsx("calcite-action-bar",{expandDisabled:!0,expanded:!this._hideActionText,key:"header-action-bar",scale:"s",slot:"action-bar"},H.tsx("calcite-action-group",{afterCreate:e=>this._actionBarMenuNode=e,overlayPositioning:"fixed",scale:"s"},this._renderActions())):null}_renderActions(){return this.viewModel.allActions.toArray().map(this._renderAction)}_renderContent(){const e=this.viewModel?.content;return e?"string"==typeof e?H.tsx("div",{class:k.css.contentNode,innerHTML:e,key:e}):this.renderNodeContent(e):null}_renderContentContainer(){const e=[this._renderContentFeature(),this._drillInWidget.render()];return H.tsx("calcite-flow",{key:"content-container"},e)}_renderContentFeature(){const{_drillInFlowItems:e,headingLevel:t,featureNavigationTop:i}=this,{title:o,active:s}=this.viewModel,n=o||"";return H.tsx("calcite-flow-item",{bind:this,class:this.classes({[I.css.contentFeature]:!0}),closed:!s,collapseDirection:i?"down":"up",headingLevel:t,key:"root-flow-item",loading:this.viewModel.waitingForContents,selected:0===e.length},"show-feature-info"===this.mode?H.tsx("calcite-action",{icon:"x",onclick:()=>{this.emit("close")},slot:"header-actions-end",text:this.messagesCommon.close}):void 0,n?H.tsx(P.Heading,{class:this.classes(I.css.featuresHeading,L.globalCss.heading),innerHTML:n,key:"header-content",level:this.headingLevel,slot:"header-content"}):null,this._renderHeaderActions(),this._renderActionBar(),H.tsx("div",{class:"add-nso"===this.mode?this.classes(I.css.container,I.css.contentContainer):this.classes(I.css.container,I.css.contentContainer,z.featureContent)},this._renderContent()))}_renderFallbackIcon(e){const{className:t,icon:i}=e;if(i)return null;const o=F.substituteActionImage({action:e,feature:this.selectedFeature}),s={[I.css.icon]:!!t,[I.css.actionImage]:!!o};return t&&(s[t]=!0),o||t?H.tsx("span",{"aria-hidden":"true",class:this.classes(I.css.icon,s),key:"icon",styles:F.getActionStyles(o)}):null}_renderHeaderAction(e,t){const i=e.title||"";return e.visible?H.tsx("calcite-action",{active:"toggle"===e.type&&e.value,appearance:"solid",bind:this,"data-action-uid":e.uid,disabled:e.disabled||!this.feature.geometry,icon:e.icon??void 0,indicator:e.indicator,key:`header-action-${t}`,loading:e.active,onclick:this._triggerHeaderAction,slot:"header-actions-end",text:i,title:i}):null}_renderHeaderActions(){return this.headerActions.map((e,t)=>this._renderHeaderAction(e,t)).toArray()}_closeOpenActionMenu(){const{_actionBarMenuNode:e}=this;e&&(e.menuOpen=!1)}_createSpinner(e){e&&(this._spinner=new x({view:e}),e.ui.add(this._spinner,{key:V,position:"manual",internal:!0}))}_destroyDrillInFlowItemWidgets(){this._drillInFlowItems.drain(e=>{"showAllEnabled"in e.viewModel&&(e.viewModel.showAllEnabled=!1),e.viewModel=null,e.destroy()})}_destroySelectedFeatureWidget(){const{_feature:e}=this;e&&(e.viewModel=null,!e.destroyed&&e.destroy()),this._feature=null}_destroySpinner(){const{_spinner:e,view:t}=this;e&&(t?.ui?.remove(e,V),e.destroy(),this._spinner=null)}_displaySpinner(){const{_spinner:e}=this;if(!e)return;const{location:t,waitingForResult:i}=this.viewModel;i&&t?e.show({location:t}):e.hide()}_featureMenuViewportScrollTop(){this._featureMenuViewportNode?.scrollContentTo({top:0})}_getActionIcon(e){return e.icon?e.icon:e.image||e.className?void 0:"question"}_getActionTitle(e){const{messages:t,selectedFeature:i,messagesCommon:o}=this,{id:s}=e,n=i?.attributes,r=e.title??"",a="zoom-to-feature"===s?D.substitute(r,{messages:t}):"remove-selected-feature"===s?D.substitute(r,{messages:o}):"zoom-to-clustered-features"===s||"browse-clustered-features"===s?D.substitute(r,{messages:t}):e.title;return a&&n?D.substitute(a,n):a??""}_hideSpinner(){const{_spinner:e}=this;e&&(e.location=null,e.hide())}async _openRelatedFeature(e){await e.viewModel.updateGeometry();const t=e.graphic,i=t?.geometry;null!=i&&null!=t&&(this._destroyDrillInFlowItemWidgets(),await this.viewModel.zoomTo({target:i}),this.open(t))}_setContentFromFeatureWidget(){const{selectedFeatureWidget:e}=this;e&&(this.viewModel.content=e)}_setTitleFromFeatureWidget(){const{selectedFeatureWidget:e,messagesCommon:t}=this,i=e?.viewModel;e&&(this.viewModel.title="error"===i?.state?t?.errorMessage:i?.title||"")}_triggerAction(e){const t=e.currentTarget;if(t.disabled)return;const i=t.dataset.actionUid,{allActions:o}=this.viewModel,s=o.findIndex(e=>e.uid===i),n=o.at(s);n&&"toggle"===n.type&&(n.value=!n.value),this.viewModel.triggerAction(s)}_triggerHeaderAction(e){const t=e.currentTarget;if(t.disabled)return;const i=t.dataset.actionUid,o=this.headerActions.find(({uid:e})=>e===i);o&&!o.disabled&&("toggle"===o?.type&&(o.value=!o.value),this.emit("trigger-header-action",{action:o}))}_viewReadyChange(e,t){e?this._wireUpView(this.viewModel?.view):t&&this.viewModel.clear()}_viewChange(e,t){e&&t&&this.viewModel.clear()}_wireUpView(e){this._destroySpinner(),e&&this._createSpinner(e)}};return t.__decorate([r.property()],Z.prototype,"_drillInFlowItems",void 0),t.__decorate([r.property()],Z.prototype,"_hideActionText",null),t.__decorate([r.property({readOnly:!0})],Z.prototype,"active",null),t.__decorate([r.property()],Z.prototype,"content",null),t.__decorate([r.property()],Z.prototype,"feature",null),t.__decorate([r.property()],Z.prototype,"featureNavigationTop",void 0),t.__decorate([r.property()],Z.prototype,"goToOverride",null),t.__decorate([r.property()],Z.prototype,"hasAssociationsPopupElement",null),t.__decorate([r.property()],Z.prototype,"hasPopupInfo",null),t.__decorate([r.property({type:W.ActionsCollection})],Z.prototype,"headerActions",void 0),t.__decorate([r.property()],Z.prototype,"headingLevel",void 0),t.__decorate([r.property()],Z.prototype,"location",null),t.__decorate([r.property(),U.messageBundle("esri/widgets/Features/t9n/Features")],Z.prototype,"messages",void 0),t.__decorate([r.property(),U.messageBundle("esri/t9n/common")],Z.prototype,"messagesCommon",void 0),t.__decorate([r.property()],Z.prototype,"mode",null),t.__decorate([r.property()],Z.prototype,"promises",null),t.__decorate([r.property()],Z.prototype,"responsiveActionsEnabled",void 0),t.__decorate([r.property({readOnly:!0})],Z.prototype,"selectedFeature",null),t.__decorate([r.property({readOnly:!0})],Z.prototype,"selectedDrillInFeature",null),t.__decorate([r.property({readOnly:!0})],Z.prototype,"selectedFeatureWidget",null),t.__decorate([r.property()],Z.prototype,"timeZone",null),t.__decorate([r.property()],Z.prototype,"view",null),t.__decorate([r.property({type:T}),E.vmEvent(["triggerAction","trigger-action"])],Z.prototype,"viewModel",void 0),Z=t.__decorate([c.subclass("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceFeature")],Z),Z});