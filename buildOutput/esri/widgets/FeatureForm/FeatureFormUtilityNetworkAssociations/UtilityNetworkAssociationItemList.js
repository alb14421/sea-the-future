// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../../chunks/tslib.es6","../../../intl","../../../core/reactiveUtils","../../../core/string","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/support/layerUtils","../../../views/support/HighlightDefaults","../../Widget","../UtilityNetworkAssociationAddAssociationViewModel","../../../chunks/componentsUtils","../../support/FilterBuilder","../../support/globalCss","../../support/Heading","../../support/SelectionToolbar","../../support/widgetUtils","../../support/decorators/messageBundle","../../support/jsxFactory","../../support/SelectionToolbar/VisibleElements","../../../intl/substitute"],function(e,t,r,i,s,l,o,a,n,d,c,u,p,h,_,y,m,g,v,f,b,w,F,C){"use strict";const x="esri-feature-form-utility-network-association-layers",L={base:x,header:`${x}__header`,headingContent:`${x}__heading-content`,featureObserver:`${x}__feature-observer`,filterContainer:`${x}__filter-container`,filterOptionsContainer:`${x}__filter-options-container`,filterOptionsHeader:`${x}__filter-options-header`,listContainer:`${x}__list-container`,spatialSelectContainer:`${x}__spatial-select-container`,spatialSelectToolbar:`${x}__spatial-select-toolbar`,stickySpinnerContainer:`${x}__sticky-loading-container`,loadingContainer:`${x}__loading-container`};let S=class extends p{constructor(e,t){super(e,t),this.headingLevel=5,this.messagesCommon=null,this.messagesEditor=null,this.messagesFeature=null,this.messagesFeatureForm=null,this.messagesFilterBuilder=null,this.viewModel=new h,this.view=null,this._filterBuilder=new y,this._featureFilterText="",this._layerFilterText="",this._observer=new IntersectionObserver(([e])=>{e?.isIntersecting&&this._increaseFeaturePage()},{root:window.document}),this._observerNode=null,this._selectionToolbar=new v({returnFeatureTitleFields:!0,layerViewPreferenceEnabled:!1,persistSelection:!1,visibleElements:new F({chip:!1,pan:!1})}),this._onSelectionComplete=async e=>{const{highlightHelper:t}=this.viewModel;await this.viewModel.onSelectionComplete(e),t?.removeAll(),this._featureSpatialGraphics.length>0&&t?.add(this._featureSpatialGraphics)}}initialize(){this._setupSelectionToolbar(),this.addHandles([i.watch(()=>this.viewModel,()=>this.reset()),i.watch(()=>[this.viewModel.state,this._observerNode],()=>this._onObserverChange()),i.watch(()=>this.selectedLayer,e=>{this._filterBuilder.layer=e,e||(this.filterOptionsVisible=!1,this._featureFilterText="")})])}loadDependencies(){return _.loadCalciteComponents({action:()=>new Promise((t,r)=>e(["../../../chunks/index12"],t,r)),button:()=>new Promise((t,r)=>e(["../../../chunks/index2"],t,r)),icon:()=>new Promise((t,r)=>e(["../../../chunks/index7"],t,r)),input:()=>new Promise((t,r)=>e(["../../../chunks/index4"],t,r)),list:()=>new Promise((t,r)=>e(["../../../chunks/index16"],t,r)),"list-item":()=>new Promise((t,r)=>e(["../../../chunks/index20"],t,r)),loader:()=>new Promise((t,r)=>e(["../../../chunks/index32"],t,r))})}destroy(){this._filterBuilder.destroy(),this._selectionToolbar.destroy()}get filterOptionsVisible(){return this.viewModel.filterOptionsVisible}set filterOptionsVisible(e){this.viewModel.filterOptionsVisible=e}get isSelecting(){return"active"===this._selectionToolbar.state}get selectedLayer(){return this.viewModel.selectedLayer}set selectedLayer(e){this.viewModel.selectedLayer=e}get selectedFeature(){return this.viewModel.selectedFeature}set selectedFeature(e){this.viewModel.selectedFeature=e}get filterWhereClause(){return this.viewModel.filterWhereClause}set filterWhereClause(e){this.viewModel.filterWhereClause=e,e||this._filterBuilder.reset()}get _featureSpatialGraphics(){return this.viewModel.featureSpatialItems.toArray().map(e=>e.feature)}get _filteredFeatureItems(){const{_featureFilterText:e}=this,{featureItems:t,featureSpatialItems:r}=this.viewModel;return(r.length?r:t).map(e=>({label:e.label,graphic:e.feature,layer:e.feature.sourceLayer})).filter(t=>t.label?.toLowerCase().includes(e)??!1)}get _filteredFeatureItemsPage(){const{featurePage:e,featuresPerPage:t}=this.viewModel,r=e*t;return this._filteredFeatureItems.toArray().slice(0,r)}render(){return w.tsx("div",{class:this.classes(L.base,m.globalCss.widget)},this._renderContent())}applyFilterOptions(){const{selectedLayer:e}=this;this.filterOptionsVisible=!1,e&&(this.filterWhereClause=this._filterBuilder.whereClause)}cancelSelection(){this._selectionToolbar.cancel()}reset(){this.filterWhereClause=null,this._featureFilterText="",this._layerFilterText="",this.filterOptionsVisible=!1,this._filterBuilder.reset()}startSelection(e){this._selectionToolbar.activateTool(e)}_setupSelectionToolbar(){this.addHandles([i.watch(()=>this.view,e=>{this.viewModel.reset(),this._selectionToolbar.view="2d"===e?.type?e:null},i.initial),i.watch(()=>[this.viewModel,this.viewModel.layerItems.length,this.viewModel.map?.allLayers.map(e=>e.visible),this.viewModel.map?.allLayers?.filter(e=>c.isSubtypeGroupLayer(e)).toArray().flatMap(e=>e.sublayers.toArray()).map(e=>e.visible)],()=>this._updateToolbarSources()),i.on(()=>this._selectionToolbar,"before-activate",e=>this.emit("before-selection",e)),i.on(()=>this._selectionToolbar,"complete",this._onSelectionComplete)])}_updateToolbarSources(){const e=this.viewModel.layerItems.toArray().filter(e=>{const{parent:t}=e;return!(t&&(c.isGroupLayer(t)||c.isSubtypeGroupLayer(t))&&!t.visible)&&e.visible});this._selectionToolbar.sources=e}_onObserverChange(){this._observerNode&&this._observer.unobserve(this._observerNode);const{state:e}=this.viewModel;this._observerNode&&"ready"===e&&this._observer.observe(this._observerNode)}_increaseFeaturePage(){const{featureCount:e,featurePage:t,featureSpatialItems:r,state:i}=this.viewModel;e||r.length||1===t?"ready"===i&&this.viewModel.featurePage++:this.viewModel.featurePage=1}_renderContent(){const{state:e,filterOptionsVisible:t}=this.viewModel;return"loading"===e?this._renderLoading():t?this._renderFilterOptions():[this._renderSelectionToolbar(),this._renderListContent()]}_renderListContent(){return this._selectionToolbar.activeOperation?.processingFinalSelection?this._renderLoading():this.selectedLayer||this.viewModel.featureSpatialItems.length?this._renderFeatures():this._renderLayers()}_renderSelectionToolbar(){const{messagesCommon:e,_selectionToolbar:t}=this,{featureSpatialItems:r,selectedLayer:i}=this.viewModel;if(i||!t.sources?.length)return null;const s=w.tsx("div",{class:L.spatialSelectToolbar},t.render()),l=w.tsx("calcite-button",{appearance:"transparent",disabled:!r.length,label:e.clear,onclick:()=>this.viewModel.reset()},e.clear);return w.tsx("div",{class:L.spatialSelectContainer,key:"spatial-select-toolbar"},s,l)}_renderStickyLoading(){return"querying"===this.viewModel.state?w.tsx("div",{class:L.stickySpinnerContainer,key:"sticky-loader"},this._renderLoadingIcon()):null}_renderLoading(){return w.tsx("div",{class:L.loadingContainer,key:"loading-container"},this._renderLoadingIcon())}_renderLoadingIcon(){return w.tsx("calcite-loader",{inline:!0,label:this.messagesCommon.loading})}_renderFilterOptions(){return w.tsx("div",{class:L.filterOptionsContainer},w.tsx("div",{class:L.filterOptionsHeader},w.tsx("span",null,this.messagesFilterBuilder.widgetLabel),w.tsx("calcite-button",{appearance:"transparent",onclick:()=>this._filterBuilder.reset()},this.messagesCommon.clear)),this._filterBuilder.render())}_renderLayers(){const e=this.messagesFeatureForm.associations,t=e.availableLayers,r=e.filterLayers;return w.tsx("div",null,this._renderHeader({heading:t,placeholder:r,renderFilterOptions:!1,renderTotal:!1}),w.tsx("div",{class:L.listContainer},w.tsx("calcite-list",{label:e.associatedFeatures},this._renderLayerItems(),this._renderStickyLoading())))}_renderLayerItems(){const{_layerFilterText:e,viewModel:t,messagesCommon:r}=this,{layerItems:i,tableItems:s}=t;return i.concat(s).map(e=>({label:e.title??r.untitled,layer:e})).filter(t=>t.label?.toLowerCase().includes(e)??!1).toArray().map(e=>this._renderLayerItem(e))}_renderLayerItem(e){const{label:t,layer:r}=e;return w.tsx("calcite-list-item",{key:`layer-item-${r.id}`,label:s.stripHTML(t),onCalciteListItemSelect:()=>{this.selectedLayer=r,this._filterBuilder.reset()}},w.tsx("calcite-icon",{flipRtl:!0,icon:"chevron-right",scale:"s",slot:"content-end"}))}_renderFeatures(){const{selectedLayer:e,viewModel:t}=this,r=t.featureSpatialItems.length>0,i=this.messagesFeatureForm.associations,s=r?void 0:e?.title||this.messagesCommon.untitled,l=i.filterFeatures;return w.tsx("div",null,this._renderHeader({heading:s,placeholder:l,renderFilterOptions:!r,renderTotal:!0}),w.tsx("div",{class:L.listContainer},w.tsx("calcite-list",{label:i.associatedFeatures},this._renderFeatureItems(),this._renderStickyLoading(),this._renderFeatureObserver())))}_renderFeatureItems(){return this._filteredFeatureItemsPage.map(e=>this._renderFeatureItem(e))}_renderFeatureItem(e){const{viewModel:t}=this,{highlightHelper:r}=t,{label:i,graphic:l}=e,o=t.featureSpatialItems.length>0?()=>r?.update(l,u.defaultHighlightName):void 0,a=t.featureSpatialItems.length>0?()=>r?.update(l,u.temporaryHighlightName):void 0;return w.tsx("calcite-list-item",{key:`feature-item-${l.uid}`,label:s.stripHTML(i),onmouseenter:o,onmouseleave:a,onCalciteListItemSelect:()=>{this.selectedFeature={feature:l,label:i}}},w.tsx("calcite-icon",{flipRtl:!0,icon:"chevron-right",scale:"s",slot:"content-end"}))}_onObserverCreate(e){this._observerNode=e}_renderFeatureObserver(){return w.tsx("div",{afterCreate:this._onObserverCreate,bind:this,class:L.featureObserver,key:"feature-observer"})}_renderHeader(e){return w.tsx("div",{class:L.header,key:"filter"},this._renderHeading(e.heading),this._renderFilter(e.placeholder,e.renderFilterOptions),e.renderTotal?this._renderTotal():null)}_renderHeading(e){return e?w.tsx(g.Heading,{key:"title",level:this.headingLevel},w.tsx("div",{class:L.headingContent},w.tsx("calcite-icon",{icon:"layer"}),e)):null}_renderFilter(e,t){const r=!this.selectedLayer&&!this.viewModel.featureSpatialItems.length,i=r?this._layerFilterText:this._featureFilterText;return w.tsx("div",{class:L.filterContainer,key:"filter"},w.tsx("calcite-input",{icon:"search",placeholder:e,type:"search",value:i,onCalciteInputInput:e=>{r?this._layerFilterText=e.currentTarget.value.trim().toLowerCase():this._featureFilterText=e.currentTarget.value.trim().toLowerCase()}},t?this._renderFilterOptionsAction():null))}_renderFilterOptionsAction(){const e=this.messagesFeatureForm.associations.filterOptions;return w.tsx("calcite-action",{appearance:"transparent",icon:"sliders",indicator:!!this._filterBuilder.whereClause,onclick:()=>{this.viewModel.filterOptionsVisible=!this.viewModel.filterOptionsVisible},scale:"s",slot:"action",text:e,title:e})}_renderTotal(){const{messagesFeature:e,viewModel:t}=this,{featureCount:r,featureSpatialItems:i}=t,s=C.substitute(e.numberRecords,{number:i.length?i.length:r});return w.tsx("div",{key:"total"},s)}};return t.__decorate([l.property()],S.prototype,"filterOptionsVisible",null),t.__decorate([l.property()],S.prototype,"headingLevel",void 0),t.__decorate([l.property()],S.prototype,"isSelecting",null),t.__decorate([l.property(),b.messageBundle("esri/t9n/common")],S.prototype,"messagesCommon",void 0),t.__decorate([l.property(),b.messageBundle("esri/widgets/Editor/t9n/Editor")],S.prototype,"messagesEditor",void 0),t.__decorate([l.property(),b.messageBundle("esri/widgets/Feature/t9n/Feature")],S.prototype,"messagesFeature",void 0),t.__decorate([l.property(),b.messageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")],S.prototype,"messagesFeatureForm",void 0),t.__decorate([l.property(),b.messageBundle("esri/widgets/support/FilterBuilder/t9n/FilterBuilder")],S.prototype,"messagesFilterBuilder",void 0),t.__decorate([l.property()],S.prototype,"selectedLayer",null),t.__decorate([l.property({type:h})],S.prototype,"viewModel",void 0),t.__decorate([l.property()],S.prototype,"selectedFeature",null),t.__decorate([l.property()],S.prototype,"filterWhereClause",null),t.__decorate([l.property()],S.prototype,"view",void 0),t.__decorate([l.property()],S.prototype,"_filterBuilder",void 0),t.__decorate([l.property()],S.prototype,"_featureFilterText",void 0),t.__decorate([l.property()],S.prototype,"_layerFilterText",void 0),t.__decorate([l.property()],S.prototype,"_observer",void 0),t.__decorate([l.property()],S.prototype,"_featureSpatialGraphics",null),t.__decorate([l.property()],S.prototype,"_filteredFeatureItems",null),t.__decorate([l.property()],S.prototype,"_filteredFeatureItemsPage",null),t.__decorate([l.property()],S.prototype,"_observerNode",void 0),S=t.__decorate([d.subclass("esri.widgets.FeatureForm.FeatureFormUtilityNetworkAssociations.UtilityNetworkAssociationItemList")],S),S});