// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../Graphic","../../core/Accessor","../../core/asyncUtils","../../core/Collection","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/sql","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/support/UpdatingHandles","../../layers/catalog/catalogUtils","../../layers/support/layerUtils","../Feature/support/featureUtils","../support/UtilityNetworkAssociations/utils/createAssociation","../support/UtilityNetworkAssociations/utils/getFeatureTitle"],function(e,t,r,a,o,s,i,n,l,u,c,y,d,p,h,_,g,f,b,m,A){"use strict";const C="association-key";return e.default=class extends a{constructor(e){super(e),this.graphic=null,this.layer=null,this.map=null,this.utilityNetwork=null,this.associationType=null,this.featureCount=0,this.featureSpatialItems=new s,this.highlightHelper=null,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=30,this.selectedFeature=null,this.association=null,this.filterOptionsVisible=!1,this.filterWhereClause=null,this._rulesTable=null,this._canAssociate=!1,this._whereClause=null,this._setUpItemsTask=null,this._updatingHandlesSetUp=new _.UpdatingHandles,this._queryFeaturesTask=null,this._updatingHandlesQueryFeatures=new _.UpdatingHandles,this._validateAssociationTask=null,this._updatingHandlesAssociation=new _.UpdatingHandles,this._featureIsNotSelected=e=>(this.globalIdField?e.attributes?.[this.globalIdField]??null:null)!==this.globalId,this._cancelQuery=()=>{const{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:e}=this;e&&e.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await n.ignoreAbortErrors(this._query()).catch(()=>this._cancelQuery()),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async e=>{this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await n.ignoreAbortErrors(this._queryFeatureCount(e)).catch(()=>this._cancelQueryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null)},this._queryPageController=async()=>{const e=new AbortController;this._queryPageAbortController=e,await n.ignoreAbortErrors(this._queryPage()).catch(()=>this._cancelQueryPage()),this._queryPageAbortController===e&&(this._queryPageAbortController=null)},this._queryDebounced=n.debounce(this._queryController,100),this._queryFeatureCountDebounced=n.debounce(this._queryFeatureCountController,100),this._queryPageDebounced=n.debounce(this._queryPageController,100)}initialize(){this.addHandles([l.watch(()=>[this.graphic,this.layer,this.map,this.utilityNetwork,this.globalId,this.associationType],()=>this._syncLayerItems(),l.initial),l.watch(()=>[this.selectedLayer,this.filterWhereClause,this.featuresPerPage],()=>{this.selectedLayer&&this._setUpFeatures()}),l.watch(()=>this.selectedFeature,()=>{this._setUpAssociation()}),l.watch(()=>this.featurePage,()=>this._queryPageDebounced())])}destroy(){this._setUpItemsTask=i.abortMaybe(this._setUpItemsTask),this._updatingHandlesSetUp.destroy(),this._queryFeaturesTask=i.abortMaybe(this._queryFeaturesTask),this._updatingHandlesQueryFeatures.destroy(),this._validateAssociationTask=i.abortMaybe(this._validateAssociationTask),this._updatingHandlesAssociation.destroy(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}get mapTables(){const{map:e}=this;if(!e)return null;const t=new Set;return e.allTables.forEach(e=>this._collectIfValidParent(e,t)),new s([...t])}get mapLayers(){const{map:e}=this;if(!e)return null;const t=new Set;return e.allLayers.forEach(e=>this._collectIfValidParent(e,t)),new s([...t])}get state(){const{canLoadLayers:e,_queryAbortController:t,_queryPageAbortController:r}=this;return e?t||r||this._updatingHandlesQueryFeatures.updating?"querying":this._updatingHandlesSetUp.updating?"loading":"ready":"disabled"}get canAddAssociation(){return!(this.updating||!this.association)&&this._canAssociate}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){const{layer:e}=this;return e?.globalIdField??null}get layerItems(){return this._get("layerItems")||new s}get tableItems(){return this._get("tableItems")||new s}get featureItems(){return this._get("featureItems")||new s}set featurePage(e){const{featuresPerPage:t,featureCount:r,featureSpatialItems:a}=this,o=a.length||r,s=Math.ceil(o/t)||1;this._set("featurePage",Math.min(Math.max(e,1),s))}get featurePage(){return this._get("featurePage")}get canLoadLayers(){const{map:e,utilityNetwork:t,graphic:r,associationType:a}=this;return!!(e&&t&&r&&a)}get canQuery(){const{utilityNetwork:e,graphic:t,associationType:r,selectedLayer:a}=this;return!!(e&&t&&r&&a)}get updating(){return this._updatingHandlesSetUp.updating||this._updatingHandlesAssociation.updating}get selectedLayer(){return this._get("selectedLayer")}set selectedLayer(e){e!==this.selectedLayer&&(this.filterWhereClause=null),this._set("selectedLayer",e)}get queryWhereClause(){const{_whereClause:e,filterWhereClause:t}=this;return u.sqlAnd(e,t)}async onSelectionComplete(e){const{associationType:t,featureSpatialItems:r,graphic:a,_rulesTable:o}=this,{selection:s}=e;if(r.removeAll(),!(t&&a&&o&&s?.length))return;const i=this._convertTypeToDirection(t.type),n=s.filter(this._featureIsNotSelected),l=o.getFeaturesCanAssociateWith(a,n,i),u=await this._processFeatures(l);r.addMany(u)}reset(){this.highlightHelper?.removeAll(),this.featureSpatialItems.removeAll(),this.featurePage=1}_collectIfValidLayer(e,t){b.isAssociatedFeatureSupportedLayer(e)&&!f.isSubtypeGroupLayer(e)&&t.add(e)}_collectIfValidParent(e,t){const r=e=>this._collectIfValidLayer(e,t);g.isLayerFromCatalog(e)||"catalog-footprint"===e.type||(f.isKnowledgeGraphLayer(e)?(e.layers?.forEach(r),e.tables?.forEach(r)):f.isMapImageLayer(e)?(e.sublayers?.forEach(r),e.subtables?.forEach(r)):f.isSubtypeGroupLayer(e)?e.sublayers?.forEach(r):this._collectIfValidLayer(e,t))}async _queryFeatureCount(e){const{selectedLayer:t,_queryFeatureCountAbortController:r}=this;if(this._set("featureCount",0),!t)return;await t.load();const a=t.createQuery();a.returnGeometry=!1,a.where=u.sqlAnd(a.where,e);const o=await t.queryFeatureCount(a,{signal:r?.signal});o>0&&this._set("featureCount",o)}async _query(){const{canQuery:e,queryWhereClause:t,_queryAbortController:r,featureItems:a}=this;e&&(this.featurePage=1,a.destroyAll(),this.featureCount&&!this.destroyed&&a.addMany(await this._queryAssociatedFeatures(t,{signal:r?.signal})))}async _queryPage(){const{canQuery:e,queryWhereClause:t,featurePage:r,_queryPageAbortController:a,featureCount:o,featureItems:s}=this;e&&(r<2||!o||s.addMany(await this._queryAssociatedFeatures(t,{signal:a?.signal})))}_convertTypeToDirection(e){switch(e){case"attachment":return[{type:"attachment",direction:"from"}];case"connectivity":return[{type:"junction-junction-connectivity"},{type:"junction-edge-from-connectivity"},{type:"junction-edge-midspan-connectivity"},{type:"junction-edge-to-connectivity"}];case"container":return[{type:"containment",direction:"to"}];case"content":return[{type:"containment",direction:"from"}];case"structure":return[{type:"attachment",direction:"to"}]}}async getRulesTable(){const{utilityNetwork:e}=this;if(!e)return null;if(this._rulesTable)return this._rulesTable;const t=await e.getRulesTable();return await(t?.load()),this._rulesTable=t,t}async _syncLayerItems(){i.abortMaybe(this._setUpItemsTask);const{graphic:e,associationType:t,layerItems:r,tableItems:a,canLoadLayers:s}=this,n=o.createTask(async o=>{if(this.selectedLayer=null,r.removeAll(),a.removeAll(),!s)return;const i=this.mapLayers?.toArray(),n=this.mapTables?.toArray();if(!i&&!n)return;if(o.aborted)return;const l=await this.getRulesTable(),u=this._convertTypeToDirection(t.type);if(i?.length){const t=l?.getLayersCanAssociateWith(e,i,u);if(o.aborted)return;r.addMany(t||[])}if(n?.length){const t=l?.getLayersCanAssociateWith(e,n,u);if(o.aborted)return;a.addMany(t||[])}});this._updatingHandlesSetUp.addPromise(n.promise),this._setUpItemsTask=n}async _setUpFeatures(){i.abortMaybe(this._queryFeaturesTask);const{graphic:e,associationType:t,selectedLayer:r,canQuery:a}=this;if(!a)return;const s=o.createTask(async a=>{const o=await this.getRulesTable(),s=this._convertTypeToDirection(t.type),i=o?.getFeaturesCanAssociateWithClause(e,r,s);this._whereClause=i,a.aborted||(await this._queryFeatureCountDebounced(this.queryWhereClause),await this._queryDebounced())});this._updatingHandlesQueryFeatures.addPromise(s.promise),this._queryFeaturesTask=s}_determineFromAndTo(e,t,r){return"from"===r?{fromFeature:e,toFeature:t}:{fromFeature:t,toFeature:e}}_determineJunctionEdgeConnectivity(e,t){const{utilityNetwork:r}=this,a=f.isSubtypeSublayer(e.sourceLayer)?e.sourceLayer.parent:e.sourceLayer,o=f.isSubtypeSublayer(t.sourceLayer)?t.sourceLayer.parent:t.sourceLayer;if(!(r&&a&&"layerId"in a&&o&&"layerId"in o))return{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"};const s=r.getSourceIdByLayerId(a.layerId),i=r.getSourceIdByLayerId(o.layerId);if(!s||!i)return{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"};const n="junction"===r.getSourceTypeById(s),l="junction"===r.getSourceTypeById(i);return n&&l?{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"}:l?{fromFeature:t,toFeature:e,type:"junction-edge-midspan-connectivity"}:{fromFeature:e,toFeature:t,type:"junction-edge-midspan-connectivity"}}_setUpAssociationHandles(){this.removeHandles(C),this.association&&this.addHandles(l.watch(()=>[this.association?.associationType,this.association?.fromNetworkElement,this.association?.fromNetworkElement?.terminalId,this.association?.toNetworkElement,this.association?.toNetworkElement?.terminalId],()=>this.validateAssociation(),l.initial),C)}_setUpAssociation(){const{utilityNetwork:e,graphic:t,selectedFeature:r,associationType:a}=this;if(!(e&&t&&r&&a))return void(this.association=null);const o=this._convertTypeToDirection(a.type);if(o.length>1){const{fromFeature:a,toFeature:o,type:s}=this._determineJunctionEdgeConnectivity(t,r.feature);return this.association=m.createAssociation({fromFeature:a,toFeature:o,utilityNetwork:e,associationType:s}),void this._setUpAssociationHandles()}const{fromFeature:s,toFeature:i}=this._determineFromAndTo(t,r.feature,o[0].direction);this.association=m.createAssociation({fromFeature:s,toFeature:i,utilityNetwork:e,associationType:o[0].type}),this._setUpAssociationHandles()}async _processFeatures(e){return Promise.all(e.map(async e=>{const{sourceLayer:t}=e;return t&&"getFeatureTitle"in t?{label:await t.getFeatureTitle(e)||A.getFeatureTitle(e),feature:e}:{label:A.getFeatureTitle(e),feature:e}}))}async _queryAssociatedFeatures(e,t){const{featuresPerPage:r,layer:a,featurePage:o,featureCount:s,selectedLayer:i}=this,{canQuery:n,globalId:l}=this;if(!n||!a||!i||null==l)return[];const c=((o-1)*r+s)%s,y=r,{historicMoment:d,gdbVersion:p}=i,h=i.createQuery();h.where=u.sqlAnd(h.where,e),h.start=c,h.num=y,h.returnGeometry=!1,h.historicMoment=d,h.gdbVersion=p,h.outFields=["*"];const _=await i.queryFeatures(h,{signal:t?.signal});return await this._processFeatures(_.features)}validateAssociation(){i.abortMaybe(this._validateAssociationTask);const{utilityNetwork:e,association:t}=this,r=o.createTask(async()=>{e&&t&&(this._canAssociate=await e.canAddAssociation(t))});this._updatingHandlesAssociation.addPromise(r.promise),this._validateAssociationTask=r}},t.__decorate([c.property({type:r})],e.default.prototype,"graphic",void 0),t.__decorate([c.property()],e.default.prototype,"layer",void 0),t.__decorate([c.property()],e.default.prototype,"map",void 0),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"mapTables",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"mapLayers",null),t.__decorate([c.property()],e.default.prototype,"utilityNetwork",void 0),t.__decorate([c.property()],e.default.prototype,"associationType",void 0),t.__decorate([c.property()],e.default.prototype,"state",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"canAddAssociation",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"globalId",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"globalIdField",null),t.__decorate([c.property()],e.default.prototype,"featureCount",void 0),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"layerItems",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"tableItems",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"featureItems",null),t.__decorate([c.property()],e.default.prototype,"featureSpatialItems",void 0),t.__decorate([c.property()],e.default.prototype,"highlightHelper",void 0),t.__decorate([c.property()],e.default.prototype,"_queryAbortController",void 0),t.__decorate([c.property()],e.default.prototype,"_queryPageAbortController",void 0),t.__decorate([c.property()],e.default.prototype,"_queryFeatureCountAbortController",void 0),t.__decorate([c.property({value:1})],e.default.prototype,"featurePage",null),t.__decorate([c.property()],e.default.prototype,"featuresPerPage",void 0),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"canLoadLayers",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"canQuery",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"updating",null),t.__decorate([c.property()],e.default.prototype,"selectedLayer",null),t.__decorate([c.property()],e.default.prototype,"selectedFeature",void 0),t.__decorate([c.property()],e.default.prototype,"association",void 0),t.__decorate([c.property()],e.default.prototype,"filterOptionsVisible",void 0),t.__decorate([c.property()],e.default.prototype,"filterWhereClause",void 0),t.__decorate([c.property()],e.default.prototype,"queryWhereClause",null),t.__decorate([c.property()],e.default.prototype,"_rulesTable",void 0),t.__decorate([c.property()],e.default.prototype,"_canAssociate",void 0),t.__decorate([c.property()],e.default.prototype,"_whereClause",void 0),e.default=t.__decorate([h.subclass("esri.widgets.FeatureForm.UtilityNetworkAssociationAddAssociationViewModel")],e.default),e.default});