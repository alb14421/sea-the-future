// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../layers/support/layerUtils","../Feature/FeatureRelationship/FeatureRelationshipViewModel","../Feature/support/featureUtils","./EditableInput","./featureFormUtils"],function(e,t,r,o,i,a,l,s,n,p,d,u){"use strict";let y=class extends d{constructor(e){super(e),this._relationshipVM=null,this.group=null,this.type="relationship",this.addHandles([t.watch(()=>({feature:this.feature,element:this.element,layer:this.layer}),e=>this._createRelationshipVM(e),t.initial),t.on(()=>this.relatedLayer,"edits",()=>this._relationshipVM?.refresh())])}destroy(){this._relationshipVM?.destroy()}get canAddRelatedFeature(){const{editable:e,featureCount:t,relationship:r}=this;if(!r||!this.loaded||!this.relatedLayerAllowsAdds)return!1;if(this.allCategories?.length&&!this.activeCategory)return!1;const{cardinality:o,role:i}=r;return!("one-to-one"===o&&t>0)&&"many-to-many"!==o&&!("one-to-many"===o&&"destination"===i&&t>0)&&e}get activeCategory(){return this._relationshipVM?.activeCategory}set activeCategory(e){const t=this._relationshipVM;t&&(t.activeCategory=e)}get allCategories(){const{relatedLayer:e}=this,t=this._relationshipVM?.categories;if(!s.isSubtypeGroupLayer(e))return;const r=(e.subtypes??[]).map(({code:e,name:r})=>{const o=t?.find(e=>e.name===r);return{name:r,count:o?.count??0,value:o?.value??e}});return r.length?r:null}get categories(){return this.showAllEnabled?this.allCategories:this.allCategories?.slice(0,this.displayCount)}get displayCount(){return this.element.displayCount??3}get displayType(){return this.element.displayType}get editable(){return!!this.relatedLayerAllowsEdits&&(this.evaluatedEditableExpression??!0)}get featureCount(){return this._relationshipVM?.featureCount??0}get label(){return this.activeCategory?.name?this.activeCategory.name:this.getFormattedLabel(this.element?.label)}get loaded(){return"loading"!==this._relationshipVM?.state}get map(){return this._get("map")}set map(e){e&&this._relationshipVM?.set("map",e),this._set("map",e)}get orderByFields(){return this.element.orderByFields}get originHasValidKey(){return!(!this.relationship||!this.feature.getAttribute(this.relationship.keyField))}get relationship(){return this._relationshipVM?.relationship}get relationshipId(){return this.element.relationshipId}get relatedFeatureInfos(){const{_relationshipVM:e,timeZone:t}=this;if(!e?.relatedFeatures?.length||!e?.relatedLayer)return[];const{itemDescriptionFieldName:r,relatedFeatures:o,relatedLayer:i}=e,a=i&&"formTemplate"in i&&i.formTemplate?i.formTemplate.title:void 0;return o.map(e=>{let o;if(r){const a=e.getAttribute(r),l=i.fieldsIndex.get(r);if(l){const e=u.getComputedAttributes({values:[a],fields:[l],timeZone:t??void 0})[r];null!=e&&(o=e.toString())}}return{feature:e,description:o,title:a?u.parseFormTemplateString({label:a,attributes:e.attributes,fieldsIndex:i.fieldsIndex,timeZone:t}):void 0}}).toArray()}get relatedLayer(){return this._relationshipVM?.relatedLayer}get relatedLayerIsTable(){return!!this.relatedLayer?.isTable}get relatedLayerAllowsAdds(){const{relatedLayer:e}=this;if(!e||!this.relatedLayerAllowsEdits)return!1;const t=s.getEffectiveLayerCapabilities(e);return!!t?.operations?.supportsAdd}get relatedLayerAllowsEdits(){const{relatedLayer:e}=this;if(!e)return!1;const t=s.getEffectiveLayerCapabilities(e);return!!t?.operations?.supportsEditing}get showAllEnabled(){return this._get("showAllEnabled")}set showAllEnabled(e){this._relationshipVM?.set("showAllEnabled",e),this._set("showAllEnabled",e)}get showAllActionVisible(){return!this.showAllEnabled&&this.featureCount>0&&this.featureCount>this.displayCount}get showAllCategoriesVisible(){const e=this.allCategories?.length??0;return!this.showAllEnabled&&e>0&&e>this.displayCount}get visible(){const{relationship:e}=this;if(!e)return!1;const{cardinality:t}=e;return"many-to-many"!==t&&(null!=this.evaluatedVisibilityExpression?this.evaluatedVisibilityExpression:null!=this.element)}get updating(){return"loading"===this._relationshipVM?.state||"querying"===this._relationshipVM?.state}incrementPage(){this._relationshipVM&&this._relationshipVM.featurePage++}getRelatedFeatureByObjectId(e){return this._relationshipVM?.getRelatedFeatureByObjectId(e)}_createRelationshipVM(e){const{feature:t,element:r,layer:o}=e;if(this._relationshipVM?.destroy(),!t||!r||!o)return;const{displayCount:i,map:a,orderByFields:l,relationshipId:s,showAllEnabled:d}=this;p.isRelatableFeatureSupportedLayer(o)&&(this._relationshipVM=new n({graphic:t,displayCount:i,layer:o,map:a,orderByFields:l,relationshipId:s,showAllEnabled:d}))}};return e.__decorate([r.property()],y.prototype,"_relationshipVM",void 0),e.__decorate([r.property()],y.prototype,"canAddRelatedFeature",null),e.__decorate([r.property()],y.prototype,"activeCategory",null),e.__decorate([r.property()],y.prototype,"allCategories",null),e.__decorate([r.property()],y.prototype,"categories",null),e.__decorate([r.property()],y.prototype,"displayCount",null),e.__decorate([r.property()],y.prototype,"displayType",null),e.__decorate([r.property()],y.prototype,"editable",null),e.__decorate([r.property()],y.prototype,"featureCount",null),e.__decorate([r.property()],y.prototype,"group",void 0),e.__decorate([r.property()],y.prototype,"label",null),e.__decorate([r.property()],y.prototype,"loaded",null),e.__decorate([r.property()],y.prototype,"map",null),e.__decorate([r.property()],y.prototype,"orderByFields",null),e.__decorate([r.property()],y.prototype,"originHasValidKey",null),e.__decorate([r.property()],y.prototype,"relationship",null),e.__decorate([r.property()],y.prototype,"relationshipId",null),e.__decorate([r.property()],y.prototype,"relatedFeatureInfos",null),e.__decorate([r.property()],y.prototype,"relatedLayer",null),e.__decorate([r.property()],y.prototype,"relatedLayerIsTable",null),e.__decorate([r.property()],y.prototype,"relatedLayerAllowsAdds",null),e.__decorate([r.property()],y.prototype,"relatedLayerAllowsEdits",null),e.__decorate([r.property()],y.prototype,"showAllEnabled",null),e.__decorate([r.property()],y.prototype,"showAllActionVisible",null),e.__decorate([r.property()],y.prototype,"showAllCategoriesVisible",null),e.__decorate([r.property({readOnly:!0})],y.prototype,"type",void 0),e.__decorate([r.property()],y.prototype,"visible",null),e.__decorate([r.property()],y.prototype,"updating",null),y=e.__decorate([l.subclass("esri.widgets.FeatureForm.RelationshipInput")],y),y});