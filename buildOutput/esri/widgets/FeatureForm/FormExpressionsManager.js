// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../core/Accessor","../../core/has","../../core/Logger","../../core/MapUtils","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],function(e,t,r,s,o,a,n,i,c,l){"use strict";const p="#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY";e.FormExpressionsManager=class extends r{constructor(e){super(e),this._fieldReferencesLookup=new Map,this._fieldsAffectedLookup=new Map,this.preserveFieldValuesWhenHidden=!0,this._latestFieldValues={...e.feature.attributes}}initialize(){this._dependencyGraph=this._buildDependencyGraph()}destroy(){this.resetExecutors()}get _asyncExecutors(){return this.executors.filter(e=>e.isAsync)}get _baseContext(){const{editType:e,layer:t,map:r,originalFeature:s,spatialReference:o,timeZone:a}=this.arcadeContextInfo,n="scene"===t?.type&&null!=t.associatedLayer?t.associatedLayer:t;return[{$originalfeature:s,$editcontext:{editType:e},$layer:n,$featureset:n,$datastore:t?.url,$map:r},{rawOutput:!0,spatialReference:o??void 0,timeZone:a}]}set feature(e){this._latestFieldValues={...e?.attributes},this._set("feature",e)}evaluateAll(){return this._evaluate(this.executors)}evaluateAsyncExpressions(){return this._evaluate(this._asyncExecutors)}evaluateExpressions(e){return this._evaluate(e)}evaluateInvalidated(e){const{_fieldReferencesLookup:t,_latestFieldValues:r,feature:s}=this,o=new Set;for(const a of e)if(r[a]=s.getAttribute(a),t.has(a))for(const e of t.get(a))o.add(e);return this._evaluate([...o])}async evaluateInvalidatedByGeometry(){if(this._fieldReferencesLookup.has(p))return this._evaluate([...this._fieldReferencesLookup.get(p)])}resetExecutors(){for(const e of this.executors)e.reset()}_buildDependencyGraph(){const{_fieldReferencesLookup:e,_fieldsAffectedLookup:t,executors:r,preserveFieldValuesWhenHidden:s}=this,o=new Map(this.fieldInputs.map(e=>[e.name,e])),n=!1===s,i=new Map(r.map(e=>[e,new Array]));for(const s of r){for(const r of s.fieldsUsed){a.getOrCreateMapValue(e,r,()=>new Set).add(s);const c=o.get(r);[c?.valueExpressionExecutor,c?.editableExpressionExecutor,n?c?.group?.visibilityExpressionExecutor:null,n?c?.visibilityExpressionExecutor:null].filter(e=>null!=e&&e!==s).forEach(e=>{i.get(e).push(s),a.getOrCreateMapValue(t,e,()=>new Set).add(c)})}s.geometryUsed&&a.getOrCreateMapValue(e,p,()=>new Set).add(s)}return i}async _evaluate(e){const t=new Map,{_dependencyGraph:r,_fieldsAffectedLookup:s,_latestFieldValues:a}=this;for(const s of e)u(s,t,r);for(const[e,{resolver:r,dependencyPromises:o}]of t)Promise.all(o).then(async()=>{const[t,r]=this._makeContext(a);return e.executeAsync(t,r)}).then(()=>{if(s.has(e))for(const t of s.get(e))this._latestFieldValues[t.name]=t.value;r.resolve()},t=>{!t||n.isAbortError(t)||d(t)||e.markStale(),r.reject(t)});const i=(await Promise.allSettled(Array.from(t.values(),({resolver:e})=>e.promise))).filter(e=>"rejected"===e.status&&!(n.isAbortError(e.reason)||d(e.reason)));if(i.length>0){const e=new AggregateError(i,`One or more expression executions failed. First error message: ${i[0].reason}`);throw o.getLogger(this).error(e),e}}_makeContext(e){const[t,r]=this._baseContext,s=this.feature.clone();return s.attributes=e,[{...t,$feature:s},r]}get test(){}},t.__decorate([i.property()],e.FormExpressionsManager.prototype,"_asyncExecutors",null),t.__decorate([i.property()],e.FormExpressionsManager.prototype,"_baseContext",null),t.__decorate([i.property()],e.FormExpressionsManager.prototype,"feature",null),t.__decorate([i.property({constructOnly:!0})],e.FormExpressionsManager.prototype,"preserveFieldValuesWhenHidden",void 0),t.__decorate([i.property()],e.FormExpressionsManager.prototype,"executors",void 0),t.__decorate([i.property()],e.FormExpressionsManager.prototype,"fieldInputs",void 0),t.__decorate([i.property()],e.FormExpressionsManager.prototype,"arcadeContextInfo",void 0),e.FormExpressionsManager=t.__decorate([l.subclass("esri.widgets.FeatureForm.FormExpressionsManager")],e.FormExpressionsManager);const u=(e,t,r)=>{if(t.has(e))return;const s=n.createResolver();t.set(e,{resolver:s,dependencyPromises:[]}),e.abort();const o=r.get(e);for(const e of o)u(e,t,r),t.get(e).dependencyPromises.push(s.promise)},d=e=>e&&"object"==typeof e&&"message"in e&&"Cancelled"===e.message;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});