// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../intl","../../core/arrayUtils","../../core/compilerUtils","../../core/lang","../../core/Logger","../../core/string","../../form/support/formUtils","../../layers/support/fieldUtils","../../layers/support/layerUtils","../../smartMapping/support/utils","../support/dateUtils","../support/forms/formUtils","../../intl/substitute"],function(e,t,n,i,r,o,l,a,s,u,p,d,m,c){"use strict";const f=e=>"field"===e?.type,y=e=>"group"===e?.type,g=e=>"relationship"===e?.type,F=e=>"utilityNetworkAssociations"===e.type,b=e=>!y(e)&&null!=e.group,I=e=>e.reduce((e,t)=>y(t)?[...e,...t.inputs]:[...e,t],[]),h=(e,t)=>null!=e&&e.input?.type===t,v="expression/";function x(e){const{fields:t,values:n}=e,i=e.timeZone??void 0,r=t.map((e,t)=>{let r=n[t];if(e.domain&&"coded-value"===e.domain.type){const t=e.domain.codedValues.find(e=>e.code===r);t?.name&&(r=t.name)}return(p.isAnyDateField(e)||s.isTimeOnlyField(e))&&(r=d.getLabelForDateFieldValue(e,r,{timeZone:i,...d.getIntlOptionsForField(e)})),[e.name,r]});return Object.fromEntries(r)}function T(e,t){return l.replace(l.replace(e,e=>`{${e.toLowerCase()}}`),Object.fromEntries(Object.entries(t).map(([e,t])=>[e.toLowerCase(),t])))}e.extractExpressionNameFromString=function(e){const[t,n]=e.split(v);return""===t&&n?n:(o.getLogger("esri.widgets.FeatureForm/featureFormUtils").error("extractExpressionNameFromString:invalid-input",`The string ${e} is not a valid expression reference of the form '${v}/expressionName'`),"")},e.flattenAssociationInputs=e=>I(e).filter(F),e.flattenFieldInputs=e=>I(e).filter(f),e.flattenInputs=I,e.flattenRelationshipInputs=e=>I(e).filter(g),e.formTemplateHasInvalidFields=function(e,t){const n=t??("formTemplate"in e&&e.formTemplate);return!!n&&(n.elements?.filter(a.isFieldElement)??[]).some(({fieldName:t})=>!e.fieldsIndex.get(t))},e.getComputedAttributes=x,e.getErrorMessageForFieldInput=(e,t,n)=>{const{dataType:i,error:r,minLength:o}=e,l=t?.validationErrors;if(!l||!r)return null;if("input-validation-error::cannot-be-empty"===r)return l.cannotBeNull;if("domain-validation-error::value-out-of-range"===r||"numeric-range-validation-error::out-of-range"===r){const{field:t,range:r}=e,o={type:"date",intlOptions:{timeZone:"date"===t.type&&n?n:void 0,...d.getIntlOptionsForField(t)}},a=m.getRangeErrorMessage(r,l);return c.substitute(a,r,{format:{max:"date"===i?o:null!=r.max&&m.shouldUseScientificNotation(r.max)?m.scientificNumberFormatOptions:m.numberFormatOptions,min:"date"===i?o:null!=r.min&&m.shouldUseScientificNotation(r.min)?m.scientificNumberFormatOptions:m.numberFormatOptions}})}return"domain-validation-error::invalid-coded-value"===r?l.invalidCodedValue:"type-validation-error::invalid-type"===r?l.invalidType:"length-validation-error::too-short"===r?c.substitute(l.tooShort,{min:o}):null},e.getFieldsInTitleAndDesc=e=>{const t=[];if(e.formTemplate){const{description:n,title:i}=e.formTemplate;e.fields?.forEach(e=>{const r=i&&l.templateHasKey(i,e.name),o=n&&l.templateHasKey(n,e.name);(r||o)&&t.push(e.name)})}return t},e.getIconForFeature=e=>{if(!e)return;const t=e.layer,n=t&&"geometryType"in t?t.geometryType:void 0,i=e.geometry?.type;return"polyline"===i||"polyline"===n?"line":"mesh"===i||"mesh"===n||"multipatch"===n?"cube":"multipoint"===i||"multipoint"===n?"point":i||n||"table"},e.getNormalizedFeatureTypeInfo=e=>{const t={typeFieldName:null,types:[]};return e?(u.isSubtypeSublayer(e)?(t.typeFieldName=e.parent?.subtypeField,t.types=e.parent?.subtypes??[]):"subtype-group"===e.type||"feature"===e.type&&e.subtypes?.length?(t.typeFieldName=e.subtypeField,t.types=e.subtypes??[]):"types"in e&&e.types&&(t.typeFieldName=e.typeIdField,t.types=e.types.map(({id:e,name:t,domains:n})=>({code:e,name:t,domains:n}))),null!=t.typeFieldName&&(t.typeFieldName=e.getField(t.typeFieldName)?.name??t.typeFieldName),t):t},e.isExpressionReference=function(e){return e.startsWith(v)},e.isFieldElementWithInputType=h,e.isFieldElementWithShowNoValueOptionInput=e=>null!=e&&(h(e,"combo-box")||h(e,"radio-buttons")),e.isFieldInput=f,e.isGroupInput=y,e.isInputInGroupInput=b,e.isInputInThisGroupInput=(e,t)=>b(e)&&e.group===t,e.isLegacyFieldMapsExpressionReference=function(e){return e.startsWith("expr/")},e.isNumberFieldInput=({domain:e,inputType:t="text-box",dataType:n})=>"number"===n&&"text-box"===t&&(!e||"coded-value"!==e.type),e.isRelationshipInput=g,e.isTextElementInput=e=>"text"===e.type,e.isUtilityNetworkAssociationInput=F,e.parseFormTemplateString=function(e){const{attributes:t,fieldsIndex:i,label:r,timeZone:o}=e;if(!t||"object"!=typeof t)return r;const a=Object.keys(t).filter(e=>l.templateHasKey(r,e)),s=a.map(e=>t[e]),u=a.map(e=>i.get(e)).filter(n.isSome);return T(r,x({values:s,fields:u,timeZone:o}))},e.prependExpressionPrefix=function(e){return`${v}${e}`},e.prependFieldPrefix=function(e){return`field/${e}`},e.substituteFieldTemplatesInString=T,e.subtypeChangeShouldPrompt=function(e,t,n){const i=u.getSubtypesFromLayer(e),o=i?.find(e=>e.code===n);if(!o)return!1;const l=i?.find(e=>e.code===t);return!r.equalsShallow(o.defaultValues,l?.defaultValues)&&Object.values(o.defaultValues).some(e=>null!=e)},e.valueIsInvalidSwitchValue=function(e,t){return null==e||t.onValue!==e&&t.offValue!==e},e.valueIsValidContingentValue=function(e,t){switch(t.objectType){case"any":return!0;case"null":return null==e;case"code":return e===t.codedValue?.code;case"range":return null!=e&&null!=t.minValue&&null!=t.maxValue&&+e>=t.minValue&&+e<=t.maxValue;default:return i.neverReached(t.objectType),!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});