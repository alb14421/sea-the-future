// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/Identifiable","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/support/UpdatingHandles","../Feature/support/featureUtils","./EditableInput","../support/UtilityNetworkAssociations/FeatureUtilityNetworkAssociationsViewModel"],function(t,e,s,o,i,a,r,n,p,c,l,d,u){"use strict";let y=class extends(e.IdentifiableMixin(d)){constructor(t){super(t),this.group=null,this.type="utilityNetworkAssociations",this.featureItem=null,this._updatingHandlesSetUp=new c.UpdatingHandles,this.addHandles([o.watch(()=>({feature:this.feature,element:this.element,layer:this.layer}),t=>this._createAssociationVM(t),o.initial),o.watch(()=>this.feature,()=>this._setFeatureItem()),o.watch(()=>this.associatedLayer,(t,e)=>this._updateLayerEditHandle(t,e),o.initial)])}destroy(){this._associationsVM?.destroy(),this._updatingHandlesSetUp.destroy()}get activeAssociationType(){return this._associationsVM?.activeAssociationType}get associatedFeatures(){const{associatedLayer:t}=this;if(t)return this.associatedFeatureInfos.get(t)}get associatedFeatureInfos(){const{_associationsVM:t}=this;if(!t?.associationFeatures?.size||!t?.utilityNetwork)return new Map;const{associationFeatures:e}=t,s=new Map;return e.forEach((t,e)=>{s.set(e,t)}),s}get associatedLayer(){return this._get("associatedLayer")}set associatedLayer(t){this._associationsVM.showAllEnabled=null!=t,this._set("associatedLayer",t)}get associationsViewModel(){return this._associationsVM}get canAddAssociation(){const{editable:t,utilityNetwork:e}=this;return!(!e||!this.loaded)&&t}get editable(){return this.evaluatedEditableExpression??!0}get featureCount(){return this._associationsVM?.featureCount??0}get viewModel(){return this._associationsVM}get loaded(){return"loading"!==this._associationsVM?.state&&!this._updatingHandlesSetUp.updating}get map(){return this._get("map")}set map(t){t&&this._associationsVM?.set("map",t),this._set("map",t)}get utilityNetwork(){return this._associationsVM?.utilityNetwork}get associationTypes(){return this._associationsVM?.associationTypes??this.element.associationTypes}get visible(){const{utilityNetwork:t}=this;return!!t&&(null!=this.evaluatedVisibilityExpression?this.evaluatedVisibilityExpression:null!=this.element)}get updating(){return"loading"===this._associationsVM?.state||"querying"===this._associationsVM?.state}async refresh(){await s.ignoreAbortErrors(this._associationsVM.refresh())}_updateLayerEditHandle(t,e){e&&"layerId"in e&&this.removeHandles(e?.layerId),l.isAssociatedFeatureSupportedLayer(t)&&this.addHandles(o.on(()=>t,"edits",()=>this.refresh()),t.layerId)}_createAssociationVM(t){const{feature:e,element:s,layer:o}=t;if(this._associationsVM?.destroy(),!e||!s||!o)return;const{map:i,associationTypes:a}=this;l.isAssociatedFeatureSupportedLayer(o)&&(this._associationsVM=new u({graphic:e,layer:o,map:i,associationTypes:a,source:"featureForm",title:this.label,description:this.description}))}_setFeatureItem(){this._updatingHandlesSetUp.addPromise((async()=>{const{feature:t,layer:e}=this;t&&e&&"getFeatureTitle"in e&&(this.featureItem={feature:t,label:await e.getFeatureTitle(t)})})())}};return t.__decorate([i.property()],y.prototype,"_associationsVM",void 0),t.__decorate([i.property()],y.prototype,"activeAssociationType",null),t.__decorate([i.property()],y.prototype,"associatedFeatures",null),t.__decorate([i.property()],y.prototype,"associatedFeatureInfos",null),t.__decorate([i.property()],y.prototype,"associatedLayer",null),t.__decorate([i.property()],y.prototype,"associationsViewModel",null),t.__decorate([i.property()],y.prototype,"canAddAssociation",null),t.__decorate([i.property()],y.prototype,"editable",null),t.__decorate([i.property()],y.prototype,"featureCount",null),t.__decorate([i.property()],y.prototype,"viewModel",null),t.__decorate([i.property()],y.prototype,"group",void 0),t.__decorate([i.property()],y.prototype,"loaded",null),t.__decorate([i.property()],y.prototype,"map",null),t.__decorate([i.property()],y.prototype,"utilityNetwork",null),t.__decorate([i.property()],y.prototype,"associationTypes",null),t.__decorate([i.property({readOnly:!0})],y.prototype,"type",void 0),t.__decorate([i.property()],y.prototype,"visible",null),t.__decorate([i.property()],y.prototype,"updating",null),t.__decorate([i.property()],y.prototype,"featureItem",void 0),y=t.__decorate([p.subclass("esri.widgets.FeatureForm.UtilityNetworkAssociationInput")],y),y});