// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/mathUtils","../../core/promiseUtils","../../core/quantityFormatUtils","../../core/quantityUtils","../../core/libs/gl-matrix-2/math/mat3","../../core/libs/gl-matrix-2/factories/mat3f64","../../core/libs/gl-matrix-2/factories/vec3f64","../../core/libs/gl-matrix-2/math/vec2","../../chunks/vec32","../../geometry/Point","../../geometry/Polygon","../../geometry/Polyline","../../geometry/projectionUtils","../../geometry/SpatialReference","../../chunks/areaOperator","../../chunks/geodeticAreaOperator","../../chunks/geodeticDensifyOperator","../../chunks/geodeticLengthOperator","../../chunks/lengthOperator","../../geometry/operators/projectOperator","../../chunks/simplifyOperator","../../geometry/support/geodesicUtils","../../layers/orientedImagery/transformations/imageToWorld","../../layers/orientedImagery/transformations/utils","../../layers/orientedImagery/transformations/worldToImage"],function(e,t,n,r,a,o,c,i,s,u,l,f,m,p,h,g,y,d,x,w,M,P,R,z,v,b){"use strict";const I=1e5;function A(e,t){let n=180*Math.atan2(-e.y+t.y,e.x-t.x)/Math.PI;return n<0&&(n+=180),n*Math.PI/180}function L(e,t,n){if(!e?.length||!t?.length||!n)return;const[r,a]=e,[,o]=t,c=o-a;return[r+c*Math.cos(n),a+c*Math.sin(n)]}async function T(e,t,n){if(await d.load(),R.isSupported(e)){const e=R.geodesicLengths([t],"meters")[0];return{area:R.geodesicAreas([n],"square-meters")[0],perimeter:e}}const r=h.WGS84,a=p.project(t,r),o=p.project(n,r);let c=d.execute(o,I);if(c=c?P.execute(c):null,!c)return null;const i=R.geodesicLengths([a],"meters")[0];return{area:R.geodesicAreas([c],"square-meters")[0],perimeter:i}}async function W(e){await x.load();const t=e.spatialReference;if(t.isGeographic){if(R.isSupported(t))return R.geodesicLengths([e],"meters")[0];const n=p.project(e,h.WGS84);return R.geodesicLengths([n],"meters")[0]}return t.isWebMercator?x.execute(e):w.execute(e)}function O(e,t){const n=P.execute(t);if(!n)return null;const r=w.execute(e);return{area:g.execute(n),perimeter:r}}function D(e,t){return[(e[1][0]-e[0][0])/t,(e[1][1]-e[0][1])/t,(e[1][2]-e[0][2])/t]}async function E(e,t){await Promise.all([y.load(),d.load(),x.load()]);let n=d.execute(t,I);if(n=n?P.execute(n):null,!n)return null;const r=x.execute(e);return{area:y.execute(n),perimeter:r}}function q(e,t,n,r,a=0,o=1,c){const{averageElevation:i,cameraPitch:u,cameraRoll:f,farDistance:m,...p}=r;if(a>=5||o<=.1)return{value:e*J(r.cameraLocation.spatialReference)};const h=new l({x:t.x,y:t.y,z:t.z?t.z+e:e,spatialReference:r.cameraLocation.spatialReference}),g=b.worldToImage(h,p),y=s.distance([n[0].x,n[0].y],[g.x,g.y]),d=n.at(0),x=n.at(-1);if(!d||!x)return null;const w=s.distance([d.x,d.y],[x.x,x.y])*e/y;return q(w,t,n,r,a+1,Math.abs(e-w))}function k(e,t,n,r,a=0,o=1,c){const{averageElevation:i,horizontalFieldOfView:u,verticalFieldOfView:f,farDistance:m,...p}=r;if(a>=5||o<=.1)return{value:e*J(r.cameraLocation.spatialReference)};const h=new l({x:t.x,y:t.y,z:t.z?t.z+e:e,spatialReference:r.cameraLocation.spatialReference}),g=b.worldToImagePanoramic(h,p),y=s.distance([n[0].x,n[0].y],[g.x,g.y]),d=n.at(0),x=n.at(-1);if(!d||!x)return null;const w=s.distance([d.x,d.y],[x.x,x.y])*e/y;return k(w,t,n,r,a+1,Math.abs(e-w))}function S(e,t,n){return new m({paths:[[[e.x,e.y,e.z??0],[t.x,t.y,t.z??0]]],spatialReference:n})}function C(e){return 1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*e/6378137)))}function G(e,t){return new l({x:(e.pointOnA[0]+e.pointOnB[0])/2,y:(e.pointOnA[1]+e.pointOnB[1])/2,z:(e.pointOnA[2]+e.pointOnB[2])/2,spatialReference:t})}async function j(e,t){const{updateElevationProps:n,...r}=t;return await z.imageToWorld(e,r,n)}async function H(e,t){const{updateElevationProps:n,...r}=t;return z.imageToWorldPanoramic(e,r,n)}function U(e){const t=e.map(e=>[e.x,e.y]),n=e[0].spatialReference;return new m({paths:[t],spatialReference:n})}function F(e,t){return e.map(e=>({x:t?.5+e[0]:e[0],y:t?.5-e[1]:e[1]}))}function V(e,t){const{cameraPitch:n,cameraRoll:r,cameraLocation:a}=e,{x:o,y:c,z:i,spatialReference:s}=a;if(t.every(e=>0===e)||!t||!t.length)return null;const[u,f,,m,p]=t,h=[-m,0,m],g=[-p,0,p],y=[-u,0,u],d=[-f,0,f],x=[];for(const t of h)for(const a of g)for(const u of y)for(const f of y)for(const m of d){const p={...e};p.cameraPitch=n+t,p.cameraRoll=r+a,p.cameraLocation=new l({x:o+u,y:c+f,z:i?i+m:0,spatialReference:{wkid:s.wkid}}),x.push(p)}return x}function B(e,t){const{cameraHeading:n,cameraLocation:r}=e,{x:a,y:o,z:c,spatialReference:i}=r;if(t.every(e=>0===e)||!t||!t.length)throw new Error("Invalid parameters");const[s,u,f]=t,m=f>0?[-f,0,f]:[],p=s>0?[-s,0,s]:[],h=u>0?[-u,0,u]:[],g=[];for(const t of m)for(const r of p)for(const s of p)for(const u of h){const f={...e};f.cameraHeading=n+t,f.cameraLocation=new l({x:a+r,y:o+s,z:c?c+u:0,spatialReference:{wkid:i.wkid}}),g.push(f)}return g}function Z(e){return Math.sqrt(e.reduce((e,t)=>e+t**2,0))}function J(e){return e.metersPerUnit}async function K(e,t,r,a=!1,o=!1,c){if(!e||!t||e.length<2)return null;const i=F(e,a);if(!i||i.length<2)return null;const[u,l]=[i[0],i.at(-1)];if(!l)return null;const f=[u],m=await z.imageToWorld(u,t);n.throwIfAborted(c);const p=m.clone();p.z?p.z+=20:p.z=20;const{averageElevation:h,cameraPitch:g,cameraRoll:y,farDistance:d,...x}=t,w=b.worldToImage(p,x),M=s.distance([u.x,u.y],[w.x,w.y]),P=A(u,w);if(!P)return;const R=L([u.x,u.y],[l.x,l.y],P);if(!R?.length)return;f.push({x:R[0],y:R[1]});const v=20*s.distance([f[0].x,f[0].y],[f[1].x,f[1].y])*J(t.cameraLocation.spatialReference)/M;if(!o)return v;const I=q(v,m,f,t,0,1);return I?.value}async function N(e,t,r,a,o=!1,c=!1,i){const{attributes:u}=a,{location:l}=u,{updateElevationProps:f,...m}=t;if(!e||!t||e.length<2)throw new Error("Invalid parameters");const g=F(e,o),[y,d]=[g[0],g.at(-1)],x=[y];let w=l.clone();w.spatialReference.isGeographic&&(w=await p.projectWithZConversion(w,h.WebMercator));const M=await z.imageToWorldPanoramic(y,{...m,cameraLocation:w},f);n.throwIfAborted(i);const P=M.clone();P.z?P.z+=20:P.z=20;const R=b.worldToImagePanoramic(P,m),v=s.distance([y.x,y.y],[R.x,R.y]),I=A(y,R);if(!I)return;const T=L([y.x,y.y],[d.x,d.y],I);if(!T?.length)return;x.push({x:T[0],y:T[1]});const W=20*s.distance([x[0].x,x[0].y],[x[1].x,x[1].y])*J(t.cameraLocation.spatialReference)/v;if(!c)return W;const O=k(W,M,x,t,0,1);return O?.value}async function Q(e,t){const n=c.create(),r=e.paths[0][0],a=t.paths[0][0];let s,l;e.spatialReference.isWGS84||e.spatialReference.isWebMercator?(await x.load(),s=x.execute(e),l=x.execute(t)):(s=w.execute(e),l=w.execute(t));const f=D(e.paths[0],s),m=D(t.paths[0],l),p=function(e,t){const n=i.zeros(),r=u.set(i.zeros(),e[0],e[1],e[2]),a=u.set(i.zeros(),t[0],t[1],t[2]),o=u.cross(n,r,a);return[o[0],o[1],o[2]]}(f,m),[h,g,y]=f,[d,M,P]=m.map(e=>-e),[R,z,v]=p,[b,I,A]=[a[0]-r[0],a[1]-r[1],a[2]-r[2]];o.set(n,h,d,R,g,M,z,y,P,v);const L=o.determinant(n);if(0===L)return null;o.set(n,b,d,R,I,M,z,A,P,v);const T=o.determinant(n);o.set(n,h,b,R,g,I,z,y,A,v);const W=o.determinant(n);o.set(n,h,d,b,g,M,I,y,P,A);const O=T/L,E=W/L,q=o.determinant(n)/L;return{distance:Math.abs(q/Math.sqrt(p[0]*p[0]+p[1]*p[1]+p[2]*p[2])),pointOnA:X(r,O,f),pointOnB:X(a,E,m)}}function X(e,t,n){return[e[0]+t*n[0],e[1]+t*n[1],e[2]+t*n[2]]}function Y(e,t){const n=i.fromValues(e[0],e[1],e[2]),r=i.fromValues(t[0],t[1],t[2]);return u.sub(i.zeros(),n,r)}function $(e,t,n){const r=v.scaleWithFactor(e,t,n);return[r[0],r[1],r[2]]}e.calculateAngle=A,e.calculateAnglePano=function(e,t){let n=180*Math.atan2(-e.y+t.y,e.x-t.x)/Math.PI;return n<0&&(n+=180),n*Math.PI/180},e.calculateCorrectedPixel=L,e.calculateHeightAccuracy=async function(e,t,r,a,o=!1,c){if(t.length<2||!a||!r||!e)return null;const i=V(r,e);if(!i)return null;const s=t.map(e=>[e.x,e.y]),u=s.at(0),l=s.at(-1);if(!u||!l)return null;const f=i.map(e=>K([u,l],e,0,o,!1)),m=await Promise.all(f);n.throwIfAborted(c);let p=0;for(const e of m){if(!e)return null;const t=Math.abs(e-a);p=Math.max(t,p)}return p},e.calculateHeightAccuracyPanoramic=async function(e,t,r,a,o,c=!1,i){if(t.length<2||!a||!r||!e)throw new Error("Missing parameters");const s=B(r,e),u=t.map(e=>[e.x,e.y]),l=u.at(0),f=u.at(-1),m=s.map(e=>N([l,f],e,0,o,c,!1)),p=await Promise.all(m);n.throwIfAborted(i);let h=0;for(const e of p){if(!e)return 0;const t=Math.abs(e-a);h=Math.max(t,h)}return h},e.calculateHeightFromTemporaryDistance=function(e,t,n=1){const r=F(e,!1);if(r?.length)return 20*s.distance([r[0].x,r[0].y],[r.at(-1).x,r.at(-1).y])*n/t},e.calculateLocationAccuracyFromDeviations=function(e){if(!e?.length)throw new Error("Invalid deviations array");const[t,n,r]=[0,1,2].map(t=>e.map(e=>e[t]).filter(e=>null!==e)).map(e=>e.length?Z(e):0);return[t,n,r]},e.calculateReferenceImagePointPanoramic=async function(e,t,r,a){const{attributes:o}=r,{location:c}=o,{updateElevationProps:i,...s}=t;if(!e||!t)throw new Error("Missing parameters");let u=c.clone();u.spatialReference.isGeographic&&(u=await p.projectWithZConversion(u,h.WebMercator));const l=await z.imageToWorldPanoramic(e,{...s,cameraLocation:u},i);n.throwIfAborted(a);const f=l.clone();return f.z?f.z+=20:f.z=20,b.worldToImagePanoramic(f,s)},e.calculateTempImagePoint=async function(e,t,r){if(!t||!e)throw new Error("Missing required parameters");const a=await z.imageToWorld(e,t);n.throwIfAborted(r);const o=a.clone();o.z?o.z+=20:o.z=20;const{averageElevation:c,cameraPitch:i,cameraRoll:s,farDistance:u,...l}=t;return b.worldToImage(o,l)},e.computeHeightIteratively=q,e.computeHeightIterativelyPanoramic=k,e.computeTriangulatedAreaMeasurement=async function(e,t){if(!e?.length)return null;const n=[],r=e[0],a=e[1],o=r.camera.spatialReference,{measurePoints:c}=r;for(let e=0;e<c.length;e++){const t=S(r.camera,r.measurePoints[e],o),c=S(a.camera,a.measurePoints[e],o),i=await Q(t,c);if(!i)return null;const s=G(i,o);n.push([s.x,s.y,s.z??0])}if(n?.length<2)return null;const i=new m({paths:[n],spatialReference:t}),s=new f({rings:[n],spatialReference:t});if(t.isGeographic){const e=await T(t,i,s);return e?.area??null}if(t.isWebMercator){const e=await E(i,s);return e?.area??null}const u=O(i,s);return u?.area??null},e.computeTriangulatedDistanceMeasurement=async function(e){if(2===e?.length){const n=[];let r=1;const[a,o]=e,c=a.camera.spatialReference,{measurePoints:i}=a;for(let e=0;e<i.length;e++){const t=S(a.camera,a.measurePoints[e],c),i=S(o.camera,o.measurePoints[e],c),s=await Q(t,i);if(!s)return null;const u=G(s,c);u.spatialReference.isWebMercator&&(r=C(u.y)),n.push([u.x,u.y,u.z??0])}if(n?.length>1){const e=function(e,t){return Math.sqrt((Math.sqrt((e[0][0]-e[1][0])**2+(e[0][1]-e[1][1])**2)/t)**2+(e[0][2]-e[1][2])**2)}(n,r),a=function(e,t){return Math.sqrt((e[0][0]-e[1][0])**2+(e[0][1]-e[1][1])**2)/t}(n,r),o=Math.abs(n[0][2]-n[1][2]),c=function(e){return t.rad2deg(Math.atan((e[1][2]-e[0][2])/Math.sqrt((e[1][0]-e[0][0])**2+(e[1][1]-e[0][1])**2)))}(n),i=function(e){let n=90-t.rad2deg(Math.atan2(e[1][1]-e[0][1],e[1][0]-e[0][0]));return n<0&&(n+=360),n}(n);return{distance:e,horizontalDistance:a,verticalDistance:o,slope:c,aspect:i}}}return null},e.computeTriangulatedPoint=async function(e){const t=e[0].camera.spatialReference;if(2!==e?.length)return null;const[n,r]=e,{camera:a,measurePoints:o}=n,{camera:c,measurePoints:i}=r,s=S(a,o[0],t),u=S(c,i[0],t),l=await Q(s,u);return l?G(l,t)??null:null},e.computeTriangulatedVector=function(e,t){if(!e)return null;const n=t.geometry.clone(),r=Array.isArray(e)?e:[e],a=[];return r.forEach(e=>{let t=!1;e.spatialReference.isWGS84&&(e=M.execute(e,new h({wkid:3857})),t=!0);const r=e.spatialReference.isWebMercator?C(e.y):1,o=function(e,t,n){return Math.sqrt((e.z??0-(t.z??0))**2+(Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)/n)**2)*n}(e,n,r),c=function(e,t,n,r){return $(Y([e.x,e.y,e.z??0],[t.x,t.y,t.z??0]),1/n,1/r)}(e,n,o,r),i=((e.z??0)-(n.z??0))/c[2]*r;let s=new l({spatialReference:e.spatialReference,x:n.x+i*c[0],y:n.y+i*c[1],z:(n.z??0)+i*c[2]/r});t&&(s=M.execute(s,new h({wkid:4326}))),a.push(s)}),{camera:n,measurePoints:r,tempMeasurePoints:a}},e.copyToClipboard=function(e){navigator.clipboard.writeText(e).catch(e=>{throw e})},e.formatPixels=F,e.generateCombinations=V,e.generateCombinationsPanoramic=B,e.getConvertedArea=function(e,t,n,o,c){const i="measurement"===e?t:n;if(c&&i)return r.formatArea(o,a.createArea(i,"square-meters"),c,3)||null},e.getConvertedDistance=function(e,t,n,o,c){const i="measurement"===e?t:Z(n);if(c&&i)return r.formatLength(o,a.createLength(i,"meters"),c,3)||null},e.getConvertedHeight=function(e,t,n,o,c){const i="measurement"===e?t:n;if(c&&i)return r.formatLength(o,a.createLength(i,"meters"),c,3)||null},e.getModeCorrectedPoint=function(e,t,n){if("default"===t)return e;const r={x:e[0],y:e[1],z:e[2]},a=v.convertSphereVertexToPixelLocation(r,n[0],n[1]);return[a.x,a.y]},e.getRootOfSumOfSquaredErrors=Z,e.getUnitRateFromSpatialReference=J,e.heightMeasurement2D=K,e.heightMeasurementPanoramic=N,e.pixelAreaMeasurement2D=async function(e,t,n=!1){if(e.length<3)return null;const r=F(e,n),a=await j(r,t),o=a.map(({x:e,y:t})=>[e,t]);e.push(e[0]),o.push(o[0]);const c=a[0].spatialReference,i=new m({paths:[o],spatialReference:c}),s=new f({rings:[o],spatialReference:c});return c.isGeographic?T(c,i,s):c.isWebMercator?E(i,s):O(i,s)},e.pixelAreaMeasurementPanoramic=async function(e,t,r=!1,a){if(e.length<3)return null;const o=F(e,r),c=await H(o,t);n.throwIfAborted(a);const i=c.map(({x:e,y:t})=>[e,t]);e.push(e[0]),i.push(i[0]);const s=c[0].spatialReference,u=new m({paths:[i],spatialReference:s}),l=new f({rings:[i],spatialReference:s});return s.isGeographic?T(s,u,l):s.isWebMercator?E(u,l):O(u,l)},e.pixelDistanceMeasurement2D=async function(e,t,n=!1){const r=F(e,n);return W(U(await j(r,t)))},e.pixelDistanceMeasurementPanoramic=async function(e,t,r=!1,a){const o=F(e,r),c=await H(o,t);return n.throwIfAborted(a),W(U(c))},e.scale=$,e.solveSkewLinesIntersection=Q,e.subtract=Y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});