// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../request","../../core/Error","../../core/mathUtils","../../core/promiseUtils","../../core/urlUtils","../../layers/orientedImagery/transformations/utils","./constants","./utils"],function(t,e,a,r,n,o,i,s,c,l){"use strict";const m=t=>Object.freeze(Object.defineProperty({__proto__:null,default:t},Symbol.toStringTag,{value:"Module"})),h=async(e,a,n)=>{const o=new(await new Promise((e,a)=>t(["../../rest/support/AttachmentQuery"],t=>e(m(t)),a)).then(t=>t.default))({objectIds:[a]}),i=await e.queryAttachments(o,n),s=i[`${a}`]?.[0],c=s?.url;if(!c)throw new r("NoAttachmentError","no attachments found",{[e.objectIdField]:a,layer:e});return{datasetFormat:s.contentType.split("/")[1].toUpperCase(),url:c}};async function u(e,a){const r="string"==typeof e,n=r?e:e.url,{pathname:s,searchParams:c,origin:h}=new URL(n);let u=r?i.getPathExtension(s):e.datasetFormat;u||(u=await l.getContentType(n));const d=await new Promise((e,a)=>t(["../../layers/support/rasterDatasets/RasterFactory"],t=>e(m(t)),a)).then(t=>t.default),g=await d.open({ioConfig:{customFetchParameters:Object.fromEntries(c),skipMapInfo:!0},datasetFormat:u?.toUpperCase(),url:`${h}${s}`,signal:a?.signal});return g?async function(t,e){const{level:a,offset:r,size:n}=function(t){const{storageInfo:e,width:a,height:r}=t.rasterInfo,{maximumPyramidLevel:n,pyramidScalingFactor:o}=e,i=o??2;return{level:n,offset:{x:0,y:0},size:{width:Math.ceil(a/i**n),height:Math.ceil(r/i**n)}}}(t),{pixelBlock:i}=await t.fetchRawPixels(a,r,n,e);return o.throwIfAborted(e),i}(g,{signal:a?.signal}):null}e.getImageSourceFromAttachment=h,e.getThumbnailPixelBlock=u,e.isFeatureAttachment=t=>"FA"===t,e.loadImageForAttachment=async function(t,e,n){if(!t)throw new r("NoLayerError","No layer provided, cannot load image from attachment",{layer:t,objectId:e});const{datasetFormat:o,url:i}=await h(t,+e,n);return l.validateTifOrMrfExtension(o)?await u({datasetFormat:o,url:i},n):(await a(i,{...n,useRequestQueue:!0,responseType:"image",query:{w:c.imageGalleryThumbnailSize}})).data},e.renderImageWithRotation=function(t,e,a=0){const{height:r,width:o}=t;e.width=o,e.height=r;const i=e.getContext("2d");if(!i)return;const c=function(t,e,a){const r=document.createElement("canvas"),n=r.getContext("2d");if(t instanceof HTMLImageElement)r.width=t.width,r.height=t.height,n?.drawImage(t,0,0);else{const o=a.createImageData(e.width,e.height);o&&(o.data.set(t.getAsRGBA()),r.width=o.width,r.height=o.height,n?.putImageData(o,0,0))}return r}(t,e,i);c.getContext("2d")&&(a>0?function(t,e,a,r,o){const i=n.deg2rad(o),c=[s.rotatePixel(0,0,i),s.rotatePixel(a,0,i),s.rotatePixel(a,r,i),s.rotatePixel(0,r,i)],l=Math.max(...c.map(t=>t[0]))-Math.min(...c.map(t=>t[0])),m=Math.max(...c.map(t=>t[1]))-Math.min(...c.map(t=>t[1])),h=Math.min(a/l,r/m);t.save(),t.clearRect(0,0,a,r),t.translate(a/2,r/2),t.rotate(i),t.scale(h,h),t.drawImage(e,-a/2,-r/2,a,r),t.restore()}(i,c,o,r,a):i.drawImage(c,0,0))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});