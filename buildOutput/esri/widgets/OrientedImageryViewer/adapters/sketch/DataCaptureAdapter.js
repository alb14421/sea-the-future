// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Collection","../../../../core/ReactiveMap","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../dataCaptureUtils","../../mixins/SketchHandlerMixin"],function(e,t,r,a,i,o,s,c,d,p,n){"use strict";let l=class extends(n.SketchHandlerMixin(t)){constructor(e){super(e),this.savedGraphics=new r,this.type="data-capture",this.pendingGraphics=new a}get collectionId(){return this.viewModel.collectionId}handleCreate(e){const{state:t,graphic:a,tool:i}=e,o=a?.geometry;if("complete"!==t||!a||!o)return;const{collectionId:s,viewModel:{dataCaptureLayer:c,currentBestFeature:d,imageGeometryField:n,oiObjectIdField:l,activeViewer:h,mode:u},pendingGraphics:g}=this,v=h?.imageSize;d&&n&&s&&l&&c&&v&&"none"!==u&&"video"!==u&&(function(e,t,a,i,o,s,c,d,n,l){e.sourceLayer=l,e.attributes=e.attributes??{},e.attributes[a]=btoa(JSON.stringify({geometry:p.mapSpaceToImageSpace(t.clone(),n,d).toJSON()})),e.attributes[i]=o.attributes.objectId,s.has(c)||s.set(c,new r),s.get(c).add(e)}(a,o,n,l,d,g,s,v,u,c),this.viewModel.emit("after-data-capture-complete",{pendingGraphics:g.get(s)?.toArray()??null}),this.viewModel.sketch?.create(i))}handleDelete(e){const{dataCaptureLayer:t}=this.viewModel;if(!t)return;const{graphics:r}=e;this.pendingGraphics.get(t.id)?.removeMany(r),this.savedGraphics.removeMany(r),this.viewModel.deleteDataCaptureFeatures(function(e,t){return e.map(({attributes:e})=>t?e[t]:null).filter(Boolean)}(r,t.objectIdField))}handleDestroy(){const{dataCaptureLayer:e}=this.viewModel;e&&(this.viewModel.stopDataCapture(),this.savedGraphics.removeAll(),this.pendingGraphics=null)}handleUpdate(e){const{toolEventInfo:t,state:r,graphics:a}=e;if(t)this.viewModel.sketch?.undo();else switch(r){case"complete":this.viewModel.emit("deselect-data-capture-features",{graphics:a});break;case"start":this.viewModel.emit("select-data-capture-features",{graphics:a})}}};return e.__decorate([i.property()],l.prototype,"collectionId",null),e.__decorate([i.property()],l.prototype,"savedGraphics",void 0),e.__decorate([i.property()],l.prototype,"type",void 0),e.__decorate([i.property()],l.prototype,"pendingGraphics",void 0),l=e.__decorate([d.subclass("esri.widgets.OrientedImageryViewer.adapters.sketch.DataCaptureAdapter")],l),l});