// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../../chunks/tslib.es6","../../../core/Collection","../../../core/Identifiable","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/support/editableLayers","../../../support/actions/ActionToggle","../../Widget","../css","../dataCaptureUtils","./OverlayLayersList","../../../chunks/componentsUtils","../../support/globalCss","../../support/widgetUtils","../../support/jsxFactory"],function(e,t,a,s,r,i,o,n,l,c,d,h,p,y,u,m,_,g,L,v){"use strict";let C=class extends(s.IdentifiableMixin(p)){constructor(e){super(e),this._previousAction=null,this.closed=!1,this.dataCaptureEnabled=!1,this.dataCaptureLayer=null,this.imageGeometryField=null,this.imageReferenceField=null,this.layerList=new m({selectionMode:"multiple"}),this.messages=null,this.overlayedLayers=new a,this.showCameraLocations=!1,this.showMapFeatures=!1,this._createSelectedItemsHandle=()=>{this.removeHandles("selected-items"),this.addHandles(this._trackLayerSelectionChanges(),"selected-items")},this._createDataCaptureLayerHandle=()=>r.watch(()=>({dataCaptureLayer:this.dataCaptureLayer,operationalItems:this.layerList.operationalItems}),({dataCaptureLayer:e,operationalItems:t},a)=>{if(!e&&a?.dataCaptureLayer){const e=t.find(e=>e.layer===a.dataCaptureLayer);e&&e.actionsSections?.items.forEach(e=>{e.items.forEach(e=>{"create-features"===e.id&&(e.value=!1)})})}},r.syncAndInitial),this._handleSelectedItemsChange=({added:e,removed:t})=>{e.forEach(e=>{this.overlayedLayers.includes(e.layer)||this.onLayerSelected?.(e)}),t.forEach(e=>{this.overlayedLayers.includes(e.layer)&&this.onLayerDeselected?.(e)}),this.overlayedLayers.removeAll(),this.overlayedLayers.addMany(this.layerList.selectedItems.items.map(e=>e.layer))},this._layerListTriggerActionHandle=()=>r.on(()=>this.layerList,"trigger-action",e=>{const{action:t,item:{layer:a}}=e;this._resetPreviousAction(t),"create-features"===t.id&&this._toggleDataCaptureLayer(t,a)}),this._resetPreviousAction=e=>{"toggle"===this._previousAction?.type&&this._previousAction!==e&&(this._previousAction.value=!1,this._previousAction=null)},this._toggleDataCaptureLayer=(e,t)=>{this._previousAction=e;const a=e.value;this.dataCaptureLayer=a?t:null,this.onDataCaptureLayerChanged?.(this.dataCaptureLayer)},this._trackLayerSelectionChanges=()=>r.on(()=>this.layerList.selectedItems,"change",this._handleSelectedItemsChange),this._watchLayerListForListItemCreatedFunction=()=>r.watch(()=>({layerList:this.layerList,listItemCreatedFunction:this._listItemCreatedFunction}),()=>{this.layerList.listItemCreatedFunction=this._listItemCreatedFunction},r.syncAndInitial),this._watchSelectedItems=()=>r.watch(()=>this.layerList.selectedItems,this._createSelectedItemsHandle,r.syncAndInitial)}initialize(){this.addHandles([this._watchSelectedItems(),this._layerListTriggerActionHandle(),this._watchLayerListForListItemCreatedFunction(),this._createDataCaptureLayerHandle()])}loadDependencies(){return _.loadCalciteComponents({list:()=>new Promise((t,a)=>e(["../../../chunks/index16"],t,a)),"list-item":()=>new Promise((t,a)=>e(["../../../chunks/index20"],t,a)),panel:()=>new Promise((t,a)=>e(["../../../chunks/index51"],t,a)).then(e=>e.index),switch:()=>new Promise((t,a)=>e(["../../../chunks/index33"],t,a))})}get _listItemCreatedFunction(){const{dataCaptureEnabled:e,imageGeometryField:t,imageReferenceField:s}=this;return e&&t&&s?async e=>{const{item:i}=e,o=i.layer,{dataCaptureLayer:n,overlayedLayers:l,messages:{createFeaturesFromImage:c},layerList:p}=this,y=l.includes(o),{selectedItems:m}=p;if(function(e,t,a){e&&t.items.push(a)}(y,m,i),await(o?.load()),!o||!u.isValidDataCaptureLayer(o,t,s)||!d.isEditableLayer(o))return;const _=n===o,g=function(e,t,s,i=!1){const o=new h({icon:"pencil",id:"create-features",title:e,value:i});return t.addHandles(r.watch(()=>s.includes(t),e=>{o.visible=e},r.syncAndInitial)),function(e,t){const s=new a;s.add(e),t.actionsSections=new a([s])}(o,t),o}(c,i,m,_);_&&(this._previousAction=g)}:null}get view(){return this.layerList?.view}set view(e){this.layerList.view=e}_renderCameraLocationsSwitch(e){return v.tsx("calcite-list-item",{bind:this,label:this.messages.overlayCameraLocations,onclick:this._toggleShowCameraLocations},v.tsx("calcite-switch",{bind:this,checked:e,class:y.css.overlaysSwitch,onchange:this._toggleShowCameraLocations,scale:"s",slot:"actions-end"}))}_renderOverlayMapFeatures(e){return v.tsx("calcite-list-item",{bind:this,label:this.messages?.overlayMapFeatures,onclick:this._toggleShowMapFeatures},v.tsx("calcite-switch",{bind:this,checked:e,class:y.css.overlaysSwitch,onchange:this._toggleShowMapFeatures,scale:"s",slot:"actions-end"}))}_renderList(e){return e?v.tsx("div",{class:y.css.imageOverlaysLayerList},this.layerList.render()):null}_renderPanel(){const{closed:e,messages:t,showCameraLocations:a,showMapFeatures:s}=this;return v.tsx("calcite-panel",{bind:this,closable:!0,closed:e,heading:t.imageOverlays,onCalcitePanelClose:this.onImageOverlaysClosed},v.tsx("calcite-list",{label:t.imageOverlays},this._renderCameraLocationsSwitch(a),this._renderOverlayMapFeatures(s)),this._renderList(s))}_toggleShowCameraLocations(e){e.stopPropagation(),this.showCameraLocations=!this.showCameraLocations,this.onShowCameraLocationsChanged?.(this.showCameraLocations)}_toggleShowMapFeatures(e){e.stopPropagation(),this.showMapFeatures=!this.showMapFeatures,this.onShowMapFeaturesChanged?.(this.showMapFeatures)}render(){const e=this.layerList.operationalItems.items.length,t=this.showMapFeatures&&0===e,a=this.showMapFeatures&&e>0,s={[g.globalCss.widget]:!0,[y.css.imageOverlaysNoResult]:t,[y.css.imageOverlaysIncreasedHeight]:a,[y.css.imageOverlays]:!t&&!a};return v.tsx("div",{class:this.classes(s)},this._renderPanel())}};return t.__decorate([i.property()],C.prototype,"_previousAction",void 0),t.__decorate([i.property()],C.prototype,"_listItemCreatedFunction",null),t.__decorate([i.property()],C.prototype,"closed",void 0),t.__decorate([i.property()],C.prototype,"dataCaptureEnabled",void 0),t.__decorate([i.property()],C.prototype,"dataCaptureLayer",void 0),t.__decorate([i.property()],C.prototype,"imageGeometryField",void 0),t.__decorate([i.property()],C.prototype,"imageReferenceField",void 0),t.__decorate([i.property()],C.prototype,"layerList",void 0),t.__decorate([i.property()],C.prototype,"messages",void 0),t.__decorate([i.property()],C.prototype,"onDataCaptureLayerChanged",void 0),t.__decorate([i.property()],C.prototype,"onImageOverlaysClosed",void 0),t.__decorate([i.property()],C.prototype,"onLayerDeselected",void 0),t.__decorate([i.property()],C.prototype,"onLayerSelected",void 0),t.__decorate([i.property()],C.prototype,"onShowCameraLocationsChanged",void 0),t.__decorate([i.property()],C.prototype,"onShowMapFeaturesChanged",void 0),t.__decorate([i.property()],C.prototype,"overlayedLayers",void 0),t.__decorate([i.property()],C.prototype,"showCameraLocations",void 0),t.__decorate([i.property()],C.prototype,"showMapFeatures",void 0),t.__decorate([i.property()],C.prototype,"view",null),C=t.__decorate([c.subclass("esri.widgets.OrientedImageryViewer.components.ImageOverlays")],C),C});