// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../../chunks/tslib.es6","../../../Map","../../../arcade/geometry/operators","../../../core/Error","../../../core/Evented","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/support/UpdatingHandles","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/SpatialReference","../../../chunks/intersectionOperator","../../../chunks/proximityOperator","../../../layers/GraphicsLayer","../../../layers/ImageryTileLayer","../../../layers/support/RasterFunction","../../../layers/support/rasterFunctionConstants","../../../layers/support/TileInfo","../../../views/MapView","../../../views/2d/viewpointUtils","../utils"],function(e,t,r,a,i,o,s,n,l,d,c,h,p,g,m,y,u,_,v,w,f,R,x,I,b,C,M,P,S){"use strict";const E=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));let H=class extends o.EventedAccessor{constructor(t){super(t),this._imageChanged=!1,this._panConstraint=null,this._image=null,this._loadController=null,this._overlays=new R({blendMode:"source-atop"}),this._map=new r,this.autoLoad=!1,this.clickAction="none",this.error=null,this.imageSource=null,this.imageRotation=0,this.navigationManager=null,this.navigationViewModel=null,this.state="ready",this.updatingHandles=new y.UpdatingHandles,this._cancelLoadWithController=()=>{this._loadController?.abort(),this._loadController=null},this._createImageHandles=()=>{this.removeHandles("enhancements-handle"),this.addHandles(c.watch(()=>[this.brightness,this.contrast,this.sharpness],([e,t,r])=>{this.image?.loaded&&(this.image.effect=`contrast(${10*(t+10)}%) brightness(${10*(e+10)}%)`,this.sharpenImage(this.image,r))},c.syncAndInitial))},this._createPanConstraint=()=>{const{image:e,imageRenderer:t}=this,r=r=>{if(!(e&&t&&r.targetGeometry&&e.serviceRasterInfo))return r;const{extent:i}=e.serviceRasterInfo,{constraints:o,rotation:s,width:n,height:l}=t,{extent:d}=a.rotate(_.fromExtent(i),s,i.center.x,i.center.y),{width:c,height:h}=d,p=r.targetGeometry.clone(),g=o.scaleToZoom(r.scale),m=1/2**g,y=n/l;let u=m*c,v=m*h;g&&(c/n>h/l?v=u/y:u=v*y);const w=d.clone();return w.xmin+=u/2,w.xmax-=u/2,w.ymin+=v/2,w.ymax-=v/2,r.targetGeometry=f.getNearestCoordinate(_.fromExtent(w),p).coordinate,this.state="image-loaded",r};return{constrain:r,applyPanConstraint:r}},this._createResizeHandles=e=>{e.removeHandles("resize"),e.addHandles(c.watch(()=>{if(!this.imageRenderer.ready)return;const{extent:t}=e.serviceRasterInfo,{width:r,height:i,rotation:o}=this.imageRenderer,{extent:s}=a.rotate(_.fromExtent(t),o,t.center.x,t.center.y),{width:n,height:l}=s;return Math.max(n/r,l/i)},e=>{if(!this.imageRenderer||null==e)return;const{constraints:t,scale:r,spatialReference:a}=this.imageRenderer,i=t.minScale,o=P.getResolutionToScaleFactor(a),s=.25*o,n=o*e;let l=n;const d=[];for(;l>s;)d.push(l),l/=2;d.push(l);const{lods:c}=C.create({scales:d});if(t.set({minScale:n,lods:c}),this._imageChanged)return this.imageRenderer.scale=n,void(this._imageChanged=!1);this.imageRenderer.scale=Math.abs(r-i)<=1e-6?n:r},c.syncAndInitial),"resize")},this._loadImageInternal=(e,t={})=>{this.state="image-loading",this.clearImage(),this.error=null,this._imageChanged=!0;const r="string"==typeof e,a=r?void 0:e.datasetFormat,i=r?e:e.url,{customParameters:o,options:n}=t;return this._image=new x({ioConfig:{skipExtensions:["aux.xml","jgw"],skipMapInfo:!0,datasetFormat:a},url:i,customParameters:o}),this._image.when(e=>{this._updatePanConstraint(),this._createResizeHandles(e),this._map.add(e),this.state="image-loaded"},t=>{d.isAbortError(t)?this.state="image-load-aborted":(this.state="image-load-error",this.error=t,s.getLogger(this).error(`error occurred while loading image ${r?e:JSON.stringify(e)}`,t),this.imageSource=null)}),this._image.load(n)},this._loadWithController=()=>{this._cancelLoadWithController(),this._loadController=new AbortController,this.loadImage(this._loadController)},this._loadNavigationManager=async()=>{if(!this.navigationManager||this.navigationManager?.destroyed){const t=await new Promise((t,r)=>e(["../navigation/NavigationManager"],e=>t(E(e)),r)).then(e=>e.default);this.navigationManager=new t({viewModel:this.navigationViewModel})}return this.navigationManager},this._updatePanConstraint=()=>{this._panConstraint&&this.imageRenderer.constraints.customConstraints.remove(this._panConstraint),this._panConstraint=this._createPanConstraint(),this.imageRenderer.constraints.customConstraints.add(this._panConstraint)},this.addGraphic=(e,t)=>{this._overlays.graphics.add(e,t)},this.addManyGraphics=e=>{this._overlays.addMany(e)},this.clearGraphics=()=>{this._overlays.graphics.removeAll()},this.clearImage=()=>{this.image&&(this._map.layers.remove(this.image),this._image=l.destroyMaybe(this._image))},this.loadImage=e=>{const{customParameters:t,imageSource:r}=this;return r?this._loadImageInternal(r,{customParameters:t,options:e}):S.logAndThrow(this.declaredClass,new i(S.getMissingPropertyErrorName("image-viewer"),S.getMissingPropertyErrorMessage("ImageViewerViewModel","imageSource")))},this.navigate=async(e,t)=>this.updatingHandles.addPromise(this.navigateInternal(e,t)),this.navigateInternal=async(e,t)=>{const r=await this._loadNavigationManager();return await r.navigate(e,t)},this.removeGraphic=e=>{this._overlays.remove(e)},this.removeManyGraphics=e=>{this._overlays.removeMany(e)},this._imageRenderer=new M({constraints:{snapToZoom:!0,rotationEnabled:!1},map:this._map,popupEnabled:!1,spatialReference:v.WebMercator,ui:{components:["zoom"]}})}destroy(){this._imageRenderer.destroy()}initialize(){this.state="initialized",this.addHandles([c.watch(()=>this.imageSource,e=>{e&&this.autoLoad&&this._loadWithController()},c.syncAndInitial),c.watch(()=>this.image?.loaded,()=>{this._createImageHandles()}),c.watch(()=>this.imageRotation,()=>{this._rotateImage()}),c.watch(()=>this.imageRenderer.map,(e,t)=>{t?.layers.remove(this._overlays),e?.layers.add(this._overlays)},c.initial),c.watch(()=>this.imageRenderer.map.allLayers.length,e=>{e&&this.imageRenderer.map.layers.reorder(this._overlays,e-1)},c.syncAndInitial),c.watch(()=>this.clickAction,e=>{this.removeHandles("click-handle"),"none"!==e&&this.addHandles(this.imageRenderer.on("click",t=>{if(this.image?.loaded&&this.imageRenderer.ready)switch(e){case"emit":t.stopPropagation(),this.emit("click",t);break;case"hittest":t.stopPropagation(),t.defer(async()=>{const e=await this.imageRenderer.hitTest(t.screenPoint,{include:this._overlays});e.results=e.results.filter(e=>"graphic"===e.type),this.emit("hittest-response",e)});break;case"pixel-location":{if(t.stopPropagation(),!this.image?.serviceRasterInfo||!t.mapPoint)return void this.emit("pixel-location",null);const{extent:e,pixelSize:r}=this.image.serviceRasterInfo,a=(t.mapPoint.x-e.xmin)*r.x,i=(e.ymax-t.mapPoint.y)*r.y,o=new u({x:a,y:i,spatialReference:e.spatialReference});this.emit("pixel-location",o);break}}}))},c.syncAndInitial)])}get brightness(){return this._get("brightness")??0}set brightness(e){this._set("brightness",n.clamp(e,-10,10))}get contrast(){return this._get("contrast")??0}set contrast(e){this._set("contrast",n.clamp(e,-10,10))}get currentNode(){return this.navigationViewModel?.currentNode}get image(){return this._image}get imagePointsInView(){const{extent:e,ready:t}=this.imageRenderer,r=this.imageRotation,i=this.image?.fullExtent,o=this.image?.serviceRasterInfo,s=!0===this._imageRenderer.allLayerViews.find(({layer:e})=>e===this.image)?.attached;if(!(t&&e&&i&&o&&s))return null;const n=a.rotate(_.fromExtent(e),r,e.center.x,e.center.y),l=_.fromExtent(i),d=w.execute(n,l),{rings:c}=d;return c.flat().map(([e,t])=>({x:(e-o.extent.xmin)*o.pixelSize.x,y:(o.extent.ymax-t)*o.pixelSize.y}))}get imageSize(){const{image:e}=this;if(!e?.raster)return null;const{width:t,height:r}=e.raster.rasterInfo;return[t,r]}get imageRenderer(){return this._imageRenderer}get imageView(){return this.imageRenderer.allLayerViews.find(e=>e.layer===this.image)}get sharpness(){return this._get("sharpness")??0}set sharpness(e){this._set("sharpness",n.clamp(e,0,1))}get updating(){return this.updatingHandles.updating}_rotateImage(){this.imageRenderer.constraints.rotationEnabled=!0,this.imageRenderer.rotation=this.imageRotation,this.imageRenderer.constraints.rotationEnabled=!1}sharpenImage(e,t){if(!t)return void(e.rasterFunction=null);const r=[0,-1*t,0,-1*t,4*t+1,-1*t,0,-1*t,0],a=new I({functionName:"Convolution",functionArguments:{type:b.convolutionKernel.userDefined,cols:3,rows:3,kernel:r,convolutionType:b.convolutionKernel.userDefined}});e.rasterFunction=a}};return t.__decorate([h.property()],H.prototype,"_image",void 0),t.__decorate([h.property()],H.prototype,"_imageRenderer",void 0),t.__decorate([h.property()],H.prototype,"_loadController",void 0),t.__decorate([h.property()],H.prototype,"_overlays",void 0),t.__decorate([h.property()],H.prototype,"_map",void 0),t.__decorate([h.property({type:Boolean})],H.prototype,"autoLoad",void 0),t.__decorate([h.property({type:Number})],H.prototype,"brightness",null),t.__decorate([h.property()],H.prototype,"clickAction",void 0),t.__decorate([h.property({type:Number})],H.prototype,"contrast",null),t.__decorate([h.property()],H.prototype,"currentNode",null),t.__decorate([h.property({type:Object})],H.prototype,"customParameters",void 0),t.__decorate([h.property({type:i})],H.prototype,"error",void 0),t.__decorate([h.property({readOnly:!0})],H.prototype,"image",null),t.__decorate([h.property({readOnly:!0})],H.prototype,"imagePointsInView",null),t.__decorate([h.property({readOnly:!0})],H.prototype,"imageSize",null),t.__decorate([h.property({cast:S.castImageSource})],H.prototype,"imageSource",void 0),t.__decorate([h.property({readOnly:!0})],H.prototype,"imageRenderer",null),t.__decorate([h.property({type:Number})],H.prototype,"imageRotation",void 0),t.__decorate([h.property()],H.prototype,"imageView",null),t.__decorate([h.property()],H.prototype,"navigationManager",void 0),t.__decorate([h.property()],H.prototype,"navigationViewModel",void 0),t.__decorate([h.property({type:Number})],H.prototype,"sharpness",null),t.__decorate([h.property()],H.prototype,"state",void 0),t.__decorate([h.property()],H.prototype,"updatingHandles",void 0),t.__decorate([h.property()],H.prototype,"updating",null),H=t.__decorate([m.subclass("esri.widgets.OrientedImageryViewer.components.ImageViewerViewModel")],H),H});