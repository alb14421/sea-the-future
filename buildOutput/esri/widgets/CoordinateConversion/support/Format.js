// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Error","../../../core/has","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/coordinateFormatter","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils","./coordinateConversionUtils"],function(e,t,r,o,n,i,a,s,c,l,p,u,d,h){"use strict";let f=class extends t{constructor(e){super(e),this.conversionInfo=null,this.coordinateSegments=null,this._currentPattern=void 0,this.defaultPattern=null,this.name=null,this.viewModel=null}get currentPattern(){return(this._currentPattern||this.defaultPattern)??""}set currentPattern(e){this._currentPattern=e}get label(){return this.name??""}set label(e){this._overrideIfSome("label",e)}get hasDisplayProperties(){return!(!this.defaultPattern||!this.coordinateSegments)}get spatialReference(){return"basemap"===this.name?this._viewSpatialReference:this.conversionInfo?.spatialReference??p.WGS84}set spatialReference(e){this._overrideIfSome("spatialReference",e)}get _viewSpatialReference(){return this.viewModel?.view?.spatialReference??p.WGS84}get _additionalCharactersPattern(){const e=this.coordinateSegments;if(!e)return null;const t=e.map(e=>e.alias),r=this.currentPattern.replaceAll(new RegExp(`["nsew${t.join()}]`,"gi"),"").replaceAll(" ","");return new RegExp(`[${r}]`,"g")}get test(){}async convert(e){if(!h.isValidPoint(e))throw new r("format:invalid-point","Could not convert invalid point.",{point:e});const t=this.conversionInfo?.convert;if(t)return Promise.resolve().then(()=>t(e));const o=this._project(e,this.spatialReference);return{location:o,coordinate:this._getCoordinate(o)}}getConversionStrategy(){const e=this._viewSpatialReference;return this.conversionInfo?.convert||this.viewModel?.formatterAvailable||"xy"===this.name&&(e.isWebMercator||e.isWGS84)||"basemap"===this.name?"client":"server"}getDisplayCoordinate(e){if(!e)return null;if(!this.coordinateSegments||!this.currentPattern)return e;let t=this.currentPattern;const r=this._getSegmentMatches(e,!1);for(let e=this.coordinateSegments.length-1;e>=0;e--){const o=this.coordinateSegments[e];t=t.replace(o.alias,r[e])}return t}_parseUserInput(e){const{defaultPattern:t,_additionalCharactersPattern:r,coordinateSegments:o}=this;if(!t||!r)return"";let n=t.replace(r,"");e=e.replace(r,"");const i=this._getSegmentMatches(e,!0);if(o)for(let e=o.length-1;e>=0;e--){const t=o[e];n=n.replace(t.alias,i[e])}return n}_getSegmentMatches(e,t){const r=new Array,{coordinateSegments:o}=this;if(!o)return r;for(let n=0;n<o.length;n++){const i=o[n],a=e.match(i.searchPattern);if(!a){r.push("");continue}let s=a[0];if(e=e.replace(s,"").trim(),i.substitution){const e=t?i.substitution.input(s):i.substitution.output(s);e&&(s=`${e}`)}r.push(s)}return r}async reverseConvert(e){const t=this._parseUserInput(e),o=this.conversionInfo?.reverseConvert;let n;if(o)n=o(t);else if("xy"===this.name||"basemap"===this.name)n=h.fromXY(t,this.spatialReference);else if(this.viewModel?.formatterAvailable)switch(this.name){case"dd":case"ddm":case"dms":n=c.fromLatitudeLongitude(t,this.spatialReference);break;case"mgrs":{const e="automatic";n=c.fromMgrs(t,this.spatialReference,e);break}case"utm":{const e="latitude-band-indicators";n=c.fromUtm(t,this.spatialReference,e);break}case"usng":n=c.fromUsng(t,this.spatialReference);break;default:n=null}if(!n)throw new r("format:invalid-input","Could not parse input into point.",{userInput:e});return this._project(n,this._viewSpatialReference)}_getCoordinate(e){const t=this.viewModel?.view?.scale??0;if(!h.isValidPoint(e))throw new r("format:invalid-point","Could not transform invalid point into coordinate.",{point:e});if(this.viewModel?.formatterAvailable||"basemap"===this.name||"xy"===this.name)switch(this.name){case"dd":case"ddm":case"dms":{const r=h.getDegreePrecision(t);return c.toLatitudeLongitude(e,this.name,r)}case"mgrs":{const t=!1,r=5,o="automatic";return c.toMgrs(e,o,r,t)}case"usng":{const t=!1,r=5;return c.toUsng(e,r,t)}case"utm":{const t=!0,r="latitude-band-indicators";return c.toUtm(e,r,t)}default:return h.pointToCoordinate(e,t)}return h.pointToCoordinate(e,t)}_project(e,t){if(u.equals(e.spatialReference,t)||!t)return e;if(this.viewModel?.formatterAvailable&&l.isLoaded())return l.project(e,t);if(!this.viewModel?.formatterAvailable){const r=d.project(e,t);if(null!=r)return r}return null}};return e.__decorate([n.property()],f.prototype,"conversionInfo",void 0),e.__decorate([n.property()],f.prototype,"coordinateSegments",void 0),e.__decorate([n.property()],f.prototype,"currentPattern",null),e.__decorate([n.property()],f.prototype,"_currentPattern",void 0),e.__decorate([n.property()],f.prototype,"label",null),e.__decorate([n.property()],f.prototype,"defaultPattern",void 0),e.__decorate([n.property({readOnly:!0})],f.prototype,"hasDisplayProperties",null),e.__decorate([n.property()],f.prototype,"name",void 0),e.__decorate([n.property({type:p})],f.prototype,"spatialReference",null),e.__decorate([n.property()],f.prototype,"viewModel",void 0),e.__decorate([n.property({readOnly:!0})],f.prototype,"_viewSpatialReference",null),e.__decorate([n.property({readOnly:!0})],f.prototype,"_additionalCharactersPattern",null),f=e.__decorate([s.subclass("esri.widgets.CoordinateConversion.support.Format")],f),f});