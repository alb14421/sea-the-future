// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/Accessor","../../core/screenUtils","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/Point","../../geometry/Polyline","../../geometry/SpatialReference","../../geometry/support/geodesicUtils","../../geometry/support/normalizeUtils","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../linkChart/utils"],function(e,t,r,i,s,n,o,c,a,l,u,d,p,m,h,g,w){"use strict";function y({state:{paddedViewState:e},spatialReference:t,width:r}){return t.isWrappable&&e.worldScreenWidth<r}function f(e,t){const{x:r,y:i}=e?g.webMercatorToGeographic(t,!0):t;return[r,i]}let v=class extends t{constructor(e){super(e),this.scaleComputedFrom=r.createScreenPoint(),this.view=null}get state(){return this.view?.ready&&"2d"===this.view.type?w.isLinkChartView(this.view)&&!this.view.inGeographicLayout?"disabled":"ready":"disabled"}getScaleBarProperties(e,t){if("disabled"===this.state||isNaN(e)||!t||!this.view)return null;const r=this._getDistanceInMeters();return null==r?null:this._getScaleBarProps(e,r,t)}_getDistanceInMeters(){const{state:e,spatialReference:t}=this.view;if(!h.isValid(t))return null;const{isGeographic:r}=t,s=function(e){const{isWebMercator:t,wkt:r,wkt2:i}=e;return t||((i||r)?.includes("WGS_1984_Web_Mercator")??!1)}(t);if(!r&&!s)return e.extent.width*(i.getMetersPerUnit(t)??1);const[n,o]=this._getScaleMeasuringPoints(),c=s||r&&!p.isSupported(t)?d.WGS84:t,a=new u({paths:[[f(s,n),f(s,o)]],spatialReference:c}),l=m.straightLineDensify(a,10);let g;try{[g]=p.geodesicLengths([l],"meters")}catch{return null}return g}_getScaleMeasuringPoints(){const e=this.view,{width:t,height:i,position:s,spatialReference:n}=e;if(y(e)){const e=h.getInfo(n),{valid:t}=e;return[new l(t[0],0,n),new l(t[1],0,n)]}let o=this.scaleComputedFrom.y-s[1];o>i?o=i:o<0&&(o=0);const c=r.createScreenPoint(0,o),a=r.createScreenPoint(t,o);return[e.toMap(c),e.toMap(a)]}_getScaleBarProps(e,t,r){const s=this.view,n=e*t/(y(s)?s.state.paddedViewState.worldScreenWidth:s.width);if(n<.001)return null;const o=function(e,t){switch(t){case"metric":return e>1e3?{distance:i.convertUnit(e,"meters","kilometers"),unit:"kilometer"}:e>1?{distance:e,unit:"meter"}:e>.01?{distance:i.convertUnit(e,"meters","centimeters"),unit:"centimeter"}:{distance:i.convertUnit(e,"meters","millimeters"),unit:"millimeter"};case"imperial":return e>1609.344?{distance:i.convertUnit(e,"meters","miles"),unit:"mile"}:e>.3048?{distance:i.convertUnit(e,"meters","feet"),unit:"foot"}:{distance:i.convertUnit(e,"meters","inches"),unit:"inch"}}}(n,r),{distance:c,unit:a}=o;let l=c,u=0;for(;l>=1;)l/=10,u++;const{min:d,max:p}=(m=l)>.5?{min:.5,max:1}:m>.2?{min:.2,max:.5}:{min:.1,max:.2};var m;const h=p/l>=l/d?d:p;return{length:e*(h/l),value:10**u*h,unit:a}}};return e.__decorate([s.property()],v.prototype,"scaleComputedFrom",void 0),e.__decorate([s.property({readOnly:!0})],v.prototype,"state",null),e.__decorate([s.property()],v.prototype,"view",void 0),v=e.__decorate([a.subclass("esri.widgets.ScaleBar.ScaleBarViewModel")],v),v});