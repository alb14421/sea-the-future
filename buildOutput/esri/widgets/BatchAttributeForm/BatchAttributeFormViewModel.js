// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/asyncUtils","../../core/Collection","../../core/Error","../../core/Evented","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/ReactiveMap","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/support/UpdatingHandles","../../geometry/SpatialReference","../../time/constants","./batchAttributeFormUtils","./expressions/ArcadeExecutorProvider","./expressions/ExpressionsManager","./expressions/ExpressionsModel","./inputs/BatchFormInputs","./inputs/support/createBatchFormInputs","./inputs/support/inputUtils","./templates/BatchFormTemplate","./templates/support/contingentValuesUtils","./templates/support/createBatchFormTemplate"],function(e,t,r,s,a,i,o,n,p,l,u,c,d,h,m,y,_,v,g,F,f,x,w,b,I,M,E){"use strict";let A=class extends a.EventedAccessor{constructor(e){super(e),this.activeFeatureIndex=-1,this.disabled=!1,this.editType="NA",this.features=new r,this._hasAsyncArcadeExpressions=!1,this.maximumFeatureCountWithComplexForms=50,this.maximumFeatureCount=2e3,this.map=null,this.readOnly=!1,this.spatialReference=null,this.submitHasBeenAttempted=!1,this.timeZone=null,this.userHasChangedValues=!1,this._arcadeExecutorProvider=new g.ArcadeExecutorProvider,this._activeFormInputsByElementId=new Map,this._emptyForm=new x({inputs:[]}),this._emptyFormTemplate=new I({elements:[]}),this._featureFormMap=new Map,this._prepareTask=null,this._reactiveGraphicLookup=new p,this._updatingHandles=new m.UpdatingHandles,this._layerTemplateMap=new p,this._layerContingentValuesMap=new p,this._workingFeatures=new r,this._expressionsManager=new F.ExpressionsManager({arcadeContext:{editType:"NA",spatialReference:null,map:null,timeZone:_.system}}),this.sharedForm=this._emptyForm,this.sharedFormTemplate=this._emptyFormTemplate}initialize(){this.addHandles([l.on(()=>this.features,"after-changes",()=>this._prepare(),{sync:!0}),l.watch(()=>[this.features,this.map,this.timeZone,this.editType],()=>this._prepare(),l.sync),l.watch(()=>this.activeForm,()=>this._activeFormInputsByElementId.clear(),l.sync)]),this._prepare()}destroy(){this._prepareTask=o.abortMaybe(this._prepareTask),this._workingFeatures.destroyAll(),this._expressionsManager&&this._expressionsManager.abort(),this._reactiveGraphicLookup=new p,this._emptyForm.destroy(),this._emptyFormTemplate.destroy()}get _effectiveTimeZone(){return this.timeZone??"system"}get activeFeature(){const e=this.activeFeatureIndex;return e<0?null:this.features.at(e)}get activeForm(){if("batch"===this.mode)return this.sharedForm;const e=this._workingFeatures.at(this.activeFeatureIndex);if(!e)return this._emptyForm;const t=this._featureFormMap.get(e);if(t)return t;const r=this._makeBatchFormInputsForFeature(e);return r!==this._emptyForm&&this._featureFormMap.set(e,r),r}get calculating(){return this._expressionsManager.calculating}get expressionEvaluationFailed(){return this._expressionsManager.expressionEvaluationFailed}get hasNonActiveInvalidFeatures(){if("batch"===this.mode)return!1;const{activeFeature:e}=this;return this.invalidFeatures.some(t=>t!==e)}get hasAsyncArcadeExpressions(){return this._hasAsyncArcadeExpressions}get hasTooManyFeatures(){return this._workingFeatures.length>this.maximumFeatureCount}get hasTooManyComplexFeatures(){return this._workingFeatures.length>this.maximumFeatureCountWithComplexForms&&this.hasAsyncArcadeExpressions}get invalidFeatures(){return this.sharedForm.invalidFeatures}get hasVisibleInputs(){return this.visibleInputs.length>0}get hasLayersWithContingentValues(){for(const e of this.layers){const t=this._layerContingentValuesMap.get(e);if(t&&t.size>0)return!0}return!1}get visibleInputs(){return this.activeForm.inputs.filter(e=>e.visible)}get noVisibleElementsReason(){if(this.hasVisibleInputs)return null;if(0===this.activeForm.inputs.length)return"noElements";const e=new Set;for(const t of this.activeForm.inputs)switch(t.visibilityCode){case"hidden:not-in-all-layers":case"hidden:no-domain-in-common":e.add("noElementsInCommon");break;case"hidden:field-definition":case"hidden:group-visibility-expression:all-features":case"hidden:visibility-expression:all-features":e.add("allElementsHidden");break;case"hidden:group-visibility-expression:some-features":case"hidden:visibility-expression:some-features":return"elementsHiddenInSome"}return e.has("allElementsHidden")?"allElementsHidden":"noElementsInCommon"}get status(){const e=this._prepareTask;return null==e?"not-loaded":e.finished?null!=e.error?"failed":"loaded":"loading"}get submittable(){return this.valid,!0}get updating(){return this._updatingHandles.updating||this.calculating}get valid(){return this.sharedForm.valid}get layers(){const e=new Set;return this.features.forEach(t=>{const r=t.sourceLayer??t.layer;e.add(r)}),Array.from(e)}get mode(){return this.activeFeatureIndex>-1?"single":"batch"}submit(){this.submitHasBeenAttempted=!0,this.emit("submit",{name:"submit",results:this._makeSubmitResults(),valid:this.valid})}findFieldInput(e){if(null==e)return;const t=this._activeFormInputsByElementId;if(t.has(e))return t.get(e);const r=this.activeForm.allFieldInputs.find(t=>t.template.elementId===e);return void 0!==r?(t.set(e,r),r):void 0}getFirstVisibleInvalidFieldInput(){if(this.hasVisibleInputs&&!this.activeForm.valid)for(const e of this.visibleInputs){if(b.isGroupInput(e)){const t=e.inputs.find(e=>!e.valid);if(t)return{input:t,groupInput:e}}if(b.isFieldInput(e)&&!e.valid)return{input:e}}}getFieldInputValue(e){return this.findFieldInput(e)?.value}getValues(e){const t=this._reactiveGraphicLookup.get(e);if(!t)throw new s("feature-not-found","The given feature is not present in the BatchAttributeForm");return{...t.attributes}}notifyGeometriesChanged(e){const t=[];for(const r of e){const e=this._reactiveGraphicLookup.get(r);e&&(t.push(e),e.geometry=r.geometry)}this._expressionsManager.runGeometryDependentExpressions(t)}async setFieldInputValue(e,t){const r=new Set(this.invalidFeatures);await e.setValueFromUser(t),this.userHasChangedValues=!0,this._trackValidityChange(r),this.emit("value-change",{features:e.features.toArray().map(e=>e.source),fieldName:e.fieldName,name:"value-change",value:t})}async setValue(e,t){const r=this.findFieldInput(e);if(null==r)throw new s("no-FieldInput-found",`Cannot set the value of FieldInput with ID: ${e} because none was found in the active form`);await this.setFieldInputValue(r,t)}userChangesHaveMadeFeatureInvalid(e){return!!this._reactiveGraphicLookup.get(e)?.userChangesHaveMadeInvalid}async _trackValidityChange(e){await l.whenOnce(()=>!1===this.calculating);const t=this.invalidFeatures;for(const r of t)!1===e.has(r)&&this._reactiveGraphicLookup.has(r)&&(this._reactiveGraphicLookup.get(r).userChangesHaveMadeInvalid=!0)}validate(){return!1}_makeBatchFormInputsForFeature(e){const t=this._layerTemplateMap.get(e.layer);return t?w.createBatchFormInputsFromBatchFormTemplate(t,new r([e]),this._expressionsManager):this._emptyForm}_makeSubmitResults(){const e=new Map;for(const[t,r]of this._reactiveGraphicLookup)e.set(t,{feature:t,values:{...r.attributes},invalidFields:[]});for(const t of this.sharedForm.allFieldInputs)for(const r of t.invalidFeatures)e.get(r)?.invalidFields.push(t.fieldName);return Array.from(e.values())}_prepare(){this._hasAsyncArcadeExpressions=!1,this._prepareTask=o.abortMaybe(this._prepareTask),this._updateWorkingFeatures(),o.abortMaybe(this._expressionsManager),this.userHasChangedValues=!1,this._expressionsManager=new F.ExpressionsManager({arcadeContext:{editType:this.editType,spatialReference:this.spatialReference??y.WebMercator,map:this.map,timeZone:this._effectiveTimeZone}});const{layers:e}=this;if(0===e.length)return;const r=t.createTask(async t=>{try{n.throwIfAborted(t);const r=new Map;for(const t of e){const e=await M.getLayerContingentValuesMetaData(t);if(e){const r=e.fieldGroups.flatMap(e=>e.fields);this._layerContingentValuesMap.set(t,new Set(r))}else this._layerContingentValuesMap.set(t,new Set);const s=await E.createBatchFormTemplate(t,{arcadeExecutorProvider:this._arcadeExecutorProvider,formTimeZone:this._effectiveTimeZone});this._layerTemplateMap.set(t,s);const a=s.getExpressionExecutorsForLayer(t);if(this._expressionsManager.layerExpressionsModelMap.set(t,new f.ExpressionsModel({preserveFieldValuesWhenHidden:s.preserveFieldValuesWhenHidden,executorMap:a})),!this._hasAsyncArcadeExpressions)for(const e of a.keys()){const t=a.get(e);if(this._hasAsyncArcadeExpressions=!0===(t.editableExpression?.isAsync||t.requiredExpression?.isAsync||t.valueExpression?.isAsync||t.visibilityExpression?.isAsync),this._hasAsyncArcadeExpressions)break}for(const e of s.elements){const{elementId:t}=e;r.has(t)?r.get(t).foldIn(e):r.set(t,e.clone())}}if(this.hasTooManyComplexFeatures)throw new s("too-many-features-with-complex-forms","There are too many features to load into the form with the configured complexity");if(this.hasTooManyFeatures)throw new s("too-many-features","There are too many features to load into the form.");const a=new I({elements:Array.from(r.values())});this.sharedFormTemplate=a,this.sharedForm=w.createBatchFormInputsFromBatchFormTemplate(a,this._workingFeatures,this._expressionsManager),await this._expressionsManager.runAllExpressions(this._workingFeatures.toArray())}catch(e){throw i.getLogger(this).error("Failed preparing form",e),e}});this._updatingHandles.addPromise(r.promise),this._prepareTask=r}_updateWorkingFeatures(){this._workingFeatures.destroyAll();const{features:e}=this;if(this._reactiveGraphicLookup=new p,0!==e.length){this._workingFeatures.addMany(e.map(v.createReactiveGraphic));for(const e of this._workingFeatures)this._reactiveGraphicLookup.set(e.source,e)}}};return e.__decorate([u.property()],A.prototype,"_effectiveTimeZone",null),e.__decorate([u.property({readOnly:!0})],A.prototype,"activeFeature",null),e.__decorate([u.property()],A.prototype,"activeFeatureIndex",void 0),e.__decorate([u.property({readOnly:!0})],A.prototype,"activeForm",null),e.__decorate([u.property()],A.prototype,"disabled",void 0),e.__decorate([u.property()],A.prototype,"calculating",null),e.__decorate([u.property()],A.prototype,"editType",void 0),e.__decorate([u.property()],A.prototype,"features",void 0),e.__decorate([u.property()],A.prototype,"expressionEvaluationFailed",null),e.__decorate([u.property()],A.prototype,"hasNonActiveInvalidFeatures",null),e.__decorate([u.property()],A.prototype,"hasAsyncArcadeExpressions",null),e.__decorate([u.property()],A.prototype,"_hasAsyncArcadeExpressions",void 0),e.__decorate([u.property()],A.prototype,"invalidFeatures",null),e.__decorate([u.property()],A.prototype,"hasVisibleInputs",null),e.__decorate([u.property()],A.prototype,"hasLayersWithContingentValues",null),e.__decorate([u.property()],A.prototype,"maximumFeatureCountWithComplexForms",void 0),e.__decorate([u.property()],A.prototype,"maximumFeatureCount",void 0),e.__decorate([u.property()],A.prototype,"visibleInputs",null),e.__decorate([u.property()],A.prototype,"map",void 0),e.__decorate([u.property()],A.prototype,"noVisibleElementsReason",null),e.__decorate([u.property()],A.prototype,"readOnly",void 0),e.__decorate([u.property()],A.prototype,"spatialReference",void 0),e.__decorate([u.property()],A.prototype,"submitHasBeenAttempted",void 0),e.__decorate([u.property()],A.prototype,"timeZone",void 0),e.__decorate([u.property()],A.prototype,"updating",null),e.__decorate([u.property()],A.prototype,"valid",null),e.__decorate([u.property()],A.prototype,"layers",null),e.__decorate([u.property()],A.prototype,"mode",null),e.__decorate([u.property()],A.prototype,"sharedForm",void 0),e.__decorate([u.property()],A.prototype,"sharedFormTemplate",void 0),e.__decorate([u.property()],A.prototype,"userHasChangedValues",void 0),e.__decorate([u.property()],A.prototype,"_arcadeExecutorProvider",void 0),e.__decorate([u.property()],A.prototype,"_prepareTask",void 0),e.__decorate([u.property()],A.prototype,"_reactiveGraphicLookup",void 0),e.__decorate([u.property()],A.prototype,"_layerTemplateMap",void 0),e.__decorate([u.property()],A.prototype,"_layerContingentValuesMap",void 0),e.__decorate([u.property()],A.prototype,"_workingFeatures",void 0),e.__decorate([u.property()],A.prototype,"_expressionsManager",void 0),A=e.__decorate([h.subclass("esri.widgets.BatchAttributeForm.BatchAttributeFormViewModel")],A),A});