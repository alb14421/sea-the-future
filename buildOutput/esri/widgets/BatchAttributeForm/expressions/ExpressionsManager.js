// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Error","../../../core/Logger","../../../core/MapUtils","../../../core/promiseUtils","../../../core/ReactiveMap","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/sql/DateOnly","../../../core/sql/TimeOnly","../inputs/support/inputUtils","../templates/support/templateUtils"],function(e,t,r,a,s,o,i,n,l,u,c,p,d,f,h,m,g){"use strict";let y=null;t.ExpressionsManager=class extends a{constructor(e){super(e),this.calculating=!1,this.arcadeContext=null,this._abortController=new AbortController,this.layerExpressionsModelMap=new Map,this.evaluatedExpressions=new l,this.expressionEvaluationFailed=!1}abort(){this._abortController.abort()}async runAllExpressions(e,t=!1){return this._evaluateSpecifiedComponentsForEachFeature(e,b,t)}async runGeometryDependentExpressions(e,t=!1){return this._evaluateSpecifiedComponentsForEachFeature(e,w,t)}async valueChanged(e,t,r=!0){try{this.calculating=!0;const a=t.map(t=>this.evaluateValueChangedForFeature(e,t,r));await Promise.all(a)}catch(e){o.getLogger(this).error(e),this.expressionEvaluationFailed=!0}finally{this.calculating=!1}}async evaluateValueChangedForFeature(e,t,r){if(this._abortController.signal.aborted)return;const a=this.layerExpressionsModelMap.get(t.layer);if(!a||0===a.components.length)return;const s=new Set,o=new Set([e]),i=new Set;for(;o.size>0;){const[e]=o;if(o.delete(e),s.has(e))continue;s.add(e);const n=a.fieldReferencesMap.get(e.toLowerCase());if(!n)continue;for(const e of n)i.has(e)&&n.delete(e);if(0===n.size)continue;const l=new Set;await this.evaluateAffectedComponents([...n],t,a,r,l);for(const e of n)i.add(e);for(const e of l)s.has(e)||o.add(e)}}async evaluateAffectedComponents(e,t,r,a,s){const o=new Map;for(const a of e)o.has(a)||o.set(a,this.createSccEvaluator(a,t,o,r));if(0===o.size)return;const i=[...o.values()].map(e=>e.evaluate(a,s));await Promise.all(i)}createSccEvaluator(e,t,r,a){const s=new x(e,t,this.arcadeContext,a,this.evaluatedExpressions,this._abortController);for(const o of e.adjacencyList)s.dependentEvaluators.push(i.getOrCreateMapValue(r,o,()=>this.createSccEvaluator(o,t,r,a)));return s}async _evaluateSpecifiedComponentsForEachFeature(e,t,r=!1){this.calculating=!0;try{const a=[];for(const s of e){const e=this.layerExpressionsModelMap.get(s.layer);if(!e||0===e.components.length)continue;const o=new Set;a.push(this.evaluateAffectedComponents(t(e),s,e,r,o))}await n.whenOrAbort(Promise.all(a),this._abortController)}catch(e){o.getLogger(this).error(e),this.expressionEvaluationFailed=!0}finally{this.calculating=!1}}},r.__decorate([u.property()],t.ExpressionsManager.prototype,"calculating",void 0),r.__decorate([u.property({constructOnly:!0})],t.ExpressionsManager.prototype,"arcadeContext",void 0),r.__decorate([u.property()],t.ExpressionsManager.prototype,"_abortController",void 0),r.__decorate([u.property()],t.ExpressionsManager.prototype,"layerExpressionsModelMap",void 0),r.__decorate([u.property()],t.ExpressionsManager.prototype,"evaluatedExpressions",void 0),r.__decorate([u.property()],t.ExpressionsManager.prototype,"expressionEvaluationFailed",void 0),t.ExpressionsManager=r.__decorate([d.subclass("esri.widgets.BatchAttributeForm.expressions.ExpressionsManager")],t.ExpressionsManager);class x{constructor(e,t,r,a,s,o){this.scc=e,this.feature=t,this.arcadeContextInfo=r,this.expressionsModel=a,this.evaluatedExpressions=s,this._abortController=o,this.dependentEvaluators=[],this._evaluatorPromise=null}get baseContext(){const{editType:e,map:t,spatialReference:r,timeZone:a}=this.arcadeContextInfo,s=this.feature.layer,o="scene"===s?.type&&null!=s.associatedLayer?s.associatedLayer:s;return{variables:{$originalfeature:this.feature.original,$editcontext:{editType:e},$layer:o,$featureset:o,$datastore:o?.url,$feature:this.feature.plainGraphic,$map:t},executeContext:{rawOutput:!0,spatialReference:r??void 0,timeZone:a,abortSignal:this._abortController.signal}}}evaluate(e,t){return null==this._evaluatorPromise&&(this._evaluatorPromise=this._evaluate(e,t)),this._evaluatorPromise}async _evaluate(t,r){null===y&&(y=await new Promise((t,r)=>e(["../../../arcade/languageUtils"],t,r)));const a=this.dependentEvaluators.map(e=>e.evaluate(t,r));await n.whenOrAbort(Promise.all(a),this._abortController);for(const e of this.scc.executors){const a=this.baseContext;if(this._abortController.signal.aborted)break;const o=this.expressionsModel.arcadeExecutorUses.get(e)??[],n=i.getOrCreateMapValue(this.evaluatedExpressions,this.feature,()=>new l);let u=null,c=null;try{u=e.isAsync?await e.executeAsync(a.variables,a.executeContext):e.execute(a.variables,a.executeContext),c={result:u,status:"success"}}catch(e){c={error:e,status:"error"}}for(const e of o){const a=this.expressionsModel.elementTemplateMap.get(e.elementId);switch(e.executorPurpose){case"editable":case"required":n.set(m.makeUseId(e.elementId,e.executorPurpose),c);break;case"value":{if("error"===c?.status)continue;const e=a.getExpressionExecutorsForLayer(this.feature.layer);let t=!0;if(e?.editableExpression&&(t=!1===n.get(m.makeUseId(a.elementId,"editable"))?.result),t){const e=this.feature.getAttribute(a.fieldName)??null,t=v(c.result,this.feature,a.fieldName,this.arcadeContextInfo.timeZone);t!==e&&(this.feature.setAttribute(a.fieldName,t),r.add(a.fieldName))}}break;case"visibility":if(n.set(m.makeUseId(e.elementId,e.executorPurpose),c),!this.expressionsModel.preserveFieldValuesWhenHidden&&!1===c.result&&t)if(g.isGroupElementTemplate(a))for(const e of a.elements)g.isFieldElementTemplate(e)&&(null!==this.feature.getAttribute(e.fieldName)&&r.add(e.fieldName),this.feature.setAttribute(e.fieldName,null));else g.isFieldElementTemplate(a)&&(null!==this.feature.getAttribute(a.fieldName)&&r.add(a.fieldName),this.feature.setAttribute(a.fieldName,null))}}if("error"===c?.status){const e=new Set;for(const t of o){const r=this.expressionsModel.elementTemplateMap.get(t.elementId);if(r)switch(t.executorPurpose){case"editable":e.add(r.label+" - Editable expression");break;case"required":e.add(r.label+" - Required expression");break;case"value":e.add(r.label+" - Value expression");break;case"visibility":e.add(r.label+" - Visibility expression")}}if(e.size>0)throw new s("expression-evaluation-failed","Arcade evaluation failed ("+[...e].join(",")+")");throw new s("expression-evaluation-failed","Arcade evaluation failed ")}}}}function v(e,t,r,a){if(null===e)return null;const o=t.layer.fieldsIndex.get(r);if(!o)throw new s("field-not-found","Unable set field value as the field cannot be found. ("+r+")");switch(o.type){case"big-integer":case"integer":case"long":case"oid":case"small-integer":case"single":case"double":return y.toNumber(e);case"global-id":case"guid":case"string":return y.toString(e);case"date":{if(y.isDate(e))return e.getTime();const t=y.toDate(e,a);if(!t)throw new s("unsupported-value-type","Arcade return type is not a supported field type. ("+r+")");return t.getTime()}case"date-only":{if(y.isDateOnly(e))return e.toStorageFormat();if(y.isDate(e))return f.DateOnly.fromDateTime(e.toDateTime()).toStorageFormat();const t=f.DateOnly.fromString(y.toString(e));if(!t)throw new s("unsupported-value-type","Arcade return type is not a supported field type.");return t.toStorageFormat()}case"time-only":{if(y.isTime(e))return e.toStorageString();if(y.isDate(e))return h.TimeOnly.fromDateTime(e.toDateTime()).toStorageString();const t=h.TimeOnly.fromString(y.toString(e));if(!t)throw new s("unsupported-value-type","Arcade return type is not a supported field type.");return t.toStorageString()}case"timestamp-offset":{if(y.isDate(e))return e.toISOString(!1);const t=y.toDate(e,a);if(!t)throw new s("unsupported-value-type","Arcade return type is not a supported field type. ("+r+")");return t.toISOString(!1)}}throw new s("unsupported-value-type","Arcade return type is not a supported field type. ("+r+")")}function b(e){return e.components}function w(e){return Array.from(e.geometryReferences)}Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});