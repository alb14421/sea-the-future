// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/arrayUtils","../../../core/MapUtils","../../../core/Queue","../../../core/SetUtils","../templates/support/templateUtils"],function(e,t,n,o,s,r){"use strict";let i=0;function a(e,t){e.index=e.lowlink=t.nextIndex++,t.nodeStack.push(e);for(const n of c(e,t))-1===n.index?(a(n,t),e.lowlink=Math.min(e.lowlink,n.lowlink)):n.index<e.index&&t.nodeStack.contains(n)&&(e.lowlink=Math.min(e.lowlink,n.index)),t.nodeStack.contains(n)||e.crossLinkNeighbors.add(n);if(e.lowlink===e.index){const n=function(){i++;const e=i.toString();return{executors:new Set,adjacencyList:new Set,componentId:e}}();for(t.components.push(n);d(t.nodeStack)>=e.index;){const e=t.nodeStack.pop();if(null!=e){e.component=n,n.executors.add(e.executor);for(const t of e.crossLinkNeighbors)null!=t.component&&n.adjacencyList.add(t.component)}}}}function c({executor:e},o){const r=new Set;for(const t of e.fieldsUsed){const i=t.toLowerCase();n.getOrCreateMapValue(o.fieldReferencesMap,i,()=>new Set).add(e),s.addMany(r,l(i,o))}e.geometryUsed&&o.geometryReferences.add(e);const i=o.arcadeExecutorUses.get(e)?.filter(e=>"value"===e.executorPurpose)??[];for(const t of i){const n=o.executorMap.get(o.elementTemplatesById.get(t.elementId));n?.editableExpression&&n.editableExpression!==e&&r.add(n.editableExpression)}return Array.from(r).map(e=>o.nodeInfoMap.get(e)).filter(t.isSome)}function l(e,{executorMap:n,fieldElementTemplateMap:o,shouldConsiderVisibility:s}){const r=[],i=o.get(e);if(null==i)return r;const a=n.get(i);if(null==a)return r;if(t.pushIfSome(r,a.editableExpression),t.pushIfSome(r,a.valueExpression),s){t.pushIfSome(r,a?.visibilityExpression);const{group:e}=i;if(null!=e){const o=n.get(e)?.visibilityExpression;t.pushIfSome(r,o)}}return r}function p(e){const t=new Map;for(const n of e.keys())r.isFieldElementTemplate(n)&&t.set(n.fieldName.toLowerCase(),n);return t}function u(e,t){const n=new Set;for(const o of e){const e=t.get(o);e?.component&&n.add(e.component)}return n}function d(e){return e.peek()?.index??-1}e.ExpressionsModel=class{constructor(e){this.arcadeExecutorUses=new Map,this.components=[],this.preserveFieldValuesWhenHidden=!1,this.executorMap=e.executorMap,this.preserveFieldValuesWhenHidden=!0===e.preserveFieldValuesWhenHidden,this.elementTemplateMap=new Map;for(const e of this.executorMap.keys())this.elementTemplateMap.set(e.elementId,e);this._buildDependencyGraph()}_buildDependencyGraph(){const e=function(e){const n=Array.from(e.values()).filter(t.isSome),o=new Set(n.flatMap(e=>Array.from(Object.values(e)))),s=Array.from(o).map(e=>({component:null,crossLinkNeighbors:new Set,executor:e,index:-1,lowlink:-1,onStack:!1}));return new Map(s.map(e=>[e.executor,e]))}(this.executorMap),r={components:[],arcadeExecutorUses:this.arcadeExecutorUses,elementTemplatesById:new Map([...this.executorMap.keys()].map(e=>[e.elementId,e])),executorMap:this.executorMap,fieldElementTemplateMap:p(this.executorMap),fieldReferencesMap:new Map,geometryReferences:new Set,nextIndex:0,nodeInfoMap:e,nodeStack:new o(s.last),shouldConsiderVisibility:!this.preserveFieldValuesWhenHidden};for(const e of this.executorMap.keys()){const t=this.executorMap.get(e);t.editableExpression&&n.getOrCreateMapValue(this.arcadeExecutorUses,t.editableExpression,()=>[]).push({elementId:e.elementId,executorPurpose:"editable"}),t.valueExpression&&n.getOrCreateMapValue(this.arcadeExecutorUses,t.valueExpression,()=>[]).push({elementId:e.elementId,executorPurpose:"value"}),t?.visibilityExpression&&n.getOrCreateMapValue(this.arcadeExecutorUses,t.visibilityExpression,()=>[]).push({elementId:e.elementId,executorPurpose:"visibility"}),t?.requiredExpression&&n.getOrCreateMapValue(this.arcadeExecutorUses,t.requiredExpression,()=>[]).push({elementId:e.elementId,executorPurpose:"required"})}for(const e of this.arcadeExecutorUses.values())e.sort(e=>"editable"===e.executorPurpose?-1:1);for(const t of e.values())-1===t.index&&a(t,r);this.dependencyGraphComponents=function(e){return new Map([...e.values()].map(({component:e,executor:t})=>[t,e]))}(r.nodeInfoMap),this.fieldReferencesMap=function({fieldReferencesMap:e,nodeInfoMap:t}){const n=new Map;for(const[o,s]of e.entries())n.set(o,u(s,t));return n}(r),this.geometryReferences=function({geometryReferences:e,nodeInfoMap:t}){return u(e,t)}(r),this.components=r.components}},e.getDirectDependencies=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});