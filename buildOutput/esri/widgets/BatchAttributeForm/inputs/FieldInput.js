// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../core/arrayUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../layers/support/CodedValue","../../../layers/support/CodedValueDomain","../../../layers/support/Domain","../../../layers/support/InheritedDomain","../../../layers/support/RangeDomain","../../../layers/support/domainUtils","../../../layers/support/fieldUtils","../../../smartMapping/support/utils","../../../support/guards","../../../time/constants","./EditableInput","./support/inputUtils","../../support/forms/formUtils"],function(e,t,i,r,a,n,l,o,s,u,d,p,m,c,h,f,y,g,_){"use strict";let b=class extends y{constructor(e){super(e),this.group=null,this.type="field",this.userHasChangedValue=!1,this._hasIntersectionWithElementFieldDomain=!1}get compositeError(){if(this.valid)return null;const{errors:e}=this;if(e.length<this.features.length)return"batch-attribute-form-validation::features-have-different-errors";const t=e[0];for(const i of e)if(i.error!==t.error)return"batch-attribute-form-validation::features-have-different-errors";return t.error}get dataType(){const{field:e}=this;return m.isNumericField(e)?"number":m.isStringField(e)?"text":c.isAnyDateField(e)||m.isTimeOnlyField(e)?"date":"unsupported"}get domain(){const e=this._allDomains.toArray();return this.calculateDomain(e)}get distinctValues(){if(this.featuresHaveSameValue)return[this.value];const e=new Set;for(const t of this.features)e.add(t.getAttribute(this.fieldName));return Array.from(e)}get editable(){return!!this.field.editable&&(this._evaluatedEditableExpression??!0)}get effectiveVisible(){return g.visibilityCodeToBoolean(this.effectiveVisibilityCode)}get effectiveVisibilityCode(){const{visibilityCode:e}=this;if("visible"!==e)return e;const{group:t}=this;if(null==t)return e;const i=t.visibilityCode;return"hidden:visibility-expression:all-features"===i?"hidden:group-visibility-expression:all-features":"hidden:visibility-expression:some-features"===i?"hidden:group-visibility-expression:some-features":e}get errors(){return this._validate()}get featuresHaveSameValue(){const{fieldName:e}=this,t=this.features.at(0)?.getAttribute(e);return this.features.every(i=>i.getAttribute(e)===t)}get field(){return this.template.field}get fieldName(){return this.field.name}get invalidFeatures(){return this.errors.map(e=>e.feature)}get isSubtypeField(){return this.layers.some(e=>{if(e&&"subtypeField"in e){const{subtypeField:t,fieldsIndex:i}=e;return(i.get(t)?.name??t)===this.fieldName}return!1})}get showNoValueOptionEnabled(){const{input:e}=this.template;return!(this.required||g.isFieldInputWithShowNoValueOptionInput(e)&&!0!==e?.showNoValueOption)}get showNoValueLabel(){const{input:e}=this.template;return g.isFieldInputWithShowNoValueOptionInput(e)?e?.noValueOptionLabel:null}get includeTime(){const{template:e,field:t}=this;return"date"===this.dataType&&("time-only"===t.type||"date-only"!==t.type&&("datetime-picker"!==e.input?.type||e.input.includeTime))}get includeTimeOffset(){if("timestamp-offset"!==this.field.type)return!1;const e=this.template.input;return!e||"datetimeoffset-picker"===e.type&&e.includeTimeOffset}get maxLength(){return _.getMaxLength({dataType:this.dataType,field:this.field,input:this.template.input})}get minLength(){return _.getMinLength({dataType:this.dataType,field:this.field,input:this.template.input})}get range(){if("date"===this.dataType)return this._dateRange;const{domain:e,field:t}=this;if(e){const i=p.getDomainRange(t,e);return{max:i?.max,min:i?.min}}const i=this._allDomains.toArray().every(e=>!e)?m.getFieldRange(t):null;return{max:i?.max===Number.MAX_VALUE?null:i?.max??null,min:i?.min===-Number.MAX_VALUE?null:i?.min??null}}get required(){if(!this.editable)return!1;if(!this.field.nullable||this.isSubtypeField)return!0;const e=this.visible&&!1!==this.group?.visible,t=this._evaluatedRequiredExpression;return!(!e||null==t)&&t}get submittable(){return!(this.required&&this.distinctValues.some(e=>_.isEmptyValue(e))||!this.valid)}get valid(){return 0===this.errors.length}get value(){return this.featuresHaveSameValue?this.features.at(0)?.getAttribute(this.fieldName)??null:g.differentValuesString}get visibilityCode(){return this.field.visible?this._fieldShouldHaveDomain&&null==this.domain?"hidden:no-domain-in-common":this._baseVisibilityCode:"hidden:field-definition"}get effectiveTimeZone(){const e=this.template;let t=e.formTimeZone??"system";return e.layerTimeZone?e.layerTimeZone===f.unknown?t=f.utc:e.formTimeZone===f.unknown&&(t=e.layerTimeZone):e.formTimeZone===f.unknown&&(t=f.utc),t}get codedValueDomainOptions(){return"coded-value"===this.domain?.type?this.domain.codedValues.map(({name:e,code:t})=>({name:e,value:t})):[]}get codedValueOptions(){const e=this.codedValueDomainOptions,{value:t}=this,i=null==t||t===g.differentValuesString||e.some(e=>e.value===t)?[]:[{name:`${t}`,value:t}];return[e,i]}get _evaluatedRequiredExpression(){let e=!1,t=!0;const i=this.template;for(const r of this.features){if(null==i.getExpressionExecutorsForLayer(r.layer)?.requiredExpression)continue;t=!1;const a=this._lookupEvaluatedExpression(r,"required");e="success"!==a?.status||e||!0===a.result}return t?null:e}get _allDomains(){const e=this.template.domain;return this.features.map(t=>{const i=t.layer.getFieldDomain(this.fieldName,{feature:t.plainGraphic});return"range"===i?.type||"range"===e?.type?i??this.template.domain:i})}get _fieldShouldHaveDomain(){return!!this._hasIntersectionWithElementFieldDomain||this._allDomains.some(t.isSome)}get _dateFormRange(){if("date"!==this.dataType)return{};const e=this.template.input;if(!e)return{};const{type:t}=e;let i={};if("date-picker"!==t&&"time-picker"!==t&&"datetimeoffset-picker"!==t||(i=p.dateTimeFieldValuesToNumericRange(this.field,e.max,e.min)),"datetime-picker"===t){const{max:t,min:r}=e;i={max:null!=t&&_.dateIsValid(t)?t.getTime():null,min:null!=r&&_.dateIsValid(r)?r.getTime():null}}return{min:i.min,max:i.max,rawMax:i?.rawMax??null,rawMin:i?.rawMin??null}}get _dateRange(){const{_dateFormRange:e,template:t,field:i,domain:r}=this;if("date"!==this.dataType)return{};if(!r)return this._fieldShouldHaveDomain?{}:e;const a=p.getDomainRange(i,r);if(!a)return e;const{max:n,min:l,rawMax:o,rawMin:s}=e,{type:u}=t.field;if("date"===u){const{max:e,min:t}=a;return{max:h.isNumber(n)&&(null===e||null!=e&&n<=e)?n:e??null,min:h.isNumber(l)&&(null===t||null!=t&&l>=t)?l:t??null}}if("date-only"===u||"time-only"===u||"timestamp-offset"===u){const{max:e,min:t,rawMax:i,rawMin:r}=a,u=h.isNumber(n)&&o&&(null==e||n<e),d=h.isNumber(l)&&s&&(null==t||l>t);return{max:u?n:e,min:d?l:t,rawMax:u?o:i,rawMin:d?s:r}}return{}}async setValueFromUser(e){this.userHasChangedValue=!0;const t=[],i=this.fieldName;for(const r of this.features)r.getAttribute(i)!==e&&t.push(r);this._setValue(e),await this.expressionsManager.valueChanged(i,t)}_setValue(e){const{fieldName:t}=this;for(const i of this.features)i.setAttribute(t,e)}_validate(){const{dataType:e,fieldName:t,maxLength:i,minLength:r,range:a}=this,n=[];for(const l of this.features){const{layer:o}=l,s=o.getField(t)??this.field,u=o.getFieldDomain(t,{feature:l.plainGraphic}),d=this.calculateDomain([u]),p=this._requiredForFeature(l),m=l.getAttribute(t),c=_.validateFormValue(m,{dataType:e,domain:d,field:s,maxLength:i,minLength:r,range:a,required:p});c&&n.push({error:c,feature:l.source})}return n}_editableForFeature(e){if(!this.field.editable)return!1;if(null==this.template.getExpressionExecutorsForLayer(e.layer)?.editableExpression)return!0;const t=this._lookupEvaluatedExpression(e,"editable");return"success"===t?.status&&!0===t.result}_effectiveVisibleFeature(e){if(this.group&&!this.group.visibleForFeature(e))return!1;if(null==this.template.getExpressionExecutorsForLayer(e.layer)?.visibilityExpression)return!0;const t=this._lookupEvaluatedExpression(e,"visibility");return"success"===t?.status&&!0===t.result}_requiredForFeature(e){if(!this._editableForFeature(e))return!1;if(!this.field.nullable||this.isSubtypeField)return!0;const t=this._effectiveVisibleFeature(e);if(null==this.template.getExpressionExecutorsForLayer(e.layer)?.requiredExpression)return!1;const i=this._lookupEvaluatedExpression(e,"required");return"success"!==i?.status?t:t&&!0===i.result}calculateDomain(e){const t=e.find(e=>null!=e),i=this.template.domain;if(!t)return i&&p.isDomainValidForField(this.field,i)?i:null;switch(t.type){case"coded-value":if(e.some(e=>!e)){if(!i)return null;e=e.filter(e=>null!==e)}break;case"range":e=e.filter(e=>null!==e)}if(!e.every(e=>e?.type===t?.type))return null;let r=null;switch(t?.type){case"range":r=this._intersectRangeDomains(e);break;case"coded-value":r=this._intersectCodedValueDomains(e)}return r}_intersectCodedValueDomains(e){if(!e.length)return null;const t=new Map(e[0].codedValues.map(({code:e,name:t})=>[e,t])),i=this.template.domain?new Map(this.template.domain.codedValues.map(({code:e,name:t})=>[e,t])):null;for(const i of e)for(const[e,r]of t)i.codedValues.some(t=>t.code===e&&t.name===r)||t.delete(e);let r=t;if(i){r=new Map;for(const[e,a]of i)t.has(e)&&r.set(e,a)}const a=Array.from(r.entries()).map(([e,t])=>new l.CodedValue({code:e,name:t}));return a.length?new o({codedValues:a}):null}_intersectRangeDomains(e){if(!e.length)return null;let t=e[0];for(let i=1;i<e.length;i++){if(!t)return null;t=this._findMinMaxValuesBetweenTwoDomains(t,e[i])}if(t&&!p.isDomainValidForField(this.field,t))return null;const{domain:i}=this.template;if(t&&i&&i instanceof d){const e=this._findMinMaxValuesBetweenTwoDomains(t,i);return this._hasIntersectionWithElementFieldDomain=!!e,e}return t}_getMinMaxFromRangeDomain(e){const t=e.minValue,i=e.maxValue,{field:r}=this;return m.isDateOnlyField(r)||m.isTimeOnlyField(r)||m.isTimestampOffsetField(r)?p.dateTimeFieldValuesToNumericRange(r,i,t):{min:null!=t&&"number"==typeof t?t:null,max:null!=i&&"number"==typeof i?i:null}}_findMinMaxValuesBetweenTwoDomains(e,t){const i=new d,r=this._getMinMaxFromRangeDomain(e),a=this._getMinMaxFromRangeDomain(t),{field:n}=this,l=this._getValidRangeValue(r.min,-1/0),o=this._getValidRangeValue(r.max,1/0),s=this._getValidRangeValue(a.min,-1/0),u=this._getValidRangeValue(a.max,1/0);return i.minValue=Math.max(l,s),i.maxValue=Math.min(o,u),i.minValue===-1/0||i.maxValue===1/0||i.minValue>i.maxValue?null:((m.isDateOnlyField(n)||m.isTimeOnlyField(n)||m.isTimestampOffsetField(n))&&(i.minValue=Number(r.min)>Number(a.min)?r.rawMin:a.rawMin,i.maxValue=Number(r.max)<Number(a.max)?r.rawMax:a.rawMax),i.name="intersection",i)}_getValidRangeValue(e,t){return h.isNumber(e)?e:t}};return e.__decorate([i.property()],b.prototype,"dataType",null),e.__decorate([i.property()],b.prototype,"domain",null),e.__decorate([i.property()],b.prototype,"distinctValues",null),e.__decorate([i.property()],b.prototype,"editable",null),e.__decorate([i.property()],b.prototype,"effectiveVisible",null),e.__decorate([i.property()],b.prototype,"effectiveVisibilityCode",null),e.__decorate([i.property()],b.prototype,"errors",null),e.__decorate([i.property()],b.prototype,"featuresHaveSameValue",null),e.__decorate([i.property()],b.prototype,"field",null),e.__decorate([i.property()],b.prototype,"fieldName",null),e.__decorate([i.property()],b.prototype,"group",void 0),e.__decorate([i.property()],b.prototype,"invalidFeatures",null),e.__decorate([i.property()],b.prototype,"isSubtypeField",null),e.__decorate([i.property()],b.prototype,"showNoValueOptionEnabled",null),e.__decorate([i.property()],b.prototype,"showNoValueLabel",null),e.__decorate([i.property()],b.prototype,"includeTime",null),e.__decorate([i.property()],b.prototype,"includeTimeOffset",null),e.__decorate([i.property()],b.prototype,"maxLength",null),e.__decorate([i.property()],b.prototype,"minLength",null),e.__decorate([i.property()],b.prototype,"range",null),e.__decorate([i.property()],b.prototype,"required",null),e.__decorate([i.property()],b.prototype,"submittable",null),e.__decorate([i.property({readOnly:!0})],b.prototype,"type",void 0),e.__decorate([i.property()],b.prototype,"userHasChangedValue",void 0),e.__decorate([i.property()],b.prototype,"valid",null),e.__decorate([i.property()],b.prototype,"value",null),e.__decorate([i.property()],b.prototype,"visibilityCode",null),e.__decorate([i.property()],b.prototype,"effectiveTimeZone",null),e.__decorate([i.property()],b.prototype,"_evaluatedRequiredExpression",null),e.__decorate([i.property()],b.prototype,"_hasIntersectionWithElementFieldDomain",void 0),e.__decorate([i.property()],b.prototype,"_allDomains",null),e.__decorate([i.property()],b.prototype,"_fieldShouldHaveDomain",null),e.__decorate([i.property()],b.prototype,"_dateFormRange",null),e.__decorate([i.property()],b.prototype,"_dateRange",null),b=e.__decorate([n.subclass("esri.widgets.BatchAttributeForm.inputs.FieldInput")],b),b});