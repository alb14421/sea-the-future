// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Error","../../../../core/Logger","../../../../form/ExpressionInfo","../../../../form/support/formUtils","../../../../layers/support/fieldUtils","../../../../layers/support/layerUtils","../../../../time/constants","../../expressions/expressionUtils","../BatchFormTemplate","../FieldElementTemplate","../GroupElementTemplate"],function(e,t,r,n,o,i,s,a,l,m,d,p){"use strict";const u="expression/dea57012-47ca4b55a000-8df62742ed0c",c=()=>r.getLogger("esri.widgets.BatchAttributeForm.templates.templateUtils");async function f(e,{arcadeExecutorProvider:t,formTimeZone:r}){const n=new Set(i.getLowerCaseEditTrackingFields(e)),o={arcadeExecutorProvider:t,formTimeZone:r,layer:e},s=[];for(const t of e.fields)T(t,e,n)&&s.push(x(t,o));const a=await Promise.all(s);return new m({elements:a,preserveFieldValuesWhenHidden:!0})}function y(e,t){for(const r of e??[])if("group"!==r.type){if("field"===r.type){if(!1===r.editable&&!r.editableExpression)return!0;if(t.subtypeField&&(s.isSubtypeSublayer(t)||s.isSubtypeGroupLayer(t))&&r.fieldName?.toLowerCase()===t.subtypeField.toLowerCase())return!0}}else if(y(r.elements??[],t))return!0;return!1}async function b(e,t){const r=e.formTemplate;if(!r)return f(e,t);let o=null;y(r.elements??[],e)&&(o=new n({title:"",name:u,expression:"false"}));const i=l.makeExpressionInfosMap(o?[...r.expressionInfos??[],o]:r.expressionInfos),s={description:r.description,elements:new Array,title:r.title,preserveFieldValuesWhenHidden:r.preserveFieldValuesWhenHidden},{elements:a}=r;if(!a)return new m(s);const{arcadeExecutorProvider:d,formTimeZone:p}=t;for(const t of a){const r=await w(t,{arcadeExecutorProvider:d,expressionInfos:i,layer:e,formTimeZone:p});r&&s.elements.push(r)}return new m(s)}async function w(e,r){return o.isFieldElement(e)?async function(e,{arcadeExecutorProvider:r,expressionInfos:n,layer:o,formTimeZone:i}){const{fieldsIndex:a}=o,{description:m,domain:p,fieldName:f,hint:y,input:b,label:w}=e;if(null==f||!a.has(f))return c().warn(new t("batch-attribute-form:invalid-form-element-field",`Field element with label '${w}' does not refer to a valid field`)),null;const x={description:m,domain:p,field:a.get(f),hint:y,input:b,formTimeZone:i,layerTimeZone:E(o),label:w};!1!==e.editable||e.editableExpression||((e=e.clone()).editableExpression=u),o.subtypeField&&(s.isSubtypeSublayer(o)||s.isSubtypeGroupLayer(o))&&e.fieldName?.toLowerCase()===o.subtypeField.toLowerCase()&&((e=e.clone()).editableExpression=u);const T=new d.FieldElementTemplate(x),F=await l.makeExecutorSetForFormElement({element:e,expressionInfos:n,provider:r});return T.addLayer(o,F),T}(e,r):o.isGroupElement(e)?async function(e,t){const{arcadeExecutorProvider:r,expressionInfos:n,layer:o}=t,{description:i,label:s,initialState:a}=e,m={description:i,elements:[],label:s,initialState:a??"expanded"};for(const r of e.elements){const e=await w(r,t);e&&m.elements.push(e)}const d=new p.GroupElementTemplate(m),u=await l.makeExecutorSetForFormElement({element:e,expressionInfos:n,provider:r});return d.addLayer(o,u),d}(e,r):(c().warn(new t("batch-attribute-form:unsupported-element-type",`Form elements of type ${e.type} are not supported`)),null)}async function x(e,{arcadeExecutorProvider:t,layer:r,formTimeZone:n}){const o=new d.FieldElementTemplate({field:e,label:e.alias??e.name,formTimeZone:n,layerTimeZone:E(r)}),i={},a=(s.isSubtypeGroupLayer(r)||s.isSubtypeSublayer(r))&&r.subtypeField&&r.subtypeField.toLowerCase()===e.name.toLowerCase();return!a&&e.editable&&r.userHasUpdateItemPrivileges&&(i.editableExpression=await t.getArcadeExecutor("true")),a&&(i.editableExpression=await t.getArcadeExecutor("false")),o.addLayer(r,i),o}function T(e,t,r){return!r.has(e.name.toLowerCase())&&i.isFieldVisibleByDefault(e,t)}function E(e){return s.isSubtypeSublayer(e)&&e.parent&&(e=e.parent),e&&"datesInUnknownTimezone"in e&&e.datesInUnknownTimezone?a.unknown:e&&"preferredTimeZone"in e&&e.preferredTimeZone?e.preferredTimeZone:null}e.convertFormTemplateToBatchFormTemplate=b,e.createBatchFormTemplate=async function(e,t){return e.formTemplate?.elements&&e.formTemplate?.elements.length>0?b(e,t):f(e,t)},e.createBatchFormTemplateFromFields=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});