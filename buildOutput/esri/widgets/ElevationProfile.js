// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../chunks/tslib.es6","../core/asyncUtils","../core/maybe","../core/memoize","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","./ElevationProfile/css","./ElevationProfile/ElevationProfileViewModel","./ElevationProfile/ElevationProfileVisibleElements","./ElevationProfile/components/Legend","./ElevationProfile/components/SettingsButton","./ElevationProfile/support/constants","../chunks/componentsUtils","./support/globalCss","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],function(e,t,s,r,i,n,o,a,l,c,h,d,p,u,_,m,C,v,g,y,b,f,w,k){"use strict";const M=[{type:"select"},{type:"sketch"}],B={none:null,"no-valid-input":"noProfile","no-visible-profiles":"noProfile","refined-but-no-chart-data":"noProfile","too-complex":"tooComplex","unknown-error":"unknown","invalid-geometry":"invalidGeometry","invalid-elevation-info":"invalidElevationInfo"};let S=class extends p{constructor(e,t){super(e,t),this.viewModel=null,this.visibleElements=new m,this.messages=null,this.messagesCommon=null,this.messagesUnits=null,this._chartContainer=null,this._chart=null,this._chartInitTask=null,this._chartIsRefined=!1,this._zoomOutButtonVisible=!1,this._getChartUpdateParamsMemoized=i.memoize((e,t,s,r)=>({chart:e,data:t,stationary:s,messages:r})),this._onZoomOutButtonClick=()=>{this._chart?.zoomOut()},this._onClearButtonClick=()=>{this.viewModel.clear()},e?.viewModel||(this._defaultViewModel=new _({view:e?.view}),this.viewModel=this._defaultViewModel)}loadDependencies(){return y.loadCalciteComponents({action:()=>new Promise((t,s)=>e(["../chunks/index12"],t,s)),button:()=>new Promise((t,s)=>e(["../chunks/index2"],t,s)),loader:()=>new Promise((t,s)=>e(["../chunks/index32"],t,s))})}postInitialize(){this.addHandles([o.watch(()=>({container:this._chartContainer}),({container:e})=>{this._destroyChart(),null!=e&&this._initializeChart(e)},o.initial),o.watch(()=>this._chartUpdateParams,()=>this._updateChart(this._chartUpdateParams),o.initial)])}destroy(){this._destroyChart(),null!=this._defaultViewModel&&this.viewModel!==this._defaultViewModel&&this._defaultViewModel.destroy()}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}get input(){return this.viewModel.input}set input(e){this.viewModel.input=e}get profiles(){return this.viewModel.profiles}set profiles(e){this.viewModel.profiles=e}get unitOptions(){return this.viewModel.unitOptions}set unitOptions(e){this.viewModel.unitOptions=e}get unit(){return this.viewModel.unit}set unit(e){this.viewModel.unit=e}get icon(){return"altitude"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get visible(){return this.viewModel.visible}set visible(e){this.viewModel.visible=e}get test(){return{chart:this._chart}}get _selectButtonVisible(){return!0===this.visibleElements.selectButton&&this.viewModel.selectAvailable}get _chartUpdateParams(){const e=this.view;return this._getChartUpdateParamsMemoized(this._chart,this.viewModel.chartData,null==e||e.stationary,this._chartMessages)}get _chartMessages(){return{...this.messagesUnits,...this.messages}}get _profilesArray(){return this.profiles.toArray()}render(){const{viewModel:e,visible:t}=this;return k.tsx("div",{"aria-label":this.messages.widgetLabel,class:this.classes({[u.css.base]:t,[b.globalCss.widget]:t,[b.globalCss.panel]:t,[b.globalCss.widgetDisabled]:t&&"disabled"===e.state,[u.css.refined]:1===e.progress}),key:this},k.tsx("div",{bind:this,key:"content-wrapper"},t?this._renderContentForState():null))}_renderContentForState(){switch(this.viewModel.state){case"ready":case"disabled":return this._renderContentForReadyState();case"selecting":return this._renderContentForSelectingState();case"creating":return this._renderContentForCreatingState();case"selected":return this._renderContentForSelectedState();case"created":return this._renderContentForCreatedState()}}_renderContentForReadyState(){const{messages:e,visibleElements:t,_selectButtonVisible:s}=this,{sketchButton:r}=t;let i;return i=r&&s?e.readyPrompt:r?e.readyPromptCreateOnly:s?e.readyPromptSelectOnly:e.errors?.noProfile,this._renderContent({prompt:i,chart:!1,actions:M})}_renderContentForSelectingState(){const{view:e}=this;if(null==e)return null;const t=this.messages[`selectingPrompt-${e.type}`];return this._renderContent({prompt:t,chart:!1,actions:[{type:"select-cancel"}]})}_renderContentForCreatingState(){const{view:e,viewModel:t}=this;if(null==e)return null;const s=t.hasVertices?[{type:"sketch-cancel"},{type:"sketch-done",disabled:!t.tool.interaction.canStopCreating}]:[{type:"select"},{type:"sketch",disabled:!0}];if("no-valid-input"===t.errorState){const t=this.messages[`creatingPrompt-${e.type}`];return this._renderContent({chart:!1,actions:s,prompt:t})}const r=this._getErrorMessage();return r?this._renderContent({chart:!1,actions:s,prompt:r}):this._renderContent({chart:!0,actions:s})}_renderContentForSelectedState(){const e=this._getErrorMessage();return e?this._renderContent({chart:!1,actions:M,prompt:e}):this._renderContent({chart:!0,actions:M})}_renderContentForCreatedState(){const e=this._getErrorMessage();return e?this._renderContent({chart:!1,actions:M,prompt:e}):this._renderContent({chart:!0,actions:M})}_getErrorMessage(){const e=B[this.viewModel.errorState];return e?this.messages?.errors?.[e]:null}_renderContent(e){const t=null!=e.prompt?this._renderPrompt(e.prompt):e.chart&&this._renderChart(),{viewModel:s}=this,r=null!=s.input;return k.tsx(k.tsxFragment,null,k.tsx("header",{class:u.css.header,key:"header"},this._zoomOutButtonVisible?this._renderZoomOutButton():null,this.visibleElements.clearButton&&r?this._renderClearButton():null,this.visibleElements.settingsButton?k.tsx(v.SettingsButton,{messages:this.messages,uniformChartScaling:s.uniformChartScaling,unit:s.unit,unitOptions:s.unitOptions,visibleElements:this.visibleElements,onUniformChartScalingChange:e=>s.uniformChartScaling=e,onUnitChange:e=>s.unit=e}):null),k.tsx("div",{class:u.css.mainContainer,key:"main-container"},t),this.visibleElements.legend?k.tsx(C.Legend,{effectiveUnits:s.effectiveUnits,messages:this.messages,profiles:this._profilesArray}):null,this._renderActions(e))}_renderZoomOutButton(){const e=this.messages.zoomOut;return k.tsx("calcite-action",{appearance:"transparent",class:u.css.zoomOutButton,"data-testid":"zoom-out-button",icon:"magnifying-glass-minus",key:"zoom-out",onclick:this._onZoomOutButtonClick,scale:"s",text:e,title:e})}_renderClearButton(){const e=this.messages.clearProfile;return k.tsx("calcite-action",{appearance:"transparent",class:u.css.clearButton,"data-testid":"clear-button",icon:"trash",key:"clear-profile",onclick:this._onClearButtonClick,scale:"s",text:e,title:e})}_renderPrompt(e){return[k.tsx("div",{bind:this,class:u.css.promptContainer,key:"prompt-container"},k.tsx("p",null,e))]}_renderChart(){if(!this.visibleElements.chart)return k.tsx("div",{class:u.css.chartContainer,key:"empty-chart-container"});const{chartData:e,progress:t}=this.viewModel,s=this._chartIsRefined||this._canRenderChart(),r=null!=e&&t<1;return s?k.tsx(k.tsxFragment,null,this._renderSpinner({size:s?"small":"large",visible:r}),k.tsx("div",{afterCreate:this._onChartContainerUpdate,afterRemoved:this._onChartContainerRemoved,afterUpdate:this._onChartContainerUpdate,bind:this,class:u.css.chartContainer,key:"chart-container"})):k.tsx(k.tsxFragment,null,this._renderSpinner({size:"large",visible:r}),k.tsx("div",{class:u.css.chartContainer,key:"chart-container-empty"}))}_renderSpinner(e){const t="small"===e.size,s=e.visible??!0;return k.tsx("calcite-loader",{class:this.classes(u.css.chartSpinner,t&&u.css.chartSpinnerSmall,s&&u.css.chartSpinnerVisible),"data-testid":"chart-spinner",inline:t,key:"spinner",label:"",scale:"s"})}_canRenderChart(){const e=this.viewModel.chartData;if(null==e)return!1;if(!this.viewModel.inputIsSketched)return e.refined;let t=0;for(const{samples:s}of e.lines)t+=null!=s?s.length:0;return e.refined||t<=g.getConfig().largeChartSamples}_renderActions({actions:e}){const t=e.map(e=>{switch(e.type){case"sketch":return this.visibleElements.sketchButton&&this._renderAction({action:e,className:u.css.sketchButton,label:this.messages.sketchButtonLabel,onClick:this._onSketchButtonClick,primary:!0});case"sketch-cancel":return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onCancelButtonClick,className:u.css.sketchCancelButton,label:this.messagesCommon.cancel,primary:!1});case"sketch-done":return this.visibleElements.sketchButton&&this._renderAction({action:e,onClick:this._onDoneButtonClick,className:u.css.sketchDoneButton,label:this.messagesCommon.done,primary:!0});case"select":return this._selectButtonVisible&&this._renderAction({action:e,onClick:this._onSelectButtonClick,className:u.css.selectButton,label:this.messages.selectButtonLabel,primary:!1});case"select-cancel":return this._selectButtonVisible&&this._renderAction({action:e,onClick:this._onCancelButtonClick,className:u.css.selectCancelButton,label:this.messagesCommon.cancel,primary:!1})}}).filter(Boolean);return t.length?k.tsx("footer",{class:u.css.footer,key:"footer"},t):null}_renderAction({action:e,className:t,label:s,onClick:r,primary:i}){return k.tsx("calcite-button",{appearance:i?"solid":"outline-fill",bind:this,class:this.classes(u.css.actionButton,t),disabled:e.disabled,key:`action-${e.type}`,onclick:r},s)}_onSketchButtonClick(){this.viewModel.start({mode:"sketch"})}_onSelectButtonClick(){this.viewModel.start({mode:"select"})}_onCancelButtonClick(){this.viewModel.cancel()}_onDoneButtonClick(){this.viewModel.stop()}_updateChart(e){const{data:t,chart:s,messages:r,stationary:i}=e;null!=s&&null!=r&&i&&this._canRenderChart()&&(s.update(e),this._chartIsRefined=null!=t&&t.refined)}_onChartContainerUpdate(e){this._chartContainer=e}_onChartContainerRemoved(e){this._chartContainer===e&&(this._chartContainer=null)}_initializeChart(t){r.abortMaybe(this._chartInitTask),this._chartInitTask=s.createTask(async s=>{const{createChart:i}=await new Promise((t,s)=>e(["./ElevationProfile/support/chartUtils"],t,s));n.throwIfAborted(s);const o=await i({container:t,abortOptions:{signal:s},onRangeChange:(e,t)=>{this._zoomOutButtonVisible=1!==e||1!==t},onCursorPositionChange:e=>{this.viewModel.hoveredChartPosition=e}});if(s.aborted)throw r.destroyMaybe(o),n.createAbortError();this._chart=o,this._updateChart(this._chartUpdateParams)})}_destroyChart(){this._chartInitTask=r.abortMaybe(this._chartInitTask),this._chart=r.destroyMaybe(this._chart),this._chartIsRefined=!1}};return t.__decorate([a.property({type:_})],S.prototype,"viewModel",void 0),t.__decorate([a.property()],S.prototype,"view",null),t.__decorate([a.property()],S.prototype,"input",null),t.__decorate([a.property()],S.prototype,"profiles",null),t.__decorate([a.property()],S.prototype,"unitOptions",null),t.__decorate([a.property()],S.prototype,"unit",null),t.__decorate([a.property({type:m,nonNullable:!0})],S.prototype,"visibleElements",void 0),t.__decorate([a.property()],S.prototype,"icon",null),t.__decorate([a.property()],S.prototype,"label",null),t.__decorate([a.property()],S.prototype,"visible",null),t.__decorate([a.property(),w.messageBundle("esri/widgets/ElevationProfile/t9n/ElevationProfile")],S.prototype,"messages",void 0),t.__decorate([a.property(),w.messageBundle("esri/t9n/common")],S.prototype,"messagesCommon",void 0),t.__decorate([a.property(),w.messageBundle("esri/core/t9n/Units")],S.prototype,"messagesUnits",void 0),t.__decorate([a.property()],S.prototype,"_chartContainer",void 0),t.__decorate([a.property()],S.prototype,"_chart",void 0),t.__decorate([a.property()],S.prototype,"_chartInitTask",void 0),t.__decorate([a.property()],S.prototype,"_chartIsRefined",void 0),t.__decorate([a.property()],S.prototype,"_zoomOutButtonVisible",void 0),t.__decorate([a.property()],S.prototype,"_selectButtonVisible",null),t.__decorate([a.property()],S.prototype,"_chartUpdateParams",null),t.__decorate([a.property()],S.prototype,"_chartMessages",null),t.__decorate([a.property()],S.prototype,"_profilesArray",null),S=t.__decorate([d.subclass("esri.widgets.ElevationProfile")],S),S});