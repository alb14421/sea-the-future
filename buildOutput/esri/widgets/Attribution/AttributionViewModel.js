// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/Accessor","../../core/asyncUtils","../../core/Collection","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/Extent","../../geometry/SpatialReference","../../geometry/support/contains","../../geometry/support/webMercatorUtils","../../views/3d/layers/Lyr3DWasm"],function(t,e,i,r,s,n,o,a,c,l,h,d,u,p,y){"use strict";function b(t,e){return t&&"copyright"in t&&(!e||"function"==typeof t.originOf&&"user"===t.originOf("copyright"))}function m(t,e,i){i&&e&&(t.find(t=>t.layerView===e&&t.text===i)||t.push({text:i,layerView:e}))}const g=[];let f=class extends e{constructor(t){super(t),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.removeHandles("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new r,this.view=null,this._allLayerViewsChange=t=>{this.removeHandles("suspension"),this.removeHandles("visible-geometry-changed");const e=this.view?.allLayerViews;e&&(this.addHandles(e.map(t=>s.watch(()=>[t.suspended,t.layer?.attributionVisible],()=>this._updateAttributionItems())).toArray(),"suspension"),e.forEach(t=>{"esri.views.3d.layers.Tiles3DLayerView3D"===t.declaredClass&&this.addHandles(t.on("visible-geometry-changed",()=>this._updateAttributionItems()),"visible-geometry-changed")})),t?.removed&&t.removed.forEach(t=>{this._pendingAttributions.delete(t),this._fetchedAttributionData.delete(t)}),this._updateAttributionItems()},this.addHandles([s.on(()=>this.view?.allLayerViews,"change",t=>this._allLayerViewsChange(t),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),s.when(()=>!0===this.view?.stationary,()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.view?.ready?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const t=this.view,e=t?.allLayerViews;if(g.length=0,!t||!e)return void this._clear();e.forEach(e=>{if(e.suspended||!e.layer?.attributionVisible)return;const i=e.layer;if(b(i,"user"))return void m(g,e,i.copyright);if(i.hasAttributionData){if(this._fetchedAttributionData.has(e)){const r=this._fetchedAttributionData.get(e);return void(r?m(g,e,this._getDynamicAttribution(r,t,i)):b(i)&&m(g,e,i.copyright))}return void this._fetchAttributionData(e)}const r="portalItem"in i?i.portalItem?.accessInformation:void 0;m(g,e,r||i.copyright)});const i=e.find(t=>"integrated-mesh-3dtiles"===t.layer?.type);if(this.view&&i){const t=y.getLyr3DWasm(this.view);if(t){const e=t.getAttributionText();for(let t=0;t<e.length;++t)m(g,i,e[t])}}var r,s;r=this.items,s=g,(r.length!==s.length||r.some((t,e)=>t.text!==s[e].text))&&(this.items.removeAll(),this.items.addMany(g)),g.length=0,this.notifyChange("state")}async _fetchAttributionData(t){if(this._pendingAttributions.has(t))return;this._pendingAttributions.add(t);const e=await i.result(t.layer.fetchAttributionData());if(this._pendingAttributions.has(t)){const i=e.ok?this._createContributionIndex(e.value,"bing-maps"===t.layer.type):null;this._pendingAttributions.delete(t),this._fetchedAttributionData.set(t,i)}this._updateAttributionItems()}_createContributionIndex(t,e){const i=t.contributors,r={};if(!i)return r;for(let t=0;t<i.length;t++){const s=i[t],n=s.coverageAreas;if(!n)return;for(const i of n){const n=i.bbox,o=i.zoomMin-(e&&i.zoomMin?1:0),a=i.zoomMax-(e&&i.zoomMax?1:0),c=new h({xmin:n[1],ymin:n[0],xmax:n[3],ymax:n[2],spatialReference:d.WGS84}),l={extent:p.geographicToWebMercator(c),attribution:s.attribution||"",score:null!=i.score?i.score:100,id:t};for(let t=o;t<=a;t++)r[t]??=[],r[t].push(l)}}return r.maxKey=Math.max.apply(null,Object.keys(r)),r}_getDynamicAttribution(t,e,i){const{extent:r,scale:s}=e;let n=i.tileInfo?.scaleToZoom(s)??0;if(n=Math.min(t.maxKey??0,Math.round(n)),!r||null==n||n<=-1)return"";const o=t[n],a=p.project(r.center.clone().normalize(),d.WebMercator),c=new Set;return o?o.filter(t=>{const e=t.id,i=!c.has(e)&&a&&t.extent&&u.extentContainsPoint(t.extent,a);return i&&c.add(e),i}).sort((t,e)=>e.score-t.score||t.objectId-e.objectId).map(t=>t.attribution).join(", "):""}};return t.__decorate([n.property({readOnly:!0,type:r})],f.prototype,"items",void 0),t.__decorate([n.property({readOnly:!0})],f.prototype,"state",null),t.__decorate([n.property()],f.prototype,"view",void 0),f=t.__decorate([l.subclass("esri.widgets.Attribution.AttributionViewModel")],f),f});