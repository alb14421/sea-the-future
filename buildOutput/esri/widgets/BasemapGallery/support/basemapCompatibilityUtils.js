// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/arrayUtils","../../../core/Error","../../../core/promiseUtils","../../../layers/support/layerUtils","../../../views/ViewingMode","../../../views/3d/terrain/terrainUtils","../../../views/3d/terrain/TilingScheme","../../../views/support/spatialReferenceSupport"],function(e,t,i,a,r,n,o,l,s){"use strict";function p(){throw new i("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}e.default2DCompatibility=async function(e,i={}){const{basemap:n,view:o}=e;a.throwIfAborted(i);const l=n.baseLayers.find(e=>"unknown"===e.type)?.loadError;if(null!=l)throw l;if(!o||"spatialReferenceLocked"in o&&!o.spatialReferenceLocked)return;if(await n.load(i),a.throwIfAborted(i),0===n.baseLayers.length)return;const s=n.baseLayers.at(0);if(!r.isTiledLayer(s))return;if(n.spatialReference){if(o.spatialReference.equals(n.spatialReference))return;p()}await s.load(i),a.throwIfAborted(i);const c=(("supportedSpatialReferences"in s?s.supportedSpatialReferences:null)||["tileInfo"in s?s.tileInfo?.spatialReference:null]).filter(t.isSome);0!==c.length&&c.every(e=>!o.spatialReference.equals(e))&&p()},e.default3DCompatibility=async function(e,t={}){const{basemap:p,view:c}=e;await p.load(t),function(e){if(0===e.baseLayers.length&&0===e.referenceLayers.length)return;const t=e.baseLayers.concat(e.referenceLayers).toArray().filter(e=>!r.isBasemap3DSupportedLayer(e)).map(e=>function(e){return new i("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})}(e));if(t.length)throw t[0]}(p),await async function(e,t,a){if(0===e.baseLayers.length)return;const p=e.baseLayers.at(0);if(r.isBasemapSupportedTiledLayer(p)){try{await p.load(a)}catch(e){const t="basemap-compatibility:unknown-error",a="Unknown basemap compatibility error",{name:r=t,message:n=a,details:o}=e;throw new i(r,n,o)}!function(e,t){const a=t.state.viewingMode;if(!a)return;let r,p;if("wmts"===e?.type){const n=o.getTileInfoAndExtentFromWMTSLayer(e,t.spatialReference,a);if(null==n.tileInfo)throw new i("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");r=n.tileInfo,p=n.fullExtent}else r=e.tileInfo,p=e.fullExtent;if(null==r)return;if(!s.isSpatialReferenceSupported(r.spatialReference,a))throw new i(`basemapgalleryitem:spatial-reference-unsupported-${n.stringFromViewingMode(a)}`,`Basemap spatial reference is unsupported in ${n.stringFromViewingMode(a)} mode`);const c="vector-tile"===e?.type?r.getCompatibleForVTL(256):null;if(1===a){let t=o.checkIfTileInfoSupportedForView(r,p,null,a);if(t&&"vector-tile"===e?.type&&null!=p&&c&&!o.checkIfTileInfoSupportedForView(c,p,null,a)&&(t=null),t){const e=r.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new i(`basemapgalleryitem:tiling-scheme-unsupported-${e}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(l.TilingScheme.checkUnsupported(r))throw new i("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const f=t.basemapTerrain?.tilingScheme;if(f&&!f.compatibleWith(r)&&("vector-tile"!==e?.type||!c||!f.compatibleWith(c)))throw new i("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}(p,t)}}(p,c,t),a.throwIfAborted(t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});