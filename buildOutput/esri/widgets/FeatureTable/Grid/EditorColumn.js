// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./Column","../../support/uriUtils"],function(e,t,o,n,i,r,l,a,c){"use strict";const s="Escape",u=Symbol();let d=class extends a{constructor(e){super(e),this.editInfo=null,this.cellValueValidatorFunction=({oldValue:e,value:t})=>e!==t,this.editable=!0,this.headerRenderFunction=e=>{const{root:t}=e,o=this.createHeaderContent();this.tableEditingEnabled&&!this.effectiveEditable&&o.prepend(this._lockIconNode),this.removeCellContent(t),t.appendChild(o)},this.inputRenderFunction=({root:e,column:t,rowData:o})=>{if(this.editInfo||!this.effectiveEditable||!o)return;const n=this.getCellValue(o),i=this.createInputElement({value:n});this._set("editInfo",{column:t,inputs:[i],root:e,rowData:o,oldValue:n});const r=document.createElement("div");r.appendChild(i),this.removeCellContent(e),e.appendChild(r),i.focus(),i instanceof HTMLInputElement&&i.select()},this.loadingMessage="",this.inputType="text",this.maxLength=null,this.onShowPromptCallback=()=>{},this.parseInputValueFunction=({inputs:e})=>e?.length||1!==e.length||Array.isArray(e[0].value)?null:e[0].value,this.renderFunction=e=>{const{root:t,rowData:o}=e,{editInfo:n}=this;if(n)return;const i=this.getCellValue(o),r=this.cellValueFormatFunction({root:t,rowData:o,value:i});let l=null;t.onclick=()=>t.focus(),t.ondblclick=()=>this.inputRenderFunction(e),t.ontouchend=()=>this.inputRenderFunction(e);const a=this.grid?.getSlotElementByName(t.slot),u=a?.parentElement;u&&!u.onkeydown&&(u.onkeydown=t=>{"Enter"!==t.key||this.editInfo||this.inputRenderFunction(e),t.key===s&&this.editInfo&&this.cancel()}),null!=i&&null!=r?t.title=r.toString():t.title&&t.removeAttribute("title"),l=r instanceof HTMLElement?r:c.autoLink(this.messagesURIUtils,r),this.removeCellContent(t),l instanceof HTMLElement?t.appendChild(l):null!=l&&(t.innerHTML=l.toString())},this.required=!1,this.tableEditingEnabled=!1}get _lockIconNode(){return this.createCalciteIcon({icon:"lock",textLabel:this.messages?.editingPreventedColumn})}get effectiveEditable(){return this.tableEditingEnabled&&this.editable}get effectiveRequired(){return this.required}get editing(){return!!this.editInfo}get shouldShowPrompt(){return!1}cancel(){this.onEditComplete()}createCalciteOption(e,t,o=!1){const n=document.createElement("calcite-option");return n.label=e,n.value=`${t}`,n.selected=o,n}createCalciteSelect(e,t){const{effectiveRequired:o,messages:n}=this;let i=!1;const r=t.map(({name:t,value:o})=>{const n=o===e;return n&&(i=!0),this.createCalciteOption(t,o,n)});if(null!=e&&""!==e&&!i){const t=e.toString(),o=this.createCalciteOption(t,t);r.unshift(o)}o||r.unshift(this.createCalciteOption(`<${n?.noValue}>`,""));const l=document.createElement("calcite-select");return r.forEach(e=>l.appendChild(e)),l}createInputElement({value:e}){const{effectiveRequired:o,maxLength:n}=this,i=document.createElement("calcite-input");return null!=n&&(i.maxLength=n),i.required=o,i.value=null!=e?e.toString():"",this.addHandles([t.on(()=>i,"calciteInputChange",()=>this.onInputBlur(),t.sync),t.on(()=>i,"keydown",e=>{e.key===s&&this.onInputBlur(!0)},t.sync),t.on(()=>i,"blur",()=>this.onInputBlur(),t.sync)],u),i}createDateComponent(){const e=document.createElement("calcite-input-date-picker");return e.focusTrapDisabled=!0,e.overlayPositioning="fixed",e}createTimeComponent(){const e=document.createElement("calcite-input-time-picker");return e.overlayPositioning="fixed",e.placement="auto-start",e.step=1,e}createTimeZoneComponent(){const e=document.createElement("calcite-input-time-zone");return e.maxItems=4,e.overlayPositioning="fixed",e}onEditComplete(){this._set("editInfo",null),this.grid?.generateCellPartNames(),this.grid?.requestContentUpdate()}onInputBlur(e=!1){this.removeHandles(u),e?this.cancel():this.submit()}async submit(){const{editInfo:e}=this;if(!e)return void this.cancel();const{inputs:t,rowData:o,oldValue:n}=e,i=this.parseInputValueFunction({inputs:t});if(!this.cellValueValidatorFunction({value:i,oldValue:n}))return void this.cancel();const{root:r}=e,l=o.item.objectId,{fieldName:a}=this;r.textContent=this.loadingMessage,this.shouldShowPrompt?this.onShowPromptCallback({column:this,objectId:l,oldValue:n,value:i}):await this.updateItems({objectId:l,updates:[{fieldName:a,value:i}]})}async updateItems(e){const{store:t}=this;if(t)try{await t.updateItem(e),this.onEditComplete()}catch{this.cancel()}else this.cancel()}};return e.__decorate([o.property()],d.prototype,"_lockIconNode",null),e.__decorate([o.property({readOnly:!0})],d.prototype,"editInfo",void 0),e.__decorate([o.property()],d.prototype,"cellValueValidatorFunction",void 0),e.__decorate([o.property()],d.prototype,"editable",void 0),e.__decorate([o.property()],d.prototype,"effectiveEditable",null),e.__decorate([o.property()],d.prototype,"effectiveRequired",null),e.__decorate([o.property()],d.prototype,"editing",null),e.__decorate([o.property()],d.prototype,"headerRenderFunction",void 0),e.__decorate([o.property()],d.prototype,"inputRenderFunction",void 0),e.__decorate([o.property({constructOnly:!0})],d.prototype,"loadingMessage",void 0),e.__decorate([o.property()],d.prototype,"inputType",void 0),e.__decorate([o.property()],d.prototype,"maxLength",void 0),e.__decorate([o.property()],d.prototype,"onShowPromptCallback",void 0),e.__decorate([o.property()],d.prototype,"parseInputValueFunction",void 0),e.__decorate([o.property()],d.prototype,"renderFunction",void 0),e.__decorate([o.property()],d.prototype,"required",void 0),e.__decorate([o.property()],d.prototype,"shouldShowPrompt",null),e.__decorate([o.property()],d.prototype,"tableEditingEnabled",void 0),d=e.__decorate([l.subclass("esri.widgets.FeatureTable.Grid.EditorColumn")],d),d});