// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/ReactiveMap","../../core/sanitizerUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../Attachments/support/attachmentUtils","./Grid/Column","./Grid/ColumnCSS"],function(t,e,n,o,a,r,s,i,c,l,h){"use strict";const p="esri-attachments-column",m={contentContainer:`${p}__content`,showAttachmentsButton:`${p}__button`};let u=class extends l{constructor(t){super(t),this._buttonElements=new e,this._thumbnailElements=new e,this.attachmentsViewEnabled=!0,this.cellValueFormatFunction=({root:t,rowData:e})=>{const{_showAttachmentsViewEnabled:n,formatFunction:o}=this,a=this.getCellValue(e);if(o&&e){const{index:n,item:{attachments:r,feature:s,relatedRecords:i}}=e;return o({attachments:r,column:this,feature:s,index:n,relatedRecords:i,value:a,virtualIndex:this.getVirtualRowIndex(t),field:void 0})}if(!e)return a;const{index:r,item:{attachments:s,objectId:i}}=e,c=`(${a})`;if(!this.thumbnailsEnabled&&!n)return a;const l=document.createElement("span");l.textContent=l.title=c;let h=null;if(this.thumbnailsEnabled&&(h=this._createOrSyncThumbnails(i,s??[])),this._showAttachmentsViewEnabled){const t=document.createElement("div");h&&t.appendChild(h),t.appendChild(l);const e=this._createOrSyncShowAttachmentsButton(i,r);return e.appendChild(t),e}const p=document.createElement("div");return p.classList.add(m.contentContainer),h&&p.appendChild(h),p.appendChild(l),p},this.icon="attachment",this.layer=null,this.onShowAttachments=null,this.sortable=!1,this.store=null,this.textAlign="center",this.thumbnailAppearance="image",this.thumbnailCount=8,this.thumbnailIconScale="m",this.thumbnailsEnabled=!0}get _showAttachmentsViewEnabled(){return!(!this.attachmentsViewEnabled||!this.onShowAttachments)}get _supportsResize(){return!!this.store?.supportsResizeAttachments}get effectiveLabel(){return n.renderingSanitizer.sanitize(this.label??(this.messages?.attachments||this.fieldName))}getCellValue(t){return t?.item?.attachments?.length??0}_createOrSyncThumbnails(t,e){const n=document.createElement("div"),o=this._thumbnailElements.get(t);return o?.length&&o.length===e.length?o.forEach(t=>n.appendChild(t)):this._thumbnailElements.set(t,this._createThumbnailElements(e,n)),n}_createOrSyncShowAttachmentsButton(t,e){const n=this._buttonElements.get(t);if(n)return n.textContent="",n.onclick=n=>this._onShowAttachmentsClick({index:e,objectId:t,event:n}),n;const o=this.createCalciteButton({alignment:"icon-end-space-between",className:`${m.showAttachmentsButton} ${h.css.contentFull}`,iconEnd:"chevron-right",iconFlipRtl:"both",scale:this.thumbnailIconScale,textContent:"",title:this.messages?.viewAttachments,width:"full",onclick:n=>this._onShowAttachmentsClick({index:e,objectId:t,event:n})});return this._buttonElements.set(t,o),o}_createThumbnailAnchor({name:t,url:e},n){const o=document.createElement("a");return o.href=`${e}`,o.download=t,o.rel="noreferrer",o.target="_blank",o.appendChild(n),o}_createThumbnailElements(t,e){const{thumbnailAppearance:n,thumbnailCount:o,thumbnailIconScale:a}=this,r=[],s=Math.min(o,t.length),i=!this.onShowAttachments,l="image"===n&&!!this.store?.supportsResizeAttachments;for(let n=0;n<s;n++){const o=t[n],{name:s,contentType:h}=o,p=c.isSupportedImage(h)&&l?this._createThumbnailImage(o):this.createCalciteIcon({icon:c.getCalciteIconForAttachment(h),scale:a,textLabel:s}),m=i?this._createThumbnailAnchor(o,p):p;e&&e.appendChild(m),r.push(m)}return r}_createThumbnailImage(t){const{name:e,size:n,url:o}=t,a=document.createElement("img"),r=`${o}${o?.includes("?")?"&":"?"}${this._supportsResize?"w=24":""}&fs=${n}`;return a.alt=this.messages?.attachmentThumbnail??e,a.src=r,a.title=e,a}_onShowAttachmentsClick({index:t,objectId:e,event:n}){n.preventDefault(),n.stopPropagation(),this.onShowAttachments?.({index:t,objectId:e})}};return t.__decorate([o.property()],u.prototype,"_showAttachmentsViewEnabled",null),t.__decorate([o.property()],u.prototype,"_buttonElements",void 0),t.__decorate([o.property()],u.prototype,"_supportsResize",null),t.__decorate([o.property()],u.prototype,"_thumbnailElements",void 0),t.__decorate([o.property()],u.prototype,"attachmentsViewEnabled",void 0),t.__decorate([o.property()],u.prototype,"cellValueFormatFunction",void 0),t.__decorate([o.property()],u.prototype,"effectiveLabel",null),t.__decorate([o.property()],u.prototype,"icon",void 0),t.__decorate([o.property()],u.prototype,"layer",void 0),t.__decorate([o.property()],u.prototype,"onShowAttachments",void 0),t.__decorate([o.property({readOnly:!0})],u.prototype,"sortable",void 0),t.__decorate([o.property()],u.prototype,"store",void 0),t.__decorate([o.property()],u.prototype,"textAlign",void 0),t.__decorate([o.property()],u.prototype,"thumbnailAppearance",void 0),t.__decorate([o.property()],u.prototype,"thumbnailCount",void 0),t.__decorate([o.property()],u.prototype,"thumbnailIconScale",void 0),t.__decorate([o.property()],u.prototype,"thumbnailsEnabled",void 0),u=t.__decorate([i.subclass("esri.widgets.FeatureTable.AttachmentsColumn")],u),u});