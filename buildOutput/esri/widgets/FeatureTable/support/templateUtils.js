// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/arrayUtils","../../../support/popupUtils","../../../tables/AttributeTableTemplate","../../../tables/elements/AttributeTableAttachmentElement","../../../tables/elements/AttributeTableFieldElement","../../../tables/elements/AttributeTableGroupElement","../../../tables/elements/AttributeTableRelationshipElement","../../../tables/support/FieldOrder","./AttachmentsColumnTemplate","./columnUtils","./FieldColumnTemplate","./GroupColumnTemplate","./RelationshipColumnTemplate","./TableTemplate","./tableUtils"],function(e,t,i,l,n,r,a,s,o,d,u,p,c,m,f,h){"use strict";function b(e,i){const l=[];return e?.forEach(e=>{const{description:n,label:r,type:a}=e;if("group"===a){const a=e.elements.map(e=>T(e,i)).filter(t.isSome);if(!a?.length)return;l.push(new c({description:n,columnTemplates:a,label:r}))}else{const t=T(e,i);if(!t)return;l.push(t)}}),l}function T(e,t){const{description:i,label:l,type:n}=e;if("field"===n){const n=e.fieldName??void 0,r=t.findIndex(e=>e.field&&e.field===n),a=r>-1?t.at(r)?.order:void 0;return new p({description:i,direction:a,fieldName:n,initialSortPriority:r,label:l})}return"attachment"===n?new d({description:i,label:l}):"relationship"===n?new m({description:i,label:l,relationshipId:e.relationshipId}):void 0}function y(e){const i=[];return e.forEach(e=>{const{hidden:l}=e;if(u.isGroupColumn(e)){if(l)return;const n=e.columns?.map(e=>F(e)).filter(t.isSome);if(!n?.length)return;i.push(new a({elements:n}))}else{const t=F(e);if(!t)return;i.push(t)}}),i}function F(e){const{fieldName:t,hidden:i}=e;if(u.isFieldColumn(e)){if(!i)return new r({fieldName:t})}else if(u.isRelationshipColumn(e)){if(!i)return new s({relationshipId:e.relationshipId})}else if(u.isAttachmentsColumn(e)&&!i)return new n}e.createAttributeTableElements=y,e.createAttributeTableTemplateFromLayer=async function({layer:e,excludeAttachments:t,excludeRelationships:a,excludedFieldTypesOverride:o}){const d=[];if(!e||!h.isIFeatureTableSupportedLayer(e))return new l;await e.load();const u=i.createFieldInfos(e,{...o&&{ignoreFieldTypes:o},sortDisabled:!0});for(const{visible:e,fieldName:t}of u)e&&d.push(new r({fieldName:t}));return h.isIFeatureTableSupportedLayerWithAttachments(e)&&!0!==t&&d.push(new n),h.isIFeatureTableSupportedLayerWithRelationships(e)&&!0!==a&&e.relationships?.forEach(e=>{d.push(new s({relationshipId:e.id}))}),new l({elements:d,orderByFields:[]})},e.createColumnTemplates=b,e.createNestedAttributeTableElement=F,e.createNestedColumnTemplate=T,e.createTableTemplateFromAttributeTableTemplate=async function(e){const{layer:t,template:l,includeHiddenFields:n,excludedFieldTypesOverride:r}=e,a=l.orderByFields??[],s=b(l.elements,a);return n&&(await t.load(),i.createFieldInfos(t,{...r&&{ignoreFieldTypes:r},sortDisabled:!0}).forEach(e=>{if(!e.fieldName)return;const{fieldName:t,label:i}=e;if(!h.hasTemplateForField(t,s)){const e=a.findIndex(e=>e.field&&e.field===t),l=e>-1?a.at(e)?.order:void 0;s.push(new p({direction:l,fieldName:t,initialSortPriority:e,label:i,visible:!1}))}}),h.isIFeatureTableSupportedLayerWithAttachments(t)&&!s.some(e=>"attachment"===e.type)&&s.push(new d({visible:!1})),h.isIFeatureTableSupportedLayerWithRelationships(t)&&t.relationships?.forEach(({id:e})=>{s.some(t=>"relationship"===t.type&&t.relationshipId===e)||s.push(new m({relationshipId:e,visible:!1}))})),new f({columnTemplates:s})},e.createTableTemplateFromLayer=async function(e){const{excludeAttachments:t,excludeRelationships:l,layer:n,excludedFieldTypesOverride:r}=e,a=[];return await n.load(),i.createFieldInfos(n,{...r&&{ignoreFieldTypes:r},sortDisabled:!0}).forEach(({fieldName:e,format:t,label:i,visible:l})=>{null!=e&&a.push(new p({fieldName:e,format:t,label:i,visible:l}))}),h.isIFeatureTableSupportedLayerWithAttachments(n)&&!0!==t&&a.push(new d),h.isIFeatureTableSupportedLayerWithRelationships(n)&&!0!==l&&n.relationships?.forEach(({id:e})=>{a.push(new m({relationshipId:e}))}),new f({columnTemplates:a})},e.syncAttributeTableTemplateWithTable=function(e,t,i=!0){const{allColumns:l,columns:n}=e,r=[],a=y(n.toArray());return e.activeSortOrders.forEach(({fieldName:e,direction:t})=>{e&&t&&r.push(new o({field:e,order:t}))}),l.filter(e=>null!=e.direction&&(!e.hidden||i)).forEach(({fieldName:e,direction:t})=>{const i=r.find(t=>t.field===e);t&&!i&&r.push(new o({field:e,order:t}))}),t.elements=a,t.orderByFields=r,t},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});