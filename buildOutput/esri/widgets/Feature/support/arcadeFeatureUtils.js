// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../chunks/tslib.es6","../../../arcade/featureset/support/shared","../../../core/Logger","../../../core/sql","../../../layers/FeatureLayer","../../../layers/support/streamLayerUtils","../../../support/guards","./featureUtils"],function(e,r,t,a,n,i,s,o,c,u){"use strict";const l=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),d=()=>n.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");function p(e){return{scale:e?.scale,timeProperties:{currentStart:e?.timeExtent?.start,currentEnd:e?.timeExtent?.end,startIncluded:!0,endIncluded:!0}}}function y(e){return{$voxel:e}}function f(e){if(c.isDate(e))return e.getTime();if("number"==typeof e)return e;if("string"==typeof e)return new Date(e).getTime();throw new Error(`Unexpected time value: ${e}`)}async function w(e,r,t){const a=r.sourceLayer||r.layer;if(null==a||!("timeInfo"in a))return null;const n=a.timeInfo?.trackIdField;if(null==n)return null;const s=r.getAttribute(n);if(null==s)return null;let c,u;if("string"==typeof s)c=`"${n.replaceAll('"','""')}" = '${s.replaceAll("'","''")}'`;else{if("number"!=typeof s)return d().warn("Expected track id to be a string or number"),null;c=`"${n.replaceAll('"','""')}" = ${s}`}if("stream"===a.type&&null!=t){const e=await t.whenLayerView(a),r=e.createQuery();r.returnGeometry=!0,r.where=i.sqlAnd(r.where,c),u=(await e.queryFeatures(r)).features}else{if(!("queryFeatures"in a))return null;{const e=a.createQuery();e.returnGeometry=!0,e.where=i.sqlAnd(e.where,c),u=(await a.queryFeatures(e)).features}}const l=a.fieldsIndex.normalizeFieldName(a.timeInfo.startField)??o.internalTimeReceivedField,p=a.timeInfo.endField?a.fieldsIndex.normalizeFieldName(a.timeInfo.endField):null,y=u.map(r=>{const a=r.getObjectId();if(null==a)throw new Error("Cannot identify observation");const n=e.ArcadeFeature.createFromGraphic(r,t?.timeZone),i=f(r.getAttribute(l));return{id:a,feature:n,startTime:i,endTime:null!=p?f(r.getAttribute(p)):i,stats:{totalDistance:void 0,distance:void 0,speed:void 0,acceleration:void 0}}}).sort((e,r)=>e.startTime-r.startTime),w="esri.TrackGraphic"===r.declaredClass?y.length-1:y.findIndex(e=>r.getObjectId()===e.id);if(w<0)throw new Error("Couldn't locate feature in observations");return{observations:y,currentObservationIndex:w}}async function g(e,r,t,n,i,s){const o=(r.sourceLayer||r.layer)??void 0;return{vars:{$feature:r,$layer:null!=o&&a.isSupportedLayer(o)?o:"scene"===o?.type&&null!=o.associatedLayer?o.associatedLayer:void 0,$map:t,$datastore:o&&"url"in o?o.url:void 0,$userInput:n,$graph:"knowledge-graph-sublayer"===o?.type?o.parentCompositeLayer?.knowledgeGraph:void 0,$view:p(i)},track:s?await w(e,r,i):null}}async function m(){const[r,t,{default:a}]=await Promise.all([new Promise((r,t)=>e(["../../../arcade"],r,t)),new Promise((r,t)=>e(["../../../arcade/arcade"],r,t)),new Promise((r,t)=>e(["../../../arcade/Feature"],e=>r(l(e)),t))]);return{executor:r,syntaxUtils:t,ArcadeFeature:a}}async function v(e,r,a){const{executor:{createArcadeProfile:n,createArcadeExecutor:i},syntaxUtils:o}=a,c=function(e){const r="esri.views.3d.layers.VoxelGraphic"===e.declaredClass;return e.isAggregate?"popup-feature-reduction":r?"popup-voxel":"popup"}(r),u=n(c);let l;try{l=await i(e,u)}catch(r){return d().error("arcade-executor-error",{error:r,expression:e}),null}const f=new Set;l.variablesUsed.includes("$view")&&(o.scriptUsesViewProperties(l.syntaxTree,["scale"])&&f.add("view-scale"),o.scriptUsesViewProperties(l.syntaxTree,["timeProperties"])&&f.add("view-time-extent"));const m=o.scriptUsesTrack(l.syntaxTree);return{dependencies:f,async evaluate({graphic:r,interceptor:n,location:i,map:o,options:u,spatialReference:f,view:v}){const x={stack:[],error:void 0,hasError:!1};try{const h=t.__addDisposableResource(x,await async function(e,{arcade:r,graphic:t,map:a,location:n,view:i,options:o,interceptor:c,arcadeExecutor:u,usesTrack:l}){switch(e){case"popup":return{...await g(r,t,a,n,i,l),[Symbol.dispose](){}};case"popup-feature-reduction":{const e=new Set(u.variablesUsed);return await async function(e,r,t,a,n,i,o){let c=null;if(i.has("$aggregatedfeatures")){const e=await async function({graphic:e,view:r,options:t}){const{isAggregate:a}=e,n=e.layer??e.sourceLayer;if(!a||!n||"2d"!==r?.type)return[];const i=await r.whenLayerView(n);if(!function(e){return"createQuery"in e&&"queryFeatures"in e}(i))return[];const s=i.createQuery(),o=e.getObjectId();s.aggregateIds=null!=o?[o]:[];const{features:c}=await i.queryFeatures(s,t);return c}({graphic:r,view:t,options:a}),i=r.sourceLayer||r.layer;c=function({layer:e,aggregatedFeatures:r,interceptor:t}){const{fields:a,objectIdField:n,geometryType:i,spatialReference:o}=e,c="displayField"in e?e.displayField:void 0;return new s({fields:a,objectIdField:n,geometryType:i,spatialReference:o,displayField:c,interceptor:t,..."feature"===e.type?{templates:e.templates,typeIdField:e.typeIdField,types:e.types}:null,source:r})}({layer:i,aggregatedFeatures:e,interceptor:n})}return{vars:{$feature:r,$aggregatedFeatures:c,$view:p(t)},track:o?await w(e,r,t):null,[Symbol.dispose]:()=>c?.[Symbol.dispose]()}}(r,t,i,o,c,e,l)}case"popup-voxel":return{vars:y(t),track:null,[Symbol.dispose](){}};default:throw new Error(`Unexpected profile name ${e}`)}}(c,{arcade:a,graphic:r,map:o,location:i,view:v,options:u,interceptor:n,arcadeExecutor:l,usesTrack:m}),!1),b={abortSignal:u?.signal??void 0,interceptor:n??void 0,rawOutput:!0,spatialReference:f??void 0,timeZone:v?.timeZone,track:h.track,console(...e){d().info(...e)}};try{return await l.executeAsync(h.vars,b)}catch(t){if(u?.signal?.aborted)return;return void d().error("arcade-execution-error",{error:t,graphic:r,expression:e})}}catch(e){x.error=e,x.hasError=!0}finally{t.__disposeResources(x)}}}}r.compileExpression=async function({expression:e,graphic:r}){return e?v(e,r,await m()):null},r.compileExpressionInfos=async function(e,r){if(!e?.length)return{dependencies:new Set,expressions:new Map};const t=await m(),a=new Set,n=new Map;for(const i of e){const e=await v(i.expression,r,t);n.set(`expression/${i.name}`,e),e?.dependencies.forEach(e=>a.add(e))}return{dependencies:a,expressions:n}},r.formatArcadeValue=function(e){return u.applyTextFormattingHTML(u.htmlEntities(e))},Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});