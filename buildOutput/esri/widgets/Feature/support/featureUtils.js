// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/has","../../../core/Logger","../../../core/string","../../../intl/date","../../../intl/number","../../../layers/support/fieldUtils","../../../layers/support/layerUtils","../../../smartMapping/support/utils","../../../support/loadArcade","../../../time/timeZoneUtils"],function(e,t,r,n,i,a,o,l,u,s,f){"use strict";const c=()=>r.getLogger("esri.widgets.Feature.support.featureUtils"),d=/href=(""|'')/gi,p=/(\{([^{\r\n]+)\})/g,y=/'/g,m=/^\s*expression\//i,b=/(\n)/gi,g=/[\u00A0-\u9999<>&]/gim,I=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,h=/^(?:mailto:|tel:)/,F="relationships/",T=i.convertDateFormatToIntlOptions("short-date-short-time");function w(e){return!!e&&m.test(e)}function N(e,t){const r=L(t,e);return r?r.name:e}function L(e,t){return e&&"function"==typeof e.getField&&t?e.getField(t)??null:null}function A(e){return`${e}`.trim()}function v({formattedAttributes:e,template:t,fieldInfoMap:r}){return A((i=n.replace(n.replace(t,e=>function(e,t){const r=t.get(e.toLowerCase());return`{${r?.fieldName||e}}`}(e,r)),e),i.replaceAll(d,"")));var i}function x(e,t){return e.replaceAll(p,(e,r,n)=>{const i=L(t,n);return i?`{${i.name}}`:r})}function Z(e,t,r){const i=x(e,r);return i?i.replaceAll(I,(e,r,i)=>function(e,t,r){const i=(t=A(t))&&!t.startsWith("{");return n.replace(e,function(e,t=!1){const r={...e};return Object.keys(r).forEach(e=>function(e,t,r=!1){const n=t[e];if("string"==typeof n){const i="%27",a=(r?encodeURIComponent(n):n).replaceAll(y,i);t[e]=a}}(e,r,t)),r}(r,i||!1))}(e,r||i,t)):i}function q(e){return null!=e&&"object"==typeof e&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&("feature"===e.type||"scene"===e.type||"subtype-group"===e.type||"subtype-sublayer"===e.type||"sublayer"===e.type)&&"when"in e}function E(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function k(e){return q(e)&&E(e)}function C(e,t){const{fieldInfos:r,fieldName:n,preventPlacesFormatting:i,layer:l,timeZone:s}=t,f=U(r,n),c=L(l,n);if(f&&!o.isRasterPixelValueField(n)){const t=c?.type,r=f.format?.dateFormat;if("date"===t||"date-only"===t||"time-only"===t||"timestamp-offset"===t||r)return u.formatAnyDate(e,{format:r,fieldType:t,timeZoneOptions:{layerTimeZone:l&&"preferredTimeZone"in l?l.preferredTimeZone:null,viewTimeZone:s,datesInUnknownTimezone:!(!l||!("datesInUnknownTimezone"in l)||!l.datesInUnknownTimezone)}})}const d=f?.format;return"string"==typeof e&&o.isRasterPixelValueField(n)&&d?function(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?R(e,",",", ",t):e.includes(";")?R(e,";","; ",t):e.includes(" ")?R(e," "," ",t):a.formatNumber(Number(e),a.convertNumberFormatToIntlOptions(t))}(e,d):(e=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}(e,d),"string"==typeof e||null==e||null==d?M(e):i?a.formatNumber(e,{...a.convertNumberFormatToIntlOptions(d),minimumFractionDigits:0,maximumFractionDigits:20}):a.formatNumber(e,a.convertNumberFormatToIntlOptions(d)))}function R(e,t,r,n){return e.trim().split(t).map(e=>a.formatNumber(Number(e),a.convertNumberFormatToIntlOptions(n))).join(r)}function U(e,t){if(e?.length&&t)return e.find(e=>e.fieldName?.toLowerCase()===t.toLowerCase())}function M(e){return"string"==typeof e?e.replaceAll(b,'<br class="esri-text-new-line" />'):e}function j(e){const{value:r,fieldName:n,fieldInfos:i,fieldInfoMap:a,layer:l,graphic:s,timeZone:f}=e;if(null==r)return"";const c=function({fieldName:e,value:r,graphic:n,layer:i}){if(O(e))return null;if(!i||"function"!=typeof i.getFieldDomain)return null;const a=n&&i.getFieldDomain(e,{feature:n,excludeImpliedDomains:t("esri-widget-legacy-field-domain-calculation")});return a&&"coded-value"===a.type?a.getName(r):null}({fieldName:n,value:r,graphic:s,layer:l});if(c)return c;const d=function({fieldName:e,graphic:t,layer:r}){if(O(e))return null;if(!r||"function"!=typeof r.getFeatureType)return null;const{typeIdField:n}=r;if(!n||e!==n)return null;const i=r.getFeatureType(t);return i?i.name:null}({fieldName:n,graphic:s,layer:l});if(d)return d;if(a.get(n.toLowerCase()))return C(r,{fieldInfos:i||Array.from(a.values()),fieldName:n,layer:l,timeZone:f});const p=l?.fieldsIndex?.get(n);return p&&(u.isAnyDateField(p)||o.isTimeOnlyField(p))?u.formatAnyDate(r,{fieldType:p.type,timeZoneOptions:{layerTimeZone:l&&"preferredTimeZone"in l?l.preferredTimeZone:null,viewTimeZone:f,datesInUnknownTimezone:!(!l||!("datesInUnknownTimezone"in l)||!l.datesInUnknownTimezone)}}):M(r)}async function D(e,t){const{layer:r,graphic:n,outFields:i,objectIds:a,returnGeometry:o,spatialReference:u}=e,s=a[0];if("number"!=typeof s&&"string"!=typeof s){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:r,graphic:n,objectId:s,requiredFields:i};return c().warn(e,t),null}if(!l.getEffectiveLayerCapabilities(r)?.operations?.supportsQuery){const e="The specified layer cannot be queried. The following fields will not be available.",t={layer:r,graphic:n,requiredFields:i,returnGeometry:o};return c().warn(e,t),null}const f=r.createQuery();return f.objectIds=a,f.outFields=i?.length?i:[r.objectIdField],f.returnGeometry=!!o,f.returnZ=!!o,f.returnM=!!o,f.outSpatialReference=u,(await r.queryFeatures(f,t)).features[0]}function O(e=""){return!!e&&e.includes(F)}function S({attributes:e,graphic:t,relatedInfo:r,fieldInfos:n,fieldInfoMap:i,layer:a,timeZone:o}){e&&t&&r&&Object.keys(t.attributes).forEach(l=>{const u=(s={layerId:r.relation.id.toString(),fieldName:l})?`${F}${s.layerId}/${s.fieldName}`:"";var s;const f=t.attributes[l];e[u]=j({fieldName:u,fieldInfos:n,fieldInfoMap:i,layer:a,value:f,graphic:t,timeZone:o})})}const $=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},z=({layer:e,method:t,query:r,definitionExpression:n})=>{if(!e.capabilities?.query?.supportsCacheHint||"attachments"===t)return;const i=null!=r.where?r.where:null,a=null!=r.geometry?r.geometry:null;$(n)||$(i)||"extent"===a?.type||"tile"===r.resultType||(r.cacheHint=!0)};function G(e,t){return e?.allTables.find(e=>"feature"===e.type&&e.layerId===t.id&&e.url===t.layer?.url)}function P({map:e,relationship:t,relationship:{relatedTableId:r},relatedLayer:n,layers:i}){if(!i)return null;for(const a of i){if("map-image"===a.type){const r=P({layers:a.sublayers,map:e,relatedLayer:n,relationship:t})||P({layers:a.subtables,map:e,relatedLayer:n,relationship:t});if(r)return r;continue}if(!k(a))continue;if("sublayer"===n.type){if(a!==n&&a.id===r)return a.isTable?G(e,a):a;continue}const i="scene"===n.type&&n.associatedLayer?n.associatedLayer.url:n.url;if(!i)return null;if("sublayer"!==a.type){if(a!==n&&a.url===i&&a.layerId===r)return a}else if(a!==n&&a.layer?.url===i&&a.id===r)return a.isTable?G(e,a):a}return null}e.applyTextFormattingHTML=M,e.createFieldInfoMap=function(e,t){const r=new Map;if(!e)return r;for(const n of e){if(!n.fieldName)continue;const e=N(n.fieldName,t);n.fieldName=e,r.set(e.toLowerCase(),n)}return r},e.findRelatedLayer=function(e,t,r){return e&&t&&r?"sublayer"===t.type?P({layers:t.layer?.allSublayers,map:e,relatedLayer:t,relationship:r})||P({layers:t.layer?.subtables,map:e,relatedLayer:t,relationship:r}):P({layers:e.allLayers,map:e,relatedLayer:t,relationship:r})||P({layers:e.allTables,map:e,relatedLayer:t,relationship:r}):null},e.findUtilityNetwork=function(e,t){return e&&"utilityNetworks"in e&&t?e.utilityNetworks?.find(e=>e.isUtilityLayer(t)):null},e.fixTokens=x,e.formatAttributes=function({fieldInfos:e,attributes:t,layer:r,graphic:n,fieldInfoMap:i,relatedInfos:a,timeZone:o}){const l={};return a?.forEach(t=>function({attributes:e,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:i,timeZone:a}){e&&t&&(t.relatedFeatures?.forEach(o=>S({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:i,timeZone:a})),t.relatedStatsFeatures?.forEach(o=>S({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:i,timeZone:a})))}({attributes:l,relatedInfo:t,fieldInfoMap:i,fieldInfos:e,layer:r,timeZone:o})),t&&Object.keys(t).forEach(a=>{const u=t[a];l[a]=j({fieldName:a,fieldInfos:e,fieldInfoMap:i,layer:r,value:u,graphic:n,timeZone:o})}),l},e.formatEditInfo=function(e,t,r,n){const{creatorField:a,creationDateField:o,editorField:l,editDateField:u}=e;if(!t)return;const s=f.getTimeZoneFormattingOptions(n&&"preferredTimeZone"in n?n.preferredTimeZone:null,!(!n||!("datesInUnknownTimezone"in n)||!n.datesInUnknownTimezone),r,T,"date"),c={...T,...s},d=t[u];if("number"==typeof d){const e=t[l];return{type:"edit",date:i.formatDate(d,c),user:e}}const p=t[o];if("number"==typeof p){const e=t[a];return{type:"create",date:i.formatDate(p,c),user:e}}return null},e.formatValueToFieldInfo=C,e.getAllFieldInfos=function(e){const t=[];if(!e)return t;const{fieldInfos:r,content:n}=e;return r&&t.push(...r),n&&Array.isArray(n)?(n.forEach(e=>{if("fields"===e.type){const r=e?.fieldInfos;r&&t.push(...r)}}),t):t},e.getFieldInfo=U,e.getFieldInfoLabel=function(e,t){const r=function(e,t){if(!t||!w(t)||!e)return;const r=t.replace(m,"").toLowerCase();return e.find(({name:e})=>e.toLowerCase()===r)}(t,e?.fieldName);return r?r.title||null:e?e.label||e.fieldName:null},e.getFixedFieldName=N,e.getFixedFieldNames=function(e,t){return e&&e.map(e=>N(e,t))},e.getSourceLayer=function(e){if(null!=e)return(e.sourceLayer||e.layer)??void 0},e.graphicCallback=async function({type:e,value:t,event:r}){try{return"function"==typeof t?t(r):await t}catch(n){return void c().error("error",`An error occurred when calling the "${e}" function`,{error:n,graphic:r.graphic,value:t})}},e.htmlEntities=function(e){return e.replaceAll(g,e=>`&#${e.charCodeAt(0)};`)},e.isAssociatedFeatureSupportedLayer=function(e){return!(!(e&&"object"==typeof e&&"createQuery"in e&&"getField"in e&&"queryFeatureCount"in e&&"queryFeatures"in e&&"queryObjectIds"in e&&"capabilities"in e&&"fields"in e&&"fieldsIndex"in e&&"type"in e)||"feature"!==e.type&&"subtype-group"!==e.type&&"subtype-sublayer"!==e.type&&"sublayer"!==e.type||!("when"in e))&&("subtype-sublayer"===e.type&&"parent"in e&&e.parent&&"object"==typeof e.parent?"globalIdField"in e.parent:"globalIdField"in e)},e.isExpressionField=w,e.isFeatureSupportedLayer=q,e.isGraphicForRelatableFeatureSupportedLayer=function(e){return!!e&&"object"==typeof e&&"sourceLayer"in e&&k(e.sourceLayer)},e.isRelatableFeatureSupportedLayer=k,e.isRelatableLayer=E,e.isRelatedField=O,e.preLayerQueryCallback=({query:e,layer:t,method:r})=>{z({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},e.preRequestCallback=({queryPayload:e,layer:t,method:r})=>{z({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},e.querySourceLayer=D,e.queryUpdatedFeature=async function({graphic:e,popupTemplate:t,layer:r,spatialReference:n},i){if(!r||!t)return;if("function"==typeof r.load&&await r.load(i),!e.attributes)return;const a=r.objectIdField,l=e.attributes[a];if(null==l)return;const u=[l],f=new Set(await t.getRequiredFields(r.fieldsIndex));null==r.timeInfo?.trackIdField||f.has(r.timeInfo.trackIdField)||await async function(e){if(!e.expressionInfos?.length)return!1;const t=await s.loadArcade(),{arcadeUtils:{requiresTrack:r}}=t;return r(e)}(t)&&f.add(r.timeInfo.trackIdField);const c=o.featureHasFields(e,f),d=c?[]:f.has(a)?[...f]:[...f,a],p=t.returnGeometry||await async function(e){if(!e.expressionInfos?.length)return!1;const t=await s.loadArcade(),{arcadeUtils:{hasGeometryFunctions:r}}=t;return r(e)}(t);if(c&&!p)return;const y=await D({layer:r,graphic:e,outFields:d,objectIds:u,returnGeometry:p,spatialReference:n},i);y&&(y.geometry&&(e.geometry=y.geometry),y.attributes&&(e.attributes={...e.attributes,...y.attributes}))},e.shouldOpenInNewTab=function(e=""){if(e)return!h.test(e.trim().toLowerCase())},e.substituteAttributes=v,e.substituteFieldsInLinksAndAttributes=function({attributes:e,globalAttributes:t,layer:r,text:n,expressionAttributes:i,fieldInfoMap:a}){return n?v({formattedAttributes:t,template:Z(n,{...t,...i,...e},r),fieldInfoMap:a}):""},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});