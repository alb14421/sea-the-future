// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../request","../../../core/arrayUtils","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../layers/support/fieldUtils","../../../rest/query/executeQueryJSON","../../../rest/support/Query","../../../rest/support/RelationshipQuery","../../../rest/support/StatisticDefinition","./featureUtils"],function(e,t,r,i,n,s,o,a,l,u,c,d){"use strict";const f=()=>n.getLogger("esri.widgets.Feature.support.relatedFeatureUtils"),p=new Map;function y({originRelationship:e,relationships:t,layerId:r}){return t.find(({relatedTableId:t,id:i})=>`${t}`===r&&i===e?.id)??null}function h(e){return e?r.unique(e):void 0}function F(e){return e?r.unique(e,(e,t)=>JSON.stringify(e.toJSON())===JSON.stringify(t.toJSON())):void 0}e.createRelatedInfo=function(e,t){const r=function(e,t){if(!t.relationships)return null;let r=null;const{relationships:i}=t;return i.some(t=>t.id===parseInt(e,10)&&(r=t,!0)),r}(e,t);if(r)return{url:`${t.url}/${r.relatedTableId}`,sourceSpatialReference:t.spatialReference,relation:r,relatedFields:[],outStatistics:[]}},e.getDestinationRelation=y,e.getRelatedFieldInfo=function(e){if(!d.isRelatedField(e))return null;const[t,r]=e.split("/").slice(1);return{layerId:t,fieldName:r}},e.getUniqueOutFields=h,e.getUniqueOutStatistics=F,e.queryLayerInfos=function({relatedInfos:e,layer:r},n){const o={};return e.forEach((e,n)=>{const{relation:s}=e;if(!s){const e=new i("editor:relation-required","A relation is required on a layer to retrieve related records.");throw f().error(e),e}const{relatedTableId:a}=s;if("number"!=typeof a){const e=new i("editor:related-table","A related table ID is required on a layer to retrieve related records.");throw f().error(e),e}const l=`${r.url}/${a}`,u=p.get(l),c=u??function(e){return t(e,{query:{f:"json"},signal:void 0})}(l);u||p.set(l,c),o[n]=c}),s.whenOrAbort(s.eachAlways(o),n)},e.queryRelatedFeatures=function({graphic:e,relatedInfos:t,layer:r},i){const n={};return t.forEach((t,c)=>{t.layerInfo&&(n[c]=async function(e,t,r,i){const n=r.layerId.toString(),{layerInfo:c,relation:d,relatedFields:f,outStatistics:p,url:I,sourceSpatialReference:S}=t,g=h(f),b=F(p);if(!c||!d)return null;const w=y({originRelationship:d,relationships:c.relationships,layerId:n});if(w?.relationshipTableId&&w.keyFieldInRelationshipTable){const t=await function(e,t,r,i){const n=new u;return n.outFields=["*"],n.relationshipId="number"==typeof t.id?t.id:parseInt(t.id,10),n.objectIds=[e.attributes[r.objectIdField]],n.gdbVersion=r.gdbVersion??null,n.historicMoment=r.historicMoment??null,r.queryRelatedFeatures?.(n,i)??Promise.resolve({})}(e,w,r,i),n=t[e.attributes[r.objectIdField]];if(!n)return null;const o=n.features.map(e=>e.attributes[c.objectIdField]);if(b?.length&&c.supportsStatistics){const e=new l;e.where=function(e,t){let r=0;const i=[];for(;r<t.length;)i.push(`${e} IN (${t.slice(r,1e3+r)})`),r+=1e3;return i.join(" OR ")}(c.objectIdField,o),e.outFields=g,e.outStatistics=b,e.sourceSpatialReference=S;const t={features:Promise.resolve(n),statsFeatures:a.executeQueryJSON(I,e)};return s.eachAlways(t)}}const R=w?.keyField;if(R){const t=o.isNumericField(function(e,t){if(null!=e){t=t.toLowerCase();for(const r of e)if(r&&r.name.toLowerCase()===t)return r}return null}(c.fields,R)),n=function(e,t){const r=t.toLowerCase();for(const t in e)if(t.toLowerCase()===r)return e[t];return null}(e.attributes,d.keyField),u=t?`${R}=${n}`:`${R}='${n}'`,f=r.historicMoment,p=r.gdbVersion,y=a.executeQueryJSON(I,new l({where:u,outFields:g,sourceSpatialReference:S,historicMoment:f,gdbVersion:p}),i),h=b?.length&&c.supportsStatistics?a.executeQueryJSON(I,new l({where:u,outFields:g,outStatistics:b,sourceSpatialReference:S}),i):null,F={features:y};return h&&(F.statsFeatures=h),s.eachAlways(F)}return null}(e,t,r,i))}),s.eachAlways(n)},e.setRelatedFeatures=function(e,t){if(!t)return;if(!e)return;const{features:r,statsFeatures:i}=e,n=r?.value;t.relatedFeatures=n?n.features:[];const s=i?.value;t.relatedStatsFeatures=s?s.features:[]},e.updateRelatedInfo=function({relatedInfo:e,fieldName:t,fieldInfo:r}){if(e.relatedFields?.push(t),r.statisticType){const i=new c({statisticType:r.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics?.push(i)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});