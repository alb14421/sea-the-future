// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../chunks/tslib.es6","../../intl","../../core/string","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./FeatureUtilityNetworkAssociations/VisibleElements","../../chunks/componentsUtils","../support/globalCss","../support/widgetUtils","../support/jsxFactory","../support/UtilityNetworkAssociations/FeatureUtilityNetworkAssociationsViewModel","../support/UtilityNetworkAssociations/UtilityNetworkAssociationList","../support/UtilityNetworkAssociations/utils/formatPercentAlong","../support/UtilityNetworkAssociations/utils/isConnectivity","../support/UtilityNetworkAssociations/utils/isConnectivityMidspan","../../intl/substitute"],function(e,t,i,s,o,l,r,n,a,c,d,u,p,h,w,y,m,f,_,b){"use strict";const g=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));var v;const M="esri-feature-utility-network-associations",A={base:M,listItemHidden:`${M}__list-item--hidden`};let F=v=class extends y{constructor(e,t){super(e,t),this.description=null,this.flowItems=null,this.flowType="feature-utility-network-association-type",this.listType=null,this.parentFeatureViewModel=null,this.title=null,this.viewModel=new w,this.visibleElements=new c}initialize(){this.setUpObserver()}loadDependencies(){return d.loadCalciteComponents({chip:()=>new Promise((t,i)=>e(["../../chunks/index11"],t,i)),icon:()=>new Promise((t,i)=>e(["../../chunks/index7"],t,i)),list:()=>new Promise((t,i)=>e(["../../chunks/index16"],t,i)),"list-item":()=>new Promise((t,i)=>e(["../../chunks/index20"],t,i)),tooltip:()=>new Promise((t,i)=>e(["../../chunks/index17"],t,i))})}destroy(){this.tooltipReferenceMap.clear()}render(){const e=this.viewModel.associationViewModels,{state:t,showAllEnabled:i}=this.viewModel,{state:s}=this.parentFeatureViewModel??{};return h.tsx("div",{class:this.classes(A.base,u.globalCss.widget)},"loading"===t||"querying"===t||"loading"===s?this.renderLoading():h.tsx("calcite-list",{displayMode:"nested",label:this.selectedLayer?.title??this.messagesCommon.untitled},i&&this.selectedLayer?h.tsx(h.tsxFragment,null,this.renderFilter(),this.renderFeatureCountWarning(),this._renderAssociatedFeatureListPage(),this.renderFeatureObserver()):Array.from(e.keys(),t=>this._renderTypeList(t,e.get(t)))))}_showAllAssociations(e){const{flowItems:t,viewModel:i,description:s}=this;if(!t||!e)return;i.showAllEnabled=!0;const o=new v({selectedLayer:e,title:e?.title,flowItems:t,parentFeatureViewModel:this.parentFeatureViewModel,featureVisibleElements:this.featureVisibleElements,description:s,visibleElements:new c({title:!1,description:!1}),viewModel:i});t.push(o)}_renderAssociatedFeatureListPage(){const e=this.viewModel.associationViewModels.get(this.selectedLayer).filter(e=>e.title.toLowerCase().includes(this.filterText)).slice(0,this.endIndex);return[...this._renderTooltips(e),...this._renderAssociatedFeatureList(e)]}_renderItemTooltip(e){const{tooltipReferenceMap:t}=this;return f.isConnectivity(e.association)?h.tsx("calcite-tooltip",{key:`tooltip-${e.featureViewModel.uid}`,overlayPositioning:"fixed",referenceElement:t.get(e.featureViewModel.uid)},this.getConnectivityTooltip(e.association.associationType)):null}_renderAssociatedFeature(e){const{featureViewModel:t,title:i}=e,o="loading"===t.state,l=this._findFlowItem(t),r=l<0&&this._isParentFeature(t),n=r||l>=0;return h.tsx("calcite-list-item",{class:o?A.listItemHidden:void 0,description:s.stripHTML(e.terminalName??""),key:`associated-feature-type-${t.uid}`,label:s.stripHTML(i),onCalciteListItemSelect:()=>this._handleFeatureClick(r,l,t)},f.isConnectivity(e.association)?this.renderConnectivityIcon(e.association.associationType,e.featureViewModel.uid):null,_.isConnectivityMidspan(e.association)?h.tsx("calcite-chip",{label:m.formatPercentAlong(e.association),scale:"s",slot:"content-end"},m.formatPercentAlong(e.association)):null,this._renderChevronIconNode(n))}async _selectAssociation(t){const{flowItems:i,featureVisibleElements:s}=this;if(!i)return;t.abilities={utilityNetworkAssociationsContent:!0};const{default:o}=await new Promise((t,i)=>e(["../Feature"],e=>t(g(e)),i));i.push(new o({flowItems:i,flowType:"feature-association",viewModel:t,visibleElements:s}))}_handleFeatureClick(e,t,i){if(e)this.flowItems.drain(e=>{"showAllEnabled"in e.viewModel&&(e.viewModel.showAllEnabled=!1),e.viewModel=null,e.destroy()});else if(t<0||!this.flowItems)this._selectAssociation(i);else for(;this.flowItems.length>t+1;){const e=this.flowItems.pop();e&&("showAllEnabled"in e.viewModel&&(e.viewModel.showAllEnabled=!1),e.viewModel=null,e.destroy())}}_featureViewModelMatch(e,t){const i=e.graphic,s=i?.layer;let o=null;"subtype-sublayer"===s?.type&&s.parent?o=s.parent.globalIdField??null:s&&"globalIdField"in s&&(o=s.globalIdField);const l=o?i?.attributes[o]:null,r=t.graphic,n=r?.layer;let a=null;"subtype-sublayer"===n?.type&&n.parent?a=n.parent.globalIdField??null:n&&"globalIdField"in n&&(a=n.globalIdField);const c=a?r?.attributes[a]:null;return l&&c&&l===c}_isParentFeature(e){const t=this.flowItems?.getItemAt(0);if(!t)return!1;const i=t.parentFeatureViewModel;return this._featureViewModelMatch(i,e)}_findFlowItem(e){return this.flowItems?.findIndex(t=>{if("feature-association"!==t.flowType)return!1;const i=t.viewModel;return this._featureViewModelMatch(i,e)})??-1}_renderTooltips(e){return e.toArray().map(e=>this._renderItemTooltip(e))}_renderAssociatedFeatureList(e){return e.toArray().map(e=>this._renderAssociatedFeature(e))}_renderChevronIconNode(e){const t=e?"move-up":"chevron-right";return h.tsx("calcite-icon",{flipRtl:!0,icon:t,scale:"s",slot:"content-end"})}_renderTypeList(e,t){const{messagesFeature:i}=this,{displayCount:s}=this.viewModel,o=t.slice(0,s),l=o.length<t.length;return h.tsx("calcite-list-item",{expanded:!0,key:"show-all",label:e.title,value:e.id},h.tsx("calcite-chip",{label:String(t.length),scale:"s",slot:"content-end"},t.length),h.tsx("calcite-list",{group:e.id,label:e.title??""},[this._renderTooltips(o),this._renderAssociatedFeatureList(o)],l?h.tsx("calcite-list-item",{description:b.substitute(i?.numberRecords,{number:t.length.toString()}),key:"show-all-item",label:i.showAll,onCalciteListItemSelect:()=>this._showAllAssociations(e)},h.tsx("calcite-icon",{icon:"list",scale:"s",slot:"content-end"})):null))}};return t.__decorate([o.property()],F.prototype,"description",void 0),t.__decorate([o.property()],F.prototype,"featureVisibleElements",void 0),t.__decorate([o.property()],F.prototype,"flowItems",void 0),t.__decorate([o.property()],F.prototype,"flowType",void 0),t.__decorate([o.property()],F.prototype,"listType",void 0),t.__decorate([o.property()],F.prototype,"parentFeatureViewModel",void 0),t.__decorate([o.property()],F.prototype,"title",void 0),t.__decorate([o.property({type:w})],F.prototype,"viewModel",void 0),t.__decorate([o.property({type:c,nonNullable:!0})],F.prototype,"visibleElements",void 0),F=v=t.__decorate([a.subclass("esri.widgets.Feature.FeatureUtilityNetworkAssociationList")],F),F});