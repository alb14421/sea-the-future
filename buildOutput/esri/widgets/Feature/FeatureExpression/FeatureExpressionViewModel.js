// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../Graphic","../../../core/Accessor","../../../core/asyncUtils","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/throttle","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/Point","../../../popup/content/AttachmentsContent","../../../popup/content/Content","../../../popup/content/CustomContent","../../../popup/content/ExpressionContent","../../../popup/content/FieldsContent","../../../popup/content/MediaContent","../../../popup/content/RelationshipContent","../../../popup/content/TextContent","../../../popup/content/UtilityNetworkAssociationsContent","../../../popup/ElementExpressionInfo","../FeatureContent/FeatureContentViewModel","../FeatureFields/FeatureFieldsViewModel","../FeatureMedia/FeatureMediaViewModel","../support/arcadeFeatureUtils"],function(e,t,o,a,i,s,n,r,l,p,c,d,h,u,_,m,y,f,v,w,T,k,x,E,g,M,b,C,F){"use strict";return e.default=class extends a{constructor(e){super(e),this._compileTask=null,this._evaluateTask=null,this.expressionInfo=null,this.graphic=null,this.contentElementViewModel=null,this.interceptor=null,this.location=null,this.view=null,this._createVM=()=>{const e=this.contentElement?.type;this.contentElementViewModel?.destroy();const t="fields"===e?new b:"media"===e?new C:"text"===e?new M:null;this._set("contentElementViewModel",t)},this._compileThrottled=l.throttle(this._startCompile,()=>this.notifyChange("state"),1,this),this._evaluateThrottled=l.throttle(this._startEvaluate,()=>this.notifyChange("state"),1,this),this.addHandles([r.watch(()=>[this.expressionInfo,this.graphic],()=>this._compileThrottled(),r.initial),r.watch(()=>[this.contentElement],()=>this._createVM(),r.initial),r.when(()=>{if(!this._compileTask?.finished)return null;const e=this._compileTask.value,t=e?.dependencies;return[e,this.spatialReference,this.map,this.view,t?.has("view-scale")?this.view?.scale:null,t?.has("view-time-extent")?this.view?.timeExtent?.start:null,t?.has("view-time-extent")?this.view?.timeExtent?.end:null]},([e])=>this._evaluateThrottled(e))])}initialize(){this.addHandles([this._compileThrottled,this._evaluateThrottled])}destroy(){this._compileTask=s.abortMaybe(this._compileTask),this._evaluateTask=s.abortMaybe(this._evaluateTask),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null)}get contentElement(){return this._evaluateTask?.value}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){const{contentElement:e,contentElementViewModel:t}=this;return this._compileThrottled.hasPendingUpdates()||this._evaluateThrottled.hasPendingUpdates()||!this._compileTask?.finished||!this._evaluateTask?.finished?"loading":e||t?"ready":"disabled"}get map(){return this.view?.map??null}set map(e){this._override("map",e)}_startCompile(){this._evaluateTask=s.abortMaybe(this._evaluateTask),this._compileTask=s.abortMaybe(this._compileTask),this._compileTask=i.createTask(async e=>{const{expressionInfo:t,graphic:o}=this,a=t?.expression;if(!a||!o)return null;const i=await F.compileExpression({expression:a,graphic:o});return n.throwIfAborted(e),i})}_startEvaluate(e){this._evaluateTask=s.abortMaybe(this._evaluateTask),this._evaluateTask=i.createTask(async t=>{const{graphic:o}=this;if(!e||!o)return null;const{interceptor:a,spatialReference:i,map:s,location:r,view:l}=this,p=await e.evaluate({graphic:o,interceptor:a,location:r,map:s,options:{signal:t},spatialReference:i,view:l});n.throwIfAborted(t);const c=p;if(!c||"esri.arcade.Dictionary"!==c.declaredClass)return null;const d=await c.castAsJsonAsync(t);n.throwIfAborted(t);const h=d?.type,u="media"===h?T.fromJSON(d):"text"===h?x.fromJSON(d):"fields"===h?w.fromJSON(d):null;return"media"===u.type&&!u.mediaInfos||"fields"===u.type&&!u.fieldInfos||"text"===u.type&&!u.text?null:u})}},t.__decorate([p.property()],e.default.prototype,"_compileTask",void 0),t.__decorate([p.property()],e.default.prototype,"_evaluateTask",void 0),t.__decorate([p.property({type:g})],e.default.prototype,"expressionInfo",void 0),t.__decorate([p.property({type:o})],e.default.prototype,"graphic",void 0),t.__decorate([p.property({readOnly:!0})],e.default.prototype,"contentElement",null),t.__decorate([p.property({readOnly:!0})],e.default.prototype,"contentElementViewModel",void 0),t.__decorate([p.property()],e.default.prototype,"interceptor",void 0),t.__decorate([p.property({type:_})],e.default.prototype,"location",void 0),t.__decorate([p.property()],e.default.prototype,"spatialReference",null),t.__decorate([p.property({readOnly:!0})],e.default.prototype,"state",null),t.__decorate([p.property()],e.default.prototype,"map",null),t.__decorate([p.property()],e.default.prototype,"view",void 0),e.default=t.__decorate([u.subclass("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],e.default),e.default});