// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/arrayUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/cast","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../popup/FieldInfo","../../../popup/content/support/ChartMediaInfoValueSeries","../support/featureUtils","../support/relatedFeatureUtils"],function(e,t,i,r,o,a,s,l,d,n,u,p){"use strict";const f={chartAnimation:!0};return e.default=class extends i{constructor(e){super(e),this.abilities={...f},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.isAggregate=!1,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(e){return{...f,...e}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(e){this._setContentElementMedia(e)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(e){const{formattedMediaInfoCount:t}=this,i=(e+t)%t;this.activeMediaInfoIndex=i}_pageContentElementMedia(e){const{activeMediaInfoIndex:t}=this,i=t+e;this._setContentElementMedia(i)}_formatMediaInfos(){const{mediaInfos:e,layer:t}=this,i=this.attributes??{},o=this.formattedAttributes??{},a=this.expressionAttributes??{},s=this.fieldInfoMap??new Map;return e?.map(e=>{const r=e?.clone();if(!r)return null;if(r.title=u.substituteFieldsInLinksAndAttributes({attributes:i,fieldInfoMap:s,globalAttributes:o,expressionAttributes:a,layer:t,text:r.title}),r.caption=u.substituteFieldsInLinksAndAttributes({attributes:i,fieldInfoMap:s,globalAttributes:o,expressionAttributes:a,layer:t,text:r.caption}),r.altText=u.substituteFieldsInLinksAndAttributes({attributes:i,fieldInfoMap:s,globalAttributes:o,expressionAttributes:a,layer:t,text:r.altText}),"image"===r.type){if(!r.value)return;return this._setImageValue({value:r.value,formattedAttributes:o,layer:t}),r.value.sourceURL?r:void 0}if("pie-chart"===r.type||"line-chart"===r.type||"column-chart"===r.type||"bar-chart"===r.type){if(!r.value)return;return this._setChartValue({value:r.value,chartType:r.type,attributes:i,formattedAttributes:o,layer:t,expressionAttributes:a}),r}return null}).filter(r.isSome)??[]}_setImageValue(e){const t=this.fieldInfoMap??new Map,{value:i,formattedAttributes:r,layer:o}=e,{linkURL:a,sourceURL:s}=i;if(s){const e=u.fixTokens(s,o);i.sourceURL=u.substituteAttributes({formattedAttributes:r,template:e,fieldInfoMap:t})}if(a){const e=u.fixTokens(a,o);i.linkURL=u.substituteAttributes({formattedAttributes:r,template:e,fieldInfoMap:t})}}_setChartValue(e){const{value:t,attributes:i,formattedAttributes:r,chartType:o,layer:a,expressionAttributes:s}=e,{popupTemplate:l,relatedInfos:d}=this,{fields:n,normalizeField:p}=t,f=a;if(t.fields=u.getFixedFieldNames(n,f),p&&(t.normalizeField=u.getFixedFieldName(p,f)),!n.some(e=>!!(null!=r[e]||u.isRelatedField(e)&&d?.size)))return;const c=l?.fieldInfos??[];n.forEach((e,a)=>{const l=t.colors?.[a];if(u.isRelatedField(e))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:c,fieldName:e,formattedAttributes:r,chartType:o,value:t,color:l})]);const d=this._getChartOption({value:t,attributes:i,chartType:o,formattedAttributes:r,expressionAttributes:s,fieldName:e,fieldInfos:c,color:l});t.series.push(d)})}_getRelatedChartInfos(e){const{fieldInfos:t,fieldName:i,formattedAttributes:r,chartType:o,value:a,color:s}=e,l=[],d=p.getRelatedFieldInfo(i),n=d&&this.relatedInfos?.get(d.layerId.toString());if(!n)return l;const{relatedFeatures:u,relation:f}=n;if(!f||!u)return l;const{cardinality:c}=f;return u.forEach(e=>{const{attributes:n}=e;n&&Object.keys(n).forEach(e=>{e===d.fieldName&&l.push(this._getChartOption({value:a,attributes:n,formattedAttributes:r,fieldName:i,chartType:o,relatedFieldName:e,hasMultipleRelatedFeatures:u?.length>1,fieldInfos:t,color:s}))})}),"one-to-many"===c||"many-to-many"===c?l:[l[0]]}_getTooltip({label:e,value:t,chartType:i}){return"pie-chart"===i?`${e}`:`${e}: ${t}`}_getChartOption(e){const{value:t,attributes:i,formattedAttributes:r,expressionAttributes:o,fieldName:a,relatedFieldName:s,fieldInfos:l,chartType:f,hasMultipleRelatedFeatures:c,color:h}=e,m=this.layer,y=this.fieldInfoMap??new Map,{normalizeField:b,tooltipField:I}=t,_=b?u.isRelatedField(b)?i[p.getRelatedFieldInfo(b).fieldName]:i[b]:null,v=u.isExpressionField(a)&&o&&void 0!==o[a]?o[a]:s&&void 0!==i[s]?i[s]:void 0!==i[a]?i[a]:r[a],A=void 0===v?null:v&&_?v/_:v,M=new n({fieldName:a,color:h,value:"number"==typeof A?A:Number(A)});if(u.isRelatedField(a)){const e=y.get(a.toLowerCase()),t=I&&y.get(I.toLowerCase()),o=e?.fieldName??a,l=c&&I?p.getRelatedFieldInfo(I).fieldName:t?.fieldName??I,d=c&&l?i[l]:r[l]??e?.label??e?.fieldName??s,n=c&&s?i[s]:r[o];return M.tooltip=this._getTooltip({label:d,value:n,chartType:f}),M}const g=u.getFieldInfo(l,a),F=u.getFixedFieldName(a,m),x=I&&void 0!==r[I]?r[I]:u.getFieldInfoLabel(g||new d({fieldName:F}),this.popupTemplate?.expressionInfos),T=r[F];return M.tooltip=this._getTooltip({label:x,value:T,chartType:f}),M}},t.__decorate([o.property()],e.default.prototype,"abilities",void 0),t.__decorate([a.cast("abilities")],e.default.prototype,"castAbilities",null),t.__decorate([o.property()],e.default.prototype,"activeMediaInfoIndex",void 0),t.__decorate([o.property({readOnly:!0})],e.default.prototype,"activeMediaInfo",null),t.__decorate([o.property()],e.default.prototype,"attributes",void 0),t.__decorate([o.property()],e.default.prototype,"description",void 0),t.__decorate([o.property()],e.default.prototype,"fieldInfoMap",void 0),t.__decorate([o.property()],e.default.prototype,"formattedAttributes",void 0),t.__decorate([o.property()],e.default.prototype,"expressionAttributes",void 0),t.__decorate([o.property({readOnly:!0})],e.default.prototype,"formattedMediaInfos",null),t.__decorate([o.property()],e.default.prototype,"isAggregate",void 0),t.__decorate([o.property()],e.default.prototype,"layer",void 0),t.__decorate([o.property({readOnly:!0})],e.default.prototype,"formattedMediaInfoCount",null),t.__decorate([o.property()],e.default.prototype,"mediaInfos",void 0),t.__decorate([o.property()],e.default.prototype,"popupTemplate",void 0),t.__decorate([o.property()],e.default.prototype,"relatedInfos",void 0),t.__decorate([o.property()],e.default.prototype,"title",void 0),e.default=t.__decorate([l.subclass("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],e.default),e.default});