// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../chunks/tslib.es6","../../intl","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/string","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../Widget","./FeatureRelationship/FeatureRelationshipViewModel","./support/FeatureElementInfo","../../chunks/componentsUtils","../support/globalCss","../support/widgetUtils","../support/decorators/messageBundle","../support/jsxFactory","../../intl/substitute","../../intl/number"],function(e,t,s,r,i,o,n,l,a,d,c,u,h,p,_,m,v,w,y,f,b,g,I){"use strict";const F=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));var C;const M="esri-feature",E=`${M}-relationship`,O={base:E,listContainer:`${E}__list`,listItem:`${E}__list-item`,listItemHidden:`${E}__list-item--hidden`,listContainerQuerying:`${E}__list--querying`,featureObserver:`${M}__feature-observer`,stickySpinnerContainer:`${M}__sticky-loading-container`,loadingSpinnerContainer:`${M}__loading-container`},R={title:!0,description:!0};return t.default=C=class extends p{constructor(e,t){super(e,t),this._featureElementInfo=null,this._relatedFeatureIntersectionObserverNode=null,this._relatedFeatureIntersectionObserver=new IntersectionObserver(([e])=>{e?.isIntersecting&&this._increaseFeaturePage()},{root:window.document}),this.flowItems=null,this.flowType="feature-relationship",this.headingLevel=2,this.viewModel=new _,this.messages=null,this.messagesCommon=null,this.visibleElements={...R},this._increaseFeaturePage=()=>{const{state:e,showAllEnabled:t,relatedFeatures:s,featuresPerPage:r,featurePage:i}=this.viewModel;"ready"===e&&t&&s.length>=r*i&&this.viewModel.featurePage++}}initialize(){this._featureElementInfo=new m,this.addHandles([n.watch(()=>[this.viewModel.description,this.viewModel.title,this.headingLevel],()=>this._setupFeatureElementInfo(),n.initial),n.watch(()=>[this.viewModel.state,this.viewModel.showAllEnabled,this._relatedFeatureIntersectionObserverNode],()=>this._handleRelatedFeatureObserverChange()),n.on(()=>this.viewModel.relatedFeatureViewModels,"change",()=>this._setupRelatedFeatureViewModels())])}loadDependencies(){return v.loadCalciteComponents({chip:()=>new Promise((t,s)=>e(["../../chunks/index11"],t,s)),icon:()=>new Promise((t,s)=>e(["../../chunks/index7"],t,s)),list:()=>new Promise((t,s)=>e(["../../chunks/index16"],t,s)),"list-item":()=>new Promise((t,s)=>e(["../../chunks/index20"],t,s)),loader:()=>new Promise((t,s)=>e(["../../chunks/index32"],t,s)),notice:()=>new Promise((t,s)=>e(["../../chunks/index6"],t,s))})}destroy(){this._unobserveRelatedFeatureObserver(),this._featureElementInfo=i.destroyMaybe(this._featureElementInfo)}get displayShowAllButton(){const{showAllEnabled:e,featureCount:t,displayCount:s,state:r,allCategoriesCount:i}=this.viewModel;return!e&&"ready"===r&&(!!i&&(i>s||0===s)||!!t&&(t>s||0===s))}get displayListItems(){const{relatedFeatureViewModels:e,allCategoriesCount:t}=this.viewModel;return this.displayShowAllButton||!!e.length||!!t}get allItemsDescription(){const{messages:e}=this,{featureCount:t,allCategories:s,allCategoriesCount:r}=this.viewModel;return g.substitute(e?.numberRecords,{number:I.formatNumber(s?r:t)})}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get title(){const{activeCategory:e,title:t}=this.viewModel;return e?.name??t}set title(e){this.viewModel.title=e}castVisibleElements(e){return{...R,...e}}render(){const{state:e}=this.viewModel;return b.tsx("div",{class:this.classes(O.base,w.globalCss.widget)},this._featureElementInfo?.render(),"loading"===e?this._renderLoading():"disabled"===e?this._renderRelationshipNotFound():this._renderRelatedFeatures())}_selectCategory(e){const{flowItems:t,featureVisibleElements:s,viewModel:r}=this;t&&(r.activeCategory=e,r.showAllEnabled=!0,t.push(new C({flowItems:t,featureVisibleElements:s,visibleElements:{title:!1,description:!1},viewModel:r})))}async _selectRecord(t){const{flowItems:s,featureVisibleElements:r}=this;if(!s)return;t.abilities={relationshipContent:!0};const{default:i}=await new Promise((t,s)=>e(["../Feature"],e=>t(F(e)),s));s.push(new i({flowItems:s,flowType:this.flowType,viewModel:t,visibleElements:r}))}_showAllRecords(){const{flowItems:e}=this;if(!e)return;const{viewModel:t,featureVisibleElements:s}=this;t.showAllEnabled=!0;const r=new C({flowItems:e,featureVisibleElements:s,visibleElements:{title:!1,description:!1},viewModel:t});e.push(r)}_renderStickyLoading(){return"querying"===this.viewModel.state?b.tsx("div",{class:O.stickySpinnerContainer,key:"sticky-loader"},this._renderLoadingIcon()):null}_renderLoadingIcon(){return b.tsx("calcite-loader",{inline:!0,label:""})}_renderLoading(){return b.tsx("div",{class:O.loadingSpinnerContainer,key:"loading-container"},this._renderLoadingIcon())}_renderShowAllIconNode(){return b.tsx("calcite-icon",{icon:"list",scale:"s",slot:"content-end"})}_renderChevronIconNode(){const e=y.isRTL(this.container)?"chevron-left":"chevron-right";return b.tsx("calcite-icon",{icon:e,scale:"s",slot:"content-end"})}_renderCategory(e){const{count:t,name:s,value:r}=e,i=I.formatNumber(t);return b.tsx("calcite-list-item",{class:O.listItem,disabled:!t,key:r,label:s,onCalciteListItemSelect:()=>this._selectCategory(e)},b.tsx("calcite-chip",{label:i,scale:"s",slot:"content-end"},i),this._renderChevronIconNode())}_renderRelatedFeature(e){const{itemDescriptionFieldName:t}=this.viewModel,s=e.title;e.description=t&&e.formattedAttributes?.global[t];const r="loading"===e.state;return b.tsx("calcite-list-item",{class:this.classes(O.listItem,{[O.listItemHidden]:r}),description:l.stripHTML(e.description??""),key:e.uid,label:l.stripHTML(s),onCalciteListItemSelect:()=>this._selectRecord(e)},this._renderChevronIconNode())}_renderShowAllListItem(){return this.displayShowAllButton?b.tsx("calcite-list-item",{description:this.allItemsDescription,key:"show-all-item",label:this.messages?.showAll,onCalciteListItemSelect:()=>this._showAllRecords()},this._renderShowAllIconNode()):null}_renderNoRelatedFeaturesMessage(){return b.tsx("calcite-notice",{icon:"information",key:"no-related-features-message",kind:"brand",open:!0,scale:"s",width:"full"},b.tsx("div",{slot:"message"},this.messages?.noRelatedFeatures))}_renderFeatureObserver(){return b.tsx("div",{afterCreate:this._relatedFeatureIntersectionObserverCreated,bind:this,class:O.featureObserver,key:"feature-observer"})}_renderList(){const{relatedFeatureViewModels:e,categories:t}=this.viewModel;return b.tsx("calcite-list",{displayMode:"flat",label:this.messages?.relatedFeaturesList},t?.map(e=>this._renderCategory(e))??e.toArray().map(e=>this._renderRelatedFeature(e)),this._renderShowAllListItem())}_renderRelatedFeatures(){const{displayListItems:e}=this,{state:t}=this.viewModel;return b.tsx("div",{class:this.classes(O.listContainer,{[O.listContainerQuerying]:"querying"===t}),key:"list-container"},e?this._renderList():"ready"===t?this._renderNoRelatedFeaturesMessage():null,this._renderStickyLoading(),this._renderFeatureObserver())}_renderRelationshipNotFound(){return b.tsx("calcite-notice",{icon:"exclamation-mark-triangle",key:"relationship-not-found",kind:"danger",open:!0,scale:"s",width:"full"},b.tsx("div",{slot:"message"},this.messages?.relationshipNotFound))}_setupRelatedFeatureViewModels(){const{relatedFeatureViewModels:e}=this.viewModel,t="related-feature-viewmodels";this.removeHandles(t),e?.forEach(e=>{this.addHandles(n.watch(()=>[e.title,e.state],()=>this.scheduleRender(),n.initial),t)}),this.scheduleRender()}_setupFeatureElementInfo(){const{headingLevel:e,visibleElements:t}=this,s=t.description&&this.description,r=t.title&&this.title;this._featureElementInfo?.set({description:s,title:r,headingLevel:e})}async _handleRelatedFeatureObserverChange(){this._unobserveRelatedFeatureObserver();const{state:e,showAllEnabled:t}=this.viewModel;await o.after(0),this._relatedFeatureIntersectionObserverNode&&"ready"===e&&t&&this._relatedFeatureIntersectionObserver.observe(this._relatedFeatureIntersectionObserverNode)}_relatedFeatureIntersectionObserverCreated(e){this._relatedFeatureIntersectionObserverNode=e}_unobserveRelatedFeatureObserver(){this._relatedFeatureIntersectionObserverNode&&this._relatedFeatureIntersectionObserver.unobserve(this._relatedFeatureIntersectionObserverNode)}},s.__decorate([a.property()],t.default.prototype,"_relatedFeatureIntersectionObserverNode",void 0),s.__decorate([a.property({readOnly:!0})],t.default.prototype,"displayShowAllButton",null),s.__decorate([a.property({readOnly:!0})],t.default.prototype,"displayListItems",null),s.__decorate([a.property({readOnly:!0})],t.default.prototype,"allItemsDescription",null),s.__decorate([a.property()],t.default.prototype,"description",null),s.__decorate([a.property()],t.default.prototype,"featureVisibleElements",void 0),s.__decorate([a.property()],t.default.prototype,"flowItems",void 0),s.__decorate([a.property()],t.default.prototype,"flowType",void 0),s.__decorate([a.property()],t.default.prototype,"headingLevel",void 0),s.__decorate([a.property()],t.default.prototype,"title",null),s.__decorate([a.property({type:_})],t.default.prototype,"viewModel",void 0),s.__decorate([a.property(),f.messageBundle("esri/widgets/Feature/t9n/Feature")],t.default.prototype,"messages",void 0),s.__decorate([a.property(),f.messageBundle("esri/t9n/common")],t.default.prototype,"messagesCommon",void 0),s.__decorate([a.property()],t.default.prototype,"visibleElements",void 0),s.__decorate([d.cast("visibleElements")],t.default.prototype,"castVisibleElements",null),t.default=C=s.__decorate([h.subclass("esri.widgets.Feature.FeatureRelationship")],t.default),t.default});