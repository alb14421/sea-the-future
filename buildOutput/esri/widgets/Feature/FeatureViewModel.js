// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../Graphic","../../arcade/featureset/support/FeatureSetQueryInterceptor","../../core/Accessor","../../core/arrayUtils","../../core/asyncUtils","../../core/Collection","../../core/Identifiable","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/throttle","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/Point","../../geometry/SpatialReference","../../popup/content/TextContent","../../time/constants","./FeatureAttachments/FeatureAttachmentsViewModel","./FeatureContent/FeatureContentViewModel","./FeatureExpression/FeatureExpressionViewModel","./FeatureFields/FeatureFieldsViewModel","./FeatureMedia/FeatureMediaViewModel","./FeatureRelationship/FeatureRelationshipViewModel","./support/arcadeFeatureUtils","./support/featureUtils","./support/relatedFeatureUtils","../support/UtilityNetworkAssociations/FeatureUtilityNetworkAssociationsViewModel"],function(e,t,i,s,r,o,a,n,l,c,p,d,u,h,f,_,m,y,g,b,A,I,w,v,x,M,F,T,E,C,V,k){"use strict";var R;const L="content-view-models",P="relationship-view-models",O={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0,utilityNetworkAssociationsContent:!0};return e.default=class extends(l.IdentifiableMixin(r)){static{R=this}constructor(e){super(e),this._error=null,this._graphicChangedTask=null,this._evaluateExpressionAttributesTask=null,this._associationVMAbortController=null,this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...O},this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.location=null,this.relatedInfos=new Map,this.title="",this.view=null,this._graphicChangedThrottled=h.throttle(this._graphicChanged,()=>this.notifyChange("waitingForContent"),1,this),this._isAllowedContentType=e=>{const{abilities:t}=this;return"attachments"===e.type&&!!t.attachmentsContent||"custom"===e.type&&!!t.customContent||"fields"===e.type&&!!t.fieldsContent||"media"===e.type&&!!t.mediaContent||"text"===e.type&&!!t.textContent||"expression"===e.type&&!!t.expressionContent||"relationship"===e.type&&!!t.relationshipContent||"utility-network-associations"===e.type&&!!t.utilityNetworkAssociationsContent},this._evaluateExpressionAttributesThrottled=h.throttle(this._evaluateExpressionAttributes,()=>this.notifyChange("waitingForContent"),1,this),this.addHandles([u.watch(()=>[this.graphic,this._effectivePopupTemplate,this.abilities,this.timeZone],()=>this._graphicChangedThrottled(),u.initial),u.when(()=>{if(!this._graphicChangedTask?.finished||null==this._graphicChangedTask.value)return null;const e=this._graphicChangedTask.value,t=e?.expressionInfos?.dependencies;return[e,t?.has("view-scale")?this.view?.scale:null,t?.has("view-time-extent")?this.view?.timeExtent?.start:null,t?.has("view-time-extent")?this.view?.timeExtent?.end:null]},([e])=>this._evaluateExpressionAttributesThrottled(e))])}initialize(){this.addHandles([this._graphicChangedThrottled,this._evaluateExpressionAttributesThrottled])}destroy(){this._clear(),this._graphicChangedTask=p.abortMaybe(this._graphicChangedTask),this._evaluateExpressionAttributesTask=p.abortMaybe(this._evaluateExpressionAttributesTask),this._error=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}static{this.interceptor=new s.FeatureSetQueryInterceptor(C.preLayerQueryCallback,C.preRequestCallback)}get _effectivePopupTemplate(){return null!=this.graphic?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return C.createFieldInfoMap(C.getAllFieldInfos(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return C.getSourceLayer(this.graphic)}castAbilities(e){return{...O,...e}}get isFeatureFromTable(){return this._sourceLayer?.isTable||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(e){this._set("graphic",e?.clone()??null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get timeZone(){return this.view?.timeZone??I.system}set timeZone(e){this._overrideIfSome("timeZone",e)}get map(){return this.view?.map||null}set map(e){this._override("map",e)}get waitingForContent(){const{_graphicChangedThrottled:e,_evaluateExpressionAttributesThrottled:t,_graphicChangedTask:i,_evaluateExpressionAttributesTask:s,_associationVMAbortController:r}=this;return e.hasPendingUpdates()||t.hasPendingUpdates()||null!=i&&!i.finished||null!=s&&!s.finished||!!r}setActiveMedia(e,t){const i=this.contentViewModels[e];i instanceof F&&i.setActiveMedia(t)}nextMedia(e){const t=this.contentViewModels[e];t instanceof F&&t.next()}previousMedia(e){const t=this.contentViewModels[e];t instanceof F&&t.previous()}async updateGeometry(){const{graphic:e,spatialReference:t,_sourceLayer:i}=this;await(i?.load());const s=i?.objectIdField;if(!s||!e||!i)return;const r=e?.attributes?.[s];if(null==r)return;const o=[r];if(!e.geometry){const s=await C.querySourceLayer({layer:i,graphic:e,outFields:[],objectIds:o,returnGeometry:!0,spatialReference:t}),r=s?.geometry;r&&(e.geometry=r)}}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}_graphicChanged(){this._evaluateExpressionAttributesTask=p.abortMaybe(this._evaluateExpressionAttributesTask),this._graphicChangedTask=p.abortMaybe(this._graphicChangedTask),this._graphicChangedTask=a.createTask(async e=>{this._error=null,this._clear();const{graphic:t}=this;try{if(!t)return null;const{_sourceLayer:i,_effectivePopupTemplate:s}=this,r=this.spatialReference;await C.queryUpdatedFeature({graphic:t,popupTemplate:s,layer:i,spatialReference:r},{signal:e});const[{value:o},{value:a}]=await d.eachAlways([this._getContent(),this._getTitle()]),[,{value:n}]=await d.eachAlways([this._checkForRelatedFeatures({signal:e}),E.compileExpressionInfos(s?.expressionInfos,t)]);return{expressionInfos:n,content:o,title:a}}catch(e){throw d.isAbortError(e)||(this._error=e,c.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:e,graphic:t,popupTemplate:this._effectivePopupTemplate})),e}})}_compileContentElement(e,t){return"attachments"===e.type?this._compileAttachments(e,t):"custom"===e.type?this._compileCustom(e,t):"fields"===e.type?this._compileFields(e,t):"media"===e.type?this._compileMedia(e,t):"text"===e.type?this._compileText(e,t):"expression"===e.type?this._compileExpression(e,t):"relationship"===e.type?this._compileRelationship(e,t):"utility-network-associations"===e.type?this._compileUtilityNetworkAssociation(e,t):void 0}_compileContent(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.filter(this._isAllowedContentType).map((e,t)=>this._compileContentElement(e,t)).filter(o.isSome):"string"==typeof e?this._compileText(new A({text:e}),0).text:e}_destroyContentViewModels(){this.removeHandles(P),this.removeHandles(L),this.contentViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("contentViewModels",[])}_matchesFeature(e,t){const i=e?.graphic?.getObjectId(),s=t?.getObjectId();return null!=i&&null!=s&&i===s}_setRelatedFeaturesViewModels({relatedFeatureViewModels:e,relatedFeatures:t,map:i}){const{view:s,spatialReference:r,timeZone:o}=this;t?.filter(Boolean).forEach(t=>{e.some(e=>this._matchesFeature(e,t))||e.add(new R({abilities:{relationshipContent:!1},map:i,view:s,spatialReference:r,timeZone:o,graphic:t}))}),e.forEach(i=>{const s=t?.find(e=>this._matchesFeature(i,e));s||e.remove(i)})}_setExpressionContentVM(e,t){const i=this.formattedAttributes,{contentElement:s,contentElementViewModel:r}=e,o=s?.type;r&&o&&("fields"===o&&(this._createFieldsFormattedAttributes({contentElement:s,contentElementIndex:t,formattedAttributes:i}),r.set(this._createFieldsVMParams(s,t))),"media"===o&&(this._createMediaFormattedAttributes({contentElement:s,contentElementIndex:t,formattedAttributes:i}),r.set(this._createMediaVMParams(s,t))),"text"===o&&r.set(this._createTextVMParams(s)))}_compileRelationship(e,t){const{displayCount:i,orderByFields:s,relationshipId:r,title:o,description:a}=e,{_sourceLayer:n,graphic:l,map:c}=this;if(!C.isRelatableFeatureSupportedLayer(n))return;const p=new T({displayCount:i,graphic:l,orderByFields:s,relationshipId:r,layer:n,map:c,...this._compileTitleAndDesc({title:o,description:a})});return this.contentViewModels[t]=p,this.addHandles(u.on(()=>p.relatedFeatures,"change",()=>this._setRelatedFeaturesViewModels(p)),P),e}_matchesGlobalFeature(e,t){const i=e?.association.globalId,s=t?.association.globalId;return null!=i&&null!=s&&i===s}_setUpUtilityNetworkAssociationsViewModels(e,t,i){const{view:s,spatialReference:r,timeZone:o}=this;e.forEach((i,s)=>{const r=t.get(s);r?i.forEach(t=>{r.find(e=>this._matchesGlobalFeature(t,e))||(i.remove(t),0===i.length&&e.delete(s))}):(i.removeAll(),e.delete(s))}),t.forEach((t,a)=>{const l=e.get(a)||new n;t?.filter(Boolean).forEach((e,t)=>{if(!l.some(t=>this._matchesGlobalFeature(t,e))){const{association:a,feature:n,terminalName:c,title:p}=e;l.add({title:p,association:a,featureViewModel:new R({abilities:{utilityNetworkAssociationsContent:!1},map:i,view:s,spatialReference:r,timeZone:o,graphic:n}),terminalName:c},t)}}),e.set(a,l)})}_compileUtilityNetworkAssociation(e,t){const{displayCount:i,title:s,description:r,associationTypes:o}=e,{_sourceLayer:a,graphic:n,map:l}=this;if(!C.isAssociatedFeatureSupportedLayer(a))return;const c=new k({graphic:n,displayCount:i,associationTypes:o,layer:a,map:l,...this._compileTitleAndDesc({title:s,description:r})});return this.contentViewModels[t]=c,this.addHandles([u.watch(()=>c.associationFeatures.values(),()=>this._setUpUtilityNetworkAssociationsViewModels(c.associationViewModels,c.associationFeatures,c.map))],"association-view-models"),e}_compileExpression(e,t){const{expressionInfo:i}=e,{graphic:s,map:r,spatialReference:o,view:a,location:n}=this,l=new x({expressionInfo:i,graphic:s,interceptor:R.interceptor,map:r,spatialReference:o,view:a,location:n});return this.contentViewModels[t]=l,this.addHandles(u.watch(()=>l.contentElementViewModel,()=>this._setExpressionContentVM(l,t),u.initial),L),e}_compileAttachments(e,t){const{graphic:i}=this,{description:s,title:r,orderByFields:o}=e;return this.contentViewModels[t]=new w({graphic:i,orderByFields:o,...this._compileTitleAndDesc({title:r,description:s})}),e}_compileCustom(e,t){const{graphic:i}=this,{creator:s,destroyer:r}=e;return this.contentViewModels[t]=new v({graphic:i,creator:s,destroyer:r}),e}_compileTitleAndDesc({title:e,description:t}){const{_fieldInfoMap:i,_sourceLayer:s,graphic:r,formattedAttributes:o}=this,a=r?.attributes,n=this._expressionAttributes,l=o.global;return{title:C.substituteFieldsInLinksAndAttributes({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:n,layer:s,text:e}),description:C.substituteFieldsInLinksAndAttributes({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:n,layer:s,text:t})}}_createFieldsVMParams(e,t){const i=this._effectivePopupTemplate,s=this.formattedAttributes,r={...s?.global,...s?.content[t]},o=e?.fieldInfos||i?.fieldInfos,a=o?.filter(({fieldName:e})=>!!e&&(C.isExpressionField(e)||C.isRelatedField(e)||r.hasOwnProperty(e))),n=i?.expressionInfos,{description:l,title:c}=e;return{attributes:r,expressionInfos:n,fieldInfos:a,...this._compileTitleAndDesc({title:c,description:l})}}_compileFields(e,t){const i=e.clone(),s=new M(this._createFieldsVMParams(e,t));return this.contentViewModels[t]=s,i.fieldInfos=s.formattedFieldInfos.slice(),i}_createMediaVMParams(e,t){const{abilities:i,graphic:s,_fieldInfoMap:r,_effectivePopupTemplate:o,relatedInfos:a,_sourceLayer:n,_expressionAttributes:l}=this,c=this.formattedAttributes,p=s?.attributes??{},{description:d,mediaInfos:u,title:h}=e;return{abilities:{chartAnimation:i.chartAnimation},activeMediaInfoIndex:e.activeMediaInfoIndex||0,attributes:p,isAggregate:s?.isAggregate,layer:n,fieldInfoMap:r,formattedAttributes:{...c?.global,...c?.content[t]},expressionAttributes:l,mediaInfos:u,popupTemplate:o,relatedInfos:a,...this._compileTitleAndDesc({title:h,description:d})}}_compileMedia(e,t){const i=e.clone(),s=new F(this._createMediaVMParams(e,t));return i.mediaInfos=s.formattedMediaInfos.slice(),this.contentViewModels[t]=s,i}_createTextVMParams(e){const{graphic:t,_fieldInfoMap:i,_sourceLayer:s,_expressionAttributes:r}=this;if(e&&e.text){const o=t?.attributes??{},a=this.formattedAttributes?.global??{};e.text=C.substituteFieldsInLinksAndAttributes({attributes:o,fieldInfoMap:i,globalAttributes:a,expressionAttributes:r,layer:s,text:e.text})}return{graphic:t,creator:e.text}}_compileText(e,t){const i=e.clone();return this.contentViewModels[t]=new v(this._createTextVMParams(i)),i}_compileLastEditInfo(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:i,timeZone:s}=this;if(!e)return;const{lastEditInfoEnabled:r}=e,o=t?.editFieldsInfo;return r&&o?C.formatEditInfo(o,i?.attributes,s,t):void 0}_compileTitle(e){const{_fieldInfoMap:t,_sourceLayer:i,graphic:s,_expressionAttributes:r}=this,o=s?.attributes??{},a=this.formattedAttributes?.global??{};return C.substituteFieldsInLinksAndAttributes({attributes:o,fieldInfoMap:t,globalAttributes:a,expressionAttributes:r,layer:i,text:e})}async _getTitle(){const{_effectivePopupTemplate:e,graphic:t}=this;return t?C.graphicCallback({type:"title",value:e?.title,event:{graphic:t}}):null}async _getContent(){const{_effectivePopupTemplate:e,graphic:t}=this;return t?C.graphicCallback({type:"content",value:e?.content,event:{graphic:t}}):null}_evaluateExpressionAttributes({title:e,content:t,expressionInfos:i}){this._evaluateExpressionAttributesTask=p.abortMaybe(this._evaluateExpressionAttributesTask),this._evaluateExpressionAttributesTask=a.createTask(async s=>{const{graphic:r,map:o,view:a,spatialReference:n,location:l}=this;try{if(!r)return;let c;if(null!=i){const e=[];for(const[t,c]of i.expressions.entries())null!=c?e.push(c.evaluate({graphic:r,interceptor:R.interceptor,location:l,map:o,options:{signal:s},spatialReference:n,view:a}).then(e=>[t,"string"==typeof e?E.formatArcadeValue(e):e]).catch(()=>[t,void 0])):e.push(Promise.resolve([t,void 0]));c=Object.fromEntries(await Promise.all(e)),d.throwIfAborted(s)}this._expressionAttributes=c,this._graphicExpressionAttributes={...r.attributes,...c},this._set("formattedAttributes",this._createFormattedAttributes(t)),this._set("title",this._compileTitle(e)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(t)||null)}catch(e){d.isAbortError(e)||(this._error=e,c.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:e,graphic:r,popupTemplate:this._effectivePopupTemplate}))}})}_createMediaFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){const{_effectivePopupTemplate:s,graphic:r,relatedInfos:o,_sourceLayer:a,_fieldInfoMap:n,_graphicExpressionAttributes:l,timeZone:c}=this;i.content[t]=C.formatAttributes({fieldInfos:s?.fieldInfos,graphic:r,attributes:{...l,...e.attributes},layer:a,fieldInfoMap:n,relatedInfos:o,timeZone:c})}_createFieldsFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){if(e.fieldInfos){const{graphic:s,relatedInfos:r,_sourceLayer:o,_fieldInfoMap:a,_graphicExpressionAttributes:n,timeZone:l}=this;i.content[t]=C.formatAttributes({fieldInfos:e.fieldInfos,graphic:s,attributes:{...n,...e.attributes},layer:o,fieldInfoMap:a,relatedInfos:r,timeZone:l})}}_createFormattedAttributes(e){const{_effectivePopupTemplate:t,graphic:i,relatedInfos:s,_sourceLayer:r,_fieldInfoMap:o,_graphicExpressionAttributes:a,timeZone:n}=this,l=t?.fieldInfos,c={global:C.formatAttributes({fieldInfos:l,graphic:i,attributes:a,layer:r,fieldInfoMap:o,relatedInfos:s,timeZone:n}),content:[]};return Array.isArray(e)&&e.forEach((e,t)=>{"fields"===e.type&&this._createFieldsFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:c}),"media"===e.type&&this._createMediaFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:c})}),c}_checkForRelatedFeatures(e){const{graphic:t,_effectivePopupTemplate:i}=this;return this._queryRelatedInfos(t,C.getAllFieldInfos(i),e)}async _queryRelatedInfos(e,t,i){const{relatedInfos:s,_sourceLayer:r}=this;s.clear();const o=null!=r?.associatedLayer?await(r?.associatedLayer.load(i)):r;if(!o||!e)return;const a=t.filter(e=>!!e.fieldName&&C.isRelatedField(e.fieldName));if(!a?.length)return;t.forEach(e=>this._configureRelatedInfo(e,o));const n=await V.queryLayerInfos({relatedInfos:s,layer:o},i);Object.keys(n).forEach(e=>{const t=s.get(e.toString()),i=n[e]?.value;t&&i&&(t.layerInfo=i.data)});const l=await V.queryRelatedFeatures({graphic:e,relatedInfos:s,layer:o},i);Object.keys(l).forEach(e=>{V.setRelatedFeatures(l[e]?.value,s.get(e.toString()))})}_configureRelatedInfo(e,t){const{relatedInfos:i}=this,s=V.getRelatedFieldInfo(e.fieldName||"");if(!s)return;const{layerId:r,fieldName:o}=s;if(!r)return;const a=i.get(r.toString())||V.createRelatedInfo(r,t);a&&(V.updateRelatedInfo({relatedInfo:a,fieldName:o,fieldInfo:e}),this.relatedInfos.set(r,a))}},t.__decorate([f.property()],e.default.prototype,"_error",void 0),t.__decorate([f.property()],e.default.prototype,"_graphicChangedTask",void 0),t.__decorate([f.property()],e.default.prototype,"_evaluateExpressionAttributesTask",void 0),t.__decorate([f.property()],e.default.prototype,"_associationVMAbortController",void 0),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"_effectivePopupTemplate",null),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"_fieldInfoMap",null),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"_sourceLayer",null),t.__decorate([f.property()],e.default.prototype,"abilities",void 0),t.__decorate([_.cast("abilities")],e.default.prototype,"castAbilities",null),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"content",void 0),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"contentViewModels",void 0),t.__decorate([f.property()],e.default.prototype,"description",void 0),t.__decorate([f.property({type:Boolean})],e.default.prototype,"defaultPopupTemplateEnabled",void 0),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"isFeatureFromTable",null),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"state",null),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"formattedAttributes",void 0),t.__decorate([f.property({type:i,value:null})],e.default.prototype,"graphic",null),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"lastEditInfo",void 0),t.__decorate([f.property({type:g})],e.default.prototype,"location",void 0),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"relatedInfos",void 0),t.__decorate([f.property({type:b})],e.default.prototype,"spatialReference",null),t.__decorate([f.property()],e.default.prototype,"timeZone",null),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"title",void 0),t.__decorate([f.property()],e.default.prototype,"map",null),t.__decorate([f.property({readOnly:!0})],e.default.prototype,"waitingForContent",null),t.__decorate([f.property()],e.default.prototype,"view",void 0),e.default=R=t.__decorate([y.subclass("esri.widgets.Feature.FeatureViewModel")],e.default),e.default});