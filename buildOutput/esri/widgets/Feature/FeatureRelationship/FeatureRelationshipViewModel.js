// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../chunks/tslib.es6","../../../Graphic","../../../core/Accessor","../../../core/arrayUtils","../../../core/Clonable","../../../core/Collection","../../../core/Identifiable","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../rest/support/RelationshipQuery","../support/featureUtils","../../FeatureForm/featureFormUtils"],function(e,t,r,o,a,l,i,s,u,n,d,y,p,h,c,_,g,C){"use strict";const b=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function f(e){return null!=e&&""!==e}return t.default=class extends(i.ClonableMixin(u.IdentifiableMixin(a))){constructor(e){super(e),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.activeCategory=null,this.allCategories=null,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:e}=this;e&&e.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await n.ignoreAbortErrors(this._query()),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const e=new AbortController;this._queryFeatureCountAbortController=e,await n.ignoreAbortErrors(this._queryFeatureCount()),this._queryFeatureCountAbortController===e&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryPageController=async()=>{const e=new AbortController;this._queryPageAbortController=e,await n.ignoreAbortErrors(this._queryPage()),this._queryPageAbortController===e&&(this._queryPageAbortController=null)},this._queryDebounced=n.debounce(this._queryController,100),this._queryFeatureCountDebounced=n.debounce(this._queryFeatureCountController,100),this._queryPageDebounced=n.debounce(this._queryPageController,100),this._query=async()=>{const{_queryAbortController:e,relatedFeatures:t}=this;this.featureCount&&("subtype-group"!==this.relatedLayer?.type||this.activeCategory)&&(this._destroyRelatedFeatureViewModels(),this.featurePage=1,t.destroyAll(),this.destroyed||t.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:e?.signal}))))},this.addHandles([d.watch(()=>[this.displayCount,this.graphic,this.layer,this.layer?.loaded,this.map,this.orderByFields,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount,this.activeCategory],()=>this._queryDebounced(),d.initial),d.watch(()=>[this.featurePage,this.showAllEnabled],()=>this._queryPageDebounced()),d.watch(()=>[this.layer,this.relationshipId,this.objectId,this.canQuery,this.activeCategory],()=>this._queryFeatureCountDebounced())])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.destroyAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(e){const{featuresPerPage:t,featureCount:r}=this,o=Math.ceil(r/t)||1;this._set("featurePage",Math.min(Math.max(e,1),o))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:e,relatedLayer:t}=this;return e&&t?.loaded?e.map(e=>{const r=e.clone();return r.field=g.getFixedFieldName(e.field,t),r}):e??[]}get supportsCacheHint(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}get canLoad(){return!!this.map&&null!=this.relationshipId&&"number"==typeof this.objectId}get canQuery(){const e=this.layer?.capabilities?.queryRelated;return!!(this.relatedLayer&&this.relationship&&null!=this.relationshipId&&null!=this.objectId&&e?.supportsCount&&e?.supportsPagination)}get allCategoriesCount(){return this.allCategories?.length??0}get categories(){const{allCategories:e}=this;return this.showAllEnabled?e:e?.slice(0,this.displayCount)??null}set displayCount(e){this._set("displayCount",Math.min(Math.max(e??3,0),10))}get displayCount(){return this._get("displayCount")}get itemDescriptionFieldName(){return this.orderByFieldsFixedCasing[0]?.field||null}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get relatedFeatures(){return this._get("relatedFeatures")||new s}get relatedLayer(){const{layer:e,map:t,relationship:r}=this;if(!e?.loaded||!t||!r)return null;const o="subtype-sublayer"===e.type&&e.parent&&g.isRelatableFeatureSupportedLayer(e.parent)?e.parent:e;return g.findRelatedLayer(t,o,r)??null}get relatedLayerKeyField(){const{relatedLayer:e,relationshipId:t}=this;return e?.loaded&&null!=t?e.relationships?.find(e=>e.id===t)?.keyField:null}get relatedLayerKeyFields(){const{relatedLayer:e}=this;return e?.loaded?e.relationships?.map(e=>e.keyField).filter(l.isSome)??[]:[]}get relationship(){const{relationshipId:e,layer:t}=this;return null!=e&&t?.loaded?t.relationships?.find(({id:t})=>t===e)??null:null}get relationshipKey(){const{relationshipKeyField:e}=this;return(e&&this.graphic?.attributes?.[e])??null}get relationshipKeyField(){return this.relationship?.keyField||null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new s}get state(){const{_queryAbortController:e,_queryFeatureCountAbortController:t,_queryPageAbortController:r,canQuery:o,_loaded:a,canLoad:l}=this;return t||l&&!a?"loading":e||r?"querying":o?"ready":"disabled"}getRelatedFeatureByObjectId(e){return this.relatedFeatures.find(t=>t.getObjectId()===e)}refresh(){this._queryFeatureCountDebounced()}_destroyRelatedFeatureViewModels(){this.relatedFeatureViewModels?.destroyAll()}async _queryFeatureCount(){const{layer:t,relatedLayer:r}=this;await(t?.load()),await(r?.load());const{_queryFeatureCountAbortController:o,activeCategory:a,canQuery:i,objectId:s,relatedLayerKeyField:u,relationshipId:n,relationshipKey:d,supportsCacheHint:y}=this;if(!i||!t||!r||null==s)return this._set("featureCount",0),void this._set("allCategories",null);if("subtype-group"===r?.type&&!a){if(this._set("featureCount",0),this._destroyRelatedFeatureViewModels(),this.featurePage=1,this.relatedFeatures.destroyAll(),u&&null!=d){const{default:t}=await new Promise((t,r)=>e(["../../../smartMapping/statistics/uniqueValues"],e=>t(b(e)),r)),{uniqueValueInfos:a}=await t({layer:r,sqlWhere:`${u} = '${d}'`,field:r.subtypeField,signal:o?.signal}),i=a.map(({count:e,value:t})=>{const o=r.subtypes?.find(e=>e.code===t)?.name;return null!=t&&o?{count:e,value:t,name:o}:void 0}).filter(l.isSome);this._set("allCategories",i)}return}const{historicMoment:p,gdbVersion:h}=t,c=new _({cacheHint:y,gdbVersion:h,historicMoment:p,relationshipId:n,returnGeometry:!1,objectIds:[s],where:this._getRelationshipWhereClause(r)}),g=await t.queryRelatedFeaturesCount(c,{signal:o?.signal});this._set("allCategories",null),this._set("featureCount",g[s]||0)}_getRelationshipWhereClause(e){const{activeCategory:t}=this,r=e.createQuery(),o="subtypeField"in e?e.subtypeField:void 0,a=t&&o?`${o} = ${t.value}`:void 0,l=r.where;return l&&a?`(${l}) AND (${a})`:l??a}_sliceFeatures(e){const{showAllEnabled:t,displayCount:r}=this;return t?e:r?e.slice(0,r):[]}async _queryPage(){const{relatedFeatures:e,featurePage:t,showAllEnabled:r,_queryPageAbortController:o,featureCount:a}=this;!r||t<2||!a||"subtype-group"===this.relatedLayer?.type&&!this.activeCategory||e.addMany(await this._queryRelatedFeatures({signal:o?.signal}))}async _queryRelatedFeatures(e){const{displayCount:t,featureCount:r,featurePage:o,featuresPerPage:a,layer:l,orderByFieldsFixedCasing:i,relatedLayer:s,relatedLayerKeyFields:u,relationshipId:n,showAllEnabled:d,supportsCacheHint:y}=this,{canQuery:p,objectId:h}=this;if(!p||!l||!s||null==h)return[];const c=d?((o-1)*a+r)%r:0,g=d?a:t,b=s.objectIdField,F="subtypeField"in s?s.subtypeField:void 0,q=[...i.map(e=>e.field),...C.getFieldsInTitleAndDesc(s),...u,b,F].filter(f),A=i.map(e=>`${e.field} ${e.order}`),{historicMoment:w,gdbVersion:P}=l,m=new _({orderByFields:A,start:c,num:g,outFields:q,cacheHint:y,historicMoment:w,gdbVersion:P,relationshipId:n,returnGeometry:!1,objectIds:[h],where:this._getRelationshipWhereClause(s)}),v=await l.queryRelatedFeatures(m,{signal:e?.signal}),I=v[h]?.features||[];return"subtype-group"===s.type&&F?I.forEach(e=>{const t=e.attributes[F],r=s.findSublayerForSubtypeCode?.(t);e.sourceLayer=r,e.layer=r}):I.forEach(e=>{e.sourceLayer=s,e.layer=s}),I}},r.__decorate([y.property()],t.default.prototype,"_loaded",void 0),r.__decorate([y.property()],t.default.prototype,"_queryAbortController",void 0),r.__decorate([y.property()],t.default.prototype,"_queryPageAbortController",void 0),r.__decorate([y.property()],t.default.prototype,"_queryFeatureCountAbortController",void 0),r.__decorate([y.property({value:1})],t.default.prototype,"featurePage",null),r.__decorate([y.property()],t.default.prototype,"featuresPerPage",void 0),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"orderByFieldsFixedCasing",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"supportsCacheHint",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"canLoad",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"canQuery",null),r.__decorate([y.property()],t.default.prototype,"activeCategory",void 0),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"allCategories",void 0),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"allCategoriesCount",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"categories",null),r.__decorate([y.property()],t.default.prototype,"description",void 0),r.__decorate([y.property({value:3})],t.default.prototype,"displayCount",null),r.__decorate([y.property({type:o})],t.default.prototype,"graphic",void 0),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"itemDescriptionFieldName",null),r.__decorate([y.property()],t.default.prototype,"layer",void 0),r.__decorate([y.property()],t.default.prototype,"map",void 0),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"objectId",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"objectIdField",null),r.__decorate([y.property()],t.default.prototype,"orderByFields",void 0),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"relatedFeatures",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"relatedLayer",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"relatedLayerKeyField",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"relatedLayerKeyFields",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"relationship",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"relationshipKey",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"relationshipKeyField",null),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"featureCount",void 0),r.__decorate([y.property({readOnly:!0})],t.default.prototype,"relatedFeatureViewModels",null),r.__decorate([y.property()],t.default.prototype,"relationshipId",void 0),r.__decorate([y.property()],t.default.prototype,"showAllEnabled",void 0),r.__decorate([y.property()],t.default.prototype,"state",null),r.__decorate([y.property()],t.default.prototype,"title",void 0),t.default=r.__decorate([c.subclass("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],t.default),t.default});