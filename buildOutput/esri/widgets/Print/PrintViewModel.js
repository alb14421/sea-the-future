// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/arrayUtils","../../core/Collection","../../core/Error","../../core/Evented","../../core/lang","../../core/Loadable","../../core/Promise","../../core/ReactiveMap","../../core/reactiveUtils","../../core/screenUtils","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/subclass","../../geometry/Extent","../../geometry/SpatialReference","../../intl/date","../../intl/locale","../../portal/Portal","../../portal/PortalQueryParams","../../portal/support/urlUtils","../../rest/print","../../rest/support/fileFormat","../../rest/support/layoutTemplate","../../rest/support/PrintParameters","../../rest/support/PrintTemplate","../../views/2d/viewpointUtils","../../views/input/InputManager","../../views/overlay/BoxOverlayItem","./CustomTemplate","./FileLink","./TemplateOptions","./utils"],function(t,e,a,o,i,s,r,l,n,p,h,d,m,u,c,y,f,T,v,_,w,I,g,x,O,b,E,S,P,L,U,k,C,F,M){"use strict";const H=[30,144,255,255],D=[237,211,23,255],A=[216,48,32,255],N=new Set(["GISProfessionalStdUT","GISProfessionalAdvUT"]),R=/(\/GPServer\/).+/i,W=a.ofType(k),J=a.ofType(C);function V(t,e,a){e&&e.visible!==a&&t.layoutOptions&&(t.layoutOptions.elementOverrides?t.layoutOptions.elementOverrides[e.name]={visible:a}:t.layoutOptions.elementOverrides={[e.name]:{visible:a}})}let z=class extends(r.LoadableMixin(l.EsriPromiseMixin(i.EventedAccessor))){constructor(t){super(t),this._serviceTemplateCustomTextElements=null,this._templateIdToCustomTemplate=new n,this._isFreeHand=!1,this._freeHandWidth=0,this._freehandHeight=0,this._asyncPrintTaskUrl=null,this._layoutInfoTaskUrl=null,this._portalLayoutInfoTaskUrl=null,this._customLayoutOptions=null,this._exportedFileNameMap={},this._layoutTemplateInfosCache=new Map,this._tasksInfoCache=new Map,this.allowedFormats="all",this.allowedLayouts="all",this.browseTemplates=new W,this.defaultTemplates=new W,this.error=null,this.exportedLinks=new J,this.extraParameters=null,this.includeDefaultTemplates=!0,this.outSpatialReference=null,this.portal=w.getDefault(),this.portalTemplateIds=[],this.printServiceTemplates=new W,this.defaultTemplate=null,this.showPrintAreaEnabled=!1,this.printServiceUrl=null,this.printTimeout=12e4,this.saveExportEnabled=!1,this.templatesInfo=null,this.updateDelay=1e3,this.view=null,this.templateCustomTextElements=null,this.templateOptions=new F}initialize(){this.addHandles([p.watch(()=>[this.showPrintAreaEnabled,this.view],()=>{this.showPrintAreaEnabled?this._enablePrintPreview():(this.removeHandles("overlay-handler"),this.view?.overlay?.removeItem(this._getOverlayItem()))}),p.watch(()=>[this.templateOptions.layout,this.templateOptions.layoutItem],()=>{this.loaded&&this._processTemplateOptions()}),p.watch(()=>[this.allowedFormats,this.allowedLayouts],()=>{this.loaded&&this._loadTemplateInfos()}),p.watch(()=>this.exportedLinks,()=>{for(const{name:t,extension:e}of this.exportedLinks)t&&e&&this._updateExportedFileNameMap(`${t}${e}`)},p.initial)])}destroy(){this.removeHandles("overlay-handler"),this.view&&(this._overlayItem&&(this.view.overlay?.removeItem(this._overlayItem),this._overlayItem.destroy(),this._overlayItem=null),this.view=null)}get effectivePrintServiceUrl(){return this.printServiceUrl??null}get effectiveTemplateCustomTextElements(){if(!this._serviceTemplateCustomTextElements)return{};const t=s.clone(this._serviceTemplateCustomTextElements);return this.templateCustomTextElements&&Object.keys(this.templateCustomTextElements).forEach(e=>{const a=t[e];if(a){const t=this.templateCustomTextElements?.[e];a.forEach(e=>{const[a]=Object.entries(e)[0];t?.forEach(t=>{const[o,i]=Object.entries(t)[0];a===o&&(e[a]=i)})})}}),Object.freeze(t)}get state(){return"loading"===this.loadStatus?"initializing":"failed"===this.loadStatus||this.error?"error":"loaded"===this.loadStatus&&this.view?.ready?"ready":"disabled"}async load(t){return this.addResolvingPromise(this._loadResources(t).catch(t=>this.error=t)),this}async print(t){const{view:e,extraParameters:a,updateDelay:i,outSpatialReference:s}=this;if(!e)throw new o("print:view-required","view is not set");!function(t){if(t.layoutOptions??={},t.layoutOptions.customTextElements??=[],!t.layoutOptions.customTextElements.find(t=>"date"in t)){const{customTextElements:e}=t.layoutOptions;let a=v.formatDate(Date.now(),v.convertDateFormatToIntlOptions("short-date"));"ar"===_.getLocaleLanguage()&&(a="‏"+a),e.push({date:a})}}(t);const r=this._getOverlayItem(),l=t.scalePreserved||!this.showPrintAreaEnabled?void 0:P.getExtent(new f,e.viewpoint,"map-only"===t.layout?[t.exportOptions.width,t.exportOptions.height]:[r.boxWidth,r.boxHeight]),n=new E({view:e,template:t,extent:l,extraParameters:a,updateDelay:i,outSpatialReference:s});try{const e=!!t.layoutItem?.id&&(this.portalTemplateIds.includes(t.layoutItem.id)||this.browseTemplates.some(e=>e.layoutItem?.id===t.layoutItem?.id));return await x.execute(e&&this._asyncPrintTaskUrl?this._asyncPrintTaskUrl:this.effectivePrintServiceUrl,n,{timeout:this.printTimeout})}catch(t){throw new o("print:export-error","An error occurred while exporting the web map.",{error:t})}}toPrintTemplate({attributionEnabled:t,author:e,copyright:a,customTextElements:i,dpi:s,forceFeatureAttributes:r,format:l,height:n,id:p,includeTables:h,layout:d,layoutItem:m,legendEnabled:u,northArrowEnabled:c,scale:y,scaleBarEnabled:f,scaleEnabled:T,title:v,width:_}){if(!d&&!m)throw new o("print:layout-required","layout is not set");const w=new S({attributionVisible:t,forceFeatureAttributes:r,format:l,includeTables:h,layout:d,layoutItem:m,layoutOptions:{authorText:e||"",copyrightText:a||"",customTextElements:i,titleText:v||""},outScale:y??0,scalePreserved:T});if(_&&(w.exportOptions.width=_),n&&(w.exportOptions.height=n),s&&(w.exportOptions.dpi=s),w.layoutOptions){u||(w.layoutOptions.legendLayers=[]);const t=this.getLayoutTemplateById(p)?.mapSurroundInfoOptions;if(t){const e=t.northArrow;for(const t of e)V(w,t,c);const a=t.scaleBar;for(const t of a)V(w,t,f);const o=t.legend;for(const t of o)V(w,t,u)}}return w}getLayoutTemplateById(t){return t?this._templateIdToCustomTemplate.get(t):null}async addPortalTemplate(t){if(!this.portal||!t?.id)return;try{t.loaded||await t.load()}catch{return void this.applyTemplate(this.defaultTemplate)}const e=new k({type:"browse-template",layoutInfoTaskUrl:this._portalLayoutInfoTaskUrl,label:t.title,layoutItem:t});this._templateIdToCustomTemplate.set(e.id,e),this.browseTemplates.add(e)}removePortalTemplate(t){t.layoutItem&&this.templateOptions.id===t.layoutItem.id&&(this.defaultTemplate?this.applyTemplate(this.defaultTemplate):this.templateOptions.reset()),this.browseTemplates.remove(t),this._templateIdToCustomTemplate.delete(t.id)}async applyTemplate(t){if(t&&t===this.getLayoutTemplateById(this.templateOptions.id))return;if(this.templateOptions.reset(),!t)return;if("map-only"===t)return void(this.templateOptions.layout="map-only");!t.layout||!this.templatesInfo||this.templatesInfo.layout.choiceList.includes(t.layout)||(this.defaultTemplate?t=this.defaultTemplate:this.templateOptions.reset());const e=t.layout||t.layoutItem?.id,a=e?this.templateCustomTextElements?.[e]:void 0;if(await this.templateOptions.applyTemplate(t,{customTextElements:a,customLayoutOptions:this._customLayoutOptions}),e&&this._serviceTemplateCustomTextElements&&!this._serviceTemplateCustomTextElements[e]&&t.layoutTemplateInfo?.layoutOptions?.customTextElements){const a=s.clone(this._serviceTemplateCustomTextElements);a[e]=t.layoutTemplateInfo.layoutOptions.customTextElements,this._serviceTemplateCustomTextElements=Object.freeze(a)}}createExportedFileLink(t){const e=this.toPrintTemplate(this.templateOptions).format.toLowerCase(),a=e.includes("png")?"png":e,o=t+a;return this._updateExportedFileNameMap(o),new C({name:t,extension:a,count:this._exportedFileNameMap[o]})}export(t){const e=this.createExportedFileLink(t);this.exportedLinks.add(e);const a=this.print(this.toPrintTemplate(this.templateOptions)).then(t=>e.set({url:t?.url,state:"ready"})).catch(t=>e.set({error:t,state:"error"}));return this.emit("submit",{link:e,saveExportEnabled:this.saveExportEnabled}),a.then(t=>this.emit("complete",{link:t,saveExportEnabled:this.saveExportEnabled})),{link:e,promise:a}}async _loadResources(t){this.destroyed||(await this._loadUrls(t),await this._loadTemplateInfos(t),this._updateOverLayItem())}async _loadTemplateInfos(t){const e=[...this.defaultTemplates,...this.printServiceTemplates];for(const{id:t}of e)this._templateIdToCustomTemplate.delete(t);this.defaultTemplates.removeAll(),this.printServiceTemplates.removeAll();const[a,o]=await Promise.all([this._getLayoutToLayoutTemplateInfos(t),this._getPrintServiceTemplatesInfo(t)]);await this._loadAllTemplates(a,o,t),this._processPrintServiceTemplatesInfo(o),await this._processTemplateOptions()}_updateExportedFileNameMap(t){void 0!==this._exportedFileNameMap[t]?this._exportedFileNameMap[t]++:this._exportedFileNameMap[t]=0}async _processTemplateOptions(){const{layout:t,layoutItem:e}=this.templateOptions;if("map-only"!==t)if(this._customLayoutOptions={legend:this.templateOptions.legendEnabled,northArrow:this.templateOptions.northArrowEnabled,scaleBar:this.templateOptions.scaleBarEnabled},e?.id){try{e.loaded||await e.load()}catch{return void this.applyTemplate(this.defaultTemplate)}let t=this._templateIdToCustomTemplate.get(e.id);t||(t=new k({label:e.title,layoutItem:e,layoutInfoTaskUrl:this._portalLayoutInfoTaskUrl}),this._templateIdToCustomTemplate.set(t.id,t)),await this.applyTemplate(t)}else if(t){const t=this.defaultTemplates.find(t=>t.layout===this.templateOptions.layout)??this.printServiceTemplates.find(t=>t.layout===this.templateOptions.layout);await this.applyTemplate(t??this.defaultTemplate)}}async _loadPortal(t){try{await this.portal.load(t)}catch(t){throw new o("print:could-not-load-portal","Cannot load print resource information from portal",{error:t,url:this.effectivePrintServiceUrl})}}async _loadUrls(t){if(this.printServiceUrl)this._set("effectivePrintServiceUrl",this.printServiceUrl),this._layoutInfoTaskUrl=await this._getLayoutInfoTaskUrl(this.effectivePrintServiceUrl,t);else{await this._loadPortal(t);const{printTask:e,asyncPrintTask:a,layoutInfoTask:o}=this.portal?.helperServices??{};this._set("effectivePrintServiceUrl",e?.url),this._asyncPrintTaskUrl=a?.url,this._layoutInfoTaskUrl=await this._getLayoutInfoTaskUrl(this.effectivePrintServiceUrl,t),o?.url&&this.effectivePrintServiceUrl!==o.url?this._portalLayoutInfoTaskUrl=await this._getLayoutInfoTaskUrl(o.url,t):this._portalLayoutInfoTaskUrl=this._layoutInfoTaskUrl}const e=this.effectivePrintServiceUrl?.toLowerCase().split("/");if(!e?.includes("gpserver"))throw new o("print:invalid-print-service-url","Can't fetch print templates information from provided URL",{url:this.effectivePrintServiceUrl})}async _getLayoutInfoTaskUrl(t,e){if(!t)return null;const a=await x.getTaskInfo(t,"GetLayoutTemplatesInfo",e);return a?t.replace(R,`$1${encodeURI(a.displayName)}`):null}_getPortalDefaultTemplates(t,e){return this.portal?.helperServices?.printTask?.templates?.filter(t=>"map_only"!==t.layout.toLowerCase()&&(!e||e.includes(b.fromJSON(t.layout))))?.map(e=>{const a=k.fromJSON(e);if(a.type="default-template",a.layoutInfoTaskUrl=this._layoutInfoTaskUrl,a.layout){const e=t.get(a.layout);e&&a.setLayoutTemplateInfo(e)}return a})??[]}async _getPortalCustomTemplates(t){if(this.printServiceUrl||!this.portal)return[];const{layoutGroupQuery:e,user:a}=this.portal,o=g.reArcGISOnlineDomain.test(this.portal.url),i=a?.userLicenseTypeId,s=i&&N.has(i);if(!e||o&&!s)return[];const r=new I({query:e,disableExtraQuery:!0}),l=await this.portal.queryGroups(r,t);if(!l.total)return[];const n=l.results[0],p=new I({num:100,query:"type:Layout",sortField:n.sortField,sortOrder:n.sortOrder??void 0}),h=(await n.queryItems(p,t)).results;return h.length?h.map(t=>(this.portalTemplateIds.push(t.id),new k({type:"default-template",label:t.title,layoutItem:t,layoutInfoTaskUrl:this._portalLayoutInfoTaskUrl}))):[]}async _loadAllTemplates(t,e,a){let o=!1;const i=e?.layout?.choiceList;if(this.includeDefaultTemplates&&this.portal&&!this.printServiceUrl){const e=this._getPortalDefaultTemplates(t,i);o=!!e.length,this.defaultTemplates.addMany(e);const s=await this._getPortalCustomTemplates(a);this.defaultTemplates.addMany(s);for(const t of this.defaultTemplates)this._templateIdToCustomTemplate.set(t.id,t)}o||t.forEach((t,e)=>{if(!i||i.includes(e)){const a=new k({type:"print-service-template",layout:e,layoutInfoTaskUrl:this._layoutInfoTaskUrl});a.setLayoutTemplateInfo(t),this.printServiceTemplates.add(a),this._templateIdToCustomTemplate.set(a.id,a)}})}_processPrintServiceTemplatesInfo(t){this._set("templatesInfo",t);const e=t?.layout?.defaultValue;if(e&&"map-only"!==e){const t=this.defaultTemplates.find(t=>t.layout===e)??this.printServiceTemplates.find(t=>t.layout===e)??this.defaultTemplates.at(0)??this.printServiceTemplates.at(0);this._set("defaultTemplate",t)}}async _getLayoutToLayoutTemplateInfos(t){const e=this._layoutInfoTaskUrl,a=e?this._layoutTemplateInfosCache.get(e):void 0,o=a??await M.fetchLayoutTemplateInfos(e,void 0,t);a||this._layoutTemplateInfosCache.set(e,o);const i=new Map,s={};for(const t of o){const e=b.fromJSON(t.layoutTemplate);i.set(e,t),s[e]=t.layoutOptions.customTextElements}return this._serviceTemplateCustomTextElements=Object.freeze(s),i}async _getPrintServiceTemplatesInfo(t){const e=this.effectivePrintServiceUrl?this._tasksInfoCache.get(this.effectivePrintServiceUrl):void 0,a=e??await x.getTaskInfo(this.effectivePrintServiceUrl,"ExportWebMap",t);if(!a)throw new o("print:unavailable-service-info","Can't fetch templates info from service");e||this._tasksInfoCache.set(this.effectivePrintServiceUrl,a);const{parameters:i}=a,s=i.find(({name:t})=>"Format"===t),r=i.find(({name:t})=>"Layout_Template"===t);return{format:this._getFormat(s),layout:this._getLayout(r)}}_getFormat(t){const a="all"===this.allowedFormats?t.choiceList:t.choiceList.filter(t=>"string"!=typeof this.allowedFormats&&this.allowedFormats.some(e=>new RegExp(`\\b${e}\\b`,"i").test(t))),o=(a.length?a:t.choiceList).map(t=>O.formatJsonMap.fromJSON(t)).filter(e.isSome),i=O.formatJsonMap.fromJSON(t.defaultValue),s=o.some(t=>new RegExp(`\\b${i}\\b`,"i").test(t))?i:o[0];return{choiceList:o,defaultValue:s}}_getLayout(t){const a=t.choiceList.filter(t=>"map_only"!==t.toLowerCase()),o="all"===this.allowedLayouts?a:a.filter(t=>this.allowedLayouts.includes(b.fromJSON(t))),i=(o.length?o:a).map(b.fromJSON).filter(e.isSome),s=b.fromJSON(t.defaultValue),r=i.includes(s)?s:i.find(t=>/(?=.*letter)(?=.*landscape)/i.test(t))??i.find(t=>/(?=.*a4)(?=.*landscape)/i.test(t))??i[0];return{choiceList:i,defaultValue:r}}_getOverlayItem(){return this._overlayItem||(this._overlayItem=new U({strokeDash:[5],strokeWidth:2,strokeColor:[30,144,255,255]})),this._overlayItem}_enablePrintPreview(){if(!this.view?.overlay)return;const t=this.templateOptions,e=this._getOverlayItem();this.addHandles([p.watch(()=>[t.width,t.height,t.scaleEnabled,t.scale,t.layout,t.layoutItem,t.id,t.state,t.dpi,this.view?.scale,this.view?.size,this.view?.state.paddedViewState.size,this.view?.state.padding,this.loaded],()=>this._updateOverLayItem(),p.initial),this.view?.on("drag",["Shift"],t=>this._handleDrag(t),L.ViewEventPriorities.WIDGET),this.view?.on("key-down",["Escape"],()=>this._resetDrag(),L.ViewEventPriorities.WIDGET)],"overlay-handler"),this.view.overlay.addItem(e)}_updateOverLayItem(){if(!this.view)return;const t=this.templateOptions,e=this._getOverlayItem(),a=t.layoutItem?.id??t.layout,o=this.view,i=o.spatialReference,[s,r]=o.state.paddedViewState.size,l=o.state.padding;let n=0,p=0;if("map-only"===a)null!=t.width&&null!=t.height&&(n=t.width,p=t.height);else if(a){const e=t.id?this._templateIdToCustomTemplate.get(t.id):null,{webMapFrameSize:a,pageUnits:o}=e?.layoutTemplateInfo??{};let l=!1;if(a&&o)if(this._isFreeHand){const t=a[0]/a[1];n=this._freeHandWidth,p=this._freehandHeight,n>p?p=n/t:n=p*t}else{const t=M.valueUnitKebabDict.fromJSON(o.toLowerCase()),e=i.unit;d.unitType(t)===d.unitType(e)?(n=d.convertUnit(a[0],t,e),p=d.convertUnit(a[1],t,e)):(l=!0,n=a[0],p=a[1])}if(!this._isFreeHand)if(t.scaleEnabled&&t.scale){const e=l?Math.min(s/n,r/p):d.getMetersPerUnitForSR(i)*d.inchesPerMeter*t.dpi;n*=e,p*=e}else if(0===n||0===p)n=s,p=r;else{const t=(s-.1*s)/n,e=(r-.1*r)/p,a=Math.min(t,e);n*=a,p*=a}}const{scaleEnabled:h,scale:m}=t,u=h&&m?m/this.view.scale:1,c=h&&m?96/t.dpi:1;if(e.boxWidth=n*u*c||s,e.boxHeight=p*u*c||r,l&&(e.padding=l),e.backgroundWidth=s??0,e.backgroundHeight=r??0,"loading"===this.loadStatus)e.strokeColor=D;else if("loaded"===this.loadStatus)switch(this.templateOptions.state){case"pending":e.strokeColor=D;break;case"ready":e.strokeColor=H;break;case"error":e.strokeColor=A}}_resetDrag(){this._isFreeHand=!1,this._updateOverLayItem()}_handleDrag(t){switch(t.action){case"start":this._start();break;case"update":this._update(t);break;case"end":this._end()}t.stopPropagation()}_start(){this._isFreeHand=!0}_update(t){const e=this._getOverlayItem(),{x:a,y:o}=t,{x:i,y:s}=t.origin;a>i?(e.x=i,e.boxWidth=a-i):(e.x=a,e.boxWidth=i-a),o>s?(e.y=s,e.boxHeight=o-s):(e.y=o,e.boxHeight=s-o)}_end(){const t=this._getOverlayItem();if(!this.view||null==t.x||null==t.y)return;const e=this.view,a=e.toMap(h.createScreenPoint(t.x+.5*t.boxWidth,t.y+.5*t.boxHeight));t.x=null,t.y=null,e.goTo({center:a}),this._freeHandWidth=t.boxWidth,this._freehandHeight=t.boxHeight,"map-only"===this.templateOptions.layout&&(this.templateOptions.width=this._freeHandWidth,this.templateOptions.height=this._freehandHeight),this.templateOptions.scale=this.view.scale,this._updateOverLayItem()}};return t.__decorate([m.property()],z.prototype,"_serviceTemplateCustomTextElements",void 0),t.__decorate([m.property()],z.prototype,"_templateIdToCustomTemplate",void 0),t.__decorate([m.property()],z.prototype,"allowedFormats",void 0),t.__decorate([m.property()],z.prototype,"allowedLayouts",void 0),t.__decorate([m.property({type:W})],z.prototype,"browseTemplates",void 0),t.__decorate([m.property({type:W})],z.prototype,"defaultTemplates",void 0),t.__decorate([m.property()],z.prototype,"error",void 0),t.__decorate([m.property({type:J})],z.prototype,"exportedLinks",void 0),t.__decorate([m.property()],z.prototype,"extraParameters",void 0),t.__decorate([m.property()],z.prototype,"includeDefaultTemplates",void 0),t.__decorate([m.property({readOnly:!0})],z.prototype,"effectivePrintServiceUrl",null),t.__decorate([m.property()],z.prototype,"effectiveTemplateCustomTextElements",null),t.__decorate([m.property({type:T})],z.prototype,"outSpatialReference",void 0),t.__decorate([m.property({type:w})],z.prototype,"portal",void 0),t.__decorate([m.property()],z.prototype,"portalTemplateIds",void 0),t.__decorate([m.property({type:W})],z.prototype,"printServiceTemplates",void 0),t.__decorate([m.property({readOnly:!0})],z.prototype,"defaultTemplate",void 0),t.__decorate([m.property()],z.prototype,"showPrintAreaEnabled",void 0),t.__decorate([m.property()],z.prototype,"printServiceUrl",void 0),t.__decorate([m.property()],z.prototype,"printTimeout",void 0),t.__decorate([m.property()],z.prototype,"saveExportEnabled",void 0),t.__decorate([m.property({readOnly:!0})],z.prototype,"state",null),t.__decorate([m.property({readOnly:!0})],z.prototype,"templatesInfo",void 0),t.__decorate([m.property()],z.prototype,"updateDelay",void 0),t.__decorate([m.property()],z.prototype,"view",void 0),t.__decorate([m.property()],z.prototype,"templateCustomTextElements",void 0),t.__decorate([m.property({type:F})],z.prototype,"templateOptions",void 0),z=t.__decorate([y.subclass("esri.widgets.Print.PrintViewModel")],z),z});