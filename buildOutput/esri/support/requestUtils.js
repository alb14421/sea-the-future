// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../config","../core/has","../core/promiseUtils","../core/urlUtils","../layers/support/arcgisLayerUrl","../portal/support/urlUtils"],function(e,r,t,o,n,s,i){"use strict";function c(){try{return new DOMException("Aborted","AbortError")}catch{const e=new Error;return e.name="AbortError",e}}const a="Timeout exceeded",u=new Map;e.createTimeoutError=function(){return new Error(a)},e.getPreferredUrl=function(e){const r=s.parse(e)?.url.path.toLowerCase();if(!r)return e;const t=u.get(r);return t?n.changeHost(e,t):e},e.isNoCorsRequestRequired=function(e){const t=r.request.crossOriginNoCorsDomains;if(t){let r=n.getOrigin(e);if(r)return r=r.toLowerCase(),!n.hasSameOrigin(r,n.getAppUrl())&&t[r]<Date.now()-36e5}return!1},e.isTimeoutError=function(e){return"object"==typeof e&&!!e&&"message"in e&&e.message===a},e.loadImageAsync=function(e,r,n=!1,s){return new Promise((i,a)=>{if(o.isAborted(s))return void a(c());let u=()=>{g(),a(new Error(`Unable to load ${r}`))},l=()=>{const r=e;g(),i(r)},d=()=>{if(!e)return;const r=e;g(),r.src="",a(c())};const g=()=>{t("esri-image-decode")||(e.removeEventListener("error",u),e.removeEventListener("load",l)),u=null,l=null,e=null,null!=s&&s.removeEventListener("abort",d),d=null,n&&URL.revokeObjectURL(r)};null!=s&&s.addEventListener("abort",d),t("esri-image-decode")?e.decode().then(l,u):(e.addEventListener("error",u),e.addEventListener("load",l))})},e.preferredHosts=u,e.registerNoCorsDomains=function(e){r.request.crossOriginNoCorsDomains||(r.request.crossOriginNoCorsDomains={});const t=r.request.crossOriginNoCorsDomains;for(let r of e)r=r.toLowerCase(),/^https?:\/\//.test(r)?t[n.getOrigin(r)??""]=0:(t[n.getOrigin("http://"+r)??""]=0,t[n.getOrigin("https://"+r)??""]=0)},e.sendNoCorsRequest=async function(e){const t=n.urlToObject(e);e=t.path,"json"===t.query?.f&&(e+="?f=json");try{await fetch(e,{mode:"no-cors",credentials:"include"})}catch{}const o=r.request.crossOriginNoCorsDomains,s=n.getOrigin(e);o&&s&&(o[s.toLowerCase()]=Date.now())},e.setPreferredHost=function(e,r){const t=r?.preferredHost;if(!t||n.hasSameOrigin(e,`https://${t}`,!0))return;const o=s.parse(e);if(!o||"FeatureServer"!==o.serverType||i.isSecureProxyService(e))return;const c=o.url.path.toLowerCase();u.has(c)||u.set(c,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});