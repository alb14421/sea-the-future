// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../chunks/tslib.es6","../core/JSONSupport","../core/lang","../core/SetUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","./ExpressionInfo","./elements/GroupElement","./support/formUtils","../layers/support/fieldUtils"],function(e,t,s,r,o,n,i,l,p,c,a,d,u){"use strict";var f;const m=d.buildTypeMaps(a);let y=f=class extends t.JSONSupport{constructor(e){super(e),this.description=null,this.elements=null,this.expressionInfos=null,this.preserveFieldValuesWhenHidden=!1,this.title=null}castElements(e){return d.ensureType(e,m)}readElements(e,t){return d.fromJSON(t.formElements,m)}writeElements(e,t){t.formElements=d.toJSON(e,m)}clone(){return new f({description:this.description,expressionInfos:s.clone(this.expressionInfos),elements:s.clone(this.elements),title:this.title,preserveFieldValuesWhenHidden:this.preserveFieldValuesWhenHidden})}async getFieldsUsed(e,t){const s=new Set,{description:r,elements:o,expressionInfos:n,title:i}=this;if(x(s,e,r),x(s,e,i),!o)return[];const l=function(e,t){if(!t||0===t.length)return[];const s=E(e),r=[];for(const e of t)s.has(e.name)&&r.push(e.expression);return r}(o,n).map(t=>u.collectArcadeFieldNames(s,e,t));await Promise.all(l);for(const r of o)h(s,{fieldsIndex:e,relationships:t},r);return Array.from(s).sort()}};function h(e,t,s){const{fieldsIndex:r}=t;if(!r||r.fields.length!==e.size)switch(x(e,r,s.label),x(e,r,s.description),s.type){case"field":u.collectField(e,r,s.fieldName);break;case"group":s.elements.forEach(s=>h(e,t,s));break;case"relationship":if(t.relationships){const o=t.relationships.find(e=>e.id===s.relationshipId);o&&u.collectField(e,r,o.keyField)}u.collectFields(e,r,s.orderByFields?.map(e=>e.field));break;case"text":x(e,r,s.text)}}function E(e){const t=new Set;for(const s of e)if(r.addMaybe(t,s.visibilityExpression),!d.isTextElement(s))if(d.isGroupElement(s))r.addMany(t,E(s.elements));else if(r.addMaybe(t,s.editableExpression),d.isFieldElement(s)){const{requiredExpression:e,valueExpression:o}=s;r.addMany(t,[e,o])}return t}function x(e,t,s){u.collectFields(e,t,u.extractSubstitutionTemplatesFromString(s))}return e.__decorate([o.property({type:String,json:{write:!0}})],y.prototype,"description",void 0),e.__decorate([o.property({json:{write:!0}})],y.prototype,"elements",void 0),e.__decorate([n.cast("elements")],y.prototype,"castElements",null),e.__decorate([i.reader("elements",["formElements"])],y.prototype,"readElements",null),e.__decorate([p.writer("elements")],y.prototype,"writeElements",null),e.__decorate([o.property({type:[c],json:{write:!0}})],y.prototype,"expressionInfos",void 0),e.__decorate([o.property({type:Boolean,json:{default:!1,write:!0}})],y.prototype,"preserveFieldValuesWhenHidden",void 0),e.__decorate([o.property({type:String,json:{write:!0}})],y.prototype,"title",void 0),y=f=e.__decorate([l.subclass("esri.form.FormTemplate")],y),y});