// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../request","../../core/Error","../../layers/support/featureQueryAll","../../layers/support/layerUtils","../../portal/PortalItem","../../rest/support/FeatureSet","../../support/guards"],function(e,t,r,n,a,l,o,u,s){"use strict";const i=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function c(e,t,r,n,a,l){if(!r||!n)return!1;const o=y(e,r,l),u=y(t,n,l);if(a){const a=y(e,n,l),s=y(t,r,l);return o&&u||a&&s}return o&&u}function p(e,t){const r=e.terminal?.terminalId,n=t.terminalId;return null==r&&null==n||(1===r?null==n||1===n:r===n)}function y(e,t,r){const{assetGroupCode:n,assetTypeCode:a}=e;return("layerId"in e?e.layerId===t.networkSource?.layerId:e.networkSourceId===t.networkSource?.sourceId)&&(null==n||n===t.assetGroup?.assetGroupCode)&&(null==a||a===t.assetType?.assetTypeCode)&&(!r||!("terminalId"in e)||p(t,e))}function d(e){return{fromRuleElement:{networkSource:e.fromNetworkSource,assetGroup:e.fromAssetGroup,assetType:e.fromAssetType,terminal:e.fromTerminal},viaRuleElement:e.viaNetworkSource?{networkSource:e.viaNetworkSource,assetGroup:e.viaAssetGroup,assetType:e.viaAssetType,terminal:e.viaTerminal}:void 0,toRuleElement:{networkSource:e.toNetworkSource,assetGroup:e.toAssetGroup,assetType:e.toAssetType,terminal:e.toTerminal}}}function m(e){const{sourceLayer:t}=e;let r;return l.isFeatureLayer(t)?r=t.layerId:l.isSubtypeSublayer(t)&&(r=t.parent?.layerId),r??null}function f(e){const[t,r]=w(e.sourceLayer);return[t?e.attributes[t]:null,r?e.attributes[r]:null]}function w(e){return e&&"fieldsIndex"in e?[e.fieldsIndex.normalizeFieldName("assetGroup")??null,e.fieldsIndex.normalizeFieldName("assetType")??null]:[null,null]}async function I(t,r){if("Utility Network Layer"===t){const{default:t}=await new Promise((t,r)=>e(["../UtilityNetwork"],e=>t(i(e)),r));return new t({layerUrl:r})}return null}t.doElementsMatchRule=c,t.doesRuleAllowAssociation=function(e,t,r){const{fromRuleElement:n,viaRuleElement:a,toRuleElement:l}=d(e);switch(e.ruleType){case 2:case 3:return c(t,r,n,l,!1,!1);case 4:case 1:return c(t,r,n,l,!0,!0);case 5:return c(t,r,n,a,!0,!0)||c(t,r,l,a,!0,!0);default:return!1}},t.getAssetFieldNames=w,t.getCompatibleRuleElements=function(e,t,r="from"){const{fromRuleElement:n,viaRuleElement:a,toRuleElement:l}=d(e),o=[];switch(e.ruleType){case 2:case 3:"from"===r&&y(t,n,!1)?o.push(l):"to"===r&&y(t,l,!1)&&o.push(n);break;case 4:case 1:y(t,n,!0)?o.push(l):y(t,l,!0)&&o.push(n);break;case 5:a&&(y(t,a,!0)?(o.push(n),o.push(l)):(y(t,n,!0)||y(t,l,!0))&&o.push(a));break;default:return[]}return o},t.getElementsFromRule=d,t.getFeatureAssetCodes=f,t.getFeatureSourceLayerId=m,t.getFeaturesFromLayers=async function(e,t){const r=e.layers,n=e.layerInfos,l=e.returnGeometry||!1,o=e.outSpatialReference;return await Promise.all(r.map(async e=>{await e.load()})),(await Promise.all(r.map(async e=>{const r=n.find(t=>t.layerUrl===e.parsedUrl?.path);if(!r?.objectIds?.length)return{layer:e,featureSet:void 0};const s=e.createQuery();s.returnGeometry=l,s.outFields=r.outFields||["*"],s.outSpatialReference=o,s.gdbVersion=e.gdbVersion,s.objectIds=r.objectIds,t&&(s.where="1=1");const i=u.fromJSON(await a.queryAllJSON(e,s));return i.features.forEach(t=>{t.layer=t.sourceLayer=e}),{layer:e,featureSet:i}}))).filter(e=>void 0!==e.featureSet)},t.getRuleValues=function(e){let t=null,r=null,n=null;if(s.isGraphic(e))t=m(e),[r,n]=f(e);else if(l.isSubtypeSublayer(e)){t=e.parent?.layerId??null;const[n]=w(e);n===e.subtypeField&&(r=e.subtypeCode)}else t=e.layerId??null;return{layerId:t,assetGroupCode:r,assetTypeCode:n}},t.isRuleElementMatch=y,t.isTerminalMatch=p,t.networkFromPortalItem=async function(e){let t="portalItem"in e?e:{portalItem:e};!t.portalItem||t.portalItem instanceof o||(t={...t,portalItem:new o(t.portalItem)});const a=t.portalItem;if(await a.load(),"Feature Service"!==a.type)throw new n("portal:unknown-item-type","Unknown item type '${type}'",{type:a.type});const l=a.url,u=await r(l,{responseType:"json",query:{f:"json"}}),s="Network Layer";if(u.data.type?.includes(s))return I(u.data.type,l);if(u.data.layers){const e=u.data.layers.find(e=>e.type.includes(s));if(e){const t=`${l}/${e.id}`;return I(e.type,t)}}return null},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});