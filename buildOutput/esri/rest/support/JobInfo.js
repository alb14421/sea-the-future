// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../chunks/tslib.es6","../../request","../../core/has","../../core/jsonMap","../../core/JSONSupport","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","../utils","../geoprocessor/GPOptions","../geoprocessor/utils","./GPMessage"],function(e,t,o,s,r,a,i,c,n,l,u,b,d,p,m,h,j){"use strict";const g=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));var J;const f=a.strict()({esriJobCancelled:"job-cancelled",esriJobCancelling:"job-cancelling",esriJobDeleted:"job-deleted",esriJobDeleting:"job-deleting",esriJobTimedOut:"job-timed-out",esriJobExecuting:"job-executing",esriJobFailed:"job-failed",esriJobNew:"job-new",esriJobSubmitted:"job-submitted",esriJobSucceeded:"job-succeeded",esriJobWaiting:"job-waiting"},{ignoreUnknown:!1}),_=1e3;return t.default=class extends i.JSONSupport{static{J=this}constructor(e){super(e),this.jobId=null,this.jobStatus=null,this.messages=null,this.progress=null,this.requestOptions=null,this.sourceUrl=null,this._cancelJobTimer=void 0,this._jobCompletionTimer=void 0}async cancelJob(e){const{jobId:t,sourceUrl:o}=this,{path:r}=p.parseUrl(o),a={...this.requestOptions,...e,query:{f:"json"}},i=`${r}/jobs/${t}/cancel`,{data:n}=await s(i,a),{messages:l,jobStatus:u,progress:b}=J.fromJSON(n);return this.set({messages:l,jobStatus:u,progress:b}),"job-cancelled"===u?this:new Promise((t,o)=>{c.onAbort(a.signal,()=>{this.clearCancelJobTimer(),o(c.createAbortError())}),this.clearCancelJobTimer();const s=()=>{this._cancelJobTimer||o(c.createAbortError()),this.checkJobStatus(e).then(({jobStatus:e})=>{switch(e){case"job-cancelling":default:this._cancelJobTimer=setTimeout(s,_);break;case"job-deleted":case"job-deleting":case"job-executing":case"job-failed":case"job-new":case"job-submitted":case"job-succeeded":case"job-timed-out":case"job-waiting":o(this);break;case"job-cancelled":t(this)}}).catch(e=>{o(e)})};this._cancelJobTimer=setTimeout(s,_)})}destroy(){clearInterval(this._cancelJobTimer),clearInterval(this._jobCompletionTimer)}async checkJobStatus(e){const{path:t}=p.parseUrl(this.sourceUrl),o={...this.requestOptions,...e,query:{f:"json"}},r=`${t}/jobs/${this.jobId}`,{data:a}=await s(r,o),{messages:i,jobStatus:c,progress:n}=J.fromJSON(a);return this.set({messages:i,jobStatus:c,progress:n}),this}async fetchResultData(e,t,o){t=m.from(t||{});const{returnColumnName:r,returnFeatureCollection:a,returnM:i,returnZ:c,outSpatialReference:n}=t,{path:l}=p.parseUrl(this.sourceUrl),u={returnColumnName:r||null,returnFeatureCollection:a||null,returnM:i||null,returnZ:c||null,outSR:n,returnType:"data",f:"json"},b=h.gpEncode(u,null),d={...this.requestOptions,...o,query:b},j=`${l}/jobs/${this.jobId}/results/${e}`,{data:g}=await s(j,d);return h.decode(g)}async fetchResultImage(e,t,o){const{path:r}=p.parseUrl(this.sourceUrl),a={...t.toJSON(),f:"json"},i=h.gpEncode(a),c={...this.requestOptions,...o,query:i},n=`${r}/jobs/${this.jobId}/results/${e}`,{data:l}=await s(n,c);return h.decode(l)}async fetchResultMapImageLayer(){const{path:t}=p.parseUrl(this.sourceUrl),o=t.indexOf("/GPServer/"),s=`${t.slice(0,Math.max(0,o))}/MapServer/jobs/${this.jobId}`;return new(0,(await new Promise((t,o)=>e(["../../layers/MapImageLayer"],e=>t(g(e)),o))).default)({url:s})}async waitForJobCompletion(e={}){const{interval:t=_,signal:o,statusCallback:s}=e;return new Promise((e,r)=>{c.onAbort(o,()=>{this.clearJobCompletionTimer(),r(c.createAbortError())}),this.clearJobCompletionTimer();const a=()=>{this._jobCompletionTimer||r(c.createAbortError()),this.checkJobStatus().then(({jobStatus:o})=>{switch(o){case"job-succeeded":e(this);break;case"job-executing":case"job-new":case"job-submitted":case"job-waiting":s&&s(this),this._jobCompletionTimer=setTimeout(a,t);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-failed":case"job-timed-out":r(this);break;default:this._jobCompletionTimer=setTimeout(a,t)}}).catch(e=>{r(e)})};this._jobCompletionTimer=setTimeout(a,t)})}clearCancelJobTimer(){clearTimeout(this._cancelJobTimer),this._cancelJobTimer=void 0}clearJobCompletionTimer(){clearTimeout(this._jobCompletionTimer),this._jobCompletionTimer=void 0}},o.__decorate([n.property()],t.default.prototype,"jobId",void 0),o.__decorate([b.enumeration(f,{ignoreUnknown:!1})],t.default.prototype,"jobStatus",void 0),o.__decorate([n.property({type:[j]})],t.default.prototype,"messages",void 0),o.__decorate([n.property()],t.default.prototype,"progress",void 0),o.__decorate([n.property()],t.default.prototype,"requestOptions",void 0),o.__decorate([n.property({json:{write:!0}})],t.default.prototype,"sourceUrl",void 0),t.default=J=o.__decorate([d.subclass("esri.rest.support.JobInfo")],t.default),t.default});