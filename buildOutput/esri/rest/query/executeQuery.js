// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../core/Error","../../core/has","../../core/promiseUtils","../../layers/support/infoFor3D","../../layers/support/source/DataLayerSource","./executeQueryJSON","./executeQueryPBF","../support/FeatureSet","../support/Query"],function(e,t,r,o,n,a,s,u,i,c,l){"use strict";function f(e,t){return null!=t&&!0===e.returnGeometry&&"xyFootprint"!==e.multipatchOption&&!e.outStatistics}t.executeQuery=async function(t,m,d,p,y){const S=await async function(e,t,n,c,m){const d={...c},p=function(e,t){let o=l.from(e);o.sourceSpatialReference=o.sourceSpatialReference??t?.sourceSpatialReference??null,(t?.gdbVersion||t?.dynamicDataSource)&&(o=o===e?o.clone():o,o.gdbVersion=e.gdbVersion||t.gdbVersion,o.dynamicDataSource=e.dynamicDataSource?s.DataLayerSource.from(e.dynamicDataSource):t.dynamicDataSource);const n=t?.infoFor3D;if(null!=n&&f(e,n)){o=o===e?o.clone():o,o.formatOf3DObjects=null;const t=a.getGlbFormatId(n),s=a.getGltfFormatId(n);for(const e of n.queryFormats){if(e===t){o.formatOf3DObjects=e;break}e!==s||o.formatOf3DObjects||(o.formatOf3DObjects=e)}if(!o.formatOf3DObjects)throw new r("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(null==o.outFields||!o.outFields.includes("*")){o=o===e?o.clone():o,null==o.outFields&&(o.outFields=[]);const{originX:t,originY:r,originZ:a,translationX:s,translationY:u,translationZ:i,scaleX:c,scaleY:l,scaleZ:f,rotationX:m,rotationY:d,rotationZ:p,rotationDeg:y}=n.transformFieldRoles;o.outFields.push(t,r,a,s,u,i,c,l,f,m,d,p,y)}}return o}(t,n),y=null!=t.outStatistics?.[0],S=o("featurelayer-pbf-statistics"),b=!y||S;let O;if("pbf"===n?.format&&b)try{O=await i.executeRawQueryPBF(e,p,d,m)}catch(e){if("query:parsing-pbf"!==e.name)throw e;n.format="json"}return"json"!==n?.format&&b||(O=await u.executeRawQueryJSON(e,p,d,m)),function(e,t){if(null!=e&&null!=t)for(const r of t){const t=e.get(r.name);t&&Object.assign(r,t.toJSON())}}(n?.fieldsIndex,O.fields),O}(t,m,d,p,y);return async function(t,r,o,a){const s=o?.infoFor3D;if(!f(t,s)||null==s||!r.assetMaps||!r.features?.length)return c.fromJSON(r);const{meshFeatureSetFromJSON:u}=await n.whenOrAbort(new Promise((t,r)=>e(["../support/meshFeatureSet"],t,r)),a);return u(t,s,r)}(m,S,d,p)},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});