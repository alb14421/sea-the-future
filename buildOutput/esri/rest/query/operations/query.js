// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../request","../../../core/urlUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","../../operations/urlUtils","./pbfQueryUtils","./queryZScale"],function(e,t,r,n,u,i,a,o,s){"use strict";const l="Layer does not support extent calculation.";function y(e,t){if(t&&"extent"===e.type)return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(t&&"point"===e.type)return`${e.x},${e.y}`;const r=e.toJSON();return delete r.spatialReference,JSON.stringify(r)}function c(e,t,r){const u=e.geometry,a=e.toJSON();delete a.compactGeometryEnabled,delete a.defaultSpatialReferenceEnabled;const o=a;let s,l,c;if(u&&(l=u.spatialReference,c=i.srToRESTValue(l),o.geometryType=n.getJsonType(u),o.geometry=y(u,e.compactGeometryEnabled),o.inSR=c),a.groupByFieldsForStatistics&&(o.groupByFieldsForStatistics=a.groupByFieldsForStatistics.join(",")),a.objectIds)switch(r?.uniqueIdFields?.length){case void 0:o.objectIds=a.objectIds.join(",");break;case 1:o.uniqueIds=JSON.stringify(a.objectIds),delete o.objectIds;break;default:o.uniqueIds=JSON.stringify(a.objectIds.map(e=>JSON.parse(e))),delete o.objectIds}if(a.orderByFields&&(o.orderByFields=a.orderByFields.join(",")),!a.outFields||!a.returnDistinctValues&&(t?.returnCountOnly||t?.returnExtentOnly||t?.returnIdsOnly)?delete o.outFields:a.outFields.includes("*")?o.outFields="*":o.outFields=a.outFields.join(","),a.outSR?(o.outSR=i.srToRESTValue(a.outSR),s=e.outSpatialReference):u&&(a.returnGeometry||a.returnCentroid)&&(o.outSR=o.inSR,s=l),a.returnGeometry&&delete a.returnGeometry,a.outStatistics&&(o.outStatistics=JSON.stringify(a.outStatistics)),a.fullText&&(o.fullText=JSON.stringify(a.fullText)),a.pixelSize&&(o.pixelSize=JSON.stringify(a.pixelSize)),a.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=l&&null!=e.quantizationParameters?.extent&&l.equals(e.quantizationParameters.extent.spatialReference)&&delete a.quantizationParameters.extent.spatialReference,o.quantizationParameters=JSON.stringify(a.quantizationParameters)),a.parameterValues&&(o.parameterValues=JSON.stringify(a.parameterValues)),a.rangeValues&&(o.rangeValues=JSON.stringify(a.rangeValues)),a.dynamicDataSource&&(o.layer=JSON.stringify({source:a.dynamicDataSource}),delete a.dynamicDataSource),a.timeExtent){const e=a.timeExtent,{start:t,end:r}=e;null==t&&null==r||(o.time=t===r?t:`${t??"null"},${r??"null"}`),delete a.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=l&&null!=s&&l.equals(s)&&(o.defaultSR=o.inSR,delete o.inSR,delete o.outSR),o}function d(e,t,r,n){return m(e,t,"pbf",r,void 0,n)}function f(e,t){if(!e.returnIdsOnly||!t.uniqueIdFields)return e;const r={...e,returnUniqueIdsOnly:!0};return delete r.returnIdsOnly,r}async function m(e,n,i,o={},s={},l={}){const y="string"==typeof e?r.urlToObject(e):e,d=n.geometry?[n.geometry]:[],m=await u.normalizeCentralMeridian(d,null,{signal:o.signal}),p=m?.[0];null!=p&&((n=n.clone()).geometry=p);const S=a.mapParameters({...y.query,f:i,...f(s,l),...c(n,s,l)});return t(r.join(y.path,function(e,t){return null!=e.formatOf3DObjects&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}(n,s)?"query3d":"query"),{...o,responseType:"pbf"===i?"array-buffer":"json",query:{...S,...o.query}})}e.encodeGeometry=y,e.executeQuery=async function(e,t,r,n,u){const i=t.timeExtent?.isEmpty?{data:{features:[]}}:await m(e,t,"json",n,void 0,u);return s.applyFeatureSetZUnitScaling(t,r,i.data),i},e.executeQueryForCount=function(e,t,r,n){return t.timeExtent?.isEmpty?Promise.resolve({data:{count:0}}):m(e,t,"json",r,{returnIdsOnly:!0,returnCountOnly:!0},n)},e.executeQueryForExtent=async function(e,t,r){if(t.timeExtent?.isEmpty)return{data:{count:0,extent:null}};const n=await m(e,t,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}),u=n.data;if(u.hasOwnProperty("extent"))return n;if(u.features)throw new Error(l);if(u.hasOwnProperty("count"))throw new Error(l);return n},e.executeQueryForIds=function(e,t,r,n){return t.timeExtent?.isEmpty?Promise.resolve({data:{objectIds:[]}}):m(e,t,"json",r,{returnIdsOnly:!0},n)},e.executeQueryPBF=async function(e,t,r,n,u){if(t.timeExtent?.isEmpty)return{data:r.createFeatureResult()};const i=await d(e,t,n,u),a=i;return a.data=o.parsePBFFeatureQuery(i.data,r),a},e.executeQueryPBFBuffer=d,e.queryToQueryStringParameters=c,e.runQuery=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});