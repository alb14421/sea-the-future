// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../kernel","../request","../core/jsonMap","../core/screenUtils","../core/urlUtils","../geometry/Polygon","../layers/support/fieldUtils","../layers/support/floorFilterUtils","../renderers/visualVariables/support/visualVariableUtils","./utils","./geoprocessor/execute","./geoprocessor/submitJob","./support/fileFormat","./support/layoutTemplate","./support/printTaskUtils","./support/PrintTemplate","./support/reportTemplate"],function(e,t,a,i,n,r,o,s,l,c,u,y,p,d,f,m,g,h){"use strict";const b={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},w=new i.JSONMap({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),S=new i.JSONMap({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"}),x=new Map;async function I(e,t){const i=O(e),n=x.get(i)??{gpServerUrl:i,legendLayerNameMap:{},legendLayers:[]};return n.gpMetadata??=(await a(i,u.asValidOptions({f:"json"},t))).data,n.cimVersion=n.gpMetadata.cimVersion,x.set(i,n),n}async function v(e,t){return a=await I(e,t),a.gpMetadata?.executionType?S.fromJSON(a.gpMetadata.executionType):"sync";var a}async function D(e,t){const i=await I(e,t),n=i.gpMetadata.tasks,r=i.gpServerUrl;return i.taskInfos||(i.taskInfos={},await Promise.all(n?.map(async e=>{const n=(await a(`${r}/${e}`,u.asValidOptions({f:"json"},t))).data,o=n.name.startsWith("GetLayoutTemplatesInfo")?"GetLayoutTemplatesInfo":n.name.startsWith("ExportWebMap")?"ExportWebMap":null;o&&(i.taskInfos[o]??=n)})??[])),i.taskInfos}async function T(e,t,a){return(await D(e,a))[t]??null}async function L(e,a){a=a||{is11xService:!1,legendLayerNameMap:{},legendLayers:[]};const i=e.template||new g;null==i.showLabels&&(i.showLabels=!0);const n=i.exportOptions;let r;const o=f.toJSON(i.layout);if(n&&(r={dpi:n.dpi},"map_only"===o?.toLowerCase()||""===o)){const{width:e,height:t}=n;r.outputSize=null!=e&&null!=t?[e,t]:void 0}const s=i.layoutOptions;let l;if(s){let e,t;"Miles"===s.scalebarUnit||"Kilometers"===s.scalebarUnit?(e="Kilometers",t="Miles"):"Meters"!==s.scalebarUnit&&"Feet"!==s.scalebarUnit||(e="Meters",t="Feet"),l={titleText:s.titleText,authorText:s.authorText,copyrightText:s.copyrightText,customTextElements:s.customTextElements,elementOverrides:s.elementOverrides,scaleBarOptions:e||t?{metricUnit:w.toJSON(e)??void 0,metricLabel:e?b[e]:void 0,nonMetricUnit:w.toJSON(t)??void 0,nonMetricLabel:t?b[t]:void 0}:void 0}}let c=null;s?.legendLayers&&(c=s.legendLayers.map(e=>{const t=e.layerId;a.legendLayerNameMap[t]=e.title;const i={id:t};return e.subLayerIds&&(i.subLayerIds=e.subLayerIds),i}));const u=await async function(e,t,a){const i=e.view;let n=i.spatialReference;const r={operationalLayers:await P(i,t,a)};t.includeTables&&(r.tables=await async function(e){const t=[],a=[];for(const t of e.map.allTables)"feature"!==t.type||t.loaded||a.push(t.load());a.length&&await Promise.allSettled(a);for(const a of e.map.allTables)if("feature"===a.type&&a.loaded&&a.isTable&&"feature-layer"===a.source?.type){const e=(e=>({id:e.id,title:e.title,customParameters:e.customParameters,layerDefinition:{definitionExpression:e.layerDefinition?.definitionExpression},url:e.url}))(te(a));X(e,a),t.push(e)}return t.length?t:void 0}(i));let o=e.extent||a.ssExtent||i.extent;if(n?.isWrappable&&(o=o.clone()._normalize(!0),n=o.spatialReference),r.mapOptions={extent:o&&o.toJSON(),spatialReference:n&&n.toJSON(),showAttribution:t.attributionVisible},a.ssExtent=null,i.background&&(r.background=i.background.toJSON()),i.rotation&&(r.mapOptions.rotation=-i.rotation),t.scalePreserved&&(r.mapOptions.scale=t.outScale||i.scale),null!=i.timeExtent){const e=null!=i.timeExtent.start?i.timeExtent.start.getTime():null,t=null!=i.timeExtent.end?i.timeExtent.end.getTime():null;r.mapOptions.time=[e,t]}return t.reportOptions&&(r.reportOptions=t.reportOptions),r}(e,i,a);if(u.operationalLayers){const e=new RegExp("[\\u4E00-\\u9FFF\\u0E00-\\u0E7F\\u0900-\\u097F\\u3040-\\u309F\\u30A0-\\u30FF\\u31F0-\\u31FF]"),t=/[\u0600-\u06FF]/,a=a=>{const i=a.text,n=a.font,r=n?.family?.toLowerCase();i&&n&&("arial"===r||"arial unicode ms"===r)&&(n.family=e.test(i)?"Arial Unicode MS":"Arial","normal"!==n.style&&t.test(i)&&(n.family="Arial Unicode MS"))};for(const e of u.operationalLayers)if(e.featureCollection?.layers)for(const t of e.featureCollection.layers){if(t.layerDefinition?.drawingInfo?.renderer?.symbol){const e=t.layerDefinition.drawingInfo.renderer;"esriTS"===e.symbol.type&&a(e.symbol)}if(t.featureSet?.features)for(const e of t.featureSet.features)e.symbol&&"esriTS"===e.symbol.type&&a(e.symbol)}}e.outSpatialReference&&(u.mapOptions.spatialReference=e.outSpatialReference.toJSON()),Object.assign(u,{exportOptions:r,layoutOptions:l||{}}),Object.assign(u.layoutOptions,{legendOptions:{operationalLayers:null!=c?c:a.legendLayers.slice()}}),a.legendLayers.length=0,x.set(a.gpServerUrl,a);const y={Web_Map_as_JSON:JSON.stringify(u),Format:d.formatJsonMap.toJSON(i.format),Layout_Template:o,Layout_Item_ID:void 0,Report_Template:h.toJSON(i.report),Report_Item_ID:void 0};if(i.layoutItem){delete y.Layout_Template;const e=i.layoutItem;await e.load(),"public"!==e.access&&t.id&&await t.id.getCredential(a.gpServerUrl),y.Layout_Item_ID=JSON.stringify({id:e.id})}if(i.reportItem){delete y.Report_Template;const e=i.reportItem;await e.load(),"public"!==e.access&&t.id&&await t.id.getCredential(a.gpServerUrl),y.Report_Item_ID=JSON.stringify({id:e.id})}return e.extraParameters&&Object.assign(y,e.extraParameters),y}function O(e){let t=e;const a=t.lastIndexOf("/GPServer/");return a>0&&(t=t.slice(0,a+9)),t}async function P(e,t,a){const i=[],n={layerView:null,printTemplate:t,view:e};let r=0;t.scalePreserved&&(r=t.outScale||e.scale);const o=m.getVisibleLayerViews(e,r);for(const e of o){const t=e.layer;if(!t.loaded||"layers"in t)continue;let r;n.layerView=e,r=m.isScreenshotRequired(e)?await $(t,n,a):m.isBingMapsLayer(t)?M(t):"csv"===t?.type?await V(t,n,a):"catalog-footprint"===t?.type?await E(t,n,a):"feature"===t?.type?await k(t,n,a):"geojson"===t?.type?await N(t,n,a):"graphics"===t?.type?await J(t,n,a):"imagery"===t?.type?R(t,a):"imagery-tile"===t?.type?await U(t,n,a):"kml"===t?.type?await C(t,n,a):"map-image"===t?.type?A(t,n,a):"map-notes"===t?.type?await z(n,a):"open-street-map"===t?.type?_():"stream"===t?.type?await B(t,n,a):"subtype-group"===t?.type?await W(t,a):"tile"===t?.type?j(t,a):"vector-tile"===t?.type?await q(t,n,a):"web-tile"===t?.type?G(t):"wfs"===t?.type?await K(t,n,a):"wms"===t?.type?Q(t,a):"wmts"===t?.type?H(t):await $(t,n,a),r&&(Array.isArray(r)?i.push(...r):(r.id=t.id,r.title=a.legendLayerNameMap[t.id]||t.title,r.opacity=e.fullOpacity,r.minScale=t.minScale||0,r.maxScale=t.maxScale||0,m.isBlendLayer(t)&&t.blendMode&&"normal"!==t.blendMode&&(r.blendMode=t.blendMode),i.push(r)))}if(r)for(const e of i)e.minScale=0,e.maxScale=0;if(e.graphics?.length){const n=await F(null,e.graphics,t,a);n&&i.push(n)}return i}function M(e){return{culture:e.culture,key:e.key,type:"BingMaps"+("aerial"===e.style?"Aerial":"hybrid"===e.style?"Hybrid":"Road")}}async function E(e,{layerView:t,printTemplate:a},i){if(parseFloat(i.cimVersion)<3.1)return F(e,await ee(t),a,i);const n=e.parent,r={id:(o=te(n,"web-map")).id,url:o.url,layerType:o.layerType,customParameters:o.customParameters,dynamicGroupLayer:{visibility:!1},footprintLayer:o.footprintLayer,layerDefinition:o.layerDefinition};var o;return X(r,n),r}async function V(e,t,a){e.legendEnabled&&a.legendLayers.push({id:e.id});const i=t.layerView,n=t.printTemplate;if(!(i.filter||e.portalItem&&"public"!==e.portalItem.access)){const t=te(e,"web-map");return t.type="CSV",delete t.popupInfo,delete t.layerType,t.showLabels=n.showLabels&&e.labelsVisible,t}return F(e,await ee(i),n,a)}async function F(e,t,a,i){let n;const r=m.createPolygonLayer(),l=m.createPolylineLayer(),c=m.createPointLayer(),u=m.createMultipointLayer(),y=m.createPointLayer();if(y.layerDefinition.name="textLayer",delete y.layerDefinition.drawingInfo,e){if("esri.layers.FeatureLayer"===e.declaredClass||"esri.layers.StreamLayer"===e.declaredClass?r.layerDefinition.name=l.layerDefinition.name=c.layerDefinition.name=u.layerDefinition.name=i.legendLayerNameMap[e.id]||e.arcgisProps?.title||e.title:"esri.layers.GraphicsLayer"===e.declaredClass&&(t=e.graphics.items),e.renderer){const t=e.renderer.toJSON(),a=r.layerDefinition.drawingInfo;a&&(a.renderer=t);const i=l.layerDefinition.drawingInfo;i&&(i.renderer=t);const n=c.layerDefinition.drawingInfo;n&&(n.renderer=t);const o=u.layerDefinition.drawingInfo;o&&(o.renderer=t)}if(a.showLabels&&e.labelsVisible&&"function"==typeof e.write){const t=te(e,"web-map"),a=t.layerDefinition?.drawingInfo?.labelingInfo;if(a){n=!0;const e=r.layerDefinition.drawingInfo;e&&(e.labelingInfo=a);const t=l.layerDefinition.drawingInfo;t&&(t.labelingInfo=a);const i=c.layerDefinition.drawingInfo;i&&(i.labelingInfo=a);const o=u.layerDefinition.drawingInfo;o&&(o.labelingInfo=a)}}}let p;e?.renderer||n||(delete r.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo,delete c.layerDefinition.drawingInfo,delete u.layerDefinition.drawingInfo);const d=e?.fieldsIndex,f=e?.renderer;if(d){const t=new Set;n&&await s.collectLabelingFields(t,e),f&&"function"==typeof f.collectRequiredFields&&await f.collectRequiredFields(t,d),p=Array.from(t);const a=d.fields.map(e=>e.toJSON());r.layerDefinition.fields=a,l.layerDefinition.fields=a,c.layerDefinition.fields=a,u.layerDefinition.fields=a}const g=t?.length;let h;for(let e=0;e<g;e++){const n=t[e]||t.at(e);if(!1!==n.visible&&n.geometry){if(h=n.toJSON(),h.hasOwnProperty("popupTemplate")&&delete h.popupTemplate,h.geometry?.z&&delete h.geometry.z,h.symbol&&(h.symbol.angle||delete h.symbol.angle,ae(h.symbol)?h.symbol=await Y(h.symbol,i):h.symbol.text&&delete h.attributes),(!a||!a.forceFeatureAttributes)&&p?.length){const e={};for(const t of p)h.attributes?.hasOwnProperty(t)&&(e[t]=h.attributes[t]);h.attributes=e}"polygon"===n.geometry.type?r.featureSet.features.push(h):"polyline"===n.geometry.type?l.featureSet.features.push(h):"point"===n.geometry.type?h.symbol?.text?y.featureSet.features.push(h):c.featureSet.features.push(h):"multipoint"===n.geometry.type?u.featureSet.features.push(h):"extent"===n.geometry.type&&(h.geometry=o.fromExtent(n.geometry).toJSON(),r.featureSet.features.push(h))}}const b=[r,l,u,c,y].filter(e=>e.featureSet.features.length>0);for(const e of b){const t=e.featureSet.features.every(e=>e.symbol);if(t&&(!a||!a.forceFeatureAttributes))for(const t of e.featureSet.features)delete t.attributes;t&&delete e.layerDefinition.drawingInfo,e.layerDefinition.drawingInfo?.renderer&&await Z(e.layerDefinition.drawingInfo.renderer,i)}return b.length?{featureCollection:{layers:b},showLabels:n}:null}async function k(e,t,a){let i;const n=e.renderer,r=parseFloat(a.cimVersion);if("binning"===e.featureReduction?.type||"cluster"===e.featureReduction?.type&&(r<2.9||"pie-chart"===e.featureReduction.renderer?.type)||"pie-chart"===n?.type&&r<3.1||"dot-density"===n?.type&&r<2.6)return $(e,t,a);e.legendEnabled&&a.legendLayers.push({id:e.id});const o=t.layerView,{printTemplate:s,view:u}=t,y="feature-layer"!==e.source?.type&&"ogc-feature"!==e.source?.type;if(o.filter||y||!n||"field"in n&&null!=n.field&&!e.getField(n.field)){const t=await ee(o);i=await F(e,t,s,a)}else{if(i={id:(p=te(e)).id,title:p.title,url:p.url,layerType:p.layerType,customParameters:p.customParameters,layerDefinition:p.layerDefinition,charts:s.includeCharts?p.charts:void 0},s.attributionVisible&&(i.credits=m.getCopyright(e)),i.showLabels=s.showLabels&&e.labelsVisible,X(i,e),delete i.layerDefinition?.featureReduction?.disablePopup,delete i.layerDefinition?.featureReduction?.popupInfo,o.displayFilterEnabled||delete i.layerDefinition?.displayFilterInfo,i.layerDefinition?.drawingInfo?.renderer&&(delete i.layerDefinition.minScale,delete i.layerDefinition.maxScale,await Z(i.layerDefinition.drawingInfo.renderer,a),"visualVariables"in n&&n.visualVariables?.[0])){const e=n.visualVariables[0];if("size"===e.type&&e.maxSize&&"number"!=typeof e.maxSize&&e.minSize&&"number"!=typeof e.minSize){const t=c.getSizeRangeAtScale(e,u.scale);i.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=t.minSize,i.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=t.maxSize}}const t=l.getFloorFilterClause(o);if(t&&(i.layerDefinition??={},i.layerDefinition.definitionExpression=i.layerDefinition.definitionExpression?`(${i.layerDefinition.definitionExpression}) AND (${t})`:t),e.gdbVersion&&(i.layerDefinition??={},i.layerDefinition.gdbVersion=e.gdbVersion),o.hasHighlight&&"highlightIds"in o){const t=o;i.selectionObjectIds=t.highlightIds,i.selectionSymbol=m.getSelectionSymbol(e.geometryType,t.highlightOptions??u.highlightOptions)}}var p;return i}async function N(e,t,a){return"binning"===e.featureReduction?.type||"cluster"===e.featureReduction?.type?$(e,t,a):(e.legendEnabled&&a.legendLayers.push({id:e.id}),F(e,await ee(t.layerView),t.printTemplate,a))}async function J(e,{printTemplate:t},a){return F(e,null,t,a)}function R(e,t){e.legendEnabled&&t.legendLayers.push({id:e.id});const a={layerType:(i=te(e)).layerType,customParameters:i.customParameters};var i;return a.bandIds=e.bandIds,a.compressionQuality=e.compressionQuality,a.format=e.format,a.interpolation=e.interpolation,(e.mosaicRule||e.definitionExpression)&&(a.mosaicRule=e.exportImageServiceParameters.mosaicRule.toJSON()),e.rasterFunction&&(a.renderingRule=e.rasterFunction.toJSON()),e.renderer&&(a.layerDefinition??={},a.layerDefinition.drawingInfo??={},a.layerDefinition.drawingInfo.renderer=e.renderer.toJSON()),X(a,e),a}async function U(e,t,a){if("flow"===e.renderer?.type)return $(e,t,a);e.legendEnabled&&a.legendLayers.push({id:e.id});const i={bandIds:(n=te(e)).bandIds,customParameters:n.customParameters,interpolation:n.interpolation,layerDefinition:n.layerDefinition};var n;return i.layerType="ArcGISImageServiceLayer",X(i,e),i}async function C(e,t,a){const i=t.printTemplate;if(!e.portalItem||"public"===e.portalItem.access){const t=te(e,"web-map");return t.type="kml",delete t.layerType,t.url=r.normalize(e.url),t}const n=[],o=t.layerView;o.allVisibleMapImages.forEach((t,a)=>{const i={id:`${e.id}_image${a}`,type:"image",title:e.id,minScale:e.minScale||0,maxScale:e.maxScale||0,opacity:o.fullOpacity,extent:t.extent};t.href.startsWith("data:image/png;base64,")?i.imageData=t.href.slice(22):i.url=t.href,n.push(i)});const s=[...o.allVisiblePoints.items,...o.allVisiblePolylines.items,...o.allVisiblePolygons.items],l={id:e.id,...await F(null,s,i,a)};return n.push(l),n}function A(e,{printTemplate:t,view:a},i){let n;const r={id:e.id,subLayerIds:[]};let o=[];const s=a.scale,l=e=>{const t=0===s,a=0===e.minScale||s<=e.minScale,i=0===e.maxScale||s>=e.maxScale;if(e.visible&&(t||a&&i))if(e.sublayers)e.sublayers.forEach(l);else{const t=e.toExportImageJSON(),a={id:e.id,name:e.title,layerDefinition:{definitionExpression:t.definitionExpression,drawingInfo:t.drawingInfo,orderBy:t.orderBy,source:t.source}};o.unshift(a),r.subLayerIds.push(e.id)}};var c;return e.sublayers&&e.sublayers.forEach(l),o.length&&(o=o.map(({id:e,name:t,layerDefinition:a})=>({id:e,name:t,layerDefinition:a})),n={layerType:(c=te(e)).layerType,customParameters:c.customParameters},n.layers=o,n.visibleLayers=e.capabilities?.exportMap?.supportsDynamicLayers?void 0:r.subLayerIds,t.attributionVisible&&(n.credits=m.getCopyright(e)),e.gdbVersion&&(n.gdbVersion=e.gdbVersion),X(n,e),e.legendEnabled&&i.legendLayers.push(r)),n}async function z({layerView:e,printTemplate:t},a){const i=[],n=e.layer;if(null!=n.featureCollections)for(const e of n.featureCollections){const n=await F(e,e.source,t,a);n&&i.push(...n.featureCollection.layers)}else if(null!=n.sublayers)for(const e of n.sublayers){const n=await F(null,e.graphics,t,a);n&&i.push(...n.featureCollection.layers)}return{featureCollection:{layers:i}}}function _(){return{type:"OpenStreetMap"}}async function $(e,{printTemplate:t,view:a},i){const o={type:"image"},s={format:"png",ignoreBackground:!0,ignorePadding:!0,layers:[e]};0!==a.rotation&&(s.rotation=0);const l=i.ssExtent||a.state.extent.clone();let c=96,u=!0,y=!0;if(t.exportOptions){const e=t.exportOptions;null!=e.dpi&&e.dpi>0&&(c=e.dpi),null!=e.width&&e.width>0&&(u=e.width%2==a.width%2),null!=e.height&&e.height>0&&(y=e.height%2==a.height%2)}if("map-only"===t.layout&&t.scalePreserved&&(!t.outScale||t.outScale===a.scale)&&96===c&&(!u||!y)&&a.state.extent.equals(a.extent)&&(s.area={x:0,y:0,width:a.width,height:a.height},u||(s.area.width-=1),y||(s.area.height-=1),!i.ssExtent)){const e=a.toMap(n.createScreenPoint(s.area.width,s.area.height));l.ymin=e.y,l.xmax=e.x,i.ssExtent=l}o.extent=l.clone()._normalize(!0).toJSON();const p=await a.takeScreenshot(s);return o.imageData=r.dataComponents(p.dataUrl)?.data,o}async function B(e,{layerView:t,printTemplate:a},i){return e.legendEnabled&&i.legendLayers.push({id:e.id}),F(e,await ee(t),a,i)}async function W(e,t){if(e.legendEnabled)for(const a of e.sublayers)a.legendEnabled&&t.legendLayers.push({id:a.id});const a={customParameters:(i=te(e)).customParameters,effect:i.effect,layerDefinition:i.layerDefinition,layerType:i.layerType,layers:i.layers,url:i.url};var i;if(X(a,e),Array.isArray(a.layers)){for(const e of a.layers)delete e.popupInfo;a.token&&a.layers.length>0&&(a.layers[a.layers.length-1].token=a.token,delete a.token)}return a}function j(e,t){e.legendEnabled&&t.legendLayers.push({id:e.id});const a={layerType:(i=te(e)).layerType,customParameters:i.customParameters};var i;return X(a,e),a}async function q(e,t,a){const i=t.layerView;if(e.serviceUrl&&e.styleUrl&&!i.spriteSourceChanged&&!i.styleChanged){const t=u.findToken(e.styleUrl,e.apiKey),i=u.findToken(e.serviceUrl,e.apiKey);if(!t&&!i||"2.1.0"!==a.cimVersion){const a={type:"VectorTileLayer"};return a.styleUrl=r.normalize(e.styleUrl),a.token=t,i!==t&&(a.additionalTokens=[{url:e.serviceUrl,token:i}]),a}}return $(e,t,a)}function G(e){const t=e.urlTemplate?.replace(/\${/g,"{"),a={type:"WebTiledLayer",urlTemplate:t,credits:e.copyright};return e.subDomains&&e.subDomains.length>0&&(a.subDomains=e.subDomains),a}async function K(e,t,a){return parseFloat(a.cimVersion)<3.5?$(e,t,a):(e.legendEnabled&&a.legendLayers.push({id:e.id}),{layerType:(i=te(e,"web-map")).layerType,layerDefinition:i.layerDefinition,url:i.url,wfsInfo:i.wfsInfo});var i}function Q(e,t){let a;const i=[],n=e=>{e.visible&&(e.sublayers?e.sublayers.forEach(n):e.name&&i.unshift(e.name))};return e.sublayers&&e.sublayers.forEach(n),i.length&&(e.legendEnabled&&t.legendLayers.push({id:e.id,subLayerIds:i}),a={type:"wms",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,transparentBackground:e.imageTransparency,visibleLayers:i,url:r.normalize(e.url),version:e.version}),a}function H(e){const t=e.activeLayer;return{type:"wmts",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,format:t.imageFormat,layer:t.id,style:t.styleId,tileMatrixSet:t.tileMatrixSetId,url:r.normalize(e.url)}}function X(e,t){t.url&&(e.url=r.normalize(e.url||t.url),e.token=u.findToken(e.url,t.apiKey))}async function Y(e,t){t.canvas||(t.canvas=document.createElement("canvas"));const i=1024;t.canvas.width=i,t.canvas.height=i;const r=t.canvas.getContext("2d");let o,s;if(e.path){const t=new Path2D(e.path);t.closePath(),r.fillStyle=Array.isArray(e.color)?`rgba(${e.color[0]},${e.color[1]},${e.color[2]},${e.color[3]/255})`:"rgb(0,0,0)",r.fill(t);const a=m.getContextBoundingBox(r);if(!a)return null;r.clearRect(0,0,i,i);const l=n.pt2px(e.size)/Math.max(a.width,a.height);r.scale(l,l);const c=i/l,u=c/2-a.width/2-a.x,y=c/2-a.height/2-a.y;if(r.translate(u,y),Array.isArray(e.color)&&r.fill(t),e.outline?.width&&Array.isArray(e.outline.color)){const i=e.outline;r.lineWidth=n.pt2px(i.width)/l,r.lineJoin="round",r.strokeStyle=`rgba(${i.color[0]},${i.color[1]},${i.color[2]},${i.color[3]/255})`,r.stroke(t),a.width+=r.lineWidth,a.height+=r.lineWidth}a.width*=l,a.height*=l;const p=r.getImageData(512-a.width/2,512-a.height/2,Math.ceil(a.width),Math.ceil(a.height));o=p.width,s=p.height,r.canvas.width=o,r.canvas.height=s,r.putImageData(p,0,0)}else{const t="image/svg+xml"===e.contentType?"data:image/svg+xml;base64,"+e.imageData:e.url,i=(await a(t,{responseType:"image"})).data;o=n.pt2px(e.width),s=n.pt2px(e.height),r.canvas.width=o,r.canvas.height=s,r.drawImage(i,0,0,r.canvas.width,r.canvas.height)}return{type:"esriPMS",imageData:r.canvas.toDataURL("image/png").slice(22),angle:e.angle,contentType:"image/png",height:n.px2pt(s),width:n.px2pt(o),xoffset:e.xoffset,yoffset:e.yoffset}}async function Z(e,t){const a=e.type;if("simple"===a&&ae(e.symbol))e.symbol=await Y(e.symbol,t);else if("uniqueValue"===a||"classBreaks"===a){ae(e.defaultSymbol)&&(e.defaultSymbol=await Y(e.defaultSymbol,t));const i=e["uniqueValue"===a?"uniqueValueInfos":"classBreakInfos"];if(i)for(const e of i)ae(e.symbol)&&(e.symbol=await Y(e.symbol,t))}}async function ee(e){return e.queryFeatures(e.createQuery()).then(e=>e.features)}function te(e,t){return e.write({},{ignorePersistenceEnabled:!0,origin:t})??{}}function ae(e){return e&&(e.path||"image/svg+xml"===e.contentType||e.url?.endsWith(".svg"))}e.execute=async function(e,t,a){const i=await I(e,a),n=await L(t,i);if("sync"===await v(e,a)){const{results:t}=await y.execute(e,n,void 0,a);return t?.[0]?.value}const r=await p.submitJob(e,n,void 0,a);await r.waitForJobCompletion({interval:t.updateDelay});const{value:o}=await r.fetchResultData("Output_File",null,a);return o},e.getGpPrintParams=L,e.getGpServerUrl=O,e.getMode=v,e.getTaskExecutionMode=async function(e,t,a){const i=await T(e,t,a);return i?.executionType?S.fromJSON(i.executionType):"sync"},e.getTaskInfo=T,e.getTaskInfos=D,e.printCacheMap=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});