// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../request","../../geometry/Extent","../../geometry/Point","../../geometry/SpatialReference","../../layers/support/RasterInfo","../../layers/support/RasterStorageInfo","../utils","../support/FeatureSet"],function(e,t,a,n,l,i,s,r,o){"use strict";async function u(e,u,c){const m=r.parseUrl(e),{rasterFunction:f,sourceJSON:d}=u||{},p=f?JSON.stringify(f.rasterFunctionDefinition||f):null,h=r.encode({...m.query,renderingRule:p,f:"json"}),g=r.asValidOptions(h,c);e=m.path;const y=d||await t(e,g).then(e=>e.data),S=y.hasRasterAttributeTable?t(`${e}/rasterAttributeTable`,g):null,x=y.hasColormap?t(`${e}/colormap`,g):null,b=y.hasHistograms?t(`${e}/histograms`,g):null,v=y.currentVersion>=10.3?t(`${e}/keyProperties`,g):null,V=y.hasMultidimensions?t(`${e}/multidimensionalInfo`,g):null,I=await Promise.allSettled([S,x,b,v,V]);let D=null;if(y.minValues&&y.minValues.length===y.bandCount){D=[];for(let e=0;e<y.minValues.length;e++)D.push({min:y.minValues[e],max:y.maxValues[e],avg:y.meanValues[e],stddev:y.stdvValues[e]})}const T=a.fromJSON(y.extent),R=Math.ceil(T.width/y.pixelSizeX-.1),M=Math.ceil(T.height/y.pixelSizeY-.1),O=l.fromJSON(y.spatialReference||y.extent.spatialReference),w="fulfilled"===I[0].status?I[0].value?.data:null,N=w?.features?.length?o.fromJSON(w):null,J="fulfilled"===I[1].status?I[1].value?.data.colormap:null,P=J?.length?J:null,k="fulfilled"===I[2].status?I[2].value?.data.histograms:null,C=k?.[0]?.counts?.length?k:null,z="fulfilled"===I[3].status?I[3].value?.data??{}:{},F="fulfilled"===I[4].status?I[4].value?.data.multidimensionalInfo:null,$=F?.variables?.length?F:null;$&&$.variables.forEach(e=>{e.statistics?.length&&e.statistics.forEach(e=>{e.avg=e.mean,e.stddev=e.standardDeviation}),e.dimensions?.forEach(e=>{"StdTime"!==e.name||e.recurring||e.unit||(e.unit="ISO8601")})});const{defaultVariable:E,serviceDataType:H}=y;E&&E!==z.DefaultVariable&&(z.DefaultVariable=E),H?.includes("esriImageServiceDataTypeVector")&&!H.includes(z.DataType)&&(z.DataType=H.replace("esriImageServiceDataType",""));let L=y.noDataValue;y.noDataValues?.length&&y.noDataValues.some(e=>e!==L)&&(L=y.noDataValues);const A=y.transposeInfo?new s({blockWidth:256,blockHeight:256,pyramidBlockWidth:256,pyramidBlockHeight:256,pyramidScalingFactor:2,compression:"lerc",origin:new n({x:y.extent.xmin,y:y.extent.ymax,spatialReference:O}),firstPyramidLevel:1,maximumPyramidLevel:Math.max(0,Math.round(Math.log(Math.max(R,M))/Math.LN2-8)),transposeInfo:y.transposeInfo}):void 0;return new i({width:R,height:M,bandCount:y.bandCount,extent:a.fromJSON(y.extent),spatialReference:O,pixelSize:new n({x:y.pixelSizeX,y:y.pixelSizeY,spatialReference:O}),pixelType:y.pixelType.toLowerCase(),statistics:D,attributeTable:N,colormap:P,histograms:C,keyProperties:z,noDataValue:L,multidimensionalInfo:$,storageInfo:A})}e.fetchServiceRasterInfo=function(e,t,a){return u(e,{sourceJSON:t},a)},e.generateRasterInfo=function(e,t,a){return u(e,{rasterFunction:t},a)},e.patchServiceInfo=function(e,t){e.attributeTable||(t.hasRasterAttributeTable=!1),e.histograms||(t.hasHistograms=!1),e.colormap||(t.hasColormap=!1),e.multidimensionalInfo||(t.hasMultidimensions=!1)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});