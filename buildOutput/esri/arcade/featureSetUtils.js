// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../request","./featureSetCollection","../chunks/languageUtils","./featureset/actions/AttributeFilter","./featureset/actions/GroupBy","./featureset/actions/OrderBy","./featureset/actions/SpatialFilter","./featureset/actions/Top","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerMemory","./featureset/sources/FeatureLayerRelated","./featureset/support/cache","./featureset/support/errorsupport","./featureset/support/shared","../core/Loadable","../core/sql/WhereClause","../layers/FeatureLayer","../layers/Layer","../portal/PortalItem"],function(e,t,a,r,n,l,s,i,o,u,c,d,p,y,f,h,m,L,I,w){"use strict";async function S(e,t,a){if(p.applicationCache){const a=p.applicationCache.getLayerInfo(e);if(a){const r=await a;return new L({url:e,outFields:t,sourceJSON:r})}const r=new L({url:e,outFields:t}),n=(async()=>(await r.load(),r.sourceJSON))();if(p.applicationCache){p.applicationCache.setLayerInfo(e,n);try{return await n,r}catch(t){throw p.applicationCache.clearLayerInfo(e),t}}return await n,r}if(null!=a){const r=a.getCachedLayerMetadata(e);if(r){const a=await r;return new L({url:e,outFields:t,sourceJSON:a})}const n=new L({url:e,outFields:t}),l=(async()=>(await n.load(),n.sourceJSON))();a.setCachedLayerMetadata(e,l);try{return await l,n}catch(t){throw a.removeCachedLayerMetadata(e,l),t}}return new L({url:e,outFields:t})}async function _(e,t,a,r,n,l=null){return F(await S(e,["*"],n),t,a,r,n,l)}function F(e,t=null,a=null,r=!0,n=null,l=null){switch(e.type){case"catalog-footprint":return F(e.parent,t,a,r,n,l);case"subtype-sublayer":{const s=F(e.parent,t,a,r,n,l);return s.filter(m.create(e.parent.subtypeField+"="+e.subtypeCode.toString(),{fieldsIndex:e.parent.fieldsIndex,timeZone:s.dateFieldsTimeZoneDefaultUTC}))}case"csv":case"geojson":case"knowledge-graph-sublayer":case"wfs":return new c({layer:e,spatialReference:t,outFields:a,includeGeometry:r,lrucache:n,interceptor:l});case"catalog":case"feature":case"oriented-imagery":case"subtype-group":{const s={layer:e,spatialReference:t,outFields:a,includeGeometry:r,lrucache:n,interceptor:l};return!e.url&&e.source?new c(s):new u(s)}default:throw new Error(`Unsupported layer type: ${e.type}`)}}async function C(e,a){if(null!==p.applicationCache){const t=p.applicationCache.getLayerInfo(e);if(null!==t)return t}if(null!=a){const t=a.getCachedServiceMetadata(e);if(null!=t)return t}const r=(async()=>{const a=await t(e,{responseType:"json",query:{f:"json"}});if(a.data){const e=a.data;return e.layers||(e.layers=[]),e.tables||(e.tables=[]),e}return{layers:[],tables:[]}})();if(null!==p.applicationCache){p.applicationCache.setLayerInfo(e,r);try{return await r}catch(t){throw p.applicationCache.clearLayerInfo(e),t}}if(null!=a){a.setCachedServiceMetadata(e,r);try{return await r}catch(t){throw a.removeCachedServiceMetadata(e,r),t}}return r}n.registerAction(),l.registerAction(),s.registerAction(),i.registerAction(),o.registerAction();class g extends a{constructor(e,t=null,a=null,r=null){super(),this._map=e,this._overrideSpatialReference=t,this._lrucache=a,this._interceptor=r,this._instantLayers=[]}_makeAndAddFeatureSet(e,t=!0,a=null){const r=F(e,this._overrideSpatialReference,null===a?["*"]:a,t,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(a)}),r}async featureSetByName(e,t=!0,a=null){if(h.isLoadable(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetByName(e,t,a);null===a&&(a=["*"]),a=(a=a.slice()).sort();const r=JSON.stringify(a);for(let a=0;a<this._instantLayers.length;a++){const n=this._instantLayers[a];if(n.opitem.title===e&&n.includeGeometry===t&&n.outFields===r)return this._instantLayers[a].featureset}const n=this._map.allLayers.find(t=>f.isSupportedLayer(t)&&t.title===e);if(null!=n)return this._makeAndAddFeatureSet(n,t,a);if(this._map.allTables){const r=this._map.allTables.find(t=>f.isSupportedLayer(t)&&t.title===e);if(null!=r)return this._makeAndAddFeatureSet(r,t,a)}return null}async featureSetById(e,t=!0,a=["*"]){if(h.isLoadable(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetById(e,t,a);null===a&&(a=["*"]),a=(a=a.slice()).sort();const r=JSON.stringify(a);for(let a=0;a<this._instantLayers.length;a++){const n=this._instantLayers[a];if(n.opitem.id===e&&n.includeGeometry===t&&n.outFields===r)return this._instantLayers[a].featureset}const n=this._map.allLayers.find(t=>f.isSupportedLayer(t)&&t.id===e);if(n)return this._makeAndAddFeatureSet(n,t,a);if(this._map.allTables){const r=this._map.allTables.find(t=>f.isSupportedLayer(t)&&t.id===e);if(null!=r)return this._makeAndAddFeatureSet(r,t,a)}return null}}class k extends a{constructor(e,t=null,a=null,r=null){super(),this._url=e,this._overrideSpatialReference=t,this._lrucache=a,this._interceptor=r,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(e,t=!0,a=null){const r=F(e,this._overrideSpatialReference,null===a?["*"]:a,t,this._lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(a)}),r}async _loadMetaData(){const e=await C(this._url,this._lrucache);return this.metadata=e,e}load(){return this._loadMetaData()}clone(){return new k(this._url,this._overrideSpatialReference,this._lrucache,this._interceptor)}async featureSetByName(e,t=!0,a=null){null===a&&(a=["*"]),a=(a=a.slice()).sort();const r=JSON.stringify(a);for(let a=0;a<this._instantLayers.length;a++){const n=this._instantLayers[a];if(n.opitem.title===e&&n.includeGeometry===t&&n.outFields===r)return this._instantLayers[a].featureset}const n=await this._loadMetaData();let l=null;for(const t of n.layers??[])t.name===e&&(l=t);if(!l)for(const t of n.tables??[])t.name===e&&(l=t);if(l){const e=await S(this._url+"/"+l.id,["*"],this._lrucache);return this._makeAndAddFeatureSet(e,t,a)}return null}async featureSetById(e,t=!0,a=["*"]){null===a&&(a=["*"]),a=(a=a.slice()).sort();const r=JSON.stringify(a);e=null!=e?e.toString():"";for(let a=0;a<this._instantLayers.length;a++){const n=this._instantLayers[a];if(n.opitem.id===e&&n.includeGeometry===t&&n.outFields===r)return this._instantLayers[a].featureset}const n=await this._loadMetaData();let l=null;for(const t of n.layers??[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(l=t);if(!l)for(const t of n.tables??[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(l=t);if(l){const e=await S(this._url+"/"+l.id,["*"],this._lrucache);return this._makeAndAddFeatureSet(e,t,a)}return null}}async function N(e,t,a,r,n,l,s){let i;if("Feature Service"===e.type||"Map Service"===e.type)i=await S(f.extractServiceUrl(e.url??"")+"/"+t,["*"],l);else{if(t)throw new Error(`layerId=${t} provided for ${e.type} item`);if(null!=l){const t=l.getCachedPortalItemLayer(e.portal.url,e.id);if(null!=t)i=await t;else{const t=I.fromPortalItem(e);l.setCachedPortalItemLayer(e.portal.url,e.id,t);try{i=await t}catch(a){throw l.removeCachedPortalItemLayer(e.portal.url,e.id,t),a}}}else i=await I.fromPortalItem(e)}return F(i,a,r,n,l,s)}e.constructAssociationMetaDataFeatureSetFromUrl=async function(e,a,r){const n={metadata:null,networkId:-1,unVersion:3,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map,queryelem:null,layerNameLkp:{},lkp:null},l=await C(e,null);if(n.metadata=l,void 0!==l.controllerDatasetLayers?.utilityNetworkLayerId&&null!==l.controllerDatasetLayers.utilityNetworkLayerId){if(l.layers)for(const e of l.layers)n.layerNameLkp[e.id]=e.name;if(l.tables)for(const e of l.tables)n.layerNameLkp[e.id]=e.name;const s=l.controllerDatasetLayers.utilityNetworkLayerId;n.networkId=s;const i=await async function(e,a){const r="QUERYDATAELEMTS:"+a.toString()+":"+e;if(null!==p.applicationCache){const e=p.applicationCache.getLayerInfo(r);if(null!==e)return e}const n=(async()=>{const r=await t(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([a.toString()]),f:"json"}});if(r.data){const e=r.data;if(e.layerDataElements?.[0])return e.layerDataElements[0]}throw new y.FeatureSetError("DataElementsNotFound")})();if(null!==p.applicationCache){p.applicationCache.setLayerInfo(r,n);try{return await n}catch(e){throw p.applicationCache.clearLayerInfo(r),e}}return n}(e,s);if(i){n.queryelem=i,n.queryelem?.dataElement&&void 0!==n.queryelem.dataElement.schemaGeneration&&(n.unVersion=n.queryelem.dataElement.schemaGeneration),n.lkp={},n.queryelem.dataElement.domainNetworks||(n.queryelem.dataElement.domainNetworks=[]);for(const e of n.queryelem.dataElement.domainNetworks){for(const t of e.edgeSources??[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:n.layerNameLkp[t.layerId]??null};n.layerIdLookup.set(e.layerId,e),n.sourceIdLookup.set(e.sourceId,e),e.className&&(n.lkp[e.className]=e)}for(const t of e.junctionSources??[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:n.layerNameLkp[t.layerId]??null};n.layerIdLookup.set(e.layerId,e),n.sourceIdLookup.set(e.sourceId,e),e.className&&(n.lkp[e.className]=e)}}if(n.queryelem.dataElement.terminalConfigurations)for(const e of n.queryelem.dataElement.terminalConfigurations)for(const t of e.terminals)n.terminals.push({terminalId:t.terminalId,terminalName:t.terminalName});const l=await async function(e){if(null!==p.applicationCache){const t=p.applicationCache.getLayerInfo(e);if(null!==t)return t}const a=(async()=>{const a=await t(e,{responseType:"json",query:{f:"json"}});return a.data?a.data:null})();if(null!==p.applicationCache){p.applicationCache.setLayerInfo(e,a);try{return await a}catch(t){throw p.applicationCache.clearLayerInfo(e),t}}return a}(e+"/"+s);if(void 0!==l.systemLayers?.associationsTableId&&null!==l.systemLayers.associationsTableId){let t=null;if(r&&n.unVersion<8){const r=[];n.unVersion>=4&&(r.push("STATUS"),r.push("PERCENTALONG")),t=await _(e+"/"+l.systemLayers.associationsTableId,a,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...r],!1,null,null),await t.load(),n.unVersion>=4&&(t=t.filter(m.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62, 63)",{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})),await t.load())}return{lkp:n.lkp,associations:t,unVersion:n.unVersion,terminals:n.terminals,layerIdLookup:n.layerIdLookup,sourceIdLookup:n.sourceIdLookup}}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}},e.constructFeatureSet=F,e.constructFeatureSetFromPortalItem=async function(e,t,a,r,n,l,s,i=null){if(p.applicationCache){const o=p.applicationCache.getLayerInfo(e+":"+l.url);if(o)return N(await o,t,a,r,n,s,i)}if(null!=s){const o=s.getCachedPortalItem(l.url,e);if(null!=o)return await N(await o,t,a,r,n,s,i)}const o=new w({id:e,portal:l}).load();p.applicationCache?p.applicationCache.setLayerInfo(e+":"+l.url,o):null!=s&&s.setCachedPortalItem(l.url,e,o);try{return await N(await o,t,a,r,n,s,i)}catch(t){throw p.applicationCache&&p.applicationCache.clearLayerInfo(e+":"+l.url),null!=s&&s.removeCachedPortalItem(l.url,e,o),t}},e.constructFeatureSetFromRelationship=async function(e,t,a,r=null,n=null,l=!0,s=null,i=null){let o=e.serviceUrl();if(!o)return null;o=o.endsWith("/")?o+t.relatedTableId.toString():o+"/"+t.relatedTableId.toString();const u=await _(o,r,n,l,s,i);return new d({layer:e,relatedLayer:u,relationship:t,objectId:a,spatialReference:r,outFields:n,includeGeometry:l,lrucache:s,interceptor:i})},e.constructFeatureSetFromUrl=_,e.convertToFeatureSet=function(e,t,a,n,l){if(null===e)return null;if(r.isFeatureSet(e)){switch(t){case"datasource":return e.getDataSourceFeatureSet();case"parent":return e;case"root":return e.getRootFeatureSet()}return null}if(e instanceof I&&f.isSupportedSourceLayer(e)){const r=e;switch(t){case"datasource":return F(r,l,"outFields"in r?r.outFields:null,!0,a,n).getDataSourceFeatureSet();case"parent":case"root":return F(r,l,"outFields"in r?r.outFields:null,!0,a,n)}return null}if(r.isSubtypeSublayer(e)){switch(t){case"datasource":return F(e.parent,l,e.parent.outFields,!0,a,n).getDataSourceFeatureSet();case"parent":case"root":return F(e,l,e.parent.outFields,!0,a,n)}return null}return null},e.createFeatureSetCollectionFromMap=function(e,t,a=null,r=null){return new g(e,t,a,r)},e.createFeatureSetCollectionFromService=function(e,t,a=null,r=null){return new k(e,t,a,r)},e.initialiseMetaDataCache=function(){null===p.applicationCache&&(p.applicationCache=new p)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});