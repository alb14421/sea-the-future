// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","./arcadeEnvironment","./ArcadeModule","./ArcadeModuleLoader","./compilerUtils","./containerUtils","./Dictionary","./executionError","./Feature","./FunctionWrapper","../chunks/languageUtils","./treeAnalysis","../chunks/aiServices","../chunks/array","./functions/date","./functions/feature","./functions/geometry","./functions/geomsync","./functions/maths","./functions/stats","./functions/string","./functions/track","../core/compilerUtils","../core/Logger","../core/promiseUtils","../core/SetUtils","../geometry/Geometry","../geometry/SpatialReference","../support/guards"],function(e,n,t,r,o,l,a,i,s,c,u,d,m,p,f,g,h,y,b,w,E,x,v,S,$,A,F,C,M,N){"use strict";const I=()=>$.getLogger("esri.arcade.arcadeCompiler");class O{constructor(){this._symbolCounter=0}nextVarId(){return this._symbolCounter+=1,`_T${this._symbolCounter}`}nextTempVarId(){return this._symbolCounter+=1,`_Tvar${this._symbolCounter}`}nextLocalsSymbolMapId(){return this._symbolCounter+=1,`_Locals${this._symbolCounter}`}}function k(e,n){const t=e.localScope?.get(n);if(null!=t)return{scope:"local",name:n,var:t};const r=e.globalScope.get(n);return null!=r?{scope:"global",name:n,var:r}:e.standardGlobals.has(n)?{scope:"global",name:n,var:n}:null}function B(e,n,r="InvalidIdentifier"){const o=k(e,t.toSymbolId(n));if(null!=o)return o;throw new s.ArcadeCompilationError(null,r,n)}function j(e,n,r){const o=k(e,t.toSymbolId(n));if(null==o)throw I().error(`Internal error: Symbol "${n.name}" not declared.`),new s.ArcadeCompilationError(null,"NeverReach",n);if(null!=r&&o.scope!==r)throw I().error(`Internal error: Expected to resolve "${n.name}" in the ${r} scope but is in the ${o.scope} scope.`),new s.ArcadeCompilationError(null,"NeverReach",n);return o}function L(e,n){const r=t.toSymbolId(n),o=e.symbolMetadata;if(e.localStack.length>0){const n=e.localStack[e.localStack.length-1],t=o.locals.get(n._SymbolsMapId);if(null==t)return void I().error(`Internal error: no reflection metadata for ${n._SymbolsMapId}`);const l=t.get(r);if(null!=l)return re.requireInitialized(n[l])}const l=o.globals.get(r);if(null!=l)return re.requireInitialized(e.globalScope[l]);if(o.standardGlobals.has(r))return re.requireInitialized(e.globalScope[r]);throw new s.ArcadeExecutionError(null,"InvalidIdentifier",null)}class R extends u.ArcadeFunction{constructor(e,n){super(),this.paramCount=n,this.fn=e}createFunction(e){return(...n)=>{if(n.length!==this.paramCount)throw new s.ArcadeExecutionError(e,"WrongNumberOfParameters",null);return this.fn(...n)}}call(e,n){return this.fn(...n.arguments)}marshalledCall(e,n,t,r){return r(e,n,(n,o,l)=>{l=l.map(n=>!d.isFunctionParameter(n)||n instanceof u.ScopeMarshalledFunction?n:u.wrapModuleScopedResponse(n,e,r));const a=this.call(t,{arguments:l});return A.isPromiseLike(a)?a.then(e=>u.wrapModuleScopedResponse(e,t,r)):a})}}function _(e,n,t){try{return t(e,null,n.arguments)}catch(e){throw e}}function T(e,n,t,r,o,a){const{globals:i,exports:s}=l.collectDeclaredGlobalNames(e);F.addMany(i,t);const c=new O,u=[],d=new Map;for(const e of i)if(t.has(e)||n.has(e))d.set(e,e);else{const n=c.nextVarId();d.set(e,n),u.push(`gscope[${JSON.stringify(n)}] = ${ne};`)}const m=new Map,p=Object.create(null),f={isAsync:r,symbols:c,standardGlobals:n,globalScope:d,exports:s,localScope:null,allLocalSymbolMetadata:m,moduleFactory:a,moduleFactoryMap:p,libraryResolver:o};return{body:[...u,"var lastStatement = lc.voidOperation;",z(f,e),"return lastStatement;"].join("\n"),symbolMetadata:{standardGlobals:n,exports:s,globals:d,locals:m},moduleFactoryMap:p}}function V(e,n){switch(n.type){case"AssignmentExpression":return function(e,n){const t=V(e,n.right);if("MemberExpression"===n.left.type){let r;const o=V(e,n.left.object);return r=!0===n.left.computed?V(e,n.left.property):"'"+n.left.property.name+"'","lang.assignmember("+o+","+r+",'"+n.operator+"',"+t+")"}const r=B(e,n.left);switch(W(r),r.scope){case"local":return`lscope['${r.var}']=lang.assign(${t},'${n.operator}', ${"="===n.operator?"null":te(`lscope['${r.var}']`)})`;case"global":return`gscope['${r.var}']=lang.assign(${t},'${n.operator}', ${"="===n.operator?"null":te(`gscope['${r.var}']`)})`;default:throw S.neverReached(r.scope),new s.ArcadeCompilationError(null,"NeverReach",n.left)}}(e,n);case"UpdateExpression":return function(e,n){if("CallExpression"===n.argument.type)throw new s.ArcadeCompilationError(null,"NeverReach",n);let t;if("MemberExpression"===n.argument.type){const r=V(e,n.argument.object);return t=!0===n.argument.computed?V(e,n.argument.property):"'"+n.argument.property.name+"'","lang.memberupdate("+r+","+t+",'"+n.operator+"',"+n.prefix+")"}const r=B(e,n.argument);switch(W(r),r.scope){case"local":return`lang.update(lscope, '${r.var}', '${n.operator}', ${n.prefix})`;case"global":return`lang.update(gscope, '${r.var}', '${n.operator}', ${n.prefix})`;default:throw S.neverReached(r.scope),new s.ArcadeCompilationError(null,"NeverReach",n.argument)}}(e,n);case"TemplateLiteral":return function(e,n){try{const t=[];let r=0;for(const o of n.quasis)t.push(o.value?JSON.stringify(o.value.cooked):JSON.stringify("")),!1===o.tail&&(t.push(n.expressions[r]?"lang.castString(lang.aCheck("+V(e,n.expressions[r])+", 'TemplateLiteral'))":""),r++);return"(["+t.join(",")+"]).join('')"}catch(e){throw e}}(e,n);case"Identifier":return function(e,n){const t=B(e,n);switch(W(t),t.scope){case"local":return te(`lscope['${t.var}']`);case"global":return te(`gscope['${t.var}']`);default:throw S.neverReached(t.scope),new s.ArcadeCompilationError(null,"NeverReach",n)}}(e,n);case"MemberExpression":return function(e,n){try{let t;return t=!0===n.computed?V(e,n.property):"'"+n.property.name+"'","lang.member("+V(e,n.object)+","+t+")"}catch(e){throw e}}(e,n);case"Literal":return null===n.value||void 0===n.value?"null":JSON.stringify(n.value);case"CallExpression":return function(e,n){try{if("MemberExpression"===n.callee.type){let t;t=!0===n.callee.computed?V(e,n.callee.property):"'"+n.callee.property.name+"'";let r="[";for(let t=0;t<n.arguments.length;t++)t>0&&(r+=", "),r+=V(e,n.arguments[t]);return r+="]",e.isAsync?"(yield lang.callModuleFunction("+V(e,n.callee.object)+","+r+","+t+",runtimeCtx))":"lang.callModuleFunction("+V(e,n.callee.object)+","+r+","+t+",runtimeCtx)"}if("Identifier"!==n.callee.type)throw new s.ArcadeCompilationError(null,"FunctionNotFound",n);const t=B(e,n.callee,"FunctionNotFound");if("global"===t.scope)switch(t.name){case"iif":return function(e,n){try{if(3!==n.arguments.length)throw new s.ArcadeCompilationError(null,"WrongNumberOfParameters",n);const t=e.symbols.nextTempVarId();return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${V(e,n.arguments[0])};\n\n        if (${t} === true) {\n          return  ${V(e,n.arguments[1])};\n        }\n        else if (${t} === false) {\n          return ${V(e,n.arguments[2])};\n        }\n        else {\n          lang.error('ExecutionErrorCodes.BooleanConditionRequired');\n        }\n      ${e.isAsync?"})}()))":"}()"}`}catch(e){throw e}}(e,n);case"when":return function(e,n){try{if(n.arguments.length<3)throw new s.ArcadeCompilationError(null,"WrongNumberOfParameters",n);if(n.arguments.length%2==0)throw new s.ArcadeCompilationError(null,"WrongNumberOfParameters",n);const t=e.symbols.nextTempVarId();let r="var ";for(let o=0;o<n.arguments.length-1;o+=2)r+=`${t} = lang.mustBoolean(${V(e,n.arguments[o])}, runtimeCtx);\n      if (${t} === true ) {\n        return ${V(e,n.arguments[o+1])}\n      }\n`;return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        ${r}\n        return ${V(e,n.arguments[n.arguments.length-1])}\n        ${e.isAsync?"})}()))":"}()"}`}catch(e){throw e}}(e,n);case"defaultvalue":return function(e,n){try{if(n.arguments.length<2||n.arguments.length>3)throw new s.ArcadeCompilationError(null,"WrongNumberOfParameters",n);const t=e.symbols.nextTempVarId(),r=e.symbols.nextTempVarId();return 3===n.arguments.length?`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n      var ${t} = ${V(e,n.arguments[0])};\n      var ${r} = ${V(e,n.arguments[1])};\n      ${t} = lang.getNestedOptionalValue(${t}, ${r});\n      return ${t} != null && ${t} !== "" ? ${t} : ${V(e,n.arguments[2])};\n      ${e.isAsync?"})}()))":"}()"}`:`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${V(e,n.arguments[0])};\n        if (${t} === null) {\n          return  ${V(e,n.arguments[1])};\n        }\n        if (${t} === "") {\n          return  ${V(e,n.arguments[1])};\n        }\n        if (${t} === undefined) {\n          return  ${V(e,n.arguments[1])};\n        }\n        return ${t};\n      ${e.isAsync?"})}()))":"}()"}`}catch(e){throw e}}(e,n);case"decode":return function(e,n){try{if(n.arguments.length<2)throw new s.ArcadeCompilationError(null,"WrongNumberOfParameters",n);if(2===n.arguments.length)return`(${V(e,n.arguments[1])})`;if((n.arguments.length-1)%2==0)throw new s.ArcadeCompilationError(null,"WrongNumberOfParameters",n);const t=e.symbols.nextTempVarId(),r=e.symbols.nextTempVarId();let o="var ";for(let l=1;l<n.arguments.length-1;l+=2)o+=`${r} = ${V(e,n.arguments[l])};\n      if (lang.binary(${r}, ${t}, "==") === true ) {\n        return ${V(e,n.arguments[l+1])}\n      }\n`;return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${V(e,n.arguments[0])};\n        ${o}\n        return ${V(e,n.arguments[n.arguments.length-1])}\n        ${e.isAsync?"})}()))":"}()"}`}catch(e){throw e}}(e,n)}let r;switch(t.scope){case"local":r=te(`lscope['${t.var}']`);break;case"global":r=te(`gscope['${t.var}']`);break;default:throw S.neverReached(t.scope),new s.ArcadeCompilationError(null,"NeverReach",n.callee)}let o="[";for(let t=0;t<n.arguments.length;t++)t>0&&(o+=", "),o+=V(e,n.arguments[t]);return o+="]",e.isAsync?"(yield lang.callfunc("+r+","+o+",runtimeCtx) )":"lang.callfunc("+r+","+o+",runtimeCtx)"}catch(e){throw e}}(e,n);case"UnaryExpression":return function(e,n){try{return"lang.unary("+V(e,n.argument)+",'"+n.operator+"')"}catch(e){throw e}}(e,n);case"BinaryExpression":return function(e,n){try{return"lang.binary("+V(e,n.left)+","+V(e,n.right)+",'"+n.operator+"')"}catch(e){throw e}}(e,n);case"LogicalExpression":return function(e,n){try{if("AssignmentExpression"===n.left.type||"UpdateExpression"===n.left.type)throw new s.ArcadeCompilationError(null,"LogicalExpressionOnlyBoolean",n);if("AssignmentExpression"===n.right.type||"UpdateExpression"===n.right.type)throw new s.ArcadeCompilationError(null,"LogicalExpressionOnlyBoolean",n);if("&&"===n.operator||"||"===n.operator)return"(lang.logicalCheck("+V(e,n.left)+") "+n.operator+" lang.logicalCheck("+V(e,n.right)+"))";throw new s.ArcadeCompilationError(null,"LogicExpressionOrAnd",null)}catch(e){throw e}}(e,n);case"ArrayExpression":return function(e,n){try{const t=[];for(let r=0;r<n.elements.length;r++)"Literal"===n.elements[r].type?t.push(V(e,n.elements[r])):t.push("lang.aCheck("+V(e,n.elements[r])+",'ArrayExpression')");return"["+t.join(",")+"]"}catch(e){throw e}}(e,n);case"ObjectExpression":return function(e,n){let t="lang.dictionary([";for(let r=0;r<n.properties.length;r++){const o=n.properties[r];let l;l="Identifier"===o.key.type?"'"+o.key.name+"'":V(e,o.key),r>0&&(t+=","),t+="lang.strCheck("+l+",'ObjectExpression'),lang.aCheck("+V(e,o.value)+", 'ObjectExpression')"}return t+="])",t}(e,n);default:throw new s.ArcadeCompilationError(null,"Unrecognized",n)}}function D(e,n){switch(n.type){case"EmptyStatement":return"lc.voidOperation";case"VariableDeclaration":return function(e,n){const t=[];for(let r=0;r<n.declarations.length;r++)t.push(Z(e,n.declarations[r]));return t.join("\n")+" \n lastStatement=  lc.voidOperation; \n"}(e,n);case"BlockStatement":return z(e,n);case"FunctionDeclaration":return function(e,n){const r=new Set(n.params.map(e=>t.toSymbolId(e))),o=l.collectDeclaredLocalNames(n);F.addMany(o,r);const a=e.symbols,i=new Map;for(const e of o)i.set(e,a.nextVarId());const s=a.nextLocalsSymbolMapId();e.allLocalSymbolMetadata.set(s,i);const c={...e,localScope:i},u=[`lscope._SymbolsMapId = ${JSON.stringify(s)};`];for(let e=0;e<n.params.length;e++){const t=j(c,n.params[e],"local");W(t),u.push(`lscope['${t.var}'] = arguments[${e}];`)}for(const[e,n]of i)r.has(e)||u.push(`lscope['${n}'] = ${ne};`);const d=z(c,n.body),m=!0===e.isAsync?["return lang.__awaiter(this, void 0, void 0, function* () {",`  ${d}`,"  return lastStatement;","});"]:[d,"return lastStatement;"],p=["new lang.UserDefinedCompiledFunction(","  lang.functionDepthchecker(","    function() {","      var lastStatement = lc.voidOperation;","      var lscope = runtimeCtx.localStack[runtimeCtx.localStack.length-1];",...u,...m,"    },","    runtimeCtx,","  ),",`  ${n.params.length},`,")"].join("\n"),f=j(e,n.id,"global");return W(f),`gscope['${f.var}']=${p}; lastStatement = lc.voidOperation;`}(e,n);case"ImportDeclaration":return function(e,n){const r=j(e,n.specifiers[0].local,"global"),l=e.libraryResolver?.loadLibrary(r.name),a=e.symbols.nextVarId();void 0===e.moduleFactory[l.uri]&&(e.moduleFactory[l.uri]=function(e,n,r){const l=new o.ArcadeModuleLoader(null,e.loadedModules),a=T(e,r?Q.provided:H.provided,new Set,r,l,n);let i;i=r?["var runtimeCtx = this.prepare(context, true);","var lc = this.lc;","var lang = this.lang;","var gscope = runtimeCtx.globalScope;","return lang.__awaiter(this, void 0, void 0, function* () {","  function mainBody() {","    return lang.__awaiter(this, void 0, void 0, function* () {",`      ${a.body}`,"    });","  }","  yield mainBody();","  return this.prepareModule(runtimeCtx);","});"].join("\n"):["var runtimeCtx = this.prepare(context, false);","var lc = this.lc;","var lang = this.lang;","var gscope = runtimeCtx.globalScope;","function mainBody() {",`  ${a.body}`,"}","mainBody();","return this.prepareModule(runtimeCtx);"].join("\n");const{symbolMetadata:s,moduleFactoryMap:c}=a,u={lc:d.lc,lang:re,prepareModule:e=>new le(e),prepare(e,r){const o=e.spatialReference??M.WebMercator,l=r?new Q:new H;return{lrucache:e.lrucache,interceptor:e.interceptor,services:e.services,console:e.console??oe,abortSignal:e.abortSignal??t.neverAbortedSignal,timeZone:e.timeZone??null,spatialReference:o,track:null,globalScope:l,localStack:[],depthCounter:e.depthCounter,symbolMetadata:s,moduleFactory:n,moduleFactoryMap:c,moduleSingletons:e.moduleSingletons}}};return new Function("context",i).bind(u)}(l.syntax,e.moduleFactory,e.isAsync)),e.moduleFactoryMap[a]=l.uri;let i="";return i=e.isAsync?"(yield lang.loadModule('"+a+"', runtimeCtx) ); ":"lang.loadModule('"+a+"', runtimeCtx); ",W(r),`gscope['${r.var}']=${i}`}(e,n);case"ExportNamedDeclaration":return D(e,n.declaration);case"ReturnStatement":return function(e,n){return null===n.argument?"return lc.voidOperation":"return "+V(e,n.argument)}(e,n);case"IfStatement":return q(e,n);case"ExpressionStatement":return function(e,n){return"AssignmentExpression"===n.expression.type?"lastStatement = lc.voidOperation; "+V(e,n.expression)+"; \n ":"lastStatement = "+V(e,n.expression)+"; "}(e,n);case"BreakStatement":return"break";case"ContinueStatement":return"continue";case"ForStatement":return function(e,n){let t="lastStatement = lc.voidOperation; \n";null!==n.init&&("VariableDeclaration"===n.init.type?t+=D(e,n.init):t+=V(e,n.init)+"; ");const r=e.symbols.nextTempVarId(),o=e.symbols.nextTempVarId();return t+="var "+r+" = true; ",t+="\n do { ",null!==n.update&&(t+=" if ("+r+"===false) {\n "+V(e,n.update)+"  \n}\n "+r+"=false; \n"),null!==n.test&&(t+="var "+o+" = "+V(e,n.test)+"; ",t+="if ("+o+"===false) { break; } else if ("+o+"!==true) { lang.error('BooleanConditionRequired');   }\n"),t+=D(e,n.body),null!==n.update&&(t+="\n "+V(e,n.update)),t+="\n"+r+" = true; \n} while(true);  lastStatement = lc.voidOperation; ",t}(e,n);case"ForInStatement":return function(e,n){const t=e.symbols.nextTempVarId();let r,o,l="var "+t+" = "+V(e,n.right)+";\n";switch("VariableDeclaration"===n.left.type?(r=j(e,n.left.declarations[0].id),l+=D(e,n.left)):r=B(e,n.left),r.scope){case"local":o=`lscope['${r.var}']`;break;case"global":o=`gscope['${r.var}']`;break;default:throw S.neverReached(r.scope),new s.ArcadeCompilationError(null,"NeverReach",n.left)}return l+="if ("+t+"===null) {  lastStatement = lc.voidOperation; }\n ",l+="else if (lc.isArray("+t+") || lc.isString("+t+")) {\n",l+=P(e,o,`${t}.length`,n.body),l+="}\n",l+="else if (lc.isImmutableArray("+t+")) {\n",l+=P(e,o,`${t}.length()`,n.body),l+="}\n",l+="else if (( "+t+" instanceof lang.Dictionary) || lc.isDictionaryLike("+t+")) {\n",l+=G(e,o,`${t}.keys()`,n.body),l+="}\n",e.isAsync&&(l+="else if (lc.isFeatureSet("+t+")) {\n",l+=U(e,o,t,n.body),l+="}\n"),l+=`else if (lc.isGeometry(${t})) {\n`,l+=G(e,o,`lang.getGeometryKeys(${t})`,n.body),l+="}\n",l+="else { lastStatement = lc.voidOperation; } \n",l}(e,n);case"ForOfStatement":return function(e,n){const t=e.symbols.nextTempVarId();let r,o,l="var "+t+" = "+V(e,n.right)+";\n";switch("VariableDeclaration"===n.left.type?(r=j(e,n.left.declarations[0].id),l+=D(e,n.left)):r=B(e,n.left),r.scope){case"local":o=`lscope['${r.var}']`;break;case"global":o=`gscope['${r.var}']`;break;default:throw S.neverReached(r.scope),new s.ArcadeCompilationError(null,"NeverReach",n.left)}return l+="if ("+t+"===null) {  lastStatement = lc.voidOperation; }\n ",l+="else if (lc.isArray("+t+") || lc.isString("+t+")) {\n",l+=P(e,o,`${t}.length`,n.body,(e,n)=>[`if (${n} >= ${t}.length) {`,"  lang.error('OutOfBounds');","}",`${e} = ${t}[${n}];`].join("\n")),l+="}\n",l+="else if (lc.isImmutableArray("+t+")) {\n",l+=P(e,o,`${t}.length()`,n.body,(e,n)=>`${e} = ${t}.get(${n});`),l+="}\n",l+="else if (( "+t+" instanceof lang.Dictionary) || lc.isDictionaryLike("+t+")) {\n",l+=G(e,o,`${t}.keys()`,n.body,e=>`lang.entry(${e}, ${t}.field(${e}))`),l+="}\n",e.isAsync&&(l+="else if (lc.isFeatureSet("+t+")) {\n",l+=U(e,o,t,n.body),l+="}\n"),l+=`else if (lc.isGeometry(${t})) {\n`,l+=G(e,o,`lang.getGeometryKeys(${t})`,n.body,e=>`lang.entry(${e}, lang.geometryMember(${t}, ${e}, runtimeCtx, null, 1))`),l+="}\n",l+="else { lastStatement = lc.voidOperation; } \n",l}(e,n);case"WhileStatement":return function(e,n){let t="lastStatement = lc.voidOperation; \n";const r=e.symbols.nextTempVarId();return t+=`\n  var ${r} = true;\n    do {\n      ${r} = ${V(e,n.test)};\n      if (${r}==false) {\n        break;\n      }\n      if (${r}!==true) {\n        lang.error('BooleanConditionRequired');\n      }\n      ${D(e,n.body)}\n    }\n    while (${r} !== false);\n    lastStatement = lc.voidOperation;\n  `,t}(e,n);default:throw new s.ArcadeCompilationError(null,"Unrecognized",n)}}function P(e,n,t,r,o=(e,n)=>`${e} = ${n}`){const l=e.symbols.nextTempVarId(),a=e.symbols.nextTempVarId();return[`var ${l} = ${t};`,`for (var ${a} = 0; ${a} < ${l}; ${a}++) {`,`  ${o(n,a)}`,`  ${D(e,r)}`,"}","lastStatement = lc.voidOperation;"].join("\n")}function G(e,n,t,r,o=e=>e){const l=e.symbols.nextTempVarId(),a=e.symbols.nextTempVarId();return[`var ${l} = ${t};`,`for (var ${a} of ${l}) {`,`  ${n} = ${o(a)};`,`  ${D(e,r)}`,"}","lastStatement = lc.voidOperation;"].join("\n")}function U(e,n,t,r){const o=e.symbols.nextTempVarId();return[`var ${o} = ${t}.iterator(runtimeCtx.abortSignal);`,`while ((${n} = lang.graphicToFeature(yield ${o}.next(), ${t}, runtimeCtx)) != null) {`,`  ${D(e,r)}`,"}","lastStatement = lc.voidOperation;"].join("\n")}function K(e,n){return"BlockStatement"===n.type?D(e,n):"ReturnStatement"===n.type||"BreakStatement"===n.type||"ContinueStatement"===n.type?D(e,n)+"; ":"ExpressionStatement"===n.type?D(e,n):D(e,n)+"; "}function q(e,n){return`if (lang.mustBoolean(${V(e,n.test)}, runtimeCtx) === true) {\n    ${K(e,n.consequent)}\n  } `+(null!==n.alternate?"IfStatement"===n.alternate.type?" else "+q(e,n.alternate):` else {\n      ${K(e,n.alternate)}\n    }\n`:" else {\n      lastStatement = lc.voidOperation;\n    }\n")}function z(e,n){let t="";for(let r=0;r<n.body.length;r++)"EmptyStatement"!==n.body[r].type&&("ReturnStatement"===n.body[r].type||"BreakStatement"===n.body[r].type||"ContinueStatement"===n.body[r].type?t+=D(e,n.body[r])+"; \n":t+=D(e,n.body[r])+" \n");return t}function W(e){if("global"===e.scope)switch(e.name){case"iif":case"when":case"defaultvalue":case"decode":throw new s.ArcadeUncompilableError}}function Z(e,n){const t=null===n.init?"null":V(e,n.init),r=j(e,n.id);switch(W(r),r.scope){case"local":return`lscope['${r.var}']=${t};`;case"global":return`gscope['${r.var}']=${t};`;default:throw S.neverReached(r.scope),new s.ArcadeCompilationError(null,"NeverReach",n.id)}}function J(e,n){try{return _(e,n,(e,n)=>{throw new s.ArcadeExecutionError(e,"Unrecognized",n)})}catch(e){throw e}}function Y(e){const n=function(){this.textformatting=i.textFormatting()};n.prototype=Object.create(null),n.provided=new Set(["textformatting","infinity","pi"]),n.prototype.infinity=Number.POSITIVE_INFINITY,n.prototype.pi=Math.PI;for(const[t,r]of Object.entries(e))n.prototype[t]=new u.NativeFunction(r),n.provided.add(t);return n}const{ScopeSync:H,ScopeAsync:Q}=function(){const e=Object.create(null);g.registerFunctions(e,_),x.registerFunctions(e,_),h.registerFunctions(e,_,L),w.registerFunctions(e,_),y.registerFunctions(e,_),E.registerFunctions(e,_),v.registerFunctions(e,_),e.iif=J,e.decode=J,e.when=J,e.defaultvalue=J;const n=Y(e);return b.registerFunctions(e,_),{ScopeSync:Y(e),ScopeAsync:n}}();function X(e,n){const t={mode:n,compiled:!0,functions:Object.create(null),signatures:[],standardFunction:_,standardFunctionAsync:_,evaluateIdentifier:L};for(const n of e)n.registerFunctions(t);if("sync"===n)for(const[e,n]of Object.entries(t.functions))H.prototype[e]=new u.NativeFunction(n),H.provided.add(e);else for(const[e,n]of Object.entries(t.functions))Q.prototype[e]=new u.NativeFunction(n),Q.provided.add(e);for(const e of t.signatures)m.addFunctionDeclaration(e,n)}X([f.ArrayFunctions],"sync"),X([f.ArrayFunctions],"async"),X([p.AiFunctions],"async");const ee=Symbol("uninitialized"),ne="lang.uninitialized";function te(e){return`lang.requireInitialized(${e})`}const re={uninitialized:ee,requireInitialized(e){if(e===ee)throw new s.ArcadeExecutionError(null,"InvalidIdentifier",null);return e},isNumber:e=>N.isNumber(e),isArray:e=>N.isArray(e),isImmutableArray:e=>d.isImmutableArray(e),isDictionaryLike:e=>d.isDictionaryLike(e),isString:e=>N.isString(e),isDictionary:e=>d.isDictionary(e),isGeometry:e=>d.isGeometry(e),getGeometryKeys:e=>a.getGeometryKeys(e),geometryMember:(e,n,t,r,o=1)=>a.geometryMember(e,n,t,r,o),error(e){throw new s.ArcadeExecutionError(null,e,null)},__awaiter(e,n,t,r){const o=r.apply(e,n||[]);let l=o.next();for(;!l.done&&!A.isPromiseLike(l.value);)l=o.next(l.value);return l.done?l.value:new Promise((e,n)=>{!function t(r){for(;!r.done;){if(A.isPromiseLike(r.value))return void Promise.resolve(r.value).then(e=>{try{t(o.next(e))}catch(e){n(e)}},e=>{try{t(o.throw(e))}catch(e){n(e)}});try{r=o.next(r.value)}catch(e){return void n(e)}}e(r.value)}(l)})},functionDepthchecker:(e,n)=>function(){if(n.depthCounter.depth++,n.localStack.push({}),n.depthCounter.depth>64)throw new s.ArcadeExecutionError(null,"MaximumCallDepth",null);const t=e.apply(this,arguments);return A.isPromiseLike(t)?t.then(e=>(n.depthCounter.depth--,n.localStack.length=n.localStack.length-1,e)):(n.depthCounter.depth--,n.localStack.length=n.localStack.length-1,t)},mustBoolean(e,n){if(!0===e||!1===e)return e;throw new s.ArcadeExecutionError(n,"BooleanConditionRequired",null)},castString:e=>d.toString(e),aCheck(e,n){if(d.isFunctionParameter(e)){if("ArrayExpression"===n)throw new s.ArcadeExecutionError(null,"NoFunctionInArray",null);if("ObjectExpression"===n)throw new s.ArcadeExecutionError(null,"NoFunctionInDictionary",null);throw new s.ArcadeExecutionError(null,"NoFunctionInTemplateLiteral",null)}return e===d.voidOperation?null:e},Dictionary:i,Feature:c,UserDefinedCompiledFunction:R,dictionary(e){const n=Object.create(null),t=new Map;for(let r=0;r<e.length;r+=2){if(d.isFunctionParameter(e[r+1]))throw new s.ArcadeExecutionError(null,"NoFunctionInDictionary",null);if(!1===N.isString(e[r]))throw new s.ArcadeExecutionError(null,"KeyMustBeString",null);let o=e[r].toString();const l=o.toLowerCase();t.has(l)?o=t.get(l):t.set(l,o),e[r+1]===d.voidOperation?n[o]=null:n[o]=e[r+1]}const r=new i(n);return r.immutable=!1,r},entry:(e,n)=>i.containerEntry(e,n),strCheck(e){if(!1===N.isString(e))throw new s.ArcadeExecutionError(null,"KeyMustBeString",null);return e},unary(e,n){if(N.isBoolean(e)){if("!"===n)return!e;if("-"===n)return-1*d.toNumber(e);if("+"===n)return 1*d.toNumber(e);if("~"===n)return~d.toNumber(e);throw new s.ArcadeExecutionError(null,"UnsupportUnaryOperator",null)}if("-"===n)return-1*d.toNumber(e);if("+"===n)return 1*d.toNumber(e);if("~"===n)return~d.toNumber(e);throw new s.ArcadeExecutionError(null,"UnsupportUnaryOperator",null)},logicalCheck(e){if(!1===N.isBoolean(e))throw new s.ArcadeExecutionError(null,"LogicExpressionOrAnd",null);return e},logical(e,n,t){if(N.isBoolean(e)&&N.isBoolean(n))switch(t){case"||":return e||n;case"&&":return e&&n;default:throw new s.ArcadeExecutionError(null,"LogicExpressionOrAnd",null)}throw new s.ArcadeExecutionError(null,"LogicExpressionOrAnd",null)},binary(e,n,t){switch(t){case"|":case"<<":case">>":case">>>":case"^":case"&":return d.binaryOperator(d.toNumber(e),d.toNumber(n),t);case"==":case"=":return d.equalityTest(e,n);case"!=":return!d.equalityTest(e,n);case"<":case">":case"<=":case">=":return d.greaterThanLessThan(e,n,t);case"+":return N.isString(e)||N.isString(n)?d.toString(e)+d.toString(n):d.toNumber(e)+d.toNumber(n);case"-":return d.toNumber(e)-d.toNumber(n);case"*":return d.toNumber(e)*d.toNumber(n);case"/":return d.toNumber(e)/d.toNumber(n);case"%":return d.toNumber(e)%d.toNumber(n);default:throw new s.ArcadeExecutionError(null,"UnsupportedOperator",null)}},assign(e,n,t){switch(n){case"=":return e===d.voidOperation?null:e;case"/=":return d.toNumber(t)/d.toNumber(e);case"*=":return d.toNumber(t)*d.toNumber(e);case"-=":return d.toNumber(t)-d.toNumber(e);case"+=":return N.isString(t)||N.isString(e)?d.toString(t)+d.toString(e):d.toNumber(t)+d.toNumber(e);case"%=":return d.toNumber(t)%d.toNumber(e);default:throw new s.ArcadeExecutionError(null,"UnsupportedOperator",null)}},update(e,n,t,r){const o=d.toNumber(this.requireInitialized(e[n]));return e[n]="++"===t?o+1:o-1,!1===r?o:"++"===t?o+1:o-1},graphicToFeature:(e,n,t)=>null===e?null:c.createFromGraphicLikeObject(e.geometry,e.attributes,n,t.timeZone),memberupdate(e,n,t,r){let o;if(N.isArray(e)){if(!N.isNumber(n))throw new s.ArcadeExecutionError(null,"ArrayAccessMustBeNumber",null);if(n<0&&(n=e.length+n),n<0||n>=e.length)throw new s.ArcadeExecutionError(null,"OutOfBounds",null);o=d.toNumber(e[n]),e[n]="++"===t?o+1:o-1}else if(e instanceof i){if(!1===N.isString(n))throw new s.ArcadeExecutionError(null,"KeyAccessorMustBeString",null);if(!0!==e.hasField(n))throw new s.ArcadeExecutionError(null,"FieldNotFound",null,{key:n});o=d.toNumber(e.field(n)),e.setField(n,"++"===t?o+1:o-1)}else if(d.isFeature(e)){if(!1===N.isString(n))throw new s.ArcadeExecutionError(null,"KeyAccessorMustBeString",null);if(!0!==e.hasField(n))throw new s.ArcadeExecutionError(null,"FieldNotFound",null);o=d.toNumber(e.field(n)),e.setField(n,"++"===t?o+1:o-1)}else{if(d.isImmutableArray(e))throw new s.ArcadeExecutionError(null,"Immutable",null);if(!(e instanceof le))throw new s.ArcadeExecutionError(null,"InvalidIdentifier",null);if(!1===N.isString(n))throw new s.ArcadeExecutionError(null,"ModuleAccessorMustBeString",null);if(!0!==e.hasGlobal(n))throw new s.ArcadeExecutionError(null,"ModuleExportNotFound",null);o=d.toNumber(e.global(n)),e.setGlobal(n,"++"===t?o+1:o-1)}return!1===r?o:"++"===t?o+1:o-1},assignmember(e,n,t,r){if(N.isArray(e)){if(!N.isNumber(n))throw new s.ArcadeExecutionError(null,"ArrayAccessMustBeNumber",null);if(n<0&&(n=e.length+n),n<0||n>e.length)throw new s.ArcadeExecutionError(null,"OutOfBounds",null);if(n===e.length){if("="!==t)throw new s.ArcadeExecutionError(null,"OutOfBounds",null);e[n]=this.assign(r,t,e[n])}else e[n]=this.assign(r,t,e[n])}else if(e instanceof i){if(!1===N.isString(n))throw new s.ArcadeExecutionError(null,"KeyAccessorMustBeString",null);if(!0===e.hasField(n))e.setField(n,this.assign(r,t,e.field(n)));else{if("="!==t)throw new s.ArcadeExecutionError(null,"FieldNotFound",null);e.setField(n,this.assign(r,t,null))}}else if(d.isFeature(e)){if(!1===N.isString(n))throw new s.ArcadeExecutionError(null,"KeyAccessorMustBeString",null);if(!0===e.hasField(n))e.setField(n,this.assign(r,t,e.field(n)));else{if("="!==t)throw new s.ArcadeExecutionError(null,"FieldNotFound",null);e.setField(n,this.assign(r,t,null))}}else{if(d.isImmutableArray(e))throw new s.ArcadeExecutionError(null,"Immutable",null);if(!(e instanceof le))throw new s.ArcadeExecutionError(null,"InvalidIdentifier",null);if(!1===N.isString(n))throw new s.ArcadeExecutionError(null,"ModuleAccessorMustBeString",null);if(!e.hasGlobal(n))throw new s.ArcadeExecutionError(null,"ModuleExportNotFound",null);e.setGlobal(n,this.assign(r,t,e.global(n)))}},member(e,n){if(null===e)throw new s.ArcadeExecutionError(null,"MemberOfNull",null);if(e instanceof i||d.isDictionaryLike(e)){if(N.isString(n))return e.field(n);throw new s.ArcadeExecutionError(null,"InvalidMemberAccessKey",null)}if(e instanceof C){if(N.isString(n))return a.geometryMember(e,n,null,null);throw new s.ArcadeExecutionError(null,"InvalidMemberAccessKey",null)}if(N.isArray(e)){if(N.isNumber(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length+n),n>=e.length||n<0)throw new s.ArcadeExecutionError(null,"OutOfBounds",null);return e[n]}throw new s.ArcadeExecutionError(null,"InvalidMemberAccessKey",null)}if(N.isString(e)){if(N.isNumber(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length+n),n>=e.length||n<0)throw new s.ArcadeExecutionError(null,"OutOfBounds",null);return e[n]}throw new s.ArcadeExecutionError(null,"InvalidMemberAccessKey",null)}if(d.isImmutableArray(e)){if(N.isNumber(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length()+n),n>=e.length()||n<0)throw new s.ArcadeExecutionError(null,"OutOfBounds",null);return e.get(n)}throw new s.ArcadeExecutionError(null,"InvalidMemberAccessKey",null)}if(e instanceof le){if(N.isString(n))return e.global(n);throw new s.ArcadeExecutionError(null,"InvalidMemberAccessKey",null)}throw new s.ArcadeExecutionError(null,"InvalidMemberAccessKey",null)},callfunc:(e,n,t)=>e.call(t,{arguments:n,preparsed:!0}),loadModule(e,n){const t=n.moduleFactoryMap[e];if(n.moduleSingletons[t])return n.moduleSingletons[t];const r=n.moduleFactory[t]({moduleSingletons:n.moduleSingletons,depthCounter:n.depthCounter,lrucache:n.lrucache,interceptor:n.interceptor,services:n.services,console:n.console,abortSignal:n.abortSignal,timeZone:n.timeZone??null,spatialReference:n.spatialReference});return n.moduleSingletons[t]=r,r},callModuleFunction(e,n,t,r){if(!(e instanceof le))throw new s.ArcadeExecutionError(null,"FunctionNotFound",null);const o=e.global(t);if(!1===d.isFunctionParameter(o))throw new s.ArcadeExecutionError(null,"CallNonFunction",null);return o.call(r,{preparsed:!0,arguments:n})},getNestedOptionalValue:(e,n)=>a.getNestedOptionalValue(e,n)};function oe(e){console.log(e)}class le extends r.ArcadeModule{constructor(e){super(),this.moduleContext=e}hasGlobal(e){const n=this.moduleContext.symbolMetadata.exports;return n.has(e)||n.has(t.toSymbolId(e))}setGlobal(e,n){if(d.isFunctionParameter(n))throw new s.ArcadeExecutionError(null,"AssignModuleFunction",null);const r=this.moduleContext.symbolMetadata.globals.get(t.toSymbolId(e));if(null==r)throw new s.ArcadeExecutionError(null,"ModuleExportNotFound",null);this.moduleContext.globalScope[r]=n}global(e){const n=this.moduleContext.symbolMetadata.globals.get(t.toSymbolId(e));if(null==n)throw new s.ArcadeExecutionError(null,"ModuleExportNotFound",null);const r=this.moduleContext.globalScope,o=re.requireInitialized(r[n]);if(d.isFunctionParameter(o)&&!(o instanceof u.ScopeMarshalledFunction)){const e=new u.ScopeMarshalledFunction;return e.fn=o,e.parameterEvaluator=_,e.context=this.moduleContext,r[n]=e,e}return o}}n.UserDefinedCompiledFunction=R,n.compileScript=function(e,n,r=!1){let l=null;e.usesModules&&(l=new o.ArcadeModuleLoader(null,e.loadedModules));const a=Object.create(null),i=new Set(Object.keys(n?.vars||{}).map(e=>t.toSymbolId(e))),u=new Set(Object.keys(n?.customfunctions||{}).map(e=>t.toSymbolId(e))),m=T(e,r?Q.provided:H.provided,new Set([...i,...u]),r,l,a);let p;p=r?["var runtimeCtx = this.prepare(context, true);","var lc = this.lc;","var lang = this.lang;","var gscope = runtimeCtx.globalScope;","return lang.__awaiter(this, void 0, void 0, function* () {","  function mainBody() {","    return lang.__awaiter(this, void 0, void 0, function* () {",`      ${m.body}`,"    });","  }","  return this.postProcess(yield mainBody());","});"].join("\n"):["var runtimeCtx = this.prepare(context, false);","var lc = this.lc;","var lang = this.lang;","var gscope = runtimeCtx.globalScope;","function mainBody() {",`  ${m.body}`,"}","return this.postProcess(mainBody());"].join("\n");const{symbolMetadata:f,moduleFactoryMap:g}=m,h={lc:d.lc,lang:re,postProcess(e){if(d.isVoid(e))return null;if(d.isFunctionParameter(e))throw new s.ArcadeExecutionError(null,"IllegalResult",null);return e},prepare(e,n){const r=e.spatialReference??M.WebMercator,o=n?new Q:new H;for(const n of u)null!=e.customfunctions&&n in e.customfunctions?o[n]=e.customfunctions[n]??null:o[n]=ee;for(const n of i){if(null==e.vars||!(n in e.vars)){n in o||(o[n]=ee);continue}const t=e.vars[n]??null;N.isGraphic(t)?o[n]=c.createFromGraphic(t,e.timeZone??null):o[n]=t}return{lrucache:e.lrucache,interceptor:e.interceptor,services:e.services,console:e.console??oe,abortSignal:e.abortSignal??t.neverAbortedSignal,timeZone:e.timeZone??null,spatialReference:r,track:e.track,globalScope:o,localStack:[],depthCounter:{depth:1},symbolMetadata:f,moduleFactory:a,moduleFactoryMap:g,moduleSingletons:Object.create(null)}}};return new Function("context",p).bind(h)},n.enableAsyncSupport=async function(){return X([await new Promise((n,t)=>e(["./functions/geomasync"],n,t))],"async"),!0},n.extend=X,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});