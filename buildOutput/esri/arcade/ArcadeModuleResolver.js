// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../request","./executionError","./parser","./featureset/support/RecentlyUsedCache","../portal/Portal"],function(e,t,r,o,s,i){"use strict";class l{constructor(e){this.portalUri=e}static{this.mocks={}}static{this.cachedModules=new s(30)}normalizeModuleUri(e){const t=/^[a-z0-9]+(@[0-9]+\.[0-9]+\.[0-9]+)?([?|/].*)?$/gi,o=/(?<portalurl>.+)\/home\/item\.html\?id=(?<itemid>.+)$/gi,s=/(?<portalurl>.+)\/sharing\/rest\/content\/users\/[a-z0-9]+\/items\/(?<itemid>.+)$/gi,c=/(?<portalurl>.+)\/sharing\/rest\/content\/items\/(?<itemid>.+)$/gi,u=/(?<itemid>.*)@(?<versionstring>[0-9]+\.[0-9]+\.[0-9]+)([?|/].*)?$/gi;if(e.startsWith("portal+")){let l=e.slice(7),a="",n=l,d=!1;for(const e of[o,c,s]){const t=e.exec(l);if(null!==t){const e=t.groups;n=e.itemid,a=e.portalurl,d=!0;break}}if(!1===d){if(!t.test(l))throw new r.ModuleError("UnsupportedUriProtocol",{uri:e});n=l,a=this.portalUri}n.includes("/")&&(n=n.split("/")[0]),n.includes("?")&&(n=n.split("?")[0]);let h="current";const m=u.exec(n);if(null!==m){const e=m.groups;n=e.itemid,h=e.versionstring}return l=new i({url:a}).restUrl+"/content/items/"+n+"/resources/"+h+".arc",{url:l,scheme:"portal",uri:"PO:"+l}}if(e.startsWith("mock")){if("mock"===e)return{url:"",scheme:"mock",data:'\n      export var hello = 1;\n      export function helloWorld() {\n          return "Hello World " + hello;\n      }\n  ',uri:"mock"};const t=e.replace("mock:","");if(void 0!==l.mocks[t])return{url:"",scheme:"mock",data:l.mocks[t],uri:e}}throw new r.ModuleError("UnrecognizedUri",{uri:e})}async fetchModule(e){const t=l.cachedModules.getFromCache(e.uri);if(t)return t;const r=this.fetchSource(e);l.cachedModules.addToCache(e.uri,r);let o=null;try{o=await r}catch(t){throw l.cachedModules.removeFromCache(e.uri),t}return o}async fetchSource(e){if("portal"===e.scheme){const r=await t(e.url,{responseType:"text",query:{}});if(r.data)return o.parseScript(r.data,[])}if("mock"===e.scheme)return o.parseScript(e.data??"",[]);throw new r.ModuleError("UnsupportedUriProtocol")}static create(e){return new l(e)}static{this._default=null}static getDefault(){return this._default??(l._default=l._moduleResolverFactory())}static set moduleResolverClass(e){this._moduleResolverFactory=e,this._default=null}static{this._moduleResolverFactory=()=>{const e=i.getDefault();return new l(e.url)}}}e.ArcadeModuleResolver=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});