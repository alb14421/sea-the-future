// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","./arcadeEnvironment","./ArcadeModule","./ArcadeModuleLoader","./compilerUtils","./containerUtils","./Dictionary","./executionError","./Feature","./FunctionWrapper","../chunks/languageUtils","./treeAnalysis","../chunks/array","./functions/date","./functions/feature","./functions/geometry","./functions/geomsync","./functions/maths","./functions/stats","./functions/string","./functions/track","../core/has","../core/Logger","../geometry/Geometry","../geometry/SpatialReference","../support/guards"],function(e,r,t,o,n,i,c,a,s,l,u,d,f,p,h,w,m,b,E,g,y,x,A,v,R,S){"use strict";const N=()=>A.getLogger("esri.arcade.arcadeRuntime"),F=Symbol("uninitialized");function O(e){if(e===F)throw new a.ArcadeExecutionError(null,"InvalidIdentifier",null)}function I(e){return O(e),e}function k(e,t){const o=r.toSymbolId(t);if(null!==e.localScope){const r=e.localScope[o];if(void 0!==r)return{scope:e.localScope,id:o,var:r}}const n=e.globalScope[o];if(void 0!==n)return{scope:e.globalScope,id:o,var:n};throw new a.ArcadeExecutionError(e,"InvalidIdentifier",t)}function M(e,t,o="InvalidIdentifier"){const n=r.toSymbolId(t);if(null!==e.localScope){const r=e.localScope[n];if(void 0!==r)return O(r),r.value}const i=e.globalScope[n];if(void 0!==i)return O(i),i.value;throw new a.ArcadeExecutionError(e,o,t)}const C=function(){};C.prototype=Object.freeze(Object.create(null));class B extends l.ArcadeFunction{constructor(e,r,t,o){super(),this.definition=e,this.context=r,this._params=t,this._locals=o}createFunction(e){return(...r)=>{const t={spatialReference:this.context.spatialReference,console:this.context.console,services:this.context.services,timeZone:this.context.timeZone??null,lrucache:this.context.lrucache,exports:this.context.exports,libraryResolver:this.context.libraryResolver,interceptor:this.context.interceptor,abortSignal:this.context.abortSignal,localScope:new C,depthCounter:{depth:e.depthCounter.depth+1},globalScope:this.context.globalScope,track:this.context.track};if(t.depthCounter.depth>64)throw new a.ArcadeExecutionError(e,"MaximumCallDepth",null);return G(t,this.definition.body,this._params,this._locals,r,null)}}call(e,r){return L(e,r,(t,o,n)=>{const i={spatialReference:e.spatialReference,services:e.services,globalScope:e.globalScope,depthCounter:{depth:e.depthCounter.depth+1},libraryResolver:e.libraryResolver,exports:e.exports,timeZone:e.timeZone??null,console:e.console,lrucache:e.lrucache,interceptor:e.interceptor,abortSignal:e.abortSignal,localScope:new C,track:e.track};if(i.depthCounter.depth>64)throw new a.ArcadeExecutionError(e,"MaximumCallDepth",r);return G(i,this.definition.body,this._params,this._locals,n,r)})}marshalledCall(e,r,t,o){return o(e,r,(n,i,c)=>{const a={spatialReference:e.spatialReference,globalScope:t.globalScope,services:e.services,depthCounter:{depth:e.depthCounter.depth+1},libraryResolver:e.libraryResolver,exports:e.exports,console:e.console,timeZone:e.timeZone??null,lrucache:e.lrucache,interceptor:e.interceptor,abortSignal:e.abortSignal,localScope:new C,track:e.track};return c=c.map(r=>!u.isFunctionParameter(r)||r instanceof l.ScopeMarshalledFunction?r:l.wrapModuleScopedResponse(r,e,o)),l.wrapModuleScopedResponse(G(a,this.definition.body,this._params,this._locals,c,r),t,o)})}}function G(e,r,t,o,n,i){try{if(t.length!==n.length)throw new a.ArcadeExecutionError(e,"WrongNumberOfParameters",i);if(null!=e.localScope){for(let r=0;r<t.length;r++)e.localScope[t[r]]={value:n[r]};for(const r of o)e.localScope[r]=F}const c=P(e,r);if(c instanceof u.ReturnResult)return c.value;if(c===u.breakResult)throw new a.ArcadeExecutionError(e,"UnexpectedToken",i);if(c===u.continueResult)throw new a.ArcadeExecutionError(e,"UnexpectedToken",i);return c instanceof u.ImplicitResult?c.value:c}catch(e){throw e}}class D extends t.ArcadeModule{constructor(e){super(),this.moduleGlobalContext=e}global(e){const t=r.toSymbolId(e),o=this.moduleGlobalContext.globalScope[t];if(O(o),u.isFunctionParameter(o.value)&&!(o.value instanceof l.ScopeMarshalledFunction)){const e=new l.ScopeMarshalledFunction;return e.fn=o.value,e.parameterEvaluator=L,e.context=this.moduleGlobalContext,this.moduleGlobalContext.globalScope[t]={value:e},e}return o.value}setGlobal(e,t){if(u.isFunctionParameter(t))throw new a.ArcadeExecutionError(null,"AssignModuleFunction",null);const o=r.toSymbolId(e);if(void 0===this.moduleGlobalContext.globalScope[o])throw new a.ArcadeExecutionError(null,"ModuleExportNotFound",null);this.moduleGlobalContext.globalScope[o]={value:t}}hasGlobal(e){return this.moduleGlobalContext.exports.has(r.toSymbolId(e))}static load(e,t){const{globals:i,exports:c}=n.collectDeclaredGlobalNames(t),a=new Q;for(const e of i)e in a||(a[e]=F);const s=e.spatialReference??R.WebMercator,l={lrucache:e.lrucache,interceptor:e.interceptor,services:e.services,console:e.console??ee,abortSignal:r.neverAbortedSignal,timeZone:e.timeZone??null,spatialReference:s,track:e.track,depthCounter:{depth:1},libraryResolver:new o.ArcadeModuleLoader(e.libraryResolver._moduleSingletons,t.loadedModules),exports:c,localScope:null,globalScope:a};return _(l,t),new D(l)}}function L(e,r,t){try{return!0===r.preparsed?t(e,null,r.arguments):t(e,r,function(e,r){const t=[];for(let o=0;o<r.arguments.length;o++)t.push(j(e,r.arguments[o]));return t}(e,r))}catch(e){throw e}}function j(e,r){try{switch(r.type){case"AssignmentExpression":return function(e,r){if("MemberExpression"===r.left.type){const t=j(e,r.left.object);let o;if(!0===r.left.computed)o=j(e,r.left.property);else{if("Identifier"!==r.left.property.type)throw new a.ArcadeExecutionError(e,"InvalidIdentifier",r);o=r.left.property.name}const n=j(e,r.right);if(S.isArray(t)){if(!S.isNumber(o))throw new a.ArcadeExecutionError(e,"ArrayAccessMustBeNumber",r);if(o<0&&(o=t.length+o),o<0||o>t.length)throw new a.ArcadeExecutionError(e,"OutOfBounds",r);if(o===t.length){if("="!==r.operator)throw new a.ArcadeExecutionError(e,"OutOfBounds",r);t[o]=K(n,r.operator,t[o],r,e)}else t[o]=K(n,r.operator,t[o],r,e)}else if(t instanceof c){if(!1===S.isString(o))throw new a.ArcadeExecutionError(e,"KeyAccessorMustBeString",r);if(!0===t.hasField(o))t.setField(o,K(n,r.operator,t.field(o),r,e));else{if("="!==r.operator)throw new a.ArcadeExecutionError(e,"FieldNotFound",r,{key:o});t.setField(o,K(n,r.operator,null,r,e))}}else if(u.isFeature(t)){if(!1===S.isString(o))throw new a.ArcadeExecutionError(e,"KeyAccessorMustBeString",r);if(!0===t.hasField(o))t.setField(o,K(n,r.operator,t.field(o),r,e));else{if("="!==r.operator)throw new a.ArcadeExecutionError(e,"FieldNotFound",r,{key:o});t.setField(o,K(n,r.operator,null,r,e))}}else{if(u.isImmutableArray(t))throw new a.ArcadeExecutionError(e,"Immutable",r);if(!(t instanceof D))throw new a.ArcadeExecutionError(e,"InvalidIdentifier",r);if(!1===S.isString(o))throw new a.ArcadeExecutionError(e,"ModuleAccessorMustBeString",r);if(!0!==t.hasGlobal(o))throw new a.ArcadeExecutionError(e,"ModuleExportNotFound",r);t.setGlobal(o,K(n,r.operator,t.global(o),r,e))}return u.voidOperation}const t=k(e,r.left),o=j(e,r.right);return t.scope[t.id]={value:K(o,r.operator,"="!==r.operator?I(t.var).value:null,r,e)},u.voidOperation}(e,r);case"UpdateExpression":return function(e,r){if("CallExpression"===r.argument.type)throw new a.ArcadeExecutionError(e,"NeverReach",r);let t;if("MemberExpression"===r.argument.type){const o=j(e,r.argument.object);let n;if(!0===r.argument.computed)n=j(e,r.argument.property);else{if("Identifier"!==r.argument.property.type)throw new a.ArcadeExecutionError(e,"Unrecognized",r);n=r.argument.property.name}if(S.isArray(o)){if(!S.isNumber(n))throw new a.ArcadeExecutionError(e,"ArrayAccessMustBeNumber",r);if(n<0&&(n=o.length+n),n<0||n>=o.length)throw new a.ArcadeExecutionError(e,"OutOfBounds",r);t=u.toNumber(o[n]),o[n]="++"===r.operator?t+1:t-1}else if(o instanceof c){if(!1===S.isString(n))throw new a.ArcadeExecutionError(e,"KeyAccessorMustBeString",r);if(!0!==o.hasField(n))throw new a.ArcadeExecutionError(e,"FieldNotFound",r);t=u.toNumber(o.field(n)),o.setField(n,"++"===r.operator?t+1:t-1)}else if(u.isFeature(o)){if(!1===S.isString(n))throw new a.ArcadeExecutionError(e,"KeyAccessorMustBeString",r);if(!0!==o.hasField(n))throw new a.ArcadeExecutionError(e,"FieldNotFound",r);t=u.toNumber(o.field(n)),o.setField(n,"++"===r.operator?t+1:t-1)}else{if(u.isImmutableArray(o))throw new a.ArcadeExecutionError(e,"Immutable",r);if(!(o instanceof D))throw new a.ArcadeExecutionError(e,"InvalidParameter",r);if(!1===S.isString(n))throw new a.ArcadeExecutionError(e,"ModuleAccessorMustBeString",r);if(!0!==o.hasGlobal(n))throw new a.ArcadeExecutionError(e,"ModuleExportNotFound",r);t=u.toNumber(o.global(n)),o.setGlobal(n,"++"===r.operator?t+1:t-1)}return!1===r.prefix?t:"++"===r.operator?t+1:t-1}const o=k(e,r.argument);t=u.toNumber(I(o.var).value);const n="++"===r.operator?t+1:t-1;return o.scope[o.id]={value:n},!1===r.prefix?t:"++"===r.operator?t+1:t-1}(e,r);case"TemplateLiteral":return function(e,r){let t="",o=0;for(const n of r.quasis)t+=n.value?n.value.cooked:"",!1===n.tail&&(t+=r.expressions[o]?u.toString(Z(j(e,r.expressions[o]),e,r)):"",o++);return t}(e,r);case"Identifier":return z(e,r);case"MemberExpression":return function(e,r){try{const t=j(e,r.object);if(null===t)throw new a.ArcadeExecutionError(e,"MemberOfNull",r);if(!1===r.computed){if("Identifier"===r.property.type){if(t instanceof c||u.isDictionaryLike(t))return t.field(r.property.name);if(t instanceof v)return i.geometryMember(t,r.property.name,e,r);if(t instanceof D){if(!t.hasGlobal(r.property.name))throw new a.ArcadeExecutionError(e,"InvalidIdentifier",r);return t.global(r.property.name)}}throw new a.ArcadeExecutionError(e,"InvalidMemberAccessKey",r)}let o=j(e,r.property);if(t instanceof c||u.isDictionaryLike(t)){if(S.isString(o))return t.field(o);throw new a.ArcadeExecutionError(e,"InvalidMemberAccessKey",r)}if(t instanceof D){if(S.isString(o))return t.global(o);throw new a.ArcadeExecutionError(e,"InvalidMemberAccessKey",r)}if(t instanceof v){if(S.isString(o))return i.geometryMember(t,o,e,r);throw new a.ArcadeExecutionError(e,"InvalidMemberAccessKey",r)}if(S.isArray(t)){if(S.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length+o),o>=t.length||o<0)throw new a.ArcadeExecutionError(e,"OutOfBounds",r);return t[o]}throw new a.ArcadeExecutionError(e,"InvalidMemberAccessKey",r)}if(S.isString(t)){if(S.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length+o),o>=t.length||o<0)throw new a.ArcadeExecutionError(e,"OutOfBounds",r);return t[o]}throw new a.ArcadeExecutionError(e,"InvalidMemberAccessKey",r)}if(u.isImmutableArray(t)){if(S.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length()+o),o>=t.length()||o<0)throw new a.ArcadeExecutionError(e,"OutOfBounds",r);return t.get(o)}throw new a.ArcadeExecutionError(e,"InvalidMemberAccessKey",r)}throw new a.ArcadeExecutionError(e,"InvalidMemberAccessKey",r)}catch(e){throw e}}(e,r);case"Literal":return r.value;case"CallExpression":return function(e,r){try{if("MemberExpression"===r.callee.type){const t=j(e,r.callee.object);if(!(t instanceof D))throw new a.ArcadeExecutionError(e,"FunctionNotFound",r);const o=!1===r.callee.computed?r.callee.property.name:j(e,r.callee.property);if(!t.hasGlobal(o))throw new a.ArcadeExecutionError(e,"FunctionNotFound",r);const n=t.global(o);if(!u.isFunctionParameter(n))throw new a.ArcadeExecutionError(e,"CallNonFunction",r);return n.call(e,r)}if("Identifier"!==r.callee.type)throw new a.ArcadeExecutionError(e,"FunctionNotFound",r);const t=M(e,r.callee,"FunctionNotFound");if(u.isFunctionParameter(t))return t.call(e,r);throw new a.ArcadeExecutionError(e,"CallNonFunction",r)}catch(e){throw e}}(e,r);case"UnaryExpression":return function(e,r){try{const t=j(e,r.argument);if(S.isBoolean(t)){if("!"===r.operator)return!t;if("-"===r.operator)return-1*u.toNumber(t);if("+"===r.operator)return 1*u.toNumber(t);if("~"===r.operator)return~u.toNumber(t);throw new a.ArcadeExecutionError(e,"UnsupportUnaryOperator",r)}if("~"===r.operator)return~u.toNumber(t);if("-"===r.operator)return-1*u.toNumber(t);if("+"===r.operator)return 1*u.toNumber(t);throw new a.ArcadeExecutionError(e,"UnsupportUnaryOperator",r)}catch(e){throw e}}(e,r);case"BinaryExpression":return function(e,r){try{const t=j(e,r.left),o=j(e,r.right);switch(r.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":return u.binaryOperator(u.toNumber(t),u.toNumber(o),r.operator);case"==":return u.equalityTest(t,o);case"!=":return!u.equalityTest(t,o);case"<":case">":case"<=":case">=":return u.greaterThanLessThan(t,o,r.operator);case"+":return S.isString(t)||S.isString(o)?u.toString(t)+u.toString(o):u.toNumber(t)+u.toNumber(o);case"-":return u.toNumber(t)-u.toNumber(o);case"*":return u.toNumber(t)*u.toNumber(o);case"/":return u.toNumber(t)/u.toNumber(o);case"%":return u.toNumber(t)%u.toNumber(o);default:throw new a.ArcadeExecutionError(e,"UnsupportedOperator",r)}}catch(e){throw e}}(e,r);case"LogicalExpression":return function(e,r){try{const t=j(e,r.left);if(S.isBoolean(t))switch(r.operator){case"||":{if(!0===t)return t;const o=j(e,r.right);if(S.isBoolean(o))return o;throw new a.ArcadeExecutionError(e,"LogicExpressionOrAnd",r)}case"&&":{if(!1===t)return t;const o=j(e,r.right);if(S.isBoolean(o))return o;throw new a.ArcadeExecutionError(e,"LogicExpressionOrAnd",r)}default:throw new a.ArcadeExecutionError(e,"LogicExpressionOrAnd",r)}throw new a.ArcadeExecutionError(e,"LogicalExpressionOnlyBoolean",r)}catch(e){throw e}}(e,r);case"ArrayExpression":return function(e,r){try{const t=[];for(let o=0;o<r.elements.length;o++){const n=j(e,r.elements[o]);if(u.isFunctionParameter(n))throw new a.ArcadeExecutionError(e,"NoFunctionInArray",r);n===u.voidOperation?t.push(null):t.push(n)}return t}catch(e){throw e}}(e,r);case"ObjectExpression":return function(e,r){const t=Object.create(null),o=new Map;for(let n=0;n<r.properties.length;n++){const i=r.properties[n],c="Identifier"===i.key.type?i.key.name:j(e,i.key),s=j(e,i.value);if(u.isFunctionParameter(s))throw new a.ArcadeExecutionError(e,"NoFunctionInDictionary",r);if(!1===S.isString(c))throw new a.ArcadeExecutionError(e,"KeyMustBeString",r);let l=c.toString();const d=l.toLowerCase();o.has(d)?l=o.get(d):o.set(d,l),s===u.voidOperation?t[l]=null:t[l]=s}const n=new c(t);return n.immutable=!1,n}(e,r);default:throw new a.ArcadeExecutionError(e,"Unrecognized",r)}}catch(t){throw a.ensureArcadeExecutionError(e,r,t)}}function P(e,t){switch(t.type){case"EmptyStatement":return u.voidOperation;case"VariableDeclaration":return q(e,t);case"ImportDeclaration":return function(e,r){const t=k(e,r.specifiers[0].local),o=e.libraryResolver;if(null==o)throw N().error("Internal error: module loader not initialized"),new a.ArcadeExecutionError(e,"NeverReach",r);const n=o.loadLibrary(t.id);let i;return o._moduleSingletons?.has(n.uri)?i=o._moduleSingletons.get(n.uri):(i=D.load(e,n.syntax),o._moduleSingletons?.set(n.uri,i)),t.scope[t.id]={value:i},u.voidOperation}(e,t);case"ExportNamedDeclaration":return function(e,r){return P(e,r.declaration),u.voidOperation}(e,t);case"BlockStatement":return _(e,t);case"FunctionDeclaration":return function(e,t){if(null!=e.localScope)throw N().error("Function declarations are only valid in global scope."),new a.ArcadeExecutionError(e,"NeverReach",t);const o=r.toSymbolId(t.id);if(!(o in e.globalScope))throw N().error(`Function "${o}" not declared.`),new a.ArcadeExecutionError(e,"NeverReach",t);const i=n.collectDeclaredLocalNames(t),c=t.params.map(e=>r.toSymbolId(e)),s=Array.from(i).filter(e=>!c.includes(e));return e.globalScope[o]={value:new B(t,e,c,s)},u.voidOperation}(e,t);case"ReturnStatement":return function(e,r){if(null===r.argument)return new u.ReturnResult(u.voidOperation);const t=j(e,r.argument);return new u.ReturnResult(t)}(e,t);case"IfStatement":return function(e,r){const t=j(e,r.test);if(!0===t)return P(e,r.consequent);if(!1===t)return null!==r.alternate?P(e,r.alternate):u.voidOperation;throw new a.ArcadeExecutionError(e,"BooleanConditionRequired",r)}(e,t);case"ExpressionStatement":return function(e,r){const t=j(e,r.expression);return t===u.voidOperation?u.voidOperation:new u.ImplicitResult(t)}(e,t);case"BreakStatement":return u.breakResult;case"ContinueStatement":return u.continueResult;case"ForStatement":return function(e,r){null!==r.init&&("VariableDeclaration"===r.init.type?P(e,r.init):j(e,r.init));const t={testResult:!0,lastAction:u.voidOperation};do{U(e,r,t)}while(!0===t.testResult);return t.lastAction instanceof u.ReturnResult?t.lastAction:u.voidOperation}(e,t);case"ForInStatement":return function(e,r){const t=j(e,r.right);"VariableDeclaration"===r.left.type&&q(e,r.left);const o=k(e,"VariableDeclaration"===r.left.type?r.left.declarations[0].id:r.left);if(S.isArray(t)||S.isString(t)){const n=t.length;for(let t=0;t<n;t++){o.scope[o.id]={value:t};const n=P(e,r.body);if(n===u.breakResult)break;if(n instanceof u.ReturnResult)return n}return u.voidOperation}if(u.isImmutableArray(t)){for(let n=0;n<t.length();n++){o.scope[o.id]={value:n};const t=P(e,r.body);if(t===u.breakResult)break;if(t instanceof u.ReturnResult)return t}return u.voidOperation}if(t instanceof c||u.isDictionaryLike(t)){const n=t.keys();for(let t=0;t<n.length;t++){o.scope[o.id]={value:n[t]};const i=P(e,r.body);if(i===u.breakResult)break;if(i instanceof u.ReturnResult)return i}return u.voidOperation}if(u.isGeometry(t)){for(const n of i.getGeometryKeys(t)){o.scope[o.id]={value:n};const t=P(e,r.body);if(t===u.breakResult)break;if(t instanceof u.ReturnResult)return t}return u.voidOperation}return u.voidOperation}(e,t);case"ForOfStatement":return function(e,r){const t=j(e,r.right);"VariableDeclaration"===r.left.type&&P(e,r.left);const o=k(e,"VariableDeclaration"===r.left.type?r.left.declarations[0].id:r.left);if(S.isArray(t)||S.isString(t)){const n=t.length;for(let i=0;i<n;i++){if(i>=t.length)throw new a.ArcadeExecutionError(e,"OutOfBounds",r);o.scope[o.id]={value:t[i]};const n=P(e,r.body);if(n===u.breakResult)break;if(n instanceof u.ReturnResult)return n}return u.voidOperation}if(u.isImmutableArray(t)){for(let n=0;n<t.length();n++){o.scope[o.id]={value:t.get(n)};const i=P(e,r.body);if(i===u.breakResult)break;if(i instanceof u.ReturnResult)return i}return u.voidOperation}if(t instanceof c||u.isDictionaryLike(t)){for(const n of t.keys()){const i=t.field(n);o.scope[o.id]={value:c.containerEntry(n,i)};const a=P(e,r.body);if(a===u.breakResult)break;if(a instanceof u.ReturnResult)return a}return u.voidOperation}if(u.isGeometry(t)){for(const n of i.getGeometryKeys(t)){const a=i.geometryMember(t,n,e,r,1);o.scope[o.id]={value:c.containerEntry(n,a)};const s=P(e,r.body);if(s===u.breakResult)break;if(s instanceof u.ReturnResult)return s}return u.voidOperation}return u.voidOperation}(e,t);case"WhileStatement":return function(e,r){const t={testResult:!0,lastAction:u.voidOperation};if(t.testResult=j(e,r.test),!1===t.testResult)return u.voidOperation;if(!0!==t.testResult)throw new a.ArcadeExecutionError(e,"BooleanConditionRequired",r);for(;!0===t.testResult&&(t.lastAction=P(e,r.body),t.lastAction!==u.breakResult)&&!(t.lastAction instanceof u.ReturnResult);)if(t.testResult=j(e,r.test),!0!==t.testResult&&!1!==t.testResult)throw new a.ArcadeExecutionError(e,"BooleanConditionRequired",r);return t.lastAction instanceof u.ReturnResult?t.lastAction:u.voidOperation}(e,t);default:throw new a.ArcadeExecutionError(e,"Unrecognized",t)}}function U(e,r,t){if(null!==r.test){if(t.testResult=j(e,r.test),!1===t.testResult)return;if(!0!==t.testResult)throw new a.ArcadeExecutionError(e,"BooleanConditionRequired",r)}t.lastAction=P(e,r.body),t.lastAction!==u.breakResult?t.lastAction instanceof u.ReturnResult?t.testResult=!1:null!==r.update&&j(e,r.update):t.testResult=!1}function K(e,r,t,o,n){switch(r){case"=":return e===u.voidOperation?null:e;case"/=":return u.toNumber(t)/u.toNumber(e);case"*=":return u.toNumber(t)*u.toNumber(e);case"-=":return u.toNumber(t)-u.toNumber(e);case"+=":return S.isString(t)||S.isString(e)?u.toString(t)+u.toString(e):u.toNumber(t)+u.toNumber(e);case"%=":return u.toNumber(t)%u.toNumber(e);default:throw new a.ArcadeExecutionError(n,"UnsupportedOperator",o)}}function _(e,r){let t=u.voidOperation;for(let o=0;o<r.body.length;o++)if(t=P(e,r.body[o]),t instanceof u.ReturnResult||t===u.breakResult||t===u.continueResult)return t;return t}function q(e,r){for(let t=0;t<r.declarations.length;t++)T(e,r.declarations[t]);return u.voidOperation}function T(e,r){let t=null===r.init?null:j(e,r.init);if(t===u.voidOperation&&(t=null),"Identifier"!==r.id.type)throw new a.ArcadeExecutionError(e,"InvalidIdentifier",r);const o=k(e,r.id);o.scope[o.id]={value:t}}function Z(e,r,t){if(u.isFunctionParameter(e))throw new a.ArcadeExecutionError(r,"NoFunctionInTemplateLiteral",t);return e}function z(e,r){return M(e,r)}function V(e,r){try{if(!0===r.preparsed)throw new a.ArcadeExecutionError(e,"NeverReach",r);const t=r.arguments;u.pcCheck(null===t?[]:t,3,3,e,r);const o=j(e,t[0]);if(!1===S.isBoolean(o))throw new a.ArcadeExecutionError(e,"BooleanConditionRequired",r);return j(e,!0===o?t[1]:t[2])}catch(e){throw e}}function W(e,r){try{if(!0===r.preparsed)throw new a.ArcadeExecutionError(e,"NeverReach",r);const t=r.arguments;u.pcCheck(null===t?[]:t,2,3,e,r);const o=j(e,t[0]);if(3===t.length){const r=j(e,t[1]),n=i.getNestedOptionalValue(o,r);return null!=n&&""!==n?n:j(e,t[2])}return null===o||""===o||void 0===o?j(e,t[1]):o}catch(e){throw e}}function Y(e,r){try{if(!0===r.preparsed)throw new a.ArcadeExecutionError(e,"NeverReach",r);const t=r.arguments;if(t.length<2)throw new a.ArcadeExecutionError(e,"WrongNumberOfParameters",r);if(2===t.length)return j(e,t[1]);if((t.length-1)%2==0)throw new a.ArcadeExecutionError(e,"WrongNumberOfParameters",r);return $(e,r,1,j(e,t[0]))}catch(e){throw e}}function $(e,r,t,o){try{const n=r.arguments,i=j(e,n[t]);if(u.equalityTest(i,o))return j(e,n[t+1]);{const i=n.length-t;return 1===i?j(e,n[t]):2===i?null:3===i?j(e,n[t+2]):$(e,r,t+2,o)}}catch(e){throw e}}function H(e,r){try{if(!0===r.preparsed)throw new a.ArcadeExecutionError(e,"NeverReach",r);const t=r.arguments;if(t.length<3)throw new a.ArcadeExecutionError(e,"WrongNumberOfParameters",r);if(t.length%2==0)throw new a.ArcadeExecutionError(e,"WrongNumberOfParameters",r);const o=j(e,t[0]);if(!1===S.isBoolean(o))throw new a.ArcadeExecutionError(e,"BooleanConditionRequired",t[0]);return J(e,r,0,o)}catch(e){throw e}}function J(e,r,t,o){try{const n=r.arguments;if(!0===o)return j(e,n[t+1]);if(3===n.length-t)return j(e,n[t+2]);{const o=j(e,n[t+2]);if(!1===S.isBoolean(o))throw new a.ArcadeExecutionError(e,"BooleanConditionRequired",n[t+2]);return J(e,r,t+2,o)}}catch(e){throw e}}const Q=function(){const e=Object.create(null);p.registerFunctions(e,L),g.registerFunctions(e,L),h.registerFunctions(e,L,z),b.registerFunctions(e,L),w.registerFunctions(e,L),E.registerFunctions(e,L),m.registerFunctions(e,L),y.registerFunctions(e,L),e.iif=V,e.defaultvalue=W,e.decode=Y,e.when=H;const r=function(){this.textformatting={value:c.textFormatting()}};(r.prototype=Object.create(null)).infinity=Object.freeze({value:Number.POSITIVE_INFINITY}),r.prototype.pi=Object.freeze({value:Math.PI});for(const[t,o]of Object.entries(e))r.prototype[t]=Object.freeze({value:new l.NativeFunction(o)});return r}();function X(e){const r={mode:"sync",compiled:!1,functions:Object.create(null),signatures:[],standardFunction:L,evaluateIdentifier:z};for(let t=0;t<e.length;t++)e[t].registerFunctions(r);for(const[e,t]of Object.entries(r.functions))Q.prototype[e]=Object.freeze({value:new l.NativeFunction(t)});for(let e=0;e<r.signatures.length;e++)d.addFunctionDeclaration(r.signatures[e],"sync")}function ee(e){console.log(e)}function re(e,t){const i=new Set(Object.keys(t?.vars||{}).map(e=>r.toSymbolId(e))),c=new Set(Object.keys(t?.customfunctions||{}).map(e=>r.toSymbolId(e))),{globals:d,exports:f}=n.collectDeclaredGlobalNames(e);return t=>{const n=t.spatialReference??R.WebMercator;let p=null;e.usesModules&&(p=new o.ArcadeModuleLoader(new Map,e.loadedModules));const h=new Q;for(const e of c)null!=t.customfunctions&&e in t.customfunctions?h[e]={value:new l.NativeFunction(t.customfunctions[e])}:h[e]=F;for(const e of i){if(null==t.vars||!(e in t.vars)){e in h||(h[e]=F);continue}const r=t.vars[e]??null;S.isGraphic(r)?h[e]={value:s.createFromGraphic(r,t.timeZone??null)}:h[e]={value:r}}for(const e of d)e in h||(h[e]=F);const w={lrucache:t.lrucache,interceptor:t.interceptor,services:t.services,console:t.console??ee,abortSignal:r.neverAbortedSignal,timeZone:t.timeZone??null,spatialReference:n,track:t.track,depthCounter:{depth:1},libraryResolver:p,exports:f,localScope:null,globalScope:h},m=_(w,e);if(m instanceof u.ReturnResult||m instanceof u.ImplicitResult){const e=m.value;if(u.isVoid(e))return null;if(u.isFunctionParameter(e))throw new a.ArcadeExecutionError(w,"IllegalResult",null);return e}if(u.isVoid(m))return null;if(m===u.breakResult)throw new a.ArcadeExecutionError(w,"IllegalResult",null);if(m===u.continueResult)throw new a.ArcadeExecutionError(w,"IllegalResult",null);throw new a.ArcadeExecutionError(w,"NeverReach",null)}}X([f.ArrayFunctions]),e.executeScript=function(e,r){return re(e,r)(r)},e.extend=X,e.prepareScript=re,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});