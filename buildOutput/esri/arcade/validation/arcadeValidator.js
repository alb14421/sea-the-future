// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/index","./diagnosticMessages","./languageKeywords"],function(e,i,t,n){"use strict";function s(e,i){return i?e.replaceAll(/\${(.*?)}/g,(e,t)=>i[t]?.toString()??""):e}function a(e){return!!e&&"dictionary"!==e.type}class o{constructor(e,i=[]){this._apiDefinitions=e,this._profileVariables=i,this._isInBlock=!1,this._identifierBeingAssigned=void 0,this._assignmentValidationMode="disabled",this._scriptScopeIdentifiers=new Map,this._diagnostics=new Array,this._undeclaredIdentifiersInFunctions=new Map}validateScript(e){if(!e)return{diagnostics:[],program:null};this._isInBlock=!1,this._identifierBeingAssigned=void 0,this._assignmentValidationMode="disabled",this._diagnostics=[],this._scriptScopeIdentifiers.clear(),this._undeclaredIdentifiersInFunctions.clear(),this._functionScopeIdentifiers=void 0;let t=null;try{t=i.Ue(e,{tolerant:!0}),this.handleErrors(t.errors),t.body.forEach(e=>this.validateStatement(e)),this.diagnoseIdentifiers(),this._undeclaredIdentifiersInFunctions.size>0&&this._undeclaredIdentifiersInFunctions.forEach(e=>{for(const i of e)this.logDiagnostic(i.node.loc,{code:"NotDefined",data:{identifier:i.node.name}})})}catch(e){this.handleException(e)}return{diagnostics:this._diagnostics,program:t}}disableRecordIdentifierAssignment(e,i){const t=this._assignmentValidationMode;this._assignmentValidationMode="disabled",e.call(this,i),this._assignmentValidationMode=t}inBlock(e,i){const t=this._isInBlock;this._isInBlock=!0,e.call(this,i),this._isInBlock=t}get _isInFunctionScope(){return!!this._functionScopeIdentifiers}inFunctionScope(e){this._functionScopeIdentifiers=new Map,e.call(this),this.diagnoseIdentifiers(),this._functionScopeIdentifiers=void 0}logDiagnostic(e,n){const a={severity:"Error",...n,message:s(t.diagnosticMessages[n.code]??i.Z[n.code],n.data),range:{start:{line:e.start.line-1,character:e.start.column},end:{line:e.end.line-1,character:e.end.column}}};this._diagnostics.push(a)}handleErrors(e){(e??[]).forEach(this.handleException,this)}handleException(e){if(function(e){return"ParsingError"===e?.name}(e)){const{range:i,code:t,data:n}=e;this.logDiagnostic(i,{code:t,data:n})}else this.logDiagnostic({start:{line:1,column:0},end:{line:1,column:0}},{code:"ExecutionError",data:{stack:e.stack}})}getIdentifierInfo(e){return this._functionScopeIdentifiers?.get(e)??this._scriptScopeIdentifiers.get(e)}setIdentiferInfo(e,i){this._functionScopeIdentifiers?this._functionScopeIdentifiers.set(e,i):((this._functionScopeIdentifiers??this._scriptScopeIdentifiers).set(e,i),this._functionScopeIdentifiers||this._undeclaredIdentifiersInFunctions.has(e)&&(this._undeclaredIdentifiersInFunctions.delete(e),i.used=!0))}isProfileVariable(e){return(this._profileVariables??[]).some(i=>i.name.toLowerCase()===e)}isApiItem(e){const i=!!this._apiDefinitions?.constantDefinitions?.get(e),t=!!this._apiDefinitions?.functionDefinitions?.get(e);return i||t}validateStatement(e){if(e)switch(e.type){case i.n.BlockStatement:return void e.body.forEach(e=>this.validateStatement(e));case i.n.VariableDeclaration:return void e.declarations.forEach(e=>this.validateVariableDeclarator(e));case i.n.FunctionDeclaration:return void this.validateFunctionDeclaration(e);case i.n.ExportNamedDeclaration:return void this.validateExportDeclaration(e);case i.n.ImportDeclaration:return void this.validateImportDeclaration(e);case i.n.WhileStatement:return void this.validateWhileStatement(e);case i.n.ForStatement:return void this.validateForStatement(e);case i.n.ForInStatement:return void this.validateForInStatement(e);case i.n.IfStatement:return void this.validateIfStatement(e);case i.n.ReturnStatement:return void this.validateExpression(e.argument);case i.n.ExpressionStatement:return void this.validateExpression(e.expression);case i.n.BreakStatement:case i.n.ContinueStatement:case i.n.EmptyStatement:return}}validateVariableDeclarator(e){this.validateExpression(e.init),this.recordVariableIdentifier(e.id,{initialized:!!e.init})}validateFunctionDeclaration(e){this.recordFunctionIdentifier(e),this.inFunctionScope(()=>{e.params.forEach(e=>this.recordParamAsIdentifier(e)),r(e.body)&&this.logDiagnostic(e.body.loc,{code:"UnexpectedEmptyFunction",data:{identifier:e.id.name},severity:"Warning"}),this.validateStatement(e.body)})}validateExportDeclaration(e){this.validateStatement(e.declaration)}validateImportDeclaration(e){this.recordImportIdentifier(e)}validateForStatement(e){i.xe(e.init)?this.inBlock(this.validateStatement,e.init):this.validateExpression(e.init),this.validateExpression(e.update),this.validateExpression(e.test),r(e.body)&&this.logDiagnostic(e.body.loc,{code:"EmptyBlockStatement",severity:"Warning"}),this.inBlock(this.validateStatement,e.body)}validateWhileStatement(e){this.validateExpression(e.test),r(e.body)&&this.logDiagnostic(e.body.loc,{code:"EmptyBlockStatement",severity:"Warning"}),this.inBlock(this.validateStatement,e.body)}validateForInStatement(e){i.ge(e.left)?this.validateExpression(e.left):this.recordVariableIdentifier(e.left.declarations[0].id,{initialized:!0,inBlock:!0}),this.validateExpression(e.right),r(e.body)&&this.logDiagnostic(e.body.loc,{code:"EmptyBlockStatement",severity:"Warning"}),this.validateStatement(e.body)}validateIfStatement(e){this.validateExpression(e.test),r(e.consequent)&&this.logDiagnostic(e.consequent.loc,{code:"EmptyBlockStatement",severity:"Warning"}),e.alternate&&r(e.alternate)&&this.logDiagnostic(e.alternate.loc,{code:"EmptyBlockStatement",severity:"Warning"}),this.inBlock(this.validateStatement,e.consequent),this.inBlock(this.validateStatement,e.alternate)}validateExpression(e){if(e)switch(e.type){case i.n.AssignmentExpression:return void this.validateAssignmentExpression(e);case i.n.CallExpression:return void this.validateCallExpression(e);case i.n.Identifier:return void this.validateIdentifier(e);case i.n.Literal:return void this.validateLiteral(e);case i.n.ArrayExpression:return void e.elements.forEach(e=>this.validateExpression(e));case i.n.ObjectExpression:return void this.validateObjectExpression(e);case i.n.UnaryExpression:return void this.validateUnaryExpression(e);case i.n.UpdateExpression:return void this.validateUpdateExpression(e);case i.n.BinaryExpression:case i.n.LogicalExpression:return void this.validateBinaryAndLogicalExpression(e);case i.n.MemberExpression:return void this.validateMemberExpression(e);case i.n.TemplateLiteral:return void e.expressions.forEach(e=>this.validateExpression(e));default:return}}validateAssignmentExpression(e){const t=this._identifierBeingAssigned,n=this._assignmentValidationMode;i.ge(e.left)&&(this._identifierBeingAssigned=e.left.name.toLowerCase(),this._assignmentValidationMode="left"),this.validateExpression(e.left),i.ge(e.left)&&(this._assignmentValidationMode="right"),this.validateExpression(e.right),this._identifierBeingAssigned=t,this._assignmentValidationMode=n}validateCallExpression(e){if(this.validateExpression(e.callee),i.ge(e.callee)){const i=e.callee.name.toLowerCase(),t=this.getIdentifierInfo(i),n=this._apiDefinitions?.functionDefinitions?.get(i);if(!t&&n){const i=function(e,i){if(!e||null==i||i<0)return null;const{min:t,max:n}=e.overloads.reduce((e,i)=>{const{min:t,max:n}=i.parametersInfo;return e.min>=0&&(e.min=Math.min(t,e.min)),e.max>=0&&(e.max=n<0?n:Math.max(n,e.max)),e},{min:1/0,max:0});return i<t?t>0?{code:"NotEnoughArguments",data:{min:t}}:{code:"NoArgumentExpected"}:n>=0&&i>n?{code:"TooManyArguments",data:{max:n}}:null}(n,e.arguments.length);i&&this.logDiagnostic(e.loc,i)}}e.arguments.forEach(e=>this.validateExpression(e))}validateIdentifier(e){const i=e.name.toLowerCase(),t=this.getIdentifierInfo(i);if(t){if("left"===this._assignmentValidationMode&&this._identifierBeingAssigned===i)return void(t.initialized=!0);if("right"===this._assignmentValidationMode&&this._identifierBeingAssigned===i)return;t.used=!0}else if(!this.isProfileVariable(i)&&!this.isApiItem(i)){if(this._isInFunctionScope){let t=this._undeclaredIdentifiersInFunctions.get(i);return t||(t=[],this._undeclaredIdentifiersInFunctions.set(i,t)),void t.push({node:e,identifier:i})}this.logDiagnostic(e.loc,{code:"NotDefined",data:{identifier:e.name}})}}validateLiteral(e){var i;(i=e.raw,Array.from((i??"").matchAll(d),e=>e[0].slice(1))).forEach(e=>{const i=this.getIdentifierInfo(e.toLowerCase());i&&(i.used=!0)})}logProfileOrApiConflict(e){const i=e.name.toLowerCase(),t=this.isProfileVariable(i),n=this.isApiItem(i);(t||n)&&this.logDiagnostic(e.loc,{code:t?"ProfileVariablesConflict":"ApiConflict",severity:"Warning",data:{identifier:e.name}})}logReservedKeywordsConflict(e){const i=e.name.toLowerCase();n.arcadeReservedKeywords.includes(i)&&this.logDiagnostic(e.loc,{code:"ReservedKeyword",severity:"Warning",data:{identifier:e.name}})}validateObjectExpression(e){e.properties.forEach(e=>{this.validateExpression(e.value)})}validateUnaryExpression(e){this.validateExpression(e.argument)}validateUpdateExpression(e){this.validateExpression(e.argument)}validateBinaryAndLogicalExpression(e){this.validateExpression(e.left),this.validateExpression(e.right)}validateMemberExpression(e){const t=this.flattenMemberExpressionAndValidate(e),n=t[0].object;this.disableRecordIdentifierAssignment(this.validateExpression,n),i.ge(n)&&(this.getIdentifierInfo(n.name.toLowerCase())||this.validateMemberExpressionWithProfile(t)||this.validateConstantMemberExpression(t))}flattenMemberExpressionAndValidate(e){return e.type===i.n.MemberExpression?(i.ge(e.property)&&!e.computed||this.validateExpression(e.property),[...this.flattenMemberExpressionAndValidate(e.object),e]):[]}extractAndValidatePropertyName(e){switch(e.type){case"Identifier":return e.name.toLowerCase();case"Literal":return"string"!=typeof e.value?(this.logDiagnostic(e.loc,{code:"UnexpectedPropertyIdentifier"}),null):e.value.toLowerCase();default:return this.logDiagnostic(e.loc,{code:"UnexpectedPropertyIdentifier"}),null}}validateConstantMemberExpression(e){const t=e[0];if(!i.ge(t.object))return!1;const n=t.object.name.toLowerCase(),s=this._apiDefinitions?.constantDefinitions?.get(n);if(!s)return!1;if("namespace"!==s.type)return this.logDiagnostic(t.property.loc,{code:"NotADictionary",data:{identifier:n}}),!0;const a=this.extractAndValidatePropertyName(t.property);if(!a)return!0;if(!s.members.some(e=>e.key===a)){const e=s.members.reduce((e,i)=>`${e}${e?" | ":""}${i.completion.label.split(".").pop()}`,"");this.logDiagnostic(t.property.loc,{code:"InvalidConstantIdentifier",data:{list:e}})}return e.length>1&&this.logDiagnostic(e[1].property.loc,{code:"UnexpectedPropertyIdentifier"}),!0}validateMemberExpressionWithProfile(e){const t=e[0];if(t.object.type!==i.n.Identifier)return!1;const n=t.object.name.toLowerCase(),s=this._profileVariables?.find(e=>e.key===n);if(!s)return!1;if(a(s))return this.logDiagnostic(t.object.loc,{code:"NotADictionary",data:{identifier:s.name}}),!0;if(this._identifierBeingAssigned===n)return this.logDiagnostic(t.loc,{code:"ProfileVariablesAreImmutable"}),!0;let o=s;for(let i=0;i<e.length;i++){if(e[i].computed)return!0;if(a(o))return this.logDiagnostic(e[i-1]?.property.loc??e[i].object.loc,{code:"NotADictionary",data:{identifier:o.name}}),!0;const t=this.extractAndValidatePropertyName(e[i].property);if(!t)return!0;if(0===o.properties.length)return this.logDiagnostic(e[i].property.loc,{code:"UnknownPropertyIdentifier",data:{identifier:t},severity:"Warning"}),!0;const n=o.properties.find(e=>e.name.toLowerCase()===t);if(!n){const t=o.properties.reduce((e,i)=>`${e}${e?" | ":""}${i.name.split(".").pop()}`,"");return this.logDiagnostic(e[i].property.loc,{code:"InvalidPropertyIdentifier",data:{list:t}}),!0}o=n}return!0}recordVariableIdentifier(e,i){this.logReservedKeywordsConflict(e),this.logProfileOrApiConflict(e);const t=e.name.toLowerCase();let n=this.getIdentifierInfo(t);const s=n&&this._isInFunctionScope&&"function"===n.scope,a=n&&!this._isInFunctionScope&&"script"===n.scope;(s||a)&&this.logDiagnostic(e.loc,{code:"AlreadyDefined",data:{identifier:e.name},severity:"Warning"});const o=i.inBlock??this._isInBlock,{initialized:r}=i;return!n||this._isInFunctionScope&&"function"!==n.scope?n={node:e,used:!1,initialized:r,scope:this._isInFunctionScope?"function":o?"block":"script"}:(n.node=e,n.used=!1,n.initialized=r),"block"!==n.scope||o||(n.scope="script",this.logDiagnostic(e.loc,{code:"AlreadyDefined",data:{identifier:e.name},severity:"Warning"})),this.setIdentiferInfo(t,n),!1}recordImportIdentifier(e){const i=e.specifiers[0].local;this.logProfileOrApiConflict(i);const t=i.name.toLowerCase();let n=this.getIdentifierInfo(t);n?.scope&&this.logDiagnostic(e.specifiers[0].local.loc,{code:"AlreadyDefined",data:{identifier:e.specifiers[0].local.name},severity:"Warning"}),n={node:e.specifiers[0].local,used:!1,...n,scope:"script",initialized:!0},this.setIdentiferInfo(t,n)}recordFunctionIdentifier(e){this.logProfileOrApiConflict(e.id);const i=e.id.name.toLowerCase();let t=this.getIdentifierInfo(i);t?.scope&&this.logDiagnostic(e.id.loc,{code:"AlreadyDefined",data:{identifier:e.id.name},severity:"Warning"}),t={node:e.id,used:!1,...t,scope:"script",initialized:!0},this.setIdentiferInfo(i,t)}recordParamAsIdentifier(e){return this.recordVariableIdentifier(e,{initialized:!0})}diagnoseIdentifiers(){(this._functionScopeIdentifiers??this._scriptScopeIdentifiers).forEach(e=>{e.node&&(e.used?e.initialized||this.logDiagnostic(e.node.loc,{code:"DefinedNeverAssigned",data:{identifier:e.node.name},severity:"Warning"}):this.logDiagnostic(e.node.loc,{code:e.initialized?"AssignedNeverUsed":"DefinedNeverUsed",data:{identifier:e.node.name},severity:"Warning"}))})}}function r(e){return i.ie(e)||i.P(e)&&!e?.body.length}const d=new RegExp(/\B@\w+/g);e.ArcadeValidationService=o,e.format=s,e.isValueVariable=a,e.validateScript=function(e,i=[],t){return e?new o(t,i).validateScript(e):{diagnostics:[]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});