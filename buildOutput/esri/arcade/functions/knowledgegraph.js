// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../config","../ArcadePortal","../Dictionary","../executionError","../../chunks/languageUtils","../portalUtils","../../geometry/Geometry","../../geometry/projectionUtils","../../geometry/SpatialReference","../../geometry/support/webMercatorUtils","../../portal/Portal","../../portal/PortalItem","../../rest/geometryService/project","../../rest/knowledgeGraph/Entity","../../rest/knowledgeGraph/GraphQueryStreaming","../../rest/knowledgeGraph/ObjectValue","../../rest/knowledgeGraph/Path","../../rest/knowledgeGraph/Relationship","../../rest/support/ProjectParameters","../../support/guards"],function(e,r,t,n,i,a,o,s,c,l,u,p,f,d,g,h,m,y,w,S,x,G){"use strict";let v=null;async function P(r,t){const n=new d({portal:r,id:t});return await n.load(),null===v&&(v=await new Promise((r,t)=>e(["../../rest/knowledgeGraphService"],r,t))),await v.fetchKnowledgeGraph(n.url)}function R(e,r,t,n,i){if(null===e)return null;if(G.isString(e)||G.isNumber(e))return e;if(o.isDate(e))return e.toJSDate();if(o.isDate(e))return e.toJSDate();if(o.isDateOnly(e))return e.toStorageFormat();if(o.isTime(e))return e.toStorageString();if(o.isDictionary(e)){const a={};for(const o of e.keys())a[o]=R(e.field(o),r,t,n,i),a[o]instanceof c&&i.push({container:a,indexer:o});return a}if(G.isArray(e)){const a=e.map(e=>R(e,r,t,n,i));for(let e=0;e<a.length;e++)a[e]instanceof c&&i.push({container:a,indexer:e});return a}return o.isGeometry(e)?e.spatialReference.isWGS84?e:e.spatialReference.isWebMercator&&r?p.webMercatorToGeographic(e):e:void 0}function b(e,r){if(!e)return null;const t={};for(const n in e)t[n]=k(e[n],r);return t}function k(e,r){return null===e?null:G.isArray(e)?e.map(e=>k(e,r)):e instanceof h?{graphTypeName:e.typeName,id:e.id,graphType:"entity",properties:b(e.properties,r)}:e instanceof y?{graphType:"object",properties:b(e.properties,r)}:e instanceof S?{graphTypeName:e.typeName,id:e.id,graphType:"relationship",originId:e.originId??null,destinationId:e.destinationId??null,properties:b(e.properties,r)}:e instanceof w?{graphType:"path",path:e.path?e.path.map(e=>k(e,r)):null}:o.isGeometry(e)?function(e,r){if(!e)return e;if(e.spatialReference.isWGS84&&r.spatialReference.isWebMercator)return p.geographicToWebMercator(e);if(e.spatialReference.equals(r.spatialReference))return e;throw new a.ArcadeExecutionError(r,"WrongSpatialReference",null)}(e,r):G.isString(e)||G.isNumber(e)||G.isDate(e)?e:null}r.registerFunctions=function(r){"async"===r.mode&&(r.functions.knowledgegraphbyportalitem=function(e,t){return r.standardFunctionAsync(e,t,(r,i,c)=>{if(o.pcCheck(c,2,2,e,t),null===c[0])throw new a.ArcadeExecutionError(e,"PortalRequired",t);if(c[0]instanceof n){const r=o.toString(c[1]);let t;return t=e.services?.portal?e.services.portal:f.getDefault(),P(s.getPortal(c[0],t),r)}if(!1===G.isString(c[0]))throw new a.ArcadeExecutionError(e,"InvalidParameter",t);const l=o.toString(c[0]);return P(e.services?.portal??f.getDefault(),l)})},r.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),r.functions.querygraph=function(n,s){return r.standardFunctionAsync(n,s,async(r,c,p)=>{o.pcCheck(p,2,4,n,s);const f=p[0];if(!o.isKnowledgeGraph(f))throw new a.ArcadeExecutionError(n,"InvalidParameter",s);const d=p[1];if(!G.isString(d))throw new a.ArcadeExecutionError(n,"InvalidParameter",s);null===v&&(v=await new Promise((r,t)=>e(["../../rest/knowledgeGraphService"],r,t)));let h=null;const y=o.defaultUndefined(p[2],null);if(!(y instanceof i||null===y))throw new a.ArcadeExecutionError(n,"InvalidParameter",s);if(y){let e=[];h=R(y,!0,!1,n,e),e=e.filter(e=>!e.container[e.indexer].spatialReference.isWGS84),e.length>0&&await async function(e){const r=t.geometryServiceUrl??"";if(!r){l.isLoaded()||await l.load();for(const r of e)r.container[r.indexer]=l.project(r.container[r.indexer],u.WGS84);return}const n=e.map(e=>e.container[e.indexer]),i=new x({geometries:n,outSpatialReference:u.WGS84}),a=await g.project(r,i);for(let r=0;r<a.length;r++){const t=e[r];t.container[t.indexer]=a[r]}}(e)}const w=o.defaultUndefined(p[3],!1),S=new m({openCypherQuery:d,bindParameters:h,provenanceBehavior:w?"include":"exclude"});(f?.serviceDefinition?.currentVersion??11.3)>11.2&&(S.outputSpatialReference=n.spatialReference);const P=(await v.executeQueryStreaming(f,S)).resultRowsStream.getReader(),b=[];try{for(;;){const{done:e,value:r}=await P.read();if(e)break;if(G.isArray(r))for(const e of r)b.push(k(e,n));else{const e=[];for(const t of r)e.push(k(r[t],n));b.push(e)}}}catch(e){throw e}return i.convertJsonToArcade(b,o.defaultTimeZone(n),!1,!0)})},r.signatures.push({name:"querygraph",min:2,max:4}))},Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});