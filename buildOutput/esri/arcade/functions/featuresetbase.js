// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../Graphic","../ArcadeDate","../ArcadePortal","../Dictionary","../enum","../executionError","../Feature","../featureSetUtils","../ImmutableArray","../../chunks/languageUtils","../portalUtils","../featureset/actions/Adapted","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/Empty","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/shared","../featureset/support/sqlUtils","./fieldStats","../../core/promiseUtils","../../core/sql/WhereClause","../../layers/FeatureLayer","../../layers/support/Field","../../portal/Portal","../../rest/networks/queryAssociations","../../rest/networks/support/NetworkElement","../../rest/networks/support/QueryAssociationsParameters","../../support/guards"],function(e,t,n,r,i,a,o,s,l,c,d,u,f,m,p,y,g,F,h,w,I,E,A,S,x,b,T,D,N,C,k){"use strict";function v(e,t,n){const r=e.getVariables();if(r.length>0){const i={};for(const e of r)i[e]=t.evaluateIdentifier(n,{name:e});e.parameters=i}return e}function L(e,t,n=null){for(const n in e)if(n.toLowerCase()===t.toLowerCase())return e[n];return n}function Z(e){if(null===e)return null;const t={type:L(e,"type",""),name:L(e,"name","")};if("range"===t.type)t.range=L(e,"range",[]);else{t.codedValues=[];for(const n of L(e,"codedValues",[]))t.codedValues.push({name:L(n,"name",""),code:L(n,"code",null)})}return t}function P(e){if(null===e)return null;const t={},n=L(e,"wkt");null!==n&&(t.wkt=n);const r=L(e,"wkid");return null!==r&&(t.wkid=r),t}function $(e){if(null===e)return null;const t={hasZ:L(e,"hasz",!1),hasM:L(e,"hasm",!1)},n=L(e,"spatialreference");null!=n&&(t.spatialReference=P(n));const r=L(e,"x",null);if(null!==r)return t.x=r,t.y=L(e,"y",null),t.hasZ&&(t.z=L(e,"z",null)),t.hasM&&(t.m=L(e,"m",null)),t;const i=L(e,"rings",null);if(null!==i)return t.rings=i,t;const a=L(e,"paths",null);if(null!==a)return t.paths=a,t;const o=L(e,"points",null);if(null!==o)return t.points=o,t;for(const n of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const r=L(e,n,null);null!==r&&(t[n]=r)}return t}function U(e){return"utc"===e?.toLowerCase()?"UTC":"unknown"===e?.toLowerCase()?"Unknown":e}e.registerFunctions=function(e){if("async"===e.mode){e.functions.timezone=function(t,r){return e.standardFunctionAsync(t,r,async(e,a,s)=>{if(d.pcCheck(s,1,2,t,r),d.isTime(s[0]))return"Unknown";if(d.isDateOnly(s[0]))return"Unknown";if(d.isFeatureSet(s[0])){if(await s[0].load(),1===s.length||null===s[1])return s[0].datesInUnknownTimezone?U("unknown"):U(s[0].dateFieldsTimeZone);if(!(s[1]instanceof i)||!1===s[1].hasField("type"))throw new o.ArcadeExecutionError(t,"InvalidParameter",r);const e=s[1].field("type");if(!1===k.isString(e))throw new o.ArcadeExecutionError(t,"InvalidParameter",r);switch(d.toString(e).toLowerCase()){case"preferredtimezone":return U(s[0].preferredTimeZone);case"editfieldsinfo":return U(s[0].editFieldsInfo?.timeZone??null);case"timeinfo":return U(s[0].timeInfo?.timeZone??null);case"field":if(s[1].hasField("fieldname")&&k.isString(s[1].field("fieldname")))return U(s[0].fieldTimeZone(d.toString(s[1].field("fieldname"))))}throw new o.ArcadeExecutionError(t,"InvalidParameter",r)}const l=d.toDate(s[0],d.defaultTimeZone(t));if(null===l)return null;const c=l.timeZone;return"system"===c?n.ArcadeDate.systemTimeZoneCanonicalName:"utc"===c.toLowerCase()?"UTC":"unknown"===c.toLowerCase()?"Unknown":c})},e.functions.sqltimestamp=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{d.pcCheck(i,1,3,t,n);const a=i[0];if(d.isDate(a)){if(1===i.length)return a.toSQLWithKeyword();if(2===i.length)return a.changeTimeZone(d.toString(i[1])).toSQLWithKeyword();throw new o.ArcadeExecutionError(t,"InvalidParameter",n)}if(d.isDateOnly(a))return a.toSQLWithKeyword();if(d.isFeatureSet(a)){if(3!==i.length)throw new o.ArcadeExecutionError(t,"InvalidParameter",n);await a.load();const e=d.toString(i[1]);if(d.isDateOnly(i[2]))return i[2].toSQLWithKeyword();if(!1===d.isDate(i[2]))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);const r=a.fieldTimeZone(e);return null==r?i[2].toSQLWithKeyword():i[2].changeTimeZone(r).toSQLWithKeyword()}throw new o.ArcadeExecutionError(t,"InvalidParameter",n)})},e.signatures.push({name:"sqltimestamp",min:2,max:4}),e.functions.featuresetbyid=function(t,n){return e.standardFunctionAsync(t,n,(e,r,i)=>{if(d.pcCheck(i,2,4,t,n),d.isFeatureSetCollection(i[0])){const e=d.toString(i[1]);let r=d.defaultUndefined(i[2],null);const a=d.toBoolean(d.defaultUndefined(i[3],!0));if(null===r&&(r=["*"]),!1===k.isArray(r))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);return i[0].featureSetById(e,a,r)}throw new o.ArcadeExecutionError(t,"InvalidParameter",n)})},e.signatures.push({name:"featuresetbyid",min:2,max:4});const R=new a.StringEnum(["datasource","parent","root"]);e.functions.getfeatureset=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(d.pcCheck(i,1,2,t,n),d.isFeature(i[0])){const e=null==i[1]?"datasource":R.lookup(d.toString(i[1]));return l.convertToFeatureSet(i[0].fullSchema(),e,t.lrucache,t.interceptor,t.spatialReference)}throw new o.ArcadeExecutionError(t,"InvalidParameter",n)})},e.signatures.push({name:"getfeatureset",min:1,max:2}),e.functions.featuresetbyportalitem=function(t,n){return e.standardFunctionAsync(t,n,(e,i,a)=>{if(d.pcCheck(a,2,5,t,n),null===a[0])throw new o.ArcadeExecutionError(t,"PortalRequired",n);if(a[0]instanceof r){const e=d.toString(a[1]),r=d.toString(a[2]);let i=d.defaultUndefined(a[3],null);const s=d.toBoolean(d.defaultUndefined(a[4],!0));if(null===i&&(i=["*"]),!1===k.isArray(i))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);let c;return c=t.services?.portal?t.services.portal:T.getDefault(),c=u.getPortal(a[0],c),l.constructFeatureSetFromPortalItem(e,r,t.spatialReference,i,s,c,t.lrucache,t.interceptor)}if(!1===k.isString(a[0]))throw new o.ArcadeExecutionError(t,"PortalRequired",n);const s=d.toString(a[0]),c=d.toString(a[1]);let f=d.defaultUndefined(a[2],null);const m=d.toBoolean(d.defaultUndefined(a[3],!0));if(null===f&&(f=["*"]),!1===k.isArray(f))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);return l.constructFeatureSetFromPortalItem(s,c,t.spatialReference,f,m,t.services?.portal??T.getDefault(),t.lrucache,t.interceptor)})},e.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),e.functions.featuresetbyname=function(t,n){return e.standardFunctionAsync(t,n,(e,r,i)=>{if(d.pcCheck(i,2,4,t,n),d.isFeatureSetCollection(i[0])){const e=d.toString(i[1]);let r=d.defaultUndefined(i[2],null);const a=d.toBoolean(d.defaultUndefined(i[3],!0));if(null===r&&(r=["*"]),!1===k.isArray(r))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);return i[0].featureSetByName(e,a,r)}throw new o.ArcadeExecutionError(t,"InvalidParameter",n)})},e.signatures.push({name:"featuresetbyname",min:2,max:4}),e.functions.featureset=function(t,n){return e.standardFunction(t,n,(e,r,a)=>{d.pcCheck(a,1,1,t,n);const s={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(k.isString(a[0])){const e=JSON.parse(a[0]);void 0!==e.layerDefinition?(s.layerDefinition=e.layerDefinition,s.featureSet=e.featureSet,e.layerDefinition.spatialReference&&(s.layerDefinition.spatialReference=e.layerDefinition.spatialReference)):(s.featureSet.features=e.features,s.featureSet.geometryType=e.geometryType,s.layerDefinition.geometryType=s.featureSet.geometryType,s.layerDefinition.objectIdField=e.objectIdFieldName??"",s.layerDefinition.typeIdField=e.typeIdFieldName,s.layerDefinition.globalIdField=e.globalIdFieldName,s.layerDefinition.fields=e.fields,e.spatialReference&&(s.layerDefinition.spatialReference=e.spatialReference))}else{if(!(a[0]instanceof i))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);{const e=JSON.parse(a[0].castToText(!0)),r=L(e,"layerdefinition");if(null!==r){s.layerDefinition.geometryType=L(r,"geometrytype",""),s.featureSet.geometryType=s.layerDefinition.geometryType,s.layerDefinition.globalIdField=L(r,"globalidfield",""),s.layerDefinition.objectIdField=L(r,"objectidfield",""),s.layerDefinition.typeIdField=L(r,"typeidfield",""),s.layerDefinition.hasZ=!0===L(r,"hasz",!1),s.layerDefinition.hasM=!0===L(r,"hasm",!1);const t=L(r,"spatialreference");t&&(s.layerDefinition.spatialReference=P(t));const n=[];for(const e of L(r,"fields",[])){const t={name:L(e,"name",""),alias:L(e,"alias",""),type:L(e,"type",""),nullable:L(e,"nullable",!0),editable:L(e,"editable",!0),length:L(e,"length",null),domain:Z(L(e,"domain"))};n.push(t)}s.layerDefinition.fields=n;const i=L(e,"featureset");if(i){const e={};for(const t of n)e[t.name.toLowerCase()]=t.name;for(const t of L(i,"features",[])){const n={},r=L(t,"attributes",{});for(const t in r)n[e[t.toLowerCase()]]=r[t];s.featureSet.features.push({attributes:n,geometry:$(L(t,"geometry"))})}}}else{s.layerDefinition.hasZ=!0===L(e,"hasz",!1),s.layerDefinition.hasM=!0===L(e,"hasm",!1),s.layerDefinition.geometryType=L(e,"geometrytype",""),s.featureSet.geometryType=s.layerDefinition.geometryType,s.layerDefinition.objectIdField=L(e,"objectidfieldname",""),s.layerDefinition.typeIdField=L(e,"typeidfieldname","");const r=L(e,"spatialreference");r&&(s.layerDefinition.spatialReference=P(r));const i=[],a=L(e,"fields",null);if(!k.isArray(a))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);for(const e of a){const t={name:L(e,"name",""),alias:L(e,"alias",""),type:L(e,"type",""),nullable:L(e,"nullable",!0),editable:L(e,"editable",!0),length:L(e,"length",null),domain:Z(L(e,"domain"))};i.push(t)}s.layerDefinition.fields=i;const l={};for(const e of i)l[e.name.toLowerCase()]=e.name;let c=L(e,"features",null);if(k.isArray(c))for(const e of c){const t={},n=L(e,"attributes",{});for(const e in n)t[l[e.toLowerCase()]]=n[e];s.featureSet.features.push({attributes:t,geometry:$(L(e,"geometry",null))})}else c=null,s.featureSet.features=c}}}if(0==(!!(l=s).layerDefinition&&!!l.featureSet&&!1!==function(e){for(const t of["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])if(t===e)return!0;return!1}(l.layerDefinition.geometryType)&&!1!==k.isArray(l.layerDefinition.fields)&&!1!==k.isArray(l.featureSet.features)))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);var l;return s.layerDefinition.geometryType||(s.layerDefinition.geometryType="esriGeometryNull"),F.create(s,t.spatialReference)})},e.signatures.push({name:"featureset",min:1,max:1}),e.functions.filter=function(t,n){return e.standardFunctionAsync(t,n,async(r,i,a)=>{if(d.pcCheck(a,2,2,t,n),k.isArray(a[0])||d.isImmutableArray(a[0])){const e=[];let r,i=a[0];if(i instanceof c&&(i=i.toArray()),!d.isFunctionParameter(a[1]))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);r=a[1].createFunction(t);for(const t of i){const n=r(t);A.isPromiseLike(n)?!0===await n&&e.push(t):!0===n&&e.push(t)}return e}if(d.isFeatureSet(a[0])){const n=await a[0].load(),r=S.create(a[1],{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),i=r.getVariables();if(i.length>0){const n={};for(const r of i)n[r]=e.evaluateIdentifier(t,{name:r});r.parameters=n}return new m({parentfeatureset:a[0],whereclause:r})}throw new o.ArcadeExecutionError(t,"InvalidParameter",n)})},e.signatures.push({name:"filter",min:2,max:2}),e.functions.orderby=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(d.pcCheck(i,2,2,t,n),d.isFeatureSet(i[0])){const e=new h(i[1]);return new p({parentfeatureset:i[0],orderbyclause:e})}throw new o.ArcadeExecutionError(t,"InvalidParameter",n)})},e.signatures.push({name:"orderby",min:2,max:2}),e.functions.top=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(d.pcCheck(i,2,2,t,n),d.isFeatureSet(i[0]))return new y({parentfeatureset:i[0],topnum:i[1]});if(k.isArray(i[0]))return d.toNumber(i[1])>=i[0].length?i[0].slice():i[0].slice(0,d.toNumber(i[1]));if(d.isImmutableArray(i[0]))return d.toNumber(i[1])>=i[0].length()?i[0].slice():i[0].slice(0,d.toNumber(i[1]));throw new o.ArcadeExecutionError(t,"InvalidParameter",n)})},e.signatures.push({name:"top",min:2,max:2}),e.functions.first=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(d.pcCheck(i,1,1,t,n),d.isFeatureSet(i[0])){const n=await i[0].first(e.abortSignal);if(null!==n){const e=s.createFromGraphicLikeObject(n.geometry,n.attributes,i[0],t.timeZone);return e._underlyingGraphic=n,e}return n}return k.isArray(i[0])?0===i[0].length?null:i[0][0]:d.isImmutableArray(i[0])?0===i[0].length()?null:i[0].get(0):null})},e.signatures.push({name:"first",min:1,max:1}),e.functions.attachments=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,a)=>{d.pcCheck(a,1,2,t,n);const s={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(a.length>1)if(a[1]instanceof i){if(a[1].hasField("minsize")&&(s.minsize=d.toNumber(a[1].field("minsize"))),a[1].hasField("metadata")&&(s.returnMetadata=d.toBoolean(a[1].field("metadata"))),a[1].hasField("maxsize")&&(s.maxsize=d.toNumber(a[1].field("maxsize"))),a[1].hasField("types")){const e=d.toStringArray(a[1].field("types"),!1);e.length>0&&(s.types=e)}}else if(null!==a[1])throw new o.ArcadeExecutionError(t,"InvalidParameter",n);if(d.isFeature(a[0])){const e=a[0]._layer;let n;if(d.isFeatureSet(e))n=e;else{if(null==e||!w.isSupportedLayer(e))return[];n=l.constructFeatureSet(e,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await n.load(),n.queryAttachments(a[0].field(n.objectIdField),s.minsize,s.maxsize,s.types,s.returnMetadata)}if(null===a[0])return[];throw new o.ArcadeExecutionError(t,"InvalidParameter",n)})},e.signatures.push({name:"attachments",min:1,max:2}),e.functions.featuresetbyrelationshipname=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{d.pcCheck(i,2,4,t,n);const a=i[0],s=d.toString(i[1]);let c=d.defaultUndefined(i[2],null);const u=d.toBoolean(d.defaultUndefined(i[3],!0));if(null===c&&(c=["*"]),!1===k.isArray(c))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);if(null===i[0])return null;if(!d.isFeature(i[0]))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);const f=a._layer;let m;if(d.isFeatureSet(f))m=f;else{if(null==f||!w.isSupportedLayer(f))return null;m=l.constructFeatureSet(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}m=await m.load();const p=m.relationshipMetaData().filter(e=>e.name===s);if(0===p.length)return null;if(void 0!==p[0].relationshipTableId&&null!==p[0].relationshipTableId&&p[0].relationshipTableId>-1)return l.constructFeatureSetFromRelationship(m,p[0],a.field(m.objectIdField),m.spatialReference,c,u,t.lrucache,t.interceptor);let y=m.serviceUrl();if(!y)return null;y=y.endsWith("/")?y+p[0].relatedTableId.toString():y+"/"+p[0].relatedTableId.toString();const F=await l.constructFeatureSetFromUrl(y,m.spatialReference,c,u,t.lrucache,t.interceptor);await F.load();let h=F.relationshipMetaData();if(h=h.filter(e=>e.id===p[0].id),!1===a.hasField(p[0].keyField)||null===a.field(p[0].keyField)){const e=await m.getFeatureByObjectId(a.field(m.objectIdField),[p[0].keyField]);if(e){const t=S.create(h[0].keyField+"= @id",{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC});return t.parameters={id:e.attributes[p[0].keyField]},F.filter(t)}return new g({parentfeatureset:F})}const I=S.create(h[0].keyField+"= @id",{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC});return I.parameters={id:a.field(p[0].keyField)},F.filter(I)})},e.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),e.functions.featuresetbyassociation=function(n,r){return e.standardFunctionAsync(n,r,async(e,i,s)=>{d.pcCheck(s,2,3,n,r);const c=s[0],u=a.toStringEnumKey(d.toString(d.defaultUndefined(s[1],""))),m=k.isString(s[2])?d.toString(s[2]):null;if(null===s[0])return null;if(!d.isFeature(s[0]))throw new o.ArcadeExecutionError(n,"InvalidParameter",r);let p=c._layer;if(p instanceof x&&(p=l.constructFeatureSet(p,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),null===p)return null;if(!1===d.isFeatureSet(p))return null;await p.load();const y=p.serviceUrl(),g=await l.constructAssociationMetaDataFeatureSetFromUrl(y,n.spatialReference,!0);if(g.unVersion>=8)return await async function(e,n,r,i,a,s,c){const d=await e.getFeatureSetInfo();if(null===(d?.layerId??null))return null;if(!a.layerIdLookup.get(d.layerId))return null;const u=e.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),f=[];switch(r){case"connected":f.push("connectivity"),f.push("junction-edge-from-connectivity"),f.push("junction-edge-to-connectivity"),f.push("junction-edge-midspan-connectivity"),f.push("junction-junction-connectivity");break;case"container":case"content":f.push("containment");break;case"structure":case"attached":f.push("attachment");break;case"junctionedge":f.push("junction-edge-from-connectivity"),f.push("junction-edge-to-connectivity");break;case"midspan":f.push("junction-edge-midspan-connectivity");break;default:throw new o.ArcadeExecutionError(s,"InvalidParameter",c)}let m=null,p=!1;if(null!==i&&""!==i&&void 0!==i){for(const e of a.terminals)e.terminalName===i&&(m=e.terminalId);null===m&&(p=!0)}const y=[];if(!p){const i=new N({globalId:n.field(e.globalIdField),networkSourceId:a.layerIdLookup.get(d.layerId).sourceId,...m?{terminalId:m}:""}),o=await D.queryAssociations(u,new C({types:f,elements:[i]}));let s=0;for(const e of o.associations){let n=null,o="",l="";if(e.fromNetworkElement?.globalId===i.globalId?(n=e.toNetworkElement,l="to"):e.toNetworkElement?.globalId===i.globalId&&(n=e.fromNetworkElement,l="from"),!n)continue;switch(r){case"attached":if("attachment"!==e.associationType)continue;if("to"!==l)continue;break;case"structure":if("attachment"!==e.associationType)continue;if("from"!==l)continue;break;case"container":if("containment"!==e.associationType)continue;if("from"!==l)continue;break;case"content":if("containment"!==e.associationType)continue;if("to"!==l)continue;break;case"connected":break;case"junctionedge":"junction-edge-to-connectivity"===e.associationType?o="to":"junction-edge-from-connectivity"===e.associationType&&(o="from");break;case"midspan":if("junction-edge-midspan-connectivity"!==e.associationType)continue}const c=a.sourceIdLookup.get(n.networkSourceId)?.className??"";y.push(new t({geometry:null,attributes:{objectId:s++,globalId:n.globalId,percentAlong:e.percentAlong??0,isContentVisible:e.isContentVisible?0:1,className:c,side:o}}))}}const g=new x({source:y,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new b({name:"objectId",alias:"objectId",type:"oid"}),new b({name:"globalId",alias:"globalId",type:"global-id"}),new b({name:"percentAlong",alias:"percentAlong",type:"double"}),new b({name:"side",alias:"side",type:"string"}),new b({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new b({name:"className",alias:"className",type:"string"})]});return l.constructFeatureSet(g)}(p,c,u,m,g,n,r);const F=g.associations;let h=null,I=null,E=!1;if(null!==m&&""!==m&&void 0!==m){for(const e of g.terminals)e.terminalName===m&&(I=e.terminalId);null===I&&(E=!0)}const A=F.getFieldsIndex(),T=A.get("TOGLOBALID").name,v=A.get("FROMGLOBALID").name,L=A.get("TOTERMINALID").name,Z=A.get("FROMTERMINALID").name,P=A.get("FROMNETWORKSOURCEID").name,$=A.get("TONETWORKSOURCEID").name,U=A.get("ASSOCIATIONTYPE").name,R=A.get("ISCONTENTVISIBLE").name,M=A.get("OBJECTID").name;for(const e of p.fields)if("global-id"===e.type){h=c.field(e.name);break}let j=null,O=new f.SqlExpressionAdapted(new b({name:"percentalong",alias:"percentalong",type:"double"}),S.create("0",{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC})),z=new f.SqlExpressionAdapted(new b({name:"side",alias:"side",type:"string"}),S.create("''",{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC}));const W="globalid",q="globalId",H={};for(const e in g.lkp)H[e]=g.lkp[e].sourceId;const B=new f.StringToCodeAdapted(new b({name:"classname",alias:"classname",type:"string"}),null,H);let G="";switch(u){case"midspan":{G=`((${T}='${h}') OR ( ${v}='${h}')) AND (${U} IN (5))`,B.codefield=S.create(`CASE WHEN (${T}='${h}') THEN ${P} ELSE ${$} END`,{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC});const e=w.cloneField(f.AdaptedFeatureSet.findField(F.fields,v));e.name=W,e.alias=W,j=new f.SqlExpressionAdapted(e,S.create(`CASE WHEN (${v}='${h}') THEN ${T} ELSE ${v} END`,{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC})),O=g.unVersion>=4?new f.OriginalField(f.AdaptedFeatureSet.findField(F.fields,A.get("PERCENTALONG").name)):new f.SqlExpressionAdapted(new b({name:"percentalong",alias:"percentalong",type:"double"}),S.create("0",{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{G=`((${T}='${h}') OR ( ${v}='${h}')) AND (${U} IN (4,6))`,B.codefield=S.create(`CASE WHEN (${T}='${h}') THEN ${P} ELSE ${$} END`,{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC});const e=w.cloneField(f.AdaptedFeatureSet.findField(F.fields,v));e.name=W,e.alias=W,j=new f.SqlExpressionAdapted(e,S.create(`CASE WHEN (${v}='${h}') THEN ${T} ELSE ${v} END`,{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC})),z=new f.SqlExpressionAdapted(new b({name:"side",alias:"side",type:"string"}),S.create(`CASE WHEN (${U}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let e=`${T}='@T'`,t=`${v}='@T'`;null!==I&&(e+=` AND ${L}=@A`,t+=` AND ${Z}=@A`),G="(("+e+") OR ("+t+"))",G=d.multiReplace(G,"@T",h??""),e=d.multiReplace(e,"@T",h??""),null!==I&&(e=d.multiReplace(e,"@A",I.toString()),G=d.multiReplace(G,"@A",I.toString())),B.codefield=S.create("CASE WHEN "+e+` THEN ${P} ELSE ${$} END`,{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC});const n=w.cloneField(f.AdaptedFeatureSet.findField(F.fields,v));n.name=W,n.alias=W,j=new f.SqlExpressionAdapted(n,S.create("CASE WHEN "+e+` THEN ${v} ELSE ${T} END`,{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC}));break}case"container":G=`${T}='${h}' AND ${U} = 2`,null!==I&&(G+=` AND ${L} = `+I.toString()),B.codefield=P,G="( "+G+" )",j=new f.FieldRename(f.AdaptedFeatureSet.findField(F.fields,v),W,W);break;case"content":G=`(${v}='${h}' AND ${U} = 2)`,null!==I&&(G+=` AND ${Z} = `+I.toString()),B.codefield=$,G="( "+G+" )",j=new f.FieldRename(f.AdaptedFeatureSet.findField(F.fields,T),W,W);break;case"structure":G=`(${T}='${h}' AND ${U} = 3)`,null!==I&&(G+=` AND ${L} = `+I.toString()),B.codefield=P,G="( "+G+" )",j=new f.FieldRename(f.AdaptedFeatureSet.findField(F.fields,v),W,q);break;case"attached":G=`(${v}='${h}' AND ${U} = 3)`,null!==I&&(G+=` AND ${Z} = `+I.toString()),B.codefield=$,G="( "+G+" )",j=new f.FieldRename(f.AdaptedFeatureSet.findField(F.fields,T),W,q);break;default:throw new o.ArcadeExecutionError(n,"InvalidParameter",r)}return E&&(G="1 <> 1"),new f.AdaptedFeatureSet({parentfeatureset:F,adaptedFields:[new f.OriginalField(f.AdaptedFeatureSet.findField(F.fields,M)),new f.OriginalField(f.AdaptedFeatureSet.findField(F.fields,R)),j,z,B,O],extraFilter:G?S.create(G,{fieldsIndex:F.getFieldsIndex(),timeZone:F.dateFieldsTimeZoneDefaultUTC}):null})})},e.signatures.push({name:"featuresetbyassociation",min:2,max:6}),e.functions.groupby=function(t,n){return e.standardFunctionAsync(t,n,async(r,a,s)=>{if(d.pcCheck(s,3,3,t,n),!d.isFeatureSet(s[0]))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);const l=await s[0].load(),c=[],u=[];let f=!1,m=[];if(k.isString(s[1]))m.push(s[1]);else if(s[1]instanceof i)m.push(s[1]);else if(k.isArray(s[1]))m=s[1];else{if(!d.isImmutableArray(s[1]))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);m=s[1].toArray()}for(const e of m)if(k.isString(e)){const t=S.create(d.toString(e),{fieldsIndex:l.getFieldsIndex(),timeZone:l.dateFieldsTimeZoneDefaultUTC}),n=!0===I.isSingleField(t)?d.toString(e):"%%%%FIELDNAME";c.push({name:n,expression:t}),"%%%%FIELDNAME"===n&&(f=!0)}else{if(!(e instanceof i))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);{const r=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",i=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===r&&(f=!0),!r)throw new o.ArcadeExecutionError(t,"InvalidParameter",n);c.push({name:r,expression:S.create(i||r,{fieldsIndex:l.getFieldsIndex(),timeZone:l.dateFieldsTimeZoneDefaultUTC})})}}if(m=[],k.isString(s[2]))m.push(s[2]);else if(k.isArray(s[2]))m=s[2];else if(d.isImmutableArray(s[2]))m=s[2].toArray();else{if(!(s[2]instanceof i))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);m.push(s[2])}for(const e of m){if(!(e instanceof i))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);{const r=e.hasField("name")?e.field("name"):"",i=e.hasField("statistic")?e.field("statistic"):"",a=e.hasField("expression")?e.field("expression"):"";if(!(r&&i&&k.isString(i)&&a))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);u.push({name:r,statistic:i,expression:S.create(a,{fieldsIndex:l.getFieldsIndex(),timeZone:l.dateFieldsTimeZoneDefaultUTC})})}}if(f){const e={};for(const t of l.fields)e[t.name.toLowerCase()]=1;for(const t of c)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);for(const t of u)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const n of c)if("%%%%FIELDNAME"===n.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,n.name="FIELD_"+t.toString()}}for(const n of c)v(n.expression,e,t);for(const n of u)v(n.expression,e,t);return s[0].groupby(c,u)})},e.signatures.push({name:"groupby",min:3,max:3}),e.functions.distinct=function(t,n){return e.standardFunctionAsync(t,n,async(r,a,s)=>{if(d.isFeatureSet(s[0])){d.pcCheck(s,2,2,t,n);const r=await s[0].load(),a=[];let l=[];if(k.isString(s[1]))l.push(s[1]);else if(s[1]instanceof i)l.push(s[1]);else if(k.isArray(s[1]))l=s[1];else{if(!d.isImmutableArray(s[1]))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);l=s[1].toArray()}let c=!1;for(const e of l)if(k.isString(e)){const t=S.create(d.toString(e),{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}),n=!0===I.isSingleField(t)?d.toString(e):"%%%%FIELDNAME";a.push({name:n,expression:t}),"%%%%FIELDNAME"===n&&(c=!0)}else{if(!(e instanceof i))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);{const i=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",s=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===i&&(c=!0),!i)throw new o.ArcadeExecutionError(t,"InvalidParameter",n);a.push({name:i,expression:S.create(s||i,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})})}}if(c){const e={};for(const t of r.fields)e[t.name.toLowerCase()]=1;for(const t of a)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const n of a)if("%%%%FIELDNAME"===n.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,n.name="FIELD_"+t.toString()}}for(const n of a)v(n.expression,e,t);return s[0].groupby(a,[])}return function(e){if(1===e.length){if(k.isArray(e[0]))return E.calculateStat("distinct",e[0],-1);if(d.isImmutableArray(e[0]))return E.calculateStat("distinct",e[0].toArray(),-1)}return E.calculateStat("distinct",e,-1)}(s)})},e.functions.getfeaturesetinfo=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,a)=>{if(d.pcCheck(a,1,1,t,n),!d.isFeatureSet(a[0]))return null;const o=await a[0].getFeatureSetInfo();return o?i.convertObjectToArcadeDictionary({layerId:o.layerId,layerName:o.layerName,itemId:o.itemId,serviceLayerUrl:o.serviceLayerUrl,webMapLayerId:o.webMapLayerId??null,webMapLayerTitle:o.webMapLayerTitle??null,className:null,objectClassId:null},d.defaultTimeZone(t),!1,!1):null})},e.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),e.functions.filterbysubtypecode=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(d.pcCheck(i,2,2,t,n),d.isFeatureSet(i[0])){const e=await i[0].load(),r=i[1];if(!k.isInteger(r))throw new o.ArcadeExecutionError(t,"InvalidParameter",n);if(e.subtypeField){const t=S.create(`${e.subtypeField}= ${i[1]}`,{fieldsIndex:e.getFieldsIndex(),timeZone:e.dateFieldsTimeZoneDefaultUTC});return new m({parentfeatureset:i[0],whereclause:t})}if(null===e.typeIdField||""===e.typeIdField)throw new o.ArcadeExecutionError(t,"FeatureSetDoesNotHaveSubtypes",n);const a=S.create(`${e.typeIdField}= ${i[1]}`,{fieldsIndex:e.getFieldsIndex(),timeZone:e.dateFieldsTimeZoneDefaultUTC});return new m({parentfeatureset:i[0],whereclause:a})}throw new o.ArcadeExecutionError(t,"InvalidParameter",n)})},e.signatures.push({name:"filterbysubtypecode",min:2,max:2})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});