// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../../../core/promiseUtils","../../../core/sql/WhereClause","../../../geometry/SpatialReference"],function(e,t,s,i,n,r,a,l){"use strict";class h extends t{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=e.parentfeatureset,e.whereclause instanceof a?(this._whereclause=e.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=e.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.subtypeField=this._parent.subtypeField,this.subtypes=this._parent.subtypes):(this.fields=[],this.typeIdField="",this.subtypeField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new l({wkid:4326}),this.geometryType=i.layerGeometryEsriConstants.point)}async _getSet(e){if(null===this._wset){await this._ensureLoaded();const t=await this._parent._getFilteredSet("",null,this._whereclause,null,e);return this._checkCancelled(e),null!==this._whereClauseFunction?this._wset=new s(t._candidates.slice().concat(t._known.slice()),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)):this._wset=new s(t._candidates.slice(),t._known.slice(),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(e){let t=this._parent?._isInFeatureSet(e);return 1===t?t:(t=this._idstates[e],void 0===t?2:t)}_getFeature(e,t,s){return this._parent._getFeature(e,t,s)}_getFeatures(e,t,s,i){return this._parent._getFeatures(e,t,s,i)}_featureFromCache(e){return this._parent._featureFromCache(e)}executeWhereClause(e){return this._whereclause?.testFeature(e)??!1}async executeWhereClauseDeferred(e){if(null!==this._whereClauseFunction){const t=this._whereClauseFunction(e);return r.isPromiseLike(t),t}return this.executeWhereClause(e)}async _fetchAndRefineFeatures(e,t,i){const n=new s([],e,!1,null),r=Math.min(t,e.length);if(await(this._parent?._getFeatures(n,-1,r,i)),this._checkCancelled(i),null==this._whereClauseFunction){for(let t=0;t<r;t++){const s=this._parent?._featureFromCache(e[t]);!0===this.executeWhereClause(s)?this._idstates[e[t]]=0:this._idstates[e[t]]=1}return"success"}const a=[];for(let t=0;t<r;t++){const s=this._parent?._featureFromCache(e[t]);a.push(await this.executeWhereClauseDeferred(s))}for(let s=0;s<t;s++)!0===a[s]?this._idstates[e[s]]=0:this._idstates[e[s]]=1;return"success"}async _getFilteredSet(e,t,i,r,a){null!==this._whereClauseFunction||(null!==i?null!==this._whereclause&&(i=n.combine(this._whereclause,i)):i=this._whereclause),await this._ensureLoaded();const l=await this._parent._getFilteredSet(e,t,i,r,a);let h;return this._checkCancelled(a),h=null!==this._whereClauseFunction?new s(l._candidates.slice().concat(l._known.slice()),[],l._ordered,this._clonePageDefinition(l.pagesDefinition)):new s(l._candidates.slice(),l._known.slice(),l._ordered,this._clonePageDefinition(l.pagesDefinition)),h}async _stat(e,t,s,i,r,a,l){if(null!==this._whereClauseFunction)return null===r&&""===s&&null===i?this._manualStat(e,t,a,l):{calculated:!1};let h=this._whereclause;null!==r&&null!==this._whereclause&&(h=n.combine(this._whereclause,r));const u=await this._parent._stat(e,t,s,i,h,a,l);return!1===u.calculated?null===r&&""===s&&null===i?this._manualStat(e,t,a,l):{calculated:!1}:u}async _canDoAggregates(e,t,s,i,r){return null===this._whereClauseFunction&&(null!==r?null!==this._whereclause&&(r=n.combine(this._whereclause,r)):r=this._whereclause,null!==this._parent&&this._parent._canDoAggregates(e,t,s,i,r))}async _getAggregatePagesDataSourceDefinition(t,s,i,r,a,l,h){if(null===this._parent)throw new e.FeatureSetError("NeverReach");return null!==a?null!==this._whereclause&&(a=n.combine(this._whereclause,a)):a=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(t,s,i,r,a,l,h)}static registerAction(){t._featuresetFunctions.filter=function(e){if("function"==typeof e)return new h({parentfeatureset:this,whereclause:e});let t=null;return e instanceof a&&(t=e),new h({parentfeatureset:this,whereclause:t})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}return h});