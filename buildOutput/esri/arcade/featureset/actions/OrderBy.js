// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/languageUtils","../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/OrderbyClause"],function(e,t,n,r,s){"use strict";class i extends n{constructor(e){super(e),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=e.orderbyclause,this._parent=e.parentfeatureset}async _getSet(e){if(null===this._wset){await this._ensureLoaded();const t=await this._getFilteredSet("",null,null,this._orderbyclause,e);return this._checkCancelled(e),this._wset=t,this._wset}return this._wset}async manualOrderSet(e,t){const n=await this.getIdColumnDictionary(e,[],-1,t);this._orderbyclause?.order(n);const s=new r([],[],!0,null);for(let e=0;e<n.length;e++)s._known.push(n[e].id);return s}async getIdColumnDictionary(t,n,r,s){if(r<t._known.length-1){const i=this._maxQueryRate();if("GETPAGES"===t._known[r+1])return await e.tick(this._parent._expandPagedSet(t,i,0,0,s)),this.getIdColumnDictionary(t,n,r,s);let a=r+1;const c=[];for(;a<t._known.length&&"GETPAGES"!==t._known[a];)c.push(t._known[a]),a++;r+=c.length;const u=await e.tick(this._parent._getFeatureBatch(c,s));this._checkCancelled(s);for(const e of u)n.push({id:e.attributes[this.objectIdField],feature:e});return this.getIdColumnDictionary(t,n,r,s)}return t._candidates.length>0?(await e.tick(this._refineSetBlock(t,this._maxProcessingRate(),s)),this._checkCancelled(s),this.getIdColumnDictionary(t,n,r,s)):n}_isInFeatureSet(e){return this._parent._isInFeatureSet(e)}_getFeatures(e,t,n,r){return this._parent._getFeatures(e,t,n,r)}_featureFromCache(e){if(void 0===this._featureCache[e]){const t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]}async _fetchAndRefineFeatures(){throw new t.FeatureSetError("NeverReach")}async _getFilteredSet(e,t,n,s,i){await this._ensureLoaded();const a=await this._parent._getFilteredSet(e,t,n,null===s?this._orderbyclause:s,i);this._checkCancelled(i);const c=new r(a._candidates.slice(),a._known.slice(),a._ordered,this._clonePageDefinition(a.pagesDefinition));let u=!0;if(a._candidates.length>0&&(u=!1),!1===c._ordered){let e=await this.manualOrderSet(c,i);return!1===u&&(null===t&&null===n||(e=new r(e._candidates.slice().concat(e._known.slice()),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)))),e}return c}static registerAction(){n._featuresetFunctions.orderBy=function(e){return""===e?this:new i({parentfeatureset:this,orderbyclause:new s(e)})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}return i});