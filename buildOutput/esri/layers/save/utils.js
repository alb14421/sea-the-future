// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/Error","../../core/accessorSupport/originUtils","../../portal/Portal","../../portal/PortalItem","../../portal/support/jsonContext","../../portal/support/portalItemUtils","../../webdoc/support/saveUtils"],function(e,t,r,a,o,i,n,s){"use strict";function l(e,r,a){const o=a(e);if(!o.isValid)throw new t(`${r}:invalid-parameters`,o.errorMessage,{layer:e})}async function p(e){const{layer:t,errorNamePrefix:r,validateLayer:a}=e;await t.load(),l(t,r,a)}function c(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function u(e){const{item:r,errorNamePrefix:a,layer:o,validateItem:i}=e;if(function(e){const{item:r,itemType:a,additionalItemType:o,errorNamePrefix:i,layer:n}=e,s=[a];if(o&&s.push(o),!s.includes(r.type)){const e=s.map(e=>`'${e}'`).join(", ");throw new t(`${i}:portal-item-wrong-type`,`Portal item type should be one of: "${e}"`,{item:r,layer:n})}}(e),i){const e=i(r);if(!e.isValid)throw new t(`${a}:invalid-parameters`,e.errorMessage,{layer:o})}}function d(e){const{layer:r,errorNamePrefix:a}=e,{portalItem:o}=r;if(!o)throw new t(`${a}:portal-item-not-set`,c(r,"requires the portalItem property to be set"));if(!o.loaded)throw new t(`${a}:portal-item-not-loaded`,c(r,"cannot be saved to a portal item that does not exist or is inaccessible"));u({...e,item:o})}function m(e){const{newItem:t,itemType:r}=e;let i=o.from(t);return i.id&&(i=i.clone(),i.id=null),i.type??=r,i.portal??=a.getDefault(),u({...e,item:i}),i}function y(e){return i.createForItemWrite(e,"portal-item")}async function f(e,t,r){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const a=e.write({},t);return await Promise.all(t.resources?.pendingOperations??[]),s.evaluateWriteErrors(t,{errorName:"layer-write:unsupported"},r),a}function w(e){n.addTypeKeyword(e,n.typeKeyword.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((e,t,r)=>r.indexOf(e)===t))}async function I(e,t,r){const a=e.portal;await a.signIn(),await a.user.addItem({item:e,data:t,folder:r?.folder})}e.addItem=I,e.createErrorMessage=c,e.ensureItemConfig=d,e.ensureLayerConfig=l,e.getLayerJSON=f,e.getPortalItem=m,e.save=async function(e,t){const{layer:a,createItemData:o,createJSONContext:i,setItemProperties:n,saveResources:s,supplementalUnsupportedErrors:l}=e;await p(e),d(e);const c=a.portalItem,u=i?i(c):y(c),m=await f(a,u,{...t,supplementalUnsupportedErrors:l}),I=await o({layer:a,layerJSON:m},c);return await(n?.(a,c,I)),w(c),await c.update({data:I}),r.updateOrigins(u),await(s?.(c,u)),c},e.saveAs=async function(e,t){const{layer:a,createItemData:o,createJSONContext:i,setItemProperties:n,saveResources:s,supplementalUnsupportedErrors:l}=e;await p(e);const c=m(e),u=i?i(c):y(c),d=await f(a,u,{...t,supplementalUnsupportedErrors:l}),g=await o({layer:a,layerJSON:d},c);return await n(a,c,g),w(c),await I(c,g,t),a.portalItem=c,r.updateOrigins(u),await(s?.(c,u)),c},e.setCommonItemProperties=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});