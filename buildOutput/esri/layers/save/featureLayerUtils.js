// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../core/arrayUtils","../../core/has","../../core/Error","../../core/accessorSupport/originUtils","./utils","../support/arcgisLayerUrl","../support/fetchService","../support/layerUtils","../../portal/support/jsonContext","../../portal/support/portalItemUtils"],function(e,r,t,a,o,n,s,l,i,y,c,u){"use strict";const p=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),f="Feature Service",d="feature-layer-utils",m=`${d}-save`,h=`${d}-save-as`,w=`${d}-saveall`,g=`${d}-saveall-as`;function T(e){return{isValid:y.isLayerWithFeatureLayerSource(e)&&(!("dynamicDataSource"in e)||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function b(e,r){const t=c.createForItemWrite(e,"portal-item");return r?.isTable&&(t.layerContainerType="tables"),t}function v(e){const r=b(e),t=b(e);return t.layerContainerType="tables",{forLayers:r,forTables:t}}function S(e){const r=[],t=[];for(const{layer:a,layerJSON:o}of e)L(a)?t.push(o):r.push(o);return{layers:r,tables:t}}function L(e,r){return e.isTable}function I(e){return S([e])}async function P(e,r){return/\/\d+\/?$/.test(e.url)?I(r[0]):O(r,e)}async function O(r,t){if(r.reverse(),!t)return S(r);const a=await async function(r,t){let a=await r.fetchData("json");if(function(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}(a))return a;a||={},function(e){e.layers||=[],e.tables||=[]}(a);const{layer:{url:o,customParameters:n,apiKey:s}}=t[0];return await async function(r,t,a){const{url:o,customParameters:n,apiKey:s}=t,{serviceJSON:l,layersJSON:y}=await i.fetchFeatureService(o,{customParameters:n,apiKey:s}),c=K(r.layers,l.layers,a),u=K(r.tables,l.tables,a);r.layers=c.itemResources,r.tables=u.itemResources;const f=[...c.added,...u.added],d=y?[...y.layers,...y.tables]:[];await async function(r,t,a,o){const n=await async function(r){const t=[];r.forEach(({type:r})=>{switch(i.getLayerModuleType(r)){case"CatalogLayer":t.push(new Promise((r,t)=>e(["../CatalogLayer"],e=>r(p(e)),t)).then(e=>e.default));break;case"FeatureLayer":t.push(new Promise((r,t)=>e(["../FeatureLayer"],e=>r(p(e)),t)).then(e=>e.default));break;case"OrientedImageryLayer":t.push(new Promise((r,t)=>e(["../OrientedImageryLayer"],e=>r(p(e)),t)).then(e=>e.default))}});const a=await Promise.all(t),o=new Map;return r.forEach(({type:e},r)=>{o.set(e,a[r])}),o}(t),s=t.map(({id:e,type:r})=>new(n.get(r))({url:a,layerId:e,sourceJSON:o.find(({id:r})=>r===e)}));await Promise.allSettled(s.map(e=>e.load())),s.forEach(e=>{const{layerId:t,loaded:a,defaultPopupTemplate:o}=e;if(!a||null==o)return;const n={id:t,popupInfo:o.toJSON()};x(e,"ArcGISFeatureLayer"===e.operationalLayerType?n:{...n,layerType:e.operationalLayerType},r)})}(r,f,o,d)}(a,{url:o??"",customParameters:n,apiKey:s},t.map(e=>e.layer.layerId)),a}(t,r);for(const e of r)x(e.layer,e.layerJSON,a);return function(e,r){const t=[],a=[];for(const{layer:e}of r){const{isTable:r,layerId:o}=e;r?a.push(o):t.push(o)}E(e.layers,t),E(e.tables,a)}(a,r),a}function E(e,r){if(e.length<2)return;const a=[];for(const{id:r}of e)a.push(r);t.equals(a.sort(A),r.slice().sort(A))&&e.sort((e,t)=>{const a=r.indexOf(e.id),o=r.indexOf(t.id);return a<o?-1:a>o?1:0})}function A(e,r){return e<r?-1:e>r?1:0}function K(e,r,a){const o=t.difference(e,r,(e,r)=>e.id===r.id);e=e.filter(e=>!o.removed.some(r=>r.id===e.id));const n=o.added;return n.forEach(({id:r})=>{e.push({id:r})}),{itemResources:e,added:n.filter(({id:e})=>!a.includes(e))}}function x(e,r,t){e.isTable?N(t.tables,r):N(t.layers,r)}function N(e,r){const t=e.findIndex(({id:e})=>e===r.id);-1===t?e.push(r):e[t]=r}function $(e,r){if(!e.length)throw new o(`${r}:missing-parameters`,"'layers' array should contain at least one feature layer")}function C(e,r){const t=e.map(e=>e.layerId);if(new Set(t).size!==t.length)throw new o(`${r}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}function U(e){if(!("layerType"in e))return!!e.charts?.length;switch(e.layerType){case"OrientedImageryLayer":return!!e.charts?.length;case"SubtypeGroupLayer":return!!e.layers.some(e=>!!e.charts?.length);case"SubtypeGroupTable":return!!e.tables.some(e=>!!e.charts?.length);case"CatalogLayer":return!!e.footprintLayer?.charts?.length}}function F(e,r){let t=0,a=0,o=0,n=0;for(const e of[...r.layers,...r.tables])if(U(e)&&n++,"layerType"in e)switch(e.layerType){case"OrientedImageryLayer":t++;break;case"SubtypeGroupLayer":a++;break;case"SubtypeGroupTable":o++}u.toggleTypeKeyword(e,u.typeKeyword.ORIENTED_IMAGERY_LAYER,t>0),u.toggleTypeKeyword(e,u.typeKeyword.SUBTYPE_GROUP_LAYER,a>0),u.toggleTypeKeyword(e,u.typeKeyword.SUBTYPE_GROUP_TABLE,o>0),u.toggleTypeKeyword(e,u.typeKeyword.CHARTS,n>0)}function J(e,r,t){u.removeTypeKeyword(r,u.typeKeyword.METADATA),u.toggleTypeKeyword(r,u.typeKeyword.MULTI_LAYER,e.length>1),u.toggleTypeKeyword(r,u.typeKeyword.SINGLE_LAYER,1===e.length),u.toggleTypeKeyword(r,u.typeKeyword.TABLE,t.tables.length>0&&0===t.layers.length),F(r,t)}async function M(e,r,t){F(r,t)}async function R(e,r,t){const{url:a,layerId:o,title:n,fullExtent:s,isTable:i}=e,y=l.parse(a);r.url=("FeatureServer"===y?.serverType?a:`${a}/${o}`)??null,r.title||=n,r.extent=null,i||null==s||(r.extent=await u.getWGS84ExtentForItem(s)),J([e],r,t)}r.save=async function(e,r){const t={layer:e,itemType:f,validateLayer:T,createJSONContext:r=>b(r,e),createItemData:(e,r)=>P(r,[e]),errorNamePrefix:m,setItemProperties:M};return s.save(t,r)},r.saveAll=async function(e,r){await async function(e){$(e,w),await Promise.all(e.map(e=>e.load()));for(const r of e)s.ensureLayerConfig(r,w,T),s.ensureItemConfig({layer:r,itemType:f,errorNamePrefix:w});!function(e,r){const t=e.map(e=>e.portalItem.id);if(new Set(t).size>1)throw new o(`${r}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")}(e,w),C(e,w)}(e);const t=e[0].portalItem,a=v(t),l=await Promise.all(e.map(e=>s.getLayerJSON(e,e.isTable?a.forTables:a.forLayers,r))),i=await P(t,e.map((e,r)=>({layer:e,layerJSON:l[r]})));return function(e,r){F(e,r),s.setCommonItemProperties(e)}(t,i),await t.update({data:i}),await Promise.all(e.slice(1).map(e=>e.portalItem.reload())),n.updateOrigins(a.forLayers),n.updateOrigins(a.forTables),t.clone()},r.saveAllAs=async function(e,r,a){await async function(e){$(e,g),await Promise.all(e.map(e=>e.load()));for(const r of e)s.ensureLayerConfig(r,g,T);!function(e,r){for(const t of e){const a=t.parsedUrl.path,n=l.parse(a),i=n?.url.path;if(!i)throw new o(`${r}:invalid-parameters`,s.createErrorMessage(t,`has unsupported url pattern: ${a}`),{layer:t});const y=n?.serverType;if("FeatureServer"!==y&&"MapServer"!==y)throw new o(`${r}:invalid-parameters`,s.createErrorMessage(t,`has unsupported server type: ${y}`),{layer:t});if("MapServer"===y&&e.length>1)throw new o(`${r}:invalid-parameters`,"Only one layer or table in a map service can be saved")}const t=l.parse(e[0].parsedUrl.path),a=t?.url.path,n=e.every(e=>{const r=l.parse(e.parsedUrl.path);return r?.url.path===a});if(!n)throw new o(`${r}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")}(e,g),C(e,g)}(e);const i=s.getPortalItem({itemType:f,errorNamePrefix:g,newItem:r}),y=v(i),c=await Promise.all(e.map(e=>s.getLayerJSON(e,e.isTable?y.forTables:y.forLayers,a))),p=await O(e.map((e,r)=>({layer:e,layerJSON:c[r]})));await async function(e,r,a){let o=0;for(const{isTable:r}of e)r||o++;const n=e[0].parsedUrl.path,i=l.parse(n);if(r.url="FeatureServer"===i?.serverType?i.url.path:n,r.title||=i.title,r.extent=null,o>0){const a=e.map(e=>e.fullExtent).filter(t.isSome).reduce((e,r)=>e.clone().union(r));a&&(r.extent=await u.getWGS84ExtentForItem(a))}J(e,r,a),s.setCommonItemProperties(r)}(e,i,p),await s.addItem(i,p,a);for(const r of e)r.portalItem=i.clone();return n.updateOrigins(y.forLayers),n.updateOrigins(y.forTables),i},r.saveAs=async function(e,r,t){const a={layer:e,itemType:f,validateLayer:T,createJSONContext:r=>b(r,e),createItemData:(e,r)=>Promise.resolve(I(e)),errorNamePrefix:h,newItem:r,setItemProperties:R};return s.saveAs(a,t)},Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});