// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../request","../../core/Error","../../core/Logger","../../core/urlUtils","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../graphics/featureConversionUtils","../graphics/OptimizedFeatureSet","../graphics/sources/geojson/geojson","../graphics/sources/support/clientSideDefaults","../graphics/sources/support/sourceUtils","../support/FieldsIndex","../support/fieldType","../../time/constants"],function(e,t,n,i,r,a,o,s,l,c,u,d,p,f,m,g){"use strict";const y=()=>i.getLogger("esri.layers.ogc.ogcFeatureUtils"),w="startindex",b=new Set([w,"offset"]),h="http://www.opengis.net/def/crs/",F=`${h}OGC/1.3/CRS84`;async function j(e,i,d){const{collection:{links:m,landingPage:{url:g}},layerDefinition:y,maxRecordCount:w,queryParameters:{apiKey:b,customParameters:h},spatialReference:F,supportedCrs:j}=e,S=k(m,"items","application/geo+json")||k(m,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==S)throw new n("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:x,num:v,start:O,timeExtent:P,where:q}=i;if(i.objectIds)throw new n("ogc-feature-layer:query-by-objectids-not-supported","Queries with object ids are not supported");const C=a.fromJSON(F),N=i.outSpatialReference??C,D=N.isWGS84?null:I(N,j),G=function(e,t){if(!function(e){return null!=e&&"extent"===e.type}(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:T(e)};const i=I(n,t);return null!=i?{bbox:T(e),"bbox-crs":i}:n.isWebMercator?{bbox:T(s.project(e,a.WGS84))}:null}(x,j),A=function(e){if(null==e)return null;const{start:t,end:n}=e;return`${null!=t?t.toISOString():".."}/${null!=n?n.toISOString():".."}`}(P),R=function(e){return null!=e&&e&&"1=1"!==e?e:null}(q),W=v??(null==O?w:10),$=0===O?void 0:O,{fields:M,geometryType:L,hasZ:Z,objectIdField:J,paginationParameter:K}=y,U=r.makeAbsolute(S.href,g),{data:z}=await t(U,{...d,query:{...h,...G,crs:D,datetime:A,query:R,limit:W,[K]:$,token:b},headers:{accept:"application/geo+json"}}),E=u.createOptimizedFeatures(z,{geometryType:L,hasZ:Z,objectIdField:J}),Q=E.length===W&&!!k(z.links??[],"next","application/geo+json"),_=new f(M);for(const e of E){const t={};p.mixAttributes(_,t,e.attributes,!0);for(const e of _.fields)e.nullable&&!(e.name in t)&&(t[e.name]=null);t[J]=e.attributes[J],e.attributes=t}if(!D&&N.isWebMercator)for(const e of E)if(null!=e.geometry&&null!=L){const t=l.convertToGeometry(e.geometry,L,Z,!1);t.spatialReference=a.WGS84,e.geometry=l.convertFromGeometry(s.project(t,N))}for(const e of E)e.objectId=e.attributes[J];const B=D||!D&&N.isWebMercator?N.toJSON():o.wgs84,V=new c;return V.exceededTransferLimit=Q,V.features=E,V.fields=M,V.geometryType=L,V.hasZ=Z,V.spatialReference=B,V}function I(e,t){const{isWebMercator:n,wkid:i}=e;if(!i)return null;const r=n?t[3857]??t[102100]??t[102113]??t[900913]:t[e.wkid];return r?`${h}${r}`:null}function T(e){if(null==e)return"";const{xmin:t,ymin:n,xmax:i,ymax:r}=e;return`${t},${n},${i},${r}`}function k(e,t,n){return e.find(({rel:e,type:i})=>e===t&&i===n)??e.find(({rel:e,type:n})=>e===t&&!n)}e.crsDefault=F,e.crsPrefix=h,e.getCollectionDefinition=async function(e,i,o={},s=5){const{links:l}=e,c=k(l,"items","application/geo+json")||k(l,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==c)throw new n("ogc-feature-layer:missing-items-page","Missing items url");const{apiKey:p,customParameters:h,signal:F}=o,j=r.makeAbsolute(c.href,e.landingPage.url),I={limit:s,...h,token:p},T=r.addQueryParameters(j,I),{data:S}=await t(T,{signal:F,headers:{accept:"application/geo+json"}}),x=function(e,t,n){if(!n)return;const i=k(n,"next","application/geo+json"),a=r.urlToObject(i?.href)?.query;if(!a)return;const o=r.urlToObject(e).query,s=Object.keys(o??{}),l=Object.entries(a).filter(([e])=>!s.includes(e)).find(([e,n])=>b.has(e.toLowerCase())&&Number.parseInt(n,10)===t),c=l?.[0];return c}(T,s,S.links)??w;u.validateGeoJSON(S);const v=u.inferLayerProperties(S,{geometryType:i.geometryType}),O=i.fields||v.fields||[],P=null!=i.hasZ?i.hasZ:v.hasZ,q=v.geometryType,C=i.objectIdField||v.objectIdFieldName||"OBJECTID";let N=i.timeInfo;const D=O.find(({name:e})=>e===C);if(D)D.editable=!1,D.nullable=!1;else{if(!v.objectIdFieldType)throw new n("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");O.unshift({name:C,alias:C,type:"number"===v.objectIdFieldType?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(C!==v.objectIdFieldName){const e=O.find(({name:e})=>e===v.objectIdFieldName);e&&(e.type="esriFieldTypeInteger")}O===v.fields&&v.unknownFields.length>0&&y().warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:v.unknownFields}});for(const e of O){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new n("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(!m.kebabDict.jsonValues.includes(e.type))throw new n("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(N){const e=new f(O);if(N.startTimeField){const t=e.get(N.startTimeField);t?(N.startTimeField=t.name,t.type="esriFieldTypeDate"):N.startTimeField=null}if(N.endTimeField){const t=e.get(N.endTimeField);t?(N.endTimeField=t.name,t.type="esriFieldTypeDate"):N.endTimeField=null}if(N.trackIdField){const t=e.get(N.trackIdField);t?N.trackIdField=t.name:(N.trackIdField=null,y().warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:N}}))}N.timeReference||={timeZoneIANA:g.utc},N.startTimeField||N.endTimeField||(y().warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:N}}),N=void 0)}const G=q?d.createDrawingInfo(q):null,A=function(e){const t=e.extent?.spatial;if(!t)return null;const n=t.bbox[0],i=4===n.length,[r,o]=n,s=i?void 0:n[2];return{xmin:r,ymin:o,xmax:i?n[2]:n[3],ymax:i?n[3]:n[4],zmin:s,zmax:i?void 0:n[5],spatialReference:a.WGS84.toJSON()}}(e);return{drawingInfo:G,extent:A,geometryType:q,fields:O,hasZ:!!P,objectIdField:C,paginationParameter:x,timeInfo:N}},e.getServerCollections=async function(e,i={}){const{links:a,url:o}=e,s=k(a,"data","application/json")||k(a,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(null==s)throw new n("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:l,customParameters:c,signal:u}=i,d=r.makeAbsolute(s.href,o),{data:p}=await t(d,{signal:u,headers:{accept:"application/json"},query:{...c,token:l}});for(const t of p.collections)t.landingPage=e;return p},e.getServerConformance=async function(e,i={}){const{links:a,url:o}=e,s=k(a,"conformance","application/json")||k(a,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(null==s)throw new n("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:l,customParameters:c,signal:u}=i,d=r.makeAbsolute(s.href,o),{data:p}=await t(d,{signal:u,headers:{accept:"application/json"},query:{...c,token:l}});return p},e.getServerLandingPage=async function(e,n={}){const{apiKey:i,customParameters:r,signal:a}=n,{data:o}=await t(e,{signal:a,headers:{accept:"application/json"},query:{...r,token:i}});return o.url=e,o},e.getServerOpenApi=async function(e,n={}){const{links:i,url:a}=e,o=k(i,"service-desc","application/vnd.oai.openapi+json;version=3.0");if(null==o)return y().warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:s,customParameters:l,signal:c}=n,u=r.makeAbsolute(o.href,a),{data:d}=await t(u,{signal:c,headers:{accept:"application/vnd.oai.openapi+json;version=3.0"},query:{...l,token:s}});return d},e.getSpatialReferenceWkid=function(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),n=t?.groups;if(!n)return null;const{authority:i,code:r}=n;switch(i.toLowerCase()){case"ogc":switch(r.toLowerCase()){case"crs27":return a.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return a.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(r,10);return Number.isNaN(e)?null:e}default:return null}},e.queryFeatureSetJSON=async function(e,t,n){const i=await j(e,t,n);return l.convertToFeatureSet(i)},e.queryOptimizedFeatureSet=j,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});