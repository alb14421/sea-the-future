// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/CircularArray","../../../core/Error","../../../core/mathUtils","../../support/streamLayerUtils"],function(e,t,s,i,r){"use strict";e.StreamFeatureManager=class{constructor(e,t,i,o,a=128){if(this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=i,this._purgeOptions=o,this.store=e,"unique-id-composite"===t.type)throw new s("stream-layer","composite uniqueIds are not supported");this.idField=t.fieldName,this.purgeInterval=a,this._useGeneratedIds=this.idField===r.defaultStreamIdField}removeById(e){this._removed.push(e)}removeByTrackId(e){const t=this._trackIdToObservations.get(e);if(t)for(const e of t.entries)this._removed.push(e)}add(e){if(this._useGeneratedIds){const t=this._nextId();e.attributes[this.idField]=t,e.objectId=t}else e.objectId=e.attributes[this.idField];const s=e.objectId;if(this._addOrUpdated.set(s,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return null==this._trackIdLessObservations&&(this._trackIdLessObservations=new t(1e5)),void this._trackIdLessObservations.enqueue(s);const r=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(r)){const e=null!=this._purgeOptions?.maxObservations?this._purgeOptions.maxObservations:1e3,s=i.clamp(e,0,1e3);this._trackIdToObservations.set(r,new t(s))}const o=this._trackIdToObservations.get(r),a=o?.enqueue(s);null!=a&&(this._addOrUpdated.has(a)?this._addOrUpdated.delete(a):this._removed.push(a))}checkForUpdates(){const e=this._getToAdd(),t=this._getToRemove(),s=performance.now(),i=s-this._lastPurge,o=Date.now();i>=this.purgeInterval&&(this._purge(s),this._lastPurge=s);const a=[];if(null!=t)for(const e of t){const t=this.store.removeById(e);null!=t&&a.push(t)}const d=[];if(null!=e){const i=new Set(t??[]);for(const t of e)i.has(t.objectId)||(t.attributes[r.esriTimestamp]=s,t.attributes[r.internalTimeReceivedField]=o,this.store.add(t),d.push(t))}return!(!d.length&&!a?.length||(this.store.update(d,a),0))}_getToAdd(){if(!this._addOrUpdated.size)return null;const e=new Array(this._addOrUpdated.size);let t=0;return this._addOrUpdated.forEach(s=>e[t++]=s),this._addOrUpdated.clear(),e}_getToRemove(){const e=this._removed;return this._removed.length?(this._removed=[],e):null}_nextId(){const e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}_purge(e){const t=this._purgeOptions;null!=t&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}_purgeSomeByDisplayCount(e){if(!e.displayCount)return;let t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField)for(const s of this._trackIdToObservations.values())if(t>e.displayCount&&s.size){const e=s.dequeue();this._removed.push(e),t--}if(null!=this._trackIdLessObservations){let s=t-e.displayCount;for(;s-- >0;){const e=this._trackIdLessObservations.dequeue();null!=e&&this._removed.push(e)}}}}_purgeByAge(e){const t=this._timeInfo?.startTimeField;if(!e.age||!t)return;const s=60*e.age*1e3,i=this._maxAge-s;this.store.forEach(e=>{e.attributes[t]<i&&this._removed.push(e.objectId)})}_purgeByAgeReceived(e,t){if(!t.ageReceived)return;const s=e-60*t.ageReceived*1e3;this.store.forEach(e=>{e.attributes[r.esriTimestamp]<s&&this._removed.push(e.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((e,t)=>{0===e.size&&this._trackIdToObservations.delete(t)})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});