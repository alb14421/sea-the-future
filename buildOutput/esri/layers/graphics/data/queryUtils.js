// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/Error","../../../core/jsonMap","../../../core/unitUtils","../../../geometry/projectionUtils","../../../geometry/support/extentUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","./projectionSupport"],function(e,t,i,n,r,a,o,s,l,u,c){"use strict";const m=new n.JSONMap({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),p=Object.freeze({});async function y(e,t,i){const{outFields:n,orderByFields:r,groupByFieldsForStatistics:a,outStatistics:o}=e;if(n)for(let e=0;e<n.length;e++)n[e]=n[e].trim();if(r)for(let e=0;e<r.length;e++)r[e]=r[e].trim();if(a)for(let e=0;e<a.length;e++)a[e]=a[e].trim();if(o)for(let e=0;e<o.length;e++)o[e].onStatisticField&&(o[e].onStatisticField=o[e].onStatisticField.trim());return e.geometry&&!e.outSR&&(e.outSR=e.geometry.spatialReference),f(e,t,i)}async function f(t,n,a){if(!t)return null;let{where:y}=t;if(t.where=y=y?.trim(),(!y||/^1 *= *1$/.test(y)||n&&n===y)&&(t.where=null),!t.geometry)return t;let f=await async function(t){const{distance:n,units:a}=t,o=t.geometry;if(null==n||"vertexAttributes"in o)return o;const l=o.spatialReference,p=a?m.fromJSON(a):r.getUnitString(l),y=l&&(u.isGeographic(l)||u.isWebMercator(l))?o:await c.checkProjectionSupport(l,u.wgs84).then(()=>c.project(o,u.wgs84)),f=await new Promise((t,i)=>e(["../../../geometry/operators/json/geodesicBufferOperator"],t,i));await f.load();const g=f.execute(y,n||1,{unit:p})??void 0;if(!g||!s.isPolygon(g)||0===g.rings.length)throw new i("unsupported-query:invalid-parameters","Invalid parameters for query by distance");return g}(t);if(t.distance=0,t.units=null,"esriSpatialRelEnvelopeIntersects"===t.spatialRel){const{spatialReference:e}=t.geometry;f=o.getGeometryExtent(f),f.spatialReference=e}if(f){await c.checkProjectionSupport(f.spatialReference,a),f=function(e,t){const i=e.spatialReference;return g(e,t)&&s.isExtent(e)?{spatialReference:i,rings:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]}:e}(f,a);const e=(await l.normalizeCentralMeridian(s.fromJSON(f)))[0];if(null==e)throw p;const i="quantizationParameters"in t&&t.quantizationParameters?.tolerance||"maxAllowableOffset"in t&&t.maxAllowableOffset||0,n=i&&g(f,a)?{densificationStep:8*i}:void 0,r=e.toJSON(),o=c.project(r,r.spatialReference,a,n);if(!o)throw p;o.spatialReference=a,t.geometry=o}return t}function g(e,t){if(!e)return!1;const i=e.spatialReference;return(s.isExtent(e)||s.isPolygon(e)||s.isPolyline(e))&&!u.equals(i,t)&&!a.canProjectWithoutEngine(i,t)}t.getDateInNumber=function(e,t){return null==e?null:"string"==typeof e?t?new Date(`1970-01-01T${e}Z`).getTime():new Date(e).getTime():e instanceof Date?e.getTime():e},t.normalizeAttributeBinsQuery=async function(e,t,i){const n=e.bin;return n.onField&&(n.onField=n.onField.trim()),n.onExpression?.value&&(n.onExpression.value=n.onExpression.value.trim()),n.splitBy&&(n.splitBy.value&&(n.splitBy.value=n.splitBy.value.trim()),n.splitBy.outAlias&&(n.splitBy.outAlias=n.splitBy.outAlias.trim())),n.stackBy&&(n.stackBy.value&&(n.stackBy.value=n.stackBy.value.trim()),n.stackBy.outAlias&&(n.stackBy.outAlias=n.stackBy.outAlias.trim())),"normalizationField"in n.parameters&&n.parameters.normalizationField&&(n.parameters.normalizationField=n.parameters.normalizationField.trim()),e.outStatistics?.length||(e.outStatistics=[{statisticType:"count",onStatisticField:"1",outStatisticFieldName:"frequency"}]),y(e,t,i)},t.normalizeQuery=y,t.normalizeQueryLike=f,t.queryEngineEmptyResult=p,t.unitsKebabDict=m,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});