// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/lang","../../../core/promiseUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","./projectionSupport","./QueryEngine","./QueryEngineResult","./queryUtils","./queryValidationUtils","./spatialQuerySupport"],function(e,t,a,r,i,n,s,l,o,u,c,p){"use strict";e.executeQueryForSnapping=async function(e,y,m){const d=a.signalFromSignalOrOptions(m),{point:f,distance:g,returnEdge:x,vertexMode:R}=y;if(!x&&"none"===R)return{candidates:[]};let S=t.clone(y.query);S=await e.schedule(()=>u.normalizeQueryLike(S,e.definitionExpression,e.spatialReference),d),S=await e.reschedule(()=>c.validateQuery(S,{availableFields:e.availableFields,fieldsIndex:e.fieldsIndex,geometryType:e.geometryType,spatialReference:e.spatialReference}),d);const h=!n.equals(f.spatialReference,e.spatialReference);h&&await s.checkProjectionSupport(f.spatialReference,e.spatialReference);const w="number"==typeof g?g:g.x,Q="number"==typeof g?g:g.y,O={xmin:f.x-w,xmax:f.x+w,ymin:f.y-Q,ymax:f.y+Q,spatialReference:f.spatialReference},b=h?s.project(O,e.spatialReference):O;if(!b)return{candidates:[]};const j=(await i.normalizeCentralMeridian(r.fromJSON(f),null,{signal:d}))[0],F=(await i.normalizeCentralMeridian(r.fromJSON(b),null,{signal:d}))[0];if(null==j||null==F)return{candidates:[]};const M=new o.QueryEngineResult(await e.reschedule(()=>e.searchFeatures(l.getQueryBBoxes(F.toJSON())),d),S,e);await e.reschedule(()=>e.executeObjectIdsQuery(M),d),await e.reschedule(()=>e.executeTimeQuery(M),d),await e.reschedule(()=>e.executeAttributesQuery(M),d),await e.reschedule(()=>async function(e,t,a){const{query:r}=t,{spatialRel:i}=r;if(!t?.items?.length||!r.geometry||!i)return;const n=await p.getSpatialQueryOperator(i,r.geometry,e.geometryType,e.hasZ,e.hasM),s=await e.runSpatialFilter(t.items,e=>n(e.geometry),a);t.items=s}(e,M,d),d);const U=j.toJSON(),q=h?s.project(U,e.spatialReference):U,v=h?Math.max(b.xmax-b.xmin,b.ymax-b.ymin)/2:g;return M.createSnappingResponse({...y,point:q,distance:v},S.returnZ,f.spatialReference)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});