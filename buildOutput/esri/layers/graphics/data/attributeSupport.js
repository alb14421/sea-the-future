// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Error","../../../core/sql/WhereClauseCache","../../support/fieldType"],function(e,i,t,r){"use strict";const s=new t.WhereClauseCache(50,500),n="unsupported-query",a=" as ",o=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeBigInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"]),l=new Set(["esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"]),d=new Set(["esriFieldTypeString","esriFieldTypeGUID","esriFieldTypeGlobalID",...o,...l]);function p(e,t,r={}){const a=c(t,e);if(!a){const r=s.getError(t,e);throw new i(n,"invalid SQL expression",{expression:t,error:r})}const o=r.expressionName||"expression";if(r.validateStandardized&&!a.isStandardized)throw new i(n,`${o} is not standard`,{expression:t});if(r.validateAggregate&&!a.isAggregate)throw new i(n,`${o} does not contain a valid aggregate function`,{expression:t});return a.fieldNames}function c(e,i){return e?s.get(e,i):null}function u(e){return/\((.*?)\)/.test(e)?e:e.split(a)[0]}function f(e,t,r,s={}){const a=new Map;if(function(e,i,t,r,s){const n=s.includes("*")?[...t,...s.filter(e=>"*"!==e)]:s;for(const s of n)if(i.get(s))y(e,i,t,r,s);else try{const n=p(i,u(s),{validateStandardized:!0});for(const s of n)y(e,i,t,r,s)}catch(i){e.set(s,{type:"expression-error",expression:s,error:i})}}(a,e,t,s.allowedFieldTypes??d,r),a.size){const e=s.expressionName??"expression";throw new i(n,`${e} contains invalid or missing fields`,{errors:Array.from(a.values()),query:s.query})}}function y(e,i,t,s,n){const a=i.get(n);a?t.has(a.name)?"all"!==s&&!1===s?.has(a.type)&&e.set(n,{type:"invalid-type",fieldName:a.name,fieldType:r.kebabDict.fromJSON(a.type),allowedFieldTypes:Array.from(s,e=>r.kebabDict.fromJSON(e))}):e.set(n,{type:"missing-field",fieldName:a.name}):e.set(n,{type:"invalid-field",fieldName:n})}e.allDateAndTimeFieldTypes=l,e.getAliasFromFieldName=function(e){return e.split(a)[1]},e.getExpressionFromFieldName=u,e.getWhereClause=c,e.numericFieldTypes=o,e.validateFields=f,e.validateHaving=function(e,t,r,s,a){if(!r)return!0;const o="having clause",l=p(e,r,{validateAggregate:!0,expressionName:o});f(e,t,l,{expressionName:o,query:a});const d=c(r,e),u=d?.getExpressions().every(i=>{const{aggregateType:t,field:r}=i,n=e.get(r)?.name;return s.some(i=>{const{onStatisticField:r,statisticType:s}=i,a=e.get(r)?.name;return a===n&&s.toLowerCase().trim()===t})});if(!u)throw new i(n,"expressions in having clause should also exist in outStatistics",{having:r});return!0},e.validateWhere=function(e,i,t,r){if(!t)return!0;const s="where clause";return f(e,i,p(e,t,{validateStandardized:!0,expressionName:s}),{expressionName:s,query:r}),!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});