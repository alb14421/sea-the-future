// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Error","./attributeSupport","./projectionSupport","./spatialQuerySupport","../../../support/loadArcade"],function(e,t,i,s,r,a){"use strict";const n="unsupported-query";async function o(e,{fieldsIndex:a,geometryType:o,spatialReference:d,availableFields:p}){if(null!=e.geometryPrecision||e.multipatchOption&&"xyFootprint"!==e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new t(n,"Unsupported query options",{query:e});return l(a,p,e),function(e,s,r){const{outStatistics:a,groupByFieldsForStatistics:o,having:l}=r,d=o?.length,p=a?.length;if(l){if(!d||!p)throw new t(n,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:r});i.validateHaving(e,s,l,a,r)}if(p){if(!function(e){return null!=e&&e.every(e=>"exceedslimit"!==e.statisticType)}(a))return;const l=a.map(e=>e.onStatisticField).filter(Boolean);i.validateFields(e,s,l,{expressionName:"onStatisticFields",query:r}),d&&i.validateFields(e,s,o,{expressionName:"groupByFieldsForStatistics",query:r});for(const o of a){const{onStatisticField:a,statisticType:l}=o;if("percentile_disc"!==l&&"percentile_cont"!==l||!("statisticParameters"in o))e.get(a)&&"count"!==l&&"min"!==l&&"max"!==l&&i.validateFields(e,s,[a],{expressionName:`outStatistics with '${l}' statistic type`,allowedFieldTypes:u,query:r});else{const{statisticParameters:e}=o;if(!e)throw new t(n,"statisticParameters should be set for percentile type",{definition:o,query:r})}}}}(a,p,e),Promise.all([r.checkSpatialQuerySupport(e,o,d),s.checkProjectionSupport(d,e.outSR)]).then(()=>e)}function l(e,s,r){const{returnDistinctValues:a,outStatistics:o}=r,l=o?o.map(e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase()).filter(Boolean):[];if("orderByFields"in r&&r.orderByFields&&r.orderByFields.length>0){const t=" asc",a=" desc",n=r.orderByFields.map(e=>{const i=e.toLowerCase();return i.includes(t)?i.split(t)[0]:i.includes(a)?i.split(a)[0]:e}).filter(e=>!l.includes(e));i.validateFields(e,s,n,{expressionName:"orderByFields",query:r})}if("outFields"in r)if(r.outFields?.length)i.validateFields(e,s,r.outFields,{expressionName:"outFields",query:r,allowedFieldTypes:"all"});else if(a)throw new t(n,"outFields should be specified for returnDistinctValues",{query:r});i.validateWhere(e,s,r.where,r)}const u=new Set([...i.numericFieldTypes,...i.allDateAndTimeFieldTypes]);async function d(e,s,r,o){let l=[];if(r.valueExpression){const{arcadeUtils:e}=await a.loadArcade();l=e.extractFieldNames(r.valueExpression)}if(r.field&&l.push(r.field),r.field2&&l.push(r.field2),r.field3&&l.push(r.field3),r.normalizationField&&l.push(r.normalizationField),!l.length&&!r.valueExpression)throw new t(n,"field or valueExpression is required",{params:r});i.validateFields(e,s,l,{expressionName:"statistics",query:o})}e.validateAttributeBinsQuery=async function(e,i){const s=e.bin;if(!s.onField&&!s.onExpression?.value||"autoIntervalBin"===s.type&&null==s.parameters.numberOfBins||"dateBin"===s.type&&(null==s.parameters.number||null==s.parameters.unit)||"fixedBoundariesBin"===s.type&&null==s.parameters.boundaries||"fixedIntervalBin"===s.type&&null==s.parameters.interval)throw new t(n,"Unsupported query options",{query:e});return o(e,i)},e.validateQuery=o,e.validateStatisticsQuery=async function(e,i,{fieldsIndex:a,geometryType:o,spatialReference:u,availableFields:p}){if(null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new t(n,"Unsupported query options",{query:e});return l(a,p,e),Promise.all([d(a,p,i,e),r.checkSpatialQuerySupport(e,o,u),s.checkProjectionSupport(u,e.outSR)]).then(()=>e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});