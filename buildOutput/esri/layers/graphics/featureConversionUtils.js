// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/Error","../../core/Logger","../../core/maybe","../../geometry/support/aaBoundingBox","../../geometry/support/aaBoundingRect","../../geometry/support/jsonUtils","./OptimizedFeature","./OptimizedFeatureSet","./OptimizedGeometry","./data/createFeatureId"],function(e,t,n,o,r,s,u,c,l,i,a){"use strict";function f(e,t){return e?t?4:3:t?3:2}const h=()=>n.getLogger("esri.layers.graphics.featureConversionUtils"),m={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0,esriGeometryMultiPatch:3,esriGeometryEnvelope:0},d=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s},g=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s,e[n+2]=t[o+2]},y=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s,e[n+2]=t[o+3]},p=(e,t,n,o,r,s)=>{e[n]=r,e[n+1]=s,e[n+2]=t[o+2],e[n+3]=t[o+3]};function F(e,t,n,o){if(e){if(n)return t&&o?p:g;if(t&&o)return y}else if(t&&o)return g;return d}function M({scale:e,translate:t},n){return Math.round((n-t[0])/e[0])}function I({scale:e,translate:t},n){return Math.round((t[1]-n)/e[1])}function G({scale:e,translate:t},n){return Math.round((n-t[0])/e[0])}function T({scale:e,translate:t},n){return Math.round((n-t[1])/e[1])}function z({scale:e,translate:t},n,o){return n*e[o]+t[o]}function P(e){const t=e.coords;return{x:t[0],y:t[1]}}function w(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function b(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function v(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function N(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function O(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function x(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function Z(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function S(e,t){return e&&t?Z:e?v:t?O:w}function E(e,t,n,o,r){const s=S(n,o);for(const n of t){const t=null!=n.geometry?s(new i,n.geometry):null;e.push(new c.OptimizedFeature(t,n.attributes,null,a.createFeatureId(n,r)))}return e}function q(e,t,n=S(null!=t.z,null!=t.m)){return n(e,t)}function V(e,t,n,o){for(const{geometry:r,attributes:s}of t)e.push({attributes:s,geometry:null!=r?Y(r,n,o):null});return e}function Y(e,t,n){if(null==e)return null;const o=f(t,n),r=[];for(let t=0;t<e.coords.length;t+=o){const n=[];for(let r=0;r<o;r++)n.push(e.coords[t+r]);r.push(n)}return t?n?{points:r,hasZ:t,hasM:n}:{points:r,hasZ:t}:n?{points:r,hasM:n}:{points:r}}function k(e,t,n,o,r){const s=f(n,o);for(const n of t){const t=null!=n.geometry?_(new i,n.geometry,s):null;e.push(new c.OptimizedFeature(t,n.attributes,null,a.createFeatureId(n,r)))}return e}function _(e,t,n=f(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const o=e.coords;let r=0;for(const e of t.points)for(let t=0;t<n;t++)o[r++]=e[t];return e}function A(e,t,n){if(!e)return null;const o=f(t,n),{coords:r,lengths:s}=e,u=[];let c=0;for(const e of s){const t=[];for(let n=0;n<e;n++){const e=[];for(let t=0;t<o;t++)e.push(r[c++]);t.push(e)}u.push(t)}return t?n?{paths:u,hasZ:t,hasM:n}:{paths:u,hasZ:t}:n?{paths:u,hasM:n}:{paths:u}}function L(e,t,n,o,r){const s=f(n,o);for(const n of t){const t=null!=n.geometry?R(new i,n.geometry,s):null,o=null!=n.centroid?q(new i,n.centroid):null;e.push(new c.OptimizedFeature(t,n.attributes,o,a.createFeatureId(n,r)))}return e}function R(e,t,n=f(t.hasZ,t.hasM)){const{lengths:o,coords:r}=e;let s=0;for(const e of t.paths){for(const t of e)for(let e=0;e<n;e++)r[s++]=t[e];o.push(e.length)}return e}function U(e,t,n){if(!e)return null;const o=f(t,n),{coords:r,lengths:s}=e,u=[];let c=0;for(const e of s){const t=[];for(let n=0;n<e;n++){const e=[];for(let t=0;t<o;t++)e.push(r[c++]);t.push(e)}u.push(t)}return t?n?{rings:u,hasZ:t,hasM:n}:{rings:u,hasZ:t}:n?{rings:u,hasM:n}:{rings:u}}function B(e,t,n=t.hasZ,o=t.hasM){return $(e,t.rings,n,o)}function $(e,t,n,o){const r=f(n,o),{lengths:s,coords:u}=e;let c=0;ne(e);for(const e of t){for(const t of e)for(let e=0;e<r;e++)u[c++]=t[e];s.push(e.length)}return e}const C=[],Q=[];function j(e,n,o,r,s,u){if(oe(e),!o){for(const t of n){const n=a.createFeatureId(t,u);e.push(new c.OptimizedFeature(null,t.attributes,null,n))}return e}switch(o){case"esriGeometryPoint":return E(e,n,r,s,u);case"esriGeometryMultipoint":return k(e,n,r,s,u);case"esriGeometryPolyline":return L(e,n,r,s,u);case"esriGeometryPolygon":case"esriGeometryMultiPatch":return function(e,t,n,o,r){for(const s of t){const t=null!=s.geometry?B(new i,s.geometry,n,o):null,u=a.createFeatureId(s,r);null!=s.centroid?e.push(new c.OptimizedFeature(t,s.attributes,w(new i,s.centroid),u)):e.push(new c.OptimizedFeature(t,s.attributes,null,u))}return e}(e,n,r,s,u);default:h().error("convertToFeatureSet:unknown-geometry",new t("internal:geometry",`Unable to parse unknown geometry type '${o}'`)),oe(e)}return e}function X(e,n,o,r){const s=e&&("coords"in e?e:e.geometry);if(null==s)return null;switch(n){case"esriGeometryPoint":{let e=P;return o&&r?e=x:o?e=b:r&&(e=N),e(s)}case"esriGeometryMultipoint":return Y(s,o,r);case"esriGeometryPolyline":return A(s,o,r);case"esriGeometryPolygon":return U(s,o,r);default:return h().error("convertToGeometry:unknown-geometry",new t("internal:geometry",`Unable to parse unknown geometry type '${n}'`)),null}}function D(e,n,o,r,s){if(oe(e),null==o)return function(e,t){for(const n of t)e.push({attributes:n.attributes});return e}(e,n);switch(o){case"esriGeometryPoint":return function(e,t,n,o){let r=P;n&&o?r=x:n?r=b:o&&(r=N);for(const n of t){const{geometry:t,attributes:o}=n,s=null!=t?r(t):null;e.push({attributes:o,geometry:s})}return e}(e,n,r,s);case"esriGeometryMultipoint":return V(e,n,r,s);case"esriGeometryPolyline":return function(e,t,n,o){for(const{geometry:r,attributes:s}of t)e.push({attributes:s,geometry:null!=r?A(r,n,o):null});return e}(e,n,r,s);case"esriGeometryPolygon":return function(e,t,n,o){for(const{geometry:r,attributes:s,centroid:u}of t){const t=null!=r?U(r,n,o):null;if(null!=u){const n=P(u);e.push({attributes:s,centroid:n,geometry:t})}else e.push({attributes:s,geometry:t})}return e}(e,n,r,s);default:h().error("convertToFeatureSet:unknown-geometry",new t("internal:geometry",`Unable to parse unknown geometry type '${o}'`))}return e}function H(e,t,n,o,r,s,u=n,c=o){if(ne(e),!t?.coords.length)return null;const l=m[r],{coords:i,lengths:a}=t,h=f(n,o),d=f(n&&u,o&&c),g=F(n,o,u,c);if(!a.length)return g(e.coords,i,0,0,M(s,i[0]),I(s,i[1])),ne(e,h,0),e;let y,p,G,T,z=0,P=0,w=P;for(const t of a){if(t<l)continue;let n=0;P=w,G=y=M(s,i[z]),T=p=I(s,i[z+1]),g(e.coords,i,P,z,G,T),n++,z+=h,P+=d;for(let o=1;o<t;o++,z+=h)G=M(s,i[z]),T=I(s,i[z+1]),G===y&&T===p||(g(e.coords,i,P,z,G-y,T-p),P+=d,n++,y=G,p=T);n>=l&&(e.lengths.push(n),w=P)}return oe(e.coords,w),e.coords.length?e:null}function J(e,t,n,o){const r=e[t],s=e[t+1],u=e[n],c=e[n+1],l=e[o],i=e[o+1];let a=u,f=c,h=l-a,m=i-f;if(0!==h||0!==m){const e=((r-a)*h+(s-f)*m)/(h*h+m*m);e>1?(a=l,f=i):e>0&&(a+=h*e,f+=m*e)}return h=r-a,m=s-f,h*h+m*m}function K(e,t,n,o,r,s,u){let c,l=o,i=0;for(let e=s+n;e<u;e+=n)c=J(t,e,s,u),c>l&&(i=e,l=c);l>o&&(i-s>n&&K(e,t,n,o,r,s,i),r(e,t,e.length,i,t[i],t[i+1]),u-i>n&&K(e,t,n,o,r,i,u))}function W(e,t,n,r,s){const{coords:u,lengths:c}=t,l=f(n,r);if(!u.length)return e!==t&&ne(e),e;o.assertIsSome(s);const{originPosition:i,scale:a,translate:h}=s,m=re;m.originPosition=i;const d=m.scale;d[0]=a[0]??1,d[1]=-(a[1]??1),d[2]=a[2]??1,d[3]=a[3]??1;const g=m.translate;if(g[0]=h[0]??0,g[1]=h[1]??0,g[2]=h[2]??0,g[3]=h[3]??0,!c.length){for(let t=0;t<l;++t)e.coords[t]=z(m,u[t],t);return e!==t&&ne(e,l,0),e}let y=0;for(let t=0;t<c.length;t++){const n=c[t];e.lengths[t]=n;for(let t=0;t<l;++t)e.coords[y+t]=z(m,u[y+t],t);let o=e.coords[y],r=e.coords[y+1];y+=l;for(let t=1;t<n;t++,y+=l){o+=u[y]*d[0],r+=u[y+1]*d[1],e.coords[y]=o,e.coords[y+1]=r;for(let t=2;t<l;++t)e.coords[y+t]=z(m,u[y+t],t)}}return e!==t&&ne(e,u.length,c.length),e}function ee(e,t,n,o){let r=0,s=e[o*t],u=e[o*(t+1)];for(let c=1;c<n;c++){const n=s+e[o*(t+c)],l=u+e[o*(t+c)+1],i=(n-s)*(l+u);s=n,u=l,r+=i}return.5*r}function te(e,t,n,o){return 0===e*o-n*t&&e*n+t*o>0}function ne(e,t=0,n=0){oe(e.lengths,n),oe(e.coords,t)}function oe(e,t=0){e.length!==t&&(e.length=t)}const re={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};e.convertFromFeature=function(e,t,n,o,r){C[0]=e;const[s]=j(Q,C,t,n,o,r);return oe(C),oe(Q),s},e.convertFromFeatureSet=function(e,t){const n=new l,{hasM:o,hasZ:r,features:s,spatialReference:u,geometryType:c,exceededTransferLimit:i,transform:a,fields:f}=e;return f&&(n.fields=f),n.geometryType=c??null,n.spatialReference=u??null,s&&j(n.features,s,c,r,o,t),i&&(n.exceededTransferLimit=i),o&&(n.hasM=o),r&&(n.hasZ=r),a&&(n.transform=a),n},e.convertFromFeatures=j,e.convertFromGeometry=function(e,n,o){if(null==e)return null;const r=new i;return"hasZ"in e&&null==n&&(n=e.hasZ),"hasM"in e&&null==o&&(o=e.hasM),u.isPoint(e)?S(null!=n?n:null!=e.z,null!=o?o:null!=e.m)(r,e):u.isPolygon(e)?B(r,e,n,o):u.isPolyline(e)?R(r,e,f(n,o)):u.isMultipoint(e)?_(r,e,f(n,o)):void h().error("convertFromGeometry:unknown-geometry",new t("internal:geometry",`Unable to parse unknown geometry type '${e}'`))},e.convertFromMultipoint=_,e.convertFromMultipointFeatures=k,e.convertFromNestedArray=$,e.convertFromPoint=q,e.convertFromPointFeatures=E,e.convertFromPolygon=B,e.convertFromPolyline=R,e.convertFromPolylineFeatures=L,e.convertToFeature=function(e,t,n,o){Q[0]=e,D(C,Q,t,n,o);const r=C[0];return oe(C),oe(Q),r},e.convertToFeatureSet=function(e){const{spatialReference:t,transform:n,fields:o,hasM:r,hasZ:s,features:u,geometryType:c,exceededTransferLimit:l,queryGeometry:i,queryGeometryType:a}=e,f={features:D([],u,c,s,r),fields:o,geometryType:c,spatialReference:t,queryGeometry:X(i,a,!1,!1)};return n&&(f.transform=n),l&&(f.exceededTransferLimit=l),r&&(f.hasM=r),s&&(f.hasZ=s),f},e.convertToFeatures=D,e.convertToGeometry=X,e.convertToMultipoint=Y,e.convertToMultipointFeatures=V,e.convertToPoint=function(e,t,n){return e?t?n?x(e):b(e):n?N(e):P(e):null},e.convertToPolygon=U,e.convertToPolyline=A,e.generalizeOptimizedGeometry=function(e,t,n,o,r,s,u=n,c=o){if(ne(e),!t?.coords.length)return null;const l=m[r],{coords:i,lengths:a}=t,h=f(n,o),d=f(n&&u,o&&c),g=F(n,o,u,c);if(!a.length)return g(e.coords,i,0,0,i[0],i[1]),ne(e,h,0),e;let y=0;const p=s*s;for(const t of a){if(t<l){y+=t*h;continue}const n=e.coords.length/d,o=y,r=y+(t-1)*h;g(e.coords,i,e.coords.length,o,i[o],i[o+1]),K(e.coords,i,h,p,g,o,r),g(e.coords,i,e.coords.length,r,i[r],i[r+1]);const s=e.coords.length/d-n;s>=l?e.lengths.push(s):oe(e.coords,n*d),y+=t*h}return e.coords.length?e:null},e.getBoundsOptimizedGeometry=function(e,t,n,o){if(!t?.coords?.length)return null;const u=f(n,o);let c=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,a=Number.NEGATIVE_INFINITY;if(t&&t.coords){const e=t.coords;for(let t=0;t<e.length;t+=u){const n=e[t],o=e[t+1];c=Math.min(c,n),i=Math.max(i,n),l=Math.min(l,o),a=Math.max(a,o)}}return r.is(e)?r.fromRectValues(e,c,l,i,a):s.fromValues(c,l,i,a,e),e},e.getQuantizedArea=function(e,t){const{coords:n,lengths:o}=e;let r=0,s=0;for(let e=0;e<o.length;e++){const u=o[e];s+=ee(n,r,u,t),r+=u}return Math.abs(s)},e.getQuantizedBoundsOptimizedGeometry=function(e,t,n,o){const r=f(n,o),{lengths:s,coords:u}=t;let c=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,a=Number.NEGATIVE_INFINITY,h=0;for(const e of s){let t=u[h],n=u[h+1];c=Math.min(t,c),l=Math.min(n,l),i=Math.max(t,i),a=Math.max(n,a),h+=r;for(let o=1;o<e;o++,h+=r){const e=u[h],o=u[h+1];t+=e,n+=o,e<0&&(c=Math.min(c,t)),e>0&&(i=Math.max(i,t)),o<0?l=Math.min(l,n):o>0&&(a=Math.max(a,n))}}return e[0]=c,e[1]=l,e[2]=i,e[3]=a,e},e.getSignedQuantizedRingArea=ee,e.quantizeForDisplay=function(e,t,n,o,r){const s=f(o,r);if(!e.lengths.length){if(e.coords.length<2)return null;const[n,o]=e.coords,r=G(t,n),s=T(t,o);return new i([],[r,s])}const u=new i([],[0,0]),c=m[n],l="esriGeometryPolygon"===n||"esriGeometryPolyline"===n;let a=0,h=0;for(let n=0;n<e.lengths.length;n++){const o=e.lengths[n],r=h;let i=G(t,e.coords[s*a]),f=T(t,e.coords[s*a+1]);u.coords[h++]=i,u.coords[h++]=f;let m=0,d=0,g=1;for(let n=1;n<o;n++){const o=G(t,e.coords[s*(n+a)]),r=T(t,e.coords[s*(n+a)+1]);if(o!==i||r!==f){const e=o-i,t=r-f;l&&te(m,d,e,t)?(u.coords[h-2]+=e,u.coords[h-1]+=t,i+=e,f+=t):(u.coords[h++]=o,u.coords[h++]=r,i=o,f=r,m=e,d=t,g+=1)}}g<c?h=r:u.lengths.push(g),a+=o}return 0===u.lengths.length?null:u},e.quantizeOptimizedFeatureSet=function(e,t){const{geometryType:n,features:o,hasM:r,hasZ:s}=t;if(!e)return t;for(let t=0;t<o.length;t++){const u=o[t],c=u.weakClone();c.geometry=new i,H(c.geometry,u.geometry,r,s,n,e),u.centroid&&(c.centroid=new i,H(c.centroid,u.centroid,r,s,"esriGeometryPoint",e)),o[t]=c}return t.transform=e,t},e.quantizeOptimizedGeometry=H,e.quantizeX=M,e.quantizeY=I,e.removeCollinearVertices=function(e,t,n,o,r){if(!t?.coords?.length)return null;const s=m[n],{coords:u,lengths:c}=t,l=F(o,r,o,r),i=f(o,r);let a=0,h=0,d=0,g=0;for(const t of c){h=g,l(e.coords,u,h,a,u[a],u[a+1]),a+=i;let n=u[a],o=u[a+1],r=n,c=o,f=o/n;h+=i,l(e.coords,u,h,a,r,c),a+=i;for(let s=2;s<t;s++){n=u[a],o=u[a+1];const t=o/n,s=f===t||!isFinite(f)&&!isFinite(t),m=s&&isFinite(t)?f>=0&&t>=0||f<=0&&t<=0:c>=0&&o>=0||c<=0&&o<=0;s&&m?(r+=n,c+=o):(r=n,c=o,h+=i),l(e.coords,u,h,a,r,c),a+=i,f=t}h+=i;const m=(h-g)/i;m>=s&&(e.lengths[d]=m,g=h,d++)}return e.coords.length>g&&(e.coords.length=g),e.lengths.length>d&&(e.lengths.length=d),e.coords.length&&e.lengths.length?e:null},e.removeZMValues=function(e,t,n,o,r,s){if(ne(e),e.lengths.push(...t.lengths),n===r&&o===s)for(let n=0;n<t.coords.length;n++)e.coords.push(t.coords[n]);else{const u=f(n,o),c=F(n,o,r,s),l=t.coords;for(let t=0;t<l.length;t+=u)c(e.coords,l,e.coords.length,t,l[t],l[t+1])}return e},e.unquantizeOptimizedFeatureSet=function(e){const{transform:t,features:n,hasM:o,hasZ:r}=e;if(!t)return e;for(const e of n)null!=e.geometry&&W(e.geometry,e.geometry,o,r,t),null!=e.centroid&&W(e.centroid,e.centroid,o,r,t);return e.transform=null,e},e.unquantizeOptimizedGeometry=W,e.unquantizeValue=z,e.unquantizeX=function(e,t){return z(e,t,0)},e.unquantizeY=function(e,t){return z(e,-t,1)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});