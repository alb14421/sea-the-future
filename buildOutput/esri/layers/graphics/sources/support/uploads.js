// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../request","../../../../core/promiseUtils","../../../../core/urlUtils","../../../support/arcgisLayerUrl","../../../../support/progressUtils"],function(e,o,t,r,s,a){"use strict";const n=2e7;e.uploadItem=async function({data:e,name:i,description:l},p,c){let d=null;try{const f=r.join(p,"uploads"),u=r.join(f,"info"),{data:h}=await o(u,{query:{f:"json"},responseType:"json"});t.throwIfAborted(c);const w=s.isHostedAgolService(p),y=1e6*h.maxUploadFileSize,j=w?2e9:y,g=w?Math.min(n,y):n;if(e.size>j)throw new Error("Data too large");const A=r.join(f,"register"),{data:I}=await o(A,{query:{f:"json",itemName:(m=i,m.replaceAll("/","_").replaceAll("\\","_")),description:l},responseType:"json",method:"post"});if(t.throwIfAborted(c),!I.success)throw new Error("Registration failed");const{itemID:T}=I.item;d=r.join(f,T);const b=r.join(d,"uploadPart"),P=Math.ceil(e.size/g),q=new Array;for(let o=0;o<P;++o)q.push(e.slice(o*g,Math.min((o+1)*g,e.size)));const v=q.slice().reverse(),z=new Array,M=a.makeProgressManager(P,c?.onProgress,"uploadItem"),U=async()=>{for(;0!==v.length;){const e=q.length-v.length,r=v.pop(),s=new FormData,n=M.simulate(e,a.estimatedTransferTime(r.size));try{s.append("f","json"),s.append("file",r),s.append("partId",`${e}`);const{data:a}=await o(b,{timeout:0,body:s,responseType:"json",method:"post"});if(t.throwIfAborted(c),!a.success)throw new Error("Part upload failed")}finally{n.remove()}}};for(let e=0;e<3&&0!==v.length;++e)z.push(U());await Promise.all(z);const E=r.join(d,"commit"),{data:S}=await o(E,{query:{f:"json",parts:q.map((e,o)=>o).join(",")},responseType:"json",method:"post"});if(t.throwIfAborted(c),!S.success)throw new Error("Commit failed");return S.item}catch(e){if(null!=d){const e=r.join(d,"delete");await o(e,{query:{f:"json"},responseType:"json",method:"post"})}throw e}var m},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});