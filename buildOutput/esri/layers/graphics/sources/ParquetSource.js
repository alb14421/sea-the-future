// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/Error","../../../core/Loadable","../../../core/Logger","../../../core/workers/workers","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../../support/FieldsIndex","../../support/parquetUtils","../../../rest/support/FeatureSet"],function(e,t,r,o,s,a,i,u,n,p,c,l){"use strict";e.ParquetSource=class extends o.Loadable{constructor(e){super(e),this.type="parquet",this.urls=null,this.fields=null,this.objectIdField=null,this.spatialReference=null}load(e){const t=null!=e?e.signal:null;return this.addResolvingPromise(this._initialize(t)),Promise.resolve(this)}destroy(){this._connection.destroy()}setCustomParameters(e){this.customParameters=e,this._proxy.setCustomParameters(this.customParameters).catch(()=>{s.getLogger(this).warn("Failed to update customParameters")})}async queryFeaturesJSON(e,t={}){return await this.load(t),this._proxy.queryFeatures(e.toJSON(),t)}async queryFeatures(e,t={}){const r=await this.queryFeaturesJSON(e,t);return l.fromJSON(r)}async queryObjectIds(e,t){return await this._proxy.queryObjectIds(e.toJSON(),t)}async queryFeatureCount(e,t){return this._proxy.queryFeatureCount(e.toJSON(),t)}async queryExtent(e,t){if(null==this.encoding)return s.getLogger(this).warn("Tried to queryExtent, but source does not have a geometry. Returning null extent."),{count:0,extent:null};const r=await this._proxy.queryExtent(e.toJSON(),t);return{count:r.count,extent:n.fromJSON(r.extent)}}async _initialize(e){let t;if(this._connection=await a.open("ParquetSourceWorker",{strategy:"dedicated"}),this._proxy=this._connection.createInvokeProxy(),this.geometryType&&this.encoding){if(!this.spatialReference)throw new r("parquet:unsupported","SpatialReference must be defined");t={geometryType:c.toParquetJSONGeometryType(this.geometryType),spatialReference:this.spatialReference.toJSON(),encoding:this.encoding.toJSON(),displayOptimization:this.displayOptimization}}const o=new p(this.fields).toJSON(),{extent:s}=await this._proxy.load({urls:this.urls,metadata:{fieldsIndex:o,geometryType:t?.geometryType??"esriGeometryPoint",featureIdInfo:{type:"object-id",fieldName:"rowId"},subtypes:null,subtypeField:null,types:null,typeIdField:null,globalIdField:null,spatialReference:t?.spatialReference,outSpatialReference:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null},geometryInfo:t,customParameters:this.customParameters});this.fullExtent=s?n.fromJSON(s):null}},t.__decorate([i.property()],e.ParquetSource.prototype,"type",void 0),t.__decorate([i.property()],e.ParquetSource.prototype,"urls",void 0),t.__decorate([i.property()],e.ParquetSource.prototype,"fields",void 0),t.__decorate([i.property()],e.ParquetSource.prototype,"encoding",void 0),t.__decorate([i.property()],e.ParquetSource.prototype,"geometryType",void 0),t.__decorate([i.property()],e.ParquetSource.prototype,"objectIdField",void 0),t.__decorate([i.property()],e.ParquetSource.prototype,"spatialReference",void 0),t.__decorate([i.property()],e.ParquetSource.prototype,"file",void 0),t.__decorate([i.property()],e.ParquetSource.prototype,"customParameters",void 0),t.__decorate([i.property()],e.ParquetSource.prototype,"displayOptimization",void 0),t.__decorate([i.property()],e.ParquetSource.prototype,"fullExtent",void 0),e.ParquetSource=t.__decorate([u.subclass("esri.layers.graphics.sources.ParquetSource")],e.ParquetSource),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});