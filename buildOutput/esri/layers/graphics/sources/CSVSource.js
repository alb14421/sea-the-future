// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/has","../../../core/Loadable","../../../core/promiseUtils","../../../core/workers/workers","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../../../rest/support/FeatureSet"],function(e,t,o,r,n,i,s,a,c,u,l,d){"use strict";e.CSVSource=class extends r.Loadable{constructor(e){super(e),this.type="csv",this.refresh=n.debounce(async e=>{await this.load();const{extent:t,timeExtent:o}=await this._connection.invoke("refresh",e);return t&&(this.sourceJSON.extent=t),o&&(this.sourceJSON.timeInfo.timeExtent=[o.start,o.end]),{dataChanged:!0,updates:{extent:this.sourceJSON.extent,timeInfo:this.sourceJSON.timeInfo}}})}load(e){const t=null!=e?e.signal:null;return this.addResolvingPromise(this._startWorker(t)),Promise.resolve(this)}destroy(){this._connection?.close(),this._connection=null}async openPorts(){return await this.load(),this._connection.openPorts()}async queryFeatures(e,t={}){await this.load(t);const o=await this._connection.invoke("queryFeatures",e?e.toJSON():null,t);return d.fromJSON(o)}async queryFeaturesJSON(e,t={}){return await this.load(t),this._connection.invoke("queryFeatures",e?e.toJSON():null,t)}async queryFeatureCount(e,t={}){return await this.load(t),this._connection.invoke("queryFeatureCount",e?e.toJSON():null,t)}async queryObjectIds(e,t={}){return await this.load(t),this._connection.invoke("queryObjectIds",e?e.toJSON():null,t)}async queryExtent(e,t={}){await this.load(t);const o=await this._connection.invoke("queryExtent",e?e.toJSON():null,t);return{count:o.count,extent:l.fromJSON(o.extent)}}async querySnapping(e,t={}){return await this.load(t),this._connection.invoke("querySnapping",e,t)}async queryAttributeBins(e,t={}){return await this.load(),this._connection.invoke("queryAttributeBins",e?e.toJSON():null,t)}async _startWorker(e){this._connection=await i.open("CSVSourceWorker",{strategy:o("feature-layers-workers")?"dedicated":"local",signal:e,registryTarget:this});const{url:t,delimiter:r,fields:n,latitudeField:s,longitudeField:a,spatialReference:c,timeInfo:u}=this.loadOptions,l=await this._connection.invoke("load",{url:t,customParameters:this.customParameters,parsingOptions:{delimiter:r,fields:n?.map(e=>e.toJSON()),latitudeField:s,longitudeField:a,spatialReference:c?.toJSON(),timeInfo:u?.toJSON()}},{signal:e});this.locationInfo=l.locationInfo,this.sourceJSON=l.layerDefinition,this.delimiter=l.delimiter}},t.__decorate([s.property()],e.CSVSource.prototype,"type",void 0),t.__decorate([s.property()],e.CSVSource.prototype,"loadOptions",void 0),t.__decorate([s.property()],e.CSVSource.prototype,"customParameters",void 0),t.__decorate([s.property()],e.CSVSource.prototype,"locationInfo",void 0),t.__decorate([s.property()],e.CSVSource.prototype,"sourceJSON",void 0),t.__decorate([s.property()],e.CSVSource.prototype,"delimiter",void 0),e.CSVSource=t.__decorate([u.subclass("esri.layers.graphics.sources.CSVSource")],e.CSVSource),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});