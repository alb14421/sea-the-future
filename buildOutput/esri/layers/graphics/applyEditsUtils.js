// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../Graphic","../../core/Error","../../core/Logger","../../core/unitUtils","../../core/urlUtils","../../geometry/projectionUtils","../../geometry/support/jsonUtils","../../geometry/support/MeshTransform","../../geometry/support/spatialReferenceUtils","./editingSupport"],function(e,t,a,r,s,n,o,l,i,u,d){"use strict";async function c(e,t){const{feature:a,attachment:r}=t,{globalId:s,name:o,contentType:l,data:i,uploadId:u}=r,d={globalId:s};if(a&&("attributes"in a?d.parentGlobalId=a.attributes?.[e.globalIdField]:a.globalId&&(d.parentGlobalId=a.globalId)),u)d.uploadId=u;else if(i){const e=await n.parseData(i);e&&(d.contentType=e.mediaType,d.data=e.data),i instanceof File&&(d.name=i.name)}return o&&(d.name=o),l&&(d.contentType=l),d}function p(e){const t=!0===e.success?null:e.error||{code:void 0,description:"Feature edit failed"};return{objectId:e.objectId,globalId:e.globalId,error:t?new a("feature-layer-source:edit-failure",t.description,{code:t.code}):null}}function g(e,a){return new t({attributes:e.attributes,geometry:l.fromJSON({...e.geometry,spatialReference:a})})}e.createEditedFeatures=function(e,t){return{adds:e?.adds?.map(e=>g(e,t))||[],updates:e?.updates?.map(e=>({original:g(e[0],t),current:g(e[1],t)}))||[],deletes:e?.deletes?.map(e=>g(e,t))||[],spatialReference:t}},e.createFeatureEditResult=p,e.getAttachmentEditsJSON=async function(e,t){const a=await Promise.all((t.addAttachments??[]).map(t=>c(e,t))),r=await Promise.all((t.updateAttachments??[]).map(t=>c(e,t))),s=t.deleteAttachments??[];return a.length||r.length||s.length?{adds:a,updates:r,deletes:[...s]}:null},e.getFeatureIds=function(e,t,a){if(!t||0===t.length)return[];if(a&&d.isFeatureIdentifierArrayWithGlobalId(t))return t.map(e=>e.globalId);if(d.isFeatureIdentifierArrayWithObjectId(t))return t.map(e=>e.objectId);const r=a?e.globalIdField:e.objectIdField;return r?t.map(e=>e.getAttribute(r)):[]},e.getFeatureJSON=async function(e,t,a){const{geometry:r}=t,n={...t.attributes};if(null!=a&&"mesh"===r?.type){const{transformFieldRoles:t}=a,{origin:l,spatialReference:d,vertexSpace:c}=r,p=r.transform??new i,g="local"===c.type,m=e.spatialReference,f=m.isGeographic,b=u.equals(m,d),y=o.isEqualBaseGCS(d,m)&&o.canProjectWithoutEngine(d,m);if(!(g&&f&&y||!g&&!f&&b))return null;const R=o.projectWithoutEngine(l,d,m);if(null==R)return null;if(n[t.originX]=R.x,n[t.originY]=R.y,n[t.originZ]=R.z??0,null!=p){const{translation:e,scale:a,rotation:r}=p,o=g?1:s.getMetersPerCartesianUnitForSR(d)/s.getMetersPerCartesianUnitForSR(m);n[t.translationX]=e[0]*o,n[t.translationY]=e[2]*o,n[t.translationZ]=-e[1]*o,n[t.scaleX]=a[0],n[t.scaleY]=a[2],n[t.scaleZ]=a[1],n[t.rotationX]=r[0],n[t.rotationY]=r[2],n[t.rotationZ]=-r[1],n[t.rotationDeg]=r[3]}return{attributes:n}}return null==r?{attributes:n}:"mesh"===r.type||"extent"===r.type?null:{geometry:r.toJSON(),attributes:n}},e.isProtectedOrPrivateVersionError=function(e){const t=e.details.raw,a=+t.code,r=+t.extendedCode;return 500===a&&(-2147217144===r||-2147467261===r)},e.unpackEditResultData=function(e){const t=e?.assetMaps;if(t){for(const e of t.addResults)e.success||r.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${e.globalId}.`);for(const e of t.updateResults)e.success||r.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${e.globalId}.`)}const a=e?.attachments,s={addFeatureResults:e?.addResults?.map(p)??[],updateFeatureResults:e?.updateResults?.map(p)??[],deleteFeatureResults:e?.deleteResults?.map(p)??[],addAttachmentResults:a?.addResults?a.addResults.map(p):[],updateAttachmentResults:a?.updateResults?a.updateResults.map(p):[],deleteAttachmentResults:a?.deleteResults?a.deleteResults.map(p):[]};return e?.editMoment&&(s.editMoment=e.editMoment),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});