// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../colorUtils","../../core/Error","./effects","./utils"],function(e,t,n,r,a){"use strict";class u extends SyntaxError{constructor(e,t,n,r){super(e),this.expected=t,this.found=n,this.location=r,this.name="SyntaxError"}format(e){let t="Error: "+this.message;if(this.location){let n=null;const r=e.find(e=>e.source===this.location.source);r&&(n=r.text.split(/\r\n|\n|\r/g));const a=this.location.start,u=this.location.source&&"function"==typeof this.location.source.offset?this.location.source.offset(a):a,o=this.location.source+":"+u.line+":"+u.column;if(n){const e=this.location.end,r="".padEnd(u.line.toString().length," "),c=n[a.line-1],l=(a.line===e.line?e.column:c.length+1)-a.column||1;t+="\n --\x3e "+o+"\n"+r+" |\n"+u.line+" | "+c+"\n"+r+" | "+"".padEnd(a.column-1," ")+"".padEnd(l,"^")}else t+="\n at "+o}return t}static buildMessage(e,t){function n(e){return e.codePointAt(0).toString(16).toUpperCase()}const r=Object.prototype.hasOwnProperty.call(RegExp.prototype,"unicode")?new RegExp("[\\p{C}\\p{Mn}\\p{Mc}]","gu"):null;function a(e){return r?e.replace(r,e=>"\\u{"+n(e)+"}"):e}function u(e){return a(e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,e=>"\\x0"+n(e)).replace(/[\x10-\x1F\x7F-\x9F]/g,e=>"\\x"+n(e)))}function o(e){return a(e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,e=>"\\x0"+n(e)).replace(/[\x10-\x1F\x7F-\x9F]/g,e=>"\\x"+n(e)))}const c={literal:e=>'"'+u(e.text)+'"',class(e){const t=e.parts.map(e=>Array.isArray(e)?o(e[0])+"-"+o(e[1]):o(e));return"["+(e.inverted?"^":"")+t.join("")+"]"+(e.unicode?"u":"")},any:()=>"any character",end:()=>"end of input",other:e=>e.description};function l(e){return c[e.type](e)}return"Expected "+function(e){const t=e.map(l);if(t.sort(),t.length>0){let e=1;for(let n=1;n<t.length;n++)t[n-1]!==t[n]&&(t[e]=t[n],e++);t.length=e}switch(t.length){case 1:return t[0];case 2:return t[0]+" or "+t[1];default:return t.slice(0,-1).join(", ")+", or "+t[t.length-1]}}(e)+" but "+function(e){return e?'"'+u(e)+'"':"end of input"}(t)+" found."}}function o(e){let t;if(!e)return[];try{t=function(e,t){const n={},r=(t=void 0!==t?t:{}).grammarSource,a={start:Ae};let o=Ae;const c="none",l=")",i=",",s="(",f="%",p="px",h="cm",g="mm",m="in",d="pt",y="pc",w="deg",v="rad",x="grad",A="turn",b="#",E=".",$="e",C=/^[ \t\n\r]/,F=/^[a-z\-]/,P=/^[0-9a-fA-F]/,R=/^[+\-]/,S=/^[0-9]/,M=ye("none"),j=me("none",!1),O=me(")",!1),q=me(",",!1),z=de([" ","\t","\n","\r"],!1,!1,!1),I=ye("function"),T=me("(",!1),N=ye("identifier"),k=de([["a","z"],"-"],!1,!1,!1),B=ye("percentage"),D=me("%",!1),U=ye("length"),H=me("px",!1),L=me("cm",!1),G=me("mm",!1),J=me("in",!1),K=me("pt",!1),Q=me("pc",!1),V=ye("angle"),W=me("deg",!1),X=me("rad",!1),Y=me("grad",!1),Z=me("turn",!1),_=ye("number"),ee=ye("color"),te=me("#",!1),ne=de([["0","9"],["a","f"],["A","F"]],!1,!1,!1),re=de(["+","-"],!1,!1,!1),ae=de([["0","9"]],!1,!1,!1),ue=me(".",!1),oe=me("e",!1);let ce=0|t.peg$currPos,le=ce;const ie=[{line:1,column:1}];let se,fe=ce,pe=t.peg$maxFailExpected||[],he=0|t.peg$silentFails;if(t.startRule){if(!(t.startRule in a))throw new Error("Can't start parsing from rule \""+t.startRule+'".');o=a[t.startRule]}function ge(){return e.substring(le,ce)}function me(e,t){return{type:"literal",text:e,ignoreCase:t}}function de(e,t,n,r){return{type:"class",parts:e,inverted:t,ignoreCase:n,unicode:r}}function ye(e){return{type:"other",description:e}}function we(t){let n,r=ie[t];if(r)return r;if(t>=ie.length)n=ie.length-1;else for(n=t;!ie[--n];);for(r=ie[n],r={line:r.line,column:r.column};n<t;)10===e.charCodeAt(n)?(r.line++,r.column=1):r.column++,n++;return ie[t]=r,r}function ve(e,t,n){const a=we(e),u=we(t);return{source:r,start:{offset:e,line:a.line,column:a.column},end:{offset:t,line:u.line,column:u.column}}}function xe(e){ce<fe||(ce>fe&&(fe=ce,pe=[]),pe.push(e))}function Ae(){let t;return t=function(){let t,r;return he++,t=ce,$e(),e.substr(ce,4)===c?(r=c,ce+=4):(r=n,0===he&&xe(j)),r!==n?($e(),le=t,t=[]):(ce=t,t=n),he--,t===n&&0===he&&xe(M),t}(),t===n&&(t=function(){let e,t;if(e=[],t=be(),t!==n)for(;t!==n;)e.push(t),t=be();else e=n;return e}()),t}function be(){let t,r,a,u;return t=ce,$e(),r=function(){let t,r,a;return he++,t=ce,r=Ce(),r!==n?(40===e.charCodeAt(ce)?(a=s,ce++):(a=n,0===he&&xe(T)),a!==n?(le=t,t=r):(ce=t,t=n)):(ce=t,t=n),he--,t===n&&(r=n,0===he&&xe(I)),t}(),r!==n?($e(),a=function(){let t,r,a,u,o,c,l,s;if(t=ce,r=Ee(),r!==n){for(a=[],u=ce,o=$e(),44===e.charCodeAt(ce)?(c=i,ce++):(c=n,0===he&&xe(q)),c===n&&(c=null),l=$e(),s=Ee(),s!==n?(o=[o,c,l,s],u=o):(ce=u,u=n);u!==n;)a.push(u),u=ce,o=$e(),44===e.charCodeAt(ce)?(c=i,ce++):(c=n,0===he&&xe(q)),c===n&&(c=null),l=$e(),s=Ee(),s!==n?(o=[o,c,l,s],u=o):(ce=u,u=n);le=t,f=r,t=(p=a).length>0?function(e,t){return[e].concat(t.map(function(e){return e[3]}))}(f,p):[f]}else ce=t,t=n;var f,p;return t}(),a===n&&(a=null),$e(),41===e.charCodeAt(ce)?(u=l,ce++):(u=n,0===he&&xe(O)),u!==n?($e(),le=t,t={type:"function",name:r,parameters:a||[]}):(ce=t,t=n)):(ce=t,t=n),t}function Ee(){let t,r;var a,u;return t=ce,r=function(){let t,r,a;return he++,t=ce,$e(),r=Fe(),r!==n?(37===e.charCodeAt(ce)?(a=f,ce++):(a=n,0===he&&xe(D)),a!==n?(le=t,t={value:r,unit:"%"}):(ce=t,t=n)):(ce=t,t=n),he--,t===n&&0===he&&xe(B),t}(),r===n&&(r=function(){let t,r,a;return he++,t=ce,$e(),r=Fe(),r!==n?(e.substr(ce,2)===p?(a=p,ce+=2):(a=n,0===he&&xe(H)),a!==n?(le=t,t={value:r,unit:"px"}):(ce=t,t=n)):(ce=t,t=n),t===n&&(t=ce,$e(),r=Fe(),r!==n?(e.substr(ce,2)===h?(a=h,ce+=2):(a=n,0===he&&xe(L)),a!==n?(le=t,t={value:r,unit:"cm"}):(ce=t,t=n)):(ce=t,t=n),t===n&&(t=ce,$e(),r=Fe(),r!==n?(e.substr(ce,2)===g?(a=g,ce+=2):(a=n,0===he&&xe(G)),a!==n?(le=t,t=function(e){return{value:e,unit:"mm"}}(r)):(ce=t,t=n)):(ce=t,t=n),t===n&&(t=ce,$e(),r=Fe(),r!==n?(e.substr(ce,2)===m?(a=m,ce+=2):(a=n,0===he&&xe(J)),a!==n?(le=t,t=function(e){return{value:e,unit:"in"}}(r)):(ce=t,t=n)):(ce=t,t=n),t===n&&(t=ce,$e(),r=Fe(),r!==n?(e.substr(ce,2)===d?(a=d,ce+=2):(a=n,0===he&&xe(K)),a!==n?(le=t,t=function(e){return{value:e,unit:"pt"}}(r)):(ce=t,t=n)):(ce=t,t=n),t===n&&(t=ce,$e(),r=Fe(),r!==n?(e.substr(ce,2)===y?(a=y,ce+=2):(a=n,0===he&&xe(Q)),a!==n?(le=t,t=function(e){return{value:e,unit:"pc"}}(r)):(ce=t,t=n)):(ce=t,t=n)))))),he--,t===n&&0===he&&xe(U),t}(),r===n&&(r=function(){let t,r,a;return he++,t=ce,r=Fe(),r!==n?(e.substr(ce,3)===w?(a=w,ce+=3):(a=n,0===he&&xe(W)),a!==n?(le=t,t={value:r,unit:"deg"}):(ce=t,t=n)):(ce=t,t=n),t===n&&(t=ce,r=Fe(),r!==n?(e.substr(ce,3)===v?(a=v,ce+=3):(a=n,0===he&&xe(X)),a!==n?(le=t,t={value:r,unit:"rad"}):(ce=t,t=n)):(ce=t,t=n),t===n&&(t=ce,r=Fe(),r!==n?(e.substr(ce,4)===x?(a=x,ce+=4):(a=n,0===he&&xe(Y)),a!==n?(le=t,t=function(e){return{value:e,unit:"grad"}}(r)):(ce=t,t=n)):(ce=t,t=n),t===n&&(t=ce,r=Fe(),r!==n?(e.substr(ce,4)===A?(a=A,ce+=4):(a=n,0===he&&xe(Z)),a!==n?(le=t,t=function(e){return{value:e,unit:"turn"}}(r)):(ce=t,t=n)):(ce=t,t=n)))),he--,t===n&&(r=n,0===he&&xe(V)),t}(),r===n&&(r=function(){let e,t;return he++,e=ce,$e(),t=Fe(),t!==n?(le=e,e={value:t,unit:null}):(ce=e,e=n),he--,e===n&&0===he&&xe(_),e}()))),r!==n&&(le=t,r={type:"quantity",value:(a=r).value,unit:a.unit}),t=r,t===n&&(t=ce,r=function(){let t,r,a,u;if(he++,t=ce,35===e.charCodeAt(ce)?(r=b,ce++):(r=n,0===he&&xe(te)),r!==n){if(a=[],u=e.charAt(ce),P.test(u)?ce++:(u=n,0===he&&xe(ne)),u!==n)for(;u!==n;)a.push(u),u=e.charAt(ce),P.test(u)?ce++:(u=n,0===he&&xe(ne));else a=n;a!==n?(le=t,t={type:"hex",value:ge()}):(ce=t,t=n)}else ce=t,t=n;return t===n&&(t=ce,r=be(),r!==n&&(le=t,r={type:"function",value:r}),t=r,t===n&&(t=ce,r=Ce(),r!==n&&(le=t,r={type:"named",value:ge()}),t=r)),he--,t===n&&(r=n,0===he&&xe(ee)),t}(),r!==n&&(le=t,r={type:"color",colorType:(u=r).type,value:u.value}),t=r),t}function $e(){let t,r;for(he++,t=[],r=e.charAt(ce),C.test(r)?ce++:(r=n,0===he&&xe(z));r!==n;)t.push(r),r=e.charAt(ce),C.test(r)?ce++:(r=n,0===he&&xe(z));return he--,t}function Ce(){let t,r,a;if(he++,t=ce,r=[],a=e.charAt(ce),F.test(a)?ce++:(a=n,0===he&&xe(k)),a!==n)for(;a!==n;)r.push(a),a=e.charAt(ce),F.test(a)?ce++:(a=n,0===he&&xe(k));else r=n;return r!==n&&(le=t,r=ge()),t=r,he--,t===n&&(r=n,0===he&&xe(N)),t}function Fe(){let t,r,a,u,o,c,l,i;for(t=ce,r=e.charAt(ce),R.test(r)?ce++:(r=n,0===he&&xe(re)),r===n&&(r=null),a=ce,u=[],o=e.charAt(ce),S.test(o)?ce++:(o=n,0===he&&xe(ae));o!==n;)u.push(o),o=e.charAt(ce),S.test(o)?ce++:(o=n,0===he&&xe(ae));if(46===e.charCodeAt(ce)?(o=E,ce++):(o=n,0===he&&xe(ue)),o!==n){if(c=[],l=e.charAt(ce),S.test(l)?ce++:(l=n,0===he&&xe(ae)),l!==n)for(;l!==n;)c.push(l),l=e.charAt(ce),S.test(l)?ce++:(l=n,0===he&&xe(ae));else c=n;c!==n?(u=[u,o,c],a=u):(ce=a,a=n)}else ce=a,a=n;if(a===n)if(a=[],u=e.charAt(ce),S.test(u)?ce++:(u=n,0===he&&xe(ae)),u!==n)for(;u!==n;)a.push(u),u=e.charAt(ce),S.test(u)?ce++:(u=n,0===he&&xe(ae));else a=n;if(a!==n){if(u=ce,101===e.charCodeAt(ce)?(o=$,ce++):(o=n,0===he&&xe(oe)),o!==n){if(c=e.charAt(ce),R.test(c)?ce++:(c=n,0===he&&xe(re)),c===n&&(c=null),l=[],i=e.charAt(ce),S.test(i)?ce++:(i=n,0===he&&xe(ae)),i!==n)for(;i!==n;)l.push(i),i=e.charAt(ce),S.test(i)?ce++:(i=n,0===he&&xe(ae));else l=n;l!==n?(o=[o,c,l],u=o):(ce=u,u=n)}else ce=u,u=n;u===n&&(u=null),le=t,t=parseFloat(ge())}else ce=t,t=n;return t}se=o();const Pe=se!==n&&ce===e.length;function Re(){throw se!==n&&ce<e.length&&xe({type:"end"}),t=pe,r=fe<e.length?function(t=ce){const n=e.codePointAt(t);return void 0===n?"":String.fromCodePoint(n)}(fe):null,a=fe<e.length?ve(fe,fe+1):ve(fe,fe),new u(u.buildMessage(t,r),t,r,a);var t,r,a}return t.peg$library?{peg$result:se,peg$currPos:ce,peg$FAILED:n,peg$maxFailExpected:pe,peg$maxFailPos:fe,peg$success:Pe,peg$throw:Pe?void 0:Re}:Pe?se:void Re()}(e)}catch(t){throw new n("effect:invalid-syntax","Invalid effect syntax",{value:e,error:t})}return t.map(e=>function(e){try{switch(e.name){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":return function(e){let t=1;return c(e.parameters,1),1===e.parameters.length&&(t=p(e.parameters[0])),new r.ColorMatrixEffect(e.name,t)}(e);case"opacity":return function(e){let t=1;return c(e.parameters,1),1===e.parameters.length&&(t=p(e.parameters[0])),new r.OpacityEffect(t)}(e);case"hue-rotate":return function(e){let t=0;var a;return c(e.parameters,1),1===e.parameters.length&&(function(e){if("quantity"!==e.type||!(0===e.value&&null===e.unit||e.unit&&null!=s[e.unit]))throw new n("effect:type-error",`Expected <angle>, Actual: ${l(e)}`,{term:e})}(a=e.parameters[0]),t=a.value*s[a.unit]||0),new r.HueRotateEffect(t)}(e);case"blur":return function(e){let t=0;return c(e.parameters,1),1===e.parameters.length&&(t=h(e.parameters[0]),i(t,e.parameters[0])),new r.BlurEffect(t)}(e);case"drop-shadow":return function(e){const t=[];let a=null;for(const r of e.parameters)if("color"===r.type){if(t.length&&Object.freeze(t),a)throw new n("effect:type-error","Accepts only one color",{});a=g(r)}else{const e=h(r);if(Object.isFrozen(t))throw new n("effect:type-error","<length> parameters not consecutive",{lengths:t});t.push(e),3===t.length&&i(e,r)}if(t.length<2||t.length>3)throw new n("effect:type-error",`Expected <length>{2,3}, Actual: <length>{${t.length}}`,{lengths:t});return new r.DropShadowEffect(t[0],t[1],t[2]||0,a||m("black"))}(e);case"bloom":return function(e){let t=1,n=0,a=0;return c(e.parameters,3),e.parameters[0]&&(t=p(e.parameters[0])),e.parameters[1]&&(n=h(e.parameters[1]),i(n,e.parameters[1])),e.parameters[2]&&(a=p(e.parameters[2])),new r.BloomEffect(t,n,a)}(e)}}catch(t){throw t.details.filter=e,t}throw new n("effect:unknown-effect",`Effect '${e.name}' is not supported`,{effect:e})}(e))}function c(e,t){if(e.length>t)throw new n("effect:type-error",`Function supports up to ${t} parameters, Actual: ${e.length}`,{parameters:e})}function l(e){if("color"===e.type)return"<color>";if(e.unit){if(e.unit in f)return"<length>";if(e.unit in s)return"<angle>";if("%"===e.unit)return"<percentage>"}return"<double>"}function i(e,t){if(e<0)throw new n("effect:type-error",`Negative values are not allowed, Actual: ${e}`,{term:t})}const s={deg:1,grad:.9,rad:180/Math.PI,turn:360},f={px:1,cm:96/2.54,mm:96/2.54/10,in:96,pc:16,pt:96/72};function p(e){!function(e){if("quantity"!==e.type||null!==e.unit&&"%"!==e.unit)throw new n("effect:type-error",`Expected <double> or <percentage>, Actual: ${l(e)}`,{term:e})}(e);const t=e.value;return i(t,e),"%"===e.unit?.01*t:t}function h(e){return function(e){if("quantity"!==e.type||!(0===e.value&&null===e.unit||e.unit&&null!=f[e.unit]))throw new n("effect:type-error",`Expected <length>, Actual: ${l(e)}`,{term:e})}(e),e.value*f[e.unit]||0}function g(e){switch(e.colorType){case"hex":return t.hexToRgba(e.value);case"named":return m(e.value);case"function":return function(e){if(c(e.parameters,4),d.test(e.name))return[p(e.parameters[0]),p(e.parameters[1]),p(e.parameters[2]),e.parameters[3]?p(e.parameters[3]):1];if(y.test(e.name))return t.hslaToRgba(function(e){return function(e){if("quantity"!==e.type||null!==e.unit)throw new n("effect:type-error",`Expected <double>, Actual: ${l(e)}`,{term:e})}(e),i(e.value,e),e.value}(e.parameters[0]),p(e.parameters[1]),p(e.parameters[2]),e.parameters[3]?p(e.parameters[3]):1);throw new n("effect:syntax-error",`Invalid color function '${e.name}'`,{colorFunction:e})}(e.value)}}function m(e){if(!t.isNamedColor(e))throw new n("effect:unknown-color",`color '${e}' isn't valid`,{namedColor:e});return t.getNamedColorCopy(e)}const d=/^rgba?/i,y=/^hsla?/i;e.parse=function(e){if(!e||0===e.length)return null;if("string"==typeof e){const t=o(e);return t&&0!==t.length?t:null}const t=e.map(e=>{if(!Number.isFinite(e.scale)||e.scale<=0)throw new n("effect:invalid-scale","scale must be finite and greater than 0",{stop:e});return{scale:e.scale,effects:o(e.value)}});t.sort((e,t)=>t.effects.length-e.effects.length);for(let e=0;e<t.length-1;e++){if(!a.canInterpolateEffects(t[e].effects,t[e+1].effects))throw new n("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:t[e].effects,b:t[e+1].effects});a.normalizeEffects(t[e].effects,t[e+1].effects)}return t.sort((e,t)=>t.scale-e.scale),t},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});