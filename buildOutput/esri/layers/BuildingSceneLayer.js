// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../chunks/tslib.es6","../core/Collection","../core/CollectionFlattener","../core/Error","../core/handleUtils","../core/lang","../core/loadAll","../core/Logger","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/urlUtils","../core/accessorSupport/decorators/property","../core/has","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../geometry/SpatialReference","./Layer","./buildingSublayers/BuildingComponentSublayer","./buildingSublayers/BuildingGroupSublayer","./buildingSublayers/utils","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/CustomParametersMixin","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/SceneService","./support/associatedFeatureServiceUtils","./support/BuildingFilter","./support/BuildingSummaryStatistics","./support/commonProperties","../support/elevationInfoUtils"],function(e,r,t,i,o,s,a,l,n,u,p,y,c,d,h,g,b,S,v,m,f,_,w,I,L,O,E,P,T,x,A,B,F){"use strict";const M=r.ofType(x),j=s.clone(m.sublayersProperty),K=j.json?.origins;K&&(K["web-scene"]={type:[v],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}},K["portal-item"]={type:[v],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}});let C=class extends(P.SceneService(w.ArcGISService(L.OperationalLayer(O.PortalLayer(E.ScaleRangeLayer(n.MultiOriginJSONMixin(I.CustomParametersMixin(_.APIKeyMixin(S))))))))){constructor(e){super(e),this.operationalLayerType="BuildingSceneLayer",this.allSublayers=new t({getCollections:()=>[this.sublayers],getChildrenFunction:e=>"building-group"===e.type?e.sublayers:null}),this.sublayers=null,this._allSublayerOverrides=null,this.filters=new M,this.activeFilterId=null,this.summaryStatistics=null,this.outFields=null,this.legendEnabled=!0,this.type="building-scene"}normalizeCtorArgs(e){return"string"==typeof e?{url:e}:e??{}}destroy(){this.allSublayers.destroy()}readSublayers(e,r,t){const i=m.readSublayers(e,r,t);return f.forEachBuildingSublayer(i,e=>e.layer=this),this._allSublayerOverrides&&(function(e,r){r.forEach(r=>R(e,r))}(i,this._allSublayerOverrides),this._allSublayerOverrides=null),i}write(e,r){return e=super.write(e,r),!r||"web-scene"!==r.origin&&"portal-item"!==r.origin||(this.sublayers?function(e,r,t){const i=[];f.forEachBuildingSublayer(e,e=>{const r=e.write({},t);Object.keys(r).length>1&&i.push(r)}),i.length>0&&(r.sublayers=i)}(this.sublayers,e,r):this._allSublayerOverrides&&function(e,r,t){const i=t?.origin&&e.get(t.origin);i&&(r.sublayers=[],i.overrides.forEach(e=>{r.sublayers.push(s.clone(e))}))}(this._allSublayerOverrides,e,r)),e}read(e,r){if(super.read(e,r),("web-scene"===r?.origin||"portal-item"===r?.origin)&&Array.isArray(e?.sublayers)){const t=function(e,r){const t=new Map;for(const o of e)null!=o&&"object"==typeof o&&"number"==typeof o.id?t.set(o.id,o):r.messages?.push(new i("building-scene-layer:invalid-sublayer-override","Invalid value for sublayer override. Not an object or no id specified.",{value:o}));return{overrides:t,context:r}}(e.sublayers,r);this.sublayers?R(this.sublayers,t):(this._allSublayerOverrides??=new Map,this._allSublayerOverrides.set(r.origin,t))}}readSummaryStatistics(e,r){if("string"==typeof r.statisticsHRef&&this.parsedUrl){const e=y.join(this.parsedUrl.path,r.statisticsHRef);return new A({url:e,apiKey:this.apiKey,customParameters:this.customParameters})}return null}set elevationInfo(e){null!=e&&"absolute-height"!==e.mode||this._set("elevationInfo",e),this._validateElevationInfo(e)}load(e){const r=null!=e?e.signal:null,t=this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch(u.throwIfAbortError).then(()=>this._fetchService(r)).then(()=>this._fetchAssociatedFeatureService(r));return this.addResolvingPromise(t),Promise.resolve(this)}loadAll(){return a.loadAll(this,e=>{f.forEachBuildingSublayer(this.sublayers,r=>{"building-group"!==r.type&&e(r)}),this.summaryStatistics&&e(this.summaryStatistics)})}async saveAs(e,r){return this._debouncedSaveOperations(1,{...r,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"},e)}async save(){const e={getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"};return this._debouncedSaveOperations(0,e)}validateLayer(e){if(!e.layerType||"Building"!==e.layerType)throw new i("buildingscenelayer:layer-type-not-supported","BuildingSceneLayer does not support this layer type",{layerType:e.layerType})}_getTypeKeywords(){return["Building"]}async _fetchAssociatedFeatureService(e){try{const{portalItem:r}=await T.findAssociatedFeatureService(`${this.url}/layers/${this.layerId}`,{sceneLayerItem:this.portalItem,customParameters:this.customParameters,apiKey:this.apiKey,signal:e});this.associatedFeatureServiceItem=r}catch(e){u.ignoreAbortErrors(this._logWarningOnPopupEnabled())}}async _logWarningOnPopupEnabled(){const e=new AbortController;this.addHandles(o.abortHandle(e)),await p.whenOnce(()=>this.allSublayers.filter(e=>"building-component"===e.type).some(e=>e.popupEnabled&&null!=e.popupTemplate),e.signal);const r=this.allSublayers.filter(e=>"building-component"===e.type).filter(e=>e.popupEnabled&&null!=e.popupTemplate),t=[],i=[];for(const e of r){const r=e.title??`untitled ${e.id}`;e.attributeStorageInfo?t.push(r):i.push(r)}const s="\n  ",a=t.length>0?`\nThe following sublayers will fall back to binary attributes for Popups:${s}${t.join(s)}`:"",n=i.length>0?`\nThe following sublayers have no binary attributes and will not work with Popups:${s}${i.join(s)}`:"";l.getLogger(this).warn(`Associated FeatureLayer could not be loaded for this BuildingSceneLayer: ${this.title}.`,a,n)}_validateElevationInfo(e){const r="Building scene layers";F.logInvalidElevationInfoWarning(l.getLogger(this),F.elevationModeRequiredMessage(r,"absolute-height",e)),F.logInvalidElevationInfoWarning(l.getLogger(this),F.featureExpressionUnsupportedMessage(r,e))}};function R(e,r){const{overrides:t,context:i}=r;f.forEachBuildingSublayer(e,e=>e.read(t.get(e.id),i))}return e.__decorate([c.property({type:["BuildingSceneLayer"]})],C.prototype,"operationalLayerType",void 0),e.__decorate([c.property({readOnly:!0})],C.prototype,"allSublayers",void 0),e.__decorate([c.property(j)],C.prototype,"sublayers",void 0),e.__decorate([h.reader("service","sublayers")],C.prototype,"readSublayers",null),e.__decorate([c.property({type:M,nonNullable:!0,json:{write:!0}})],C.prototype,"filters",void 0),e.__decorate([c.property({type:String,json:{write:!0}})],C.prototype,"activeFilterId",void 0),e.__decorate([c.property({readOnly:!0,type:A})],C.prototype,"summaryStatistics",void 0),e.__decorate([h.reader("summaryStatistics",["statisticsHRef"])],C.prototype,"readSummaryStatistics",null),e.__decorate([c.property({type:[String],json:{read:!1}})],C.prototype,"outFields",void 0),e.__decorate([c.property(B.sceneLayerFullExtent)],C.prototype,"fullExtent",void 0),e.__decorate([c.property(B.legendEnabled)],C.prototype,"legendEnabled",void 0),e.__decorate([c.property({type:["show","hide","hide-children"]})],C.prototype,"listMode",void 0),e.__decorate([c.property(B.readOnlyService(b))],C.prototype,"spatialReference",void 0),e.__decorate([c.property(B.elevationInfo)],C.prototype,"elevationInfo",null),e.__decorate([c.property({json:{read:!1},readOnly:!0})],C.prototype,"type",void 0),e.__decorate([c.property()],C.prototype,"associatedFeatureServiceItem",void 0),C=e.__decorate([g.subclass("esri.layers.BuildingSceneLayer")],C),C});