// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/Logger","../../core/timeUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils","./NCTimeParser","./VoxelDimension"],function(e,i,t,s,r,n,a,o,l,u,p,c,d,g,y,h){"use strict";return e.default=class extends t.JSONSupport{constructor(e){super(e),this.id=0,this.dimensions=null,this.spatialReference=d.WGS84}get zDimension(){if(!this.dimensions)return-1;if(!Array.isArray(this.dimensions))return-1;if(4!==this.dimensions.length)return-1;for(let e=2;e<4;++e)if(this.dimensions[e].size>0)return e;return-1}get isValid(){return!(!this.dimensions||!Array.isArray(this.dimensions)||4!==this.dimensions.length||this.dimensions[0].size<1||this.dimensions[1].size<1||-1===this.zDimension||this.dimensions[this.zDimension].size<1)}get originInLayerSpace3D(){if(!this.isValid||"xyt"===this.volumeType)return[0,0,0];const e=this.dimensions[0].getRange(),i=this.dimensions[1].getRange(),t=this.dimensions[2],s=t.isRegular?t.getRange():[0,t.size];return[e[0],i[0],s[0]]}get voxelSizeInLayerSpaceSigned(){if(!this.isValid||"xyt"===this.volumeType)return[0,0,0];const e=this.dimensions[0].getRange(),i=this.dimensions[1].getRange(),t=this.dimensions[2],s=t.isRegular?t.getRange():[0,t.size],r=[this.sizeInVoxels[0],this.sizeInVoxels[1],this.sizeInVoxels[2]];for(let e=0;e<3;++e)r[e]<2?r[e]=1:r[e]-=1;return t.isRegular&&!t.isPositiveUp&&(r[2]*=-1),[(e[1]-e[0])/r[0],(i[1]-i[0])/r[1],(s[1]-s[0])/r[2]]}get volumeType(){if(this.isValid){const e=this.dimensions[2].size>0;let i=this.dimensions[3].size>0;if(i){const e=this.dimensions[3];i="time"===e.quantity,i&&null!==e.unit&&(i=y.parseTimeDimensionUnit(e.unit).didParse)}if(!e&&i)return"xyt";if(e&&i)return"xyzt"}return"xyz"}get sizeInVoxels(){if(!this.isValid)return[0,0,0];const e=this.zDimension;return[this.dimensions[0].size,this.dimensions[1].size,this.dimensions[e].size]}get timeStops(){if("xyzt"!==this.volumeType)return[];const e=this.dimensions[3],i=[],t=y.parseTimeDimensionUnit(e.unit);if(t.didParse)if(e.isRegular){const s=e.regularSpacing?.offset??0,n=e.regularSpacing?.scale||1;for(let a=0;a<e.size;++a){const e=s+n*a;i.push(r.offsetDateUTC(t.reference,e,t.unit))}}else if(Array.isArray(e.irregularSpacing?.values)&&e.irregularSpacing.values.length>0)for(let s=0;s<e.irregularSpacing.values.length;++s){const n=e.irregularSpacing.values[s];i.push(r.offsetDateUTC(t.reference,n,t.unit))}return i}computeVoxelSpaceLocation(e){if(!this.isValid)return[0,0,0];if("xyt"===this.volumeType)return s.getLogger(this).error("computeVoxelSpacePosition cannot be used with XYT volumes."),[0,0,0];if(!g.equals(this.spatialReference,e.spatialReference))return s.getLogger(this).error("pos argument should have the same spatial reference as the VoxelLayer."),[0,0,0];const i=p.fromValues(e.x,e.y,e.z??0);u.subtract(i,i,this.originInLayerSpace3D),u.divide(i,i,this.voxelSizeInLayerSpaceSigned);const t=this.dimensions[this.zDimension];if(!t.isRegular&&Array.isArray(t.irregularSpacing?.values)&&t.irregularSpacing.values.length>1){const s=e.z??0,r=t.irregularSpacing.values,n=t.isPositiveUp?1:-1,a=r.reduce((e,i)=>Math.abs(n*i-s)<Math.abs(n*e-s)?i:e);for(let e=0;e<r.length;++e)if(r[e]===a){i[2]=e;break}}return[i[0],i[1],i[2]]}computeLayerSpaceLocation(e){if(!this.isValid)return new c({x:0,y:0,spatialReference:this.spatialReference});const i=p.fromArray(e);if(u.multiply(i,i,this.voxelSizeInLayerSpaceSigned),u.add(i,i,this.originInLayerSpace3D),"xyt"===this.volumeType)return new c({x:i[0],y:i[1],spatialReference:this.spatialReference});const t=this.dimensions[this.zDimension];return t.isRegular||Array.isArray(t.irregularSpacing?.values)&&(e[2]<0?i[2]=t.irregularSpacing.values[0]:e[2]<t.irregularSpacing.values.length?i[2]=t.irregularSpacing.values[e[2]]:i[2]=t.irregularSpacing.values[t.irregularSpacing.values.length-1],t.isPositiveUp||(i[2]*=-1)),new c({x:i[0],y:i[1],z:i[2],spatialReference:this.spatialReference})}},i.__decorate([n.property({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],e.default.prototype,"id",void 0),i.__decorate([n.property({type:[h],json:{write:{enabled:!0,isRequired:!0}}})],e.default.prototype,"dimensions",void 0),i.__decorate([n.property({type:d,json:{read:{enabled:!1}}})],e.default.prototype,"spatialReference",void 0),i.__decorate([n.property({type:Number,json:{read:!1}})],e.default.prototype,"zDimension",null),i.__decorate([n.property({type:[Boolean],json:{read:!1}})],e.default.prototype,"isValid",null),i.__decorate([n.property({type:[Number],json:{read:!1}})],e.default.prototype,"originInLayerSpace3D",null),i.__decorate([n.property({type:[Number],json:{read:!1}})],e.default.prototype,"voxelSizeInLayerSpaceSigned",null),i.__decorate([n.property({type:["xyz","xyzt","xyt"],json:{read:{enabled:!1}}})],e.default.prototype,"volumeType",null),i.__decorate([n.property({type:[Number],json:{read:!1}})],e.default.prototype,"sizeInVoxels",null),i.__decorate([n.property({type:[Date],json:{read:!1,write:!1}})],e.default.prototype,"timeStops",null),e.default=i.__decorate([l.subclass("esri.layers.voxel.VoxelVolume")],e.default),e.default});