// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../Color","../../core/Clonable","../../core/Collection","../../core/collectionUtils","../../core/JSONSupport","../../core/mathUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./VoxelColorStop","./VoxelOpacityStop","./VoxelRangeFilter"],function(o,t,e,r,s,i,n,p,c,l,a,h,y,u,f){"use strict";let S=class extends(e.ClonableMixin(i.JSONSupport)){constructor(o){super(o),this.interpolation=null,this.stretchRange=null,this.rangeFilter=null,this._colorMapSize=256,this.colorStops=new(r.ofType(y)),this.opacityStops=new(r.ofType(u))}set colorStops(o){this._set("colorStops",s.referenceSetter(o,this._get("colorStops"),r.ofType(y)))}set opacityStops(o){this._set("opacityStops",s.referenceSetter(o,this._get("opacityStops"),r.ofType(u)))}getPreviousNext(o,t,e){let r=o;for(;--r>0&&t[r].type!==e&&3!==t[r].type;);let s=o;const i=t.length;for(;++s<i&&t[s].type!==e&&3!==t[s].type;);return[r,s]}get rasterizedTransferFunction(){const o=[];if(this.colorStops.length<2)return o;const e=[],r=[];for(const t of this.colorStops){if(!t.color)return o;r.push({color:{r:t.color.r,g:t.color.g,b:t.color.b,a:Math.round(255*(1-t.color.a))},position:t.position,type:1})}if(0===this.opacityStops.length)for(const o of r)e.push({color:o.color,position:o.position});else{for(const o of this.opacityStops){const t=n.clamp(o.position,0,1),e=Math.round(255*n.clamp(1-o.opacity,0,1));let s=!1;for(const o of r)if(1===o.type&&Math.abs(o.position-t)<1e-5){o.color.a=e,o.type=3,s=!0;break}s||r.push({color:{r:0,g:0,b:0,a:e},position:o.position,type:2})}r.sort((o,t)=>o.position<t.position?-1:1);const o=r.length;for(let t=0;t<o;++t){const e=r[t];if(3!==e.type)if(1===e.type){const[s,i]=this.getPreviousNext(t,r,2);if(-1!==s&&i!==o){const o=(e.position-r[s].position)/(r[i].position-r[s].position);e.color.a=Math.round(n.lerp(r[s].color.a,r[i].color.a,o))}else e.color.a=-1!==s?r[s].color.a:r[i].color.a}else{const[s,i]=this.getPreviousNext(t,r,1);if(-1!==s&&i!==o){const o=(e.position-r[s].position)/(r[i].position-r[s].position),t=r[s].color,p=r[i].color;d.forEach(r=>{e.color[r]=Math.round(n.lerp(t[r],p[r],o))})}else-1!==s?d.forEach(o=>{e.color[o]=r[s].color[o]}):d.forEach(o=>{e.color[o]=r[i].color[o]})}}for(const o of r)e.push({color:o.color,position:o.position})}e[0].position=0,e[e.length-1].position=1;let s=0,i=1;for(let r=0;r<this._colorMapSize;++r){const p=r/this._colorMapSize;for(;p>e[i].position;)s=i++;const c=(p-e[s].position)/(e[i].position-e[s].position),l=e[s].color,a=e[i].color,h=new t;d.forEach(o=>{h[o]=Math.round(n.lerp(l[o],a[o],c))}),h.a=n.clamp(1-n.lerp(l.a,a.a,c)/255,0,1),o.push(h)}return o}getColorForContinuousDataValue(o,t){const e=this.rasterizedTransferFunction;if(this.colorStops.length<2||!Array.isArray(this.stretchRange)||this.stretchRange.length<2||e.length<256)return null;let r=this.stretchRange[0],s=this.stretchRange[1];if(r>s){const o=r;r=s,s=o}o=n.clamp(o,r,s);const i=e[Math.round((o-r)/(s-r)*(this._colorMapSize-1))].clone();return t||(i.a=1),i}};o.__decorate([p.property({type:["linear","nearest"],json:{write:!0}})],S.prototype,"interpolation",void 0),o.__decorate([p.property({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],S.prototype,"stretchRange",void 0),o.__decorate([p.property({type:r.ofType(y),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.colorStops&&this.colorStops.length>0}}}}})],S.prototype,"colorStops",null),o.__decorate([p.property({type:r.ofType(u),json:{read:{source:"alphaStops"},write:{enabled:!0,target:"alphaStops",overridePolicy(){return{enabled:!!this.opacityStops&&this.opacityStops.length>0}}}}})],S.prototype,"opacityStops",null),o.__decorate([p.property({type:f,json:{write:!0}})],S.prototype,"rangeFilter",void 0),o.__decorate([p.property({type:[t],clonable:!1,json:{read:!1}})],S.prototype,"rasterizedTransferFunction",null),S=o.__decorate([h.subclass("esri.layers.voxel.VoxelTransferFunctionStyle")],S);const d=["r","g","b"];return S});