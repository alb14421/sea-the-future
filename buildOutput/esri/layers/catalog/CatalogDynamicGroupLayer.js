// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../core/Collection","../../core/handleUtils","../../core/LRUCache","../../core/MapUtils","../../core/MultiOriginJSONSupport","../../core/ReactiveMap","../../core/reactiveUtils","../../core/signal","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../Layer","../mixins/BlendLayer","../mixins/ScaleRangeLayer","../support/commonProperties","../support/OrderByInfo","../../statistics/utils"],function(e,t,r,o,a,i,s,l,n,d,p,c,y,u,h,_,f,g,m,b,L){"use strict";e.default=class extends(g.ScaleRangeLayer(f.BlendLayer(s.MultiOriginJSONMixin(_)))){constructor(e){super(e),this._layerCache=new a.LRUCache(20,e=>e.destroy()),this._oidToReference=new l,this._layerToReference=new Map,this.legendEnabled=!0,this.layers=new r,this.maximumVisibleSublayers=10,this.opacity=1,this.parent=null,this.persistenceEnabled=!0,this.title="Layers in view",this.type="catalog-dynamic-group",this.visible=!0}initialize(){this.addHandles([this.layers.on("after-add",({item:e})=>{e.parent=this}),this.layers.on("after-remove",({item:e})=>{e.parent=null}),n.watch(()=>this._orderBy,()=>{this._updateLayerSortValues(),this._sortAllLayers()})])}load(e){return this.addResolvingPromise(this.parent.load()),Promise.resolve(this)}destroy(){this._layerCache.destroy(),this._oidToReference.clear(),this._layerToReference.clear()}get _orderBy(){return this.parent?this.parent.orderBy?.find(e=>!e.valueExpression&&e.field)??new b({field:this.parent.objectIdField}):null}get _referenceComparator(){const e=this._orderBy;if(!this.parent||!e)return()=>0;const t=this.parent.fieldsIndex.get(e.field),r=L.getAttributeComparator(t?.toJSON().type,"descending"===e.order),o=L.getAttributeComparator("esriFieldTypeOID","descending"===e.order);return(e,t)=>r(t.sortValue,e.sortValue)||o(t.objectId,e.objectId)}get fullExtent(){return this.parent?.fullExtent??null}get updating(){return i.someMap(this._oidToReference,({pending:e})=>null!=e)}acquireLayer(e){if(this.destroyed)return o.makeHandle();const t=this._getLayerReference(e);return t.count++,o.makeHandle(()=>{t.count--,t.count||this._destroyLayerReference(t)})}_getLayerReference(e){const t=e.getObjectId();return i.getOrCreateMapValue(this._oidToReference,t,()=>{const t=e.getObjectId(),r=`${t}`,o=e.getAttribute(this.parent.itemSourceField),a=new v(e,t,o),i=this._layerCache.pop(r);return i?(this._addLayer(a,i),a):(a.pending=this.parent.createLayerFromFootprint(e).then(e=>{a.count?this._addLayer(a,e):(this.destroyed||this._layerCache.get(r)||this._layerCache.put(r,e),a.layer=null)}).catch(()=>{}).finally(()=>{a.pending=null}),a)})}_destroyLayerReference(e){e.layer&&(this._layerToReference.delete(e.layer),this.layers.remove(e.layer),this.destroyed?e.layer.destroy():this._layerCache.put(`${e.objectId}`,e.layer),e.layer=null),this._oidToReference.delete(e.objectId)}_addLayer(e,t){e.layer=t,t.persistenceEnabled=!1,this._layerToReference.set(t,e),this._updateLayerSortValue(e),this.layers.add(t),this._sortAllLayers()}_updateLayerSortValues(){for(const e of this._layerToReference.values())this._updateLayerSortValue(e)}_updateLayerSortValue(e){this._orderBy&&(e.sortValue=e.footprint.getAttribute(this._orderBy.field))}_sortAllLayers(){this.layers.sort((e,t)=>this._referenceComparator(this._layerToReference.get(e),this._layerToReference.get(t)))}},t.__decorate([p.property()],e.default.prototype,"_orderBy",null),t.__decorate([p.property({readOnly:!0})],e.default.prototype,"_referenceComparator",null),t.__decorate([p.property(m.legendEnabled)],e.default.prototype,"legendEnabled",void 0),t.__decorate([p.property({type:["show","hide","hide-children"],json:{write:!0}})],e.default.prototype,"listMode",void 0),t.__decorate([p.property({readOnly:!0})],e.default.prototype,"fullExtent",null),t.__decorate([p.property({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0,isRequired:!0}}})],e.default.prototype,"id",void 0),t.__decorate([p.property({readOnly:!0})],e.default.prototype,"layers",void 0),t.__decorate([p.property({type:c.Integer,range:{min:0,max:50},json:{write:!0,default:10}})],e.default.prototype,"maximumVisibleSublayers",void 0),t.__decorate([p.property(m.opacity)],e.default.prototype,"opacity",void 0),t.__decorate([p.property({clonable:!1})],e.default.prototype,"parent",void 0),t.__decorate([p.property({type:String,nonNullable:!0,json:{write:{ignoreOrigin:!0,isRequired:!0}}})],e.default.prototype,"title",void 0),t.__decorate([p.property({json:{read:!1}})],e.default.prototype,"type",void 0),t.__decorate([p.property({readOnly:!0})],e.default.prototype,"updating",null),t.__decorate([p.property({type:Boolean,json:{name:"visibility",write:!0}})],e.default.prototype,"visible",void 0),e.default=t.__decorate([h.subclass("esri.layers.catalog.CatalogDynamicGroupLayer")],e.default);class v{constructor(e,t,r){this.footprint=e,this.objectId=t,this.itemSource=r,this.count=0,this.layer=null,this.sortValue=void 0,this._pending=d.signal(null)}get pending(){return this._pending.value}set pending(e){this._pending.value=e}}return e.default});