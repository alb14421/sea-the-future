// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/Collection","../../core/Error","../../core/jsonMap","../../geometry/SpatialReference","./Field","./locationUtils","./ParquetEncodingLocation","./ParquetEncodingWkb","../../libs/parquet/parquet"],function(e,t,n,i,o,r,a,l,s,u){"use strict";const c=new i.JSONMap({esriGeometryPoint:"point",esriGeometryPolygon:"polygon",esriGeometryPolyline:"polyline",esriGeometryMultipoint:"multipoint"});async function m(e,t={}){if(e.geometryType&&e.spatialReference&&e.encoding&&e.fields)return e;if(e.urls.length<1)throw new n("parquet:bad-input","At least one url must be specified",e);const i=await u.createParquetFile(e.urls.getItemAt(0),{getCustomParameters:()=>t.customParameters}),c=u.readGeoMetadata(i),m={...e,file:i};null==m.fields&&(m.fields=i.fields().map(e=>r.fromJSON({name:e.name,type:e.type}))),null==m.encoding&&(m.encoding=function(e,t){if(null!=e){const t=e.primary_column,n=e.columns[t];return new s({primaryFieldName:t,orientation:n.orientation??null})}const n=a.inferLocationInfo(t.map(e=>e.name));return n.latitudeFieldName&&n.latitudeFieldName?new l({latitudeFieldName:n.latitudeFieldName,longitudeFieldName:n.longitudeFieldName}):null}(c,m.fields));const d=u.readEsriMetadata(i);if(d)switch(d.mode){case"z":m.displayOptimization={mode:"z"};break;case"xz":{const e=d.multiscale;if(!e)throw new n("bad-format","XZ display optimization requires multiscale geometries");m.displayOptimization={mode:"xz",multiscale:e};break}}if(!m.encoding)return m;switch(m.encoding.type){case"location":null==m.spatialReference&&(m.spatialReference=o.WGS84),null==m.geometryType&&(m.geometryType="point");break;case"wkb":{if(!c)return m;const e=c.primary_column,t=c.columns[e];if(m.geometryType||(m.geometryType=function(e){const{geometry_types:t}=e,i=new Set;for(const e of t){const t=p(e);t&&i.add(t)}if(i.size>1)throw new n("unsupported","Parquet mixed geometry types are not support",{geometryTypes:i});return 1===i.size?i.values().next().value:void 0}(t)),m.spatialReference||(m.spatialReference=function(e){const t=e.crs?.id?.code;return t&&"number"==typeof t?new o({wkid:t}):void 0}(t)),m.fields)for(const e of Object.keys(c.columns))m.fields=m.fields.filter(t=>t.name!==e)}}return m}function p(e){switch(e){case"Point":return"point";case"Polygon":case"MultiPolygon":return"polygon";case"LineString":return"polyline";case"MultiPoint":return"multipoint";default:return null}}e.completeParquetLayerInfo=m,e.getParquetLayerInfo=function(e,n={}){return m({urls:new t(e)},n)},e.parquetGeometryTypeKebabDict=c,e.toParquetJSONGeometryType=function(e){return c.toJSON(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});