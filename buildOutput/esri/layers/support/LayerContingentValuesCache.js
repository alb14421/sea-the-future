// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../request","../../core/arrayUtils","../../core/JSONSupport","../../core/Loadable","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/subclass","./arcgisLayerUrl","./Contingency","./ContingencyConstraintViolation","./ContingentValue","./ContingentValuesResult","./FieldGroup","./fieldUtils","./Subtype","../../widgets/FeatureForm/featureFormUtils"],function(e,t,n,i,s,o,r,a,l,u,c,p,d,y,f,m,g,h){"use strict";var V;let b=V=class extends(i.JSONSupportMixin(s.Loadable)){constructor(e){super(e),this.request=t,this.fieldGroups=null,this.fieldGroupDefinitions=null}initialize(){}get loaded(){return super.loaded}get subtypeFieldName(){return h.getNormalizedFeatureTypeInfo(this.layer).typeFieldName}static async createLoadedLayerContingentValuesCache(e){await e.load();const t=e.sourceJSON;if(void 0===e.layerId)return null;const n=t?.hasContingentValuesDefinition;if(n)return new V({layer:e}).load();if(void 0===n){const t=u.parse(e.url);if(null==t)return null;const n=t.url.path;if((await v(n)).supportsQueryDataElements){const t=e.layerId.toString(),i=await G(n,t);if(i){const t=i.map(t=>({name:t.name,isEditingRestrictive:t.isEditingRestrictive,fields:t.fieldNames.names.map(t=>e.fieldsIndex.normalizeFieldName(t))}));return new V({layer:e,fieldGroupDefinitions:t}).load()}}}return null}async load(e){const t=this.layer.load(e).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,e));return this.addResolvingPromise(t),this}validateContingencyConstraints(e,t){const n=Object.keys(e),i=[],s=[];for(const o of this.fieldGroups){const r=o.isEditingRestrictive?"error":"warning";if(t&&!o.fields.some(e=>t.includes(e)))continue;if(!o.fields.every(e=>n.includes(e))){s.push(new p({fieldGroup:o,type:r}));continue}let a=!1;const l=e[this.subtypeFieldName],u=o.contingencies.filter(e=>!(!e.isRetired&&e.subtype)||e.subtype.code===l);if(0!==u.length){for(const t of u){let n=!0;for(const i in t.values){const s=t.values[i];if("any"!==s.objectType)if("null"===s.objectType){if(null!=e[i]){n=!1;break}}else if("code"===s.objectType){if(e[i]!==s.codedValue.code){n=!1;break}}else if("range"===s.objectType){const t=e[i];if(t<s.minValue||t>s.maxValue){n=!1;break}}}if(n){a=!0;break}}a||i.push(new p({fieldGroup:o,type:r}))}}return{invalid:i,incomplete:s}}getContingentValues(e,t,n=!1){const i=e[this.subtypeFieldName],s=null!=i,o={};let r=[];const a=this.fieldGroups.filter(e=>e.fields.includes(t));r.push(new d({objectType:"any"}));for(const l of a){let a=[];const u=l.contingencies.filter(e=>!(e.isRetired||e.subtype&&s&&e.subtype.code!==i));let c=!1;const p={};for(const n of u){let i,s=!0;for(const o in n.values){const r=n.values[o];if(t!==o){if(void 0!==e[o]&&"any"!==r.objectType)if("null"===r.objectType)null!==e[o]&&(s=!1);else if("code"===r.objectType)e[o]!==r.codedValue.code&&(s=!1);else if("range"===r.objectType){const t=e[o];(t<r.minValue||t>r.maxValue)&&(s=!1)}}else i=r,c=c||"range"===r.objectType}if(i&&s){if("any"===i.objectType){a.length=0,a.push(i);break}const e=j(i);p[e]||a.push(i),p[e]=!0}}c&&(a=T(a)),o[l.name]=a,r=n?w(r,a):[]}return 1===a.length&&n&&(r=[]),new y({contingentValuesAllGroups:r,contingentValuesByFieldGroup:o})}async _initializeContingentValues(e,t){const n=e??await this._fetchFieldGroupDefs(t);if(0===n.length)return void(this.fieldGroups=[]);const i=await this._fetchContingentValues(n,t);this.fieldGroups=i}async _fetchFieldGroupDefs(e){if(void 0===this.layer.layerId)return[];const n=this.layer.sourceJSON,i=this.layer.layerId.toString(),s=u.parse(this.layer.url).url.path;if(n?.hasContingentValuesDefinition){const n=await async function(e,n,i){return t(`${e}/${n}/fieldgroups`,{responseType:"json",query:{f:"json"},...i}).then(e=>e.data.fieldGroups??[])}(s,i,e);return n.map(e=>({name:e.name,isEditingRestrictive:e.restrictive,fields:e.fields.map(e=>this.layer.fieldsIndex.normalizeFieldName(e))}))}return void 0!==n?.hasContingentValuesDefinition?[]:v(s,e).then(async t=>t.supportsQueryDataElements?(await G(s,i,e)).map(e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names.map(e=>this.layer.fieldsIndex.normalizeFieldName(e))})):[])}async _fetchContingentValues(e,n){if(void 0===this.layer.layerId)return[];const i=this.layer.sourceJSON,s=this.layer.layerId.toString(),o=u.parse(this.layer.url).url.path;if(i?.hasContingentValuesDefinition){const i=await async function(e,n,i){return t(`${e}/${n}/contingentValues`,{responseType:"json",query:{f:"json"},...i}).then(e=>e.data)}(o,s,n);return this._constructFieldGroupsAGOL(e,i)}const r=await async function(e,n,i){return t(`${e}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([n]),f:"json"},...i}).then(e=>e.data.contingentValueSets?.[0])}(o,s,n);return this._constructFieldGroupsEnterprise(e,r)}_constructFieldGroupsAGOL(e,t){return e.map(e=>{const n=t.contingentValuesDefinition.fieldGroups.find(t=>t.name===e.name);if(n){let i=[];return i=t.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(e,t,n.subTypes):this._parseAGOLFieldGroup(e,t,n.contingentValues),new f({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:i})}return null}).filter(n.isSome)}_parseAGOLFieldGroupSubtype(e,t,n){let i=[];return n?.forEach(n=>{const s=this._getSubtypeAGOL(n.name);i=i.concat(this._parseAGOLFieldGroup(e,t,n.contingentValues,s))}),i}_parseAGOLFieldGroup(e,t,n,i=null){const s=[];for(const o of n??[]){const n=this._parseAGOLContingency(o,e,t,i);s.push(n)}return s}_parseAGOLContingency(e,t,n,i){const s=e.id,o=!!e.retired&&1===e.retired,r={};for(let s=0,o=0;s<t.fields.length;s++){const a=t.fields[s],l=n.typeCodes[e.types[s]];if("Code"===l){let t=e.values[o];o++;const s=this._getDomain(i,a),l=this.layer.getField(a);if("string"===l?.type){const e=n.stringDicts.find(e=>e.domain===s?.name);e&&(t=e.entries[t])}const u=s?.codedValues.find(e=>e.code===t),c=new d({codedValue:u,objectType:"code"});r[a]=c}else if("Range"===l){const t=e.values[o];o++;const n=t.range[0],i=t.range[1],s=new d({minValue:n,maxValue:i,objectType:"range"});r[a]=s}else if("Any"===l){const e=new d({objectType:"any"});r[a]=e}else{const e=new d({objectType:"null"});r[a]=e}}return new c({id:s,isRetired:o,subtype:i,values:r})}_constructFieldGroupsEnterprise(e,t){const i=t.fieldGroups;return e.map(e=>{const n=i.find(t=>t.name===e.name);if(n){const i=n.contingencies.map(n=>{const i=n.id,s=n.isRetired||!1,o=this._getSubtypeEnterprise(n.subtypeCode),r={};for(let i=0;i<e.fields.length;i++){const s=e.fields[i];let a=n.values[i];if("number"==typeof a||"string"==typeof a){const e=this._getDomain(o,s),n=this.layer.getField(s);if(m.isStringField(n))a=t.stringDictionary[a];else if(m.isDateField(n)){const e=new Date(`${a}+00:00`);a=e.getTime()}const i=e?.codedValues.find(e=>e.code===a),l=new d({codedValue:i,objectType:"code"});r[s]=l}else if("object"==typeof a){const e=a.minValue,t=a.maxValue,n=new d({minValue:e,maxValue:t,objectType:"range"});r[s]=n}else if(a){const e=new d({objectType:"any"});r[s]=e}else{const e=new d({objectType:"null"});r[s]=e}}return new c({id:i,isRetired:s,subtype:o,values:r})});return new f({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:i})}return null}).filter(n.isSome)}_getSubtypeEnterprise(e){const t=this.layer.sourceJSON;let n;if(t?.subtypes){const i=t.subtypes.find(t=>t.code===e);n=g.fromJSON(i)}return n||null}_getSubtypeAGOL(e){const t=this.layer.sourceJSON;let n;if(t?.subtypes){const i=t.subtypes.find(t=>t.name===e);n=g.fromJSON(i)}return n||null}_getDomain(e,t){const n=e?function(e,t){const n=e.domains;if(n){const[e,i]=Object.entries(n).find(([e])=>e.trim().toLowerCase()===t.trim().toLowerCase())||[];return i||null}return null}(e,t):this.layer.getFieldDomain(t);return"inherited"===n?.type?this.layer.getFieldDomain(t):n}};function j(e){switch(e.objectType){case"any":return"@any@";case"null":return"@null@";case"code":return e.codedValue.name+e.codedValue.code.toString();case"range":return e.minValue.toString()+"-"+e.maxValue.toString()}}function T(e){let t,n;e.sort((e,t)=>"null"===e.objectType?-1:"null"===t.objectType?1:e.minValue-t.minValue);const i=[];for(const s of e)"null"!==s.objectType?null!=t&&null!=n?n<s.minValue?(i.push(new d({objectType:"range",minValue:t,maxValue:n})),t=s.minValue,n=s.maxValue):n<s.maxValue&&(n=s.maxValue):(t=s.minValue,n=s.maxValue):i.push(s);return i.push(new d({objectType:"range",minValue:t,maxValue:n})),i}function w(e,t){if(0===e.length||0===t.length)return[];if("any"===e[0].objectType)return t;if("any"===t[0].objectType)return e;const n="range"===e[0].objectType||"range"===e[1]?.objectType,i="range"===t[0].objectType||"range"===t[1]?.objectType;return n||i?function(e,t){const n=[];let i,s=0;for(const o of e)for(;s<t.length;s++){const e=t[s];if("null"===o.objectType&&"null"===e.objectType)n.push(new d({objectType:"null"}));else{if("null"===o.objectType)break;if("null"===e.objectType)continue}if(o.maxValue<e.minValue)break;if(o.maxValue===e.minValue){n.push(new d({objectType:"range",minValue:o.maxValue,maxValue:e.minValue}));break}if(!(o.minValue>e.maxValue))if(o.minValue!==e.maxValue){if(i=o.minValue>e.minValue?o.minValue:e.minValue,o.maxValue<e.maxValue){n.push(new d({objectType:"range",minValue:i,maxValue:o.maxValue}));break}n.push(new d({objectType:"range",minValue:i,maxValue:e.maxValue}))}else n.push(new d({objectType:"range",minValue:o.minValue,maxValue:e.maxValue}))}return n}(e,t):function(e,t){const n=[];for(const i of e)t.some(e=>{if(i.objectType===e.objectType)switch(i.objectType){case"any":case"null":return!0;case"code":return i.codedValue.code===e.codedValue.code&&i.codedValue.name===e.codedValue.name}return!1})&&n.push(i);return n}(e,t)}async function G(e,n,i){return t(`${e}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([n]),f:"json"},...i}).then(e=>e.data.layerDataElements?.[0].dataElement.fieldGroups??[])}async function v(e,n){return t(e,{responseType:"json",query:{f:"json"},...n}).then(e=>e.data)}return e.__decorate([o.property({constructOnly:!0})],b.prototype,"layer",void 0),e.__decorate([o.property({constructOnly:!0})],b.prototype,"request",void 0),e.__decorate([o.property({type:[f]})],b.prototype,"fieldGroups",void 0),e.__decorate([o.property({constructOnly:!0})],b.prototype,"fieldGroupDefinitions",void 0),e.__decorate([o.property()],b.prototype,"subtypeFieldName",null),b=V=e.__decorate([l.subclass("esri.layers.support.LayerContingentValuesCache")],b),b});