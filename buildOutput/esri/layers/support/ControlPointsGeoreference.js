// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../core/Clonable","../../core/Error","../../core/JSONSupport","../../core/Logger","../../core/perspectiveUtils","../../core/screenUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../core/libs/gl-matrix-2/math/mat3","../../core/libs/gl-matrix-2/factories/mat3f64","../../core/libs/gl-matrix-2/math/vec2","../../core/libs/gl-matrix-2/factories/vec2f64","../../geometry/Point","../../geometry/Polygon","../../geometry/projectionUtils","../../geometry/SpatialReference","./GeoreferenceBase"],function(e,t,o,r,n,i,s,l,a,c,u,p,f,P,d,m,h,y,g,_,v,w,R){"use strict";const x=m.create(),S=y.create();let j=class extends n.JSONSupport{};t.__decorate([a.property({type:Number,json:{write:{isRequired:!0}}})],j.prototype,"x",void 0),t.__decorate([a.property({type:Number,json:{write:{isRequired:!0}}})],j.prototype,"y",void 0),j=t.__decorate([f.subclass("esri.layers.support.ControlPointsGeoreference.ControlPointJSONType")],j);let b=class extends o.Clonable{constructor(){super(...arguments),this.sourcePoint=null,this.mapPoint=null}};function C(e){return null!=e?.sourcePoint&&null!=e.mapPoint}t.__decorate([a.property()],b.prototype,"sourcePoint",void 0),t.__decorate([a.property({type:g})],b.prototype,"mapPoint",void 0),b=t.__decorate([f.subclass("esri.layers.support.ControlPointsGeoreference.ControlPoint")],b),e.default=class extends(n.JSONSupportMixin(R)){constructor(e){super(e),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(e,t){const o=w.fromJSON(t.spatialReference),r=m.fromValues(...t.coefficients,1);return e.map(e=>(h.set(S,e.x,e.y),s.transformProjective(S,S,r),{sourcePoint:e,mapPoint:new g({x:S[0],y:S[1],spatialReference:o})}))}writeControlPoints(e,t,o,n){if(null==this.transform){const e=new r("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration. Make sure the parent media element is loaded i.e. the ImageElement or VideoElement set as 'MediaLayer.source'.",{layer:n?.layer,georeference:this});return void(n?.messages?n.messages.push(e):i.getLogger(this).error(e.name,e.message))}null!=e&&C(e[0])&&(t.controlPoints=e.map(e=>{const t=e.sourcePoint;return{x:t.x,y:t.y}}),t.spatialReference=e[0].mapPoint.spatialReference.toJSON(),t.coefficients=this.transform.slice(0,8))}get coords(){if(null==this.controlPoints)return null;const e=this._updateTransform(x);if(null==e||!C(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return function(e,t,o,r){const n=y.fromValues(0,o),i=y.fromValues(0,0),l=y.fromValues(t,0),a=y.fromValues(t,o);return s.transformProjective(n,n,e),s.transformProjective(i,i,e),s.transformProjective(l,l,e),s.transformProjective(a,a,e),new _({rings:[[n,i,l,a,n]],spatialReference:r})}(e,this.width,this.height,t)}set coords(e){if(null==this.controlPoints||!C(this.controlPoints[0]))return;const t=this.controlPoints[0].mapPoint.spatialReference;if(null==(e=this.projectOrWarn(e,t)))return;const{width:o,height:r}=this,{rings:[[n,i,a,c]]}=e,u={sourcePoint:l.createScreenPoint(0,r),mapPoint:new g({x:n[0],y:n[1],spatialReference:t})},p={sourcePoint:l.createScreenPoint(0,0),mapPoint:new g({x:i[0],y:i[1],spatialReference:t})},f={sourcePoint:l.createScreenPoint(o,0),mapPoint:new g({x:a[0],y:a[1],spatialReference:t})},P={sourcePoint:l.createScreenPoint(o,r),mapPoint:new g({x:c[0],y:c[1],spatialReference:t})};C(u)&&C(p)&&C(f)&&C(P)&&(E(x,u,p,f,P),this.controlPoints=this.controlPoints.map(({sourcePoint:e})=>(h.set(S,e.x,e.y),s.transformProjective(S,S,x),{sourcePoint:e,mapPoint:new g({x:S[0],y:S[1],spatialReference:t})})))}get inverseTransform(){return null==this.transform?null:d.invert(m.create(),this.transform)}get transform(){return this._updateTransform()}toMap(e){if(null==e||null==this.transform||null==this.controlPoints||!C(this.controlPoints[0]))return null;h.set(S,e.x,e.y);const t=this.controlPoints[0].mapPoint.spatialReference;return s.transformProjective(S,S,this.transform),new g({x:S[0],y:S[1],spatialReference:t})}toSource(e){if(null==e||null==this.inverseTransform||null==this.controlPoints||!C(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return e=e.normalize(),null==(e=v.projectOrLoad(e,t).geometry)?null:(h.set(S,e.x,e.y),s.transformProjective(S,S,this.inverseTransform),l.createScreenPoint(S[0],S[1]))}toSourceNormalized(e){const t=this.toSource(e);return null!=t&&(t.x/=this.width,t.y/=this.height),t}_updateTransform(e){const{controlPoints:t,width:o,height:r}=this;if(!(null!=t&&o>0&&r>0))return null;const[n,i,s,l]=t;if(!C(n))return null;const a=n.mapPoint.spatialReference,c=this._projectControlPoint(i,a),u=this._projectControlPoint(s,a),p=this._projectControlPoint(l,a);if(!c.valid||!u.valid||!p.valid)return null;if(!C(c.controlPoint))return null;null==e&&(e=m.create());let f=null;return f=C(u.controlPoint)&&C(p.controlPoint)?E(e,n,c.controlPoint,u.controlPoint,p.controlPoint):C(u.controlPoint)?function(e,t,o,r){return I(N,L,t),I(O,M,o),I(T,J,r),h.lerp(q,N,O,.5),h.rotate(q,T,q,Math.PI),h.lerp(V,L,M,.5),h.rotate(V,J,V,Math.PI),A(e,N,O,T,q,L,M,J,V)}(e,n,c.controlPoint,u.controlPoint):function(e,t,o){return I(N,L,t),I(O,M,o),h.rotate(T,O,N,G),h.rotate(q,N,O,G),h.rotate(J,M,L,-G),h.rotate(V,L,M,-G),A(e,N,O,T,q,L,M,J,V)}(e,n,c.controlPoint),f.every(e=>0===e)?null:f}_projectControlPoint(e,t){if(!C(e))return{valid:!0,controlPoint:e};const{sourcePoint:o,mapPoint:r}=e,{geometry:n,pending:s}=v.projectOrLoad(r,t);return s?{valid:!1,controlPoint:null}:s||n?{valid:!0,controlPoint:{sourcePoint:o,mapPoint:n}}:(i.getLogger(this).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:e,sourceSpatialReference:r.spatialReference,targetSpatialReference:t}),{valid:!1,controlPoint:null})}},t.__decorate([a.property({type:[b],json:{write:{allowNull:!1,isRequired:!0,target:{controlPoints:{type:[j],isRequired:!0},coefficients:{type:[Number],isRequired:!0},spatialReference:{type:w,isRequired:!0}}}}})],e.default.prototype,"controlPoints",void 0),t.__decorate([p.reader("controlPoints")],e.default.prototype,"readControlPoints",null),t.__decorate([P.writer("controlPoints")],e.default.prototype,"writeControlPoints",null),t.__decorate([a.property({clonable:!1})],e.default.prototype,"coords",null),t.__decorate([a.property({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],e.default.prototype,"height",void 0),t.__decorate([a.property({readOnly:!0})],e.default.prototype,"inverseTransform",null),t.__decorate([a.property({readOnly:!0})],e.default.prototype,"transform",null),t.__decorate([a.property({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],e.default.prototype,"width",void 0),e.default=t.__decorate([f.subclass("esri.layers.support.ControlPointsGeoreference")],e.default);const N=y.create(),O=y.create(),T=y.create(),q=y.create(),L=y.create(),M=y.create(),J=y.create(),V=y.create(),G=Math.PI/2;function I(e,t,o){h.set(e,o.sourcePoint.x,o.sourcePoint.y),h.set(t,o.mapPoint.x,o.mapPoint.y)}function E(e,t,o,r,n){return I(N,L,t),I(O,M,o),I(T,J,r),I(q,V,n),A(e,N,O,T,q,L,M,J,V)}const U=new Array(8).fill(0),k=new Array(8).fill(0);function z(e,t,o,r,n){return e[0]=t[0],e[1]=t[1],e[2]=o[0],e[3]=o[1],e[4]=r[0],e[5]=r[1],e[6]=n[0],e[7]=n[1],e}function A(e,t,o,r,n,i,l,a,c){return s.getProjectiveTransform(e,z(U,t,o,r,n),z(k,i,l,a,c))}return e.default});