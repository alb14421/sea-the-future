// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../request","../../core/Error","../../core/Logger","../../core/typedArrayUtil","../../core/urlUtils"],function(t,e,i,s,a){"use strict";function r(t){const e=document.createElement("canvas"),i=e.getContext("2d");e.width=t.width,e.height=t.height,i.drawImage(t,0,0,t.width,t.height);const s=i.getImageData(0,0,t.width,t.height);return{width:t.width,height:t.height,data:new Uint8Array(s.data)}}return class{constructor(t,e){this._spriteSource=t,this._maxTextureSize=e,this.devicePixelRatio=1,this._spriteImageFormat="png",this._isRetina=!1,this._spritesData={},this.image=null,this.width=null,this.height=null,this.loadStatus="not-loaded","url"===t.type&&t.spriteFormat&&(this._spriteImageFormat=t.spriteFormat),t.pixelRatio&&(this.devicePixelRatio=t.pixelRatio),this.baseURL=t.spriteUrl}get spriteNames(){const t=[];for(const e in this._spritesData)t.push(e);return t.sort(),t}getSpriteInfo(t){return this._spritesData?this._spritesData[t]:null}async load(t){if(this.baseURL){this.loadStatus="loading";try{await this._loadSprites(t),this.loadStatus="loaded"}catch{this.loadStatus="failed"}}else this.loadStatus="failed"}async _loadSprites(t){this._isRetina=this.devicePixelRatio>1.15;const{width:s,height:a,data:r,json:h}=await this._getSpriteData(this._spriteSource,t),o=Object.keys(h);if(!o||0===o.length||!r)return this._spritesData=this.image=null,void(this.width=this.height=0);this._spritesData=h,this.width=s,this.height=a;const n=Math.max(this._maxTextureSize,4096);if(s>n||a>n){const t=`Sprite resource for style ${this.baseURL} is bigger than the maximum allowed of ${n} pixels}`;throw i.getLogger("esri.layers.support.SpriteSource").error(t),new e("SpriteSource",t)}let d;for(let t=0;t<r.length;t+=4)d=r[t+3]/255,r[t]=r[t]*d,r[t+1]=r[t+1]*d,r[t+2]=r[t+2]*d;this.image=r}async _getSpriteData(i,h){if("image"===i.type){let t,a;if(this.devicePixelRatio<1.15){if(!i.spriteSource1x)throw new e("SpriteSource","no image data provided for low resolution sprites!");t=i.spriteSource1x.image,a=i.spriteSource1x.json}else{if(!i.spriteSource2x)throw new e("SpriteSource","no image data provided for high resolution sprites!");t=i.spriteSource2x.image,a=i.spriteSource2x.json}return"width"in t&&"height"in t&&"data"in t&&(s.isArrayBuffer(t.data)||s.isUint8ClampedArray(t.data))?{width:t.width,height:t.height,data:new Uint8Array(t.data),json:a}:{...r(t),json:a}}const o=a.urlToObject(this.baseURL),n=o.query?"?"+a.objectToQuery(o.query):"",d=this._isRetina?"@2x":"",l=`${o.path}${d}.${this._spriteImageFormat}${n}`,p=`${o.path}${d}.json${n}`,[u,c]=await Promise.all([t(p,h),t(l,{responseType:"image",...h})]);return{...r(c.data),json:u.data}}}});