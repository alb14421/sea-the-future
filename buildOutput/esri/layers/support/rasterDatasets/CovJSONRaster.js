// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../core/Error","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./BaseRaster","./covJSONParser","./InMemoryRaster","../rasterFunctions/stretchUtils","../../../rest/support/FeatureSet"],function(e,t,s,r,a,i,o,n,c,l,p,d){"use strict";let h=class extends n{constructor(){super(...arguments),this.datasetFormat="CovJSON"}fetchRawTile(e,t,s,r={}){return this._inMemoryRaster.fetchRawTile(e,t,s,r)}async _open(e){const{extent:t,pixelBlocks:s,multidimensionalInfo:r,attributeTable:a,bandNames:i}=await this._fetchData(e),{statistics:o,histograms:n}=p.computeStatisticsHistograms(s[0]),c=i?.map(e=>({BandName:e})),h={DataType:a?"Thematic":r?"Scientific":"Generic",BandProperties:c},u=new l({source:{extent:t,pixelBlocks:s,attributeTable:a?d.fromJSON(a):null,multidimensionalInfo:r,statistics:o,histograms:n,keyProperties:h,isPseudoSpatialReference:!1}});await u.open(),this._inMemoryRaster=u;const g=this.source?"":this.url.slice(this.url.lastIndexOf("/")+1);this._set("datasetName",g.slice(0,g.indexOf("."))),this._set("rasterInfo",u.rasterInfo)}async _fetchData(e){const s=this.source??(await this.request(this.url,{signal:e?.signal})).data,r="imagery-tile-layer:open-coverage-json";if("coverage"!==s.type?.toLowerCase()||"grid"!==s.domain?.domainType?.toLowerCase())throw new t(r,"Only coverage with Grid domain type is supported");if(!s.ranges)throw new t(r,"Missing ranges in the grid coverage data");if(!s.domain.referencing?.length)throw new t(r,"Missing domain referencing in the grid coverage data");const a=Object.values(s.ranges);for(let e=0;e<a.length;e++){const{axisNames:s,shape:i,type:o,values:n}=a[e];if(!("ndarray"===o.toLowerCase()&&n?.length&&s?.length&&i?.length))throw new t(r,"Only ranges with valid NdArray, axisNames, shape, and inline values are supported");if(!c.isXAxis(s[s.length-1])||!c.isYAxis(s[s.length-2]))throw new t(r,"Only row-major ordered pixel values are supported. X axis must be the last axis.")}return c.parseGridCoverage(s)}};return e.__decorate([s.property({type:String,json:{write:!0}})],h.prototype,"datasetFormat",void 0),e.__decorate([s.property({constructOnly:!0})],h.prototype,"source",void 0),h=e.__decorate([o.subclass("esri.layers.support.rasterDatasets.CovJSONRaster")],h),h});