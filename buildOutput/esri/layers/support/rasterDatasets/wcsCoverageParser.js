// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../geometry/Extent","../../../geometry/Polygon","../../ogc/crsUtils","../RasterInfo","./multidimensionalUtils","./xmlUtilities"],function(e,t,n,i,a,l,s){"use strict";function o(e){e.variables.forEach(e=>e.dimensions.forEach(e=>e.values??=l.getDimensionValues(e)))}function r(e){return{requestResponseCRSs:s.getElementValues(e,"requestResponseCRSs").map(e=>e.split(":")[1]),nativeCRSs:s.getElementValues(e,"nativeCRSs").map(e=>e.split(":")[1])}}function m(e,t){const n="1.0.0"===t?"interpolationMethod":"InterpolationMethod",i=s.getElementValues(e,n),a="1.0.0"===t?e.getAttribute("default"):s.getElementValue(e,"InterpolationMethods/Default");return null!=a?[a].concat(i.filter(e=>e.toLowerCase()!==a.toLowerCase())):i}function u(e){return null==e?["nearest"]:e.map(e=>{const t=e.toLowerCase();return t.includes("nearest")?"nearest":t.includes("linear")?"bilinear":t.includes("cubic")?"cubic":null}).filter(e=>!!e)}function p(e){const n=s.getElements(e,"pos"),i=s.getSpaceDelimitedNumericValues(n[0]),a=s.getSpaceDelimitedNumericValues(n[1]);return new t({xmin:i[0],ymin:i[1],xmax:a[0],ymax:a[1],spatialReference:{wkid:4326}})}function g(e,t){const n=s.getElementValues(e,t);return n?.length&&""!==n[0]&&!isNaN(Number(n[0]))?n.map(e=>Number(e)):null}function c(e){const t=s.getSpaceDelimitedNumericValues(e,"MinimumValue"),n=s.getSpaceDelimitedNumericValues(e,"MaximumValue");return t.length&&n.length?t.map((e,t)=>({min:e,max:n[t],avg:-1,stddev:-1})):null}function d(e){return null==e?null:e.every(t=>t===e[0])?e[0]:e}function f(e){const t=[],n=s.getElements(e,"RangeSet");let i=[];for(let e=0;e<n.length;e++){const a=s.getElementValue(n[e],"name"),l=s.getElementValue(n[e],"label"),o=[],r=g(n[e],"nullValues/singleValue"),m=s.getElements(n[e],"AxisDescription");for(let e=0;e<m.length;e++){const t=s.getElementValue(m[e],"name"),n=s.getElementValue(m[e],"label"),a=s.getElementValues(m[e],"singleValue");if(0===a.length){const t=s.getElementValue(m[e],"min"),n=s.getElementValue(m[e],"max"),i=Number(s.getElementValue(m[e],"res"))||1;if(null!==t&&null!==n)for(let e=parseInt(t,10);e<=parseInt(n,10);e+=i)a.push(e.toString())}"band"===t.toLowerCase()&&(i=a),o.push({name:t,label:n,values:a})}t.push({name:a,label:l,nullValues:r,axis:o})}return{rangeSet:t,bandNames:i}}function h(e){const t=s.getElements(e,"timeposition");if(t.length>0){const e=[];for(let n=0;n<t.length;n++)e.push(new Date(s.getElementValue(t[n])));return{begin:e[0],end:e[e.length-1],values:e}}const n=s.getElement(e,"timePeriod")||s.getElement(e,"TimePeriod");return n?{begin:new Date(s.getElementValue(n,"beginPosition")||s.getElementValue(n,"BeginPosition")),end:new Date(s.getElementValue(n,"endPosition")||s.getElementValue(n,"EndPosition")),...function(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const n=["Years","Months","Days","Hours","Minutes","Seconds"];let i,a,l;return t.includes("PT")?(t=t.slice(2),l=["H","M","S"].findIndex(e=>t.includes(e)),i=n[3+l],a=parseFloat(t.slice(0,-1))):(t=t.slice(1),l=["Y","M","D"].findIndex(e=>t.includes(e)),l>-1&&(i=n[l]),a=parseFloat(t.slice(0,-1))),{resolution:a,units:i}}(s.getElementValue(n,"timeResolution")||s.getElementValue(n,"TimeResolution"))}:null}function E(e){const n=s.getElement(e,"spatialDomain"),i=s.getElement(n,"Envelope")||s.getElement(n,"EnvelopeWithTimePeriod"),a=i.getAttribute("srsName").split(":"),l=a[a.length-1],o=s.getElements(i,"pos"),r=s.getSpaceDelimitedNumericValues(o[0]),m=s.getSpaceDelimitedNumericValues(o[1]),u=parseInt(l,10),p=isNaN(u)?null:{wkid:u},g=new t({xmin:r[0],ymin:r[1],xmax:m[0],ymax:m[1],spatialReference:p}),c=s.getElement(n,"RectifiedGrid"),d=s.getElementValue(c,"low").split(" "),f=s.getElementValue(c,"high").split(" "),E=parseInt(f[0],10)-parseInt(d[0],10)+1,b=parseInt(f[1],10)-parseInt(d[1],10)+1,S=s.getSpaceDelimitedNumericValues(n,"origin/pos"),x=s.getElements(n,"offsetVector"),V={envelope:g,columns:E,rows:b,offset:{x:parseFloat(s.getElementValue(x[0]).split(" ")[0]),y:parseFloat(s.getElementValue(x[1]).split(" ")[1])},origin:{x:S[0],y:S[1]}},v=s.getElement(e,"temporalDomain")||s.getElement(e,"TemporalDomain");return{spatialDomain:V,temporalDomain:v?h(v):null}}function b(e,t){const n=[],i=s.getElements(e,"Field");let a,l=[];for(let e=0;e<i.length;e++){const o=s.getElementValue(i[e],"Identifier"),r=s.getElementValue(i[e],"Description"),u=s.getElementValue(i[e],"Definition"),p=s.getElementValue(i[e],"Abstract"),d=s.getElementValue(i[e],"Title"),f=g(i[e],"NullValue"),h=s.getElement(i[e],"AllowedValues"),E=h?c(h):null,b=m(i[e],"1.1.0"),S=[],x=s.getElements(i[e],"Axis");for(let e=0;e<x.length;e++){const n=x[e].getAttribute("identifier"),i=s.getElementValue(x[e],"UOM"),o=s.getElementValue(x[e],"DataType"),r=s.getElementValues(x[e],"Key");t&&!n.toLowerCase().includes("band")||(l=r,a=f),S.push({identifier:n,uom:i,dataType:o,values:r,bandNoDataValues:a})}n.push({identifier:o,description:r,definition:u,abstract:p,title:d,supportedInterpolations:b,axis:S,nullValues:f,statistics:E})}return{rangeSet:n,bandNames:l,bandNoDataValues:a,statistics:n[0].statistics}}function S(e){const n=s.getElement(e,"SpatialDomain"),a=s.getElement(n,"GridCRS"),l=s.getElementValue(a,"GridBaseCRS"),o=s.getElementValue(a,"GridOrigin"),r=o?.split(" ").map(e=>parseFloat(e))??[0,0],m=s.getSpaceDelimitedNumericValues(a,"GridOffsets"),u=s.getElements(n,"BoundingBox");let p,g,c,d;for(let e=0;e<u.length;e++){const n=u[e].getAttribute("crs")?.toLowerCase();if(null!=n)if(n.includes("imagecrs")){const t=s.getSpaceDelimitedNumericValues(u[e],"LowerCorner"),n=s.getSpaceDelimitedNumericValues(u[e],"UpperCorner");p=n[0]-t[0]+1,g=n[1]-t[1]+1}else if(n.indexOf("epsg")>0){const i=n.split(":");c=parseInt(i[i.length-1],10);const a=s.getSpaceDelimitedNumericValues(u[e],"LowerCorner"),l=s.getSpaceDelimitedNumericValues(u[e],"UpperCorner");d=new t({xmin:a[0],ymin:a[1],xmax:l[0],ymax:l[1],spatialReference:{wkid:c}})}}const f=p>g,E=d.xmax-d.xmin>d.ymax-d.ymin;let b=!1;i.isAxesOrderReversedForWkid(c)&&(f===E?b=!1:(b=!0,d=new t({xmin:d.ymin,ymin:d.xmin,xmax:d.ymax,ymax:d.xmax,spatialReference:{wkid:c}})));const S={columns:p,rows:g,origin:{x:r[0],y:r[1]},offset:{x:m[0],y:m[m.length-1]},gridBaseCRS:l,envelope:d,useEPSGAxis:b},x=s.getElement(e,"temporalDomain")||s.getElement(e,"TemporalDomain");return{spatialDomain:S,temporalDomain:x?h(x):null}}function x(e){const n=s.getElement(e,"Envelope")||s.getElement(e,"EnvelopeWithTimePeriod"),i=n.getAttribute("srsName"),a=i.slice(i.lastIndexOf("/")+1),l=n.getAttribute("axisLabels").split(" ").map(e=>e.trim()).filter(e=>""!==e.trim()),o=s.getSpaceDelimitedNumericValues(n,"lowerCorner"),r=s.getSpaceDelimitedNumericValues(n,"upperCorner"),m=!["y","lat","latitude","north","nor","n","b"].includes(l[0].toLowerCase());let u;const p=parseInt(a,10),g=isNaN(p)?null:{wkid:p};u=new t(m?{xmin:o[0],ymin:o[1],xmax:r[0],ymax:r[1],spatialReference:g}:{xmin:o[1],ymin:o[0],xmax:r[1],ymax:r[0],spatialReference:g});const c={mins:o,maxs:r},d=n.getAttribute("uomLabels").trim().split(" ");let f,h;if(s.isSameTagIgnoreNS(n,"EnvelopeWithTimePeriod")){f=new Date(s.getElementValue(e,"beginPosition")||s.getElementValue(e,"BeginPosition")),h=new Date(s.getElementValue(e,"endPosition")||s.getElementValue(e,"EndPosition"));const t=d?.findIndex(e=>"oledatetime"===e?.toLowerCase());t>-1&&(d[t]="ISO8601")}return{envelope:u,axisLabels:l,uomLabels:d.length?d:null,envelopeAllDims:c,beginPosition:f,endPosition:h,isEastFirst:m}}function V(e,t){const n=[],i=s.getElements(e,"DataRecord"),a=[];let l,o=[];for(let e=0;e<i.length;e++){const r=s.getElements(i[e],"field"),m=[];for(let e=0;e<r.length;e++){const n=r[e].getAttribute("name"),i=s.getElementValue(r[e],"description")||"",u=s.getElement(r[e],"uom")?.getAttribute("code")||"",p=s.getSpaceDelimitedNumericValues(r[e],"interval"),c=g(r[e],"nilValue")?.[0];t&&!n.toLowerCase().includes("band")||(a.push(n),p?.length&&(l=l||[],l.push({min:p[0],max:p[1],avg:-1,stddev:-1})),o.push(c)),m.push({name:n,description:i,uom:u,allowedValues:p,nilValue:c})}n.push(m)}return o.some(e=>null!=e)||(o=null),{rangeType:n,bandNames:a,bandStats:l,bandNoDataValues:o}}function v(e){let t=1,n="";return Math.abs(e-1/24)<1/24*.01?n="Hours":Math.abs(e-1)<.01?n="Days":e<1?(t=Math.round(24*e),n="Hours"):e>27.99&&e<31.01||Math.round(e/30)<12?n="Months":e>364.99&&e<366.01&&(n="Years"),{interval:t,intervalUnit:n}}function D(e,t){const n=s.getElement(e,"RectifiedGrid"),i=s.getSpaceDelimitedNumericValues(n,"low"),a=s.getSpaceDelimitedNumericValues(n,"high"),l=[];for(let e=0;e<i.length;e++)l.push(a[e]-i[e]+1);const o=s.getElementValue(n,"axisLabels").split(" "),r=s.getSpaceDelimitedNumericValues(n,"origin/pos"),m=s.getElements(n,"offsetVector"),u=[];for(let e=0;e<m.length;e++){const t=s.getSpaceDelimitedNumericValues(m[e]),n=t.findIndex(e=>0!==e);u[n]=t[n]}let p,g,c,d=!1;return t?.length&&o?.length&&(d=[...t].sort((e,t)=>e<t?-1:1).join(",")===[...o].sort((e,t)=>e<t?-1:1).join(",")),["y","lat","latitude","north","nor","n","b"].includes((d?o:t)[0].toLowerCase())?(p=l[1],g=l[0],c={y:Math.abs(u[0]),x:Math.abs(u[1])}):(p=l[0],g=l[1],c={x:Math.abs(u[0]),y:Math.abs(u[1])}),{columns:p,rows:g,origin:r,offset:u,resolution:c,gridSamples:l,axisLabels:o,hasSameAxisLabelsAsBoundedBy:d}}function N(e){const t=s.getElement(e,"EarthObservation");if(!t)return null;const i=s.getElement(t,"phenomenonTime"),a=i?h(i):null,l=s.getElement(t,"phenomenonTime"),o=l?h(l):null,r=s.getElementValue(t,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let m=null;if(r){const e=r.split(" ").map(e=>e.trim()).filter(e=>null!=e&&""!==e).map(Number);if(e.length){const t=[];for(let n=0;n<e.length/2;n+=2)t.push(e[n],e[n+1]);m=new n({rings:[[t]]})}}return{observation:{phenomenonTime:a,resultTime:o,footprint:m,identifier:s.getElementValue(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:s.getElementValue(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:s.getElementValue(e,"metaDataProperty/EarthObservationMetaData/status")}}}e.parseCoverages=function(e,t){let n=null;if(n="string"==typeof e?(new DOMParser).parseFromString(e,"text/xml"):e,"1.0.0"===t)return s.getElements(n,"CoverageOffering").map(e=>function(e){const t={version:"1.0"};let n,i=[];for(let a=0;a<e.childNodes.length;a++){const l=e.childNodes[a];if(1===l.nodeType)if(s.isSameTagIgnoreNS(l,"description"))t.description=s.getElementValue(l);else if(s.isSameTagIgnoreNS(l,"name"))t.name=s.getElementValue(l);else if(s.isSameTagIgnoreNS(l,"label"))t.label=s.getElementValue(l);else if(s.isSameTagIgnoreNS(l,"supportedFormats"))t.supportedFormats=s.getElementValues(l,"formats");else if(s.isSameTagIgnoreNS(l,"supportedCRSs"))t.supportedCRSs=r(l);else if(s.isSameTagIgnoreNS(l,"supportedInterpolations"))t.supportedInterpolations=m(l,"1.0.0");else if(s.isSameTagIgnoreNS(l,"lonLatEnvelope"))t.lonLatEnvelope=p(l);else if(s.isSameTagIgnoreNS(l,"rangeSet")){const e=f(l);t.rangeSet=e.rangeSet,i=e.bandNames;const a=e.rangeSet[0].nullValues;a?.length&&(n=d(a))}else s.isSameTagIgnoreNS(l,"domainSet")&&(t.domainSet=E(l))}const l=u(t.supportedInterpolations),{name:g,description:c,label:h,lonLatEnvelope:b,supportedFormats:S}=t,{spatialDomain:x}=t.domainSet,V={x:Math.abs(x.offset.x),y:Math.abs(x.offset.y)},v=function(e){if(!e.temporalDomain)return null;const{begin:t,end:n,values:i,units:a,resolution:l}=e.temporalDomain,s={variables:[{name:"default",description:"",dimensions:[{name:"StdTime",description:"",unit:"ISO8601",values:i?.map(e=>e.getTime()),hasRegularIntervals:!i,interval:l,intervalUnit:a,extent:[t.getTime(),n.getTime()]}]}]};return o(s),s}(t.domainSet),D=new a({width:x.columns,height:x.rows,pixelSize:V,pixelType:"unknown",extent:x.envelope,spatialReference:x.envelope.spatialReference,bandCount:i.length||1,noDataValue:n,multidimensionalInfo:v});return{id:g,title:t.name,description:c||h,lonLatEnvelope:b,rasterInfo:D,bandNames:i,supportedFormats:S,supportedInterpolations:l,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}(e));const i=s.getElements(n,"CoverageDescription");return"1.1.0"===t||"1.1.1"===t||"1.1.2"===t?i.map(e=>function(e,t){const n=[],i=[],l={supportedFormats:n,supportedCRSs:i,version:"1.1"};let r,m,p=[];for(let t=0;t<e.childNodes.length;t++){const a=e.childNodes[t];if(1!==a.nodeType)continue;const o=s.getNodeNameIgnoreNS(a).toLowerCase();switch(o){case"title":case"abstract":case"identifier":l[o]=s.getElementValue(a);break;case"supportedformat":{const e=s.getElementValue(a);n.includes(e)||n.push(e)}break;case"supportedcrs":{const e=s.getElementValue(a);i.includes(e)||i.push(e)}break;case"range":{const e=b(a,!!l.domain?.temporalDomain);l.range=e.rangeSet,p=e.bandNames;const{bandNoDataValues:t}=e;t?.length&&(r=d(t)),m=e.statistics}break;case"domain":l.domain=S(a)}}const g=u(l.range[0].supportedInterpolations),{identifier:c,abstract:f,title:h,domain:E,range:x}=l,V={x:Math.abs(E.spatialDomain.offset.x),y:Math.abs(E.spatialDomain.offset.y)},v=function(e,t){if(!t.temporalDomain)return null;const n=e.filter(e=>!e.identifier.toLowerCase().includes("field_1")&&!e.axis.some(e=>e.identifier.includes("band"))),i=[];if(n.length&&n.forEach(e=>{const t=e.axis.map(e=>{const t=e.values.map(t=>"ISO8601"===e.uom?(t=t.trim()).toLowerCase().includes("z")?new Date(t).getTime():new Date(t+"Z").getTime():parseFloat(t.trim())),n=[Math.min.apply(null,t),Math.max.apply(null,t)];return{name:e.identifier.trim(),description:"",field:e.identifier.trim(),unit:e.uom?e.uom.trim():"",hasRegularIntervals:!1,values:t,extent:n}});i.push({name:e.identifier.trim(),description:e.description?.trim()??"",unit:"",dimensions:t,statistics:e.statistics})}),t.temporalDomain){const{begin:e,end:n,values:a,units:l,resolution:s}=t.temporalDomain;i.some(e=>e.dimensions.some(e=>"stdtime"===e.name.toLowerCase()))||i.forEach(t=>{t.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:a?.map(e=>e.getTime()),hasRegularIntervals:!a,interval:s,intervalUnit:l,extent:[e.getTime(),n.getTime()]})})}if(i.length){const e={variables:i};return o(e),e}return null}(x,E);v&&(r=x[0].nullValues,1===r?.length&&(r=r[0]));const D=new a({width:E.spatialDomain.columns,height:E.spatialDomain.rows,pixelSize:V,pixelType:"unknown",extent:E.spatialDomain.envelope,spatialReference:E.spatialDomain.envelope.spatialReference,bandCount:p.length||1,noDataValue:r,statistics:m,multidimensionalInfo:v});return{id:c,title:l.title,description:f||h,bandNames:p,rasterInfo:D,supportedFormats:n,supportedInterpolations:g,coverageDescription:l,version:t,useEPSGAxis:E.spatialDomain.useEPSGAxis}}(e,t)):i.map(e=>function(e){const t={version:"2.0"};let n,i,r=[];for(let a=0;a<e.childNodes.length;a++){const l=e.childNodes[a];if(1===l.nodeType)if(s.isSameTagIgnoreNS(l,"coverageId"))t.coverageId=s.getElementValue(l);else if(s.isSameTagIgnoreNS(l,"ServiceParameters"))t.serviceParameters={supportedFormats:s.getElementValues(l,"nativeFormat")};else if(s.isSameTagIgnoreNS(l,"boundedBy"))t.boundedBy=x(l);else if(s.isSameTagIgnoreNS(l,"rangeType")){const e=V(l,t.boundedBy?.axisLabels.length>2||t.domainSet?.axisLabels.length>2);t.rangeType=e.rangeType,r=e.bandNames,n=e.bandStats;const{bandNoDataValues:a}=e;a?.length&&(i=d(a))}else if(s.isSameTagIgnoreNS(l,"domainSet"))t.domainSet=D(l,t.boundedBy?.axisLabels);else if(s.isSameTagIgnoreNS(l,"metadata")){const e=s.getElement(l,"EOMetadata");t.eoMetadata=e?N(e):null}}const{coverageId:m,boundedBy:u,domainSet:p,rangeType:g,serviceParameters:c}=t,f=function(e,t,n){if(n.axisLabels.length<=2)return null;const i=[];for(let t=0;t<e.length;t++){const n=e[t];for(let e=0;e<n.length;e++)n[e].name.toLowerCase().includes("band")||i.push(n[e])}const a=[];if(i.length){const e=[];for(let i=2;i<n.axisLabels.length;i++){const a=t.uomLabels?.[i]?.trim()??"",s=n.axisLabels[i].toLowerCase().includes("time")||"iso8601"===a.toLowerCase()||"oledatetime"===a.toLowerCase();let o,r;if(s){const e=v(n.offset[i]);o=e.interval,r=e.intervalUnit}else o=n.offset[i],r=a;const m=[];s?(m.push(l.convertOleDateTimeToEpoch(t.envelopeAllDims.mins[i])),m.push(l.convertOleDateTimeToEpoch(t.envelopeAllDims.maxs[i]))):(m.push(t.envelopeAllDims.mins[i]),m.push(t.envelopeAllDims.maxs[i])),e.push({name:n.axisLabels[i].trim(),description:n.axisLabels[i].trim(),unit:s?"ISO8601":a,hasRegularIntervals:!0,extent:m,interval:o,intervalUnit:r})}if(i.forEach(t=>{const{allowedValues:n}=t,i=2===n?.length?[{min:n[0],max:n[1],avg:-1,stddev:-1}]:null;a.push({name:t.name.trim(),description:t.description?.trim()??"",unit:t.uom.trim(),statistics:i,dimensions:[...e]})}),a.length){const e={variables:a};return o(e),e}}return null}(g,u,p);return!n&&f&&(n=f?.variables[0].statistics),null!=f&&(i=g[0][0].nilValue),{id:m,title:m,description:m,bandNames:r,rasterInfo:new a({width:p.columns,height:p.rows,pixelSize:p.resolution,pixelType:"unknown",extent:u.envelope,spatialReference:u.envelope.spatialReference,bandCount:r.length||1,statistics:n,noDataValue:i,multidimensionalInfo:f}),supportedFormats:c.supportedFormats,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}(e))},e.standardizeInterpolations=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});