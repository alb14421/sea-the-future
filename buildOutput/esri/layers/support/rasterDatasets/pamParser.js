// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/arrayUtils","../../../geometry/SpatialReference","../../../geometry/support/spatialReferenceUtils","./xmlUtilities","../rasterTransforms/PolynomialTransform"],function(e,t,n,a,r,s){"use strict";function l(e,t){if(!e||!t)return null;const n=[];for(let a=0;a<e.length;a++)n.push(e[a]),n.push(t[a]);return n}function i(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&0!==t)return new n({wkid:t});if(e=String(e).trim(),a.isWKT2(e))return new n({wkt2:e});const r=e.toUpperCase();if(r.startsWith("COMPD_CS")){if(!r.includes("VERTCS")||!r.includes("GEOGCS")&&!r.startsWith("PROJCS"))return null;const a=r.indexOf("VERTCS"),s=r.indexOf("PROJCS"),l=s>-1?s:r.indexOf("GEOGCS");if(-1===l)return null;const i=e.slice(l,e.lastIndexOf("]",a)+1).trim(),o=e.slice(a,e.lastIndexOf("]")).trim();t=u(i);const c=new n(t?{wkid:t}:{wkt:i}),m=u(o);return m&&(c.vcsWkid=m),c}return r.startsWith("GEOGCS")||r.startsWith("PROJCS")?(t=u(e),new n(0!==t?{wkid:t}:{wkt:e})):null}function u(e){const t=e.replaceAll("]","[").replaceAll('"',"").split("[").map(e=>e.trim()).filter(e=>""!==e),n=t[t.length-1].split(","),a=n[0]?.toLowerCase();if(("epsg"===a||"esri"===a)&&e.endsWith('"]]')){const e=Number(n[1]);if(!isNaN(e)&&0!==e)return e}return 0}e.parsePAMInfo=function(e){if("pamdataset"!==e?.documentElement.tagName?.toLowerCase())return{};const n={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach(e=>{if(1===e.nodeType)if(r.isSameTagIgnoreNS(e,"SRS")){if(!n.spatialReference){const t=r.getElementValue(e);n.spatialReference=i(t)}}else if(r.isSameTagIgnoreNS(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){const{spatialReference:t,transform:a}=function(e){const t=r.getElement(e,"GeodataXform"),n=i(r.getElementNumericValue(t,"SpatialReference/WKID")||r.getElementValue(t,"SpatialReference/WKT"));if("typens:PolynomialXform"!==t.getAttribute("xsi:type"))return{spatialReference:n,transform:null};const a=r.getElementNumericValue(t,"PolynomialOrder")??1,u=r.getElementNumericValues(t,"CoeffX/Double"),o=r.getElementNumericValues(t,"CoeffY/Double"),c=r.getElementNumericValues(t,"InverseCoeffX/Double"),m=r.getElementNumericValues(t,"InverseCoeffY/Double"),f=l(u,o),d=l(c,m);return{spatialReference:n,transform:f&&d&&f.length&&d.length?new s({spatialReference:n,polynomialOrder:a,forwardCoefficients:f,inverseCoefficients:d}):null}}(e);n.transform=a,n.spatialReference||(n.spatialReference=t)}else r.getElements(e,"MDI").forEach(e=>n.metadata[e.getAttribute("key")]=r.getElementValue(e));else if(r.isSameTagIgnoreNS(e,"PAMRasterBand")){const t=function(e){const t=r.getElementNumericValue(e,"NoDataValue"),n=r.getElement(e,"Histograms/HistItem"),a=r.getElementNumericValue(n,"HistMin"),s=r.getElementNumericValue(n,"HistMax"),l=r.getElementNumericValue(n,"BucketCount"),i=r.getElementValue(n,"HistCounts")?.split("|").map(e=>Number(e));let u,o,c,m;r.getElements(e,"Metadata/MDI").forEach(e=>{const t=Number(e.textContent??e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":u=t;break;case"STATISTICS_MAXIMUM":o=t;break;case"STATISTICS_MEAN":c=t;break;case"STATISTICS_STDDEV":m=t}});const f=r.getElementNumericValue(e,"Metadata/SourceBandIndex");return{noDataValue:t,histogram:i?.length&&null!=a&&null!=s?{min:a,max:s,size:l||i.length,counts:i}:null,sourceBandIndex:f,statistics:null!=u&&null!=o?{min:u,max:o,avg:c,stddev:m}:null}}(e);null!=t.sourceBandIndex&&null==n.rasterBands[t.sourceBandIndex]?n.rasterBands[t.sourceBandIndex]=t:n.rasterBands.push(t)}});const a=n.rasterBands;if(a.length){const e=!!a[0].statistics;n.statistics=e?a.map(e=>e.statistics).filter(t.isSome):null;const r=!!a[0].histogram;n.histograms=r?a.map(e=>e.histogram).filter(t.isSome):null}return n},e.parseSpatialReference=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});