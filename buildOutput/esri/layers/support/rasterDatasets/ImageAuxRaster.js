// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../core/Error","../../../core/has","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../../../geometry/SpatialReference","./BaseRaster","./InMemoryRaster","./pamParser","../rasterFormats/RasterCodec","../rasterFunctions/stretchUtils","../rasterTransforms/PolynomialTransform"],function(e,t,s,a,r,o,i,n,l,c,p,u,f,m,h,d){"use strict";let g=class extends p{fetchRawTile(e,t,s,a={}){return this._inMemoryRaster.fetchRawTile(e,t,s,a)}async _open(e){const t=await this._fetchData(e);let{spatialReference:s,statistics:a,histograms:r,transform:o}=await this._fetchAuxiliaryData(e);const i=!s;i&&(s=new c({wkid:3857})),r?.length&&null==a&&(a=h.estimateStatisticsFromHistograms(r));const{width:n,height:p}=t;let f=new l({xmin:-.5,ymin:.5-p,xmax:n-.5,ymax:.5,spatialReference:s});const m=o?o.forwardTransform(f):f;let d=!0;if(o){const e=o.forwardCoefficients;d=e&&0===e[1]&&0===e[2],d&&(o=null,f=m)}const g=new u({source:{extent:m,nativeExtent:f,transform:o,pixelBlocks:[t],statistics:a,histograms:r,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:i},ioConfig:{sampling:"closest",skipStatistics:!0}});this.ioConfig.skipMapInfo&&(g.ioConfig.skipMapInfo=!0),await g.open(),g.source=null,this._set("rasterInfo",g.rasterInfo),this._inMemoryRaster=g}async _fetchData(e){const{data:a}=await this.request(this.url,{responseType:"array-buffer",signal:e?.signal}),r=m.getFormat(a).toUpperCase();if("JPG"!==r&&"PNG"!==r&&"GIF"!==r&&"BMP"!==r)throw new t("image-aux-raster:open","the data is not a supported format");this._set("datasetFormat",r);const o=r.toLowerCase(),i="gif"===o||"bmp"===o||!s("ios"),n=await this.decodePixelBlock(a,{format:o,useCanvas:i,hasNoZlibMask:!0});if(null==n)throw new t("image-aux-raster:open","the data cannot be decoded");return n}async _fetchAuxiliaryData(e){const t=e?.signal,{skipExtensions:s=[],skipMapInfo:r}=this.ioConfig,o=r||s.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:t}),i=this.datasetFormat,n="JPG"===i?"jgw":"PNG"===i?"pgw":"BMP"===i?"bpw":null,l=n&&s.includes(n)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+n,{responseType:"text",signal:t}),c=await a.eachAlways([o,l]);if(t?.aborted)throw a.createAbortError();const p=f.parsePAMInfo(c[0].value?.data);if(!p.transform){const e=c[1].value?c[1].value.data.split("\n").slice(0,6).map(e=>Number(e)):null;p.transform=6===e?.length?new d({forwardCoefficients:[e[4],e[5],e[0],-e[1],e[2],-e[3]]}):null}return p}};return e.__decorate([r.property({type:String,json:{write:!0}})],g.prototype,"datasetFormat",void 0),g=e.__decorate([n.subclass("esri.layers.support.rasterDatasets.ImageAuxRaster")],g),g});