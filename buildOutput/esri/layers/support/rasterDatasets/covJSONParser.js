// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../Color","../../../geometry/Extent","../../../geometry/SpatialReference","../../../intl/locale","../PixelBlock","../rasterFormats/pixelRangeUtils"],function(e,t,n,l,a,s,i){"use strict";function r(e){return["x","e","east","long","longitude"].includes(e.toLowerCase())}function o(e){return["y","n","west","lat","latitude"].includes(e.toLowerCase())}function u(e){const t=a.getLocaleLanguage();return t?e[t]??Object.values(e)[0]:Object.values(e)[0]}function c(){return Math.round(255*Math.random())}function d(e){let t=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let l=0;l<e.length;l++){const a=e[l];null!=a&&(a<t&&(t=a),a>n&&(n=a))}return i.getIntegerPixelType(t,n)}function m(e,t,n){const l=e.map((e,n)=>({name:e,count:t[n]})).sort((e,t)=>e.name>t.name?-1:1),a=(s=1,e=>s*=e.count);var s;const i=[...l.slice(1),{name:"",count:1}].reverse().map(a).reverse();let r=0;for(let a=e.length-1;a>=0;a--)r+=i[l.findIndex(({name:t})=>t===e[a])]*(n%t[a]),n=Math.floor(n/t[a]);return r}e.isXAxis=r,e.isYAxis=o,e.parseGridCoverage=function(e){const{width:a,height:i,extent:f,dimensions:p}=function(e){const{axes:t}=e.domain,a=Object.keys(t),s=[],i=[];let u=-1,c=-1,d=[];for(let e=0;e<a.length;e++){const n=a[e];r(n)?u=e:o(n)&&(c=e);const l=t[n],m=[];if("values"in l){l.values.forEach(e=>m.push("string"==typeof e?new Date(e).getTime():e));const e=m[1]-m[0];s.push([m[0]-.5*e,m[m.length-1]+.5*e]),i.push(e)}else{const{start:e,stop:t,num:n}=l,a=(t-e)/(n-1);s.push([e-.5*a,t+.5*a]),i.push(a);for(let t=0;t<n;t++)m.push(e+a*t)}d.push({name:n,values:m,extent:[m[0],m[m.length-1]]})}u>-1&&-1===c?c=0===u?1:0:c>-1&&-1===u?u=0===c?1:0:-1===c&&-1===u&&(u=0,c=1),d=d.filter((e,t)=>!(t===u||t===c));const{referencing:m}=e.domain,f=m.find(e=>e.coordinates.includes(a[u])).system.id,p=f?.slice(f.lastIndexOf("/")+1),g=null==p||"CRS84"===p?4326:Number(p),h=new l({wkid:g}),[b,y]=s[u],[x,v]=s[c],T=new n({xmin:b,xmax:y,ymin:x,ymax:v,spatialReference:h});return{width:Math.round(T.width/i[u]),height:Math.round(T.height/i[c]),extent:T,dimensions:d}}(e),{ranges:g}=e,h=Object.keys(g).sort((e,t)=>e<t?-1:1),b=[];for(let e=0;e<h.length;e++){const t=h[e];p?.length&&b.push({name:t,dimensions:p})}const y=function(e){const n={},{parameters:l}=e;if(!l)return n;for(const[e,a]of Object.entries(l)){const{type:l,description:s,unit:i,categoryEncoding:r,observedProperty:o}=a;if("Parameter"===l&&(n[e]={},s&&(n[e].description=u(s)),i&&(n[e].unit=i.label?u(i.label):null,n[e].symbol=i.symbol?.value),r)){const l=Object.entries(r).map((e,t)=>({OID:t,Value:Number(e[1]),ClassName:e[0].slice(e[0].lastIndexOf("/")+1),Count:1}));let a=!1;o?.categories?.length&&(o.categories.forEach(e=>{if(!e.id)return;const n=e.id.slice(e.id.lastIndexOf("/")+1),s=l.find(e=>e.ClassName===n);if(!s)return;const i=e.label?u(e.label):null;if(s.Label=i,e.preferredColor){const n=t.fromHex(e.preferredColor);n&&(a=!0,s.Red=n.r,s.Green=n.g,s.Blue=n.b)}}),a&&l.forEach(e=>{null==e.Red&&(e.Red=c(),e.Green=c(),e.Blue=c())}));const s={objectIdFieldName:"",fields:[{name:"OID",type:"esriFieldTypeOID",alias:"OID",domain:null},{name:"Value",type:"esriFieldTypeInteger",alias:"Value",domain:null},{name:"Count",type:"esriFieldTypeDouble",alias:"Count",domain:null},{name:"ClassName",type:"esriFieldTypeString",alias:"ClassName",domain:null,length:50},{name:"Label",type:"esriFieldTypeString",alias:"Label",domain:null,length:50}],features:l.map(e=>({attributes:e}))};a&&s.fields.push({name:"Red",type:"esriFieldTypeInteger",alias:"Red",domain:null},{name:"Green",type:"esriFieldTypeInteger",alias:"Green",domain:null},{name:"Blue",type:"esriFieldTypeInteger",alias:"Blue",domain:null}),n[e].attributeTable=s}}return n}(e);b.forEach(e=>y[e.name]&&Object.assign(e,y[e.name]));const x=b.length?{variables:b}:void 0,v=[];for(let e=0;e<h.length;e++){const t=h[e],{values:n,dataType:l,axisNames:r,shape:o}=g[t],u=o.length>2?e*o.slice(0,-2).reduce((e,t)=>e*t):0,c=r.slice(0,-2),f=o.slice(0,-2),b="float"===l?"f32":d(n),y=a*i,x=n.length/y;for(let t=0;t<x;t++){const l=s.createEmptyBand(b,y),r=new Uint8Array(y).fill(255);let o=!1;const d=t*y;for(let e=0;e<y;e++){const t=n[d+e];null==t?(r[e]=0,o=!0):l[e]=t}if(0===e||p?.length){const e=new s({width:a,height:i,mask:o?r:null,pixels:[l],pixelType:b});e.updateStatistics(),p?.length?v[m(c,f,t)+u]=e:v.push(e)}else{const e=v[t];e.pixels.push(l),o?e.mask&&(e.mask=s.combineBandMasks([e.mask,r])):e.mask=o?r:null}}}const T=Object.values(y).find(e=>e.attributeTable)?.attributeTable;return{extent:f,pixelBlocks:v,multidimensionalInfo:x,attributeTable:T,bandNames:x?void 0:h}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});