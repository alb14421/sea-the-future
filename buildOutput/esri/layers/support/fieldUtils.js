// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/Error","../../core/object","../../core/SetUtils","../../core/sql","./domainUtils","../../support/arcadeExpressionUtils","../../support/guards","../../support/loadArcade"],function(e,i,n,t,l,r,s,a,o){"use strict";const d=/^([0-9_])/,u=/[^a-z0-9_\u0080-\uffff]+/gi,c=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],f=["field","normalizationField"];function p(e,i,t){if(e)for(const l of e){const e=n.getDeepValue(l,i),r=e&&"function"!=typeof e&&t.get(e);r&&n.setDeepValue(l,r.name,i)}}const m=new Set;function g(e,i){return e&&i?(m.clear(),F(m,e,i),Array.from(m).sort()):[]}function F(e,i,n){if(n)if(i?.fields?.length)if(n.includes("*"))for(const{name:n}of i.fields)e.add(n);else for(const t of n)y(e,i,t);else{if(n.includes("*"))return e.clear(),void e.add("*");for(const i of n)null!=i&&e.add(i)}}function y(e,i,n){if("string"==typeof n)if(i){const t=i.get(n);t&&e.add(t.name)}else e.add(n)}async function I(e,i,n){if(!n)return;let t;const l=s.getFieldNameFromSimpleExpression(n);if(l)t=[l];else{const{arcadeUtils:e}=await o.loadArcade();t=e.extractFieldNames(n,i?.fields?.map(e=>e.name))}for(const n of t)y(e,i,n)}async function b(e,n,t){if(t&&"1=1"!==t){const r=await l.parseWhereClause(t,n);if(!r.isStandardized)throw new i("fieldUtils:collectFilterFields","Where clause is not standardized",{where:t});F(e,n,r.fieldNames)}}function T(e,i){for(const n of e)if(n?.valueType&&n.valueType===i)return n.name;return null}async function x(e,i){if(!i)return;const n=i.elevationInfo?.featureExpressionInfo;return n?n.collectRequiredFields(e,i.fieldsIndex):void 0}async function w(e,i,n){const t=[];n?.expressionInfos&&t.push(...n.expressionInfos.map(n=>I(e,i.fieldsIndex,n.expression)));const l=n?.content;if(Array.isArray(l))for(const n of l)"expression"===n.type&&n.expressionInfo&&t.push(I(e,i.fieldsIndex,n.expressionInfo.expression));await Promise.all(t)}function h(e){if(!e)return[];const i=e.geometryFieldsInfo;return i?g(e.fieldsIndex,[i.shapeAreaField,i.shapeLengthField]):[]}const v=new Set(["oid","global-id","guid"]),S=new Set(["oid","global-id"]),E=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,/^shape$/i,/^shape_$/i,/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/objectid/i,/^perimeter_/i,/_perimeter$/i,/_i$/i];function N(e){const i=new Set;$(e).forEach(e=>i.add(e)),h(e).forEach(e=>i.add(e.toLowerCase()));const n=e&&"infoFor3D"in e?e.infoFor3D:void 0;return n&&(Object.values(n.assetMapFieldRoles).forEach(e=>i.add(e.toLowerCase())),Object.values(n.transformFieldRoles).forEach(e=>i.add(e.toLowerCase()))),Array.from(i)}function A(e){if(!e)return[];const i="editFieldsInfo"in e&&e.editFieldsInfo;if(!i)return[];const{creationDateField:n,creatorField:t,editDateField:l,editorField:r}=i;return[n,t,l,r].filter(Boolean)}function $(e){return A(e).map(e=>e.toLowerCase())}async function D(e,i){const{labelingInfo:n,fieldsIndex:t}=i;n?.length&&await Promise.all(n.map(i=>L(e,t,i)))}async function L(e,i,n){if(!n)return;const t=n.getLabelExpression(),l=n.where;if("arcade"===t.type)await I(e,i,t.expression);else{const n=t.expression.match(/{[^}]*}/g);n&&n.forEach(n=>{y(e,i,n.slice(1,-1))})}await b(e,i,l)}function _(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function R(e){return null===e||_(e)}function V(e){return null===e||Number.isInteger(e)}function M(){return!0}function O(e,i){let n;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"big-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":case"esriFieldTypeBigInteger":n=e.nullable?V:Number.isInteger;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":n=e.nullable?R:_;break;case"string":case"esriFieldTypeString":n=e.nullable?a.isStringOrNull:a.isString;break;default:n=M}return 1===arguments.length?n:n(i)}const k=["integer","small-integer","big-integer","long"],C=["single","double"],j=[...k,...C],z=["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeLong","esriFieldTypeBigInteger"],P=["esriFieldTypeSingle","esriFieldTypeDouble"],U=new Set([...k,...z]),q=new Set([...C,...P]),X=t.union(U,q);function B(e){return null!=e&&X.has(e.type)}function G(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}function J(e,i){return null==e||e.nullable&&null===i?null:O(e,i)?B(e)&&!W(e.type,Number(i))?"numeric-range-validation-error::out-of-range":null:"type-validation-error::invalid-type"}function W(e,i){const n="string"==typeof e?H(e):e;if(!n)return!1;const t=n.min,l=n.max;return n.isInteger?Number.isInteger(i)&&i>=t&&i<=l:i>=t&&i<=l}function H(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return Q;case"esriFieldTypeInteger":case"esriFieldTypeLong":case"integer":case"long":return K;case"esriFieldTypeBigInteger":case"big-integer":return Y;case"esriFieldTypeSingle":case"single":return Z;case"esriFieldTypeDouble":case"double":return ee}}const Q={min:-32768,max:32767,isInteger:!0,rawMin:-32768,rawMax:32767},K={min:-2147483648,max:2147483647,isInteger:!0,rawMin:-2147483648,rawMax:2147483647},Y={min:-Number.MAX_SAFE_INTEGER,max:Number.MAX_SAFE_INTEGER,isInteger:!0,rawMin:-Number.MAX_SAFE_INTEGER,rawMax:Number.MAX_SAFE_INTEGER},Z={min:-34e37,max:12e37,isInteger:!1,rawMin:-34e37,rawMax:12e37},ee={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1,rawMin:-Number.MAX_VALUE,rawMax:Number.MAX_VALUE};function ie(e,i,n){if(!e?.attributes||!i){if(null!=n)for(const e of i??[])n.add(e);return!0}const t=new Set(Object.keys(e.attributes));let l=!1;for(const e of i)if(!t.has(e)){if(l=!0,null==n)break;n.add(e)}return l}e.bigIntegerRange=Y,e.collectArcadeFieldNames=I,e.collectDisplayFilterFields=async function(e,i,n){if(!i||!n)return;const t=i.fieldsIndex;await Promise.all(n.filters.map(i=>b(e,t,i.where)))},e.collectElevationFields=x,e.collectFeatureReductionFields=async function(e,i,n){if(!i||!n||!("fields"in n))return;const t=[],l=n.popupTemplate;t.push(w(e,i,l)),n.fields&&t.push(...n.fields.map(async n=>function(e,i,n){n.onStatisticExpression?I(e,i,n.onStatisticExpression.expression):e.add(n.onStatisticField)}(e,i.fieldsIndex,n))),await Promise.all(t)},e.collectField=y,e.collectFields=F,e.collectFilterFields=async function(e,i,n){i&&(i.timeInfo&&n?.timeExtent&&F(e,i.fieldsIndex,[i.timeInfo.startField,i.timeInfo.endField]),i.floorInfo&&F(e,i.fieldsIndex,[i.floorInfo.floorField]),null!=n?.where&&await b(e,i.fieldsIndex,n.where))},e.collectLabelingFields=D,e.collectOrderByInfos=async function(e,i,n){i&&n&&await Promise.all(n.map(n=>async function(e,i,n){i&&n&&(n.valueExpression?await I(e,i.fieldsIndex,n.valueExpression):n.field&&y(e,i.fieldsIndex,n.field))}(e,i,n)))},e.collectPopupTemplateFields=w,e.collectSQLFieldNames=b,e.collectTrackInfoFields=async function(e,i){const{fieldsIndex:n,trackInfo:t}=i;if(!i||!t||!n)return;const l=[t.latestObservations.renderer?.collectRequiredFields(e,n),t.previousObservations.renderer?.collectRequiredFields(e,n),t.trackLines.renderer?.collectRequiredFields(e,n)];t.popupTemplate&&l.push(w(e,i,t.popupTemplate));for(const i of[t.latestObservations.labelingInfo,t.previousObservations.labelingInfo,t.trackLines.labelingInfo])if(i)for(const t of i)l.push(L(e,n,t));await Promise.all(l)},e.doubleRange=ee,e.extractSubstitutionTemplatesFromString=function(e){const i=e?.match(/{[^}]+}/g);return i?i.map(e=>e.slice(1,-1).split(":")[0].trim()):[]},e.featureHasFields=function(e,i){return!ie(e,i,null)},e.fixFields=g,e.fixRendererFields=function(e,i){if(null!=e&&null!=i)for(const n of Array.isArray(e)?e:[e])if(p(c,n,i),"visualVariables"in n&&n.visualVariables)for(const e of n.visualVariables)p(f,e,i)},e.fixTimeInfoFields=function(e,i){if(null!=e&&i?.fields?.length)if("startField"in e){const n=i.get(e.startField),t=i.get(e.endField);e.startField=n?.name??null,e.endField=t?.name??null}else{const n=i.get(e.startTimeField),t=i.get(e.endTimeField);e.startTimeField=n?.name??null,e.endTimeField=t?.name??null}},e.floatJSONTypes=P,e.floatTypes=C,e.getDisplayFieldName=function({displayField:e,fields:i}){return e||(i?.length?T(i,"name-or-title")||T(i,"unique-identifier")||T(i,"type-or-category")||function(e){for(const i of e){if(!i?.name)continue;const e=i.name.toLowerCase();if(e.includes("name")||e.includes("title"))return i.name}return null}(i):null)},e.getEditTrackingFields=A,e.getElevationFields=async function(e){if(!e)return[];const i=new Set;return await x(i,e),Array.from(i).sort()},e.getExpressionFields=async function(e,i){const n=new Set;for(const t of i)await I(n,e.fieldsIndex,t);return Array.from(n).sort()},e.getFeatureEditFields=function(e){return e?g(e.fieldsIndex,A(e)):[]},e.getFeatureGeometryFields=h,e.getFieldDefaultLength=function(e){const i="string"==typeof e?{type:e}:e;return G(i)?255:"esriFieldTypeDate"===i.type||"date"===i.type?8:void 0},e.getFieldDefaultValue=function(e){const i=e.defaultValue;return void 0!==i&&O(e,i)?i:e.nullable?null:void 0},e.getFieldRange=function(e,i){return r.getDomainRange(e,i)||(B(e)?H(e.type):void 0)},e.getLabelingFields=async function(e){if(!e)return[];const i=new Set;return await D(i,e),Array.from(i).sort()},e.getLowerCaseDefaultHiddenFields=N,e.getLowerCaseEditTrackingFields=$,e.getNumericTypeForValue=function(e){if(!_(e))return null;if(Number.isInteger(e)){if(e>=Q.min&&e<=Q.max)return"esriFieldTypeSmallInteger";if(e>=K.min&&e<=K.max)return"esriFieldTypeInteger";if(e>=Y.min&&e<=Y.max)return"esriFieldTypeBigInteger"}return e>=Z.min&&e<=Z.max?"esriFieldTypeSingle":"esriFieldTypeDouble"},e.getRendererFields=async function(e,i){const n=new Set;return e?.collectRequiredFields&&await e.collectRequiredFields(n,i),Array.from(n).sort()},e.getTimeFields=async function(e){if(!e)return[];const i="timeInfo"in e&&e.timeInfo;return i?g(e.fieldsIndex,[e.trackIdField,i.startField,i.endField]):[]},e.integerJSONTypes=z,e.integerRange=K,e.integerTypes=k,e.isDateField=function(e){return null!=e&&("date"===e.type||"esriFieldTypeDate"===e.type)},e.isDateOnlyField=function(e){return null!=e&&("date-only"===e.type||"esriFieldTypeDateOnly"===e.type)},e.isFieldEditable=function(e,i){return e.editable&&!v.has(e.type)&&!$(i).includes(e.name?.toLowerCase()??"")},e.isFieldVisibleByDefault=function(e,i){const n=e.name?.toLowerCase()??"";return!(null!=i?.objectIdField&&n===i.objectIdField.toLowerCase()||null!=i?.globalIdField&&n===i.globalIdField.toLowerCase()||N(i).includes(n)||S.has(e.type)||E.some(e=>e.test(n)))},e.isGlobalIDField=function(e){return null!=e&&("global-id"===e.type||"esriFieldTypeGlobalID"===e.type)},e.isIntegerField=function(e){return null!=e&&U.has(e.type)},e.isNumberInRange=W,e.isNumericField=B,e.isObjectIDField=function(e){return null!=e&&("oid"===e.type||"esriFieldTypeOID"===e.type)},e.isRasterPixelValueField=function(e){return!!e&&["raster.itempixelvalue","raster.servicepixelvalue"].some(i=>e.toLowerCase().startsWith(i))},e.isStringField=G,e.isTimeOnlyField=function(e){return null!=e&&("time-only"===e.type||"esriFieldTypeTimeOnly"===e.type)},e.isTimestampOffsetField=function(e){return null!=e&&("timestamp-offset"===e.type||"esriFieldTypeTimestampOffset"===e.type)},e.isValidFieldValue=function(e,i){return null===J(e,i)},e.isValueMatchingFieldType=O,e.normalizeFieldName=function(e){return null==e?null:e.trim().replaceAll(u,"_").replace(d,"F$1")||null},e.numericTypes=j,e.packFields=function(e,i,n=1){if(!i||!e)return[];if(i.includes("*"))return["*"];const t=g(e,i);return t.length/e.fields.length>=n?["*"]:t},e.populateMissingFields=ie,e.rendererFields=c,e.sanitizeNullFieldValue=function(e){return null==e||"number"==typeof e&&isNaN(e)?null:e},e.singleRange=Z,e.smallIntegerRange=Q,e.unpackFieldNames=function(e,i){return null==i||null==e?[]:i.includes("*")?(e.fields??[]).map(e=>e.name):i},e.validateFieldValue=J,e.validationErrorToString=function(e,i,n){switch(e){case"domain-validation-error::invalid-coded-value":return`Value ${n} is not in the coded domain - field: ${i.name}, domain: ${JSON.stringify(i.domain)}`;case"domain-validation-error::value-out-of-range":return`Value ${n} is out of the range of valid values - field: ${i.name}, domain: ${JSON.stringify(i.domain)}`;case"type-validation-error::invalid-type":return`Value ${n} is not a valid value for the field type - field: ${i.name}, type: ${i.type}, nullable: ${i.nullable}`;case"numeric-range-validation-error::out-of-range":{const{min:e,max:t}=H(i.type);return`Value ${n} is out of range for the number type - field: ${i.name}, type: ${i.type}, value range is ${e} to ${t}`}}},e.visualVariableFields=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});