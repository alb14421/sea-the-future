// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/unitUtils","../../../geometry/Extent","../../../geometry/Point","../PixelBlock"],function(e,t,n,i,a,r){"use strict";function o(e){const{geometry:t,size:n,srcExtent:i,srcMask:a}=e,[r,o]=n;let h;const x=i.width/r,s=i.height/o,{xmin:m,ymax:l}=i;if("extent"===t.type){const e=(t.xmin-m)/x,n=(t.xmax-m)/x,i=(l-t.ymax)/s,a=(l-t.ymin)/s;h=[[[e,i],[e,a],[n,a],[n,i],[e,i]]]}else h=t.rings.map(e=>e.map(([e,t])=>[(e-m)/x,(l-t)/s]));return function(e,t,n){const[i,a]=t,r=new OffscreenCanvas(i,a).getContext("2d");r.fillStyle="#f00",r.beginPath(),e.forEach(e=>{r.moveTo(e[0][0],e[0][1]);for(let t=0;t<e.length;t++)r.lineTo(e[t][0],e[t][1]);r.closePath()}),r.fill();const o=r.getImageData(0,0,i,a).data,h=i*a,x=new Uint8Array(h);let s=!1;for(let e=0;e<h;e++)n&&!n[e]||(o[4*e+3]>127?x[e]=255:s=!0);return s||n?x:void 0}(h,n,a)}function h(e,t,a,r=!0){const{spatialReference:o}=e,{x:h,y:x}=function(e,t){if(e.spatialReference.equals(t))return e;const i=n.getMetersPerUnitForSR(e.spatialReference),a=n.getMetersPerUnitForSR(t);if(i===a)return e;const r=i/a;return{x:e.x*r,y:e.y*r}}(a,o);let s,m,l;const p="extent"===t.type?t:t.extent;let{xmin:c,xmax:y,ymax:f,ymin:M}=p;const{xmin:u,ymax:w}=e.extent;return r?(c=u+(c>u?h*Math.round((c-u)/h):0),f=w-(f<w?x*Math.round((w-f)/x):0),y=u+(y>u?h*Math.round((y-u)/h):0),M=w-(M<w?x*Math.round((w-M)/x):0),s=new i({xmin:c,ymax:f,xmax:y,ymin:M,spatialReference:o}),m=Math.round(s.width/h),l=Math.round(s.height/x)):(m=Math.floor((y-c)/h+.8),l=Math.floor((f-M)/x+.8),c=u+(c>u?h*Math.floor((c-u)/h+.1):0),f=w-(f<w?x*Math.floor((w-f)/x+.1):0),y=c+m*h,M=f-l*x,s=new i({xmin:c,ymax:f,xmax:y,ymin:M,spatialReference:o})),{extent:s,width:m,height:l}}t.clip=async function(t,n,i){if("extent"===i.type)return function(e,t,n){const{width:i,height:a}=e,o=new Uint8Array(i*a),h=t.width/i,x=t.height/a;if(n.width/h<.5||n.height/x<.5)return new r({pixelType:e.pixelType,width:i,height:a,mask:o,pixels:[...e.pixels]});const{xmin:s,xmax:m,ymin:l,ymax:p}=t,{xmin:c,xmax:y,ymin:f,ymax:M}=n,u=Math.max(s,c),w=Math.min(m,y),d=Math.max(l,f),g=Math.min(p,M),T=.5*h,k=.5*x;if(w-u<T||g-d<k||w<s+T||u>m-T||d>p-k||g<l+k)return new r({pixelType:e.pixelType,width:i,height:a,mask:o,pixels:[...e.pixels]});const R=Math.max(0,(u-s)/h),P=Math.min(i,Math.max(0,(w-s)/h)),S=Math.max(0,(p-g)/x),U=Math.min(a,Math.max(0,(p-d)/x)),A=Math.round(R),v=Math.round(P)-1,z=Math.round(S),E=Math.round(U)-1;if(A===v&&R%1>.5&&P%1<.5||z===E&&S%1>.5&&U%1<.5)return new r({pixelType:e.pixelType,width:i,height:a,mask:o,pixels:[...e.pixels]});if(0===A&&0===z&&v===i&&E===a)return e;const I=e.mask;for(let e=z;e<=E;e++)for(let t=A;t<=v;t++){const n=e*i+t;o[n]=I?I[n]:255}return new r({pixelType:e.pixelType,width:i,height:a,mask:o,pixels:[...e.pixels]})}(t,n,i);const{width:a,height:h}=t,x=new Uint8Array(a*h);return(await new Promise((t,n)=>e(["../../../geometry/operators/intersectsOperator"],t,n))).execute(n,i)?"polyline"===i.type?function(e,t,n){const{width:i,height:a}=e,o=new Uint8Array(i*a),h=t.width/i,x=t.height/a,{xmin:s,ymax:m}=t,{paths:l}=n,p=e.mask;for(let e=0;e<l.length;e++){const t=l[e];for(let e=0;e<t.length-1;e++){const[n,r]=t[e],[l,c]=t[e+1],y=Math.min(r,c),f=Math.max(r,c),M=Math.max(0,Math.floor((m-f)/x)),u=Math.min(a-1,Math.floor((m-y)/x));if(!(u<M))if(M===u){const e=Math.min(n,l),t=Math.max(n,l),a=Math.max(0,Math.floor((e-s)/h)),r=Math.min(i-1,Math.floor((t-s)/h));if(r<a)continue;const x=M*i;for(let e=x+a;e<=x+r;e++)o[e]=p?p[e]:255}else{const e=(n-s)/h,t=(l-n)/(c-r)/h,a=x*t;for(let n=M;n<=u;n++){const h=t*(m-n*x-r)+e,s=Math.max(0,Math.floor(a>0?h-a:h)),l=Math.min(i-1,Math.floor(a>0?h:h-a));if(l<s)continue;const c=n*i;for(let e=c+s;e<=c+l;e++)o[e]=p?p[e]:255}}}}return new r({pixelType:e.pixelType,width:i,height:a,mask:o,pixels:[...e.pixels]})}(t,n,i):(await new Promise((t,n)=>e(["../../../geometry/operators/containsOperator"],t,n))).execute(i,n)?t:function(e,t,n){if(!e)return e;const{width:i,height:a}=e,h=o({geometry:n,size:[i,a],srcExtent:t,srcMask:e.mask});return new r({pixelType:e.pixelType,width:i,height:a,mask:h,maskIsAlpha:!1,pixels:[...e.pixels]})}(t,n,i):new r({pixelType:t.pixelType,width:a,height:h,mask:x,maskIsAlpha:!1,pixels:[...t.pixels]})},t.clipRasterInfo=function(e,t){const{extent:n}=h(e,t,new a({x:e.pixelSize.x,y:e.pixelSize.y,spatialReference:e.spatialReference})),{extent:i}=e.extent;if(n.xmax=Math.min(n.xmax,i.xmax),n.ymax=Math.min(n.ymax,i.ymax),n.xmin<n.xmax&&n.ymin<n.ymax){const{x:t,y:i}=e.pixelSize,a=Math.round(n.width/t),r=Math.round(n.height/i);e.extent=n,e.width=a,e.height=r}},t.convertGeometryToMask=o,t.snapToRaster=h,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});