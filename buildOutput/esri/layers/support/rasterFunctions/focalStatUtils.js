// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/has","../../../core/jsonMap","../PixelBlock","./mirror"],function(t,e,o,n,s){"use strict";const i=new o.JSONMap({1:"min",2:"max",3:"mean",4:"stddev",5:"median",6:"majority",7:"minority"},{useNumericKeys:!0});function r(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:i,mask:r,outBand:l}=t;if(o&&!r)return void l.set(n);const{statisticsType:a,kernelRows:c,kernelCols:f}=e,h="stddev"===a,u=s*i,d=new Float64Array(u),m=new Float64Array(u),y=new Uint32Array(u);for(let t=0;t<i;t++){const e=t*s;let o=0,i=0,l=0;for(let t=0;t<f;t++)r&&!r[e+t]||(o+=n[e+t],h&&(i+=n[e+t]**2),l++);d[e]=o,m[e]=i,y[e]=l;for(let t=1;t<=s-f;t++){const s=e+t-1,a=s+f;r?(r[s]&&(l--,o-=n[s],h&&(i-=n[s]**2)),r[a]&&(l++,o+=n[a],h&&(i+=n[a]**2))):(o-=n[s],o+=n[a],h&&(i-=n[s]**2,i+=n[a]**2)),d[e+t]=o,y[e+t]=l,h&&(m[e+t]=i)}}const k=new Float64Array(u),p=new Float64Array(u),w=new Uint32Array(u),M=c*s;for(let t=0;t<=s-f;t++){let e=0,o=0,n=0;for(let i=0;i<c;i++){const r=i*s+t;e+=d[r],n+=y[r],h&&(o+=m[r])}k[t]=e,p[t]=o,w[t]=n;for(let r=1;r<=i-c;r++){const i=(r-1)*s+t,l=i+M;e-=d[i],e+=d[l],n-=y[i],n+=y[l],h&&(o-=m[i],o+=m[l]),k[r*s+t]=e,p[r*s+t]=o,w[r*s+t]=n}}const g=Math.floor(c/2),b=Math.floor(f/2);for(let t=g;t<i-g;t++){const e=t*s;for(let n=b;n<s-b;n++){const i=(t-g)*s+n-b,a=w[i];if(0===a||o&&(!r||r[e+n]))continue;const c=k[i]/a,f=h?Math.sqrt((p[i]-k[i]*c)/a):c;l[e+n]=f,r&&(r[e+n]=255)}}}function l(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:i,mask:r,outBand:l}=t;if(o&&!r)return void l.set(n);const{kernelRows:a,kernelCols:c,statisticsType:f}=e,h=Math.floor(a/2),u=Math.floor(c/2),d="min"===f,m=l.slice(),y=new Uint32Array(s*i);for(let t=h;t<i-h;t++){const e=t*s;for(let t=u;t<s-u;t++){let o=d?Number.MAX_VALUE:-Number.MAX_VALUE,i=0;for(let l=0;l<a;l++)for(let a=0;a<c;a++){const c=e+t+(l-h)*s+a-u;r&&!r[c]||(o=d?Math.min(o,n[c]):Math.max(o,n[c]),i++)}r?(m[e+t]=0===i?0:o,y[e+t]=i):l[e+t]=0===i?0:o}}if(r)for(let t=h;t<i-h;t++){const e=t*s;for(let t=u;t<s-u;t++)if(y[e+t]){if(o&&r[e+t])continue;l[e+t]=m[e+t],r[e+t]=255}}}function a(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:i,mask:r,outBand:l}=t;if(o&&!r)return void l.set(n);const{kernelRows:a,kernelCols:c}=e,f=Math.floor(a/2),h=Math.floor(c/2),u=l.slice(),d=new Uint32Array(s*i);for(let t=f;t<i-f;t++){const e=t*s;for(let t=h;t<s-h;t++){if(o&&r?.[e+t])continue;const i=[];for(let o=0;o<a;o++)for(let l=0;l<c;l++){const a=e+t+(o-f)*s+l-h;r&&!r[a]||i.push(n[a])}i.length&&(i.sort((t,e)=>t-e),r?(u[e+t]=i[Math.floor((i.length-1)/2)],d[e+t]=i.length):l[e+t]=i[Math.floor((i.length-1)/2)])}}if(r)for(let t=f;t<i-f;t++){const e=t*s;for(let t=h;t<s-h;t++)if(d[e+t]){if(o&&r[e+t])continue;l[e+t]=u[e+t],r[e+t]=255}}}function c(t,e){const{fillNoDataOnly:o}=e,{band:n,width:s,height:i,mask:r,outBand:l}=t;if(o&&!r)return void l.set(n);const{kernelRows:a,kernelCols:c}=e,f=Math.floor(a/2),h=Math.floor(c/2),u="majority"===e.statisticsType,d=a*c,m=l.slice(),y=new Uint32Array(s*i);for(let t=f;t<i-f;t++){const e=t*s;for(let t=h;t<s-h;t++){if(o&&r?.[e+t])continue;const i=new Map;for(let o=0;o<a;o++)for(let l=0;l<c;l++){const a=e+t+(o-f)*s+l-h;if(r&&!r[a])continue;const c=n[a];i.set(c,i.has(c)?i.get(c)+1:1)}if(0===i.size)continue;let k=0,p=0,w=u?0:d+1;for(const t of i.keys())p=i.get(t),u===p>w&&(w=p,k=t);r?(m[e+t]=k,y[e+t]=i.size):l[e+t]=k}}if(r)for(let t=f;t<i-f;t++){const e=t*s;for(let t=h;t<s-h;t++)if(y[e+t]){if(o&&r[e+t])continue;l[e+t]=m[e+t],r[e+t]=255}}}t.computeFocalStatistics=function(t,e){const{mask:o}=t,{fillNoDataOnly:i}=e;if(i&&!o)return t;const{pixels:f,width:h,height:u,bandMasks:d,pixelType:m}=t,y=f.length,k=h*u,p=[],{kernelRows:w,kernelCols:M,statisticsType:g,mirrorEdges:b}=e;if(i&&!o)return t;const A=e.outputPixelType??m,x=[];for(let t=0;t<y;t++){const m=f[t],y=n.createEmptyBand(A,k);i&&y.set(m);const N=d?.[t]??o,T=N?.slice()??null,v={band:m,width:h,height:u,mask:T,outBand:y};switch(g){case"min":case"max":l(v,e);break;case"mean":case"stddev":r(v,e);break;case"median":a(v,e);break;case"majority":case"minority":c(v,e)}b&&!i&&s.mirror(y,h,u,w,M),p.push(y),T&&x.push(T)}let N=x[0]??o;x.length!==y&&(x.length=0),y>1&&d?.length&&(N=n.combineBandMasks(d));const T=new n({pixelType:A,width:h,height:u,pixels:p,bandMasks:d&&x.length?x:null,mask:N});return T.updateStatistics(),T},t.statisticsTypeMap=i,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});