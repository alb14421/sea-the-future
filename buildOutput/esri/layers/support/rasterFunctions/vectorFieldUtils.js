// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/jsonMap","../PixelBlock","./pixelUtils"],function(t,e,n,r){"use strict";const o=new Map;o.set("meter-per-second",1),o.set("kilometer-per-hour",.277778),o.set("knots",.514444),o.set("feet-per-second",.3048),o.set("mile-per-hour",.44704);const i=180/Math.PI,a=new e.JSONMap({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function s(t,e){return o.get(t)/o.get(e)||1}function l(t){return(450-t)%360}function c(t,e="geographic"){const[n,r]=t,o=Math.sqrt(n*n+r*r);let a=Math.atan2(r,n)*i;return a=(360+a)%360,"geographic"===e&&(a=l(a)),[o,a]}function h(t,e="geographic"){let n=t[1];"geographic"===e&&(n=l(n)),n%=360;const r=t[0];return[r*Math.cos(n/i),r*Math.sin(n/i)]}function u(t,e,o="geographic",i=1){if(!r.isValidPixelBlock(t))return t;const{pixels:a,width:s,height:l}=t,u=s*l,f=a[0],p=a[1],m=t.pixelType.startsWith("f")?t.pixelType:"f32",d=n.createEmptyBand(m,u),g=n.createEmptyBand(m,u);let M=0;for(let t=0;t<l;t++)for(let t=0;t<s;t++)"vector-uv"===e?([d[M],g[M]]=c([f[M],p[M]],o),d[M]*=i):([d[M],g[M]]=h([f[M],p[M]],o),d[M]*=i,g[M]*=i),M++;const x=new n({pixelType:m,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[d,g]});return x.updateStatistics(),x}const f=p(0,0,0);function p(t=0,e=0,n=Math.PI,r=!0){r&&(n=(2*Math.PI-n)%(2*Math.PI));const o=r?-1:1,i=13*o,a=-7*o,s=-2*o,l=-16*o,c=21.75,[h,u]=d(0,e+i,n,c),[f,p]=d(t-5.5,e+a,n,c),[m,g]=d(t+5.5,e+a,n,c),[M,x]=d(t-1.5,e+s,n,c),[k,w]=d(t+1.5,e+s,n,c),[y,P]=d(t-1.5,e+l,n,c),[b,v]=d(t+1.5,e+l,n,c);return[h,u,f,p,M,x,k,w,m,g,y,P,b,v]}function m(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const r=n?-1:1,o=5*r,i=20*r,a=25*r,s=45,l=2*r,c=n?1:-1,h=5*c;let[u,f]=[0+h,0-i],[p,m]=[u+2*c,f],[g,M]=[p-0*c,m+l],[x,k]=[0-h,0-a],[w,y]=[x+0*c,k-l],P=Math.ceil(t/5),b=Math.floor(P/10);P-=8*b;const v=[],I=[];for(let t=0;t<P/2;t++,b--){b<=0&&P%2==1&&t===(P-1)/2&&(x=0,w=x+0*c,k=(k+f)/2,y=k-l);const[n,r]=d(x,k,e,s);if(b>0){const[t,o]=d(p,k,e,s),[i,a]=d(u,f,e,s);v.push(t),v.push(o),v.push(n),v.push(r),v.push(i),v.push(a)}else{const[t,o]=d(p,m,e,s),[i,a]=d(g,M,e,s),[l,c]=d(w,y,e,s);I.push(n),I.push(r),I.push(l),I.push(c),I.push(i),I.push(a),I.push(t),I.push(o)}k+=o,f+=o,m+=o,M+=o,y+=o}const[S,A]=d(0+h,0+i,e,s),_=7*c,[F,U]=d(0+_,0+i,e,s),[D,V]=d(0+h,0-a,e,s),[T,B]=d(0+_,0-a,e,s);return{pennants:v,barbs:I,shaft:[S,A,F,U,D,V,T,B]}}function d(t,e,n,r=1){const o=Math.sqrt(t*t+e*e)/r,i=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[o,(2*Math.PI+i-n)%(2*Math.PI)]}const g=[0,1,3,6,10,16,21,27,33,40,47,55,63],M=[0,.5,1,1.5,2],x=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function k(t,e,n,r){const o=s(r||"knots",n);let i;for(i=1;i<e.length;i++)if(i===e.length-1){if(t<e[i]*o)break}else if(t<=e[i]*o)break;return Math.min(i-1,e.length-2)}function w(t,e,n,r,o){let i=0;switch(e){case"beaufort_kn":i=k(t,g,"knots",n);break;case"beaufort_km":i=k(t,g,"kilometer-per-hour",n);break;case"beaufort_ft":i=k(t,g,"feet-per-second",n);break;case"beaufort_m":i=k(t,g,"meter-per-second",n);break;case"classified_arrow":i=k(t,o??[],r,n);break;case"ocean_current_m":i=k(t,M,"meter-per-second",n);break;case"ocean_current_kn":i=k(t,x,"knots",n)}return i}const y=[];function P(t,e){let n=0,r=0;const{width:o,height:i,mask:l}=t,c=t.pixels[0],h=[],u=[],f=s(a.fromJSON(e.inputUnit),"knots"),p="wind_speed"===e.style?5:Number.MAX_VALUE;for(let t=0;t<i;t++)for(let e=0;e<o;e++){const a=c[t*o+e]*f;if((!l||l[t*o+e])&&a<p){for(let r=0;r<4;r++)h[n++]=(e+.5)/o,h[n++]=(t+.5)/i,h[n++]=r<2?-.5:.5,h[n++]=r%2==0?-.5:.5,h[n++]=0,h[n++]=a;const s=4*(n/24-1);u[r++]=s,u[r++]=s+1,u[r++]=s+2,u[r++]=s+1,u[r++]=s+2,u[r++]=s+3}}return{vertexData:new Float32Array(h),indexData:new Uint32Array(u)}}t.convertToLocalDirections=function(t,e,n,o="geographic"){if(!r.isValidPixelBlock(t)||null==n)return t;const i="vector-magdir"===e?t.clone():u(t,e),a=i.pixels[1];for(let t=0;t<a.length;t++)a[t]="geographic"===o?(a[t]+n[t]+270)%360:(a[t]+360-n[t])%360;return"vector-magdir"===e?i:u(i,"vector-magdir")},t.convertVectorFieldData=u,t.convertVectorFieldUnit=function(t,e,n=1){if(1===n||!r.isValidPixelBlock(t))return t;const o=t.clone(),{pixels:i,width:a,height:s}=o,l=i[0],c=i[1];let h=0;for(let t=0;t<s;t++)for(let t=0;t<a;t++)"vector-uv"===e?(l[h]*=n,c[h]*=n):l[h]*=n,h++;return o.updateStatistics(),o},t.createVFMesh=function(t,e){return"simple_scalar"===e.style?P(t,e):"wind_speed"===e.style?function(t,e){if(0===y.length)for(let t=0;t<30;t++)y.push(m(5*t,0,!e.invertDirection));const n=s(a.fromJSON(e.inputUnit),"knots"),{width:r,height:o,mask:i}=t,l=t.pixels[0],c=t.pixels[1],h=[],u=[];let f=0,p=0;for(let t=0;t<o;t++)for(let e=0;e<r;e++){const a=t*r+e,s=l[a]*n;if((!i||i[t*r+e])&&s>=5){const n=(c[a]+360)%360/180*Math.PI,{pennants:i,barbs:l,shaft:m}=y[Math.min(Math.floor(s/5),29)];if(i.length+l.length===0)continue;let d=h.length/6;const g=(e+.5)/r,M=(t+.5)/o;for(let t=0;t<i.length;t+=2)h[f++]=g,h[f++]=M,h[f++]=i[t],h[f++]=i[t+1]+n,h[f++]=0,h[f++]=s;for(let t=0;t<l.length;t+=2)h[f++]=g,h[f++]=M,h[f++]=l[t],h[f++]=l[t+1]+n,h[f++]=0,h[f++]=s;for(let t=0;t<m.length;t+=2)h[f++]=g,h[f++]=M,h[f++]=m[t],h[f++]=m[t+1]+n,h[f++]=0,h[f++]=s;for(let t=0;t<i.length/6;t++)u[p++]=d,u[p++]=d+1,u[p++]=d+2,d+=3;for(let t=0;t<l.length/8;t++)u[p++]=d,u[p++]=d+1,u[p++]=d+2,u[p++]=d+1,u[p++]=d+2,u[p++]=d+3,d+=4;u[p++]=d+0,u[p++]=d+1,u[p++]=d+2,u[p++]=d+1,u[p++]=d+3,u[p++]=d+2,d+=4}}return{vertexData:new Float32Array(h),indexData:new Uint32Array(u)}}(t,e):function(t,e){const{style:n,inputUnit:r,outputUnit:o,breakValues:i}=e,s=a.fromJSON(r),l=a.fromJSON(o);let c=0,h=0;const{width:u,height:m,mask:d}=t,g=t.pixels[0],M=t.pixels[1],x=null!=d?d.filter(t=>t>0).length:u*m,k=new Float32Array(42*x),y=new Uint32Array(15*x),P=e.invertDirection?p(0,0,0,!1):f;for(let t=0;t<m;t++)for(let e=0;e<u;e++){const r=t*u+e;if(!d||d[t*u+e]){const o=(M[r]+360)%360/180*Math.PI,a=w(g[r],n,s,l,i);for(let n=0;n<P.length;n+=2)k[c++]=(e+.5)/u,k[c++]=(t+.5)/m,k[c++]=P[n],k[c++]=P[n+1]+o,k[c++]=a,k[c++]=g[r];const f=7*(c/42-1);y[h++]=f,y[h++]=f+1,y[h++]=f+2,y[h++]=f+0,y[h++]=f+4,y[h++]=f+3,y[h++]=f+0,y[h++]=f+2,y[h++]=f+3,y[h++]=f+2,y[h++]=f+5,y[h++]=f+3,y[h++]=f+5,y[h++]=f+6,y[h++]=f+3}}return{vertexData:k,indexData:y}}(t,e)},t.createVFMeshScalar=P,t.getUnitConversionFactor=s,t.sampleVectorField=function(t,e,r,o=[0,0],i=.5){const{width:a,height:s,mask:l}=t,[u,f]=t.pixels,[p,m]=o,d=Math.round((a-p)/r),g=Math.round((s-m)/r),M=d*g,x=new Float32Array(M),k=new Float32Array(M),w=new Uint8Array(M),y="vector-uv"===e;for(let t=0;t<g;t++)for(let e=0;e<d;e++){let n=0;const o=t*d+e,g=Math.max(0,t*r+m),M=Math.max(0,e*r+p),P=Math.min(s,g+r),b=Math.min(a,M+r);for(let t=g;t<P;t++)for(let e=M;e<b;e++){const r=t*a+e;if(!l||l[r]){n++;const t=y?[u[r],f[r]]:[u[r],(360+f[r])%360],[e,i]=y?t:h(t);x[o]+=e,k[o]+=i}}if(n>=(P-g)*(b-M)*(1-i)){w[o]=1;const[t,e]=c([x[o]/n,k[o]/n]);x[o]=t,k[o]=e}else w[o]=0,x[o]=0,k[o]=0}const P=new n({width:d,height:g,pixels:[x,k],mask:w});return P.updateStatistics(),P},t.snapImageToSymbolTile=function(t,e,n,r,o){if(null==o||!o.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(e/r),height:Math.round(n/r),resolution:t.width/e};const i=o.xmin,a=o.ymax,s=(t.xmax-t.xmin)/e*r,l=(t.ymax-t.ymin)/n*r,c=(s+l)/2;return t.xmin=i+Math.floor((t.xmin-i)/s)*s,t.xmax=i+Math.ceil((t.xmax-i)/s)*s,t.ymin=a+Math.floor((t.ymin-a)/l)*l,t.ymax=a+Math.ceil((t.ymax-a)/l)*l,{extent:t,width:Math.round(t.width/s),height:Math.round(t.height/l),resolution:c}},t.unitKebabDict=a,t.uvComponentToVector=c,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});