// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/Collection","../../core/has","./LayerLoadContext","./lazyLayerLoader","../../portal/PortalItem","../../portal/support/featureCollectionUtils","../../portal/support/portalLayers","../../renderers/support/styleUtils"],function(e,a,r,y,t,L,i,o,n){"use strict";async function l(e,a,r){if(!a)return;const l=a.map(e=>async function(e,a){const r=await async function(e,a){const r=a.context,n=function(e){let a;switch(e.origin){case"web-scene":switch(e.layerContainerType){case"basemap":a=u;break;case"ground":a=s;break;case"tables":a=p;break;default:a=c}break;case"link-chart":switch(e.layerContainerType){case"basemap":a=T;break;case"tables":a=M;break;default:a=g}break;default:switch(e.layerContainerType){case"basemap":a=I;break;case"tables":a=d;break;default:a=S}}return a}(r);let l=e.layerType||e.type;!l&&a?.defaultLayerType&&(l=a.defaultLayerType);const m=n[l];let b=m?t.layerLookupMap[m]:t.layerLookupMap.UnknownLayer;if(f(e)){const a=r?.portal;if(e.itemId){const r=new L({id:e.itemId,portal:a});await r.load();const i=(await o.selectLayerClassPath(r,new y.LayerLoadContext)).className||"UnknownLayer";b=t.layerLookupMap[i]}}else"ArcGISFeatureLayer"===l?i.isMapNotesLayer(e)||i.isMarkupLayer(e)?b=t.layerLookupMap.MapNotesLayer:i.isRouteLayer(e)?b=t.layerLookupMap.RouteLayer:G(e)&&(b=t.layerLookupMap.GroupLayer):e.wmtsInfo?.url&&e.wmtsInfo.layerIdentifier?b=t.layerLookupMap.WMTSLayer:"WFS"===l&&"2.0.0"!==e.wfsInfo?.version&&(b=t.layerLookupMap.UnsupportedLayer);return b()}(e,a);return async function(e,a,r){const y=new e;return y.read(a,r.context),"group"===y.type&&("GroupLayer"===a.layerType?await m(y,a,r):f(a)?function(e,a,r){a.itemId&&(e.portalItem=new L({id:a.itemId,portal:r?.portal}),e.when(()=>{const y=y=>{const t=y.layerId;b(y,e,a,t,r);const L=a.featureCollection?.layers?.[t];L&&y.read(L,r)};e.layers?.forEach(y),e.tables?.forEach(y)}))}(y,a,r.context):G(a)&&await async function(e,a,r){const y=t.layerLookupMap.FeatureLayer,L=await y(),i=a.featureCollection,o=i?.showLegend,n=i?.layers?.map((y,t)=>{const i=new L;i.read(y,r);const n={...r,ignoreDefaults:!0};return b(i,e,a,t,n),null!=o&&i.read({showLegend:o},n),i});e.layers.addMany(n??[])}(y,a,r.context)),await n.loadStyleRenderer(y,r.context),y}(r,e,a)}(e,r)),A=await Promise.allSettled(l);for(const a of A)"rejected"===a.status||a.value&&e.add(a.value)}const c={ArcGISDimensionLayer:"DimensionLayer",ArcGISFeatureLayer:"FeatureLayer",ArcGISImageServiceLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",ArcGISSceneServiceLayer:"SceneLayer",ArcGISTiledElevationServiceLayer:"ElevationLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",BuildingSceneLayer:"BuildingSceneLayer",CatalogLayer:"CatalogLayer",CSV:"CSVLayer",DefaultTileLayer:"TileLayer",GeoJSON:"GeoJSONLayer",GroupLayer:"GroupLayer",IntegratedMesh3DTilesLayer:"IntegratedMesh3DTilesLayer",Object3DTilesLayer:"UnsupportedLayer",IntegratedMeshLayer:"IntegratedMeshLayer",KML:"KMLLayer",LineOfSightLayer:"LineOfSightLayer",MediaLayer:"MediaLayer",OGCFeatureLayer:"OGCFeatureLayer",OrientedImageryLayer:"OrientedImageryLayer",PointCloudLayer:"PointCloudLayer",RasterDataLayer:"UnsupportedLayer",VectorTileLayer:"VectorTileLayer",ViewshedLayer:"ViewshedLayer",Voxel:"VoxelLayer",WCS:"WCSLayer",WFS:"WFSLayer",WMS:"WMSLayer",WebTiledLayer:"WebTileLayer"},s={ArcGISTiledElevationServiceLayer:"ElevationLayer",DefaultTileLayer:"ElevationLayer",RasterDataElevationLayer:"UnsupportedLayer"},p={ArcGISFeatureLayer:"FeatureLayer"},u={ArcGISImageServiceLayer:"UnsupportedLayer",ArcGISMapServiceLayer:"UnsupportedLayer",ArcGISSceneServiceLayer:"SceneLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",DefaultTileLayer:"TileLayer",OpenStreetMap:"OpenStreetMapLayer",VectorTileLayer:"VectorTileLayer",WCS:"UnsupportedLayer",WMS:"UnsupportedLayer",WebTiledLayer:"WebTileLayer"},S={ArcGISAnnotationLayer:"UnsupportedLayer",ArcGISDimensionLayer:"UnsupportedLayer",ArcGISFeatureLayer:"FeatureLayer",ArcGISImageServiceLayer:"ImageryLayer",ArcGISImageServiceVectorLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",ArcGISStreamLayer:"StreamLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",ArcGISVideoLayer:"VideoLayer",BingMapsAerial:"BingMapsLayer",BingMapsHybrid:"BingMapsLayer",BingMapsRoad:"BingMapsLayer",CatalogLayer:"CatalogLayer",CSV:"CSVLayer",DefaultTileLayer:"TileLayer",GeoJSON:"GeoJSONLayer",GeoRSS:"GeoRSSLayer",GroupLayer:"GroupLayer",KML:"KMLLayer",KnowledgeGraphLayer:"KnowledgeGraphLayer",MediaLayer:"MediaLayer",OGCFeatureLayer:"OGCFeatureLayer",OrientedImageryLayer:"OrientedImageryLayer",SubtypeGroupLayer:"SubtypeGroupLayer",VectorTileLayer:"VectorTileLayer",WCS:"WCSLayer",WFS:"WFSLayer",WMS:"WMSLayer",WebTiledLayer:"WebTileLayer"},d={ArcGISFeatureLayer:"FeatureLayer",SubtypeGroupTable:"SubtypeGroupLayer"},I={ArcGISImageServiceLayer:"ImageryLayer",ArcGISImageServiceVectorLayer:"ImageryLayer",ArcGISMapServiceLayer:"MapImageLayer",ArcGISTiledImageServiceLayer:"ImageryTileLayer",ArcGISTiledMapServiceLayer:"TileLayer",BingMapsAerial:"BingMapsLayer",BingMapsHybrid:"BingMapsLayer",BingMapsRoad:"BingMapsLayer",DefaultTileLayer:"TileLayer",OpenStreetMap:"OpenStreetMapLayer",VectorTileLayer:"VectorTileLayer",WCS:"WCSLayer",WMS:"WMSLayer",WebTiledLayer:"WebTileLayer"},g={...S,LinkChartLayer:"LinkChartLayer"},M={...d},T={...I};function G(e){return"ArcGISFeatureLayer"===e.layerType&&!f(e)&&(e.featureCollection?.layers?.length??0)>1}function f(e){return"Feature Collection"===e.type}async function m(e,r,y){const t=new a,L=l(t,Array.isArray(r.layers)?r.layers:[],y);try{try{if(await L,"group"===e.type)return e.layers.addMany(t),e}catch(a){e.destroy();for(const e of t)e.destroy();throw a}}catch(e){throw e}}function b(e,a,r,y,t){e.read({id:`${a.id}-sublayer-${y}`,visibility:r.visibleLayers?.includes(y)??!0},t)}e.populateGroupLayer=m,e.populateOperationalLayers=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});