// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../chunks/tslib.es6","../../core/Accessor","../../core/arrayUtils","../../core/asyncUtils","../../core/Collection","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/subclass","./fieldUtils","../../support/loadArcade"],function(e,t,s,r,i,a,o,l,n,d,c,p,u){"use strict";return t.default=class extends r{constructor(e){super(e),this._featureUtils=null,this.effectivePopupTemplate=null}get _arcadeTask(){return this.expressionsUsedInTitle.length>0?this._get("_arcadeTask")||a.createTask(()=>u.loadArcade()):null}get featureUtilsPromise(){return this._get("featureUtilsPromise")??new Promise((t,s)=>e(["../../widgets/Feature/support/featureUtils"],t,s)).then(e=>this._featureUtils=e)}get calculatedExpressions(){const e=new o;if(!this.expressionsUsedInTitle.length)return e;if(!this._arcadeTask?.value){for(const t of this.expressionsUsedInTitle??[])e.push({name:t.name,invalid:!0});return e}for(const t of this.expressionsUsedInTitle)try{const s=this._arcadeTask.value.arcade.parseScript(t.expression,["$layer","$map","$datastore"]);if(s.isAsync){e.push({name:t.name,invalid:!0});break}e.push({name:t.name,syntax:s,invalid:!1,func:this._arcadeTask.value.arcade.compileScript(s,{vars:{$feature:"any"}})})}catch{e.push({name:t.name,invalid:!0});break}return e}get expressionsUsedInTitle(){let e=this.effectivePopupTemplate?.title??"";return"string"!=typeof e?[]:(e=e.toLowerCase(),this.effectivePopupTemplate?.expressionInfos?.filter(t=>e.includes(`{expression/${t.name.toLowerCase()}}`))??[])}get fieldInfoMap(){return this._featureUtils?this._createFieldInfoMap(this._featureUtils.getAllFieldInfos(this.effectivePopupTemplate)):null}get hasBadExpressions(){return this.calculatedExpressions.some(e=>!0===e.invalid)}get requiredFields(){const e=new Set;if(this._arcadeTask?.value&&!this.hasBadExpressions)for(const t of this.calculatedExpressions?.toArray()??[])try{const s=this._arcadeTask.value.arcade.extractFieldLiterals(t.syntax);for(const t of s){const s=t.split("."),r=this.fieldsIndex.get(s.at(-1)??"");r&&e.add(r.name)}}catch{}const t=this._extractFieldNames(this.workingTitle);for(const s of t){const t=this.fieldsIndex.get(s);t&&e.add(t.name)}return null!=this.objectIdField&&e.add(this.objectIdField),e}get titleFromDisplayField(){let e="";return this.displayField&&(e=this.fieldsIndex.get(this.displayField)?.name??""),e||(e=this.fieldsIndex.get(this.objectIdField)?.name??""),e?`{${e}}`:""}get workingTitle(){const e=this.effectivePopupTemplate?this.effectivePopupTemplate.title:"";return""===e||null==e||this.hasBadExpressions||"string"!=typeof e?this.titleFromDisplayField:e}async getTitle(e,t,s){const r=t.getObjectId()??t.attributes[e.objectIdField];return(await this.getTitles(e,[t],s)).get(r)??""}async getTitles(e,t,s){const r=new Map,i=s?.timeZone??"system";try{const[{substituteFieldsInLinksAndAttributes:a}]=await Promise.all([this.featureUtilsPromise,this._arcadeTask?.promise]);s?.fetchMissingFields&&(t=await this._checkAndReQueryGraphics(e,t));const{fieldInfoMap:o,workingTitle:l}=this,n=l&&o;t.forEach(t=>{const s=t.getObjectId()??t.attributes[e.objectIdField],d=n?a({attributes:t.attributes,expressionAttributes:null,fieldInfoMap:o,globalAttributes:this._createFormattedAttributes(e,t,i).global,layer:e,text:l}):"";r.set(s,d)})}catch{}return r}async _checkAndReQueryGraphics(e,t){const s=t.map(t=>t.getObjectId()??t.attributes[e.objectIdField]).filter(i.isSome);if(s.length!==t.length)return t;if(t.some(e=>!p.featureHasFields(e,this.requiredFields))){const r=e.createQuery();r.where="1=1",r.outFields=[...this.requiredFields],r.objectIds=s;const i=await e.queryFeatures(r);if(i?.features.length===t.length)return i.features}return t}_createFieldInfoMap(e){const t=new Map;if(!e)return t;for(const s of e){if(!s.fieldName)continue;const e=this.fieldsIndex.get(s.fieldName),r=e?.name??s.fieldName;s.fieldName=r,t.set(r.toLowerCase(),s)}return t}_createFormattedAttributes(e,t,s="system"){const r=this.effectivePopupTemplate?.fieldInfos??[],i={};if(!this._featureUtils)return{};if(!this.hasBadExpressions&&this.calculatedExpressions.length>0&&this._arcadeTask?.value){const s=this._arcadeTask.value.Feature.createFromGraphicLikeObject(t.geometry,t.attributes,e,null);for(const e of this.calculatedExpressions)try{i[`expression/${e.name}`]=e.func({vars:{$feature:s}})}catch{}}const a={...t.attributes,...i};return{global:this._featureUtils.formatAttributes({fieldInfos:r,attributes:a,graphic:t,timeZone:s,layer:e,fieldInfoMap:this.fieldInfoMap}),content:[]}}_extractFieldNames(e){return p.extractSubstitutionTemplatesFromString(e).filter(e=>!(e.startsWith("relationships/")||e.startsWith("expression/")))}},s.__decorate([l.property({readOnly:!0})],t.default.prototype,"_arcadeTask",null),s.__decorate([l.property()],t.default.prototype,"_featureUtils",void 0),s.__decorate([l.property({readOnly:!0})],t.default.prototype,"featureUtilsPromise",null),s.__decorate([l.property({readOnly:!0})],t.default.prototype,"calculatedExpressions",null),s.__decorate([l.property()],t.default.prototype,"displayField",void 0),s.__decorate([l.property()],t.default.prototype,"effectivePopupTemplate",void 0),s.__decorate([l.property()],t.default.prototype,"expressionsUsedInTitle",null),s.__decorate([l.property()],t.default.prototype,"fieldsIndex",void 0),s.__decorate([l.property()],t.default.prototype,"fieldInfoMap",null),s.__decorate([l.property()],t.default.prototype,"fields",void 0),s.__decorate([l.property()],t.default.prototype,"objectIdField",void 0),s.__decorate([l.property()],t.default.prototype,"requiredFields",null),t.default=s.__decorate([c.subclass("esri.layers.support.TitleCreator")],t.default),t.default});