// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../request","../../core/Error","../../core/Logger","../../core/mathUtils","../../core/sanitizerUtils","../../core/urlUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","./MediaElementBase","./mediaUtils","./videoUtils","../../support/mediaLayerUtils","../../chunks/persistableUrlUtils"],function(e,t,o,r,s,i,n,a,d,l,c,u,p,h,y,m,v,g){"use strict";var _;const f=Symbol("canplay");return e.default=class extends h{static{_=v.VideoElementSymbol}constructor(e){super(e),this.autoplay=!0,this.content=null,this.type="video",this[_]=!0}load(){const e=this.video;return"string"==typeof e?this.addResolvingPromise(this._preProcessVideoUrl(e).then(async e=>{const t=document.createElement("video");return t.src=n.renderingSanitizer.sanitizeUrl(a.makeAbsolute(e)),t.crossOrigin="anonymous",t.autoplay=this.autoplay,t.muted=!0,t.loop=!0,t.playsInline=!0,this._loadVideo(t).then(()=>{this._set("content",t)})})):e instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(e).then(()=>{this._set("content",e)})):this.addResolvingPromise(Promise.reject(new r("video-element:invalid-video-type","Invalid video type",{video:e}))),Promise.resolve(this)}get contentWidth(){return this.content?.videoWidth??0}get contentHeight(){return this.content?.videoHeight??0}get currentTime(){return this.content?.currentTime}set currentTime(e){if(!this.content)return;const t=i.clamp(e,0,this.content.duration);"fastSeek"in this.content?this.content.fastSeek(t):this.content.currentTime=t,this.content.play().then(()=>{this.content?.pause()}).catch(()=>{})}get duration(){return this.content?.duration}set video(e){"not-loaded"===this.loadStatus?this._set("video",e):s.getLogger(this).error("#video","video cannot be changed after the element is loaded.")}writeVideo(e,t,o,s){if(!e)return void(s?.messages&&s.messages.push(new r("video-element:unsupported-video","video source is missing")));const i=function(e){return"string"==typeof e&&!a.isDataProtocol(e)&&!a.isBlobProtocol(e)}(e)?e:null;if(!i)return void(s?.messages&&s.messages.push(new r("video-element:unsupported-video","video source must be an absolute url")));!a.isAbsolute(i)&&s?.blockedRelativeUrls&&s.blockedRelativeUrls.push(i);const n=a.makeAbsolute(i);g.itemIdFromResourceUrl(n)?s?.messages&&s.messages.push(new r("video-element:unsupported-video","video source cannot be an item resource")):t[o]=n}async _preProcessVideoUrl(e){if(a.getProxyRule(e))return a.addProxy(e);try{return await o(e,{method:"head"}),e}catch{try{return a.addProxy(e,!0)}catch{return e}}}async _loadVideo(e){"anonymous"!==e.crossOrigin&&(e.crossOrigin="anonymous",a.isBlobProtocol(e.src)||(e.src=e.src));try{await m.whenVideoPlayable(e,e=>this.addHandles(e,f)),this.autoplay&&await e.play().catch(e=>{throw console.error(e),e})}finally{this.removeHandles(f)}}},t.__decorate([d.property()],e.default.prototype,"autoplay",void 0),t.__decorate([d.property({readOnly:!0})],e.default.prototype,"content",void 0),t.__decorate([d.property({readOnly:!0})],e.default.prototype,"contentWidth",null),t.__decorate([d.property({readOnly:!0})],e.default.prototype,"contentHeight",null),t.__decorate([d.property({type:Number})],e.default.prototype,"currentTime",null),t.__decorate([d.property({type:Number})],e.default.prototype,"duration",null),t.__decorate([d.property(y.mediaElementUrlProperty)],e.default.prototype,"video",null),t.__decorate([p.writer("video")],e.default.prototype,"writeVideo",null),t.__decorate([d.property(y.mediaTypeProperty)],e.default.prototype,"type",void 0),e.default=t.__decorate([u.subclass("esri.layers.support.VideoElement")],e.default),e.default});