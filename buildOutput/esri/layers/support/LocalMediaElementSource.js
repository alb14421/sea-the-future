// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../core/Collection","../../core/collectionUtils","../../core/Evented","../../core/Loadable","../../core/Logger","../../core/Promise","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/Extent","../../geometry/projectionUtils","../../geometry/SpatialReference","../../geometry/support/aaBoundingRect","../../geometry/support/intersectsBase","../../geometry/support/spatialReferenceUtils","../graphics/data/BoundsStore","./ImageElement","./MediaElementBase","./MediaElementView","./VideoElement"],function(e,t,s,n,r,i,a,l,o,d,c,h,m,p,u,f,_,g,x,y,E,R,w,M,I){"use strict";const S={key:"type",defaultKeyValue:"image",base:w,typeMap:{image:R,video:I}},V=s.ofType(S);return e.default=class extends(i.LoadableMixin(l.EsriPromiseMixin(r.EventedAccessor))){constructor(e){super(e),this._index=new E.BoundsStore,this._elementViewsMap=new Map,this._elementsIndexes=new Map,this._elementsChangedHandler=e=>{for(const t of e.removed){const e=this._elementViewsMap.get(t);this._elementViewsMap.delete(t),this._index.delete(e),this.removeHandles(e),e.destroy(),this.notifyChange("fullExtent")}const{spatialReference:t}=this;for(const s of e.added){if(this._elementViewsMap.get(s))continue;const e=new M.MediaElementView({spatialReference:t,element:s});this._elementViewsMap.set(s,e);const n=d.watch(()=>e.coords,()=>this._updateIndexForElement(e,!1));this._updateIndexForElement(e,!0),this.addHandles(n,e)}this._elementsIndexes.clear(),this.elements.forEach((e,t)=>this._elementsIndexes.set(e,t)),this.emit("refresh")},this.elements=new V}async load(e){if(o.throwIfAborted(e),!this.spatialReference){const e=this.elements.find(e=>null!=e.georeference?.coords);this._set("spatialReference",e?e.georeference.coords.spatialReference:_.WGS84)}return this._elementsChangedHandler({added:this.elements.items,removed:[]}),this.addHandles(this.elements.on("change",this._elementsChangedHandler)),this}destroy(){this._index.clear(),this._elementViewsMap.clear(),this._elementsIndexes.clear()}set elements(e){this._set("elements",n.referenceSetter(e,this._get("elements"),V))}get fullExtent(){if("not-loaded"===this.loadStatus)return null;const e=this._index.fullBounds;return null==e?null:new u({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this.spatialReference})}set spatialReference(e){"not-loaded"===this.loadStatus?this._set("spatialReference",e):a.getLogger(this).error("#spatialReference","spatialReference cannot be changed after the source is loaded.")}async queryElements(e,t){await this.load(),await f.initializeProjection(e.spatialReference,this.spatialReference,null,t);const s=y.equals(e.spatialReference,this.spatialReference)?e:f.project(e,this.spatialReference);if(!s)return[];const n=s.normalize(),r=[];for(const e of n)this._index.forEachInBounds(g.fromExtent(e),({normalizedCoords:t,element:s})=>{null!=t&&x.extentIntersectsPolygon(e,t)&&r.push(s)});return r.sort((e,t)=>this._elementsIndexes.get(e)-this._elementsIndexes.get(t)),r}hasElement(e){return this.elements.includes(e)}_updateIndexForElement(e,t){const s=e.normalizedBounds,n=this._index.has(e),r=null!=s;this._index.delete(e),r&&this._index.set(e,s),this.notifyChange("fullExtent"),t||(n!==r?this.emit("refresh"):this.emit("change",{element:e.element}))}},t.__decorate([c.property()],e.default.prototype,"elements",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"fullExtent",null),t.__decorate([c.property()],e.default.prototype,"spatialReference",null),e.default=t.__decorate([p.subclass("esri.layers.support.LocalMediaElementSource")],e.default),e.default});