// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/arrayUtils","../../core/Error","../../core/urlUtils","../ogc/crsUtils","../../chunks/datetime"],function(e,t,n,i,r,s){"use strict";const o={84:4326,83:4269,27:4267};function a(e){if(e.spatialReferences.length>0)return e.spatialReferences;if(e.sublayers)for(const t of e.sublayers){const e=a(t);if(e.length>0)return e}return[]}function l(e){let t=[];for(const n of e)t.push(n),n.sublayers?.length&&(t=t.concat(l(n.sublayers)),delete n.sublayers);return t}function u(e,t,n){return t.getAttribute(e)??n}function c(e,t){for(let n=0;n<t.childNodes.length;n++){const i=t.childNodes[n];if(y(i)&&i.nodeName===e)return i}return null}function m(e,t){if(null==t)return[];const n=[];for(let i=0;i<t.childNodes.length;i++){const r=t.childNodes[i];y(r)&&r.nodeName===e&&n.push(r)}return n}function d(e,t,n){return c(e,t)?.textContent??n}function f(e,t,n){const i=parseFloat(e.getAttribute("minx")??"0"),r=parseFloat(e.getAttribute("miny")??"0"),s=parseFloat(e.getAttribute("maxx")??"0"),o=parseFloat(e.getAttribute("maxy")??"0");return{xmin:n?isNaN(r)?-Number.MAX_VALUE:r:isNaN(i)?-Number.MAX_VALUE:i,ymin:n?isNaN(i)?-Number.MAX_VALUE:i:isNaN(r)?-Number.MAX_VALUE:r,xmax:n?isNaN(o)?Number.MAX_VALUE:o:isNaN(s)?Number.MAX_VALUE:s,ymax:n?isNaN(s)?Number.MAX_VALUE:s:isNaN(o)?Number.MAX_VALUE:o,spatialReference:{wkid:t}}}function p(e,t){const n=c(t,e);if(n){const e=c("DCPType",n);if(e){const t=c("HTTP",e);if(t){const e=c("Get",t);if(e){let t=function(e,t,n){const i=c("OnlineResource",n);return i?u("xlink:href",i,null):null}(0,0,e);if(t){const e=t.indexOf("&");return-1!==e&&e===t.length-1&&(t=t.slice(0,-1)),function(e,t){const n=[],r=i.urlToObject(e);for(const e in r.query)r.query.hasOwnProperty(e)&&(t.includes(e.toLowerCase())||n.push(e+"="+r.query[e]));return r.path+(n.length?"?"+n.join("&"):"")}(t,["service","request"])}}}}}return null}function x(e,n){const i=m("Operation",e);if(!i.length)return m("Format",c(n,e)).map(({textContent:e})=>e).filter(t.isSome);const r=[];for(const e of i)if(e.getAttribute("name")===n){const t=m("Format",e);for(const{textContent:e}of t)null!=e&&r.push(e)}return r}function h(e,t,n){const i=c(t,e);if(!i)return n;const{textContent:r}=i;if(null==r||""===r)return n;const s=Number(r);return isNaN(s)?n:s}function g(e,t,n){if(!e)return null;const i=e.getAttribute("queryable")?.toLowerCase(),s="1"===i||"true"===i,a={id:n.idCounter++,fullExtents:[],parentLayerId:null,queryable:s,spatialReferences:[],sublayers:null},l=c("LatLonBoundingBox",e),p=c("EX_GeographicBoundingBox",e),x=l?f(l,4326):p?{xmin:parseFloat(d("westBoundLongitude",p,"0")),ymin:parseFloat(d("southBoundLatitude",p,"0")),xmax:parseFloat(d("eastBoundLongitude",p,"0")),ymax:parseFloat(d("northBoundLatitude",p,"0")),spatialReference:{wkid:4326}}:{xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}};a.minScale=h(e,"MaxScaleDenominator",0),a.maxScale=h(e,"MinScaleDenominator",0);const y=["1.0.0","1.1.0","1.1.1"].includes(t)?"SRS":"CRS";return Array.prototype.slice.call(e.childNodes).forEach(e=>{if("Name"===e.nodeName)a.name=e.textContent||"";else if("Title"===e.nodeName)a.title=e.textContent||"";else if("Abstract"===e.nodeName)a.description=e.textContent||"";else if("BoundingBox"===e.nodeName){const n=e.getAttribute(y),i=n?.indexOf(":");if(i&&i>-1){let s=parseInt(n.slice(i+1),10);0===s||isNaN(s)||(s=o[s]??s);const l="1.3.0"===t?f(e,s,r.isAxesOrderReversedForWkid(s)):f(e,s);l&&a.fullExtents&&a.fullExtents.push(l)}}else if(e.nodeName===y)(e.textContent?.split(" ")??[]).forEach(e=>{let t=NaN;if(e.includes(":")){const[n,i]=e.toUpperCase().split(":");"CRS"!==n&&"EPSG"!==n||(t=parseInt(i,10))}else t=parseInt(e,10);if(0!==t&&!isNaN(t)){const e=o[t]??t;a.spatialReferences.includes(e)||a.spatialReferences.push(e)}});else if("Style"!==e.nodeName||a.legendUrl){if("Layer"===e.nodeName){const i=g(e,t,n);i&&(i.parentLayerId=a.id,a.sublayers||(a.sublayers=[]),a.sublayers.push(i))}}else{const t=c("LegendURL",e);if(t){const e=c("OnlineResource",t);e&&(a.legendUrl=e.getAttribute("xlink:href"))}}}),a.extent=x,a.dimensions=m("Dimension",e).filter(e=>e.getAttribute("name")&&e.getAttribute("units")&&e.textContent).map(e=>{const t=e.getAttribute("name"),n=e.getAttribute("units"),i=e.textContent,r=e.getAttribute("unitSymbol")??void 0,s=e.getAttribute("default")??void 0,o="0"!==u("default",e,"0"),a="0"!==u("nearestValue",e,"0"),l="0"!==u("current",e,"0");return b({name:t,units:n})?{name:"time",units:"ISO8601",extent:E(i),default:E(s),multipleValues:o,nearestValue:a,current:l}:N({name:t,units:n})?{name:"elevation",units:n,extent:A(i),unitSymbol:r,default:A(s),multipleValues:o,nearestValue:a}:{name:t,units:n,extent:S(i),unitSymbol:r,default:S(s),multipleValues:o,nearestValue:a}}),a}function y(e){return e.nodeType===Node.ELEMENT_NODE}function N(e){return/^elevation$/i.test(e.name)&&/^(epsg|crs):\d+$/i.test(e.units)}function b(e){return/^time$/i.test(e.name)&&/^iso8601$/i.test(e.units)}function A(e){if(!e)return;const n=e.includes("/"),i=e.split(",");return n?i.map(e=>{const t=e.split("/");return t.length<2?null:{min:parseFloat(t[0]),max:parseFloat(t[1]),resolution:t.length>=3&&"0"!==t[2]?parseFloat(t[2]):void 0}}).filter(t.isSome):i.map(e=>parseFloat(e))}function S(e){if(!e)return;const n=e.includes("/"),i=e.split(",");return n?i.map(e=>{const t=e.split("/");return t.length<2?null:{min:t[0],max:t[1],resolution:t.length>=3&&"0"!==t[2]?t[2]:void 0}}).filter(t.isSome):i}function E(e){if(!e)return;const n=e.includes("/"),i=e.split(",");return n?i.map(e=>{const t=e.split("/");return t.length<2?null:{min:L(t[0]),max:L(t[1]),resolution:t.length>=3&&"0"!==t[2]?T(t[2]):void 0}}).filter(t.isSome):i.map(e=>L(e))}function L(e){return s.DateTime.fromISO(e,{zone:s.FixedOffsetZone.utcInstance}).toJSDate()}function T(e){const t=e.match(/(?:p(\d+y|\d+(?:\.|,)\d+y)?(\d+m|\d+(?:\.|,)\d+m)?(\d+d|\d+(?:\.|,)\d+d)?)?(?:t(\d+h|\d+(?:\.|,)\d+h)?(\d+m|\d+(?:\.|,)\d+m)?(\d+s|\d+(?:\.|,)\d+s)?)?/i);return t?{years:C(t[1]),months:C(t[2]),days:C(t[3]),hours:C(t[4]),minutes:C(t[5]),seconds:C(t[6])}:null}function C(e){if(!e)return 0;const t=e.match(/(?:\d+(?:\.|,)\d+|\d+)/);if(!t)return 0;const n=t[0].replace(",",".");return Number(n)}function F(e){return e.toISOString().replace(/\.[0-9]{3}/,"")}const M=new Set([102100,3857,102113,900913]),v=new Set([3395,54004]);e.fromISODuration=T,e.getPopupLayers=function(e){const t=e.filter(e=>e.popupEnabled&&e.name&&e.queryable);return t.length?t.map(({name:e})=>e).join():null},e.isDimensionInterval=function(e){return void 0!==e.min&&void 0!==e.max},e.isElevationDimension=N,e.isGenericDimension=function(e){return!b(e)&&!N(e)},e.isTimeDimension=b,e.normalizeWKID=function(e,t){let n=e.wkid;return null==t?n:(null!=n&&t.includes(n)||!e.latestWkid||(n=e.latestWkid),null!=n&&M.has(n)?t.find(e=>M.has(e))||t.find(e=>v.has(e))||102100:n)},e.parseCapabilities=function(e){if(!e)return null;const i={idCounter:-1};"string"==typeof e&&(e=(new DOMParser).parseFromString(e,"text/xml"));const r=e.documentElement;if("ServiceExceptionReport"===r.nodeName){const e=Array.prototype.slice.call(r.childNodes).map(e=>e.textContent).join("\r\n");throw new n("wmslayer:wms-capabilities-xml-is-not-valid","The server returned errors when the WMS capabilities were requested.",e)}const s=c("Capability",r),o=c("Service",r),u=s&&c("Request",s);if(!s||!o||!u)return null;const m=c("Layer",s);if(!m)return null;const f="WMS_Capabilities"===r.nodeName||"WMT_MS_Capabilities"===r.nodeName?r.getAttribute("version"):"1.3.0",h=d("Title",o,"")||d("Name",o,""),y=d("AccessConstraints",o,""),N=/^none$/i.test(y)?"":y,A=d("Abstract",o,""),S=parseInt(d("MaxWidth",o,"5000"),10),E=parseInt(d("MaxHeight",o,"5000"),10),L=x(u,"GetMap"),T=p(u,"GetMap"),C=g(m,f,i);if(!C)return null;let F,M=0;const v=Array.prototype.slice.call(s.childNodes),I=C.sublayers??[],R=e=>{null!=e&&I.push(e)};v.forEach(e=>{"Layer"===e.nodeName&&(0===M?F=e:1===M?(C.name&&(C.name="",R(g(F,f,i))),R(g(e,f,i))):R(g(e,f,i)),M++)});const w=C.sublayers??[],U=C.fullExtents??[];0===w.length&&w.push(C),C.extent??=w[0].extent;const O=C.spatialReferences.length>0?C.spatialReferences:a(C),D=p(u,"GetFeatureInfo"),V=D?x(u,"GetFeatureInfo"):null,_=l(w),k=C.minScale||0,B=C.maxScale||0,q=C.dimensions??[],W=_.reduce((e,t)=>e.concat(t.dimensions??[]),[]),X=q.concat(W).filter(b);let G=null;if(X.length){const e=X.map(e=>{const{extent:t}=e;return n=t,Array.isArray(n)&&n.length>0&&n[0]instanceof Date?t.map(e=>e.getTime()):t?.map(e=>[e.min.getTime(),e.max.getTime()]);var n}).flat(2).filter(t.isSome),{start:n,end:i}=e.reduce((e,t)=>({start:Math.min(e.start,t),end:Math.max(e.end,t)}),{start:1/0,end:-1/0});G={startTimeField:null,endTimeField:null,trackIdField:void 0,timeExtent:[n,i]}}return{copyright:N,description:A,dimensions:q,extent:C.extent,fullExtents:U,featureInfoFormats:V,featureInfoUrl:D,mapUrl:T,maxWidth:S,maxHeight:E,maxScale:B,minScale:k,layers:_,spatialReferences:O,supportedImageFormatTypes:L,timeInfo:G,title:h,version:f}},e.toTimeQueryParameter=function(e){if(!e||e.isAllTime||e.isEmpty)return;const{start:t,end:n}=e;return t&&n&&t.getTime()===n.getTime()?`${F(t)}`:`${t?F(t):"0000-01-01T00:00:00Z"}/${n?F(n):"9999-12-31T23:59:59Z"}`},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});