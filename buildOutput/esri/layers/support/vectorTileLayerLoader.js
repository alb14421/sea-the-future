// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../request","../../core/lang","../../core/promiseUtils","../../core/urlUtils","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../views/2d/engine/vectorTiles/style/VectorTileSource"],function(e,t,r,l,o,s,n,i){"use strict";function u(...e){let t;for(const r of e)if(null!=r)if(o.isProtocolRelative(r)){if(t){const e=t.split("://")[0];t=e+":"+r.trim()}}else t=o.isAbsolute(r)?r:o.join(t,r);return t?o.removeTrailingSlash(t):void 0}async function a(e,r,s,n,i){let c,p,m;if(l.throwIfAborted(i),"string"==typeof s){const e=o.normalize(s);m=await t(e,{...i,responseType:"json",query:{f:"json",...i?.query}}),m.ssl&&(c&&(c=c.replace(/^http:/i,"https:")),p&&(p=p.replace(/^http:/i,"https:"))),c=e,p=e}else null!=s&&(m={data:s},c=s.jsonUrl||null,p=n);const d=m?.data;if(f(d))return e.styleUrl=c||null,async function(e,t,r,l){const s=r?o.removeFile(r):o.getAppBaseUrl();e.styleBase=s,e.style=t,t["sprite-format"]&&"webp"===t["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const n=[];if(t.sources&&t.sources.esri){const r=t.sources.esri;r.url?await a(e,"esri",u(s,r.url),void 0,l):n.push(a(e,"esri",r,s,l))}for(const r of Object.keys(t.sources))"esri"!==r&&"vector"===t.sources[r].type&&(t.sources[r].url?n.push(a(e,r,u(s,t.sources[r].url),void 0,l)):t.sources[r].tiles&&n.push(a(e,r,t.sources[r],s,l)));await Promise.all(n)}(e,d,p,i);if(!f(d))return e.sourceUrl?y(e,d,p,!1,r,i):(e.sourceUrl=c||null,y(e,d,p,!0,r,i));throw new Error("You must specify the URL or the JSON for a service or for a style.")}function c(e){return"object"==typeof e&&!!e&&"tilejson"in e&&null!=e.tilejson}function f(e){return!!e&&"sources"in e&&!!e.sources}async function y(e,t,l,f,y,p){const m=l?o.removeTrailingSlash(l)+"/":o.getAppBaseUrl(),d=function(e){const t=512;if(function(e){return e.hasOwnProperty("tileInfo")}(e)){const r=e?.tileInfo;return null!=r&&(null==r.rows&&(r.rows=t),null==r.cols&&(r.cols=t)),e}const l={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100,latestWkid:3857}};let o=null;if(c(e)){const{bounds:t}=e;if(t){const e=n.geographicToWebMercator({x:t[0],y:t[1],spatialReference:r.clone(s.wgs84)}),l=n.geographicToWebMercator({x:t[2],y:t[3],spatialReference:r.clone(s.wgs84)});o={xmin:e.x,ymin:e.y,xmax:l.x,ymax:l.y,spatialReference:r.clone(s.webMercator)}}}null===o&&(o=l);let i=78271.51696400007,u=295828763.7957775;const a=[],f=e.hasOwnProperty("maxzoom")&&null!=e.maxzoom?+e.maxzoom:22;for(let e=0;e<=f;e++)a.push({level:e,scale:u,resolution:i}),i/=2,u/=2;return{capabilities:"TilesOnly",initialExtent:o,fullExtent:l,minScale:0,maxScale:0,tiles:e.tiles,tileInfo:{rows:t,cols:t,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:a,spatialReference:r.clone(s.webMercator)}}}(t),S=new i(y,o.addQueryParameters(m,p?.query??{}),d);if(!f&&e.primarySourceName in e.sourceNameToSource){const t=e.sourceNameToSource[e.primarySourceName];if(!t.isCompatibleWith(S))return;null!=S.fullExtent&&(null!=t.fullExtent?t.fullExtent.union(S.fullExtent):t.fullExtent=S.fullExtent.clone()),t.tileInfo&&S.tileInfo&&t.tileInfo.lods.length<S.tileInfo.lods.length&&(t.tileInfo=S.tileInfo)}if(f&&(e.sourceBase=m,e.source=t,e.validatedSource=d,e.primarySourceName=y),e.sourceNameToSource[y]=S,!c(e)&&"defaultStyles"in t&&!e.style){if(null==t.defaultStyles)throw new Error;return"string"==typeof t.defaultStyles?a(e,"",u(m,t.defaultStyles,"root.json"),void 0,p):a(e,"",t.defaultStyles,u(m,"root.json"),p)}}e.loadMetadata=async function(e,t){const r={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[l,o]="string"==typeof e?[e,null]:[null,e.jsonUrl];return await a(r,"esri",e,o,t),{layerDefinition:r.validatedSource,url:l,serviceUrl:r.sourceUrl,style:r.style,styleUrl:r.styleUrl,spriteUrl:r.style.sprite&&u(r.styleBase,r.style.sprite),spriteFormat:r.spriteFormat,glyphsUrl:r.style.glyphs&&u(r.styleBase,r.style.glyphs),sourceNameToSource:r.sourceNameToSource,primarySourceName:r.primarySourceName}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});