// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/promiseUtils","../../core/sql","./fieldUtils","../../support/loadArcade"],function(e,t,o,i,n){"use strict";async function r(e){if(e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some(e=>"expression"===e.type))return n.loadArcade()}e.fetchFeaturePopupFeatures=async function(e,n,s,l){const u=new Array(n.length),a=new Map,c=new Map,d=i.unpackFieldNames(e.fieldsIndex,s.outFields),p=l?.hasRequiredFields??i.featureHasFields;for(let e=0;e<n.length;e++){const o=n[e];if(o.isAggregate){u[e]=o;continue}let i=!1;if(l?.getPopupTemplate){const e=(o.origin&&"object"==typeof o.origin&&"layer"in o.origin?o.origin.layer:null)??o.sourceLayer??o.layer,n=l.getPopupTemplate(e);if(null==n)continue;const s=await r(n);t.throwIfAborted(l),i=s&&s.arcadeUtils.hasGeometryOperations(n)}if(i||!p(o,d)){const t=o.getObjectId();if(null!=t){a.set(t,{graphic:o,index:e});continue}const i=o.getGlobalId();if(null!=i){c.set(i,{graphic:o,index:e});continue}}u[e]=o}if(!e.queryFeatures||0===a.size&&0===c.size)return u.filter(Boolean);const f=[],g=(e,t)=>{t&&(e.outFields??=[],e.outFields.includes(t)||e.outFields.push(t))};if(a.size>0){const t=s.clone();g(t,e.objectIdField),"uniqueIdFields"in e&&e.uniqueIdFields?.length&&(t.outFields??=[],t.outFields.push(...e.uniqueIdFields)),t.objectIds=Array.from(a.keys()),f.push({type:"object-id",query:t,map:a})}const y="globalIdField"in e?e.globalIdField:null;if(null!=y&&c.size>0){const e=s.clone();g(e,y);const t=Array.from(c.keys());e.where=o.sqlAnd(s.where,`${y} IN (${t.map(e=>`'${e}'`).join(",")})`),f.push({type:"global-id",query:e,map:c})}const b=l?.updateSourceAttributes??!1;for(const{type:t,query:o,map:i}of f)try{const n=await e.queryFeatures(o,l);for(const e of n.features){const o="object-id"===t?e.getObjectId():e.getGlobalId();if(null==o)continue;const n=i.get(o);if(!n)continue;const{graphic:r,index:s}=n;if(b&&e.attributes){r.attributes??={};for(const t of d)t in e.attributes&&(r.attributes[t]=e.attributes[t])}const{geometry:l,origin:a}=r;e.geometry||=l,e.origin=a,u[s]=e}}catch{}return u.filter(Boolean)},e.loadFeaturePopupArcadeModules=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});