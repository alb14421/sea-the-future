// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../kernel","../../core/asyncUtils","../../core/Error","../../core/jsonMap","../../core/sql","../../core/uuid","../../core/accessorSupport/extensions/serializableProperty/reader","./CodedValue","./CodedValueDomain","./featureQueryAll","./fieldUtils","./layerUtils","../../renderers/SimpleRenderer","../../renderers/UniqueValueRenderer","../../rest/support/AttachmentQuery","../../rest/support/NormalizationBinParametersMixin","../../rest/support/Query","../../rest/support/RelationshipQuery","../../symbols/support/typeUtils"],function(e,t,n,r,i,o,a,s,u,l,c,p,d,y,f,m,h,b,w,g,I){"use strict";const F=new o.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});function S(e,t,n){const{attributes:r}=t,{objectIdField:o}=e;return e.capabilities?.data?.supportsAttachment?t?r?o&&r[o]?Promise.resolve():Promise.reject(new i(n,`feature is missing the identifying attribute ${o}`)):Promise.reject(new i(n,"'attributes' are required on a feature to query attachments")):Promise.reject(new i(n,"A feature is required to add/delete/update attachments")):Promise.reject(new i(n,"this layer doesn't support attachments"))}function q(e,t){const{subtypes:n,subtypeField:r}=e;if(!t?.attributes||!n?.length||!r)return null;const i=t.attributes[r];return null==i?null:n.find(e=>e.code===i)}function O(e,t){const{fieldsIndex:n,subtypeField:r}=e,{name:i,type:o}=n.get(t)??{};if(!i)return null;if((r&&n.get(r)?.name)===i&&e.subtypes?.length){const t=e.subtypes.map(e=>new l.CodedValue({code:x(e.code,o),name:e.name}));if(t?.length)return new c({codedValues:t})}return null}function P(e,t){const{fieldsIndex:n}=e,{name:r,type:i}=n.get(t)??{};if(!r)return null;if(("typeIdField"in e?n.get(e.typeIdField)?.name:null)===r&&"types"in e&&e.types?.length){const t=e.types.map(e=>new l.CodedValue({code:x(e.id,i),name:e.name}));return new c({codedValues:t})}return null}function x(e,t){return t?d.isStringField({type:t})&&"number"==typeof e?`${e}`:d.isIntegerField({type:t})&&"string"==typeof e?Number.parseInt(e,10):e:e}async function v(e){return(await e.load()).source}async function A(e,t){if(!n.id)return;if(n.id.findCredential(e))return;let r;try{const i=await y.getOwningPortalUrl(e,t);i&&(r=await n.id.checkSignInStatus(`${i}/sharing`))}catch(e){}if(r)try{const r=null!=t?t.signal:null;await n.id.getCredential(e,{signal:r})}catch(e){}}function C(e){return!!e?.toLowerCase().includes("current_user")}const L=u.createTypeReader({types:I.symbolTypesRenderer});async function j(e,t,n){if(null==t)return null;const i=[],{objectIdField:o}=e;if(t.forEach(e=>{let t=null;if("attributes"in e){const{attributes:r}=e;t={globalId:r[n],objectId:null!=r[o]&&-1!==r[o]?r[o]:null}}else t={globalId:e.globalId,objectId:null!=e.objectId&&-1!==e.objectId?e.objectId:null};null!=t.globalId&&(null!=t.objectId&&-1!==t.objectId||i.push(t.globalId))}),0===i.length)return null;const a=e.createQuery();a.where=i.map(e=>`${n}='${e}'`).join(" OR "),a.returnGeometry=!1,a.outFields=[o,n],a.cacheHint=!1;const u=await r.resultOrAbort(p.queryAllJSON(e,a));if(!u.ok)return null;const l=new Map,c=u.value.features;for(const e of c){const t=e.attributes[n],r=e.attributes[o];null!=t&&null!=r&&-1!==r&&l.set(s.normalizeGlobalID(t),r)}return l}function D(e,t,n){if(!t||!n||!e)return null;const r=n.getAttribute(t);return null==r?null:e.find(e=>{const{id:t}=e;return null!=t&&t.toString()===r.toString()})??null}function E(e){return e.sourceJSON?.isMultiServicesView||function(e){return!!e.sourceJSON?.capabilities?.toLowerCase().split(",").map(e=>e.trim()).includes("map")}(e)}function T(e,t){return null!=e&&!!t?.[b.normalizationTypeJsonMap.toJSON(e)]}t.addAttachment=async function(e,t,n,r){const o=await v(e);if(await S(e,t,r),!o.addAttachment)throw new i(r,"Layer source does not support addAttachment capability");return o.addAttachment(t,n)},t.applyEdits=async function(t,n,r){const{applyEdits:i}=await new Promise((t,n)=>e(["../graphics/editingSupport"],t,n)),o=await t.load();let a=r;return"feature"===o.type&&o.infoFor3D&&null!=n.deleteFeatures&&null!=o.globalIdField&&(a={...a,globalIdToObjectId:await j(o,n.deleteFeatures,o.globalIdField)}),i(o,o.source,n,r)},t.checkServiceCurrentUserSupport=async function(e){const t=e.parsedUrl?.path;t&&function(e){return function(e){return!(!y.isLayerWithFeatureCapabilities(e)||!e.capabilities?.query.supportsCurrentUser)}(e)&&("serviceDefinitionExpression"in e&&C(e.serviceDefinitionExpression)||"definitionExpression"in e&&C(e.definitionExpression))}(e)&&await A(t)},t.computeDomainFromSubtypes=O,t.computeDomainFromTypes=P,t.computeEffectiveEditingEnabled=function(e){return!E(e)&&(e.userHasUpdateItemPrivileges||e.editingEnabled)},t.createDefaultRenderer=function(e,t){if(e.defaultSymbol)return e.types?.length?new m({defaultSymbol:L(e.defaultSymbol,e,t),field:e.typeIdField,uniqueValueInfos:e.types.map(e=>({id:e.id,symbol:L(e.symbol,e,t)}))}):new f({symbol:L(e.defaultSymbol,e,t)})},t.createQuery=function(e){const t=new w;t.historicMoment=e.historicMoment,t.gdbVersion=e.gdbVersion,t.returnGeometry=!0,t.outFields=["*"],t.multipatchOption="multipatch"===e.geometryType?"xyFootprint":null;const n=e.capabilities?.query;n&&(t.compactGeometryEnabled=n.supportsCompactGeometry,t.defaultSpatialReferenceEnabled=n.supportsDefaultSpatialReference);const r=e.capabilities?.data;r?.supportsZ&&null!=e.returnZ&&(t.returnZ=e.returnZ),r?.supportsM&&null!=e.returnM&&(t.returnM=e.returnM);const{timeOffset:i,timeExtent:o}=e;return t.timeExtent=null!=i&&null!=o?o.offset(-i.value,i.unit):o||null,t},t.deleteAttachments=async function(e,t,n,r){const o=await v(e);if(await S(e,t,r),!o.deleteAttachments)throw new i(r,"Layer source does not support deleteAttachments capability");return o.deleteAttachments(t,n)},t.ensureCredentialIfSignedIn=A,t.ensureLayerCredential=async function(e,t,n){const r=e.parsedUrl?.path;r&&e.authenticationTriggerEvent===t&&await A(r,n)},t.fetchRecomputedExtents=async function(e,t,n){const r=(await e.load({signal:t?.signal})).source;if(!r.fetchRecomputedExtents)throw new i(n,"Layer source does not support fetchUpdates capability");return r.fetchRecomputedExtents(t)},t.geometryTypeKebabDict=F,t.getFeatureSubtype=q,t.getFeatureType=D,t.getFieldDomain=function(e,t,n,r){const i=n?.feature,o=!!e.subtypes?.length;if(o&&!n?.excludeImpliedDomains){const n=O(e,t);if(n)return n}const a=o&&q(e,i);if(a){const e=a?.domains?.[t];return"inherited"===e?.type?r:e}const s=D(e.types,e.typeIdField,i);if(s){const e=s.domains&&s.domains[t];if(e&&"inherited"!==e?.type)return e}if(r)return r;if(!n?.excludeImpliedDomains){const n=P(e,t);if(n)return n}return null},t.getGlobalIdToObjectIdMap=j,t.getSignedInUser=async function(e,t){if(!n.id)return;const r=n.id.findCredential(e);if(r)return r.userId;let i;try{const r=await y.getOwningPortalUrl(e,t);r&&(i=await n.id.checkSignInStatus(`${r}/sharing`))}catch(e){}return i?i.userId:null},t.hasCurrentUser=C,t.hasDataChanged=async function(e){const t=e.source;if(t?.refresh)try{const{dataChanged:n,updates:r}=await t.refresh();if(null!=r&&(e.sourceJSON={...e.sourceJSON,...r},e.read(r,{origin:"service",url:e.parsedUrl})),n)return!0}catch{}if(e.definitionExpression)try{return(await a.parseWhereClause(e.definitionExpression,e.fieldsIndex)).hasDateFunctions}catch{}return!1},t.isLayerCacheStale=function(e){let t=e.sourceJSON?.cacheMaxAge;if(!t)return!1;const n=e.editingInfo?.lastEditDate?.getTime();return null==n||(t*=1e3,Date.now()-n<t)},t.queryAttachments=async function(e,t,n,r){t=h.from(t),await e.load();const o=e.source,a=e.capabilities;if(!a?.data?.supportsAttachment)throw new i(r,"this layer doesn't support attachments");const{attachmentTypes:s,objectIds:u,globalIds:l,num:c,size:p,start:d,where:y}=t;if(!a?.operations?.supportsQueryAttachments&&(s?.length>0||l?.length>0||p?.length>0||c||d||y))throw new i(r,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",t);if(!(u?.length||l?.length||y))throw new i(r,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",t);if(!o.queryAttachments)throw new i(r,"Layer source does not support queryAttachments capability",t);return!a?.attachment?.supportsOrderByFields&&t.orderByFields?.length&&((t=t.clone()).orderByFields=null),o.queryAttachments(t)},t.queryExtent=async function(e,t,n,r){const o=await v(e);if(!o.queryExtent)throw new i(r,"Layer source does not support queryExtent capability");return o.queryExtent(w.from(t)??e.createQuery(),n)},t.queryFeatureCount=async function(e,t,n,r){const o=await v(e);if(!o.queryFeatureCount)throw new i(r,"Layer source does not support queryFeatureCount capability");return o.queryFeatureCount(w.from(t)??e.createQuery(),n)},t.queryObjectIds=async function(e,t,n,r){const o=await v(e);if(!o.queryObjectIds)throw new i(r,"Layer source does not support queryObjectIds capability");return o.queryObjectIds(w.from(t)??e.createQuery(),n)},t.queryRelatedFeatures=async function(e,t,n,r){const o=await v(e);if(!o.queryRelatedFeatures)throw new i(r,"Layer source does not support queryRelatedFeatures capability");return o.queryRelatedFeatures(g.from(t),n)},t.queryRelatedFeaturesCount=async function(e,t,n,r){const o=await v(e);if(!o.queryRelatedFeaturesCount)throw new i(r,"Layer source does not support queryRelatedFeaturesCount capability");return o.queryRelatedFeaturesCount(g.from(t),n)},t.readGlobalIdField=function(e){const{globalIdField:t,fields:n}=e;if(t)return t;if(n)for(const e of n)if("esriFieldTypeGlobalID"===e.type)return e.name},t.readObjectIdField=function(e){const{objectIdField:t,fields:n}=e;if(t)return t;if(n)for(const e of n)if("esriFieldTypeOID"===e.type)return e.name},t.readVersion=function(e){return e.currentVersion?e.currentVersion:e.hasOwnProperty("capabilities")||e.hasOwnProperty("drawingInfo")||e.hasOwnProperty("hasAttachments")||e.hasOwnProperty("htmlPopupType")||e.hasOwnProperty("relationships")||e.hasOwnProperty("timeInfo")||e.hasOwnProperty("typeIdField")||e.hasOwnProperty("types")?10:9.3},t.supportsQueryOnly=E,t.updateAttachment=async function(e,t,n,r,o){const a=await v(e);if(await S(e,t,o),!a.updateAttachment)throw new i(o,"Layer source does not support updateAttachment capability");return a.updateAttachment(t,n,r)},t.uploadAssets=async function(t,n,r){const{uploadAssets:i}=await new Promise((t,n)=>e(["../graphics/editingSupport"],t,n)),o=await t.load();return i(o,o.source,n,r)},t.validateBinsQuery=function(e,t,n){const r=t?.queryAttributeBins;if(!t?.operations?.supportsQueryBins||!r)throw new i(n,"Layer source does not support binning");switch(e.binParameters.type){case"auto-interval":if(!r.supportsAutoInterval)throw new i(n,"Layer source does not support auto-interval binning");if(e.binParameters.normalizationType&&(!r.supportsNormalization||!T(e.binParameters.normalizationType,r.supportedNormalizationTypes)))throw new i(n,"Layer source does not support normalization binning");break;case"date":if(!r.supportsDate)throw new i(n,"Layer source does not support date binning");if(e.binParameters.snapToData&&!r.supportsSnapToData)throw new i(n,"Layer source does not support snapToData binning");if(e.binParameters.returnFullIntervalBin&&!r.supportsReturnFullIntervalBin)throw new i(n,"Layer source does not support returnFullIntervalBin binning");break;case"fixed-boundaries":if(!r.supportsFixedBoundaries)throw new i(n,"Layer source does not support fixed-boundaries binning");break;case"fixed-interval":if(!r.supportsFixedInterval)throw new i(n,"Layer source does not support fixed-interval binning");if(e.binParameters.normalizationType&&(!r.supportsNormalization||!T(e.binParameters.normalizationType,r.supportedNormalizationTypes)))throw new i(n,"Layer source does not support normalization binning")}if(e.binParameters.stackBy&&!r.supportsStackBy)throw new i(n,"Layer source does not support stackBy binning");if(e.binParameters.splitBy&&!r.supportsSplitBy)throw new i(n,"Layer source does not support splitBy binning");if(e.binParameters.firstDayOfWeek&&!r.supportsFirstDayOfWeek)throw new i(n,"Layer source does not support firstDayOfWeek binning");const o=r?.supportedStatistics;if(e.outStatistics&&o){const t=new Map([["count","count"],["sum","sum"],["min","min"],["max","max"],["avg","avg"],["stddev","stddev"],["var","var"],["percentile-continuous","percentileContinuous"],["percentile-discrete","percentileDiscrete"],["centroid-aggregate","centroid"],["convex-hull-aggregate","convexHull"],["envelope-aggregate","envelope"]]);for(const{statisticType:r}of e.outStatistics){const e=t.get(r);if(e&&!o[e])throw new i(n,`Layer source does not support ${r} statistic type`)}}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});