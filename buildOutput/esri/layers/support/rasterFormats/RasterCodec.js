// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Error","../../../core/maybe","../PixelBlock","../SimpleBandStatistics","./ImageCanvasDecoder","./JpgPlus","./Lerc","./Lzw","./pixelRangeUtils","../../../chunks/Zlib","./Raw","./TiffDecoder","./utils"],function(t,e,a,i,s,r,n,o,h,l,c,d,p,u){"use strict";var f=function(t){var e,a,i;function s(t){var e,a,i,s,r,n,o,h,l,c,d,p,u;for(this.data=t,this.pos=8,this.palette=[],this.imgData=[],this.transparency={},this.animation=null,this.text={},r=null;;){switch(e=this.readUInt32(),h=function(){var t,e;for(e=[],t=0;t<4;++t)e.push(String.fromCharCode(this.data[this.pos++]));return e}.call(this).join(""),h){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(e);break;case"fcTL":r&&this.animation.frames.push(r),this.pos+=4,r={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()},s=this.readUInt16(),i=this.readUInt16()||100,r.delay=1e3*s/i,r.disposeOp=this.data[this.pos++],r.blendOp=this.data[this.pos++],r.data=[];break;case"IDAT":case"fdAT":for("fdAT"===h&&(this.pos+=4,e-=4),t=(null!=r?r.data:void 0)||this.imgData,d=0;0<=e?d<e:d>e;0<=e?++d:--d)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:if(this.transparency.indexed=this.read(e),(l=255-this.transparency.indexed.length)>0)for(p=0;0<=l?p<l:p>l;0<=l?++p:--p)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(e)[0];break;case 2:this.transparency.rgb=this.read(e)}break;case"tEXt":n=(c=this.read(e)).indexOf(0),o=String.fromCharCode.apply(String,c.slice(0,n)),this.text[o]=String.fromCharCode.apply(String,c.slice(n+1));break;case"IEND":return r&&this.animation.frames.push(r),this.colors=function(){switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this),this.hasAlphaChannel=4===(u=this.colorType)||6===u,a=this.colors+(this.hasAlphaChannel?1:0),this.pixelBitlength=this.bits*a,this.colorSpace=function(){switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData=new Uint8Array(this.imgData));default:this.pos+=e}if(this.pos+=4,this.pos>this.data.length)throw new Error("Incomplete or corrupt PNG file")}}return s.load=function(t,e,a){var i;return"function"==typeof e&&(a=e),(i=new XMLHttpRequest).open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(){var t;return t=new s(new Uint8Array(i.response||i.mozResponseArrayBuffer)),"function"==typeof(null!=e?e.getContext:void 0)&&t.render(e),"function"==typeof a?a(t):void 0},i.send(null)},s.prototype.read=function(t){var e,a;for(a=[],e=0;0<=t?e<t:e>t;0<=t?++e:--e)a.push(this.data[this.pos++]);return a},s.prototype.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},s.prototype.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},s.prototype.decodePixels=function(t){var e,a,i,s,r,n,o,h,l,d,p,u,f,g,m,w,y,b,x,k,T,I,v;if(null==t&&(t=this.imgData),0===t.length)return new Uint8Array(0);for(t=(t=new c.Zlib(t)).getBytes(),w=(u=this.pixelBitlength/8)*this.width,f=new Uint8Array(w*this.height),n=t.length,m=0,g=0,a=0;g<n;){switch(t[g++]){case 0:for(s=x=0;x<w;s=x+=1)f[a++]=t[g++];break;case 1:for(s=k=0;k<w;s=k+=1)e=t[g++],r=s<u?0:f[a-u],f[a++]=(e+r)%256;break;case 2:for(s=T=0;T<w;s=T+=1)e=t[g++],i=(s-s%u)/u,y=m&&f[(m-1)*w+i*u+s%u],f[a++]=(y+e)%256;break;case 3:for(s=I=0;I<w;s=I+=1)e=t[g++],i=(s-s%u)/u,r=s<u?0:f[a-u],y=m&&f[(m-1)*w+i*u+s%u],f[a++]=(e+Math.floor((r+y)/2))%256;break;case 4:for(s=v=0;v<w;s=v+=1)e=t[g++],i=(s-s%u)/u,r=s<u?0:f[a-u],0===m?y=b=0:(y=f[(m-1)*w+i*u+s%u],b=i&&f[(m-1)*w+(i-1)*u+s%u]),o=r+y-b,h=Math.abs(o-r),d=Math.abs(o-y),p=Math.abs(o-b),l=h<=d&&h<=p?r:d<=p?y:b,f[a++]=(e+l)%256;break;default:throw new Error("Invalid filter algorithm: "+t[g-1])}m++}return f},s.prototype.decodePalette=function(){var t,e,a,i,s,r,n,o,h;for(a=this.palette,r=this.transparency.indexed||[],s=new Uint8Array((r.length||0)+a.length),i=0,a.length,t=0,e=n=0,o=a.length;n<o;e=n+=3)s[i++]=a[e],s[i++]=a[e+1],s[i++]=a[e+2],s[i++]=null!=(h=r[t++])?h:255;return s},s.prototype.copyToImageData=function(t,e){var a,i,s,r,n,o,h,l,c,d,p;if(i=this.colors,c=null,a=this.hasAlphaChannel,this.palette.length&&(c=null!=(p=this._decodedPalette)?p:this._decodedPalette=this.decodePalette(),i=4,a=!0),l=(s=t.data||t).length,n=c||e,r=o=0,1===i)for(;r<l;)h=c?4*e[r/4]:o,d=n[h++],s[r++]=d,s[r++]=d,s[r++]=d,s[r++]=a?n[h++]:this.transparency.grayscale&&this.transparency.grayscale===d?0:255,o=h;else for(;r<l;)h=c?4*e[r/4]:o,s[r++]=n[h++],s[r++]=n[h++],s[r++]=n[h++],s[r++]=a?n[h++]:this.transparency.rgb&&this.transparency.rgb[1]===n[h-3]&&this.transparency.rgb[3]===n[h-2]&&this.transparency.rgb[5]===n[h-1]?0:255,o=h},s.prototype.decode=function(){var t;return t=new Uint8Array(this.width*this.height*4),this.copyToImageData(t,this.decodePixels()),t},a=t.document&&t.document.createElement("canvas"),i=a&&a.getContext("2d"),e=function(t){var e;return i.width=t.width,i.height=t.height,i.clearRect(0,0,t.width,t.height),i.putImageData(t,0,0),(e=new Image).src=a.toDataURL(),e},s.prototype.decodeFrames=function(t){var a,i,s,r,n,o,h,l;if(this.animation){for(l=[],i=n=0,o=(h=this.animation.frames).length;n<o;i=++n)a=h[i],s=t.createImageData(a.width,a.height),r=this.decodePixels(new Uint8Array(a.data)),this.copyToImageData(s,r),a.imageData=s,l.push(a.image=e(s));return l}},s.prototype.renderFrame=function(t,e){var a,i,s;return a=(i=this.animation.frames)[e],s=i[e-1],0===e&&t.clearRect(0,0,this.width,this.height),1===(null!=s?s.disposeOp:void 0)?t.clearRect(s.xOffset,s.yOffset,s.width,s.height):2===(null!=s?s.disposeOp:void 0)&&t.putImageData(s.imageData,s.xOffset,s.yOffset),0===a.blendOp&&t.clearRect(a.xOffset,a.yOffset,a.width,a.height),t.drawImage(a.image,a.xOffset,a.yOffset)},s.prototype.animate=function(t){var e,a,i,s,r,n,o=this;return a=0,n=this.animation,s=n.numFrames,i=n.frames,r=n.numPlays,(e=function(){var n,h;if(n=a++%s,h=i[n],o.renderFrame(t,n),s>1&&a/s<r)return o.animation._timeout=setTimeout(e,h.delay)})()},s.prototype.stopAnimation=function(){var t;return clearTimeout(null!=(t=this.animation)?t._timeout:void 0)},s.prototype.render=function(t){var e,a;return t._png&&t._png.stopAnimation(),t._png=this,t.width=this.width,t.height=this.height,e=t.getContext("2d"),this.animation?(this.decodeFrames(e),this.animate(e)):(a=e.createImageData(this.width,this.height),this.copyToImageData(a,this.decodePixels()),e.putImageData(a,0,0))},s}(self);const g=new Set(["jpg","png","bmp","gif"]);async function m(t,a){if(!u.isPlatformLittleEndian)throw new e("rasterCoded:decode","lerc decoder is not supported on big endian platform");await o.load();const{offset:r}=a,{width:n,height:h,pixelType:l,statistics:c,depthCount:d,noDataValues:p,bandMasks:f,pixels:g,mask:m}=o.decode(t,{inputOffset:r,returnInterleaved:a.returnInterleaved}),w=new i({width:n,height:h,pixelType:l.toLowerCase(),pixels:g,mask:m,statistics:c.map(({minValue:t,maxValue:e})=>new s.SimpleBandStatistics(t,e)),bandMasks:f,depthCount:d,noDataValues:p});return c?.length||w.updateStatistics(),w}async function w(t,e){const s=await p.decode(t,{...e,noDataValue:e.tiffNoDataValue,matchAllNoData:e.matchAllNoData});a.assertIsSome(s);const r=new i({width:s.width,height:s.height,pixels:s.pixels,pixelType:s.pixelType.toLowerCase(),mask:s.mask,bandMasks:s.bandMasks,statistics:null});return r.updateStatistics(),r}function y(t,e){const a=e.pixelType||"u8",s=i.getPixelArrayConstructor(a),r="u8"===a?t:new s(t.buffer),n=[],o=e.planes||1;if(1===o)n.push(r);else for(let a=0;a<o;a++){const i=(e.width||1)*(e.height||t.length),h=new s(i);for(let t=0;t<i;t++)h[t]=r[t*o+a];n.push(h)}const h=new i({width:e.width||1,height:e.height||t.length,pixels:n,pixelType:a,statistics:null});return h.updateStatistics(),h}function b(t,e){return y(new c.Zlib(new Uint8Array(t)).getBytes(),e)}function x(t,e){return y(h.decode(t,e.offset,e.eof,!e.isInputBigEndian),e)}function k(t,e){const a=n.decode(t,e.hasNoZlibMask??void 0),s=new i({width:a.width,height:a.height,pixels:a.pixels,pixelType:"u8",mask:a.mask,statistics:null});return s.updateStatistics(),s}function T(t,e){const a=new Uint8Array(t),s=new f(a),{width:r,height:n}=e,o=r*n,h=s.decode();let l,c=0,d=0;const p=new Uint8Array(o);for(c=0;c<o;c++)p[c]=h[4*c+3];const u=new i({width:r,height:n,pixels:[],pixelType:"u8",mask:p,statistics:[]});for(c=0;c<3;c++){for(l=new Uint8Array(o),d=0;d<o;d++)l[d]=h[4*d+c];u.addData({pixels:l})}return u.updateStatistics(),u}function I(t){if(null==t)throw new e("rasterCodec:decode","parameter encodeddata is required.");const a=new Uint8Array(t,0,10);let i="";return 255===a[0]&&216===a[1]?i="jpg":137===a[0]&&80===a[1]&&78===a[2]&&71===a[3]?i="png":67===a[0]&&110===a[1]&&116===a[2]&&90===a[3]&&73===a[4]&&109===a[5]&&97===a[6]&&103===a[7]&&101===a[8]&&32===a[9]?i="lerc":76===a[0]&&101===a[1]&&114===a[2]&&99===a[3]&&50===a[4]&&32===a[5]?i="lerc2":73===a[0]&&73===a[1]&&42===a[2]&&0===a[3]||77===a[0]&&77===a[1]&&0===a[2]&&42===a[3]||73===a[0]&&73===a[1]&&43===a[2]&&0===a[3]||77===a[0]&&77===a[1]&&0===a[2]&&43===a[3]?i="tiff":71===a[0]&&73===a[1]&&70===a[2]?i="gif":66===a[0]&&77===a[1]?i="bmp":String.fromCharCode.apply(null,a).toLowerCase().includes("error")&&(i="error"),i}t.decode=async function(t,a={},s){if(null==t)throw new e("rasterCodec:decode","missing encodeddata parameter.");let n=a.format?.toLowerCase();if(!("bsq"!==n&&"bip"!==n||null!=a.width&&null!=a.height))throw new e("rasterCodec:decode","requires width and height in options parameter.");if("tiff"===n&&a.customOptions)return async function(t,e){const a=await p.decodeTileOrStrip(t,e.customOptions),s=new i({width:a.width,height:a.height,pixels:a.pixels,pixelType:a.pixelType.toLowerCase(),mask:a.mask,statistics:null});return s.updateStatistics(),s}(t,a);if((!n||"bsq"!==n&&"bip"!==n&&"deflate"!==n&&"lzw"!==n)&&(n=I(t)),a.useCanvas&&g.has(n))return async function(t,e,a,s){const n=new r,o={applyJpegMask:!1,format:e,...a},h=await n.decode(t,o,s),l=new i(h);return l.updateStatistics(),l}(t,n,a,s);const o=function(t){let a=null;switch(t){case"lerc":case"lerc2":a=m;break;case"jpg":a=k;break;case"png":a=T;break;case"bsq":case"bip":a=(e,a)=>function(t,e,a){const{pixelTypeCtor:s}=function(t){let e=null,a=null;switch(t?t.toLowerCase():"f32"){case"u1":case"u2":case"u4":case"u8":a=255,e=Uint8Array;break;case"u16":a=a||65535,e=Uint16Array;break;case"u32":a=a||2**32-1,e=Uint32Array;break;case"s8":a=a||-128,e=Int8Array;break;case"s16":a=a||-32768,e=Int16Array;break;case"s32":a=a||0-2**31,e=Int32Array;break;default:e=Float32Array}return{pixelTypeCtor:e,noDataValue:a}}(e.pixelType),r=(0,d.decode)(t,{width:e.width,height:e.height,pixelType:s,format:a}),n=new i({width:e.width,height:e.height,pixels:r.pixels,pixelType:e.pixelType,mask:r.mask,statistics:null});return n.updateStatistics(),n}(e,a,t);break;case"tiff":a=w;break;case"deflate":a=b;break;case"lzw":a=x;break;case"error":a=()=>{throw new e("rasterCodec:decode","input data contains error")};break;default:a=()=>{throw new e("rasterCodec:decode","unsupported raster format")}}return a}(n);let h;a.isPoint&&(null!=(a={...a}).width&&a.width++,null!=a.height&&a.height++);const{offsets:c}=a;if(c&&c.length>1){const e=c.map((e,i)=>o(t.slice(e,c[i+1]),a)),s=await Promise.all(e);h=s[0],h.pixels=s.map(t=>t.pixels[0]);const r=s.map(t=>t.mask);s.some(t=>null!=t)&&(r.forEach((t,e)=>{null==t&&(r[e]=new Uint8Array(h.width*h.height).fill(255))}),h.bandMasks=r,h.mask=i.combineBandMasks(r)),h.updateStatistics()}else h=await o(t,{...a,offset:c?.[0]??a.offset});return"jpg"!==n&&null!=a.noDataValue&&1===h.depthCount&&l.convertNoDataToMask(h,a.noDataValue,{customFloatTolerance:a.tolerance}),a.isPoint&&function(t,e=1){if(!t)return;const{pixels:a,width:s,height:r,mask:n}=t;if(!a||0===a.length)return;const o=a.length,h=s-1,l=r-1,c=[];let d,p,u,f,g,m,w=null;const y=i.getPixelArrayConstructor(t.pixelType);if(0===e){for(d=0;d<o;d++){for(g=a[d],m=new y(h*l),p=0;p<l;p++)for(f=p*s,u=0;u<h;u++)m[p*h+u]=g[f+u];c.push(m)}if(null!=n)for(w=new Uint8Array(h*l),p=0;p<l;p++)for(f=p*s,u=0;u<h;u++)w[p*h+u]=n[f+u]}else{for(d=0;d<o;d++){for(g=a[d],m=new y(h*l),p=0;p<l;p++)for(f=p*s,u=0;u<h;u++)m[p*h+u]=(g[f+u]+g[f+u+1]+g[f+s+u]+g[f+s+u+1])/4;c.push(m)}if(n)for(w=new Uint8Array(h*l),p=0;p<l;p++)for(f=p*s,u=0;u<h;u++)w[p*h+u]=Math.min.apply(null,[n[f+u],n[f+u+1],n[f+s+u],n[f+s+u+1]])}t.width=h,t.height=l,t.mask=w,t.pixels=c}(h),h},t.getFormat=function(t){let e=I(t);return"lerc2"===e?e="lerc":"error"===e&&(e=""),e},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});