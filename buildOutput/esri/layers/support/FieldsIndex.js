// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../core/Error","../../core/Logger","../../core/MapUtils","../../core/sql/UnknownTimeZone","../../core/support/jsonUtils","./fieldUtils","../../time/constants","../../time/timeZoneUtils","../../chunks/datetime"],function(e,i,t,n,s,l,r,d,o){"use strict";const a=new Map;class m{static fromJSON(e){return new m(e.fields,e.timeZoneByFieldName)}static fromLayer(e){return new m(e.fields??[],c(e))}static fromLayerJSON(e){return new m(e.fields??[],c(e))}constructor(e=[],i){this._fieldsMap=new Map,this._normalizedFieldsMap=new Map,this._dateFieldsSet=new Set,this._numericFieldsSet=new Set,this._requiredFields=null,this.dateFields=[],this.numericFields=[],this.fields=e||[],this._timeZoneByFieldName=i?new Map(i):null;const t=[];for(const e of this.fields){const i=e?.name,n=f(i);if(i&&n){const s=u(i);this._fieldsMap.set(i,e),this._fieldsMap.set(s,e),this._normalizedFieldsMap.set(n,e),t.push(`${s}:${e.type}:${this._timeZoneByFieldName?.get(i)}`),l.isDateField(e)?(this.dateFields.push(e),this._dateFieldsSet.add(e)):l.isNumericField(e)&&(this._numericFieldsSet.add(e),this.numericFields.push(e)),l.isObjectIDField(e)||l.isGlobalIDField(e)||(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable)}}t.sort(),this.uid=t.join()}get requiredFields(){if(!this._requiredFields){this._requiredFields=[];for(const e of this.fields)l.isObjectIDField(e)||l.isGlobalIDField(e)||e.nullable||void 0!==l.getFieldDefaultValue(e)||this._requiredFields.push(e)}return this._requiredFields}equals(e){return this.uid===e?.uid}has(e){return null!=this.get(e)}get(e){if(!e)return;let i=this._fieldsMap.get(e);return i||(i=this._fieldsMap.get(u(e))??this._normalizedFieldsMap.get(f(e)),i&&this._fieldsMap.set(e,i),i)}getTimeZone(t){const n=this.get(t&&"string"!=typeof t?t.name:t);return n?this._timeZoneByFieldName?this._timeZoneByFieldName.get(n.name):"date"===n.type||"esriFieldTypeDate"===n.type?(i.getLogger("esri.layers.support.FieldsIndex").errorOnce(new e("getTimeZone:no-timezone-information",`no time zone information for field '${n.name}'`)),r.utc):F.has(n.type)?r.unknown:null:null}getLuxonTimeZone(e){const i=this.getTimeZone(e);return i?i===r.unknown?n.UnknownTimeZone.instance:i===r.utc?o.FixedOffsetZone.utcInstance:t.getOrCreateMapValue(a,i,()=>o.IANAZone.create(i)):null}isDateField(e){return this._dateFieldsSet.has(this.get(e))}isTimeOnlyField(e){return l.isTimeOnlyField(this.get(e))}isNumericField(e){return this._numericFieldsSet.has(this.get(e))}normalizeFieldName(e){return this.get(e)?.name??void 0}toJSON(){return{fields:this.fields.map(e=>s.isSerializable(e)?e.toJSON():e),timeZoneByFieldName:this._timeZoneByFieldName?Array.from(this._timeZoneByFieldName.entries()):null}}}function u(e){return e.trim().toLowerCase()}function f(e){return l.normalizeFieldName(e)?.toLowerCase()??""}const F=new Set(["time-only","date-only","timestamp-offset","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"]);function c(e){const i=new Map;if(!e.fields)return i;const t=!0===e.datesInUnknownTimezone,{timeInfo:n,editFieldsInfo:s}=e,l=(n?"startField"in n?n.startField:n.startTimeField:"")??"",o=(n?"endField"in n?n.endField:n.endTimeField:"")??"",a="dateFieldsTimeZone"in e?e.dateFieldsTimeZone??null:e.dateFieldsTimeReference?d.fromTimeReference(e.dateFieldsTimeReference):null,m=s?"timeZone"in s?s.timeZone??a:s.dateFieldsTimeReference?d.fromTimeReference(s.dateFieldsTimeReference):a??r.utc:null,f=n?"timeZone"in n?n.timeZone??a:n.timeReference?d.fromTimeReference(n.timeReference):a:null,c=new Map([[u(s?.creationDateField??""),m],[u(s?.editDateField??""),m],[u(l),f],[u(o),f]]);for(const{name:n,type:s}of e.fields)if(F.has(s))i.set(n,r.unknown);else if("date"!==s&&"esriFieldTypeDate"!==s)i.set(n,null);else if(t)i.set(n,r.unknown);else{const e=c.get(u(n??""))??a;i.set(n,e)}return i}return m});