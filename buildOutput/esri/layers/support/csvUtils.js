// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../request","../../core/arrayUtils","../../core/date","../../core/Error","../../core/number","../../core/urlUtils","./Field","./fieldUtils","./locationUtils"],function(e,t,i,n,r,l,o,s,a,c){"use strict";async function u(e){const t=e.getReader(),i=g(t),n=(await i.next()).value?.trim(),l=(await i.next()).value?.trim();if(t.releaseLock(),!n)throw new r("csv-utils:empty-csv","CSV is empty");const{delimiter:o,locationInfo:u}=function(e,t,i){e=e.trim(),t=t?.trim();const n=[],r=Array.from(new Set([i?.delimiter,...p])).filter(e=>null!=e);for(const i of r){const r=F(e,i).length,l=F(t,i).length??r;r>1&&n.push({weight:Math.min(r,l),delimiter:i})}const l=n.sort(({weight:e},{weight:t})=>t-e).map(({delimiter:e})=>e);for(const t of l){const n=h(e,t).names,r=c.inferLocationInfo(n,i?.longitudeField,i?.latitudeField);if(r.longitudeFieldName&&r.latitudeFieldName)return{delimiter:t,locationInfo:r}}return{delimiter:l[0],locationInfo:null}}(n,l);if(!o)throw new r("csv-utils:invalid-delimiter","Unable to detect the delimiter from CSV",{firstLine:n,secondLine:l});const{names:N,aliases:T}=h(n,o),v=await async function(e,t,i,n,r){const l=e.getReader(),o=g(l),s=[],c=[];for await(const e of async function*(e,t,i,n=()=>Object.create(null)){let r="",l="",o=0,s=n(),a=0;for await(const c of e){const e=y(c,i);for(const c of e)if(r+=l+c,l="",o+=S(c),o%2==0){if(o>0){const e=d.exec(r);if(!e)return s=n(),a=0,r="",void(o=0);s[t[a]]=b(e[1]).replaceAll(f,'"'),a++}else s[t[a]]=b(r),a++;r="",o=0}else l=i;0===o?(yield s,s=n(),a=0):l=m}}(o,i,t)){if(10===c.length)break;c.push(e)}for(let e=0;e<i.length;e++){const t=i[e],l=n[e];if(t===r?.longitudeFieldName||t===r?.latitudeFieldName)s.push({name:t,type:"esriFieldTypeDouble",alias:l});else{const e=w(c.map(e=>e[t]))??"esriFieldTypeString";s.push({name:t,type:e,alias:l,length:a.getFieldDefaultLength(e)})}}return l.releaseLock(),s}(e,o,N,T,u);return{delimiter:o,fields:v.map(e=>s.fromJSON(e)),latitudeField:u?.latitudeFieldName,longitudeField:u?.longitudeFieldName}}const d=/^\s*"([\S\s]*)"\s*$/,f=/""/g,m="\n",p=[","," ",";","|","\t"];async function*g(e){const t=/\r?\n/gm,i=new TextDecoder;let n="";for await(const r of async function*(e){let t=await e.read();for(;!t.done;)yield t.value,t=await e.read();e.releaseLock()}(e)){const e=`${n}${i.decode(r)}`.split(t).filter(Boolean);n=e.pop()||"",yield*e}}function y(e,t){return function*(e,t){let i=0;for(;i<=e.length;){const n=e.indexOf(t,i),r=e.slice(i,n>-1?n:void 0);i+=r.length+t.length,yield r}}(e,t)}function h(e,t){const n=F(e,t).filter(i.isSome),r=n.map(e=>a.normalizeFieldName(e));for(let e=r.length-1;e>=0;e--)r[e]||(r.splice(e,1),n.splice(e,1));return{names:r,aliases:n}}function F(e,t){if(!e?.length)return[];const i=[];let n="",r="",l=0;const o=y(e,t);for(const e of o)if(n+=r+e,r="",l+=S(e),l%2==0){if(l>0){const e=d.exec(n);e&&i.push(e[1].replaceAll(f,'"'))}else i.push(n);n="",l=0}else r=t;return i}function w(e){if(!e.length)return"esriFieldTypeString";const t=/[^+\-.,0-9]/;return e.map(e=>{if(""!==e){if(!t.test(e)){let t=N(e);if(!isNaN(t))return/[.,]/.test(e)||!Number.isInteger(t)||t>214783647||t<-214783648?"esriFieldTypeDouble":"esriFieldTypeInteger";if(e.includes("E")){if(t=Number(e),!Number.isNaN(t))return"esriFieldTypeDouble";if(e.includes(",")&&(e=e.replace(",","."),t=Number(e),!Number.isNaN(t)))return"esriFieldTypeDouble"}}return n.isDateString(e)?"esriFieldTypeDate":"esriFieldTypeString"}}).reduce((e,t)=>void 0===e?t:void 0===t?e:e===t?t:"esriFieldTypeString"===e||"esriFieldTypeString"===t?"esriFieldTypeString":"esriFieldTypeDouble"===e||"esriFieldTypeDouble"===t?"esriFieldTypeDouble":void 0)}const N=function(){const e=l._parseInfo(),t=new RegExp("^"+e.regexp+"$"),i=new RegExp("["+e.group+"\\s\\xa0]","g"),n=e.factor;return r=>{const l=t.exec(r);if(e.factor=n,!l)return NaN;let o=l[1];if(!l[1]){if(!l[2])return NaN;o=l[2],e.factor*=-1}return o=o.replace(i,"").replace(e.decimal,"."),+o*e.factor}}();function b(e){return JSON.parse(JSON.stringify(e))}function S(e){let t=0,i=0;for(i=e.indexOf('"',i);i>=0;)t++,i=e.indexOf('"',i+1);return t}e.getCSVLayerInfo=async function(e,i={}){const{customParameters:n,signal:l}=i,s=o.urlToObject(e),a=await t(s.path,{query:{...s.query,...n},responseType:"native",signal:l});if(!a.data.body)throw new r("csv-utils:empty-csv","CSV is empty");const[c]=await Promise.allSettled([u(a.data.body)]);if(await a.data.body.cancel(),"rejected"===c.status)throw c.reason;return{url:e,customParameters:n,...c.value}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});