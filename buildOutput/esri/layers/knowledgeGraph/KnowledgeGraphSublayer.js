// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../PopupTemplate","../../core/lang","../../core/Logger","../../core/MultiOriginJSONSupport","../../core/workers/workers","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../geometry/Extent","../../geometry/Point","../../geometry/Polygon","../../geometry/Polyline","../../geometry/projectionUtils","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils","../../geometry/support/typeUtils","../../graphic/KnowledgeGraphGraphicOrigin","../Layer","../graphics/data/FeatureStore","../graphics/data/QueryEngine","../graphics/sources/support/clientSideDefaults","./constants","./KnowledgeGraphSublayerBase","./layerUtils","../mixins/BlendLayer","../mixins/DisplayFilteredLayer","../mixins/FeatureEffectLayer","../mixins/FeatureReductionLayer","../mixins/OrderedLayer","../mixins/RefreshableLayer","../mixins/ScaleRangeLayer","../mixins/TemporalLayer","../support/commonProperties","../support/featureReductionUtils","../support/Field","../support/fieldUtils","../support/LabelClass","../support/labelingInfo","../support/TimeInfo","../../renderers/SimpleRenderer","../../renderers/support/jsonUtils","../../renderers/support/typeUtils","../../rest/support/FeatureSet","../../rest/support/Query","../../support/popupUtils","../../symbols/support/utils","../../core/workers/RemoteClient"],function(e,t,r,o,i,a,n,p,s,l,y,d,u,c,h,g,f,m,_,b,w,T,I,S,O,N,v,E,L,F,x,j,R,C,D,P,Q,M,G,J,k,q,U,K,A,B,V,Z,H,W){"use strict";function z(e){if(!e.json)return e;e.json.write=Y(e.json.write);const t=e.json.origins;if(!t)return e;let r;for(r in t){const e=t[r];e&&(e.write=Y(e.write))}return e}function Y(e){return"object"==typeof e&&e?(!1!==e.enabled&&(e.overridePolicy=function(e){const{target:t,writer:r,overridePolicy:o,...i}=e;return function(e,t){const r=$.call(this,e,t);return r.enabled?{...i,...r}:r}}(e)),e):!0===e?X():e}function X(){return{overridePolicy:$}}function $(e,t){const r=!!this.geometryType;let o={enabled:r};return r&&(o={...o,...ee.call(this,e,t)}),o}function ee(e,t){return{ignoreOrigin:this.originIdOf(t)>0}}return e.default=class extends(N.KnowledgeGraphSublayerBase(L.DisplayFilteredLayer(x.FeatureReductionLayer(F.FeatureEffectLayer(E.BlendLayer(j.OrderedLayer(D.TemporalLayer(C.ScaleRangeLayer(R.RefreshableLayer(a.MultiOriginJSONMixin(w))))))))))){constructor(e){super(e),this.blendMode="normal",this.capabilities=S.createCapabilities(!1,!0),this.charts=null,this.definitionExpression=null,this.displayField="",this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphicOrigin=new b(this),this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=O.systemOidFieldName,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const e=new MessageChannel;return new W(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const r=V.fromJSON(e);return this.queryFeaturesJSON(r,t)}}}),[e.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get userHasUpdateItemPrivileges(){return!!this.parent?.userHasUpdateItemPrivileges}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){const t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}get fields(){const e=[];return this.objectType?.properties?.forEach(t=>{const r="esriFieldTypeOID"===t.fieldType?"esriFieldTypeInteger":t.fieldType;e.push(M.fromJSON({name:t.name,type:r,alias:t.alias,defaultValue:t.defaultValue,editable:t.editable,nullable:t.nullable}))}),e.push(M.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),M.fromJSON({name:O.systemAggregationCountFieldName,type:"esriFieldTypeInteger",alias:O.systemAggregationCountFieldName,editable:!1}),M.fromJSON({name:O.systemIsSpatialFieldName,type:"esriFieldTypeInteger",alias:O.systemIsSpatialFieldName,editable:!1})),e}get geometryType(){if("link-chart"===this.parentCompositeLayer?.type)return"relationship"===this.graphType?"polyline":"point";const e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.geometryType;return t&&"esriGeometryNull"!==t?_.featureGeometryTypeKebabDictionary.fromJSON(t):null}get geometryFieldName(){if("link-chart"===this.parentCompositeLayer?.type)return O.systemLayoutGeometryFieldName;const e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name);return e?.name??null}get graphTypeName(){return this.objectType?.name}set graphTypeName(e){this._set("graphTypeName",e)}get hasM(){const e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.name,r=t?this.objectType?.properties?.[t]:null;return r?.hasM??!1}get hasZ(){const e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.name,r=t?this.objectType?.properties?.[t]:null;return r?.hasZ??!1}set labelingInfo(e){this._set("labelingInfo",e)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");if(!this.objectType||!this.parentCompositeLayer||!this.graphTypeName)return null;const e=this.objectType.properties?v.getDisplayLabelProperty(this.objectType.properties):"ESRI__ID";return"link-chart"===this.parentCompositeLayer.type?v.getLinkChartDefaultLabelingInfo(this.graphType,this.graphTypeName,e):v.getMapDefaultLabelingInfo(this.graphTypeName,this.geometryType,e)}set renderer(e){G.fixRendererFields(e,this.fieldsIndex),this._set("renderer",e)}get renderer(){if(this._isOverridden("renderer"))return this._get("renderer");const e=this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel,t=[...e?.entityTypes??[],...e?.relationshipTypes??[]].map(e=>e.name).indexOf(this.graphTypeName),r=v.getKGSublayerSymbolColor(t);if("link-chart"===this.parentCompositeLayer?.type){if("relationship"===this.graphType)return new U({type:"simple",symbol:v.getDefaultLCRelationshipSublayerSymbol(r)});const e=K.fromJSON(S.createDrawingInfo(_.featureGeometryTypeKebabDictionary.toJSON("point")).renderer);return H.applyColorToSymbol(e.symbol,r),e}const o=K.fromJSON(S.createDrawingInfo(_.featureGeometryTypeKebabDictionary.toJSON(this.geometryType)).renderer);return H.applyColorToSymbol(o.symbol,r),o}get spatialReference(){return this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel?.spatialReference??f.WGS84}set timeInfo(e){this._set("timeInfo",e)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(e){this._set("title",e)}writeTitle(e,t){t.title=e??"Layer"}createPopupTemplate(e){return Z.createPopupTemplate(this,e)}createQuery(){return new V({where:"1=1",outFields:["*"]})}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){return null}async queryFeatures(e,t){await this.load();const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e),i=B.fromJSON(await o.executeQuery(r.toJSON(),t?.signal));return i.features.forEach(e=>{e.sourceLayer=this}),i}async queryFeaturesJSON(e,t){await this.load();const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e);return await o.executeQuery(r.toJSON(),t?.signal)}async queryFeatureCount(e,t){await this.load();const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e);return o.executeQueryForCount(r.toJSON(),t?.signal)}async queryExtent(e={},t){await this.load();const r={...e,returnGeometry:!0},{resolvedQuery:o,queryEngine:i}=await this._setupQueryObjects(r),a=await i.executeQueryForExtent(o.toJSON(),t?.signal);let n;return n=null!=a.extent?.xmin&&null!=a.extent?.xmax&&null!=a.extent?.ymin&&null!=a.extent?.ymax?new d(a.extent):new d,{count:a.count,extent:n}}async queryObjectIds(e,t){await this.load();const r=V.from(e);let o;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)o=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(r,this,t);o=this.loadQueryEngine(e)}return await o.executeQueryForIds(r.toJSON(),t?.signal)}loadQueryEngine(e){const t=new T({geometryType:_.featureGeometryTypeKebabDictionary.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new I.QueryEngine({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:_.featureGeometryTypeKebabDictionary.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,featureIdInfo:{type:"object-id",fieldName:this.objectIdField},spatialReference:this.spatialReference.toJSON(),timeInfo:this.timeInfo?.toJSON(),featureStore:t});return r.featureStore.addMany(e),r}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new V({where:"1=1",outFields:[O.systemOidFieldName]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}load(e){return this.addResolvingPromise(this.parent.load(e).then(()=>G.fixTimeInfoFields(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(e,t){const r=V.from(e),o=r.geometry;if(o&&!o.spatialReference?.isWGS84&&(await g.initializeProjection(o.spatialReference,m.wgs84),r.geometry=o instanceof c||o instanceof h||o instanceof u?g.project(o,m.wgs84):g.project(o.extent,m.wgs84)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)return{resolvedQuery:r,queryEngine:this._cachedQueryEngine};const i=await this.parentCompositeLayer.dataManager.getData(r,this,t);return{resolvedQuery:r,queryEngine:this.loadQueryEngine(i)}}},t.__decorate([p.property(z(o.clone(E.blendModeProperty)))],e.default.prototype,"blendMode",void 0),t.__decorate([p.property()],e.default.prototype,"capabilities",void 0),t.__decorate([p.property({readOnly:!0})],e.default.prototype,"userHasUpdateItemPrivileges",null),t.__decorate([p.property({json:{origins:{"web-scene":{write:!1}},write:X()}})],e.default.prototype,"charts",void 0),t.__decorate([p.property({readOnly:!0})],e.default.prototype,"defaultPopupTemplate",null),t.__decorate([p.property({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],e.default.prototype,"definitionExpression",void 0),t.__decorate([p.property()],e.default.prototype,"displayField",void 0),t.__decorate([p.property(z(o.clone(L.displayFilterEnabledProperty)))],e.default.prototype,"displayFilterEnabled",void 0),t.__decorate([p.property(z(o.clone(L.displayFilterInfoProperty)))],e.default.prototype,"displayFilterInfo",void 0),t.__decorate([p.property(z(o.clone(E.effectProperty)))],e.default.prototype,"effect",void 0),t.__decorate([p.property()],e.default.prototype,"elevationInfo",void 0),t.__decorate([p.property(z(o.clone(F.featureEffectProperty)))],e.default.prototype,"featureEffect",void 0),t.__decorate([p.property(z(o.clone(Q.featureReductionProperty)))],e.default.prototype,"featureReduction",null),t.__decorate([p.property()],e.default.prototype,"fields",null),t.__decorate([p.property()],e.default.prototype,"geometryType",null),t.__decorate([p.property()],e.default.prototype,"geometryFieldName",null),t.__decorate([p.property({readOnly:!0,clonable:!1})],e.default.prototype,"graphicOrigin",void 0),t.__decorate([p.property({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],e.default.prototype,"graphType",void 0),t.__decorate([p.property({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],e.default.prototype,"graphTypeName",null),t.__decorate([p.property()],e.default.prototype,"hasM",null),t.__decorate([p.property()],e.default.prototype,"hasZ",null),t.__decorate([p.property({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],e.default.prototype,"id",void 0),t.__decorate([p.property({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],e.default.prototype,"labelsVisible",void 0),t.__decorate([p.property({type:[J],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:function(e,t,r){const o=[["ESRI__AGGREGATION_COUNT",O.systemAggregationCountFieldName],["ESRI__ORIGIN_ID",O.systemOriginIdFieldName],["ESRI__DESTINATION_ID",O.systemDestinationIdFieldName],["ESRI__LAYOUT_GEOMETRY",O.systemLayoutGeometryFieldName]];try{for(const t of e)for(const[e,r]of o)t.labelExpression=t.labelExpression?.replaceAll(e,r),t.labelExpressionInfo?.expression&&(t.labelExpressionInfo.expression=t.labelExpressionInfo.expression.replaceAll(e,r))}catch(e){i.getLogger(this).warn("Error updating labelingInfo",e)}return k.reader(e,t,r)},write:X()}})],e.default.prototype,"labelingInfo",null),t.__decorate([p.property({readOnly:!0,json:{read:!1,write:{writer(e,t){switch(this.parentCompositeLayer?.type){case"link-chart":t.layerType="LinkChartSubLayer";break;case"knowledge-graph":t.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],e.default.prototype,"layerType",void 0),t.__decorate([p.property(z(o.clone(P.legendEnabled)))],e.default.prototype,"legendEnabled",void 0),t.__decorate([p.property(z(o.clone(P.maxScale)))],e.default.prototype,"maxScale",void 0),t.__decorate([p.property(z(o.clone(P.minScale)))],e.default.prototype,"minScale",void 0),t.__decorate([p.property()],e.default.prototype,"objectIdField",void 0),t.__decorate([p.property()],e.default.prototype,"objectType",void 0),t.__decorate([p.property(z(o.clone(P.opacity)))],e.default.prototype,"opacity",void 0),t.__decorate([p.property(z(o.clone(j.orderByProperty)))],e.default.prototype,"orderBy",void 0),t.__decorate([p.property({clonable:!1})],e.default.prototype,"parent",void 0),t.__decorate([p.property()],e.default.prototype,"parentCompositeLayer",void 0),t.__decorate([p.property(z(o.clone(P.popupEnabled)))],e.default.prototype,"popupEnabled",void 0),t.__decorate([p.property({type:r,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],e.default.prototype,"popupTemplate",void 0),t.__decorate([p.property({type:Number,json:{write:{overridePolicy:ee}}})],e.default.prototype,"refreshInterval",void 0),t.__decorate([p.property({types:A.rendererTypes,json:{name:"layerDefinition.drawingInfo.renderer",write:X()}})],e.default.prototype,"renderer",null),t.__decorate([p.property()],e.default.prototype,"source",void 0),t.__decorate([p.property()],e.default.prototype,"spatialReference",null),t.__decorate([p.property({type:q,json:{name:"layerDefinition.timeInfo",write:!0,origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:!0},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:!0}}}})],e.default.prototype,"timeInfo",null),t.__decorate([p.property({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],e.default.prototype,"title",null),t.__decorate([y.writer("title")],e.default.prototype,"writeTitle",null),t.__decorate([p.property({json:{read:!1}})],e.default.prototype,"type",void 0),t.__decorate([p.property(z(o.clone(D.useViewTimeProperty)))],e.default.prototype,"useViewTime",void 0),t.__decorate([p.property({type:Boolean,json:{name:"visibility",write:X()}})],e.default.prototype,"visible",void 0),e.default=t.__decorate([l.subclass("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],e.default),e.default});