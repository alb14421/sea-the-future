// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/mathUtils","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec32","../../../geometry/support/webMercatorUtils","./utils","../../../widgets/OrientedImageryViewer/components/imageNavigationUtils"],function(a,t,e,r,o,n,i){"use strict";function c(a,t){const{cameraLocation:o,pointsToTransform:i,scalingFactor:c}=function(a,t,e){const r=Array.isArray(a)||"items"in a?a:[a];n.validatePointsToTransform(r,t),s(r,t),n.validateRotationMatrix(e);const o=n.getWebMercatorScalingFactor(t.y,t.spatialReference);return{pointsToTransform:r.map(a=>a.toArray()),scalingFactor:o,cameraLocation:t.toArray()}}(a,t.cameraLocation,t.rotationMatrix),l=new Array;return function(a,t,o){const{affineTransformations:n,cameraLocation:i,focalLengthX:c,focalLengthY:s,principalOffsetPoint:f,radialDistortionCoefficients:l,rotationMatrix:m,scalingFactor:g,tangentialDistortionCoefficients:u}=o;for(const o of a){const a=e.create();r.sub(a,o,i),a[0]=a[0]/g,a[1]=a[1]/g;const d=-c*((m[0]*a[0]+m[3]*a[1]+m[6]*a[2])/(m[2]*a[0]+m[5]*a[1]+m[8]*a[2])),h=-s*((m[1]*a[0]+m[4]*a[1]+m[7]*a[2])/(m[2]*a[0]+m[5]*a[1]+m[8]*a[2])),p=d*d+h*h;let y=0,L=0,T=0,b=0,A=0,w=0,M=0;l&&(y=l[0]??0,L=l[1]??0,T=l[2]??0),u&&(b=u[0],A=u[1]),f&&(w=f[0]??0,M=f[1]??0);const v=1+y*p+L*p*p+T*p*p*p;let F=d*v+b*(p+2*d**2)+2*A*d*h,x=h*v+A*(p+2*h**2)+2*b*d*h;F+=w,x+=M;const N=Number(n[0])+Number(n[1])*F+Number(n[2])*x,P=Number(n[3])+Number(n[4])*F+Number(n[5])*x;t.push({x:N,y:P})}}(i,l,{...t,cameraLocation:o,scalingFactor:c,...f(t)}),Array.isArray(a)?l:l[0]}function s(a,t){if(a.some(a=>!a.spatialReference.equals(t.spatialReference)))throw new Error("Input points and camera location must have the same spatial reference")}function f(a){if(function(a){return null!=a?.focalLength}(a))return{focalLengthX:a.focalLength,focalLengthY:a.focalLength};const{imageWidth:e,imageHeight:r,horizontalFieldOfView:o,verticalFieldOfView:n}=a;return{focalLengthX:e/(2*Math.tan(t.deg2rad(o)/2)),focalLengthY:r/(2*Math.tan(t.deg2rad(n)/2))}}a.worldToImage=c,a.worldToImagePanoramic=function(a,e){const{cameraHeading:o,imageHeight:c,imageWidth:f}=e,{cameraLocation:l,pointsToTransform:m}=function(a,t){const e=Array.isArray(a)||"items"in a?a:[a];return n.validatePointsToTransform(e,t),s(e,t),{pointsToTransform:e.map(a=>a.toArray()),cameraLocation:t.toArray()}}(a,e.cameraLocation),g=new Array,u=n.getWebMercatorScalingFactor(l[1],e.cameraLocation.spatialReference);for(const a of m){const e=r.distance([l[0],l[1],l[2]*u],[a[0],a[1],a[2]*u]),s=[(a[0]-l[0])/e,(a[1]-l[1])/e,(a[2]-l[2])*u/e],m=0!==s[0]&&0!==s[1]?i.normalizeDegrees(t.rad2deg(Math.atan2(s[0],s[1]))-o):0,d=t.rad2deg(Math.acos(-s[2]));g.push(n.convertOrientationToPixelLocation(m,d,f,c))}return Array.isArray(a)?g:g[0]},a.worldToImageWithLTPFlag=function(a,t,e){return c(a?t.map(a=>o.webMercatorToGeographic(a)):t,e).map(a=>({...a,z:1}))},Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});