// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/Clonable","../../../core/Error","../../../core/JSONSupport","../../../core/Logger","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/cast","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/reader","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/decorators/writer","../../../geometry/Point","../../../geometry/support/zscale","./CameraOrientation","./cameraOrientationFactory","./utils","../transformations/utils"],function(e,t,r,a,o,i,n,p,d,c,l,s,u,y,f,m,_,g){"use strict";const h=e=>({cast:e=>{const t=parseFloat(e);return Number.isFinite(t)?t:void 0},json:{name:e,write:{writer:(e,t,r)=>{t[r]=Number.isFinite(e)?e:void 0}}}}),v=e=>({cast:e=>"string"==typeof e?e.split(";").map(Number):e,json:{default:e,write:{writer:(e,t,r)=>{t[r]=e?.join(";")}}}});return e.default=class extends(r.ClonableMixin(o.JSONSupport)){constructor(e){super(e),this._geometry=null,this.cameraOrientation=null,this.elevation=null,this.elevationSource=null,this.name=null,this.sourceMap=null}read(e,t){const r={},{attributes:a,geometry:o}=e,i={};for(const e in a)r[e.toLowerCase()]=a[e],i[e.toLowerCase()]=e;const n=e.layer??{};n.sequenceOrderField?.length&&(r.sequenceorder=a[n.sequenceOrderField],i.sequenceorder=n.sequenceOrderField),super.read({geometry:o,layer:n,sourceMap:i,...r},t)}write(e,t){const r=super.write(e,t),{sourceMap:a}=this;if(!a||!r)return r;const o={};for(const e in r){const t=a[e.toLowerCase()];t&&(o[t]=r[e])}return o}readCameraHeading(e,t){const{cameraheading:r,camheading:a,layer:o}=t;return r??a??o.cameraHeading}readCameraHeight(e,t){const{cameraheight:r,avghtag:a,layer:o}=t;return r??a??o.cameraHeight}readCamOffset(e,t){const{cameraoffset:r,camoffset:a}=t;return r?.split(";").map(Number)??a?.split(";").map(Number)??null}writeCameraOffset(e,t){e&&(t.cameraOffset=e.join(";"))}readCameraOrientation(e,t){const{cameraorientation:r,camori:a}=t;return r??a}readCameraPitch(e,t){const{camerapitch:r,campitch:a,layer:o}=t;return r??a??o.cameraPitch}readCameraRoll(e,t){const{cameraroll:r,camroll:a,layer:o}=t;return r??a??o.cameraRoll}readDepthImage(e,t){const{depthimage:r,depthimg:a,layer:o}=t,i=r??a??null,{depthImagePathPrefix:n,depthImagePathSuffix:p}=o??{};return _.appendPrefixAndSuffix(i,n,p)}readElevationSource(e,t){const{elevationsource:r,layer:a}=t,{demPathSuffix:o,demPathPrefix:i}=a;if(r){const e=this._parseIfJSON(r);return _.getEffectiveElevationSource(e,i,o)}return a.effectiveElevationSource}readFarDistance(e,t){const{fardistance:r,fardist:a,layer:o}=t;return r??a??o.farDistance}get geometry(){const e=this._geometry.clone();if(!e)return null;const{cameraOffset:t}=this;if(t){const[r,a,o]=t;e.x+=r,e.y+=a,null!=e.z&&null!=o&&(e.z+=o)}return e}set geometry(e){this._geometry=e}writeGeometry(e,t){t.geometry=this._geometry.toJSON()}readHFOV(e,t){const{horizontalfieldofview:r,hfov:a,layer:o}=t;return r??a??o.horizontalFieldOfView}readImageURL(e,t){const{imagepath:r,layer:o}=t;r||function(e,t){throw new a("exposure-point:missing-attribute-value","a value for imagePath is missing in attribute table",{exposurePoint:t})}(0,this);const{imagePathPrefix:i,imagePathSuffix:n}=o;return _.appendPrefixAndSuffix(r,i,n)}readImageRotation(e,t){const{imagerotation:r,imgrot:a,layer:o}=t;return r??a??o.imageRotation}get isHorizontal(){return"horizontal"===this.orientedImageryType}get isInspection(){return"inspection"===this.orientedImageryType}get isNadir(){return"nadir"===this.orientedImageryType}get isOblique(){return"oblique"===this.orientedImageryType}get isSpherical(){return"360"===this.orientedImageryType}get location(){const{cameraOrientation:e,cameraHeight:t,elevation:r}=this;if(e){const{type:t,x:r,y:a,z:o,horizontalWKID:i,verticalWKID:n}=e,p="number"==typeof i?{wkid:i}:{wkt:i};if(4===t){const{latitude:t,longitude:r,ellipsoidRadius:a,squaredEccentricity:o,properties:i}=e,{x:n,y:p,z:d}=i;return new u(g.ltpToGeographic([n,p,d],[t,r,a,o]))}const d=new u({x:r,y:a,z:o,spatialReference:p}),c=n?y.getGeometryZScaler("point",{wkid:n},p):null;return c&&c(d),d}if("number"!=typeof t)throw function(){throw new a("exposure-point:missing-default-value","a value for cameraHeight is missing in default properties")}();const o=this.geometry.clone(),n=(r??0)+t/_.getMetersPerUnitOfSR(o.spatialReference);if("360"===this.orientedImageryType&&o.hasZ){const e=n-o.z;return null!=r&&Math.abs(e)>.001&&(i.getLogger(this).warnOnce("The elevation value is different from the geometry's z value. The geometry's z value will be updated.",{elevation:r,geometryZ:o.z}),o.z=n),o}return o.z=o.hasZ?o.z:n,o}set matrix(e){if(e)return 9!==e.length?(i.getLogger(this).warnOnce("Ignoring rotation matrix because it doesn't have 9 values",{value:e}),void this._set("matrix",null)):void this._set("matrix",e)}readNearDistance(e,t){const{neardistance:r,neardist:a,layer:o}=t;return r??a??o.nearDistance}readOffsetFromStart(e,t){return t.offsetfromstart??null}readOrientationAccuracy(e,t){const{accuracy:r,orientationaccuracy:a}=t;return a?.split(";").map(Number)??r?.split(";").map(Number)??null}writeOrientationAccuracy(e,t){e&&(t.orientationAccuracy=e.join(";"))}readOIType(e,t){const{orientedimagerytype:r,oitype:a,camerapitch:o,campitch:i,layer:n}=t,p=_.orientedImageryTypeMap.read(r??a??n.orientedImageryType),d=o??i??n.cameraPitch;return"oblique"===p?d<10?"nadir":"oblique":p}set radial(e){if(e){if("string"==typeof e){const[t,r,a]=e.split(";").map(Number);return void this._set("radial",[t??0,r??0,a??0])}this._set("radial",e)}else this._set("radial",[0,0,0])}readSequenceOrder(e,t){const{layer:r}=t;return t[r.sequenceOrderField.toLowerCase()]}writeSequenceOrder(e,t){if(!e)return;const{sourceMap:r}=this;r&&(t[r.sequenceorder]=e)}set tangential(e){if(e){if("string"==typeof e){const[t,r]=e.split(";").map(Number);return void this._set("tangential",[t??0,r??0])}this._set("tangential",e)}else this._set("tangential",[0,0])}readVFOV(e,t){const{verticalfieldofview:r,vfov:a,layer:o}=t;return r??a??o.verticalFieldOfView}_parseIfJSON(e){let t=null;try{t=JSON.parse(e)}catch(t){i.getLogger(this).error("couldn't parse the given elevation source JSON",e,t)}return t}clone(){const e=super.clone();return e._geometry=this._geometry.clone(),e}},t.__decorate([n.property()],e.default.prototype,"_geometry",void 0),t.__decorate([n.property(h())],e.default.prototype,"a0",void 0),t.__decorate([n.property(h())],e.default.prototype,"a1",void 0),t.__decorate([n.property(h())],e.default.prototype,"a2",void 0),t.__decorate([n.property({type:Date,json:{write:{enabled:!0,target:"acquisitionDate"},name:"acquisitiondate"}})],e.default.prototype,"acquisitionDate",void 0),t.__decorate([n.property(h())],e.default.prototype,"b0",void 0),t.__decorate([n.property(h())],e.default.prototype,"b1",void 0),t.__decorate([n.property(h())],e.default.prototype,"b2",void 0),t.__decorate([n.property({type:Number,json:{write:!0,read:{source:["cameraheading","camheading","layer.cameraHeading"]}}})],e.default.prototype,"cameraHeading",void 0),t.__decorate([c.reader("cameraHeading")],e.default.prototype,"readCameraHeading",null),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"cameraHeight",void 0),t.__decorate([c.reader("cameraHeight",["cameraheight","avghtag","layer.cameraHeight"])],e.default.prototype,"readCameraHeight",null),t.__decorate([n.property()],e.default.prototype,"cameraOffset",void 0),t.__decorate([c.reader("cameraOffset",["cameraoffset","camoffset"])],e.default.prototype,"readCamOffset",null),t.__decorate([s.writer("cameraOffset")],e.default.prototype,"writeCameraOffset",null),t.__decorate([n.property({json:{write:{writer:(e,t,r)=>{t[r]=e.toString()}}},type:f}),p.cast(e=>e?m.getCameraOrientation(e):null)],e.default.prototype,"cameraOrientation",void 0),t.__decorate([c.reader("cameraOrientation",["cameraorientation","camori"])],e.default.prototype,"readCameraOrientation",null),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"cameraPitch",void 0),t.__decorate([c.reader("cameraPitch",["camerapitch","campitch","layer.cameraPitch"])],e.default.prototype,"readCameraPitch",null),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"cameraRoll",void 0),t.__decorate([c.reader("cameraRoll",["cameraroll","camroll","layer.cameraRoll"])],e.default.prototype,"readCameraRoll",null),t.__decorate([n.property({json:{write:!0},type:String})],e.default.prototype,"depthImage",void 0),t.__decorate([c.reader("depthImage",["depthimage","depthimg"])],e.default.prototype,"readDepthImage",null),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"elevation",void 0),t.__decorate([n.property({json:{write:!0},clonable:"reference"})],e.default.prototype,"elevationSource",void 0),t.__decorate([c.reader("elevationSource",["elevationsource","layer.effectiveElevationSource"])],e.default.prototype,"readElevationSource",null),t.__decorate([n.property({json:{name:"exposurestationid",write:{target:"exposureStationId"}},type:String})],e.default.prototype,"exposureStationId",void 0),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"farDistance",void 0),t.__decorate([c.reader("farDistance",["fardistance","fardist","layer.farDistance"])],e.default.prototype,"readFarDistance",null),t.__decorate([n.property(h("focallength"))],e.default.prototype,"focalLength",void 0),t.__decorate([n.property({type:u,json:{name:"geometry"}})],e.default.prototype,"geometry",null),t.__decorate([s.writer("geometry")],e.default.prototype,"writeGeometry",null),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"horizontalFieldOfView",void 0),t.__decorate([c.reader("horizontalFieldOfView",["horizontalfieldofview","hfov","layer.horizontalFieldOfView"])],e.default.prototype,"readHFOV",null),t.__decorate([n.property({json:{write:!0},type:String})],e.default.prototype,"imagePath",void 0),t.__decorate([c.reader("imagePath",["imagepath"])],e.default.prototype,"readImageURL",null),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"imageRotation",void 0),t.__decorate([c.reader("imageRotation",["imagerotation","imgrot","layer.imageRotation"])],e.default.prototype,"readImageRotation",null),t.__decorate([n.property()],e.default.prototype,"isHorizontal",null),t.__decorate([n.property()],e.default.prototype,"isInspection",null),t.__decorate([n.property()],e.default.prototype,"isNadir",null),t.__decorate([n.property()],e.default.prototype,"isOblique",null),t.__decorate([n.property()],e.default.prototype,"isSpherical",null),t.__decorate([n.property()],e.default.prototype,"location",null),t.__decorate([n.property(v())],e.default.prototype,"matrix",null),t.__decorate([n.property({json:{write:!0},type:String})],e.default.prototype,"name",void 0),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"nearDistance",void 0),t.__decorate([c.reader("nearDistance",["neardistance","neardist","layer.nearDistance"])],e.default.prototype,"readNearDistance",null),t.__decorate([n.property({json:{write:!0,name:"objectid"},type:Number})],e.default.prototype,"objectId",void 0),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"offsetFromStart",void 0),t.__decorate([c.reader("offsetFromStart",["offsetfromstart"])],e.default.prototype,"readOffsetFromStart",null),t.__decorate([n.property()],e.default.prototype,"orientationAccuracy",void 0),t.__decorate([c.reader("orientationAccuracy",["accuracy","orientationaccuracy"])],e.default.prototype,"readOrientationAccuracy",null),t.__decorate([s.writer("orientationAccuracy")],e.default.prototype,"writeOrientationAccuracy",null),t.__decorate([d.enumeration(_.orientedImageryTypeMap)],e.default.prototype,"orientedImageryType",void 0),t.__decorate([c.reader("orientedImageryType",["orientedimagerytype","oitype","layer.orientedImageryType"])],e.default.prototype,"readOIType",null),t.__decorate([n.property({type:Number,json:{write:!0,read:{source:"principalx"}}})],e.default.prototype,"principalX",void 0),t.__decorate([n.property({type:Number,json:{write:!0,read:{source:"principaly"}}})],e.default.prototype,"principalY",void 0),t.__decorate([n.property(v([0,0,0]))],e.default.prototype,"radial",null),t.__decorate([n.property({type:String})],e.default.prototype,"sequenceOrder",void 0),t.__decorate([c.reader("sequenceOrder",["sequenceorder","layer.sequenceOrderField"])],e.default.prototype,"readSequenceOrder",null),t.__decorate([s.writer("sequenceOrder")],e.default.prototype,"writeSequenceOrder",null),t.__decorate([n.property({type:Object})],e.default.prototype,"sourceMap",void 0),t.__decorate([n.property(v([0,0]))],e.default.prototype,"tangential",null),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"verticalFieldOfView",void 0),t.__decorate([c.reader("verticalFieldOfView",["verticalfieldofview","vfov","layer.verticalFieldOfView"])],e.default.prototype,"readVFOV",null),e.default=t.__decorate([l.subclass("esri.layers.orientedImagery.core.ExposurePoint")],e.default),e.default});