// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/libs/gl-matrix-2/math/mat3","../../../chunks/vec32","../../../geometry/Circle","../../../geometry/Mesh","../../../geometry/Multipoint","../../../geometry/Polygon","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/support/Ellipsoid","../../../geometry/support/MeshComponent","../../../geometry/support/MeshVertexAttributes","../../../geometry/support/plane","../../../geometry/support/spatialReferenceUtils","../transformations/utils"],function(e,t,r,a,n,o,c,s,i,l,f,u,h,d,m,y,g,p){"use strict";const x=Math.PI/180;function M(e,t,c,i,l,f,u,h,d,y,g=0,M=0){const F=n.transpose(r.create(),p.createRotationMatrixFromHPR([e,t,g??0])),z=function(e,t){const{cameraHeight:r,cameraPitch:n,farDistance:c,location:i,horizontalFieldOfView:l,nearDistance:f,verticalFieldOfView:u}=e,h=b(i),d=n+u/2>=90==0,y=2*Math.tan(u*x/2)*f,g=2*Math.tan(l*x/2)*f,M=2*Math.tan(u*x/2)*c,w=2*Math.tan(l*x/2)*c;let F,z;z=[0,0,-1],z=p.transformMat3(z,t),F=p.scaleAndAddWithFactor([i.x,i.y,r],z,c,h),d&&(F[2]=0);const R=p.scaleAndAddWithFactor([i.x,i.y,r],z,f,h);let W=[0,1,0];W=p.transformMat3(W,t);let A=[1,0,0];A=p.transformMat3(A,t);let v=[],P=[];f?(P=[{faces:[4,0,3,4,7,3]},{faces:[5,1,2,5,6,2]},{faces:[4,0,1,4,5,1]},{faces:[6,2,3,6,7,3]}],v=v.concat(o.add(a.zeros(),R,o.sub(a.zeros(),p.scaleWithFactor(W,y/2,h),p.scaleWithFactor(A,g/2,h)))),v=v.concat(o.add(a.zeros(),R,o.add(a.zeros(),p.scaleWithFactor(W,y/2,h),p.scaleWithFactor(A,g/2,h)))),v=v.concat(o.sub(a.zeros(),R,o.sub(a.zeros(),p.scaleWithFactor(W,y/2,h),p.scaleWithFactor(A,g/2,h)))),v=v.concat(o.sub(a.zeros(),R,o.add(a.zeros(),p.scaleWithFactor(W,y/2,h),p.scaleWithFactor(A,g/2,h))))):(v=[i.x,i.y,r],P=[{faces:[0,1,2,0,2,3,0,3,4,0,4,1]}]),v=v.concat(o.add(a.zeros(),F,o.sub(a.zeros(),p.scaleWithFactor(W,M/2,h),p.scaleWithFactor(A,w/2,h)))),v=v.concat(o.add(a.zeros(),F,o.add(a.zeros(),p.scaleWithFactor(W,M/2,h),p.scaleWithFactor(A,w/2,h)))),v=v.concat(o.sub(a.zeros(),F,o.sub(a.zeros(),p.scaleWithFactor(W,M/2,h),p.scaleWithFactor(A,w/2,h)))),v=v.concat(o.sub(a.zeros(),F,o.add(a.zeros(),p.scaleWithFactor(W,M/2,h),p.scaleWithFactor(A,w/2,h))));const V=new m.MeshVertexAttributes({position:Float64Array.from(v)});return new s({vertexAttributes:V,components:P,spatialReference:i.spatialReference})}({cameraHeight:c,cameraPitch:t,farDistance:l,location:i,horizontalFieldOfView:h,nearDistance:M,verticalFieldOfView:u},F),R=p.transformMat3([0,0,-1],F),{x:W,y:A}=i,v=p.scaleAndAddWithFactor([W,A,c],R,l,f),P=2*Math.tan(u*x/2)*l,V=2*Math.tan(h/d*x/2)*l,D=p.transformMat3([0,1,0],F),I=p.transformMat3([1,0,0],F),S=p.scaleWithFactor(D,P/2,f),H=p.scaleWithFactor(I,V/2,f),O=o.sub(a.zeros(),S,H),j=o.add(a.zeros(),S,H),C=w([o.add(a.zeros(),v,O),o.add(a.zeros(),v,j),o.sub(a.zeros(),v,O),o.sub(a.zeros(),v,j)],c,i,f);return C.push(C[0]),y.addRing(C),z}function w(e,t,r,n){return e.map(e=>function(e,t,r,n){{const c=Math.sqrt((e[2]-t)**2+(Math.sqrt((e[0]-r.x)**2+(e[1]-r.y)**2)/n)**2)*n,s=p.scaleWithFactor(o.sub(a.zeros(),[e[0],e[1],e[2]],[r.x,r.y,t]),1/c,1/n),i=t/(t-e[2]),l={x:(1-i)*r.x+i*e[0],y:(1-i)*r.y+i*e[1],z:(1-i)*t+i*e[2]},f=Math.sqrt((l.z-t)**2+(Math.sqrt((l.x-r.x)**2+(l.y-r.y)**2)/n)**2)*n,u=p.scaleWithFactor(o.sub(a.zeros(),[l.x,l.y,l.z],[r.x,r.y,t]),1/f,1/n);return F(s[0],u[0])&&F(s[1],u[1])&&F(s[2],u[2])||e[2]>=0?[e[0],e[1],0]:[l.x,l.y,l.z]}}(e,t,r,n))}function F(e,t){return Math.sign(e)!==Math.sign(t)}function b(e){return e&&g.isWebMercator(e?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*e.y/h.earth.radius))):1}function z(e,t,r,n){const{coefficients:o,vertexPositions:c}=n,s=a.zeros();y.intersectRay(o,{origin:e,direction:t},s)&&c.splice(3*r,3,...s)}function R(e,t,r,n){if(!n)return;const o=a.zeros();y.intersectRay(n.coefficients,{origin:e,direction:t},o)&&n.vertexPositions.splice(3*r,3,...o)}async function W(e,r,a,n){if(r.equals(a))return e;const o=e.reduce((e,t,r)=>{const a=Math.floor(r/3);return e[a]||(e[a]=new Array),e[a].push(t),e},new Array),{points:c}=await f.projectWithZConversion(new i(o,r),a,n);return t.throwIfAborted(n),c.flat()}function A(e,t="far"){const r=y.create();let a;switch(t){case"far":if(a=Array.from(15===e.length?e.slice(3):e.slice(12)),y.fromArray(r,a,!1))return{coefficients:r,vertexPositions:a};break;case"near":if(a=Array.from(e.slice(0,12)),15===e.length||!y.fromArray(r,a,!1))return;return{coefficients:r,vertexPositions:a}}}const v=(e,t=!1)=>{if(t&&e-2<=4||e<=4||e%2!=0)throw new Error("Invalid number of vertices");const r=[],a=e/2,n=Math.round((t?e-2:e)/2);for(let o=0;o<n;o++){const n=o+a,c=t?n+1:n,s=c%e,i=(t?n:c+1)%e;r.push({faces:new Uint32Array([o,i,s,o,o+1,s])})}return r};function P(e,t=!1){if(e<3||t&&e-1<3)throw new Error("Invalid number of vertices");const r=[],a=t?e-2:e-1;for(let e=0;e<a;e++)r.push({faces:new Uint32Array([0,e+1,e+2])});return r}const V=e=>e.map(e=>new d(e)),D=e=>e.length/3;e.checkIfPolygonContainsSelectedPoint=function(e,t){return e.contains(t)},e.computePolygonForInspection=function(e){const{spatialReference:t,x:r,y:a}=e.geometry,{cameraHeading:n,cameraPitch:o,farDistance:c,nearDistance:s}=e,i=b(e.geometry),f=new l({spatialReference:t}),u=Math.abs(1.44*c*i);let h=Math.abs(1.44*s*i);(o<20||null==n)&&(h=u);const d=[];return d[0]={x:r+u*Math.sin((n-45)*x),y:a+u*Math.cos((n-45)*x)},d[1]={x:r+u*Math.sin((n+45)*x),y:a+u*Math.cos((n+45)*x)},d[2]={x:r+h*Math.sin((n+135)*x),y:a+h*Math.cos((n+135)*x)},d[3]={x:r+h*Math.sin((n+225)*x),y:a+h*Math.cos((n+225)*x)},f.addRing([[d[0].x,d[0].y,0],[d[1].x,d[1].y,0],[d[2].x,d[2].y,0],[d[3].x,d[3].y,0],[d[0].x,d[0].y,0]]),f},e.createCoveragePolygon=function(e){const t=p.convertToSRUnits(e,e.geometry.spatialReference);return e.isSpherical?function(e){const{geometry:t,farDistance:r,objectId:a,nearDistance:n,cameraHeight:o}=e,i=p.getWebMercatorScalingFactor(t.y,t.spatialReference),l=new c({center:t.clone(),radius:r*i});if(l.imageID=a,n){const e=new c({center:t.clone(),radius:n*i});l.addRing(e.rings[0])}const f=t.clone();f.z=o-r*i;const u=s.createSphere(f,{size:2*r*i});return u.imageID=a,{polygon:l,frustum:u}}(t):function(e){const{horizontalFieldOfView:t,verticalFieldOfView:r,geometry:a,cameraHeading:n}=e,o=p.getWebMercatorScalingFactor(a.y,a.spatialReference);let c=e.cameraPitch,s=e.cameraRoll??0,i=150;t>150&&(c=90,s=0,i=5);const f=Math.ceil(t/i),u=function(e,t,r){const a=[];if(e%2==0)for(let n=0;n<e/2;n++)a.push(t-r/e*(n+.5),t+r/e*(n+.5));else{a.push(t);for(let n=1;n<e/2;n++)a.push(t-r/e*n,t+r/e*n)}return a.sort(),a}(f,n,t);let h=e.farDistance?e.farDistance*o:e.cameraHeight*o/Math.cos(c*x);e.cameraPitch+r/2>=90&&(h=(e.farDistance||20)*o);const d=new l({spatialReference:a?.spatialReference});d.imageID=e.objectId;let m=null;for(const n of u)m=M(n,c,e.cameraHeight,a,h,o,r,t,f,d,s,e.nearDistance);return m.imageID=e.objectId,{polygon:d,frustum:m}}(t)},e.limitZToGround=w,e.projectVertices=W,e.resizePolygon=function(e,t){const r=1+t/100;if("esri.geometry.Circle"===e.declaredClass){const{radius:t,center:a}=e,n=new c({radius:t*r,center:a});return e.rings.length>1&&n.addRing(e.rings[1]),n}if("esri.geometry.Polygon"===e.declaredClass){const t=new l({spatialReference:e.spatialReference}),n=e.centroid;if(n){const c=[];for(let t=0;t<e.rings[0].length;t++){const s=Math.sqrt((n.x-e.rings[0][t][0])**2+(n.y-e.rings[0][t][1])**2),i=p.scaleWithFactor(o.sub(a.zeros(),[e.rings[0][t][0],e.rings[0][t][1],0],[n.x,n.y,0]),1/s,1),l=p.scaleAndAddWithFactor([n.x,n.y,0],i,s*r,1);c.push({x:l[0],y:l[1]})}t.addRing([[c[0].x,c[0].y,0],[c[1].x,c[1].y,0],[c[2].x,c[2].y,0],[c[3].x,c[3].y,0],[c[0].x,c[0].y,0]])}return t}return e},e.updateFrustum=async function(e,t,r){const{cameraHeight:a,cameraLocation:n,cameraPitch:o,frustumVertices:c,horizontalFieldOfView:i,imageHeight:l,imageWidth:f,inSRS:h,outSRS:d,verticalFieldOfView:y,cameraRoll:g,options:x}=r,M=new u(h),w=new u(d),F=p.computeHFOVAndVFOV(i,y,g??0),b=c.length>15;return o+F.vfov/2>=90?await async function(e,t,r,a,n,o,c,i){let l,f=c?new Array:[e[0],e[1],e[2]],u=new Array;for(const n of t)c?(l=p.projectiveTransform([n[0],n[1],1],[[0,0,1],[r,0,1],[r,a,1],[0,a,1]],[[e[0],e[1],e[2]],[e[3],e[4],e[5]],[e[6],e[7],e[8]],[e[9],e[10],e[11]]]),f=f.concat(...l),l=p.projectiveTransform([n[0],n[1],1],[[0,0,1],[r,0,1],[r,a,1],[0,a,1]],[[e[12],e[13],e[14]],[e[15],e[16],e[17]],[e[18],e[19],e[20]],[e[21],e[22],e[23]]]),u=u.concat(...l)):(l=p.projectiveTransform([n[0],n[1],1],[[0,0,1],[r,0,1],[r,a,1],[0,a,1]],[[e[3],e[4],e[5]],[e[6],e[7],e[8]],[e[9],e[10],e[11]],[e[12],e[13],e[14]]]),f=f.concat(...l));f=f.concat(u);const h=await W(f,n,o,i),d=D(h);return new s({vertexAttributes:new m.MeshVertexAttributes({position:h}),components:V(c?v(d,!0):P(d,!0)),spatialReference:o})}(c,e,f,l,M,w,b,x):await async function(e,t,r,a,n,o,c,i,l){const f=function(e,t,r,a,n){const o=A(e),c=A(e,"near");if(!o)return;const s=t.length;for(let e=0;e<s;e++){const t=Array.from(r[e]),s=[t[0]-a[0],t[1]-a[1],t[2]-(a[2]??n)];R(a,s,e,c),z(a,s,e,o)}return{farPlane:o,nearPlane:c}}(e,t,r,a,n);if(!f)return;const{farPlane:u,nearPlane:h}=f,d=await W([...h?.vertexPositions??e.slice(0,3),...u.vertexPositions],c,i,l),y=D(d);return new s({vertexAttributes:new m.MeshVertexAttributes({position:d}),components:V(o?v(y,!0):P(y,!0)),spatialReference:i})}(c,e,t,n,a,b,M,w,x)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});