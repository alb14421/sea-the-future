// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../chunks/tslib.es6","../request","../core/Error","../core/Logger","../core/mathUtils","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/persistable","../chunks/vec32","../core/libs/gl-matrix-2/factories/vec3f64","../geometry/ellipsoidUtils","../geometry/Extent","../geometry/SpatialReference","../geometry/projection/projectBuffer","./Layer","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/CustomParametersMixin","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./support/commonProperties","./support/SceneModifications","../support/elevationInfoUtils","../chunks/persistableUrlUtils"],function(e,t,r,i,o,a,s,n,l,c,d,p,u,m,f,y,h,x,g,_,v,S,b,E,M,A,I,L,w,R,V){"use strict";var N;let T=class extends(b.ArcGISService(M.OperationalLayer(A.PortalLayer(I.ScaleRangeLayer(a.MultiOriginJSONMixin(E.CustomParametersMixin(S.APIKeyMixin(v)))))))){static{N=this}readModifications(e,t,r){this._modificationsSource={url:V.fromJSON(e,r),context:r}}initialize(){this.addHandles(n.on(()=>this.modifications,"after-changes",()=>this.modifications=this.modifications,n.sync))}constructor(e){super(e),this.operationalLayerType="IntegratedMesh3DTilesLayer",this.modifications=null,this._modificationsSource=null,this.spatialReference=new g({wkid:4326,vcsWkid:115700}),this.fullExtent=new x(-180,-90,180,90,this.spatialReference),this.url=null,this.type="integrated-mesh-3dtiles",this.path=null,this.minScale=0,this.maxScale=0,this.rootTilesetJSON=null}set elevationInfo(e){null!=e&&"absolute-height"!==e.mode||this._set("elevationInfo",e),this._validateElevationInfo(e)}_verifyArray(e,t){if(!Array.isArray(e)||e.length<t)return!1;for(const t of e)if("number"!=typeof t)return!1;return!0}static{this.googleIMFullExtent={xmin:-180,ymin:-90,zmin:-450,xmax:180,ymax:90,zmax:8850}}_initFullExtent(){const e=this.rootTilesetJSON?.root?.boundingVolume;if(!e)return;const{spatialReference:t}=this;if(e.box){const r=e?.box;if(r[3]>U&&r[7]>U&&r[11]>U)return void(this.fullExtent=new x({...N.googleIMFullExtent,spatialReference:t}))}const r=this.rootTilesetJSON?.root?.transform,i=y.create();if(e.region&&this._verifyArray(e.region,6)){const r=e.region,i=o.rad2deg(r[0]),a=o.rad2deg(r[1]),s=r[4],n=o.rad2deg(r[2]),l=o.rad2deg(r[3]),c=r[5];this.fullExtent=new x({xmin:i,ymin:a,zmin:s,xmax:n,ymax:l,zmax:c,spatialReference:t})}else if(e.sphere&&this._verifyArray(e.sphere,4)){const o=e.sphere,a=y.fromValues(o[0],o[1],o[2]),s=o[3]/Math.sqrt(3),n=y.create();f.subtract(n,a,y.fromValues(s,s,s));const l=y.create();if(f.add(l,a,y.fromValues(s,s,s)),r&&this._verifyArray(r,16)){const e=r;f.transformMat4(i,n,e),f.copy(n,i),f.transformMat4(i,l,e),f.copy(l,i)}_.projectBuffer(n,h.WGS84ECEFSpatialReferenceLike,0,n,g.WGS84,0),_.projectBuffer(l,h.WGS84ECEFSpatialReferenceLike,0,l,g.WGS84,0);const c=y.create(),d=y.create();f.min(c,n,l),f.max(d,n,l),this.fullExtent=new x({xmin:c[0],ymin:c[1],zmin:c[2],xmax:d[0],ymax:d[1],zmax:d[2],spatialReference:t})}else if(e.box&&this._verifyArray(e.box,12)){const i=e.box,o=y.fromValues(i[0],i[1],i[2]),a=y.fromValues(i[3],i[4],i[5]),s=y.fromValues(i[6],i[7],i[8]),n=y.fromValues(i[9],i[10],i[11]),l=[];for(let e=0;e<8;++e)l.push(y.create());if(f.add(l[0],o,a),f.add(l[0],l[0],s),f.add(l[0],l[0],n),f.sub(l[1],o,a),f.add(l[1],l[1],s),f.add(l[1],l[1],n),f.add(l[2],o,a),f.sub(l[2],l[2],s),f.add(l[2],l[2],n),f.sub(l[3],o,a),f.sub(l[3],l[3],s),f.add(l[3],l[3],n),f.add(l[4],o,a),f.add(l[4],l[4],s),f.sub(l[4],l[4],n),f.sub(l[5],o,a),f.add(l[5],l[5],s),f.sub(l[5],l[5],n),f.add(l[6],o,a),f.sub(l[6],l[6],s),f.sub(l[6],l[6],n),f.sub(l[7],o,a),f.sub(l[7],l[7],s),f.sub(l[7],l[7],n),r&&this._verifyArray(r,16)){const e=r;for(let t=0;t<8;++t)f.transformMat4(l[t],l[t],e)}const c=y.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),d=y.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let e=0;e<8;++e)_.projectBuffer(l[e],h.WGS84ECEFSpatialReferenceLike,0,l[e],g.WGS84,0),f.min(d,d,l[e]),f.max(c,c,l[e]);this.fullExtent=new x({xmin:d[0],ymin:d[1],zmin:d[2],xmax:c[0],ymax:c[1],zmax:c[2],spatialReference:t})}}async load(e){return this.addResolvingPromise(this._doLoad(e)),this}async _doLoad(e){const i=null!=e?e.signal:null;try{await this.loadFromPortal({supportedTypes:["3DTiles Service"],validateItem:e=>{if(e.typeKeywords?.includes("IntegratedMesh"))return!0;throw new r("portal:invalid-layer-item-type","Invalid layer item, expected '${expectedType}' ",{expectedType:"3DTiles Service containing IntegratedMesh"})}},e)}catch(e){s.throwIfAbortError(e)}if(null!=this._modificationsSource){const t=await w.fromUrl(this._modificationsSource.url,this.spatialReference,e);this.setAtOrigin("modifications",t,this._modificationsSource.context.origin),this._modificationsSource=null}if(this.url){const e=t(this.url,{query:{...this.customParameters,token:this.apiKey},responseType:"json",signal:i}).then(e=>{this.rootTilesetJSON=e.data,this._initFullExtent()},e=>{s.throwIfAbortError(e)});await e}}beforeSave(){if(null!=this._modificationsSource)return this.load().then(()=>{},()=>{})}async fetchAttributionData(){return this.load().then(()=>({}))}_validateElevationInfo(e){const t="Integrated mesh 3d tiles layers";R.logInvalidElevationInfoWarning(i.getLogger(this),R.elevationModeRequiredMessage(t,"absolute-height",e)),R.logInvalidElevationInfoWarning(i.getLogger(this),R.featureExpressionUnsupportedMessage(t,e))}};e.__decorate([l.property({type:["IntegratedMesh3DTilesLayer"]})],T.prototype,"operationalLayerType",void 0),e.__decorate([l.property({type:w,clonable:e=>e.clone()}),m.persistable({origins:["web-scene","portal-item"],type:"resource",prefix:"modifications"})],T.prototype,"modifications",void 0),e.__decorate([p.reader(["web-scene","portal-item"],"modifications")],T.prototype,"readModifications",null),e.__decorate([l.property({type:g})],T.prototype,"spatialReference",void 0),e.__decorate([l.property({type:x})],T.prototype,"fullExtent",void 0),e.__decorate([l.property(L.elevationInfo)],T.prototype,"elevationInfo",null),e.__decorate([l.property({type:["show","hide"]})],T.prototype,"listMode",void 0),e.__decorate([l.property(L.url)],T.prototype,"url",void 0),e.__decorate([l.property({readOnly:!0})],T.prototype,"type",void 0),e.__decorate([l.property({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],T.prototype,"path",void 0),e.__decorate([l.property({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:!1,write:!1}}}})],T.prototype,"minScale",void 0),e.__decorate([l.property({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:!1,write:!1}}}})],T.prototype,"maxScale",void 0),T=N=e.__decorate([u.subclass("esri.layers.IntegratedMesh3DTilesLayer")],T);const U=7645211;return T});