// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../core/Evented","../../core/lang","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/subclass","../../versionManagement/support/versionManagementUtils"],function(e,t,i,s,n,d,o,r,a,l){"use strict";const c=new i.EventEmitter;function h(e){return c.on("apply-edits",new WeakRef(e))}function u(e){return c.on("update-moment",new WeakRef(e))}const m=Symbol();function p(e){return null!=e&&"object"==typeof e&&"gdbVersion"in e}function b(e,t,i){const s=new URL(e).host,n=l.defaultVersionNameLookup.get(s),d=e=>!e||e===n;return d(t)&&d(i)||t===i}e.EditBusLayer=e=>{var i;const n=e;let o=class extends n{static{i=m}constructor(...e){super(...e),this[i]=!0,this._applyEditsHandler=e=>{const{serviceUrl:t,layerId:i,gdbVersion:n,mayReceiveServiceEdits:d,result:o}=e,r=t===this.url,a=null!=i&&null!=this.layerId&&i===this.layerId,l=p(this),c=p(this)&&b(t,n,this.gdbVersion);if(!r||l&&!c||!a&&!d)return;const h=o.then(e=>{if(this.lastEditsEventDate=new Date,a&&(e.addedFeatures.length||e.updatedFeatures.length||e.deletedFeatures.length||e.addedAttachments.length||e.updatedAttachments.length||e.deletedAttachments.length))return this.emit("edits",s.clone(e)),e;const i=e.editedFeatures?.find(({layerId:e})=>e===this.layerId);if(i){const{adds:t,updates:n,deletes:d}=i.editedFeatures,o={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:t?t.map(({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]})):[],deletedFeatures:d?d.map(({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]})):[],updatedFeatures:n?n.map(({current:{attributes:e}})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]})):[],editedFeatures:s.clone(e.editedFeatures),exceededTransferLimit:!1,historicMoment:s.clone(e.historicMoment)};return this.emit("edits",o),o}const d={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:s.clone(e.editedFeatures),exceededTransferLimit:!1,historicMoment:s.clone(e.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(t,n,d.historicMoment)&&this.emit("edits",d),d}).then(e=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(t,n,e.historicMoment)&&(this.historicMoment=e.historicMoment),e));this.emit("apply-edits",{result:h})},this._updateMomentHandler=e=>{const{serviceUrl:t,gdbVersion:i,moment:s}=e,n=t===this.url,d=p(this),o=p(this)&&b(t,i,this.gdbVersion),r=p(this)&&!b(t,this.gdbVersion,null);n&&d&&o&&r&&"historicMoment"in this&&this.historicMoment!==s&&(this.historicMoment=s)},this.when().then(()=>{this.addHandles(h(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(u(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(e,t,i){return"historicMoment"in this&&this.historicMoment!==i&&l.isVersionInEditSession(e,t)}};return t.__decorate([d.property()],o.prototype,"lastEditsEventDate",void 0),o=t.__decorate([a.subclass("esri.layers.mixins.EditBusLayer")],o),o},e.emitApplyEditsEvent=function(e,t,i=null,s=!1){const d=n.createResolver();return s=null==t||s,c.emit("apply-edits",{serviceUrl:e,layerId:t,gdbVersion:i,mayReceiveServiceEdits:s,result:d.promise}),d},e.emitUpdateMomentEvent=function(e,t,i=null,s){c.emit("update-moment",{serviceUrl:e,layerId:t,gdbVersion:i,moment:s})},e.isEditBusLayer=function(e){return null!=e&&"object"==typeof e&&m in e},e.isLayerWithGDBVersion=p,e.onApplyEditsEvent=h,e.onUpdateMomentEvent=u,e.versionMatches=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});