// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../core/Collection","../../core/CollectionFlattener","../../core/Error","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/utils","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/PropertyOrigin","../support/Sublayer","../support/sublayerUtils"],function(e,r,s,t,a,l,o,i,n,u,y,c,b,d,h){"use strict";const p=s.ofType(d);function S(e,r){e&&e.forEach(e=>{r(e),e.sublayers&&e.sublayers.length&&S(e.sublayers,r)})}e.SublayersOwner=e=>{const n=e;let u=class extends n{constructor(...e){super(...e),this.allSublayers=new t({getCollections:()=>[this.sublayers],getChildrenFunction:e=>e.sublayers}),this.sublayersSourceJSON={2:{},3:{},4:{},5:{},6:{}},this.subtables=null,this.addHandles([o.watch(()=>this.sublayers,(e,r)=>this._handleSublayersChange(e,r),o.sync),o.watch(()=>this.subtables,(e,r)=>this._handleSublayersChange(e,r),o.sync)])}destroy(){this.allSublayers.destroy()}readSublayers(e,r){if(!r||!e)return;const{sublayersSourceJSON:s}=this,t=b.nameToId(r.origin);if(t<2)return;if(s[t]={context:r,visibleLayers:e.visibleLayers||s[t].visibleLayers,layers:e.layers||s[t].layers},t>2)return;this._set("serviceSublayers",this.createSublayersForOrigin("service").sublayers);const{sublayers:a,origin:l}=this.createSublayersForOrigin("web-document"),o=y.getProperties(this);o.setDefaultOrigin(l),this._set("sublayers",new p(a)),o.setDefaultOrigin("user")}findSublayerById(e){return this.allSublayers.find(r=>r.id===e)}createServiceSublayers(){return this.createSublayersForOrigin("service").sublayers}createSublayersForOrigin(e){let r;const s="web-document"===e?b.nameToId("web-map"):b.nameToId(e);let t=2,a=this.sublayersSourceJSON[2].layers,l=this.sublayersSourceJSON[2].context,o=null;const i=[3,4,5].filter(e=>e<=s);for(const e of i){const r=this.sublayersSourceJSON[e];h.isSublayerOverhaul(r.layers)&&(t=e,a=r.layers,l=r.context,r.visibleLayers&&(o={visibleLayers:r.visibleLayers,context:r.context}))}const n=[3,4,5].filter(e=>e>t&&e<=s);let u=null;for(const e of n){const{layers:s,visibleLayers:t,context:a}=this.sublayersSourceJSON[e];s&&(u={layers:s,context:a},r??=e),t&&(o={visibleLayers:t,context:a})}const y=function(e,r){const s=[],t={};return e?(e.forEach(e=>{const a=new d;if(a.read(e,r),t[a.id]=a,null!=e.parentLayerId&&-1!==e.parentLayerId){const r=t[e.parentLayerId];r.sublayers||(r.sublayers=[]),r.sublayers.unshift(a)}else s.unshift(a)}),s):s}(a,l),c=new Map,f=new Set;if(u)for(const e of u.layers)c.set(e.id,e);if(o?.visibleLayers)for(const e of o.visibleLayers)f.add(e);return S(y,e=>{u&&e.read(c.get(e.id),u.context),o&&e.read({defaultVisibility:f.has(e.id)},o.context)}),{origin:b.idToName(t),originWithPartialOverrides:r?b.idToName(r):null,sublayers:new p({items:y})}}read(e,r){super.read(e,r),this.readSublayers(e,r)}_handleSublayersChange(e,r){r&&(r.forEach(e=>{e.parent=null,e.layer=null}),this.removeHandles("sublayers-owner")),e&&(e.forEach(e=>{e.parent=this,e.layer=this}),this.addHandles([e.on("after-add",({item:e})=>{e.parent=this,e.layer=this}),e.on("after-remove",({item:e})=>{e.parent=null,e.layer=null})],"sublayers-owner"),"tile"===this.type&&this.addHandles(e.on("before-changes",e=>{l.getLogger("esri.layers.TileLayer").error(new a("tilelayer:sublayers-non-modifiable","Sublayer can't be added, moved, or removed from the layer's sublayers",{layer:this})),e.preventDefault()}),"sublayers-owner"))}};return r.__decorate([i.property({readOnly:!0})],u.prototype,"allSublayers",void 0),r.__decorate([i.property({readOnly:!0,type:s.ofType(d)})],u.prototype,"serviceSublayers",void 0),r.__decorate([i.property({value:null,type:p,json:{read:!1,write:{allowNull:!0,ignoreOrigin:!0}}})],u.prototype,"sublayers",void 0),r.__decorate([i.property({readOnly:!0})],u.prototype,"sublayersSourceJSON",void 0),r.__decorate([i.property({type:p,json:{read:{source:"tables"}}})],u.prototype,"subtables",void 0),u=r.__decorate([c.subclass("esri.layers.mixins.SublayersOwner")],u),u},e.forEachSublayer=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});