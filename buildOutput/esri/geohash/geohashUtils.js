// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../core/has","../core/mathUtils","../core/libs/gl-matrix-2/math/vec2","../core/libs/gl-matrix-2/factories/vec2f64","../geometry/Polygon","../geometry/SpatialReference","../geometry/support/aaBoundingRect","../geometry/support/Ellipsoid","../layers/graphics/featureConversionUtils","../layers/graphics/OptimizedGeometry","../layers/graphics/data/projectionSupport"],function(t,e,o,n,r,c,s,a,h,i,l,u){"use strict";const f=16,g=r.create(),d=r.create();function m(t,e,n,r){if(r.isWebMercator){const r=o.rad2deg(t/h.earth.radius),c=r-360*Math.floor((r+180)/360),s=[0,0];return v(s,0,o.rad2deg(Math.PI/2-2*Math.atan(Math.exp(-e/h.earth.radius))),c,n),s}const c={x:t,y:e},a=u.project(c,r,s.WGS84);if(!a)return null;const i=[0,0];return v(i,0,a.y,a.x,n),i}function p(t){return t<=57?t-48:t<=104?t-88:t<=107?t-89:t<=110?t-90:t-91}function y(t){return"0123456789bcdefghjkmnpqrstuvwxyz"[t]}function x(t){return(t[0]+t[1])/2}function G(t,e){const o=x(t),n=e,r=!e;t[0]=r*t[0]+n*o,t[1]=r*o+n*t[1]}function M(t,e){const o=e>x(t);return G(t,o),o}function v(t,e,o,n,r){r%2&&(r+=1);let c=0,s=0,a=-90,h=90,i=-180,l=180;for(let t=0;t<r/2;t++){for(let e=0;e<5;e++){const o=(i+l)/2,r=n>o?1:0;c|=r<<29-(e+5*t),i=(1-r)*i+r*o,l=(1-r)*o+r*l}for(let e=0;e<5;e++){const n=(a+h)/2,r=o>n?1:0;s|=r<<29-(e+5*t),a=(1-r)*a+r*n,h=(1-r)*n+r*h}}t[2*e]=c,t[2*e+1]=s}function S(t,e){return e?1&t|(4&t)>>1|(f&t)>>2:(2&t)>>1|(8&t)>>2}function B(t,e){return e?(2&t)>>1|(8&t)>>2:1&t|(4&t)>>1|(f&t)>>2}t.convertGeohash32ToXY=function(t,e){let o=0,n=0,r=30,c=30;for(let t=0;t<e.length;t++){const s=p(e.charCodeAt(t)),a=t%2==0;r-=a?3:2,c-=a?2:3,o|=S(s,a)<<r,n|=B(s,a)<<c}return{geohashX:o,geohashY:n}},t.decodeBase32Char=p,t.decodeGeohash=function(t,e){const o=n.set(g,-90,90),r=n.set(d,-180,180);for(let t=0;t<e.length;t++){const n=p(e.charCodeAt(t));t%2==0?(G(r,!!(f&n)),G(r,!!(4&n)),G(r,!!(1&n)),G(o,!!(8&n)),G(o,!!(2&n))):(G(o,!!(f&n)),G(o,!!(4&n)),G(o,!!(1&n)),G(r,!!(8&n)),G(r,!!(2&n)))}return t[0]=x(o),t[1]=x(r),t},t.decodeGeohashXY=function(t,e){let o=-90,n=90,r=-180,c=180;for(let s=0;s<e;s++){const e=Math.ceil((s+1)/2),a=Math.floor((s+1)/2),h=1-s%2,i=30-(3*e+2*a),l=30-(2*e+3*a),u=3*h+2*(1-h),f=2*h+3*(1-h),g=3*h+7*(1-h)<<l,d=(7*h+3*(1-h)<<i&t.geohashX)>>i,m=(g&t.geohashY)>>l;for(let t=u-1;t>=0;t--){const e=(r+c)/2,o=d&1<<t?1:0;r=(1-o)*r+o*e,c=(1-o)*e+o*c}for(let t=f-1;t>=0;t--){const e=(o+n)/2,r=m&1<<t?1:0;o=(1-r)*o+r*e,n=(1-r)*e+r*n}}return[r,o,c,n]},t.encodeBase32Char=y,t.encodeGeohash=function(t,e,o){let r="";const c=n.set(g,-90,90),s=n.set(d,-180,180);for(let n=0;n<o;n++){let o=0;n%2?(o|=M(c,t)<<4,o|=M(s,e)<<3,o|=M(c,t)<<2,o|=M(s,e)<<1,o|=0|M(c,t)):(o|=M(s,e)<<4,o|=M(c,t)<<3,o|=M(s,e)<<2,o|=M(c,t)<<1,o|=0|M(s,e)),r+=y(o)}return r},t.getGeohash=m,t.getGeohashBounds=function(t,e,o,n){const r=[t.xmin,t.ymin,t.xmax,t.ymax],h=c.fromExtent(a.toExtent(r,n)),f=u.project(h,n,s.WGS84,{densificationStep:64*e});if(!f)return null;const g=i.convertFromPolygon(new l,f,!1,!1),d=g.coords.filter((t,e)=>!(e%2)),p=g.coords.filter((t,e)=>e%2),y=Math.min(...d),x=Math.min(...p),G=Math.max(...d),M=Math.max(...p),v=m(y,x,o,s.WGS84),S=m(G,M,o,s.WGS84);return v&&S?{bounds:r,geohashBounds:{xLL:v[0],yLL:v[1],xTR:S[0],yTR:S[1]},level:o}:null},t.getRelativeGeohash=function t(e,o,n){const r=!((e.length-1)%2),c=e.slice(0,-1),s=p(e.charCodeAt(e.length-1));let a=0,h=0,i=0,l=0;r?(a=8,h=4,i=1&s|(4&s)>>1|(f&s)>>2,l=(2&s)>>1|(8&s)>>2):(a=4,h=8,l=1&s|(4&s)>>1|(f&s)>>2,i=(2&s)>>1|(8&s)>>2);const u=i+o,g=l+n,d=Math.floor(u/a),m=Math.floor(g/h),x=y(function(t,e,o){return o?1&t|(1&e)<<1|(2&t)<<1|(2&e)<<2|(4&t)<<2:1&e|(1&t)<<1|(2&e)<<1|(2&t)<<2|(4&e)<<2}(u-d*a,g-m*h,r));return e.length>1&&(d||m)?t(c,d,m)+x:c+x},t.setGeohashBuf=v,t.setGeohashXY=function(t,e,o,n){n%2&&(n+=1);let r=0,c=0,s=-90,a=90,h=-180,i=180;for(let t=0;t<n/2;t++){for(let e=0;e<5;e++){const n=(h+i)/2,c=o>n?1:0;r|=c<<29-(e+5*t),h=(1-c)*h+c*n,i=(1-c)*n+c*i}for(let o=0;o<5;o++){const n=(s+a)/2,r=e>n?1:0;c|=r<<29-(o+5*t),s=(1-r)*s+r*n,a=(1-r)*n+r*a}}t.geohashX=r,t.geohashY=c},t.unpackXBits=S,t.unpackYBits=B,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});