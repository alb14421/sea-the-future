// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../geometry/GeometryCursor","../../../geometry/geometryCursorCollectUtils","../CIMCursor","../CurveHelper"],function(t,e,r,n,o){"use strict";const s=1.7320508075688772;class i{static{this.instance=null}static local(){return null===i.instance&&(i.instance=new i),i.instance}execute(t,e,r){return new c(t,e,r)}}class c extends n.PathEffectCursor{constructor(t,e,r){super(t,!1,!0),this._curveHelper=new o.CurveHelper,this._width=(void 0!==e.width?e.width:5)*r,this._arrowType=void 0!==e.geometricEffectArrowType?e.geometricEffectArrowType:void 0!==e.arrowType?e.arrowType:"OpenEnded",this._offsetFlattenError=o.pixelTolerance*r}processPath(t){const r=e.GeometryCursor.createEmptyOptimizedCIM(t.geometryType);switch(this._arrowType){case"OpenEnded":default:this._constructSimpleArrow(r,t,!0);break;case"Block":this._constructSimpleArrow(r,t,!1);break;case"Crossed":this._constructCrossedArrow(r,t)}return r}_constructSimpleArrow(t,e,n){const o=e.pathLength();let s=this._width;o<2*s&&(s=o/2);const i=this._curveHelper.getSubCurve(e,0,o-s);if(!i||!i.nextPath())return;i.seekPathStart();const c=s/2;if(this._curveHelper.isEmpty(i))return;const u=r.collectPath(i),h=this._constructOffset(u,-c);if(!h)return;const l=this._constructOffset(u,c);if(!l)return;const P=this._constructArrowBasePoint(h,-c/2);if(!P)return;const a=this._constructArrowBasePoint(l,c/2);if(!a)return;e.seekInPath(e.pathSize-1);const p=[e.x,e.y];t.pushPath(l),t.nextPath(),t.nextPoint(),t.setControlPoint(),t.pushPoint(a),t.nextPoint(),t.setControlPoint(),t.pushPoint(p),t.nextPoint(),t.setControlPoint(),t.pushPoint(P),t.nextPoint(),t.setControlPoint(),t.pushPoints(h.reverse()),t.setControlPoint(),n||(t.setControlPointAt(0),t.setControlPointAt(t.pathSize-1),t.pushPoint(l[0])),t.reset()}_constructCrossedArrow(t,e){const n=e.pathLength();let o=this._width;n<o*(1+s+1)&&(o=n/(1+s+1)),e.seekPathStart();const i=this._curveHelper.getSubCurve(e,0,n-o*(1+s));if(!i)return;i.nextPath();const c=o/2;if(this._curveHelper.isEmpty(i))return;const u=r.collectPath(i),h=this._constructOffset(u,c);if(!h)return;const l=this._constructOffset(u,-c);if(!l)return;const P=this._curveHelper.getSubCurve(e,0,n-o);if(!P)return;if(P.nextPath(),this._curveHelper.isEmpty(P))return;const a=r.collectPath(P),p=this._constructOffset(a,c);if(!p)return;const f=this._constructOffset(a,-c);if(!f)return;const _=p[p.length-1],C=this._constructArrowBasePoint(p,c/2);if(!C)return;const w=f[f.length-1],d=this._constructArrowBasePoint(f,-c/2);if(!d)return;e.seekInPath(e.pathSize-1);const x=[e.x,e.y];t.pushPath(h),t.nextPath(),t.nextPoint(),t.setControlPoint(),t.pushPoint(w),t.nextPoint(),t.setControlPoint(),t.pushPoint(d),t.nextPoint(),t.setControlPoint(),t.pushPoint(x),t.nextPoint(),t.setControlPoint(),t.pushPoint(C),t.nextPoint(),t.setControlPoint(),t.pushPoint(_),t.nextPoint(),t.setControlPoint(),t.pushPoints(l.reverse()),t.nextPoint(),t.setControlPoint(),t.reset()}_constructOffset(t,e){return this._curveHelper.offset(t,e,"Rounded",4,this._offsetFlattenError)}_constructArrowBasePoint(t,e){if(!t||t.length<2)return null;const r=t[t.length-2],n=t[t.length-1],o=[n[0]-r[0],n[1]-r[1]];return this._curveHelper.normalize(o),[n[0]+o[1]*e,n[1]-o[0]*e]}}t.EffectArrow=i,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});