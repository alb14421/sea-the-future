// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/Logger","./animationDebugFlags","./defaultCIMValues","./SDFHelper","./utils"],function(t,e,n,o,r,a){"use strict";function i(t){return!!t.animations&&t.animations.length>0}function s(t){return!!t.animations&&t.animations.some(t=>"CIMSymbolAnimationMoveAlongLine"===t.type)}const c=new Set(["CIMSymbolAnimationOffset","CIMSymbolAnimationRotation","CIMSymbolAnimationSize","CIMSymbolAnimationScale"]);function m(t){return!!t.animations&&t.animations.some(t=>c.has(t.type))}function l(t,e){let n=0,o=0;const r="Absolute"!==t.anchorPointUnits;return t.anchorPoint&&(n=-t.anchorPoint.x,o=-t.anchorPoint.y),{...e,transform:{type:"AnimatedTransform",relativeTranslation:r,absoluteScale:!1,translation:y([n,o]),rotation:y(0),scale:y(1),parent:e.transform}}}function f(t,e){switch(e.type){case"CIMPictureMarker":case"CIMVectorMarker":return a.getProcessParam(t,e,"Rotation")}return 0}function p(t,e){switch(e.type){case"CIMPointSymbol":case"CIMVectorMarker":return[1,1,1,1];case"CIMSolidStroke":case"CIMSolidFill":return a.getProcessParam(t,e,"Color");case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":return a.getProcessParam(t,e,"TintColor")}return[1,1,1,1]}function u(t,e){if(!e)return{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:"Local",repeatType:"Loop",easing:"Linear",playAnimation:1,reverseAnimation:0};const n=a.getProcessParam(t,e,"Duration");let r;r=a.getProcessParam(t,e,"RandomizeStartTime")?{type:"Process",op:"Random",min:0,max:n,seed:a.getProcessParam(t,e,"RandomizeStartSeed")}:a.getProcessParam(t,e,"StartTimeOffset");const i=a.getProcessParam(t,e,"RepeatDelay"),s=a.getProcessParam(t,e,"PlayAnimation"),c=a.getProcessParam(t,e,"ReverseAnimation"),m=a.getValue(e.repeatType,o.defaultCIMValues.CIMAnimatedSymbolProperties.repeattype);return{duration:n,startTimeOffset:r,repeatDelay:i,timeOriginSelector:"None"===m?"Local":"Global",repeatType:m,easing:a.getValue(e.easing,o.defaultCIMValues.CIMAnimatedSymbolProperties.easing),playAnimation:s,reverseAnimation:c}}function y(t){return{from:t,to:t,timing:{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:"Local",repeatType:"Loop",easing:"Linear",playAnimation:1,reverseAnimation:0}}}t.checkForAnimations=function t(e){if(null==e)return!1;if("object"!=typeof e)return!1;if(e.animations&&Array.isArray(e.animations)&&e.animations.length>0)return!0;for(const n in e)if(t(e[n]))return!0;return!1},t.getAnimationParams=function(t,e,n){const o=function(t,e,n){const o=function(t,e){const{animations:n}=e,o=n?.find(t=>"CIMSymbolAnimationOffset"===t.type);return o?{from:[0,0],to:[a.getProcessParam(t,o,"OffsetX"),a.getProcessParam(t,o,"OffsetY")],timing:u(t,o.animatedSymbolProperties)}:y([0,0])}(t,e),r=function(t,e){const{animations:n}=e,o=function(t,e){switch(e.type){case"CIMPictureMarker":case"CIMVectorMarker":return a.getProcessParam(t,e,"RotateClockwise")}return 0}(t,e),r={type:"Process",op:"Divide",left:f(t,e),right:{type:"Process",op:"Cond",condition:o,ifTrue:-1,ifFalse:1}},i=n?.find(t=>"CIMSymbolAnimationRotation"===t.type);if(!i)return y(r);const s={type:"Process",op:"Add",left:a.getProcessParam(t,i,"ToRotation"),right:{type:"Process",op:"Divide",left:r,right:-1}};return{from:r,to:{type:"Process",op:"Add",left:r,right:{type:"Process",op:"Cond",condition:a.getProcessParam(t,i,"RotateClockwise"),ifTrue:{type:"Process",op:"MatchWinding",sign:-1,angle:s},ifFalse:{type:"Process",op:"MatchWinding",sign:1,angle:s}}},timing:u(t,i.animatedSymbolProperties)}}(t,e),i=function(t,e){const{animations:n}=e;let o;o="CIMPictureMarker"===e.type||"CIMVectorMarker"===e.type?a.getProcessParam(t,e,"Size"):"CIMSolidStroke"===e.type||"CIMPictureStroke"===e.type?a.getProcessParam(t,e,"Width"):a.getSize(e)||10;const r=n?.find(t=>"CIMSymbolAnimationScale"===t.type);if(!r){const e=n?.find(t=>"CIMSymbolAnimationSize"===t.type);return e?{from:1,to:{type:"Process",op:"Divide",left:a.getProcessParam(t,e,"ToSize"),right:o},timing:u(t,e.animatedSymbolProperties)}:y(1)}return{from:1,to:a.getProcessParam(t,r,"ScaleFactor"),timing:u(t,r.animatedSymbolProperties)}}(t,e);return{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:o,rotation:r,scale:i,parent:n}}(t,e,n.transform),r=function(t,e,n){return{type:"AnimatedColor",color:y(p(t,e)),opacity:y(1),parent:n}}(t,e,n.fromColor),c=function(t,e,n){const{animations:o}=e;let r=p(t,e);const i=o?.find(t=>"CIMSymbolAnimationColor"===t.type);return i&&(r=a.getProcessParam(t,i,"ToColor")),{type:"AnimatedColor",color:y(r),opacity:y(1),parent:n}}(t,e,n.toColor),l=function(t,e,n){const{animations:o}=e,r=o?.find(t=>"CIMSymbolAnimationColor"===t.type);return r?{type:"AnimatedColor",color:y([1,1,1,1]),opacity:{from:0,to:1,timing:u(t,r?.animatedSymbolProperties)},parent:[1,1,1,1]}:n}(t,e,n.colorMix),P=function(t,e,n){const{animations:o}=e;let r=y(1);const i=o?.find(t=>"CIMSymbolAnimationTransparency"===t.type);return i&&(r=y({type:"Process",op:"Transparency",value:a.getProcessParam(t,i,"ToTransparency")})),{type:"AnimatedColor",color:y([1,1,1,1]),opacity:r,parent:n}}(t,e,n.toOpacity),g=function(t,e,n){const{animations:o}=e,r=o?.find(t=>"CIMSymbolAnimationTransparency"===t.type);return r?{type:"AnimatedColor",color:y([1,1,1,1]),opacity:{from:0,to:1,timing:u(t,r?.animatedSymbolProperties)},parent:[1,1,1,1]}:n}(t,e,n.opacityMix),d=function(t,e,n){const{animations:o}=e,r=o?.find(t=>"CIMSymbolAnimationMoveAlongLine"===t.type);if(!r)return n;let i,s;const c=u(t,r.animatedSymbolProperties),m=a.hasProcessParam(t,r,"DistanceAlong"),l=a.hasProcessParam(t,r,"Speed"),f=m&&a.getProcessParam(t,r,"DistanceAlong"),p=l&&a.getProcessParam(t,r,"Speed"),y=!0===r.continuous;if(!1!==f)i={type:"Process",op:"Divide",left:f,right:100},s=!0;else if(!1!==p)i={type:"Process",op:"Multiply",left:p,right:c.duration},s=!1;else{if(!y)throw new Error("Either distanceAlong, speed or continuous must be specified.");i=1,s=!0}return{type:"AnimatedShift",multiplyByLineLength:s,shift:{from:0,to:i,timing:c},parent:n}}(t,e,n.shift);return{transform:o,fromColor:r,toColor:c,colorMix:l,toOpacity:P,opacityMix:g,shift:d,hasAnimations:n.hasAnimations||i(e),hasShiftAnimation:n.hasShiftAnimation||s(e),hasMotionAnimations:n.hasMotionAnimations||m(e)}},t.getFrameTranslation=function(t,e){const n=e?.5*-(e.xmin+e.xmax):0,o=e?.5*-(e.ymin+e.ymax):0;let a=0,i=0;if("x"in t&&"y"in t)a=t.x+n,i=t.y+o;else{const e=r.getExtent(t);e&&(a=(e[0]+e[2])/2+n,i=(e[1]+e[3])/2+o)}return[a,i]},t.getStaticParam=y,t.handleAbsoluteAnchor=function(t,e){return"Absolute"!==t.anchorPointUnits?e:l(t,e)},t.handleAnchor=l,t.handleMarker=function(t,n,o){if("CIMCharacterMarker"===n.type)return e.getLogger("animationUtils").error("#handleMarker()","CIM character markers do not support animations"),o;const r=a.getProcessParam(t,n,"OffsetX"),i=a.getProcessParam(t,n,"OffsetY");if("CIMPictureMarker"===n.type)return{...o,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!0,translation:y([r,i]),rotation:y(0),scale:y(a.getProcessParam(t,n,"Size")),parent:o.transform}};const s=n.frame,c=s.ymax-s.ymin;return{...o,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:y([r,i]),rotation:y(0),scale:y({type:"Process",op:"Divide",left:a.getProcessParam(t,n,"Size"),right:c}),parent:o.transform}}},t.handleRelativeAnchor=function(t,e){return"Absolute"===t.anchorPointUnits?e:l(t,e)},t.shouldUseAnimatedPath=function(t){return!n.animationDebugFlags.forceStaticPath&&(n.animationDebugFlags.forceAnimatedPath||t.hasAnimations)},t.translate=function(t,e,n){return{...t,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:y([e,n]),rotation:y(0),scale:y(1),parent:t.transform}}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});