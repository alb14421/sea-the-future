// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../core/screenUtils","../support/textUtils"],function(e,t){"use strict";function i(e){return`rgba(${e.slice(0,3).toString()},${e[3]})`}function n(t,i){const n=Math.max(i.size,.5),s=i.font,r=`${s.style} ${s.weight} ${e.pt2px(n).toFixed(1)}px ${s.family}, sans-serif`;let o;switch(t.font=r,t.textBaseline="top",i.horizontalAlignment){case"left":default:o="left";break;case"right":o="right";break;case"center":o="center"}t.textAlign=o}return class{constructor(e){e&&(this._textRasterizationCanvas=e)}rasterizeText(e,s){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const r=this._textRasterizationCanvas,o=r.getContext("2d",{willReadFrequently:!0});n(o,s),this._parameters=s,this._textLines=e.split(/\r?\n/),this._lineHeight=this._computeLineHeight();const{decoration:a,weight:h}=s.font;this._lineThroughWidthOffset=a&&"line-through"===a?.1*this._lineHeight:0;const l=null!=s.backgroundColor||null!=s.borderLine,d=l?t.backgroundPadding:0,c=this._computeTextWidth(o,s)+2*d,_=this._lineHeight*this._textLines.length+2*d;if(r.width=c+2*this._lineThroughWidthOffset,r.height=_,0===r.width||0===r.height)return r.width=r.height=1,{size:[0,0],image:new Uint32Array(0),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0,canvas:r};this._renderedLineHeight=Math.round(this._lineHeight),this._renderedOutlineSize=(s.outline.size||0)*s.pixelRatio,this._renderedHaloSize=(s.halo.size||0)*s.pixelRatio,this._renderedWidth=c,this._renderedHeight=_,this._lineThroughWidthOffset*=s.pixelRatio;const u=(s.outline&&s.outline.color)??[0,0,0,0],g=s.color??[0,0,0,0],f=s.halo&&s.halo.color?s.halo.color:[0,0,0,0];this._fillStyle=i(g),this._outlineStyle=i(u),this._haloStyle=`rgb(${f.slice(0,3).toString()})`;const p=this._renderedLineHeight,m=this._renderedOutlineSize,x=this._renderedHaloSize;o.save(),o.clearRect(0,0,r.width,r.height),n(o,s);const z=d*s.pixelRatio,b=function(e,t,i){return"center"===e?.5*t:"right"===e?t-i:i}(o.textAlign,this._renderedWidth-2*z,this._renderedHaloSize+this._renderedOutlineSize)+z,w=x+m+z,v=x>0;let S=this._lineThroughWidthOffset,y=0;if(l){o.save();const e=s.backgroundColor??[0,0,0,0],t=s.borderLine?.color??[0,0,0,0],n=2*(s.borderLine?.size??0);o.fillStyle=i(e),o.strokeStyle=i(t),o.lineWidth=n,o.fillRect(0,0,r.width,r.height),o.strokeRect(0,0,r.width,r.height),o.restore()}v&&this._renderHalo(o,b,w,S,y,s),m>0&&this._renderOutline(o,b,w,S,y,s),y+=w,S+=b;for(const e of this._textLines)v?(o.globalCompositeOperation="destination-out",o.fillStyle="rgb(0, 0, 0)",o.fillText(e,S,y),o.globalCompositeOperation="source-over",o.fillStyle=this._fillStyle,o.fillText(e,S,y)):(o.fillStyle=this._fillStyle,o.fillText(e,S,y)),a&&"none"!==a&&this._renderDecoration(o,S,y,a,h),y+=p;o.restore();const R=this._renderedWidth+2*this._lineThroughWidthOffset,C=this._renderedHeight,H=o.getImageData(0,0,R,C),W=new Uint8Array(H.data);if(s.premultiplyColors){let e;for(let t=0;t<W.length;t+=4)e=W[t+3]/255,W[t]=W[t]*e,W[t+1]=W[t+1]*e,W[t+2]=W[t+2]*e}let k,T;switch(s.horizontalAlignment){case"left":k=-.5;break;case"right":k=.5;break;default:k=0}switch(s.verticalAlignment){case"bottom":T=-.5;break;case"top":T=.5;break;case"baseline":T=-1/6;break;default:T=0}return{size:[R,C],image:new Uint32Array(W.buffer),sdf:!1,simplePattern:!1,anchorX:k,anchorY:T,canvas:r}}_renderHalo(e,t,i,s,r,o){const a=this._renderedWidth,h=this._renderedHeight;this._outlineRasterizationCanvas||(this._outlineRasterizationCanvas=document.createElement("canvas")),this._outlineRasterizationCanvas.width=a,this._outlineRasterizationCanvas.height=h;const l=this._outlineRasterizationCanvas,d=l.getContext("2d");d.clearRect(0,0,a,h),n(d,o);const{decoration:c,weight:_}=o.font;d.fillStyle=this._haloStyle,d.strokeStyle=this._haloStyle,d.lineJoin="round",this._renderOutlineNative(d,t,i,c,_,this._renderedHaloSize+this._renderedOutlineSize),e.globalAlpha=this._parameters.halo.color[3],e.drawImage(l,0,0,a,h,s,r,a,h),e.globalAlpha=1}_renderOutline(e,t,i,s,r,o){const a=this._renderedWidth,h=this._renderedHeight;this._outlineRasterizationCanvas||(this._outlineRasterizationCanvas=document.createElement("canvas")),this._outlineRasterizationCanvas.width=a,this._outlineRasterizationCanvas.height=h;const l=this._outlineRasterizationCanvas,d=l.getContext("2d");d.clearRect(0,0,a,h),n(d,o);const{decoration:c,weight:_}=o.font;d.fillStyle=this._outlineStyle,d.strokeStyle=this._outlineStyle,d.lineJoin="round",this._renderOutlineNative(d,t,i,c,_,this._renderedOutlineSize),e.globalAlpha=this._parameters.outline.color[3],e.drawImage(l,0,0,a,h,s,r,a,h),e.globalAlpha=1}_renderOutlineNative(e,t,i,n,s,r){const o=this._renderedLineHeight;for(const a of this._textLines){const h=2*r,l=5,d=.1;for(let r=0;r<l;r++){const o=(1-(l-1)*d+r*d)*h;e.lineWidth=o,e.strokeText(a,t,i),n&&"none"!==n&&this._renderDecoration(e,t,i,n,s,o)}i+=o}}computeTextSize(e,t){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const i=this._textRasterizationCanvas,s=i.getContext("2d");n(s,t),this._parameters=t,this._textLines=e.split(/\r?\n/),this._lineHeight=this._computeLineHeight();const r=this._computeTextWidth(s,t),o=this._lineHeight*this._textLines.length;return i.width=r,i.height=o,[r*t.pixelRatio,o*t.pixelRatio]}_computeTextWidth(t,i){let n=0;for(const e of this._textLines)n=Math.max(n,t.measureText(e).width);const s=i.font;return("italic"===s.style||"oblique"===s.style||"string"==typeof s.weight&&("bold"===s.weight||"bolder"===s.weight)||"number"==typeof s.weight&&s.weight>600)&&(n+=.3*t.measureText("w").width),n+=2*e.pt2px(this._parameters.halo.size),Math.round(n)}_computeLineHeightBase(){return 1.275*this._parameters.size}_computeLineHeight(){let t=this._computeLineHeightBase();const i=this._parameters.font.decoration;return i&&"underline"===i&&(t*=1.3),Math.round(t+2*e.pt2px(this._parameters.halo.size))}_renderDecoration(e,t,i,n,s,r){let o=.9*this._lineHeight;const a="bold"===s?.06:"bolder"===s?.09:.04;switch(e.textAlign){case"center":t-=this._renderedWidth/2;break;case"right":t-=this._renderedWidth}const h=e.textBaseline;if("underline"===n)switch(o=.9*this._computeLineHeightBase(),h){case"top":i+=o;break;case"middle":i+=o/2}else if("line-through"===n)switch(h){case"top":i+=o/1.5;break;case"middle":i+=o/3}const l=r?1.5*r:Math.ceil(o*a);e.save(),e.beginPath(),e.strokeStyle=e.fillStyle,e.lineWidth=l,e.moveTo(t-this._lineThroughWidthOffset,i),e.lineTo(t+this._renderedWidth+2*this._lineThroughWidthOffset,i),e.stroke(),e.restore()}}});