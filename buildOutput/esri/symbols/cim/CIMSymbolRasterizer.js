// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../geometry/support/jsonUtils","./CIMResourceManager","./CIMSymbolDrawHelper","./CIMSymbolHelper","./OverrideHelper","./rasterizingUtils","./utils"],function(e,t,i,r,n,s,h,a){"use strict";const l=96/72;function o(e,t,i,r,n){const s=-t/2+1,a=t/2-1,l=i/2-1,o=-i/2+1;if(n&&("esriGeometryPolygon"===e||"esriGeometryPolyline"===e)){const r=function(e,t,i,r){return"esriGeometryPolygon"===t?{rings:h.translate(h.scale(e.rings,{xmin:0,ymin:0,width:i,height:r}),-1*i/2,-1*r/2)}:"esriGeometryPolyline"===t?{paths:h.translate(h.scale(e.paths,{xmin:0,ymin:0,width:i,height:r}),-1*i/2,-1*r/2)}:null}(n,e,t,i);if(r)return r}switch(e){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[s,0],[0,0],[a,0]]]};default:return"legend"===r?{rings:[[[s,l],[a,0],[a,o],[s,o],[s,l]]]}:{rings:[[[s,l],[a,l],[a,o],[s,o],[s,l]]]}}}e.CIMSymbolRasterizer=class{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new i}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,i,r,l,y,c,g,m,d,w){if(!e)return null;const{data:u}=e;if(!u||"CIMSymbolReference"!==u.type||!u.symbol)return null;const{symbol:p}=u;c||(c=a.mapCIMSymbolToGeometryType(p));const b=await s.OverrideHelper.resolveSymbolOverrides(u,i,this._spatialReference,y,c,g,m),x=this._cimResourceManager,M=[];n.CIMSymbolHelper.fetchResources(b,x,M),n.CIMSymbolHelper.fetchFonts(b,x,M),M.length>0&&await Promise.all(M);const{width:f,height:C}=r;let S=o(c,f,C,l,w);const I=n.CIMSymbolHelper.getEnvelope(b,S,x);if(!I)return null;I.x===1/0&&(I.x=f+2),I.y===1/0&&(I.y=-C/2),I.width===-1/0&&(I.width=f),I.height===-1/0&&(I.height=C);let v=1,R=0,P=0;switch(p.type){case"CIMPointSymbol":case"CIMTextSymbol":{let e=1;I.width>f&&(e=f/I.width);let t=1;I.height>C&&(t=C/I.height),"preview"===l&&(I.width<f&&(e=f/I.width),I.height<C&&(t=C/I.height)),v=Math.min(e,t),R=I.x+I.width/2,P=I.y+I.height/2}break;case"CIMLineSymbol":if(w){P=I.y+I.height/2,R=I.x+I.width/2;const e=I.width-f,t=I.height-C;S={paths:h.scale(S.paths,{xmin:-1*I.width/2+e,xmax:I.width/2-e,ymin:-1*I.height/2+t,ymax:I.height/2-t,width:I.width-2*e,height:I.height-2*t})}}else{(d||I.height>C)&&(v=C/I.height),P=I.y+I.height/2;const e=I.x*v+f/2,i=(I.x+I.width)*v+f/2,r=t.isPolyline(S)?S.paths:t.isPolygon(S)?S.rings:null;if(null===r)throw new Error("Bad geometry, can't rasterise symbol!");r[0][0][0]-=e/v,r[0][2][0]-=(i-f)/v}break;case"CIMPolygonSymbol":if(w){P=I.y+I.height/2,R=I.x+I.width/2;const e=I.width-f,t=I.height-C;S={paths:h.scale(S.rings,{xmin:-1*I.width/2+e,xmax:I.width/2-e,ymin:-1*I.height/2+t,ymax:I.height/2-t,width:I.width-2*e,height:I.height-2*t})}}else{R=I.x+I.width/2,P=I.y+I.height/2;const e=I.x*v+f/2,t=(I.x+I.width)*v+f/2,i=I.y*v+C/2,r=(I.y+I.height)*v+C/2,{rings:n}=S;e<0&&(n[0][0][0]-=e,n[0][3][0]-=e,n[0][4][0]-=e),i<0&&(n[0][0][1]+=i,n[0][1][1]+=i,n[0][4][1]+=i),t>f&&(n[0][1][0]-=t-f,n[0][2][0]-=t-f),r>C&&(n[0][2][1]+=r-C,n[0][3][1]+=r-C)}}const _={type:"cim",data:{type:"CIMSymbolReference",symbol:b}};return this.rasterize(_,f,C,R,P,v,c,1,S)}rasterize(e,t,i,n,s,h,y,c=0,g=null,m=window.devicePixelRatio||1){const{data:d}=e;if(!d||"CIMSymbolReference"!==d.type||!d.symbol)return null;const{symbol:w}=d,u=this._canvas,p=m*l;u.width=t*p,u.height=i*p,y||(y=a.mapCIMSymbolToGeometryType(w)),g||(g=o(y,t,i,"legend")),u.width+=2*c,u.height+=2*c;const b=u.getContext("2d",{willReadFrequently:!0}),x=r.Transformation.createIdentity();return x.translate(-n,-s),x.scale(h*p,-h*p),x.translate(t*p/2+c,i*p/2+c),b.clearRect(0,0,u.width,u.height),new r.CanvasDrawHelper(b,this._cimResourceManager,x,!0).drawSymbol(w,g),b.getImageData(0,0,u.width,u.height)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});