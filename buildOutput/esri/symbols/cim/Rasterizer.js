// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["./CIMSymbolHelper","./rasterizingUtils","./Rect","./SDFHelper","./utils","../../views/2d/engine/webgl/definitions"],function(e,r,t,a,n,i){"use strict";function s(e){if(!e)return null;const{data:r,width:t,height:n,sdfPaddingRatio:i,sdfDecodeCoeff:s}=a.buildSDF(e);return r?{size:[t,n],image:new Uint32Array(r.buffer),sdf:!0,simplePattern:!0,sdfPaddingRatio:i,sdfDecodeCoeff:s,anchorX:0,anchorY:0}:null}return class{constructor(e){this._resourceManager=e,this._cachedRasterizationCanvas=null}dispose(){this._cachedRasterizationCanvas=null}get _canvas(){return this._cachedRasterizationCanvas||(this._cachedRasterizationCanvas=document.createElement("canvas")),this._cachedRasterizationCanvas}rasterizeJSONResource(e){switch(e.type){case"dash":{const t=n.normalizeDashTemplate(e.dashTemplate),[a,i,s]=r.rasterizeDash1D(t);return{size:[i,s],image:new Uint32Array(a.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}case"fill-style":{const[t,a,n,s]=r.rasterizeFillStyle(this._canvas,e,i.patternFillRasterizationScale);return{size:[a,n],image:new Uint32Array(t.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:s}}case"sdf":return s(e);case"CIMGradientFill":case"CIMGradientStroke":case"CIMHatchFill":case"CIMPictureMarker":case"CIMVectorMarker":return this._rasterizeCIMJSONResource(e)}}_rasterizeCIMJSONResource(t){switch(t.type){case"CIMGradientFill":case"CIMGradientStroke":{const[e,a,n]=r.rasterizeGradient(this._canvas,t);return{size:[a,n],image:new Uint32Array(e.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0,samplingMode:"Discrete"===t.gradientType||"CIMFixedColorRamp"===t.colorRamp.type?"Nearest":"Linear"}}case"CIMHatchFill":{const r=e.CIMSymbolHelper.fromCIMHatchFill(t,i.patternFillRasterizationScale);return this._rasterizeCIMVectorMarker(r)}case"CIMPictureMarker":{const r=e.CIMSymbolHelper.fromCIMInsidePolygon(t);return this._rasterizeCIMVectorMarker(r)}case"CIMVectorMarker":{if("CIMMarkerPlacementInsidePolygon"===t.markerPlacement?.type){const r=e.CIMSymbolHelper.fromCIMInsidePolygon(t);return this._rasterizeCIMVectorMarker(r)}const r=a.getSDFInfo(t);return r&&!t.avoidSDFRasterization?s(r):this._rasterizeCIMVectorMarker(t,!1,i.rasterizedVectorMarkerMinSize)}}}_rasterizeCIMVectorMarker(r,a=!0,n){const i=a?t.fromExtent(r.frame):null,[s,o,c,l,h]=e.CIMSymbolHelper.rasterize(this._canvas,r,i,this._resourceManager,!0,n);return s?{size:[o,c],image:new Uint32Array(s.buffer),sdf:!1,simplePattern:!1,anchorX:l,anchorY:h}:null}rasterizeImageResource(e,r,t,a){this._canvas.width=e,this._canvas.height=r;const i=this._canvas.getContext("2d",{willReadFrequently:!0});t instanceof ImageData?i.putImageData(t,0,0):(t.setAttribute("width",`${e}px`),t.setAttribute("height",`${r}px`),i.drawImage(t,0,0,e,r));const s=i.getImageData(0,0,e,r),o=new Uint8Array(s.data);if(a)for(const e of a)if(e&&e.oldColor&&4===e.oldColor.length&&e.newColor&&4===e.newColor.length){const[r,t,a,n]=e.oldColor,[i,s,c,l]=e.newColor;if(r===i&&t===s&&a===c&&n===l)continue;for(let e=0;e<o.length;e+=4)r===o[e]&&t===o[e+1]&&a===o[e+2]&&n===o[e+3]&&(o[e]=i,o[e+1]=s,o[e+2]=c,o[e+3]=l)}let c;for(let e=0;e<o.length;e+=4)c=o[e+3]/255,o[e]=o[e]*c,o[e+1]=o[e+1]*c,o[e+2]=o[e+2]*c;let l=o,h=e,d=r;const f=512;if(h>=f||d>=f){const t=h/d;t>1?(h=f,d=Math.round(f/t)):(d=f,h=Math.round(f*t)),l=new Uint8Array(4*h*d);const a=new Uint8ClampedArray(l.buffer);n.resampleHermite(o,e,r,a,h,d,!1)}return{size:[h,d],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}});