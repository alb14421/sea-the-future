// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../core/has","../../core/screenUtils","../../layers/support/layerUtils","../../support/loadArcade","./gfxUtils","./renderUtils","./typeUtils","./utils","../../widgets/Legend/styles/support/relationshipUtils","../../widgets/Legend/support/relationshipRampUtils"],function(e,t,l,a,i,r,o,n,s,c,u,p){"use strict";let y=null;const f=[255,255,255];function d(e,t){return Math.floor(Math.random()*(t-e+1)+e)}async function b(t,l){switch(t.type){case"web-style":{const{previewWebStyleSymbol:a}=await new Promise((t,l)=>e(["./previewWebStyleSymbol"],t,l));return a(t,b,l)}case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":{const{previewSymbol3D:a}=await new Promise((t,l)=>e(["./previewSymbol3D"],t,l));return a(t,l)}case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":{const{previewSymbol2D:a}=await new Promise((t,l)=>e(["./previewSymbol2D"],t,l));return a(t,l)}case"cim":{const{previewCIMSymbol:a}=await new Promise((t,l)=>e(["./previewCIMSymbol"],t,l));return a(t,l)}default:return}}function h(e){return e&&"opacity"in e?e.opacity*h(e.parent):1}async function m(t,l){if(!t)return;const a=t.sourceLayer,i=(null!=l&&l.useSourceLayer?a:t.layer)??a,o=l?.ignoreOpacity?1:h(i);if(null!=t.symbol&&(null==l||!0!==l.ignoreGraphicSymbol)){const e="web-style"===t.symbol.type?await t.symbol.fetchSymbol({...l,acceptedFormats:l?.webStyleAcceptedFormats,cache:l?.webStyleCache}):t.symbol.clone();return c.applyColorToSymbol(e,null,{add:o}),e}const n=l?.renderer??w(i);let s=n&&"getSymbolAsync"in n?await n.getSymbolAsync(t,l):null;if(!s)return;if(s="web-style"===s.type?await s.fetchSymbol({...l,acceptedFormats:l?.webStyleAcceptedFormats,cache:l?.webStyleCache}):s.clone(),!(n&&"visualVariables"in n&&n.visualVariables?.length&&g(s)))return c.applyColorToSymbol(s,null,{add:o}),s;if("arcadeRequiredForVisualVariables"in n&&n.arcadeRequiredForVisualVariables&&null==l?.arcade){const e={...l};e.arcade=await r.loadArcade(),l=e}const{getColor:u,getOpacity:p,getAllSizes:y,getRotationAngle:f}=await new Promise((t,l)=>e(["../../renderers/visualVariables/support/visualVariableUtils"],t,l)),d=[],b=[],m=[],S=[];for(const e of n.visualVariables)switch(e.type){case"color":d.push(e);break;case"opacity":b.push(e);break;case"rotation":S.push(e);break;case"size":e.target||m.push(e)}const v=!!d.length&&d[d.length-1],V=v?u(v,t,l):null,L=!!l?.ignoreOpacity,C=!!b.length&&b[b.length-1],k=C?p(C,t,l):null;if(c.applyColorToSymbol(s,V,L?void 0:{override:k,add:o}),m.length&&!0!==l?.ignoreSizeVariables){const e=y(m,t,l);await c.applySizesToSymbol(s,e)}if(!0!==l?.ignoreRotationVariables)for(const e of S)c.applyRotationToSymbol(s,f(e,t,l),e.axis);return s}function g(e){return!s.isSymbol3D(e)||"water"!==e.symbolLayers.at(0)?.type}function w(e){if(e)return"renderer"in e?e.renderer:void 0}t.getDisplayedColor=async function(t,l){if(!t)return;const{layer:a,sourceLayer:i}=t,o=h(a??i);if(null!=t.symbol&&(null==l||!0!==l.ignoreGraphicSymbol)){const e="web-style"===t.symbol.type?await t.symbol.fetchSymbol({...l,acceptedFormats:l?.webStyleAcceptedFormats}):t.symbol.clone();return c.getColorFromSymbol(e,o)}const n=l?.renderer??w(a)??w(i);let s=n&&"getSymbolAsync"in n?await n.getSymbolAsync(t,l):void 0;if(!s)return;s="web-style"===s.type?await s.fetchSymbol({...l,acceptedFormats:l?.webStyleAcceptedFormats}):s.clone();const u=c.getColorFromSymbol(s,void 0);if(!n||!("visualVariables"in n)||"visualVariables"in n&&!n.visualVariables||"visualVariables"in n&&!n.visualVariables?.length||!g(s))return u?c.applyOpacityToColor(u,o):void 0;if("arcadeRequiredForVisualVariables"in n&&n.arcadeRequiredForVisualVariables&&null==l?.arcade){const e={...l};e.arcade=await r.loadArcade(),l=e}const{getColor:p,getOpacity:y}=await new Promise((t,l)=>e(["../../renderers/visualVariables/support/visualVariableUtils"],t,l)),f=[],d=[];if(n.visualVariables)for(const e of n.visualVariables)switch(e.type){case"color":f.push(e);break;case"opacity":d.push(e)}const b=f.length>0?f[f.length-1]:null,m=(b?p(b,t,l):void 0)??u,S=d.length>0?d[d.length-1]:null,v=S?y(S,t,l):null;return null!=m&&null!=v&&(m.a=v),m?c.applyOpacityToColor(m,o):null},t.getDisplayedSymbol=m,t.getLegendLabel=async function(t,l,a){if(!t)return;const{layer:i,sourceLayer:r}=t,o=a?.renderer??w(i)??w(r);if(!o)return null;if("visualVariables"in o&&o.visualVariables?.length){const{getRampStops:r}=await new Promise((t,l)=>e(["../../widgets/Legend/support/colorRampUtils"],t,l)),{getRampStops:n}=await new Promise((t,l)=>e(["../../widgets/Legend/support/sizeRampUtils"],t,l)),{getDateFormatOptions:s}=await new Promise((t,l)=>e(["../../widgets/Legend/support/utils"],t,l));let c=null;for(const e of o.visualVariables){const u=l?s(i,e,l.timeZone):null;let p=null;switch(e.type){case"color":p=await r(e,null,u);break;case"opacity":p=await r(e);break;case"size":e.target||(p=await n(o,e,null,a?.scale||l?.scale,l,u))}if(p?.length){const l=p.find((l,a)=>{const i=t.attributes[e.field];return 0===a?i>=l.value:a===p?.length-1?i<=l.value:l.value===i});if(l){c=l.label;break}}}if(c)return c}switch(o.type){case"class-breaks":{const e="getClassBreakInfo"in o?await o.getClassBreakInfo(t,a):null;return e?.label??(e&&o.classBreakInfos?.length>1)?`${e.minValue} - ${e.maxValue}`:null}case"unique-value":{const e="getUniqueValueInfo"in o?await o.getUniqueValueInfo(t,a):null;return e?.label}}return null},t.previewGraphic=async function(e,t){e?.layer&&i.isSubtypeGroupLayer(e.layer)&&((e=e.cloneShallow()).layer=e.layer.findSublayerForFeature(e)??null);const l=null===e?t?.fallbackSymbol??null:await m(e,{ignoreGraphicSymbol:!!e.layer,ignoreOpacity:t?.ignoreOpacity??!0,ignoreRotationVariables:t?.ignoreRotationVariables??!0,ignoreSizeVariables:t?.ignoreSizeVariables??!0})??t?.fallbackSymbol??null;if(!l)return null;const r=await b(l,{geometry:t.useGeometryForShape?e?.geometry??null:null,useMarkerSymbolSize:!1!==t.useMarkerSymbolSize,size:{width:a.px2pt(t.widthInPixels??16),height:a.px2pt(t.heightInPixels??16)},..."cim"===l?.type?{cimOptions:{feature:{attributes:e?.attributes??{}}}}:{}});return r?"element"===(t?.format??"element")?r:r.outerHTML:null},t.renderColorRampPreviewHTML=function(e,t={}){const l="horizontal"===t.align,a=l?75:24,i=l?24:75,r=t.width??a,o=t.height??i,n=t.gradient??!0,s=window.devicePixelRatio,u=r*s,p=o*s,y=document.createElement("canvas");y.width=u,y.height=p,y.ariaLabel=t.ariaLabel??null,y.style.width=`${r}px`,y.style.height=`${o}px`;const f=y.getContext("2d"),d=l?u:0,b=l?0:p;if(n){const t=f.createLinearGradient(0,0,d,b),l=e.length,a=1===l?0:1/(l-1);e.forEach((e,l)=>t.addColorStop(l*a,e.toString())),f.fillStyle=t,f.fillRect(0,0,u,p)}else{const t=l?u/e.length:u,a=l?p:p/e.length;let i=0,r=0;for(const o of e)f.fillStyle=o.toString(),f.fillRect(i,r,t,a),i=l?i+t:0,r=l?0:r+a}const h=document.createElement("div");return h.style.width=`${r}px`,h.style.height=`${o}px`,function(e,t){if(!t)return;e.style.filter=c.getCSSFilterFromEffectList(t);const l=t.effects;if(l)for(const t of l)if("drop-shadow"===t?.type){t.offsetX<0?e.style.marginLeft=`${Math.abs(t.offsetX)}px`:e.style.marginRight=`${t.offsetX}px`;break}}(h,t?.effectList),h.appendChild(y),h},t.renderDotDensityPreviewHTML=function(e,t,l){const{backgroundColor:a,outline:i,dotSize:r}=e,o=l?.swatchSize||22,n=Math.round(o*o/Math.max(r,.5)**2*.8),s=window.devicePixelRatio,c=document.createElement("canvas"),u=o*s;c.width=u,c.height=u,c.style.width=c.width/s+"px",c.style.height=c.height/s+"px";const p=c.getContext("2d");if(a&&(p.fillStyle=a.toCss(!0),p.fillRect(0,0,u,u),p.fill()),p.fillStyle=t?.toCss(!0)??"",y&&y.length/2===n)for(let e=0;e<2*n;e+=2){const t=y[e],l=y[e+1];p.fillRect(t,l,r*s,r*s),p.fill()}else{y=[];for(let e=0;e<2*n;e+=2){const e=d(0,u),t=d(0,u);y.push(e,t),p.fillRect(e,t,r*s,r*s),p.fill()}}i&&(i.color&&(p.strokeStyle=i.color.toCss(!0)),p.lineWidth=i.width,p.strokeRect(0,0,u,u));const f=new Image(o,o);return f.src=c.toDataURL(),f.ariaLabel=l?.ariaLabel??null,f.alt=l?.ariaLabel??"",f},t.renderPieChartPreviewHTML=function(e,t={}){const l=t.radius||40,a=2*Math.PI*l,i=e.length,r=a/i,s=[],c=o.getStroke(t.outline);null!=c?.width&&(c.width*=2),(c||t.backgroundColor)&&s.push({shape:{type:"circle",cx:l,cy:l,r:l},fill:t.backgroundColor,stroke:c,offset:[0,0]});const u=t.values,p=u&&u.length===i&&100===u.reduce((e,t)=>e+t,0),y=[0];for(let t=0;t<i;t++){let i=null;p&&(i=u[t]*a/100,y.push(i+y[t])),s.push({shape:{type:"circle",cx:l,cy:l,r:l/2},fill:[0,0,0,0],stroke:{width:l,dashArray:`${(i??r)/2} ${a}`,dashoffset:"-"+(p?y[t]/2:t*(r/2)),color:e[t]},offset:[0,0]})}let d=null;const b=2*l+(c?.width||0),h=t.holePercentage;if(h){c&&s.push({shape:{type:"circle",cx:l,cy:l,r:l*h},fill:null,stroke:c,offset:[0,0]});const e=b/2;d=[[{shape:{type:"circle",cx:e,cy:e,r:e},fill:f,stroke:c?{...c,color:f}:null,offset:[0,0]},{shape:{type:"circle",cx:e,cy:e,r:l*h},fill:[0,0,0],stroke:null,offset:[0,0]}]]}return n.renderSymbol([s],[b,b],{effectView:t.effectList,ignoreStrokeWidth:!0,masking:d,rotations:[-90],ariaLabel:t.ariaLabel})},t.renderPreviewHTML=b,t.renderRelationshipRampPreviewHTML=function(e,t={}){const l=e?.authoringInfo;if("relationship"!==l?.type||!l?.numClasses||!e.uniqueValueInfos)return null;const{focus:a,numClasses:i}=l,r=p.getRelationshipRampElement({focus:a,numClasses:i,infos:e.uniqueValueInfos}),o=t?.node||document.createElement("div");return n.renderOnce(o,()=>u.renderRelationshipRamp(r,t.id||"relationship",{opacity:t.opacity||1,effectList:t.effectList,ariaLabel:t.ariaLabel})),o},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});