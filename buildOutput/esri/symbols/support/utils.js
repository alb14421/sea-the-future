// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../Color","../../core/asyncUtils","../../core/has","../../core/screenUtils","../../core/libs/gl-matrix-2/factories/vec3f64","../../layers/effects/jsonUtils","./cimSymbolUtils","./gfxUtils","./Symbol3DMaterial","./typeUtils"],function(e,t,o,l,r,n,i,c,u,s,a,y){"use strict";function f(e,t){if(null==t||null==e)return e;const l=e.toRgba();return l[3]=l[3]*t,new o(l)}function m(e){for(const t of e)if("number"==typeof t)return t;return null}function b(e,t,o){for(let l=0;l<3;l++){const r=e[l];switch(r){case"symbol-value":{const e=o[l];return null!=e?e/t[l]:1}case"proportional":break;default:if(r&&t[l])return r/t[l]}}return null}function p(e,t,o,l){switch(e){case"proportional":return o*l;case"symbol-value":return null!=t?t:o;default:return e}}t.applyColorToSymbol=function(e,t,l){e&&(t||null!=l)&&(t&&(t=new o(t)),y.isSymbol3D(e)?function(e,t,l){const r=e.symbolLayers;if(!r)return;const n=(e,r=!1)=>{let n=t??e??null;return null!=l?.override&&(!n&&r&&(n=new o([255,255,255])),n&&(n.a=l.override)),f(n,l?.add)};r.forEach(e=>{if("water"===e.type)return void(e.color=f(e.color,l?.add));const t=null!=e.material?e.material.color:null,o=n(t,"icon"===e.type&&null!=e.resource?.href);null==e.material?e.material=new a.Symbol3DMaterial({color:o}):e.material.color=o,"outline"in e&&e.outline?.color&&null!=l?.add&&(e.outline.color=f(e.outline.color,l.add)),"marker"in e&&null!=e.marker&&(e.marker.color=n(e.marker.color))})}(e,t,l):y.isSymbol2D(e)&&function(e,t,o){t=t??e.color,null!=o?.override&&t&&(t.a=o.override),t&&(e.color=f(t,o?.add)),"outline"in e&&e.outline?.color&&(e.outline.color=f(e.outline.color,o?.add))}(e,t,l))},t.applyOpacityToColor=f,t.applyRotationToSymbol=function(e,t,o){if(e&&null!=t)if(y.isSymbol3D(e)){const l=e.symbolLayers;l&&l.forEach(e=>{if("object"===e.type)switch(o){case"tilt":e.tilt=(e.tilt??0)+t;break;case"roll":e.roll=(e.roll??0)+t;break;default:e.heading=(e.heading??0)+t}"icon"===e.type&&(e.angle+=t)})}else y.isSymbol2D(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle+=t))},t.applySizesToSymbol=async function(t,o){if(t&&o)return y.isSymbol3D(t)?async function(t,o){const r=t.symbolLayers;r&&await l.forEach(r,async t=>async function(t,o){switch(t.type){case"extrude":!function(e,t){const o=t[2];"number"==typeof o&&(e.size=o)}(t,o);break;case"icon":case"line":case"text":!function(e,t){const o=m(t);null!=o&&(e.size=o)}(t,o);break;case"path":!function(e,t){const o=b(t,i.ONES,[e.width,void 0,e.height]);null!=o&&(e.width=p(t[0],e.width,1,o),e.height=p(t[2],e.height,1,o))}(t,o);break;case"object":await async function(t,o){const{resourceSize:l,symbolSize:r}=await async function(t){const{computeObjectLayerResourceSize:o}=await new Promise((t,o)=>e(["./symbolLayerUtils"],t,o)),l=await o(t,10),{width:r,height:n,depth:i}=t,c=[r,i,n];let u=1;for(let e=0;e<3;e++){const t=c[e];if(null!=t){u=t/l[e];break}}for(let e=0;e<3;e++)null==c[e]&&(c[e]=l[e]*u);return{resourceSize:l,symbolSize:c}}(t),n=b(o,l,r);null!=n&&(t.width=p(o[0],r[0],l[0],n),t.depth=p(o[1],r[1],l[1],n),t.height=p(o[2],r[2],l[2],n))}(t,o)}}(t,o))}(t,o):void(y.isSymbol2D(t)&&function(e,t){const o=m(t);if(null!=o)switch(e.type){case"simple-marker":e.size=o;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=o,e.height=o*t):(e.width=o*t,e.height=o);break}case"simple-line":e.width=o;break;case"text":e.font.size=o}}(t,o))},t.getCSSFilterFromEffectList=function(e){if(!e)return null;const t=e.effects.filter(e=>"bloom"!==e.type).map(e=>e.toJSON());return c.effectFunctionsFromJSON(t)},t.getColorFromSymbol=function(e,t){if(!e)return null;let l=null;return y.isSymbol3D(e)?l=function(e){const t=e.symbolLayers;if(!t)return null;let l=null;return t.forEach(e=>{"object"===e.type&&e.resource?.href||(l="water"===e.type?e.color:e.material?e.material.color:null)}),l?new o(l):null}(e):y.isSymbol2D(e)&&(l="cim"===e.type?u.getCIMSymbolColor(e):e.color?new o(e.color):null),l?f(l,t):null},t.getIconHref=function(e){return e.resource?.href??""},t.getSymbolOutlineColor=function(e){if(!e)return null;if(y.isSymbol3D(e))return function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.color}(e);const t=s.getStroke(e)?.color;return t?new o(t):null},t.getSymbolOutlineSize=function(e){if(!e)return 0;if(y.isSymbol3D(e)){const t=function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.size}(e);return null!=t?t:0}return n.px2pt(s.getStroke(e)?.width)},t.isVolumetricSymbol=function(e){if(null==e||!("symbolLayers"in e)||null==e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some(e=>"object"===e.type);case"line-3d":return e.symbolLayers.some(e=>"path"===e.type);case"polygon-3d":return e.symbolLayers.some(e=>"object"===e.type||"extrude"===e.type);default:return!1}},t.symbolHasExtrudeSymbolLayer=function(e){return null!=e&&"polygon-3d"===e.type&&e.symbolLayers.some(e=>"extrude"===e.type)},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});