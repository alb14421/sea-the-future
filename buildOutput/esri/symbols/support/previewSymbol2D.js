// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../Color","../../core/colorUtils","../../core/Error","../../core/fontUtils","../../core/screenUtils","../../geometry/support/quantizationUtils","./gfxUtils","./previewUtils","./renderUtils","./textUtils"],function(t,e,n,o,i,a,l,s,r,h,c){"use strict";const p="picture-fill",u=120,d=document.createElement("canvas");function m(t,e,n){if("polygon"===t.type){const o=t.extent,i=0===o.width?1:o.width,a=0===o.height?1:o.height;t=l.quantizePolygon({originPosition:"upperLeft",scale:[i/e,a/n],translate:[o.xmin,o.ymax]},{},t);let s="";for(let e=0;e<t.rings.length;e++){const n=t.rings[e];for(let t=0;t<n.length;t++){const e=n[t][0],o=n[t][1];let i="";0===t?(i=`M${e.toString()} ${o.toString()}`,""!==s&&(i=` ${i}`),s+=i):t===n.length-1?(i=`l${e.toString()} ${o.toString()} Z`,""!==s&&(i=` ${i}`),s+=i):(i=`l${e.toString()} ${o.toString()}`,""!==s&&(i=` ${i}`),s+=i)}}return s}if("polyline"===t.type){const o=t.extent,i=0===o.width?1:o.width,a=0===o.height?1:o.height;t=l.quantizePolyline({originPosition:"upperLeft",scale:[i/e,a/n],translate:[o.xmin,o.ymax]},{},t);let s="";for(let e=0;e<t.paths.length;e++){const n=t.paths[e];for(let t=0;t<n.length;t++){const e=n[t][0],o=n[t][1];let i="";0===t?(i=`M${e.toString()} ${o.toString()}`,""!==s&&(i=` ${i}`),s+=i):(i=`l${e.toString()} ${o.toString()}`,""!==s&&(i=` ${i}`),s+=i)}}return s}return""}function g(t,e){const n=d.getContext("2d"),o=[];e&&(e.weight&&o.push(e.weight),e.size&&o.push(e.size+"px"),e.family&&o.push(e.family)),n.font=o.join(" ");const{width:i,actualBoundingBoxLeft:a,actualBoundingBoxRight:l,actualBoundingBoxAscent:s,actualBoundingBoxDescent:r}=n.measureText(t);return{width:Math.ceil(Math.max(i,a+l)),height:Math.ceil(s+r),x:Math.floor(a),y:Math.floor((s-r)/2)}}function f(t){const e=t?.size;return{width:null!=e&&"object"==typeof e&&"width"in e?a.pt2px(e.width):null,height:null!=e&&"object"==typeof e&&"height"in e?a.pt2px(e.height):null}}function y(t,e){return t>e?"dark":"light"}function w(t,e){const n="number"==typeof e?.size?e?.size:null,o=null!=n?a.pt2px(n):null,i=null!=e?.maxSize?a.pt2px(e.maxSize):null;let l="angle"in t?t.angle:null;null!=e?.rotation&&(l=(l??0)+e.rotation);const h=s.getFill(t);let c=s.getStroke(t);"dark"!==x(t,245)||e?.ignoreWhiteSymbols||(c={width:.75,...c,color:"#bdc3c7"});let d=null;const y={shape:null,fill:h,stroke:c,offset:[0,0]};c?.width&&(c.width=Math.min(c.width,80));const w=c?.width||0;let b=null!=e?.size&&(null==e?.scale||e?.scale),v=0,M=0,S=!1;switch(t.type){case"simple-marker":{const n=t.style,{width:s,height:r}=f(e);let h=s===r&&null!=s?s:null!=o?o:Math.min(a.pt2px(t.size),i||u);if(!0===e?.useMarkerSymbolSize&&null!==s&&null!==r){const e=Math.min(a.pt2px(t.size),i||u);h=e>s&&e>r?Math.min(s,r):e}switch(v=h,M=h,n){case"circle":y.shape={type:"circle",cx:0,cy:0,r:.5*h},b||(v+=w,M+=w);break;case"cross":y.shape={type:"path",path:[{command:"M",values:[0,.5*M]},{command:"L",values:[v,.5*M]},{command:"M",values:[.5*v,0]},{command:"L",values:[.5*v,M]}]};break;case"diamond":y.shape={type:"path",path:[{command:"M",values:[0,.5*M]},{command:"L",values:[.5*v,0]},{command:"L",values:[v,.5*M]},{command:"L",values:[.5*v,M]},{command:"Z",values:[]}]},b||(v+=w,M+=w);break;case"square":y.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[v,0]},{command:"L",values:[v,M]},{command:"L",values:[0,M]},{command:"Z",values:[]}]},b||(v+=w,M+=w),l&&(S=!0);break;case"triangle":y.shape={type:"path",path:[{command:"M",values:[.5*v,0]},{command:"L",values:[v,M]},{command:"L",values:[0,M]},{command:"Z",values:[]}]},b||(v+=w,M+=w),l&&(S=!0);break;case"x":y.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[v,M]},{command:"M",values:[v,0]},{command:"L",values:[0,M]}]},l&&(S=!0);break;case"path":y.shape={type:"path",path:t.path||""},b||(v+=w,M+=w),l&&(S=!0),b=!0}break}case"simple-line":{const{width:t,height:n}=f(e),i=s.getDashArray(c).reduce((t,e)=>t+e,0),a=i&&Math.ceil(50/i),l=n??o??w,r=t??(i*a||50);if(b=!0,"polyline"===e?.geometry?.type&&e?.geometry?.extent){v=r,M=n??v;const t=1e3,o=.15*t;d=[v,M],M=d[0]>d[1]?t*d[1]/d[0]:t,v=d[0]>d[1]?t:t*d[0]/d[1],c?.width&&(c.width=c.width*t/(d[1]>d[0]?d[1]:d[0]),c.width>o&&(c.width=o)),y.shape={type:"path",path:m(e.geometry,v,M)}}else v=null!=e?.maxSize?Math.min(r,e.maxSize):r,M=l,c&&(c.width=l),y.shape={type:"path",path:[{command:"M",values:[l/2,M/2]},{command:"L",values:[v-l/2,M/2]}]};break}case p:case"simple-fill":{const t="object"==typeof e?.symbolConfig&&!!e?.symbolConfig?.isSquareFill,{width:n,height:i}=f(e);v=!t&&n!==i||null==n?null!=o?o:22:n,M=!t&&n!==i||null==i?v:i,b||(v+=w,M+=w),b=!0,e?.geometry?.extent&&"polygon"===e?.geometry?.type?(d=[v,M],M=d[0]>d[1]?1e3*d[1]/d[0]:1e3,v=d[0]>d[1]?1e3:1e3*d[0]/d[1],y.shape={type:"path",path:m(e.geometry,v,M)}):y.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[v,0]},{command:"L",values:[v,M]},{command:"L",values:[0,M]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:r.shapes.fill[0];break}case"picture-marker":{const n=Math.min(a.pt2px(t.width),i||u),s=Math.min(a.pt2px(t.height),i||u),{width:r,height:h}=f(e),c=r===h&&null!=r?r:null!=o?o:Math.max(n,s),p=t.width/t.height;v=p<=1?Math.ceil(c*p):c,M=p<=1?c:Math.ceil(c/p),y.shape={type:"image",x:-Math.round(v/2),y:-Math.round(M/2),width:v,height:M,src:t.url||""},l&&(S=!0);break}case"text":{const n=t,l=e?.overrideText||n.text||"Aa",s=n.font,{width:r,height:h}=f(e),c=null!=h?h:null!=o?o:Math.min(a.pt2px(s.size),i||u),{width:p,height:d}=g(l,{weight:s.weight,size:c,family:s.family}),m=/[\uE600-\uE6FF]/.test(l);v=r??(m?c:p),M=m?c:d;let w=.5*(m?c:d);m&&(w+=5),y.shape={type:"text",text:l,x:n.xoffset||0,y:n.yoffset||w,align:"middle",alignBaseline:n.verticalAlignment,decoration:s&&s.decoration,rotated:n.rotated,kerning:n.kerning},y.font=s&&{size:c,style:s.style,decoration:s.decoration,weight:s.weight,family:s.family};break}}return{shapeDescriptor:y,size:[v,M],outputSize:d,renderOptions:{node:e?.node,scale:b,opacity:e?.opacity,rotations:[l],useRotationSize:S,effectView:e?.effectView,ariaLabel:e?.ariaLabel,clipBloomEffect:e?.clipBloomEffect}}}function x(t,o=225){const i=s.getFill(t),a=s.getStroke(t),l=!i||"type"in i?null:new e(i),r=a?.color?new e(a?.color):null,h=l?y(n.getColorLuminance(l),o):null,c=r?y(n.getColorLuminance(r),o):null;return c?h?h===c?h:o>=225?"light":"dark":c:h}t.getContrastingBackgroundTheme=x,t.getRenderSymbolParameters=w,t.previewSymbol2D=async function(t,e){const{shapeDescriptor:n,size:l,renderOptions:u,outputSize:d}=w(t,e);if(!n.shape)throw new o("symbolPreview: renderPreviewHTML2D","symbol not supported.");await async function(t,e){const n=e.fill,o=t.color;if("pattern"===n?.type&&o&&t.type!==p){const t=await s.getPatternUrlWithColor(n.src,o.toCss(!0));n.src=t,e.fill=n}}(t,n),await async function(t,e,n,o){if(!("font"in t)||!t.font||"text"!==e.shape.type)return;try{await i.loadFont(t.font)}catch{}const{width:a,height:l}=f(o);if(!/[\uE600-\uE6FF]/.test(e.shape.text)){const{width:i,height:s,x:r,y:h}=g(e.shape.text,{weight:e.font?.weight,size:e.font?.size,family:e.font?.family});n[0]=a??i,n[1]=l??s,e.shape.x=r,e.shape.y=h;let c="angle"in t?t.angle:null;if(null!=o?.rotation&&(c=(c??0)+o.rotation),c){const t=c*(Math.PI/180),e=Math.abs(Math.sin(t)),o=Math.abs(Math.cos(t));n[1]=n[0]*e+n[1]*o}}}(t,n,l,e);const m=[[n]];if("object"==typeof e?.symbolConfig&&e?.symbolConfig?.applyColorModulation){const t=.6*l[0];m.unshift([{...n,offset:[-t,0],fill:r.adjustColorBrightness(n.fill,-.3)}]),m.push([{...n,offset:[t,0],fill:r.adjustColorBrightness(n.fill,.3)}]),l[0]+=2*t,u.scale=!1}"text"===t.type&&function(t,e,n,o,i){if(null!=t.haloColor&&null!=t.haloSize){i.masking??=n.map(()=>[]);const l=a.pt2px(t.haloSize);o[0]+=l,o[1]+=l,n.unshift([{...e,fill:null,stroke:{color:t.haloColor,width:2*l,join:"round",cap:"round"}}]),i.masking.unshift([{shape:{type:"rect",x:0,y:0,width:o[0]+2*c.backgroundPadding,height:o[1]+2*c.backgroundPadding},fill:[255,255,255],stroke:null},{...e,fill:[0,0,0,0],stroke:null}])}null==t.backgroundColor&&null==t.borderLineColor||(o[0]+=2*c.backgroundPadding,o[1]+=2*c.backgroundPadding,n.unshift([{shape:{type:"rect",x:0,y:0,width:o[0],height:o[1]},fill:t.backgroundColor,stroke:{color:t.borderLineColor,width:a.pt2px(t.borderLineSize)}}]),i.masking?.unshift([]))}(t,n,m,l,u);const y=h.renderSymbol(m,l,u);if(d&&y){const t="img"===y.nodeName.toLowerCase()?y:y.firstChild;"svg"===t.nodeName.toLowerCase()&&t.setAttribute("viewBox",`0 0 ${l[0].toString()} ${l[1].toString()}`),t.setAttribute("width",d[0].toString()),t.setAttribute("height",d[1].toString()),d.length>2&&(t.style.setProperty("padding-left",d[2]?.toString()+"px"),t.style.setProperty("padding-right",d[2]?.toString()+"px"),t.style.setProperty("padding-top",d[3]?.toString()+"px"),t.style.setProperty("padding-bottom",d[3]?.toString()+"px"),t.style.setProperty("box-sizing","border-box"))}return y},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});