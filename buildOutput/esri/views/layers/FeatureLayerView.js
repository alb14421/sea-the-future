// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/promiseUtils","../../core/reactiveUtils","../../core/sql","../../core/accessorSupport/decorators/property","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../graphic/graphicOriginUtils","../../layers/graphics/data/FeatureIdInfo","../../layers/knowledgeGraph/constants","../../layers/support/displayFilterUtils","../../layers/support/FeatureEffect","../../layers/support/FeatureFilter","../../layers/support/featureLayerUtils","../../layers/support/featurePopupQueryUtils","../../layers/support/fieldUtils","../../layers/support/floorFilterUtils","../../networks/support/networkFieldUtils","../../rest/support/Query","../2d/layers/features/layerAdapters/featureServiceUtils","./support/popupUtils","./support/WhereClauseVisitor"],function(e,t,i,r,l,s,o,a,n,d,u,p,c,f,y,h,F,m,g,I,b,w,_,v,E){"use strict";e.FeatureLayerView=e=>{const i=e;let n=class extends i{constructor(...e){super(...e),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([s.watch(()=>{const e=this.layer,t=this.view;return[e&&"elevationInfo"in e?e.elevationInfo?.featureExpressionInfo:null,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,t?.requiredFieldsOptions?.featureTitleFields&&e&&"featureTitleFields"in e&&e.featureTitleFields,t?.requiredFieldsOptions?.utilityNetworkFields&&b.getUtilityNetworkFields(t,e),e.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,"knowledge-graph-sublayer"===e?.type&&"link-chart"===e.parentCompositeLayer.type&&e.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode,"parquet"===e?.type&&e.popupTemplate]},()=>this._handleChange(),s.syncAndInitial),s.on(()=>this.view?.floors,"change",()=>this._handleChange()),s.on(()=>this.layer.displayFilterInfo?.filters,"change",()=>this._handleChange()),s.on(()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null,"change",()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];const{layer:e,layer:{fieldsIndex:t},requiredFields:i}=this;return"outFields"in e&&e.outFields?g.fixFields(t,[...g.unpackFieldNames(t,e.outFields),...i]):g.fixFields(t,i)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){const e=this.layer;return this.displayFilterEnabled&&e.displayFilterInfo?f.getEffectiveDisplayFilter(e.displayFilterInfo,this.view):null}get effectiveDisplayFilterClause(){const e=this.effectiveDisplayFilter?.where??null;return e&&this.hasHighlight?o.sqlOr(e,o.sqlIn(this.layer.objectIdField,this.highlightIds)):e}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){r.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?F.getSignedInUser(this.layer.url):Promise.resolve(null)}highlight(e,t){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=null!=this.filter?this.filter.createQuery(e):new w(e);return"floorInfo"in this.layer&&this.layer.floorInfo&&(t.where=o.sqlAnd(t.where,I.getFloorFilterClause(this))),this.displayFilterEnabled&&(t.where=o.sqlAnd(t.where,this.effectiveDisplayFilter?.where)),null!=this.timeExtent&&(t.timeExtent=null!=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new w(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(e,t){const i=await this._createPopupQuery(e.map(e=>u.getGraphicOriginLayer(e.origin)??e.layer),t);return await m.fetchFeaturePopupFeatures(this.layer,e,i,{getPopupTemplate:e=>v.getFetchPopupTemplate(e,{...t,checkPopupEnabled:!0}),hasRequiredFields:(e,t)=>this._popupFeatureHasRequiredFields(e,t),...t})}_handleChange(){const e=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set("_updatingRequiredPromise",e),e.then(()=>{this._updatingRequiredPromise===e&&this._set("_updatingRequiredPromise",null)}),e}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;const{layer:e}=this,t=new E.WhereClauseVisitor(e.fieldsIndex);if(t.visitFilter(this.filter),"featureReduction"in e&&t.visitFeatureReduction(e.featureReduction),"labelingInfo"in e&&t.visitLabelingInfo(e.labelsVisible,e.labelingInfo),"trackInfo"in e&&t.visitTrackInfo(e.trackInfo),"2d"===this.view.type&&(t.visitFilter(this.featureEffect?.filter),t.visitDisplayFilter(this.displayFilterEnabled,e.displayFilterInfo),"featureReduction"in e&&t.visitFeatureReduction(e.featureReduction)),"subtype-group"===e.type)for(const i of e.sublayers)t.visitLabelingInfo(i.labelsVisible,i.labelingInfo);try{const e=await t.finish();this._set("requiresCurrentUser",e.requiresCurrentUser)}catch(e){r.getLogger(this).error(e)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:i}}=this,l="renderer"in t&&t.renderer,s="orderBy"in t&&t.orderBy,o="featureReduction"in t?t.featureReduction:null,a=new Set,n=[l?l.collectRequiredFields(a,i):null,g.collectLabelingFields(a,t),e&&"elevationInfo"in t?g.collectElevationFields(a,t):null,null!=this.filter?g.collectFilterFields(a,t,this.filter):null,e||null==this.featureEffect?null:g.collectFilterFields(a,t,this.featureEffect.filter),!e&&o?g.collectFeatureReductionFields(a,t,o):null,!e&&s?g.collectOrderByInfos(a,t,s):null];if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&g.collectFields(a,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"timeInfo"in t&&t.timeInfo&&"trackInfo"in t&&t.trackInfo){const{trackInfo:e}=t;g.collectFields(a,t.fieldsIndex,[t.timeInfo.trackIdField]),"feature"!==t.type&&"startTimeField"!==e.timeField||g.collectFields(a,t.fieldsIndex,[t.timeInfo.startField]),"endTimeField"===e.timeField&&g.collectFields(a,t.fieldsIndex,[t.timeInfo.endField]),await g.collectTrackInfoFields(a,t)}if("floorInfo"in t&&t.floorInfo&&g.collectFields(a,t.fieldsIndex,[t.floorInfo.floorField]),"featureTitleFields"in t&&this.view?.requiredFieldsOptions?.featureTitleFields&&t.featureTitleFields&&g.collectFields(a,t.fieldsIndex,t.featureTitleFields),"feature"===t.type&&t.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&g.collectFields(a,t.fieldsIndex,[t.globalIdField]),this.displayFilterEnabled&&n.push(g.collectDisplayFilterFields(a,t,t.displayFilterInfo)),"feature"===t.type&&e&&null!=t.infoFor3D&&(null==t.globalIdField&&r.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),g.collectFields(a,t.fieldsIndex,[t.globalIdField])),"subtype-group"===t.type){g.collectField(a,i,t.subtypeField);const e=t.sublayers.map(e=>Promise.all([e.renderer?.collectRequiredFields(a,i),g.collectLabelingFields(a,e)]));n.push(Promise.all(e))}if("catalog-footprint"===t.type&&t.parent){const e=t.parent;g.collectFields(a,i,[e.itemNameField,e.itemSourceField,e.itemTypeField,e.maxScaleField,e.minScaleField])}"knowledge-graph-sublayer"===t.type&&"link-chart"===t.parentCompositeLayer.type&&g.collectField(a,i,c.systemIsSpatialFieldName),"parquet"===t.type&&n.push(v.getRequiredFields(t,t.popupTemplate).then(e=>{for(const t of e)a.add(t)}));const d=await Promise.allSettled(n);if(e)g.collectField(a,i,t.objectIdField);else for(const e of p.getFeatureIdInfoFieldNames(_.createFeatureIdInfo(t)))g.collectField(a,i,e);e&&"displayField"in t&&t.displayField&&g.collectField(a,i,t.displayField);for(const e of d)"rejected"===e.status&&r.getLogger(this).error(e.reason);const u=Array.from(a).sort();this._set("requiredFields",u)}_popupFeatureHasRequiredFields(e,t){return g.featureHasFields(e,t)}async _createPopupQuery(e,t){const i=this.layer.createQuery(),r=new Set;let s=!1;const a=e??[this.layer];for(const e of a){const i=v.getFetchPopupTemplate(e,t);if(null==i)continue;const o=await m.loadFeaturePopupArcadeModules(i);l.throwIfAborted(t);const a=o&&o.arcadeUtils.hasGeometryOperations(i);s=!("point"!==this.layer.geometryType&&!a);const n=await v.getRequiredFields(this.layer,i);l.throwIfAborted(t);for(const e of n)r.add(e)}return i.returnGeometry=s,i.returnZ=s,i.returnM=s,i.outFields=Array.from(r),i.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(i.where=o.sqlAnd(i.where,I.getFloorFilterClause(this))),i}canResume(){return!(!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty)}getTest(){}get test(){}};return t.__decorate([a.property()],n.prototype,"_updatingRequiredPromise",void 0),t.__decorate([a.property({readOnly:!0})],n.prototype,"availableFields",null),t.__decorate([a.property({readOnly:!0})],n.prototype,"displayFilterEnabled",null),t.__decorate([a.property({readOnly:!0})],n.prototype,"effectiveDisplayFilter",null),t.__decorate([a.property({readOnly:!0})],n.prototype,"effectiveDisplayFilterClause",null),t.__decorate([a.property({type:y})],n.prototype,"featureEffect",null),t.__decorate([a.property({type:h})],n.prototype,"filter",void 0),t.__decorate([a.property()],n.prototype,"layer",void 0),t.__decorate([a.property({type:Number})],n.prototype,"maximumNumberOfFeatures",null),t.__decorate([a.property({readOnly:!0,type:Boolean})],n.prototype,"maximumNumberOfFeaturesExceeded",null),t.__decorate([a.property()],n.prototype,"requiresCurrentUser",void 0),t.__decorate([a.property({readOnly:!0})],n.prototype,"requiredFields",void 0),t.__decorate([a.property({readOnly:!0})],n.prototype,"signedInUser",null),t.__decorate([a.property()],n.prototype,"suspended",void 0),t.__decorate([a.property()],n.prototype,"view",void 0),n=t.__decorate([d.subclass("esri.views.layers.FeatureLayerView")],n),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});