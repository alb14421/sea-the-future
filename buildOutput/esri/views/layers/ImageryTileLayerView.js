// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../Graphic","../../core/Error","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../layers/support/rasterFieldUtils","../../layers/support/timeSupport","../../layers/support/rasterDatasets/datasetUtils","../../layers/support/rasterFunctions/rasterProjectionHelper","./support/popupUtils"],function(e,t,r,a,s,i,n,o,l,c,u,p,d){"use strict";return s=>{const i=s;let n=class extends i{constructor(...e){super(...e),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){return c.combineTimeExtent(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){try{return this.layer.loaded?p.getDefaultDatumTransformationForDataset(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(e){try{return!this.layer.loaded||!!p.projectDatasetExtent(this.layer.serviceRasterInfo,e)}catch{return!1}}async fetchPopupFeaturesAtLocation(e,a){const{layer:s}=this;if(!e)throw new r("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:i}=s,n=d.getFetchPopupTemplate(s,a);if(!i||null==n)return[];const o=[],{value:c,magdirValue:p,processedValue:y}=await s.identify(e,{timeExtent:this.timeExtent,signal:a?.signal});let m="";if(c?.length){m="imagery-tile"===s.type&&s.hasStandardTime()&&null!=c[0]?c.map(e=>s.getStandardTimeValue(e)).join(", "):c.join(", ");const e={ObjectId:0};e[l.commonRasterFieldNames.servicePixelValue]="imagery-tile"===s.type&&u.isFunctionRaster(s.raster)?y?.join(", "):m,e[l.commonRasterFieldNames.rawServicePixelValue]=m;const r=s.raster?.rasterInfo??s.serviceRasterInfo,a=r?.attributeTable;if(null!=a){const{fields:t,features:r}=a,s=t.find(({name:e})=>"value"===e.toLowerCase()),i=e[l.commonRasterFieldNames.servicePixelValue],n=s?r.find(e=>String(e.attributes[s.name])===i):null;if(n)for(const t in n.attributes)n.attributes.hasOwnProperty(t)&&(e[l.rasterFieldPrefix+t]=n.attributes[t])}const i=r?.dataType;"vector-magdir"!==i&&"vector-uv"!==i||(e[l.commonRasterFieldNames.magnitude]=p?.[0],e[l.commonRasterFieldNames.direction]=p?.[1]);const{multidimensionalDefinition:n}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});l.addMultidimensionalFieldValues(s.rasterFields,e,n);const d=new t({geometry:this.fullExtent?.clone(),attributes:e,layer:s,sourceLayer:s});o.push(d)}return o}async getSourceScale(){return await this.layer.load(),p.getSourceScale(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return p.projectDatasetExtent(this.layer.serviceRasterInfo,this.view.spatialReference)}};return e.__decorate([a.property()],n.prototype,"fullExtent",null),e.__decorate([a.property()],n.prototype,"layer",void 0),e.__decorate([a.property({readOnly:!0})],n.prototype,"timeExtent",null),e.__decorate([a.property()],n.prototype,"tileInfo",void 0),e.__decorate([a.property({readOnly:!0})],n.prototype,"hasTilingEffects",null),e.__decorate([a.property()],n.prototype,"datumTransformation",null),n=e.__decorate([o.subclass("esri.views.layers.ImageryTileLayerView")],n),n}});