// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../chunks/tslib.es6","../../Viewpoint","../../core/CollectionFlattener","../../core/maybe","../../core/reactiveUtils","../../core/workers/workers","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/projectionUtils","../../layers/support/TileInfo","../View","../Viewport2DBaseMixin","../2d/AnimationManager","../2d/GoToManager","../2d/layerViewModuleImportUtils","../2d/tiling/TileInfoView","../2d/tiling/TileKey","../2d/tiling/TileQueue","../2d/tiling/TileStrategy","../2d/viewpointUtils","../2d/layers/features/support/TileStore","../2d/support/hitTestUtils","../2d/support/Timeline"],function(e,t,i,a,r,s,o,n,l,p,h,c,d,g,u,y,w,m,V,_,f,T,v,M,S,b,D){"use strict";let L,C,O,R,U=class extends(y.Viewport2DBaseMixin(u)){constructor(e){super(e),this.stage=null,this.rootLayerViews=new a({getCollections:()=>[this.layerViews],getChildrenFunction:()=>null}),this.featuresTilingScheme=null,this.graphicsView=null,this.timeline=new D.Timeline,this.goToManager=new m.GoToManager({view:this}),this.labelManager=null,this.map=null,this.surface=null,this.padding={top:0,right:0,bottom:0,left:0},o.initialize()}initialize(){this.addResolvingPromise(s.whenOnce(()=>this.ready))}destroy(){this.layerViewManager.clear(),this._set("preconditionsReady",!1),this.frameTask=r.destroyMaybe(this.frameTask),this.goToManager.destroy(),this.rootLayerViews.destroy()}get graphicsTileStore(){return new S(this.featuresTilingScheme)}get typeSpecificPreconditionsReady(){const e=this._getDefaultViewpoint();if(!e)return!1;const t=e.targetGeometry,i=this.spatialReference;return d.isLoadedOrLoadFor(t.spatialReference,i)}async hitTest(e,t){return b.hitTest(this,e,t)}goTo(e,t){return this.goToManager.goTo(e,t)}toMap(e){return this.stateManager.toMap(e)}requestUpdate(){this.ready&&this.frameTask.requestUpdate()}loadAsyncDependencies(){return async function(){const[,{GraphicsView2D:t,GraphicContainer:i,LabelManager:a,MapViewNavigation:r}]=await Promise.all([new Promise((t,i)=>e(["../2d/webglDeps"],t,i)),new Promise((t,i)=>e(["../2d/mapViewDeps"],t,i))]);L=t,C=i,O=a,R=r}()}hasLayerViewModule(e){return V.layerView2DImporter.hasLayerViewModule(e)}importLayerView(e){return V.layerView2DImporter.importLayerView(e)}_getDefaultViewpoint(){const{constraints:e,initialExtent:t,map:a,padding:r,size:s}=this;if(!e)return null;const o=a&&"initialViewProperties"in a?a.initialViewProperties:void 0,n=this.stateManager.getUserStartupOptions(this.size),l=o?.viewpoint,p=l?.targetGeometry?.extent??t,h=p?.center,c=l?.rotation??0,d=l?.scale||p&&M.extentToScale(p,[s[0]-r.left-r.right,s[1]-r.top-r.bottom]),g=n.center??h,u=n.rotation??c,y=n.scale??d;return g&&y?new i({targetGeometry:g,scale:y,rotation:u}):null}_updateStageChildren(){this.stage.removeAllChildren(),this.rootLayerViews.forEach(e=>{this.stage.addChild(e.container)});const e=this.graphicsView;this.stage.addChild(e.container)}_startup(){this.timeline.begin("VideoOperationalDataView Startup");const e=this._getDefaultViewpoint();this.stateManager.startup(e,this.size,this.spatialReference,this.defaultsFromMap.extent?.center),this.graphics.owner=this;const t=new O({view:this});this._set("labelManager",t);const i=new w({view:this});this._set("animationManager",i);const a=new R({view:this,animationManager:i});this._set("mapViewNavigation",a);const r=new _(g.create({spatialReference:this.spatialReference,size:512,numLODs:36}));this._set("featuresTilingScheme",r);const o=new L({view:this,graphics:this.graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new C(r)});this._set("graphicsView",o),this.addHandles([this.rootLayerViews.on("change",()=>this._updateStageChildren()),this.stage.on("webgl-error",e=>this.fatalError=e.error),s.watch(()=>this.stationary,e=>this.stage.stationary=e,s.syncAndInitial),s.watch(()=>this.state.id,()=>this.stage.state=this.state,s.syncAndInitial)],"video-graphics-view"),this._updateStageChildren(),this.timeline.end("VideoOperationalDataView Startup"),this.frameTask.start(),this.stage.viewIsReady=!0,this._set("ready",!0)}_teardown(){this.removeHandles("video-graphics-view"),this.mapViewNavigation.destroy(),this._set("mapViewNavigation",null),this.animation=null,this.animationManager.destroy(),this._set("animationManager",null),this.layerViewManager.clear(),this.stage.destroy(),this.stage=null;const e=this.graphicsView;this._set("graphicsView",null),e.destroy(),this._set("featuresTilingScheme",null),this._set("mapViewNavigation",null),this.graphics.owner=null,this.frameTask.stop(),this.stationaryManager.clear(),this._set("ready",!1),this.stateManager.teardown()}};return t.__decorate([n.property()],U.prototype,"stage",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"featuresTilingScheme",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"graphicsTileStore",null),t.__decorate([n.property()],U.prototype,"graphicsView",void 0),t.__decorate([n.property({type:D.Timeline,readOnly:!0})],U.prototype,"timeline",void 0),t.__decorate([n.property()],U.prototype,"goToManager",void 0),t.__decorate([n.property()],U.prototype,"labelManager",void 0),t.__decorate([n.property()],U.prototype,"map",void 0),t.__decorate([n.property({readOnly:!0})],U.prototype,"typeSpecificPreconditionsReady",null),t.__decorate([n.property({readOnly:!0})],U.prototype,"surface",void 0),U=t.__decorate([c.subclass("esri.views.video.VideoOperationalDataView")],U),U});