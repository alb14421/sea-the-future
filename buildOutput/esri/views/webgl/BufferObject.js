// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/arrayUtils","../../core/has","../../core/Logger","../../core/typedArrayUtil","./checkWebGLError","./enums"],function(e,t,i,s,r,n,a){"use strict";const u=()=>s.getLogger("esri.views.webgl.BufferObject"),c=!!i("esri-tests-disable-gpu-memory-measurements");class h{static createIndex(e,t,i){return new h(e,34963,t,i)}static createUniform(e,t,i){return new h(e,35345,t,i)}static createPixelPack(e,t=35041,i){const s=new h(e,35051,t);return i&&s.setSize(i),s}static createPixelUnpack(e,t=35040,i){return new h(e,35052,t,i)}static createTransformFeedback(e,t=35044,i){const s=new h(e,35982,t);return s.setSize(i),s}constructor(e,t,i,s){this._context=e,this.bufferType=t,this.usage=i,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(a.ResourceType.BufferObject,this),this._glName=this._context.gl.createBuffer(),n.checkWebGLError(this._context.gl),s&&this.setData(s)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get sizeBytes(){if(34963===this.bufferType){if(this._indexType===a.DataType.UNSIGNED_INT)return 4*this._size;if(this._indexType===a.DataType.UNSIGNED_SHORT)return 2*this._size}return this._size}get usedMemory(){return c?0:this.sizeBytes}get _isVAOAware(){return 34963===this.bufferType||34962===this.bufferType}dispose(){this._context?.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(a.ResourceType.BufferObject,this),this._context=null):this._glName&&u().warn("Leaked WebGL buffer object")}setSize(e,t=null){if(34963===this.bufferType&&null!=t)switch(this._indexType=t,t){case a.DataType.UNSIGNED_SHORT:e*=2;break;case a.DataType.UNSIGNED_INT:e*=4}this._setBufferData(e)}setData(e){if(!e)return;let t=e.byteLength;34963===this.bufferType&&(r.isUint8Array(e)?this._indexType=a.DataType.UNSIGNED_BYTE:r.isUint16Array(e)?(t/=2,this._indexType=a.DataType.UNSIGNED_SHORT):r.isUint32Array(e)&&(t/=4,this._indexType=a.DataType.UNSIGNED_INT)),this._setBufferData(t,e)}_setBufferData(e,t=null){this._size=e;const i=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const s=this._context.gl;null!=t?s.bufferData(this.bufferType,t,this.usage):s.bufferData(this.bufferType,e,this.usage),n.checkWebGLError(s),this._isVAOAware&&this._context.bindVAO(i)}setSubData(e,t,i,s){if(!e)return;const r=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const{gl:a}=this._context;a.bufferSubData(this.bufferType,t*e.BYTES_PER_ELEMENT,e,i,s-i),n.checkWebGLError(a),this._isVAOAware&&this._context.bindVAO(r)}getSubData(e,i=0,s,r){if(s<0||r<0)return;const n=(a=e,t.isArrayLike(a)?e.BYTES_PER_ELEMENT:1);var a;if(n*((s??0)+(r??0))>e.byteLength)return;i+n*(r??0)>this.usedMemory&&u().warn("Potential problem getting subdata: requested data exceeds buffer size!");const c=this._context.gl;35982===this.bufferType?(this._context.bindBuffer(this,35982),c.getBufferSubData(35982,i,e,s,r),this._context.unbindBuffer(35982)):(this._context.bindBuffer(this,36662),c.getBufferSubData(36662,i,e,s,r),this._context.unbindBuffer(36662))}async getSubDataAsync(e,t=0,i,s){await this._context.clientWaitAsync(),this.getSubData(e,t,i,s)}}e.BufferObject=h,e.tracer=null,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});