// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/has","./checkWebGLError","./enums","./ShaderTranspiler"],function(e,t,o,n,i){"use strict";const r=!!t("esri-tests-disable-gpu-memory-measurements");function s(e,t,n){const i=e.gl,r=i.createShader(t);return i.shaderSource(r,n),i.compileShader(r),o.webglValidateShadersEnabled()&&!i.getShaderParameter(r,i.COMPILE_STATUS)&&(console.error("Compile error in ".concat(35633===t?"vertex":"fragment"," shader")),console.error(i.getShaderInfoLog(r)),console.error(function(e){let t=2;return e.replaceAll("\n",()=>{return"\n"+((e=t++)>=1e3?e.toString():("  "+e).slice(-3))+":";var e})}(n))),r}function a(e,t,o){const n=e.get(t);if(!n)return e.set(t,Array.from(o)),!0;const i=o.length;if(n.length!==i)return e.set(t,Array.from(o)),!0;for(let e=0;e<i;++e){const t=o[e];if(n[e]!==t){for(n[e]=t;e<i;++e)n[e]=o[e];return!0}}return!1}const h={enabled:!1},m=o.webglDebugEnabled()?(e,...t)=>f(e,t):()=>{},f=o.webglDebugEnabled()?(e,t)=>{if(e?.supportsNaN)return;const o=t.length;for(let e=0;e<o;++e){const o=t[e];Number.isNaN(o)&&console.error(`Got ${o} as uniform value from ${(new Error).stack}`)}}:()=>{};e.Program=class{constructor(e,t,a,m,f=new Map,c=[]){this._context=e,this._refCount=1,this._compiled=!1,this._linesOfCode=0,this._nameToUniformLocation=new Map,this._nameToUniform1=new Map,this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),0===t.length&&console.error("Shaders source should not be empty!"),t=i.transpileShader(t,35633),a=i.transpileShader(a,35632),this._vShader=s(this._context,35633,t),this._fShader=s(this._context,35632,a),h.enabled&&(this._linesOfCode=t.match(/\n/g).length+a.match(/\n/g).length+2,e.instanceCounter.increment(n.ResourceType.LinesOfCode,this._vShader,this._linesOfCode)),this._vShader&&this._fShader||console.error("Error loading shaders!"),e.instanceCounter.increment(n.ResourceType.Shader,this),o.webglValidateShadersEnabled()&&(this.vertexShader=t,this.fragmentShader=a),this.usedMemory=r?0:t.length+a.length;const l=this._context.gl,g=l.createProgram();l.attachShader(g,this._vShader),l.attachShader(g,this._fShader),m.forEach((e,t)=>l.bindAttribLocation(g,e,t)),this.hasTransformFeedbackVaryings=!!c?.length,this.hasTransformFeedbackVaryings&&l.transformFeedbackVaryings(g,c,l.SEPARATE_ATTRIBS),l.linkProgram(g),o.webglValidateShadersEnabled()&&!l.getProgramParameter(g,l.LINK_STATUS)&&console.error(`Could not link shader\nvalidated: ${l.getProgramParameter(g,l.VALIDATE_STATUS)}, gl error ${l.getError()}, vertex: ${l.getShaderParameter(this._vShader,l.COMPILE_STATUS)}, fragment: ${l.getShaderParameter(this._fShader,l.COMPILE_STATUS)}, info log: ${l.getProgramInfoLog(g)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`);for(const[e,t]of f){const o=l.getUniformBlockIndex(g,e);o<4294967295&&l.uniformBlockBinding(g,o,t)}this._glName=g,e.instanceCounter.increment(n.ResourceType.Program,this)}get glName(){return this._glName}get hasGLName(){return null!=this._glName}get compiled(){return!!this._compiled||(this._context.capabilities.parallelShaderCompile&&null!=this.glName?(this._compiled=!!this._context.gl.getProgramParameter(this.glName,37297),this._compiled):(this._compiled=!0,!0))}dispose(){if(--this._refCount>0)return;const e=this._context.gl,t=this._context.instanceCounter;this._nameToUniformLocation.forEach(e=>e&&t.decrement(n.ResourceType.Uniform,e)),this._nameToUniformLocation.clear(),this._vShader&&(this._linesOfCode>0&&(t.decrement(n.ResourceType.LinesOfCode,this._vShader,this._linesOfCode),this._linesOfCode=0),e.deleteShader(this._vShader),this._vShader=null,t.decrement(n.ResourceType.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,t.decrement(n.ResourceType.Program,this))}ref(){++this._refCount}_getUniformLocation(e){const t=this._nameToUniformLocation.get(e);if(void 0!==t)return t;if(this.glName){const t=this._context.gl.getUniformLocation(this.glName,e);return this._nameToUniformLocation.set(e,t),t&&this._context.instanceCounter.increment(n.ResourceType.Uniform,t),t}return null}hasUniform(e){return null!=this._getUniformLocation(e)}setUniform1i(e,t,o){m(o,t);const n=this._nameToUniform1.get(e);void 0!==n&&t===n||(this._context.gl.uniform1i(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1iv(e,t,o){f(o,t),a(this._nameToUniform1v,e,t)&&this._context.gl.uniform1iv(this._getUniformLocation(e),t)}setUniform2iv(e,t,o){f(o,t),a(this._nameToUniform2,e,t)&&this._context.gl.uniform2iv(this._getUniformLocation(e),t)}setUniform3iv(e,t,o){f(o,t),a(this._nameToUniform3,e,t)&&this._context.gl.uniform3iv(this._getUniformLocation(e),t)}setUniform4iv(e,t,o){f(o,t),a(this._nameToUniform4,e,t)&&this._context.gl.uniform4iv(this._getUniformLocation(e),t)}setUniform1f(e,t,o){m(o,t);const n=this._nameToUniform1.get(e);void 0!==n&&t===n||(this._context.gl.uniform1f(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1fv(e,t,o){f(o,t),a(this._nameToUniform1v,e,t)&&this._context.gl.uniform1fv(this._getUniformLocation(e),t)}setUniform2f(e,t,o,n){m(n,t,o);const i=this._nameToUniform2.get(e);void 0===i?(this._context.gl.uniform2f(this._getUniformLocation(e),t,o),this._nameToUniform2.set(e,[t,o])):t===i[0]&&o===i[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),t,o),i[0]=t,i[1]=o)}setUniform2fv(e,t,o){f(o,t),a(this._nameToUniform2,e,t)&&this._context.gl.uniform2fv(this._getUniformLocation(e),t)}setUniform3f(e,t,o,n,i){m(i,t,o,n);const r=this._nameToUniform3.get(e);void 0===r?(this._context.gl.uniform3f(this._getUniformLocation(e),t,o,n),this._nameToUniform3.set(e,[t,o,n])):t===r[0]&&o===r[1]&&n===r[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),t,o,n),r[0]=t,r[1]=o,r[2]=n)}setUniform3fv(e,t,o){f(o,t);const n=this._getUniformLocation(e);null!=n&&a(this._nameToUniform3,e,t)&&this._context.gl.uniform3fv(n,t)}setUniform4f(e,t,o,n,i,r){m(r,t,o,n,i);const s=this._nameToUniform4.get(e);void 0===s?(this._context.gl.uniform4f(this._getUniformLocation(e),t,o,n,i),this._nameToUniform4.set(e,[t,o,n,i])):void 0!==s&&t===s[0]&&o===s[1]&&n===s[2]&&i===s[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),t,o,n,i),s[0]=t,s[1]=o,s[2]=n,s[3]=i)}setUniform4fv(e,t,o){f(o,t);const n=this._getUniformLocation(e);null!=n&&a(this._nameToUniform4,e,t)&&this._context.gl.uniform4fv(n,t)}setUniformMatrix3fv(e,t,o=!1,n){f(n,t);const i=this._getUniformLocation(e);null!=i&&a(this._nameToUniformMatrix3,e,t)&&this._context.gl.uniformMatrix3fv(i,o,t)}setUniformMatrix4fv(e,t,o=!1,n){f(n,t);const i=this._getUniformLocation(e);null!=i&&a(this._nameToUniformMatrix4,e,t)&&this._context.gl.uniformMatrix4fv(i,o,t)}stop(){}},e.test=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});