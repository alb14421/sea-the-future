// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../chunks/tslib.es6","../../Graphic","../../UndoRedo","../../core/asyncUtils","../../core/handleUtils","../../core/maybe","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/coordinateFormatter","../../layers/GraphicsLayer","../../layers/graphics/dehydratedFeatureComparison","./support/CreateOperationGeometry","./support/createUtils","./support/surfaceCoordinateSystems","./support/tooltipUtils","../interactive/InteractiveToolBase","../interactive/sketch/SketchOptions","../interactive/tooltip/tooltipCommonUtils","../../core/accessorSupport/trackingUtils"],function(e,t,o,r,i,a,n,s,p,l,c,d,h,u,y,m,_,g,v,w,G,O,T,f){"use strict";e.DrawGraphicTool=class extends G.InteractiveToolBase{constructor(e){super(e),this._graphic=null,this._coordinateFormatterLoadTask=null,this._createOperationGeometry=null,this.defaultZ=0,this.directionOptions=null,this.elevationLockOnVertexAddDisabled=!1,this.geometryType=null,this.hasZ=!0,this.geometryToPlace=null,this.snappingManager=null,this.snapToScene=!1,this.sketchOptions=new O}initialize(){const{view:e}=this;this.internalGraphicsLayer=new y({listMode:"hide",internal:!0,title:"DrawGraphicTool layer"}),this.view.map.layers.add(this.internalGraphicsLayer);const t=this.drawOperation=this.makeDrawOperation();this.tooltipInfos=w.createTooltipInfos(e.type,this.sketchOptions);const o=T.makeTooltip(()=>({view:e,options:this.sketchOptions.tooltips}));this.tooltip=o,w.initializeConstraints(this._tooltipsContext),this._coordinateFormatterLoadTask=i.createTask(()=>u.load()),this.addHandles([t.on("vertex-add",e=>this.onVertexAdd(e)),t.on("vertex-remove",e=>this.onVertexRemove(e)),t.on("vertex-update",e=>this.onVertexUpdate(e)),t.on("cursor-update",e=>this.onCursorUpdate(e)),t.on("cursor-remove",()=>this._updateGraphic()),t.on("complete",e=>this.onComplete(e)),this._coordinateFormatterLoadTask,o.on("paste",e=>T.pasteLocation(e,this.activeTooltipInfo)),s.watch(()=>this.cursor,e=>{t.cursor=e},s.syncAndInitial),f.autorun(()=>{const{activeTooltipInfo:e,sketchOptions:t}=this;w.updateTooltipInfo(e,this._tooltipsContext),o.info=t.tooltips.effectiveEnabled?e:null}),f.autorun(()=>{t.constraintZ=w.getConstraintZ(this._tooltipsContext)},s.sync)]),this.finishToolCreation()}destroy(){this.drawOperation=n.destroyMaybe(this.drawOperation),this.tooltip=n.destroyMaybe(this.tooltip),this._destroyAllVisualizations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=n.destroyMaybe(this.internalGraphicsLayer),this._set("view",null)}get _drawSpatialReference(){return this.drawOperation.coordinateHelper.spatialReference}get _tooltipsContext(){const{defaultZ:e,directionOptions:t,drawOperation:o,forceUniformSize:r,geometryType:i,graphic:a,sketchOptions:n,tooltipInfos:s,view:p,automaticAreaMeasurementUtils:l,automaticLengthMeasurementUtils:c}=this;return{createOperationGeometry:this._createOperationGeometry,defaultZ:e,directionOptions:t,drawOperation:o,forceUniformSize:r,geometryType:i,graphic:a,sketchOptions:n,tooltipInfos:s,view:p,automaticAreaMeasurementUtils:l,automaticLengthMeasurementUtils:c}}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(e){this._set("centered",e),this._updateGraphic()}get cursor(){return this._get("cursor")}set cursor(e){this._set("cursor",e)}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}set forceUniformSize(e){this._set("forceUniformSize",e),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(e){this._set("graphicSymbol",e),null!=this._graphic&&(this._graphic.symbol=e)}set mode(e){const t=this.drawOperation;t&&(t.drawingMode=e),this._set("mode",e)}get updating(){return this.drawOperation?.updating??!1}get undoRedo(){const{view:{type:e,map:t}}=this;return"2d"===e&&t&&"undoRedo"in t&&t.undoRedo instanceof r.UndoRedo?t.undoRedo:null}set undoRedo(e){this._override("undoRedo",e)}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(e){this.destroyed||T.enterInputModeIfAvailable(e,this.tooltip)||this.drawOperation.onInputEvent(e)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo(),0===this.drawOperation.numCommittedVertices&&w.initializeConstraints(this._tooltipsContext)}_destroyAllVisualizations(){this.removeHandles(x.outline),this.removeHandles(x.regularVertices),this.removeHandles(x.activeVertex),this.removeHandles(x.activeEdge),this.removeHandles(C)}_createOrUpdateGraphic(e){if(null!=this._graphic)return this.updateGraphicGeometry(e),this._graphic;const t=new o({...this.graphicProperties,symbol:this.graphicSymbol});return this._graphic=t,this.updateGraphicGeometry(e),this.internalGraphicsLayer.add(t),this.addHandles(this.initializeGraphic(t)),this.notifyChange("graphic"),this.addHandles(a.makeHandle(()=>{this.internalGraphicsLayer.remove(t),this._graphic===t&&(this._graphic=null)}),C),t}updateGraphicGeometry(e){this._graphic.geometry=e}_getCreateOperationGeometry(e={operationComplete:!1}){if(null==this.drawOperation)return;const{coordinateHelper:t,view:o,visualizationCursorVertex:r,lastVertex:i,committedVertices:a,geometryIncludingUncommittedVertices:n,numCommittedVertices:s}=this.drawOperation;if(!(s>0||null!=r))return;const p=e.operationComplete?a:n,l=p.length,c=null!=r?t.pointToArray(r):null,d=this._drawSpatialReference,h="3d"===o.type&&"global"===o.viewingMode,u=new _.CreateOperationGeometry;u.committedVertices=a,u.cursorVertex=c;const{geometryType:y}=this;switch(y){case"point":case"mesh":u.full=t.arrayToPoint(p[0]);break;case"multipoint":u.full=l>0?g.createMultipoint(p,d):null;break;case"polyline":case"polygon":l>0&&(u.full="polygon"===y?g.createPolygon([p],d,h,!0):g.createPolyline([p],d,h),u.cursorEdge=null!=c&&i&&!m.pointEquals(r,i)?g.createPolyline([[c,t.pointToArray(i)]],d,h):null,u.outline=l>1?u.full:null);break;case"circle":case"rectangle":{if(u.committedVertices=u.cursorVertex=null,!l)break;const t=v.createViewAlignedCoordinateSystem(o,p[0]),r=p[0],i=t.makeMapPoint(r[0]+D*o.resolution,r[1]);"circle"===y?1===l&&e.operationComplete?u.circle=g.createCircle([r,i],t,!0):2===l&&(this.forceUniformSize?u.circle=g.createCircle(p,t,this.centered):u.rectangle=g.createEllipse(p,t,this.centered)):1===l&&e.operationComplete?u.rectangle=g.createSquare([r,i],t,!0):2===l&&(u.rectangle=this.forceUniformSize?g.createSquare(p,t,this.centered):g.createRectangle(p,t,this.centered)),u.full=null!=u.circle?u.circle.geometry:u.rectangle?.geometry,u.outline="polygon"===u.full?.type?u.full:null;break}default:return null}return u}initializeGraphic(e){return a.makeHandle()}onComplete(e){if(!this.drawOperation)return;this._updateGraphic();let t=null;if(this.drawOperation.isCompleted){const e=this._getCreateOperationGeometry({operationComplete:!0});null!=e&&(t=this._createOrUpdateGraphic(e.full))}this._createOperationGeometry=null,this.emit("complete",{graphic:t,...e})}onCursorUpdate(e){this._updateGraphic(),this.emit("cursor-update",e)}onDeactivate(){const{drawOperation:e}=this;e&&(e.isCompleted||e.cancel())}onOutlineChanged(e){return a.makeHandle()}onCursorEdgeChanged(e){return a.makeHandle()}onVertexAdd(e){w.unlockConstraintsOnVertexAddOrRemove(this._tooltipsContext),this._updateGraphic(),this.elevationLockOnVertexAddDisabled||w.lockElevationOnVertexAdd(e.vertices.at(0)?.coordinates,this._tooltipsContext),this.emit("vertex-add",e)}onVertexRemove(e){w.unlockConstraintsOnVertexAddOrRemove(this._tooltipsContext),this._updateGraphic(),this.emit("vertex-remove",e)}onVertexUpdate(e){this._updateGraphic(),this.emit("vertex-update",e)}_updateGraphic(){const e=this._getCreateOperationGeometry();this._createOperationGeometry=e,null!=e?(null!=e.cursorEdge?this.addHandles(this.onCursorEdgeChanged(e.cursorEdge),x.activeEdge):this.removeHandles(x.activeEdge),null!=e.outline?this.addHandles(this.onOutlineChanged(e.outline),x.outline):this.removeHandles(x.outline),null!=e.committedVertices?this.addHandles(this.onRegularVerticesChanged(e.committedVertices),x.regularVertices):this.removeHandles(x.regularVertices),null!=e.cursorVertex?this.addHandles(this.onActiveVertexChanged(e.cursorVertex),x.activeVertex):this.removeHandles(x.activeVertex),null!=e.full?this._createOrUpdateGraphic(e.full):this.removeHandles(C)):this._destroyAllVisualizations()}get activeTooltipInfo(){return this._coordinateFormatterLoadTask?.finished?w.getActiveTooltipInfo(this._tooltipsContext):null}},t.__decorate([p.property()],e.DrawGraphicTool.prototype,"_coordinateFormatterLoadTask",void 0),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"_createOperationGeometry",void 0),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"_tooltipsContext",null),t.__decorate([p.property({value:!0})],e.DrawGraphicTool.prototype,"centered",null),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"cursor",null),t.__decorate([p.property({nonNullable:!0})],e.DrawGraphicTool.prototype,"defaultZ",void 0),t.__decorate([p.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"directionOptions",void 0),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"drawOperation",void 0),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"elevationLockOnVertexAddDisabled",void 0),t.__decorate([p.property({value:!0})],e.DrawGraphicTool.prototype,"enabled",null),t.__decorate([p.property({value:!0})],e.DrawGraphicTool.prototype,"forceUniformSize",null),t.__decorate([p.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"geometryType",void 0),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"graphic",null),t.__decorate([p.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"graphicProperties",void 0),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"graphicSymbol",null),t.__decorate([p.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"hasZ",void 0),t.__decorate([p.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"geometryToPlace",void 0),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"mode",null),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"snappingManager",void 0),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"snapToScene",void 0),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"tooltip",void 0),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"tooltipInfos",void 0),t.__decorate([p.property({constructOnly:!0,type:O})],e.DrawGraphicTool.prototype,"sketchOptions",void 0),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"updating",null),t.__decorate([p.property({constructOnly:!0,nonNullable:!0})],e.DrawGraphicTool.prototype,"view",void 0),t.__decorate([p.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"automaticAreaMeasurementUtils",void 0),t.__decorate([p.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"automaticLengthMeasurementUtils",void 0),t.__decorate([p.property({constructOnly:!0})],e.DrawGraphicTool.prototype,"undoRedo",null),t.__decorate([p.property()],e.DrawGraphicTool.prototype,"activeTooltipInfo",null),e.DrawGraphicTool=t.__decorate([h.subclass("esri.views.draw.DrawGraphicTool")],e.DrawGraphicTool);const C=Symbol("create-operation-graphic"),x={outline:Symbol("outline-visual"),regularVertices:Symbol("regular-vertices-visual"),activeVertex:Symbol("active-vertex-visual"),activeEdge:Symbol("active-edge-visual")},D=48;e.geometryTypeToDrawOperationGeometryType=function(e){switch(e){case"point":case"polyline":case"polygon":case"multipoint":return e;case"circle":case"rectangle":return"segment";case"mesh":return"point"}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});