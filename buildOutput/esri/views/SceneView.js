// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
require({cache:{"esri/core/ReactiveSet":function(){define(["./accessorSupport/tracking","./accessorSupport/tracking/SimpleObservable"],function(e,t){"use strict";class r{constructor(e){this._observable=new t.SimpleObservable,this._set=new Set(e)}get size(){return e.trackAccess(this._observable),this._set.size}add(e){const t=this._set.size;return this._set.add(e),this._set.size!==t&&this._observable.notify(),this}clear(){this._set.size>0&&(this._set.clear(),this._observable.notify())}delete(e){const t=this._set.delete(e);return t&&this._observable.notify(),t}entries(){return e.trackAccess(this._observable),this._set.entries()}forEach(t,r){e.trackAccess(this._observable),this._set.forEach((e,i)=>t.call(r,e,i,this),r)}has(t){return e.trackAccess(this._observable),this._set.has(t)}keys(){return e.trackAccess(this._observable),this._set.keys()}values(){return e.trackAccess(this._observable),this._set.values()}[Symbol.iterator](){return e.trackAccess(this._observable),this._set[Symbol.iterator]()}[Symbol.dispose](){this._observable.destroy()}get[Symbol.toStringTag](){return this._set[Symbol.toStringTag]}}return r})},"esri/core/accessorSupport/overrideDefaultsFrom":function(){define(["exports","../Accessor","./utils"],function(e,t,r){"use strict";e.overrideDefaultsFrom=function e(i,s){const n=r.getProperties(i),o=r.getProperties(s),a=n.store,l=o.store,c=o.metadata;for(const r in c){const s=c[r],n=a.originOf(r),o=l.originOf(r);if(!s.readOnly&&0!==o){if(0!==n){const i=a.get(r),s=l.get(r);i&&s&&s instanceof t&&i instanceof t&&i instanceof s.constructor&&e(i,s);continue}i.set(r,l.get(r))}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/libs/rbush/PooledRBush":function(){define(["exports","../../arrayUtils","../../compilerUtils","../../has","../../PooledArray","../../../chunks/quickselect"],function(e,t,r,i,s,n){"use strict";function o(e,t){let i=e;for(v.clear();i;){if(!0===i.leaf)for(const e of i.children)t(r.toConst(e));else v.pushArray(i.children);i=v.pop()??null}}function a(e,t){l(e,0,e.children.length,t,e)}function l(e,t,r,i,s){s||(s=new C([])),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let n,o=t;o<r;o++)n=e.children[o],c(s,e.leaf?i(n):n);return s}function c(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function u(e,t){return e.minX-t.minX}function d(e,t){return e.minY-t.minY}function h(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function p(e){return e.maxX-e.minX+(e.maxY-e.minY)}function f(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function m(e,t){const r=Math.max(e.minX,t.minX),i=Math.max(e.minY,t.minY),s=Math.min(e.maxX,t.maxX),n=Math.min(e.maxY,t.maxY);return Math.max(0,s-r)*Math.max(0,n-i)}function g(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function y(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function _(e,t,r,i,s){const o=[t,r];for(;o.length;){const t=o.pop(),r=o.pop();if(t-r<=i)continue;const a=r+Math.ceil((t-r)/i/2)*i;n.quickselect(e,a,r,t,s),o.push(r,a,a,t)}}const b=new s,v=new s,w=new s,x=new s({deallocator:void 0});class S{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class T extends S{constructor(){super(...arguments),this.height=1,this.indexHint=new t.PositionHint}}class C extends T{constructor(e){super(),this.children=e,this.leaf=!0}}class P extends T{constructor(e){super(),this.children=e,this.leaf=!1}}e.BBox=S,e.PooledRBush=class{constructor(e=9,t){this._compareMinX=u,this._compareMinY=d,this._toBBox=e=>e,this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),b.prune(),v.prune(),w.prune(),x.prune()}all(e){o(this._data,e)}search(e,t){let r=this._data;const i=this._toBBox;if(y(e,r))for(b.clear();r;){for(let s=0,n=r.children.length;s<n;s++){const n=r.children[s],a=r.leaf?i(n):n;y(e,a)&&(r.leaf?t(n):g(e,a)?o(n,t):b.push(n))}r=b.pop()}}collides(e){let t=this._data;const r=this._toBBox;if(!y(e,t))return!1;for(b.clear();t;){for(let i=0,s=t.children.length;i<s;i++){const s=t.children[i],n=t.leaf?r(s):s;if(y(e,n)){if(t.leaf||g(e,n))return!0;b.push(s)}}t=b.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,r=e.length;t<r;t++)this.insert(e[t]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(this._data.children.length)if(this._data.height===t.height)this._splitRoot(this._data,t);else{if(this._data.height<t.height){const e=this._data;this._data=t,t=e}this._insert(t,this._data.height-t.height-1,!0)}else this._data=t;return this}insert(e){return e&&this._insert(e,this._data.height-1),this}clear(){return this._data=new C([]),this}remove(e){if(!e)return this;let i,s=this._data,n=null,o=0,a=!1;const l=this._toBBox(e);for(w.clear(),x.clear();s||w.length>0;){if(s||(s=w.pop(),n=w.data[w.length-1],o=x.pop()??0,a=!0),s.leaf&&(i=t.indexOf(s.children,r.toConst(e),s.children.length,s.indexHint),-1!==i))return s.children.splice(i,1),w.push(s),this._condense(w),this;a||s.leaf||!g(s,l)?n?(o++,s=n.children[o],a=!1):s=null:(w.push(s),x.push(o),o=0,n=s,s=s.children[0])}return this}toJSON(){return this._data}fromJSON(e){return this._data=e,this}_build(e,t,r,i){const s=r-t+1;let n=this._maxEntries;if(s<=n){const i=new C(e.slice(t,r+1));return a(i,this._toBBox),i}i||(i=Math.ceil(Math.log(s)/Math.log(n)),n=Math.ceil(s/n**(i-1)));const o=new P([]);o.height=i;const l=Math.ceil(s/n),c=l*Math.ceil(Math.sqrt(n));_(e,t,r,c,this._compareMinX);for(let s=t;s<=r;s+=c){const t=Math.min(s+c-1,r);_(e,s,t,l,this._compareMinY);for(let r=s;r<=t;r+=l){const s=Math.min(r+l-1,t);o.children.push(this._build(e,r,s,i-1))}}return a(o,this._toBBox),o}_insert(e,t,r){const i=this._toBBox,s=r?e:i(e);w.clear();const n=function(e,t,r,i){for(;i.push(t),!0!==t.leaf&&i.length-1!==r;){let r,i=1/0,s=1/0;for(let n=0,o=t.children.length;n<o;n++){const o=t.children[n],a=h(o),l=f(e,o)-a;l<s?(s=l,i=a<i?a:i,r=o):l===s&&a<i&&(i=a,r=o)}t=r||t.children[0]}return t}(s,this._data,t,w);for(n.children.push(e),c(n,s);t>=0&&w.data[t].children.length>this._maxEntries;)this._split(w,t),t--;!function(e,t,r){for(let i=r;i>=0;i--)c(t.data[i],e)}(s,w,t)}_split(e,t){const r=e.data[t],i=r.children.length,s=this._minEntries;this._chooseSplitAxis(r,s,i);const n=this._chooseSplitIndex(r,s,i);if(!n)return;const o=r.children.splice(n,r.children.length-n),l=r.leaf?new C(o):new P(o);l.height=r.height,a(r,this._toBBox),a(l,this._toBBox),t?e.data[t-1].children.push(l):this._splitRoot(r,l)}_splitRoot(e,t){this._data=new P([e,t]),this._data.height=e.height+1,a(this._data,this._toBBox)}_chooseSplitIndex(e,t,r){let i,s,n;i=s=1/0;for(let o=t;o<=r-t;o++){const t=l(e,0,o,this._toBBox),a=l(e,o,r,this._toBBox),c=m(t,a),u=h(t)+h(a);c<i?(i=c,n=o,s=u<s?u:s):c===i&&u<s&&(s=u,n=o)}return n}_chooseSplitAxis(e,t,r){const i=e.leaf?this._compareMinX:u,s=e.leaf?this._compareMinY:d;this._allDistMargin(e,t,r,i)<this._allDistMargin(e,t,r,s)&&e.children.sort(i)}_allDistMargin(e,t,r,i){e.children.sort(i);const s=this._toBBox,n=l(e,0,t,s),o=l(e,r-t,r,s);let a=p(n)+p(o);for(let i=t;i<r-t;i++){const t=e.children[i];c(n,e.leaf?s(t):t),a+=p(n)}for(let i=r-t-1;i>=t;i--){const t=e.children[i];c(o,e.leaf?s(t):t),a+=p(o)}return a}_condense(e){for(let r=e.length-1;r>=0;r--){const i=e.data[r];if(0===i.children.length)if(r>0){const s=e.data[r-1],n=s.children;n.splice(t.indexOf(n,i,n.length,s.indexHint),1)}else this.clear();else a(i,this._toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this._compareMinX=new Function("a","b",t.join(e[0])),this._compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}},e.cleanupPooledRBush=function(){b.prune(),v.prune(),w.prune(),x.prune()},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/quickselect":function(){define(["exports"],function(e){"use strict";function t(e,i,s,n,o){for(;n>s;){if(n-s>600){var a=n-s+1,l=i-s+1,c=Math.log(a),u=.5*Math.exp(2*c/3),d=.5*Math.sqrt(c*u*(a-u)/a)*(l-a/2<0?-1:1);t(e,i,Math.max(s,Math.floor(i-l*u/a+d)),Math.min(n,Math.floor(i+(a-l)*u/a+d)),o)}var h=e[i],p=s,f=n;for(r(e,s,i),o(e[n],h)>0&&r(e,s,n);p<f;){for(r(e,p,f),p++,f--;o(e[p],h)<0;)p++;for(;o(e[f],h)>0;)f--}0===o(e[s],h)?r(e,s,f):r(e,++f,n),f<=i&&(s=f+1),i<=f&&(n=f-1)}}function r(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}function i(e,t){return e<t?-1:e>t?1:0}e.quickselect=function(e,r,s,n,o){t(e,r,s||0,n||e.length-1,o||i)}})},"esri/geometry/spatialReferenceEllipsoidUtils":function(){define(["exports","./ellipsoidUtils","./SpatialReference","./support/spatialReferenceUtils"],function(e,t,r,i){"use strict";const s=new r(t.SphericalECEFSpatialReferenceLike),n=new r(t.SphericalPCPFMarsLike),o=new r(t.SphericalPCPFMoonLike),a=new r(t.WGS84ECEFSpatialReferenceLike),l=new Map,c=n.wkt.toUpperCase(),u=o.wkt.toUpperCase();e.SphericalECEFSpatialReference=s,e.SphericalPCPFMars=n,e.SphericalPCPFMoon=o,e.WGS84ECEFSpatialReference=a,e.cleanupSpatialReferenceEllipsoidUtils=function(){l.clear()},e.getSphericalPCPF=function(e){const t=l.get(e);if(t)return t;let r=s;if(e)if(e===n)r=n;else if(e===o)r=o;else{const t=e.wkid,s=e.latestWkid;if(null!=t||null!=s)i.isWKIDFromMars(t)||i.isWKIDFromMars(s)?r=n:(i.isWKIDFromMoon(t)||i.isWKIDFromMoon(s))&&(r=o);else{const t=e.wkt2??e.wkt;if(t){const e=t.toUpperCase();e===c?r=n:e===u&&(r=o)}}}return l.set(e,r),r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/projection/projectBoundingRect":function(){define(["exports","../../core/libs/gl-matrix-2/factories/vec3f64","./projectBuffer","../support/aaBoundingRect","../support/spatialReferenceUtils"],function(e,t,r,i,s){"use strict";const n=t.create();e.projectBoundingRect=function(e,t,o,a){return!(null==e||(s.equals(t,a)?(i.copy(o,e),0):(n[0]=e[0],n[1]=e[1],n[2]=0,!r.projectBuffer(n,t,0,n,a,0)||(o[0]=n[0],o[1]=n[1],n[0]=e[2],n[1]=e[3],n[2]=0,!r.projectBuffer(n,t,0,n,a,0)||(o[2]=n[0],o[3]=n[1],0)))))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/projection/projectPointToVector":function(){define(["exports","../../core/libs/gl-matrix-2/factories/vec3f64","../projectionUtils","./projectBuffer"],function(e,t,r,i){"use strict";function s(e,t,s,o){if(r.canProjectWithoutEngine(e.spatialReference,s)){n[0]=e.x,n[1]=e.y;const r=e.z;return n[2]=r??o??0,i.projectBuffer(n,e.spatialReference,0,t,s,0)}const a=r.tryProjectWithZConversion(e,s);return!!a&&(t[0]=a?.x,t[1]=a?.y,t[2]=a?.z??o??0,!0)}const n=t.create();e.projectPointToVector=s,e.projectPointToVectorAsync=async function(e,t,i,n,o){return await r.initializeProjection(e.spatialReference,i,null,o),s(e,t,i,n)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/coordinateSystem":function(){define(["exports","../../core/libs/gl-matrix-2/math/mat4","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","../ellipsoidUtils","../SpatialReference","../spatialReferenceEllipsoidUtils","../../chunks/boundedPlane","../../chunks/sphere"],function(e,t,r,i,s,n,o,a,l){"use strict";function c(e){return{operations:e,value:e.create()}}function u(e,t,r=c(e)){return r.operations=e,e.copy(t,r.value),r}const d=2**50;function h(e,t,r,i){return e.operations.setAltitudeAt(e.value,t,r,i)}const p=i.create(),f=i.create();e.altitudeAt=function(e,t){return e.operations.altitudeAt(e.value,t)},e.axisAt=function(e,t,r,i){return e.operations.axisAt(e.value,t,r,i)},e.closestPoint=function(e,t,r){return e.operations.closestPoint(e.value,t,r)},e.closestPointOnSilhouette=function(e,t,r){return e.operations.closestPointOnSilhouette(e.value,t,r)},e.coordinateSystemFromOneAxisAndNormalVector=function(e,t,i,s,n){r.copy(i,e),r.copy(f,t),r.normalize(f,f),r.cross(s,f,i),r.cross(n,s,i)},e.create=function(e){const{value:t,operations:r}=e;return{operations:r,value:r.create(t)}},e.createFromOperations=c,e.createGlobal=function(e){return u(l.sphere,l.fromValues(0,0,0,s.getReferenceEllipsoid(e).radius))},e.createLocal=function(){return u(a.boundedPlane,a.fromValues([0,0,0],[d,0,0],[0,d,0]))},e.distanceToSilhouette=function(e,t){return e.operations.distanceToSilhouette(e.value,t)},e.elevate=function(e,t,r){return e.operations.elevate(e.value,t,r.value)},e.fromValues=u,e.getExtent=function(e,t){return e.operations.getExtent(e.value,t),t},e.intersectRay=function(e,t,r){return e.operations.intersectRay(e.value,t,r)},e.intersectRayClosestSilhouette=function(e,t,r){return e.operations.intersectRayClosestSilhouette(e.value,t,r)},e.normalAt=function(e,t,r){return e.operations.axisAt(e.value,t,2,r)},e.renderSRFromViewSR=function(e,t){return e?o.getSphericalPCPF(t):t.isGeographic?n.PlateCarree:t},e.setAltitudeAt=h,e.setAltitudeOfTransformation=function(e,i,s,n){return i!==n&&t.copy(n,i),r.set(p,n[12],n[13],n[14]),h(e,p,s,p),n[12]=p[0],n[13]=p[1],n[14]=p[2],n},e.setExtent=function(e,t,r){return e.operations.setExtent(e.value,t,r.value),r},e.vectorCoordinates=function(e,t,i,s,n){return n[0]=r.dot(e,t),n[1]=r.dot(e,i),n[2]=r.dot(e,s),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/boundedPlane":function(){define(["exports","../core/has","../core/Logger","../core/mathUtils","../core/ObjectStack","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../geometry/support/aaBoundingRect","../geometry/support/lineSegment","../geometry/support/plane","../geometry/support/ray","../geometry/support/vector","../geometry/support/vectorStacks"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";const m=()=>r.getLogger("esri.views.3d.support.geometryUtils.boundedPlane"),g=class{constructor(){this.plane=d.create(),this.origin=l.create(),this.basis1=l.create(),this.basis2=l.create()}};function y(e=Z){return{plane:d.create(e.plane),origin:l.clone(e.origin),basis1:l.clone(e.basis1),basis2:l.clone(e.basis2)}}function _(e,t,r){const i=K.get();return i.origin=e,i.basis1=t,i.basis2=r,i.plane=d.wrap(0,0,0,0),x(i),i}function b(e,t=y()){return w(e.origin,e.basis1,e.basis2,t)}function v(e,t){a.copy(t.origin,e.origin),a.copy(t.basis1,e.basis1),a.copy(t.basis2,e.basis2),d.copy(t.plane,e.plane)}function w(e,t,r,i=y()){return a.copy(i.origin,e),a.copy(i.basis1,t),a.copy(i.basis2,r),x(i),s=i,n="fromValues()",Math.abs(a.dot(s.basis1,s.basis2)/(a.length(s.basis1)*a.length(s.basis2)))>1e-6&&m().warn(n,"Provided basis vectors are not perpendicular"),Math.abs(a.dot(s.basis1,q(s)))>1e-6&&m().warn(n,"Basis vectors and plane normal are not perpendicular"),Math.abs(-a.dot(q(s),s.origin)-s.plane[3])>1e-6&&m().warn(n,"Plane offset is not consistent with plane origin"),i;var s,n}function x(e){d.fromVectorsAndPoint(e.basis2,e.basis1,e.origin,e.plane)}function S(e,t,r){e!==r&&b(e,r);const i=a.scale(f.sv3d.get(),q(e),t);return a.add(r.origin,r.origin,i),r.plane[3]-=t,r}function T(e,t,r){return P(t,r),S(r,N(e,e.origin),r),r}function C(e,t){const r=e.basis1[0],i=e.basis2[1],[s,n]=e.origin;return c.fromValues(s-r,n-i,s+r,n+i,t)}function P(e,t=y()){const r=(e[2]-e[0])/2,i=(e[3]-e[1])/2;return a.set(t.origin,e[0]+r,e[1]+i,0),a.set(t.basis1,r,0,0),a.set(t.basis2,0,i,0),d.fromValues(0,0,1,0,t.plane),t}function M(e,t,r){return!!d.intersectRay(e.plane,t,r)&&H(e,r)}function R(e,t,r){if(M(e,t,r))return r;const i=O(e,t,f.sv3d.get());return a.add(r,t.origin,a.scale(f.sv3d.get(),t.direction,a.distance(t.origin,i)/a.length(t.direction))),r}function O(e,t,r){const s=Y.get();Q(e,t,s,Y.get());let n=Number.POSITIVE_INFINITY;for(const o of ee){const l=$(e,o,X.get()),c=f.sv3d.get();if(d.intersectLineSegment(s,l,c)){const e=a.direction(f.sv3d.get(),t.origin,c),s=Math.abs(i.acosClamped(a.dot(t.direction,e)));s<n&&(n=s,a.copy(r,c))}}return n===Number.POSITIVE_INFINITY?F(e,t,r):r}function I(e,t){return(t-e)/t}function F(e,t,r){if(M(e,t,r))return r;const i=Y.get(),s=Y.get();Q(e,t,i,s);let n=Number.POSITIVE_INFINITY;for(const o of ee){const l=$(e,o,X.get()),c=f.sv3d.get();if(d.intersectLineSegmentClamp(i,l,c)){const e=h.distance2(t,c);if(!d.isPointInside(s,c))continue;e<n&&(n=e,a.copy(r,c))}}return E(e,t.origin)<n&&A(e,t.origin,r),r}function A(e,t,r){const i=d.projectPoint(e.plane,t,f.sv3d.get()),s=u.projectPointClamp(W(e,e.basis1),i,-1,1,f.sv3d.get()),n=u.projectPointClamp(W(e,e.basis2),i,-1,1,f.sv3d.get());return a.subtract(r,a.add(f.sv3d.get(),s,n),e.origin),r}function D(e,t,r){const{origin:i,basis1:s,basis2:n}=e,o=a.subtract(f.sv3d.get(),t,i),l=p.projectPointSignedLength(s,o),c=p.projectPointSignedLength(n,o),u=p.projectPointSignedLength(q(e),o);return a.set(r,l,c,u)}function E(e,t){const r=D(e,t,f.sv3d.get()),{basis1:i,basis2:s}=e,n=a.length(i),o=a.length(s),l=Math.max(Math.abs(r[0])-n,0),c=Math.max(Math.abs(r[1])-o,0),u=r[2];return l*l+c*c+u*u}function L(e,t){return Math.sqrt(E(e,t))}function V(e,t){let r=Number.NEGATIVE_INFINITY;for(const i of ee){const s=$(e,i,X.get()),n=u.distance2(s,t);n>r&&(r=n)}return Math.sqrt(r)}function U(e,t){return d.isPointInside(e.plane,t)&&H(e,t)}function B(e,t,r,i){return function(e,t,r){switch(t){case 0:a.copy(r,e.basis1),a.normalize(r,r);break;case 1:a.copy(r,e.basis2),a.normalize(r,r);break;case 2:a.copy(r,q(e))}return r}(e,r,i)}function N(e,t){const r=-e.plane[3];return p.projectPointSignedLength(q(e),t)-r}function k(e,t,r,i){const s=N(e,t),n=a.scale(J,q(e),r-s);return a.add(i,t,n),i}function z(e,t){return a.exactEquals(e.basis1,t.basis1)&&a.exactEquals(e.basis2,t.basis2)&&a.exactEquals(e.origin,t.origin)}function j(e,t,r){return e!==r&&b(e,r),n.invert(te,t),n.transpose(te,te),a.transformMat4(r.basis1,e.basis1,te),a.transformMat4(r.basis2,e.basis2,te),a.transformMat4(d.getNormal(r.plane),d.getNormal(e.plane),te),a.transformMat4(r.origin,e.origin,t),d.setOffsetFromPoint(r.plane,r.plane,r.origin),r}function G(e,t,r,i){return e!==i&&b(e,i),n.fromRotation(re,t,r),a.transformMat4(i.basis1,e.basis1,re),a.transformMat4(i.basis2,e.basis2,re),x(i),i}function q(e){return d.getNormal(e.plane)}function H(e,t){const r=a.subtract(f.sv3d.get(),t,e.origin),i=a.squaredLength(e.basis1),s=a.squaredLength(e.basis2),n=a.dot(e.basis1,r),o=a.dot(e.basis2,r);return-n-i<0&&n-i<0&&-o-s<0&&o-s<0}function W(e,t){const r=X.get();return a.copy(r.origin,e.origin),a.copy(r.vector,t),r}function $(e,t,r){const{basis1:i,basis2:s,origin:n}=e,o=a.scale(f.sv3d.get(),i,t.origin[0]),l=a.scale(f.sv3d.get(),s,t.origin[1]);a.add(r.origin,o,l),a.add(r.origin,r.origin,n);const c=a.scale(f.sv3d.get(),i,t.direction[0]),u=a.scale(f.sv3d.get(),s,t.direction[1]);return a.scale(r.vector,a.add(c,c,u),2),r}function Q(e,t,r,i){const s=q(e);d.fromVectorsAndPoint(s,t.direction,t.origin,r),d.fromVectorsAndPoint(d.getNormal(r),s,t.origin,i)}const Z={plane:d.create(),origin:l.fromValues(0,0,0),basis1:l.fromValues(1,0,0),basis2:l.fromValues(0,1,0)},Y=new s.ObjectStack(d.create),X=new s.ObjectStack(u.create),J=l.create(),K=new s.ObjectStack(()=>y()),ee=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],te=o.create(),re=o.create(),ie=Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:g,altitudeAt:N,axisAt:B,cameraFrustumCoverage:I,closestPoint:F,closestPointOnSilhouette:O,copy:b,copyWithoutVerify:v,create:y,distance:L,distance2:E,distanceToSilhouette:V,elevate:S,equals:z,extrusionContainsPoint:U,fromAABoundingRect:P,fromValues:w,getExtent:C,intersectRay:M,intersectRayClosestSilhouette:R,normal:q,projectPoint:A,projectPointLocal:D,rotate:G,setAltitudeAt:k,setExtent:T,transform:j,up:Z,updateUnboundedPlane:x,wrap:_},Symbol.toStringTag,{value:"Module"}));e.BoundedPlaneClass=g,e.altitudeAt=N,e.axisAt=B,e.boundedPlane=ie,e.cameraFrustumCoverage=I,e.closestPoint=F,e.closestPointOnSilhouette=O,e.copy=b,e.copyWithoutVerify=v,e.create=y,e.distance=L,e.distance2=E,e.distanceToSilhouette=V,e.elevate=S,e.equals=z,e.extrusionContainsPoint=U,e.fromAABoundingRect=P,e.fromValues=w,e.getExtent=C,e.intersectRay=M,e.intersectRayClosestSilhouette=R,e.normal=q,e.projectPoint=A,e.projectPointLocal=D,e.rotate=G,e.setAltitudeAt=k,e.setExtent=T,e.transform=j,e.up=Z,e.updateUnboundedPlane=x,e.wrap=_})},"esri/core/ObjectStack":function(){define(["exports","./nextTick"],function(e,t){"use strict";e.ObjectStack=class{constructor(e){this._allocator=e,this._items=[],this._itemsPtr=0,this._grow()}get(){return 0===this._itemsPtr&&t.nextTick(()=>this._reset()),this._itemsPtr===this._items.length&&this._grow(),this._items[this._itemsPtr++]}_reset(){const e=Math.min(3*Math.max(8,this._itemsPtr),this._itemsPtr+3072);this._items.length=Math.min(e,this._items.length),this._itemsPtr=0}_grow(){for(let e=0;e<Math.max(8,Math.min(this._items.length,1024));e++)this._items.push(this._allocator())}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/lineSegment":function(){define(["exports","../../core/mathUtils","../../core/ObjectStack","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","./vectorStacks"],function(e,t,r,i,s,n){"use strict";function o(e){return e?{origin:s.clone(e.origin),vector:s.clone(e.vector)}:{origin:s.create(),vector:s.create()}}function a(e,t){const r=h.get();return r.origin=e,r.vector=t,r}function l(e,t,r=o()){return i.copy(r.origin,e),i.copy(r.vector,t),r}function c(e,r,s,o,a){const{vector:l,origin:c}=e,u=i.subtract(n.sv3d.get(),r,c),d=i.dot(l,u)/i.squaredLength(l);return i.scale(a,l,t.clamp(d,s,o)),i.add(a,a,e.origin)}function u(e,r,s,o){const a=1e-6,l=e.origin,c=i.add(n.sv3d.get(),l,e.vector),u=r.origin,d=i.add(n.sv3d.get(),u,r.vector),h=n.sv3d.get(),p=n.sv3d.get();if(h[0]=l[0]-u[0],h[1]=l[1]-u[1],h[2]=l[2]-u[2],p[0]=d[0]-u[0],p[1]=d[1]-u[1],p[2]=d[2]-u[2],Math.abs(p[0])<a&&Math.abs(p[1])<a&&Math.abs(p[2])<a)return!1;const f=n.sv3d.get();if(f[0]=c[0]-l[0],f[1]=c[1]-l[1],f[2]=c[2]-l[2],Math.abs(f[0])<a&&Math.abs(f[1])<a&&Math.abs(f[2])<a)return!1;const m=h[0]*p[0]+h[1]*p[1]+h[2]*p[2],g=p[0]*f[0]+p[1]*f[1]+p[2]*f[2],y=h[0]*f[0]+h[1]*f[1]+h[2]*f[2],_=p[0]*p[0]+p[1]*p[1]+p[2]*p[2],b=(f[0]*f[0]+f[1]*f[1]+f[2]*f[2])*_-g*g;if(Math.abs(b)<a)return!1;let v=(m*g-y*_)/b,w=(m+g*v)/_;s&&(v=t.clamp(v,0,1),w=t.clamp(w,0,1));const x=n.sv3d.get(),S=n.sv3d.get();return x[0]=l[0]+v*f[0],x[1]=l[1]+v*f[1],x[2]=l[2]+v*f[2],S[0]=u[0]+w*p[0],S[1]=u[1]+w*p[1],S[2]=u[2]+w*p[2],o.tA=v,o.tB=w,o.pA=x,o.pB=S,o.distance2=i.squaredDistance(x,S),!0}const d={tA:0,tB:0,pA:s.create(),pB:s.create(),distance2:0},h=new r.ObjectStack(()=>o());e.closestLineSegmentPoint=function(e,t,r){return!!u(e,t,!0,d)&&(i.copy(r,d.pA),!0)},e.closestRayDistance2=function(e,t){if(u(e,a(t.origin,t.direction),!1,d)){const{tA:t,pB:r,distance2:s}=d;if(t>=0&&t<=1)return s;if(t<0)return i.squaredDistance(e.origin,r);if(t>1)return i.squaredDistance(i.add(n.sv3d.get(),e.origin,e.vector),r)}return null},e.copy=function(e,t=o()){return l(e.origin,e.vector,t)},e.create=o,e.distance2=function(e,r){const s=i.subtract(n.sv3d.get(),r,e.origin),o=i.dot(e.vector,s),a=i.dot(e.vector,e.vector),l=t.clamp(o/a,0,1),c=i.subtract(n.sv3d.get(),i.scale(n.sv3d.get(),e.vector,l),s);return i.dot(c,c)},e.fromPoints=function(e,t,r=o()){return i.copy(r.origin,e),i.subtract(r.vector,t,e),r},e.fromValues=l,e.pointAt=function(e,t,r){return i.add(r,e.origin,i.scale(r,e.vector,t))},e.projectPoint=function(e,t,r){return c(e,t,0,1,r)},e.projectPointClamp=c,e.wrap=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/vectorStacks":function(){define(["exports","../../core/VectorStack"],function(e,t){"use strict";const r=t.VectorStack.createVec2f64(),i=t.VectorStack.createVec3f64(),s=t.VectorStack.createVec4f64(),n=t.VectorStack.createMat3f64(),o=t.VectorStack.createMat4f64(),a=t.VectorStack.createQuatf64();e.sm3d=n,e.sm4d=o,e.sq4d=a,e.sv2d=r,e.sv3d=i,e.sv4d=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/VectorStack":function(){define(["exports","./has","./nextTick","./libs/gl-matrix-2/factories/mat3f64","./libs/gl-matrix-2/factories/mat4f64","./libs/gl-matrix-2/factories/quatf64","./libs/gl-matrix-2/factories/vec2f64","./libs/gl-matrix-2/factories/vec3f64","./libs/gl-matrix-2/factories/vec4f64"],function(e,t,r,i,s,n,o,a,l){"use strict";class c{constructor(e){this._create=e,this._items=new Array,this._itemsPtr=0}get(){return 0===this._itemsPtr&&r.nextTick(()=>this._reset()),this._itemsPtr>=this._items.length&&this._items.push(this._create()),this._items[this._itemsPtr++]}_reset(){const e=2*this._itemsPtr;this._items.length>e&&(this._items.length=e),this._itemsPtr=0}static createVec2f64(){return new c(o.create)}static createVec3f64(){return new c(a.create)}static createVec4f64(){return new c(l.create)}static createMat3f64(){return new c(i.create)}static createMat4f64(){return new c(s.create)}static createQuatf64(){return new c(n.create)}get test(){}}e.VectorStack=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/libs/gl-matrix-2/factories/vec2f64":function(){define(["exports"],function(e){"use strict";function t(){return[0,0]}function r(e){return[e[0],e[1]]}function i(e,t){return[e,t]}function s(e,t){return[e,t]}function n(e,t=[0,0]){const r=Math.min(2,e.length);for(let i=0;i<r;++i)t[i]=e[i];return t}function o(){return[0,0]}function a(){return i(1,1)}function l(){return i(1,0)}function c(){return i(0,1)}const u=[0,0],d=a(),h=l(),p=c(),f=Object.freeze(Object.defineProperty({__proto__:null,ONES:d,UNIT_X:h,UNIT_Y:p,ZEROS:u,clone:r,create:t,freeze:s,fromArray:n,fromValues:i,ones:a,unitX:l,unitY:c,zeros:o},Symbol.toStringTag,{value:"Module"}));e.ONES=d,e.UNIT_X=h,e.UNIT_Y=p,e.ZEROS=u,e.clone=r,e.create=t,e.freeze=s,e.fromArray=n,e.fromValues=i,e.ones=a,e.unitX=l,e.unitY=c,e.vec2f64=f,e.zeros=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/plane":function(){define(["exports","../../core/mathUtils","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","../../chunks/vec42","./vector","./vectorStacks","../../views/3d/support/mathUtils"],function(e,t,r,i,s,n,o,a){"use strict";function l(e=P){return[e[0],e[1],e[2],e[3]]}const c=s.exactEquals,u=s.equals;function d(e,t){return h(t[0],t[1],t[2],t[3],e)}function h(e,t,r,i,s=l()){return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s}function p(e,t,r){const i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=Math.abs(i-1)>1e-5&&i>1e-12?1/Math.sqrt(i):1;return r[0]=t[0]*s,r[1]=t[1]*s,r[2]=t[2]*s,r[3]=-(r[0]*e[0]+r[1]*e[1]+r[2]*e[2]),r}function f(e,t,r,i=l()){const s=r[0]-t[0],n=r[1]-t[1],o=r[2]-t[2],a=e[0]-t[0],c=e[1]-t[1],u=e[2]-t[2],d=n*u-o*c,h=o*a-s*u,p=s*c-n*a,f=d*d+h*h+p*p,m=Math.abs(f-1)>1e-5&&f>1e-12?1/Math.sqrt(f):1;return i[0]=d*m,i[1]=h*m,i[2]=p*m,i[3]=-(i[0]*e[0]+i[1]*e[1]+i[2]*e[2]),i}function m(e,t,i,s=0,n=Math.floor(i*(1/3)),o=Math.floor(i*(2/3))){if(i<3)return!1;t(y,s);let a=n,l=!1;for(;a<i-1&&!l;)t(_,a),a++,l=!r.exactEquals(y,_);if(!l)return!1;for(a=Math.max(a,o),l=!1;a<i&&!l;)t(b,a),a++,r.subtract(v,y,_),r.normalize(v,v),r.subtract(w,_,b),r.normalize(w,w),l=!r.exactEquals(y,b)&&!r.exactEquals(_,b)&&Math.abs(r.dot(v,w))<g;return l?(f(y,_,b,e),!0):(0!==s||1!==n||2!==o)&&m(e,t,i,0,1,2)}const g=.99619469809,y=i.create(),_=i.create(),b=i.create(),v=i.create(),w=i.create();function x(e,t,i){const s=r.scale(o.sv3d.get(),e,r.dot(e,t));return r.subtract(i,t,s),i}function S(e,t){return r.dot(e,t)+e[3]}function T(e){return 0===e||1===e}function C(e,i,s,n,o){const a=r.dot(e,s),l=S(e,i);if(0===a)return l>=0?2:3;let c=-l/a;return 1&n&&(c=t.clamp(c,0,1)),!(4&n)&&c<0||!(8&n)&&c>1?l>=0?2:3:(r.add(o,i,r.scale(o,s,c)),l>=0?0:1)}const P=[0,0,1,0];e.clip=function(e,t){const i=r.dot(e,t.ray.direction),s=-S(e,t.ray.origin);if(s<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return s>0;if((s<0||i<0)&&!(s<0&&i<0))return!0;const n=s/i;return i>0?n<t.c1&&(t.c1=n):n>t.c0&&(t.c0=n),t.c0<=t.c1},e.clipInfinite=function(e,t){const i=r.dot(e,t.ray.direction),s=-S(e,t.ray.origin);if(i>-1e-6&&i<1e-6)return s>0;const n=s/i;return i>0?n<t.c1&&(t.c1=n):n>t.c0&&(t.c0=n),t.c0<=t.c1},e.copy=d,e.create=l,e.distance=function(e,t){return Math.abs(S(e,t))},e.equals=u,e.exactEquals=c,e.fromArray=function(e,t,i=!0){const s=t.length/3;return m(e,(e,i)=>r.set(e,t[3*i+0],t[3*i+1],t[3*i+2]),i?s-1:s)},e.fromManyPoints=m,e.fromNormalAndOffset=function(e,t,i){return r.copy(i,e),i[3]=t,i},e.fromPoints=f,e.fromPositionAndNormal=p,e.fromValues=h,e.fromVectorsAndPoint=function(e,t,i,s){return r.cross(b,t,e),p(i,b,s)},e.getNormal=function(e){return e},e.intersectLine=function(e,t,i,s){return T(C(e,t,r.subtract(o.sv3d.get(),i,t),12,s))},e.intersectLineOrRay=C,e.intersectLineSegment=function(e,t,r){return T(C(e,t.origin,t.vector,0,r))},e.intersectLineSegmentClamp=function(e,t,r){return T(C(e,t.origin,t.vector,1,r))},e.intersectRay=function(e,t,r){return null!=t&&T(C(e,t.origin,t.direction,8,r))},e.isPointInside=function(e,t){return S(e,t)>=0},e.negate=function(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},e.projectPoint=function(e,t,i){const s=r.scale(o.sv3d.get(),e,-e[3]),n=x(e,r.subtract(o.sv3d.get(),t,s),o.sv3d.get());return r.add(i,n,s),i},e.projectPointLocal=function(e,t,i,s){const l=e,c=o.sv3d.get(),u=o.sv3d.get();a.tangentFrame(l,c,u);const d=r.subtract(o.sv3d.get(),i,t),h=n.projectPointSignedLength(c,d),p=n.projectPointSignedLength(u,d),f=n.projectPointSignedLength(l,d);return r.set(s,h,p,f)},e.projectVector=x,e.setOffsetFromPoint=function(e,t,i){return t!==e&&d(e,t),e[3]=-r.dot(e,i),e},e.signedDistance=S,e.up=P,e.wrap=function(e=P[0],t=P[1],r=P[2],i=P[3]){return h(e,t,r,i,o.sv4d.get())},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/vector":function(){define(["exports","../../core/mathUtils","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64"],function(e,t,r,i){"use strict";const s=i.create(),n=i.create();e.angle=function(e,i){const s=r.dot(e,i)/(r.length(e)*r.length(i));return-t.acosClamped(s)},e.angleAroundAxis=function(e,i,o){r.normalize(s,e),r.normalize(n,i);const a=r.dot(s,n),l=t.acosClamped(a),c=r.cross(s,s,n);return r.dot(c,o)<0?2*Math.PI-l:l},e.projectPoint=function(e,t,i){const s=r.dot(e,t)/r.dot(e,e);return r.scale(i,e,s)},e.projectPointSignedLength=function(e,t){return r.dot(e,t)/r.length(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/mathUtils":function(){define(["exports","../../../core/mathUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64"],function(e,t,r,i){"use strict";const s=i.create(),n=i.create(),o=i.create(),a=i.create(),l=i.create();e.angle=function(e,i,s){e=r.normalize(a,e),i=r.normalize(l,i);const n=t.acosClamped(r.dot(e,i));if(s){const t=r.cross(o,e,i);if(r.dot(t,s)<0)return-n}return n},e.bilerp=function(e,t,r,i,s,n){const o=e+(t-e)*s;return o+(r+(i-r)*s-o)*n},e.cosCapped=function(e,t){return e>t?Math.cos(t):Math.cos(e)},e.fovx2fovy=function(e,t,r){return 2*Math.atan(r*Math.tan(.5*e)/t)},e.fovy2fovx=function(e,t,r){return 2*Math.atan(t*Math.tan(.5*e)/r)},e.makeOrthonormal=function(e,t,i){i=i||e;const s=r.dot(e,t);r.set(i,e[0]-s*t[0],e[1]-s*t[1],e[2]-s*t[2]),r.normalize(i,i)},e.makePiecewiseLinearFunction=function(e){const t=e.length;return r=>{if(r<=e[0][0])return e[0][1];if(r>=e[t-1][0])return e[t-1][1];let i=1;for(;r>e[i][0];)i++;const s=e[i-1][0],n=e[i][0],o=(n-r)/(n-s);return o*e[i-1][1]+(1-o)*e[i][1]}},e.maxScale=function(e){const t=e[0]*e[0]+e[4]*e[4]+e[8]*e[8],r=e[1]*e[1]+e[5]*e[5]+e[9]*e[9],i=e[2]*e[2]+e[6]*e[6]+e[10]*e[10];return Math.sqrt(Math.max(t,r,i))},e.midpoint3d=function(e,t){if(r.set(t,0,0,0),e.length>0){for(let i=0;i<e.length;++i)r.add(t,t,e[i]);r.scale(t,t,1/e.length)}},e.planeFromPoints=function(e,t,i,o){r.subtract(s,t,e),r.subtract(n,i,e),r.cross(o,s,n),r.normalize(o,o),o[3]=-r.dot(e,o)},e.scaleFromMatrix=function(e,t){const i=Math.sqrt(t[0]*t[0]+t[4]*t[4]+t[8]*t[8]),s=Math.sqrt(t[1]*t[1]+t[5]*t[5]+t[9]*t[9]),n=Math.sqrt(t[2]*t[2]+t[6]*t[6]+t[10]*t[10]);return r.set(e,i,s,n),e},e.slerp=function(e,t,s,n=i.create()){const o=r.length(e),c=r.length(t),u=r.dot(e,t)/(o*c);if(u<.9999999999999999){const i=Math.acos(u),d=((1-s)*o+s*c)/Math.sin(i),h=d/o*Math.sin((1-s)*i),p=d/c*Math.sin(s*i);return r.scale(a,e,h),r.scale(l,t,p),r.add(n,a,l)}return r.lerp(n,e,t,s)},e.slerpTangent=function(e,t,s,n=i.create(),o=i.create()){const c=r.length(e),u=r.length(t),d=r.dot(e,t)/(c*u);if(d<.9999999999999999){const i=Math.acos(d),h=Math.sin(i),p=Math.sin(s*i),f=Math.sin((1-s)*i),m=(1-s)*c+s*u;{const i=m/h,s=i/c*f,o=i/u*p;r.scale(a,e,s),r.scale(l,t,o),r.add(n,a,l)}{const n=1/c*(-Math.cos((1-s)*i)*i*m+f*(-c+u));r.scale(a,e,n);const d=1/u*(Math.cos(s*i)*i*m+p*(-c+u));r.scale(l,t,d),r.add(o,a,l),r.scale(o,o,1/h)}return o}return r.lerp(n,e,t,s),r.subtract(o,t,e),r.normalize(o,o),o},e.tangentFrame=function(e,t,i){Math.abs(e[0])>Math.abs(e[1])?r.set(t,0,1,0):r.set(t,1,0,0),r.cross(i,e,t),r.cross(t,i,e),r.normalize(i,i),r.normalize(t,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/ray":function(){define(["exports","../../core/arrayUtils","../../core/ObjectStack","../../core/libs/gl-matrix-2/math/mat3","../../core/libs/gl-matrix-2/factories/mat3f64","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","./vectorStacks"],function(e,t,r,i,s,n,o,a){"use strict";function l(e){return e?c(o.clone(e.origin),o.clone(e.direction)):c(o.create(),o.create())}function c(e,t){return{origin:e,direction:t}}function u(e,t,r=l()){return n.copy(r.origin,e),n.copy(r.direction,t),r}const d=new r.ObjectStack(()=>l()),h=o.create(),p=o.create(),f=o.create(),m=s.create();e.closestPoint=function(e,t,r){const i=n.dot(e.direction,n.subtract(r,t,e.origin));return n.add(r,e.origin,n.scale(r,e.direction,i)),r},e.closestPoints=function(e,t,r,s){const o=e.origin,a=t.origin,l=e.direction,c=t.direction,u=n.dot(n.normalize(p,l),n.normalize(f,c));if(Math.abs(u)>=1)return null;const d=n.cross(p,l,c),g=n.sub(h,a,o),y=i.set(m,l[0],l[1],l[2],-c[0],-c[1],-c[2],d[0],d[1],d[2]),_=i.invert(m,y);if(null==_)return[r,s];const b=n.dot(n.set(p,_[0],_[3],_[6]),g),v=n.dot(n.set(f,_[1],_[4],_[7]),g);return n.add(r,o,n.scale(h,l,b)),n.add(s,a,n.scale(h,c,v)),[r,s]},e.copy=function(e,t=l()){return u(e.origin,e.direction,t)},e.create=l,e.distance2=function(e,t){const r=n.cross(a.sv3d.get(),n.normalize(a.sv3d.get(),e.direction),n.subtract(a.sv3d.get(),t,e.origin));return n.dot(r,r)},e.equals=function(e,r){return t.equals(e.origin,r.origin)&&t.equals(e.direction,r.direction)},e.fromPoints=function(e,t,r=l()){return n.copy(r.origin,e),n.subtract(r.direction,t,e),r},e.fromValues=u,e.wrap=function(e,t){const r=d.get();return r.origin=e,r.direction=t,r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/libs/gl-matrix-2/math/mat3":function(){define(["exports","./common"],function(e,t){"use strict";function r(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function i(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function s(e,t,r,i,s,n,o,a,l,c){return e[0]=t,e[1]=r,e[2]=i,e[3]=s,e[4]=n,e[5]=o,e[6]=a,e[7]=l,e[8]=c,e}function n(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function o(e,t){if(e===t){const r=t[1],i=t[2],s=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=i,e[7]=s}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}function a(e,t){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8],d=u*o-a*c,h=-u*n+a*l,p=c*n-o*l;let f=r*d+i*h+s*p;return f?(f=1/f,e[0]=d*f,e[1]=(-u*i+s*c)*f,e[2]=(a*i-s*o)*f,e[3]=h*f,e[4]=(u*r-s*l)*f,e[5]=(-a*r+s*n)*f,e[6]=p*f,e[7]=(-c*r+i*l)*f,e[8]=(o*r-i*n)*f,e):null}function l(e,t){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8];return e[0]=o*u-a*c,e[1]=s*c-i*u,e[2]=i*a-s*o,e[3]=a*l-n*u,e[4]=r*u-s*l,e[5]=s*n-r*a,e[6]=n*c-o*l,e[7]=i*l-r*c,e[8]=r*o-i*n,e}function c(e){const t=e[0],r=e[1],i=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8];return t*(c*n-o*l)+r*(-c*s+o*a)+i*(l*s-n*a)}function u(e,t,r){const i=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],d=t[8],h=r[0],p=r[1],f=r[2],m=r[3],g=r[4],y=r[5],_=r[6],b=r[7],v=r[8];return e[0]=h*i+p*o+f*c,e[1]=h*s+p*a+f*u,e[2]=h*n+p*l+f*d,e[3]=m*i+g*o+y*c,e[4]=m*s+g*a+y*u,e[5]=m*n+g*l+y*d,e[6]=_*i+b*o+v*c,e[7]=_*s+b*a+v*u,e[8]=_*n+b*l+v*d,e}function d(e,t,r){const i=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],d=t[8],h=r[0],p=r[1];return e[0]=i,e[1]=s,e[2]=n,e[3]=o,e[4]=a,e[5]=l,e[6]=h*i+p*o+c,e[7]=h*s+p*a+u,e[8]=h*n+p*l+d,e}function h(e,t,r){const i=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],d=t[8],h=Math.sin(r),p=Math.cos(r);return e[0]=p*i+h*o,e[1]=p*s+h*a,e[2]=p*n+h*l,e[3]=p*o-h*i,e[4]=p*a-h*s,e[5]=p*l-h*n,e[6]=c,e[7]=u,e[8]=d,e}function p(e,t,r){const i=r[0],s=r[1],n=r[2];return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e[6]=n*t[6],e[7]=n*t[7],e[8]=n*t[8],e}function f(e,t,r){const i=r[0],s=r[1];return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e}function m(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e}function g(e,t){const r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=0,e[3]=-r,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function y(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function _(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e}function b(e,t){const r=t[0],i=t[1],s=t[2],n=t[3],o=r+r,a=i+i,l=s+s,c=r*o,u=i*o,d=i*a,h=s*o,p=s*a,f=s*l,m=n*o,g=n*a,y=n*l;return e[0]=1-d-f,e[3]=u-y,e[6]=h+g,e[1]=u+y,e[4]=1-c-f,e[7]=p-m,e[2]=h-g,e[5]=p+m,e[8]=1-c-d,e}function v(e,t){const r=t[0],i=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],u=t[10],d=u*o-a*c,h=-u*n+a*l,p=c*n-o*l,f=r*d+i*h+s*p;if(!f)return null;const m=1/f;return e[0]=d*m,e[1]=(-u*i+s*c)*m,e[2]=(a*i-s*o)*m,e[3]=h*m,e[4]=(u*r-s*l)*m,e[5]=(-a*r+s*n)*m,e[6]=p*m,e[7]=(-c*r+i*l)*m,e[8]=(o*r-i*n)*m,e}function w(e,t){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8],d=t[9],h=t[10],p=t[11],f=t[12],m=t[13],g=t[14],y=t[15],_=r*a-i*o,b=r*l-s*o,v=r*c-n*o,w=i*l-s*a,x=i*c-n*a,S=s*c-n*l,T=u*m-d*f,C=u*g-h*f,P=u*y-p*f,M=d*g-h*m,R=d*y-p*m,O=h*y-p*g;let I=_*O-b*R+v*M+w*P-x*C+S*T;return I?(I=1/I,e[0]=(a*O-l*R+c*M)*I,e[1]=(l*P-o*O-c*C)*I,e[2]=(o*R-a*P+c*T)*I,e[3]=(s*R-i*O-n*M)*I,e[4]=(r*O-s*P+n*C)*I,e[5]=(i*P-r*R-n*T)*I,e[6]=(m*S-g*x+y*w)*I,e[7]=(g*v-f*S-y*b)*I,e[8]=(f*x-m*v+y*_)*I,e):null}function x(e,t,r){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/r,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e}function S(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}function T(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+e[6]**2+e[7]**2+e[8]**2)}function C(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e}function P(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e}function M(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e}function R(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e[4]=t[4]+r[4]*i,e[5]=t[5]+r[5]*i,e[6]=t[6]+r[6]*i,e[7]=t[7]+r[7]*i,e[8]=t[8]+r[8]*i,e}function O(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]}function I(e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],u=e[7],d=e[8],h=r[0],p=r[1],f=r[2],m=r[3],g=r[4],y=r[5],_=r[6],b=r[7],v=r[8],w=t.getEpsilon();return Math.abs(i-h)<=w*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(s-p)<=w*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(n-f)<=w*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(o-m)<=w*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(a-g)<=w*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(l-y)<=w*Math.max(1,Math.abs(l),Math.abs(y))&&Math.abs(c-_)<=w*Math.max(1,Math.abs(c),Math.abs(_))&&Math.abs(u-b)<=w*Math.max(1,Math.abs(u),Math.abs(b))&&Math.abs(d-v)<=w*Math.max(1,Math.abs(d),Math.abs(v))}function F(e){const r=t.getEpsilon(),i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],u=e[7],d=e[8];return Math.abs(1-(i*i+o*o+c*c))<=r&&Math.abs(1-(s*s+a*a+u*u))<=r&&Math.abs(1-(n*n+l*l+d*d))<=r}const A=u,D=P,E=Object.freeze(Object.defineProperty({__proto__:null,add:C,adjoint:l,copy:i,determinant:c,equals:I,exactEquals:O,frob:T,fromMat2d:_,fromMat4:r,fromQuat:b,fromRotation:g,fromScaling:y,fromTranslation:m,identity:n,invert:a,isOrthoNormal:F,mul:A,multiply:u,multiplyScalar:M,multiplyScalarAndAdd:R,normalFromMat4:w,normalFromMat4Legacy:v,projection:x,rotate:h,scale:p,scaleByVec2:f,set:s,str:S,sub:D,subtract:P,translate:d,transpose:o},Symbol.toStringTag,{value:"Module"}));e.add=C,e.adjoint=l,e.copy=i,e.determinant=c,e.equals=I,e.exactEquals=O,e.frob=T,e.fromMat2d=_,e.fromMat4=r,e.fromQuat=b,e.fromRotation=g,e.fromScaling=y,e.fromTranslation=m,e.identity=n,e.invert=a,e.isOrthoNormal=F,e.mat3=E,e.mul=A,e.multiply=u,e.multiplyScalar=M,e.multiplyScalarAndAdd=R,e.normalFromMat4=w,e.normalFromMat4Legacy=v,e.projection=x,e.rotate=h,e.scale=p,e.scaleByVec2=f,e.set=s,e.str=S,e.sub=D,e.subtract=P,e.translate=d,e.transpose=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/sphere":function(){define(["exports","../core/has","../core/Logger","../core/mathUtils","../core/libs/gl-matrix-2/math/mat4","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","./vec42","../core/libs/gl-matrix-2/factories/vec4f64","../core/libs/gl-matrix-2/math/common","../geometry/support/ray","../geometry/support/sphereUtils","../geometry/support/vector","../geometry/support/vectorStacks"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const f=m();function m(){return l.create()}const g=a.equals,y=a.equals;function _(e,t){return a.copy(t,e)}function b(e,t){return l.fromValues(e[0],e[1],e[2],t)}function v(e){return e}function w(e){e[0]=e[1]=e[2]=e[3]=0}function x(e,t){return e[0]=e[1]=e[2]=0,e[3]=t,e}function S(e){return e[3]}function T(e){return e}function C(e,t,r,i){return l.fromValues(e,t,r,i)}function P(e,t,r){return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2]),r[3]=e[3]+t,r}function M(e,t,r){return e!==r&&_(e,r),r}function R(e,t){return t}function O(e,t,r){if(null==t)return!1;if(!A(e,t,F))return!1;let{t0:i,t1:s}=F;if((i<0||s<i&&s>0)&&(i=s),i<0)return!1;if(r){const{origin:e,direction:s}=t;r[0]=e[0]+s[0]*i,r[1]=e[1]+s[1]*i,r[2]=e[2]+s[2]*i}return!0}function I(e,t,r){const i=u.fromPoints(t,r);if(!A(e,i,F))return[];const{origin:s,direction:a}=i,{t0:l,t1:d}=F,h=t=>{const r=o.create();return n.scaleAndAdd(r,s,a,t),N(e,r,r)};return Math.abs(l-d)<c.getEpsilon()?[h(l)]:[h(l),h(d)]}const F={t0:0,t1:0};function A(e,t,r){const{origin:i,direction:s}=t,n=D;n[0]=i[0]-e[0],n[1]=i[1]-e[1],n[2]=i[2]-e[2];const o=s[0]*s[0]+s[1]*s[1]+s[2]*s[2];if(0===o)return!1;const a=2*(s[0]*n[0]+s[1]*n[1]+s[2]*n[2]),l=a*a-4*o*(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]-e[3]*e[3]);if(l<0)return!1;const c=Math.sqrt(l);return r.t0=(-a-c)/(2*o),r.t1=(-a+c)/(2*o),!0}const D=o.create();function E(e,t){return O(e,t,null)}function L(e,t,r){if(O(e,t,r))return r;const i=V(e,t,p.sv3d.get());return n.add(r,t.origin,n.scale(p.sv3d.get(),t.direction,n.distance(t.origin,i)/n.length(t.direction))),r}function V(e,t,r){const i=p.sv3d.get(),o=p.sm4d.get();n.cross(i,t.origin,t.direction);const a=S(e);n.cross(r,i,t.origin),n.scale(r,r,1/n.length(r)*a);const l=z(e,t.origin),c=h.angle(t.origin,r);return s.fromRotation(o,c+l,i),n.transformMat4(r,r,o),r}function U(e,t,r,i){const s=S(e),n=s*s,o=t+.5*Math.PI,a=r*r+n-2*Math.cos(o)*r*s,l=Math.sqrt(a),c=a-n;if(c<=0)return.5;const u=Math.sqrt(c),d=Math.acos(u/l)-Math.asin(s/(l/Math.sin(o)));return Math.min(1,(d+.5*i)/i)}function B(e,t,r){return O(e,t,r)?r:(u.closestPoint(t,e,r),N(e,r,r))}function N(e,t,r){const i=n.subtract(p.sv3d.get(),t,e),s=n.scale(p.sv3d.get(),i,e[3]/n.length(i));return n.add(r,s,e)}function k(e,t){const r=n.subtract(p.sv3d.get(),t,e),i=n.squaredLength(r),s=e[3]*e[3];return Math.sqrt(Math.abs(i-s))}function z(e,t){const r=n.subtract(p.sv3d.get(),t,e),s=n.length(r),o=S(e),a=o+Math.abs(o-s);return i.acosClamped(o/a)}const j=o.create();function G(e,t,r,i){const s=n.subtract(j,t,e);switch(r){case 0:{const e=d.cartesianToSpherical(s,j)[2];return n.set(i,-Math.sin(e),Math.cos(e),0)}case 1:{const e=d.cartesianToSpherical(s,j),t=e[1],r=e[2],o=Math.sin(t);return n.set(i,-o*Math.cos(r),-o*Math.sin(r),Math.cos(t))}case 2:return n.normalize(i,s);default:return}}function q(e,t){const r=n.subtract(Q,t,e);return n.length(r)-e[3]}function H(e,t,r,i){const s=q(e,t),o=G(e,t,2,Q),a=n.scale(Q,o,r-s);return n.add(i,t,a)}function W(e,t){const r=n.squaredDistance(e,t),i=S(e);return r<=i*i}function $(e,t,r=l.create()){const i=n.distance(e,t),s=e[3],o=t[3];return i+o<s?(a.copy(r,e),r):i+s<o?(a.copy(r,t),r):(n.lerp(r,e,t,(i+o-s)/(2*i)),r[3]=(i+s+o)/2,r)}const Q=o.create(),Z=m(),Y=Object.freeze(Object.defineProperty({__proto__:null,NullSphere:f,altitudeAt:q,angleToSilhouette:z,axisAt:G,cameraFrustumCoverage:U,clear:w,closestPoint:B,closestPointOnSilhouette:V,containsPoint:W,copy:_,create:m,distanceToSilhouette:k,elevate:P,equals:y,exactEquals:g,fromCenterAndRadius:b,fromRadius:x,fromValues:C,getCenter:T,getExtent:R,getRadius:S,intersectLine:I,intersectRay:O,intersectRayClosestSilhouette:L,intersectsRay:E,projectPoint:N,setAltitudeAt:H,setExtent:M,tmpSphere:Z,union:$,wrap:v},Symbol.toStringTag,{value:"Module"}));e.NullSphere=f,e.altitudeAt=q,e.angleToSilhouette=z,e.axisAt=G,e.cameraFrustumCoverage=U,e.clear=w,e.closestPoint=B,e.closestPointOnSilhouette=V,e.containsPoint=W,e.copy=_,e.create=m,e.distanceToSilhouette=k,e.elevate=P,e.equals=y,e.exactEquals=g,e.fromCenterAndRadius=b,e.fromRadius=x,e.fromValues=C,e.getCenter=T,e.getExtent=R,e.getRadius=S,e.intersectLine=I,e.intersectRay=O,e.intersectRayClosestSilhouette=L,e.intersectsRay=E,e.projectPoint=N,e.setAltitudeAt=H,e.setExtent=M,e.sphere=Y,e.tmpSphere=Z,e.union=$,e.wrap=v})},"esri/geometry/support/sphereUtils":function(){define(["exports","../../core/mathUtils","../../chunks/vec32"],function(e,t,r){"use strict";e.cartesianToSpherical=function(e,i){const s=r.length(e),n=t.asinClamped(e[2]/s),o=Math.atan2(e[1]/s,e[0]/s);return r.set(i,s,n,o),i},e.sphericalToCartesian=function(e,t){const i=e[0],s=e[1],n=e[2],o=Math.cos(s);r.set(t,i*o*Math.cos(n),i*o*Math.sin(n),i*Math.sin(s))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/TilemapCache":function(){define(["exports","../../chunks/tslib.es6","../../request","../../core/Accessor","../../core/Error","../../core/handleUtils","../../core/has","../../core/LRUCache","../../core/PooledArray","../../core/promiseUtils","../../core/reactiveUtils","../../core/scheduling","../../core/urlUtils","../../core/accessorSupport/decorators/property","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./TileKey","./Tilemap"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";var b;function v(e,t,r){return new s("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:r})}e.TilemapCache=class extends i{static{b=this}constructor(e){super(e),this._pendingTilemapRequests={},this.request=r,this.size=32,this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new a.LRUCache(2097152),this.addHandles(u.watch(()=>{const{layer:e}=this;return[e?.parsedUrl,e?.tileServers,e?.apiKey,e?.customParameters]},()=>this._initializeTilemapDefinition(),u.initial))}get effectiveMinLOD(){return this.minLOD??this.layer.tileInfo.lods[0].level}get effectiveMaxLOD(){return this.maxLOD??this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}getAvailability(e,t,r){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return"unavailable";const i=this._tilemapFromCache(e,t,r,this._tmpTilemapDefinition);return i?i.getAvailability(t,r):"unknown"}fetchAvailability(e,t,r,i){return!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD?Promise.reject(v(e,t,r)):this._fetchTilemap(e,t,r,i).catch(e=>e).then(i=>{if(i instanceof _.Tilemap){const s=i.getAvailability(t,r);if("unavailable"===s)throw v(e,t,r);return s}if(c.isAbortError(i))throw i;return"unknown"})}fetchAvailabilityUpsample(e,t,r,i,s){i.level=e,i.row=t,i.col=r;const n=this.layer.tileInfo;n.updateTileInfo(i);const o=this.fetchAvailability(e,t,r,s).catch(e=>{if(c.isAbortError(e))throw e;if(n.upsampleTile(i))return this.fetchAvailabilityUpsample(i.level,i.row,i.col,i,s);throw e});return this._fetchAvailabilityUpsamplePrefetch(i.id,e,t,r,s,o),o}async _fetchAvailabilityUpsamplePrefetch(e,t,r,i,s,o){if(!this._prefetchingEnabled||null==e)return;const a=`prefetch-${e}`;if(this.hasHandles(a))return;const l=new AbortController;o.then(()=>l.abort(),()=>l.abort());let u=!1;const h=n.makeHandle(()=>{u||(u=!0,l.abort())});if(this.addHandles(h,a),await d.waitTicks(10,l.signal).catch(()=>{}),u||(u=!0,this.removeHandles(a)),c.isAborted(l))return;const p=new y.TileKey(e,t,r,i),f={...s,signal:l.signal},m=this.layer.tileInfo;for(let e=0;b._prefetches.length<b._maxPrefetch&&m.upsampleTile(p);++e){const e=this.fetchAvailability(p.level,p.row,p.col,f);b._prefetches.push(e);const t=()=>{b._prefetches.removeUnordered(e)};e.then(t,t)}}static{this._maxPrefetch=4}static{this._prefetches=new l({initialSize:b._maxPrefetch})}static cleanupTilemapCache(){this._prefetches.prune()}_fetchTilemap(e,t,r,i){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return Promise.reject(new s("tilemap-cache:level-unavailable",`Level ${e} is unavailable in the service`));const n=this._tmpTilemapDefinition,o=this._tilemapFromCache(e,t,r,n);if(o)return Promise.resolve(o);const a=i?.signal;return i={...i,signal:null},new Promise((e,t)=>{c.onAbort(a,()=>t(c.createAbortError()));const r=_.tilemapDefinitionId(n);let s=this._pendingTilemapRequests[r];if(!s){s=_.Tilemap.fromDefinition(n,i).then(e=>(this._tilemapCache.put(r,e,e.byteSize),e));const e=()=>{delete this._pendingTilemapRequests[r]};this._pendingTilemapRequests[r]=s,s.then(e,e)}s.then(e,t)})}_initializeTilemapDefinition(){if(!this.layer.parsedUrl)return;const{parsedUrl:e,apiKey:t,customParameters:r}=this.layer;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:h.objectToQuery({...e.query,...r,token:t??e.query?.token}),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(e,t,r,i){i.level=e,i.row=t-t%this.size,i.col=r-r%this.size;const s=_.tilemapDefinitionId(i);return this._tilemapCache.get(s)}get test(){}},t.__decorate([p.property({constructOnly:!0})],e.TilemapCache.prototype,"layer",void 0),t.__decorate([p.property({constructOnly:!0})],e.TilemapCache.prototype,"minLOD",void 0),t.__decorate([p.property({constructOnly:!0})],e.TilemapCache.prototype,"maxLOD",void 0),t.__decorate([p.property({constructOnly:!0})],e.TilemapCache.prototype,"request",void 0),t.__decorate([p.property({constructOnly:!0})],e.TilemapCache.prototype,"size",void 0),e.TilemapCache=b=t.__decorate([g.subclass("esri.layers.support.TilemapCache")],e.TilemapCache),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/TileKey":function(){define(["exports"],function(e){"use strict";e.TileKey=class{constructor(e,t,r,i,s=void 0){this.id=e,this.level=t,this.row=r,this.col=i,this.extent=s}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/Tilemap":function(){define(["exports","../../request","../../core/Error","../../core/lang","../../core/memoryEstimations","../../geometry/support/UintArray"],function(e,t,r,i,s,n){"use strict";class o{constructor(e){!function(e){if(!e?.location)throw new r("tilemap:missing-location","Location missing from tilemap response");if(!1===e.valid)throw new r("tilemap:invalid","Tilemap response was marked as invalid");if(!e.data)throw new r("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(e.data))throw new r("tilemap:data-mismatch","Data must be an array of numbers");if(e.data.length!==e.location.width*e.location.height)throw new r("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}(e);const{location:t,data:o}=e;this.location=Object.freeze(i.clone(t));const a=this.location.width,l=this.location.height;let c=!0,u=!0;const d=Math.ceil(a*l/32),h=n.newUintArray(d);let p=0;for(let e=0;e<o.length;e++){const t=e%32;o[e]?(u=!1,h[p]|=1<<t):c=!1,31===t&&++p}u?(this._availability="unavailable",this.byteSize=40):c?(this._availability="available",this.byteSize=40):(this._availability=h,this.byteSize=40+s.estimateNumberArrayMemory(h))}getAvailability(e,t){if("unavailable"===this._availability||"available"===this._availability)return this._availability;const r=(e-this.location.top)*this.location.width+(t-this.location.left),i=r%32,s=r>>5,n=this._availability;return s<0||s>n.length?"unknown":n[s]&1<<i?"available":"unavailable"}static fromDefinition(e,i){const s=e.service.request||t,{row:n,col:a,width:l,height:c}=e,u={query:{f:"json"}};return i=i?{...u,...i}:u,s(function(e){let t;if(e.service.tileServers?.length){const r=e.service.tileServers;t=`${r&&r.length?r[e.row%r.length]:e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}else t=`${e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`;const r=e.service.query;return r&&(t=`${t}?${r}`),t}(e),i).then(e=>e.data).catch(e=>{if(422===e?.details?.httpStatus)return{location:{top:n,left:a,width:l,height:c},valid:!0,data:new Array(l*c).fill(0)};throw e}).then(e=>{if(e.location&&(e.location.top!==n||e.location.left!==a||e.location.width!==l||e.location.height!==c))throw new r("tilemap:location-mismatch","Tilemap response for different location than requested",{response:e,definition:{top:n,left:a,width:l,height:c}});return o.fromJSON(e)})}static fromJSON(e){return Object.freeze(new o(e))}}e.Tilemap=o,e.tilemapDefinitionId=function(e){return`${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/UintArray":function(){define(["exports","../../core/typedArrayUtil"],function(e,t){"use strict";e.newUintArray=function(e,r=!1){return e<=t.nativeArrayMaxSize?r?new Array(e).fill(0):new Array(e):new Uint32Array(e)},e.uintSubArray=function(e,t,r){return Array.isArray(e)?e.slice(t,t+r):e.subarray(t,t+r)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/support/tagSymbols":function(){define(["exports"],function(e){"use strict";const t=Symbol("WebScene");e.WebSceneTag=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/BreakpointsOwner":function(){define(["exports","../chunks/tslib.es6","../core/ArrayPool","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a,l){"use strict";const c={widthBreakpoint:{getValue(e){const t=e.viewSize[0],r=e.breakpoints,i=this.values;return t<=r.xsmall?i.xsmall:t<=r.small?i.small:t<=r.medium?i.medium:t<=r.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(e){const t=e.viewSize[1],r=e.breakpoints,i=this.values;return t<=r.xsmall?i.xsmall:t<=r.small?i.small:t<=r.medium?i.medium:t<=r.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(e){const t=e.viewSize,r=t[0],i=t[1],s=this.values;return i>=r?s.portrait:s.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},u={xsmall:544,small:768,medium:992,large:1200};function d(e,t){return t?c[e].valueToClassName[t].split(" "):[]}e.BreakpointsOwner=e=>{const n=e;let o=class extends n{constructor(...e){super(...e),this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=u}initialize(){this.addHandles(i.watch(()=>[this.breakpoints,this.size],()=>this._updateClassNames(),i.initial))}destroy(){this.destroyed||this._removeActiveClassNames()}set breakpoints(e){if(e!==this._get("breakpoints")){if(!function(e){const t=e;return t&&t.xsmall<t.small&&t.small<t.medium&&t.medium<t.large}(e)){const t=JSON.stringify(u,null,2);console.warn("provided breakpoints are not valid, using defaults:"+t),e=u}this._set("breakpoints",{...e})}}_updateClassNames(){if(!this.container)return;const e=r.acquire(),t=r.acquire();let i,s=!1;for(i in c){const r=this[i],n=c[i].getValue({viewSize:this.size,breakpoints:this.breakpoints});r!==n&&(s=!0,this[i]=n,d(i,r).forEach(e=>t.push(e)),d(i,n).forEach(t=>e.push(t)))}s&&(this._applyClassNameChanges(e,t),r.release(e),r.release(t))}_applyClassNameChanges(e,t){const r=this.container;r&&(t.forEach(e=>r.classList.remove(e)),e.forEach(e=>r.classList.add(e)))}_removeActiveClassNames(){const e=this.container;if(!e)return;let t;for(t in c)d(t,this[t]).forEach(t=>e.classList.remove(t))}};return t.__decorate([s.property()],o.prototype,"breakpoints",null),t.__decorate([s.property()],o.prototype,"orientation",void 0),t.__decorate([s.property()],o.prototype,"widthBreakpoint",void 0),t.__decorate([s.property()],o.prototype,"heightBreakpoint",void 0),o=t.__decorate([l.subclass("esri.views.BreakpointsOwner")],o),o},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/DOMContainer":function(){define(["exports","../chunks/tslib.es6","../core/domUtils","../core/events","../core/handleUtils","../core/Logger","../core/maybe","../core/reactiveUtils","../core/scheduling","../core/accessorSupport/decorators/property","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./overlay/ViewOverlay"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const f=[0,0];function m(e){const t=(e.ownerDocument||window.document).defaultView,r=e.getBoundingClientRect();return f[0]=r.left+(t?.pageXOffset??0),f[1]=r.top+(t?.pageYOffset??0),f}function g(e){e&&(e.textContent="",e.parentNode&&e.parentNode.removeChild(e))}const y=16,_=750;e.DOMContainer=e=>{const u=e;let d=class extends u{constructor(...e){super(...e),this._freqInfo={freq:y,time:_},this._overlayRenderTaskHandle=null,this.height=0,this.messagesCommon=null,this.overlay=null,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.addHandles([a.watch(()=>this.cursor,e=>{const{surface:t}=this;t&&t.setAttribute("data-cursor",e)}),a.watch(()=>this.navigating,e=>{const{surface:t}=this;t&&t.setAttribute("data-navigating",e.toString())})])}initialize(){this.addHandles([a.watch(()=>this.ui,(e,t)=>this._handleUIChange(e,t),a.initial),this.on("focus",()=>this.notifyChange("focused")),this.on("blur",()=>this.notifyChange("focused"))])}destroy(){this.destroyed||(this.ui?.destroy(),this.container=null)}get container(){return this._get("container")??null}set container(e){const t=this._get("container"),i=r.byId(e);if(i||"string"!=typeof e||n.getLogger(this).error("#container",`element with id '${e}' not found`),t===i)return;if(this._stopMeasuring(),t&&(t.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay&&(this.overlay.destroy(),this._set("overlay",null)),this.root&&(g(this.root),this._set("root",null)),this.userContent&&(r.reparent(this.userContent,t),g(this.userContent),this._set("userContent",null))),!i)return this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),void this._set("container",null);i.classList.add("esri-view");const s=document.createElement("div");s.className="esri-view-user-storage",r.reparent(i,s),i.appendChild(s),this._set("userContent",s);const c=document.createElement("div");c.className="esri-view-root",i.insertBefore(c,i.firstChild),this._set("root",c);const u=document.createElement("div");u.className="esri-view-surface",u.setAttribute("role","application"),u.tabIndex=0,c.appendChild(u),this._set("surface",u);const d=new p;c.appendChild(d.surface),this._set("overlay",d),this.addHandles(a.watch(()=>d.needsRender,e=>{e&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=l.addFrameTask({render:()=>this.overlay?.render()}):this._overlayRenderTaskHandle=o.removeMaybe(this._overlayRenderTaskHandle)})),this.forceDOMReadyCycle(),this._set("container",i),this._startMeasuring()}get focused(){const e=document.activeElement===this.surface;return document.hasFocus()&&e}get size(){return[this.width,this.height]}set ui(e){const t=this._get("ui");t!==e&&t?.destroy(),this._set("ui",e)}blur(){this.surface?.blur()}focus(){this.surface?.focus()}pageToContainer(e,t,r){const i=this.position;return e-=i?i[0]:0,t-=i?i[1]:0,r?(r[0]=e,r[1]=t):r=[e,t],r}containerToPage(e,t,r){const i=this.position;return e+=i?i[0]:0,t+=i?i[1]:0,r?(r[0]=e,r[1]=t):r=[e,t],r}_handleUIChange(e,t){this.removeHandles("ui"),t&&t!==e&&t.destroy(),e&&(e.view=this,this.addHandles(a.watch(()=>this.root,t=>{e.container=t?function(e){const t=document.createElement("div");return e.appendChild(t),t}(t):null},a.initial),"ui")),this._set("ui",e)}_stopMeasuring(){this.removeHandles("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const e=this._freqInfo;e.freq=y,e.time=_;const t=l.addFrameTask({prepare:e=>{const r=this._measure(),i=this._freqInfo;if(i.time+=e.deltaTime,r&&(i.freq=y,this._get("resizing")||this._set("resizing",!0)),i.time<i.freq)return;i.time=0;const s=this._position();i.freq=s||r?y:Math.min(_,2*i.freq),!r&&i.freq>=512&&(t.pause(),this._get("resizing")&&this._set("resizing",!1))}}),r=new ResizeObserver(r=>{e.freq=y,e.time=_,t.resume()});null!=this.container&&r.observe(this.container);const n=s.makeHandle(()=>r.disconnect());this.addHandles([i.on(window,"resize",()=>{e.freq=y,e.time=_,t.resume()}),n,t],"measuring"),this._measure(),this._position()}_measure(){const e=this.container,t=e?e.clientWidth:0,r=e?e.clientHeight:0;if(0===t||0===r)return this.suspended||this._set("suspended",!0),!1;const i=this.width,s=this.height;return t===i&&r===s?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",t),this._set("height",r),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:i,oldHeight:s,width:t,height:r}),!0)}_position(){const e=this.container,t=this.position,r=e&&m(e);return!(!r||t&&r[0]===t[0]&&r[1]===t[1]||(this._set("position",[r[0],r[1]]),0))}forceDOMReadyCycle(){}};return t.__decorate([c.property()],d.prototype,"container",null),t.__decorate([c.property({readOnly:!0})],d.prototype,"focused",null),t.__decorate([c.property({readOnly:!0})],d.prototype,"height",void 0),t.__decorate([c.property()],d.prototype,"messagesCommon",void 0),t.__decorate([c.property({type:p})],d.prototype,"overlay",void 0),t.__decorate([c.property({readOnly:!0})],d.prototype,"position",void 0),t.__decorate([c.property({readOnly:!0})],d.prototype,"resizing",void 0),t.__decorate([c.property({readOnly:!0})],d.prototype,"root",void 0),t.__decorate([c.property({value:null,readOnly:!0})],d.prototype,"size",null),t.__decorate([c.property({readOnly:!0})],d.prototype,"surface",void 0),t.__decorate([c.property({readOnly:!0})],d.prototype,"suspended",void 0),t.__decorate([c.property({nonNullable:!0})],d.prototype,"ui",null),t.__decorate([c.property({readOnly:!0})],d.prototype,"userContent",void 0),t.__decorate([c.property({readOnly:!0})],d.prototype,"width",void 0),t.__decorate([c.property()],d.prototype,"widthBreakpoint",void 0),d=t.__decorate([h.subclass("esri.views.DOMContainer")],d),d},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/overlay/ViewOverlay":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/Collection","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/support/UpdatingHandles","../../libs/maquette/projection","../../libs/maquette/projector"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";let d=class extends t{constructor(){super(...arguments),this.items=new r,this._watchUpdatingTracking=new l.UpdatingHandles,this._callbacks=new Map,this._projector=u.createProjector(),this._hiddenProjector=u.createProjector()}get needsRender(){return this.items.length>0}get updating(){return this._watchUpdatingTracking?.updating??!1}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(()=>this.items,e=>{for(const t of e.added){const e=()=>t.render();this._callbacks.set(t,e),this._projector.append(this.surface,e)}for(const t of e.removed){const e=this._projector.detach(this._callbacks.get(t));this.surface.removeChild(e.domNode),this._callbacks.delete(t)}})}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach(e=>this._projector.detach(e)),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const t=this._hiddenSurface,r=this._hiddenProjector;let i;const s=()=>(i=e.render(),i);r.append(t,s),r.renderNow();const n={left:0,top:0,right:0,bottom:0};if(i?.domNode){const e=i.domNode.getBoundingClientRect();n.left=e.left,n.top=e.top,n.right=e.right,n.bottom=e.bottom}for(r.detach(s);t.firstChild;)t.removeChild(t.firstChild);return n}overlaps(e,t){const r=this.computeBoundingRect(e),i=this.computeBoundingRect(t);return Math.max(r.left,i.left)<=Math.min(r.right,i.right)&&Math.max(r.top,i.top)<=Math.min(r.bottom,i.bottom)}get hasVisibleItems(){return this.items.some(e=>e.visible)}async prepare(){await document.fonts.load(this._fontString()).catch(()=>{})}renderCanvas(e,t){const r=!!t?.disableDecorations;if(!this.items.some(e=>e.visible&&!(r&&e.isDecoration)))return;const i=e.getContext("2d");i.save(),i.font=this._fontString(),this.items.forEach(e=>{r&&e.isDecoration||(i.save(),e.renderCanvas(i),i.restore())}),i.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};return e.__decorate([i.property({readOnly:!0})],d.prototype,"surface",void 0),e.__decorate([i.property({readOnly:!0})],d.prototype,"items",void 0),e.__decorate([i.property({readOnly:!0})],d.prototype,"needsRender",null),e.__decorate([i.property({readOnly:!0})],d.prototype,"_watchUpdatingTracking",void 0),e.__decorate([i.property({readOnly:!0})],d.prototype,"updating",null),d=e.__decorate([a.subclass("esri.views.overlay.ViewOverlay")],d),d})},"esri/views/GroundView":function(){define(["../chunks/tslib.es6","../core/Accessor","../core/Collection","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./3d/support/cameraUtils","./support/GroundViewElevationSampler"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";let d=class extends t{constructor(e){super(e),this.view=null,this.layerViews=new r}initialize(){this.addHandles(i.when(()=>this.view?.map?.ground,e=>e.load()))}destroy(){this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return"2d"!==this.view?.type&&this.view?.ready&&this.view?.basemapTerrain?.ready?new u({view:this.view}):null}get extent(){const e=this.view;return e&&"2d"!==e.type&&e.ready?c.toExtent(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return this.view?.suspended??!0}};return e.__decorate([s.property({readOnly:!0})],d.prototype,"elevationSampler",null),e.__decorate([s.property({readOnly:!0})],d.prototype,"extent",null),e.__decorate([s.property({type:Boolean,readOnly:!0})],d.prototype,"updating",null),e.__decorate([s.property({constructOnly:!0})],d.prototype,"view",void 0),e.__decorate([s.property({type:r,readOnly:!0})],d.prototype,"layerViews",void 0),e.__decorate([s.property({readOnly:!0})],d.prototype,"suspended",null),d=e.__decorate([l.subclass("esri.views.GroundView")],d),d})},"esri/views/3d/support/cameraUtils":function(){define(["exports","../../../Camera","../../../core/Cyclical","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/Point","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectVectorToPoint","../webgl","./earthUtils","./ElevationProvider","./viewingModeUtils","../../support/spatialReferenceSupport"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";const b=()=>i.getLogger("esri.views.3d.support.cameraUtils"),v=96*39.37,w=a.create(),x=new r.Cyclical(-20037508.342788905,20037508.342788905),S=new r.Cyclical(-180,180);function T(e){return e.spatialReference??d.WGS84}function C(e,t){const{camera:r}=e.state,{unitInMeters:i}=e.renderCoordsHelper;return t/=i,r.width/2/r.pixelRatio/(v/t)/Math.tan(r.fovX/2)}function P(e,t){const{camera:r}=e.state,{unitInMeters:i}=e.renderCoordsHelper,s=t*Math.tan(r.fovX/2),n=r.width/2/r.pixelRatio;return v/(n/s)*i}function M(e,t,r,i){const s=i.levelAtScale(t),n=O(y.directionToHeadingTilt(e,r.eye,r.viewForward,r.up).tilt),o=Math.max(s-n,0);return i.scaleAtLevel(o)}function R(e,t,r){const i=r.levelAtScale(e),s=O(t);return r.scaleAtLevel(i+s)}function O(e){return 2*((e>90?180-e:e)/90)**2}function I(e,t,r=0){const i=f.toRenderCamera(e,t);return i?function(e,t,r=0){const i=e.basemapTerrain?.tilingScheme;if(!i)return 0;const s=l.getReferenceEllipsoid(e.spatialReference).radius,n=2===e.state.viewingMode?t.eye[2]:o.length(t.eye)-s;return M(e,P(e,Math.abs(n-r)),t,i)}(e,i,r):0}async function F(e,t,r,i,s,o){const a=await E(e,i.heading,i.tilt,t,r,s,o);return n.throwIfAborted(o),$(e,a,i.fov,o)}function A(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,w,e.spatialReference)&&e.elevationProvider&&(g.getElevationAtPoint(e.elevationProvider,w)??0)>w[2]-1)}function D(e,t,r,i,s,n){const l=i instanceof c?i:null,u=function(e,t){const r=a.create();if(null==t)return o.copy(r,e.state.camera.center);if(t instanceof c){if(!h.projectPointToVector(t,r,e.renderSpatialReference))return null;const{basemapTerrain:i,elevationProvider:s}=e;if(null==t.z&&null!=i&&null!=s){const i=g.getElevationAtPoint(s,t);null!=i&&e.renderCoordsHelper.setAltitude(r,i)}return r}return o.copy(r,t)}(e,i);return L(e,t,r,l,u,s,n)}async function E(e,t,r,i,s,l,u){const d=i instanceof c?i:null,p=await async function(e,t,r){const i=a.create();if(null==t)return o.copy(i,e.state.camera.center);if(t instanceof c){const{renderSpatialReference:s,basemapTerrain:o,elevationProvider:a}=e,l=t.spatialReference;if(await h.projectPointToVectorAsync(t,i,s,0,{signal:r}),n.throwIfAborted(r),null==t.z&&null!=o&&null!=a){const s=await a.queryElevation(t.x,t.y,t.z??0,l,"ground",r);n.throwIfAborted(r),null!=s&&e.renderCoordsHelper.setAltitude(i,s)}return i}return o.copy(i,t)}(e,i,u);return n.throwIfAborted(u),V(e,t,r,d,p,s,l,u)}function L(e,t,r,i,s,n,o){if(null==s)return null;if(!i&&(i=new c({spatialReference:T(e)}),!p.projectVectorToPoint(s,e.renderSpatialReference,i)))return null;const a=U(e,t,r,s,n,o);if(B(e,r,o)&&A(e,a.eye)){const{tilt:o,mode:a}=N(e,r,s,n);return L(e,t,o,i,s,n,a)}return k(a,s)}async function V(e,t,r,i,s,o,a,l){i||(i=new c({spatialReference:T(e)}),await p.projectVectorToPointAsync(s,e.renderSpatialReference,i,{signal:l})||(i=null)),n.throwIfAborted(l);const u=U(e,t,r,s,o,a);if(B(e,r,a)&&await async function(e,t,r){if(A(e,t))return!0;const{elevationProvider:i,spatialReference:s,renderCoordsHelper:o}=e;if(null==i||!o.fromRenderCoords(t,w,s))return!1;const[a,l,c]=w,u=await i.queryElevation(a,l,c,s,"ground",r)??0;return n.throwIfAborted(r),u>c-1}(e,u.eye,l)){n.throwIfAborted(l);const{tilt:a,mode:c}=N(e,r,s,o);return V(e,t,a,i,s,o,c,l)}return k(u,s)}function U(e,t,r,i,s,n){const a=function(e,t,r,i,s,n){let a=0;return 1===n&&function(e,t,r){const i=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/i)/Math.LN2>8)return!0;const s=t,n=e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return o.distance(s,n)/(Math.tan(.5*e.state.camera.fov)*i)>5}(e,i,s)?(t=0,a=function(e,t,r,i){const s=H(e,i,t,r);if(!e.state.constraints.tilt)return s;const n=e.state.constraints.tilt(t);n.max=Math.min(n.max,.5*Math.PI);const o=n.min*(1-G)+n.max*G;return Math.min(s,o)}(e,s,r,i)):a=H(e,i,s,r),a=e.state.constraints.clampTilt(s,a),{heading:t,tilt:r=q(e,i,s,a)}}(e,t,r,i,s=Math.max(s,e.state.constraints.minimumPoiDistance),n);return(0,y.viewModeDependentUtil(e).eyeForCenterWithHeadingTilt)(i,s,a.heading,a.tilt)}function B(e,t,r){const i=e.map.ground.navigationConstraint;return 1===r&&e.state.isGlobal&&t>0&&(null==i||"stay-above"===i.type)}function N(e,t,r,i){const s=q(e,r,i,function(e,t,r,i){let s=H(e,i,t,r);if(!e.state.constraints.tilt)return s;const n=e.state.constraints.tilt(t);return s=Math.min(s,.5*Math.PI),n.min*(1-G)+s*G}(e,i,t,r));return{tilt:s,mode:t-s<1?0:1}}function k(e,t){return{...e,center:a.clone(t)}}function z(e,t){const{state:r,spatialReference:i}=e,s=t.spatialReference;return r.isGlobal&&_.isSpatialReferenceSupported(s,1)||r.isLocal&&i.equals(s)}function j(e,t){let r,i,s;if(e.state.isGlobal){const e=new c(t.xmin,t.ymin,t.spatialReference),n=new c(t.xmax,t.ymax,t.spatialReference),o=t.spatialReference.isGeographic?S:x;r=new c({x:o.center(e.x,n.x),y:(n.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const a=l.getReferenceEllipsoid(t.spatialReference),u=m.getGreatCircleSpanAt(r,e,n);i=u.lon,s=u.lat,o.diff(e.x,n.x)>o.range/2&&(i+=a.halfCircumference),i=Math.min(i,a.halfCircumference),s=Math.min(s,a.halfCircumference)}else{const n=e.renderSpatialReference??t.spatialReference;n.equals(t.spatialReference)||(t=u.project(t,n)),i=t.xmax-t.xmin,s=t.ymax-t.ymin;const o=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;r=new c({x:t.xmin+.5*i,y:t.ymin+.5*s,z:o,spatialReference:n})}const n=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,o=e.state.camera,a=1/Math.tan(o.fovX/2),d=1/Math.tan(o.fovY/2),h=1/Math.tan(o.fov/2);return{center:r,distance:Math.max(.5*i*a,.5*s*d,.5*n*h)/1}}const G=.7;function q(e,t,r,i){return y.viewModeDependentUtil(e).lookAtTiltToEyeTilt(i,t,r)}function H(e,t,r,i){return y.viewModeDependentUtil(e).eyeTiltToLookAtTilt(i,t,r)}function W(e,r,i,s){if(null==r)return null;const n=e.renderSpatialReference,o=new c({spatialReference:T(e)});return p.projectVectorToPoint(r.eye,n,o)?(s??=new t,s.position=o,s.heading=r.heading,s.tilt=r.tilt,s.fov=i,s):null}async function $(e,r,i,s){const o=e.renderSpatialReference,a=new c({spatialReference:T(e)});return await p.projectVectorToPointAsync(r.eye,o,a,{signal:s}),n.throwIfAborted(s),new t(a,r.heading,r.tilt,i)}e.applyTiltAdjustToScale=M,e.distanceToScale=P,e.fromCenterDistanceAsync=F,e.fromCenterDistanceSync=function(e,t,r,i,s,n){return W(e,D(e,i.heading,i.tilt,t,r,s),i.fov,n)},e.fromCenterScale=async function(e,t,r,i,s,n){return F(e,t,C(e,r),i,s,n)},e.fromExtentAsync=async function(e,t,r,i,s,o){const a=z(e,t)?t:await u.projectWithZConversion(t,e.spatialReference,{signal:o});n.throwIfAborted(o);const{center:l,distance:c}=j(e,a),d=await E(e,r,i,l,c,s,o);return n.throwIfAborted(o),$(e,d,e.camera.fov,o)},e.fromExtentSync=function(e,t,r,i,s,n){let o;try{o=z(e,t)?t:u.project(t,e.spatialReference)}catch(e){return null}const{center:a,distance:l}=j(e,o),c=D(e,r,i,a,l,s);return null==c?null:W(e,c,e.camera.fov,n)},e.getObserverForPointAtDistanceAsync=E,e.getObserverForPointAtDistanceSync=D,e.getViewSR=T,e.headingTiltToDirectionUp=function(e,t,r,i,s){return y.viewModeDependentUtil(e).headingTiltToDirectionUp(t,r,i,s)},e.removeTiltAdjustFromScale=R,e.scaleErrorThreshold=1,e.scaleToDistance=C,e.scaleToZoom=function(e,t){const r=e.basemapTerrain?.tilingScheme;if(r)return r.levelAtScale(t);b().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")},e.toArea=function(e,t){return y.viewModeDependentUtil(e).toArea(e,t)},e.toExtent=function(e,t,r){const i=e.renderSpatialReference,s=new c({spatialReference:T(e)});if(!p.projectVectorToPoint(r,i,s))return null;const n=Math.tan(t.fovX/2),a=Math.tan(t.fovY/2),l=o.dist(t.eye,r),u=2*l*n*1,d=2*l*a*1;return y.viewModeDependentUtil(e).toExtent(e,s,u,d)},e.viewScaleToCameraDistance=function(e,t,r,i,n){if(0===t)return 0;const a=o.distance(r.eye,i),c=e.basemapTerrain?.tilingScheme;if(!c)return b().error("#scaleToTargetDistance()","Cannot compute distance from scale without a tiling scheme"),a;let u=a;const d=y.directionToHeadingTilt(e,r.eye,r.viewForward,r.up),h=d.tilt>90;if(e.state.isLocal){const i=(C(e,R(t,d.tilt,c))-Math.abs(r.eye[2]-n[2]))/Math.cos(s.deg2rad(d.tilt));return u=h?u-i:u+i,u}let p=1/0,f=0,m=D(e,d.heading,d.tilt,i,a,1);if(!m)return u;const g=o.length(n);for(;p>1&&f<100;){const n=o.length(m.eye),a=h?180-m.tilt:m.tilt,y=s.deg2rad(a),_=Math.sin(y)*n,b=Math.cos(y)*n,v=C(e,R(t,m.tilt,c)),w=h?g-v:g+v,x=s.asinClamped(_/w),S=Math.cos(x)*w-b,T=o.distance(m.eye,i);u=h?T-S:T+S,m=D(e,d.heading,d.tilt,i,u,1);const P=W(e,m,s.rad2deg(r.fov));if(!m||!P)return u;const M=I(e,P,g-l.getReferenceEllipsoid(e.spatialReference).radius);p=Math.abs(t-M),++f}return u},e.zoomToScale=function(e,t){const r=e.basemapTerrain?.tilingScheme;if(r)return r.scaleAtLevel(t);b().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/projection/projectVectorToPoint":function(){define(["exports","../../core/libs/gl-matrix-2/factories/vec3f64","../projectionUtils","./projectVectorToVector"],function(e,t,r,i){"use strict";function s(e,t,r){return!!i.projectVectorToVector(e,t,n,r.spatialReference)&&(r.x=n[0],r.y=n[1],r.z=n[2],!0)}const n=t.create();e.projectVectorToPoint=s,e.projectVectorToPointAsync=async function(e,t,i,n){return await r.initializeProjection(t,i.spatialReference,null,n),s(e,t,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/projection/projectVectorToVector":function(){define(["exports","../projectionUtils","../SpatialReference","./projectPointToVector","../../layers/graphics/dehydratedPoint"],function(e,t,r,i,s){"use strict";function n(e,t,r,s,n){return!(null==t||null==s||e.length<2)&&(o.x=e[0],o.y=e[1],o.z=e[2],o.spatialReference=t,i.projectPointToVector(o,r,s,n))}const o=s.makeDehydratedPoint(0,0,0,r.WGS84);e.projectVectorToVector=n,e.projectVectorToVectorAsync=async function(e,r,i,s,o,a){return await t.initializeProjection(r,s,null,a),n(e,r,i,s,o)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/dehydratedPoint":function(){define(["exports"],function(e){"use strict";e.ImmutableDehydratedPoint=class{constructor(e,t,r,i,s){this.spatialReference=e,this._position=void 0!==s?[t,r,i??0,s??0]:void 0!==i?[t,r,i??0]:[t,r],this._flags=(void 0!==i?1:0)+(void 0!==s?2:0)}get hasZ(){return!(1&~this._flags)}get hasM(){return!(2&~this._flags)}get type(){return"point"}get x(){return this._position[0]}get y(){return this._position[1]}get z(){return this.hasZ?this._position[2]:void 0}get m(){return this.hasM?this._position[3]:void 0}},e.makeDehydratedPoint=function(e,t,r,i){return{x:e,y:t,z:r,hasZ:null!=r,hasM:!1,spatialReference:i,type:"point"}},e.setDehydratedPoint=function(e,t,r,i,s){e.x=t,e.y=r,e.z=i,e.hasZ=null!=i,e.spatialReference=s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl":function(){define(["exports","../../Camera","../../core/mathUtils","../../core/libs/gl-matrix-2/factories/mat4f64","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","../../geometry/Point","../../geometry/SpatialReference","../../geometry/projection/computeTranslationToOriginAndRotation","../../geometry/projection/projectBuffer","../../geometry/projection/projectPointToVector","../../geometry/projection/projectVectorToVector","./camera/intersectionUtils","./support/viewingModeUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const f=n.create(),m={heading:0,tilt:0};e.InternalRenderCategory={SSAO:"ssao",LASERLINES:"laserline-color",ANTIALIASING:"aa-color",HIGHLIGHTS:"highlight-color",MAGNIFIER:"magnifier-color",OCCLUDED:"occluded-color",VIEWSHED:"viewshed-color",OPAQUE_TERRAIN:"opaque-terrain-color",OPAQUE_ENVIRONMENT:"opaque-environment-color",TRANSPARENT_ENVIRONMENT:"transparent-environment-color",FOCUSAREA:"focusarea",FOCUSAREA_COLOR:"focusarea-color"},e.RenderCategory={OPAQUE:"opaque-color",TRANSPARENT:"transparent-color",COMPOSITE:"composite-color",FINAL:"final-color"},e.fromRenderCamera=function(e,i,s){const n=e.renderSpatialReference,l=p.directionToHeadingTilt(e,i.eye,i.viewForward,i.up,m);let c=e.spatialReference;return d.projectVectorToVector(i.eye,n,f,c)||(c=a.WGS84,d.projectVectorToVector(i.eye,n,f,c)),null==s?s=new t(new o(f,c),l.heading,l.tilt,r.rad2deg(i.fov)):(s.position.x=f[0],s.position.y=f[1],s.position.z=f[2],s.position.spatialReference=c,s.heading=l.heading,s.tilt=l.tilt,s.fov=r.rad2deg(i.fov)),s.layout.row=i.row,s.layout.rows=i.rows,s.layout.column=i.column,s.layout.columns=i.columns,s},e.fromRenderCoordinates=function(e,t,r,i,s,n,o){return n=n||e.spatialReference,c.projectBuffer(t,e.renderCoordsHelper.spatialReference,r,i,n,s,o)?i:null},e.renderCoordinateTransformAt=function(e,t,r,s){return s||(s=i.create()),r=r||e.spatialReference,l.computeTranslationToOriginAndRotation(r,t,s,e.renderCoordsHelper.spatialReference)?s:null},e.toRenderCamera=function(e,t){if(!t)return null;const i=e.renderSpatialReference,o=p.viewModeDependentUtil(e).headingTiltToDirectionUp,a=n.create();if(!u.projectPointToVector(t.position,a,i))return null;const l=o(a,t.heading,t.tilt);s.scale(l.direction,l.direction,e.state.camera.distance),s.add(l.direction,l.direction,a);const c=h.cameraOnContentAlongViewDirection(e,a,l.direction,l.up);return c.fov=r.deg2rad(t.fov),c.row=t.layout.row,c.rows=t.layout.rows,c.column=t.layout.column,c.columns=t.layout.columns,c},e.toRenderCoordinates=function(e,t,r,i,s,n,o){return i=i||e.spatialReference,c.projectBuffer(t,i,r,s,e.renderCoordsHelper.spatialReference,n,o)?s:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/projection/computeTranslationToOriginAndRotation":function(){define(["exports","../../core/mathUtils","../../core/libs/gl-matrix-2/math/mat4","../../core/libs/gl-matrix-2/factories/vec3f64","./localRotationUtils","./projectors","../support/spatialReferenceUtils"],function(e,t,r,i,s,n,o){"use strict";function a(e){return 1===e||6===e||8===e||4===e}const l=t.deg2rad(1),c=i.create(),u=i.create();e.computeTranslationToOriginAndRotation=function(e,t,i,d){const h=n.getProjectorClassification(e,d);if(null==h)return!1;const p=h.source.spatialReferenceId,f=h.dest.spatialReferenceId;if(p===f&&!a(f)&&(0!==p||o.equals(e,d)))return r.fromTranslation(i,t),!0;if(a(f)){const e=n.projectionTable[p][10],r=n.projectionTable[10][f];return null!=e&&null!=r&&(e(t,0,c,0),r(c,0,u,0),s.computeENUToPCPFLocalRotation(l*c[0],l*c[1],i),i[12]=u[0],i[13]=u[1],i[14]=u[2],!0)}const m=a(p);if((3===f||11===f||2===f||5===f)&&(2===p||m||3===p||5===p)){const e=n.projectionTable[p][10],o=n.projectionTable[10][f];return null!=e&&null!=o&&(e(t,0,c,0),o(c,0,u,0),m?s.computePCPFToENULocalRotation(l*c[0],l*c[1],i):r.identity(i),i[12]=u[0],i[13]=u[1],i[14]=u[2],!0)}return!1},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/projection/localRotationUtils":function(){define(["exports","../../core/libs/gl-matrix-2/math/mat4"],function(e,t){"use strict";function r(e,t,r){const i=Math.sin(e),s=Math.cos(e),n=Math.sin(t),o=Math.cos(t),a=r;return a[0]=-i,a[4]=-n*s,a[8]=o*s,a[12]=0,a[1]=s,a[5]=-n*i,a[9]=o*i,a[13]=0,a[2]=0,a[6]=o,a[10]=n,a[14]=0,a[3]=0,a[7]=0,a[11]=0,a[15]=1,a}e.computeENUToPCPFLocalRotation=r,e.computePCPFToENULocalRotation=function(e,i,s){return r(e,i,s),t.transpose(s,s),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/camera/intersectionUtils":function(){define(["exports","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/support/aaBoundingRect","../webgl/RenderCamera","../webgl-engine/lib/DepthRange","../webgl-engine/lib/Intersector"],function(e,t,r,i,s,n,o,a){"use strict";function l(e,t){return e.elevationProvider?e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function c(e,r,i){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const s=l(e,r),a=e.stateManager.constraintsManager.nearFarHeuristic;let c=f.get(e);void 0===c&&(c=new n,f.set(e,c)),c.eye=r,c.center=i;const{far:u}=a.compute(c,e.renderDataExtent,o.DepthRange.infinite,s),d=u*u;return t.squaredDistance(r,i)>d}let u={};const d=r.create(),h=r.create(),p=r.create(),f=new WeakMap;e.cameraOnContentAlongViewDirection=function(e,r,s,n){const o=e.state.camera.clone();r&&s&&n&&(o.eye=r,o.center=s,o.up=n),function(e,r,s){let n=u[e.viewingMode];n||(n=new a.Intersector(e.state.viewingMode),n.options.backfacesTerrain=!e.state.isGlobal,n.options.invisibleTerrain=!0,u[e.viewingMode]=n);const{isGlobal:o}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(r,n,s)||c(e,r.origin,s))||!(!e.renderCoordsHelper.intersectManifold(r,0,s)||c(e,r.origin,s))||!!o&&function(e,r,i){const s=t.dot(e.origin,e.origin)-i*i,n=s>0?Math.sqrt(s)/3:1;return t.scale(r,e.direction,n/t.length(e.direction)),t.add(r,r,e.origin),!0}(r,s,i.getReferenceEllipsoid(e.spatialReference).radius)}(e,o.ray,h)||t.copy(h,o.center);const l=e.state.constraints,f=l.minimumPoiDistance;if(t.squaredDistance(o.eye,h)<f){const r=l.collision.enabled;t.copy(p,o.viewForward),t.scale(p,p,f),r?o.eye=t.subtract(d,h,p):t.add(h,o.eye,p);const i=e.renderCoordsHelper,s=i.getAltitude(o.eye),n=l.collision.elevationMargin;r&&s<n&&(t.subtract(p,h,o.eye),o.eye=i.setAltitude(d,n,o.eye),t.add(h,o.eye,p))}return o.center=h,o},e.cleanupIntersectionUtils=function(){u={}},e.eyeWithinExtent=function(e,t,r,i){return null!=e.renderCoordsHelper.fromRenderCoords(t.eye,d,i)&&s.containsPoint(r,d)},e.surfaceElevationBelowRenderLocation=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl/RenderCamera":function(){define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Logger","../../../core/mathUtils","../../../core/screenUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/support/frustum","../../../geometry/support/ray","../../../geometry/support/vector","../webgl-engine/lib/fov"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v){"use strict";var w;let x=w=class extends t{constructor(e){super(e),this._ray=_.create(),this._viewport=g.fromValues(0,0,1,1),this._padding=g.fromValues(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=h.fromValues(1,1e3),this._viewDirty=!0,this._viewMatrix=u.create(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=u.create(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=u.create(),this._frustumDirty=!0,this._frustum=y.create(),this._fullViewport=g.create(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=f.create(),this._up=f.create(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,"_center")}get ray(){return p.subtract(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){c.copy(this._viewMatrix,e),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),p.set(f.create(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),p.set(f.create(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),p.set(f.create(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(1===this.pixelRatio)return this._viewport;const e=m.scale(g.create(),this._viewport,1/this.pixelRatio),t=this._get("screenViewport");return t&&m.equals(e,t)?t:e}get screenPadding(){if(1===this.pixelRatio)return this._padding;const e=m.scale(g.create(),this._padding,1/this.pixelRatio),t=this._get("screenPadding");return t&&m.equals(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){m.exactEquals(this._padding,e)||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),m.copy(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(c.multiply(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return c.invert(u.create(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||u.create()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return v.fovd2fovx(this._fov,this.width,this.height)}set fovX(e){this._fov=v.fovx2fovd(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return v.fovd2fovy(this._fov,this.width,this.height)}set fovY(e){this._fov=v.fovy2fovd(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return p.distance(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(c.invert(this._viewInverseTransposeMatrix,this.viewMatrix),c.transpose(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const{near:t,far:r}=this;return 2*t*r/(r+t-e*(r-t))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}get _projectionMatrixInternal(){const e=this.width,t=this.height,r=this.near*Math.tan(this.fovY/2)*2,i=r*this._aspect,s=r/this.rows,n=i/this.columns,o=-i/2+this.column*n,a=o+n,l=-r/2+this.row*s,d=l+s,h=c.frustum(u.create(),o*(1+2*this._padding[3]/e),a*(1+2*this._padding[1]/e),l*(1+2*this._padding[2]/t),d*(1+2*this._padding[0]/t),this.near,this.far),p=this._get("projectionMatrix");return p&&c.equals(p,h)?p:h}copyFrom(e){p.copy(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,m.copy(this._viewport,e.viewport),this.notifyChange("_viewport"),m.copy(this._padding,e.padding),this.notifyChange("_padding"),d.copy(this._nearFar,e.nearFar),this.notifyChange("_nearFar"),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(c.copy(this._viewMatrix,e.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(y.copy(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(c.copy(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),m.copy(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up,this.fov=e.fov}clone(){return(new w).copyFrom(this)}equals(e){return p.exactEquals(this.eye,e.eye)&&p.exactEquals(this.center,e.center)&&p.exactEquals(this.up,e.up)&&m.exactEquals(this._viewport,e.viewport)&&m.exactEquals(this._padding,e.padding)&&d.exactEquals(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){const t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||m.squaredDistance(e.screenPadding,this.screenPadding)>=t||m.squaredDistance(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;p.sub(P,e.eye,e.center),p.sub(M,this.eye,this.center);const r=p.dot(P,M),i=p.sqrLen(P),s=p.sqrLen(M),n=5e-4;return r*r>=(1-1e-10)*i*s&&p.sqrDist(e.eye,this.eye)<Math.max(i,s)*n*n}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs(b.projectPointSignedLength(this.viewForward,p.subtract(P,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=s.createScreenPointArray()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,r=.5){return e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*r,e[2]=.5,e}setGLViewport(e){const t=this.viewport,r=this.padding;e.setViewport(t[0]-r[3],t[1]-r[2],t[2]+r[1]+r[3],t[3]+r[0]+r[2])}applyProjection(e,t){e!==T&&p.copy(T,e),T[3]=1,m.transformMat4(T,T,this.projectionMatrix);const r=Math.abs(T[3]);p.scale(T,T,1/r);const s=this.fullViewport;t[0]=i.lerp(0,s[0]+s[2],.5+.5*T[0]),t[1]=i.lerp(0,s[1]+s[3],.5+.5*T[1]),t[2]=.5*(T[2]+1),t[3]=r}unapplyProjection(e,t){const r=this.fullViewport;T[0]=(e[0]/(r[0]+r[2])*2-1)*e[3],T[1]=(e[1]/(r[1]+r[3])*2-1)*e[3],T[2]=(2*e[2]-1)*e[3],T[3]=e[3],null!=this.inverseProjectionMatrix&&(m.transformMat4(T,T,this.inverseProjectionMatrix),t[0]=T[0],t[1]=T[1],t[2]=T[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,R),this.renderToScreen(R,t),t}projectToRenderScreen(e,t){if(T[0]=e[0],T[1]=e[1],T[2]=e[2],T[3]=1,m.transformMat4(T,T,this.viewProjectionMatrix),0===T[3])return null;const r=T;p.scale(r,r,1/Math.abs(T[3]));const s=this.fullViewport,n=i.lerp(0,s[0]+s[2],.5+.5*r[0]),o=i.lerp(0,s[1]+s[3],.5+.5*r[1]);return"x"in t?(t.x=n,t.y=o):(t[0]=n,t[1]=o,t.length>2&&(t[2]=.5*(r[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,R),t)}unprojectFromRenderScreen(e,t){if(c.multiply(C,this.projectionMatrix,this.viewMatrix),!c.invert(C,C))return null;const r=this.fullViewport;return T[0]=2*(e[0]-r[0])/r[2]-1,T[1]=2*(e[1]-r[1])/r[3]-1,T[2]=2*e[2]-1,T[3]=1,m.transformMat4(T,T,C),0===T[3]?null:(t[0]=T[0]/T[3],t[1]=T[1]/T[3],t[2]=T[2]/T[3],t)}constrainWindowSize(e,t,r,i){const s=e*this.pixelRatio,n=t*this.pixelRatio,o=Math.max(s-r/2,0),a=Math.max(this.fullHeight-n-i/2,0),l=-Math.min(s-r/2,0),c=-Math.min(this.fullHeight-n-i/2,0),u=r-l- -Math.min(this.fullWidth-s-r/2,0),d=i-c- -Math.min(n-i/2,0);return[Math.round(o),Math.round(a),Math.round(u),Math.round(d)]}computeUp(e){1===e?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const r=e[0]*this.pixelRatio,i=this.fullHeight-e[1]*this.pixelRatio;return t[0]=r,t[1]=i,t}renderToScreen(e,t){const r=e[0]/this.pixelRatio,i=(this.fullHeight-e[1])/this.pixelRatio;t[0]=r,t[1]=i}_computeUpGlobal(){p.subtract(P,this.center,this.eye);const e=p.length(this.center);e<1?(p.set(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(p.dot(P,this.center))>.9999*p.length(P)*e||(p.cross(this._up,P,this.center),p.cross(this._up,this._up,P),p.normalize(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){p.direction(P,this.eye,this.center),Math.abs(P[2])<=.9999&&(p.scale(P,P,P[2]),p.set(this._up,-P[0],-P[1],1-P[2]),p.normalize(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(e,t,i=""){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?p.exactEquals(e,t)||(p.copy(t,e),this._markViewDirty(),i.length&&this.notifyChange(i)):r.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(y.fromMatrix(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(c.lookAt(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};e.__decorate([n.property()],x.prototype,"_viewport",void 0),e.__decorate([n.property()],x.prototype,"_padding",void 0),e.__decorate([n.property()],x.prototype,"_fov",void 0),e.__decorate([n.property()],x.prototype,"_nearFar",void 0),e.__decorate([n.property()],x.prototype,"_viewDirty",void 0),e.__decorate([n.property()],x.prototype,"_viewMatrix",void 0),e.__decorate([n.property()],x.prototype,"_pixelRatio",void 0),e.__decorate([n.property()],x.prototype,"pixelRatio",null),e.__decorate([n.property()],x.prototype,"row",void 0),e.__decorate([n.property()],x.prototype,"column",void 0),e.__decorate([n.property()],x.prototype,"_rows",void 0),e.__decorate([n.property()],x.prototype,"rows",null),e.__decorate([n.property()],x.prototype,"_columns",void 0),e.__decorate([n.property()],x.prototype,"columns",null),e.__decorate([n.property()],x.prototype,"eye",null),e.__decorate([n.property()],x.prototype,"center",null),e.__decorate([n.property()],x.prototype,"_center",void 0),e.__decorate([n.property()],x.prototype,"up",null),e.__decorate([n.property()],x.prototype,"_up",void 0),e.__decorate([n.property()],x.prototype,"viewMatrix",null),e.__decorate([n.property({readOnly:!0})],x.prototype,"viewForward",null),e.__decorate([n.property({readOnly:!0})],x.prototype,"viewUp",null),e.__decorate([n.property({readOnly:!0})],x.prototype,"viewRight",null),e.__decorate([n.property({readOnly:!0})],x.prototype,"nearFar",null),e.__decorate([n.property()],x.prototype,"near",null),e.__decorate([n.property()],x.prototype,"far",null),e.__decorate([n.property()],x.prototype,"viewport",null),e.__decorate([n.property({readOnly:!0})],x.prototype,"screenViewport",null),e.__decorate([n.property({readOnly:!0})],x.prototype,"screenPadding",null),e.__decorate([n.property()],x.prototype,"x",null),e.__decorate([n.property()],x.prototype,"y",null),e.__decorate([n.property()],x.prototype,"width",null),e.__decorate([n.property()],x.prototype,"height",null),e.__decorate([n.property()],x.prototype,"fullWidth",null),e.__decorate([n.property()],x.prototype,"fullHeight",null),e.__decorate([n.property({readOnly:!0})],x.prototype,"_aspect",null),e.__decorate([n.property()],x.prototype,"padding",null),e.__decorate([n.property({readOnly:!0})],x.prototype,"projectionMatrix",null),e.__decorate([n.property({readOnly:!0})],x.prototype,"inverseProjectionMatrix",null),e.__decorate([n.property()],x.prototype,"fov",null),e.__decorate([n.property()],x.prototype,"fovX",null),e.__decorate([n.property()],x.prototype,"fovY",null),e.__decorate([n.property()],x.prototype,"viewInverseTransposeMatrix",null),e.__decorate([n.property({readOnly:!0})],x.prototype,"_projectionMatrixInternal",null),e.__decorate([n.property()],x.prototype,"relativeElevation",void 0),x=w=e.__decorate([l.subclass("esri.views.3d.webgl.RenderCamera")],x);const S=x,T=g.create(),C=u.create(),P=f.create(),M=f.create(),R=s.createRenderScreenPointArray3();return S})},"esri/core/libs/gl-matrix-2/math/vec2":function(){define(["exports","./common"],function(e,t){"use strict";function r(e,t){return e[0]=t[0],e[1]=t[1],e}function i(e,t,r){return e[0]=t,e[1]=r,e}function s(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e}function n(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function o(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e}function a(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e}function l(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function c(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function u(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e}function d(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e}function h(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function p(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e}function f(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e}function m(e,t){const r=t[0]-e[0],i=t[1]-e[1];return Math.sqrt(r*r+i*i)}function g(e,t){const r=t[0]-e[0],i=t[1]-e[1];return r*r+i*i}function y(e){const t=e[0],r=e[1];return Math.sqrt(t*t+r*r)}function _(e){const t=e[0],r=e[1];return t*t+r*r}function b(e,t){return e[0]=-t[0],e[1]=-t[1],e}function v(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function w(e,t){const r=t[0],i=t[1];let s=r*r+i*i;return s>0&&(s=1/Math.sqrt(s),e[0]=t[0]*s,e[1]=t[1]*s),e}function x(e,t){return e[0]*t[0]+e[1]*t[1]}function S(e,t,r){const i=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=i,e}function T(e,t,r,i){const s=t[0],n=t[1];return e[0]=s+i*(r[0]-s),e[1]=n+i*(r[1]-n),e}function C(e,r=1){const i=2*t.RANDOM()*Math.PI;return e[0]=Math.cos(i)*r,e[1]=Math.sin(i)*r,e}function P(e,t,r){const i=t[0],s=t[1];return e[0]=r[0]*i+r[2]*s,e[1]=r[1]*i+r[3]*s,e}function M(e,t,r){const i=t[0],s=t[1];return e[0]=r[0]*i+r[2]*s+r[4],e[1]=r[1]*i+r[3]*s+r[5],e}function R(e,t,r){const i=t[0],s=t[1];return e[0]=r[0]*i+r[3]*s+r[6],e[1]=r[1]*i+r[4]*s+r[7],e}function O(e,t,r){const i=t[0],s=t[1];return e[0]=r[0]*i+r[4]*s+r[12],e[1]=r[1]*i+r[5]*s+r[13],e}function I(e,t,r,i){const s=t[0]-r[0],n=t[1]-r[1],o=Math.sin(i),a=Math.cos(i);return e[0]=s*a-n*o+r[0],e[1]=s*o+n*a+r[1],e}function F(e,t){const r=e[0],i=e[1],s=t[0],n=t[1];let o=r*r+i*i;o>0&&(o=1/Math.sqrt(o));let a=s*s+n*n;a>0&&(a=1/Math.sqrt(a));const l=(r*s+i*n)*o*a;return l>1?0:l<-1?Math.PI:Math.acos(l)}function A(e){return"vec2("+e[0]+", "+e[1]+")"}function D(e,t){return e[0]===t[0]&&e[1]===t[1]}function E(e,r){const i=e[0],s=e[1],n=r[0],o=r[1],a=t.getEpsilon();return Math.abs(i-n)<=a*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(s-o)<=a*Math.max(1,Math.abs(s),Math.abs(o))}function L(e,t,r,i,s){let n=t[0]-r[0],o=t[1]-r[1];const a=(i[0]*n+i[1]*o)*(s-1);return n=i[0]*a,o=i[1]*a,e[0]=t[0]+n,e[1]=t[1]+o,e}const V=y,U=n,B=o,N=a,k=m,z=g,j=_,G=Object.freeze(Object.defineProperty({__proto__:null,add:s,angle:F,ceil:l,copy:r,cross:S,dist:k,distance:m,div:N,divide:a,dot:x,equals:E,exactEquals:D,floor:c,inverse:v,len:V,length:y,lerp:T,max:d,min:u,mul:B,multiply:o,negate:b,normalize:w,projectAndScale:L,random:C,rotate:I,round:h,scale:p,scaleAndAdd:f,set:i,sqrDist:z,sqrLen:j,squaredDistance:g,squaredLength:_,str:A,sub:U,subtract:n,transformMat2:P,transformMat2d:M,transformMat3:R,transformMat4:O},Symbol.toStringTag,{value:"Module"}));e.add=s,e.angle=F,e.ceil=l,e.copy=r,e.cross=S,e.dist=k,e.distance=m,e.div=N,e.divide=a,e.dot=x,e.equals=E,e.exactEquals=D,e.floor=c,e.inverse=v,e.len=V,e.length=y,e.lerp=T,e.max=d,e.min=u,e.mul=B,e.multiply=o,e.negate=b,e.normalize=w,e.projectAndScale=L,e.random=C,e.rotate=I,e.round=h,e.scale=p,e.scaleAndAdd=f,e.set=i,e.sqrDist=z,e.sqrLen=j,e.squaredDistance=g,e.squaredLength=_,e.str=A,e.sub=U,e.subtract=n,e.transformMat2=P,e.transformMat2d=M,e.transformMat3=R,e.transformMat4=O,e.vec2=G,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/frustum":function(){define(["exports","../../core/ObjectStack","../../core/libs/gl-matrix-2/math/mat4","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","../../chunks/vec42","../../core/libs/gl-matrix-2/factories/vec4f64","./clipRay","./plane","./vectorStacks"],function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(){return[s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create()]}function d(e,t){l.fromPoints(t[4],t[0],t[3],e[0]),l.fromPoints(t[1],t[5],t[6],e[1]),l.fromPoints(t[4],t[5],t[1],e[2]),l.fromPoints(t[3],t[2],t[6],e[3]),l.fromPoints(t[0],t[1],t[2],e[4]),l.fromPoints(t[5],t[4],t[7],e[5])}function h(e,t){for(let r=0;r<p;r++)if(!l.clip(e[r],t))return!1;return!0}const p=6,f=[o.fromValues(-1,-1,-1,1),o.fromValues(1,-1,-1,1),o.fromValues(1,1,-1,1),o.fromValues(-1,1,-1,1),o.fromValues(-1,-1,1,1),o.fromValues(1,-1,1,1),o.fromValues(1,1,1,1),o.fromValues(-1,1,1,1)],m=new t.ObjectStack(a.create),g=u();e.computePlanes=d,e.copy=function(e,t){for(let r=0;r<p;r++)l.copy(e[r],t[r]);return e},e.create=function(e){return e?[l.create(e[0]),l.create(e[1]),l.create(e[2]),l.create(e[3]),l.create(e[4]),l.create(e[5])]:[l.create(),l.create(),l.create(),l.create(),l.create(),l.create()]},e.createPoints=u,e.fromMatrix=function(e,t,s,o=g){const a=r.multiply(c.sm4d.get(),t,e);r.invert(a,a);for(let e=0;e<8;++e){const t=n.transformMat4(c.sv4d.get(),f[e],a);i.set(o[e],t[0]/t[3],t[1]/t[3],t[2]/t[3])}d(s,o)},e.intersectClipRay=function(e,t){for(let r=0;r<p;r++){const i=e[r];if(!l.clipInfinite(i,t))return!1}return!0},e.intersectsLineSegment=function(e,t,r){return h(e,a.fromLineSegmentAndDirection(t,r,m.get()))},e.intersectsPoint=function(e,t){for(let r=0;r<p;r++)if(l.signedDistance(e[r],t)>0)return!1;return!0},e.intersectsRay=function(e,t){return h(e,a.fromRay(t,m.get()))},e.intersectsSphere=function(e,t){for(let r=0;r<p;r++){const i=e[r];if(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+i[3]>=t[3])return!1}return!0},e.numPlanes=p,e.numPoints=8,e.planePointIndices={bottom:[5,1,0,4],near:[0,1,2,3],far:[5,4,7,6],right:[1,5,6,2],left:[4,0,3,7],top:[7,3,2,6]},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/clipRay":function(){define(["exports","../../core/ObjectStack","../../chunks/vec32","./ray"],function(e,t,r,i){"use strict";function s(e){return e?{ray:i.create(e.ray),c0:e.c0,c1:e.c1}:{ray:i.create(),c0:0,c1:Number.MAX_VALUE}}function n(e,t,r,n=s()){return i.copy(e,n.ray),n.c0=t,n.c1=r,n}function o(e,t,i){return r.add(i,e.ray.origin,r.scale(i,e.ray.direction,t))}const a=new t.ObjectStack(()=>s());e.copy=function(e,t=s()){return n(e.ray,e.c0,e.c1,t)},e.create=s,e.fromLineSegmentAndDirection=function(e,t,n=s()){const o=r.length(e.vector);return i.fromValues(e.origin,t,n.ray),n.c0=0,n.c1=o,n},e.fromRay=function(e,t=s()){return i.copy(e,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t},e.fromValues=n,e.getAt=o,e.getEnd=function(e,t){return o(e,e.c1,t)},e.getStart=function(e,t){return o(e,e.c0,t)},e.wrap=function(e,t,r){const i=a.get();return i.ray=e,i.c0=t,i.c1=r,i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/fov":function(){define(["exports"],function(e){"use strict";e.fovd2fovx=function(e,t,r){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+r*r))},e.fovd2fovy=function(e,t,r){return 2*Math.atan(r*Math.tan(.5*e)/Math.sqrt(t*t+r*r))},e.fovx2fovd=function(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/t)},e.fovy2fovd=function(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/r)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/DepthRange":function(){define(["exports"],function(e){"use strict";class t{constructor(e=1/0,t=-1/0){this.near=e,this.far=t}set(e,t){this.near=e,this.far=t}union(e){null!=e&&(this.near=Math.min(this.near,e.near),this.far=Math.max(this.far,e.far))}within(e){return this.near<=e&&e<=this.far}equals(e){return this.near===e.near&&this.far===e.far}static{this.zero=new t(0,0)}static{this.infinite=new t}}e.DepthRange=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Intersector":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/ray","../../webgl/RenderCamera","./HUDIntersectorResult","./IntersectorInterfaces","./IntersectorResult","./verticalOffsetUtils"],function(e,t,r,i,s,n,o,a,l){"use strict";const c=1e-5;function u(e,t){return(t??-Number.MAX_VALUE)-(e??-Number.MAX_VALUE)}class d{constructor(){this.min=new a.IntersectorResult(i.create()),this.max=new a.IntersectorResult(i.create()),this.hud={min:new n.HUDIntersectorResult(i.create()),max:new n.HUDIntersectorResult(i.create()),all:new Array},this.ground=new a.IntersectorResult(i.create()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}}e.Intersector=class{constructor(e){this.options=new o.IntersectorOptions,this._results=new d,this.transform=new l.IntersectorTransform,this.camera=new s,this.tolerance=c,this.verticalOffset=null,this._ray=i.create(),this._rayEnd=r.create(),this._rayBeginTransformed=r.create(),this._rayEndTransformed=r.create(),this.viewingMode=e??1}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,r){this.resetWithRay(i.fromPoints(e,t,this._ray),r)}resetWithRay(e,r){this.camera=r,e!==this._ray&&i.copy(e,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,t.add(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,r,i,s){this.point=t,this.filterPredicate=i,this.tolerance=r??c;const n=l.getVerticalOffsetObject3D(this.verticalOffset);if(e&&e.length>0){const t=s?e=>{s(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const r of e){const e=r.getSpatialQueryAccelerator?.();null!=e?(null!=n?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,n):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):r.objects.forEach(e=>t(e))}}this.sortResults()}intersectObject(e){const r=e.geometries;if(!r)return;const i=e.effectiveTransformation,s=l.getVerticalOffsetObject3D(this.verticalOffset);for(const n of r){if(!n.visible)continue;const{material:r,id:o}=n;if(!r.visible)continue;this.transform.setAndInvalidateLazyTransforms(i,n.transformation),t.transformMat4(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),t.transformMat4(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const a=this.transform.transform;null!=s&&(s.objectTransform=this.transform),r.intersect(n,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(t,r,i,s)=>this.handleObjectIntersection({object:e,geometryId:o,primitiveIndex:i},t,r,a,s))}}handleObjectIntersection(e,t,r,i,s){if(t<0||null!=this.filterPredicate&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;const o=s?this._results.hud:this._results;e=s?new n.HUDTarget(e,s):e;const l=s?i=>i.set(1,e,t,r):s=>s.set(0,e,t,r,i);if((null==o.min.distance||t<o.min.distance)&&l(o.min),0!==this.options.store&&(null==o.max.distance||t>o.max.distance)&&l(o.max),2===this.options.store)if(s){const e=new n.HUDIntersectorResult(this._ray);l(e),this._results.hud.all.push(e)}else{const e=new a.IntersectorResult(this._ray);l(e),this._results.all.push(e)}}sortResults(e=this._results.all){e.sort((e,t)=>e.distance!==t.distance?(e.distance??0)-(t.distance??0):e.drapedLayerOrder!==t.drapedLayerOrder?u(e.drapedLayerOrder,t.drapedLayerOrder):u(e.renderPriority,t.renderPriority))}},e.defaultTolerance=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/HUDIntersectorResult":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec3f64","./IntersectorResult","./ObjectTarget"],function(e,t,r,i){"use strict";class s extends r.IntersectorResult{constructor(){super(...arguments),this.intersector=1}}class n extends i.ObjectTarget{constructor(e,r){super(e.object,e.geometryId,e.primitiveIndex),this.center=t.clone(r)}}e.HUDIntersectorResult=s,e.HUDTarget=n,e.isHUDIntersectorResult=function(e){return r.isValidIntersectorResult(e)&&1===e.intersector&&!!e.target&&"center"in e.target},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/IntersectorResult":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/ray"],function(e,t,r,i,s,n,o,a){"use strict";function l(e){return null!=e?.distance}const c=s.create(),u=o.create();e.IntersectorResult=class{get ray(){return this._ray}get distanceInRenderSpace(){return null==this.distance?null:(i.scale(c,this.ray.direction,this.distance),i.length(c))}withinDistance(e){return!!l(this)&&this.distanceInRenderSpace<=e}getIntersectionPoint(e){return!!l(this)&&(i.scale(c,this.ray.direction,this.distance),i.add(e,this.ray.origin,c),!0)}getTransformedNormal(e){return i.copy(u,this.normal),u[3]=0,n.transformMat4(u,u,this.transformation),i.copy(e,u),i.normalize(e,e)}constructor(e){this.intersector=0,this.normal=s.create(),this.transformation=r.create(),this._ray=a.create(),this.init(e)}init(e){this.distance=this.target=this.drapedLayerOrder=this.renderPriority=null,this.intersector=0,a.copy(e,this._ray)}set(e,n,o,a,l,c,u){this.intersector=e,this.distance=o,i.copy(this.normal,a??s.UNIT_Z),t.copy(this.transformation,l??r.IDENTITY),this.target=n,this.drapedLayerOrder=c,this.renderPriority=u}copy(e){a.copy(e.ray,this._ray),this.intersector=e.intersector,this.distance=e.distance,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.renderPriority=e.renderPriority,i.copy(this.normal,e.normal),t.copy(this.transformation,e.transformation)}},e.isValidIntersectorResult=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/ObjectTarget":function(){define(["exports"],function(e){"use strict";e.ObjectTarget=class{constructor(e,t,r){this.object=e,this.geometryId=t,this.primitiveIndex=r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/IntersectorInterfaces":function(){define(["exports"],function(e){"use strict";e.IntersectorOptions=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerViewUids=[],this.store=2,this.normalRequired=!0,this.excludeLabels=!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/verticalOffsetUtils":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/sphere","../../support/orientedBoundingBox"],function(e,t,r,i,s,n,o,a,l){"use strict";class c{constructor(e,t,r){this._original=e,this._update=t,this._dirty=!0,this._transform=r()}invalidate(){this._dirty=!0}get value(){return this._dirty&&(this._update(this._transform,this._original.value),this._dirty=!1),this._transform}}class u{constructor(e=0){this.offset=e,this.tmpVertex=o.create()}applyToVertex(e,t,r){const i=n.set(g,e,t,r),s=n.add(y,i,this.localOrigin),o=this.offset/n.length(s);return n.scaleAndAdd(this.tmpVertex,i,s,o),this.tmpVertex}applyToAabb(e){const t=_,r=b,i=v;for(let s=0;s<3;++s)t[s]=e[0+s]+this.localOrigin[s],r[s]=e[3+s]+this.localOrigin[s],i[s]=t[s];const s=this.applyToVertex(t[0],t[1],t[2]);for(let t=0;t<3;++t)e[t]=s[t],e[t+3]=s[t];const n=t=>{const r=this.applyToVertex(t[0],t[1],t[2]);for(let t=0;t<3;++t)e[t]=Math.min(e[t],r[t]),e[t+3]=Math.max(e[t+3],r[t])};for(let e=1;e<8;++e){for(let s=0;s<3;++s)i[s]=e&1<<s?r[s]:t[s];n(i)}let o=0;for(let e=0;e<3;++e)t[e]*r[e]<0&&(o|=1<<e);if(0!==o&&7!==o)for(let e=0;e<8;++e)if(0===(o&e)){for(let s=0;s<3;++s)i[s]=o&1<<s?0:e&1<<s?t[s]:r[s];n(i)}for(let t=0;t<3;++t)e[t]-=this.localOrigin[t],e[t+3]-=this.localOrigin[t];return e}}class d{constructor(e=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=o.create(),this._tmpMbs=a.create(),this._tmpObb=new l.Obb,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=n.length(e)}applyToVertex(e,t,r){const i=n.set(g,e,t,r),s=n.set(y,e,t,r+this.componentLocalOriginLength),o=this._totalOffset/n.length(s);return n.scaleAndAdd(this._tmpVertex,i,s,o),this._tmpVertex}applyToAabb(e){const t=this.componentLocalOriginLength,r=e[0],i=e[1],s=e[2]+t,n=e[3],o=e[4],a=e[5]+t,l=Math.abs(r),c=Math.abs(i),u=Math.abs(s),d=Math.abs(n),h=Math.abs(o),p=Math.abs(a),f=.5*(1+Math.sign(r*n))*Math.min(l,d),m=.5*(1+Math.sign(i*o))*Math.min(c,h),g=.5*(1+Math.sign(s*a))*Math.min(u,p),y=Math.max(l,d),_=Math.max(c,h),b=Math.max(u,p),v=Math.sqrt(f*f+m*m+g*g),w=Math.sign(l+r),x=Math.sign(c+i),S=Math.sign(u+s),T=Math.sign(d+n),C=Math.sign(h+o),P=Math.sign(p+a),M=this._totalOffset;if(v<M)return e[0]-=(1-w)*M,e[1]-=(1-x)*M,e[2]-=(1-S)*M,e[3]+=T*M,e[4]+=C*M,e[5]+=P*M,e;const R=M/Math.sqrt(y*y+_*_+b*b),O=M/v,I=O-R,F=-I;return e[0]+=r*(w*F+O),e[1]+=i*(x*F+O),e[2]+=s*(S*F+O),e[3]+=n*(T*I+R),e[4]+=o*(C*I+R),e[5]+=a*(P*I+R),e}applyToMbs(e){const t=n.length(a.getCenter(e)),r=this._totalOffset/t;return n.scaleAndAdd(a.getCenter(this._tmpMbs),a.getCenter(e),a.getCenter(e),r),this._tmpMbs[3]=e[3]+e[3]*this._totalOffset/t,this._tmpMbs}applyToObb(e){return l.computeOffsetObb(e,this._totalOffset,this._totalOffset,1,this._tmpObb),this._tmpObb}}class h{constructor(e=0){this.offset=e,this.sphere=a.create(),this.tmpVertex=o.create()}applyToVertex(e,t,r){const i=this.objectTransform.transform,s=n.set(g,e,t,r),o=n.transformMat4(s,s,i),a=this.offset/n.length(o);n.scaleAndAdd(o,o,o,a);const l=this.objectTransform.inverse;return n.transformMat4(this.tmpVertex,o,l),this.tmpVertex}applyToMinMax(e,t){const r=this.offset/n.length(e);n.scaleAndAdd(e,e,e,r);const i=this.offset/n.length(t);n.scaleAndAdd(t,t,t,i)}applyToAabb(e){const t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;const r=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*r,e[4]+=e[4]*r,e[5]+=e[5]*r,e}applyToBoundingSphere(e){const t=n.length(a.getCenter(e)),r=this.offset/t;return n.scaleAndAdd(a.getCenter(this.sphere),a.getCenter(e),a.getCenter(e),r),this.sphere[3]=e[3]+e[3]*this.offset/t,this.sphere}}const p=new h,f=new d,m=new u,g=o.create(),y=o.create(),_=o.create(),b=o.create(),v=o.create();e.I3SVerticalOffsetGlobalViewingMode=d,e.IntersectorTransform=class{constructor(){this._transform=s.create(),this._transformInverse=new c({value:this._transform},i.invert,s.create),this._transformInverseTranspose=new c(this._transformInverse,i.transpose,s.create),this._transformTranspose=new c({value:this._transform},i.transpose,s.create),this._transformInverseRotation=new c({value:this._transform},t.normalFromMat4Legacy,r.create)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){i.copy(this._transform,e)}multiplyTransform(e){i.multiply(this._transform,this._transform,e)}set(e){i.copy(this._transform,e),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this._invalidateLazyTransforms()}},e.Object3DVerticalOffsetGlobalViewingMode=h,e.TerrainVerticalOffsetGlobalViewingMode=u,e.getVerticalOffsetI3S=function(e){return null!=e?(f.offset=e,f):null},e.getVerticalOffsetObject3D=function(e){return null!=e?(p.offset=e,p):null},e.getVerticalOffsetTerrain=function(e){return null!=e?(m.offset=e,m):null},e.terrainId="terrain",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/orientedBoundingBox":function(){define(["exports","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/quat","../../../core/libs/gl-matrix-2/factories/quatf64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/ellipsoidUtils","../../../geometry/spatialReferenceEllipsoidUtils","../../../geometry/projection/computeTranslationToOriginAndRotation","../../../geometry/projection/projectBuffer","../../../geometry/projection/projectors","../../../geometry/support/plane","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/vectorStacks","./dito","../webgl-engine/lib/Attribute"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b){"use strict";class v{constructor(e=a.ZEROS,t=G,r=n.IDENTITY){this._data=[e[0],e[1],e[2],t[0],t[1],t[2],r[0],r[1],r[2],r[3]]}clone(){const e=new v;return e._data=this._data.slice(),e}invalidate(){this._data[3]=-1}get isValid(){return this._data[3]>=0}static fromData(e){const t=new v;return t._data=e.slice(),t}static fromJSON(e){return new v(e.center,e.halfSize,e.quaternion)}copy(e){this._data=e.data.slice()}get center(){return o.set(y.sv3d.get(),this._data[0],this._data[1],this._data[2])}get centerX(){return this._data[0]}get centerY(){return this._data[1]}get centerZ(){return this._data[2]}getCenter(e){return e[0]=this._data[0],e[1]=this._data[1],e[2]=this._data[2],e}set center(e){this._data[0]=e[0],this._data[1]=e[1],this._data[2]=e[2]}setCenter(e,t,r){this._data[0]=e,this._data[1]=t,this._data[2]=r}get halfSize(){return o.set(y.sv3d.get(),this._data[3],this._data[4],this._data[5])}get halfSizeX(){return this._data[3]}get halfSizeY(){return this._data[4]}get halfSizeZ(){return this._data[5]}getHalfSize(e){return e[0]=this._data[3],e[1]=this._data[4],e[2]=this._data[5],e}set halfSize(e){this._data[3]=e[0],this._data[4]=e[1],this._data[5]=e[2]}get quaternion(){return s.set(y.sq4d.get(),this._data[6],this._data[7],this._data[8],this._data[9])}getQuaternion(e){return e[0]=this._data[6],e[1]=this._data[7],e[2]=this._data[8],e[3]=this._data[9],e}set quaternion(e){this._data[6]=e[0],this._data[7]=e[1],this._data[8]=e[2],this._data[9]=e[3]}get data(){return this._data}getCorners(e){const t=w,r=this._data;t[0]=r[6],t[1]=r[7],t[2]=r[8],t[3]=r[9];for(let i=0;i<8;++i){const s=e[i];s[0]=(1&i?-1:1)*r[3],s[1]=(2&i?-1:1)*r[4],s[2]=(4&i?-1:1)*r[5],o.transformQuat(s,s,t),s[0]+=r[0],s[1]+=r[1],s[2]+=r[2]}}doesIntersectFrustumConservativeApproximation(e){return this.intersectPlane(e[0])<=0&&this.intersectPlane(e[1])<=0&&this.intersectPlane(e[2])<=0&&this.intersectPlane(e[3])<=0&&this.intersectPlane(e[4])<=0&&this.intersectPlane(e[5])<=0}get radius(){const e=this._data[3],t=this._data[4],r=this._data[5];return Math.sqrt(e*e+t*t+r*r)}intersectSphere(e){T[0]=this._data[0]-e[0],T[1]=this._data[1]-e[1],T[2]=this._data[2]-e[2];const t=this.getQuaternion(x);return s.conjugate(w,t),o.transformQuat(T,T,w),o.abs(T,T),C[0]=Math.min(T[0],this._data[3]),C[1]=Math.min(T[1],this._data[4]),C[2]=Math.min(T[2],this._data[5]),o.sqrDist(C,T)<e[3]*e[3]}intersectSphereWithMBS(e,t=this.radius){const r=this._data;T[0]=r[0]-e[0],T[1]=r[1]-e[1],T[2]=r[2]-e[2];const i=e[3],s=i+t;return!(o.sqrLen(T)>s*s)&&(w[0]=-r[6],w[1]=-r[7],w[2]=-r[8],w[3]=r[9],o.transformQuat(T,T,w),o.abs(T,T),C[0]=Math.min(T[0],r[3]),C[1]=Math.min(T[1],r[4]),C[2]=Math.min(T[2],r[5]),o.sqrDist(C,T)<i*i)}intersectPlane(e){const t=e[0]*this._data[0]+e[1]*this._data[1]+e[2]*this._data[2]+e[3],r=this.projectedRadius(m.getNormal(e));return t>r?1:t<-r?-1:0}intersectRay(e,t,r=0){const i=this._data,s=w;s[0]=-i[6],s[1]=-i[7],s[2]=-i[8],s[3]=i[9],T[0]=e[0]-i[0],T[1]=e[1]-i[1],T[2]=e[2]-i[2];const n=o.transformQuat(T,T,w),a=o.transformQuat(C,t,w);let l=-1/0,c=1/0;const u=this.getHalfSize(V);for(let e=0;e<3;e++){const t=n[e],i=a[e],s=u[e]+r;if(Math.abs(i)>1e-6){const e=(s-t)/i,r=(-s-t)/i;l=Math.max(l,Math.min(e,r)),c=Math.min(c,Math.max(e,r))}else if(t>s||t<-s)return!1}return l<=c}projectedArea(e,r,i,n){const a=this.getQuaternion(x);s.conjugate(w,a),T[0]=e[0]-this._data[0],T[1]=e[1]-this._data[1],T[2]=e[2]-this._data[2],o.transformQuat(T,T,w);const c=this.getHalfSize(V),u=T[0]<-c[0]?-1:T[0]>c[0]?1:0,d=T[1]<-c[1]?-1:T[1]>c[1]?1:0,h=T[2]<-c[2]?-1:T[2]>c[2]?1:0,p=Math.abs(u)+Math.abs(d)+Math.abs(h);if(0===p)return 1/0;const f=1===p?4:6,m=6*(u+3*d+9*h+13);t.fromQuat(U,a),t.scale(U,U,c);const g=this.getCenter(E);for(let e=0;e<f;e++){const t=O[m+e];o.set(T,((1&t)<<1)-1,(2&t)-1,((4&t)>>1)-1),o.transformMat3(T,T,U),o.add(P,g,T),P[3]=1,l.transformMat4(P,P,r);const i=1/Math.max(1e-6,P[3]);R[2*e]=P[0]*i,R[2*e+1]=P[1]*i}const y=2*f-2;let _=R[0]*(R[3]-R[y+1])+R[y]*(R[1]-R[y-1]);for(let e=2;e<y;e+=2)_+=R[e]*(R[e+3]-R[e-1]);return Math.abs(_)*i*n*.125}projectedRadius(e){const t=this.getQuaternion(x);return s.conjugate(w,t),o.transformQuat(T,e,w),Math.abs(T[0]*this._data[3])+Math.abs(T[1]*this._data[4])+Math.abs(T[2]*this._data[5])}minimumDistancePlane(e){return e[0]*this._data[0]+e[1]*this._data[1]+e[2]*this._data[2]+e[3]-this.projectedRadius(m.getNormal(e))}maximumDistancePlane(e){return e[0]*this._data[0]+e[1]*this._data[1]+e[2]*this._data[2]+e[3]+this.projectedRadius(m.getNormal(e))}toAaBoundingBox(e){const r=this.getQuaternion(x),i=t.fromQuat(U,r),s=this._data[3]*Math.abs(i[0])+this._data[4]*Math.abs(i[3])+this._data[5]*Math.abs(i[6]),n=this._data[3]*Math.abs(i[1])+this._data[4]*Math.abs(i[4])+this._data[5]*Math.abs(i[7]),o=this._data[3]*Math.abs(i[2])+this._data[4]*Math.abs(i[5])+this._data[5]*Math.abs(i[8]);e[0]=this._data[0]-s,e[1]=this._data[1]-n,e[2]=this._data[2]-o,e[3]=this._data[0]+s,e[4]=this._data[1]+n,e[5]=this._data[2]+o}transform(e,t,r,i=0,n=d.getSphericalPCPF(r),a=d.getSphericalPCPF(t),l=f.getProjector(t,a)){if(r===n)t.isGeographic?function(e,t,r,i,n=d.getSphericalPCPF(r)){const a=u.getReferenceEllipsoid(r),l=1+Math.max(0,i)/(a.radius+e.centerZ);e.getCenter(D),D[2]+=i,p.projectBuffer(D,r,0,D,n,0),t.center=D;const c=e.getQuaternion(x);t.quaternion=c,s.conjugate(w,c),o.set(k,0,0,1),o.transformQuat(k,k,w);const h=e.getHalfSize(V);o.set(k,h[0]*Math.abs(k[0]),h[1]*Math.abs(k[1]),h[2]*Math.abs(k[2])),o.scale(k,k,a.inverseFlattening),o.add(k,h,k),t.halfSize=o.scale(k,k,l)}(this,e,t,i,a):function(e,t,r,i,n=d.getSphericalPCPF(r),a=f.getProjector(r,n)){e.getCorners(N),e.getCenter(D),D[2]+=i,h.computeTranslationToOriginAndRotation(r,D,B,n),t.setCenter(B[12],B[13],B[14]);const l=2*Math.sqrt(1+B[0]+B[5]+B[10]);w[0]=(B[6]-B[9])/l,w[1]=(B[8]-B[2])/l,w[2]=(B[1]-B[4])/l,w[3]=.25*l;const c=e.getQuaternion(x);t.quaternion=s.multiply(w,w,c),s.conjugate(w,w),o.set(z,0,0,0);const u=t.getCenter(L);for(const e of N)e[2]+=i,a(e,0,e,0),o.sub(k,e,u),o.transformQuat(k,k,w),o.abs(k,k),o.max(z,z,k);t.halfSize=z}(this,e,t,i,a,l);else if(t.isWGS84&&(r.isWebMercator||g.isPlateCarree(r)))!function(e,t,r,i,s){t.getCenter(E),E[2]+=s;const n=d.getSphericalPCPF(r);p.projectBuffer(E,e,0,E,n,0),I(n,t,E,r,i)}(t,this,r,e,i);else if(t.isWebMercator&&g.isPlateCarree(r))!function(e,t,r,i,s){t.getCenter(E),E[2]+=s,I(e,t,E,r,i)}(t,this,r,e,i);else{const s=this.getCenter(E);s[2]+=i,p.projectBuffer(s,t,0,s,r,0),e.center=s,this!==e&&(e.quaternion=this.getQuaternion(x),e.halfSize=this.getHalfSize(V))}}}const w=n.create(),x=n.create(),S=n.create(),T=a.create(),C=a.create(),P=c.create();function M(e,t=new v){return _.computeOBB(e,t),t}const R=[.1,.2,.3,.4,.5,.6,.7,.8,.9,1,1.1,1.2],O=(()=>{const e=new Int8Array(162);let t=0;const r=r=>{for(let i=0;i<r.length;i++)e[t+i]=r[i];t+=6};return r([6,2,3,1,5,4]),r([0,2,3,1,5,4]),r([0,2,3,7,5,4]),r([0,1,3,2,6,4]),r([0,1,3,2,0,0]),r([0,1,5,7,3,2]),r([0,1,3,7,6,4]),r([0,1,3,7,6,2]),r([0,1,5,7,6,2]),r([0,1,5,4,6,2]),r([0,1,5,4,0,0]),r([0,1,3,7,5,4]),r([0,2,6,4,0,0]),r([0,0,0,0,0,0]),r([1,3,7,5,0,0]),r([2,3,7,6,4,0]),r([2,3,7,6,0,0]),r([2,3,1,5,7,6]),r([0,1,5,7,6,2]),r([0,1,5,7,6,4]),r([0,1,3,7,6,4]),r([4,5,7,6,2,0]),r([4,5,7,6,0,0]),r([4,5,1,3,7,6]),r([0,2,3,7,5,4]),r([6,2,3,7,5,4]),r([6,2,3,1,5,4]),e})();function I(e,r,i,s,n){const o=r.getQuaternion(x),a=t.fromQuat(U,o),l=r.getHalfSize(V);for(let e=0;e<8;++e){for(let t=0;t<3;++t)D[t]=l[t]*(e&1<<t?-1:1);for(let t=0;t<3;++t){let r=i[t];for(let e=0;e<3;++e)r+=D[e]*a[3*e+t];F[3*e+t]=r}}p.projectBuffer(F,e,0,F,s,0,8),M(A,n)}const F=new Array(24),A=new b.Vertices(F,3),D=a.create(),E=a.create(),L=a.create(),V=a.create(),U=r.create(),B=i.create(),N=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],k=a.create(),z=a.create(),j=a.create(),G=a.freeze(-1,-1,-1);e.Obb=v,e.compute=M,e.computeOffsetObb=function(e,t,r,i,n){const l=e.getQuaternion(x);n.quaternion=l,s.conjugate(w,l);const c=e.getCenter(E),u=e.getHalfSize(V);if(1===i){o.transformQuat(k,c,w),o.abs(z,k),o.min(j,z,u),o.sub(j,z,j);const i=o.length(j);o.add(j,z,u);const s=o.length(j);if(i<r)n.center=c,o.set(k,r,r,r),n.halfSize=o.add(k,u,k);else{const a=s>0?1+t/s:1,l=i>0?1+r/i:1,c=(l+a)/2,d=(l-a)/2;o.scale(j,z,d),n.halfSize=o.scaleAndAdd(j,j,u,c),o.scale(j,z,c),o.scaleAndAdd(j,j,u,d),o.sign(k,k),o.multiply(k,j,k);const h=e.getQuaternion(S);n.center=o.transformQuat(k,k,h)}}else{n.center=o.scaleAndAdd(k,c,a.UNIT_Z,(r+t)/2);const e=o.transformQuat(k,a.UNIT_Z,w);o.abs(e,e),n.halfSize=o.scaleAndAdd(z,u,e,(r-t)/2)}return n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/dito":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/quatf64","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../webgl-engine/lib/Attribute"],function(e,t,r,i,s,n,o){"use strict";const a=1e-6,l=n.create(),c=n.create(),u=n.create(),d=n.create(),h=n.create(),p=n.create(),f=n.create(),m=n.create(),g=n.create(),y=n.create(),_=[0,0,0],b=i.create(),v=n.create(),w=n.create(),x=n.create(),S=n.create(),T=n.create(),C=n.create();function P(e,t,r,i,s,n){if(K(t)<a)return;X(v,r,t),X(w,i,t),X(x,s,t),R(e,t,b),T[1]=b[0],S[1]=b[1],C[1]=S[1]-T[1];const o=[r,i,s],l=[v,w,x];for(let r=0;r<3;++r){R(e,o[r],b),T[0]=b[0],S[0]=b[1],R(e,l[r],b),T[2]=b[0],S[2]=b[1],C[0]=S[0]-T[0],C[2]=S[2]-T[2];const i=W(C);i<n.quality&&(Y(n.b0,o[r]),Y(n.b1,t),Y(n.b2,l[r]),n.quality=i)}}const M=n.create();function R(e,t,r){const{data:i,size:s}=e;r[0]=Number.POSITIVE_INFINITY,r[1]=Number.NEGATIVE_INFINITY;for(let e=0;e<i.length;e+=s){const s=i[e]*t[0]+i[e+1]*t[1]+i[e+2]*t[2];r[0]=Math.min(r[0],s),r[1]=Math.max(r[1],s)}}function O(e,t,i){i.center=e,i.halfSize=s.scale(t,t,.5),i.quaternion=r.IDENTITY}const I=n.create(),F=n.create(),A=n.create(),D=n.create(),E=n.create(),L=n.create();function V(e,t,r){Y(I,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?I[0]=0:Math.abs(t[1])>Math.abs(t[2])?I[1]=0:I[2]=0,K(I)<a&&(I[0]=I[1]=I[2]=1),X(F,t,I),J(F,F),X(A,t,F),J(A,A),U(e,t,F,A,D,E),Q(L,E,D),G(t,F,A,D,E,L,r)}function U(e,t,r,i,s,n){R(e,t,b),s[0]=b[0],n[0]=b[1],R(e,r,b),s[1]=b[0],n[1]=b[1],R(e,i,b),s[2]=b[0],n[2]=b[1]}const B=n.create(),N=n.create(),k=n.create(),z=t.fromValues(1,0,0,0,1,0,0,0,1),j=r.create();function G(e,t,r,i,n,o,a){z[0]=e[0],z[1]=e[1],z[2]=e[2],z[3]=t[0],z[4]=t[1],z[5]=t[2],z[6]=r[0],z[7]=r[1],z[8]=r[2],a.quaternion=function(e,t){const r=t[0]+t[4]+t[8];if(r>0){let i=Math.sqrt(r+1);e[3]=.5*i,i=.5/i,e[0]=(t[5]-t[7])*i,e[1]=(t[6]-t[2])*i,e[2]=(t[1]-t[3])*i}else{let r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);const i=(r+1)%3,s=(r+2)%3;let n=Math.sqrt(t[3*r+r]-t[3*i+i]-t[3*s+s]+1);e[r]=.5*n,n=.5/n,e[3]=(t[3*i+s]-t[3*s+i])*n,e[i]=(t[3*i+r]+t[3*r+i])*n,e[s]=(t[3*s+r]+t[3*r+s])*n}return e}(j,z),$(B,i,n),Z(B,B,.5),Z(N,e,B[0]),Z(k,t,B[1]),$(N,N,k),Z(k,r,B[2]),a.center=s.add(N,N,k),a.halfSize=s.scale(B,o,.5)}class q{constructor(e){this.minVert=new Array(7),this.maxVert=new Array(7),this.buffer=new ArrayBuffer(448);let t=0;this.minProj=new Float64Array(this.buffer,t,7),t+=56,this.maxProj=new Float64Array(this.buffer,t,7),t+=56;for(let e=0;e<7;++e)this.minVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.maxVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.minProj[e]=Number.POSITIVE_INFINITY,this.maxProj[e]=Number.NEGATIVE_INFINITY;const r=new Array(7),i=new Array(7),{data:s,size:n}=e;for(let e=0;e<s.length;e+=n){let t=s[e];t<this.minProj[0]&&(this.minProj[0]=t,r[0]=e),t>this.maxProj[0]&&(this.maxProj[0]=t,i[0]=e),t=s[e+1],t<this.minProj[1]&&(this.minProj[1]=t,r[1]=e),t>this.maxProj[1]&&(this.maxProj[1]=t,i[1]=e),t=s[e+2],t<this.minProj[2]&&(this.minProj[2]=t,r[2]=e),t>this.maxProj[2]&&(this.maxProj[2]=t,i[2]=e),t=s[e]+s[e+1]+s[e+2],t<this.minProj[3]&&(this.minProj[3]=t,r[3]=e),t>this.maxProj[3]&&(this.maxProj[3]=t,i[3]=e),t=s[e]+s[e+1]-s[e+2],t<this.minProj[4]&&(this.minProj[4]=t,r[4]=e),t>this.maxProj[4]&&(this.maxProj[4]=t,i[4]=e),t=s[e]-s[e+1]+s[e+2],t<this.minProj[5]&&(this.minProj[5]=t,r[5]=e),t>this.maxProj[5]&&(this.maxProj[5]=t,i[5]=e),t=s[e]-s[e+1]-s[e+2],t<this.minProj[6]&&(this.minProj[6]=t,r[6]=e),t>this.maxProj[6]&&(this.maxProj[6]=t,i[6]=e)}for(let e=0;e<7;++e){let t=r[e];Y(this.minVert[e],s,t),t=i[e],Y(this.maxVert[e],s,t)}}}class H{constructor(){this.b0=n.fromValues(1,0,0),this.b1=n.fromValues(0,1,0),this.b2=n.fromValues(0,0,1),this.quality=0}}function W(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function $(e,t,r){e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2]}function Q(e,t,r){e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2]}function Z(e,t,r){e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}function Y(e,t,r=0){e[0]=t[r],e[1]=t[r+1],e[2]=t[r+2]}function X(e,t,r){const i=t[0],s=t[1],n=t[2],o=r[0],a=r[1],l=r[2];e[0]=s*l-n*a,e[1]=n*o-i*l,e[2]=i*a-s*o}function J(e,t){const r=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(r>0){const i=1/Math.sqrt(r);e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}}function K(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function ee(e,t){const r=t[0]-e[0],i=t[1]-e[1],s=t[2]-e[2];return r*r+i*i+s*s}function te(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}e.computeOBB=function(e,t){const{data:r,size:i}=e,s=r.length/i;if(s<=0)return;const v=new q(e);$(l,v.minProj,v.maxProj),Z(l,l,.5),Q(c,v.maxProj,v.minProj);const w=W(c),x=new H;x.quality=w,s<14&&(e=new o.Vertices(new Float64Array(v.buffer,112,42),3));const S=n.create(),T=n.create(),C=n.create(),R=n.create(),I=n.create(),F=n.create(),A=n.create();switch(function(e,t,r,i,s,n,o,l,c,u){if(function(e,t,r){let i=ee(e.maxVert[0],e.minVert[0]),s=0;for(let t=1;t<7;++t){const r=ee(e.maxVert[t],e.minVert[t]);r>i&&(i=r,s=t)}Y(t,e.minVert[s]),Y(r,e.maxVert[s])}(e,i,s),ee(i,s)<a)return 1;Q(o,i,s),J(o,o);const d=function(e,t,r,i){const{data:s,size:n}=e;let o=Number.NEGATIVE_INFINITY,a=0;for(let e=0;e<s.length;e+=n){_[0]=s[e]-t[0],_[1]=s[e+1]-t[1],_[2]=s[e+2]-t[2];const i=r[0]*_[0]+r[1]*_[1]+r[2]*_[2],n=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],l=_[0]*_[0]+_[1]*_[1]+_[2]*_[2]-i*i/n;l>o&&(o=l,a=e)}return Y(i,s,a),o}(t,i,o,n);return d<a?2:(Q(l,s,n),J(l,l),Q(c,n,i),J(c,c),X(r,l,o),J(r,r),P(t,r,o,l,c,u),0)}(v,e,A,S,T,C,R,I,F,x)){case 1:return void O(l,c,t);case 2:return void V(e,R,t)}!function(e,t,r,i,s,n,o,l,c){(function(e,t,r,i,s){!function(e,t,r,i,s){const{data:n,size:o}=e;Y(i,n),Y(s,i),r[0]=te(M,t),r[1]=r[0];for(let e=o;e<n.length;e+=o){const o=n[e]*t[0]+n[e+1]*t[1]+n[e+2]*t[2];o<r[0]&&(r[0]=o,Y(i,n,e)),o>r[1]&&(r[1]=o,Y(s,n,e))}}(e,t,b,s,i);const n=te(r,t);b[1]-a<=n&&(i[0]=void 0),b[0]+a>=n&&(s[0]=void 0)})(e,t,r,u,d),void 0!==u[0]&&(Q(h,u,r),J(h,h),Q(p,u,i),J(p,p),Q(f,u,s),J(f,f),X(m,p,n),J(m,m),X(g,f,o),J(g,g),X(y,h,l),J(y,y),P(e,m,n,p,h,c),P(e,g,o,f,p,c),P(e,y,l,h,f,c)),void 0!==d[0]&&(Q(h,d,r),J(h,h),Q(p,d,i),J(p,p),Q(f,d,s),J(f,f),X(m,p,n),J(m,m),X(g,f,o),J(g,g),X(y,h,l),J(y,y),P(e,m,n,p,h,c),P(e,g,o,f,p,c),P(e,y,l,h,f,c))}(e,A,S,T,C,R,I,F,x),U(e,x.b0,x.b1,x.b2,D,E);const L=n.create();Q(L,E,D),x.quality=W(L),x.quality<w?G(x.b0,x.b1,x.b2,D,E,L,t):O(l,c,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Attribute":function(){define(["exports"],function(e){"use strict";class t{constructor(e,t,r=t){this.data=e,this.size=t,this.stride=r}}e.Attribute=class extends t{constructor(e,t,r,i=!1,s=r){super(e,r,s),this.indices=t,this.exclusive=i}},e.Vertices=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/viewingModeUtils":function(){define(["exports","../../../chunks/cameraUtilsPlanar","../../../chunks/cameraUtilsSpherical"],function(e,t,r){"use strict";function i({state:e}){return e.isGlobal?r.cameraUtilsSpherical:t.cameraUtilsPlanar}e.directionToHeadingTilt=function(e,t,r,s,n){return i(e).directionToHeadingTilt(t,r,s,n)},e.viewModeDependentUtil=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/cameraUtilsPlanar":function(){define(["exports","../core/mathUtils","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","../core/libs/gl-matrix-2/factories/vec2f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../geometry/Extent","../geometry/Polygon","../geometry/projection/projectPointToVector","../geometry/projection/projectVectorToVector","../geometry/support/coordsUtils","../geometry/support/polygonExtentClipping","../geometry/support/ray","../views/3d/support/cameraUtilsInternal"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";const m=o.fromValues(0,1,0),g=o.fromValues(0,0,1),y=i.create(),_=o.create(),b=o.create();function v(e,i,s,o=f.createDirectionUp()){const{direction:a,up:l}=o;return r.fromZRotation(y,-t.deg2rad(i)),r.rotateX(y,y,t.deg2rad(s)),n.transformMat4(a,g,y),n.scale(a,a,-1),n.transformMat4(l,m,y),o}function w(e,t,r,i){return f.directionToHeadingTilt(t,r,i,g,m)}function x(e,t,r,i){const s=v(0,r,i),a=o.create();return n.scale(a,s.direction,-t),n.add(a,a,e),{up:s.up,eye:a,heading:r,tilt:i}}function S(e){return t.rad2deg(e)}function T(e){return t.deg2rad(e)}function C(e,t,r,i,s){const n=e.renderSpatialReference,o=e.spatialReference??t.spatialReference;return c.projectPointToVector(t,_,n),c.projectPointToVector(t,b,n),_[0]-=r/2,b[0]+=r/2,_[1]-=i/2,b[1]+=i/2,u.projectVectorToVector(_,n,_,o),u.projectVectorToVector(b,n,b,o),s?(s.xmin=_[0],s.ymin=_[1],s.xmax=b[0],s.ymax=b[1],s.spatialReference=o):s=new a(_[0],_[1],b[0],b[1],o),s}function P(e,t){const r=e.frustum,{renderCoordsHelper:i}=e,o=i.getAltitude(t),a=e.spatialReference,c=e.state.camera.eye,u=[],m=r.planes[5];for(let e=0;e<4;e++){const t=r.lines[e];i.intersectInfiniteManifold(p.wrap(t.origin,t.direction),o,R)||M(R,r,i,t.endpoint,o),f.clampLineSegmentToPlane(R,c,R,m),u.push(s.fromValues(R[0],R[1]))}return function(e,t,r){const i=e.map(e=>(n.set(R,e[0],e[1],0),t.fromRenderCoords(R,R,r),[R[0],R[1]]));return i.length<=2?new l({spatialReference:r}):(i.push(i[0].slice()),d.isClockwise(i)||i.reverse(),new l({rings:[i],spatialReference:r}))}(h.clipPolygonToExtent(u,i.extent),i,a)}function M(e,t,r,i,s){const o=t.lines[11].direction,a=(s-r.getAltitude(i))/o[2];n.scaleAndAdd(e,i,o,a)}const R=o.create(),O=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:w,eyeForCenterWithHeadingTilt:x,eyeTiltToLookAtTilt:T,headingTiltToDirectionUp:v,lookAtTiltToEyeTilt:S,toArea:P,toExtent:C},Symbol.toStringTag,{value:"Module"}));e.cameraUtilsPlanar=O,e.directionToHeadingTilt=w,e.eyeForCenterWithHeadingTilt=x,e.eyeTiltToLookAtTilt=T,e.headingTiltToDirectionUp=v,e.lookAtTiltToEyeTilt=S,e.toArea=P,e.toExtent=C})},"esri/geometry/support/polygonExtentClipping":function(){define(["exports","../../core/libs/gl-matrix-2/math/vec2","../../core/libs/gl-matrix-2/factories/vec2f64"],function(e,t,r){"use strict";function i(e,t,i,o){const a=function(e,t){const r=0===t||2===t?0:1,i=e[t],s=0===t||1===t?1:-1,n=0===r?1:0;return(e,t,o)=>{if(t[r]<i&&o[r]<i)return 1===s?0:1;if(t[r]>i&&o[r]>i)return 1===s?1:0;const a=(o[n]-t[n])/(o[r]-t[r]),l=t[n]+a*(i-t[r]);return e[r]=i,e[n]=l,(t[r]<i?1:-1)*s>0?2:3}}(i,o);if(e.length=0,t.length){1===a(n,t[0],t[0])&&s(e,t[0]);for(let i=0;i<t.length;i++){const o=t[i===t.length-1?0:i+1];switch(a(n,t[i],o)){case 1:s(e,o);break;case 3:s(e,r.clone(n));break;case 2:s(e,r.clone(n)),s(e,o)}}}}function s(e,r){0!==e.length&&t.equals(e.at(-1),r)||e.push(r)}const n=r.create();e.clipPolygonToExtent=function(e,t){const r=[],s=[];return i(r,e,t,0),i(s,r,t,1),i(r,s,t,2),i(s,r,t,3),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/cameraUtilsInternal":function(){define(["exports","../../../core/mathUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/lineSegment","../../../geometry/support/plane"],function(e,t,r,i,s,n){"use strict";const o=i.create(),a=i.create(),l=i.create();e.clampLineSegmentToPlane=function(e,t,i,o){r.subtract(l,i,t),n.intersectLineSegment(o,s.wrap(t,l),e)||e===i||r.copy(e,i)},e.createDirectionUp=function(){return{direction:i.create(),up:i.create()}},e.directionToHeadingTilt=function(e,i,s,n,l){let c=r.normalize(o,e),u=r.dot(c,n);const d=u>0;u=Math.abs(u),u>.99&&(u=Math.abs(r.dot(i,n)),u<.99?(r.copy(c,i),d&&r.scale(c,c,-1)):c=null);let h=0;if(c){r.scale(a,n,r.dot(n,c)),r.subtract(c,c,a);const e=r.dot(c,l)/(r.length(c)*r.length(l));r.cross(a,c,l),h=(r.dot(a,n)>0?1:-1)*t.rad2deg(t.acosClamped(e))}const p=t.rad2deg(t.acosClamped(-r.dot(n,e)/r.length(e)));return s?(s.heading=h,s.tilt=p,s):{heading:h,tilt:p}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/cameraUtilsSpherical":function(){define(["exports","../core/Cyclical","../core/mathUtils","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","./vec42","../core/libs/gl-matrix-2/factories/vec4f64","../core/libs/gl-matrix-2/math/common","../geometry/ellipsoidUtils","../geometry/Extent","../geometry/Polygon","../geometry/SpatialReference","../geometry/support/coordsUtils","../geometry/support/lineSegment","../geometry/support/plane","../geometry/support/ray","./sphere","../geometry/support/webMercatorUtils","../views/3d/state/Frustum","../views/3d/state/NearFarHeuristic","../views/3d/state/utils/viewUtils","../views/3d/support/cameraUtilsInternal","../views/3d/support/earthUtils","../views/3d/support/mathUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C){"use strict";const P=o.fromValues(0,0,1),M=n.normalize(o.create(),o.fromValues(1,1,1)),R=new t.Cyclical(-180,180),O=s.create(),I=o.create(),F=o.create();function A(e,t,s,o=S.createDirectionUp()){n.cross(I,e,P),0===n.dot(I,I)&&n.cross(I,e,M),i.fromRotation(O,-r.deg2rad(t),e),i.rotate(O,O,-r.deg2rad(s),I);const{up:a,direction:l}=o;return n.cross(a,I,e),n.normalize(a,a),n.transformMat4(a,a,O),n.normalize(l,e),n.negate(l,l),n.transformMat4(l,l,O),o}function D(e,t,r,i){const s=I,o=F;return n.normalize(s,e),n.cross(F,s,P),0===n.dot(F,F)&&n.cross(F,s,M),n.cross(o,F,s),S.directionToHeadingTilt(t,r,i,s,o)}function E(e,t,i,s){const a={eye:o.create(),up:null,tilt:s,heading:i},l=I;l[0]=e[0],l[1]=e[2],l[2]=-e[1];const c=t,u=r.deg2rad(i),d=r.deg2rad(s),h=Math.sin(u),p=Math.cos(u),f=Math.sin(d),m=Math.cos(d),g=n.length(l);let y;if(Math.abs(d)<1e-8)y=c+g;else{const e=g/f,t=r.asinClamped(c/e),i=Math.PI-d-t;y=e*Math.sin(i)}const _=m*c,b=c*c*(f*f),v=p*p*b,w=y-_,x=w*w,S=v*(v+x-l[1]*l[1]);if(S<0)return n.scale(a.eye,l,y/g),a.tilt=0,V(a,e);const T=Math.sqrt(S),C=l[1]*w,P=v+x;let M;if(M=p>0?-T+C:T+C,Math.abs(P)<1e-8)return g<1e-8?(a.eye[0]=0,a.eye[1]=0,a.eye[2]=c):n.scale(a.eye,l,y/g),a.tilt=0,L(a.eye),V(a,e);a.eye[1]=M/P;const R=h*h*b,O=f*c,F=p*O*a.eye[1],A=a.eye[1]*a.eye[1],D=1-A,E=Math.sqrt(D),U=v*A+R-2*F*E*w+D*x;return Math.abs(U)<1e-8?(n.scale(a.eye,l,y/g),a.tilt=0,L(a.eye),V(a,e)):(a.eye[0]=(D*(y*l[0]-_*l[0])-O*E*(l[0]*a.eye[1]*p+l[2]*h))/U,a.eye[2]=(D*(y*l[2]-_*l[2])-O*E*(l[2]*a.eye[1]*p-l[0]*h))/U,n.scale(a.eye,a.eye,y),L(a.eye),V(a,e))}function L(e){const t=e[1];e[1]=-e[2],e[2]=t}function V(e,t){const r=A(t,e.heading,e.tilt);return e.up=r.up,e}function U(e,t,i){const s=n.length(t),o=Math.sqrt(i*i+s*s-2*i*s*Math.cos(Math.PI-e)),a=r.asinClamped(i/(o/Math.sin(e)));return r.rad2deg(e-a)}function B(e,t,i){const s=r.deg2rad(e),o=n.length(t);return r.asinClamped(i/(o/Math.sin(s)))+s}function N(e,i,s,n,o){let a,l,c,h;const f=i.latitude,m=u.getReferenceEllipsoid(e.spatialReference).radius,g=i.longitude,y=T.getLonDeltaForDistance(f,s,m)/2;a=g-y,l=g+y;const _=r.deg2rad(f),v=(1+Math.sin(_))/(1-Math.sin(_)),w=(v+1)*Math.tan(n/m/2),x=w*w;function S(e){const r=Math.PI/2;return(e=t.cyclical2PI.normalize(e,-r))>r&&(e=Math.PI-e),e}if(c=1.5*Math.PI-2*Math.atan(.5*(w+Math.sqrt(4*v+x))),h=c+n/m,c=S(c),h=S(h),h<c){const e=h;h=c,c=e}if(c=Math.max(r.rad2deg(c),-90),h=Math.min(r.rad2deg(h),90),l=R.monotonic(a,l),l-a>180){const e=(l-a-180)/2;a+=e,l-=e}const C=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:p.WGS84;return o?(o.xmin=a,o.ymin=c,o.xmax=l,o.ymax=h,o.spatialReference=C):o=new d(a,c,l,h,C),e.spatialReference&&e.spatialReference.isWebMercator&&b.geographicToWebMercator(o,!1,o),o}function k(e,t){const{renderCoordsHelper:i}=e,s=e.state.camera.clone(),l=new v.Frustum(i);s.near=w.minNearDistanceInMeters,l.update(s);const u=i.getAltitude(t),d=e.spatialReference,p=i.referenceEllipsoid.radius,m=s.eye,b=1+n.distance(m,t)/(p+u),T=Math.sqrt(b*b-1),{minCurvature:P,maxCurvature:M,minSamples:R,maxSamples:O}=j,I=function(e){const{renderCoordsHelper:t,state:{camera:r}}=e,{center:i,eye:s}=r,n=Math.abs(t.getAltitude(i)),o=Math.abs(Math.PI/2-x.viewAngle(t,i,s));return _.fromRadius(Q,t.referenceEllipsoid.radius+n),_.cameraFrustumCoverage(Q,o,r.distance,r.fovY)}(e),F=r.clamp((T-P)/(M-P),0,1),A=Math.round(r.lerp(R,O,F)),D=s.aboveGround,E=l.planes[5],L=[],V=g.fromPositionAndNormal(o.ZEROS,G,g.create()),U=g.fromPositionAndNormal(o.ZEROS,q,g.create());a.set(Y,0,0,0,0);const B=e=>{};for(let e=0;e<4;e++){const t=1===e&&!D||3===e&&D?1-I:0,s=1===e&&D||3===e&&!D?I:1,a=l.lines[e],c=l.lines[3===e?0:e+1];for(let l=0;l<A;l++){const d=l/A,h=1===e?1-(1-d)**2:3===e?d**2:d,p=0===l?0:r.lerp(t,s,h),f=n.lerp(W,a.origin,c.origin,p),_=C.slerp(a.direction,c.direction,p,H);i.intersectManifoldClosestSilhouette(y.wrap(f,_),u,$),S.clampLineSegmentToPlane($,m,$,E),L.push(o.clone($)),0!==L.length&&B(n.sqrDist(L.at(-1),$));const b=(g.isPointInside(V,$)?1:0)|(g.isPointInside(U,$)?2:0);Y[b]=1}}L.length>2&&n.sqrDist(L[0],L.at(-1));const N=a.squaredLength(Y)>1?function(e,t){const r=[];for(const i of e)r.push(...z(i,t));return r}(z(L,V),U):[L],k=function(e,t,r){const i=2*c.getEpsilon();return e.map(e=>{const s=[];let n=!1;for(const o of e)t.fromRenderCoords(o,$,r),Math.abs(o[0])<i&&Math.abs(o[1])<i?(s.push([null,$[1]]),s.push([null,$[1]]),n=!0):s.push([$[0],$[1]]);if(n)for(let e=0;e<s.length;e++){const t=s[e];if(null!=t[0])continue;const r=s[e+1],i=s.at(0===e?-1:e-1);t[0]=i[0],e++;const n=s.at(e===s.length-1?0:e+1);r[0]=n[0]}return s.push(s[0]),f.isClockwise(s)||s.reverse(),s})}(N,i,d);return new h({rings:k,spatialReference:d})}function z(e,t){const r=[],i=[],s=c.getEpsilon();for(let a=0;a<e.length;a++){const l=e[a],c=a===e.length-1?e[0]:e[a+1],u=m.fromPoints(l,c,Z),d=g.intersectLineOrRay(t,u.origin,u.vector,0,$);switch(d){case 2:r.push(l);break;case 3:i.push(l);break;case 0:case 1:{const[e,a,c]=0===d?[1,r,i]:[-1,i,r],u=g.getNormal(t),h=n.scaleAndAdd(o.create(),$,u,e*s),p=n.scaleAndAdd(o.create(),$,u,e*-s);a.push(l),a.push(h),c.push(p)}}}const a=[];return r.length&&a.push(r),i.length&&a.push(i),a}const j={minCurvature:r.deg2rad(5),maxCurvature:r.deg2rad(50),minSamples:1,maxSamples:6},G=o.fromValues(1,0,0),q=o.fromValues(0,1,0),H=o.create(),W=o.create(),$=o.create(),Q=_.create(),Z=m.create(),Y=l.create(),X=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:D,eyeForCenterWithHeadingTilt:E,eyeTiltToLookAtTilt:B,headingTiltToDirectionUp:A,lookAtTiltToEyeTilt:U,toArea:k,toExtent:N},Symbol.toStringTag,{value:"Module"}));e.cameraUtilsSpherical=X,e.directionToHeadingTilt=D,e.eyeForCenterWithHeadingTilt=E,e.eyeTiltToLookAtTilt=B,e.headingTiltToDirectionUp=A,e.lookAtTiltToEyeTilt=U,e.toArea=k,e.toExtent=N})},"esri/views/3d/state/Frustum":function(){define(["exports","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/frustum"],function(e,t,r,i){"use strict";class s{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=i.create(),this._points=i.createPoints(),this.lines=new Array(12),this._origin=r.create(),this._direction=r.create(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:r.create(),endpoint:null}}update(e){i.fromMatrix(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),t.copy(this._origin,e.eye),t.copy(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let r=0;r<this._points.length;r++)t.copy(this._points[r],e[r]);i.computePlanes(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return i.intersectsSphere(this.frustum,e)}intersectsRay(e){return i.intersectsRay(this.frustum,e)}intersectsLineSegment(e,t){return i.intersectsLineSegment(this.frustum,e,t)}intersectsPoint(e){return i.intersectsPoint(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const r=t+4;n(this.lines[t],e[t],e[r]),n(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),n(this.lines[t+8],e[r],3===t?e[4]:e[r+1])}}static{this.planePointIndices=i.planePointIndices}static{this.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]]}}function n(e,r,i){e.origin=r,e.endpoint=i,t.direction(e.direction,r,i)}e.Frustum=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/NearFarHeuristic":function(){define(["exports","../../../core/mathUtils","../../../core/unitUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/Extent","../../../geometry/support/ray","../../../chunks/sphere","../environment/atmosphereUtils","../webgl-engine/lib/DepthRange"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";class d{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=n.getReferenceEllipsoid(t),this._unitInMeters=r.getMetersPerUnitForSR(t,this._referenceEllipsoid.metersPerDegree)}compute(e,r,s,n){const{eye:a,center:l}=e;let c=a[2]*this._unitInMeters;const u=c,d=c-n,h=this._elevationProvider?.visibleElevationBounds;h&&(c=d>=0?u-this._unitInMeters*h.min:this._unitInMeters*h.max-u),r??=new o({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0});const f={x:r.xmax-r.xmin,y:r.ymax-r.ymin,z:4*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},m=Math.max(f.x,f.y,f.z);i.subtract(x,l,a),w[0]=x[0]>0?r.xmax:r.xmin,w[1]=x[1]>0?r.ymax:r.ymin,w[2]=x[2]>0?m/2:-m/2,i.subtract(w,w,a),i.normalize(x,x);const y=1.1*i.dot(w,x)*this._unitInMeters,_=Math.sqrt(c*(c+2*this._referenceEllipsoid.radius)),T=Math.max(r.xmax-r.xmin,r.ymax-r.ymin),C=T*b*this._unitInMeters,P=T*v*this._unitInMeters,M=t.clamp((c-P)/(C-P),0,1)**3,R=Math.min(t.lerp(_,y,M),_)*Math.max(Math.log(Math.abs(d)),1);return p(Math.min(R,Math.max(34064e4,m))/this._unitInMeters,g,this._unitInMeters,S)}}class h{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=n.getReferenceEllipsoid(t)}compute(e,r,s,n){const{eye:o}=e,d=i.length(o),h=d-this._referenceEllipsoid.radius,b=this._referenceEllipsoid.radius+Math.min(0,n),v=Math.abs(h-n),P=Math.max(v,Math.abs(h)),M=this._elevationProvider?.visibleElevationBounds.max??0,R=c.computeInnerAltitudeFade(P),O=Math.sqrt(P*(P+2*b)),I=d+this._referenceEllipsoid.radius,F=1.2*t.lerp(O,I,R),A=(Math.log(P)-f)/(m-f);p(F,t.clamp(g-A*(g-y),y,g),1,S);const D=this._referenceEllipsoid.radius+M,E=this._referenceEllipsoid.radius+this._referenceEllipsoid.atmosphereHeight,L=Math.max(D,E),V=d-L;if(R>0&&V>_){const r=i.normalize(w,i.scale(w,e.eye,-1)),n=i.normalize(x,e.viewForward),o=t.acosClamped(i.dot(r,n)),c=.5*e.fovY,d=Math.cos(c);let h=u.DepthRange.infinite.near;if(o<=c)h=V*d;else{const t=i.normalize(w,e.viewUp),r=Math.tan(c),s=i.scale(w,t,r),o=i.normalize(w,i.subtract(w,n,s)),u=a.fromValues(e.eye,o,C),p=l.fromRadius(T,L);if(l.intersectRay(p,u,w)){const t=i.subtract(w,w,e.eye);h=i.length(t)*d}}const p=.99*Math.min(s.near,h);if(p<u.DepthRange.infinite.near&&p>S.near){const e=t.lerp(S.near,p,R);S.near=e}}return S}}function p(e,t,r,i){const s=_/r,n=e/t;return n>s?(i.far=e,i.near=n):(i.near=s,i.far=i.near*t),i}const f=7.983,m=16.994,g=2e4,y=100,_=2,b=.001,v=1e-4,w=s.create(),x=s.create(),S={near:0,far:0},T=l.create(),C=a.create();e.createNearFarHeuristic=function(e,t,r){return 1===e?new h(t,r):new d(t,r)},e.minNearDistanceInMeters=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/atmosphereUtils":function(){define(["exports","../../../core/mathUtils","../../../core/libs/gl-matrix-2/factories/vec3f64"],function(e,t,r){"use strict";const i=1e5,s=r.fromValues(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),n=r.fromValues(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),o=r.fromValues(parseFloat(Number(s[0]+n[0]).toFixed(6)),parseFloat(Number(s[1]+n[1]).toFixed(6)),parseFloat(Number(s[2]+n[2]).toFixed(6)));e.betaCombined=o,e.betaMie=3996e-9,e.betaOzone=n,e.betaRayleigh=s,e.computeInnerAltitudeFade=function(e){return t.clamp((e-i)/9e5,0,1)},e.innerAtmosphereDepth=1e4,e.innerAtmosphereFadeStart=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/utils/viewUtils":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64"],function(e,t,r,i){"use strict";const s=i.create(),n=i.create();e.viewAngle=function(e,i,o){e.worldUpAtPosition(i,s),r.subtract(n,o,i);const a=r.length(n);return 0===a?0:t.acosClamped(r.dot(n,s)/a)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/earthUtils":function(){define(["exports","../../../core/mathUtils","../../../geometry/ellipsoidUtils","../../../geometry/Point"],function(e,t,r,i){"use strict";function s(e,t,r){if(null==t.longitude||null==t.latitude||null==r.longitude||null==r.latitude)throw new Error("Invalid points: no lon/lat");return n(e,t.longitude,t.latitude,r.longitude,r.latitude)}function n(e,r,i,s,n){const o=t.deg2rad(i),a=t.deg2rad(n),l=o-a,c=t.deg2rad(r)-t.deg2rad(s),u=Math.sin(l/2),d=Math.sin(c/2),h=2*t.asinClamped(Math.sqrt(u*u+Math.cos(o)*Math.cos(a)*d*d))*e;return Math.round(1e4*h)/1e4}function o(e,t){let r=e/15;return t||(r=Math.round(r)),r}e.getGreatCircleDistance=n,e.getGreatCircleDistanceFromPoints=s,e.getGreatCircleSpanAt=function(e,t,n){const o=t.spatialReference,a=r.getReferenceEllipsoid(o),l=new i(t.x,e.y,o),c=new i(n.x,e.y,o),u=new i(e.x,t.y,o),d=new i(e.x,n.y,o);return{lon:s(a.radius,l,c),lat:s(a.radius,u,d)}},e.getLonDeltaForDistance=function(e,r,i){const s=r/i,n=t.deg2rad(e),o=Math.sin(s/2),a=Math.cos(n),l=2*t.asinClamped(Math.sqrt(o*o/(a*a)));return t.rad2deg(l)},e.longitudeToTimezone=o,e.positionToTimezoneInfo=function(e,t){const r=e?.[0];if(null==r)return null;t||(t={hours:0,minutes:0,seconds:0}),t.hours=o(r,!0);const i=t.hours%1;t.hours-=i,t.minutes=60*i;const s=t.minutes%1;return t.minutes-=s,t.seconds=Math.round(60*s),t},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/ElevationProvider":function(){define(["exports","../../../layers/graphics/dehydratedFeatureUtils"],function(e,t){"use strict";function r(e){return"array"in e}e.SamplePosition=class{constructor(e,t=null,r=0){this.array=e,this.spatialReference=t,this.offset=r}},e.getElevationAtPoint=function(e,i,s="ground"){if(t.isDehydratedPoint(i))return e.getElevation(i.x,i.y,i.z||0,i.spatialReference,s);if(r(i)){let t=i.offset;return e.getElevation(i.array[t++],i.array[t++],i.array[t]||0,i.spatialReference??e.spatialReference,s)}return e.getElevation(i[0],i[1],i[2]||0,e.spatialReference,s)},e.isSamplePosition=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/dehydratedFeatureUtils":function(){define(["exports"],function(e){"use strict";e.isDehydratedPoint=function(e){return"point"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/spatialReferenceSupport":function(){define(["exports"],function(e){"use strict";e.isSpatialReferenceSupported=function(e,t){return null!=e&&(null==t||(2===t?!e.isGeographic||e.isWGS84||4490===e.wkid:e.isWebMercator||e.isWGS84||4490===e.wkid||104971===e.wkid||104905===e.wkid||104903===e.wkid))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/GroundViewElevationSampler":function(){define(["../../chunks/tslib.es6","../../core/Evented","../../core/Logger","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/SpatialReference","../../geometry/support/aaBoundingRect","../../geometry/support/contains","../../layers/support/ElevationSampler","../3d/terrain/TerrainConst"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";let h=class extends t.EventedAccessor{constructor(e){super(e),this.noDataValue=d.elevationNoDataValue}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get demResolution(){return this.view.basemapTerrain.demResolution}get extent(){const e=this.view.basemapTerrain;if(null==e?.extent||null==e.spatialReference)return null;const t=l.toExtent(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){return this.view.basemapTerrain?.spatialReference??a.WGS84}elevationAt(e,t){if(null==this.extent||!c.extentContainsXYZ(this.extent,e,t)){const i=null!=this.extent?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return r.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return this.view.elevationProvider?.getElevation(e,t,0,this.spatialReference,"ground")??this.noDataValue}queryElevation(e){return u.updateGeometryElevation(e.clone(),this)}};return e.__decorate([i.property({readOnly:!0})],h.prototype,"demResolution",null),e.__decorate([i.property({readOnly:!0})],h.prototype,"extent",null),e.__decorate([i.property({readOnly:!0})],h.prototype,"noDataValue",void 0),e.__decorate([i.property()],h.prototype,"spatialReference",null),e.__decorate([i.property({constructOnly:!0})],h.prototype,"view",void 0),h=e.__decorate([o.subclass("esri.views.support.GroundViewElevationSampler")],h),h})},"esri/layers/support/ElevationSampler":function(){define(["exports","../../core/has","../../core/handleUtils","../../core/Logger","../../core/unitUtils","../../geometry/Point","../../geometry/support/aaBoundingRect","../../geometry/support/webMercatorUtils"],function(e,t,r,i,s,n,o,a){"use strict";const l=()=>i.getLogger("esri.layers.support.ElevationSampler");class c{queryElevation(e){return d(e.clone(),this)}on(){return r.makeHandle()}projectIfRequired(e,t){return h(e,t)}}class u extends c{get spatialReference(){return this.extent.spatialReference}constructor(e,t,r){super(),this.tile=e,this.noDataValue=r;const i=e.tile.extent;this.extent=o.toExtent(i,t.spatialReference),this.extent.zmin=e.zmin,this.extent.zmax=e.zmax,this._aaExtent=i;const n=s.getMetersPerUnitForSR(t.spatialReference),a=t.lodAt(e.tile.level).resolution*n;this.demResolution={min:a,max:a}}contains(e){const t=this.projectIfRequired(e,this.spatialReference);return null!=t&&this.containsAt(t.x,t.y)}containsAt(e,t){return o.containsXY(this._aaExtent,e,t)}elevationAt(e,t){if(!this.containsAt(e,t)){const r=this.extent,i=`${r.xmin}, ${r.ymin}, ${r.xmax}, ${r.ymax}`;return l().warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return this.tile.sample(e,t)??this.noDataValue}}function d(e,t){const r=h(e,t.spatialReference);if(!r)return null;switch(e.type){case"point":!function(e,t,r){e.z=r.elevationAt(t.x,t.y)}(e,r,t);break;case"polyline":!function(e,t,r){p.spatialReference=t.spatialReference;const i=e.hasM&&!e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s],o=t.paths[s];for(let e=0;e<n.length;e++){const t=n[e],s=o[e];p.x=s[0],p.y=s[1],i&&(t[3]=t[2]),t[2]=r.elevationAt(p.x,p.y)}}e.hasZ=!0}(e,r,t);break;case"multipoint":!function(e,t,r){p.spatialReference=t.spatialReference;const i=e.hasM&&!e.hasZ;for(let s=0;s<e.points.length;s++){const n=e.points[s],o=t.points[s];p.x=o[0],p.y=o[1],i&&(n[3]=n[2]),n[2]=r.elevationAt(p.x,p.y)}e.hasZ=!0}(e,r,t)}return e}function h(e,t){if(null==e)return null;const r=e.spatialReference;if(r.equals(t))return e;const i=a.project(e,t);return i||l().error(`Cannot project geometry spatial reference (wkid:${r.wkid}) to elevation sampler spatial reference (wkid:${t.wkid})`),i}const p=new n;e.ElevationSamplerBase=c,e.MultiTileElevationSampler=class extends c{get spatialReference(){return this.extent.spatialReference}constructor(e,t,r){let i;super(),"number"==typeof t?(this.noDataValue=t,i=null):(i=t,this.noDataValue=r),this.samplers=i?e.map(e=>new u(e,i,this.noDataValue)):e;const s=this.samplers[0];if(s){this.extent=s.extent.clone();const{min:e,max:t}=s.demResolution;this.demResolution={min:e,max:t};for(let e=1;e<this.samplers.length;e++){const t=this.samplers[e];this.extent.union(t.extent),this.demResolution.min=Math.min(this.demResolution.min,t.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,t.demResolution.max)}}else this.extent=o.toExtent(o.create(),i.spatialReference),this.demResolution={min:0,max:0}}elevationAt(e,t){let r,i=!1;for(const s of this.samplers)if(s.containsAt(e,t)&&(i=!0,r=s.elevationAt(e,t),r!==s.noDataValue))return r;return null!=r?r:(i||l().warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler`),this.noDataValue)}},e.TileElevationSampler=u,e.updateGeometryElevation=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TerrainConst":function(){define(["exports","../../../core/mathUtils","../../../geometry/support/aaBoundingRect","./TilingScheme"],function(e,t,r,i){"use strict";const s=t.clampFloat32(t.numberMaxFloat32/10),n=r.create();i.TilingScheme.WebMercatorAuxiliarySphere.getExtent(0,0,0,n);const o=r.create([-180,-90,180,90]);e.elevationNoDataValue=s,e.geographicWorldExtent=o,e.maxMemoryLodBias=2.5,e.maxPatchTesselation=512,e.maxRootTiles=64,e.maxTileNeighborLevelDelta=4,e.progressiveLoadingModulo=2,e.tooManyRootTilesAfterChangeError="Cannot extend surface to encompass all layers because it would result in too many root tiles.",e.tooManyRootTilesForLayerError="Surface extent is too large for tile resolution at level 0.",e.webMercatorWorldExtent=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TilingScheme":function(){define(["exports","../../../core/Error","../../../core/has","../../../core/mathUtils","../../../core/unitUtils","../../../geometry/Extent","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/aaBoundingRect","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils","../../../layers/support/LOD","../../../layers/support/TileInfo"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";class p{constructor(e){const t=p.checkUnsupported(e);if(null!=t)throw t;const r=e;this.spatialReference=r.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=c.isGeographic(this.spatialReference),this.origin=[r.origin.x,r.origin.y],this.pixelSize=r.size[0],this.dpi=r.dpi;const i=r.lods.reduce((e,t)=>(t.level<e.minLod.level&&(e.minLod=t),e.max=Math.max(e.max,t.level),e),{minLod:r.lods[0],max:-1/0}),s=i.minLod,n=2**s.level;let o=s.resolution*n,a=s.scale*n;this.levels=new Array(i.max+1);for(let e=0;e<this.levels.length;e++)this.levels[e]={resolution:o,scale:a,tileSize:[o*r.size[0],o*r.size[1]]},o/=2,a/=2}clone(){return new p(this.toTileInfo())}toTileInfo(){return new h({dpi:this.dpi,origin:new o({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((e,t)=>new d({level:t,scale:e.scale,resolution:e.resolution}))})}getExtent(e,t,r,i){const s=this.levels[e],n=s.tileSize[0],o=s.tileSize[1];i[0]=this.origin[0]+r*n,i[2]=this.origin[0]+(r+1)*n,i[3]=this.origin[1]-t*o,i[1]=this.origin[1]-(t+1)*o}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=u.x2lon(e[0]),t[1]=u.y2lat(e[1]),t[2]=u.x2lon(e[2]),t[3]=u.y2lat(e[3])):this._isGCS&&(t[0]=i.deg2rad(e[0]),t[1]=i.deg2rad(e[1]),t[2]=i.deg2rad(e[2]),t[3]=i.deg2rad(e[3]))}getExtentGeometry(e,t,r,i=new n){return this.getExtent(e,t,r,m),i.spatialReference=this.spatialReference,i.xmin=m[0],i.ymin=m[1],i.xmax=m[2],i.ymax=m[3],i.zmin=void 0,i.zmax=void 0,i}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const{resolution:e,scale:r}=this.levels[this.levels.length-1],i=e/2*this.pixelSize;this.levels.push({resolution:e/2,scale:r/2,tileSize:[i,i]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e,t=1/0){if(p.checkUnsupported(e))return!1;const r=new p(e);if(!r.spatialReference.equals(this.spatialReference))return!1;if(r.pixelSize!==this.pixelSize)return!1;const s=Math.min(this.levels.length-1,r.levels.length-1,t),n=this.levels[s].resolution;let o=.5*n;return!(!i.floatEqualAbsolute(r.origin[0],this.origin[0],o)||!i.floatEqualAbsolute(r.origin[1],this.origin[1],o))&&(o=.5*n/2**s/this.pixelSize*12,i.floatEqualAbsolute(n,r.levels[s].resolution,o))}rootTilesInExtent(e,t=null,r=1/0){const i=new Array,s=this.levels[0].tileSize;if(null==e||0===s[0]||0===s[1])return i;p.computeRowColExtent(e,s,this.origin,m);let n=m[1],o=m[3],a=m[0],l=m[2];const c=l-a,u=o-n;if(c*u>r){const e=Math.floor(Math.sqrt(r));u>e&&(n=n+Math.floor(.5*u)-Math.floor(.5*e),o=n+e),c>e&&(a=a+Math.floor(.5*c)-Math.floor(.5*e),l=a+e)}for(let e=n;e<o;e++)for(let t=a;t<l;t++)i.push([0,e,t]);return null!=t&&(t[0]=this.origin[0]+a*s[0],t[1]=this.origin[1]-o*s[1],t[2]=this.origin[0]+l*s[0],t[3]=this.origin[1]-n*s[1]),i}static computeRowColExtent(e,t,r,i){const s=.001*(e[2]-e[0]+(e[3]-e[1]));i[0]=Math.max(0,Math.floor((e[0]+s-r[0])/t[0])),i[2]=Math.max(0,Math.ceil((e[2]-s-r[0])/t[0])),i[1]=Math.max(0,Math.floor((r[1]-e[3]+s)/t[1])),i[3]=Math.max(0,Math.ceil((r[1]-e[1]-s)/t[1]))}static isPowerOfTwo(e){const t=e.lods,r=t[0].resolution*2**t[0].level;return!t.some(e=>!i.floatEqualRelative(e.resolution,r/2**e.level))}static hasGapInLevels(e){const t=e.lods.map(e=>e.level);t.sort((e,t)=>e-t);for(let e=1;e<t.length;e++)if(t[e]!==t[0]+e)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&!(t&t-1)&&t>=128&&t<=512}static hasOriginPerLODs(e){const t=e.origin;return e.lods.some(e=>null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y))}static getMissingTileInfoError(){return new t("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return null==e?f():e.lods.length<1?new t("tilingscheme:generic","Tiling scheme must have at least one level"):p.isPowerOfTwo(e)?p.hasGapInLevels(e)?new t("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):p.tileSizeSupported(e)?p.hasOriginPerLODs(e)?new t("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new t("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new t("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,t){const r=e[2]-e[0],i=e[3]-e[1],n=s.getMetersPerUnitForSR(t),a=1.2*Math.max(r,i),l=a/256,c=l*n*(96/.0254),u=new p(new h({size:[256,256],origin:new o({x:e[0]-.5*(a-r),y:e[3]+.5*(a-i)}),lods:[new d({level:0,resolution:l,scale:c})],spatialReference:t}));return u.ensureMaxLod(20),u}static makeWebMercatorAuxiliarySphere(e){const t=new p(p.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,r=16){const i=256/t,s=new p(new h({size:[t,t],origin:new o({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new d({level:0,resolution:.703125*i,scale:295497598.570834*i})]}));return s.ensureMaxLod(r),s}static{this.WebMercatorAuxiliarySphereTileInfo=new h({size:[256,256],origin:new o({x:-20037508.342787,y:20037508.342787,spatialReference:a.WebMercator}),spatialReference:a.WebMercator,lods:[new d({level:0,resolution:156543.03392800014,scale:591657527.591555})]})}static{this.WebMercatorAuxiliarySphere=p.makeWebMercatorAuxiliarySphere(19)}get test(){}}function f(){return new t("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}const m=l.create();e.TilingScheme=p,e.getMissingTileInfoError=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/LOD":function(){define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";var l;return e.default=class extends r.JSONSupport{static{l=this}constructor(e){super(e),this.cols=null,this.level=0,this.levelValue=null,this.origin=null,this.resolution=0,this.rows=null,this.scale=0}clone(){return new l({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}},t.__decorate([i.property({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.default.prototype,"cols",void 0),t.__decorate([i.property({type:s.Integer,json:{write:!0}})],e.default.prototype,"level",void 0),t.__decorate([i.property({type:String,json:{write:!0}})],e.default.prototype,"levelValue",void 0),t.__decorate([i.property({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.default.prototype,"origin",void 0),t.__decorate([i.property({type:Number,json:{write:!0}})],e.default.prototype,"resolution",void 0),t.__decorate([i.property({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.default.prototype,"rows",void 0),t.__decorate([i.property({type:Number,json:{write:!0}})],e.default.prototype,"scale",void 0),e.default=l=t.__decorate([a.subclass("esri.layers.support.LOD")],e.default),e.default})},"esri/layers/support/TileInfo":function(){define(["exports","../../chunks/tslib.es6","../../core/jsonMap","../../core/JSONSupport","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/aaBoundingRect","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","./LOD","./TileKey"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";var b;const v=new r.JSONMap({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});return e.default=class extends i.JSONSupport{static{b=this}static create(e={}){const{resolutionFactor:t=1,scales:r,size:i=256,spatialReference:n=p.WebMercator,numLODs:o=24}=e;if(!m.isValid(n)){const e=[];if(r)for(let t=0;t<r.length;t++){const i=r[t];e.push(new y({level:t,scale:i,resolution:i}))}else{let t=5e-4;for(let r=o-1;r>=0;r--)e.unshift(new y({level:r,scale:t,resolution:t})),t*=2}return new b({dpi:96,lods:e,origin:new h(0,0,n),size:[i,i],spatialReference:n})}const a=m.getInfo(n),l=e.origin?new h({x:e.origin.x,y:e.origin.y,spatialReference:n}):new h(a?{x:a.origin[0],y:a.origin[1],spatialReference:n}:{x:0,y:0,spatialReference:n}),c=1/(39.37*s.getMetersPerUnitForSR(n)*96),u=[];if(r)for(let e=0;e<r.length;e++){const t=r[e],i=t*c;u.push(new y({level:e,scale:t,resolution:i}))}else{let e=m.isGeographic(n)?512/i*591657527.5917094:256/i*591657527.591555;const r=Math.ceil(o/t);u.push(new y({level:0,scale:e,resolution:e*c}));for(let i=1;i<r;i++){const r=e/2**t,s=r*c;u.push(new y({level:i,scale:r,resolution:s})),e=r}}return new b({dpi:96,lods:u,origin:l,size:[i,i],spatialReference:n})}constructor(e){super(e),this.dpi=96,this.format=null,this.origin=null,this.size=null,this.spatialReference=null}get isWrappable(){const{spatialReference:e,origin:t}=this;if(e&&t){const r=m.getInfo(e);return e.isWrappable&&!!r&&Math.abs(r.origin[0]-t.x)<=r.dx}return!1}readOrigin(e,t){return h.fromJSON({spatialReference:t.spatialReference,...e})}set lods(e){let t=0,r=0;const i=[],s=this._levelToLOD={};e&&(t=-1/0,r=1/0,e.forEach(e=>{i.push(e.scale),t=e.scale>t?e.scale:t,r=e.scale<r?e.scale:r,s[e.level]=e})),this._set("scales",i),this._set("lods",e),this._initializeUpsampleLevels()}readSize(e,t){return[t.cols,t.rows]}writeSize(e,t){t.cols=e[0],t.rows=e[1]}zoomToScale(e){const t=this.scales;if(e<=0)return t[0];if(e>=t.length-1)return t[t.length-1];const r=Math.floor(e),i=r+1;return t[r]/(t[r]/t[i])**(e-r)}scaleToZoom(e){const t=this.scales,r=t.length-1;let i=0;for(;i<r;i++){const r=t[i],s=t[i+1];if(r<=e)return i;if(s===e)return i+1;if(r>e&&s<e)return i+Math.log(r/e)/Math.log(r/s)}return i}tileAt(e,t,r,i){const s=this.lodAt(e);if(!s)return null;let n,o;if("number"==typeof t)n=t,o=r;else if(m.equals(t.spatialReference,this.spatialReference))n=t.x,o=t.y,i=r;else{const e=g.project(t,this.spatialReference);if(null==e)return null;n=e.x,o=e.y,i=r}const a=s.resolution*this.size[0],l=s.resolution*this.size[1];return i||(i=new _.TileKey(null,0,0,0,f.create())),i.level=e,i.row=Math.floor((this.origin.y-o)/l+.001),i.col=Math.floor((n-this.origin.x)/a+.001),this.updateTileInfo(i),i}updateTileInfo(e,t=0){let r=this.lodAt(e.level);if(!r&&1===t){const t=this.lods[this.lods.length-1];t.level<e.level&&(r=t)}if(!r)return;const i=e.level-r.level,s=r.resolution*this.size[0]/2**i,n=r.resolution*this.size[1]/2**i;e.id=`${e.level}/${e.row}/${e.col}`,e.extent||(e.extent=f.create()),e.extent[0]=this.origin.x+e.col*s,e.extent[1]=this.origin.y-(e.row+1)*n,e.extent[2]=e.extent[0]+s,e.extent[3]=e.extent[1]+n}upsampleTile(e){const t=this._upsampleLevels[e.level];return!(!t||-1===t.parentLevel||(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),0))}getTileBounds(e,t){const r=this.lodAt(t.level);if(null==r)return null;const{resolution:i}=r,s=i*this.size[0],n=i*this.size[1];return e[0]=this.origin.x+t.col*s,e[1]=this.origin.y-(t.row+1)*n,e[2]=e[0]+s,e[3]=e[1]+n,e}lodAt(e){return this._levelToLOD?.[e]??null}clone(){return b.fromJSON(this.write({}))}getCompatibleForVTL(e){if(this.size[0]!==this.size[1]||256===this.size[0]&&512===e)return null;const t=(512===this.size[0]&&256===e?-1:0)+(this.spatialReference.isGeographic?1:0);if(this.size[0]===e&&0===t)return this;const r=[],i=this.lods.length-t;for(let e=0;e<i;e++){const i=e+t,{scale:s,resolution:n}=i>=0?this.lods[i]:{scale:2*this.lods[0].scale,resolution:2*this.lods[0].resolution};r.push(new y({level:e,scale:s,resolution:n}))}return new b({size:[e,e],dpi:this.dpi,format:this.format,compressionQuality:this.compressionQuality,origin:this.origin,spatialReference:this.spatialReference,lods:r})}_initializeUpsampleLevels(){const e=this.lods;this._upsampleLevels=[];let t=null;for(let r=0;r<e.length;r++){const i=e[r];this._upsampleLevels[i.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/i.resolution:0},t=i}}},t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"compressionQuality",void 0),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"dpi",void 0),t.__decorate([n.property({type:String,json:{read:v.read,write:v.write,origins:{"web-scene":{read:!1,write:!1}}}})],e.default.prototype,"format",void 0),t.__decorate([n.property({readOnly:!0})],e.default.prototype,"isWrappable",null),t.__decorate([n.property({type:h,json:{write:!0}})],e.default.prototype,"origin",void 0),t.__decorate([c.reader("origin")],e.default.prototype,"readOrigin",null),t.__decorate([n.property({type:[y],value:null,json:{write:!0}})],e.default.prototype,"lods",null),t.__decorate([n.property({readOnly:!0})],e.default.prototype,"scales",void 0),t.__decorate([n.property({cast:e=>Array.isArray(e)?e:"number"==typeof e?[e,e]:[256,256]})],e.default.prototype,"size",void 0),t.__decorate([c.reader("size",["rows","cols"])],e.default.prototype,"readSize",null),t.__decorate([d.writer("size",{cols:{type:o.Integer},rows:{type:o.Integer}})],e.default.prototype,"writeSize",null),t.__decorate([n.property({type:p,json:{write:!0}})],e.default.prototype,"spatialReference",void 0),e.default=b=t.__decorate([u.subclass("esri.layers.support.TileInfo")],e.default),e.default})},"esri/views/PopupView":function(){define(["require","exports","../chunks/tslib.es6","../core/asyncUtils","../core/Error","../core/has","../core/Logger","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./input/InputManager"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";const p=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function f(e){return null!=e&&"open"in e&&"declaredClass"in e}function m(e){return null!=e&&"declaredClass"in e&&"dockOptions"in e}class g{constructor(e){this.layerView=e,this._resolver=a.createResolver(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(e){const{layerView:t,graphics:r,_resolver:i}=this;if(!t)return i.resolve(r),i.promise;let s;return t.fetchPopupFeaturesFromGraphics(r,e).catch(e=>(s=e,null)).then(e=>{e?i.resolve(e):i.reject(s)}),i.promise}}t.PopupView=t=>{const u=t;let y=class extends u{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([l.watch(()=>[this.ui,this.popup],([e,t],r)=>{const i="popup";if(r){const[e,s]=r;e&&f(s)&&(s.view=null,m(s)&&(e.remove(s,i),s!==t&&t&&s.destroy()))}e&&f(t)&&(t.view=this,m(t)&&e.add(t,{key:i,position:"manual",internal:!0}))},l.syncAndInitial),this.on("click",e=>{this.popup&&this.popupEnabled&&("mouse"!==e.pointerType||0===e.button)&&(f(this.popup)?this.popup.viewModel.handleViewClick(e):e.defer(async()=>{await this.setupPopup(),f(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(e)}))},h.ViewEventPriorities.WIDGET)]),l.whenOnce(()=>this.ready&&this.popupEnabled&&!this.updating).then(()=>new Promise((t,r)=>e(["../widgets/Popup"],e=>t(p(e)),r)))}destroy(){this.destroyed||this.closePopup()}async openPopup(e){if(f(this.popup))return this.popup.open(e);try{if(await this.setupPopup(),!this.popup)return void o.getLogger(this).error(new s("view:null-popup","Popup is null and can't be opened"));this.popup.open(e)}catch{}}closePopup(){this._popupSetupTask?.abort(),f(this.popup)&&this.popup.close()}async fetchPopupFeatures(e,t){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(e,t),t)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!f(this.popup))return this._popupSetupTask=i.createTask(async t=>{const{default:r}=await new Promise((t,r)=>e(["../widgets/Popup"],e=>t(p(e)),r));if(a.throwIfAborted(t),!this.popup||f(this.popup))return;const i=this.popup;delete i.open,delete i.close,this.popup=new r(i)}),this._popupSetupTask.promise}async _popupHitsToFeatures({location:e,hits:t},r){const i=[],s=[];let o=!1;const l=a.wrapAbortWithTimeout(r,n("popup-view-fetch-timeout")??5e3),c=e=>{const t=s.at(-1);return t&&t.layerView===e&&!o?t:(e=>{const t=new g(e);return s.push(t),i.push(t.promise),t})(e)};for(const e of t)"graphic"in e?(c(e.layerView).graphics.push(e.graphic),o=!1):(i.push(e.layerView.fetchPopupFeaturesAtLocation(e.mapPoint,l)),o=!0);s.forEach(e=>e.resolve(l));const u=a.allSettledValues(i).then(e=>e.filter(e=>!!e).flat());return{pendingFeatures:i,allGraphicsPromise:u,location:e}}async _getPopupHits(e,t){const{hits:r,location:i}=await this.popupHitTest(e);a.throwIfAborted(t);const s=[];for(const e of r)if("graphic"in e){if(this._isValidPopupGraphic(e.graphic,t)){const t=this._isValidPopupGraphicsLayerView(e.layerView)?e.layerView:void 0;s.push({graphic:e.graphic,layerView:t})}}else this._isValidPopupLocationLayerView(e.layerView)&&s.push({mapPoint:e.mapPoint,layerView:e.layerView});return{hits:s,location:i}}_isValidPopupGraphic(e,t){return e&&!!e.getEffectivePopupTemplate(t?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(e){return!e||(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesFromGraphics"in e}_isValidPopupLocationLayerView(e){return(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesAtLocation"in e}};return r.__decorate([c.property()],y.prototype,"popup",void 0),r.__decorate([c.property()],y.prototype,"popupEnabled",void 0),y=r.__decorate([d.subclass("esri.views.PopupView")],y),y},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/ViewingMode":function(){define(["exports"],function(e){"use strict";e.stringFromViewingMode=function(e){return 1===e?"global":"local"},e.viewingModeFromString=function(e){return"global"===e?1:2},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layerViewModuleImportUtils":function(){define(["require","exports","../../core/Error"],function(e,t,r){"use strict";const i=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),s=()=>new Promise((t,r)=>e(["./layers/TileLayerView3D"],e=>t(i(e)),r)),n=()=>new Promise((t,r)=>e(["./layers/ElevationLayerView3D"],e=>t(i(e)),r)),o={"base-dynamic":()=>new Promise((t,r)=>e(["./layers/BaseDynamicLayerView3D"],e=>t(i(e)),r)),"base-elevation":n,"base-tile":s,"bing-maps":s,"building-scene":()=>new Promise((t,r)=>e(["./layers/BuildingSceneLayerView3D"],e=>t(i(e)),r)),catalog:()=>new Promise((t,r)=>e(["./layers/CatalogLayerView3D"],e=>t(i(e)),r)),"catalog-dynamic-group":()=>new Promise((t,r)=>e(["./layers/CatalogDynamicGroupLayerView3D"],e=>t(i(e)),r)),"catalog-footprint":()=>new Promise((t,r)=>e(["./layers/CatalogFootprintLayerView3D"],e=>t(i(e)),r)),csv:()=>new Promise((t,r)=>e(["./layers/CSVLayerView3D"],e=>t(i(e)),r)),dimension:()=>new Promise((t,r)=>e(["./layers/DimensionLayerView3D"],e=>t(i(e)),r)),elevation:n,feature:()=>new Promise((t,r)=>e(["./layers/FeatureLayerView3D"],e=>t(i(e)),r)),"gaussian-splat":()=>new Promise((t,r)=>e(["./layers/GaussianSplatLayerView3D"],e=>t(i(e)),r)),geojson:()=>new Promise((t,r)=>e(["./layers/GeoJSONLayerView3D"],e=>t(i(e)),r)),graphics:()=>new Promise((t,r)=>e(["./layers/GraphicsLayerView3D"],e=>t(i(e)),r)),group:()=>new Promise((t,r)=>e(["./layers/GroupLayerView3D"],e=>t(i(e)),r)),imagery:()=>new Promise((t,r)=>e(["./layers/ImageryLayerView3D"],e=>t(i(e)),r)),"integrated-mesh":()=>new Promise((t,r)=>e(["./layers/IntegratedMeshLayerView3D"],e=>t(i(e)),r)),"integrated-mesh-3dtiles":()=>new Promise((t,r)=>e(["./layers/IntegratedMesh3DTilesLayerView3D"],e=>t(i(e)),r)),"line-of-sight":()=>new Promise((t,r)=>e(["./layers/LineOfSightLayerView3D"],e=>t(i(e)),r)),"map-image":()=>new Promise((t,r)=>e(["./layers/MapImageLayerView3D"],e=>t(i(e)),r)),media:()=>new Promise((t,r)=>e(["./layers/MediaLayerView3D"],e=>t(i(e)),r)),"ogc-feature":()=>new Promise((t,r)=>e(["./layers/OGCFeatureLayerView3D"],e=>t(i(e)),r)),"open-street-map":s,"oriented-imagery":()=>new Promise((t,r)=>e(["./layers/FeatureLayerView3D"],e=>t(i(e)),r)),"point-cloud":()=>new Promise((t,r)=>e(["./layers/PointCloudLayerView3D"],e=>t(i(e)),r)),viewshed:()=>new Promise((t,r)=>e(["./layers/ViewshedLayerView3D"],e=>t(i(e)),r)),voxel:()=>new Promise((t,r)=>e(["./layers/VoxelLayerView3D"],e=>t(i(e)),r)),route:()=>new Promise((t,r)=>e(["./layers/RouteLayerView3D"],e=>t(i(e)),r)),scene:t=>null==t.profile||"mesh-pyramids"===t.profile?new Promise((t,r)=>e(["./layers/SceneLayerView3D"],e=>t(i(e)),r)):new Promise((t,r)=>e(["./layers/SceneLayerGraphicsView3D"],e=>t(i(e)),r)),stream:()=>new Promise((t,r)=>e(["./layers/StreamLayerView3D"],e=>t(i(e)),r)),tile:s,"imagery-tile":()=>new Promise((t,r)=>e(["./layers/ImageryTileLayerView3D"],e=>t(i(e)),r)),"vector-tile":()=>new Promise((t,r)=>e(["./layers/VectorTileLayerView3D"],e=>t(i(e)),r)),wcs:()=>new Promise((t,r)=>e(["./layers/ImageryTileLayerView3D"],e=>t(i(e)),r)),"web-tile":s,wfs:()=>new Promise((t,r)=>e(["./layers/WFSLayerView3D"],e=>t(i(e)),r)),wms:()=>new Promise((t,r)=>e(["./layers/WMSLayerView3D"],e=>t(i(e)),r)),wmts:()=>new Promise((t,r)=>e(["./layers/WMTSLayerView3D"],e=>t(i(e)),r)),"geo-rss":null,kml:null,"knowledge-graph-sublayer":null,"knowledge-graph":null,"link-chart":null,"map-notes":null,parquet:null,"subtype-group":null,unknown:null,unsupported:null,video:null},a={hasLayerViewModule:e=>null!=o[e.type],importLayerView:e=>{const t=o[e.type];if(null==t)throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new r(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)}};t.layerView3DImporter=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/analysis/AnalysisViewManager3D":function(){define(["require","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/asyncUtils","../../../core/Collection","../../../core/Error","../../../core/handleUtils","../../../core/has","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/scheduling","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const f=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),m="analyses-owner-handles";let g=class extends r{constructor(e){super(e),this._allAnalysisViews=new s,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=y(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"elevation-profile":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null},"volume-measurement":{module:null}},this._emitOnView=(e,t)=>this.view.emit(e,t)}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(u.createAbortError("AnalysisViewManager was destroyed")),this._set("view",null)}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(u.createAbortError()),this._attachedToViewResolver=y()}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(null==t||1===t.state.list)throw new n("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),m)}_disconnectOwners(){this.removeHandles(m),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const t of e)this._addAnalysis(t);const t=e.on("after-add",e=>this._addAnalysis(e.item)),r=e.on("after-remove",e=>this._removeAnalysis(e.item));return o.makeHandle(()=>{t.remove(),r.remove();for(const t of e)this._removeAnalysis(t)})}_addAnalysis(e){const t=this._items.get(e);if(null==t){const t={state:{view:0,list:0},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,t),t.createAnalysisViewTask=i.createTask(r=>this._createAnalysisViewPromise(t,r).then(t=>(this._emitOnView("analysis-view-create",{analysis:e,analysisView:t}),t),t=>{throw this._emitOnView("analysis-view-create-error",{analysis:e,error:t}),t}))}else t.state.list=0}_removeAnalysis(e){const t=this._items.get(e);null!=t?(t.state.list=1,this._scheduleUpdate()):l.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){null==this._scheduledUpdateHandle&&(this._scheduledUpdateHandle=d.schedule(()=>this._update()))}_update(){this._scheduledUpdateHandle=c.removeMaybe(this._scheduledUpdateHandle),this._items.forEach(e=>{if(1!==e.state.list)return;const{analysis:t,view:r}=e;switch(this._items.delete(t),e.state.view){case 0:e.createAnalysisViewTask=c.abortMaybe(e.createAnalysisViewTask);break;case 1:null!=r&&(this._allAnalysisViews.remove(r),e.view=c.destroyMaybe(r),e.createAnalysisViewTask=null,this._emitOnView("analysis-view-destroy",{analysis:t,analysisView:r}))}})}async _createAnalysisViewPromise(e,t){const r=e.analysis,i=r.type,s=this._analysisModules[i];if(this._creatingViewCount+=1,null==s.module)try{s.module=await this._loadAnalysisModule(i)}catch(e){throw this._creatingViewCount-=1,e}if(u.isAborted(t))throw this._creatingViewCount-=1,u.createAbortError("AnalysisView creation aborted");const n=new s.module.default({analysis:r,view:this.view});let o=!0;u.onAbort(t,()=>{o&&this._destroyAnalysisView(r,n)});try{await n.when()}catch(e){throw o=!1,this._destroyAnalysisView(r,n),e}if(u.isAborted(t))throw u.createAbortError();return o=!1,e.view=n,e.state.view=1,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_destroyAnalysisView(e,t){t.destroyed||(this._creatingViewCount-=1,t.destroy(),this._emitOnView("analysis-view-destroy",{analysis:e,analysisView:t}))}_loadAnalysisModule(t){switch(t){case"area-measurement":return new Promise((t,r)=>e(["./AreaMeasurementAnalysisView3D"],e=>t(f(e)),r));case"dimension":return new Promise((t,r)=>e(["./DimensionAnalysisView3D"],e=>t(f(e)),r));case"direct-line-measurement":return new Promise((t,r)=>e(["./DirectLineMeasurementAnalysisView3D"],e=>t(f(e)),r));case"elevation-profile":return new Promise((t,r)=>e(["./ElevationProfileAnalysisView3D"],e=>t(f(e)),r));case"line-of-sight":return new Promise((t,r)=>e(["./LineOfSightAnalysisView3D"],e=>t(f(e)),r));case"slice":return new Promise((t,r)=>e(["./SliceAnalysisView3D"],e=>t(f(e)),r));case"viewshed":return new Promise((t,r)=>e(["./ViewshedAnalysisView3D"],e=>t(f(e)),r));case"volume-measurement":return new Promise((t,r)=>e(["./VolumeMeasurementAnalysisView3D"],e=>t(f(e)),r))}}};function y(){const e=u.createResolver();return e.promise.catch(()=>{}),e}return t.__decorate([h.property()],g.prototype,"updating",null),t.__decorate([h.property({constructOnly:!0})],g.prototype,"view",void 0),t.__decorate([h.property()],g.prototype,"_allAnalysisViews",void 0),t.__decorate([h.property()],g.prototype,"_creatingViewCount",void 0),g=t.__decorate([p.subclass("esri.views.3d.analysis.AnalysisViewManager3D")],g),g})},"esri/views/3d/constraints/Constraints":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Clonable","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./AltitudeConstraint","./ClipDistanceConstraint","./TiltConstraint"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.Constraints=class extends r.Clonable{constructor(e){super(e),this.tilt=new u.TiltConstraint,this.altitude=new l.AltitudeConstraint,this.clipDistance=new c.ClipDistanceConstraint}},t.__decorate([i.property({type:u.TiltConstraint})],e.Constraints.prototype,"tilt",void 0),t.__decorate([i.property({type:l.AltitudeConstraint})],e.Constraints.prototype,"altitude",void 0),t.__decorate([i.property({type:c.ClipDistanceConstraint})],e.Constraints.prototype,"clipDistance",void 0),e.Constraints=t.__decorate([a.subclass("esri.views.3d.constraints.Constraints")],e.Constraints),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/constraints/AltitudeConstraint":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Clonable","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../state/Constraints"],function(e,t,r,i,s,n,o,a,l){"use strict";e.AltitudeConstraint=class extends r.Clonable{constructor(){super(...arguments),this.min=l.earthAltitudeConstraint.min,this.max=l.earthAltitudeConstraint.max}},t.__decorate([i.property({type:Number})],e.AltitudeConstraint.prototype,"min",void 0),t.__decorate([i.property({type:Number})],e.AltitudeConstraint.prototype,"max",void 0),e.AltitudeConstraint=t.__decorate([a.subclass("esri.views.3d.constraints.AltitudeConstraint")],e.AltitudeConstraint),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/Constraints":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Logger","../../../core/mathUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/Ellipsoid","../support/mathUtils"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.Constraints=class extends r{constructor(e){super(e),this.collision=new f,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return 2===this.mode?null:this._get("altitude")||null}set altitude(e){2!==this.mode?this._set("altitude",e):i.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(e){return this.altitude?s.clamp(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const r=this.tilt(e);return s.clamp(t,r.min,r.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return 2===this.mode?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,r=p)=>(r.min=h.min,r.max=e,r)}_createDefaultTiltLocal(){const e=this.collision.enabled?u.makePiecewiseLinearFunction([[4e3,h.max],[1e4,s.deg2rad(88)],[6e6,s.deg2rad(88)]]):()=>h.max;return(t,r=p)=>(r.min=h.min,r.max=e(t),r)}_createDefaultTiltGlobal(){const e=this.collision.enabled?u.makePiecewiseLinearFunction([[4e3,h.max],[5e4,s.deg2rad(88)],[6e6,s.deg2rad(88)],[2e7,h.min]]):u.makePiecewiseLinearFunction([[3e5,h.max],[3e6,s.deg2rad(88)],[6e6,s.deg2rad(88)],[2e7,h.min]]);return(t,r=p)=>(r.min=h.min,r.max=e(t),r)}},t.__decorate([n.property()],e.Constraints.prototype,"altitude",null),t.__decorate([n.property({readOnly:!0})],e.Constraints.prototype,"collision",void 0),t.__decorate([n.property()],e.Constraints.prototype,"distance",void 0),t.__decorate([n.property({readOnly:!0})],e.Constraints.prototype,"minimumPoiDistance",void 0),t.__decorate([n.property()],e.Constraints.prototype,"tilt",void 0),t.__decorate([n.property({constructOnly:!0})],e.Constraints.prototype,"state",void 0),e.Constraints=t.__decorate([l.subclass("esri.views.3d.state.Constraints")],e.Constraints);const d={min:-2e5,max:4*c.earth.radius},h={min:s.deg2rad(.5),max:s.deg2rad(179.5)},p={min:0,max:0};let f=class extends r{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};t.__decorate([n.property({type:Boolean})],f.prototype,"enabled",void 0),t.__decorate([n.property({type:Number})],f.prototype,"elevationMargin",void 0),f=t.__decorate([l.subclass("esri.views.3d.state.Constraints.CollisionConstraint")],f),e.TiltRange=h,e.earthAltitudeConstraint=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/constraints/ClipDistanceConstraint":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Clonable","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/cast","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";e.ClipDistanceConstraint=class extends r.Clonable{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}},t.__decorate([i.property({type:Number,value:1e-8})],e.ClipDistanceConstraint.prototype,"near",null),t.__decorate([s.cast("near")],e.ClipDistanceConstraint.prototype,"castNear",null),t.__decorate([i.property({type:Number,value:1e-8})],e.ClipDistanceConstraint.prototype,"far",null),t.__decorate([s.cast("far")],e.ClipDistanceConstraint.prototype,"castFar",null),t.__decorate([i.property({type:["auto","manual"]})],e.ClipDistanceConstraint.prototype,"mode",void 0),e.ClipDistanceConstraint=t.__decorate([a.subclass("esri.views.3d.constraints.ClipDistanceConstraint")],e.ClipDistanceConstraint),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/constraints/TiltConstraint":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Clonable","../../../core/mathUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/cast","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../state/Constraints"],function(e,t,r,i,s,n,o,a,l,c){"use strict";const u={min:i.rad2deg(c.TiltRange.min),max:i.rad2deg(c.TiltRange.max)};e.TiltConstraint=class extends r.Clonable{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return i.clamp(e,u.min,u.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}},t.__decorate([s.property({type:["auto","manual"]})],e.TiltConstraint.prototype,"mode",void 0),t.__decorate([s.property({type:Number,value:u.max})],e.TiltConstraint.prototype,"max",null),t.__decorate([n.cast("max")],e.TiltConstraint.prototype,"castMax",null),e.TiltConstraint=t.__decorate([l.subclass("esri.views.3d.constraints.TiltConstraint")],e.TiltConstraint),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/EnvironmentManager":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Evented","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/projection/projectPointToVector","../../../geometry/support/planetGCSUtils","../../../geometry/support/spatialReferenceUtils","./EnvironmentRenderer","../support/earthUtils","../support/sunUtils","../webgl-engine/lighting/Lightsources"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v){"use strict";e.EnvironmentManager=class extends r.EventedAccessor{constructor(){super(),this._tmpLightParameters=new b.ColorAndIntensity,this._defaultLightParameters=new b.ColorAndIntensity,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new v.MainLight,this._ambientLight=new v.AmbientLight,this._moonLight=new v.FillLight,this._disableWeather=!1,this._renderer=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!!this._renderer?.updating||!this._canProjectCameraPosition}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&1===this._view?.state?.viewingMode&&g.isEarth(this._view.spatialReference)}get _weatherAvailable(){return this.weatherEnabled&&this._renderer?.weatherAvailable}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){const e=this._view?.stateManager?.camera?.position?.spatialReference??p.WGS84,t=m.getGCSForPlanet(e);return h.isLoadedOrLoadFor(e,t)}connectView(e){if(this._renderer)return;this._renderer=new y.EnvironmentRenderer({view:e});const t=()=>this._updateRenderParameters(),r=()=>this._cameraHandler();this.addHandles([n.watch(()=>e.environment.lighting,e=>this._updateLightingHandler(e),n.sync),n.watch(()=>"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null,e=>this._lightingDateHandler(e),n.sync),n.watch(()=>e.environment.lighting.directShadowsEnabled,t,n.sync),n.watch(()=>e.qualitySettings.ambientOcclusion,t,n.sync),n.watch(()=>e.qualitySettings.reflections,t,n.sync),n.watch(()=>e.spatialReference,()=>this._resetReferencePosition(!0),n.sync),n.watch(()=>[e.environment.weather.type,this.weatherEnabled],()=>this._updateLighting(null,1),n.sync),n.watch(()=>"snowy"===e.environment.weather.type&&e.environment.weather.snowCover,t,n.sync),n.watch(()=>e.environment,e=>e.setComputeWeatherAvailable(()=>this._weatherAvailable),n.syncAndInitial),n.watch(()=>e.viewingMode,()=>this._resetReferencePosition(!0),n.syncAndInitial),n.watch(()=>"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled,e=>this._updateCameraTracking(e),n.syncAndInitial),n.watch(()=>e.state.camera,r,n.syncAndInitial),n.when(()=>this._canProjectCameraPosition,r,n.sync)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=s.destroyMaybe(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"virtual"!==e?.type&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if("virtual"!==t?.type){if(e){if(!t.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(e),null!=this._referencePositionGeographic)){const e=_.positionToTimezoneInfo(this._referencePositionGeographic,this._tmpTz);null!=e&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const r=t.stateManager.camera;if(!r)return;const{position:i}=r,s=i.spatialReference??p.WGS84,n=m.getGCSForPlanet(s);if(!f.projectPointToVector(i,S,n)){if(null==this._referencePositionGeographic)return;return this._referencePositionGeographic=null,void this._updateLighting()}this._referencePositionGeographic?u.equals(this._referencePositionGeographic,S)||(u.copy(this._referencePositionGeographic,S),this.notifyChange("referencePositionGeographic")):this._referencePositionGeographic=d.clone(S),this._autoUpdateTimezone(this._referencePositionGeographic,e)||this._updateLighting(e)}_updateLighting(e,t=0){const r=this._view,{lighting:i}=r.environment,s="virtual"===i.type,n=this._referencePositionGeographic,o=null!=n?this._tmpLightParameters:this._defaultLightParameters;if(n){e??=s?null:i.date;const t=this._weatherAvailable?r.environment.weather.type:"disabled";b.computeColorAndIntensity(e,n,r.state.viewingMode,t,r.state.camera,o)}else s&&b.computeVirtualLightDirection(r.state.camera,r.state.viewingMode,o.direct.directionToLightSource);const a=this._mainLight,l=o.direct;u.scale(a.intensity,l.color,l.intensity*Math.PI),u.copy(a.direction,l.directionToLightSource),a.specularStrength=o.specularStrength,a.environmentStrength=o.environmentStrength;const c=this._ambientLight;u.scale(c.intensity,o.ambient.color,o.ambient.intensity);const d=this._moonLight;u.lerp(d.intensity,w,x,o.globalFactor);const h=(1-.5*o.globalFactor)*(1-.4*o.noonFactor*(1-o.globalFactor));u.scale(d.intensity,d.intensity,h),u.copy(d.direction,l.directionToLightSource),this._view.stage?.renderer.updateLighting([a,c,d],o.noonFactor,o.globalFactor,this._weatherAvailable?t:0),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==e)return!1;const r=this._tmpDate;r.setTime((t||this._view.environment.lighting.date).getTime());const i=_.positionToTimezoneInfo(e,this._tmpTz);if(null==i)return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===i.hours&&s.minutes===i.minutes&&s.seconds===i.seconds)return!1}else s=i;const n=r.getUTCHours()-(i.hours-s.hours),o=r.getUTCMinutes()-(i.minutes-s.minutes),a=r.getUTCSeconds()-(i.seconds-s.seconds);return r.setUTCHours(n),r.setUTCMinutes(o),r.setUTCSeconds(a),!t&&this._view.environment.lighting.autoUpdate(r,i)}_updateRenderParameters(){const e=this._view.stage;if(!e)return;const t=null==this._referencePositionGeographic||b.computeShadowsEnabled(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._weatherAvailable,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._referencePositionGeographic=null,e&&this._cameraHandler()}get test(){}},t.__decorate([o.property({type:Boolean,readOnly:!0})],e.EnvironmentManager.prototype,"updating",null),t.__decorate([o.property()],e.EnvironmentManager.prototype,"_disableWeather",void 0),t.__decorate([o.property()],e.EnvironmentManager.prototype,"weatherEnabled",null),t.__decorate([o.property()],e.EnvironmentManager.prototype,"_weatherAvailable",null),t.__decorate([o.property()],e.EnvironmentManager.prototype,"referencePositionGeographic",null),t.__decorate([o.property()],e.EnvironmentManager.prototype,"_referencePositionGeographic",void 0),t.__decorate([o.property()],e.EnvironmentManager.prototype,"_renderer",void 0),t.__decorate([o.property()],e.EnvironmentManager.prototype,"_canProjectCameraPosition",null),e.EnvironmentManager=t.__decorate([c.subclass("esri.views.3d.environment.EnvironmentManager")],e.EnvironmentManager);const w=d.fromValues(.22,.22,.33),x=d.fromValues(.22,.22,.22),S=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/planetGCSUtils":function(){define(["exports","../SpatialReference","../spatialReferenceEllipsoidUtils","./spatialReferenceUtils"],function(e,t,r,i){"use strict";e.getGCSForPlanet=function(e){return i.equals(e,r.SphericalPCPFMars)||i.isMars(e)?{wkid:104971}:i.equals(e,r.SphericalPCPFMoon)||i.isMoon(e)?{wkid:104903}:t.WGS84},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/EnvironmentRenderer":function(){define(["exports","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/signal","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../geometry/ellipsoidUtils","./CloudsPresets","./CloudsRenderer","./Precipitation","./weather","../webgl-engine/effects/RenderPlugin"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g){"use strict";e.EnvironmentRenderer=class extends g.SyncRenderPlugin{constructor(e){super(e),this.produces=new Map([]),this._clouds=n.signal(null),this._incarnation=0,this._precipitation=null}initialize(){this.view.stage?.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?.stage?.removeRenderPlugin(this),this._set("view",null)}get updating(){return!!this._clouds.value?.readyToRun}get weatherAvailable(){return u.length(this.view.state.camera.eye)-d.getReferenceEllipsoid(this.view.spatialReference).radius<=m.heightLimit}get usedMemory(){return this._clouds.value?.usedMemory??0}_fadeOutPrecipitation(){this._precipitation&&(this._precipitationOutgoing?.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut(()=>{this._precipitationOutgoing=i.destroyMaybe(this._precipitationOutgoing)}),this._precipitation=null,++this._incarnation)}get weather(){return this.view?.environmentManager?.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;const t=this.view,r=()=>this._requestRender();this.addHandles([s.watch(()=>this._precipitation,r,s.sync),s.watch(()=>this._clouds.value?.state,r,s.sync),s.watch(()=>t.state.mode,r,s.sync),s.watch(()=>this._updateClouds(),r,s.sync),s.watch(()=>this._updatePrecipitation(),r,s.sync),s.watch(()=>this.weather,e=>this._initWeather(e))])}uninitializeRenderContext(){this._context=null,this._clouds.value=i.destroyMaybe(this._clouds.value),this._precipitation=i.destroyMaybe(this._precipitation),this._precipitationOutgoing=i.destroyMaybe(this._precipitationOutgoing)}prepareRender(e){const{bind:t,time:r}=e;if("local"!==this.view.viewingMode&&t.clouds.data){t.clouds.fade(t.camera,r,this.view.qualitySettings.fadeDuration);const e=this._clouds.value;e&&0===e.state&&0===e.coverage&&!e.readyToRun&&e.destroyCubeMap()}}acquireTechniques(){return[]}render(){}_requestRender(){this._context?.requestRender()}_initWeather(e){const t=this._context;if(!e||!t)return void(this._clouds.value=i.destroyMaybe(this._clouds.value));if(this._clouds.value)return;const r=this.view;this._clouds.value=new p.CloudsRenderer({context:t,view:r,requestRender:()=>this._requestRender()})}_updateClouds(){const e=this.view.environment.weather;return null==e||null==this._clouds.value||this._clouds.value.applyPreset(h.cloudPresets[e.type],function(e){switch(e.type){case"rainy":case"snowy":case"cloudy":case"sunny":return e.cloudCover;case"foggy":return e.fogStrength}}(e)),++this._incarnation}_updatePrecipitation(){const e=this.view.environment.weather;if(e.type===this._precipitation?.type)return this._incarnation;this._fadeOutPrecipitation();const t="rainy"===e.type||"snowy"===e.type,r=this._context;return t&&r&&(this._precipitation=new f.Precipitation({view:this.view,type:e.type}),++this._incarnation),this._incarnation}get test(){}hasHighlight(){return!1}},t.__decorate([o.property({constructOnly:!0})],e.EnvironmentRenderer.prototype,"view",void 0),t.__decorate([o.property({type:Boolean,readOnly:!0})],e.EnvironmentRenderer.prototype,"updating",null),t.__decorate([o.property()],e.EnvironmentRenderer.prototype,"weatherAvailable",null),t.__decorate([o.property()],e.EnvironmentRenderer.prototype,"_context",void 0),e.EnvironmentRenderer=t.__decorate([c.subclass("esri.views.3d.environment.EnvironmentRenderer")],e.EnvironmentRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/CloudsPresets":function(){define(["exports"],function(e){"use strict";class t{constructor(e,t,r,i,s,n,o,a,l=.5){this.coverage=e,this.density=t,this.absorption=r,this.cloudSize=i,this.detailSize=s,this.smoothness=n,this.cloudHeight=o,this.raymarchingSteps=a,this.median=l}}const r={sunny:new t([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],0),cloudy:new t([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],2,.6),rainy:new t([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],2,.4),snowy:new t([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],1,.65),foggy:new t([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],0)};r.default=r.sunny,e.CloudPreset=t,e.cloudPresets=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/CloudsRenderer":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/compilerUtils","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/signal","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../core/libs/gl-matrix-2/factories/vec3f32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../chunks/Clouds.glsl","./CloudsPresets","./CloudsTechnique","./CloudsTechniqueConfiguration","./NoiseTextureAtlas","../../support/Scheduler","../../support/Yield","../../webgl/enums","../../webgl/FramebufferObject","../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O){"use strict";e.CloudsRenderer=class extends r{constructor(e){super(e),this._state=a.signal(0),this._passParameters=new v.CloudsPassParameters,this._weatherTileCount=128,this._sliceIndex=0,this._tileIndex=0,this._tilesPerSlice=1,this.coverage=s.lerp(w.cloudPresets.default.coverage[0],w.cloudPresets.default.coverage[1],.5),this.density=s.lerp(w.cloudPresets.default.density[0],w.cloudPresets.default.density[1],.5),this.absorption=s.lerp(w.cloudPresets.default.absorption[0],w.cloudPresets.default.absorption[1],.5),this.cloudSize=s.lerp(w.cloudPresets.default.cloudSize[0],w.cloudPresets.default.cloudSize[1],.5),this.detailSize=s.lerp(w.cloudPresets.default.detailSize[0],w.cloudPresets.default.detailSize[1],.5),this.smoothness=s.lerp(w.cloudPresets.default.smoothness[0],w.cloudPresets.default.smoothness[1],.5),this.cloudHeight=s.lerp(w.cloudPresets.default.cloudHeight[0],w.cloudPresets.default.cloudHeight[1],.5),this.raymarchingSteps=w.cloudPresets.default.raymarchingSteps,this._viewMatrix=f.create(),this._dirty=!0,this.readyToRun=!0,this._configuration=new S.CloudsTechniqueConfiguration}initialize(){const e=b.getReferenceEllipsoid(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius;const t=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(C.TaskPriority.CLOUDS_GENERATOR,this),o.watch(()=>this.coverage,t,o.initial),o.watch(()=>this.density,t,o.initial),o.watch(()=>this.absorption,t,o.initial),o.watch(()=>this.cloudSize,t,o.initial),o.watch(()=>this.detailSize,t,o.initial),o.watch(()=>this.smoothness,t,o.initial),o.watch(()=>this.cloudHeight,t,o.initial),o.watch(()=>this.raymarchingSteps,t,o.initial)]);const r=g.clone(this._computeWeatherTile());let i=0;this.addHandles(o.watch(()=>{const e=this._computeWeatherTile();return m.equals(r,e)||(++i,m.copy(r,e)),i},t))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=n.destroyMaybe(this._passParameters.noiseTexture)}_precompile(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=0,this.context.techniques.precompile(x.CloudsTechnique,this._configuration),this._configuration.writeTextureChannels=1,this.context.techniques.precompile(x.CloudsTechnique,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case 0:this._tilesPerSlice=1;break;case 1:this._tilesPerSlice=4;break;case 3:case 2:this._tilesPerSlice=8;break;default:i.neverReached(this.raymarchingSteps)}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.get(x.CloudsTechnique,this._configuration)}_computeWeatherTile(){const{camera:e,environment:t}=this.view,{latitude:r,longitude:i}=e.position;if(null==r||null==i)return g.ZEROS;m.set(D,(r+90)/180,(i+180)/360);const s=Math.floor(this._weatherTileCount*Math.abs(2*D[0]-1));D[0]=Math.floor(2*this._weatherTileCount*D[0]),D[1]=Math.floor(4*(this._weatherTileCount-s)*D[1]);let n=0,o=0;if("virtual"!==t?.lighting?.type&&null!=t?.lighting?.date){const e=new Date(t.lighting.date);e.setUTCHours(t.lighting.date.getUTCHours()+(t.lighting.displayUTCOffset??0)),n=31*e.getUTCMonth()+e.getUTCDate(),o=e.getUTCFullYear()}return D[0]=(D[0]+n)%(2*this._weatherTileCount),D[1]=(D[1]+o%100)%(4*this._weatherTileCount),D}get state(){return this._state.value}set state(e){this._state.value=e}get usedMemory(){return(this._fbo?.usedMemory??0)+(this._passParameters.noiseTexture?.textureAtlas?.usedMemory??0)}_ensureNoiseTexture(){return this._passParameters.noiseTexture??=new T.NoiseTextureAtlas({context:this.context}),this._passParameters.noiseTexture}_ensureFrameBufferCube(e){const t=this.context.renderContext.rctx;if(null==this._fbo){const r=new O.TextureDescriptor(e,e/2);r.target=35866,r.depth=6,r.wrapMode=33071,this._fbo=new R.FramebufferObject(t,r),this.parameters.data=this,this.parameters.absorption=this.absorption,this.parameters.coverage=this.coverage}return t.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=n.disposeMaybe(this._fbo),this.parameters.data=null}applyPreset(e,t){const r=e.median,i=e=>{const i=s.lerp(e[0],e[1],r);return t<.5?s.lerp(e[0],i,2*t):s.lerp(i,e[1],2*(t-.5))};this.coverage=i(e.coverage),this.density=i(e.density),this.absorption=i(e.absorption),this.cloudSize=i(e.cloudSize),this.detailSize=i(e.detailSize),this.smoothness=i(e.smoothness),this.cloudHeight=i(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps,this._precompile()}setDirty(){this._dirty=this.readyToRun=!0}runTask(e){if(3===this.state)return P.Yield;this._dirty&&(this._sliceIndex=this._tileIndex=0,this.state=1,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);const t=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!t.compiled)return P.Yield;const r=I[this._sliceIndex],i=F[this._sliceIndex];p.targetTo(this._viewMatrix,A,r,i),h.fromMat4(this._passParameters.viewMatrix,this._viewMatrix);const s=this.context.renderContext.rctx,n=s.getViewport(),o=v.cubeMapSize/this._tilesPerSlice,a=this._tileIndex*o;s.setViewport(0,a,v.cubeMapSize,o);const l=this._ensureFrameBufferCube(v.cubeMapSize);return s.bindFramebuffer(l),this._passParameters.lastSlice=5===this._sliceIndex,s.bindTechnique(t,this.context.renderContext.bind,this._passParameters),l.setColorTextureTarget(35866,M.ColorAttachment0,this._sliceIndex),s.screen.draw(),s.gl.flush(),s.setViewport(n.x,n.y,n.width,n.height),this.requestRender(),++this._tileIndex,5===this._sliceIndex&&this._tileIndex===this._tilesPerSlice?(this._sliceIndex=this._tileIndex=0,this.state=2,this.readyToRun=!1):this._tileIndex===this._tilesPerSlice&&(++this._sliceIndex,this._tileIndex=0),e.madeProgress(),P.Yield}},t.__decorate([l.property({constructOnly:!0})],e.CloudsRenderer.prototype,"context",void 0),t.__decorate([l.property({constructOnly:!0})],e.CloudsRenderer.prototype,"view",void 0),t.__decorate([l.property({constructOnly:!0})],e.CloudsRenderer.prototype,"requestRender",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"coverage",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"density",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"absorption",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"cloudSize",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"detailSize",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"smoothness",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"cloudHeight",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"raymarchingSteps",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"readyToRun",void 0),e.CloudsRenderer=t.__decorate([d.subclass("esri.views.3d.environment.CloudsRenderer")],e.CloudsRenderer);const I=[y.fromValues(1,0,0),y.fromValues(-1,0,0),y.fromValues(0,1,0),y.fromValues(0,-1,0),y.fromValues(0,0,1),y.fromValues(0,0,1)],F=[y.fromValues(0,0,-1),y.fromValues(0,0,-1),y.fromValues(0,0,-1),y.fromValues(0,0,-1),y.fromValues(0,1,0),y.fromValues(0,1,0)],A=_.zeros(),D=g.zeros();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/libs/gl-matrix-2/factories/vec3f32":function(){define(["exports"],function(e){"use strict";function t(){return new Float32Array(3)}function r(e){const t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function i(e,t,r){const i=new Float32Array(3);return i[0]=e,i[1]=t,i[2]=r,i}function s(){return t()}function n(){return i(1,1,1)}function o(){return i(1,0,0)}function a(){return i(0,1,0)}function l(){return i(0,0,1)}const c=s(),u=n(),d=o(),h=a(),p=l(),f=Object.freeze(Object.defineProperty({__proto__:null,ONES:u,UNIT_X:d,UNIT_Y:h,UNIT_Z:p,ZEROS:c,clone:r,create:t,fromValues:i,ones:n,unitX:o,unitY:a,unitZ:l,zeros:s},Symbol.toStringTag,{value:"Module"}));e.ONES=u,e.UNIT_X=d,e.UNIT_Y=h,e.UNIT_Z=p,e.ZEROS=c,e.clone=r,e.create=t,e.fromValues=i,e.ones=n,e.unitX=o,e.unitY=a,e.unitZ=l,e.vec3f32=f,e.zeros=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/Clouds.glsl":function(){define(["exports","../core/has","../core/mathUtils","../core/libs/gl-matrix-2/factories/mat3f64","../core/libs/gl-matrix-2/math/vec2","../core/libs/gl-matrix-2/factories/vec2f64","../views/3d/environment/NoiseTextureAtlasDimensions","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/BooleanPassUniform","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix3PassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/shaders/SphereIntersect.glsl","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g){"use strict";class y extends m.NoParameters{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.lastSlice=!1,this.viewMatrix=i.create()}}const _=t("esri-mobile")?1024:2048;function b(e){const t=new g.ShaderBuilder;t.include(a.ScreenSpacePass,!1);const i=t.fragment;return i.include(f.SphereIntersect),i.uniforms.add(new u.FloatPassUniform("cloudRadius",e=>e.cloudRadius),new u.FloatPassUniform("power",e=>r.lerp(35,120,e.absorption)),new u.FloatPassUniform("sigmaE",e=>1+e.absorption),new u.FloatPassUniform("density",e=>r.lerp(0,.3,e.density)),new u.FloatPassUniform("cloudSize",e=>r.lerp(0,.02,Math.max(.01,1-e.cloudSize))),new u.FloatPassUniform("detailSize",e=>r.lerp(0,.2,Math.max(.01,1-e.detailSize))),new u.FloatPassUniform("smoothness",e=>r.lerp(0,.5,1-e.smoothness)),new u.FloatPassUniform("cloudHeight",e=>r.lerp(0,1500,e.cloudHeight)),new u.FloatPassUniform("coverage",e=>e.coverage),new h.Matrix3PassUniform("view",e=>e.viewMatrix),new p.Texture2DPassUniform("cloudShapeTexture",e=>null!=e.noiseTexture?e.noiseTexture.textureAtlas:null),new c.Float2PassUniform("cloudVariables",e=>s.set(v,e.coverage,e.absorption)),new l.BooleanPassUniform("lastSlice",e=>e.lastSlice)),i.constants.add("halfCubeMapSize","float",.5*_),i.code.add(d.glsl`
    const int STEPS = ${0===e.steps?d.glsl`16`:1===e.steps?d.glsl`100`:d.glsl`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord;
      xy.x -= halfCubeMapSize;
      xy.y = lastSlice ? fragCoord.y - halfCubeMapSize : fragCoord.y;

      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),i.code.add(d.glsl`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${d.glsl.float(o.atlasSize)};
      const float dataWidth = ${d.glsl.float(o.atlasSize)};
      const float tileRows = ${d.glsl.float(o.tileRows)};
      const vec3 atlasDimensions = vec3(${d.glsl.float(o.tileSize)}, ${d.glsl.float(o.tileSize)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${d.glsl.float(o.textureScale)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${d.glsl.float(o.weatherMapScale)} * p) / ${d.glsl.float(o.atlasSize)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),i.code.add(d.glsl`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),i.code.add(d.glsl`float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}
float multipleOctaves(float extinction, float mu, float stepL) {
float attenuation = 1.0;
float contribution = 1.0;
float phaseAttenuation = 1.0;
float luminance = 0.0;
for (int i = 0; i < 4; i++) {
float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
attenuation *= 0.2;
contribution *= 0.6;
phaseAttenuation *= 0.5;
}
return luminance;
}`),i.code.add(d.glsl`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),i.code.add(d.glsl`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),i.main.add(d.glsl`if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
float cloudDistance = cloudRadius + cloudStart;
float rayStartDistance = dot(viewPos, viewPos) - (cloudDistance * cloudDistance);
vec2 rayStartIntersect = sphereIntersect(viewPos, rayDir, rayStartDistance);
float rayEndDistance = dot(viewPos, viewPos) - ((cloudDistance + cloudHeight) * (cloudDistance + cloudHeight));
vec2 rayEndIntersect = sphereIntersect(viewPos, rayDir, rayEndDistance);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);`),t}const v=n.create(),w=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:y,build:b,cubeMapSize:_},Symbol.toStringTag,{value:"Module"}));e.Clouds=w,e.CloudsPassParameters=y,e.build=b,e.cubeMapSize=_})},"esri/views/3d/environment/NoiseTextureAtlasDimensions":function(){define(["exports","../../../core/has"],function(e,t){"use strict";const r=t("esri-mobile")?64:128,i=r/128,s=Math.ceil(Math.sqrt(r)),n=(r+2)*s,o=n/1560;e.atlasSize=n,e.textureScale=i,e.tileRows=s,e.tileSize=r,e.weatherMapScale=o,e.weatherMapSize=1e5,e.weatherTileSize=128,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl":function(){define(["exports","../shaderModules/glsl"],function(e,t){"use strict";e.ScreenSpacePass=function(e,r=!0){e.attributes.add("position","vec2"),r&&e.varyings.add("uv","vec2"),e.vertex.main.add(t.glsl`
      gl_Position = vec4(position, 0.0, 1.0);
      ${r?t.glsl`uv = position * 0.5 + vec2(0.5);`:""}
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/glsl":function(){define(["exports"],function(e){"use strict";const t=(e,...t)=>{let r="";for(let i=0;i<t.length;i++)r+=e[i]+t[i];return r+=e[e.length-1],r};t.int=e=>Math.round(e).toString(),t.float=e=>e.toPrecision(8),e.If=function(e,t,r=""){return e?t:r},e.glsl=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/BooleanPassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"bool",1,(r,i,s)=>r.setUniform1b(e,t(i,s)))}}e.BooleanPassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/Uniform":function(){define(["exports","../../core/has"],function(e,t){"use strict";e.Uniform=class{constructor(e,t,r,i,s=null){if(this.name=e,this.type=t,this.arraySize=s,this.bind={0:null,1:null,2:null},i)switch(r){case void 0:break;case 0:this.bind[0]=i;break;case 1:this.bind[1]=i;break;case 2:this.bind[2]=i}}equals(e){return this.type===e.type&&this.name===e.name&&this.arraySize===e.arraySize}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Float2PassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"vec2",1,(i,s,n)=>i.setUniform2fv(e,t(s,n),r))}}e.Float2PassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/FloatPassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"float",1,(i,s,n)=>i.setUniform1f(e,t(s,n),r))}}e.FloatPassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Matrix3PassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"mat3",1,(i,s,n)=>i.setUniformMatrix3fv(e,t(s,n),r))}}e.Matrix3PassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"sampler2D",1,(r,i,s)=>r.bindTexture(e,t(i,s)))}}e.Texture2DPassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/SphereIntersect.glsl":function(){define(["exports","../core/shaderModules/glsl"],function(e,t){"use strict";e.SphereIntersect=function(e){e.code.add(t.glsl`vec2 sphereIntersect(vec3 start, vec3 dir, float distance) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * distance;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/NoParameters":function(){define(["exports"],function(e){"use strict";const t=class{},r=new t;e.NoParameters=t,e.noParameters=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/ShaderBuilder":function(){define(["exports","../../core/Error","../../core/has","../../core/Logger"],function(e,t,r,i){"use strict";const s=()=>i.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class n{constructor(){this._includedModules=new Map}include(e,t){this._includedModules.has(e)?this._includedModules.get(e):(this._includedModules.set(e,t),e(this.builder,t))}}class o{constructor(e){this._stage=e,this._entries=new Map}add(...e){for(const t of e)this._add(t);return this._stage}get(e){return this._entries.get(e)}_add(e){if(null!=e){if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new t("shaderbuilder:duplicate-uniform",`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}else s().error(`Trying to add null Uniform from ${(new Error).stack}.`)}generateSource(){return Array.from(this._entries.values()).map(({name:e,arraySize:t,type:r})=>null!=t?`uniform ${r} ${e}[${t}];`:`uniform ${r} ${e};`)}get entries(){return Array.from(this._entries.values())}}class a{constructor(e){this._stage=e,this._bodies=new Array}add(e){return this._bodies.push(e),this._stage}generateSource(e){if(this._bodies.length>0)return[`void main() {\n ${this._bodies.join("\n")||""} \n}`];if(e)throw new t("shaderbuilder:missing-main","Shader does not contain main function body.");return[]}}class l{constructor(e){this._stage=e,this._entries=new Array}add(e){return this._entries.push(e),this._stage}generateSource(){return this._entries}}class c extends n{constructor(){super(...arguments),this.uniforms=new o(this),this.main=new a(this),this.code=new l(this),this.constants=new f(this)}get builder(){return this}}class u{constructor(){this._entries=new Array}add(e,t){this._entries.push([e,t])}generateSource(e){return"fragment"===e?[]:this._entries.map(e=>`in ${e[1]} ${e[0]};`)}get names(){return this._entries.map(([e])=>e)}}class d{constructor(){this._entries=new Map}add(e,t,r){this._entries.has(e)?s().warn(`Ignoring duplicate varying ${t} ${e}`):this._entries.set(e,{type:t,invariant:r?.invariant??!1,flat:r?.flat??!1})}generateSource(e){const t=new Array;return this._entries.forEach((r,i)=>t.push((r.invariant&&"vertex"===e?"invariant ":"")+(r.flat||"int"===r.type?"flat ":"")+("vertex"===e?"out":"in")+` ${r.type} ${i};`)),t}}class h{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const t="vertex"===e?h.ALLOWLIST_VERTEX:h.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(e=>t.includes(e)).map(e=>`#extension ${e} : enable`)}static{this.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"]}static{this.ALLOWLIST_VERTEX=[]}}class p{constructor(){this._entries=new Map}add(e,t,r=0){const i=this._entries.get(r);i?.name!==e||i?.type!==t?this._entries.set(r,{name:e,type:t}):s().warn(`Fragment shader output location ${r} occupied`)}static{this.DEFAULT_TYPE="vec4"}static{this.DEFAULT_NAME="fragColor"}generateSource(e){if("vertex"===e)return[];0===this._entries.size&&this._entries.set(0,{name:p.DEFAULT_NAME,type:p.DEFAULT_TYPE});const t=new Array;return this._entries.forEach((e,r)=>t.push(`layout(location = ${r}) out ${e.type} ${e.name};`)),t}}class f{constructor(e){this._stage=e,this._entries=new Set}add(e,t,r){let i="ERROR_CONSTRUCTOR_STRING";switch(t){case"float":i=f._numberToFloatStr(r);break;case"int":i=f._numberToIntStr(r);break;case"bool":i=r.toString();break;case"vec2":i=`vec2(${f._numberToFloatStr(r[0])},                            ${f._numberToFloatStr(r[1])})`;break;case"vec3":i=`vec3(${f._numberToFloatStr(r[0])},                            ${f._numberToFloatStr(r[1])},                            ${f._numberToFloatStr(r[2])})`;break;case"vec4":i=`vec4(${f._numberToFloatStr(r[0])},                            ${f._numberToFloatStr(r[1])},                            ${f._numberToFloatStr(r[2])},                            ${f._numberToFloatStr(r[3])})`;break;case"ivec2":i=`ivec2(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])})`;break;case"ivec3":i=`ivec3(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])},                             ${f._numberToIntStr(r[2])})`;break;case"ivec4":i=`ivec4(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])},                             ${f._numberToIntStr(r[2])},                             ${f._numberToIntStr(r[3])})`;break;case"uvec2":i=`uvec2(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])})`;break;case"uvec3":i=`uvec3(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])},                             ${f._numberToIntStr(r[2])})`;break;case"uvec4":i=`uvec4(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])},                             ${f._numberToIntStr(r[2])},                             ${f._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":i=`${t}(${Array.prototype.map.call(r,e=>f._numberToFloatStr(e)).join(", ")})`}return this._entries.add(`const ${t} ${e} = ${i};`),this._stage}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}}e.Code=l,e.Includes=n,e.Main=a,e.ShaderBuilder=class extends n{constructor(){super(...arguments),this.vertex=new c,this.fragment=new c,this.attributes=new u,this.varyings=new d,this.extensions=new h,this.outputs=new p}get fragmentUniforms(){return this.fragment.uniforms.entries}get attributeNames(){return this.attributes.names}get builder(){return this}generate(e,t=!1){const r=this.extensions.generateSource(e),i=this.attributes.generateSource(e),s=this.varyings.generateSource(e),n="vertex"===e?this.vertex:this.fragment,o=n.uniforms.generateSource(),a=n.code.generateSource(),l=n.main.generateSource(t),c="vertex"===e?"precision highp float;\n precision highp sampler2D;\n precision highp usampler2D;\n precision highp sampler2DArray;\n precision highp sampler2DShadow;\n\n\n invariant gl_Position;\n ":"#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp int;\n  precision highp sampler2D;\n  precision highp usampler2D;\n  precision highp sampler2DArray;\n  precision highp sampler2DShadow;\n#else\n  precision mediump float;\n  precision mediump int;\n  precision mediump sampler2D;\n  precision mediump usampler2D;\n  precision mediump sampler2DArray;\n  precision mediump sampler2DShadow;\n#endif",u=n.constants.generateSource(),d=this.outputs.generateSource(e);return`#version 300 es\n${r.join("\n")}\n${c}\n${u.join("\n")}\n${o.join("\n")}\n${i.join("\n")}\n${s.join("\n")}\n${d.join("\n")}\n${a.join("\n")}\n${l.join("\n")}`}generateBind(e){const t=new Map;this.vertex.uniforms.entries.forEach(e=>{const r=e.bind[0];r&&t.set(e.name,r)}),this.fragment.uniforms.entries.forEach(e=>{const r=e.bind[0];r&&t.set(e.name,r)});const r=Array.from(t.values()),i=r.length;return t=>{for(let s=0;s<i;++s)r[s](e,t)}}generateBindPass(e){const t=new Map;this.vertex.uniforms.entries.forEach(e=>{const r=e.bind[1];r&&t.set(e.name,r)}),this.fragment.uniforms.entries.forEach(e=>{const r=e.bind[1];r&&t.set(e.name,r)});const r=Array.from(t.values()),i=r.length;return(t,s)=>{for(let n=0;n<i;++n)r[n](e,t,s)}}generateBindDraw(e){const t=new Map;this.vertex.uniforms.entries.forEach(e=>{const r=e.bind[2];r&&t.set(e.name,r)}),this.fragment.uniforms.entries.forEach(e=>{const r=e.bind[2];r&&t.set(e.name,r)});const r=Array.from(t.values()),i=r.length;return(t,s,n)=>{for(let o=0;o<i;++o)r[o](e,n,t,s)}}},e.Stage=c,e.Uniforms=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/CloudsTechnique":function(){define(["require","exports","../../../chunks/Clouds.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../webgl-engine/lib/DefaultVertexBufferLayouts","../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.Clouds,()=>new Promise((t,r)=>e(["./Clouds.glsl"],t,r))),n.Pos2Locations)}initializePipeline(e){return o.makePipelineState({blending:o.simpleBlendingParams(32769,32770,32774,0===e.writeTextureChannels?[1,1,0,0]:[0,0,1,1]),depthTest:{func:515},colorWrite:o.defaultColorWrite})}}t.CloudsTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderTechnique/ReloadableShaderModule":function(){define(["exports"],function(e){"use strict";e.ReloadableShaderModule=class{constructor(e,t){this._module=e,this._load=t}get(){return this._module}async reload(){return this._module=await this._load(),this._module}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderTechnique/ShaderTechnique":function(){define(["exports","../../../../../core/Logger","../../../../../core/maybe","../shaderLibrary/ShaderOutput","../../lib/Program","../../../../webgl/enums","../../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";e.ShaderTechnique=class{constructor(e,i,o,a){this.primitiveType=n.PrimitiveType.TRIANGLES,this.key=i.key,this._program=new s.Program(e.rctx,o.get().build(i),a),this._pipeline=this.initializePipeline(i),this.reload=async n=>{n&&await o.reload(),this.key.equals(i.key)||t.getLogger("esri.views.3d.webgl.ShaderTechnique").warn("Configuration was changed after construction, cannot reload shader.",o),r.disposeMaybe(this._program),this._program=new s.Program(e.rctx,o.get().build(i),a),this._pipeline=this.initializePipeline(i)}}destroy(){this._program=r.disposeMaybe(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,t){return this._pipeline}initializePipeline(e){return o.makePipelineState({blending:o.premultipliedAlpha,colorWrite:o.defaultColorWrite})}},e.depthOnlyOutputBuffersOr=function(e,t){return i.isDepthOnlyOutput(e)?{buffers:[0]}:t??null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/ShaderOutput":function(){define(["exports"],function(e){"use strict";function t(e){return 8===e||9===e}function r(e){return 0===e}function i(e){return r(e)||l(e)}function s(e){return r(e)||8===e}function n(e){return i(e)||t(e)}function o(e){return n(e)||a(e)}function a(e){return 2===e}function l(e){return 1===e}e.is2DGeometryOutput=function(e){return r(e)||t(e)},e.is3DGeometryOutputMRT=function(e){return o(e)||3===e},e.isColor=r,e.isColorEmission=l,e.isColorEmissionHighlightOIDOrDepth=o,e.isColorEmissionHighlightOrOID=n,e.isColorHighlightOrDepth=function(e){return s(e)||a(e)},e.isColorOrColorEmission=i,e.isColorOrColorEmissionOrOID=function(e){return i(e)||9===e},e.isColorOrHighlight=s,e.isColorOrOID=function(e){return r(e)||9===e},e.isDepth=a,e.isDepthOnlyOutput=function(e){switch(e){case 2:case 4:case 5:case 6:case 7:return!0}return!1},e.isHighlightOrOID=t,e.isShadowRelatedOutput=function(e){return 4===e||5===e||6===e||7===e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Program":function(){define(["exports","../../../../core/has","../../../webgl/checkWebGLError"],function(e,t,r){"use strict";e.Program=class{constructor(e,t,i){this._context=e,this.locations=i,this._textures=new Map,this.source=r.webglDebugEnabled()?t:null,t.attributeNames.forEach(e=>{i.has(e)||console.error(`Missing VertexAttributeLocation for ${e} used in shader`)}),this._glProgram=e.programCache.acquire(t.generate("vertex",!0),t.generate("fragment",!0),i),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bind=t.generateBind(this),this.bindPass=t.generateBindPass(this),this.bindDraw=t.generateBindDraw(this)}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,t){this._glProgram.setUniform1i(e,t?1:0)}setUniform1i(e,t){this._glProgram.setUniform1i(e,t)}setUniform1f(e,t,r){this._glProgram.setUniform1f(e,t,r)}setUniform2fv(e,t,r){this._glProgram.setUniform2fv(e,t,r)}setUniform3fv(e,t,r){this._glProgram.setUniform3fv(e,t,r)}setUniform4fv(e,t,r){this._glProgram.setUniform4fv(e,t,r)}setUniformMatrix3fv(e,t,r){this._glProgram.setUniformMatrix3fv(e,t,!1,r)}setUniformMatrix4fv(e,t,r){this._glProgram.setUniformMatrix4fv(e,t,!1,r)}setUniform1fv(e,t,r){this._glProgram.setUniform1fv(e,t,r)}setUniform1iv(e,t){this._glProgram.setUniform1iv(e,t)}setUniform2iv(e,t){this._glProgram.setUniform2iv(e,t)}setUniform3iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform4iv(e,t){this._glProgram.setUniform4iv(e,t)}assertCompatibleVertexAttributeLocations(e,t){let r=e.locations;if(t){const e=new Map(r);t.forEach((t,i)=>e.set(i,r.size+t)),r=e}r.size!==this.locations.size&&console.error(`VertexAttributeLocations are incompatible: ${r}, ${this.locations}`),this.locations.forEach((e,t)=>{r.get(t)!==e&&console.error(`VertexAttributeLocations are incompatible: Program has ${t} at position ${e}, VAO has it at position ${r.get(t)}.`)})}stop(){this._textures.clear()}bindTexture(e,t){t?.glName||(r.webglDebugEnabled()&&console.error(`Texture sampler ${e} has no given Texture in ${(new Error).stack} `),t=this._context.emptyTexture);const i=this._ensureTextureUnit(e,t);this._context.useProgram(this),this.setUniform1i(e,i.unit),this._context.bindTexture(t,i.unit)}_ensureTextureUnit(e,t){let r=this._textures.get(e);return null==r?(r={texture:t,unit:this._textures.size},this._textures.set(e,r)):r.texture=t,r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/checkWebGLError":function(){define(["exports","../../core/Error","../../core/has","../../core/Logger"],function(e,t,r,i){"use strict";function s(e){switch(e.getError()){case e.NO_ERROR:return null;case e.INVALID_ENUM:return"Invalid Enum. An unacceptable value has been specified for an enumerated argument.";case e.INVALID_VALUE:return"Invalid Value. A numeric argument is out of range.";case e.INVALID_OPERATION:return"Invalid Operation. The specified command is not allowed for the current state.";case e.INVALID_FRAMEBUFFER_OPERATION:return"Invalid Framebuffer operation. The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case e.OUT_OF_MEMORY:return"Out of memory. Not enough memory is left to execute the command.";case e.CONTEXT_LOST_WEBGL:return"WebGL context has been lost";default:return"Unknown error"}}const n=!!r("enable-feature:webgl-debug");function o(){return n}e.checkWebGLError=function(e,r=o()){if(r){const r=s(e);if(r){const e=(new Error).stack;i.getLogger("esri.views.webgl.checkWebGLError").error(new t("webgl-error","WebGL error occurred",{message:r,stack:e}))}}},e.getErrorMessage=s,e.hasFeatureFlagWebGLDebug=n,e.webglDebugEnabled=o,e.webglValidateShadersEnabled=function(){return n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/enums":function(){define(["exports"],function(e){"use strict";const t={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,HALF_FLOAT:5131},r={RGBA4:32854,R16F:33325,RG16F:33327,RGB32F:34837,RGBA16F:34842,R32F:33326,RG32F:33328,RGBA32F:34836,R11F_G11F_B10F:35898,RGB8:32849,RGBA8:32856,RGB5_A1:32855,R8:33321,RG8:33323,R8I:33329,R8UI:33330,R16I:33331,R16UI:33332,R32I:33333,R32UI:33334,RG8I:33335,RG8UI:33336,RG16I:33337,RG16UI:33338,RG32I:33339,RG32UI:33340,RGB16F:34843,RGB9_E5:35901,SRGB8:35905,SRGB8_ALPHA8:35907,RGB565:36194,RGBA32UI:36208,RGB32UI:36209,RGBA16UI:36214,RGB16UI:36215,RGBA8UI:36220,RGB8UI:36221,RGBA32I:36226,RGB32I:36227,RGBA16I:36232,RGB16I:36233,RGBA8I:36238,RGB8I:36239,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,RGB10_A2:32857,RGB10_A2UI:36975},i=Object.values(r),s={FLOAT:t.FLOAT,UNSIGNED_BYTE:t.UNSIGNED_BYTE,UNSIGNED_INT_24_8:34042,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,BYTE:t.BYTE,UNSIGNED_SHORT:t.UNSIGNED_SHORT,SHORT:t.SHORT,UNSIGNED_INT:t.UNSIGNED_INT,INT:t.INT,HALF_FLOAT:5131,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269};e.ColorAttachment0=36064,e.ColorAttachment1=36065,e.ColorAttachment10=36074,e.ColorAttachment11=36075,e.ColorAttachment12=36076,e.ColorAttachment13=36077,e.ColorAttachment14=36078,e.ColorAttachment15=36079,e.ColorAttachment2=36066,e.ColorAttachment3=36067,e.ColorAttachment4=36068,e.ColorAttachment5=36069,e.ColorAttachment6=36070,e.ColorAttachment7=36071,e.ColorAttachment8=36072,e.ColorAttachment9=36073,e.CompressedTextureFormat={COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_SRGB8_ETC2:37493,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37494,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37495,COMPRESSED_RGBA8_ETC2_EAC:37496,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37497},e.DataType=t,e.DepthAttachment=36096,e.DepthStencilAttachment=33306,e.PixelType=s,e.PrimitiveType={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},e.ResourceType={Texture:0,TileTexture:1,BufferObject:2,VertexArrayObject:3,Shader:4,Program:5,FramebufferObject:6,Renderbuffer:7,TransformFeedback:8,Sync:9,UNCOUNTED:10,LinesOfCode:10,Uniform:11,COUNT:12},e.SizedDepthFormat={DEPTH_COMPONENT16:33189,DEPTH_COMPONENT24:33190,DEPTH_COMPONENT32F:36012},e.SizedDepthStencilFormat={DEPTH24_STENCIL8:35056,DEPTH32F_STENCIL8:36013},e.SizedPixelFormat=r,e.StencilAttachment=36128,e.baseTextureUnit=33984,e.sizedPixelFormatValues=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/renderState":function(){define(["exports"],function(e){"use strict";function t(e,t,r=32774,i=[0,0,0,0]){return{srcRgb:e,srcAlpha:e,dstRgb:t,dstAlpha:t,opRgb:r,opAlpha:r,color:{r:i[0],g:i[1],b:i[2],a:i[3]}}}function r(e,t,r,i,s=32774,n=32774,o=[0,0,0,0]){return{srcRgb:e,srcAlpha:t,dstRgb:r,dstAlpha:i,opRgb:s,opAlpha:n,color:{r:o[0],g:o[1],b:o[2],a:o[3]}}}const i=t(0,771),s=t(1,0),n=t(1,1),o=t(1,771),a=r(770,1,771,771),l={face:1029,mode:2305},c={face:1028,mode:2305};function u(e){return w.intern(e)}function d(e){return S.intern(e)}function h(e){return C.intern(e)}function p(e){return M.intern(e)}function f(e){return O.intern(e)}function m(e){return F.intern(e)}function g(e){return D.intern(e)}function y(e){return L.intern(e)}function _(e){return U.intern(e)}class b{constructor(e,t){this._makeKey=e,this._makeRef=t,this._interns=new Map}intern(e){if(!e)return null;const t=this._makeKey(e),r=this._interns;return r.has(t)||r.set(t,this._makeRef(e)),r.get(t)??null}}function v(e){return"["+e.join(",")+"]"}const w=new b(x,e=>({__tag:"Blending",...e}));function x(e){return e?v([e.srcRgb,e.srcAlpha,e.dstRgb,e.dstAlpha,e.opRgb,e.opAlpha,e.color.r,e.color.g,e.color.b,e.color.a]):null}const S=new b(T,e=>({__tag:"Culling",...e}));function T(e){return e?v([e.face,e.mode]):null}const C=new b(P,e=>({__tag:"PolygonOffset",...e}));function P(e){return e?v([e.factor,e.units]):null}const M=new b(R,e=>({__tag:"DepthTest",...e}));function R(e){return e?v([e.func]):null}const O=new b(I,e=>({__tag:"StencilTest",...e}));function I(e){return e?v([e.function.func,e.function.ref,e.function.mask,e.operation.fail,e.operation.zFail,e.operation.zPass]):null}const F=new b(A,e=>({__tag:"DepthWrite",...e}));function A(e){return e?v([e.zNear,e.zFar]):null}const D=new b(E,e=>({__tag:"ColorWrite",...e}));function E(e){return e?v([e.r,e.g,e.b,e.a]):null}const L=new b(V,e=>({__tag:"StencilWrite",...e}));function V(e){return e?v([e.mask]):null}const U=new b(B,e=>({__tag:"DrawBuffers",...e}));function B(e){return e?v(e.buffers):null}const N=new b(function(e){return e?v([x(e.blending),T(e.culling),P(e.polygonOffset),R(e.depthTest),I(e.stencilTest),A(e.depthWrite),E(e.colorWrite),V(e.stencilWrite),B(e.drawBuffers)]):null},e=>({blending:u(e.blending),culling:d(e.culling),polygonOffset:h(e.polygonOffset),depthTest:p(e.depthTest),stencilTest:f(e.stencilTest),depthWrite:m(e.depthWrite),colorWrite:g(e.colorWrite),stencilWrite:y(e.stencilWrite),drawBuffers:_(e.drawBuffers)}));e.StateTracker=class{constructor(e){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._drawBuffersInvalid=!0,this._stateSetters=e}setPipeline(e){(this._pipelineInvalid||e!==this._pipeline)&&(this._setBlending(e.blending),this._setCulling(e.culling),this._setPolygonOffset(e.polygonOffset),this._setDepthTest(e.depthTest),this._setStencilTest(e.stencilTest),this._setDepthWrite(e.depthWrite),this._setColorWrite(e.colorWrite),this._setStencilWrite(e.stencilWrite),this._setDrawBuffers(e.drawBuffers),this._pipeline=e),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDrawBuffers(){this._drawBuffersInvalid=!0,this._pipelineInvalid=!0}_setBlending(e){this._blending=this._setSubState(e,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}_setCulling(e){this._culling=this._setSubState(e,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}_setPolygonOffset(e){this._polygonOffset=this._setSubState(e,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}_setDepthTest(e){this._depthTest=this._setSubState(e,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}_setStencilTest(e){this._stencilTest=this._setSubState(e,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}_setDepthWrite(e){this._depthWrite=this._setSubState(e,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}_setColorWrite(e){this._colorWrite=this._setSubState(e,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}_setStencilWrite(e){this._stencilWrite=this._setSubState(e,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}_setDrawBuffers(e){this._drawBuffers=this._setSubState(e,this._drawBuffers,this._drawBuffersInvalid,this._stateSetters.setDrawBuffers),this._drawBuffersInvalid=!1}_setSubState(e,t,r,i){return(r||e!==t)&&(i(e),this._pipelineInvalid=!0),e}},e.add=n,e.backFaceCullingParams=l,e.copySource=s,e.cullingParams=e=>2===e?l:1===e?c:null,e.defaultColorWrite={r:!0,g:!0,b:!0,a:!0},e.defaultDepthWrite={zNear:0,zFar:1},e.destinationTimesOneMinusSourceAlpha=i,e.frontFaceCullingParams=c,e.makeBlending=u,e.makeColorWrite=g,e.makeCulling=d,e.makeDepthTest=p,e.makeDepthWrite=m,e.makeDrawBuffers=_,e.makePipelineState=function(e){return N.intern(e)},e.makePolygonOffset=h,e.makeStencilTest=f,e.makeStencilWrite=y,e.premultipliedAlpha=o,e.separateBlendingParams=r,e.simpleBlendingParams=t,e.unpremultipliedAlphaToPremultipliedAlpha=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/DefaultVertexBufferLayouts":function(){define(["exports","../../../webgl/enums","../../../webgl/VertexAttributeLocations","../../../webgl/VertexElementDescriptor"],function(e,t,r,i){"use strict";const s=[new i.VertexElementDescriptor("position",3,t.DataType.FLOAT,0,12)],n=[new i.VertexElementDescriptor("position",2,t.DataType.FLOAT,0,8)],o=r.fromLayout(n),a=[new i.VertexElementDescriptor("position",2,t.DataType.FLOAT,0,12),new i.VertexElementDescriptor("uv0",2,t.DataType.HALF_FLOAT,8,12)],l=[new i.VertexElementDescriptor("position",2,t.DataType.FLOAT,0,16),new i.VertexElementDescriptor("uv0",2,t.DataType.FLOAT,8,16)];e.NoVertex=[],e.Pos2=n,e.Pos2Locations=o,e.Pos2TexF16=a,e.Pos2TexF32=l,e.Pos3=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/VertexAttributeLocations":function(){define(["exports"],function(e){"use strict";function t(e){const t=new Map;let r=0;return e.forEach(e=>e.forEach(({name:e,count:i})=>{t.set(e,r),16===i?r+=4:9===i?r+=3:++r})),t}e.fromBuffers=function(e){return t(Array.from(e.values()).map(({layout:e})=>e))},e.fromLayout=function(e){let t=0;return new Map(e.map(({name:e,count:r})=>{const i=[e,t];return 16===r?t+=4:9===r?t+=3:++t,i}))},e.fromLayouts=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/VertexElementDescriptor":function(){define(["exports"],function(e){"use strict";e.VertexElementDescriptor=class{constructor(e,t,r,i,s,n=!1,o=0){this.name=e,this.count=t,this.type=r,this.offset=i,this.stride=s,this.normalized=n,this.divisor=o}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/CloudsTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.steps=0,this.writeTextureChannels=0}}t.__decorate([r.parameter({count:3})],i.prototype,"steps",void 0),t.__decorate([r.parameter({count:2})],i.prototype,"writeTextureChannels",void 0),e.CloudsTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration":function(){define(["exports","../../../../../core/Error","./ShaderTechniqueConfigurationKey","../../../../webgl/NoParameters"],function(e,t,r,i){"use strict";class s extends i.NoParameters{constructor(){super(),this._parameterBits=this._parameterBits?.map(()=>0)??[],this._parameterNames??=[]}get key(){return this._key??=new r.ShaderTechniqueConfigurationKey(this._parameterBits),this._key}decode(e=this.key){const t=this._parameterBits;this._parameterBits=[...e.bits];const r=this._parameterNames.map(e=>`    ${e}: ${this[e]}`).join("\n");return this._parameterBits=t,r}}e.ShaderTechniqueConfiguration=s,e.parameter=function(e={}){return(r,i)=>{r.hasOwnProperty("_parameterNames")||Object.defineProperty(r,"_parameterNames",{value:r._parameterNames?.slice()??[],configurable:!0,writable:!0}),r.hasOwnProperty("_parameterBits")||Object.defineProperty(r,"_parameterBits",{value:r._parameterBits?.slice()??[0],configurable:!0,writable:!0}),r._parameterNames.push(i);const s=e.count||2,n=Math.ceil(Math.log2(s)),o=r._parameterBits;let a=0;for(;o[a]+n>16;)a++,a>=o.length&&o.push(0);const l=o[a],c=(1<<n)-1<<l;o[a]+=n,e.count?Object.defineProperty(r,i,{get(){return(this._parameterBits[a]&c)>>l},set(r){if(this[i]!==r){if(this._key=null,this._parameterBits[a]=this._parameterBits[a]&~c|+r<<l&c,"number"!=typeof r)throw new t("internal:invalid-shader-configuration",`Configuration value for ${i} must be a number, got ${typeof r}`);if(null==e.count)throw new t("internal:invalid-shader-configuration",`Configuration value for ${i} must provide a count option`)}}}):Object.defineProperty(r,i,{get(){return!!((this._parameterBits[a]&c)>>l)},set(e){if(this[i]!==e&&(this._key=null,this._parameterBits[a]=this._parameterBits[a]&~c|+e<<l&c,"boolean"!=typeof e))throw new t("internal:invalid-shader-configuration",`Configuration value for ${i} must be boolean, got ${typeof e}`)}})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderTechnique/ShaderTechniqueConfigurationKey":function(){define(["exports","../../../../../core/arrayUtils"],function(e,t){"use strict";e.ShaderTechniqueConfigurationKey=class{constructor(e){this._bits=[...e]}equals(e){return t.equals(this._bits,e.bits)}get code(){return this._code??=String.fromCharCode(...this._bits),this._code}get bits(){return this._bits}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/NoiseTextureAtlas":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/vec2","../../../chunks/NoiseTextureAtlas.glsl","./NoiseTextureAtlasConfiguration","./NoiseTextureAtlasDimensions","./NoiseTextureAtlasTechnique","../../webgl/FramebufferObject","../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";e.NoiseTextureAtlas=class extends r{constructor(e){super(e),this._needsRender=!0,this._passParameters=new u.NoiseTextureAtlasPassParameters,this._configuration=new d.NoiseTextureAtlasTechniqueConfiguration,this._fbo=new f.FramebufferObject(e.context.renderContext.rctx,new m.TextureDescriptor(h.atlasSize)),e.context.techniques.precompile(p.NoiseTextureAtlasTechnique,new d.NoiseTextureAtlasTechniqueConfiguration);const t=new d.NoiseTextureAtlasTechniqueConfiguration;t.mode=1,e.context.techniques.precompile(p.NoiseTextureAtlasTechnique,t)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?1:0;const e=this.context.techniques.get(p.NoiseTextureAtlasTechnique,this._configuration);return e.compiled&&(this._texture=this._render(e)),this._texture}updateWeatherMap(e){c.equals(this._passParameters.weatherTile,e)||(c.copy(this._passParameters.weatherTile,e),this._needsRender=!0)}destroy(){this._fbo=i.disposeMaybe(this._fbo)}_render(e){if(!this._fbo)return null;const t=this.context.renderContext.rctx,r=t.getViewport();return t.setViewport(0,0,h.atlasSize,h.atlasSize),t.bindFramebuffer(this._fbo),t.bindTechnique(e,this.context.renderContext.bind,this._passParameters),t.screen.draw(),t.setViewport(r.x,r.y,r.width,r.height),this._needsRender=!1,this._fbo.colorTexture}},t.__decorate([s.property({constructOnly:!0})],e.NoiseTextureAtlas.prototype,"context",void 0),e.NoiseTextureAtlas=t.__decorate([l.subclass("esri.views.3d.environment.NoiseTextureAtlas")],e.NoiseTextureAtlas),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/NoiseTextureAtlas.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec2f64","../views/3d/environment/NoiseTextureAtlasDimensions","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a){"use strict";class l extends o.NoParameters{constructor(){super(...arguments),this.weatherTile=t.fromValues(0,0)}}function c(e){const t=new a.ShaderBuilder;if(t.include(i.ScreenSpacePass,!1),t.fragment.code.add(n.glsl`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),0===e.mode){const e=2,i=8;t.fragment.code.add(n.glsl`float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),t.fragment.code.add(n.glsl`vec3 modulo(vec3 m, float n) {
return mod(mod(m, n) + n, n);
}
vec3 hash(vec3 p3, float frequency) {
p3 = modulo(p3, frequency);
p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yxz + 33.33);
return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
}`),t.fragment.code.add(n.glsl`vec3 fade(vec3 t) {
return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
}`),t.fragment.code.add(n.glsl`
    float gradientNoise(vec3 p, float frequency) {
      vec3 i = floor(p);
      vec3 f = fract(p);
      vec3 u = fade(f);
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequency = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequency;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${n.glsl.float(r.tileRows)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${n.glsl.float(i)});

      float worley0 = worley(p, ${n.glsl.float(e)} * 2.0);
      float worley1 = worley(p, ${n.glsl.float(e)} * 8.0);
      float worley2 = worley(p, ${n.glsl.float(e)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${n.glsl.float(e)});
      float worley1 = worley(p, ${n.glsl.float(e)} * 2.0);
      float worley2 = worley(p, ${n.glsl.float(e)} * 4.0);
      float worley3 = worley(p, ${n.glsl.float(e)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)}return t.fragment.uniforms.add(new s.Float2PassUniform("weatherTile",e=>e.weatherTile)).code.add(n.glsl`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${n.glsl.float(r.weatherTileSize)});

      // Get global coordinates of p
      p += weatherTile * ${n.glsl.float(r.weatherTileSize)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${n.glsl.float(r.weatherMapSize)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),0===e.mode?t.fragment.main.add(n.glsl`
      float padWidth = 1.0;
      float paddedSize = ${n.glsl.float(r.tileSize)} + 2.0 * padWidth;
      float tileCount = ${n.glsl.float(r.tileRows)} * ${n.glsl.float(r.tileRows)};
      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

      bool padCell = false;
      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      bool startPadX = false;
      bool startPadY = false;
      bool endPadX = false;
      bool endPadY = false;

      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
        startPadX = true;
      }

      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
        startPadY = true;
      }

      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
        endPadX = true;
      }

      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
        endPadY = true;
      }

      vec2 padding = vec2(2.0 * padWidth) * tile;
      vec2 uv;

      if (padCell) {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;

        if (startPadX) {
          pixel.x += ${n.glsl.float(r.tileSize)};
        }

        if (startPadY) {
          pixel.y += ${n.glsl.float(r.tileSize)};
        }

        if (endPadX) {
          pixel.x -= ${n.glsl.float(r.tileSize)};
        }

        if (endPadY) {
          pixel.y -= ${n.glsl.float(r.tileSize)};
        }

        uv = vec2(pixel.xy / ${n.glsl.float(r.tileSize)});
      } else {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;
        uv = vec2(pixel.xy / ${n.glsl.float(r.tileSize)});
      }

      vec3 p_ = get3Dfrom2D(uv);
      vec3 p = p_;
      p.z /= (${n.glsl.float(r.tileRows)} * ${n.glsl.float(r.tileRows)});

      float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      float worleyNoise = getTextureForPointWorley(p);

      fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      p_ = mod(p_ + 1.0, ${n.glsl.float(r.tileRows)} * ${n.glsl.float(r.tileRows)});
      p = p_;
      p.z /= (${n.glsl.float(r.tileRows)} * ${n.glsl.float(r.tileRows)});

      worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      worleyNoise = getTextureForPointWorley(p);

      fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      vec2 mapUV = ${n.glsl.float(r.weatherTileSize)} * (gl_FragCoord.xy / ${n.glsl.float(r.atlasSize)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor.ba = vec2(0.0, map);
      `):t.fragment.main.add(n.glsl`
      vec2 mapUV = ${n.glsl.float(r.weatherTileSize)} * (gl_FragCoord.xy / ${n.glsl.float(r.atlasSize)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor = vec4(map);
    `),t}const u=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:l,build:c},Symbol.toStringTag,{value:"Module"}));e.NoiseTextureAtlas=u,e.NoiseTextureAtlasPassParameters=l,e.build=c})},"esri/views/3d/environment/NoiseTextureAtlasConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.mode=0}}t.__decorate([r.parameter({count:2})],i.prototype,"mode",void 0),e.NoiseTextureAtlasTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/NoiseTextureAtlasTechnique":function(){define(["require","exports","../../../chunks/NoiseTextureAtlas.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../webgl-engine/lib/DefaultVertexBufferLayouts","../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.NoiseTextureAtlas,()=>new Promise((t,r)=>e(["./NoiseTextureAtlas.glsl"],t,r))),n.Pos2Locations)}initializePipeline(e){return o.makePipelineState({blending:0===e.mode?o.copySource:o.separateBlendingParams(0,1,1,0),depthTest:{func:519},colorWrite:o.defaultColorWrite})}}t.NoiseTextureAtlasTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/FramebufferObject":function(){define(["exports","../../core/has","../../core/Logger","../../core/maybe","./BufferObject","./checkWebGLError","./enums","./Renderbuffer","./Texture"],function(e,t,r,i,s,n,o,a,l){"use strict";class c{constructor(e,t,r){if(this._context=e,this._glName=null,this._colorAttachments=new Map,this._depthStencilBuffer=null,this._depthStencilTexture=null,this._initialized=!1,e.instanceCounter.increment(o.ResourceType.FramebufferObject,this),null!=t){const r=function(e,t){return u(t)||d(t)?t:h(t)?new l.Texture(e,t):function(e){return 3===p(e)||null!=e&&"samples"in e}(t)?new a.Renderbuffer(e,t):null}(e,t);null!=r&&(this._colorAttachments.set(o.ColorAttachment0,r),u(r)?this._validateTextureDescriptor(r.descriptor):this._validateRenderbufferDescriptor(r.descriptor)),this._validateColorAttachmentPoint(o.ColorAttachment0)}var i;if(null!=r)if(u(i=r)||h(i))this._depthStencilTexture=u(r)?r:new l.Texture(e,r),this._validateTextureDescriptor(this._depthStencilTexture.descriptor);else{const t=d(r)?r:new a.Renderbuffer(e,r);this._depthStencilBuffer=t,this._validateRenderbufferDescriptor(t.descriptor)}}dispose(){const{_colorAttachments:e,_glName:t}=this;if(0===e.size&&!this._depthStencilBuffer&&!this._depthStencilTexture&&!t)return;const{_context:r}=this,i=r.getBoundFramebufferObject();e.forEach((e,t)=>this.detachColorTexture(t)?.dispose()),this.detachDepthStencilBuffer()?.dispose(),this.detachDepthStencilTexture()?.dispose(),r.gl.deleteFramebuffer(t),this._glName=null,r.bindFramebuffer(i===this?null:i),r.instanceCounter.decrement(o.ResourceType.FramebufferObject,this)}get glName(){return this._glName}get colorTexture(){const e=this._colorAttachments.get(o.ColorAttachment0);return u(e)?e:null}get depthStencil(){return this._depthStencilTexture||this._depthStencilBuffer}get depthStencilTexture(){return this._depthStencilTexture}get width(){const e=this._colorAttachments.get(o.ColorAttachment0)??this._depthStencilTexture??this._depthStencilBuffer;return e?.descriptor?.width??0}get height(){const e=this._colorAttachments.get(o.ColorAttachment0)??this._depthStencilTexture??this._depthStencilBuffer;return e?.descriptor?.height??0}get usedMemory(){return[...this._colorAttachments].reduce((e,[t,r])=>e+r.usedMemory,this.depthStencil?.usedMemory??0)}static{this._MAX_COLOR_ATTACHMENTS=-1}getColorTexture(e){const t=this._colorAttachments.get(e);return t&&u(t)?t:null}get colorAttachments(){return[...this._colorAttachments.keys()]}attachColorTexture(e,t=o.ColorAttachment0){if(!e)return;this._validateColorAttachmentPoint(t);const{descriptor:r}=e;this._validateTextureDescriptor(r),this.detachColorTexture(t)?.dispose(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,t)),this._colorAttachments.set(t,e)}detachColorTexture(e=o.ColorAttachment0){const t=this._colorAttachments.get(e);if(!t)return;const r=u(t);return this._initialized&&this._context.temporaryBindFramebufferObject(this,()=>{if(r)this._framebufferTexture2D(null,e);else{const t=this._context.gl;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,null)}}),this._colorAttachments.delete(e),r?t:void 0}setColorTextureTarget(e,t=o.ColorAttachment0,r=0){const i=this._colorAttachments.get(t);i&&(35866===e?this._framebufferTextureLayer(i.glName,t,36160,0,r):this._framebufferTexture2D(i.glName,t,e,36160,0))}attachDepthStencil(e){if(e)switch(e.type){case 1:return this._attachDepthStencilTexture(e);case 2:return this._attachDepthStencilBuffer(e)}}_attachDepthStencilTexture(e){if(null==e)return;const{descriptor:t}=e,{pixelFormat:r,dataType:i}=t;34041===r||6402===r?34041!==r||i===o.PixelType.UNSIGNED_INT_24_8?6402!==r||i===o.PixelType.UNSIGNED_INT||i===o.PixelType.UNSIGNED_SHORT?(this._validateTextureDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,g(r))),this._depthStencilTexture?.dispose(),this._depthStencilTexture=e):console.error("Depth texture must have data type of UNSIGNED_INT or UNSIGNED_SHORT!"):console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"):console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!")}detachDepthStencilTexture(){const e=this._depthStencilTexture;return e&&this._initialized&&this._context.temporaryBindFramebufferObject(this,()=>{this._framebufferTexture2D(null,g(e.descriptor.pixelFormat))}),this._depthStencilTexture=null,e}_attachDepthStencilBuffer(e){if(null==e)return;const t=e.descriptor;if(this._validateRenderbufferDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const{gl:r}=this._context,i=this._getGLAttachmentPoint(t);r.framebufferRenderbuffer(36160,i,r.RENDERBUFFER,e.glName)}this._depthStencilBuffer=e}detachDepthStencilBuffer(){const e=this._depthStencilBuffer;if(e&&this._initialized){const{_context:t}=this,r=t.getBoundFramebufferObject();t.bindFramebuffer(this);const{gl:i}=t,s=this._getGLAttachmentPoint(e.descriptor);i.framebufferRenderbuffer(36160,s,i.RENDERBUFFER,null),t.bindFramebuffer(r)}return this._depthStencilBuffer=null,e}invalidateAttachments(e){const{_context:t}=this;t.temporaryBindFramebufferObject(this,()=>t.gl.invalidateFramebuffer(36160,e),!0)}copyToTexture(e,t,r,i,s,n,o){(e<0||t<0||s<0||n<0)&&console.error("Offsets cannot be negative!"),(r<=0||i<=0)&&console.error("Copy width and height must be greater than zero!");const a=o.descriptor;3553!==o.descriptor.target&&console.error("Texture target must be TEXTURE_2D!"),(null==a?.width||null==a?.height||e+r>this.width||t+i>this.height||s+r>a.width||n+i>a.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const c=this._context,u=c.bindTexture(o,l.Texture.TEXTURE_UNIT_FOR_UPDATES);c.setActiveTexture(l.Texture.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(this),c.gl.copyTexSubImage2D(3553,0,s,n,e,t,r,i),c.bindTexture(u,l.Texture.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,t,r,i,s,n,o){(r<=0||i<=0)&&console.error("Copy width and height must be greater than zero!"),o||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,t,r,i,s,n,o)}async readPixelsAsync(e,t,r,i,n,o,a){const{gl:l}=this._context,c=s.BufferObject.createPixelPack(this._context,35041,a.byteLength);this._context.bindBuffer(c);const u=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),l.readPixels(e,t,r,i,n,o,0),this._context.unbindBuffer(35051),this._context.bindFramebuffer(u),await c.getSubDataAsync(a),c.dispose()}resize(e,t){if(this.width===e&&this.height===t)return;const r={width:e,height:t};f(r,this._context.parameters.maxTextureSize),this._colorAttachments.forEach(e=>e.resize(r.width,r.height)),this._depthStencilTexture?.resize(r.width,r.height),this._initialized&&(f(r,this._context.parameters.maxRenderbufferSize),this._depthStencilBuffer?.resize(r.width,r.height),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1)}initializeAndBind(e=36160){const{gl:t}=this._context;if(this._initialized)return void t.bindFramebuffer(e,this.glName);this._glName&&t.deleteFramebuffer(this._glName);const r=t.createFramebuffer();if(t.bindFramebuffer(e,r),this._colorAttachments.forEach((t,r)=>{if(u(t)){const i=m(t);35866===i?this._framebufferTextureLayer(t.glName,r,e,0,0):this._framebufferTexture2D(t.glName,r,i,e)}else if(d(t)){const i=this._context.gl;i.framebufferRenderbuffer(e,r,i.RENDERBUFFER,t.glName)}}),this._depthStencilBuffer){const r=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);t.framebufferRenderbuffer(e,r,t.RENDERBUFFER,this._depthStencilBuffer.glName)}else if(this._depthStencilTexture){const t=g(this._depthStencilTexture.descriptor.pixelFormat);this._framebufferTexture2D(this._depthStencilTexture.glName,t,m(this._depthStencilTexture),e)}n.webglDebugEnabled()&&t.checkFramebufferStatus(e)!==t.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=r,this._initialized=!0}_framebufferTexture2D(e,t=o.ColorAttachment0,r=3553,i=36160,s=0){this._context.gl.framebufferTexture2D(i,t,r,e,s)}_framebufferTextureLayer(e,t=o.ColorAttachment0,r=36160,i=0,s=0){this._context.gl.framebufferTextureLayer(r,t,e,i,s)}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthStencilBuffer){if(this._initialized){this._context.bindFramebuffer(this);const t=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);e.framebufferRenderbuffer(36160,t,e.RENDERBUFFER,null)}this._depthStencilBuffer=i.disposeMaybe(this._depthStencilBuffer)}this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,g(this._depthStencilTexture.descriptor.pixelFormat))),this._depthStencilTexture=i.disposeMaybe(this._depthStencilTexture))}_validateTextureDescriptor(e){3553!==e.target&&34067!==e.target&&35866!==e.target&&console.error("Texture type must be TEXTURE_2D, TEXTURE_2D_ARRAY or TEXTURE_CUBE_MAP!"),f(e,this._context.parameters.maxTextureSize),this._validateBufferDimensions(e)}_validateRenderbufferDescriptor(e){f(e,this._context.parameters.maxRenderbufferSize),this._validateBufferDimensions(e)}_validateBufferDimensions(e){e.width<=0&&(e.width=this.width),e.height<=0&&(e.height=this.height),this.width>0&&this.height>0&&(this.width===e.width&&this.height===e.height||console.error("Attachment size must match framebuffer size!"))}_getGLAttachmentPoint(e){switch(e.internalFormat){case o.SizedDepthFormat.DEPTH_COMPONENT16:case o.SizedDepthFormat.DEPTH_COMPONENT24:case o.SizedDepthFormat.DEPTH_COMPONENT32F:return o.DepthAttachment;case o.SizedDepthStencilFormat.DEPTH24_STENCIL8:case o.SizedDepthStencilFormat.DEPTH32F_STENCIL8:return o.DepthStencilAttachment;case 36168:return o.StencilAttachment;default:return o.ColorAttachment0}}_validateColorAttachmentPoint(e){if(-1===c._MAX_COLOR_ATTACHMENTS){const{gl:e}=this._context;c._MAX_COLOR_ATTACHMENTS=e.getParameter(e.MAX_COLOR_ATTACHMENTS)}const t=e-o.ColorAttachment0;t+1>c._MAX_COLOR_ATTACHMENTS&&r.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${t+1}. Implementation supports up to ${c._MAX_COLOR_ATTACHMENTS} color attachments`)}}function u(e){return 1===p(e)}function d(e){return 2===p(e)}function h(e){return 0===p(e)}function p(e){return null!=e&&"type"in e?e.type:null}function f(e,t){const i=Math.max(e.width,e.height);if(i>t){r.getLogger("esri.views.webgl.FramebufferObject").warnOnce(`Resizing FBO attachment size ${e.width}x${e.height} to device limit ${t}`);const s=t/i;return e.width=Math.round(e.width*s),e.height=Math.round(e.height*s),!1}return!0}function m(e){return 34067===e.descriptor.target?34069:35866===e.descriptor.target?35866:3553}function g(e){return 6402===e?o.DepthAttachment:o.DepthStencilAttachment}e.FramebufferObject=c,e.ensureAttachmentMaxSize=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/BufferObject":function(){define(["exports","../../core/arrayUtils","../../core/has","../../core/Logger","../../core/typedArrayUtil","./checkWebGLError","./enums"],function(e,t,r,i,s,n,o){"use strict";const a=()=>i.getLogger("esri.views.webgl.BufferObject"),l=!!r("esri-tests-disable-gpu-memory-measurements");class c{static createIndex(e,t,r){return new c(e,34963,t,r)}static createUniform(e,t,r){return new c(e,35345,t,r)}static createPixelPack(e,t=35041,r){const i=new c(e,35051,t);return r&&i.setSize(r),i}static createPixelUnpack(e,t=35040,r){return new c(e,35052,t,r)}static createTransformFeedback(e,t=35044,r){const i=new c(e,35982,t);return i.setSize(r),i}constructor(e,t,r,i){this._context=e,this.bufferType=t,this.usage=r,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(o.ResourceType.BufferObject,this),this._glName=this._context.gl.createBuffer(),n.checkWebGLError(this._context.gl),i&&this.setData(i)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get sizeBytes(){if(34963===this.bufferType){if(this._indexType===o.DataType.UNSIGNED_INT)return 4*this._size;if(this._indexType===o.DataType.UNSIGNED_SHORT)return 2*this._size}return this._size}get usedMemory(){return l?0:this.sizeBytes}get _isVAOAware(){return 34963===this.bufferType||34962===this.bufferType}dispose(){this._context?.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(o.ResourceType.BufferObject,this),this._context=null):this._glName&&a().warn("Leaked WebGL buffer object")}setSize(e,t=null){if(34963===this.bufferType&&null!=t)switch(this._indexType=t,t){case o.DataType.UNSIGNED_SHORT:e*=2;break;case o.DataType.UNSIGNED_INT:e*=4}this._setBufferData(e)}setData(e){if(!e)return;let t=e.byteLength;34963===this.bufferType&&(s.isUint8Array(e)?this._indexType=o.DataType.UNSIGNED_BYTE:s.isUint16Array(e)?(t/=2,this._indexType=o.DataType.UNSIGNED_SHORT):s.isUint32Array(e)&&(t/=4,this._indexType=o.DataType.UNSIGNED_INT)),this._setBufferData(t,e)}_setBufferData(e,t=null){this._size=e;const r=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const i=this._context.gl;null!=t?i.bufferData(this.bufferType,t,this.usage):i.bufferData(this.bufferType,e,this.usage),n.checkWebGLError(i),this._isVAOAware&&this._context.bindVAO(r)}setSubData(e,t,r,i){if(!e)return;const s=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const{gl:o}=this._context;o.bufferSubData(this.bufferType,t*e.BYTES_PER_ELEMENT,e,r,i-r),n.checkWebGLError(o),this._isVAOAware&&this._context.bindVAO(s)}getSubData(e,r=0,i,s){if(i<0||s<0)return;const n=(o=e,t.isArrayLike(o)?e.BYTES_PER_ELEMENT:1);var o;if(n*((i??0)+(s??0))>e.byteLength)return;r+n*(s??0)>this.usedMemory&&a().warn("Potential problem getting subdata: requested data exceeds buffer size!");const l=this._context.gl;35982===this.bufferType?(this._context.bindBuffer(this,35982),l.getBufferSubData(35982,r,e,i,s),this._context.unbindBuffer(35982)):(this._context.bindBuffer(this,36662),l.getBufferSubData(36662,r,e,i,s),this._context.unbindBuffer(36662))}async getSubDataAsync(e,t=0,r,i){await this._context.clientWaitAsync(),this.getSubData(e,t,r,i)}}e.BufferObject=c,e.tracer=null,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/Renderbuffer":function(){define(["exports","../../core/has","./enums","./RenderbufferDescriptor"],function(e,t,r,i){"use strict";const s=!!t("esri-tests-disable-gpu-memory-measurements");e.Renderbuffer=class{constructor(e,t){this._context=e,this._descriptor=t,this.type=2,this._context.instanceCounter.increment(r.ResourceType.Renderbuffer,this);const i=this._context.gl;this.glName=i.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:s,height:n,internalFormat:o,multisampled:a}=t;a?i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,o,s,n):i.renderbufferStorage(i.RENDERBUFFER,o,s,n),this._context.bindRenderbuffer(null)}get descriptor(){return this._descriptor}get samples(){const e=this._descriptor.samples,t=this._context.parameters.maxSamples;return e?Math.min(e,t):t}get usedMemory(){return s?0:i.estimateMemory(this._descriptor)}resize(e,t){const r=this._descriptor;if(r.width===e&&r.height===t)return;r.width=e,r.height=t;const i=this._context.gl;this._context.bindRenderbuffer(this),r.multisampled?i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,r.internalFormat,r.width,r.height):i.renderbufferStorage(i.RENDERBUFFER,r.internalFormat,r.width,r.height),this._context.bindRenderbuffer(null)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(r.ResourceType.Renderbuffer,this),this._context=null)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/RenderbufferDescriptor":function(){define(["exports","./Util"],function(e,t){"use strict";e.RenderbufferDescriptor=class{constructor(e,t=0,r=t,i=!1,s=1){this.internalFormat=e,this.width=t,this.height=r,this.multisampled=i,this.samples=s}},e.estimateMemory=function(e){return e.width<=0||e.height<=0||null==e.internalFormat?0:e.width*e.height*t.getBytesPerElementFormat(e.internalFormat)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/Util":function(){define(["exports","../../core/has","./checkWebGLError","./enums"],function(e,t,r,i){"use strict";e.bindVertexBufferLayout=function(e,t,i,s=0){const n=e.gl;e.bindBuffer(i);for(const o of i.layout){const i=t.get(o.name);if(null==i){console.warn(`There is no location for vertex attribute '${o.name}' defined.`);continue}const a=s*o.stride;if(o.count<=4)n.vertexAttribPointer(i,o.count,o.type,o.normalized,o.stride,o.offset+a),n.enableVertexAttribArray(i),o.divisor>0&&n.vertexAttribDivisor(i,o.divisor);else if(9===o.count)for(let e=0;e<3;e++)n.vertexAttribPointer(i+e,3,o.type,o.normalized,o.stride,o.offset+12*e+a),n.enableVertexAttribArray(i+e),o.divisor>0&&n.vertexAttribDivisor(i+e,o.divisor);else if(16===o.count)for(let e=0;e<4;e++)n.vertexAttribPointer(i+e,4,o.type,o.normalized,o.stride,o.offset+16*e+a),n.enableVertexAttribArray(i+e),o.divisor>0&&n.vertexAttribDivisor(i+e,o.divisor);else console.error("Unsupported vertex attribute element count: "+o.count);if(r.webglDebugEnabled()){const t=r.getErrorMessage(e.gl);t&&console.error(`Unable to bind vertex attribute "${o.name}" with baseInstanceOffset ${a}:`,t,o)}}},e.getBytesPerElementFormat=function(e){switch(e){case 6406:case 6409:case 6403:case 36244:case i.SizedPixelFormat.R8:case i.SizedPixelFormat.R8I:case i.SizedPixelFormat.R8UI:case i.SizedPixelFormat.R8_SNORM:case 36168:return 1;case 6410:case 33319:case 33320:case i.SizedPixelFormat.RGBA4:case i.SizedPixelFormat.R16F:case i.SizedPixelFormat.R16I:case i.SizedPixelFormat.R16UI:case i.SizedPixelFormat.RG8:case i.SizedPixelFormat.RG8I:case i.SizedPixelFormat.RG8UI:case i.SizedPixelFormat.RG8_SNORM:case i.SizedPixelFormat.RGB565:case i.SizedPixelFormat.RGB5_A1:case i.SizedDepthFormat.DEPTH_COMPONENT16:return 2;case 6407:case 36248:case i.SizedPixelFormat.RGB8:case i.SizedPixelFormat.RGB8I:case i.SizedPixelFormat.RGB8UI:case i.SizedPixelFormat.RGB8_SNORM:case i.SizedPixelFormat.SRGB8:case i.SizedDepthFormat.DEPTH_COMPONENT24:return 3;case 6408:case 36249:case i.SizedPixelFormat.RGBA8:case i.SizedPixelFormat.R32F:case i.SizedPixelFormat.R11F_G11F_B10F:case i.SizedPixelFormat.RG16F:case i.SizedPixelFormat.R32I:case i.SizedPixelFormat.R32UI:case i.SizedPixelFormat.RG16I:case i.SizedPixelFormat.RG16UI:case i.SizedPixelFormat.RGBA8I:case i.SizedPixelFormat.RGBA8UI:case i.SizedPixelFormat.RGBA8_SNORM:case i.SizedPixelFormat.SRGB8_ALPHA8:case i.SizedPixelFormat.RGB9_E5:case i.SizedPixelFormat.RGB10_A2UI:case i.SizedPixelFormat.RGB10_A2:case i.SizedDepthFormat.DEPTH_COMPONENT32F:case i.SizedDepthStencilFormat.DEPTH24_STENCIL8:return 4;case i.SizedDepthStencilFormat.DEPTH32F_STENCIL8:return 5;case i.SizedPixelFormat.RGB16F:case i.SizedPixelFormat.RGB16I:case i.SizedPixelFormat.RGB16UI:return 6;case i.SizedPixelFormat.RG32F:case i.SizedPixelFormat.RG32I:case i.SizedPixelFormat.RG32UI:case i.SizedPixelFormat.RGBA16F:case i.SizedPixelFormat.RGBA16I:case i.SizedPixelFormat.RGBA16UI:return 8;case i.SizedPixelFormat.RGB32F:case i.SizedPixelFormat.RGB32I:case i.SizedPixelFormat.RGB32UI:return 12;case i.SizedPixelFormat.RGBA32F:case i.SizedPixelFormat.RGBA32I:case i.SizedPixelFormat.RGBA32UI:return 16;case i.CompressedTextureFormat.COMPRESSED_RGB_S3TC_DXT1_EXT:case i.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT1_EXT:return.5;case i.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT3_EXT:case i.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT5_EXT:return 1;case i.CompressedTextureFormat.COMPRESSED_R11_EAC:case i.CompressedTextureFormat.COMPRESSED_SIGNED_R11_EAC:case i.CompressedTextureFormat.COMPRESSED_RGB8_ETC2:case i.CompressedTextureFormat.COMPRESSED_SRGB8_ETC2:case i.CompressedTextureFormat.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:case i.CompressedTextureFormat.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:return.5;case i.CompressedTextureFormat.COMPRESSED_RG11_EAC:case i.CompressedTextureFormat.COMPRESSED_SIGNED_RG11_EAC:case i.CompressedTextureFormat.COMPRESSED_RGBA8_ETC2_EAC:case i.CompressedTextureFormat.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:return 1}return 0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/Texture":function(){define(["exports","../../core/Error","../../core/has","../../core/Logger","../../core/maybe","../../core/object","../../core/promiseUtils","./checkWebGLError","./enums","./TextureDescriptor","./textureUtils","./ValidatedTextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h=!!r("esri-tests-disable-gpu-memory-measurements"),p=()=>i.getLogger("esri/views/webgl/Texture");let f=class e{static{this.TEXTURE_UNIT_FOR_UPDATES=0}static{this.compressionWorkerHandle=null}constructor(e,r=null,i=null){if(this.type=1,this._glName=null,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._shadowFilterDirty=!1,this._wasImmutablyAllocated=!1,"context"in e)this._descriptor=e,i=r;else{const i=d.ValidatedTextureDescriptor.validate(e,r);if(!i)throw new t("texture:invalid-descriptor","Texture descriptor invalid");this._descriptor=i}34067===this._descriptor.target?this._setDataCubeMap(i):this.setData(i)}get glName(){return this._glName}get descriptor(){return this._descriptor}get usedMemory(){return h?0:c.estimateMemory(this._descriptor)}get cachedMemory(){return this.usedMemory}get isDirty(){return this._samplingModeDirty||this._wrapModeDirty||this._shadowFilterDirty}get hasWebGLTextureObject(){return!!this._glName}dispose(){this.abortCompression(),this.hasWebGLTextureObject&&this._descriptor.context?.gl&&(this._descriptor.context.instanceCounter.decrement(l.ResourceType.Texture,this),this._descriptor.context.unbindTexture(this),this._descriptor.context.gl.deleteTexture(this._glName),this._glName=null,this._descriptor=null)}release(){this.dispose()}[Symbol.dispose](){this.dispose()}resize(e,r){const i=this._descriptor;if(i.width!==e||i.height!==r){if(this._wasImmutablyAllocated)throw new t("texture:immutable-resize","Immutable textures can't be resized!");i.width=e,i.height=r,34067===this._descriptor.target?this._setDataCubeMap(null):this.setData(null)}}enableCompression(e){this._descriptor.compress=e}disableCompression(){this._descriptor.compress=void 0}setData(e){this.abortCompression(),!u.isCompressedData(e)&&this._descriptor.internalFormat&&n.hasValue(l.CompressedTextureFormat,this._descriptor.internalFormat)&&(this._descriptor.internalFormat=void 0),this._setData(e),!u.isCompressedData(e)&&this._descriptor.compress&&this._compressOnWorker(e)}updateData(r,i,s,n,o,a,l=0){a||p().error("An attempt to use uninitialized data!"),this.hasWebGLTextureObject||p().error("An attempt to update uninitialized texture!");const c=this._descriptor;c.internalFormat=u.deriveInternalFormat(c);const{context:d,pixelFormat:h,dataType:f,target:m,isImmutable:g}=c;if(g&&!this._wasImmutablyAllocated)throw new t("texture:uninitialized","Cannot update immutable texture before allocation!");const y=d.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES,!0);(i<0||s<0||i+n>c.width||s+o>c.height)&&p().error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage();const{gl:_}=d;l&&(n&&o||p().warn("Must pass width and height if `UNPACK_SKIP_ROWS` is used"),_.pixelStorei(_.UNPACK_SKIP_ROWS,l)),u.isTexImageSource(a)?_.texSubImage2D(m,r,i,s,n,o,h,f,a):u.isCompressedData(a)?_.compressedTexSubImage2D(m,r,i,s,n,o,c.internalFormat,a.levels[r]):_.texSubImage2D(m,r,i,s,n,o,h,f,a),l&&_.pixelStorei(_.UNPACK_SKIP_ROWS,0),d.bindTexture(y,e.TEXTURE_UNIT_FOR_UPDATES)}updateData3D(r,i,s,n,o,a,l,c){c||p().error("An attempt to use uninitialized data!"),this.hasWebGLTextureObject||p().error("An attempt to update an uninitialized texture!");const d=this._descriptor;d.internalFormat=u.deriveInternalFormat(d);const{context:h,pixelFormat:f,dataType:m,isImmutable:g,target:y}=d;if(g&&!this._wasImmutablyAllocated)throw new t("texture:uninitialized","Cannot update immutable texture before allocation!");u.is3DTarget(y)||p().warn("Attempting to set 3D texture data on a non-3D texture");const _=h.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES);h.setActiveTexture(e.TEXTURE_UNIT_FOR_UPDATES),(i<0||s<0||n<0||i+o>d.width||s+a>d.height||n+l>d.depth)&&p().error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage();const{gl:b}=h;if(u.isCompressedData(c))c=c.levels[r],b.compressedTexSubImage3D(y,r,i,s,n,o,a,l,d.internalFormat,c);else{const e=c;b.texSubImage3D(y,r,i,s,n,o,a,l,f,m,e)}h.bindTexture(_,e.TEXTURE_UNIT_FOR_UPDATES)}generateMipmap(){const r=this._descriptor;if(0===r.width||0===r.height)return;if(!r.hasMipmap){if(this._wasImmutablyAllocated)throw new t("texture:immutable-change","Cannot add mipmaps to immutable texture after allocation");r.hasMipmap=!0,this._samplingModeDirty=!0,u.validateTexture(r)}9729===r.samplingMode?(this._samplingModeDirty=!0,r.samplingMode=9985):9728===r.samplingMode&&(this._samplingModeDirty=!0,r.samplingMode=9984);const i=this._descriptor.context.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES);this._descriptor.context.setActiveTexture(e.TEXTURE_UNIT_FOR_UPDATES),this._descriptor.context.gl.generateMipmap(r.target),this._descriptor.context.bindTexture(i,e.TEXTURE_UNIT_FOR_UPDATES)}clearMipmap(){const e=this._descriptor;if(e.hasMipmap){if(this._wasImmutablyAllocated)throw new t("texture:immutable-change","Cannot delete mipmaps to immutable texture after allocation");e.hasMipmap=!1,this._samplingModeDirty=!0,u.validateTexture(e)}9985===e.samplingMode?(this._samplingModeDirty=!0,e.samplingMode=9729):9984===e.samplingMode&&(this._samplingModeDirty=!0,e.samplingMode=9728)}setSamplingMode(e){e!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=e,this._samplingModeDirty=!0)}setWrapMode(e){e!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=e,u.validateTexture(this._descriptor),this._wrapModeDirty=!0)}setShadowFiltering(e){e!==this._descriptor.linearFilterDepth&&(this._descriptor.linearFilterDepth=this._descriptor.compareEnabled=e,this.setSamplingMode(e?9729:9728),u.validateTexture(this._descriptor),this._shadowFilterDirty=!0)}applyChanges(){this._samplingModeDirty&&(this._applySamplingMode(),this._samplingModeDirty=!1),this._wrapModeDirty&&(this._applyWrapMode(),this._wrapModeDirty=!1),this._shadowFilterDirty&&(this._applyShadowMode(),this._shadowFilterDirty=!1)}abortCompression(){this._compressionAbortController=s.abortMaybe(this._compressionAbortController)}_setData(r,i){const s=this._descriptor,n=s.context?.gl;if(!n)return;a.checkWebGLError(n),this.hasWebGLTextureObject||(this._glName=n.createTexture(),s.context.instanceCounter.increment(l.ResourceType.Texture,this)),u.validateTexture(s);const o=s.context.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES);s.context.setActiveTexture(e.TEXTURE_UNIT_FOR_UPDATES),this._configurePixelStorage(),a.checkWebGLError(n);const c=i??s.target,d=u.is3DTarget(c);if(u.isTexImageSource(r))this._setDataFromTexImageSource(r,c);else{const{width:e,height:i,depth:o}=s;if(null==e||null==i)throw new t("texture:missing-size","Width and height must be specified!");if(d&&null==o)throw new t("texture:missing-depth","Depth must be specified!");if(s.internalFormat=u.deriveInternalFormat(s),s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(c,s.internalFormat,s.hasMipmap,e,i,o),u.isCompressedData(r)){if(!u.isCompressedFormat(s.internalFormat))throw new t("texture:format-mismatch","Attempting to use compressed data with an uncompressed format!");this._setDataFromCompressedSource(r,s.internalFormat,c)}else this._texImage(c,0,s.internalFormat,e,i,o,r),a.checkWebGLError(n),s.hasMipmap&&this.generateMipmap()}this._applySamplingMode(),this._applyWrapMode(),this._applyAnisotropicFilteringParameters(),this._applyShadowMode(),a.checkWebGLError(n),s.context.bindTexture(o,e.TEXTURE_UNIT_FOR_UPDATES)}_setDataCubeMap(e=null){for(let t=34069;t<=34074;t++)this._setData(e,t)}_configurePixelStorage(){const e=this._descriptor.context.gl,{unpackAlignment:t,flipped:r,preMultiplyAlpha:i}=this._descriptor;e.pixelStorei(e.UNPACK_ALIGNMENT,t),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,r?1:0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i?1:0)}_setDataFromTexImageSource(e,t){const{gl:r}=this._descriptor.context,i=this._descriptor;i.internalFormat=u.deriveInternalFormat(i);const s=u.is3DTarget(t),{width:n,height:o,depth:l}=u.getDimensions(e);i.width&&i.height,i.width||(i.width=n),i.height||(i.height=o),s&&i.depth,s&&(i.depth=l),i.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(t,i.internalFormat,i.hasMipmap,n,o,l),this._texImage(t,0,i.internalFormat,n,o,l,e),a.checkWebGLError(r),i.hasMipmap&&(this.generateMipmap(),a.checkWebGLError(r))}_setDataFromCompressedSource(e,t,r){const i=this._descriptor,{width:s,height:n,depth:o}=i,a=e.levels,l=u.calcMipmapLevels(r,s,n,o),c=Math.min(l,a.length)-1;this._descriptor.context.gl.texParameteri(i.target,33085,c),this._forEachMipmapLevel((e,i,s,n)=>{const o=a[Math.min(e,a.length-1)];this._compressedTexImage(r,e,t,i,s,n,o)},c)}_texStorage(e,r,i,s,n,o){const{gl:a}=this._descriptor.context;if(!u.isSizedPixelFormat(r)&&!u.isSizedDepthFormat(r)&&!u.isSizedDepthStencilFormat(r))throw new t("texture:missing-format","Immutable textures must have a sized internal format");if(!this._descriptor.isImmutable)return;const l=i?u.calcMipmapLevels(e,s,n,o):1;if(u.is3DTarget(e)){if(null==o)throw new t("texture:missing-depth","Missing depth dimension for 3D texture upload");a.texStorage3D(e,l,r,s,n,o)}else a.texStorage2D(e,l,r,s,n);this._wasImmutablyAllocated=!0}_texImage(e,r,i,s,n,o,a){const l=this._descriptor.context.gl,c=u.is3DTarget(e),{isImmutable:d,pixelFormat:h,dataType:p}=this._descriptor;if(d){if(null!=a){const i=a;if(c){if(null==o)throw new t("texture:missing-depth","Missing depth dimension for 3D texture upload");l.texSubImage3D(e,r,0,0,0,s,n,o,h,p,i)}else l.texSubImage2D(e,r,0,0,s,n,h,p,i)}}else{const u=a;if(c){if(null==o)throw new t("texture:missing-depth","Missing depth dimension for 3D texture upload");l.texImage3D(e,r,i,s,n,o,0,h,p,u)}else l.texImage2D(e,r,i,s,n,0,h,p,u)}}_compressedTexImage(e,r,i,s,n,o,a){const l=this._descriptor.context.gl,c=u.is3DTarget(e);if(this._descriptor.isImmutable){if(null!=a)if(c){if(null==o)throw new t("texture:missing-depth","Missing depth dimension for 3D texture upload");l.compressedTexSubImage3D(e,r,0,0,0,s,n,o,i,a)}else l.compressedTexSubImage2D(e,r,0,0,s,n,i,a)}else if(c){if(null==o)throw new t("texture:missing-depth","Missing depth dimension for 3D texture upload");l.compressedTexImage3D(e,r,i,s,n,o,0,a)}else l.compressedTexImage2D(e,r,i,s,n,0,a)}async _compressOnWorker(t){const{width:r,height:i,context:s,flipped:n,preMultiplyAlpha:a,hasMipmap:l}=this._descriptor,c=this._descriptor.compress?.compressionTracker,u=this._descriptor.compress?.compressionCallback,{compressedTextureETC:d,compressedTextureS3TC:h}=s.capabilities;if(!e.compressionWorkerHandle?.isCompressible(t,this._descriptor)||!d&&!h)return;this.abortCompression();const f=new AbortController;this._compressionAbortController=f,c?.increment();try{let s;t instanceof Uint8Array?s=t.buffer:(s=await createImageBitmap(t,{imageOrientation:n?"flipY":"none"}),o.throwIfAborted(f));const c={data:s,width:r,height:i,needsFlip:t instanceof Uint8Array&&this.descriptor.flipped,components:6408===this._descriptor.pixelFormat?4:3,preMultiplyAlpha:a,hasMipmap:l,hasETC:!!d,hasS3TC:!!h},p=await e.compressionWorkerHandle.invoke(c,f.signal,"low");if(o.throwIfAborted(f),p.compressedTexture&&this.hasWebGLTextureObject){const e=this.usedMemory;this._descriptor.internalFormat=p.internalFormat,this._setData(p.compressedTexture),u?.(e-this.usedMemory)}}catch(e){o.isAbortError(e)||p().error("Texture compression failed!")}finally{c?.decrement(),this._compressionAbortController?.signal.aborted&&(this._compressionAbortController=null)}}_forEachMipmapLevel(e,r=1/0){let{width:i,height:s,depth:n,hasMipmap:o,target:a}=this._descriptor;const l=32879===a;if(null==i||null==s||l&&null==n)throw new t("texture:missing-size","Missing texture dimensions for mipmap calculation");for(let t=0;e(t,i,s,n),o&&(1!==i||1!==s||l&&1!==n)&&!(t>=r);++t)i=Math.max(1,i>>1),s=Math.max(1,s>>1),l&&(n=Math.max(1,n>>1))}_applySamplingMode(){const e=this._descriptor,t=e.context?.gl;let r=e.samplingMode,i=e.samplingMode;9985===r||9987===r?(r=9729,e.hasMipmap||(i=9729)):9984!==r&&9986!==r||(r=9728,e.hasMipmap||(i=9728)),t.texParameteri(e.target,t.TEXTURE_MAG_FILTER,r),t.texParameteri(e.target,t.TEXTURE_MIN_FILTER,i)}_applyWrapMode(){const e=this._descriptor,t=e.context?.gl;"number"==typeof e.wrapMode?(t.texParameteri(e.target,t.TEXTURE_WRAP_S,e.wrapMode),t.texParameteri(e.target,t.TEXTURE_WRAP_T,e.wrapMode)):(t.texParameteri(e.target,t.TEXTURE_WRAP_S,e.wrapMode.s),t.texParameteri(e.target,t.TEXTURE_WRAP_T,e.wrapMode.t))}_applyShadowMode(){const e=this._descriptor,t=e.context?.gl,r=e.compareEnabled?t.COMPARE_REF_TO_TEXTURE:t.NONE;t.texParameteri(e.target,t.TEXTURE_COMPARE_MODE,r),e.compareEnabled&&t.texParameteri(e.target,t.TEXTURE_COMPARE_FUNC,t.GREATER),a.checkWebGLError(t)}_applyAnisotropicFilteringParameters(){const e=this._descriptor,t=e.context.capabilities.textureFilterAnisotropic;t&&e.context.gl.texParameterf(e.target,t.TEXTURE_MAX_ANISOTROPY,e.maxAnisotropy??1)}};e.Texture=f,e.tracer=null,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/TextureDescriptor":function(){define(["exports","./enums","./Util"],function(e,t,r){"use strict";e.TextureDescriptor=class{constructor(e=0,r=e){this.width=e,this.height=r,this.type=0,this.target=3553,this.pixelFormat=6408,this.dataType=t.PixelType.UNSIGNED_BYTE,this.samplingMode=9729,this.wrapMode=10497,this.maxAnisotropy=1,this.flipped=!1,this.hasMipmap=!1,this.isOpaque=!1,this.unpackAlignment=4,this.preMultiplyAlpha=!1,this.compareEnabled=!1,this.linearFilterDepth=!1,this.depth=1,this.isImmutable=!1}},e.estimateMemory=function(e){return e.width<=0||e.height<=0||e.depth<=0?0:Math.round(e.width*e.height*e.depth*(e.hasMipmap?4/3:1)*(null==e.internalFormat?4:r.getBytesPerElementFormat(e.internalFormat))*(34067===e.target?6:1))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/textureUtils":function(){define(["exports","../../core/Error","../../core/Logger","../../core/object","./enums"],function(e,t,r,i,s){"use strict";const n=()=>r.getLogger("esri/views/webgl/textureUtils");function o(e){return i.hasValue(s.SizedDepthFormat,e)}function a(e){return i.hasValue(s.SizedDepthStencilFormat,e)}function l(e){return null!=e&&i.hasValue(s.CompressedTextureFormat,e)}function c(e){return null!=e&&"type"in e&&"compressed"===e.type}function u(e){return null!=e&&"byteLength"in e}e.calcMipmapLevels=function(e,t,r,i=1){let s=Math.max(t,r);return 32879===e&&(s=Math.max(s,i)),Math.floor(Math.log2(s))+1},e.deriveInternalFormat=function(e){if(null!=e.internalFormat)return e.internalFormat;switch(e.dataType){case s.PixelType.FLOAT:switch(e.pixelFormat){case 6408:return s.SizedPixelFormat.RGBA32F;case 6407:return s.SizedPixelFormat.RGB32F;default:throw new t("texture:unknown-format","Unable to derive format")}case s.PixelType.UNSIGNED_BYTE:switch(e.pixelFormat){case 6408:return s.SizedPixelFormat.RGBA8;case 6407:return s.SizedPixelFormat.RGB8}}const{pixelFormat:r}=e;return e.internalFormat=34041===r?s.SizedDepthStencilFormat.DEPTH24_STENCIL8:6402===r?s.SizedDepthFormat.DEPTH_COMPONENT24:r,e.internalFormat},e.getDimensions=function(e){let t="width"in e?e.width:e.codedWidth,r="height"in e?e.height:e.codedHeight;return e instanceof HTMLVideoElement&&(t=e.videoWidth,r=e.videoHeight),{width:t,height:r,depth:1}},e.is3DTarget=function(e){return 32879===e||35866===e},e.isArrayBufferView=u,e.isCompressedData=c,e.isCompressedFormat=l,e.isCompressedTexture=function(e){return l(e.descriptor.internalFormat)},e.isSizedDepthFormat=o,e.isSizedDepthStencilFormat=a,e.isSizedPixelFormat=function(e){return s.sizedPixelFormatValues.includes(e)},e.isTexImageSource=function(e){return null!=e&&!c(e)&&!u(e)},e.validateTexture=function(e){const{width:t,height:r,depth:i}=e;(null!=t&&t<0||null!=r&&r<0||null!=i&&i<0)&&n().error("Negative dimension parameters are not allowed!");const{internalFormat:s}=e;if(s&&(o(s)||a(s))){const{linearFilterDepth:t,compareEnabled:r,samplingMode:i,hasMipmap:s}=e;s&&n().error("Depth textures cannot have mipmaps"),t?9729!==i&&9728!==i&&n().error("Depth textures cannot sample mipmaps"):(9728!==i&&n().error("Depth textures without filtering must use NEAREST filtering"),r&&n().error("Depth textures without filtering cannot use compare function"))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/ValidatedTextureDescriptor":function(){define(["exports","./enums","./TextureDescriptor"],function(e,t,r){"use strict";class i extends r.TextureDescriptor{constructor(e,r){switch(super(),this.context=e,Object.assign(this,r),this.internalFormat){case t.SizedPixelFormat.R16F:case t.SizedPixelFormat.R32F:case t.SizedPixelFormat.R8_SNORM:case t.SizedPixelFormat.R8:this.pixelFormat=6403;break;case t.SizedPixelFormat.R8I:case t.SizedPixelFormat.R8UI:case t.SizedPixelFormat.R16I:case t.SizedPixelFormat.R16UI:case t.SizedPixelFormat.R32I:case t.SizedPixelFormat.R32UI:this.pixelFormat=36244}}static validate(e,t){return new i(e,t)}}e.ValidatedTextureDescriptor=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/Scheduler":function(){define(["exports","../../core/arrayUtils","../../core/Handles","../../core/has","../../core/Logger","../../core/maybe","../../core/PerformanceSampler","../../core/promiseUtils","../../core/reactiveUtils","../../core/signal","../../core/time","../../layers/support/PromiseQueue","./debugFlags","./Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const f={RESOURCE_CONTROLLER_IMMEDIATE:"immediate",RESOURCE_CONTROLLER:"schedule",SLIDE:"slide",STREAM_DATA_LOADER:"stream loader",ELEVATION_QUERY:"elevation query",TERRAIN_SURFACE:"terrain",SURFACE_GEOMETRY_UPDATES:"surface geometry updates",LOD_RENDERER:"LoD renderer",GRAPHICS_CORE:"Graphics3D",I3S_CONTROLLER:"I3S",POINT_CLOUD_LAYER:"point cloud",FEATURE_TILE_FETCHER:"feature fetcher",STREAM_CONTROLLER:"stream controller",OVERLAY:"overlay",OVERLAY_RENDERER:"overlay renderer",STAGE:"stage",GRAPHICS_DECONFLICTOR:"graphics deconflictor",FILTER_VISIBILITY:"Graphics3D filter visibility",SCALE_VISIBILITY:"Graphics3D scale visibility",FRUSTUM_VISIBILITY:"Graphics3D frustum visibility",POINT_OF_INTEREST_FREQUENT:"POI frequent",POINT_OF_INTEREST_INFREQUENT:"POI infrequent",LABELER:"labeler",FEATURE_QUERY_ENGINE:"feature query",FEATURE_TILE_TREE:"feature tile tree",FEATURE_TILE_TREE_ACTIVE:"fast feature tile tree",ELEVATION_ALIGNMENT:"elevation alignment",ELEVATION_ALIGNMENT_SCENE:"elevation alignment scene",TEXT_TEXTURE_ATLAS:"text texture atlas",TEXTURE_UNLOAD:"texture unload",LINE_OF_SIGHT_TOOL:"line of sight tool",LINE_OF_SIGHT_TOOL_INTERACTIVE:"interactive line of sight tool",ELEVATION_PROFILE:"elevation profile",SNAPPING:"snapping",SHADOW_ACCUMULATOR:"shadow accumulator",CLOUDS_GENERATOR:"clouds generator",FLOW_GENERATOR:"flow generator",MAPVIEW_FETCH_QUEUE:"mapview fetch queue",MAPVIEW_LAYERVIEW_UPDATE:"mapview layerview update",MAPVIEW_VECTOR_TILE_PARSING_QUEUE:"mapview vector tile parsing queue",NONE:0,TEST_PRIO:1},m=new Map([[f.RESOURCE_CONTROLLER_IMMEDIATE,0],[f.RESOURCE_CONTROLLER,4],[f.SLIDE,0],[f.STREAM_DATA_LOADER,0],[f.ELEVATION_QUERY,0],[f.TERRAIN_SURFACE,1],[f.SURFACE_GEOMETRY_UPDATES,1],[f.LOD_RENDERER,2],[f.GRAPHICS_CORE,2],[f.I3S_CONTROLLER,2],[f.POINT_CLOUD_LAYER,2],[f.FEATURE_TILE_FETCHER,2],[f.STREAM_CONTROLLER,2],[f.CLOUDS_GENERATOR,2],[f.OVERLAY,4],[f.OVERLAY_RENDERER,4],[f.STAGE,4],[f.GRAPHICS_DECONFLICTOR,4],[f.FILTER_VISIBILITY,4],[f.SCALE_VISIBILITY,4],[f.FRUSTUM_VISIBILITY,4],[f.POINT_OF_INTEREST_FREQUENT,6],[f.POINT_OF_INTEREST_INFREQUENT,30],[f.LABELER,8],[f.FEATURE_QUERY_ENGINE,8],[f.FEATURE_TILE_TREE,16],[f.FEATURE_TILE_TREE_ACTIVE,0],[f.ELEVATION_ALIGNMENT,12],[f.ELEVATION_ALIGNMENT_SCENE,14],[f.TEXT_TEXTURE_ATLAS,12],[f.TEXTURE_UNLOAD,12],[f.LINE_OF_SIGHT_TOOL,16],[f.LINE_OF_SIGHT_TOOL_INTERACTIVE,0],[f.SNAPPING,0],[f.SHADOW_ACCUMULATOR,30],[f.FLOW_GENERATOR,12],[f.MAPVIEW_FETCH_QUEUE,0],[f.MAPVIEW_LAYERVIEW_UPDATE,2],[f.MAPVIEW_VECTOR_TILE_PARSING_QUEUE,0]]);function g(e){return m.has(e)?m.get(e):"number"==typeof e?e:1}const y=u.Milliseconds(6.5),_=u.Milliseconds(1),b=u.Milliseconds(30),v=u.Milliseconds(1e3/30),w=u.Milliseconds(100);class x{get updating(){return this._updating.value}_updatingChanged(){this._updating.value=this._tasks.some(e=>e.needsUpdate)}constructor(){this._updating=c.signal(!0),this._microTaskQueued=!1,this._frameNumber=0,this.performanceInfo={total:new o("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=new T,this._state=1,this._tasks=new Array,this._runQueue=new Array,this._load=0,this._idleStateCallbacks=new Array,this._idleUpdatesStartFired=!1,this._forceTask=!1,this._debug=!1,this._debugHandle=l.watch(()=>h.SCHEDULER_LOG_SLOW_TASKS,e=>this._debug=e,l.initial);for(const e of Object.keys(f))this.performanceInfo.tasks.set(f[e],new o(String(f[e])))}destroy(){this._tasks.forEach(e=>e.remove()),this._tasks.length=0,this._idleStateCallbacks.length=0,this._runQueue.length=0,n.removeMaybe(this._debugHandle),this._microTaskQueued=!1,this._updatingChanged()}taskRunningChanged(e){this._updatingChanged(),e&&this._budget.remaining>0&&!this._microTaskQueued&&(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.remaining>0&&this._schedule()&&this._runFrame())}))}registerTask(e,t){const r=new S(this,e,t);return this._tasks.push(r),this._updatingChanged(),this.performanceInfo.tasks.has(e)||this.performanceInfo.tasks.set(e,new o(e)),r}registerIdleStateCallbacks(e,t){const r={idleBegin:e,idleEnd:t};this._idleStateCallbacks.push(r),2===this.state&&this._idleUpdatesStartFired&&r.idleBegin();const i=this;return{remove:()=>this._removeIdleStateCallbacks(r),set idleBegin(e){i._idleUpdatesStartFired&&(r.idleEnd(),2===i._state&&e()),r.idleBegin=e},set idleEnd(e){r.idleEnd=e}}}get load(){return this._load}set state(e){this._state!==e&&(this._state=e,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forEach(e=>e.idleEnd())))}get state(){return this._state}frame(e){this._startFrameTaskTimes();const t=this._updateBudget(e);if(t){const e=this._budget.now();this._runFrame(),this._recordFrameTaskTimes(this._budget.now()-e)}else this._recordFrameTaskTimes(0);return t}_updateBudget(e){this._test&&(this._test.usedBudget=0),++this._frameNumber;let t=y,r=e.frameDuration,i=_;switch(this.state){case 2:t=u.Milliseconds(0),r=u.Milliseconds(Math.max(w,e.frameDuration)),i=b;break;case 1:r=u.Milliseconds(Math.max(v,e.frameDuration))}return r=u.Milliseconds(r-e.elapsedFrameTime-t),2!==this.state&&r<_&&!this._forceTask?(this._forceTask=!0,!1):(r=u.Milliseconds(Math.max(r,i)),this._budget.reset(r),this._updateLoad(),this._schedule())}_runFrame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forEach(e=>e.idleBegin())),this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test&&(this._test.usedBudget=this._budget.elapsed)}stopFrame(){this._budget.reset(u.Milliseconds(0)),this._budget.madeProgress()}_removeIdleStateCallbacks(e){this._idleUpdatesStartFired&&e.idleEnd(),t.removeUnordered(this._idleStateCallbacks,e)}removeTask(e){t.removeUnordered(this._tasks,e),t.removeUnordered(this._runQueue,e),this._updatingChanged()}_updateTask(e){this._tasks.forEach(t=>{t.name===e&&t.setPriority(e)})}_getState(e){if(this._runQueue.some(t=>t.name===e))return"s";let t="i";return this._tasks.forEach(r=>{r.name===e&&r.needsUpdate&&(r.schedulePriority<=1?t="r":"r"!==t&&(t="w"))}),t}_getRuntime(e){let t=0;return this._tasks.forEach(r=>{r.name===e&&(t+=r.runtime)}),t}_resetRuntimes(){this._tasks.forEach(e=>e.runtime=0)}_getRunning(){const e=new Map;if(this._tasks.forEach(t=>{t.needsUpdate&&e.set(t.name,(e.get(t.name)||0)+1)}),0===e.size)return null;let t="";return e.forEach((e,r)=>{t+=e>1?` ${e}x ${r}`:` ${r}`}),t}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const e=this._tasks.reduce((e,t)=>t.needsUpdate?++e:e,0);this._load=.9*this._load+e*(1-.9)}_schedule(){for(t.filterInPlace(this._runQueue,e=>!!e.needsUpdate||(e.schedulePriority=e.basePriority,!1)),this._tasks.forEach(e=>{0===e.basePriority&&e.needsUpdate&&!this._runQueue.includes(e)&&e.blockFrame!==this._frameNumber&&this._runQueue.unshift(e)});0===this._runQueue.length;){let e=!1,t=0;if(this._tasks.forEach(r=>{r.needsUpdate&&0!==r.schedulePriority&&0!==r.basePriority&&r.blockFrame!==this._frameNumber&&(e=!0,t=Math.max(t,r.basePriority),1===r.schedulePriority?(r.schedulePriority=0,this._runQueue.push(r)):--r.schedulePriority)}),!e)return this._updatingChanged(),!1}return this._updatingChanged(),!0}_run(){do{for(;this._runQueue.length>0;){const e=this._budget.now(),t=this._runQueue.pop();this._budget.resetProgress();try{t.task.runTask(this._budget)===p.Yield&&(t.blockFrame=this._frameNumber)}catch(e){s.getLogger("esri.views.support.Scheduler").error(`Exception in task "${t.name}"`,e),t.blockFrame=this._frameNumber}!this._budget.hasProgressed&&t.blockFrame!==this._frameNumber&&t.needsUpdate&&(t.name,t.blockFrame=this._frameNumber),t.schedulePriority=t.basePriority;const r=this._budget.now()-e;if(t.runtime+=r,this._frameTaskTimes.set(t.priority,this._frameTaskTimes.get(t.priority)+r),this._budget.remaining<=0)return void this._updatingChanged()}}while(this._schedule());this._updatingChanged()}_startFrameTaskTimes(){for(const e of Object.keys(f))this._frameTaskTimes.set(f[e],0)}_recordFrameTaskTimes(e){this._frameTaskTimes.forEach((e,t)=>this.performanceInfo.tasks.get(t).push(e)),this.performanceInfo.total.push(e)}get test(){return this._test}}class S{get task(){return this._task.value}get readyToRun(){return this._queue.readyToRun}get updating(){return this._queue.updating}constructor(e,t,i){this._scheduler=e,this.name=t,this.blockFrame=0,this.runtime=0,this._queue=new d.PromiseQueue,this._handles=new r,this._basePriority=g(t),this.schedulePriority=this._basePriority,this._task=c.signal(null!=i?i:this._queue),this._handles.add(l.when(()=>this.task.readyToRun,t=>e.taskRunningChanged(t)))}remove(){this.processQueue(C),this._scheduler.removeTask(this),this.schedule=P.schedule,this.reschedule=P.reschedule,this.scheduleGenerator=P.scheduleGenerator,this.rescheduleGenerator=P.rescheduleGenerator,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(e){if(this.name===e)return;this.name=e;const t=g(e);0!==this._basePriority&&0===this.schedulePriority||(this.schedulePriority=t),this._basePriority=t}get priority(){return this.name}set priority(e){this.setPriority(e)}get needsUpdate(){return this.readyToRun||!this.task.destroyed&&this.task.readyToRun}schedule(e,t,r){return this._queue.push(e,t,r)}reschedule(e,t,r){return this._queue.unshift(e,t,r)}scheduleGenerator(e,t,r){return this._queue.pushGenerator(e,t,r)}rescheduleGenerator(e,t,r){return this._queue.unshiftGenerator(e,t,r)}processQueue(e){return this._queue.runTask(e)}}class T{constructor(){this._begin=performance?.now()??0,this._budget=0,this._done=!1,this._progressed=!1,this._enabled=!0}run(e){return!this.done&&(!0===e()&&this.madeProgress(),!0)}get done(){return this._done}get budget(){return this._budget}madeProgress(){return this._progressed=!0,this._done=this.elapsed>=this._budget&&this._enabled,this._done}get enabled(){return this._enabled}set enabled(e){this._enabled=e}reset(e){this._begin=this.now(),this._budget=e,this.resetProgress()}get remaining(){return Math.max(this._budget-this.elapsed,0)}now(){return performance.now()}get elapsed(){return this.now()-this._begin}resetProgress(){this._progressed=!1,this._done=!1}get hasProgressed(){return this._progressed}}const C=new T;C.enabled=!1;const P=new class{remove(){}processQueue(){}schedule(e,t,r){try{if(a.isAborted(t)){const e=a.createAbortError();return r?Promise.resolve(r(e)):Promise.reject(e)}return a.when(e(C))}catch(e){return Promise.reject(e)}}reschedule(e,t,r){return this.schedule(e,t,r)}async scheduleGenerator(e,t,r){if(a.isAborted(t)){const e=a.createAbortError();if(r)return r(e);throw e}const i=e(C);for(;;){const e=i.next(C),s=a.isPromiseLike(e)?await e:e;if(a.isAborted(t)){const e=a.createAbortError();if(r)return r(e);throw e}if(s.done)return s.value}}rescheduleGenerator(e,t,r){return this.rescheduleGenerator(e,t,r)}};e.ImmediateTask=P,e.TaskPriority=f,e.getTaskPriority=g,e.makeBudget=function(e){const t=new T;return t.reset(e),t},e.newScheduler=function(){return new x},e.noBudget=C,e.taskPriorities=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/PromiseQueue":function(){define(["exports","../../core/compilerUtils","../../core/Logger","../../core/promiseUtils","../../core/signal","../../views/support/Yield"],function(e,t,r,i,s,n){"use strict";function o(e){i.isPromiseLike(e)?e.then(a):a(e)}function a(e){e.done||r.getLogger("esri.layers.support.PromiseQueue").warn("Generator iterator was aborted, but it is not done.")}class l{constructor(e,t,r=void 0,i=void 0){this.resolve=e,this.reject=t,this.signal=r,this.abortCallback=i}}class c extends l{constructor(e,t,r,i,s){super(e,t,i,s),this.callback=r,this.type=0}}class u extends l{constructor(e,t,r,i,s,n){super(e,t,i,s),this.generatorFunction=r,this.scheduleFunction=n,this.type=1}}class d extends l{constructor(e,t,r,i,s,n){super(e,t,i,s),this.iterator=r,this.scheduleFunction=n,this.type=2}}e.PromiseQueue=class{constructor(){this._tasks=new Array,this._numPendingTasks=s.signal(0),this._readyToRun=s.signal(!1)}get length(){return this._tasks.length}get updating(){return this._numPendingTasks.value>0}get readyToRun(){return this._readyToRun.value}_updateReadyToRun(){this._readyToRun.value=this._tasks.length>0}destroy(){this.cancelAll()}runTask(e){if(0===this.length)return n.Yield;for(;!e.done&&this._process(e);)e.madeProgress()}push(e,t,r){return this._addTask((i,s)=>new c(i,s,e,t,r),Array.prototype.push)}unshift(e,t,r){return this._addTask((i,s)=>new c(i,s,e,t,r),Array.prototype.unshift)}pushGenerator(e,t,r){const i=Array.prototype.push;return this._addTask((s,n)=>new u(s,n,e,t,r,i),i)}unshiftGenerator(e,t,r){const i=Array.prototype.unshift;return this._addTask((s,n)=>new u(s,n,e,t,r,i),i)}_process(e){if(0===this._tasks.length)return!1;const r=this._tasks.shift();this._updateReadyToRun();try{if(i.isAborted(r.signal))this._cancelTask(r,i.createAbortError());else switch(r.type){case 0:this._processSimple(r,e);break;case 1:this._processGenerator(r,e);break;case 2:this._processIterator(r,e);break;default:t.neverReached(r)}}catch(e){r.reject(e)}return!0}cancelAll(){const e=i.createAbortError();for(const t of this._tasks)this._cancelTask(t,e);this._tasks.length=0,this._updateReadyToRun()}_cancelTask(e,t){if(e.abortCallback){const r=e.abortCallback(t);2===e.type&&e.iterator.return&&o(e.iterator.return()),i.isPromiseLike(r)?r.then(e.resolve,e.reject):e.resolve(r)}else 2===e.type&&e.iterator.throw&&o(e.iterator.throw(t)),e.reject(t)}_onIteratorResult(e,t){t.done?e.resolve(t.value):(e.scheduleFunction.call(this._tasks,e),this._updateReadyToRun())}_processSimple(e,t){const r=e.callback(t);i.isPromiseLike(r)?r.then(e.resolve,e.reject):e.resolve(r)}_processGenerator(e,t){const r=e.generatorFunction(t),i=new d(e.resolve,e.reject,r,e.signal,e.abortCallback,e.scheduleFunction);this._processIterator(i,t)}_processIterator(e,t){const r=e.iterator.next(t);i.isPromiseLike(r)?r.then(t=>this._onIteratorResult(e,t),e.reject):this._onIteratorResult(e,r)}_addTask(e,t){return new Promise((r,i)=>{const s=e(r,i);t.call(this._tasks,s),++this._numPendingTasks.value,this._updateReadyToRun()}).finally(()=>--this._numPendingTasks.value)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/Yield":function(){define(["exports"],function(e){"use strict";const t=Symbol("Yield");e.Yield=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/debugFlags":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o){"use strict";let a=class extends t{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};return e.__decorate([r.property()],a.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),e.__decorate([r.property()],a.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),a=e.__decorate([o.subclass("esri.views.support.debugFlags")],a),new a})},"esri/views/3d/environment/Precipitation":function(){define(["exports","../../../chunks/tslib.es6","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/ellipsoidUtils","../../../geometry/support/Indices","../webgl","./PrecipitationTechnique","./PrecipitationTechniqueConfiguration","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/effects/TransparentEnvironment","../webgl-engine/lib/VertexArrayObject","../../webgl/enums","../../webgl/Util","../../webgl/VertexAttributeLocations","../../webgl/VertexBuffer"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S){"use strict";e.Precipitation=class extends _.TransparentEnvironment{constructor(e){super(e),this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new f.PrecipitationPassParameters,this._configuration=new m.PrecipitationTechniqueConfiguration;const{view:t,type:r}=e;this._configuration.type="rainy"===r?0:1,t.stage.renderView.techniques.precompile(f.PrecipitationTechnique,this._configuration),this._passParameters.time=0,this._passParameters.radius=d.getReferenceEllipsoid(t.spatialReference).radius,this.addHandles([s.watch(()=>t.environment.weather,e=>{e.type===r&&this.addHandles(s.watch(()=>e.precipitation,e=>this._adjustParticles(e),s.syncAndInitial))},s.syncAndInitial)]),this.addHandles(s.watch(()=>t.stage?.renderer.renderContext.bind.clouds.fadeFactor??1,e=>{this._passParameters.opacity=e,1===e&&(this.removeHandles("opacity"),this.addHandles(s.watch(()=>t.stage?.renderer.renderContext.bind.clouds.opacity??1,e=>this._passParameters.opacity=e,s.syncAndInitial),"opacity"))},s.sync),"opacity")}initialize(){this.addHandles([s.watch(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),s.syncAndInitial)])}_adjustParticles(e){const t=e<.5?r.lerp(0,.35,2*e):r.lerp(.35,1,2*(e-.5));this._numParticles=T*t}destroy(){this._numParticles=0,this._vao=i.disposeMaybe(this._vao),this._instanceIdBuffer=i.disposeMaybe(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles(s.watch(()=>this.renderContext?.bind.clouds.fadeFactor??1,t=>{this._passParameters.opacity=1-t,1===t&&(this.removeAllHandles(),e())}),"opacity")}updateAnimation(e){const t=("rainy"===this.type?this._rainSpeed:this._snowSpeed)*n.secondsFromMilliseconds(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext,r=Math.round(this._numParticles*this._passParameters.opacity),i=e.find(({name:e})=>e===p.InternalRenderCategory.TRANSPARENT_ENVIRONMENT);if(r<1)return i;const s=this.techniques.get(f.PrecipitationTechnique,this._configuration);if(!s.compiled)return this.requestRender(1),i;const n=t.bindTechnique(s,this.bindParameters,this._passParameters);return this._vao??=function(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new b.VertexArrayObject(e,new S.VertexBuffer(e,g.glLayout(C),t))}(t),t.bindVAO(this._vao),this._bindInstanceIdBuffer(n.locations),n.assertCompatibleVertexAttributeLocations(this._vao,x.fromLayout(P)),t.drawArraysInstanced(v.PrimitiveType.TRIANGLES,0,3,r),t.unbindBuffer(34962),i}_bindInstanceIdBuffer(e){const t=this.renderingContext;if(this._instanceIdBuffer)return void t.bindBuffer(this._instanceIdBuffer);const r=h.getContinuousIndexArray(T);this._instanceIdBuffer=new S.VertexBuffer(t,P,new Float32Array(r)),w.bindVertexBufferLayout(t,e,this._instanceIdBuffer,0)}},t.__decorate([o.property({constructOnly:!0})],e.Precipitation.prototype,"type",void 0),e.Precipitation=t.__decorate([u.subclass("esri.views.3d.environment.Precipitation")],e.Precipitation);const T=25e4,C=y.newLayout().vec3f("position").freeze(),P=g.glLayout(y.newLayout().f32("instanceFeatureAttribute"),1);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/Indices":function(){define(["exports","../../core/typedArrayUtil"],function(e,t){"use strict";function r(e,r){if(Array.isArray(e)){if(e.length<t.nativeArrayMaxSize)return e}else if(e.length<t.nativeArrayMaxSize)return Array.from(e);let i=!0,s=!0;return e.some((e,t)=>(i=i&&0===e,s=s&&e===t,!i&&!s)),i?c(e.length):s?o(e.length):t.isTypedArray(e)&&e.BYTES_PER_ELEMENT===Uint16Array.BYTES_PER_ELEMENT?e:function(e,r){for(const i of e){if(i>=65536)return t.isTypedArray(e)?e:new Uint32Array(e);i>=256&&(r=!1)}return r?new Uint8Array(e):new Uint16Array(e)}(e,!r)}let i=a(131072);const s=[0],n=(()=>{const e=new Uint16Array(65536);for(let t=0;t<e.length;++t)e[t]=t;return e})();function o(e){return 1===e?s:e<t.nativeArrayMaxSize?Array.from(new Uint16Array(n.buffer,0,e)):e<n.length?new Uint16Array(n.buffer,0,e):(e>i.length&&(i=a(Math.max(2*i.length,e))),new Uint32Array(i.buffer,0,e))}function a(e){const t=new Uint32Array(e);for(let e=0;e<t.length;e++)t[e]=e;return t}let l=new Uint8Array(65536);function c(e){if(1===e)return s;if(e<t.nativeArrayMaxSize)return new Array(e).fill(0);if(e>l.length){const t=Math.max(2*l.length,e);l=new Uint8Array(t)}return new Uint8Array(l.buffer,0,e)}e.compactIndices=r,e.compactMeshIndices=function(e){return r(e,!0)},e.getContinuousIndexArray=o,e.getZeroIndexArray=c,e.newIndexArray=function(e){return e<=t.nativeArrayMaxSize?new Array(e):e<=65536?new Uint16Array(e):new Uint32Array(e)},e.newIntArray=function(e){return e<=t.nativeArrayMaxSize?new Array(e):new Uint32Array(e)},e.pruneIndexArrays=function(){i=a(131072),l=new Uint8Array(65536)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/PrecipitationTechnique":function(){define(["require","exports","../../../chunks/Precipitation.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../../webgl/NoParameters","../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends n.NoParameters{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}}class l extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.Precipitation,()=>new Promise((t,r)=>e(["./Precipitation.glsl"],t,r))),new Map([["position",0],["instanceFeatureAttribute",1]]))}initializePipeline(){return o.makePipelineState({blending:o.premultipliedAlpha,depthTest:{func:515},colorWrite:o.defaultColorWrite})}}t.PrecipitationPassParameters=a,t.PrecipitationTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/Precipitation.glsl":function(){define(["exports","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4BindUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l){"use strict";function c(e){const r=new l.ShaderBuilder;return r.attributes.add("position","vec3"),r.attributes.add("instanceFeatureAttribute","float"),r.vertex.uniforms.add(new i.Float3BindUniform("cameraPosition",e=>e.camera.eye),new s.Float3PassUniform("offset",(e,r)=>function(e,r){const i=r.camera.eye,s=.5*e.width,n=1/e.width,o=t.floor(u,t.set(u,(i[0]+s)*n,(i[1]+s)*n,(i[2]+s)*n));return t.sub(o,i,t.scale(o,o,e.width))}(e,r)),new n.FloatPassUniform("width",e=>e.width),new n.FloatPassUniform("time",e=>e.time),new a.Matrix4BindUniform("proj",e=>e.camera.projectionMatrix),new a.Matrix4BindUniform("view",e=>e.camera.viewMatrix)),r.varyings.add("vUv","vec2"),r.vertex.code.add(o.glsl`vec3 hash31(float p){
vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yzx + 33.33);
return fract((p3.xxy + p3.yzz) * p3.zyx);
}
float hash11(float p){
p = fract(p * 0.1031);
p *= p + 33.33;
p *= p + p;
return fract(p);
}
vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
}`),r.vertex.main.add(o.glsl`
      vUv = position.xz;
      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundredths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${0===e.type?o.glsl`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:o.glsl`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
  `),r.fragment.uniforms.add(new n.FloatPassUniform("opacity",e=>e.opacity),new i.Float3BindUniform("particleColor",r=>function(e,r){const i=0===r.type?p:h,s=t.scale(u,i,f),n=e.camera.eye;t.normalize(d,n);const o=Math.max(0,t.dot(d,e.lighting.mainLight.direction));return t.lerp(s,s,i,o)}(r,e))),r.fragment.main.add(o.glsl`
    float d = length(vUv - vec2(0.5));

    ${0===e.type?o.glsl`d = 0.35 * smoothstep(0.5, 0.0, d);`:o.glsl`d = smoothstep(0.5, 0.1, d);`}
    fragColor = opacity * vec4(particleColor * d, d);
  `),r}const u=r.create(),d=r.create(),h=r.fromValues(1,1,1),p=r.fromValues(.85,.85,.85),f=.7,m=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}));e.Precipitation=m,e.build=c})},"esri/views/3d/webgl-engine/core/shaderModules/Float3BindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"vec3",0,(i,s)=>i.setUniform3fv(e,t(s),r))}}e.Float3BindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Float3PassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"vec3",1,(i,s,n)=>i.setUniform3fv(e,t(s,n),r))}}e.Float3PassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Matrix4BindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"mat4",0,(i,s)=>i.setUniformMatrix4fv(e,t(s),r))}}e.Matrix4BindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/PrecipitationTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.type=0}}t.__decorate([r.parameter({count:2})],i.prototype,"type",void 0),e.PrecipitationTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/buffer/glUtil":function(){define(["exports","../../../../core/has","../../../webgl/enums","../../../webgl/VertexElementDescriptor"],function(e,t,r,i){"use strict";e.glLayout=function(e,t=0){const s=e.stride;return Array.from(e.fields.keys()).map(n=>{const o=e.fields.get(n),a=o.constructor.ElementCount,l=function(e){switch(e){case"u8":return r.DataType.UNSIGNED_BYTE;case"u16":return r.DataType.UNSIGNED_SHORT;case"u32":return r.DataType.UNSIGNED_INT;case"i8":return r.DataType.BYTE;case"i16":return r.DataType.SHORT;case"i32":return r.DataType.INT;case"f16":return r.DataType.HALF_FLOAT;case"f32":return r.DataType.FLOAT;default:throw new Error("BufferType not supported in WebGL")}}(o.constructor.ElementType),c=o.offset,u=o.optional?.glNormalized??!1;return new i.VertexElementDescriptor(n,a,l,c,s,u,t)})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/buffer/InterleavedLayout":function(){define(["exports","../../../../geometry/support/float16","../../../../geometry/support/buffer/BufferView","../../../../geometry/support/buffer/types","./glUtil","../../webgl-engine/lib/Util","../../../webgl/VertexAttributeLocations"],function(e,t,r,i,s,n,o){"use strict";class a{constructor(e,t){this.layout=e,this.buffer="number"==typeof t?new ArrayBuffer(t*e.stride):t;for(const t of e.fields.keys()){const r=e.fields.get(t);this[t]=new r.constructor(this.buffer,r.offset,this.stride)}}get stride(){return this.layout.stride}get count(){return this.buffer.byteLength/this.stride}get byteLength(){return this.buffer.byteLength}getField(e,t){const r=this[e];return r&&r.elementCount===t.ElementCount&&r.elementType===t.ElementType?r:null}slice(e,t){return new a(this.layout,this.buffer.slice(e*this.stride,t*this.stride))}copyFrom(e,t=0,r=0,i=e.count){const s=this.stride;if(s%4==0){const n=new Uint32Array(e.buffer,t*s,i*s/4);new Uint32Array(this.buffer,r*s,i*s/4).set(n)}else{const n=new Uint8Array(e.buffer,t*s,i*s);new Uint8Array(this.buffer,r*s,i*s).set(n)}return this}get cachedMemory(){return this.byteLength}dispose(){}}class l{constructor(e){this._stride=0,this._fields=new Map,e&&(this._stride=e.stride,e.fields.forEach(e=>{return this._fields.set(e[0],{...e[1],constructor:(t=e[1].constructor,d.get(t))});var t}))}freeze(){return this}get locations(){return o.fromLayout(s.glLayout(this))}vec2f16(e,i){return this._appendField(e,t.hasNativeFloat16Array?r.BufferViewVec2f16:r.BufferViewVec2f,i),this}vec2f(e,t){return this._appendField(e,r.BufferViewVec2f,t),this}vec2f64(e,t){return this._appendField(e,r.BufferViewVec2f64,t),this}vec3f16(e,i){return this._appendField(e,t.hasNativeFloat16Array?r.BufferViewVec3f16:r.BufferViewVec3f,i),this}vec3f(e,t){return this._appendField(e,r.BufferViewVec3f,t),this}vec3f64(e,t){return this._appendField(e,r.BufferViewVec3f64,t),this}vec4f16(e,i){return this._appendField(e,t.hasNativeFloat16Array?r.BufferViewVec4f16:r.BufferViewVec4f,i),this}vec4f(e,t){return this._appendField(e,r.BufferViewVec4f,t),this}vec4f64(e,t){return this._appendField(e,r.BufferViewVec4f64,t),this}mat3f(e,t){return this._appendField(e,r.BufferViewMat3f,t),this}mat3f64(e,t){return this._appendField(e,r.BufferViewMat3f64,t),this}mat4f(e,t){return this._appendField(e,r.BufferViewMat4f,t),this}mat4f64(e,t){return this._appendField(e,r.BufferViewMat4f64,t),this}vec4u8(e,t){return this._appendField(e,r.BufferViewVec4u8,t),this}f16(e,i){return this._appendField(e,t.hasNativeFloat16Array?r.BufferViewFloat16:r.BufferViewFloat,i),this}f32(e,t){return this._appendField(e,r.BufferViewFloat,t),this}f64(e,t){return this._appendField(e,r.BufferViewFloat64,t),this}u8(e,t){return this._appendField(e,r.BufferViewUint8,t),this}u16(e,t){return this._appendField(e,r.BufferViewUint16,t),this}i8(e,t){return this._appendField(e,r.BufferViewInt8,t),this}vec2i8(e,t){return this._appendField(e,r.BufferViewVec2i8,t),this}vec2i16(e,t){return this._appendField(e,r.BufferViewVec2i16,t),this}vec2u8(e,t){return this._appendField(e,r.BufferViewVec2u8,t),this}vec2u16(e,t){return this._appendField(e,r.BufferViewVec2u16,t),this}vec4u16(e,t){return this._appendField(e,r.BufferViewVec4u16,t),this}u32(e,t){return this._appendField(e,r.BufferViewUint32,t),this}_appendField(e,t,r){this._fields.has(e)&&n.assert(!1,`${e} already added to vertex buffer layout`);const s=t.ElementCount*i.elementTypeSize(t.ElementType),o=this._stride;this._fields.set(e,{constructor:t,size:s,offset:o,optional:r}),this._alignFields()}_alignFields(){let e=0,t=1;this._fields.forEach(r=>{const s=i.elementTypeSize(r.constructor.ElementType);e=Math.floor((e+s-1)/s)*s,r.offset=e,e+=r.size,t=Math.max(t,s)}),e=Math.floor((e+t-1)/t)*t,this._stride=e}createBuffer(e){return new a(this,e)}createView(e){return new a(this,e)}clone(){const e=new l;return e._stride=this._stride,e._fields=new Map,this._fields.forEach((t,r)=>e._fields.set(r,t)),e.BufferType=this.BufferType,e}get stride(){return this._stride}get fields(){return this._fields}}const c=[r.BufferViewFloat,r.BufferViewVec2f,r.BufferViewVec3f,r.BufferViewVec4f,r.BufferViewMat3f,r.BufferViewMat4f,r.BufferViewFloat64,r.BufferViewVec2f64,r.BufferViewVec3f64,r.BufferViewVec4f64,r.BufferViewMat3f64,r.BufferViewMat4f64,r.BufferViewUint8,r.BufferViewVec2u8,r.BufferViewVec3u8,r.BufferViewVec4u8,r.BufferViewUint16,r.BufferViewVec2u16,r.BufferViewVec3u16,r.BufferViewVec4u16,r.BufferViewUint32,r.BufferViewVec2u32,r.BufferViewVec3u32,r.BufferViewVec4u32,r.BufferViewInt8,r.BufferViewVec2i8,r.BufferViewVec3i8,r.BufferViewVec4i8,r.BufferViewInt16,r.BufferViewVec2i16,r.BufferViewVec3i16,r.BufferViewVec4i16,r.BufferViewInt32,r.BufferViewVec2i32,r.BufferViewVec3i32,r.BufferViewVec4i32];function u(e){return`${e.ElementType}_${e.ElementCount}`}const d=new Map;c.forEach(e=>d.set(u(e),e)),e.InterleavedBuffer=a,e.InterleavedLayout=l,e.PackedLayout=class{constructor(e){this.fields=new Array,e.fields.forEach((e,t)=>{const r={...e,constructor:u(e.constructor)};this.fields.push([t,r])}),this.stride=e.stride}},e.newLayout=function(){return new l},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/float16":function(){define(["exports"],function(e){"use strict";let t=globalThis.Float16Array;e.hasNativeFloat16Array=!!t,e.disableNativeF16Array=function(){t=null,e.hasNativeFloat16Array=!1},e.getFloat16ArrayConstructor=function(){return t},e.makeFloat16Array=function(...e){return new(t??Float32Array)(...e)},e.resetNativeF16Array=function(){t=globalThis.Float16Array,e.hasNativeFloat16Array=!!t},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/buffer/BufferView":function(){define(["exports","../float16","./internals/Mat3","./internals/Mat4","./internals/Scalar","./internals/Vec2","./internals/Vec3","./internals/Vec4","../../../views/3d/webgl-engine/lib/Util"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends s.BufferViewScalarImpl{constructor(e,r=0,i,s){l.assert(t.hasNativeFloat16Array),super(t.getFloat16ArrayConstructor(),e,r,i,s),this.elementType="f16"}static{this.ElementType="f16"}}class u extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}static{this.ElementType="f32"}}class d extends n.BufferViewVec2Impl{constructor(e,r=0,i,s){l.assert(t.hasNativeFloat16Array),super(t.getFloat16ArrayConstructor(),e,r,i,s),this.elementType="f16"}slice(e,t){return this.sliceBuffer(d,e,t)}static{this.ElementType="f16"}}class h extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}slice(e,t){return this.sliceBuffer(h,e,t)}static{this.ElementType="f32"}}class p extends o.BufferViewVec3Impl{constructor(e,r=0,i,s){l.assert(t.hasNativeFloat16Array),super(t.getFloat16ArrayConstructor(),e,r,i,s),this.elementType="f16"}slice(e,t){return this.sliceBuffer(p,e,t)}static{this.ElementType="f16"}}class f extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}slice(e,t){return this.sliceBuffer(f,e,t)}static fromTypedArray(e,t){return new f(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}static{this.ElementType="f32"}}class m extends a.BufferViewVec4Impl{constructor(e,r=0,i,s){l.assert(t.hasNativeFloat16Array),super(t.getFloat16ArrayConstructor(),e,r,i,s),this.elementType="f16"}slice(e,t){return this.sliceBuffer(m,e,t)}static{this.ElementType="f16"}}class g extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}slice(e,t){return this.sliceBuffer(g,e,t)}static{this.ElementType="f32"}}class y extends r.BufferViewMat3Impl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}slice(e,t){return this.sliceBuffer(y,e,t)}static{this.ElementType="f32"}}class _ extends r.BufferViewMat3Impl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(_,e,t)}static{this.ElementType="f64"}}class b extends i.BufferViewMat4Impl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}slice(e,t){return this.sliceBuffer(b,e,t)}static{this.ElementType="f32"}}class v extends i.BufferViewMat4Impl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(v,e,t)}static{this.ElementType="f64"}}class w extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(w,e,t)}static{this.ElementType="f64"}}class x extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(x,e,t)}static{this.ElementType="f64"}}class S extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(S,e,t)}static fromTypedArray(e,t){return new S(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}static{this.ElementType="f64"}}class T extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(T,e,t)}static{this.ElementType="f64"}}class C extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Uint8Array,e,t,r,i),this.elementType="u8"}slice(e,t){return this.sliceBuffer(C,e,t)}static{this.ElementType="u8"}}class P extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Uint8Array,e,t,r,i),this.elementType="u8"}slice(e,t){return this.sliceBuffer(P,e,t)}static{this.ElementType="u8"}}class M extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Uint8Array,e,t,r,i),this.elementType="u8"}slice(e,t){return this.sliceBuffer(M,e,t)}static fromTypedArray(e,t){return new M(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}static{this.ElementType="u8"}}class R extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Uint8Array,e,t,r,i),this.elementType="u8"}slice(e,t){return this.sliceBuffer(R,e,t)}static{this.ElementType="u8"}}class O extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Uint16Array,e,t,r,i),this.elementType="u16"}slice(e,t){return this.sliceBuffer(O,e,t)}static{this.ElementType="u16"}}class I extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Uint16Array,e,t,r,i),this.elementType="u16"}slice(e,t){return this.sliceBuffer(I,e,t)}static{this.ElementType="u16"}}class F extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Uint16Array,e,t,r,i),this.elementType="u16"}slice(e,t){return this.sliceBuffer(F,e,t)}static{this.ElementType="u16"}}class A extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Uint16Array,e,t,r,i),this.elementType="u16"}slice(e,t){return this.sliceBuffer(A,e,t)}static{this.ElementType="u16"}}class D extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Uint32Array,e,t,r,i),this.elementType="u32"}slice(e,t){return this.sliceBuffer(D,e,t)}static{this.ElementType="u32"}}class E extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Uint32Array,e,t,r,i),this.elementType="u32"}slice(e,t){return this.sliceBuffer(E,e,t)}static{this.ElementType="u32"}}class L extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Uint32Array,e,t,r,i),this.elementType="u32"}slice(e,t){return this.sliceBuffer(L,e,t)}static{this.ElementType="u32"}}class V extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Uint32Array,e,t,r,i),this.elementType="u32"}slice(e,t){return this.sliceBuffer(V,e,t)}static{this.ElementType="u32"}}class U extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Int8Array,e,t,r,i),this.elementType="i8"}slice(e,t){return this.sliceBuffer(U,e,t)}static{this.ElementType="i8"}}class B extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Int8Array,e,t,r,i),this.elementType="i8"}slice(e,t){return this.sliceBuffer(B,e,t)}static{this.ElementType="i8"}}class N extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Int8Array,e,t,r,i),this.elementType="i8"}slice(e,t){return this.sliceBuffer(N,e,t)}static{this.ElementType="i8"}}class k extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Int8Array,e,t,r,i),this.elementType="i8"}slice(e,t){return this.sliceBuffer(k,e,t)}static{this.ElementType="i8"}}class z extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Int16Array,e,t,r,i),this.elementType="i16"}slice(e,t){return this.sliceBuffer(z,e,t)}static{this.ElementType="i16"}}class j extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Int16Array,e,t,r,i),this.elementType="i16"}slice(e,t){return this.sliceBuffer(j,e,t)}static{this.ElementType="i16"}}class G extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Int16Array,e,t,r,i),this.elementType="i16"}slice(e,t){return this.sliceBuffer(G,e,t)}static{this.ElementType="i16"}}class q extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Int16Array,e,t,r,i),this.elementType="i16"}slice(e,t){return this.sliceBuffer(q,e,t)}static{this.ElementType="i16"}}class H extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Int32Array,e,t,r,i),this.elementType="i32"}slice(e,t){return this.sliceBuffer(H,e,t)}static{this.ElementType="i32"}}class W extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Int32Array,e,t,r,i),this.elementType="i32"}slice(e,t){return this.sliceBuffer(W,e,t)}static{this.ElementType="i32"}}class $ extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Int32Array,e,t,r,i),this.elementType="i32"}slice(e,t){return this.sliceBuffer($,e,t)}static{this.ElementType="i32"}}class Q extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Int32Array,e,t,r,i),this.elementType="i32"}slice(e,t){return this.sliceBuffer(Q,e,t)}static{this.ElementType="i32"}}e.BufferViewFloat=u,e.BufferViewFloat16=c,e.BufferViewFloat64=w,e.BufferViewInt16=z,e.BufferViewInt32=H,e.BufferViewInt8=U,e.BufferViewMat3f=y,e.BufferViewMat3f64=_,e.BufferViewMat4f=b,e.BufferViewMat4f64=v,e.BufferViewUint16=O,e.BufferViewUint32=D,e.BufferViewUint8=C,e.BufferViewVec2f=h,e.BufferViewVec2f16=d,e.BufferViewVec2f64=x,e.BufferViewVec2i16=j,e.BufferViewVec2i32=W,e.BufferViewVec2i8=B,e.BufferViewVec2u16=I,e.BufferViewVec2u32=E,e.BufferViewVec2u8=P,e.BufferViewVec3f=f,e.BufferViewVec3f16=p,e.BufferViewVec3f64=S,e.BufferViewVec3i16=G,e.BufferViewVec3i32=$,e.BufferViewVec3i8=N,e.BufferViewVec3u16=F,e.BufferViewVec3u32=L,e.BufferViewVec3u8=M,e.BufferViewVec4f=g,e.BufferViewVec4f16=m,e.BufferViewVec4f64=T,e.BufferViewVec4i16=q,e.BufferViewVec4i32=Q,e.BufferViewVec4i8=k,e.BufferViewVec4u16=A,e.BufferViewVec4u32=V,e.BufferViewVec4u8=R,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/buffer/internals/Mat3":function(){define(["exports"],function(e){"use strict";class t{static{this.ElementCount=9}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.elementCount=9;const n=this.TypedArrayConstructor;void 0===i&&(i=9*n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}getMat(e,t){let r=e*this.typedBufferStride;for(let e=0;e<9;e++)t[e]=this.typedBuffer[r++];return t}setMat(e,t){let r=e*this.typedBufferStride;for(let e=0;e<9;e++)this.typedBuffer[r++]=t[e]}get(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}set(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}copyFrom(e,t,r){const i=this.typedBuffer,s=t.typedBuffer;let n=e*this.typedBufferStride,o=r*t.typedBufferStride;for(let e=0;e<9;++e)i[n++]=s[o++]}get buffer(){return this.typedBuffer.buffer}}e.BufferViewMat3Impl=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/buffer/internals/Mat4":function(){define(["exports"],function(e){"use strict";class t{static{this.ElementCount=16}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.elementCount=16;const n=this.TypedArrayConstructor;void 0===i&&(i=16*n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}getMat(e,t){let r=e*this.typedBufferStride;for(let e=0;e<16;e++)t[e]=this.typedBuffer[r++];return t}setMat(e,t){let r=e*this.typedBufferStride;for(let e=0;e<16;e++)this.typedBuffer[r++]=t[e]}get(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}set(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}copyFrom(e,t,r){this.copyFromTypedBuffer(e,t.typedBuffer,r*t.typedBufferStride)}copyFromTypedBuffer(e,t,r){const i=this.typedBuffer;let s=e*this.typedBufferStride;for(let e=0;e<16;++e)i[s++]=t[r++]}get buffer(){return this.typedBuffer.buffer}}e.BufferViewMat4Impl=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/buffer/internals/Scalar":function(){define(["exports"],function(e){"use strict";class t{static{this.ElementCount=1}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.elementCount=1;const n=this.TypedArrayConstructor;void 0===i&&(i=n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.stride=i,this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride)}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}get(e){return this.typedBuffer[e*this.typedBufferStride]}set(e,t){this.typedBuffer[e*this.typedBufferStride]=t}get buffer(){return this.typedBuffer.buffer}}e.BufferViewScalarImpl=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/buffer/internals/Vec2":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/vec2"],function(e,t){"use strict";class r{static{this.ElementCount=2}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.start=r,this.elementCount=2;const n=this.TypedArrayConstructor;void 0===i&&(i=2*n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}getVec(e,r){return e*=this.typedBufferStride,t.set(r,this.typedBuffer[e],this.typedBuffer[e+1])}setVec(e,t){e*=this.typedBufferStride,this.typedBuffer[e++]=t[0],this.typedBuffer[e]=t[1]}get(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}set(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}setValues(e,t,r){e*=this.typedBufferStride,this.typedBuffer[e++]=t,this.typedBuffer[e]=r}copyFrom(e,t,r){const i=this.typedBuffer,s=t.typedBuffer;let n=e*this.typedBufferStride,o=r*t.typedBufferStride;i[n++]=s[o++],i[n]=s[o]}get buffer(){return this.typedBuffer.buffer}}e.BufferViewVec2Impl=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/buffer/internals/Vec3":function(){define(["exports","../../../../chunks/vec32"],function(e,t){"use strict";class r{static{this.ElementCount=3}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.elementCount=3;const n=this.TypedArrayConstructor;void 0===i&&(i=3*n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}getVec(e,r){return e*=this.typedBufferStride,t.set(r,this.typedBuffer[e],this.typedBuffer[e+1],this.typedBuffer[e+2])}setVec(e,t){e*=this.typedBufferStride,this.typedBuffer[e++]=t[0],this.typedBuffer[e++]=t[1],this.typedBuffer[e]=t[2]}get(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}set(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}setValues(e,t,r,i){e*=this.typedBufferStride,this.typedBuffer[e++]=t,this.typedBuffer[e++]=r,this.typedBuffer[e]=i}copyFrom(e,t,r){const i=this.typedBuffer,s=t.typedBuffer;let n=e*this.typedBufferStride,o=r*t.typedBufferStride;i[n++]=s[o++],i[n++]=s[o++],i[n]=s[o]}get buffer(){return this.typedBuffer.buffer}}e.BufferViewVec3Impl=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/buffer/internals/Vec4":function(){define(["exports","../../../../chunks/vec42"],function(e,t){"use strict";class r{static{this.ElementCount=4}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.start=r,this.elementCount=4;const n=this.TypedArrayConstructor;void 0===i&&(i=4*n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}getVec(e,r){return e*=this.typedBufferStride,t.set(r,this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e])}setVec(e,t){e*=this.typedBufferStride,this.typedBuffer[e++]=t[0],this.typedBuffer[e++]=t[1],this.typedBuffer[e++]=t[2],this.typedBuffer[e]=t[3]}get(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}set(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}setValues(e,t,r,i,s){e*=this.typedBufferStride,this.typedBuffer[e++]=t,this.typedBuffer[e++]=r,this.typedBuffer[e++]=i,this.typedBuffer[e]=s}copyFrom(e,t,r){const i=this.typedBuffer,s=t.typedBuffer;let n=e*this.typedBufferStride,o=r*t.typedBufferStride;i[n++]=s[o++],i[n++]=s[o++],i[n++]=s[o++],i[n]=s[o]}get buffer(){return this.typedBuffer.buffer}}e.BufferViewVec4Impl=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Util":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64"],function(e,t,r,i){"use strict";const s=i.create();class n{constructor(e){this.message=e}toString(){return`AssertException: ${this.message}`}}function o(e,t="Assertion"){if(!e){const e=new Error(t).stack;throw new n(`${t} at ${e}`)}}e.assert=o,e.isTranslationMatrix=function(e){return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&1===e[15]},e.logWithBase=function(e,t){return Math.log(e)/Math.log(t)},e.project=function(e,t,i,n,a){s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1,r.transformMat4(s,s,t),a.length>2&&(a[2]=-s[2]),r.transformMat4(s,s,i),o(0!==s[3]),a[0]=s[0]/s[3],a[1]=s[1]/s[3],a[2]=s[2]/s[3],a[0]=(.5*a[0]+.5)*n[2]+n[0],a[1]=(.5*a[1]+.5)*n[3]+n[1]},e.rayBoxTest=function(e,t,r,i){let s,n=(r[0]-e[0])/t[0],o=(i[0]-e[0])/t[0];n>o&&(s=n,n=o,o=s);let a=(r[1]-e[1])/t[1],l=(i[1]-e[1])/t[1];if(a>l&&(s=a,a=l,l=s),n>l||a>o)return!1;a>n&&(n=a),l<o&&(o=l);let c=(r[2]-e[2])/t[2],u=(i[2]-e[2])/t[2];return c>u&&(s=c,c=u,u=s),!(n>u||c>o||(u<o&&(o=u),o<0))},e.rayRay2D=function(e,r,i,s,n,o=t.create()){const a=(s[n]-i[n])*(r[0]-e[0])-(s[0]-i[0])*(r[n]-e[n]),l=(s[0]-i[0])*(e[n]-i[n])-(s[n]-i[n])*(e[0]-i[0]);if(0===a)return!1;const c=l/a;return o[0]=e[0]+c*(r[0]-e[0]),o[1]=e[n]+c*(r[n]-e[n]),!0},e.setMatrixTranslation3=function(e,t,r,i){e[12]=t,e[13]=r,e[14]=i},e.verify=function(e,t){e||(t=t||"",console.warn("Verify failed: "+t+"\n"+new Error("verify").stack))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/buffer/types":function(){define(["exports"],function(e){"use strict";e.elementTypeSize=function(e){switch(e){case"u8":case"i8":return 1;case"u16":case"i16":case"f16":return 2;case"u32":case"i32":case"f32":return 4;case"f64":return 8}},e.isInteger=function(e){switch(e){case"u8":case"u16":case"u32":case"i8":case"i16":case"i32":return!0;case"f16":case"f32":case"f64":return!1}},e.isSigned=function(e){switch(e){case"u8":case"u16":case"u32":return!1;case"i8":case"i16":case"i32":case"f16":case"f32":case"f64":return!0}},e.maximumValue=function(e){switch(e){case"u8":return 255;case"u16":return 65535;case"u32":return 4294967295;case"i8":return 127;case"i16":return 32767;case"i32":return 2147483647;case"f16":return 65504;case"f32":return 3402823e32;case"f64":return 179769e303}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/TransparentEnvironment":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../webgl","./OpaqueEnvironment"],function(e,t,r,i,s,n,o,a,l){"use strict";e.TransparentEnvironment=class extends l.OpaqueEnvironment{constructor(){super(...arguments),this.consumes={required:[a.InternalRenderCategory.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=a.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,this.requestRender(1)}},t.__decorate([r.property()],e.TransparentEnvironment.prototype,"consumes",void 0),e.TransparentEnvironment=t.__decorate([o.subclass("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],e.TransparentEnvironment),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/OpaqueEnvironment":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../webgl","../../webgl/RenderNode"],function(e,t,r,i,s,n,o,a,l){"use strict";e.OpaqueEnvironment=class extends l{constructor(){super(...arguments),this.produces="disabled",this.consumes={required:[a.InternalRenderCategory.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=a.InternalRenderCategory.OPAQUE_ENVIRONMENT,this.requestRender(1)}_disable(){this.produces="disabled",this.requestRender(1)}},t.__decorate([r.property()],e.OpaqueEnvironment.prototype,"produces",void 0),t.__decorate([r.property()],e.OpaqueEnvironment.prototype,"consumes",void 0),e.OpaqueEnvironment=t.__decorate([o.subclass("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],e.OpaqueEnvironment),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl/RenderNode":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Error","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../webgl"],function(e,t,r,i,s,n,o,a){"use strict";return e.default=class extends r{constructor(e){super(e),this.view=null,this.consumes={required:[]},this.produces=a.RenderCategory.COMPOSITE,this.requireGeometryDepth=!1,this._dirty=!0}initialize(){this.addHandles([s.watch(()=>this.view.ready,e=>{e&&this.view.stage?.renderer.addRenderNode(this)},s.initial)])}destroy(){this.view.stage?.renderer?.removeRenderNode(this)}precompile(){}render(){throw new i("RenderNode:render-function-not-implemented","render() is not implemented.")}get camera(){return this.view.state.camera.clone()}get sunLight(){return this.bindParameters.lighting.legacy}get gl(){return this.view.stage.renderView.renderingContext.gl}get techniques(){return this.view.stage.renderView.techniques}acquireOutputFramebuffer(){const e=this._frameBuffer?.getTexture()?.descriptor,t=this.view.stage.renderer.fboCache.acquire(e?.width??640,e?.height??480,this.produces);return t.fbo?.initializeAndBind(),t}bindRenderTarget(){return this._frameBuffer?.fbo?.initializeAndBind(),this._frameBuffer}requestRender(e){1===e&&this.view.stage?.renderView.requestRender(e),this._dirty=!0}resetWebGLState(){this.renderingContext.resetState(),this.renderingContext.bindFramebuffer(this._frameBuffer?.fbo)}get fboCache(){return this.view.stage.renderer.fboCache}get bindParameters(){return this.renderContext.bind}get renderingContext(){return this.view.stage.renderView.renderingContext}get renderContext(){return this.view.stage?.renderer.renderContext}updateAnimation(e){return!!this._dirty&&(this._dirty=!1,!0)}doRender(e){this._frameBuffer=e.find(({name:e})=>e===this.produces);try{return this.render(e)}finally{this._frameBuffer=null}}},t.__decorate([n.property({constructOnly:!0})],e.default.prototype,"view",void 0),t.__decorate([n.property({constructOnly:!0})],e.default.prototype,"consumes",void 0),t.__decorate([n.property()],e.default.prototype,"produces",void 0),t.__decorate([n.property({readOnly:!0})],e.default.prototype,"techniques",null),e.default=t.__decorate([o.subclass("esri.views.3d.webgl.RenderNode")],e.default),e.default})},"esri/views/3d/webgl-engine/lib/VertexArrayObject":function(){define(["exports","../../../webgl/VertexArrayObject"],function(e,t){"use strict";class r extends t.VertexArrayObject{}e.VertexArrayObject=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/VertexArrayObject":function(){define(["exports","../../core/compilerUtils","../../core/Logger","../../core/maybe","../../core/memoryEstimations","./enums","./Util","./VertexAttributeLocations"],function(e,t,r,i,s,n,o,a){"use strict";const l=()=>r.getLogger("esri.views.webgl.VertexArrayObject");e.VertexArrayObject=class{constructor(e,r,i){this._context=e,this._indexBuffer=i,this._buffers=r instanceof Map?r:new Map([["geometry",r]]),this.locations=t.toConst(a.fromBuffers(this._buffers))}get glName(){return this._glName}get context(){return this._context}get buffers(){return t.toConst(this._buffers)}buffer(e="geometry"){return this.buffers.get(e)}get indexBuffer(){return this._indexBuffer}getByteLength(e){return this.buffer(e)?.sizeBytes??0}vertexCount(e){const t=this.buffer(e);return t?t.sizeBytes/t.layout[0].stride:0}get usedMemory(){return Array.from(this._buffers.values()).reduce((e,t)=>e+t.usedMemory,this._indexBuffer?.usedMemory??0+(this._buffers.size+(this._indexBuffer?1:0))*s.baseTypedArrayMemory)}get cachedMemory(){return this.usedMemory}dispose(){this._context?(this._context.getBoundVAO()===this&&this._context.bindVAO(null),this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this._indexBuffer=i.disposeMaybe(this._indexBuffer),this.disposeVAOOnly()):(this._glName||this._buffers.size>0)&&l().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(n.ResourceType.VertexArrayObject,this)),this._context=null}bind(e=this.locations){const t=this._context.gl;this._glName?t.bindVertexArray(this._glName):(this._context.instanceCounter.increment(n.ResourceType.VertexArrayObject,this),this._glName=t.createVertexArray(),t.bindVertexArray(this._glName),this._bindLayout(e))}_bindLayout(e){const{_buffers:t,_indexBuffer:r}=this;if(t||l().error("Vertex buffer dictionary is empty!"),t.forEach(t=>o.bindVertexBufferLayout(this._context,e,t)),null!=r){const e=this._context.gl;this._context.gl.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r.glName)}}unbind(){this._context.gl.bindVertexArray(null)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/VertexBuffer":function(){define(["exports","./BufferObject"],function(e,t){"use strict";class r extends t.BufferObject{constructor(e,t,r,i=35044){super(e,34962,i,r),this.layout=t}}e.VertexBuffer=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/weather":function(){define(["exports","./CloudyWeather","./FoggyWeather","./RainyWeather","./SnowyWeather","./SunnyWeather"],function(e,t,r,i,s,n){"use strict";const o={key:"type",base:n,typeMap:{sunny:n,cloudy:t,rainy:i,snowy:s,foggy:r}},a=Object.keys(o.typeMap);e.cloudsHeight=1e5,e.heightLimit=1e4,e.validateWeatherType=function(e,t){return!!a.includes(e)||(t.error(`"${e}" is not a valid weather type`),!1)},e.weatherTypes=o,e.weatherTypesArray=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/CloudyWeather":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends t.JSONSupport{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new l({cloudCover:this.cloudCover})}};return e.__decorate([o.enumeration({cloudy:"cloudy"}),r.property({json:{write:{isRequired:!0}}})],c.prototype,"type",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),c=l=e.__decorate([a.subclass("esri.views.3d.environment.CloudyWeather")],c),c})},"esri/views/3d/environment/FoggyWeather":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends t.JSONSupport{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new l({fogStrength:this.fogStrength})}};return e.__decorate([o.enumeration({foggy:"foggy"}),r.property({json:{write:{isRequired:!0}}})],c.prototype,"type",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"fogStrength",void 0),c=l=e.__decorate([a.subclass("esri.views.3d.environment.FoggyWeather")],c),c})},"esri/views/3d/environment/RainyWeather":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends t.JSONSupport{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new l({cloudCover:this.cloudCover,precipitation:this.precipitation})}};return e.__decorate([o.enumeration({rainy:"rainy"}),r.property({json:{write:{isRequired:!0}}})],c.prototype,"type",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"precipitation",void 0),c=l=e.__decorate([a.subclass("esri.views.3d.environment.RainyWeather")],c),c})},"esri/views/3d/environment/SnowyWeather":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends t.JSONSupport{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new l({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};return e.__decorate([o.enumeration({snowy:"snowy"}),r.property({json:{write:{isRequired:!0}}})],c.prototype,"type",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"precipitation",void 0),e.__decorate([r.property({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],c.prototype,"snowCover",void 0),c=l=e.__decorate([a.subclass("esri.views.3d.environment.SnowyWeather")],c),c})},"esri/views/3d/environment/SunnyWeather":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends t.JSONSupport{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new l({cloudCover:this.cloudCover})}};return e.__decorate([o.enumeration({sunny:"sunny"}),r.property({json:{write:{isRequired:!0}}})],c.prototype,"type",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),c=l=e.__decorate([a.subclass("esri.views.3d.environment.SunnyWeather")],c),c})},"esri/views/3d/webgl-engine/effects/RenderPlugin":function(){define(["exports","../../../../core/Accessor"],function(e,t){"use strict";const r={required:[]};class i extends t{precompile(e){return!!this.acquireTechniques(e)}consumes(){return r}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(e){}}e.AsyncRenderPlugin=class extends i{},e.ConsumesDepth={required:[2]},e.ConsumesNone=r,e.SyncRenderPlugin=class extends i{},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/sunUtils":function(){define(["exports","../../../core/Logger","../../../core/mathUtils","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/SunCalc","./mathUtils"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class h{constructor(e,t){this.direct=e,this.ambient=t}}function p(e,t,r){1===t?a.normalize(k,e.eye):a.set(k,0,0,1),a.scale(z,e.viewForward,-1);const s=u.angle(z,k),n=Math.max(s-2*G,0),o=.85*n/(n+1),l=Math.max(G,s-G-o);i.fromRotation(N,-l,e.viewRight),a.transformMat4(r,z,N),a.add(r,r,a.scale(j,e.viewRight,q)),a.normalize(r,r)}function f(e,t,s,n){const o=y,l=i.identity(g);if(1===s)c.SunCalc.getPosition(e,0,0,o),a.set(n,0,0,-1),i.rotateX(l,l,-o.azimuth),i.rotateY(l,l,-o.altitude),a.transformMat4(n,n,l);else{const s=d.planarDirection,u=s.globalAngles,h=t[2];let p=(Math.abs(h)-s.localAltitude)/(s.globalAltitude-s.localAltitude);p=r.clamp(p,0,1),p<1?(c.SunCalc.getPosition(e,t[1],t[0],o),o.azimuth=(1-p)*o.azimuth+p*u.azimuth,o.altitude=(1-p)*o.altitude+p*u.altitude):(o.azimuth=u.azimuth,o.altitude=u.altitude),a.set(n,0,-1,0),i.rotateZ(l,l,-o.azimuth),i.rotateX(l,l,-o.altitude),a.transformMat4(n,n,l)}}const m=l.fromValues(.5773502691896258,-.5773502691896258,.5773502691896258),g=s.create(),y={azimuth:0,altitude:0};function _(e){switch(e){case"disabled":case"sunny":case"cloudy":return new h(1,1);case"rainy":return new h(.4,1.2);case"snowy":return new h(.5,1.3);case"foggy":return new h(.2,1.6)}}function b(e,t){const r=(e[0]+e[1]+e[2])/3;e[0]+=(r-e[0])*t,e[1]+=(r-e[1])*t,e[2]+=(r-e[2])*t}const v=l.fromValues(.01,.01,.01),w=l.fromValues(1,.6,.5),x=l.fromValues(1,.98,.98),S=l.fromValues(1,1,1),T=l.fromValues(.8,.8,1),C=l.fromValues(.8,.8,1),P=l.fromValues(.98,.98,1),M=l.fromValues(1,1,1),R=o.fromValues(.01,d.local.ambientAtNight),O=o.fromValues(d.local.directAtTwilight,d.local.ambientAtTwilight),I=o.fromValues(.9*d.local.directAtNoon,d.local.ambientAtNoon),F=o.fromValues(d.local.directAtNoon,d.local.ambientAtNoon),A=I,D=x,E=P,L=O,V=w,U=C,B=new Date(0),N=s.create(),k=l.create(),z=l.create(),j=l.create(),G=.25,q=.2;e.ColorAndIntensity=class{constructor(){this.ambient={color:l.fromValues(1,1,1),intensity:.55},this.direct={color:l.fromValues(1,1,1),intensity:.55,directionToLightSource:l.clone(m)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}},e.computeColorAndIntensity=function(e,t,i,s,u,h){a.set(h.ambient.color,1,1,1),h.ambient.intensity=d.global.ambient,a.set(h.direct.color,1,1,1),h.direct.intensity=d.global.direct;const m=t[2],g=r.clamp((Math.abs(m)-d.local.altitude)/(d.global.altitude-d.local.altitude),0,1);let y;if(h.globalFactor=g,null!=e&&(y=c.SunCalc.getTimes(e,t[1],t[0])),g<1){let t;if(null!=e)t=function(e,t,r){const i=e.valueOf();let s,u;t.polarException===c.SunCalc.PolarException.MIDNIGHT_SUN?(s=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,u=s+432e6):t.polarException===c.SunCalc.PolarException.POLAR_NIGHT?(s=i-2,u=i-1):(s=t.sunrise.valueOf(),u=t.sunset.valueOf());const d=u-s,h=s+d/2,p=d/4,f=h-p,m=h+p,g=.06*d,y=s-g/2,B=s+g/2,N=u-g/2,k=u+g/2,z=o.create(),j=l.create(),G=l.create();let q="";if(i<y||i>k)n.copy(z,R),a.copy(j,v),a.copy(G,T),q="night";else if(i<B){const e=(i-y)/(B-y);n.lerp(z,R,O,e),a.lerp(j,v,w,e),a.lerp(G,T,C,e),q="sun rising"}else if(i<f){const e=(i-B)/(f-B);n.lerp(z,O,I,e),a.lerp(j,w,x,e),a.lerp(G,C,P,e),q="early morning"}else if(i<h){const e=(i-f)/(h-f);n.lerp(z,I,F,e),a.lerp(j,x,S,e),a.lerp(G,P,M,e),q="late morning"}else if(i<m){const e=(i-h)/(m-h);n.lerp(z,F,A,e),a.lerp(j,S,D,e),a.lerp(G,M,E,e),q="early afternoon"}else if(i<N){const e=(i-m)/(N-m);n.lerp(z,A,L,e),a.lerp(j,D,V,e),a.lerp(G,E,U,e),q="late afternoon"}else if(i<k){const e=(i-N)/(k-N);n.lerp(z,L,R,e),a.lerp(j,V,v,e),a.lerp(G,U,T,e),q="sun setting"}let H=0;switch(r){case"rainy":case"foggy":H=.8;break;case"snowy":H=.5}H>0&&(b(j,H),b(G,H));const W=_(r);return{direct:{intensity:z[0]*W.direct,color:j},ambient:{intensity:z[1]*W.ambient,color:G},timeOfDay:q}}(e,y,s);else{const e=_(s);t={direct:{intensity:d.local.directAtNoon*e.direct,color:l.fromValues(1,1,1)},ambient:{intensity:d.local.ambientAtNoon*e.ambient,color:l.fromValues(1,1,1)},timeOfDay:"early afternoon"}}a.lerp(h.ambient.color,t.ambient.color,h.ambient.color,g),h.ambient.intensity=r.lerp(t.ambient.intensity,h.ambient.intensity,g),a.lerp(h.direct.color,t.direct.color,h.direct.color,g),h.direct.intensity=r.lerp(t.direct.intensity,h.direct.intensity,g),h.specularStrength="rainy"===s||"snowy"===s||"foggy"===s?0:1,h.environmentStrength="rainy"===s?.7:"snowy"===s||"foggy"===s?.75:1}h.noonFactor=null!=e?function(e,t){const i=e.valueOf();let s,n;t.polarException===c.SunCalc.PolarException.MIDNIGHT_SUN?(s=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=s+432e6):t.polarException===c.SunCalc.PolarException.POLAR_NIGHT?(s=i-2,n=i-1):(s=t.sunrise.valueOf(),n=t.sunset.valueOf());const o=s+(n-s)/2;return 1-r.clamp(Math.abs(i-o)/432e5,0,1)}(e,y):1,null!=e?f(e,t,i,h.direct.directionToLightSource):p(u,i,h.direct.directionToLightSource)},e.computeDirectionsOverTime=function(e,r,i,s,n,o){const a=e.getTime(),c=Math.max(0,r.getTime()-a),u=Math.floor(c/i)+1,d=Math.min(o,u),h=new Array(d),p=1===d?0:c/(d-1);u>d&&t.getLogger("esri.views.3d.support.sunUtils").warnOnce("computeDirectionsOverTime",`Requested interval ${i} exceeds maximum supported interval of ${Math.floor(p)} based on the provided time range.`);for(let e=0;e<d;++e)B.setTime(a+p*e),h[e]=l.create(),f(B,s,n,h[e]);return h},e.computeShadowsEnabled=function(e,t){if(1===t)return!0;const r=d.planarDirection;return Math.abs(e)<r.localAltitude},e.computeVirtualLightDirection=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/SunCalc":function(){define(["exports"],function(e){"use strict";var t=Math.PI,r=Math.sin,i=Math.cos,s=Math.tan,n=Math.asin,o=Math.atan2,a=Math.acos,l=t/180,c=864e5,u=2440588,d=2451545,h={dec:0,ra:0};function p(e){return new Date((e+.5-u)*c)}function f(e){return function(e){return e.valueOf()/c-.5+u}(e)-d}var m=23.4397*l;function g(e,t){return o(r(e)*i(m)-s(t)*r(m),i(e))}function y(e,t){return n(r(t)*i(m)+i(t)*r(m)*r(e))}function _(e,t,n){return o(r(e),i(e)*r(t)-s(n)*i(t))}function b(e,t,s){return n(r(t)*r(s)+i(t)*i(s)*i(e))}function v(e,t){return l*(280.16+360.9856235*e)-t}function w(e){return l*(357.5291+.98560028*e)}function x(e){return l*(1.9148*r(e)+.02*r(2*e)+3e-4*r(3*e))}function S(e,r){return e+r+102.9372*l+t}function T(e,t){var r=w(e),i=S(r,x(r));return t||(t={dec:0,ra:0}),t.dec=y(i,0),t.ra=g(i,0),t}var C={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,r,i){var s=l*-r,n=l*t,o=f(e),a=T(o,h),c=v(o,s)-a.ra;return i||(i={azimuth:0,altitude:0}),i.azimuth=_(c,n,a.dec),i.altitude=b(c,n,a.dec),i}},P=[[-.83,"sunrise","sunset"]];C.addTime=function(e,t,r){P.push([e,t,r])};var M=9e-4;function R(e,r,i){return M+(e+r)/(2*t)+i}function O(e,t,i){return d+e+.0053*r(t)-.0069*r(2*i)}function I(e){var t=l*(134.963+13.064993*e),s=l*(93.272+13.22935*e),n=l*(218.316+13.176396*e)+6.289*l*r(t),o=5.128*l*r(s),a=385001-20905*i(t);return{ra:g(n,o),dec:y(n,o),dist:a}}C.getTimes=function(e,s,n){var o=l*-n,c=l*s,u=function(e,r){return Math.round(e-M-r/(2*t))}(f(e),o),d=R(0,o,u),h=w(d),m=x(h),g=S(h,m),_=y(g,0),b=O(d,h,g);function v(e){var t=function(e,t,s){return a((r(e)-r(t)*r(s))/(i(t)*i(s)))}(e,c,_);return O(R(t,o,u),h,g)}var T,I,F,A,D,E,L,V={solarNoon:p(b),nadir:p(b-.5),polarException:C.PolarException.NORMAL};for(T=0,I=P.length;T<I;T+=1)D=b-((A=v((F=P[T])[0]*l))-b),V[F[1]]=p(D),V[F[2]]=p(A);return V.polarException=(E=P[0][0]*l,(L=(r(E)-r(c)*r(_))/(i(c)*i(_)))<-1?C.PolarException.MIDNIGHT_SUN:L>1?C.PolarException.POLAR_NIGHT:C.PolarException.NORMAL),V},C.getMoonPosition=function(e,t,r){var i=l*-r,n=l*t,o=f(e),a=I(o),c=v(o,i)-a.ra,u=b(c,n,a.dec);return u+=.017*l/s(u+10.26*l/(u+5.1*l)),{azimuth:_(c,n,a.dec),altitude:u,distance:a.dist}},C.getMoonFraction=function(e){var t=f(e),s=T(t),n=I(t),l=149598e3,c=a(r(s.dec)*r(n.dec)+i(s.dec)*i(n.dec)*i(s.ra-n.ra)),u=o(l*r(c),n.dist-l*i(c));return(1+i(u))/2},e.SunCalc=C})},"esri/views/3d/webgl-engine/lighting/Lightsources":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec3f64"],function(e,t){"use strict";e.AmbientLight=class{constructor(e=t.zeros()){this.intensity=e}},e.FillLight=class{constructor(e=t.zeros(),r=t.fromValues(.57735,.57735,.57735)){this.intensity=e,this.direction=r}},e.MainLight=class{constructor(e=t.zeros(),r=t.fromValues(.57735,.57735,.57735),i=!0,s=1,n=1){this.intensity=e,this.direction=r,this.castShadows=i,this.specularStrength=s,this.environmentStrength=n}},e.SphericalHarmonicsAmbientLight=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/SceneViewEnvironment":function(){define(["../../../chunks/tslib.es6","../../../core/compilerUtils","../../../core/handleUtils","../../../core/lang","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/cast","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/ensureType","./lightingUtils","./SunLighting","./VirtualLighting","../../../webscene/Environment","../../../webscene/SunLighting","../../../webscene/VirtualLighting"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";var f;let m=class extends d{static{f=this}constructor(e){super(e),this.lighting=this.castLighting(),this._computeWeatherAvailable=void 0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new f({...t,lighting:t.lighting?"virtual"===t.lighting.type?u.fromWebsceneLighting(t.lighting):c.fromWebsceneLighting(t.lighting):void 0})}get weatherAvailable(){return this._computeWeatherAvailable?.()??!1}setComputeWeatherAvailable(e){this._computeWeatherAvailable=e}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){const t=this._convertLighting(e);return t!==e&&this.addHandles(r.destroyHandle(t)),t}_convertLighting(e){return e?e instanceof c||e instanceof u?e:e instanceof h?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new c({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):e instanceof p?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new u({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):a.ensureOneOfType(l.lightingTypes,e):new c}clone(){return new f({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:i.clone(this.background)})}cloneWithWebsceneEnvironment(e){return new f({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:i.clone(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):c.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):u.fromWebsceneLighting(e.lighting);default:return t.neverReached(e.lighting),c.fromWebsceneLighting(e.lighting)}}};return e.__decorate([s.property({nonNullable:!0})],m.prototype,"lighting",void 0),e.__decorate([s.property()],m.prototype,"_computeWeatherAvailable",void 0),e.__decorate([s.property({readOnly:!0})],m.prototype,"weatherAvailable",null),e.__decorate([n.cast("lighting")],m.prototype,"castLighting",null),m=f=e.__decorate([o.subclass("esri.views.3d.environment.SceneViewEnvironment")],m),m})},"esri/views/3d/environment/lightingUtils":function(){define(["exports","./SunLighting","./VirtualLighting"],function(e,t,r){"use strict";const i={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:t,virtual:r}};e.lightingTypes=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/SunLighting":function(){define(["../../../chunks/tslib.es6","../../../core/Evented","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../webscene/SunLighting"],function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends(t.EventedMixin(a)){static calculateTimezoneOffset({hours:e,minutes:t,seconds:r}){return Math.round(e+t/60+r/3600)}constructor(e){super(e),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const t=(new Date).getFullYear(),r=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",r),this._set("date",r)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(e){return new l(e.cloneConstructProperties())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const r=l.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let i=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(e.getTime())?(i=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(i=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime()))));const s=l.calculateTimezoneOffset(this.positionTimezoneInfo);if(r!==s&&(u.target=this,u.timezoneOffset=s,this.emit("timezone-will-change",u),u.target=null),null!=e)return isNaN(e.getTime())||i!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new l({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};e.__decorate([r.property({type:Boolean})],c.prototype,"cameraTrackingEnabled",void 0),e.__decorate([r.property({type:Date})],c.prototype,"defaultDate",null),e.__decorate([r.property({type:Date})],c.prototype,"date",null),c=l=e.__decorate([o.subclass("esri.views.3d.environment.SunLighting")],c);const u={target:null,timezoneOffset:0};return c})},"esri/webscene/SunLighting":function(){define(["../chunks/tslib.es6","../core/JSONSupport","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer"],function(e,t,r,i,s,n,o,a,l){"use strict";var c;let u=class extends t.JSONSupport{static{c=this}constructor(...e){super(...e),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return null!=t.datetime&&new Date(t.datetime)||null}writeDate(e,t,r){t[r]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,r){e&&(t[r]=e)}writeDisplayUTCOffset(e,t){null!=e&&(t.displayUTCOffset=e)}clone(){return new c(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}};return e.__decorate([r.property({readOnly:!0,type:["sun"],json:{write:!0}})],u.prototype,"type",void 0),e.__decorate([r.property({type:Date,json:{type:Number,write:{target:"datetime"}}})],u.prototype,"date",void 0),e.__decorate([o.reader("date",["datetime"])],u.prototype,"readDate",null),e.__decorate([l.writer("date")],u.prototype,"writeDate",null),e.__decorate([r.property({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],u.prototype,"directShadowsEnabled",void 0),e.__decorate([o.reader("directShadowsEnabled",["directShadows"])],u.prototype,"readDirectShadowsEnabled",null),e.__decorate([l.writer("directShadowsEnabled")],u.prototype,"writedirectShadowsEnabled",null),e.__decorate([r.property({type:Number,json:{write:!0}})],u.prototype,"displayUTCOffset",void 0),e.__decorate([l.writer("displayUTCOffset")],u.prototype,"writeDisplayUTCOffset",null),u=c=e.__decorate([a.subclass("esri.webscene.SunLighting")],u),u})},"esri/views/3d/environment/VirtualLighting":function(){define(["../../../chunks/tslib.es6","../../../core/Evented","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../webscene/VirtualLighting"],function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends(t.EventedMixin(a)){constructor(e){super(e),this.cameraTrackingEnabled=!0}clone(){return new l({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(e){return new l(e.cloneConstructProperties())}cloneWithWebsceneLighting(e){const t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};return e.__decorate([r.property({type:Boolean})],c.prototype,"cameraTrackingEnabled",void 0),c=l=e.__decorate([o.subclass("esri.views.3d.environment.VirtualLighting")],c),c})},"esri/webscene/VirtualLighting":function(){define(["../chunks/tslib.es6","../core/JSONSupport","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o){"use strict";var a;let l=class extends t.JSONSupport{static{a=this}constructor(...e){super(...e),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new a(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};return e.__decorate([r.property({readOnly:!0,type:["virtual"],json:{write:{isRequired:!0}}})],l.prototype,"type",void 0),e.__decorate([r.property({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],l.prototype,"directShadowsEnabled",void 0),l=a=e.__decorate([o.subclass("esri.webscene.VirtualLighting")],l),l})},"esri/webscene/Environment":function(){define(["../chunks/tslib.es6","../core/JSONSupport","../core/lang","../core/Logger","../core/accessorSupport/decorators/property","../core/has","../core/accessorSupport/decorators/subclass","../views/3d/environment/SunnyWeather","../views/3d/environment/weather","./lightingTypes","./SunLighting","./VirtualLighting","./background/utils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";var p;const f=(e,t,r)=>({enabled:!r?.isPresentation});let m=class extends t.JSONSupport{static{p=this}constructor(e){super(e),this.lighting=new u,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(e){l.validateWeatherType(e?.type,i.getLogger(this))&&this._set("weather",e)}clone(){return new p(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&"virtual"===this.lighting.type?d.prototype.clone.call(this.lighting):u.prototype.clone.call(this.lighting),background:r.clone(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};return e.__decorate([s.property({types:c.lightingTypes,nonNullable:!0,json:{write:!0}})],m.prototype,"lighting",void 0),e.__decorate([s.property(h.backgroundProperty)],m.prototype,"background",void 0),e.__decorate([s.property({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:f}}})],m.prototype,"atmosphereEnabled",void 0),e.__decorate([s.property({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:f}}})],m.prototype,"starsEnabled",void 0),e.__decorate([s.property({types:l.weatherTypes,nonNullable:!0,json:{write:!0},value:new a})],m.prototype,"weather",null),m=p=e.__decorate([o.subclass("esri.webscene.Environment")],m),m})},"esri/webscene/lightingTypes":function(){define(["exports","./SunLighting","./VirtualLighting"],function(e,t,r){"use strict";const i={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:t,virtual:r}};e.lightingTypes=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/webscene/background/utils":function(){define(["exports","./Background","./ColorBackground"],function(e,t,r){"use strict";const i={base:t,key:"type",typeMap:{color:r}},s={types:i,json:{read:(n=i,(e,t,r)=>{if(!e)return e;for(const t in n.typeMap)if(e.type===t){const i=new n.typeMap[t];return i.read(e,r),i}}),write:{overridePolicy:(e,t,r)=>({enabled:!r?.isPresentation})}}};var n;e.backgroundProperty=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/webscene/background/Background":function(){define(["../../chunks/tslib.es6","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o){"use strict";let a=class extends t.JSONSupport{constructor(e){super(e)}clone(){throw new Error("Subclasses of Background should implement their own clone method.")}};return e.__decorate([r.property({readOnly:!0,json:{read:!1}})],a.prototype,"type",void 0),a=e.__decorate([o.subclass("esri.webscene.background.Background")],a),a})},"esri/webscene/background/ColorBackground":function(){define(["../../chunks/tslib.es6","../../Color","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","../../symbols/support/materialUtils","./Background"],function(e,t,r,i,s,n,o,a,l,c){"use strict";var u;let d=u=class extends c{constructor(e){super(e),this.type="color",this.color=new t([0,0,0,1])}clone(){return new u(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};return e.__decorate([o.enumeration({color:"color"},{readOnly:!0}),r.property({json:{write:{isRequired:!0}}})],d.prototype,"type",void 0),e.__decorate([r.property(l.colorAndTransparencyProperty({nonNullable:!0,colorRequiredOnWrite:!0}))],d.prototype,"color",void 0),d=u=e.__decorate([a.subclass("esri.webscene.background.ColorBackground")],d),d})},"esri/views/3d/input/SceneInputManager":function(){define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./handlers/DoubleClickZoom","./handlers/DragRotate","./handlers/DragZoom","./handlers/GamepadNavigation","./handlers/KeyboardNavigation","./handlers/MouseWheelZoom","./handlers/PinchAndPanNavigation","./handlers/PointerDownCancelAnimation","./handlers/TwoFingerTilt","../../input/BrowserEventSource","../../input/InputManager","../../input/handlers/PreventContextMenu","../../input/handlers/support","../../input/recognizers/Drag","../../input/recognizers/ImmediateDoubleClick","../../input/recognizers/PointerClickHoldAndDrag","../../input/recognizers/SingleAndDoubleClick","../../input/recognizers/VerticalTwoFingerDrag"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P){"use strict";let M=class extends t{constructor(){super(...arguments),this.mode="default",this._updateMode=({mode:e,dragPrimary:t,dragSecondary:r,dragTertiary:i})=>{"pro"===e&&(r="zoom",i="pan"===t?"rotate":"pan");const s={dragPrimary:t,dragSecondary:r,dragTertiary:i};this._modeDragPan&&(this._modeDragPan.pointerActions=w.getPointerActions("pan",s)),this._modeDragRotate&&(this._modeDragRotate.pointerActions=w.getPointerActions("rotate",s)),this._modeDragZoom&&(this._modeDragZoom.pointerActions=w.getPointerActions("zoom",s))}}destroy(){this.disconnect()}get primaryDragAction(){return this.view.navigation.actionMap.dragPrimary}set primaryDragAction(e){const{actionMap:t}=this.view.navigation;t.dragPrimary=e,t.dragSecondary="pan"===e?"rotate":"pan"}get updating(){return!!this._inputManager?.updating}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.removeAllHandles(),this.view.viewEvents.disconnect(),this._modeDragPan=null,this._modeDragRotate=null,this._modeDragZoom=null,this._modeKeyboardNavigation=null,this._inputManager=i.destroyMaybe(this._inputManager),this._source=i.destroyMaybe(this._source)}connect(){const e=this.view;this._source=new _.BrowserEventSource(this.view.surface,e.input);const t=[new S.ImmediateDoubleClick,new T.PointerClickHoldAndDrag,new C.SingleAndDoubleClick,new x.Drag(this.view.navigation),new P.VerticalTwoFingerDrag],r=new b.InputManager({eventSource:this._source,recognizers:t});this._inputManager=r,r.installHandlers("prevent-context-menu",[new v.PreventContextMenu],b.ViewEventPriorities.INTERNAL);const i={fov:"Shift",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:["u","U"],down:["j","J"]},lookAround:{headingLeft:["a","A"],headingRight:["d","D"],tiltUp:["w","W"],tiltDown:["s","S"],modifier:"b"},zoom:{zoomIn:["+","="],zoomOut:["-","_"]},reset:{heading:["n","N"],tilt:["p","P"]}};this._modeDragPan=new m.PinchAndPanNavigation(e,["primary"]),this._modeDragRotate=new u.DragRotate(e,["secondary"],0),this._modeDragZoom=new d.DragZoom(e,["tertiary"],i.fov),this._modeKeyboardNavigation=new p.KeyboardNavigation(e,i),r.installHandlers("navigation",[new g.PointerDownCancelAnimation(e),new c.DoubleClickZoom(e),new h.GamepadNavigation(e),new f.MouseWheelZoom(e,i.fov),new u.DragRotate(e,["primary"],1,[i.lookAround.modifier]),new u.DragRotate(e,["secondary"],0,[i.lookAround.modifier]),new m.PinchAndPanNavigation(e,["tertiary"],[i.lookAround.modifier]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new y.TwoFingerTilt(e)],b.ViewEventPriorities.INTERNAL),this.view.viewEvents.connect(r),this.addHandles([s.watch(()=>this.view.navigation?.browserTouchPanEnabled,e=>{this._source.browserTouchPanningEnabled=!e},s.initial),s.watch(()=>{const{actionMap:e}=this.view.navigation,{dragPrimary:t,dragSecondary:r,dragTertiary:i}=e;return{mode:this.mode,dragPrimary:t,dragSecondary:r,dragTertiary:i}},this._updateMode,s.syncAndInitial)])}isModifierKeyDown(e){return this._inputManager?.isModifierKeyDown(e)??!1}get test(){}};return e.__decorate([n.property()],M.prototype,"view",void 0),e.__decorate([n.property({type:["default","pro"]})],M.prototype,"mode",void 0),e.__decorate([n.property({readOnly:!0})],M.prototype,"updating",null),e.__decorate([n.property()],M.prototype,"latestPointerType",null),e.__decorate([n.property()],M.prototype,"latestPointerLocation",null),e.__decorate([n.property()],M.prototype,"multiTouchActive",null),e.__decorate([n.property()],M.prototype,"_inputManager",void 0),M=e.__decorate([l.subclass("esri.views.3d.input.SceneInputManager")],M),M})},"esri/views/3d/input/handlers/DoubleClickZoom":function(){define(["exports","../../../../core/screenUtils","../../state/controllers/ZoomStepControllerGlobal","../../state/controllers/ZoomStepControllerLocal","../../../input/InputHandler","../../../input/handlers/support"],function(e,t,r,i,s,n){"use strict";class o extends s.InputHandler{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,e=>this._handleDoubleClick(e))}_handleDoubleClick(e){const s=e.data;if(n.eventMatchesPointerAction(s,"primary")){const n=this._view.state.isGlobal?new r.ZoomStepControllerGlobal({view:this._view,mode:"animation"}):new i.ZoomStepControllerLocal({view:this._view,mode:"animation"});this._view.state.switchCameraController(n),n.step(Math.log(.5)/Math.log(.6),t.createScreenPointArray(s.x,s.y)),e.stopPropagation()}}}e.DoubleClickZoom=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/ZoomStepControllerGlobal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/time","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/ray","../../../../chunks/sphere","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/surfaceCollision","./PointToPointAnimationController","../utils/navigationUtils","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl/RenderCamera","../../webgl-engine/lib/Intersector","../../../animation/easing"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x){"use strict";e.ZoomStepControllerGlobal=class extends g.PointToPointAnimationController{constructor(){super(...arguments),this._zoomLocation=u.create(),this._tmpCamera=new v,this._tmpViewDir=u.create(),this._tmpRayDir=d.create(),this._targetOnSphere=u.create(),this._tmpCenter=u.create(),this._beginCamera=new v,this._constraintOptions=new f.ConstraintOptions(7,1,null,this._beginCamera),this._sphere=h.create()}initialize(){this._intersector=new w.Intersector(this.view.state.viewingMode)}step(e,t){if(!this.running)return;const r=this.view.state;this.animation.finished?this._beginCamera.copyFrom(r.camera):this.animation.cameraAt(1,this._beginCamera);let i=!1,s=!1;this._intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?y.excludeTerrain:{})&&(i=e>0,s=!0),this._tmpCamera.copyFrom(r.camera),i?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:c.copy(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,t,s),this.begin(this._tmpCamera)}animationSettings(){return{duration:i.Milliseconds(600),easing:x.outExpo}}_updateCamera(e,t,i,s){const n=y.navigationMode(e,i,this.view.renderCoordsHelper,this.view.viewingMode),o=Math.abs(this.view.camera.position.z),a=this._zoomLocation;c.normalize(T,e.eye),c.scale(T,T,-1),_.fromScreenAtEye(e,i,this._tmpRayDir),c.normalize(this._tmpRayDir.direction,this._tmpRayDir.direction);const l=r.clamp(y.getTiltScaleFactor(T,this._tmpRayDir.direction,y.maxZoomStepDistanceModifier)*o,y.zoomStepDistanceClamp[0],y.zoomStepDistanceClamp[1]);if(1===n){let r=.6**t;this._sphere[3]=c.length(a),c.subtract(this._tmpViewDir,e.center,e.eye);const s=Math.min(c.length(this._tmpViewDir),l);let n=s*r;if(r<=1&&n<4&&(n=4,r=n/s),Math.abs(s-n)<1e-6)return;const o=c.length(e.center);if(this._sphere[3]!==o){const t=this._sphere[3]+r*(o-this._sphere[3]);e.center=c.scale(S,e.center,t/o)}c.scale(this._tmpViewDir,this._tmpViewDir,-r),e.eye=c.add(S,e.center,this._tmpViewDir),p.applyAll(this.view,e,this._constraintOptions),c.squaredDistance(a,e.center)>1e-12&&b.intersectScreen(this._sphere,e,i,this._targetOnSphere)&&y.panToPosition(this._sphere,e,a,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let r=.6**Math.abs(t);const n=t>0?1:-1;c.subtract(this._tmpViewDir,a,e.eye);const o=c.length(this._tmpViewDir),u=this.view.stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,60);let d=null!=u?u:l;s&&t>0&&(d=Math.min(d,o)),c.scale(this._tmpRayDir.direction,this._tmpRayDir.direction,d),c.add(a,this._tmpRayDir.origin,this._tmpRayDir.direction);let h=d*r;const p=Math.max(4,1.01*e.nearFar[0]);if(t>0&&h<p&&(h=p,r=h/d),Math.abs(d-h)<1e-6)return;c.scale(this._tmpRayDir.direction,this._tmpRayDir.direction,n*(1-r)),e.eye=c.add(S,e.eye,this._tmpRayDir.direction),e.center=c.add(S,e.center,this._tmpRayDir.direction)}m.applySurfaceCollisionConstraint(this.view,e)}},e.ZoomStepControllerGlobal=t.__decorate([l.subclass("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],e.ZoomStepControllerGlobal);const S=u.create(),T=u.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/camera/constraintUtils":function(){define(["exports","./constraintUtils/altitude","./constraintUtils/common","./constraintUtils/ConstraintOptions","./constraintUtils/distance","./constraintUtils/surfaceCollision","./constraintUtils/tilt","../../animation/easing"],function(e,t,r,i,s,n,o,a){"use strict";const l=[{type:1,error:function(e,t,r){return o.getTiltConstraintError(e,t,r)*t.distance},apply:o.applyTiltConstraint},{type:2,error:t.getAltitudeConstraintError,apply:t.applyAltitudeConstraint},{type:4,error:s.getDistanceConstraintError,apply:s.applyDistanceConstraint}],c=new i.ConstraintOptions;e.applyAll=function(e,t,i=c,s=t){s!==t&&s.copyFrom(t),s.computeUp(e.state.viewingMode);let o=!1;for(let t=0;t<5;t++){let t=0;for(const n of l)if(r.hasConstraintType(i.selection,n.type)){const r=Math.abs(n.error(e,s,i));n.apply(e,s,i)&&(o=!0,t+=r)}if(0===t)break}const a=r.hasConstraintType(i.selection,8),u=function(e,t){switch(e){case 4:return 1;case 5:return t.state.isGlobal?2:1;default:return 0}}(i.interactionType,e);return a&&n.applySurfaceCollisionConstraint(e,s,u)&&(o=!0),o&&s.computeUp(e.state.viewingMode),o},e.pixelDistanceToInteractionFactor=function(e){const t=Math.min(1,e/150);return a.inOutCubic(t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/camera/constraintUtils/altitude":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/ray","./common","../../support/intersectionUtils"],function(e,t,r,i,s,n,o){"use strict";function a(e,r,i=n.defaultConstraintOptions){if(!function(e,t){const r=e.state.constraints.altitude;return!(!e.state.isGlobal||!r||2===t.interactionType&&n.hasConstraintType(t.selection,1))}(e,i)||!e.state.constraints.altitude)return 0;const s=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,l);!function(e,t,r){const i=t.interactionType;if(0===i)return;const{min:s,max:o}=r,{interactionStartCamera:l,interactionFactor:c}=t;if(!l)return;const u=2===i||1===i,d=a(e,l),h=0===d?0:e.renderCoordsHelper.getAltitude(l.eye);r.min=s,r.max=o;const p=.05*h;n.adjustRangeForInteraction(d,h,u,c,p,r)}(e,i,s);const o=e.renderCoordsHelper.getAltitude(r.eye),c=t.clamp(o,s.min,s.max)-o;return Math.abs(c)<=1e-6?0:c}const l={min:0,max:0},c=i.create(),u=i.create(),d=i.create(),h=i.create();e.applyAltitudeConstraint=function(e,t,i=n.defaultConstraintOptions){const l=a(e,t,i);if(0===l)return!1;const p=e.renderCoordsHelper,f=p.getAltitude(t.eye)+l,m=n.interactionDirectionTowardsConstraintMinimization(t,i.interactionDirection,function(e,t,i,s){return e.renderCoordsHelper.worldUpAtPosition(t.eye,s),r.scale(s,s,i),s}(e,t,Math.sign(l),u),c),g=r.copy(d,t.viewForward),y=p.intersectInfiniteManifold(s.wrap(t.eye,m),f,h);return t.eye=null!=y?y:p.setAltitude(h,f,t.eye),t.center=o.closestPointOnRay(h,t.eye,g,t.center),!0},e.getAltitudeConstraintError=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/camera/constraintUtils/common":function(){define(["exports","../../../../chunks/vec32","./ConstraintOptions"],function(e,t,r){"use strict";const i=new r.ConstraintOptions(0);e.adjustRangeForInteraction=function(e,t,r,i,s,n){0!==e&&(r?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):null!=i?(n.min-=Math.max(0,(t-n.min)*(1-i)),n.max+=Math.max(0,(t-n.max)*(1-i))):s&&(n.min-=Math.max(0,t-n.min-s),n.max+=Math.max(0,t-n.max-s)))},e.defaultConstraintOptions=i,e.hasConstraintType=function(e,t){return 0!==(e&t)},e.interactionDirectionTowardsConstraintMinimization=function(e,r,i,s){return r=r||e.viewForward,t.copy(s,r),t.scale(s,s,Math.sign(t.dot(r,i))),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/camera/constraintUtils/ConstraintOptions":function(){define(["exports"],function(e){"use strict";e.ConstraintOptions=class{constructor(e=15,t=0,r=0,i=null,s=null,n=0){this.selection=e,this.interactionType=t,this.interactionFactor=r,this.interactionStartCamera=i,this.interactionDirection=s,this.tiltMode=n}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/intersectionUtils":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/plane"],function(e,t,r,i,s){"use strict";const n={dir:i.create(),len:0,clip:t.create()};function o(e,t,i,s){const o=n;return e?(i&&s&&(o.len=r.distance(t,i)),r.copy(o.dir,e)):s?(o.len=r.distance(t,i),r.subtract(o.dir,i,t),r.scale(o.dir,o.dir,1/o.len)):(r.subtract(o.dir,i,t),r.normalize(o.dir,o.dir)),o}function a(e,t,i){const n=r.dot(s.getNormal(e),i.dir),o=-s.signedDistance(e,t);if(o<0&&n>=0)return!1;if(n>-1e-6&&n<1e-6)return o>0;if((o<0||n<0)&&!(o<0&&n<0))return!0;const a=o/n;return n>0?a<i.clip[1]&&(i.clip[1]=a):a>i.clip[0]&&(i.clip[0]=a),i.clip[0]<=i.clip[1]}function l(e,t,r,i){i.clip[0]=0,i.clip[1]=r?i.len:Number.MAX_VALUE;for(let r=0;r<e.length;r++)if(!a(e[r],t,i))return!1;return!0}e.closestPointOnRay=function(e,t,i,s){const n=r.dot(i,r.subtract(e,s,t));return r.add(e,t,r.scale(e,i,n))},e.frustumLineSegment=function(e,t,r,i){return l(e,t,r,o(i,t,r,!0))},e.frustumPoint=function(e,t){for(let r=0;r<6;r++)if(s.signedDistance(e[r],t)>0)return!1;return!0},e.frustumRay=function(e,t,r,i){return l(e,t,null,o(i,t,r,!1))},e.frustumSphere=function(e,t,r){const i=t[0],s=t[1],n=t[2];return!(e[0][0]*i+e[0][1]*s+e[0][2]*n+e[0][3]>r||e[1][0]*i+e[1][1]*s+e[1][2]*n+e[1][3]>r||e[2][0]*i+e[2][1]*s+e[2][2]*n+e[2][3]>r||e[3][0]*i+e[3][1]*s+e[3][2]*n+e[3][3]>r||e[4][0]*i+e[4][1]*s+e[4][2]*n+e[4][3]>r||e[5][0]*i+e[5][1]*s+e[5][2]*n+e[5][3]>r)},e.planeSphere=function(e,t,r){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]<r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/camera/constraintUtils/distance":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/ray","../../../../chunks/sphere","./common"],function(e,t,r,i,s,n){"use strict";function o(e,t,r=n.defaultConstraintOptions){if(!e.state.isLocal)return 0;const i=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||i===1/0)return 0;l.min=0,l.max=i,function(e,t,r){const i=t.interactionType;if(0===i)return;const{min:s,max:l}=r,{interactionStartCamera:c,interactionFactor:u}=t;if(!c)return;const d=1===i||4===i,h=o(e,c),p=0===h?0:a(e,c);r.min=s,r.max=l;const f=.05*p;n.adjustRangeForInteraction(h,p,d,u,f,r)}(e,r,l);const s=a(e,t),c=l.max-s;return c>=-1e-6?0:c}function a(e,r){const i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?t.distance(r.eye,i.renderLocation):0}const l={min:0,max:0},c=r.create(),u=r.create(),d=r.create(),h=r.create(),p=r.create();e.applyDistanceConstraint=function(e,r,l=n.defaultConstraintOptions){const f=o(e,r,l);if(0===f)return!1;const m=e.pointsOfInterest.surfaceOrigin;if(!m.renderLocation)return!1;const g=a(e,r)+f,y=t.copy(c,r.eye),_=n.interactionDirectionTowardsConstraintMinimization(r,l.interactionDirection,function(e,r,i){return t.direction(i,e.eye,r)}(r,m.renderLocation,h),d);if(!s.intersectRay(s.fromCenterAndRadius(m.renderLocation,g),i.wrap(r.eye,_),p))return!1;r.eye=p;const b=t.subtract(u,r.eye,y);r.center=t.add(p,r.center,b);const v=e.renderCoordsHelper.getAltitude(r.center),w=e.renderCoordsHelper.intersectInfiniteManifold(r.ray,v,p);return null!=w&&(r.center=w),!0},e.getDistanceConstraintError=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/camera/constraintUtils/surfaceCollision":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../intersectionUtils"],function(e,t,r,i){"use strict";const s=r.create(),n=r.create();e.applySurfaceCollisionConstraint=function(e,r,o=0){const a=e.state.constraints;if(!a.collision.enabled)return!1;const l=i.surfaceElevationBelowRenderLocation(e,r.eye),c=e.renderCoordsHelper.getAltitude(r.eye),u=l+a.collision.elevationMargin;if(c>=u)return!1;const d=t.length(r.eye);if(t.subtract(s,r.center,r.eye),r.eye=e.renderCoordsHelper.setAltitude(n,u,r.eye),1===o)r.center=t.add(s,r.eye,s);else if(2===o){const e=(d-c+u)/d;r.center=t.scale(s,r.center,e)}return!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/camera/constraintUtils/tilt":function(){define(["exports","../../../../core/compilerUtils","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../chunks/sphere","./common","../../state/utils/viewUtils"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";function d(e,t,i,s=c.defaultConstraintOptions,o){if(!e.state.constraints.tilt)return 0;const m=Math.min(t.relativeElevation*b,t.distance),g=e.state.constraints.tilt(m,v);return function(e,t,r){if(0===t.interactionType)return;const{interactionStartCamera:i,interactionFactor:s}=t;if(!i)return;const{min:n,max:o}=r,a=d(e,i,c.defaultConstraintOptions,t),l=0===a?0:u.viewAngle(e.renderCoordsHelper,i.center,i.eye);r.min=n,r.max=o,2===t.interactionType?(c.hasConstraintType(t.selection,2)&&f(e,i,r),c.adjustRangeForInteraction(a,l,!0,s,_,r)):c.adjustRangeForInteraction(a,l,!1,s,_,r)}(e,i,g),2===s.interactionType&&c.hasConstraintType(s.selection,2)&&f(e,s.interactionStartCamera,g),1===i.tiltMode||1===s.tiltMode?function(e,t,i,s){switch(s&&(s.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,s){const o=function(e,t,i){const s=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,o=s+a.getReferenceEllipsoid(e.spatialReference).radius,c=e.renderCoordsHelper.intersectManifold(t.ray,s,y);return i.distance=Math.min(t.relativeElevation*b,t.distance),i.centerIsOnSurface=!1,null!=c?(i.distance=Math.min(t.relativeElevation*b,n.distance(t.eye,c)),i.tiltAtCenter=u.viewAngle(e.renderCoordsHelper,c,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=u.viewAngle(e.renderCoordsHelper,t.center,t.eye):(l.closestPointOnSilhouette(l.fromRadius(l.tmpSphere,o),t.ray,y),i.distance=Math.min(t.relativeElevation*b,n.distance(t.eye,y)),i.tiltAtCenter=r.acosClamped(-n.dot(t.viewForward,n.normalize(y,y)))),i.radius=o,i.eyeRadius=n.length(t.eye),i.constraints=e.state.constraints,i}(e,t,w),c=r.clamp(o.tiltAtCenter,i.min,i.max);if(!h(o.tiltAtCenter-c))return 0;let d,f;return o.centerIsOnSurface?(d=function(e){const{constraints:t,distance:r,tiltAtCenter:i}=e;let s=i,n=t.clampTilt(r,i);const o=p(e,n);if(t.clampTilt(o,i)===n)return n;let a=0;for(;a<10&&h(n-s);){const r=(s+n)/2,i=p(e,r);h(t.clampTilt(i,r)-r)?s=r:n=r,a++}return n}(o),f=function(e,t){const i=r.asinClamped(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),s=r.asinClamped(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-s:s-i}(o,d)):(d=o.constraints.clampTilt(o.distance,o.tiltAtCenter),s&&d<Math.PI/2&&(s.requiresTwoSteps=!0,d=Math.PI/2-1e-5),f=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(o,d)),s&&(s.eyeCenterDistance=p(o,d)),f}(e,t,i,s);case"local":return function(e,t,i,s){const n=u.viewAngle(e.renderCoordsHelper,t.center,t.eye),o=r.clamp(n,i.min,i.max),a=n-o;if(!h(a))return 0;if(s){const r=Math.abs(e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),i=e.renderCoordsHelper.getAltitude(t.eye)-r,n=Math.max(Math.cos(o),1e-4);Math.abs(n)>1e-4?s.eyeCenterDistance=i/n:s.eyeCenterDistance=t.distance}return a}(e,t,i,s)}}(e,t,g,o):function(e,t,i){const s=u.viewAngle(e.renderCoordsHelper,t.center,t.eye),n=s-r.clamp(s,i.min,i.max);return h(n)?n:0}(e,t,g)}function h(e){return Math.abs(e)>1e-9}function p(e,t){if(!e.centerIsOnSurface)return e.distance;const i=Math.PI-r.clamp(t,0,Math.PI),s=r.asinClamped(e.radius/e.eyeRadius*Math.sin(i)),n=Math.PI-i-s,o=Math.sin(n)/Math.sin(i);if(e.eyeRadius<e.radius&&o>1){const t=Math.PI-s,r=Math.PI-i-t;return Math.sin(r)/Math.sin(i)*e.eyeRadius}return o*e.eyeRadius}function f(e,t,i){const s=e.state.constraints;if(e.state.isLocal||!s.altitude||!t)return;const o=n.squaredLength(t.center),l=Math.sqrt(o),c=t.distance,u=a.getReferenceEllipsoid(e.spatialReference).radius,d=s.altitude.min+u,h=s.altitude.max+u,p=(d*d-c*c-o)/(-2*l*c),f=(h*h-c*c-o)/(-2*l*c);i.min=Math.max(i.min,Math.min(Math.PI-r.acosClamped(f),i.max)),i.max=Math.min(i.max,Math.PI-r.acosClamped(p))}const m=o.create(),g=s.create(),y=o.create(),_=r.deg2rad(5),b=30,v={min:0,max:0},w={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,distance:0,tiltAtCenter:0},x={eyeCenterDistance:0,requiresTwoSteps:!1};e.applyTiltConstraint=function e(r,s,o,a=!0){x.eyeCenterDistance=0,x.requiresTwoSteps=!1;const l=d(r,s,o,c.defaultConstraintOptions,x);if(0===l)return!1;switch(i.fromRotation(g,-l,s.viewRight),o.tiltMode){case 1:n.transformMat4(m,s.viewForward,g),n.scale(m,m,x.eyeCenterDistance),s.center=n.add(y,s.eye,m);break;case 0:n.subtract(m,s.center,s.eye),n.transformMat4(m,m,g),s.eye=n.subtract(y,s.center,m);break;default:t.neverReached(o.tiltMode)}return s.up=n.transformMat4(y,s.up,g),!x.requiresTwoSteps||!a||e(r,s,o,!1)},e.getTiltConstraintError=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/animation/easing":function(){define(["exports","../2d/unitBezier"],function(e,t){"use strict";const r=e=>e,i=e=>e*e,s=e=>1-i(1-e),n=e=>e<.5?i(2*e)/2:(s(2*(e-.5))+1)/2,o=e=>e*e*e,a=e=>1-o(1-e),l=e=>e<.5?o(2*e)/2:(a(2*(e-.5))+1)/2,c=e=>e*e*e*e,u=e=>1-c(1-e),d=e=>e<.5?c(2*e)/2:(u(2*(e-.5))+1)/2,h=e=>e*e*e*e*e,p=e=>1-h(1-e),f=e=>e<.5?h(2*e)/2:(p(2*(e-.5))+1)/2,m=e=>1-Math.cos(e*Math.PI/2),g=e=>1-m(1-e),y=e=>e<.5?m(2*e)/2:(g(2*(e-.5))+1)/2,_=e=>2**(10*(e-1)),b=e=>1-_(1-e),v=e=>e<.5?_(2*e)/2:(b(2*(e-.5))+1)/2,w=e=>-(Math.sqrt(1-e*e)-1),x=e=>1-w(1-e),S=e=>e<.5?w(2*e)/2:(x(2*(e-.5))+1)/2;function T(e){const t=2*(e-Math.sqrt((e-1)*e)),r=t/2/e;return i=>i<r?e*i*i:t*i-t+1}function C(e,t){return(r,i)=>r<t?t*e(r/t,i):1-e((1-r)/(1-t),i)*(1-t)}const P=C(T(1),1),M=C(T(1),0),R=C(T(1),.5),O=C(T(2),1),I=C(T(2),0),F=C(T(2),.5),A=C(T(3),1),D=C(T(3),0),E=C(T(3),.5),L=C(T(4),1),V=C(T(4),0),U=C(T(4),.5),B={linear:r,"in-quad":i,"out-quad":s,"in-out-quad":n,"in-coast-quad":P,"out-coast-quad":M,"in-out-coast-quad":R,"in-cubic":o,"out-cubic":a,"in-out-cubic":l,"in-coast-cubic":O,"out-coast-cubic":I,"in-out-coast-cubic":F,"in-quart":c,"out-quart":u,"in-out-quart":d,"in-coast-quart":A,"out-coast-quart":D,"in-out-coast-quart":E,"in-quint":h,"out-quint":p,"in-out-quint":f,"in-coast-quint":L,"out-coast-quint":V,"in-out-coast-quint":U,"in-sine":m,"out-sine":g,"in-out-sine":y,"in-expo":_,"out-expo":b,"in-out-expo":v,"in-circ":w,"out-circ":x,"in-out-circ":S,"quad-in":i,"quad-out":s,"quad-in-out":n,"quad-in-coast":P,"quad-out-coast":M,"quad-in-out-coast":R,"cubic-in":o,"cubic-out":a,"cubic-in-out":l,"cubic-in-coast":O,"cubic-out-coast":I,"cubic-in-out-coast":F,"quart-in":c,"quart-out":u,"quart-in-out":d,"quart-in-coast":A,"quart-out-coast":D,"quart-in-out-coast":E,"quint-in":h,"quint-out":p,"quint-in-out":f,"quint-in-coast":L,"quint-out-coast":V,"quint-in-out-coast":U,"sine-in":m,"sine-out":g,"sine-in-out":y,"expo-in":_,"expo-out":b,"expo-in-out":v,"circ-in":w,"circ-out":x,"circ-in-out":S,ease:e=>t.easingFunctions.ease(e),"ease-in":e=>t.easingFunctions.easeIn(e),"ease-out":e=>t.easingFunctions.easeOut(e),"ease-in-out":e=>t.easingFunctions.easeInOut(e)};e.EasingFunctions=B,e.inCirc=w,e.inCoastCubic=O,e.inCoastQuad=P,e.inCoastQuart=A,e.inCoastQuint=L,e.inCubic=o,e.inExpo=_,e.inOutCirc=S,e.inOutCoastCubic=F,e.inOutCoastQuad=R,e.inOutCoastQuart=E,e.inOutCoastQuint=U,e.inOutCubic=l,e.inOutExpo=v,e.inOutQuad=n,e.inOutQuart=d,e.inOutQuint=f,e.inOutSine=y,e.inQuad=i,e.inQuart=c,e.inQuint=h,e.inSine=m,e.linear=r,e.outCirc=x,e.outCoastCubic=I,e.outCoastQuad=M,e.outCoastQuart=D,e.outCoastQuint=V,e.outCubic=a,e.outExpo=b,e.outQuad=s,e.outQuart=u,e.outQuint=p,e.outSine=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/unitBezier":function(){define(["exports"],function(e){"use strict";function t(e,t,r,i){const s=3*e,n=3*(r-e)-s,o=1-s-n,a=3*t,l=3*(i-t)-a,c=1-a-l;function u(e){return((o*e+n)*e+s)*e}function d(e){return(3*o*e+2*n)*e+s}return function(e,t=1e-6){return r=function(e,t){let r,i,s,n,o,a;for(s=e,a=0;a<8;a++){if(n=u(s)-e,Math.abs(n)<t)return s;if(o=d(s),Math.abs(o)<1e-6)break;s-=n/o}if(r=0,i=1,s=e,s<r)return r;if(s>i)return i;for(;r<i;){if(n=u(s),Math.abs(n-e)<t)return s;e>n?r=s:i=s,s=.5*(i-r)+r}return s}(e,t),((c*r+l)*r+a)*r;var r}}const r=/^cubic-bezier\((.*)\)/,i={};i.ease=t(.25,.1,.25,1),i.linear=t(0,0,1,1),i.easeIn=i["ease-in"]=t(.42,0,1,1),i.easeOut=i["ease-out"]=t(0,0,.58,1),i.easeInOut=i["ease-in-out"]=t(.42,0,.58,1),e.easingFunctions=i,e.parse=function(e){let s=i[e]||null;if(!s){const i=r.exec(e);if(i){const e=i[1].split(",").map(e=>parseFloat(e.trim()));4!==e.length||e.some(e=>isNaN(e))||(s=t.apply(t,e))}}return s},e.unitBezier=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/PointToPointAnimationController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../ViewAnimation","../../animation/pointToPoint/Animation","./AnimationController","../../webgl/RenderCamera","../../webgl-engine/lib/Intersector","../../../animation/easing"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";e.PointToPointAnimationController=class extends u.AnimationController{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.type="point-to-point",this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new c.Animation(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new l}get isInteractive(){return"interaction"===this.mode}begin(e,t){this._hasTarget=!0;const r=this.animationSettings(t);f.copyFrom(this.view.state.camera);const i=new h.Intersector(this.view.state.viewingMode);this._intersectionHelper.intersectRay(f.ray,i,m)&&(f.center=m),this.animation.update(f,e,r),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?p.EasingFunctions[e.easing]:e.easing}}},t.__decorate([r.property({constructOnly:!0})],e.PointToPointAnimationController.prototype,"mode",void 0),t.__decorate([r.property({readOnly:!0})],e.PointToPointAnimationController.prototype,"isInteractive",null),e.PointToPointAnimationController=t.__decorate([o.subclass("esri.views.3d.state.controllers.PointToPointAnimationController")],e.PointToPointAnimationController);let f=new d;const m=a.create();e.cleanupPointToPointAnimationController=function(){f=new d},e.isPointToPointAnimationController=function(e){return null!=e&&"type"in e&&"point-to-point"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/animation/pointToPoint/Animation":function(){define(["exports","../../../../core/time","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","./Camera","../../../animation/pointToPoint/Animation"],function(e,t,r,i,s,n){"use strict";const o=i.create();e.Animation=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=t.Milliseconds(0),this._animation=new n.Animation(()=>new s.Camera(e)),this._current=new s.Camera(e)}update(e,i,s){const{source:n,target:a}=this._animation.definition,l=r.subtract(o,i.center,e.center),c=r.length(l);c>=1e-5?(l[0]/=c,l[1]/=c,l[2]/=c):(l[0]=0,l[1]=1,l[0]=0),r.copy(n.direction,l),r.copy(a.direction,l),n.copyFromRenderCamera(e),a.copyFromRenderCamera(i),this._current.copyFrom(n),this._animation.update(n,a,s),this.currentTime=t.Milliseconds(0),e.almostEquals(i)&&(this.currentTime=this._animation.time)}cameraAt(e,t){this._animation.cameraAt(e,this._current),this._current.copyToRenderCamera(t)}step(e,r){this.finished||(this.currentTime=t.Milliseconds(this.currentTime+t.millisecondsFromSeconds(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/animation/pointToPoint/Camera":function(){define(["exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../support/mathUtils"],function(e,t,r,i,s,n,o){"use strict";const a=n.create(),l=n.create(),c=n.create(),u=n.create(),d=n.create(),h=n.create(),p=n.UNIT_Z,f=n.UNIT_Y,m=n.UNIT_X,g=i.create();e.Camera=class{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=n.create(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=n.clone(f),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotate(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(1===this.viewingMode){const r=(s.length(this.center)+s.length(e.center))/2;t.pan=o.angle(this.center,e.center)*r}else t.pan=s.distance(this.center,e.center);let r=Math.abs(e._yaw-this._yaw);r>=Math.PI&&(r=2*Math.PI-r);const i=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(r,i),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,r,i){1===this.viewingMode?o.slerp(e.center,r.center,i.pan,this.center):s.lerp(this.center,e.center,r.center,i.pan),this._distance=isFinite(r.distance)?t.lerp(e.distance,r.distance+i.zoomOffset,i.zoom):e.distance,this._pitch=t.lerp(e.pitch,r.pitch,i.rotate);let n=e._yaw;const a=r._yaw;Math.abs(a-n)>=Math.PI&&(n+=2*(n<a?1:-1)*Math.PI),this._yaw=t.lerp(n,a,i.rotate),this._fov=t.lerp(e.fov,r.fov,i.fov)}copyFrom(e){s.copy(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,s.copy(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,g);var r;s.copy(this.center,e.center),s.subtract(u,e.center,e.eye),s.transformMat3(u,u,t),s.transformMat3(d,e.up,t),this._distance=s.length(u),0!==this._distance&&(u[0]/=this._distance,u[1]/=this._distance,u[2]/=this._distance),this._pitch=(r=u,Math.PI-o.angle(p,r)),this._yaw=function(e,t){const r=h;return Math.abs(t[2])<.5?(s.copy(r,t),e[2]>0&&s.scale(r,r,-1)):s.copy(r,e),s.cross(l,r,p),s.normalize(l,l),o.angle(m,l,p)}(u,d),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,g);r.transpose(t,t),this._axisAngleVec3(m,this._pitch-Math.PI/2,f,u),this._axisAngleVec3(p,this._yaw,u,u),this._axisAngleVec3(m,this._pitch-Math.PI/2,p,d),this._axisAngleVec3(p,this._yaw,d,d),s.scale(u,u,this._distance),s.transformMat3(u,u,t),s.transformMat3(d,d,t),e.center=this.center,e.eye=s.subtract(u,this.center,u),e.up=d,e.fov=this._fov}_axisAngleVec3(e,t,r,i){const n=Math.cos(t),o=Math.sin(t);return s.scale(a,r,n),s.cross(l,e,r),s.scale(l,l,o),s.scale(c,e,(1-n)*s.dot(e,r)),s.add(i,s.add(i,a,l),c)}_lookAtOrientation(e,t=i.create()){return this._upAtLookAt(e,c),s.cross(a,this.direction,c),s.normalize(a,a),0===a[0]&&0===a[1]&&0===a[2]&&s.copy(a,m),s.cross(l,c,a),s.normalize(l,l),t[0]=a[0],t[1]=l[0],t[2]=c[0],t[3]=a[1],t[4]=l[1],t[5]=c[1],t[6]=a[2],t[7]=l[2],t[8]=c[2],t}_upAtLookAt(e,t){return 2===this.viewingMode?s.copy(t,p):s.normalize(t,e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/animation/pointToPoint/Animation":function(){define(["exports","../../../core/time","../easing","./Definition","./InterpolateComponents","./Settings","./apex/Path"],function(e,t,r,i,s,n,o){"use strict";const a=new s.InterpolateComponents;e.Animation=class{get time(){return this._time}get isLinear(){return 1===this.path.segments.length}constructor(e){this._time=t.Milliseconds(0),this._easing=r.inOutCoastQuad,this.definition=new i.Definition(e),this.path=new o.Path}update(e,i,s){this.definition.update(e,i,s),this.path.update(this.definition,s),this._time=this._applyTimeSettings(t.millisecondsFromSeconds(isFinite(this.path.time)?this.path.time:t.Seconds(0)),s),this._easing=s.easing??(this._time>=1e3?r.inOutCoastQuad:r.outExpo)}cameraAt(e,t){e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const r=this.path.interpolateComponentsAt(e,a);t.interpolate(this.definition.source,this.definition.target,r)}_normalizedEasing(e){const t=this._easing(0,this._time),r=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(r-t)}_applyTimeSettings(e,r){const i=null!=r.speedFactor?r.speedFactor:1,s=r.minDuration??n.defaultSettings.minDuration/i,o=r.maxDuration??n.defaultSettings.maxDuration/i;return null!=r.duration?t.Milliseconds(r.duration):t.Milliseconds(Math.min(Math.max(e/i,s),o))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/animation/pointToPoint/Definition":function(){define(["exports","../../../core/libs/gl-matrix-2/math/common","./Camera","./Settings"],function(e,t,r,i){"use strict";class s{constructor(e){this._createCamera=e,this.compared=new r.CompareResult,this.segmentStart=0,this.segmentEnd=1,this.settings={desiredScreenFlow:i.defaultSettings.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new s(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,r){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=r.desiredScreenFlow??i.defaultSettings.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>t.getEpsilon()}get hasFov(){return Math.abs(this.compared.fov)>t.getEpsilon()}get hasRotate(){return this.compared.rotate>t.getEpsilon()}}e.Definition=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/animation/pointToPoint/Camera":function(){define(["exports"],function(e){"use strict";e.CompareResult=class{constructor(){this.pan=0,this.rotate=0,this.fov=0,this.sourceZoom=0,this.targetZoom=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/animation/pointToPoint/Settings":function(){define(["exports","../../../core/time"],function(e,t){"use strict";const r={desiredScreenFlow:2,minDuration:t.Milliseconds(500),maxDuration:t.Milliseconds(8e3)},i={...r,maxDuration:t.Milliseconds(4e3)};e.defaultSettings=r,e.defaultSettings2D=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/animation/pointToPoint/InterpolateComponents":function(){define(["exports"],function(e){"use strict";e.InterpolateComponents=class{constructor(){this.pan=0,this.rotate=0,this.zoom=0,this.fov=0,this.zoomOffset=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/animation/pointToPoint/apex/Path":function(){define(["exports","../../easing","../Path","../Segment","./planning"],function(e,t,r,i,s){"use strict";class n extends r.Path{constructor(e,t){super(),this._preallocSegments=[new i.Segment,new i.Segment,new i.Segment],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();const r=t?.apex?s.optimalDistance(e,t.apex):null;this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,r?this._updateWithApex(r,t?.apex):this._updateWithoutApex()}segmentInterpolateComponentsAt(e,r,i){e.interpolateComponentsAt(r,i),e===this._ascensionSegment?i.zoom=t.outQuad(i.zoom):e===this._descensionSegment&&(i.zoom=t.inQuad(i.zoom))}_updateWithApex(e,t){const[r,i,s]=this._preallocSegments,n=t?.ascensionFactor??.5,o=Math.min(1-n,null!=t?.ascensionFactor&&null!=t.descensionFactor?t.descensionFactor:.5),a=1-n-o;r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*n,r.definition.compared.rotate=this.definition.compared.rotate*n,r.definition.segmentEnd=n,r.update(),this._ascensionSegment=r,this.segments.push(r),a>0&&(i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.copyFrom(this.definition),i.definition.compared.sourceZoom=e,i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*a,i.definition.compared.rotate=this.definition.compared.rotate*a,i.definition.segmentStart=r.definition.segmentEnd,i.definition.segmentEnd=r.definition.segmentEnd+a,i.update(),this.segments.push(i)),s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.compared.sourceZoom=e,s.definition.compared.pan=this.definition.compared.pan*o,s.definition.compared.rotate=this.definition.compared.rotate*o,s.definition.segmentStart=n+a,s.update(),this._descensionSegment=s,this.segments.push(s)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}e.Path=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/animation/pointToPoint/Path":function(){define(["exports","../../../core/time"],function(e,t){"use strict";e.Path=class{constructor(){this.segments=new Array}get time(){return this.segments.reduce((e,r)=>t.Seconds(e+r.time),t.Seconds(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let r=0,i=0;const s=this.definition,n=this.segments.reduce((e,t)=>e||t.definition.hasZoom,!1);for(let o=0;o<this.segments.length;o++){const a=this.segments[o],l=a.definition;if(e<=a.time||o===this.segments.length-1){if(this.segmentInterpolateComponentsAt(a,0===a.time?0:e/a.time,t),s.hasPan&&!isNaN(t.pan)&&isFinite(s.compared.pan)?t.pan=(r+l.compared.pan*t.pan)/s.compared.pan:t.pan=1,s.hasRotate&&!isNaN(t.rotate)&&isFinite(s.compared.rotate)?t.rotate=(i+l.compared.rotate*t.rotate)/s.compared.rotate:t.rotate=1,n&&!isNaN(t.zoom)&&isFinite(l.compared.targetZoom)){const{sourceZoom:e,targetZoom:r}=l.compared,i=t.zoom*(r-e)+e,s=this.segments[0].definition.compared.sourceZoom,n=this.segments[this.segments.length-1].definition.compared.targetZoom,o=Math.abs(r-s)>Math.abs(e-s)?r:e;t.zoomOffset=o-n,t.zoom=(i-s)/(o-s)}else t.zoom=1;return t}e-=a.time,r+=l.compared.pan,i+=l.compared.rotate}}segmentInterpolateComponentsAt(e,t,r){e.interpolateComponentsAt(t,r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/animation/pointToPoint/Segment":function(){define(["exports","../../../core/mathUtils","../../../core/time"],function(e,t,r){"use strict";const i=t.deg2rad(45);e.Segment=class{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,r=t.sourceZoom,i=t.targetZoom;this._zoomSign=r>i?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(r);const s=(e.source.pixelsPerRotate()+e.target.pixelsPerRotate())/2;this._rotatePixels=t.rotate*s}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:s,hasRotate:n}=this.definition;let o=0,a=0;i&&(s&&(o=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(a=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(i&&s&&n){const e=o+a+o*a;this._zoomPixelFlow=o*a/e*l,this._panPixelFlow=a/e*l,this._rotatePixelFlow=o/e*l}else if(i&&s){const e=1+o;this._zoomPixelFlow=o/e*l,this._panPixelFlow=1/e*l}else if(i&&n){const e=1+a;this._zoomPixelFlow=a/e*l,this._rotatePixelFlow=1/e*l}else if(s&&n){const e=this._panPixelsAtSource/this._rotatePixels,t=1+e;this._panPixelFlow=e/t*l,this._rotatePixelFlow=1/t*l}else s?this._panPixelFlow=l:i?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);if(this._time=r.Seconds(Math.max(this.rotateTime,this.zoomTime,this.panTime)),this.fovTime>this._time){const e=this.fovTime/this._time;this._time=this.fovTime,this._zoomPixelFlow/=e,this._panPixelFlow/=e,this._rotatePixelFlow/=e}}get rotateTime(){return this.definition.hasRotate?r.Seconds(this._rotatePixels/this._rotatePixelFlow):r.Seconds(0)}get zoomTime(){return this.definition.hasZoom?r.Seconds(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):r.Seconds(0)}get fovTime(){return this.definition.hasFov?r.Seconds(Math.abs(this.definition.compared.fov)/i):r.Seconds(0)}get panTime(){if(!this.definition.hasPan)return r.Seconds(0);if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return r.Seconds(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return r.Seconds(this._panPixelsAtSource/this._panPixelFlow)}_interpolateComponentsZoom(e){if(0===e||1===e)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom;return(t*(t/r)**-e-t)/(r-t)}return e}_interpolateComponentsFov(e){if(0===e)return this.definition.segmentStart;if(1===e)return this.definition.segmentEnd;if(this.definition.hasFov){const{segmentStart:t,segmentEnd:r}=this.definition;return t+e*(r-t)}return this.definition.segmentStart}_interpolateComponentsPan(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),t.zoom=this._interpolateComponentsZoom(e),t.pan=this._interpolateComponentsPan(e),t.rotate=this._interpolateComponentsRotate(e),t.zoomOffset=0,t.fov=this._interpolateComponentsFov(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/animation/pointToPoint/apex/planning":function(){define(["exports","./functions"],function(e,t){"use strict";e.optimalDistance=function(e,r){let i=function(e,t){const r=Math.max(e.compared.sourceZoom,e.compared.targetZoom),i=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return i<r?null!=t.maximumDistance?r+(t.maximumDistance-r)/2:1.5*r:t.maximumDistance?Math.min(t.maximumDistance,i):i}(e,r);const s={ascensionFactor:null!=r.ascensionFactor?r.ascensionFactor:.5,descensionFactor:null!=r.descensionFactor?r.descensionFactor:.5},n=0===s.ascensionFactor,o=0===s.descensionFactor,a=n?t.tAscensionZoomOnly:t.tAscensionZoomPan,l=n?t.dtAscensionZoomOnly:t.dtAscensionZoomPan,c=n?t.ddtAscensionZoomOnly:t.ddtAscensionZoomPan,u=o?t.tDescensionZoomOnly:t.tDescensionZoomPan,d=o?t.dtDescensionZoomOnly:t.dtDescensionZoomPan,h=o?t.ddtDescensionZoomOnly:t.ddtDescensionZoomPan,p=r=>a(e,r,s)+t.tPanion(e,r,s)+u(e,r,s),f=r=>l(e,r,s)+t.dtPanion(e,r,s)+d(e,r,s),m=r=>c(e,r,s)+t.ddtPanion(e,r,s)+h(e,r,s);let g=p(i);const y=t.tBaseLine(e);let _;const b=r.maximumIterations||20,v=null!=r.maximumDistance?r.maximumDistance:1/0;for(_=0;_<b;_++){const t=r.desiredSlope??1e-6;let s=f(i);Math.abs(s)>t&&(s+=t);const n=s/m(i);if(isNaN(n)||i>=v&&n<0){if(!isFinite(v))return null;i=v,g=p(i);break}if(i-=n,i<=e.compared.sourceZoom||i<=e.compared.targetZoom)return null;const o=p(i);if(Math.abs(o-g)/g<=.005)break;g=o}return isNaN(g)||g>.7*y||i<=e.compared.sourceZoom||i<=e.compared.targetZoom?null:i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/animation/pointToPoint/apex/functions":function(){define(["exports"],function(e){"use strict";e.ddtAscensionZoomOnly=function(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)},e.ddtAscensionZoomPan=function(e,t,r){const i=t-e.compared.sourceZoom,s=1/i,n=1/t,o=Math.log(e.compared.sourceZoom*n),a=(r.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(i))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*a+2*s*o+2*n-2*o*a/(i*i)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)},e.ddtDescensionZoomOnly=function(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)},e.ddtDescensionZoomPan=function(e,t,r){const i=t-e.compared.targetZoom,s=1/i,n=1/t,o=Math.log(t/e.compared.targetZoom),a=(e.halfWindowPanAtZoom(t)+r.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*a-2*s*o+2*n+2*o*a/(i*i)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)},e.ddtPanion=function(e,t,r){return-2*e.compared.pan*e.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))},e.dtAscensionZoomOnly=function(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)},e.dtAscensionZoomPan=function(e,t,r){const i=1/t,s=Math.log(e.compared.sourceZoom*i),n=1/e.desiredPixelFlow,o=1/Math.LN2,a=t-e.compared.sourceZoom,l=1/a,c=(r.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(a))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*i*n*o*l*c-e.halfWindowSize*s*n*o*l+e.halfWindowSize*s*n*o*c/(a*a)},e.dtDescensionZoomOnly=function(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)},e.dtDescensionZoomPan=function(e,t,r){const i=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,n=1/Math.LN2,o=-t+e.compared.targetZoom,a=1/o,l=(-e.halfWindowPanAtZoom(t)-r.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*i*s*n*a+e.halfWindowSize*i*s*n*l/(o*o)+e.halfWindowSize*s*n*a*l/t},e.dtPanion=function(e,t,r){return e.compared.pan*e.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))},e.tAscensionZoomOnly=function(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)},e.tAscensionZoomPan=function(e,t,r){const i=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(i);return-e.halfWindowSize*(r.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)},e.tBaseLine=function(e){const t=e.compared.sourceZoom-e.compared.targetZoom;if(0===t)return e.compared.pan*e.halfWindowSize/(e.desiredPixelFlow*e.halfWindowPanAtZoom(e.compared.sourceZoom));const r=Math.LN2*e.compared.pan,i=t,s=e.halfWindowPanAtZoom(i),n=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*s);return e.compared.sourceZoom<=e.compared.targetZoom?n*(r-s):n*(r+s)},e.tDescensionZoomOnly=function(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)},e.tDescensionZoomPan=function(e,t,r){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-r.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))},e.tPanion=function(e,t,r){return-e.compared.pan*e.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/AnimationController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../ViewAnimation","./CameraController"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.AnimationController=class extends u.CameraController{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(i.createAbortError()),this._asyncResult=null),4===this.state||3===this.state?(r.assertIsSome(e),4===this.state?e.resolve():e.reject(i.createAbortError())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=2,null!=this.viewAnimation&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!this.viewAnimation||0!==this.state&&2!==this.state||(this.viewAnimation.state===c.state.FINISHED?this.finish():this.viewAnimation.state===c.state.STOPPED&&(this.state=3))}onControllerEnd(e){null==this.viewAnimation||this.viewAnimation.done||(4===this.state?this.viewAnimation.finish():3===this.state&&this.viewAnimation.stop()),this._asyncResult&&(4===this.state?this._asyncResult.resolve():this._asyncResult.reject(i.createAbortError()))}finish(){this.finishController()}},e.AnimationController=t.__decorate([l.subclass("esri.views.3d.state.controllers.AnimationController")],e.AnimationController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/CameraController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";e.CameraController=class extends r{constructor(e){super(e),this.state=0}get running(){return 2===this.state}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=3,!0)}finishController(){this.state=4}get steppingFinished(){return!1}},t.__decorate([i.property({constructOnly:!0})],e.CameraController.prototype,"view",void 0),t.__decorate([i.property({readOnly:!0})],e.CameraController.prototype,"running",null),t.__decorate([i.property()],e.CameraController.prototype,"state",void 0),t.__decorate([i.property({readOnly:!0})],e.CameraController.prototype,"isInteractive",null),e.CameraController=t.__decorate([a.subclass("esri.views.3d.state.controllers.CameraController")],e.CameraController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/utils/navigationUtils":function(){define(["exports","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vectorStacks","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl/RenderCamera","../../webgl-engine/lib/verticalOffsetUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";const b={exclude:new Set([_.terrainId])};function v(e,t,r){const i=s.fromRotation(f.sm4d.get(),r[3],u.axis(r));null==i||s.exactEquals(i,n.IDENTITY)||(l.subtract(re,e.eye,t),l.transformMat4(re,re,i),e.eye=l.add(re,re,t),l.subtract(re,e.center,t),l.transformMat4(re,re,i),e.center=l.add(re,re,t),e.up=l.transformMat4(re,e.up,i))}const w=i.createScreenPointArray();function x(e,t,r,i){return Math.sin(e/l.length(t))*(r+i.radius)}const S={Elevation:3e4,Angle:r.deg2rad(16)},T=r.deg2rad(80),C=c.create();function P(e,t,r,i){const s=m.fromScreenAtEye(t,r,ae);return!(null==s||(p.closestPointOnSilhouette(e,s,M),p.intersectRay(e,s,i)?l.squaredDistance(M,s.origin)<l.squaredDistance(i,s.origin)&&(l.copy(i,M),1):(l.subtract(R,t.eye,t.center),l.normalize(R,R),h.fromNormalAndOffset(R,-l.dot(l.normalize(R,R),M),O),h.intersectRay(O,s,i),1)))}const M=c.create(),R=c.create(),O=h.create();function I(e,i,s,n,o,a){let u=0;if(l.cross(ne,e,i),l.subtract(ie,e,i),l.length(e)<=o||!n.aboveGround){l.cross(s,ie,n.eye);const d=l.dot(e,i)/(l.length(e)*l.length(i));if(d<.9999)u=r.acosClamped(d);else{const t=l.length(l.cross(c.create(),e,i))/(l.length(e)*l.length(i));u=r.asinClamped(t)}const h=Math.cos(r.clamp(t.cyclicalPI.normalize(r.deg2rad(a)),0,T));u=-u-Math.max(0,l.length(i)-o)/(h*o)}else l.subtract(F,n.eye,n.center),l.cross(s,ie,F),u=-l.length(ie)/o;return l.normalize(s,s),l.scale(s,s,l.length(ne)),u}const F=c.create();function A(e,i,s,n){let o,a;const l=Math.cos(r.clamp(t.cyclicalPI.normalize(r.deg2rad(n)),0,T));return o=i>s?-(i-s)/(l*s):i<-s?Math.PI-(i+s)/(l*s):r.acosClamped(i/s),a=e>s?-(e-s)/(l*s):e<-s?Math.PI-(e+s)/(l*s):r.acosClamped(e/s),(a-o)*s}function D(e,t,r,i,s,n,a,c,u,d){const h=A(e[2],t[2],n[3],c),p=u?A(e[0],t[0],n[3],180):t[0]-e[0],f=Math.sin(a)*p-Math.cos(a)*h,m=Math.cos(a)*p+Math.sin(a)*h;l.normalize(re,s);const g=u?f/Math.sqrt(Math.abs(n[3]**2-l.dot(r,re)**2)):f/n[3],y=m/Math.sqrt(Math.abs(n[3]**2-l.dot(r,i)**2));o.set(d,g,y)}function E(e,t,r,i,s,n,o,a,c,u){l.cross(ne,e,t),d.coordinateSystemFromOneAxisAndNormalVector(n.up,n.eye,H,W,$),d.coordinateSystemFromOneAxisAndNormalVector([0,0,1],n.eye,j,G,q),l.copy(r,G),l.copy(i,j),l.normalize(r,r),l.scale(r,r,l.length(ne)),d.vectorCoordinates(e,l.normalize(W,W),l.normalize($,$),l.normalize(H,H),Q),d.vectorCoordinates(t,W,$,H,Z),D(Q,Z,e,j,G,o,a,c,u,s)}function L(e,t,r,i,n,o,a){s.fromRotation(J,n,i),s.fromRotation(K,a,o),s.multiply(ee,J,K),l.subtract(t,e,r),l.transformMat4(t,t,ee),l.add(t,t,r)}function V(e,t,r,i,n,o){s.fromRotation(J,i,r),s.fromRotation(K,o,n),s.multiply(ee,J,K),l.subtract(re,e.eye,t),l.transformMat4(re,re,ee),e.eye=l.add(re,re,t),l.subtract(re,e.center,t),l.transformMat4(re,re,ee),e.center=l.add(re,re,t),l.subtract(re,e.up,t),l.transformMat4(re,re,ee),e.up=l.add(re,re,t)}const U={Pole:.95,Angle:r.deg2rad(18),Tilt:45,TiltHysteresisMargin:1e-7};let B=!1;function N(e,t,r,i,s,n){const o=Math.abs(i)>Math.PI-U.Angle||Math.abs(i)<U.Angle,a=(Math.abs(e[2])<r*U.Pole||Math.abs(t)>r)&&n;return o&&a?!B&&s<U.Tilt-U.TiltHysteresisMargin?B=!0:B&&s>U.Tilt+U.TiltHysteresisMargin&&(B=!1):B=!1,B}function k(e,t,r,i,s,n){if(n)u.fromPoints(r,i,X),v(t,p.getCenter(e),X);else{const n=I(r,i,oe,t,e[3],s);v(t,p.getCenter(e),u.wrapAxisAngle(oe,n))}}function z(e,t,r,i,s,n,o){const a=o?20:1;let c,u;l.copy(te,i),se.copyFrom(t);for(let i=0;i<a&&l.squaredDistance(r,te)>1e-12&&(c=l.squaredDistance(r,te),E(r,te,G,j,Y,se,e,s,n,o),V(se,p.getCenter(e),j,Y[1],G,Y[0]),L(te,te,p.getCenter(e),j,Y[1],G,Y[0]),u=l.squaredDistance(r,te),u<c||0===i);i++)t.copyFrom(se)}const j=c.create(),G=c.create(),q=c.create(),H=c.create(),W=c.create(),$=c.create(),Q=c.create(),Z=c.create(),Y=a.create(),X=u.create(),J=n.create(),K=n.create(),ee=n.create(),te=c.create(),re=c.create(),ie=c.create();let se=new y;const ne=c.create(),oe=c.create(),ae={origin:c.create(),direction:c.create()},le={origin:c.create(),direction:c.create()};e.TiltThresholdPanningSpeed=T,e.VerticalPanTresholds=S,e.applyPanPlanar=function(e,t,r){l.subtract(C,r,t),e.eye=l.subtract(re,e.eye,C),e.center=l.subtract(re,e.center,C)},e.applyPanSphericalDirectRotation=k,e.applyPanSphericalPreserveHeading=z,e.applyRotation=v,e.applyRotationWithTwoAxes=V,e.applyZoomOnSphere=function(e,t,r){t.getScreenCenter(w),g.intersectScreen(e,t,w,re)&&(t.center=re);const i=t.distance,s=i*r;if(Math.abs(i-s)<1e-6)return;const n=l.scale(f.sv3d.get(),t.viewForward,s);t.eye=l.subtract(re,t.center,n)},e.applyZoomToPoint=function(e,t,r,i){const s=f.sv3d.get();let n=1-r;l.subtract(s,t,e.eye);const o=l.length(s);let a=o*(1-n);n>=0&&a<i&&(a=i,n=-(a-o)/o),Math.abs(o-a)<1e-6||(l.scale(s,s,n),e.eye=l.add(re,e.eye,s),e.center=l.lerp(re,e.center,t,n))},e.centroid=function(e,t){l.set(t,0,0,0);for(const r of e)l.add(t,t,r);l.scale(t,t,1/e.length)},e.cleanupNavigationUtils=function(){se=new y},e.excludeTerrain=b,e.getTiltScaleFactor=function(e,t,r=1/0){const i=Math.abs(l.dot(e,t));return Math.min(r,1/i)},e.intersectPlaneFromScreenPoint=function(e,t,r,i){return h.intersectRay(e,m.fromScreen(t,r,ae),i)},e.intersectPlaneFromScreenPointAtEye=function(e,t,r,i){return h.intersectRay(e,m.fromScreenAtEye(t,r,ae),i)},e.lengthFromPoints=A,e.maxPanDistanceModifier=5,e.maxRotatePivotDistanceModifier=5,e.maxZoomPivotDistanceModifier=30,e.maxZoomStepDistanceModifier=8,e.minPinchAndPanCameraHeight=50,e.minRotatePivotDistance=10,e.navigationMode=function(e,t,r,i){const s=e.relativeElevation;if(s>S.Elevation&&"global"===i)return 1;m.fromScreenAtEye(e,t,le);const n=Math.sign(s),o=r.worldUpAtPosition(e.eye,re);return-n*l.dot(o,le.direction)<Math.sin(S.Angle)*l.length(le.direction)?0:1},e.normalizeCoordinate=function(e,t,r){return r[0]=t[0]/(e.fullWidth/e.pixelRatio),r[1]=t[1]/(e.fullHeight/e.pixelRatio),r},e.normalizeRotationDelta=function(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e},e.offSurfaceTiltToEyeTiltGlobal=function(e,t,r,i){return x(Math.PI/2,t,r,i)+(e-Math.PI/2)},e.onSurfaceTiltToEyeTiltGlobal=x,e.panMotionToRotationMatrix=function(e,i,n,o,a,c,u,h,p){N(e.center,l.dot(e.up,e.center),l.length(e.center),-t.cyclicalPI.normalize(r.deg2rad(c)),u,i.aboveGround)?function(e,t,r,i,n,o){const{eye:a}=e;d.coordinateSystemFromOneAxisAndNormalVector([0,0,1],a,j,G,q);const c=t.translation[0]*r.pan,u="zoom"===n.mode?0:t.translation[1]*r.pan,h=Math.max(Math.sqrt(Math.abs(1-l.dot(e.center,j)**2/l.length(e.center)**2)),.5),p=(Math.sin(o)*u+Math.cos(o)*c)/h,f=-Math.cos(o)*u+Math.sin(o)*c;switch(s.rotate(i.pan.matrix,i.pan.matrix,p,j),i.pan.enabled=!0,n.mode){case"pan":s.rotate(i.pan.matrix,i.pan.matrix,f,G),i.pan.enabled=!0;break;case"zoom":i.zoom=-t.translation[1]*r.zoom}}(i,n,o,h,p,-t.cyclicalPI.normalize(r.deg2rad(a))):function(e,t,r,i,n){const{eye:o,viewRight:a}=e,c=l.cross(f.sv3d.get(),a,o),u=t.translation[0]*r.pan;switch(0!==u&&(s.rotate(i.pan.matrix,i.pan.matrix,-u,c),i.pan.enabled=!0),n.mode){case"pan":{const e=t.translation[1]*r.pan;0!==e&&(s.rotate(i.pan.matrix,i.pan.matrix,e,a),i.pan.enabled=!0);break}case"zoom":i.zoom=-t.translation[1]*r.zoom}}(i,n,o,h,p)},e.panToPosition=function(e,i,s,n,o,a,c){N(s,l.dot(i.up,s),e[3],-t.cyclicalPI.normalize(r.deg2rad(o)),a,i.aboveGround)?z(e,i,s,n,-t.cyclicalPI.normalize(r.deg2rad(o)),a,c):k(e,i,s,n,a,c)},e.pickPointAndInitSphere=function(e,t,r,i,s,n){const o=c.create(),a=p.create();let u=!0,d=!0;return e.intersectScreen(r,o,n)?a[3]=l.length(o):(d=!1,t.aboveGround&&0!==s?a[3]=Math.max(l.length(t.center),.9*i):a[3]=l.length(t.eye)-t.relativeElevation,1===s?P(a,t,r,o):u=g.intersectScreen(a,t,r,o)),{sphere:a,scenePickPoint:u?o:null,hasGeometryIntersection:d}},e.pivotSearchAreaSize=80,e.preservingHeadingThresholds=U,e.rotatePivotSearchAreaSize=90,e.rotatePointAroundTwoAxes=L,e.rotationAngleAndAxisDirectRotation=I,e.rotationAnglesAndAxesHeadingPreserving=E,e.rotationAnglesHeadingPreserving=D,e.shouldPreserveHeading=N,e.sphereOrPlanePointFromScreenPoint=P,e.zoomPivotDistanceClamp=[1,3e8],e.zoomStepDistanceClamp=[200,1508e5],Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/axisAngle":function(){define(["exports","../../core/libs/gl-matrix-2/math/quat","../../core/libs/gl-matrix-2/factories/quatf64","../../chunks/vec32","./vector","./vectorStacks"],function(e,t,r,i,s,n){"use strict";function o(e=u){return[e[0],e[1],e[2],e[3]]}function a(e,t,r,i,s=o()){return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s}function l(e){return e[3]}function c(e,t){return e[3]=t,e}const u=[0,0,1,0],d=r.create(),h=r.create();e.angle=l,e.axis=function(e){return e},e.compose=function(e,r,i){return t.setAxisAngle(d,e,l(e)),t.setAxisAngle(h,r,l(r)),t.multiply(d,h,d),c(i,t.getAxisAngle(i,d))},e.copy=function(e,t=o()){return a(e[0],e[1],e[2],e[3],t)},e.create=o,e.fromAxisAndAngle=function(e,t){const r=o();return i.copy(r,e),r[3]=t,r},e.fromPoints=function(e,t,r){return i.cross(r,e,t),i.normalize(r,r),r[3]=s.angle(e,t),r},e.fromValues=a,e.setAngle=c,e.up=u,e.wrap=function(e,t,r,i){return a(e,t,r,i,n.sv4d.get())},e.wrapAxisAngle=function(e,t){return a(e[0],e[1],e[2],t,n.sv4d.get())},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/geometryUtils/ray":function(){define(["exports","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/vec2","../../../../chunks/vec32","../../../../geometry/support/ray","../../../../geometry/support/vectorStacks"],function(e,t,r,i,s,n){"use strict";function o(e,r,i){return a(e,e.screenToRender(r,t.castRenderScreenPointArray3(n.sv3d.get())),i)}function a(e,s,o){const a=t.castRenderScreenPointArray3(r.copy(n.sv3d.get(),s));if(a[2]=0,!e.unprojectFromRenderScreen(a,o.origin))return null;const l=t.castRenderScreenPointArray3(r.copy(n.sv3d.get(),s));l[2]=1;const c=e.unprojectFromRenderScreen(l,n.sv3d.get());return null==c?null:(i.subtract(o.direction,c,o.origin),o)}function l(e,t,r){i.copy(r.origin,e.eye);const s=i.set(n.sv3d.get(),t[0],t[1],1),o=e.unprojectFromRenderScreen(s,n.sv3d.get());return null==o?null:(i.subtract(r.direction,o,r.origin),r)}e.fromRender=a,e.fromRenderAtEye=l,e.fromScreen=o,e.fromScreenAtEye=function(e,r,i){return l(e,e.screenToRender(r,t.castRenderScreenPointArray3(n.sv3d.get())),i)},e.fromScreenNormalized=function(e,r,n=s.create()){return o(e,t.screenPointObjectToArray(r),n),i.normalize(n.direction,n.direction),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/geometryUtils/sphere":function(){define(["exports","../../../../geometry/support/ray","../../../../chunks/sphere","./ray"],function(e,t,r,i){"use strict";const s=t.create();e.intersectScreen=function(e,t,n,o){const a=i.fromScreenAtEye(t,n,s);return r.intersectRay(e,a,o)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/ZoomStepControllerLocal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/time","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../layers/VoxelWasm","./PointToPointAnimationController","../utils/navigationUtils","../../webgl/RenderCamera","../../webgl-engine/lib/Intersector","../../../animation/easing"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";e.ZoomStepControllerLocal=class extends f.PointToPointAnimationController{constructor(){super(...arguments),this._zoomLocation=u.create(),this._tmpCamera=new g,this._tmpRayDir=u.create(),this._tmpCenter=u.create(),this._beginCamera=new g,this._constraintOptions=new h.ConstraintOptions(15,1,null,this._beginCamera)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const s=new y.Intersector(this.view.state.viewingMode);let n=!1;e>0?(n=this._intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.basemapTerrain.invisible?m.excludeTerrain:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,s,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,s,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:c.copy(this._zoomLocation,this._tmpCamera.center);const o=.6**e;let a=this.view.stage.renderView.getMinimalDepthForArea(p.getVoxelWasm(this.view),t[0],t[1],this.view.state.camera,60);c.subtract(w,this._tmpCamera.eye,this._zoomLocation),c.normalize(w,w);const l=Math.abs(this.view.camera.position.z),d=r.clamp(m.getTiltScaleFactor(v,w,m.maxZoomStepDistanceModifier)*l,m.zoomStepDistanceClamp[0],m.zoomStepDistanceClamp[1]);a=null!=a?a:d;const h=u.create();c.subtract(h,this._zoomLocation,this._tmpCamera.eye),(a<c.length(h)||!n)&&(c.normalize(h,h),c.add(this._zoomLocation,this._tmpCamera.eye,c.scale(h,h,a))),this._updateCamera(this._tmpCamera,o,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:i.Milliseconds(600),easing:_.outExpo}}_updateCamera(e,t,r){c.subtract(this._tmpRayDir,r,e.eye);const i=c.length(this._tmpRayDir);let s=i*t;const n=t<=1,o=Math.max(4,1.01*e.nearFar[0]);0!==s&&(n&&s<o&&(s=o,t=s/i),Math.abs(i-s)<1e-6||(c.scale(this._tmpRayDir,this._tmpRayDir,t),e.eye=c.subtract(b,r,this._tmpRayDir),e.center=c.lerp(b,e.center,r,1-t),d.applyAll(this.view,e,this._constraintOptions)))}},e.ZoomStepControllerLocal=t.__decorate([l.subclass("esri.views.3d.state.controllers.ZoomStepControllerLocal")],e.ZoomStepControllerLocal);const b=u.create(),v=u.fromValues(0,0,1),w=u.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/VoxelWasm":function(){define(["require","exports"],function(e,t){"use strict";const r=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));let i,s=null;const n=new Map;t.addLayerViewToWasm=async function(t){null==s&&(null==i&&(i=new Promise((t,i)=>e(["../../../layers/VoxelWasmPerSceneView"],e=>t(r(e)),i))),s=await i);const o=t.view;let a=n.get(o);return a||(a=new s.default({view:o}),n.set(o,a)),a.addVoxelLayer(t)},t.getVoxelWasm=function(e){return n.get(e)},t.removeLayerViewFromWasm=function(e){const t=e.view,r=n.get(t);r&&r.removeVoxelLayer(e)<1&&(n.delete(t),0===n.size&&(i=null,s=null))},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/handlers/support":function(){define(["exports"],function(e){"use strict";function t(e,t){switch(t){case"primary":return"touch"===e.pointerType||0===e.button;case"secondary":return"touch"!==e.pointerType&&2===e.button;case"tertiary":return"touch"!==e.pointerType&&1===e.button}}e.eventMatchesMousePointerActions=function(e,t){const{button:r,pointerType:i}=e;return"touch"!==i&&t.some(e=>"primary"===e&&0===r||"secondary"===e&&2===r||"tertiary"===e&&1===r)},e.eventMatchesPointerAction=t,e.eventMatchesPointerActions=function(e,r){return r.some(r=>t(e,r))},e.getPointerActions=function(e,{dragPrimary:t,dragSecondary:r,dragTertiary:i}){return[{key:"primary",value:t},{key:"secondary",value:r},{key:"tertiary",value:i}].filter(t=>t.value===e).map(e=>e.key)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/input/handlers/DragRotate":function(){define(["exports","../../../../core/screenUtils","../../state/controllers/RotateController","../../../input/InputHandler","../../../input/handlers/support"],function(e,t,r,i,s){"use strict";class n extends i.InputHandler{constructor(e,t,r,i){super(!0),this._view=e,this.pointerActions=t,this._pivot=r,this.registerIncoming("drag",i,e=>this._handleDrag(e))}_handleDrag(e){const i=e.data;if(i.pointers.size>1)return;if(!s.eventMatchesMousePointerActions(e.data,this.pointerActions))return;const n=t.createScreenPointArray(i.center.x,i.center.y);switch(i.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new r.RotateController({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(n);break;case"update":this._cameraController&&this._cameraController.update(n);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}e.DragRotate=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/RotateController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../layers/VoxelWasm","../Constraints","./InteractiveController","../utils/navigationUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v){"use strict";e.RotateController=class extends b.InteractiveController{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=0,this._rotScale=0,this._lastPoint=h.create(),this._tmpWorldUp=f.create(),this._tmpViewDir=f.create(),this._tmpRotCurPoint=h.create(),this._tmpTransf=u.create(),this._tmpAxis=f.create(),this._tmpPivotPoint=f.create(),this._pivotPos=f.create(),this._constraintOptions=new g.ConstraintOptions(15,2,0,this.startCamera)}initialize(){this._rotScale=0===this.pivot?3:1.5}begin(e){if(this.running){switch(this.pivot){case 1:p.copy(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=3,this._constraintOptions.tiltMode=1,this._constraintOptions.selection=0;break;case 0:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.basemapTerrain.invisible?v.excludeTerrain:{});t||p.copy(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=2,this._constraintOptions.tiltMode=0,this._constraintOptions.selection=11;break}}v.normalizeCoordinate(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const r=this.startCamera,s=f.create();p.subtract(s,this._pivotPos,r.eye);const n=p.length(s),o=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(r.eye,x);let a=Math.max(v.getTiltScaleFactor(x,r.viewForward,v.maxRotatePivotDistanceModifier)*o,v.minRotatePivotDistance);t&&(a=Math.min(n,a));const l=i.createScreenPointArray(r.width/r.pixelRatio*.5,r.height/r.pixelRatio*.5),c=v.navigationMode(this.startCamera,l,this.view.renderCoordsHelper,this.view.viewingMode);let u=this.view.stage.renderView.getMinimalDepthForArea(y.getVoxelWasm(this.view),r.fullWidth/r.pixelRatio*.5,r.fullHeight/r.pixelRatio*.5,r,2.5*v.rotatePivotSearchAreaSize,v.rotatePivotSearchAreaSize),d=this.view.stage.renderView.getMinimalDepthForArea(y.getVoxelWasm(this.view),e[0],e[1],r,v.rotatePivotSearchAreaSize);null==u&&null==d||(u=u??d??0,d=null==d||1===c?u:d,a=u>d?d:u,a=t?Math.min(a,n):a),p.normalize(s,s),p.copy(this._pivotPos,p.add(this._tmpPivotPoint,r.eye,p.scale(this._tmpPivotPoint,s,a)))}update(e){if(this.running){switch(this.pivot){case 1:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case 0:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}m.applyAll(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(e,t,i,s){this.view.renderCoordsHelper.worldUpAtPosition(s,this._tmpWorldUp),v.normalizeCoordinate(e,t,this._tmpRotCurPoint);let n=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,o=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;p.subtract(this._tmpViewDir,i,s);const a=p.length(this._tmpViewDir),l=r.acosClamped(p.dot(this._tmpViewDir,this._tmpWorldUp)/a);if(1===this.pivot){n*=-.5;const e=.5*Math.PI-l,t=.5*Math.PI*.99;n=e-Math.max(-t,Math.min(t,e+n))}return n=r.clamp(n+l,_.TiltRange.min,_.TiltRange.max)-l,p.cross(this._tmpAxis,e.up,this._tmpViewDir),0===this.pivot&&(o=-o),c.fromRotation(this._tmpTransf,o,this._tmpWorldUp),c.rotate(this._tmpTransf,this._tmpTransf,n,this._tmpAxis),p.transformMat4(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=p.transformMat4(w,e.up,this._tmpTransf),p.add(w,s,this._tmpViewDir),d.copy(this._lastPoint,this._tmpRotCurPoint),w}},t.__decorate([s.property()],e.RotateController.prototype,"pivot",void 0),e.RotateController=t.__decorate([l.subclass("esri.views.3d.state.controllers.RotateController")],e.RotateController);const w=f.create(),x=f.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/InteractiveController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/clock","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../ViewStateManager","./CameraController","../../webgl/RenderCamera"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.InteractiveController=class extends c.CameraController{constructor(){super(...arguments),this.startCamera=new u,this.currentCamera=new u,this._isInteractive=!1,this._interactingTimeoutHandle=void 0}get isInteractive(){return this._isInteractive}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=2,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._isInteractive=!0,this._interactingTimeoutHandle?.remove(),this._interactingTimeoutHandle=r.clock.setTimeout(()=>{this._isInteractive=!1,this._interactingTimeoutHandle=void 0},l.interactingTimeout),this.view.state.updateCamera(e=>this.stepController(0,e)),this.steppingFinished&&this.finishController()}},t.__decorate([i.property({readOnly:!0})],e.InteractiveController.prototype,"isInteractive",null),t.__decorate([i.property()],e.InteractiveController.prototype,"_isInteractive",void 0),e.InteractiveController=t.__decorate([a.subclass("esri.views.3d.state.controllers.InteractiveController")],e.InteractiveController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/ViewStateManager":function(){define(["exports","../../../chunks/tslib.es6","../../../Camera","../../../Viewpoint","../../../core/Accessor","../../../core/Logger","../../../core/maybe","../../../core/reactiveUtils","../../../core/scheduling","../../../core/screenUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/Extent","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/projectionUtils","../webgl","../camera/constraintUtils","../camera/intersectionUtils","./ConstraintsManager","./Frustum","./GoToOperation","./controllers/SurfaceCollisionCorrectionController","../support/cameraUtils","../support/viewpointUtils","../webgl/RenderCamera","../../support/PropertiesPool","../../webgl/FramebufferObject"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D){"use strict";e.ViewStateManager=class extends s{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=G,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return null!=this.renderState},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(e){this.viewStateManager._idleTimeout=e?G:0}},this._propertiesPool=new A.PropertiesPool({frustum:P.Frustum},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new E}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([a.on(()=>this.view.state.events,"before-camera-change",({camera:e})=>e&&this._updateElevation(e)),a.watch(()=>this.view.state?.camera,(e,t)=>this._cameraChangedHandler(e,t),a.sync)]),a.when(()=>this.view.state?.camera,e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([l.addFrameTask({prepare:()=>this._prepareFrame()}),a.watch(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(z)}),a.on(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=o.destroyMaybe(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=x.fromRenderCamera(this.view,this.view.state.camera,B);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider?.enableCache(!0),this.setStateCamera(x.toRenderCamera(this.view,e),{applyConstraints:!1})||n.getLogger(this).error("#camera=","Invalid camera",e),this.view.elevationProvider?.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=x.fromRenderCamera(this.view,this.view.state.contentCamera,B);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=x.toRenderCamera(this.view,e);this.view.state.contentCamera=null!=t?t:null}installContentCameraReset(e){if(this.removeHandles(j),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,r=this.view.state.camera.distance**2,i=m.fromArray(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.addHandles([a.watch(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles(j),this.test.contentCameraResetState.clear())}),a.watch(()=>this.zoom,e=>{void 0!==e&&void 0!==t&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s))}),a.watch(()=>this.view.state.camera,e=>{const t=f.squaredDistance(i,e.center);this.test.contentCameraResetState.set("camera.center",t/r),t>r?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)})],j),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():n.getLogger(this).error("#center=","Invalid center",e):n.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):n.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){const e=this._get("extent");return e?v.fromExtent(e):null}return O.toArea(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=O.toExtent(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return null!=t?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||n.getLogger(this).error("#extent=","Invalid extent",e):n.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):n.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){const e=this.view.map;return e&&"initialViewProperties"in e?e.initialViewProperties?.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");const e=this.view.basemapTerrain.tilingScheme,t=this.view.pointsOfInterest.cameraOnSurface.scale;return e&&t?O.applyTiltAdjustToScale(this.view,t,this.view.state.contentCamera,e):this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||n.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,r=e.pixelRatio,i=this._get("padding"),s=Math.round(t[0]/r),n=Math.round(t[1]/r),o=Math.round(t[2]/r),a=Math.round(t[3]/r);return null!=i&&i.top===s&&i.right===n&&i.bottom===o&&i.left===a?i:{top:s,right:n,bottom:o,left:a}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,k),this.view.state.updateCamera(e=>e.padding=k))}_paddingToArray(e,t,r){e?g.set(r,e.top||0,e.right||0,e.bottom||0,e.left||0):g.set(r,0,0,0,0);for(let e=0;e<4;e++)r[e]=Math.round(r[e]*t)}get screenCenter(){const e=this.padding;return c.createScreenPoint((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?I.fromCamera(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e){if(!this.isCompatible(e)){const t=null!=e.camera?e.camera.position:e.targetGeometry,r=null!=t&&t.spatialReference;return void n.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(r?r.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||n.getLogger(this).error("#viewpoint=","Invalid viewpoint",e)}else n.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?O.scaleToZoom(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||n.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const r=this.view.stage.renderView.renderingContext?.parameters.maxTextureSize;return r&&D.ensureAttachmentMaxSize(this._tmpCanvasSize,r),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return null!=this._devicePixelRatioOverride?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?.stage?.renderer.isFeatureEnabled(8)??!1}get _usePhysicalPixelRenderingAny(){const e=this.view?.stage?.renderer;return e&&(e.isFeatureEnabled(8,2)||e.isFeatureEnabled(8,1)||e.isFeatureEnabled(8,0))}preinit(e){return!(this._isOverridden("center")&&!w.isLoadedOrLoadFor(this.center.spatialReference,e)||this._isOverridden("camera")&&!w.isLoadedOrLoadFor(this.camera.position.spatialReference,e)||this._isOverridden("extent")&&!w.isLoadedOrLoadFor(this.extent.spatialReference,e)||!(!this._isOverridden("viewpoint")||w.isLoadedOrLoadFor(this.viewpoint.targetGeometry?.spatialReference,e)&&w.isLoadedOrLoadFor(this.viewpoint.camera?.position?.spatialReference,e)))}init(){this._constraintsManager=new C.ConstraintsManager({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const e=this._initialViewpoint||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):2===this.view.state.viewingMode&&this.addHandles(a.when(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(z),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),z)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(z),this._constraintsManager=o.destroyMaybe(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},null!=this._gotoOperation&&this._gotoOperation.abort(t.animate),this._gotoOperation=new M.GoToOperation(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera(T.cameraOnContentAlongViewDirection(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,r=t?.cameraController;r&&(t.updateCamera(t=>r.stepController(e,t)),r.steppingFinished&&r.finishController())}_cancelGoToOperation(){null!=this._gotoOperation&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:r,overrides:i}of V){const s=e.has(r),n=this._isOverridden(r);!s&&n&&t.push({name:r,value:this._get(r)}),this._clearOverride(r),(s||n)&&i.forEach(t=>e.add(t))}return t}_setInitialView(e){if(null==e||this._cameraSetByUser)return;if(e instanceof r)return void this.setStateCamera(x.toRenderCamera(this.view,e),{applyConstraints:!1});if(e instanceof i){if(e.targetGeometry instanceof _){const t=O.fromExtentSync(this.view,e.targetGeometry,0,.5,0);return void(null!=t&&this.setStateCamera(x.toRenderCamera(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},r=this._viewpointToCamera(e);return void this.setStateCamera(r,t)}const t=O.fromExtentSync(this.view,e,0,.5,0);null!=t&&this.setStateCamera(x.toRenderCamera(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&L.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return null!=e&&(e instanceof i?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof r?this.isCompatible(e.position):e.spatialReference&&!w.requiresLoad(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=U){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,r=N){const{heading:i,tilt:s}=this._getPreservingHeadingTilt(),n=O.getObserverForPointAtDistanceSync(this.view,i,s,e,t,1);return null==n?null:(r.copyFrom(this.view.state.camera),r.eye=n.eye,r.center=n.center,r.up=n.up,r)}_centerToCamera(e){let t;if(e.hasZ)t=this.view.state.camera.distance;else{const{centerOnContent:e}=this.view.pointsOfInterest;e.runTask(),t=e.distance}return this._centerPointAtDistanceToCamera(e,t)}_extentToCamera(e){const{heading:t,tilt:r}=this._getPreservingHeadingTilt(),i=O.fromExtentSync(this.view,e,t,r,1,B);return i?x.toRenderCamera(this.view,i):null}_scaleToCamera(e){if(null==e)return null;const t=this.view,r=t.pointsOfInterest.centerOnContent;r.runTask();const i=r.renderLocation,s=t.pointsOfInterest.cameraOnSurface.renderLocation,n=O.viewScaleToCameraDistance(t,e,t.state.contentCamera,i,s);return this._centerPointAtDistanceToCamera(i,n)}_zoomToCamera(e){return this._scaleToCamera(O.zoomToScale(this.view,e))}_viewpointToCamera(e){return x.toRenderCamera(this.view,I.toCameraSync(this.view,e))}setStateCamera(e,t){return!(null==e||!this.view.state.stopActiveCameraController()||(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(r=>{t.positionAndOrientationOnly?(r.eye=e.eye,r.center=e.center,r.up=e.up,r.fov=e.fov):r.copyFrom(e),t.applyConstraints&&S.applyAll(this.view,r)}),t.applyConstraints||(this.view.state.cameraController=new R.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:e})),0))}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const r=this._computeCanvasSize();if(0!==r.width&&0!==r.height&&(t.width===r.width&&t.height===r.height||(t.width=r.width,t.height=r.height),this.view.state)){const e=this.view.state.camera;e.fullWidth===r.width&&e.fullHeight===r.height&&e.pixelRatio===r.pixelRatio||(N.copyFrom(e),N.pixelRatio!==r.pixelRatio&&(this._paddingToArray(this.padding,r.pixelRatio,k),N.padding=k),N.fullWidth=r.width,N.fullHeight=r.height,N.pixelRatio=r.pixelRatio,this.view.state.camera=N),this._updateViewState()}}_updateElevation(e){const t=this.view.basemapTerrain?.spatialReference,r=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,i=t?T.surfaceElevationBelowRenderLocation(this.view,e.eye):0;e.relativeElevation=r-i}_updateViewState(){null!=this.test.renderState?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=0:this.view.interacting?this.view.state.mode=1:(0===this.view.state.mode&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=1:this.view.state.mode=2),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}},t.__decorate([u.property({type:r,dependsOn:["view.state.camera","ready"]})],e.ViewStateManager.prototype,"camera",null),t.__decorate([u.property({type:r,dependsOn:["view.state.contentCamera","ready"]})],e.ViewStateManager.prototype,"contentCamera",null),t.__decorate([u.property({type:b})],e.ViewStateManager.prototype,"center",null),t.__decorate([u.property()],e.ViewStateManager.prototype,"visibleArea",null),t.__decorate([u.property({type:_})],e.ViewStateManager.prototype,"extent",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"frustum",null),t.__decorate([u.property()],e.ViewStateManager.prototype,"_constraintsManager",void 0),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"constraintsManager",null),t.__decorate([u.property()],e.ViewStateManager.prototype,"_initialViewpoint",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"hasInitialView",null),t.__decorate([u.property({readOnly:!0,type:Boolean})],e.ViewStateManager.prototype,"ready",void 0),t.__decorate([u.property({type:Number})],e.ViewStateManager.prototype,"scale",null),t.__decorate([u.property()],e.ViewStateManager.prototype,"padding",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"screenCenter",null),t.__decorate([u.property({constructOnly:!0})],e.ViewStateManager.prototype,"view",void 0),t.__decorate([u.property({type:i})],e.ViewStateManager.prototype,"viewpoint",null),t.__decorate([u.property({type:Number})],e.ViewStateManager.prototype,"zoom",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"_rasterPixelRatio",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"_usePhysicalPixelRendering",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"_usePhysicalPixelRenderingAny",null),t.__decorate([u.property()],e.ViewStateManager.prototype,"_windowDevicePixelRatio",void 0),t.__decorate([u.property()],e.ViewStateManager.prototype,"_devicePixelRatioOverride",void 0),e.ViewStateManager=t.__decorate([p.subclass("esri.views.3d.state.ViewStateManager")],e.ViewStateManager);class E{constructor(){this.width=0,this.height=0,this.pixelRatio=1}}const L=new Set(["camera","viewpoint","extent","scale","center","zoom"]),V=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],U={heading:0,tilt:0};let B=new r,N=new F;const k=y.create(),z="pending-initial-view",j="content-camera-reset",G=300;e.cleanupViewStateManager=function(){B=new r,N=new F},e.interactingTimeout=100,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/ConstraintsManager":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/mathUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../camera/constraintUtils","../camera/intersectionUtils","../camera/constraintUtils/ConstraintOptions","./NearFarHeuristic","./SurfaceCollisionConstraint"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";function m(e,t){t&&(e.near=t.near,e.far=t.far)}e.ConstraintsManager=class extends r{constructor(e){super(e),this.nearFarHeuristic=p.createNearFarHeuristic(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([s.watch(()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far],()=>this._clipDistanceNearFarChanged()),s.watch(()=>this.view.constraints?.clipDistance?.mode,()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",({camera:e,sceneDepthRange:t})=>this._updateCameraNearFar(e,t)),s.watch(()=>this.view.stage.renderer.sceneDepthRange.value,()=>this._updateNearFar(),s.sync),s.watch(()=>this.view.renderDataExtent,()=>this._updateNearFar(),s.sync),s.watch(()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max],()=>this._updateAltitude(),s.sync),s.watch(()=>this.view.constraints?.tilt?.max,()=>this._updateTiltMax(),s.sync),s.watch(()=>this.view.constraints?.tilt?.mode,()=>this._updateTilt(),s.sync),s.watch(()=>this.view.state?.camera,()=>this._updateTiltAutoMax(),s.sync),s.watch(()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled],()=>this._updateCollision(),s.sync)]),this.view.state.isLocal&&this.addHandles(s.watch(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),s.initial)),this._updateNearFar(),2!==this.view.state.viewingMode&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new f.SurfaceCollisionConstraint({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints?.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera(t=>m(t,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e,t){const r=this.view.constraints?.clipDistance;"manual"===(r?r.mode:"auto")?m(e,r):this._updateCameraNearFarAuto(e,r,t)}_updateCameraNearFarAuto(e,t,r){const i=d.surfaceElevationBelowRenderLocation(this.view,e.eye),s=this.nearFarHeuristic.compute(e,this.view.renderDataExtent,r??this.view.stage.renderer.sceneDepthRange.value,i);e.near=s.near,e.far=s.far,t&&t.autoUpdate(e.near,e.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,t=!e||"stay-above"===e,r=this.view.state.constraints.collision;if(t!==r.enabled){r.enabled=t,t&&this._reapplyConstraints(8);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&2!==this.view.state.viewingMode?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(i.deg2rad(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const r=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(i.rad2deg(r))}}_updateLocalSurfaceDistance(e){if(null==e)return;let t=Math.max(e.width,e.height);if(t<=0)return;null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));const r=this.view.state,i=3*t/Math.atan(r.camera.fov/2);i!==r.constraints.distance&&(r.constraints.distance=i)}_reapplyConstraints(e=15){this.view.state.updateCamera(t=>u.applyAll(this.view,t,new h.ConstraintOptions(e,0,null)))}},t.__decorate([n.property({constructOnly:!0})],e.ConstraintsManager.prototype,"view",void 0),t.__decorate([n.property({readOnly:!0})],e.ConstraintsManager.prototype,"surfaceCollisionConstraint",void 0),e.ConstraintsManager=t.__decorate([c.subclass("esri.views.3d.state.ConstraintsManager")],e.ConstraintsManager),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/SurfaceCollisionConstraint":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../camera/intersectionUtils","../camera/constraintUtils/surfaceCollision"],function(e,t,r,i,s,n,o,a,l,c){"use strict";e.SurfaceCollisionConstraint=class extends r{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;null!=e.spatialReference&&l.eyeWithinExtent(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>c.applySurfaceCollisionConstraint(this.view,e,1))}},t.__decorate([i.property({constructOnly:!0})],e.SurfaceCollisionConstraint.prototype,"view",void 0),e.SurfaceCollisionConstraint=t.__decorate([a.subclass("esri.views.3d.state.SurfaceCollisionConstraint")],e.SurfaceCollisionConstraint),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/GoToOperation":function(){define(["exports","../../../Camera","../../../Viewpoint","../../../core/Error","../../../core/promiseUtils","../../../core/reactiveUtils","../webgl","../camera/constraintUtils","../camera/constraintUtils/surfaceCollision","./controllers/PointToPointAnimationController","./controllers/SurfaceCollisionCorrectionController","../support/viewpointUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";e.GoToOperation=class{constructor(e,t,r){this._target=e,this._options=t,this.view=r,this.state="pending",this._animationController=null,this.promise=new Promise((e,t)=>{this._resolveCallback=e,this._rejectCallback=t;const r=new AbortController;null!=this._options.signal&&s.onAbort(this._options.signal,()=>this.abort()),this._abortController=r,this._waitForReady()})}_resolve(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}_reject(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&null!=this._animationController&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject(s.createAbortError())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await n.whenOnce(()=>this.view.ready,this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if("finished"!==this.state){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await d.create(this.view,this._target,this._abortController.signal);if("finished"===this.state)return;const t=e?this._getCameraFromViewpoint(e):null;if(null==t)return;if(this._options.animate){if(null==this._animationController)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){const s=!!(this._target instanceof r&&this._target.camera||this._target instanceof t),n=e.camera;if(null==n)return null;if(!this.view.stateManager.isCompatible(n)){const e=n.position,t=e&&e.spatialReference,r=t?t.wkid:"none",s=this.view.spatialReference?.wkid;return this._reject(new i("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${r}, view: ${s})`,{camera:n})),null}const a=o.toRenderCamera(this.view,n);return null==a?(this._reject(new i("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:a,isFullySpecified:s}}_startAnimation(e,t){this.state="wait-for-animation-finish";const r=t.viewAnimation;if(null==r)return void this._reject(new i("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(r.update(e.viewpoint,"running"),!t.running||null==t.viewAnimation||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let s;e.isFullySpecified?(s=new u.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:e.camera}),l.applySurfaceCollisionConstraint(this.view,e.camera,1)):a.applyAll(this.view,e.camera),t.begin(e.camera,this._options);const n=e=>{if(null!=this.view.state)switch(t.state){case 4:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case 0:case 1:case 2:case 3:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(e)}}};r.when(()=>{const r=this.view.state.cameraController;s&&(r&&r.running?c.isPointToPointAnimationController(r)&&null!=r.viewAnimation&&r.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=s):null!=t.viewAnimation&&t.viewAnimation.target===e.viewpoint&&4===t.state&&(this.view.state.cameraController=s))},e=>n(e)),t.asyncResult={resolve:()=>n(),reject:e=>n(e)}}_getAnimationController(){let e=null,t=null;const r=this.view.state.cameraController;return c.isPointToPointAnimationController(r)&&(r.updateStateFromViewAnimation(),r.running&&(e=r,t=e.viewAnimation)),null==e&&(e=new c.PointToPointAnimationController({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e),1===e.state)?(t?.stop(),this._reject(new i("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/SurfaceCollisionCorrectionController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../camera/intersectionUtils","../../camera/constraintUtils/surfaceCollision","./CameraController"],function(e,t,r,i,s,n,o,a,l,c){"use strict";e.SurfaceCollisionCorrectionController=class extends c.CameraController{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=2,this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(null==e.spatialReference||a.eyeWithinExtent(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),l.applySurfaceCollisionConstraint(this.view,e,1)||this.constraintEnabled||(this.state=3)})}},t.__decorate([r.property({constructOnly:!0})],e.SurfaceCollisionCorrectionController.prototype,"desiredCamera",null),e.SurfaceCollisionCorrectionController=t.__decorate([o.subclass("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],e.SurfaceCollisionCorrectionController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/viewpointUtils":function(){define(["exports","../../../Camera","../../../Graphic","../../../Viewpoint","../../../core/asyncUtils","../../../core/has","../../../core/Cyclical","../../../core/Error","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/Extent","../../../geometry/Geometry","../../../geometry/Multipoint","../../../geometry/Point","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/projection/computeTranslationToOriginAndRotation","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectVectorToPoint","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/frustum","../../../geometry/support/scaleUtils","../webgl","../camera/intersectionUtils","./cameraUtils","./ElevationProvider","./viewingModeUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A){"use strict";function D(e){return 360-o.cyclicalDegrees.normalize(e)}function E(e){return o.cyclicalDegrees.normalize(360-e)}async function L(e,t,r,i){const s=t.camera;if(null!=s)return async function(e,t,r){const i=e.position,s=await _.projectWithZConversion(i,t,{signal:r});l.throwIfAborted(r);const n=e.clone();return n.position=s.clone(),n}(s,I.getViewSR(e),i);const{targetGeometry:n}=t;if(null==n)throw new Error("Viewpoint has no targetGeometry!");const{camera:o,mode:a}=V(e,t.rotation,r);if("point"===n.type)return async function(e,t,r,i,s,n){const o=e.spatialReference,a=await _.projectWithZConversion(r.clone(),o,{signal:n});l.throwIfAborted(n);const c=null!=t.scale?I.scaleToDistance(e,t.scale):e.state.camera.distance;return I.fromCenterDistanceAsync(e,a,c,i,s,n)}(e,t,n,o,a,i);const c=n.extent;if(null==c)throw new Error("Target geometry has no extent!");return I.fromExtentAsync(e,c,o.heading,o.tilt,a,i)}function V(e,t,r){const i=R.fromRenderCamera(e,e.state.camera);let s=1;return null!=t&&(i.heading=D(t),s=0),null!=r&&(i.tilt=r),{camera:i,mode:s}}function U(e,t){return null==t.scale&&null!=t.zoom?I.zoomToScale(e,t.zoom):t.scale}function B(e,t){let r=!1;return null!=t.heading?(e.heading=t.heading,r=!0):null!=t.rotation&&(e.heading=D(t.rotation),r=!0),null!=t.tilt&&(e.tilt=t.tilt,r=!0),null!=t.fov&&(e.fov=t.fov),r}function N(e,t,r,i){const s=e.spatialReference||b.WGS84;if(t??=R.toRenderCamera(e,r),null==t)return i;const n=new y({spatialReference:s});return x.projectVectorToPoint(t.center,e.renderSpatialReference,n)?(i.targetGeometry=n,i.scale=I.distanceToScale(e,t.distance),i.rotation=E(r.heading),i.camera=r,i):i}async function k(e,t,r,i){const s=()=>new a("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!t)throw s();"mesh"===t.type&&(t=t.extent);const n=e.basemapTerrain.spatialReference;if(!t.hasZ&&e.basemapTerrain){let r;switch(t.type){case"point":r=t;break;case"multipoint":case"polyline":r=t.extent?.center;break;case"extent":r=t.center;break;case"polygon":r=t.centroid}null!=r&&n&&e.elevationProvider?(r=await _.projectWithZConversion(r,n,{signal:i}),W[2]=F.getElevationAtPoint(e.elevationProvider,r)??0):W[2]=0}const o=re[t.type],l=new Array;if(o(t,t.hasZ?e=>{l.push([e[0],e[1],e[2]])}:e=>{l.push([e[0],e[1]])},W),0===l.length)throw s();const c=t.spatialReference,u=e.spatialReference,d=await _.projectWithZConversion(new g({spatialReference:c,hasZ:t.hasZ,hasM:!1,points:l}),u,{signal:i});if(t.hasZ&&(r.hasZ=!0),t.hasZ)for(const[e,t,i]of d.points)W[0]=e,W[1]=t,W[2]=i,T.expandWithVec3(r.boundingBox,W);else for(const[e,t]of d.points)W[0]=e,W[1]=t,T.expandWithVec3(r.boundingBox,W)}async function z(e,t,i,n,o){if(Array.isArray(t)&&2===t.length){const r=t[0],i=t[1];if("number"==typeof r&&"number"==typeof i)return te.x=r,te.y=i,te.z=void 0,te.spatialReference=e.spatialReference?.isGeographic?e.spatialReference:b.WGS84,void await k(e,te,n,o)}t&&"map"in t&&"function"==typeof t.map?await Promise.allSettled(t.map(t=>z(e,t,i,n,o))):t instanceof m?await k(e,t,n,o):t instanceof r&&await async function(e,t,r,i,n){const o=await s.result(e.whenViewForGraphic(t));if(!1===o.ok||null==o.value||!("whenGraphicBounds"in o.value))return void await k(e,t.geometry,i,n);const a=o.value,l=await s.result(a.whenGraphicBounds(t,{minDemResolution:r}));if(!1===l.ok||!l.value)return void await k(e,t.geometry,i,n);const{screenSpaceObjects:c,boundingBox:u}=l.value;T.expandWithAABB(i.boundingBox,u),c&&c.forEach(e=>{i.screenSpaceObjects.push(e)}),isFinite(u[2])&&(i.hasZ=!0)}(e,t,i,n,o)}async function j(e,t,r,i){const s=e.spatialReference,n=await _.projectWithZConversion(t.position,s,{signal:r}),o=t.clone();return o.position=n,N(e,null,o,i)}async function G(e,t,r,i,s,n){n.targetGeometry=r.clone();const o=O.cameraOnContentAlongViewDirection(e);if(t.position)return async function(e,t,r,i,s,n,o){const a=e.renderSpatialReference;return await w.projectPointToVectorAsync(t,K,a,0,{signal:o}),await w.projectPointToVectorAsync(r,J,a,0,{signal:o}),n.targetGeometry=new y(t),s.position=new y(r),h.subtract(X,K,J),A.directionToHeadingTilt(e,J,X,i.up,s),n.scale=I.distanceToScale(e,h.distance(J,K)),n.rotation=E(s.heading),n.camera=s,n}(e,n.targetGeometry,t.position,o,i,n,s);if(t.zoomFactor){const r=o.distance/t.zoomFactor,i=h.scale(W,o.viewForward,-r);o.eye=h.add(W,o.center,i),n.scale=I.distanceToScale(e,r)}R.fromRenderCamera(e,o,i);const a=B(i,t)?0:1;if(!t.zoomFactor){const r=U(e,t);if(null==r){await w.projectPointToVectorAsync(n.targetGeometry,W,e.renderSpatialReference,0,{signal:s});const t=P.intersectsPoint(o.frustum,W)?h.distance(o.eye,W):o.distance;n.camera=await I.fromCenterDistanceAsync(e,n.targetGeometry,t,i,a),n.scale=I.distanceToScale(e,t)}else n.scale=r,n.camera=await I.fromCenterScale(e,n.targetGeometry,n.scale,i,a,s)}return n}function q(e){return null!=e?.camera&&(e.rotation=E(e.camera.heading)),e}class H{constructor(){this.hasZ=!1,this.boundingBox=T.empty(),this.screenSpaceObjects=new Array}}const W=p.create(),$=d.create(),Q=u.create(),Z=T.create(),Y=C.create(),X=p.create(),J=p.create(),K=p.create(),ee={heading:0,tilt:0},te=new y,re={point(e,t,r){r[0]=e.x,r[1]=e.y,null!=e.z&&(r[2]=e.z),t(r)},polygon(e,t,r){const i=e.hasZ;for(let s=0;s<e.rings.length;s++){const n=e.rings[s];for(let e=0;e<n.length;e++)r[0]=n[e][0],r[1]=n[e][1],i&&(r[2]=n[e][2]),t(r)}},polyline(e,t,r){const i=e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s];for(let e=0;e<n.length;e++)r[0]=n[e][0],r[1]=n[e][1],i&&(r[2]=n[e][2]),t(r)}},multipoint(e,t,r){const i=e.points,s=e.hasZ;for(let e=0;e<i.length;e++)r[0]=i[e][0],r[1]=i[e][1],s&&(r[2]=i[e][2]),t(r)},extent(e,t,r){null!=e.zmin&&null!=e.zmax?(t(h.set(r,e.xmin,e.ymin,e.zmin)),t(h.set(r,e.xmax,e.ymin,e.zmin)),t(h.set(r,e.xmin,e.ymax,e.zmin)),t(h.set(r,e.xmax,e.ymax,e.zmin)),t(h.set(r,e.xmin,e.ymin,e.zmax)),t(h.set(r,e.xmax,e.ymin,e.zmax)),t(h.set(r,e.xmin,e.ymax,e.zmax)),t(h.set(r,e.xmax,e.ymax,e.zmax))):(t(h.set(r,e.xmin,e.ymin,r[2])),t(h.set(r,e.xmax,e.ymin,r[2])),t(h.set(r,e.xmin,e.ymax,r[2])),t(h.set(r,e.xmax,e.ymax,r[2])))}};e.create=async function(e,r,s){const n=function(e,t){if(!t||!e.spatialReference)return null;const r={target:void 0};return"declaredClass"in t||Array.isArray(t)?r.target=t:(Object.assign(r,t),!r.target&&"center"in t&&t.center&&(r.target=t.center)),r}(e,r);if(!n)throw new a("viewpointutils-create:no-target","Missing target for creating viewpoint");const o=new t({fov:e.camera.fov}),l=new i({camera:o});if(n.target instanceof i){const t=await async function(e,t,r,i,s){if(t.camera)return j(e,t.camera,i,s);s.scale=t.scale,s.rotation=t.rotation,s.targetGeometry=null!=t.targetGeometry?t.targetGeometry.clone():null,s.camera=null,null!=r.heading?s.rotation=E(r.heading):null!=r.rotation&&(s.rotation=r.rotation);const n=U(e,r);return null!=n&&(s.scale=n),s.camera=await L(e,s,r.tilt,i),s}(e,n.target,n,s,l);return q(t)}if(n.target instanceof t)return q(await j(e,n.target,s,l));const u=null!=n.scale||null!=n.zoom;if(n.target instanceof f){const t=n.target.xmin===n.target.xmax||n.target.ymin===n.target.ymax;return q(u||t?await G(e,n,n.target.center,o,s,l):await async function(e,t,r,i,s,n){n.targetGeometry=r.clone();const o=O.cameraOnContentAlongViewDirection(e);R.fromRenderCamera(e,o,i);const a=B(i,t)?0:1;return n.camera=await I.fromExtentAsync(e,r,i.heading,i.tilt,a,s),n}(e,n,n.target,o,s,l))}const d=new H,p=u?function(e,t){const r=U(e,t);return r?M.getResolutionInMetersForScale(r):void 0}(e,n):void 0;if(await z(e,n.target,p,d,s),isFinite(d.boundingBox[0])){let t;if(T.center(d.boundingBox,W),te.x=W[0],te.y=W[1],te.z=W[2],te.spatialReference=e.spatialReference,isFinite(te.z)&&d.hasZ?t=T.isPoint(d.boundingBox):(te.z=void 0,t=C.isPoint(T.toRect(d.boundingBox,Y))),u||t)return q(await G(e,n,te,o,s,l));const r=function(e,t){if(!t.length)return.66;let r=Number.NEGATIVE_INFINITY;for(let e=0;e<t.length;e++){const i=t[e].screenSpaceBoundingRect;r=Math.max(r,Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2]),Math.abs(i[3]))}return.66-r/Math.min(e.width,e.height)*2}(e,d.screenSpaceObjects);return q(await async function(e,t,r,i,s,n,o,a){a.targetGeometry=r.clone();const l=O.cameraOnContentAlongViewDirection(e),u=function(e,t,r,i,s){let n=0;null!=r.z?n=r.z:e.basemapTerrain&&e.elevationProvider&&(n=F.getElevationAtPoint(e.elevationProvider,r)),h.set(W,r.x,r.y,n),v.computeTranslationToOriginAndRotation(e.spatialReference,W,$,e.renderSpatialReference),c.fromMat4(Q,$),c.transpose(Q,Q),T.empty(Z);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let t=0;t<o.length;t++){const r=o[t];let s=i[r[2]];isFinite(s)||(s=n),h.set(W,i[r[0]],i[r[1]],s),S.projectVectorToVector(W,e.spatialReference,W,e.renderSpatialReference),T.expandWithVec3(Z,h.transformMat3(W,W,Q))}const a=T.width(Z),l=T.height(Z),u=T.depth(Z),d=1/Math.tan(t.fovX/2),p=1/Math.tan(t.fovY/2),f=.5*Math.sqrt(a*a+u*u)*Math.max(p,d)+.5*l,m=.5*l*p+.5*Math.max(a,u);return Math.max(f,m)/s}(e,l,r,i,s);R.fromRenderCamera(e,l,n);const d=B(n,t)?0:1;return a.camera=await I.fromCenterDistanceAsync(e,a.targetGeometry,u,n,d,o),a.scale=I.distanceToScale(e,u),a}(e,n,te,d.boundingBox,r,o,s,l))}return n.position?q(await async function(e,t,r,i,s){const n=O.cameraOnContentAlongViewDirection(e);h.copy(X,n.viewForward),A.directionToHeadingTilt(e,n.eye,X,n.up,ee);const o=e.spatialReference,{position:a}=t;if(a){const e=await _.projectWithZConversion(a,o,{signal:s});r.position=e}else r.position=new y;return r.heading=null!=t.heading?t.heading:ee.heading,r.tilt=null!=t.tilt?t.tilt:ee.tilt,N(e,null,r,i)}(e,n,o,l,s)):q(await async function(e,t,r,i,s){if(null!=t.heading||null!=t.rotation||null!=t.scale||null!=t.tilt||null!=t.zoom||null!=t.zoomFactor){const n=O.cameraOnContentAlongViewDirection(e),{spatialReference:o,renderSpatialReference:a}=e,l=new y({spatialReference:o});return x.projectVectorToPoint(n.center,a,l)?G(e,t,l,r,i,s):s}return s.scale=e.scale,s.camera=e.camera.clone(),B(s.camera,t),s}(e,n,o,s,l))},e.fromCamera=function(e,t,r=null){return null==r&&(r=new i),N(e,null,t.clone(),r)},e.toCameraAsync=L,e.toCameraSync=function(e,t,r){const i=t.camera;if(null!=i)return function(e,t){const r=e.position;let i;try{i=_.tryProjectWithZConversion(r,t)}catch(e){return null}if(!i)return null;const s=e.clone();return s.position=i.clone(),s}(i,I.getViewSR(e));const{targetGeometry:s}=t;if(null==s)return null;const{camera:n,mode:o}=V(e,t.rotation,r);if("point"===s.type)return function(e,t,r,i,s){const n=e.spatialReference;let o;try{o=_.tryProjectWithZConversion(r.clone(),n)}catch(e){return null}if(!o)return null;const a=null!=t.scale?I.scaleToDistance(e,t.scale):e.state.camera.distance;return I.fromCenterDistanceSync(e,o,a,i,s)}(e,t,s,n,o);const a=s.extent;return null==a?null:I.fromExtentSync(e,a,n.heading,n.tilt,o)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/input/handlers/DragZoom":function(){define(["exports","../../../../core/screenUtils","../../state/controllers/FovController","../../state/controllers/ZoomControllerGlobal","../../state/controllers/ZoomControllerLocal","../../../input/InputHandler","../../../input/handlers/support"],function(e,t,r,i,s,n,o){"use strict";class a extends n.InputHandler{constructor(e,t,r){super(!0),this._view=e,this.pointerActions=t,this._fovModifier=r,this.registerIncoming("drag",[r],e=>this._handleZoom(e)),this.registerIncoming("drag",e=>this._handleZoom(e))}_handleZoom(e){const n=e.data;if(n.pointers.size>1)return;if(!o.eventMatchesMousePointerActions(e.data,this.pointerActions))return;const a=t.createScreenPointArray(n.center.x,n.center.y);switch(n.action){case"start":{this._cameraController?.finish();const t=this._view,n=e.modifiers.has(this._fovModifier);this._cameraController=n?new r.FovController({view:t,onStop:()=>this._stopController()}):t.state.isGlobal?new i.ZoomControllerGlobal({view:t}):new s.ZoomControllerLocal({view:t}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(a);break}case"update":this._cameraController?.update(a);break;case"end":this._cameraController instanceof r.FovController?this._cameraController.updateTimeout():this._stopController()}e.stopPropagation()}_stopController(){this._cameraController?.finish(),this._cameraController=null}}e.DragZoom=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/FovController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../Camera","../../../../core/mathUtils","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","./InteractiveController","../utils/navigationUtils","../../../ui/Component","../../../../widgets/FovOverlay"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y){"use strict";e.FovController=class extends f.InteractiveController{constructor(e){super(e),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov(_),this.updateTimeout()},this._center=d.create(),this._viewForward=d.create(),this._constraints=new p.ConstraintOptions(15,1)}begin(e){!function(e){return!Array.isArray(e)}(e)?(this._lastDrag=e[1],this._startSize=null,this._ensureStartSize(this.view.state.camera)):this._showOverlay().fov=e.fov}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(e){if(null==this._lastDrag)return this._lastDrag=e[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);const t=-(this._lastDrag-e[1])/2;this._lastDrag=e[1],this.step(t)}step(e){if(!this.running)return void(this._startSize=this._lastDrag=null);const t=this.view.state,r=this.currentCamera.copyFrom(t.camera),s=i.rad2deg(r.fov)+e,n=i.deg2rad(i.clamp(s,b,v));n!==r.fov?this._setFov(n):this._showOverlay().fov=r.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(e){super.onControllerEnd(e),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new g({id:"esri.FovOverlay",node:new y.FovOverlay({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=s.destroyMaybe(this._overlay))}_setFov(e){const t=this.view.state,r=this.currentCamera.copyFrom(t.camera),i=this._ensureStartSize(r)/Math.tan(e/2),s=u.add(w,this._center,u.scale(w,this._viewForward,-i));r.eye=s,r.fov=e,this._constraints.interactionStartCamera=t.camera,this._constraints.interactionFactor=h.pixelDistanceToInteractionFactor(this.currentCamera.height-t.camera.height),h.applyAll(this.view,this.currentCamera,this._constraints),this.begin(r),this.commitCamera()}_ensureStartSize(e){if(null==this._startSize){u.copy(this._viewForward,e.viewForward);const t=this.view.stage.renderView.getMinimalDepthForArea(null,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,m.pivotSearchAreaSize),r=u.distance(e.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),i=t??r;u.add(this._center,e.eye,u.scale(w,this._viewForward,i)),this._startSize=i*Math.tan(e.fov/2)}return this._startSize}},t.__decorate([n.property()],e.FovController.prototype,"onStop",void 0),e.FovController=t.__decorate([c.subclass("esri.views.3d.state.controllers.FovController")],e.FovController);const _=i.deg2rad((new r).fov),b=10,v=150,w=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/ui/Component":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/domUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";const l="esri-component";let c=class extends t{constructor(){super(...arguments),this.widget=null}destroy(){this.node=null,this.widget?.destroy()}get id(){return this._get("id")??this.widget?.id??this.node?.id}set id(e){this._set("id",e)}set node(e){const t=this._get("node");e!==t&&(e&&e.classList.add(l),t&&t.classList.remove(l),this._set("node",e))}castNode(e){return this.widget?.destroy(),e?"string"==typeof e||function(e){return e&&"nodeType"in e}(e)?(this._set("widget",null),r.byId(e)):(function(e){return e&&"function"==typeof e.render}(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};return e.__decorate([i.property()],c.prototype,"id",null),e.__decorate([i.property()],c.prototype,"node",null),e.__decorate([s.cast("node")],c.prototype,"castNode",null),e.__decorate([i.property({readOnly:!0})],c.prototype,"widget",void 0),c=e.__decorate([a.subclass("esri.views.ui.Component")],c),c})},"esri/widgets/FovOverlay":function(){define(["exports","../chunks/tslib.es6","../core/mathUtils","../core/unitFormatUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";const p="esri-fov-overlay",f={base:p,outer:`${p}-outer`,reset:`${p}-reset`,text:`${p}-text`};e.FovOverlay=class extends c{constructor(e){super(e),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return h.tsx("div",{class:f.outer},h.tsx("div",{class:f.base},h.tsx("p",{class:f.text},this._overlay),h.tsx("p",{class:f.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){const{fov:e,_messagesUnits:t}=this;if(!t||null==e)return"";const s=i.formatAngleDegrees(r.rad2deg(e),"degrees","arithmetic","arithmetic",0),n=m/(2*Math.tan(e/2));return`${s} | ${i.formatDecimal(t,n,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&null!=this.fov?"↺":""}},t.__decorate([s.property()],e.FovOverlay.prototype,"onReset",void 0),t.__decorate([s.property(),d.messageBundle("esri/t9n/common")],e.FovOverlay.prototype,"_messagesCommon",void 0),t.__decorate([s.property(),d.messageBundle("esri/core/t9n/Units")],e.FovOverlay.prototype,"_messagesUnits",void 0),t.__decorate([s.property()],e.FovOverlay.prototype,"fov",void 0),t.__decorate([s.property()],e.FovOverlay.prototype,"_overlay",null),t.__decorate([s.property()],e.FovOverlay.prototype,"_reset",null),e.FovOverlay=t.__decorate([l.subclass("esri.widgets.FovOverlay")],e.FovOverlay);const m=Math.sqrt(1872);e.base=p,e.css=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/unitFormatUtils":function(){define(["exports","./Cyclical","./mathUtils","./quantityUtils","./string","./unitUtils","../intl/number"],function(e,t,r,i,s,n,o){"use strict";function a(e,t,r){return e.units[t][r]}function l(e,t,r,i=2,s="abbr"){return`${o.formatNumber(t,{minimumFractionDigits:i,maximumFractionDigits:i,signDisplay:t>0?"never":"exceptZero"})} ${a(e,r,s)}`}function c(e,t,r,i=2,s="abbr"){return`${o.formatNumber(t,{minimumFractionDigits:i,maximumFractionDigits:i,signDisplay:"exceptZero"})} ${a(e,r,s)}`}const u=new Map;function d(e,t){const r=JSON.stringify(t);let i=u.get(r);return i||(i=new Intl.NumberFormat("en-US",t),u.set(r,i)),/^[-+]?360\.?0*°?$/.test(i.format(e))?0:e}const h=["B","kB","MB","GB","TB"];e.formatAngleDegrees=function(e,r,s,a,l,c=t.cyclicalDegrees,u=!0){let h=c.normalize(i.convertRotationType(n.convertUnit(e,r,"degrees"),s,a),0,u);const p=((e,t)=>({style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:t,minimumFractionDigits:t,signDisplay:e>0?"never":"exceptZero"}))(h,l??2);return h=d(h,p),o.formatNumber(h,p)},e.formatDMS=function(e,t,r=2){let i=n.convertUnit(e,t,"degrees"),s=i-Math.floor(i);i-=s,s*=60;let o=s-Math.floor(s);return s-=o,o*=60,`${i.toFixed()}° ${s.toFixed()}' ${o.toFixed(r)}"`},e.formatDecimal=l,e.formatFileSize=function(e,t){let i=0===(t=Math.round(t))?0:Math.floor(Math.log(t)/Math.log(1024));i=r.clamp(i,0,h.length-1);const n=o.formatNumber(t/1024**i,{maximumFractionDigits:2});return s.replace(e.units.bytes[h[i]],{fileSize:n})},e.formatImperialArea=function(e,t,r,i=2,s="abbr"){const o=n.adaptiveImperialAreaUnit(t,r);return l(e,n.convertUnit(t,r,o),o,i,s)},e.formatImperialLength=function(e,t,r,i=2,s="abbr"){const o=n.adaptiveImperialLengthUnit(t,r);return l(e,n.convertUnit(t,r,o),o,i,s)},e.formatImperialRelativeLength=function(e,t,r,i=2,s="abbr"){const o=n.adaptiveImperialLengthUnit(t,r);return c(e,n.convertUnit(t,r,o),o,i,s)},e.formatImperialRelativeVerticalLength=function(e,t,r,i=2,s="abbr"){const o=n.adaptiveImperialVerticalLengthUnit(t,r);return c(e,n.convertUnit(t,r,o),o,i,s)},e.formatImperialVerticalLength=function(e,t,r,i=2,s="abbr"){const o=n.adaptiveImperialVerticalLengthUnit(t,r);return l(e,n.convertUnit(t,r,o),o,i,s)},e.formatMetricArea=function(e,t,r,i=2,s="abbr"){const o=n.adaptiveMetricAreaUnit(t,r);return l(e,n.convertUnit(t,r,o),o,i,s)},e.formatMetricLength=function(e,t,r,i=2,s="abbr"){const o=n.adaptiveMetricLengthUnit(t,r);return l(e,n.convertUnit(t,r,o),o,i,s)},e.formatMetricRelativeLength=function(e,t,r,i=2,s="abbr"){const o=n.adaptiveMetricLengthUnit(t,r);return c(e,n.convertUnit(t,r,o),o,i,s)},e.formatMetricRelativeVerticalLength=function(e,t,r,i=2,s="abbr"){const o=n.adaptiveMetricVerticalLengthUnit(t,r);return c(e,n.convertUnit(t,r,o),o,i,s)},e.formatMetricVerticalLength=function(e,t,r,i=2,s="abbr"){const o=n.adaptiveMetricVerticalLengthUnit(t,r);return l(e,n.convertUnit(t,r,o),o,i,s)},e.formatRelativeAngleDegrees=function(e,t,r,i,s=2){r!==i&&(e=-e);const a={style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:s,minimumFractionDigits:s,signDisplay:"exceptZero"};let l=n.convertUnit(e,t,"degrees")%360;return l=d(l,a),o.formatNumber(l,a)},e.formatRelativeDecimal=c,e.unitName=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/quantityUtils":function(){define(["exports","./unitUtils"],function(e,t){"use strict";function r(e,r){return{type:t.unitType(r),value:e,unit:r}}function i(e,r){return{type:t.unitType(r),value:e,unit:r}}function s(e,r){return{type:t.unitType(r),value:e,unit:r}}function n(e,r,i="arithmetic"){return{type:t.unitType(r),value:e,unit:r,rotationType:i}}function o(e,t){const i=a(e,t);return"angle"===e.type?n(i,t,e.rotationType):r(i,t)}function a(e,r){return t.convertUnit(e.value,e.unit,r)}const l=i(0,"meters"),c=s(0,"square-meters"),u=n(0,"radians"),d=n(0,"degrees"),h=n(0,"degrees","geographic");e.convertRotationType=function(e,t,r){if(t===r)return e;switch(r){case"arithmetic":case"geographic":return 90-e}},e.createAngle=n,e.createArea=s,e.createLength=i,e.createQuantity=r,e.createScalar=function(e){return{value:e}},e.isBaseUnit=function(e){return t.isBaseUnit(e.unit)},e.max=function(e,r){return null==e?r:null==r||e.value>t.convertUnit(r.value,r.unit,e.unit)?e:r},e.min=function(e,r){return null==e?r:null==r||e.value<t.convertUnit(r.value,r.unit,e.unit)?e:r},e.scale=function(e,t){return null==e?null:{...e,value:e.value*t}},e.toBaseUnit=function(e){return o(e,t.baseUnitForUnit(e.unit))},e.toUnit=o,e.valueInUnit=a,e.zeroDegrees=d,e.zeroDegreesGeographic=h,e.zeroMeters=l,e.zeroRadians=u,e.zeroSquareMeters=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/ZoomControllerGlobal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/support/axisAngle","../../../../chunks/sphere","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/surfaceCollision","./InteractiveController","../utils/navigationUtils","../../support/geometryUtils/ray"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w){"use strict";e.ZoomControllerGlobal=class extends b.InteractiveController{constructor(){super(...arguments),this._pickPoint=h.create(),this._tmpP0=u.create(),this._panAxisAngle=f.create(),this._tmpRayDir=h.create(),this._tmpRayDirPick=h.create(),this._targetOnSphere=h.create(),this._navigationMode=1,this._tmpRay={origin:h.create(),direction:h.create()},this.dragBeginPoint=i.createScreenPointArray(),this._normalizedAnchorPoint=u.create(),this._constraintOptions=new y.ConstraintOptions(7,1,0,this.startCamera),this._sphere=m.create(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;c.copy(this.dragBeginPoint,e),v.normalizeCoordinate(this.startCamera,e,this._normalizedAnchorPoint);const t=p.getReferenceEllipsoid(this.view.spatialReference),i=v.pickPointAndInitSphere(this._intersectionHelper,this.startCamera,e,t.radius,0,this.view.basemapTerrain.invisible?v.excludeTerrain:{});if(this._navigationMode=v.navigationMode(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),1===this._navigationMode)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let t;w.fromScreenAtEye(this.startCamera,e,this._tmpRay),d.normalize(this._tmpRay.direction,this._tmpRay.direction),null!=i.scenePickPoint&&(d.subtract(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),t=d.length(this._tmpRayDirPick));const s=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,S);const n=r.clamp(v.getTiltScaleFactor(S,this._tmpRay.direction,v.maxZoomPivotDistanceModifier)*s,v.zoomPivotDistanceClamp[0],v.zoomPivotDistanceClamp[1]),o=this.view.stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,v.pivotSearchAreaSize);let a=null!=o?o:n;null!=t&&(a=Math.min(a,t)),this._hasPickPoint=!0,d.scale(this._tmpRay.direction,this._tmpRay.direction,a),d.add(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,1===this._navigationMode){d.subtract(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=d.length(this._tmpRayDir);v.normalizeCoordinate(this.currentCamera,e,this._tmpP0);const r=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let i=t*2**r;const s=this.view.state.constraints.minimumPoiDistance;if(r<0&&i<s&&(i=s),Math.abs(t-i)<1e-6)return;if(this._hasPickPoint&&i<t){const e=1-(1-i/t)*(1-this._sphere[3]/d.length(this.currentCamera.center));this.currentCamera.center=d.scale(x,this.currentCamera.center,e)}d.scale(this._tmpRayDir,this._tmpRayDir,-i/t),this.currentCamera.eye=d.add(x,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(c.distance(this.dragBeginPoint,e)),g.applyAll(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(v.sphereOrPlanePointFromScreenPoint(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),f.fromPoints(this._pickPoint,this._targetOnSphere,this._panAxisAngle),v.applyRotation(this.currentCamera,m.getCenter(this._sphere),this._panAxisAngle))}else{const t=d.length(this._tmpRay.direction);v.normalizeCoordinate(this.currentCamera,e,this._tmpP0);const r=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let i=t*2**r;const s=this.view.state.constraints.minimumPoiDistance;if(r<0&&i<s&&(i=s),Math.abs(t-i)<1e-6)return;d.scale(this._tmpRayDir,this._tmpRay.direction,1-i/t),this.currentCamera.eye=d.add(x,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=d.add(x,this.currentCamera.center,this._tmpRayDir)}_.applySurfaceCollisionConstraint(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}},e.ZoomControllerGlobal=t.__decorate([l.subclass("esri.views.3d.state.controllers.ZoomControllerGlobal")],e.ZoomControllerGlobal);const x=h.create(),S=h.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/ZoomControllerLocal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/plane","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../layers/VoxelWasm","./InteractiveController","../utils/navigationUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";e.ZoomControllerLocal=class extends y.InteractiveController{constructor(){super(...arguments),this._tmpP=h.create(),this._tmpDir=h.create(),this._tmpN=h.create(),this._tmpP0=u.create(),this._tmpPoi=h.create(),this._tmpRayDir=h.create(),this.dragBeginPoint=i.createScreenPointArray(),this._normalizedAnchorPoint=u.create(),this._constraintOptions=new m.ConstraintOptions(15,1,0,this.startCamera,h.create()),this._plane=p.create()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;c.copy(this.dragBeginPoint,e),_.normalizeCoordinate(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.basemapTerrain.invisible?_.excludeTerrain:{});d.subtract(this._tmpDir,this._tmpP,this.startCamera.eye);const i=d.length(this._tmpDir);d.normalize(this._tmpDir,this._tmpDir);const s=Math.abs(this.view.camera.position.z),n=r.clamp(_.getTiltScaleFactor(v,this._tmpDir,_.maxZoomPivotDistanceModifier)*s,_.zoomPivotDistanceClamp[0],_.zoomPivotDistanceClamp[1]),o=this.view.stage.renderView.getMinimalDepthForArea(g.getVoxelWasm(this.view),e[0],e[1],this.view.state.camera,_.pivotSearchAreaSize);let a=null!=o?o:n;t&&(a=Math.min(a,i)),d.scale(this._tmpDir,this._tmpDir,a),d.add(this._tmpP,this.startCamera.eye,this._tmpDir),d.subtract(this._tmpN,this.startCamera.eye,this.startCamera.center),d.normalize(this._tmpN,this._tmpN),this._tmpN[1]<0&&d.negate(this._tmpN,this._tmpN),p.fromPositionAndNormal(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.running)return;_.intersectPlaneFromScreenPoint(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||d.copy(this._tmpPoi,this.currentCamera.center),_.normalizeCoordinate(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);c.copy(this._normalizedAnchorPoint,this._tmpP0),d.subtract(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const r=d.length(this._tmpRayDir);let i=r*(1-t);this._constraintOptions.interactionDirection&&(d.copy(this._constraintOptions.interactionDirection,this._tmpRayDir),d.scale(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/r));const s=this.view.state.constraints.minimumPoiDistance;t>=0&&i<s&&(i=s,t=-(i-r)/r),Math.abs(r-i)<1e-6||(d.scale(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=d.add(b,this.currentCamera.eye,this._tmpRayDir),d.lerp(b,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?b[2]=Math.max(this.startCamera.center[2],b[2]):b[2]=Math.min(this.startCamera.center[2],b[2]),this.currentCamera.center=b,this._constraintOptions.interactionFactor=f.pixelDistanceToInteractionFactor(c.distance(this.dragBeginPoint,e)),f.applyAll(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}},e.ZoomControllerLocal=t.__decorate([l.subclass("esri.views.3d.state.controllers.ZoomControllerLocal")],e.ZoomControllerLocal);const b=h.create(),v=h.fromValues(0,0,1);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/input/handlers/GamepadNavigation":function(){define(["exports","../../../../core/Handles","../../../../core/reactiveUtils","../../state/controllers/GamepadKeyboardController","../../../input/InputHandler"],function(e,t,r,i,s){"use strict";class n extends s.InputHandler{constructor(e){super(!0),this._view=e,this._watchHandles=new t,this._handle=this.registerIncoming("gamepad",e=>this._handleEventGamepad(e)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([r.watch(()=>this._view.navigation.gamepad.enabled,e=>{e?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},r.initial),r.watch(()=>this._view.navigation.gamepad.device,e=>{this._cameraControllerGamepad&&e&&this._cameraControllerGamepad.gamepadDevice!==e&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const r=this._cameraControllerGamepad?.running;if(r||i.GamepadKeyboardController.activatesFor(this._view,e.data)){if(!r){const t=new i.GamepadKeyboardController({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(t),1!==t.state&&(this._cameraControllerGamepad=t)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}e.GamepadNavigation=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/GamepadKeyboardController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/compilerUtils","../../../../core/mathUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/support/ray","../../../../chunks/sphere","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../Constraints","./InteractiveController","../utils/navigationUtils","../utils/viewUtils","../../support/cameraUtils","../../support/cameraUtilsInternal","../../webgl/RenderCamera","../../../navigation/gamepadAndKeyboardUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P){"use strict";e.GamepadKeyboardController=class extends v.InteractiveController{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new C,this._headingStart=0,this._constraintOptions=new _.ConstraintOptions(15,0,0,new C,null,1)}handleEventGamepad(e){const t=P.extractTransformation(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||P.isZeroTransformation(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,P.extractTransformationKeyboard(this._keysButtonState,this._transformation)}directionActive(e){return 1===this._keysButtonState[e]}countActiveDirections(){return this._keysButtonState.reduce((e,t)=>t>0?e+1:e,0)}deactivateDirection(e){this._keysButtonState[e]=0;const t=P.extractTransformationKeyboard(this._keysButtonState,this._transformation);P.isZeroTransformation(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,E),this._applyDisabledMovementTypes(E),this._applyPan(E.pan),this._applyRotate(E.rotate),this._applyZoom(E.zoom),this._applyAscend(E.ascend),this._constraintOptions.interactionType=0,this._constraintOptions.selection=8,y.applyAll(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;u.subtract(L,t.center,t.eye),u.transformMat4(L,L,e.matrix),t.center=u.add(L,L,t.eye),t.up=u.transformMat4(L,t.up,e.matrix),this._constraintOptions.interactionType=3,this._constraintOptions.selection=7,y.applyAll(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=u.transformMat4(L,t.eye,e.matrix),t.center=u.transformMat4(L,t.center,e.matrix),this.view.state.isGlobal&&(t.up=u.transformMat4(L,t.up,e.matrix)),this._constraintOptions.interactionType=4,this._constraintOptions.selection=15,y.applyAll(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=u.add(L,this.currentCamera.eye,u.scale(g.sv3d.get(),t,e)),u.copy(V,t),u.negate(V,V),this._constraintOptions.interactionDirection=V,this._constraintOptions.interactionType=1,this._constraintOptions.selection=7,y.applyAll(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,g.sv3d.get());if(this._constraintOptions.interactionDirection=u.copy(V,t),this.view.state.isGlobal){const t=u.length(this.currentCamera.eye),r=(t+e)/t;this.currentCamera.eye=u.scale(L,this.currentCamera.eye,r),this.currentCamera.center=u.scale(L,this.currentCamera.center,r)}else{const r=u.scale(g.sv3d.get(),t,e);this.currentCamera.eye=u.add(L,this.currentCamera.eye,r),this.currentCamera.center=u.add(L,this.currentCamera.center,r)}this._updateCameraCenter(),this._constraintOptions.interactionType=5,this._constraintOptions.selection=8,y.applyAll(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=7,y.applyAll(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,r){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,l.identity(e.pan.matrix),e.rotate.enabled=!1,l.identity(e.rotate.matrix)}(r);const i=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(i,t,r):this._calculateControlTransformationGlobal(i,t,r)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,r=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(r,e,L)}_calculateControlTransformationLocal(e,t,s){const{viewRight:n,viewForward:o}=t,a=this._transformation,c=this.view.navigation.gamepad,d=u.set(g.sv3d.get(),o[0],o[1],0);u.normalize(d,d);const h=a.translation[0]*e.pan;if(0!==h){const e=u.scale(g.sv3d.get(),n,h);l.translate(s.pan.matrix,s.pan.matrix,e),s.pan.enabled=!0}switch(c.mode){case"pan":{const t=-a.translation[1]*e.pan;if(0!==t){const e=u.scale(g.sv3d.get(),d,t);l.translate(s.pan.matrix,s.pan.matrix,e),s.pan.enabled=!0}s.zoom=a.zoom*e.zoom;break}case"zoom":s.zoom=(-a.translation[1]+a.zoom)*e.zoom;break;default:r.neverReached(c.mode)}const p=a.translation[2]*e.ascend;s.ascend=p;const f=-a.heading*e.rotate;0!==f&&(l.rotate(s.rotate.matrix,s.rotate.matrix,f,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,g.sv3d.get())),s.rotate.enabled=!0);const m=a.tilt*e.rotate,y=x.viewAngle(this.view.renderCoordsHelper,t.center,t.eye),_=i.clamp(y+m,b.TiltRange.min,b.TiltRange.max)-y;_&&(l.rotate(s.rotate.matrix,s.rotate.matrix,_,n),s.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,r){const{eye:i,viewRight:s}=t,n=this._transformation,o=this.view.navigation.gamepad,a=u.cross(g.sv3d.get(),s,i);u.normalize(a,a),u.negate(a,a),w.panMotionToRotationMatrix(this.startCamera,t,n,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,r,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(E.pan,this._tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,d=n.translation[2]*e.ascend;r.ascend=d;const h=-n.heading*e.rotate;0!==h&&(l.rotate(r.rotate.matrix,r.rotate.matrix,h,this._tmpCamera.eye),r.rotate.enabled=!0);const p=n.tilt*e.rotate,f=this._clampTiltDeltaGlobalToValidRange(p,t.ray,c);0!==f&&(l.rotate(r.rotate.matrix,r.rotate.matrix,f,this._tmpCamera.viewRight),r.rotate.enabled=!0),r.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,r){const s=h.getReferenceEllipsoid(this.view.spatialReference),n=w.onSurfaceTiltToEyeTiltGlobal(b.TiltRange.min,t.origin,r,s);let o=0,a=0;const l=g.sv3d.get();if(this.view.renderCoordsHelper.intersectManifold(t,r,l)){const e=x.viewAngle(this.view.renderCoordsHelper,l,t.origin);o=w.onSurfaceTiltToEyeTiltGlobal(e,t.origin,r,s),a=w.onSurfaceTiltToEyeTiltGlobal(b.TiltRange.max,t.origin,r,s)}else{f.closestPointOnSilhouette(f.fromRadius(f.tmpSphere,r+s.radius),t,l);const e=Math.PI+m.angle(t.direction,l);o=w.offSurfaceTiltToEyeTiltGlobal(e,t.origin,r,s),a=w.offSurfaceTiltToEyeTiltGlobal(b.TiltRange.max,t.origin,r,s)}return i.clamp(o+e,n,a)-o}_getPointAbsoluteSurfaceElevation(e,t,r){const{renderCoordsHelper:i}=this.view,s=i.getAltitude(e),n=t+Math.abs(s-t);return i.setAltitude(r,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:r}=this.view,{camera:i}=this.view.state,{direction:s}=S.headingTiltToDirectionUp(this.view,t,0,R,U),n=r.intersectManifoldClosestSilhouette(p.wrap(t,s),e,g.sv3d.get()),o=u.distance(t,n),a=r.intersectManifoldClosestSilhouette(p.wrap(t,u.direction(g.sv3d.get(),t,i.center)),e,g.sv3d.get()),l=u.distance(t,a);return Math.min(o,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:r}=this.view,{camera:s,isGlobal:n}=r,o=t.intersectManifoldClosestSilhouette(s.ray,this._filteredSurfaceElevation,g.sv3d.get());if(n){const t=u.subtract(g.sv3d.get(),e,o),r=u.length(t);u.scale(t,t,1/r);const s=u.normalize(g.sv3d.get(),e),n=i.acosClamped(u.dot(s,t));return r*Math.sin(Math.min(O,n))}{const r=u.copy(g.sv3d.get(),e);return t.setAltitude(r,this._filteredSurfaceElevation),u.distance(o,r)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:F}_computeVelocities(e){const t=this._filteredSurfaceElevation,r=t+h.getReferenceEllipsoid(this.view.spatialReference).radius,{camera:s,isGlobal:n}=this.view.state,o=g.sv3d.get(),a=this._getPointAbsoluteSurfaceElevation(s.eye,t,o),l=this._clampedDistanceToSurface(t,o),c=s.width/2,u=I*s.width,d=I*s.width,p=l*Math.tan(.5*s.fovX)/c,f=p/r,m=p/this._computeHeadingRotateRadius(o),y=a-t;return{pan:(n?f:p)*u*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(u*e/c)*y-y),zoom:2**(u*e/c)*l-l,rotate:i.clamp(m*d,A,D)*e}}_applyDisabledMovementTypes(e){null==this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&l.identity(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&l.identity(e.rotate.matrix))}static activatesFor(e,t){const r=P.extractTransformation(t,e.navigation.gamepad,M);return!("end"===t.action||P.isZeroTransformation(r))}},t.__decorate([s.property({constructOnly:!0})],e.GamepadKeyboardController.prototype,"gamepadDevice",void 0),t.__decorate([s.property({constructOnly:!0})],e.GamepadKeyboardController.prototype,"disableMovements",void 0),e.GamepadKeyboardController=t.__decorate([a.subclass("esri.views.3d.state.controllers.GamepadKeyboardController")],e.GamepadKeyboardController);const M={translation:[0,0,0],heading:0,tilt:0,zoom:0},R=80,O=i.deg2rad(R),I=.75,F=5,A=i.deg2rad(30),D=i.deg2rad(80),E={zoom:0,ascend:0,pan:{enabled:!1,matrix:c.create()},rotate:{enabled:!1,matrix:c.create()}},L=d.create(),V=d.create(),U=T.createDirectionUp();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/navigation/gamepadAndKeyboardUtils":function(){define(["exports","../../chunks/vec32"],function(e,t){"use strict";function r(e){let t=e*e;return e<0&&(t*=-1),t}e.extractTransformation=function(e,i,s){const n=s,o=e.state,a=e.device,l="forward-down"===i.tiltDirection?1:-1;return"standard"===a.deviceType?(n.translation[0]=r(o.axes[0]),n.translation[1]=r(o.axes[1]),n.translation[2]=r(o.buttons[7])-r(o.buttons[6]),n.heading=r(o.axes[2]),n.tilt=r(o.axes[3])):"spacemouse"===a.deviceType&&(n.translation[0]=1.2*r(o.axes[0]),n.translation[1]=1.2*r(o.axes[1]),n.translation[2]=2*-r(o.axes[2]),n.heading=1.2*r(o.axes[5]),n.tilt=1.2*r(o.axes[3])),n.tilt*=l,t.scale(n.translation,n.translation,1),n},e.extractTransformationKeyboard=function(e,t){const r=t;return r.translation[0]=e[1]-e[0],r.translation[1]=e[3]-e[2],r.translation[2]=e[4]-e[5],r.heading=e[7]-e[6],r.tilt=e[8]-e[9],r.zoom=e[10]-e[11],r},e.isZeroTransformation=function(e){return 0===e.translation[0]&&0===e.translation[1]&&0===e.translation[2]&&0===e.heading&&0===e.tilt&&0===e.zoom},e.resetTransformation=function(e){return e.translation[0]=0,e.translation[1]=0,e.translation[2]=0,e.heading=0,e.tilt=0,e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/input/handlers/KeyboardNavigation":function(){define(["exports","../../state/controllers/GamepadKeyboardController","../../../input/InputHandler","../../../input/VisibilityChange"],function(e,t,r,i){"use strict";class s extends r.InputHandler{constructor(e,t){super(!0),this._view=e,this._keyToDirection=new Map,this._keyToAction=new Map,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._addKeysMapping(t),this.registerIncoming("key-down",null,e=>this._handleKeyDown(e)),this.registerIncoming("key-up",null,e=>this._handleKeyUp(e)),this.registerIncoming("blur",null,()=>this._handleStop()),this._visibilityHandle=i.onVisibilityChange(e=>e?null:this._handleStop())}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}setStickyKeyDuration(e){this._stickyKeyDuration=e}_addKeysMapping(e){this._addKeyMapping(e.pan.left,0),this._addKeyMapping(e.pan.right,1),this._addKeyMapping(e.pan.forward,2),this._addKeyMapping(e.pan.backward,3),this._addKeyMapping(e.pan.up,4),this._addKeyMapping(e.pan.down,5),this._addKeyMapping(e.lookAround.headingLeft,6),this._addKeyMapping(e.lookAround.headingRight,7),this._addKeyMapping(e.lookAround.tiltUp,8),this._addKeyMapping(e.lookAround.tiltDown,9),this._addKeyMapping(e.zoom.zoomIn,10),this._addKeyMapping(e.zoom.zoomOut,11),this._addKeyAction(e.reset.heading,()=>this._resetHeading()),this._addKeyAction(e.reset.tilt,()=>this._resetTilt())}_addKeyMapping(e,t){for(const r of this._eachKey(e))this._keyToDirection.set(r,t)}*_eachKey(e){"string"==typeof e?yield e:yield*e}_addKeyAction(e,t){for(const r of this._eachKey(e))this._keyToAction.set(r,t)}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const r=this._keyToAction.get(e.data.key);if(null!=r)return e.stopPropagation(),void r();const i=this._keyToDirection.get(e.data.key);if(null!=i&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new t.GamepadKeyboardController({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(e.stopPropagation(),this._cameraControllerKeyboard.directionActive(i))return;if(this._cameraControllerKeyboard.activateDirection(i),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(i))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout(()=>{this._stickyKeyTimeoutHandle=void 0,null!=this._stickyDirection&&void 0!==this._stickyDirection&&(this._cameraControllerKeyboard?.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)},this._stickyKeyDuration))}}_handleStop(){this._cameraControllerKeyboard?.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey||!this._cameraControllerKeyboard?.running)return;const t=this._keyToDirection.get(e.data.key);if(null==t)return;e.stopPropagation();const r=void 0===this._stickyKeyTimeoutHandle;void 0===this._stickyKeyTimeoutHandle||1!==this._cameraControllerKeyboard?.countActiveDirections()?(this._cameraControllerKeyboard?.deactivateDirection(t),r&&(this._stickyDirection=void 0)):this._stickyDirection=t}_isPanning(e){return e<=3}_resetHeading(){this._view.goTo({heading:0}).catch(()=>{})}_resetTilt(){this._view.goTo({tilt:0}).catch(()=>{})}}e.KeyboardNavigation=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/VisibilityChange":function(){define(["exports","../../core/handleUtils"],function(e,t){"use strict";e.onVisibilityChange=function(e){const r=()=>e("visible"===document.visibilityState);return document.addEventListener("visibilitychange",r),t.makeHandle(()=>document.removeEventListener("visibilitychange",r))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/input/handlers/MouseWheelZoom":function(){define(["exports","../../../../core/screenUtils","../../state/controllers/FovController","../../state/controllers/ZoomStepControllerGlobal","../../state/controllers/ZoomStepControllerLocal","../../../input/InputHandler"],function(e,t,r,i,s,n){"use strict";class o extends n.InputHandler{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",[t],e=>this._handleFov(e)),this.registerIncoming("mouse-wheel",e=>this._handleZoom(e))}_handleZoom(e){if(!this._mouseWheelZoomEnabled)return;const r=e.data;this._zoomController?.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new i.ZoomStepControllerGlobal({view:this._view,mode:"interaction"}):new s.ZoomStepControllerLocal({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-r.deltaY/60,t.createScreenPointArray(r.x,r.y)),e.preventDefault(),e.stopPropagation()}_handleFov(e){this._mouseWheelZoomEnabled&&(this._fovController?.running||(this._zoomController?.finish(),this._fovController?.hideOverlay(),this._fovController=new r.FovController({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),1!==this._fovController.state)?(this._fovController.updateTimeout(),this._fovController.step(e.data.deltaY/20),e.preventDefault(),e.stopPropagation()):this._stopFovController())}get _mouseWheelZoomEnabled(){return"zoom"===this._view.navigation.actionMap.mouseWheel}_stopFovController(){this._fovController?.finish(),this._fovController=null}}e.MouseWheelZoom=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/input/handlers/PinchAndPanNavigation":function(){define(["exports","../../state/controllers/PinchAndPanControllerGlobal","../../state/controllers/PinchAndPanControllerLocal","../../../input/InputHandler","../../../input/handlers/support"],function(e,t,r,i,s){"use strict";class n extends i.InputHandler{constructor(e,t,r){super(!0),this._view=e,this.pointerActions=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",r,e=>this._handleDrag(e))}_handleDrag(e){if("mouse"===e.data.pointerType&&!s.eventMatchesMousePointerActions(e.data,this.pointerActions))return;const t=e.timestamp-this._lastEndTimestamp,r=this._momentum&&this._momentum.running&&t<40;switch(e.data.action){case"start":case"update":if(r)break;this._controller&&this._controller.running?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller?.running){this._lastEndTimestamp=e.timestamp;const r=this._controller.end(e.data);t&&r&&(this._momentum=r,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new t.PinchAndPanControllerGlobal({view:this._view}):new r.PinchAndPanControllerLocal({view:this._view})}}e.PinchAndPanNavigation=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/PinchAndPanControllerGlobal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/vec2","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/support/axisAngle","../../../../geometry/support/plane","../../../../chunks/sphere","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../input/util","./InteractiveController","./momentum/PanPlanarMomentumController","./momentum/PanSphericalMomentumController","./momentum/RotationMomentumController","./momentum/ZoomPlanarMomentumController","./momentum/ZoomSphericalMomentumController","../utils/navigationUtils","../../webgl/RenderCamera","../../../navigation/PanPlanarMomentumEstimator","../../../navigation/PanSphericalMomentumEstimator","../../../navigation/RotationMomentumEstimator","../../../navigation/ZoomMomentumEstimator"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F){"use strict";e.PinchAndPanControllerGlobal=class extends v.InteractiveController{constructor(){super(...arguments),this._smoothRotation=new b.ExponentialFalloff(.05),this._rotationAxis=h.create(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=m.create(),this._beginRadius=0,this._smoothScaling=new b.ExponentialFalloff(.05),this._zoomCenterScreen=s.createScreenPointArray(),this._zoomMomentumEstimator=new F.ZoomMomentumEstimator,this._rotationMomentumEstimator=new I.RotationMomentumEstimator,this._panSphericalMomentumEstimator=new O.PanSphericalMomentumEstimator,this._panPlanarMomentumEstimator=new R.PanPlanarMomentumEstimator,this._adjustedSphere=g.create(),this._tmp3d=h.create(),this._tmpScreenPointArray=s.createScreenPointArray(),this._beginScreenPoint=s.createScreenPointArray(),this._beginScenePoint=h.create(),this._screenPickPoint=s.createScreenPointArray(),this._scenePickPoint=h.create(),this._navMode=1,this._sphere=g.create(),this._pointerCount=0,this._tmpInteractionDirection=h.create(),this._beginCamera=new M,this._constraintOptions=new _.ConstraintOptions(15,0,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-r.cyclicalPI.normalize(i.deg2rad(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),s.screenPointObjectToArray(e.center,this._screenPickPoint),u.copy(this._beginScreenPoint,this._screenPickPoint);const t=P.pickPointAndInitSphere(this._intersectionHelper,this.startCamera,this._screenPickPoint,p.getReferenceEllipsoid(this.view.spatialReference).radius,1,this.view.basemapTerrain.invisible?P.excludeTerrain:{});null!=t.scenePickPoint&&(this._scenePickPoint=t.scenePickPoint,this._sphere=t.sphere,d.copy(this._beginScenePoint,this._scenePickPoint),this._navMode=P.navigationMode(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),0===this._navMode&&this._preparePlanarPanMode(e,t.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;1===this._navMode?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return 1===this._navMode?new C.ZoomSphericalMomentumController({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new T.ZoomPlanarMomentumController({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const r=this._rotationMomentumEstimator.evaluateMomentum();if(r)return new S.RotationMomentumController({view:this.view,momentum:r,center:g.getCenter(this._sphere),axis:this._rotationAxis});if(1===this._navMode){const e=this._panSphericalMomentumEstimator.evaluateMomentum();if(e)return new x.PanSphericalMomentumController({view:this.view,momentum:e})}else{const e=this._panPlanarMomentumEstimator.evaluateMomentum();if(e)return new w.PanPlanarMomentumController({view:this.view,momentum:e})}return null}_preparePlanarPanMode(e,t){const r=d.negate(this._tmp3d,this.startCamera.viewForward);m.fromPositionAndNormal(this._scenePickPoint,r,this._panningPlane);const i=s.createScreenPointArray(this._screenPickPoint[0],0),n=h.create(),o=d.length(this.startCamera.eye);this._adjustedSphere[3]=o<this._sphere[3]?o-100:this._sphere[3],P.sphereOrPlanePointFromScreenPoint(this._adjustedSphere,this.startCamera,i,n);const a=s.createRenderScreenPointArray3();this.startCamera.projectToRenderScreen(n,a);const l=h.create(),c=h.create(),u=h.create();d.subtract(l,this._scenePickPoint,this.currentCamera.eye);const p=d.length(l);d.normalize(l,l);const f=P.maxPanDistanceModifier*Math.max(Math.abs(this.view.camera.position.z),P.minPinchAndPanCameraHeight),g=this.view.stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,P.pivotSearchAreaSize);let y=null!=g?g:f;t&&(y=Math.min(y,p)),d.copy(u,d.add(c,this.currentCamera.eye,d.scale(c,l,y))),this._panningPlane[3]=-d.dot(m.getNormal(this._panningPlane),u),this.startCamera.center=d.add(c,this.startCamera.eye,d.scale(c,this.startCamera.viewForward,y));const _=s.screenPointObjectToArray(e.center,this._tmpScreenPointArray);P.intersectPlaneFromScreenPointAtEye(this._panningPlane,this.startCamera,_,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=r,this._smoothScaling.update(t),P.applyZoomOnSphere(this._sphere,this.currentCamera,this._smoothScaling.value),s.screenPointObjectToArray(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(e.radius-this._beginRadius),y.applyAll(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=s.screenPointObjectToArray(e.center,this._tmpScreenPointArray);P.sphereOrPlanePointFromScreenPoint(this._sphere,this.currentCamera,t,this._tmp3d),P.shouldPreserveHeading(this._beginScenePoint,d.dot(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera.aboveGround)?(P.applyPanSphericalPreserveHeading(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(P.applyPanSphericalDirectRotation(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(u.distance(this._screenPickPoint,t)),y.applyAll(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){d.normalize(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||d.negate(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,r=t+P.normalizeRotationDelta(e.angle-t),i=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=i,this._smoothRotation.update(r);const s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*e.timestamp),P.applyRotation(this.currentCamera,g.getCenter(this._sphere),f.wrapAxisAngle(this._rotationAxis,s)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(e.radius*r),y.applyAll(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=s.screenPointObjectToArray(e.center,this._tmpScreenPointArray);P.intersectPlaneFromScreenPointAtEye(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(P.applyPanPlanar(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(u.distance(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),y.applyAll(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=r,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),P.applyZoomToPoint(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(e.radius-this._beginRadius),y.applyAll(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){d.copy(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||d.negate(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let r=e.angle-t;r=P.normalizeRotationDelta(r);const i=t+r,s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(i);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),P.applyRotation(this.currentCamera,g.getCenter(this._sphere),f.wrapAxisAngle(this._rotationAxis,n)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(e.radius*n),y.applyAll(this.view,this.currentCamera,this._constraintOptions)}},e.PinchAndPanControllerGlobal=t.__decorate([c.subclass("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],e.PinchAndPanControllerGlobal),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/input/util":function(){define(["exports"],function(e){"use strict";e.ExponentialFalloff=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/momentum/PanPlanarMomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./MomentumController"],function(e,t,r,i,s,n,o,a,l,c){"use strict";e.PanPlanarMomentumController=class extends c.MomentumController{constructor(e){super(e),this.interactionType=4,this._tmpPan=l.create()}momentumStep(e,t){const r=this.momentum.value(e);a.scale(this._tmpPan,this.momentum.direction,r),t.eye=a.subtract(u,t.eye,this._tmpPan),t.center=a.subtract(u,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}},t.__decorate([r.property({constructOnly:!0})],e.PanPlanarMomentumController.prototype,"momentum",void 0),e.PanPlanarMomentumController=t.__decorate([o.subclass("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],e.PanPlanarMomentumController);const u=l.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/momentum/MomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Logger","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../ViewAnimation","../../../camera/constraintUtils","../../../camera/constraintUtils/ConstraintOptions","../AnimationController","../../../webgl/RenderCamera"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";e.MomentumController=class extends u.AnimationController{constructor(){super(...arguments),this._beginCamera=new d,this._elapsedTimeSec=0,this.constraintOptions=new c.ConstraintOptions(15,4,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new a}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),l.applyAll(this.view,t,this.constraintOptions)}},e.MomentumController=t.__decorate([o.subclass("esri.views.3d.state.controllers.momentum.MomentumController")],e.MomentumController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/momentum/PanSphericalMomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./MomentumController","../../utils/navigationUtils"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=l.create(),h=l.create();e.PanSphericalMomentumController=class extends c.MomentumController{constructor(e){super(e),this.interactionType=4}momentumStep(e,t){const r=this.momentum.value1(e),i=this.momentum.value2(e);a.copy(h,t.eye),a.normalize(h,h),a.cross(this.momentum.axis2,h,this.momentum.axis1),u.applyRotationWithTwoAxes(t,d,this.momentum.axis1,r,this.momentum.axis2,i)}},t.__decorate([r.property({constructOnly:!0})],e.PanSphericalMomentumController.prototype,"momentum",void 0),e.PanSphericalMomentumController=t.__decorate([o.subclass("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],e.PanSphericalMomentumController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/momentum/RotationMomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/axisAngle","./MomentumController","../../utils/navigationUtils"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.RotationMomentumController=class extends c.MomentumController{set center(e){this._set("center",a.clone(e))}set axis(e){this._set("axis",a.clone(e))}constructor(e){super(e),this.interactionType=2}momentumStep(e,t){const r=this.momentum.value(e);u.applyRotation(t,this.center,l.wrapAxisAngle(this.axis,r))}},t.__decorate([r.property({constructOnly:!0})],e.RotationMomentumController.prototype,"momentum",void 0),t.__decorate([r.property({constructOnly:!0})],e.RotationMomentumController.prototype,"center",null),t.__decorate([r.property({constructOnly:!0})],e.RotationMomentumController.prototype,"axis",null),e.RotationMomentumController=t.__decorate([o.subclass("esri.views.3d.state.controllers.momentum.RotationMomentumController")],e.RotationMomentumController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/momentum/ZoomPlanarMomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./MomentumController","../../utils/navigationUtils"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.ZoomPlanarMomentumController=class extends c.MomentumController{set zoomCenter(e){this._set("zoomCenter",l.clone(e))}constructor(e){super(e),this.interactionType=1,this.constraintOptions.interactionDirection=l.create()}momentumStep(e,t){const{interactionDirection:r}=this.constraintOptions;if(!r)return;a.copy(r,t.eye);const i=this.momentum.valueDelta(0,e);u.applyZoomToPoint(t,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),a.direction(r,t.eye,r)}},t.__decorate([r.property({constructOnly:!0})],e.ZoomPlanarMomentumController.prototype,"momentum",void 0),t.__decorate([r.property({constructOnly:!0})],e.ZoomPlanarMomentumController.prototype,"zoomCenter",null),e.ZoomPlanarMomentumController=t.__decorate([o.subclass("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],e.ZoomPlanarMomentumController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/momentum/ZoomSphericalMomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/screenUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/axisAngle","../../../../../chunks/sphere","../../../camera/constraintUtils","./MomentumController","../../utils/navigationUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";e.ZoomSphericalMomentumController=class extends h.MomentumController{set screenCenter(e){this._set("screenCenter",r.createScreenPointArray(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",l.clone(e))}constructor(e){super(e),this.interactionType=1,this.radius=0,this._tmpSceneCenter=l.create(),this._tmpZoomAxisAngle=c.create(),this._sphere=u.create()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const r=this.momentum.valueDelta(0,e);p.applyZoomOnSphere(this._sphere,t,r),this.constraintOptions.interactionType=1,d.applyAll(this.view,t,this.constraintOptions),p.sphereOrPlanePointFromScreenPoint(this._sphere,t,this.screenCenter,this._tmpSceneCenter),c.fromPoints(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),p.applyRotation(t,u.getCenter(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=4}},t.__decorate([i.property({constructOnly:!0})],e.ZoomSphericalMomentumController.prototype,"momentum",void 0),t.__decorate([i.property({constructOnly:!0})],e.ZoomSphericalMomentumController.prototype,"screenCenter",null),t.__decorate([i.property({constructOnly:!0})],e.ZoomSphericalMomentumController.prototype,"sceneCenter",null),t.__decorate([i.property({constructOnly:!0})],e.ZoomSphericalMomentumController.prototype,"radius",void 0),e.ZoomSphericalMomentumController=t.__decorate([a.subclass("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],e.ZoomSphericalMomentumController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/navigation/PanPlanarMomentumEstimator":function(){define(["exports","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","./FilteredFiniteDifference","./Momentum"],function(e,t,r,i,s){"use strict";class n extends s.Momentum{constructor(e,t,r,i,s){super(e,t,r),this._sceneVelocity=i,this.direction=s}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}}e.PanPlanarMomentum=n,e.PanPlanarMomentumEstimator=class{constructor(e=300,t=12,s=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=s,this.enabled=!0,this._time=new i.FilteredFiniteDifference(.6),this._screen=[new i.FilteredFiniteDifference(.4),new i.FilteredFiniteDifference(.4)],this._scene=[new i.FilteredFiniteDifference(.6),new i.FilteredFiniteDifference(.6),new i.FilteredFiniteDifference(.6)],this._tmpDirection=r.create()}add(e,t,r){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(r)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(r)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,r=null==e||null==t?0:Math.sqrt(e*e+t*t),i=this._time.filteredDelta,s=null==i||null==r?0:r/i;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,r,i){t.set(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const s=t.length(this._tmpDirection);s>0&&t.scale(this._tmpDirection,this._tmpDirection,1/s);const o=this._time.filteredDelta;return new n(e,r,i,null==o?0:s/o,this._tmpDirection)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/navigation/FilteredFiniteDifference":function(){define(["exports"],function(e){"use strict";e.FilteredFiniteDifference=class{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return void 0!==this.lastValue}hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return void 0===this.lastValue?NaN:e-this.lastValue}_updateDelta(e){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/navigation/Momentum":function(){define(["exports"],function(e){"use strict";e.Momentum=class{constructor(e,t,r){this._initialVelocity=e,this._stopVelocity=t,this._friction=r,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const r=this.value(e);return this.value(e+t)-r}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const r=1-this.friction;return e*(r**t-1)/Math.log(r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/navigation/PanSphericalMomentumEstimator":function(){define(["exports","../../core/libs/gl-matrix-2/factories/vec2f64","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","../3d/state/utils/navigationUtils","./FilteredFiniteDifference","./FilteredValue","./Momentum"],function(e,t,r,i,s,n,o,a){"use strict";const l=1e-5;class c extends a.Momentum{constructor(e,t,r,i,s,n=0,o){super(e,t,r),this._angularVelocity1=i,this.axis1=s,this.angularVelocity2=n,this.axis2=o}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}e.PanSphericalMomentum=c,e.PanSphericalMomentumEstimator=class{constructor(e=300,r=12,s=.84){this._minimumInitialVelocity=e,this._stopVelocity=r,this._friction=s,this.enabled=!0,this._tmpAxis1=i.create(),this._tmpAxis2=i.create(),this._tmpAngles=t.create(),this._time=new n.FilteredFiniteDifference(.3),this._screen=[new n.FilteredFiniteDifference(.4),new n.FilteredFiniteDifference(.4)],this._angle1=new o.FilteredValue(.6),this._angle2=new o.FilteredValue(.6),this._axis1=i.create(),this._axis2=i.create(),this._lastScene=i.create()}addMomentumDirectRotation(e,t,i,n,o,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let e=s.rotationAngleAndAxisDirectRotation(this._lastScene,t,this._tmpAxis2,n,o,a);this._angle2.update(0),r.squaredLength(this._tmpAxis2)<l?e=0:r.normalize(this._axis1,this._tmpAxis2),this._angle1.update(e),r.copy(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,n,o,a,c){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;s.rotationAnglesAndAxesHeadingPreserving(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,n,o,a,c,!1),r.squaredLength(this._tmpAxis2)<l?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),r.normalize(this._axis1,this._tmpAxis1),r.normalize(this._axis2,this._tmpAxis2)),r.copy(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,r=null==e||null==t?null:Math.sqrt(e*e+t*t),i=this._time.filteredDelta,s=null==r||null==i?0:r/i;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,t,r){const i=this._time.filteredDelta,s=this._angle1.filteredValue,n=this._angle2.filteredValue,o=null==i||null==n?0:n/i;return new c(e,t,r,null==i||null==s?0:s/i,this._axis1,o,this._axis2)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/navigation/FilteredValue":function(){define(["exports"],function(e){"use strict";e.FilteredValue=class{constructor(e){this._gain=e}update(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/navigation/RotationMomentumEstimator":function(){define(["exports","./MomentumEstimator"],function(e,t){"use strict";class r extends t.MomentumEstimator{constructor(e=3,t=.01,r=.95,i=12){super(e,t,r,i)}add(e,t){const r=this.value.lastValue;if(null!=r){let t=e-r;for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;e=r+t}super.add(e,t)}}e.RotationMomentumEstimator=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/navigation/MomentumEstimator":function(){define(["exports","../../core/mathUtils","./FilteredFiniteDifference","./Momentum"],function(e,t,r,i){"use strict";e.MomentumEstimator=class{constructor(e=2.5,t=.01,i=.95,s=12){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this._maxVelocity=s,this.enabled=!0,this.value=new r.FilteredFiniteDifference(.8),this.time=new r.FilteredFiniteDifference(.3)}add(e,t){if(this.enabled&&null!=t){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){const t=this.value.computeDelta(e);this.value.filteredDelta*t<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=t.clamp(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,t,r){return new i.Momentum(e,t,r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/navigation/ZoomMomentumEstimator":function(){define(["exports","./Momentum","./MomentumEstimator"],function(e,t,r){"use strict";class i extends t.Momentum{constructor(e,t,r){super(e,t,r)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const r=super.value(e),i=super.value(e+t)-r;return Math.exp(i)}}class s extends r.MomentumEstimator{constructor(e=2.5,t=.01,r=.95,i=12){super(e,t,r,i)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,r){return new i(e,t,r)}}e.ZoomMomentum=i,e.ZoomMomentumEstimator=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/controllers/PinchAndPanControllerLocal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/screenUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/vec2","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/plane","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../input/util","../../layers/VoxelWasm","./InteractiveController","./momentum/PanPlanarMomentumController","./momentum/RotationMomentumController","./momentum/ZoomPlanarMomentumController","../utils/navigationUtils","../../webgl/RenderCamera","../../../navigation/PanPlanarMomentumEstimator","../../../navigation/RotationMomentumEstimator","../../../navigation/ZoomMomentumEstimator"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C){"use strict";const P=u.fromValues(0,0,1);e.PinchAndPanControllerLocal=class extends y.InteractiveController{constructor(){super(...arguments),this._rotationValueSmooth=new m.ExponentialFalloff(.05),this._scalingValueSmooth=new m.ExponentialFalloff(.05),this._planeHorizontal=h.create(),this._planeVertical=h.create(),this._rotationMomentumEstimator=new T.RotationMomentumEstimator,this._panMomentumEstimator=new S.PanPlanarMomentumEstimator(300,12,.9),this._zoomMomentumEstimator=new C.ZoomMomentumEstimator,this._beginRadius=0,this._beginCenter=u.create(),this._beginAngle=0,this._tmpPoints=[],this._navMode=1,this._beginCenterScreen=r.createScreenPointArray(),this._tmpCentroid3d=u.create(),this._tmpCentroid2d=r.createScreenPointArray(),this._tmp2d=r.createScreenPointArray(),this._pointerCount=0,this._beginCamera=new x,this._constraintOptions=new f.ConstraintOptions(15,0,0,this._beginCamera)}begin(e){if(!this.running)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),r.screenPointObjectToArray(e.center,this._beginCenterScreen),h.fromNormalAndOffset(P,0,this._planeHorizontal);const i=u.create(),s=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.basemapTerrain.invisible?w.excludeTerrain:{}),n=u.create();c.negate(n,this.startCamera.viewForward);const o=u.create();c.copy(o,P);const a=c.dot(n,o);this._navMode=w.navigationMode(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const l=w.getTiltScaleFactor(o,this.startCamera.viewForward,w.maxPanDistanceModifier)*Math.max(Math.abs(this.view.camera.position.z),w.minPinchAndPanCameraHeight);h.setOffsetFromPoint(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||h.negate(this._planeHorizontal,this._planeHorizontal);const d=u.create(),p=u.create(),f=u.create();c.subtract(d,i,this.currentCamera.eye);const m=c.length(d);if(c.normalize(d,d),0===this._navMode){c.scale(o,o,a),c.subtract(h.getNormal(this._planeVertical),n,o),c.normalize(h.getNormal(this._planeVertical),h.getNormal(this._planeVertical)),h.setOffsetFromPoint(this._planeVertical,this._planeVertical,i);const t=this.view.stage.renderView.getMinimalDepthForArea(g.getVoxelWasm(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,w.pivotSearchAreaSize);let r=null!=t?t:l;s&&(r=Math.min(r,m)),c.copy(f,c.add(p,this.currentCamera.eye,c.scale(p,d,r))),this._planeVertical[3]=-c.dot(h.getNormal(this._planeVertical),f),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),w.centroid(this._tmpPoints,this._beginCenter)}else{const t=s?m:l;c.copy(f,c.add(p,this.currentCamera.eye,c.scale(p,d,t))),this._planeHorizontal[3]=-c.dot(h.getNormal(this._planeHorizontal),f),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),w.centroid(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=1===this._navMode?this._planeHorizontal:this._planeVertical,s=this._beginCenter;if(t){const t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=r,this._scalingValueSmooth.update(t),w.applyZoomToPoint(this.currentCamera,s,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=p.pixelDistanceToInteractionFactor(Math.abs(e.radius-this._beginRadius)),p.applyAll(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),w.centroid(this._tmpPoints,this._tmpCentroid3d),r.screenPointObjectToArray(e.center,this._tmpCentroid2d),w.applyPanPlanar(this.currentCamera,s,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=p.pixelDistanceToInteractionFactor(l.distance(this._beginCenterScreen,this._tmpCentroid2d)),p.applyAll(this.view,this.currentCamera,this._constraintOptions),t){const t=s,r=this._rotationValueSmooth.value,i=r+w.normalizeRotationDelta(e.angle-r),n=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=n,this._rotationValueSmooth.update(i);const o=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(o,.001*e.timestamp);const a=h.getNormal(this._planeHorizontal);w.applyRotation(this.currentCamera,t,d.wrapAxisAngle(a,o)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=p.pixelDistanceToInteractionFactor(Math.abs(e.radius*o)),p.applyAll(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new v.ZoomPlanarMomentumController({view:this.view,momentum:t,zoomCenter:this._beginCenter});const r=this._rotationMomentumEstimator.evaluateMomentum();if(r)return new b.RotationMomentumController({view:this.view,momentum:r,center:this._beginCenter,axis:h.getNormal(this._planeHorizontal)});const i=this._panMomentumEstimator.evaluateMomentum();return i?new _.PanPlanarMomentumController({view:this.view,momentum:i}):null}_computePlanePoints(e,t,r,i){i.length=e.size;const s=this._tmp2d;let n=0;return e.forEach(e=>{s[0]=e.x,s[1]=e.y,void 0===i[n]&&(i[n]=u.create()),w.intersectPlaneFromScreenPointAtEye(t,r,s,i[n]),n+=1}),i}get _intersectionHelper(){return this.view.sceneIntersectionHelper}},e.PinchAndPanControllerLocal=t.__decorate([a.subclass("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],e.PinchAndPanControllerLocal),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/input/handlers/PointerDownCancelAnimation":function(){define(["exports","../../../input/InputHandler"],function(e,t){"use strict";class r extends t.InputHandler{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,()=>this.view.state.stopActiveCameraController())}}e.PointerDownCancelAnimation=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/input/handlers/TwoFingerTilt":function(){define(["exports","../../../../core/screenUtils","../../state/controllers/RotateController","../../../input/InputHandler"],function(e,t,r,i){"use strict";class s extends i.InputHandler{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",e=>this._handleTwoFinger(e))}_handleTwoFinger(e){const i=this._invert?-1:1,s=t.createScreenPointArray(0,e.data.delta*i);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new r.RotateController({view:this._view,pivot:0}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(s);break;case"update":this._cameraController?.update(s);break;case"end":this._cameraController?.end(),this._cameraController=null}}}e.TwoFingerTilt=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/BrowserEventSource":function(){define(["exports","../../core/has","../../core/maybe","./gamepad/GamepadSource","../support/screenUtils"],function(e,t,r,i,s){"use strict";const n=t("edge"),o=t("chrome"),a=t("ff"),l=t("safari"),c="esri-view-surface",u={touchNone:`${c}--touch-none`,touchPan:`${c}--touch-pan`};class d{static{this.test={disableSubpixelCoordinates:!1}}constructor(e,t){this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=e,e.getAttribute("tabindex")||e.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new i.GamepadSource(e,t),this._gamepadSource.onEvent=e=>this._callback("gamepad",e)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach(e=>this._releasePointerCaptureSafe(e)),this._activePointerCaptures.clear(),this._gamepadSource=r.destroyMaybe(this._gamepadSource),this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(e){this._browserTouchPanningEnabled=e,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(e){this._callback=e}set activeEvents(e){for(const t in this._active)if(!e||!e.has(t)){const e=this._active[t];this._element.removeEventListener(h[t],e),delete this._active[t]}e&&e.forEach(e=>{if(!this._active[e]&&h[e]){const t=(this._eventHandlers[e]||this._handleDefault).bind(this,e);this._element.addEventListener(h[e],t),this._active[e]=t}}),this._gamepadSource&&(this._gamepadSource.hasEventListeners=e?.has("gamepad")??!1)}setPointerCapture(e,t){t?this._setPointerCaptureSafe(e.pointerId):(this._releasePointerCaptureSafe(e.pointerId),this._activePointerCaptures.delete(e.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?u.touchNone:u.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?u.touchPan:u.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(u.touchNone),this._element.classList.remove(u.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_setPointerCaptureSafe(e){try{this._element.setPointerCapture(e),this._activePointerCaptures.add(e)}catch{}}_releasePointerCaptureSafe(e){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(e))return;this._element.releasePointerCapture(e)}catch(e){}}_updateNormalizedPointerLikeEvent(e,t){const r=s.createScreenPointFromNativeEvent(this._element,e);return d.test.disableSubpixelCoordinates&&(r.x=Math.round(r.x),r.y=Math.round(r.y)),t.x=r.x,t.y=r.y,t}_handleKey(e,t){const{key:r}=t;r&&"key-up"===e&&this._keyDownState.delete(r);const i={native:t,key:r,repeat:!!r&&this._keyDownState.has(r)};r&&"key-down"===e&&this._keyDownState.add(i.key),this._callback(e,i)}_handlePointer(e,t){const r=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});this._callback(e,r)}_handlePointerPreventDefault(e,t){const r=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});t.preventDefault(),this._callback(e,r)}_getDeltaFromTrackpadOrMouseWheel(e){return e.shiftKey&&t("mac")&&0===e.deltaY?e.deltaX:e.deltaY}_handleMouseWheel(e,t){let r=this._getDeltaFromTrackpadOrMouseWheel(t);switch(t.deltaMode){case 0:n&&(r=r/document.documentElement.clientHeight*600);break;case 1:r*=30;break;case 2:r*=900}n?r*=.7:o||l?r*=.6:a&&(r*=1.375);const i=Math.abs(r);i>100&&(r=r/i*200/(1+Math.exp(-.02*(i-100))));const s=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,deltaY:r});this._callback(e,s)}_handlePointerCaptureLost(e,t){this._activePointerCaptures.delete(t.pointerId),this._handleDefault(e,t)}_handleDefault(e,t){const r={native:t};t.preventDefault(),this._callback(e,r)}_preventAltKeyDefault(e){"Alt"===e.key&&e.preventDefault()}_preventMultiTouchPanning(e){e.touches.length>1&&e.preventDefault()}}const h={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};e.BrowserEventSource=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/gamepad/GamepadSource":function(){define(["exports","../../../core/scheduling","./GamepadInputDevice","./GamepadState"],function(e,t,r,i){"use strict";function s(e){if(!e)return!1;if(!e.connected)return!1;for(let t=0;t<e.axes.length;t++)if(isNaN(e.axes[t]))return!1;return!0}function n(e){for(const t of navigator.getGamepads())s(t)&&e(t)}e.GamepadSource=class{constructor(e,t){this._element=e,this._input=t,this._hasEventListeners=!1,this._onConnectGamepad=e=>{this._connectGamepad(e.gamepad)},this._onDisconnectGamepad=e=>{const t=e.gamepad,r=t.index,s=this._inputDevices[r];s&&(this._emitGamepadEvent(t,i.extractState(s),!1),this._inputDevices.splice(r,1),this._latestUpdate.splice(r,1),this._input.gamepad.devices.remove(s),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;const r="getGamepads"in window.navigator,s=window.isSecureContext;this.supported=r&&s,this.supported&&(n(e=>this._connectGamepad(e)),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this._callback=e}_connectGamepad(e){const t=new r(e);"unknown"!==t.deviceType&&(this._inputDevices[e.index]=t,this._input.gamepad.devices.add(t)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){null==this._frameTask&&(this._frameTask=t.addFrameTask({update:()=>this._readGamepadState()}))}_stopPolling(){null!=this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){const e=document.hasFocus(),t=this._element.contains(document.activeElement),r="document"===this._input.gamepad.enabledFocusMode&&!e||"view"===this._input.gamepad.enabledFocusMode&&!t;n(e=>{const t=this._inputDevices[e.index];if(!t)return;const s=this._latestUpdate[e.index],n=i.extractState(t),o=r||i.stateIdle(n);if(s){if(s.timestamp===e.timestamp)return;if(!s.active&&o)return;if(i.stateEqual(s.state,n))return}this._emitGamepadEvent(e,n,!o)})}_emitGamepadEvent(e,t,r){const i=this._latestUpdate[e.index],s=i&&i.active;if(!s&&!r)return;const n=!s&&r?"start":s&&r?"update":"end";this._latestUpdate[e.index]={timestamp:e.timestamp,state:t,active:r},this._callback&&this._callback({device:this._inputDevices[e.index],state:t,action:n})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/gamepad/GamepadState":function(){define(["exports"],function(e){"use strict";e.extractState=function(e){const t=e.native;return t?{buttons:t.buttons.map(e=>e.pressed?e.value||1:0),axes:t.axes.map(t=>function(e,t){const r=Math.abs(e);return r<t?0:Math.sign(e)*(r-t)/(1-t)}(t,e.axisThreshold))}:{buttons:[],axes:[]}},e.stateEqual=function(e,t){if(e.axes.length!==t.axes.length)return!1;if(e.buttons.length!==t.buttons.length)return!1;for(let r=0;r<e.axes.length;r++)if(e.axes[r]!==t.axes[r])return!1;for(let r=0;r<e.buttons.length;r++)if(e.buttons[r]!==t.buttons[r])return!1;return!0},e.stateIdle=function(e){for(let t=0;t<e.axes.length;t++)if(0!==e.axes[t])return!1;for(let t=0;t<e.buttons.length;t++)if(0!==e.buttons[t])return!1;return!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/handlers/PreventContextMenu":function(){define(["exports","../InputHandler"],function(e,t){"use strict";class r extends t.InputHandler{constructor(){super(!0),this.registerIncoming("context-menu",e=>e.data.native.preventDefault())}}e.PreventContextMenu=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/recognizers/Drag":function(){define(["exports","../../../core/screenUtils","../../../core/time","../InputHandler","./support"],function(e,t,r,i,s){"use strict";class n extends i.InputHandler{constructor(e){super(!1),this._navigationTouch=e,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(e,t,r,i){return{action:e,pointerType:this._pointerType,button:this._mouseButton,buttons:t.buttons,timestamp:i,pointers:l(this._activePointerMap),pointer:t,angle:r.angle,radius:r.radius,center:r.center}}_addPointer(e){const t=e.native.pointerId,r=a(this._activePointerMap).angle,i={event:e,initialAngle:0,lastAngle:0};this._activePointerMap.set(t,i);const s=c(i,o(this._activePointerMap));i.initialAngle=s,i.lastAngle=s,this._updatePointerAngles(r)}_updatePointer(e){if(e&&null==e.x&&null==e.y)return;const t=e.native.pointerId,r=this._activePointerMap.get(t);r?r.event=e:this._addPointer(e)}_removePointer(e){const t=a(this._activePointerMap).angle;this._activePointerMap.delete(e),this._updatePointerAngles(t)}_updatePointerAngles(e){const t=a(this._activePointerMap);this._activePointerMap.forEach(r=>{r.initialAngle=c(r,t)-e,r.lastAngle=c(r,t)-e})}_emitEvent(e,t,r){const i=a(this._activePointerMap);this._drag.emit(this._createPayload(e,t,i,r),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(e){const t=e.data.native.pointerId,i=r.Milliseconds(e.timestamp);this._activePointerMap.get(t)&&(1===this._activePointerMap.size?(this._updatePointer(e.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",e.data,i),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(t)):(this._removePointer(t),this._emitEvent("removed",e.data,r.Milliseconds(e.timestamp))))}_handlePointerDrag(e){const t=e.data,i=t.currentEvent,s=r.Milliseconds(e.timestamp);switch(t.action){case"start":case"update":this._isDragging?this._activePointerMap.has(i.native.pointerId)?(this._updatePointer(i),!this._isCurrentDragSuppressed&&this._emitEvent("update",i,s)):(this._addPointer(i),this._emitEvent("added",i,s),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(i),this._pointerType=e.data.startEvent.pointerType,this._mouseButton=e.data.startEvent.button,this._startStateModifiers=e.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",i,s))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&"touch"===this._pointerType&&1===this._activePointerMap.size}}function o(e){const r=[];return e.forEach(e=>{r.push(t.createScreenPoint(e.event.x,e.event.y))}),s.fitCircleLSQ(r)}function a(e){const t=o(e);let r=0;return e.forEach(e=>{let i=c(e,t),s=i-e.lastAngle;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;i=e.lastAngle+s,e.lastAngle=i;const n=i-e.initialAngle;r+=n}),r/=e.size||1,{angle:r,radius:t.radius,center:t.center}}function l(e){const t=new Map;return e.forEach((e,r)=>t.set(r,e.event)),t}function c(e,t){const r=e.event,i=r.x-t.center.x,s=r.y-t.center.y;return Math.atan2(s,i)}e.Drag=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/recognizers/support":function(){define(["exports","../../../core/has","../../../core/screenUtils"],function(e,t,r){"use strict";e.euclideanDistance=function(e,t){const r=t.x-e.x,i=t.y-e.y;return Math.sqrt(r*r+i*i)},e.fitCircleLSQ=function(e,t){if(t?(t.radius=0,t.center.x=0,t.center.y=0):t={radius:0,center:r.createScreenPoint()},0===e.length)return t;if(1===e.length)return t.center.x=e[0].x,t.center.y=e[0].y,t;if(2===e.length){const[r,i]=e,[s,n]=[i.x-r.x,i.y-r.y];return t.radius=Math.sqrt(s*s+n*n)/2,t.center.x=(r.x+i.x)/2,t.center.y=(r.y+i.y)/2,t}let i=0,s=0;for(let t=0;t<e.length;t++)i+=e[t].x,s+=e[t].y;i/=e.length,s/=e.length;const n=e.map(e=>e.x-i),o=e.map(e=>e.y-s);let a=0,l=0,c=0,u=0,d=0,h=0,p=0;for(let e=0;e<n.length;e++){const t=n[e],r=o[e],i=t*t,s=r*r;a+=i,l+=s,c+=t*r,u+=i*t,d+=s*r,h+=t*s,p+=r*i}const f=.5*(u+h),m=.5*(d+p),g=a*l-c*c,y=(f*l-m*c)/g,_=(a*m-c*f)/g,b=r.createScreenPoint(y+i,_+s);return{radius:Math.sqrt(y*y+_*_+(a+l)/e.length),center:b}},e.getDoubleClickParameters=(e={})=>({maximumClickDelay:300,maximumDoubleClickDistance:10,maximumDoubleTouchDistance:35,maximumDoubleClickDelay:250,maximumDoubleTouchDelay:350,...e}),e.getHoldAndDragParameters=(e={})=>({maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500,...e}),e.getPointerId=function(e){const{native:t}=e,{pointerId:r,button:i,pointerType:s}=t;return"mouse"===s?`${r}:${i}`:`${s}`},e.manhattanDistance=function(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/recognizers/ImmediateDoubleClick":function(){define(["exports","../../../core/clock","../InputHandler","./support"],function(e,t,r,i){"use strict";class s extends r.InputHandler{constructor(e={},r=t.clock){super(!1),this._clock=r,this._pointerState=new Map,this._parameters=i.getDoubleClickParameters(e),this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach(e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()}),super.onUninstall()}_handlePointerDown(e){const t=e.data,r=i.getPointerId(t);if(!this._pointerState.has(r)){const e={downButton:t.native.button,x:t.x,y:t.y,immediateDoubleClick:null};this._pointerState.set(r,e),this.startCapturingPointer(t.native)}}_handlePointerUp(e){const t=e.data,r=i.getPointerId(t),s=this._pointerState.get(r);if(s&&s.downButton===t.native.button){const r=s.immediateDoubleClick,n="touch"===e.data.native.pointerType?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;r?(r.timeoutHandle.remove(),i.manhattanDistance(r,e.data)>n?this._startImmediateDoubleClick(e,s):(this._immediateDoubleClick.emit(e.data,void 0,r.modifiers),this._removeState(t))):i.manhattanDistance(s,e.data)>n?this._removeState(t):this._startImmediateDoubleClick(e,s)}}_startImmediateDoubleClick(e,t){const r="touch"===e.data.native.pointerType?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay;t.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout(()=>this._removeState(e.data),r)}}_removeState(e){const t=i.getPointerId(e);this._pointerState.delete(t),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}}e.ImmediateDoubleClick=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/recognizers/PointerClickHoldAndDrag":function(){define(["exports","../../../core/clock","../../../core/maybe","../InputHandler","./support"],function(e,t,r,i,s){"use strict";class n extends i.InputHandler{constructor(e={},r=t.clock){super(!1),this._clock=r,this._pointerState=new Map,this._parameters=s.getHoldAndDragParameters(e),this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",e=>this._handlePointerDown(e)),this.registerIncoming("pointer-up",e=>this._handlePointerLoss(e,"pointer-up")),this.registerIncoming("pointer-capture-lost",e=>this._handlePointerLoss(e,"pointer-capture-lost")),this.registerIncoming("pointer-cancel",e=>this._handlePointerLoss(e,"pointer-cancel")),this._moveHandle=this.registerIncoming("pointer-move",e=>this._handlePointerMove(e)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach(e=>{e.holdTimeout=r.removeMaybe(e.holdTimeout)}),super.onUninstall()}_handlePointerDown(e){const t=e.data,r=t.native.pointerId;let i=null;0===this._pointerState.size&&(i=this._clock.setTimeout(()=>{const t=this._pointerState.get(r);if(t){if(!t.isDragging){const r=t.previousEvent;this._pointerHold.emit(r,void 0,e.modifiers),t.holdEmitted=!0}t.holdTimeout=null}},this._parameters.holdDelay));const s={startEvent:t,previousEvent:t,startTimestamp:e.timestamp,isDragging:!1,downButton:t.native.button,holdTimeout:i,modifiers:new Set};this._pointerState.set(r,s),this.startCapturingPointer(t.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(e)}_handlePointerMove(e){const t=e.data,r=t.native.pointerId,i=this._pointerState.get(r);i&&(i.isDragging?this._pointerDrag.emit(o("update",i,t),void 0,i.modifiers):s.euclideanDistance(t,i.startEvent)>this._getDragThreshold(t.native.pointerType)&&this._startDragging(e),i.previousEvent=t)}_getDragThreshold(e){switch(e){case"touch":return this._parameters.movementUntilTouchDrag;case"pen":return this._parameters.movementUntilPenDrag;default:return this._parameters.movementUntilMouseDrag}}_startDragging(e){const t=e.data,r=t.native.pointerId;this._pointerState.forEach(i=>{null!=i.holdTimeout&&(i.holdTimeout.remove(),i.holdTimeout=null),i.isDragging||(i.modifiers=e.modifiers,i.isDragging=!0,r===i.startEvent.native.pointerId?this._pointerDrag.emit(o("start",i,t)):this._pointerDrag.emit(o("start",i,i.previousEvent),e.timestamp))})}_handlePointerLoss(e,t){const r=e.data,i=r.native.pointerId,s=this._pointerState.get(i);s&&(null!=s.holdTimeout&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging?this._pointerDrag.emit(o("end",s,"pointer-up"===t?r:s.previousEvent),void 0,s.modifiers):"pointer-up"===t&&s.downButton===r.native.button&&e.timestamp-s.startTimestamp<=this._parameters.maximumClickDelay&&!s.holdEmitted&&this._immediateClick.emit(r),this._pointerState.delete(i),this.stopCapturingPointer(r.native),0===this._pointerState.size&&this._moveHandle.pause())}}function o(e,t,r){return{action:e,startEvent:t.startEvent,previousEvent:t.previousEvent,currentEvent:r}}e.PointerClickHoldAndDrag=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/recognizers/SingleAndDoubleClick":function(){define(["exports","../../../core/clock","../../../core/maybe","../InputHandler","./support"],function(e,t,r,i,s){"use strict";class n extends i.InputHandler{constructor(e={},r=t.clock){super(!1),this._clock=r,this._pointerState=new Map,this._parameters=s.getDoubleClickParameters(e),this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",e=>this._handleImmediateClick(e)),this.registerIncoming("pointer-down",e=>this._handlePointerDown(e))}onUninstall(){this._pointerState.forEach(e=>e.doubleClickTimer=r.removeMaybe(e.doubleClickTimer))}get hasPendingInputs(){for(const e of this._pointerState.values())if(null!=e.doubleClickTimer)return!0;return!1}_clearDoubleClickTimer(e,t){const i=this._pointerState.get(e);i&&(i.doubleClickTimer=r.removeMaybe(i.doubleClickTimer),t&&this._click.emit(i.event.data,void 0,i.event.modifiers),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const t=this._pointerState.get(e);1===t.pointerDownCount&&this._click.emit(t.event.data,void 0,t.event.modifiers),t.doubleClickTimer=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}_handleImmediateClick(e){const t=e.data,{pointerType:r}=t.native,i=function(e){const{pointerId:t,pointerType:r,button:i}=e.native;return"mouse"===r?`${t}:${i}`:`${r}`}(t);if(!this._pointerState.has(i))return void this._startClick(e);const n=this._pointerState.get(i),{data:o,modifiers:a}=n.event,l="touch"===r?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;s.manhattanDistance(o,t)>l?(this._clearDoubleClickTimer(i,!0),this._startClick(e)):(this._clearDoubleClickTimer(i,!1),2===n.pointerDownCount&&this._doubleClick.emit(o,void 0,a))}_handlePointerDown(e){const t=s.getPointerId(e.data),r=this._pointerState.get(t);r&&(r.pointerDownCount+=1)}_startClick(e){const{data:t}=e,{native:{pointerType:r}}=t,i=s.getPointerId(t),n="touch"===r?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay,o=this._clock.setTimeout(()=>this._doubleClickTimeoutExceeded(i),n);this._pointerState.set(i,{event:e,doubleClickTimer:o,pointerDownCount:1}),this.refreshHasPendingInputs()}}e.SingleAndDoubleClick=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/recognizers/VerticalTwoFingerDrag":function(){define(["exports","../DragEventSeparator","../InputHandler"],function(e,t,r){"use strict";class i extends r.InputHandler{constructor(e=20,r=40){super(!1),this._threshold=e,this._maxDelta=r,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new t.DragEventSeparator({start:(e,t)=>this._observeStart(e,t),update:(e,t,r)=>this._observeUpdate(e,t,r),end:(e,t)=>this._observeEnd(t)}),this.registerIncoming("drag",e=>this._dragEventSeparator.handle(e))}get failed(){return"failed"===this._state}_observeStart(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}_observeUpdate(e,t,r){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,r.data)?this._checkVerticalThresholdReached(t.data,r.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let r=-1/0,i=1/0,s=-1/0,n=1/0;for(const{x:e,y:o}of t.pointers.values())r=Math.max(r,e),i=Math.min(i,e),s=Math.max(s,o),n=Math.min(n,o);let o=-1/0,a=1/0,l=-1/0,c=1/0;for(const{x:t,y:r}of e.pointers.values())o=Math.max(o,t),a=Math.min(a,t),l=Math.max(l,r),c=Math.min(c,r);const u=r-i,d=s-n,h=o-a,p=l-c;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(h-u)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let r=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((e,i)=>{const s=t.pointers.get(i);r=Math.min(r,Math.abs(e.y-s.y))}),r>=this._threshold}}e.VerticalTwoFingerDrag=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/input/DragEventSeparator":function(){define(["exports"],function(e){"use strict";e.DragEventSeparator=class{constructor(e){this._callbacks=e,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(e){const t=e.data,r=t.pointers.size;switch(t.action){case"start":this._currentCount=r,this._emitStart(e);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=r,this._emitStart(e);break;case"update":this._emitUpdate(e);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=r,this._emitStart(e);break;case"end":this._emitEnd(e),this._currentCount=0}this._previousEvent=e}_emitStart(e){this._startEvent=e,this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.start(this._currentCount,e,this._startEvent)}_emitUpdate(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.update(this._currentCount,e,this._startEvent)}_emitEnd(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.end(this._currentCount,e,this._startEvent),this._startEvent=null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/GraphicsDeconflictor":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/boundedPlane","./Deconflictor","./LabelDeconflictor","../../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";function p(e){const t=e.layer;return!(!t?.featureReduction||"selection"!==t.featureReduction.type)}e.GraphicsDeconflictor=class extends u.Deconflictor{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=1,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._updatingHandles.add(()=>this.view?.state?.camera,()=>{this._updateViewState(),this.setDirty()}),this._updatingHandles.add(()=>this.view?.slice?.plane,()=>{this._updateSlicePlane(),this._slicePlaneChanged()},i.initial),this.addHandles(i.watch(()=>this.view.basemapTerrain?.updating||this.view.graphicsView?.updating||this.view.allLayerViews.some(e=>e.updating),(e,t)=>{!e&&t&&this.setDirty()},i.sync)),this._frameTask=this.view.resourceController.scheduler.registerTask(h.TaskPriority.GRAPHICS_DECONFLICTOR,this),this._labels=new d.LabelDeconflictor({view:this.view,parent:this})}destroy(){this._labels=r.destroyMaybe(this._labels),this._frameTask=r.removeMaybe(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){const t=super.runTask(e);return this.readyToRun||this._labels.setDirty(),t}_updateViewState(){this.view?.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?.slice?.plane;null!=e&&c.transform(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=null!=e}_slicePlaneChanged(){for(const e of this._contexts.keys())if(e.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:r=>this._addGraphic(e,t,r),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labelsEnabledChanged(e,t),featureReductionChange:()=>this._enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(e=>this._removeGraphic(t,e.graphics3DGraphic)),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(e=>this._removeGraphic(t,e.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,r){const i=r.graphic.uid,s=new u.DeconflictorGraphic(r,e.symbolCreationContext.slicePlaneEnabled);t.set(i,s),this.addToCheckOcclusion(s),p(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&(this._labels.addToCheckOcclusion(s),this._labels.addToActiveGraphics(s));const n=!this._graphicSupportsDeconfliction(r)||!p(e);r.setVisibilityFlag(1,8,n)}_removeGraphic(e,t){const r=t.graphic.uid,i=e.get(r);i&&(this.removeFromActiveGraphics(i),this.removeFromCheckOcclusion(i),this._labels.removeFromActiveGraphics(i),this._labels.removeFromCheckOcclusion(i),e.delete(r),this.setDirty())}_enabledChanged(e,t){p(e)?t.forEach(e=>this.addToActiveGraphics(e)):(t.forEach(e=>this.removeFromActiveGraphics(e)),function(e){const t=e.graphics3DGraphics;t&&t.forEach(e=>e.setVisibilityFlag(1,8,!0))}(e))}_labelsEnabledChanged(e,t){e.labelsEnabled?(t.forEach(e=>this._labels.addToCheckOcclusion(e)),t.forEach(e=>this._labels.addToActiveGraphics(e))):(t.forEach(e=>this._labels.removeFromCheckOcclusion(e)),t.forEach(e=>this._labels.removeFromActiveGraphics(e)))}_slicePlaneEnabledChanged(e,t){const r=e.symbolCreationContext.slicePlaneEnabled;t.forEach(e=>e.slicePlaneEnabled=r),this.setDirty()}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!t?.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const r=new Map;return this._contexts.set(e,r),this.setDirty(),r}},e.GraphicsDeconflictor=t.__decorate([l.subclass("esri.views.3d.layers.graphics.GraphicsDeconflictor")],e.GraphicsDeconflictor),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Deconflictor":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/mathUtils","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../core/support/UpdatingHandles","../../../../geometry/ellipsoidUtils","../../../../geometry/support/aaBoundingRect","../../../../chunks/boundedPlane","../../../../geometry/support/ray","../../../../chunks/sphere","./DeconflictAABR","./deconflictorDebug","../../webgl/RenderCamera","../../webgl-engine/lib/GPUPointOcclusionQuery","../../webgl-engine/lib/screenSizePerspectiveUtils","../../webgl-engine/materials/HUDMaterial","../../webgl-engine/materials/ScaleInfo","../../../support/Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I){"use strict";const F=f.create(),A=f.create(),D=g.create(),E=g.create(),L=f.create(),V=d.create(),U=x.create(),B=w.create(),N=f.create(),k=b.create();class z{constructor(e){this.id=e,this.aabr=b.create(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.culled=!1,this.visible=!1,this.priority=0}}function j(e,t){const r=0!==e.distanceToOccluder&&e.distance>e.distanceToOccluder,i=0!==t.distanceToOccluder&&t.distance>t.distanceToOccluder;return r!==i?+r-+i:e.priority!==t.priority?t.priority-e.priority:e.distance!==t.distance?e.distance-t.distance:e.visible!==t.visible?+t.visible-+e.visible:e.id-t.id}class G{constructor(){this.camera=new C,this.slicePlane=v.create(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),v.copy(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}e.Deconflictor=class extends r{get dirty(){return this._dirty}get state(){return this._state}constructor(e){super(e),this._dirty=!1,this._viewState=new G,this._state=0,this._checkOcclusion=new Map,this._active=new Map,this._checkOcclusionIterator=null,this._activeIterator=null,this._occlusionQueryUids=new Array,this._updatingHandles=new y.UpdatingHandles,this._deconflictor=new S.DeconflictAABR((e,t)=>{e.visible=t,this._setGraphicVisibility(this._active.get(e.id),t)},(e,t)=>e.id!==t.id,j),this._baseOccludedVisibility=10,this._altitudeFactor=2,this._minAltitudeDifference=100}initialize(){this._updatingHandles.add(()=>(this.view?.map?.ground?.opacity??0)>0,()=>this.setDirty()),this._updatingHandles.add(()=>this.view.ready,()=>this._occlusionQuery=null)}destroy(){this._occlusionQuery=null,this._updatingHandles.destroy(),this._deconflictor.destroy(),this._checkOcclusion.clear(),this._active.clear()}setDirty(){!this._dirty&&(this._active.size>0||this._checkOcclusion.size>0)&&(this._dirty=!0,this.notifyChange("updating"))}setPriority(e,t){const r=this._active.get(e.graphic.uid)?.getInfo(this.visibilityGroup);r&&(r.priority=t)}get updating(){return 0!==this._state||this._dirty||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;const e=this._state/5;return this._dirty?.5*e:e}get readyToRun(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case 0:this._startUpdate(),e.madeProgress();case 1:if(this._state=1,!this._processCheckOcclusion(e))return;case 2:if(this._state=2,this._occlusionQuery&&!this._occlusionQuery.done)return I.Yield;this._readOcclusionQueryResult(),e.madeProgress();case 3:if(this._state=3,!this._collectActiveGraphics(e))return;case 4:if(this._state=4,this._deconflictor.run(e),!this._deconflictor.done)return;default:this._state=0,this.notifyChange("updating")}}setGraphicsActive(e,t){t?e.forEach(e=>this.addToActiveGraphics(e)):e.forEach(e=>this.removeFromActiveGraphics(e))}layerSupportsDeconfliction(e){if(null==e||"object3d"!==e.type)return!1;const t=e.stageObject;if(1!==(t?.geometries.length??0))return!1;const r=t?.geometries[0],i=r?.material;return i instanceof R.HUDMaterial}_startUpdate(){T.prepare(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._viewState.camera;this._deconflictor.reset(e,t),this._resetIterators(),this._occlusionQueryUids.length=0,this._checkOcclusion.size||(this._occlusionQuery=s.destroyMaybe(this._occlusionQuery))}addToActiveGraphics(e){e.ensureInfo(this.visibilityGroup),this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){!function(e,t){const r=e.graphics3DGraphic;r.destroyed||r.setVisibilityFlag(t,8,!0)}(e,this.visibilityGroup),e.removeInfo(this.visibilityGroup),this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}addToCheckOcclusion(e){this._checkOcclusion.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromCheckOcclusion(e){this._checkOcclusion.delete(e.graphics3DGraphic.graphic.uid)}_processCheckOcclusion(e){if(0===this._checkOcclusion.size)return!0;const t=this._ensureCheckOcclusionIterator(),r=this._viewState.camera,i=u.transpose(V,r.viewInverseTransposeMatrix),n=this.view.map.ground.opacity>0,o="global"===this.view.viewingMode&&n&&r.relativeElevation>0?U:null;let a=0;null!=o&&(p.transformMat4(x.getCenter(o),f.ZEROS,r.viewMatrix),o[3]=_.getReferenceEllipsoid(this.view.spatialReference).radius,a=x.distanceToSilhouette(o,f.ZEROS));const l=b.create();for(;;){if(e.done)return!1;e.madeProgress();const s=t.next();if(!0===s.done)break;const n=s.value,c=n.graphics3DGraphic;if(c.destroyed)continue;if(!c.isVisible(1,8))continue;const u=W(c,this.visibilityGroup);let d=null,h=!0;for(const e of u){if(!this.layerSupportsDeconfliction(e))continue;d=$,this._projectHudLayer(e,r,d),b.empty(l);const t=e.stageObject.geometries[0].material;if(this._expandBoundingRect(l,r,e,t,d),d.isOutsideScreen){h=!1;break}if(this._isCulledBySlice(n,d.positionView)){h=!1;break}if(null!=o&&H(d,o,a)){h=!1;break}p.transformMat4(A,d.positionView,i),d.altitude=this.view.renderCoordsHelper.getAltitude(A);const s=n.ensureInfo(this.visibilityGroup);if(s.altitude=d.altitude,s.distance=d.distance,s.distanceToOccluder=d.distanceToOccluder,s.culled=!1,b.copy(s.aabr,l),t.parameters.occlusionTest)break;this._ensureOcclusionQuery().addPosition(A)===this._occlusionQueryUids.length&&this._occlusionQueryUids.push(c.graphic.uid);break}if(this._active.has(c.graphic.uid)&&(!h||!d)){const e=n.ensureInfo(this.visibilityGroup);e.visible=!d,e.culled=!0}}return this._checkOcclusionIterator=null,this._occlusionQueryUids.length||(this._occlusionQuery=s.destroyMaybe(this._occlusionQuery)),this._occlusionQuery?.start(),!0}_readOcclusionQueryResult(){if(!this._occlusionQuery||!this._occlusionQueryUids.length)return;const e=this._viewState.camera,t=this.view.renderCoordsHelper.getAltitude(e.eye);for(let e=0;e<this._occlusionQueryUids.length;e++){const r=this._occlusionQueryUids[e],i=this._checkOcclusion.get(r);if(!i)continue;const s=this._occlusionQuery.getOcclusion(e)??-1,n=i.getInfo(this.visibilityGroup);n&&(n.distanceToOccluder=s>0?n.distance-s:0);const o=s<=0||this._occludedVisibility(n?.distanceToOccluder??0,n?.distance??s,n?.altitude??0,t);this._active.has(r)?n&&(n.culled=!o,n.visible=o):this._setGraphicVisibility(i,o)}this._occlusionQueryUids.length=0}_collectActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),r=16===this.visibilityGroup;for(;!e.done;){e.madeProgress();const i=t.next();if(!0===i.done)return this._activeIterator=null,!0;const s=i.value,n=s.getInfo(this.visibilityGroup);n&&(r&&!s.graphics3DGraphic.isVisible()||n.culled?(T.drawPoly(n.aabr,!1,!0),this._setGraphicVisibility(s,n.visible)):this._deconflictor.add(n))}return!1}_occludedVisibility(e,t,r,i){const s=Math.max(this._minAltitudeDifference,Math.abs(r-i))-this._minAltitudeDifference;return 0===e||t-e<=this._baseOccludedVisibility+this._altitudeFactor*s}_resetIterators(){this._checkOcclusionIterator=null,this._activeIterator=null}_ensureCheckOcclusionIterator(){return this._checkOcclusionIterator??=this._checkOcclusion.values(),this._checkOcclusionIterator}_ensureActiveGraphicsIterator(){return this._activeIterator??=this._active.values(),this._activeIterator}_ensureOcclusionQuery(){return this._occlusionQuery??=new P.GPUPointOcclusionQuery({view:this.view}),this._occlusionQueryUids.length||this._occlusionQuery.init(this._checkOcclusion.size,this._viewState.camera.eye),this._occlusionQuery}_projectHudLayer(e,t,r){const i=e.stageObject,s=i.geometries[0],n=s.material,o=x.getCenter(i.boundingVolumeWorldSpace.bounds);p.transformMat4(F,o,t.viewMatrix);const a=s.attributes,l=a.get("normal").data,c=a.get("centerOffsetAndDistance").data;n.applyShaderOffsetsView(F,l,i.transformation,c,t,r.scaleInfo,F),m.set(D,F[0],F[1],F[2],1),m.transformMat4(E,D,t.projectionMatrix),p.scale(r.positionNDC,E,1/E[3]),n.applyShaderOffsetsNDC(r.positionNDC,c,t,r.positionNDC,L),r.distanceWithoutPolygonOffset=t.depthNDCToWorld(L[2]),r.distance=L[2]===r.positionNDC[2]?r.distanceWithoutPolygonOffset:t.depthNDCToWorld(r.positionNDC[2]),m.set(E,r.positionNDC[0],r.positionNDC[1],r.positionNDC[2],1),m.transformMat4(D,E,t.inverseProjectionMatrix),m.scale(D,D,1/D[3]),p.set(r.positionView,F[0],F[1],F[2])}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&v.extrusionContainsPoint(this._viewState.slicePlane,t)}_expandBoundingRect(e,t,r,s,{positionNDC:n,scaleInfo:o}){const a=r.getScreenSize(q);M.applyPrecomputedScaleFactor(a,o.factor,a),a[0]*=t.pixelRatio,a[1]*=t.pixelRatio;const l=b.offset(s.calculateRelativeScreenBounds(a,o.factorAlignment.scale*t.pixelRatio,k),i.lerp(0,t.fullWidth,.5+.5*n[0]),i.lerp(0,t.fullHeight,.5+.5*n[1])),c=this.marginFactor;if(0!==c){const e=c*Math.min(b.width(l),b.height(l));l[0]-=e,l[1]-=e,l[2]+=e,l[3]+=e}b.expand(e,l,e)}_setGraphicVisibility(e,t){const r=e?.graphics3DGraphic;r&&!r.destroyed&&(r.setVisibilityFlag(this.visibilityGroup,8,t),16===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(r,t))}},t.__decorate([n.property({constructOnly:!0})],e.Deconflictor.prototype,"view",void 0),t.__decorate([n.property({type:Boolean,readOnly:!0})],e.Deconflictor.prototype,"updating",null),t.__decorate([n.property({readOnly:!0})],e.Deconflictor.prototype,"_updatingHandles",void 0),e.Deconflictor=t.__decorate([c.subclass("esri.views.3d.layers.graphics.Deconflictor")],e.Deconflictor);const q=h.create();function H(e,t,r){return p.copy(B.direction,e.positionView),p.set(B.origin,0,0,0),!!x.intersectRay(t,B,N)&&e.distanceWithoutPolygonOffset>r}function W(e,t){return 16===t?e.labelLayers:e.layers}const $=new class{constructor(){this.positionView=f.create(),this.positionNDC=f.create(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new O.ScaleInfo}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1||e[2]>=1}};e.DeconflictorGraphic=class{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this._info=null,this._labelInfo=null}ensureInfo(e){let t=this.getInfo(e);return t||(t=new z(this.graphics3DGraphic.graphic.uid),this._setInfo(e,t)),t}getInfo(e){return 16===e?this._labelInfo:this._info}removeInfo(e){this._setInfo(e,null)}_setInfo(e,t){16===e?this._labelInfo=t:this._info=t}},e.DeconflictorViewState=G,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/DeconflictAABR":function(){define(["exports","../../../../core/heapSort","../../../../core/PooledArray","../../../../geometry/support/aaBoundingRect","./deconflictorDebug"],function(e,t,r,i,s){"use strict";e.DeconflictAABR=class{constructor(e,t,r){this._setVisibility=e,this._canConflict=t,this._compare=r,this.done=!1,this._items=new Array,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null}destroy(){this._generator=null,this._accBins=null,this._items.length=0}reset(e,t){this._initBins(e,t),this._items.length=0,this.done=!1,this._generator=null}add(e){this._items.push(e)}run(e){this._generator??=this._run(e),this.done=!!this._generator.next(e).done}*_run(e){yield*this._sort(e),yield*this._deconflict(e),s.drawAccelerationStruct(()=>({bins:this._accBins,numX:this._accBinsNumX,numY:this._accBinsNumY,sizeX:this._accBinsSizeX,sizeY:this._accBinsSizeY,numTests:0,numVisible:this._items.length}))}*_sort(e){for(const r of t.iterableSort(this._items,0,this._items.length,this._compare))e.madeProgress(),e.done&&(e=yield)}_isConflicted(e){let t=!0;return this._forEachBin(e.aabr,r=>(t=!1,r.some(t=>this._canConflict(t,e)&&i.intersects(t.aabr,e.aabr))))||t}*_deconflict(e){for(const t of this._items){e.done&&(e=yield);const r=!this._isConflicted(t);this._setVisibility(t,r),s.drawPoly(t.aabr,r),r&&this._addToBins(t),e.madeProgress()}}_initBins(e,t){if(null==this._accBins){this._accBins=[];for(let e=0;e<this._accBinsNumX;e++){this._accBins.push([]);const e=this._accBins[this._accBins.length-1];for(let t=0;t<this._accBinsNumY;t++)e.push(new r)}}else for(let e=0;e<this._accBinsNumX;e++)for(let t=0;t<this._accBinsNumY;t++)this._accBins[e][t].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY}_addToBins(e){this._forEachBin(e.aabr,t=>t.push(e))}_forEachBin(e,t){if(!this._accBins)return!1;const r=Math.max(Math.floor(e[0]/this._accBinsSizeX),0),i=Math.max(Math.floor(e[1]/this._accBinsSizeY),0),s=Math.min(Math.floor(e[2]/this._accBinsSizeX),this._accBinsNumX-1),n=Math.min(Math.floor(e[3]/this._accBinsSizeY),this._accBinsNumY-1);for(let e=r;e<=s;e++)for(let r=i;r<=n;r++)if(t(this._accBins[e][r]))return!0;return!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/deconflictorDebug":function(){define(["exports","../../support/debugFlags"],function(e,t){"use strict";let r,i,s=!1,n=!1,o=!1,a=!1,l=null;function c(){l&&(l(),l=null)}function u(e,t,s,n,o){c();const a=r.height,l=i;l.beginPath(),l.lineWidth=1,l.strokeStyle=o,l.moveTo(e,a-s),l.lineTo(t,a-s),l.stroke(),l.lineTo(t,a-n),l.stroke(),l.lineTo(e,a-n),l.stroke(),l.lineTo(e,a-s),l.stroke(),l.closePath()}e.drawAccelerationStruct=function(e){const t=n?e():null;if(!t?.bins)return;c();const r=i;let s=0;for(let e=0;e<t.numX;e++)for(let i=0;i<t.numY;i++){const n=t.bins[e][t.numY-1-i];s+=n.length;const o=e*t.sizeX,a=(e+1)*t.sizeX,l=i*t.sizeY,c=(i+1)*t.sizeY;r.fillText(n.length.toFixed(),o+5,l+15),u(o,a,l,c,"blue")}r.fillText("total totalShownLabels: "+s,70,40),r.fillText("total visible labels: "+t.numVisible,70,50),r.fillText("total numTests: "+t.numTests,70,30)},e.drawPoly=function(e,t,r=!1){s&&(t&&o||!t&&a)&&u(e[0],e[2],e[1],e[3],r?t?"pink":"grey":t?"green":"red")},e.prepare=function(e){o=t.debugFlags.DECONFLICTOR_SHOW_VISIBLE,a=t.debugFlags.DECONFLICTOR_SHOW_INVISIBLE,s=o||a,n=t.debugFlags.DECONFLICTOR_SHOW_GRID,l=null,s||n?(i&&r&&i.clearRect(0,0,r.width,r.height),l=()=>function(e){null==r&&(r=document.createElement("canvas"),r.setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(r),r.style.position="absolute",r.style.width="100%",r.style.height="100%",r.style.display="block",r.style.pointerEvents="none",i=r.getContext("2d"),i.font="12px Arial");const{width:t,height:s}=e.state.camera;r.width=t,r.height=s}(e)):r&&(r.parentElement.removeChild(r),r=null)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/debugFlags":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";let l=class extends r{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1}};t.__decorate([i.property()],l.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),t.__decorate([i.property()],l.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),t.__decorate([i.property()],l.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),t.__decorate([i.property()],l.prototype,"DECONFLICTOR_SHOW_GRID",void 0),t.__decorate([i.property()],l.prototype,"LABELS_SHOW_BORDER",void 0),t.__decorate([i.property()],l.prototype,"TEXT_SHOW_BASELINE",void 0),t.__decorate([i.property()],l.prototype,"TEXT_SHOW_BORDER",void 0),t.__decorate([i.property()],l.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),t.__decorate([i.property()],l.prototype,"OVERLAY_SHOW_CENTER",void 0),t.__decorate([i.property()],l.prototype,"SHOW_POI",void 0),t.__decorate([i.property()],l.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),t.__decorate([i.property()],l.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),t.__decorate([i.property()],l.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),t.__decorate([i.property()],l.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),t.__decorate([i.property()],l.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),t.__decorate([i.property()],l.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),t.__decorate([i.property()],l.prototype,"I3S_TREE_SHOW_TILES",void 0),t.__decorate([i.property()],l.prototype,"I3S_SHOW_MODIFICATIONS",void 0),t.__decorate([i.property()],l.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),t.__decorate([i.property()],l.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),t.__decorate([i.property()],l.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),t.__decorate([i.property()],l.prototype,"LINE_WIREFRAMES",void 0),l=t.__decorate([a.subclass("esri.views.3d.support.debugFlags")],l);const c=new l;e.debugFlags=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/GPUPointOcclusionQuery":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../webgl","../../webgl/RenderNode","./DefaultVertexBufferLayouts","../../../support/Scheduler","../../../support/Yield","../../../webgl/enums","../../../webgl/renderState","../../../webgl/Sync","../../../webgl/Texture","../../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w){"use strict";e.GPUPointOcclusionQuery=class extends p{constructor(e){super(e),this.category=h.RenderCategory.COMPOSITE,this.readyToRun=!1,this.done=!0,this._origin=d.create(),this._textureWidth=256,this._uploadBuffer=new Float32Array(3*this._textureWidth),this._counter=0,this._width=0,this._height=0,this._pipeline=_.makePipelineState({colorWrite:_.defaultColorWrite}),this._format=0}initialize(){this.view.resourceController.scheduler.registerTask(m.TaskPriority.GRAPHICS_CORE,this),this.produces="disabled",this.consumes.required=[this.category],this.formatOverride&&(this._format=this.formatOverride)}destroy(){this._program=r.disposeMaybe(this._program);const e=this.gl;this._sync=r.destroyMaybe(this._sync),this._pixelBuffer&&(e.deleteBuffer(this._pixelBuffer),this._pixelBuffer=null),this._texture=r.disposeMaybe(this._texture)}precompile(){this._ensureProgram(this.renderingContext)}render(e){const t=e.find(({name:e})=>e===this.category);if(this._sync)return t;this.produces="disabled";const r=this.renderingContext,i=this.gl,s=t.getTexture(i.DEPTH_STENCIL_ATTACHMENT);if(!s)return t;const n=this.view.stage.renderer.fboCache.acquire(this._width,this._height,"hud visibility",9);r.bindFramebuffer(n.fbo),r.setPipelineState(this._pipeline);const o=this._ensureProgram(r);return r.useProgram(o),r.bindTexture(s,0),o.setUniform1i("depthTex",0),r.bindTexture(this._texture,1),o.setUniform1i("positionTex",1),l.multiply(C,this.camera.viewMatrix,l.fromTranslation(C,this._origin)),o.setUniformMatrix4fv("view",C),o.setUniformMatrix4fv("proj",this.camera.projectionMatrix),o.setUniform1i("count",this._counter),r.screen.draw(),this._pixelBuffer||(this._pixelBuffer=i.createBuffer()),0===this._format&&(this._format=6403===i.getParameter(i.IMPLEMENTATION_COLOR_READ_FORMAT)&&i.getParameter(i.IMPLEMENTATION_COLOR_READ_TYPE)===y.DataType.FLOAT?6403:6408),i.bindBuffer(i.PIXEL_PACK_BUFFER,this._pixelBuffer),i.bufferData(i.PIXEL_PACK_BUFFER,this._width*this._height*(6403===this._format?4:16),i.STREAM_READ),i.readPixels(0,0,this._width,this._height,this._format,y.DataType.FLOAT,0),this._sync=new b.Sync(i),n.release(),setTimeout(()=>this.readyToRun=!0,0),t}runTask(){if(!this._sync)return void(this.readyToRun=!1);try{if(!this._sync.poll())return g.Yield}catch(e){return this.readyToRun=!1,void(this._sync=r.destroyMaybe(this._sync))}this.readyToRun=!1,this._sync=r.destroyMaybe(this._sync);const e=this.gl;e.bindBuffer(e.PIXEL_PACK_BUFFER,this._pixelBuffer),this._cpuBuffer=new Float32Array(this._width*this._height*(6403===this._format?1:4)),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,this._cpuBuffer),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),this.done=!0}init(e,t){const r=this._textureWidth;if(this._width=r,this._height=Math.ceil(e/r),this._counter=0,this._texture?.dispose(),0===this._height)return;const i=new w.TextureDescriptor(this._width,this._height);i.pixelFormat=6407,i.dataType=y.PixelType.FLOAT,i.samplingMode=9728,this._texture=new v.Texture(this.renderingContext,i),this.done=!1,u.set(this._origin,Math.fround(t[0]),Math.fround(t[1]),Math.fround(t[2]))}addPosition(e){const t=this._width;if(this._counter>=t*this._height)return-1;const r=this._counter%t;return u.sub(T,e,this._origin),this._uploadBuffer[3*r+0]=T[0],this._uploadBuffer[3*r+1]=T[1],this._uploadBuffer[3*r+2]=T[2],r===t-1&&this._flush(),this._counter++}start(){if(0===this._width||0===this._height)return;const e=this._width;this._counter%e>0&&this._flush(),this.produces=this.category,this.requestRender(1)}getOcclusion(e){return this._cpuBuffer?.[6403===this._format?e:4*e]??-1}_flush(){const e=this._width,t=Math.floor(this._counter/e);this._texture?.updateData(0,0,t,e,1,this._uploadBuffer)}_ensureProgram(e){return this._program??=e.programCache.acquire(x,S,f.Pos2Locations),this._program}},t.__decorate([i.property()],e.GPUPointOcclusionQuery.prototype,"category",void 0),t.__decorate([i.property()],e.GPUPointOcclusionQuery.prototype,"formatOverride",void 0),t.__decorate([i.property()],e.GPUPointOcclusionQuery.prototype,"readyToRun",void 0),t.__decorate([i.property()],e.GPUPointOcclusionQuery.prototype,"done",void 0),e.GPUPointOcclusionQuery=t.__decorate([a.subclass("esri.views.3d.webgl-engine.lib.GPUPointOcclusionQuery")],e.GPUPointOcclusionQuery);const x="#version 300 es\nprecision highp float;\nin vec2 position;\n\nvoid main() {\n    gl_Position = vec4(position, 0.0, 1.0);\n}",S="#version 300 es\nprecision highp float;\nout highp vec4 fragColor;\n\nuniform highp mat4 proj;\nuniform highp mat4 view;\n\nuniform highp int count;\n\nuniform highp sampler2D depthTex;\nuniform highp sampler2D positionTex;\n\nfloat linearizeDepth(float depth) {\n  float depthNdc = depth * 2.0 - 1.0;\n  float c1 = proj[3][2];\n  float c2 = proj[2][2];\n  return -c1 / (depthNdc + c2 + 1e-7);\n}\n\nvoid main() {\n  int u = int(floor(gl_FragCoord.x));\n  int v = int(floor(gl_FragCoord.y));\n  if (u + v * textureSize(positionTex, 0).x >= count) {\n    fragColor = vec4(-1);\n    return;\n  }\n  vec4 posWorld = vec4(texelFetch(positionTex, ivec2(u, v), 0).rgb, 1.0);\n\n  vec4 posView = view * posWorld;\n  vec4 projected = proj * posView;\n\n  vec3 clipPos = projected.xyz / projected.w;\n\n  if (clipPos.x < -1.0 || clipPos.x > 1.0 || clipPos.y < -1.0 || clipPos.y > 1.0) {\n    fragColor = vec4(-1);\n    return;\n  }\n\n  vec3 uvDepth = 0.5 * clipPos + vec3(0.5);\n\n  float depth = texture(depthTex, uvDepth.xy).r;\n\n  if (uvDepth.z <= depth) {\n    fragColor = vec4(0);\n    return;\n  }\n\n  fragColor = vec4(linearizeDepth(depth) - linearizeDepth(uvDepth.z));\n}\n",T=d.create(),C=c.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/Sync":function(){define(["exports"],function(e){"use strict";e.Sync=class{constructor(e){this._gl=e,this._sync=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0)}poll(){const e=this._gl,t=e.clientWaitSync(this._sync,e.SYNC_FLUSH_COMMANDS_BIT,0);if(t===e.WAIT_FAILED)throw new Error("clientWaitSync failed");return t!==e.TIMEOUT_EXPIRED}destroy(){this._gl.deleteSync(this._sync),this._sync=null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/screenSizePerspectiveUtils":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/boundedPlane","../../../../chunks/sphere"],function(e,t,r,i){"use strict";function s(e,t,r){const i=r.parameters;return u.scale=Math.min(i.divisor/(t-i.offset),1),u.factor=function(e){return Math.abs(e*e*e)}(e),u}function n(e,r){return t.lerp(e*Math.max(r.scale,r.minScaleFactor),e,r.factor)}class o{get minScaleFactor(){return null!=this._fontHeight?Math.min(this._description.minPixelSize/this._fontHeight,1):0}constructor(e,t,r,i={camera:{distance:0,fovY:0},divisor:0,offset:0},s){this._viewingMode=e,this._description=t,this._ellipsoidRadius=r,this.parameters=i,this._fontHeight=s,2===this._viewingMode?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return!(this.parameters&&this.parameters.camera.fovY===e.fovY&&this.parameters.camera.distance===e.distance||(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),0))}overrideFontHeight(e){return e!==this._fontHeight?new o(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,t,r){const{scaleStart:i,scaleFallOffRange:s}=this._description,{fovY:n,distance:o}=e,a=this._calculateCurvatureDependentParameters(e,t),l=this._coverageCompensation(e,t,a),{tiltAngle:c,scaleFallOffFactor:u}=a,d=Math.sin(c)*o,h=.5*Math.PI-c-n*(.5-i*l),p=d/Math.cos(h),f=h+n*s*l,m=(p-u*(d/Math.cos(f)))/(1-u);return r.camera.fovY=e.fovY,r.camera.distance=e.distance,r.offset=m,r.divisor=p-m,r}_calculateCurvatureDependentParametersLocal(e,t,r=d){return r.tiltAngle=this._description.curvatureDependent.min.tiltAngle,r.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,r}_calculateCurvatureDependentParametersGlobal(e,r,i=d){const s=this._description.curvatureDependent,n=1+e.distance/r,o=Math.sqrt(n*n-1),[a,l]=[s.min.curvature,s.max.curvature],c=t.clamp((o-a)/(l-a),0,1),[u,h]=[s.min,s.max];return i.tiltAngle=t.lerp(u.tiltAngle,h.tiltAngle,c),i.scaleFallOffFactor=t.lerp(u.scaleFallOffFactor,h.scaleFallOffFactor,c),i}_surfaceCoverageCompensationLocal(e,t,i){return r.cameraFrustumCoverage(i.tiltAngle,e.fovY)}_surfaceCoverageCompensationGlobal(e,t,r){return i.fromRadius(h,t),i.cameraFrustumCoverage(h,r.tiltAngle,e.distance,e.fovY)}}const a={curvatureDependent:{min:{curvature:t.deg2rad(10),tiltAngle:t.deg2rad(12),scaleFallOffFactor:.5},max:{curvature:t.deg2rad(70),tiltAngle:t.deg2rad(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},l={scaleFallOffFactor:.7},c={scaleFallOffFactor:.95},u={scale:0,factor:0,minScaleFactor:0},d={tiltAngle:0,scaleFallOffFactor:0},h=i.create();e.applyPrecomputedScaleFactor=function(e,t,r=[0,0]){const i=Math.min(Math.max(t.scale,t.minScaleFactor),1);return r[0]=e[0]*i,r[1]=e[1]*i,r},e.applyScaleFactor=n,e.getLabelSettings=function(e,t){const{curvatureDependent:r,scaleStart:i,scaleFallOffRange:s}=a;return new o(e,{curvatureDependent:{min:{curvature:r.min.curvature,tiltAngle:r.min.tiltAngle,scaleFallOffFactor:l.scaleFallOffFactor},max:{curvature:r.max.curvature,tiltAngle:r.max.tiltAngle,scaleFallOffFactor:c.scaleFallOffFactor}},scaleStart:i,scaleFallOffRange:s,minPixelSize:14},t)},e.getSettings=function(e,t){return new o(e,a,t)},e.precomputeScaleFactor=function(e,t,r,i){i.scale=function(e,t,r){const i=s(e,t,r);return i.minScaleFactor=0,n(1,i)}(e,t,r),i.factor=0,i.minScaleFactor=r.minScaleFactor},e.scale=function(e,t,r,i){return n(e,s(t,r,i))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/HUDMaterial":function(){define(["exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../core/libs/gl-matrix-2/types/mat4","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/buffer/BufferView","../../layers/support/FastSymbolUpdates","../../support/debugFlags","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/hud/HUD.glsl","../effects/geometry/olidUtils","../lib/GLTextureMaterial","../lib/Material","../lib/screenSizePerspectiveUtils","../lib/Util","./ScaleInfo","./internal/bufferWriterUtils","./internal/MaterialUtil","../../../../chunks/HUDMaterial.glsl","../shaders/HUDMaterialTechnique","../shaders/HUDMaterialTechniqueConfiguration","../../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O){"use strict";class I extends v.Material{constructor(e,t){super(e,ee),this.produces=new Map([[13,e=>g.isColorEmissionHighlightOrOID(e)&&!this.parameters.drawAsLabel],[14,e=>g.isColorEmissionHighlightOrOID(e)&&this.parameters.drawAsLabel],[12,()=>this.parameters.occlusionTest],[18,e=>this.parameters.draped&&g.isColorEmissionHighlightOrOID(e)]]),this._visible=!0,this._configuration=new R.HUDMaterialTechniqueConfiguration(t)}getConfiguration(e,t){const r=this.parameters.draped;return super.getConfiguration(e,t,this._configuration),this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=r,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.hasRotation=this.parameters.hasRotation,this._configuration.hasVVSize=!!this.parameters.vvSize,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration.occlusionPass=12===t.slot,this._configuration.occludedFragmentFade=!r&&this.parameters.occludedFragmentFade,this._configuration.horizonCullingEnabled=this.parameters.horizonCullingEnabled,this._configuration.isFocused=this.parameters.isFocused,this._configuration.depthTestEnabled=this.parameters.depthEnabled||12===t.slot,g.isColorOrColorEmission(e)&&(this._configuration.debugDrawLabelBorder=!!m.debugFlags.LABELS_SHOW_BORDER),this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}intersect(e,t,i,n,o,a){const{options:{selectionMode:d,hud:h,excludeLabels:p},point:f,camera:m}=i,{parameters:g}=this;if(!d||!h||p&&g.isLabel||!e.visible||!f||!m)return;const y=e.attributes.get("featureAttribute"),_=null==y?null:u.fromArray(y.data,Q),{scaleX:b,scaleY:v}=re(_,g,m.pixelRatio);r.fromMat4(j,t),e.attributes.has("featureAttribute")&&function(e){const t=e[0],r=e[1],i=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],u=1/Math.sqrt(t*t+r*r+i*i),d=1/Math.sqrt(s*s+n*n+o*o),h=1/Math.sqrt(a*a+l*l+c*c);e[0]=t*u,e[1]=r*u,e[2]=i*u,e[3]=s*d,e[4]=n*d,e[5]=o*d,e[6]=a*h,e[7]=l*h,e[8]=c*h}(j);const S=e.attributes.get("position"),T=e.attributes.get("size"),C=e.attributes.get("normal"),M=e.attributes.get("rotation"),R=e.attributes.get("centerOffsetAndDistance");x.assert(S.size>=3);const O=P.calculateAnchorPosition(g),I="screen"===this.parameters.centerOffsetUnits;for(let e=0;e<S.data.length/S.size;e++){const r=e*S.size;l.set(L,S.data[r],S.data[r+1],S.data[r+2]),l.transformMat4(L,L,t),l.transformMat4(L,L,m.viewMatrix);const n=e*R.size;if(l.set(W,R.data[n],R.data[n+1],R.data[n+2]),!I&&(L[0]+=W[0],L[1]+=W[1],0!==W[2])){const e=W[2];l.normalize(W,L),l.subtract(L,L,l.scale(W,W,e))}const o=e*C.size;if(l.set(V,C.data[o],C.data[o+1],C.data[o+2]),A(V,j,m,Z),ie(this.parameters,L,Z,m,E),m.applyProjection(L,U),U[0]>-1){I&&(W[0]||W[1])&&(U[0]+=W[0]*m.pixelRatio,0!==W[1]&&(U[1]+=w.applyScaleFactor(W[1],E.factorAlignment)*m.pixelRatio),m.unapplyProjection(U,L)),U[0]+=this.parameters.screenOffset[0]*m.pixelRatio,U[1]+=this.parameters.screenOffset[1]*m.pixelRatio,U[0]=Math.floor(U[0]),U[1]=Math.floor(U[1]);const t=e*T.size;J[0]=T.data[t],J[1]=T.data[t+1],w.applyPrecomputedScaleFactor(J,E.factor,J);const r=Y*m.pixelRatio;let n=0;g.textureIsSignedDistanceField&&(n=Math.min(g.outlineSize,.5*J[0])*m.pixelRatio/2),J[0]*=b,J[1]*=v;const o=e*M.size,u=g.rotation+M.data[o];if(D(f,U[0],U[1],J,r,n,u,g,O)){const e=i.ray;if(l.transformMat4(N,L,s.invert(q,m.viewMatrix)),U[0]=f[0],U[1]=f[1],m.unprojectFromRenderScreen(U,L)){const t=c.create();l.copy(t,e.direction);const r=1/l.length(t);l.scale(t,t,r),a(l.distance(e.origin,L)*r,t,-1,N)}}}}}intersectDraped(e,t,r,i,s){const n=e.attributes.get("position"),o=e.attributes.get("size"),a=e.attributes.get("rotation"),l=this.parameters,c=P.calculateAnchorPosition(l),d=e.attributes.get("featureAttribute"),h=null==d?null:u.fromArray(d.data,Q),{scaleX:p,scaleY:f}=re(h,l,e.screenToWorldRatio),m=X*e.screenToWorldRatio;for(let t=0;t<n.data.length/n.size;t++){const u=t*n.size,d=n.data[u],h=n.data[u+1],g=t*o.size;J[0]=o.data[g],J[1]=o.data[g+1];let y=0;l.textureIsSignedDistanceField&&(y=Math.min(l.outlineSize,.5*J[0])*e.screenToWorldRatio/2),J[0]*=p,J[1]*=f;const _=t*a.size,b=l.rotation+a.data[_];D(r,d,h,J,m,y,b,l,c)&&i(s.distance,s.normal,-1)}}createBufferWriter(){return new te}applyShaderOffsetsView(e,t,r,i,s,n,o){const a=A(t,r,s,Z);return this._applyVerticalGroundOffsetView(e,a,s,o),ie(this.parameters,o,a,s,n),this._applyPolygonOffsetView(o,a,i[3],s,o),this._applyCenterOffsetView(o,i,o),o}applyShaderOffsetsNDC(e,t,r,i,s){return this._applyCenterOffsetNDC(e,t,r,i),null!=s&&l.copy(s,i),this._applyPolygonOffsetNDC(i,t,r,i),i}_applyPolygonOffsetView(e,r,i,s,n){const o=s.aboveGround?1:-1;let a=Math.sign(i);0===a&&(a=o);const c=o*a;if(this.parameters.shaderPolygonOffset<=0)return l.copy(n,e);const u=t.clamp(Math.abs(r.cosAngle),.01,1),d=1-Math.sqrt(1-u*u)/u/s.viewport[2];return c>0?l.scale(n,e,d):l.scale(n,e,1/d),n}_applyVerticalGroundOffsetView(e,t,r,i){const s=l.length(e),n=r.aboveGround?1:-1,o=r.computeRenderPixelSizeAtDist(s)*y.HUDVerticalPixelOffset,a=l.scale(L,t.normal,n*o);return l.add(i,e,a),i}_applyCenterOffsetView(e,t,r){const i="screen"!==this.parameters.centerOffsetUnits;return r!==e&&l.copy(r,e),i&&(r[0]+=t[0],r[1]+=t[1],t[2]&&(l.normalize(V,r),l.sub(r,r,l.scale(V,V,t[2])))),r}_applyCenterOffsetNDC(e,t,r,i){const s="screen"!==this.parameters.centerOffsetUnits;return i!==e&&l.copy(i,e),s||(i[0]+=t[0]/r.fullWidth*2,i[1]+=t[1]/r.fullHeight*2),i}_applyPolygonOffsetNDC(e,t,r,i){const s=this.parameters.shaderPolygonOffset;if(e!==i&&l.copy(i,e),s){const e=r.aboveGround?1:-1,n=e*Math.sign(t[3]);i[2]-=(n||e)*s}return i}set visible(e){this._visible=e}get visible(){const{color:e,outlineSize:t,outlineColor:r}=this.parameters,i=e[3]>=O.alphaCutoff||t>=O.alphaCutoff&&r[3]>=O.alphaCutoff;return this._visible&&i}createGLMaterial(e){return new F(e)}calculateRelativeScreenBounds(e,t,r=h.create()){return function(e,t,r,i){i[0]=e.anchorPosition[0]*-t[0]+e.screenOffset[0]*r,i[1]=e.anchorPosition[1]*-t[1]+e.screenOffset[1]*r}(this.parameters,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r}}class F extends b.GLTextureMaterial{constructor(e){super({...e,...e.material.parameters})}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.getTechnique(M.HUDMaterialTechnique,e)}}function A(e,t,i,s){return d.isMat4(t)&&(t=r.fromMat4(G,t)),l.transformMat3(s.normal,e,t),l.transformMat4(s.normal,s.normal,i.viewInverseTransposeMatrix),s.cosAngle=l.dot(B,K),s}function D(e,r,i,s,n,a,l,c,u){let d=r-n-s[0]*u[0],h=d+s[0]+2*n,p=i-n-s[1]*u[1],f=p+s[1]+2*n;const m=c.distanceFieldBoundingBox;return c.textureIsSignedDistanceField&&null!=m&&(d+=s[0]*m[0],p+=s[1]*m[1],h-=s[0]*(1-m[2]),f-=s[1]*(1-m[3]),d-=a,h+=a,p-=a,f+=a),o.set(z,r,i),o.rotate(k,e,z,t.deg2rad(l)),k[0]>d&&k[0]<h&&k[1]>p&&k[1]<f}const E=new S.ScaleInfo,L=c.create(),V=c.create(),U=u.create(),B=c.create(),N=c.create(),k=a.create(),z=a.create(),j=i.create(),G=i.create(),q=n.create(),H=u.create(),W=c.create(),$=c.create(),Q=u.create(),Z={normal:B,cosAngle:0},Y=1,X=2,J=a.fromValues(0,0),K=c.fromValues(0,0,1);class ee extends b.GLTextureMaterialBindParameters{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1,this.color=u.freeze(1,1,1,1),this.polygonOffset=!1,this.anchorPosition=a.fromValues(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=u.freeze(1,1,1,1),this.outlineSize=0,this.distanceFieldBoundingBox=u.create(),this.rotation=0,this.hasRotation=!1,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.occludedFragmentFade=!1,this.horizonCullingEnabled=!1,this.centerOffsetUnits="world",this.drawAsLabel=!1,this.depthEnabled=!0,this.isFocused=!0,this.focusStyle="bright",this.draped=!1,this.isLabel=!1}get hasVVSize(){return!!this.vvSize}get hasVVColor(){return!!this.vvColor}get hasVVOpacity(){return!!this.vvOpacity}}class te{constructor(){this.layout=_.olidEnabled()?M.olidLayout:M.layout}elementCount(e){return 6*e.get("position").indices.length}write(e,t,r,i,s,n){const{position:o,normal:a,uvi:l,color:c,size:u,rotation:d,centerOffsetAndDistance:h,featureAttribute:f}=s;T.writePosition(r.get("position"),e,o,n,6),T.writeNormal(r.get("normal"),t,a,n,6);const m=r.get("uvi")?.data;let g=0,y=0,_=-1-P.fullUV,b=-1-P.fullUV;m&&m.length>=4&&(g=m[0],y=m[1],_=-1-m[2],b=-1-m[3]);let v=r.get("position").indices.length,w=n;for(let e=0;e<v;++e)l.set(w,0,g),l.set(w,1,y),w++,l.set(w,0,_),l.set(w,1,y),w++,l.set(w,0,_),l.set(w,1,b),w++,l.set(w,0,_),l.set(w,1,b),w++,l.set(w,0,g),l.set(w,1,b),w++,l.set(w,0,g),l.set(w,1,y),w++;T.writeColor(r.get("color"),4,c,n,6);const{data:x,indices:S}=r.get("size");v=S.length,w=n;for(let e=0;e<v;++e){const t=x[2*S[e]],r=x[2*S[e]+1];for(let e=0;e<6;++e)u.set(w,0,t),u.set(w,1,r),w++}if(T.writeBufferFloat(r.get("rotation"),d,n,6),r.get("centerOffsetAndDistance")?T.writeBufferVec4(r.get("centerOffsetAndDistance"),h,n,6):T.writeBufferVec4Zeros(h,n,6*v),r.get("featureAttribute")?T.writeBufferVec4(r.get("featureAttribute"),f,n,6):T.writeBufferVec4Zeros(f,n,6*v),null!=i){const e=r.get("position")?.indices;if(e){const t=e.length,r=s.getField("olidColor",p.BufferViewVec4u8);T.writeOlidColor(i,r,t,n,6)}}return{numVerticesPerItem:6,numItems:v}}intersect(e,t,r,i,n,o,a){const{options:{selectionMode:u,hud:d,excludeLabels:h},point:f,camera:m}=i;if(!u||!d||h&&t.isLabel||!f)return;const g=this.layout.createView(e),y=g.getField("position",p.BufferViewVec3f),_=g.getField("normal",p.BufferViewVec3f),b=g.getField("rotation",p.BufferViewFloat),v=g.getField("size",p.BufferViewVec2f),x=g.getField("featureAttribute",p.BufferViewVec4f),S=g.getField("centerOffsetAndDistance",p.BufferViewVec4f),T="screen"===t.centerOffsetUnits,C=P.calculateAnchorPosition(t);if(null==y||null==_||null==b||null==v||null==S||null==m)return;const M=null==x?null:x.getVec(0,Q),{scaleX:R,scaleY:O}=re(M,t,m.pixelRatio),I=y.count/6;for(let e=0;e<I;e++){const n=6*e;if(y.getVec(n,L),null!=r&&l.add(L,L,r),l.transformMat4(L,L,m.viewMatrix),S.getVec(n,H),l.set(W,H[0],H[1],H[2]),!T&&(L[0]+=W[0],L[1]+=W[1],0!==W[2])){const e=W[2];l.normalize(W,L),l.subtract(L,L,l.scale(W,W,e))}if(_.getVec(n,V),A(V,j,m,Z),ie(t,L,Z,m,E),m.applyProjection(L,U),U[0]>-1){T&&(W[0]||W[1])&&(U[0]+=W[0]*m.pixelRatio,0!==W[1]&&(U[1]+=w.applyScaleFactor(W[1],E.factorAlignment)*m.pixelRatio),m.unapplyProjection(U,L)),U[0]+=t.screenOffset[0]*m.pixelRatio,U[1]+=t.screenOffset[1]*m.pixelRatio,U[0]=Math.floor(U[0]),U[1]=Math.floor(U[1]),v.getVec(n,J),w.applyPrecomputedScaleFactor(J,E.factor,J);const r=Y*m.pixelRatio;let o=0;t.textureIsSignedDistanceField&&(o=Math.min(t.outlineSize,.5*J[0])*m.pixelRatio/2),J[0]*=R,J[1]*=O;const u=b.get(n),d=t.rotation+u;if(D(f,U[0],U[1],J,r,o,d,t,C)){const t=i.ray;if(l.transformMat4(N,L,s.invert(q,m.viewMatrix)),U[0]=f[0],U[1]=f[1],m.unprojectFromRenderScreen(U,L)){const r=c.create();l.copy(r,t.direction);const i=1/l.length(r);l.scale(r,r,i),a(l.distance(t.origin,L)*i,r,e,N)}}}}}}function re(e,t,r){return null==e||null==t.vvSize?{scaleX:r,scaleY:r}:(f.evaluateModelTransformScale($,t,e),{scaleX:$[0]*r,scaleY:$[1]*r})}function ie(e,t,r,i,s){if(!e.verticalOffset?.screenLength)return e.screenSizePerspective||e.screenSizePerspectiveAlignment?se(e,s,l.length(t),r.cosAngle):(s.factor.scale=1,s.factorAlignment.scale=1),t;const n=l.length(t),o=e.screenSizePerspectiveAlignment??e.screenSizePerspective,a=C.verticalOffsetAtDistance(i,n,e.verticalOffset,r.cosAngle,o);return se(e,s,n,r.cosAngle),l.scale(r.normal,r.normal,a),l.add(t,t,r.normal)}function se(e,t,r,i){null!=e.screenSizePerspective?w.precomputeScaleFactor(i,r,e.screenSizePerspective,t.factor):(t.factor.scale=1,t.factor.factor=0,t.factor.minScaleFactor=0),null!=e.screenSizePerspectiveAlignment?w.precomputeScaleFactor(i,r,e.screenSizePerspectiveAlignment,t.factorAlignment):(t.factorAlignment.factor=t.factor.factor,t.factorAlignment.scale=t.factor.scale,t.factorAlignment.minScaleFactor=t.factor.minScaleFactor)}e.HUDMaterial=I,e.Parameters=ee,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/libs/gl-matrix-2/types/mat4":function(){define(["exports"],function(e){"use strict";function t(e){return e instanceof Float32Array&&e.length>=16}function r(e){return Array.isArray(e)&&e.length>=16}e.isMat4=function(e){return t(e)||r(e)},e.isMat4f32=t,e.isMat4f64=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/FastSymbolUpdates":function(){define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../renderers/support/lengthUtils","../../../../support/guards","../../support/debugFlags","../../webgl-engine/effects/geometry/olidUtils","../../../webgl/NoParameters"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";class g{constructor(e){this.field=e}}class y extends g{constructor(e){super(e),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[0,0,0],this.fallback=[0,0,0]}}class _ extends g{constructor(e){super(e),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0],this.fallback=[0,0,0,0]}}class b extends g{constructor(e,t=0){super(e),this.fallback=t,this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}}class v{}function w(e){return null!=e}function x(e,t){e&&e.push(t)}function S(e,t,r,i,s){const n=e.minSize,o=e.maxSize;if(e.useSymbolValue){const e=i.symbolSize[r];return t.minSize[r]=e,t.maxSize[r]=e,t.offset[r]=t.minSize[r],t.factor[r]=0,t.type[r]=1,!0}if(w(e.field))return w(e.stops)?2===e.stops.length&&h.isNumber(e.stops[0].size)&&h.isNumber(e.stops[1].size)?(T(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,r),t.type[r]=1,!0):(x(s,"Could not convert size info: stops only supported with 2 elements"),!1):h.isNumber(n)&&h.isNumber(o)&&w(e.minDataValue)&&w(e.maxDataValue)?(T(n,o,e.minDataValue,e.maxDataValue,t,r),t.type[r]=1,!0):"unknown"===e.valueUnit?(x(s,"Could not convert size info: proportional size not supported"),!1):null!=d.meterIn[e.valueUnit]?(t.minSize[r]=-1/0,t.maxSize[r]=1/0,t.offset[r]=0,t.factor[r]=1/d.meterIn[e.valueUnit],t.type[r]=1,!0):(x(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!w(e.field)){if(e.stops?.[0]&&h.isNumber(e.stops[0].size))return t.minSize[r]=e.stops[0].size,t.maxSize[r]=e.stops[0].size,t.offset[r]=t.minSize[r],t.factor[r]=0,t.type[r]=1,!0;if(h.isNumber(n))return t.minSize[r]=n,t.maxSize[r]=n,t.offset[r]=n,t.factor[r]=0,t.type[r]=1,!0}return x(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function T(e,t,r,i,s,n){const o=Math.abs(i-r)>0?(t-e)/(i-r):0;s.minSize[n]=o>0?e:t,s.maxSize[n]=o>0?t:e,s.offset[n]=e-r*o,s.factor[n]=o}function C(e,t,r){e[4*t]=r.r/255,e[4*t+1]=r.g/255,e[4*t+2]=r.b/255,e[4*t+3]=r.a}function P(e,t,r){const i=2===r&&"arithmetic"===e.rotationType;t.offset[r]=i?90:0,t.factor[r]=i?-1:1,t.type[r]=1}function M(e,t,r){if(!e)return null;const i=e.reduce((e,i)=>{if(!e)return e;if(i.valueExpression)return x(r,"Could not convert visual variables: arcade expressions not supported"),null;switch(i.type){case"size":return t.supports.size?function(e,t,r,i){if(e.normalizationField||e.valueRepresentation)return x(i,"Could not convert size info: unsupported property"),null;if(!h.isStringOrNull(e.field))return x(i,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return x(i,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size=new y(e.field),a.copy(t.size.fallback,r.fallbackSize);let s;switch(e.axis){case"width":return s=S(e,t.size,0,r,i),s?t:null;case"height":return s=S(e,t.size,2,r,i),s?t:null;case"depth":return s=S(e,t.size,1,r,i),s?t:null;case"width-and-depth":return s=S(e,t.size,0,r,i),s&&S(e,t.size,1,r,i),s?t:null;case null:case void 0:case"all":return s=S(e,t.size,0,r,i),s=s&&S(e,t.size,1,r,i),s=s&&S(e,t.size,2,r,i),s?t:null;default:return x(i,`Could not convert size info: unknown axis "${e.axis}""`),null}}(i,e,t,r):e;case"color":return t.supports.color?function(e,t,r,i){if(e.normalizationField)return x(i,"Could not convert color info: unsupported property"),null;if(h.isString(e.field)){if(!e.stops)return x(i,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return x(i,"Could not convert color info: too many color stops"),null;t.color=new _(e.field);const s=e.stops;for(let e=0;e<8;++e){const r=s[Math.min(e,s.length-1)];t.color.values[e]=r.value,C(t.color.colors,e,r.color)}c.copy(t.color.fallback,r.fallbackColor)}}else{if(!(e.stops&&e.stops.length>=0))return x(i,"Could not convert color info: no field and no colors/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color=new _(null);for(let e=0;e<8;e++)t.color.values[e]=1/0,C(t.color.colors,e,i);c.copy(t.color.fallback,r.fallbackColor)}}return t}(i,e,t,r):e;case"opacity":return t.supports.opacity?function(e,t,r,i){if(e.normalizationField)return x(i,"Could not convert opacity info: unsupported property"),null;if(h.isString(e.field)){if(!e.stops)return x(i,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return x(i,"Could not convert opacity info: too many opacity stops"),null;t.opacity=new b(e.field,r.fallbackColor[3]);const s=e.stops;for(let e=0;e<8;++e){const r=s[Math.min(e,s.length-1)];t.opacity.values[e]=r.value,t.opacity.opacityValues[e]=r.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return x(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const i=e.stops&&e.stops.length>=0?e.stops[0].opacity:0;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0],fallback:r.fallbackColor[3]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=i}}return t}(i,e,t,r):null;case"rotation":return t.supports.rotation?function(e,t,r){if(!h.isString(e.field))return x(r,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return x(r,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return P(e,t.rotation,0),t;case"roll":return P(e,t.rotation,1),t;case null:case void 0:case"heading":return P(e,t.rotation,2),t;default:return x(r,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}(i,e,r):e;default:return null}},new v);return!(e.length>0&&i)||i.size||i.color||i.opacity||i.rotation?i?.size&&!function(e,t,r){for(let r=0;r<3;++r){let i=t.unitInMeters;1===e.type[r]&&(i*=t.modelSize[r],e.type[r]=2),e.minSize[r]=e.minSize[r]/i,e.maxSize[r]=e.maxSize[r]/i,e.offset[r]=e.offset[r]/i,e.factor[r]=e.factor[r]/i}let i;if(0!==e.type[0])i=0;else if(0!==e.type[1])i=1;else{if(0===e.type[2])return x(r,"No size axis contains a valid size or scale"),!1;i=2}for(let t=0;t<3;++t)0===e.type[t]&&(e.minSize[t]=e.minSize[i],e.maxSize[t]=e.maxSize[i],e.offset[t]=e.offset[i],e.factor[t]=e.factor[i],e.type[t]=e.type[i]);return!0}(i.size,t,r)?null:i:null}class R{constructor(e,t,r){this.visualVariables=e,this.materialParameters=t,this.requiresShaderTransformation=r}}function O(e,t,r){if(!!e!=!!t)return!1;if(e&&e.field!==t?.field)return!1;if(e&&"rotation"===r){const r=e,i=t;for(let e=0;e<3;e++)if(r.type[e]!==i.type[e]||r.offset[e]!==i.offset[e]||r.factor[e]!==i.factor[e])return!1}return!0}class I extends m.NoParameters{constructor(e){super(),this.vvSize=e?.size??null,this.vvColor=e?.color??null,this.vvOpacity=e?.opacity??null}get hasVVSize(){return!!this.vvSize}get hasVVColor(){return!!this.vvColor}get hasVVOpacity(){return!!this.vvOpacity}}function F(e,t){const r=new I(e);return r.vvSize&&(r.vvSymbolAnchor=t.anchor,n.identity(L),function(e,t,r,i=o.create()){const s=e||0,a=t||0,l=r||0;0!==s&&n.rotateZ(i,i,-s/180*Math.PI),0!==a&&n.rotateX(i,i,a/180*Math.PI),0!==l&&n.rotateY(i,i,l/180*Math.PI)}(t.rotation[2],t.rotation[0],t.rotation[1],L),r.vvSymbolRotationMatrix=r.vvSymbolRotationMatrix||s.create(),i.fromMat4(r.vvSymbolRotationMatrix,L)),r}function A(e,t,i){if(!t.vvSize)return a.set(e,1,1,1),e;if(Number.isNaN(i[0]))return a.copy(e,t.vvSize.fallback);for(let s=0;s<3;++s){const n=t.vvSize.offset[s]+i[0]*t.vvSize.factor[s];e[s]=r.clamp(n,t.vvSize.minSize[s],t.vvSize.maxSize[s])}return e}const D=o.create(),E=l.create(),L=o.create();e.ConvertOptions=class{constructor({supports:e,modelSize:t,symbolSize:r,unitInMeters:i,anchor:s,scale:n,rotation:o,fallbackColor:a,fallbackSize:c}){this.supports=e,this.modelSize=t??l.ones(),this.symbolSize=r??l.ones(),this.unitInMeters=i??1,this.anchor=s??l.zeros(),this.scale=n??l.ones(),this.rotation=o??l.zeros(),this.fallbackColor=a??u.ones(),this.fallbackSize=c??l.ones()}},e.FastColorInfo=_,e.FastOpacityInfo=b,e.FastRotationInfo=class extends g{constructor(e){super(e),this.offset=[0,0,0],this.factor=[1,1,1],this.type=[0,0,0]}},e.FastSizeInfo=y,e.FastSymbolUpdatesState=R,e.FastVisualVariables=v,e.VisualVariablesParameters=I,e.convertVisualVariables=M,e.evaluateModelTransform=function(e,t,r){if(!e.vvSize)return r;n.copy(D,r);const i=e.vvSymbolRotationMatrix;return n.set(L,i[0],i[1],i[2],0,i[3],i[4],i[5],0,i[6],i[7],i[8],0,0,0,0,1),n.multiply(D,D,L),A(E,e,t),n.scale(D,D,E),n.translate(D,D,e.vvSymbolAnchor),D},e.evaluateModelTransformScale=A,e.getAttributeValue=function(e,t){const r=null==e?0:t.attributes[e];return"number"==typeof r&&isFinite(r)?r:NaN},e.getMaterialParameters=F,e.initFastSymbolUpdatesState=function(e,t){if(!e)return null;if(f.olidEnabled())return null;if(p.debugFlags.TESTS_DISABLE_FAST_UPDATES)return null;const r=M(e.visualVariables,t);return r?new R(r,F(r,t),!!r.size):null},e.updateFastSymbolUpdatesState=function(e,t,r){if(!t||!e)return!1;const i=e.visualVariables,s=M(t.visualVariables,r);return!!s&&!!(O(i.size,s.size,"size")&&O(i.color,s.color,"color")&&O(i.rotation,s.rotation,"rotation")&&O(i.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=F(s,r),e.requiresShaderTransformation=!!s.size,!0)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/geometry/olidUtils":function(){define(["exports","../../../../../core/has"],function(e,t){"use strict";e.olidEnabled=function(){return!!t("enable-feature:objectAndLayerId-rendering")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/hud/HUD.glsl":function(){define(["exports","../attributes/VerticalOffset.glsl","../util/ScreenSizePerspective.glsl","../util/View.glsl","../../shaderModules/Float4BindUniform","../../shaderModules/FloatBindUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl"],function(e,t,r,i,s,n,o,a){"use strict";e.HUD=function(e,l){e.include(r.ScreenSizePerspective),e.attributes.add("position","vec3"),e.attributes.add("normal","vec3"),e.attributes.add("centerOffsetAndDistance","vec4");const c=e.vertex;i.addProjViewLocalOrigin(c,l),i.addCameraPosition(c,l),c.uniforms.add(new s.Float4BindUniform("viewport",e=>e.camera.fullViewport),new o.FloatPassUniform("polygonOffset",e=>e.shaderPolygonOffset),new n.FloatBindUniform("cameraGroundRelative",e=>e.camera.aboveGround?1:-1)),l.hasVerticalOffset&&t.addVerticalOffset(c),c.code.add(a.glsl`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),c.code.add(a.glsl`
    float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
      float pointGroundSign = ${l.terrainDepthTest?a.glsl.float(0):a.glsl`sign(pointGroundDistance)`};
      if (pointGroundSign == 0.0) {
        pointGroundSign = cameraGroundRelative;
      }

      // cameraGroundRelative is -1 if camera is below ground, 1 if above ground
      // groundRelative is 1 if both camera and symbol are on the same side of the ground, -1 otherwise
      float groundRelative = cameraGroundRelative * pointGroundSign;

      // view angle dependent part of polygon offset emulation: we take the absolute value because the sign that is
      // dropped is instead introduced using the ground-relative position of the symbol and the camera
      if (polygonOffset > .0) {
        float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
        float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
        float factor = (1.0 - tanAlpha / viewport[2]);

        // same side of the terrain
        if (groundRelative > 0.0) {
          posView *= factor;
        }
        // opposite sides of the terrain
        else {
          posView /= factor;
        }
      }

      return groundRelative;
    }
  `),l.draped&&!l.hasVerticalOffset||i.addViewNormal(c),l.draped||(c.uniforms.add(new n.FloatBindUniform("perDistancePixelRatio",e=>Math.tan(e.camera.fovY/2)/(e.camera.fullViewport[2]/2))),c.code.add(a.glsl`
    void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
      float distanceToCamera = length(posView);

      // Compute offset in world units for a half pixel shift
      float pixelOffset = distanceToCamera * perDistancePixelRatio * ${a.glsl.float(.5)};

      // Apply offset along normal in the direction away from the ground surface
      vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;

      // Apply the same offset also on the view space position
      vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;

      posModel += modelOffset;
      posView += viewOffset;
    }
  `)),l.screenCenterOffsetUnitsEnabled&&i.addPixelRatio(c),l.hasScreenSizePerspective&&r.addScreenSizePerspectiveAlignment(c),c.code.add(a.glsl`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      vec3 centerOffset = centerOffsetAndDistance.xyz;
      float pointGroundDistance = centerOffsetAndDistance.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${l.draped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${l.hasScreenSizePerspective&&(l.hasVerticalOffset||l.screenCenterOffsetUnitsEnabled)?"vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${l.hasVerticalOffset?l.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${l.hasVerticalOffset?a.glsl`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${l.screenCenterOffsetUnitsEnabled?"":a.glsl`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${l.screenCenterOffsetUnitsEnabled?l.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${l.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `)},e.HUDVerticalPixelOffset=.5,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VerticalOffset.glsl":function(){define(["exports","../../../../../../core/screenUtils","../../../../../../chunks/vec42","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","../util/ScreenSizePerspective.glsl","../util/View.glsl","../../shaderModules/Float4PassUniform","../../shaderModules/glsl"],function(e,t,r,i,s,n,o,a){"use strict";const l=i.create();function c(e){e.uniforms.add(new o.Float4PassUniform("verticalOffset",(e,t)=>{const{minWorldLength:i,maxWorldLength:s,screenLength:n}=e.verticalOffset,o=Math.tan(.5*t.camera.fovY)/(.5*t.camera.fullViewport[3]),a=t.camera.pixelRatio||1;return r.set(l,n*a,o,i,s)}))}e.VerticalOffset=function(e,t){const r=e.vertex;t.hasVerticalOffset?(c(r),t.hasScreenSizePerspective&&(e.include(s.ScreenSizePerspective),s.addScreenSizePerspectiveAlignment(r),n.addCameraPosition(e.vertex,t)),r.code.add(a.glsl`
      vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
        ${t.spherical?a.glsl`vec3 worldNormal = normalize(worldPos + localOrigin);`:a.glsl`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
        ${t.hasScreenSizePerspective?a.glsl`
            float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
            float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:a.glsl`
            float verticalOffsetScreenHeight = verticalOffset.x;`}
        // Screen sized offset in world space, used for example for line callouts
        float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
        return worldNormal * worldOffset;
      }

      vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        return worldPos + calculateVerticalOffset(worldPos, localOrigin);
      }
    `)):r.code.add(a.glsl`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)},e.VerticalOffsetParameters=class{constructor(e){this.screenLength=t.pt2px(e.screenLength),this.minWorldLength=e.minWorldLength??0,this.maxWorldLength=e.maxWorldLength??1/0}},e.addVerticalOffset=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/ScreenSizePerspective.glsl":function(){define(["exports","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../shaderModules/Float3PassUniform","../../shaderModules/glsl"],function(e,t,r,i,s){"use strict";function n(e){return t.set(o,e.parameters.divisor,e.parameters.offset,e.minScaleFactor)}const o=r.create();e.ScreenSizePerspective=function(e){e.vertex.code.add(s.glsl`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),e.vertex.code.add(s.glsl`vec3 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec3 params) {
return vec3(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z
);
}`),e.vertex.code.add(s.glsl`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec3 factor) {
return mix(size * clamp(factor.x, factor.z, 1.0), size, factor.y);
}`),e.vertex.code.add(s.glsl`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),e.vertex.code.add(s.glsl`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec3 factor) {
return mix(size * clamp(factor.x, factor.z, 1.0), size, factor.y);
}`),e.vertex.code.add(s.glsl`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)},e.addScreenSizePerspective=function(e){e.uniforms.add(new i.Float3PassUniform("screenSizePerspective",e=>n(e.screenSizePerspective)))},e.addScreenSizePerspectiveAlignment=function(e){e.uniforms.add(new i.Float3PassUniform("screenSizePerspectiveAlignment",e=>n(e.screenSizePerspectiveAlignment||e.screenSizePerspective)))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/View.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../shaderModules/Float3BindUniform","../../shaderModules/Float3DrawUniform","../../shaderModules/FloatBindUniform","../../shaderModules/Matrix4BindUniform","../../shaderModules/Matrix4DrawUniform"],function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=r.create(),d=s.create();e.addCameraPosition=function(e,t){t.instancedDoublePrecision?e.constants.add("cameraPosition","vec3",s.ZEROS):e.uniforms.add(new o.Float3DrawUniform("cameraPosition",(e,t)=>i.set(d,t.camera.viewInverseTransposeMatrix[3]-e.origin[0],t.camera.viewInverseTransposeMatrix[7]-e.origin[1],t.camera.viewInverseTransposeMatrix[11]-e.origin[2])))},e.addPixelRatio=function(e){e.uniforms.add(new a.FloatBindUniform("pixelRatio",e=>e.camera.pixelRatio/e.overlayStretch))},e.addProjViewLocalOrigin=function(e,r){if(!r.instancedDoublePrecision)return void e.uniforms.add(new l.Matrix4BindUniform("proj",e=>e.camera.projectionMatrix),new c.Matrix4DrawUniform("view",(e,r)=>t.translate(u,r.camera.viewMatrix,e.origin)),new o.Float3DrawUniform("localOrigin",e=>e.origin));const s=({camera:e})=>i.set(d,e.viewInverseTransposeMatrix[3],e.viewInverseTransposeMatrix[7],e.viewInverseTransposeMatrix[11]);e.uniforms.add(new l.Matrix4BindUniform("proj",e=>e.camera.projectionMatrix),new l.Matrix4BindUniform("view",e=>t.translate(u,e.camera.viewMatrix,s(e))),new n.Float3BindUniform("localOrigin",e=>s(e)))},e.addViewNormal=function(e){e.uniforms.add(new l.Matrix4BindUniform("viewNormal",e=>e.camera.viewInverseTransposeMatrix))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Float3DrawUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"vec3",2,(i,s,n,o)=>i.setUniform3fv(e,t(s,n,o),r))}}e.Float3DrawUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/FloatBindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"float",0,(i,s)=>i.setUniform1f(e,t(s),r))}}e.FloatBindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Matrix4DrawUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"mat4",2,(i,s,n)=>i.setUniformMatrix4fv(e,t(s,n),r))}}e.Matrix4DrawUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Float4PassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"vec4",1,(i,s,n)=>i.setUniform4fv(e,t(s,n),r))}}e.Float4PassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Float4BindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"vec4",0,(i,s)=>i.setUniform4fv(e,t(s),r))}}e.Float4BindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/GLTextureMaterial":function(){define(["exports","../../../../core/maybe","../../../../core/promiseUtils","./GLMaterial","../../../webgl/NoParameters"],function(e,t,r,i,s){"use strict";class n extends s.NoParameters{constructor(e=null){super(),this.textureEmissive=e}}class o extends n{constructor(e,t,r,i,s,n,o){super(r),this.texture=e,this.textureNormal=t,this.textureOcclusion=i,this.textureMetallicRoughness=s,this.scale=n,this.normalTextureTransformMatrix=o}}e.GLEmissiveTexturePassParameters=n,e.GLTextureMaterial=class extends i{constructor(e){super(e),this._numLoading=0,this._disposed=!1,this._textures=e.textures,this.updateTexture(e.textureId),this._acquire(e.normalTextureId,e=>this._textureNormal=e),this._acquire(e.emissiveTextureId,e=>this._textureEmissive=e),this._acquire(e.occlusionTextureId,e=>this._textureOcclusion=e),this._acquire(e.metallicRoughnessTextureId,e=>this._textureMetallicRoughness=e)}dispose(){super.dispose(),this._texture=t.releaseMaybe(this._texture),this._textureNormal=t.releaseMaybe(this._textureNormal),this._textureEmissive=t.releaseMaybe(this._textureEmissive),this._textureOcclusion=t.releaseMaybe(this._textureOcclusion),this._textureMetallicRoughness=t.releaseMaybe(this._textureMetallicRoughness),this._disposed=!0}ensureResources(e){return 0===this._numLoading?2:1}get textureBindParameters(){return new o(this._texture?.glTexture??null,this._textureNormal?.glTexture??null,this._textureEmissive?.glTexture??null,this._textureOcclusion?.glTexture??null,this._textureMetallicRoughness?.glTexture??null)}updateTexture(e){null!=this._texture&&e===this._texture.id||(this._texture=t.releaseMaybe(this._texture),this._acquire(e,e=>this._texture=e))}_acquire(e,i){if(null==e)return void i(null);const s=this._textures.acquire(e);if(r.isPromiseLike(s))return++this._numLoading,void s.then(e=>{if(this._disposed)return t.releaseMaybe(e),void i(null);i(e)}).finally(()=>--this._numLoading);i(s)}},e.GLTextureMaterialBindParameters=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/GLMaterial":function(){define(function(){"use strict";return class{constructor(e){this._material=e.material,this._techniques=e.techniques,this._output=e.output}dispose(){}get _stippleTextures(){return this._techniques.context?.stippleTextures}get _markerTextures(){return this._techniques.context?.markerTextures}getTechnique(e,t){return this._techniques.get(e,this._material.getConfiguration(this._output,t))}ensureResources(e){return 2}}})},"esri/views/3d/webgl-engine/lib/Material":function(){define(["exports","../../../../core/uid","../materials/DefaultTechniqueConfiguration","../materials/internal/MaterialUtil","../../../webgl/NoParameters"],function(e,t,r,i,s){"use strict";class n extends s.NoParameters{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1}}e.Material=class{constructor(e,r){this.id=t.generateUID(),this.supportsEdges=!1,this._renderPriority=0,this._parameters=new r,i.updateParameters(this._parameters,e),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(e){return!1}setParameters(e,t=!0){i.updateParameters(this._parameters,e)&&(this.validateParameters(this._parameters),t&&this._parametersChanged())}validateParameters(e){}shouldRender(e){return this.visible&&this.isVisibleForOutput(e.output)&&(!this.parameters.isDecoration||e.bind.decorations)&&0!==(this.parameters.renderOccluded&e.renderOccludedMask)}isVisibleForOutput(e){return!0}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this._parametersChanged())}_parametersChanged(){this.repository?.materialChanged(this)}get renderOccludedFlags(){return this.visible?this.parameters.renderOccluded:0}get hasEmissions(){return!1}getConfiguration(e,t,i=new r.DefaultTechniqueConfiguration){return i.output=e,i.hasHighlightMixTexture=8===e&&null!=t.highlightMixTexture,i}},e.MaterialParameters=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/DefaultTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderLibrary/attributes/InstancedDoubleConfiguration","../core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends r.InstancedDoubleConfiguration{constructor(){super(...arguments),this.output=0,this.oitPass=0,this.hasSlicePlane=!1,this.hasHighlightMixTexture=!1,this.bindType=1,this.instanced=!1,this.writeDepth=!0}}t.__decorate([i.parameter({count:10})],s.prototype,"output",void 0),t.__decorate([i.parameter({count:3})],s.prototype,"oitPass",void 0),t.__decorate([i.parameter()],s.prototype,"hasSlicePlane",void 0),t.__decorate([i.parameter()],s.prototype,"hasHighlightMixTexture",void 0),e.DefaultTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/InstancedDoubleConfiguration":function(){define(["exports","../../shaderTechnique/ShaderTechniqueConfiguration"],function(e,t){"use strict";class r extends t.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}}e.InstancedDoubleConfiguration=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/internal/MaterialUtil":function(){define(["exports","../../../../../core/arrayUtils","../../../../../core/mathUtils","../../lib/screenSizePerspectiveUtils"],function(e,t,r,i){"use strict";e.colorMixModes={multiply:1,ignore:2,replace:3,tint:4},e.updateParameters=function(e,r){let i=!1;for(const s in r){const n=r[s];void 0!==n&&(Array.isArray(n)?Array.isArray(e[s])&&t.equals(n,e[s])||(e[s]=n.slice(),i=!0):e[s]!==n&&(i=!0,e[s]=n))}return i},e.verticalOffsetAtDistance=function(e,t,s,n,o){let a=s.screenLength*e.pixelRatio;null!=o&&(a=i.scale(a,n,t,o));const l=a*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return r.clamp(l*t,s.minWorldLength,s.maxWorldLength)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/ScaleInfo":function(){define(["exports"],function(e){"use strict";class t{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}}e.ScaleFactor=t,e.ScaleInfo=class{constructor(){this.factor=new t,this.factorAlignment=new t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/internal/bufferWriterUtils":function(){define(["exports","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../geometry/support/buffer/BufferView","../../lib/Util"],function(e,t,r,i,s,n){"use strict";function o(e,t,r){const{data:i,indices:s}=e,n=t.typedBuffer,o=t.typedBufferStride,a=s.length;r*=o;for(let e=0;e<a;++e){const t=2*s[e];n[r]=i[t],n[r+1]=i[t+1],r+=o}}function a(e,t,r,i=1){const{data:s,indices:n}=e,o=t.typedBuffer,a=t.typedBufferStride,l=n.length;if(r*=a,1===i)for(let e=0;e<l;++e){const t=3*n[e];o[r]=s[t],o[r+1]=s[t+1],o[r+2]=s[t+2],r+=a}else for(let e=0;e<l;++e){const t=3*n[e];for(let e=0;e<i;++e)o[r]=s[t],o[r+1]=s[t+1],o[r+2]=s[t+2],r+=a}}function l(e,t,r,i=1){const{data:s,indices:n}=e,o=t.typedBuffer,a=t.typedBufferStride,l=n.length;if(r*=a,1===i)for(let e=0;e<l;++e){const t=4*n[e];o[r]=s[t],o[r+1]=s[t+1],o[r+2]=s[t+2],o[r+3]=s[t+3],r+=a}else for(let e=0;e<l;++e){const t=4*n[e];for(let e=0;e<i;++e)o[r]=s[t],o[r+1]=s[t+1],o[r+2]=s[t+2],o[r+3]=s[t+3],r+=a}}function c(e,t,r,s,n=1){if(!t)return void a(e,r,s,n);const{data:o,indices:l}=e,c=r.typedBuffer,u=r.typedBufferStride,d=l.length,h=t[0],p=t[1],f=t[2],m=t[4],g=t[5],y=t[6],_=t[8],b=t[9],v=t[10],w=t[12],x=t[13],S=t[14];s*=u;let T=0,C=0,P=0;const M=i.hasIdentityRotation(t)?e=>{T=o[e]+w,C=o[e+1]+x,P=o[e+2]+S}:e=>{const t=o[e],r=o[e+1],i=o[e+2];T=h*t+m*r+_*i+w,C=p*t+g*r+b*i+x,P=f*t+y*r+v*i+S};if(1===n)for(let e=0;e<d;++e)M(3*l[e]),c[s]=T,c[s+1]=C,c[s+2]=P,s+=u;else for(let e=0;e<d;++e){M(3*l[e]);for(let e=0;e<n;++e)c[s]=T,c[s+1]=C,c[s+2]=P,s+=u}}function u(e,t,r,s,n=1){if(!t)return void a(e,r,s,n);const{data:o,indices:l}=e,c=t,u=r.typedBuffer,d=r.typedBufferStride,h=l.length,p=c[0],f=c[1],m=c[2],g=c[4],y=c[5],_=c[6],b=c[8],v=c[9],w=c[10],x=!i.isOrthoNormal(c),S=1e-6,T=.999999;s*=d;let C=0,P=0,M=0;const R=i.hasIdentityRotation(c)?e=>{C=o[e],P=o[e+1],M=o[e+2]}:e=>{const t=o[e],r=o[e+1],i=o[e+2];C=p*t+g*r+b*i,P=f*t+y*r+v*i,M=m*t+_*r+w*i};if(1===n)if(x)for(let e=0;e<h;++e){R(3*l[e]);const t=C*C+P*P+M*M;if(t<T&&t>S){const e=1/Math.sqrt(t);u[s]=C*e,u[s+1]=P*e,u[s+2]=M*e}else u[s]=C,u[s+1]=P,u[s+2]=M;s+=d}else for(let e=0;e<h;++e)R(3*l[e]),u[s]=C,u[s+1]=P,u[s+2]=M,s+=d;else for(let e=0;e<h;++e){if(R(3*l[e]),x){const e=C*C+P*P+M*M;if(e<T&&e>S){const t=1/Math.sqrt(e);C*=t,P*=t,M*=t}}for(let e=0;e<n;++e)u[s]=C,u[s+1]=P,u[s+2]=M,s+=d}}function d(e,t,r,s,n=1){if(!t)return void l(e,r,s,n);const{data:o,indices:a}=e,c=t,u=r.typedBuffer,d=r.typedBufferStride,h=a.length,p=c[0],f=c[1],m=c[2],g=c[4],y=c[5],_=c[6],b=c[8],v=c[9],w=c[10],x=!i.isOrthoNormal(c),S=1e-6,T=.999999;if(s*=d,1===n)for(let e=0;e<h;++e){const t=4*a[e],r=o[t],i=o[t+1],n=o[t+2],l=o[t+3];let c=p*r+g*i+b*n,h=f*r+y*i+v*n,C=m*r+_*i+w*n;if(x){const e=c*c+h*h+C*C;if(e<T&&e>S){const t=1/Math.sqrt(e);c*=t,h*=t,C*=t}}u[s]=c,u[s+1]=h,u[s+2]=C,u[s+3]=l,s+=d}else for(let e=0;e<h;++e){const t=4*a[e],r=o[t],i=o[t+1],l=o[t+2],c=o[t+3];let h=p*r+g*i+b*l,C=f*r+y*i+v*l,P=m*r+_*i+w*l;if(x){const e=h*h+C*C+P*P;if(e<T&&e>S){const t=1/Math.sqrt(e);h*=t,C*=t,P*=t}}for(let e=0;e<n;++e)u[s]=h,u[s+1]=C,u[s+2]=P,u[s+3]=c,s+=d}}function h(e,t,r,i,s=1){const{data:n,indices:o}=e,a=r.typedBuffer,l=r.typedBufferStride,c=o.length;if(i*=l,t===n.length&&4===t){a[i]=n[0],a[i+1]=n[1],a[i+2]=n[2],a[i+3]=n[3];const e=new Uint32Array(r.typedBuffer.buffer,r.start),t=l/4,o=e[i/=4];i+=t;const u=c*s;for(let r=1;r<u;++r)e[i]=o,i+=t;return}if(1!==s)if(4!==t)for(let e=0;e<c;++e){const t=3*o[e];for(let e=0;e<s;++e)a[i]=n[t],a[i+1]=n[t+1],a[i+2]=n[t+2],a[i+3]=255,i+=l}else for(let e=0;e<c;++e){const t=4*o[e];for(let e=0;e<s;++e)a[i]=n[t],a[i+1]=n[t+1],a[i+2]=n[t+2],a[i+3]=n[t+3],i+=l}else{if(4===t){for(let e=0;e<c;++e){const t=4*o[e];a[i]=n[t],a[i+1]=n[t+1],a[i+2]=n[t+2],a[i+3]=n[t+3],i+=l}return}for(let e=0;e<c;++e){const t=3*o[e];a[i]=n[t],a[i+1]=n[t+1],a[i+2]=n[t+2],a[i+3]=255,i+=l}}}function p(e,t,r){const{data:i,indices:s}=e,n=t.typedBuffer,o=t.typedBufferStride,a=s.length,l=i[0];r*=o;for(let e=0;e<a;++e)n[r]=l,r+=o}const f=r.create();function m(e,t,r,i,s=1){const n=t.typedBuffer,o=t.typedBufferStride;if(i*=o,1===s)for(let t=0;t<r;++t)n[i]=e[0],n[i+1]=e[1],n[i+2]=e[2],n[i+3]=e[3],i+=o;else for(let t=0;t<r;++t)for(let t=0;t<s;++t)n[i]=e[0],n[i+1]=e[1],n[i+2]=e[2],n[i+3]=e[3],i+=o}function g(e,t,r,i,f,m){switch(e){case"position":{n.assert(3===t.size);const i=f.getField(e,s.BufferViewVec3f);n.assert(!!i,`No buffer view for ${e}`),c(t,r,i,m);break}case"normal":{n.assert(3===t.size);const r=f.getField(e,s.BufferViewVec3f);n.assert(!!r,`No buffer view for ${e}`),u(t,i,r,m);break}case"normalCompressed":case"profileRight":case"profileUp":{n.assert(2===t.size);const r=f.getField(e,s.BufferViewVec2i16);n.assert(!!r,`No buffer view for ${e}`),o(t,r,m);break}case"uv0":{n.assert(2===t.size);const r=f.getField(e,s.BufferViewVec2f16)??f.getField(e,s.BufferViewVec2f);n.assert(!!r,`No buffer view for ${e}`),o(t,r,m);break}case"uvi":{n.assert(2===t.size);const r=f.getField(e,s.BufferViewVec2i16);n.assert(!!r,`No buffer view for ${e}`),o(t,r,m);break}case"color":case"symbolColor":{const r=f.getField(e,s.BufferViewVec4u8);n.assert(!!r,`No buffer view for ${e}`),n.assert(3===t.size||4===t.size),h(t,t.size,r,m);break}case"colorFeatureAttribute":case"opacityFeatureAttribute":case"sizeFeatureAttribute":{const r=f.getField(e,s.BufferViewFloat)??f.getField(e,s.BufferViewFloat);n.assert(!!r,`No buffer view for ${e}`),n.assert(1===t.size),p(t,r,m);break}case"tangent":{n.assert(4===t.size);const i=f.getField(e,s.BufferViewVec4f);n.assert(!!i,`No buffer view for ${e}`),d(t,r,i,m);break}case"profileVertexAndNormal":{n.assert(4===t.size);const r=f.getField(e,s.BufferViewVec4f16)??f.getField(e,s.BufferViewVec4f);n.assert(!!r,`No buffer view for ${e}`),l(t,r,m);break}case"profileAuxData":{n.assert(3===t.size);const r=f.getField(e,s.BufferViewVec3f16)??f.getField(e,s.BufferViewVec3f);n.assert(!!r,`No buffer view for ${e}`),a(t,r,m);break}}}e.writeAttribute=g,e.writeAttributes=function(e,t,r,i,n,o,a){let l={numItems:0,numVerticesPerItem:0};for(const c of r.fields.keys()){const r=e.get(c),u=r?.indices;if(r&&u)"position"===c&&(l={numItems:1,numVerticesPerItem:u.length}),g(c,r,i,n,o,a);else if("olidColor"===c&&null!=t){const r=e.get("position")?.indices;if(r){const e=r.length;m(t,o.getField(c,s.BufferViewVec4u8),e,a)}}}return l},e.writeBufferFloat=function(e,t,r,i=1){const{data:s,indices:n}=e,o=t.typedBuffer,a=t.typedBufferStride,l=n.length;if(r*=a,1===i)for(let e=0;e<l;++e)o[r]=s[n[e]],r+=a;else for(let e=0;e<l;++e){const t=s[n[e]];for(let e=0;e<i;e++)o[r]=t,r+=a}},e.writeBufferMat3f=function(e,t,r){const{data:i,indices:s}=e,n=t.typedBuffer,o=t.typedBufferStride,a=s.length;r*=o;for(let e=0;e<a;++e){const t=9*s[e];for(let e=0;e<9;++e)n[r+e]=i[t+e];r+=o}},e.writeBufferMat4f=function(e,t,r){const{data:i,indices:s}=e,n=t.typedBuffer,o=t.typedBufferStride,a=s.length;r*=o;for(let e=0;e<a;++e){const t=16*s[e];for(let e=0;e<16;++e)n[r+e]=i[t+e];r+=o}},e.writeBufferVec2=o,e.writeBufferVec3=a,e.writeBufferVec4=l,e.writeBufferVec4Zeros=function(e,t,r){const i=e.typedBuffer,s=e.typedBufferStride;t*=s;for(let e=0;e<r;++e)i[t]=0,i[t+1]=0,i[t+2]=0,i[t+3]=0,t+=s},e.writeColor=h,e.writeDeltaF16Vector=function(e,r,i,s){t.subtract(f,e,r);const n=Math.max(Math.sqrt(t.length(f)),1e-4);t.scale(f,f,1/n),i[s++]=f[0],i[s++]=f[1],i[s++]=f[2],i[s++]=n},e.writeNormal=u,e.writeOlidColor=m,e.writePosition=c,e.writeTangent=d,e.writeVVFeatureAttribute=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/HUDMaterial.glsl":function(){define(["exports","../core/libs/gl-matrix-2/math/vec2","../core/libs/gl-matrix-2/factories/vec2f64","../core/libs/gl-matrix-2/factories/vec4f64","../geometry/support/Ellipsoid","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/ObjectAndLayerIdColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/AlignPixel.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/HUD.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/HUDOcclusionPass.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/HUDVisibility.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/VisualVariables.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ScreenSizePerspective.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/Float4BindUniform","../views/3d/webgl-engine/core/shaderModules/Float4DrawUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatBindUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M){"use strict";function R(e){const r=new P.ShaderBuilder,{signedDistanceFieldEnabled:R,occlusionTestEnabled:A,horizonCullingEnabled:E,pixelSnappingEnabled:L,hasScreenSizePerspective:V,debugDrawLabelBorder:U,hasVVSize:B,hasVVColor:N,hasRotation:k,occludedFragmentFade:z,sampleSignedDistanceFieldTexelCenter:j}=e;r.include(l.HUD,e),r.vertex.include(n.RejectBySlice,e);const{occlusionPass:G,output:q,oitPass:H}=e;if(G)return r.include(c.HUDOcclusionPass,e),r;const{vertex:W,fragment:$}=r;r.include(m.ScreenSizePerspective),r.include(h.VisualVariables,e),r.include(o.ObjectAndLayerIdColor,e),A&&r.include(u.HUDVisibility),$.include(f.RgbaFloatEncoding),$.include(p.ColorConversion),r.varyings.add("vcolor","vec4"),r.varyings.add("vtc","vec2"),r.varyings.add("vsize","vec2");const Q=8===q,Z=Q&&A;Z&&r.varyings.add("voccluded","float"),W.uniforms.add(new _.Float4BindUniform("viewport",e=>e.camera.fullViewport),new y.Float2PassUniform("screenOffset",(e,r)=>t.set(F,2*e.screenOffset[0]*r.camera.pixelRatio,2*e.screenOffset[1]*r.camera.pixelRatio)),new y.Float2PassUniform("anchorPosition",e=>I(e)),new v.Float4PassUniform("materialColor",e=>e.color),new x.FloatPassUniform("materialRotation",e=>e.rotation),new C.Texture2DPassUniform("tex",e=>e.texture)),g.addPixelRatio(W),R&&(W.uniforms.add(new v.Float4PassUniform("outlineColor",e=>e.outlineColor)),$.uniforms.add(new v.Float4PassUniform("outlineColor",e=>O(e)?e.outlineColor:i.ZEROS),new x.FloatPassUniform("outlineSize",e=>O(e)?e.outlineSize:0))),E&&W.uniforms.add(new b.Float4DrawUniform("pointDistanceSphere",(e,t)=>{const r=t.camera.eye,n=e.origin;return i.fromValues(n[0]-r[0],n[1]-r[1],n[2]-r[2],s.earth.radius)})),L&&W.include(a.AlignPixel),V&&(m.addScreenSizePerspective(W),m.addScreenSizePerspectiveAlignment(W)),U&&r.varyings.add("debugBorderCoords","vec4"),r.attributes.add("uvi","vec2"),r.attributes.add("color","vec4"),r.attributes.add("size","vec2"),r.attributes.add("rotation","float"),(B||N)&&r.attributes.add("featureAttribute","vec4"),W.code.add(E?S.glsl`bool behindHorizon(vec3 posModel) {
vec3 camToEarthCenter = pointDistanceSphere.xyz - localOrigin;
vec3 camToPos = pointDistanceSphere.xyz + posModel;
float earthRadius = pointDistanceSphere.w;
float a = dot(camToPos, camToPos);
float b = dot(camToPos, camToEarthCenter);
float c = dot(camToEarthCenter, camToEarthCenter) - earthRadius * earthRadius;
return b > 0.0 && b < a && b * b  > a * c;
}`:S.glsl`bool behindHorizon(vec3 posModel) { return false; }`),W.main.add(S.glsl`
    ProjectHUDAux projectAux;
    vec4 posProj = projectPositionHUD(projectAux);
    forwardObjectAndLayerIdColor();

    if (rejectBySlice(projectAux.posModel)) {
      // Project outside of clip plane
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      return;
    }

    if (behindHorizon(projectAux.posModel)) {
      // Project outside of clip plane
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      return;
    }

    vec2 inputSize;
    ${S.If(V,S.glsl`
        inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
        vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);`,S.glsl`
        inputSize = size;
        vec2 screenOffsetScaled = screenOffset;`)}
    ${S.If(B,S.glsl`inputSize *= vvScale(featureAttribute).xx;`)}

    vec2 combinedSize = inputSize * pixelRatio;
    vec4 quadOffset = vec4(0.0);

    ${S.If(A,S.glsl`
    bool visible = testHUDVisibility(posProj);
    if (!visible) {
      vtc = vec2(0.0);
      ${S.If(U,"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);")}
      return;
    }`)}
    ${S.If(Z,S.glsl`voccluded = visible ? 0.0 : 1.0;`)}
  `);const Y=S.glsl`
      vec2 uvi1 = vec2(uvi.x < 0.0 ? 1.0 : 0.0, uvi.y < 0.0 ? 1.0 : 0.0);
      vec2 uv = abs(uvi + uvi1);
      vec2 texSize = vec2(textureSize(tex, 0));
      uv.x = uv.x >= ${D} ? 1.0 : uv.x / texSize.x;
      uv.y = uv.y >= ${D} ? 1.0 : uv.y / texSize.y;
      quadOffset.xy = (uvi1 - anchorPosition) * 2.0 * combinedSize;

      ${S.If(k,S.glsl`
          float angle = radians(materialRotation + rotation);
          float cosAngle = cos(angle);
          float sinAngle = sin(angle);
          mat2 rotate = mat2(cosAngle, -sinAngle, sinAngle,  cosAngle);

          quadOffset.xy = rotate * quadOffset.xy;
        `)}

      quadOffset.xy = (quadOffset.xy + screenOffsetScaled) / viewport.zw * posProj.w;
  `,X=L?R?S.glsl`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:S.glsl`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:S.glsl`posProj += quadOffset;`;W.main.add(S.glsl`
    ${Y}
    ${N?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${S.If(9===q,S.glsl`vcolor.a = 1.0;`)}

    bool alphaDiscard = vcolor.a < ${S.glsl.float(M.alphaCutoff)};
    ${S.If(R,`alphaDiscard = alphaDiscard && outlineColor.a < ${S.glsl.float(M.alphaCutoff)};`)}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${X}
      gl_Position = posProj;
    }

    vtc = uv;

    ${S.If(U,S.glsl`debugBorderCoords = vec4(uv01, 1.5 / combinedSize);`)}
    vsize = inputSize;
  `),$.uniforms.add(new C.Texture2DPassUniform("tex",e=>e.texture)),z&&!Q&&$.uniforms.add(new T.Texture2DBindUniform("depthMap",e=>e.mainDepth),new w.FloatBindUniform("occludedOpacity",e=>e.hudOccludedFragmentOpacity));const J=U?S.glsl`(isBorder > 0.0 ? 0.0 : ${S.glsl.float(M.alphaCutoff)})`:S.glsl.float(M.alphaCutoff),K=S.glsl`
    ${S.If(U,S.glsl`float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`)}

    vec2 samplePos = vtc;

    ${S.If(j,S.glsl`
      float txSize = float(textureSize(tex, 0).x);
      float texelSize = 1.0 / txSize;

      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      samplePos += (vec2(1.0, -1.0) * texelSize) * scaleFactor;`)}

    ${R?S.glsl`
      vec4 fillPixelColor = vcolor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgbaTofloat(texture(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${J} ||
          fillPixelColor.a + outlinePixelColor.a < ${S.glsl.float(M.alphaCutoff)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        ${S.If(!Q,S.glsl`fragColor = vec4(compositeColor, compositeAlpha);`)}
      } else {
        if (fillAlphaFactor < ${J}) {
          discard;
        }

        ${S.If(!Q,S.glsl`fragColor = premultiplyAlpha(fillPixelColor);`)}
      }

      // visualize SDF:
      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:S.glsl`
          vec4 texColor = texture(tex, samplePos, -0.5);
          if (texColor.a < ${J}) {
            discard;
          }
          ${S.If(!Q,S.glsl`fragColor = texColor * premultiplyAlpha(vcolor);`)}
          `}

    ${S.If(z&&!Q,S.glsl`
        float zSample = texelFetch(depthMap, ivec2(gl_FragCoord.xy), 0).x;
        if (zSample < gl_FragCoord.z) {
          fragColor *= occludedOpacity;
        }
        `)}

    ${S.If(!Q&&U,S.glsl`fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`)}
  `;switch(q){case 0:case 1:r.outputs.add("fragColor","vec4",0),1===q&&r.outputs.add("fragEmission","vec4",1),1===H&&r.outputs.add("fragAlpha","float",1===q?2:1),$.main.add(S.glsl`
        ${K}
        ${S.If(2===H,S.glsl`fragColor.rgb /= fragColor.a;`)}
        ${S.If(1===q,S.glsl`fragEmission = vec4(0.0);`)}
        ${S.If(1===H,S.glsl`fragAlpha = fragColor.a;`)}`);break;case 9:$.main.add(S.glsl`
        ${K}
        outputObjectAndLayerIdColor();`);break;case 8:r.include(d.OutputHighlight,e),$.main.add(S.glsl`
        ${K}
        outputHighlight(${S.If(Z,S.glsl`voccluded == 1.0`,S.glsl`false`)});`)}return r}function O(e){return e.outlineColor[3]>0&&e.outlineSize>0}function I(e){var r,i,s;return e.textureIsSignedDistanceField?(r=e.anchorPosition,i=e.distanceFieldBoundingBox,s=F,t.set(s,r[0]*(i[2]-i[0])+i[0],r[1]*(i[3]-i[1])+i[1])):t.copy(F,e.anchorPosition),F}const F=r.create(),A=32e3,D=S.glsl.float(A),E=Object.freeze(Object.defineProperty({__proto__:null,build:R,calculateAnchorPosition:I,fullUV:A},Symbol.toStringTag,{value:"Module"}));e.HUDMaterial=E,e.build=R,e.calculateAnchorPosition=I,e.fullUV=A})},"esri/views/3d/webgl-engine/core/shaderLibrary/Slice.glsl":function(){define(["exports","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../shaderModules/Float3DrawUniform","../shaderModules/Float3PassUniform","../shaderModules/glsl","../../../../webgl/NoParameters"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends l.NoParameters{constructor(e){super(),this.slicePlaneLocalOrigin=e}}const u=a.glsl`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
bool rejectBySlice(vec3 pos) {
return sliceByPlane(pos);
}`;function d(e,t,...r){t.hasSlicePlane?(e.uniforms.add(...r),e.code.add(u)):e.code.add("bool rejectBySlice(vec3 pos) { return false; }")}function h(e,t,...r){d(e,t,...r),t.hasSlicePlane?e.code.add("\n    void discardBySlice(vec3 pos) {\n      if (sliceByPlane(pos)) {\n        discard;\n      }\n    }\n\n    vec4 applySliceOutline(vec4 color, vec3 pos) {\n      SliceFactors factors = calculateSliceFactors(pos);\n\n      factors.front /= 2.0 * fwidth(factors.front);\n      factors.side0 /= 2.0 * fwidth(factors.side0);\n      factors.side1 /= 2.0 * fwidth(factors.side1);\n      factors.side2 /= 2.0 * fwidth(factors.side2);\n      factors.side3 /= 2.0 * fwidth(factors.side3);\n\n      // return after calling fwidth, to avoid aliasing caused by discontinuities in the input to fwidth\n      if (sliceByFactors(factors)) {\n        return color;\n      }\n\n      float outlineFactor = (1.0 - step(0.5, factors.front))\n        * (1.0 - step(0.5, factors.side0))\n        * (1.0 - step(0.5, factors.side1))\n        * (1.0 - step(0.5, factors.side2))\n        * (1.0 - step(0.5, factors.side3));\n\n      return mix(color, vec4(vec3(0.0), color.a), outlineFactor * 0.3);\n    }\n\n    vec4 applySlice(vec4 color, vec3 pos) {\n      return sliceEnabled() ? applySliceOutline(color, pos) : color;\n    }\n  "):e.code.add(a.glsl`void discardBySlice(vec3 pos) { }
vec4 applySlice(vec4 color, vec3 pos) { return color; }`)}function p(e,t,r){return e.instancedDoublePrecision?i.set(_,r.camera.viewInverseTransposeMatrix[3],r.camera.viewInverseTransposeMatrix[7],r.camera.viewInverseTransposeMatrix[11]):t.slicePlaneLocalOrigin}function f(e,t){return null!=e?i.subtract(b,t.origin,e):t.origin}function m(e,r,i){return e.hasSliceTranslatedView?null!=r?t.translate(w,i.camera.viewMatrix,r):i.camera.viewMatrix:null}function g(e,t,r){if(null==r.slicePlane)return s.ZEROS;const n=p(e,t,r),o=f(n,r.slicePlane),a=m(e,n,r);return null!=a?i.transformMat4(b,o,a):o}function y(e,t,r,n){if(null==n||null==r.slicePlane)return s.ZEROS;const o=p(e,t,r),a=f(o,r.slicePlane),l=m(e,o,r);return null!=l?(i.add(v,n,a),i.transformMat4(b,a,l),i.transformMat4(v,v,l),i.subtract(v,v,b)):n}const _=s.create(),b=s.create(),v=s.create(),w=r.create();e.RejectBySlice=function(e,t){d(e,t,new n.Float3DrawUniform("slicePlaneOrigin",(e,r)=>g(t,e,r)),new n.Float3DrawUniform("slicePlaneBasis1",(e,r)=>y(t,e,r,r.slicePlane?.basis1)),new n.Float3DrawUniform("slicePlaneBasis2",(e,r)=>y(t,e,r,r.slicePlane?.basis2)))},e.SliceDraw=function(e,t){h(e,t,new n.Float3DrawUniform("slicePlaneOrigin",(e,r)=>g(t,e,r)),new n.Float3DrawUniform("slicePlaneBasis1",(e,r)=>y(t,e,r,r.slicePlane?.basis1)),new n.Float3DrawUniform("slicePlaneBasis2",(e,r)=>y(t,e,r,r.slicePlane?.basis2)))},e.SlicePass=function(e,t){h(e,t,new o.Float3PassUniform("slicePlaneOrigin",(e,r)=>g(t,e,r)),new o.Float3PassUniform("slicePlaneBasis1",(e,r)=>y(t,e,r,r.slicePlane?.basis1)),new o.Float3PassUniform("slicePlaneBasis2",(e,r)=>y(t,e,r,r.slicePlane?.basis2)))},e.SlicePlaneParameters=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/ObjectAndLayerIdColor.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.ObjectAndLayerIdColor=function(e,r){if(9!==r.output)return e.vertex.code.add(t.glsl`void forwardObjectAndLayerIdColor() {}`),void e.fragment.code.add(t.glsl`void outputObjectAndLayerIdColor() {}`);const i=r.instanced;e.varyings.add("objectAndLayerIdColorVarying","vec4");const s=i?"instanceOlidColor":"olidColor";e.attributes.add(s,"vec4"),e.vertex.code.add(t.glsl`
    void forwardObjectAndLayerIdColor() {
      objectAndLayerIdColorVarying = ${s} * 0.003921568627451;
    }`),e.fragment.code.add(t.glsl`void outputObjectAndLayerIdColor() {
fragColor = objectAndLayerIdColorVarying;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/hud/AlignPixel.glsl":function(){define(["exports","../../shaderModules/BooleanBindUniform","../../shaderModules/glsl"],function(e,t,r){"use strict";e.AlignPixel=function(e){e.uniforms.add(new t.BooleanBindUniform("alignPixelEnabled",e=>e.alignPixelEnabled)),e.code.add(r.glsl`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`),e.code.add(r.glsl`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/BooleanBindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"bool",0,(r,i)=>r.setUniform1b(e,t(i)))}}e.BooleanBindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/hud/HUDOcclusionPass.glsl":function(){define(["exports","./AlignPixel.glsl","../shading/TerrainDepthTest.glsl","../../shaderModules/glsl"],function(e,t,r,i){"use strict";e.HUDOcclusionPass=function(e,s){const{vertex:n,fragment:o}=e;e.include(r.terrainDepthTest,s),n.include(t.AlignPixel),n.main.add(i.glsl`vec4 posProjCenter;
if (dot(position, position) > 0.0) {
ProjectHUDAux projectAux;
vec4 posProj = projectPositionHUD(projectAux);
posProjCenter = alignToPixelCenter(posProj, viewport.zw);
forwardViewPosDepth(projectAux.posView);
vec3 vpos = projectAux.posModel;
if (rejectBySlice(vpos)) {
posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
}
} else {
posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
}
gl_Position = posProjCenter;
gl_PointSize = 1.0;`),o.main.add(i.glsl`fragColor = vec4(1);
if(discardByTerrainDepth()) {
fragColor.g = 0.5;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/TerrainDepthTest.glsl":function(){define(["exports","../output/ReadDepth.glsl","../../shaderModules/glsl","../../shaderModules/Texture2DBindUniform"],function(e,t,r,i){"use strict";e.terrainDepthTest=function(e,{occlusionPass:s,terrainDepthTest:n,cullAboveTerrain:o}){const{vertex:a,fragment:l,varyings:c}=e;if(!n)return a.code.add("void forwardViewPosDepth(vec3 pos) {}"),void l.code.add(`${s?"bool":"void"} discardByTerrainDepth() { ${r.If(s,"return false;")}}`);c.add("viewPosDepth","float",{invariant:!0}),a.code.add("void forwardViewPosDepth(vec3 pos) {\n    viewPosDepth = pos.z;\n  }"),l.include(t.ReadDepth),l.uniforms.add(new i.Texture2DBindUniform("terrainDepthTexture",e=>e.terrainDepth?.attachment)).code.add(r.glsl`
    ${s?"bool":"void"} discardByTerrainDepth() {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${s?"return viewPosDepth < linearDepth && depth < 1.0;":`if(viewPosDepth ${o?">":"<="} linearDepth) discard;`}
    }`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../../core/libs/gl-matrix-2/factories/vec2f64","../../shaderModules/Float2BindUniform","../../shaderModules/glsl"],function(e,t,r,i,s){"use strict";const n=r.create();e.ReadDepth=function(e){e.uniforms.add(new i.Float2BindUniform("zProjectionMap",e=>function(e){const r=e.projectionMatrix;return t.set(n,r[14],r[10])}(e.camera))),e.code.add(s.glsl`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),e.code.add(s.glsl`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),e.code.add(s.glsl`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Float2BindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"vec2",0,(i,s)=>i.setUniform2fv(e,t(s),r))}}e.Float2BindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"sampler2D",0,(r,i)=>r.bindTexture(e,t(i)))}}e.Texture2DBindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/hud/HUDVisibility.glsl":function(){define(["exports","./AlignPixel.glsl","../../shaderModules/Float4BindUniform","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../shaderModules/Texture2DBindUniform"],function(e,t,r,i,s,n){"use strict";e.HUDVisibility=function(e){e.vertex.uniforms.add(new i.FloatBindUniform("renderTransparentlyOccludedHUD",e=>0===e.hudRenderStyle?1:1===e.hudRenderStyle?0:.75),new r.Float4BindUniform("viewport",e=>e.camera.fullViewport),new n.Texture2DBindUniform("hudVisibilityTexture",e=>e.hudVisibility?.getTexture())),e.vertex.include(t.AlignPixel),e.vertex.code.add(s.glsl`bool testHUDVisibility(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl":function(){define(["exports","../HighlightReadBitmap.glsl","../../shaderModules/glsl","../../shaderModules/Integer2BindUniform","../../shaderModules/IntegerBindUniform","../../shaderModules/Texture2DBindUniform","../../shaderModules/Texture2DUintBindUniform"],function(e,t,r,i,s,n,o){"use strict";e.OutputHighlight=function(e,a){const{fragment:l}=e,{output:c,draped:u,hasHighlightMixTexture:d}=a;8===c?(l.uniforms.add(new s.IntegerBindUniform("highlightLevel",e=>e.highlightLevel??0),new i.Integer2BindUniform("highlightMixOrigin",e=>e.highlightMixOrigin)),e.outputs.add("fragHighlight","uvec2",0),e.include(t.HighlightReadBitmap),d?l.uniforms.add(new o.Texture2DUintBindUniform("highlightMixTexture",e=>e.highlightMixTexture)).code.add(r.glsl`uvec2 getAccumulatedHighlight() {
return texelFetch(highlightMixTexture, ivec2(gl_FragCoord.xy) - highlightMixOrigin, 0).rg;
}
void outputHighlight(bool occluded) {
if (highlightLevel == 0) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
} else {
int ll = (highlightLevel & 3) << 1;
int li = (highlightLevel >> 2) & 3;
uint bits;
if (occluded) {
bits = 3u << ll;
} else {
bits = 1u << ll;
}
uvec2 combinedHighlight = getAccumulatedHighlight();
combinedHighlight[li] |= bits;
fragHighlight = combinedHighlight;
}
}`):l.code.add(r.glsl`void outputHighlight(bool occluded) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
}`),u?l.code.add(r.glsl`bool isHighlightOccluded() {
return false;
}`):l.uniforms.add(new n.Texture2DBindUniform("depthTexture",e=>e.mainDepth)).code.add(r.glsl`bool isHighlightOccluded() {
float sceneDepth = texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x;
return gl_FragCoord.z > sceneDepth + 5e-7;
}`),l.code.add(r.glsl`void calculateOcclusionAndOutputHighlight() {
outputHighlight(isHighlightOccluded());
}`)):l.code.add(r.glsl`void calculateOcclusionAndOutputHighlight() {}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/HighlightReadBitmap.glsl":function(){define(["exports","../shaderModules/glsl"],function(e,t){"use strict";e.HighlightReadBitmap=function(e){const{fragment:r}=e;r.code.add(t.glsl`uint readChannelBits(uint channel, int highlightLevel) {
int llc = (highlightLevel & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(uvec2 texel, int highlightLevel) {
int lic = (highlightLevel >> 2) & 1;
return texel[lic];
}
uint readLevelBits(uvec2 texel, int highlightLevel) {
return readChannelBits(readChannel(texel, highlightLevel), highlightLevel);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Integer2BindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"ivec2",0,(r,i)=>r.setUniform2iv(e,t(i)))}}e.Integer2BindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/IntegerBindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"int",0,(r,i)=>r.setUniform1i(e,t(i)))}}e.IntegerBindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DUintBindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"usampler2D",0,(r,i)=>r.bindTexture(e,t(i)))}}e.Texture2DUintBindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/VisualVariables.glsl":function(){define(["exports","../attributes/MaskedColor.glsl","../../shaderModules/Float3PassUniform","../../shaderModules/Float4PassUniform","../../shaderModules/Float4sPassUniform","../../shaderModules/FloatsPassUniform","../../shaderModules/glsl","../../shaderModules/Matrix3PassUniform","../../../materials/VisualVariablePassParameters"],function(e,t,r,i,s,n,o,a,l){"use strict";e.VisualVariables=function(e,c){const{vertex:u,attributes:d}=e;c.hasVVInstancing&&(c.hasVVSize||c.hasVVColor)&&d.add("instanceFeatureAttribute","vec4"),c.hasVVSize?(u.uniforms.add(new r.Float3PassUniform("vvSizeMinSize",e=>e.vvSize.minSize)),u.uniforms.add(new r.Float3PassUniform("vvSizeMaxSize",e=>e.vvSize.maxSize)),u.uniforms.add(new r.Float3PassUniform("vvSizeOffset",e=>e.vvSize.offset)),u.uniforms.add(new r.Float3PassUniform("vvSizeFactor",e=>e.vvSize.factor)),u.uniforms.add(new r.Float3PassUniform("vvSizeFallback",e=>e.vvSize.fallback)),u.uniforms.add(new a.Matrix3PassUniform("vvSymbolRotationMatrix",e=>e.vvSymbolRotationMatrix)),u.uniforms.add(new r.Float3PassUniform("vvSymbolAnchor",e=>e.vvSymbolAnchor)),u.code.add(o.glsl`vec3 vvScale(vec4 _featureAttribute) {
if (isnan(_featureAttribute.x)) {
return vvSizeFallback;
}
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),u.code.add(o.glsl`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 scale = max(vvScale(_featureAttribute), eps);
        return vec4(vvSymbolRotationMatrix * _normal / scale, 1.0);
      }

      ${c.hasVVInstancing?o.glsl`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):u.code.add(o.glsl`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),e.vertex.include(t.MaskedColorDefinition),c.hasVVColor?(u.constants.add("vvColorNumber","int",l.vvColorNumber),u.uniforms.add(new n.FloatsPassUniform("vvColorValues",e=>e.vvColor.values,l.vvColorNumber),new s.Float4sPassUniform("vvColorColors",e=>e.vvColor.colors,l.vvColorNumber),new i.Float4PassUniform("vvColorFallback",e=>e.vvColor.fallback,{supportsNaN:!0})),c.hasVVInstancing&&(e.vertex.include(t.MultiplyMaskedColors),e.vertex.include(t.CreateMaskedFromNaNColor)),u.code.add(o.glsl`
      vec4 interpolateVVColor(float value) {
        if (isnan(value)) {
          return vvColorFallback;
        }

        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${c.hasVVInstancing?o.glsl`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return multiplyMaskedColors(color, createMaskedFromNaNColor(vvColor()));
            }
            `:o.glsl`
            vec4 vvColor() {
              return vec4(1.0);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return color;
            }
            `}
    `)):u.code.add(o.glsl`vec4 vvColor() {
return vec4(1.0);
}
MaskedColor applyVVColor(MaskedColor color) {
return color;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/MaskedColor.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";function r(e){e.code.add(t.glsl`struct MaskedColor {
vec4 color;
bvec4 mask;
};`)}e.CreateMaskedFromNaNColor=function(e){e.include(r),e.code.add(t.glsl`MaskedColor createMaskedFromNaNColor(vec4 color) {
return MaskedColor(color, isnan(color));
}`)},e.CreateMaskedFromUInt8NaNColor=function(e){e.include(r),e.code.add(t.glsl`
    MaskedColor createMaskedFromUInt8NaNColor(vec4 color) {
      return MaskedColor(color * ${t.glsl.float(1/254)}, equal(color, vec4(255)));
    }
  `)},e.MaskedColorDefinition=r,e.MultiplyMaskedColors=function(e){e.include(r),e.code.add(t.glsl`MaskedColor multiplyMaskedColors(MaskedColor color1, MaskedColor color2) {
vec4 masked1 = mix(color1.color, vec4(1), color1.mask);
vec4 masked2 = mix(color2.color, vec4(1), color2.mask);
return MaskedColor(masked1 * masked2, bvec4(ivec4(color1.mask) & ivec4(color2.mask)));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Float4sPassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r,i){super(e,"vec4",1,(r,s,n)=>r.setUniform4fv(e,t(s,n),i),r)}}e.Float4sPassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/FloatsPassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r,i){super(e,"float",1,(r,s,n)=>r.setUniform1fv(e,t(s,n),i),r)}}e.FloatsPassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/VisualVariablePassParameters":function(){define(["exports","../../layers/support/FastSymbolUpdates"],function(e,t){"use strict";class r extends t.VisualVariablesParameters{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1}}e.VisualVariablePassParameters=r,e.vvColorNumber=8,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.ColorConversion=function(e){e.code.add(t.glsl`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.RgbaFloatEncoding=function(e){e.code.add(t.glsl`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}`),e.code.add(t.glsl`const vec4 RGBA_TO_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgbaTofloat(vec4 rgba) {
return dot(rgba, RGBA_TO_FLOAT_FACTORS);
}`),e.code.add(t.glsl`const vec4 uninterpolatedRGBAToFloatFactors = vec4(
1.0 / 256.0,
1.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0 / 256.0
);
float uninterpolatedRGBAToFloat(vec4 rgba) {
return (dot(round(rgba * 255.0), uninterpolatedRGBAToFloatFactors) - 0.5) * 2.0;
}`),e.code.add(t.glsl`const vec3 uninterpolatedRGBToFloatFactors = vec3(
1.0 / 256.0,
1.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0
);
float uninterpolatedRGBToFloat(vec3 rgb) {
return (dot(round(rgb * 255.0), uninterpolatedRGBToFloatFactors) - 0.5) * 2.0;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Float4DrawUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"vec4",2,(i,s,n)=>i.setUniform4fv(e,t(s,n),r))}}e.Float4DrawUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/webscene/support/AlphaCutoff":function(){define(["exports"],function(e){"use strict";e.alphaCutoff=1/255.5,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/HUDMaterialTechnique":function(){define(["require","exports","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../effects/geometry/olidUtils","../lib/OrderIndependentTransparency","../../../../chunks/HUDMaterial.glsl","../../../webgl/enums","../../../webgl/renderState"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";class d extends n.ShaderTechnique{constructor(t,r){super(t,r,new s.ReloadableShaderModule(l.HUDMaterial,()=>new Promise((t,r)=>e(["./HUDMaterial.glsl"],t,r))),(o.olidEnabled()?f:p).locations),this.primitiveType=r.occlusionPass?c.PrimitiveType.POINTS:c.PrimitiveType.TRIANGLES}initializePipeline(e){const{oitPass:t,hasPolygonOffset:r,draped:s,output:n,depthTestEnabled:o,occlusionPass:l}=e,c=0===t,d=o&&!s&&!(1===t)&&!l&&!(8===n);return u.makePipelineState({blending:i.isColorOrColorEmission(n)?c?u.premultipliedAlpha:a.oitBlending(t):null,depthTest:o&&!s?{func:515}:null,depthWrite:d?u.defaultDepthWrite:null,drawBuffers:a.getDrawBuffers(t,n),colorWrite:u.defaultColorWrite,polygonOffset:r?h:null})}}const h={factor:0,units:-4},p=r.newLayout().vec3f("position").vec3f("normal").vec2i16("uvi").vec4u8("color").vec2f("size").f32("rotation").vec4f("centerOffsetAndDistance").vec4f("featureAttribute"),f=p.clone().vec4u8("olidColor");t.HUDMaterialTechnique=d,t.layout=p,t.olidLayout=f,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/OrderIndependentTransparency":function(){define(["exports","../core/shaderLibrary/ShaderOutput","../../../webgl/enums","../../../webgl/renderState"],function(e,t,r,i){"use strict";const s=i.separateBlendingParams(1,0,1,771),n={factor:-1,units:-2};e.OITPolygonOffset=n,e.OITPolygonOffsetLimit=5e5,e.blending=function(e){switch(e){case 0:return i.unpremultipliedAlphaToPremultipliedAlpha;case 1:return s;case 2:case 3:return null}},e.blendingColorAlpha=s,e.depthWrite=function(e){if(e.draped)return null;switch(e.oitPass){case 0:case 2:return e.writeDepth?i.defaultDepthWrite:null;case 1:case 3:return null}},e.getDrawBuffers=function(e,i){const s=t.isColorEmission(i);return 1===e?s?{buffers:[r.ColorAttachment0,r.ColorAttachment1,r.ColorAttachment2]}:{buffers:[r.ColorAttachment0,r.ColorAttachment1]}:s?{buffers:[r.ColorAttachment0,r.ColorAttachment1]}:null},e.oitBlending=function(e){return 2===e?null:s},e.oitDepthTest=function(e,t=513){return 0===e||2===e?t:515},e.oitPolygonOffset=function({oitPass:e,enableOffset:t}){return t&&1===e?n:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/HUDMaterialTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hasRotation=!1,this.debugDrawLabelBorder=!1,this.hasPolygonOffset=!1,this.depthTestEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.occlusionPass=!1,this.occludedFragmentFade=!1,this.horizonCullingEnabled=!0,this.isFocused=!0,this.olidColorInstanced=!1,this.textureCoordinateType=0,this.emissionSource=0,this.discardInvisibleFragments=!0,this.hasVVInstancing=!1,this.snowCover=!1}}t.__decorate([r.parameter()],s.prototype,"screenCenterOffsetUnitsEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"occlusionTestEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"signedDistanceFieldEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),t.__decorate([r.parameter()],s.prototype,"hasVVSize",void 0),t.__decorate([r.parameter()],s.prototype,"hasVVColor",void 0),t.__decorate([r.parameter()],s.prototype,"hasVerticalOffset",void 0),t.__decorate([r.parameter()],s.prototype,"hasScreenSizePerspective",void 0),t.__decorate([r.parameter()],s.prototype,"hasRotation",void 0),t.__decorate([r.parameter()],s.prototype,"debugDrawLabelBorder",void 0),t.__decorate([r.parameter()],s.prototype,"hasPolygonOffset",void 0),t.__decorate([r.parameter()],s.prototype,"depthTestEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"pixelSnappingEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"draped",void 0),t.__decorate([r.parameter()],s.prototype,"terrainDepthTest",void 0),t.__decorate([r.parameter()],s.prototype,"cullAboveTerrain",void 0),t.__decorate([r.parameter()],s.prototype,"occlusionPass",void 0),t.__decorate([r.parameter()],s.prototype,"occludedFragmentFade",void 0),t.__decorate([r.parameter()],s.prototype,"horizonCullingEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"isFocused",void 0),e.HUDMaterialTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/LabelDeconflictor":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./Deconflictor","../../../support/Yield"],function(e,t,r,i,s,n,o,a,l){"use strict";e.LabelDeconflictor=class extends a.Deconflictor{constructor(e){super(e),this.visibilityGroup=16,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.readyToRun)return l.Yield;const t=performance.now();if(2!==this.view.state.mode&&t-this._lastDeconfliction<2e3)return l.Yield;const r=super.runTask(e);return 0===this.state&&(this._lastDeconfliction=t),r}},t.__decorate([r.property({constructOnly:!0})],e.LabelDeconflictor.prototype,"parent",void 0),e.LabelDeconflictor=t.__decorate([o.subclass("esri.views.3d.layers.graphics.LabelDeconflictor")],e.LabelDeconflictor),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Labeler":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../layers/graphics/hydratedFeatures","../../../../layers/support/labelFormatUtils","../../../../symbols/callouts/calloutUtils","./Graphics3DCalloutSymbolLayerFactory","./Graphics3DLineCalloutSymbolLayer","./graphicSymbolUtils","./LabelInfo","./LabelParameters","./placementUtils","./pointUtils","../../webgl-engine/lib/TextRenderer","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureAtlas","../../webgl-engine/lib/WebGLLayer","../../../support/layerViewUtils","../../../support/Scheduler","../../../support/Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O){"use strict";class I{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.textureAtlasHandles=[],this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class F{constructor(e,t,r,i,s){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=r,this.textRenderParameters=i,this.labelFunction=s,this.calloutSymbolLayerIndex=0,this.graphics=new Map,this.scaleVisibility=null}}class A{constructor(e,t,r,i,s,n,o,a){this.layer=t,this.graphics3DCore=r,this.scaleVisibility=i,this.emptySymbolLabelSupported=s,this.elevationInfoOverride=n,this.disablePlacement=o,this.active=a,this.labelClassAbortController=new AbortController,this._labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new P.WebGLLayer(e,{pickable:!0},r.owner.layerViewUid)}destroy(){this.stageLayer.destroy()}get labelClassContexts(){return this._labelClassContexts}setLabelClassContext(e,t){this._labelClassContexts[e]=t}resetLabelClassContext(){this._labelClassContexts.length=0}}function D(e,t){e.geometries[0].setAttributeData("size",[t.displayWidth,t.displayHeight]),e.geometryVertexAttributeUpdated(e.geometries[0],"size")}function E(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function L(e){return!e||0===e.length}function V(e){return"label-3d"===e.symbol?.type?e.symbol:null}function U(e){return!!e.labelsVisible&&!!e.labelingInfo?.some(e=>!!e.symbol)}e.Labeler=class extends r{constructor(e){super(e),this._hudMaterials=new Map,this._calloutMaterials=new Map,this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([l.watch(()=>this.view.state?.camera,()=>this.setDirty()),l.watch(()=>this.view.state?.rasterPixelRatio,()=>this._resetAllLabels()),l.watch(()=>this.view.focusAreasView?.polygons,()=>this._updateFocus()),this.view.resourceController.scheduler.registerTask(R.TaskPriority.LABELER,this)]),M.hasLayerBasedScaleVisibility()&&this.addHandles(l.watch(()=>this.view.scale,()=>this._updateScaleVisibility())),this._textTextureAtlas=new C.TextTextureAtlas({view:this.view})}dispose(){this.removeAllHandles(),this._textTextureAtlas=o.disposeMaybe(this._textTextureAtlas),this._hudMaterials.clear(),this._calloutMaterials.clear(),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),B.graphic=null,B.renderingInfo=null,B.layer=null}_updateFocus(){this._labelingContexts.forEach(e=>{e.graphics.forEach(t=>{if(0===t.labelLayers.length)return;const r=x.placePointOnGeometry(t.graphic.geometry);if(null==r)return;const i=this.view.focusAreasView?.containsGeometry(r)??!0;t.labelLayers.forEach(r=>{r.stageObject.geometries.some(e=>e.material.parameters.isFocused!==i)&&(this._removeGraphic(e,t),this._addGraphic(e,t),this.setDirty())})})})}_activateLabelingContext(e){e.graphics.forEach((t,r)=>{const i=new I(e,t);this._labels.set(r,i),e.labelsToInitialize.set(r,i),t.setVisibilityFlag(16,1,!0)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((e,t)=>{e.setVisibilityFlag(16,1,!1),this.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),this._labels.delete(t)}),e.active=!1}_addLabelTextureToAtlas(e){if(this._textTextureAtlas)for(const t of e.graphics3DGraphic.labelLayers){if(!t.labelClass)continue;const r=e.textRenderers[t.labelClassContextIndex];r&&(e.textureAtlasHandles.push(this._textTextureAtlas.addText(r,e=>{return i=e,(r=t.stageObject).geometries[0].setAttributeData("uvi",i),void r.geometryVertexAttributeUpdated(r.geometries[0],"uvi",!0);var r,i})),D(t.stageObject,r))}}_removeLabelTextureFromAtlas(e){e.textureAtlasHandles.forEach(e=>e.remove()),e.textureAtlasHandles.length=0}get readyToRun(){return this.view.ready&&(this._dirty||this.deconflictor.readyToRun)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.readyToRun&&this.deconflictor.runTask(e),O.Yield}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(E(t))this._dirty=!0;else if(L(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else for(const[r,i]of t.labelsToInitialize)if(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done){this._dirty=!0;break}this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;e.layer.when&&await e.layer.when(),a.throwIfAborted(t),e.scaleVisibility?.updateScaleRangeActive();const r=e.graphics3DCore,s=r.layer,o=s.labelingInfo?.filter(e=>!!e.symbol);if(!o||0===o.length)return;let l=!1;await i.forEach(o,async(s,o)=>{const c=s.symbol,u=_.getGraphics3DSymbol(r.getOrCreateGraphics3DSymbol(c));if(null==u)return void n.getLogger(this).error("Failed to create Graphics3DSymbol for label");await u.load(),a.throwIfAborted(t);let d=null;m.hasCalloutSupport(c)&&c.hasVisibleCallout()&&(d=g.make(c,r.symbolCreationContext),await d.load(),a.throwIfAborted(t));const h=await i.result(f.createLabelFunction(s,e.layer.fieldsIndex,this.view.spatialReference));if(a.throwIfAborted(t),!0===h.ok){const r=await this._createTextRenderParameters(u.symbol);a.throwIfAborted(t);const i=new F(s,u,d,r,h.value);this._updateLabelClassContextVisibility(i),e.setLabelClassContext(o,i)}else n.getLogger(this).error(`Label expression failed to evaluate: ${h.error}`),l=!0}),a.throwIfAborted(t)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(a.isAbortError(t))throw t;e.resetLabelClassContext()}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==t?.type?null:T.TextRenderParameters.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,o.abortMaybe(t),e.resetLabelClassContext(),e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,r,i,s,n){if(!this._textTextureAtlas)return null;const o=new v.LabelParameters(r,w.horizontalPlacementFromAnchor(r.anchor),w.verticalPlacementFromAnchor(r.anchor),e.text,h.fromValues(e.displayWidth,e.displayHeight));return B.graphic=t,B.layer=i,B.renderingInfo=null,s.createLabel(B,o,this._hudMaterials,this._textTextureAtlas,()=>n.placement?.elevationOffset??null)}_createLineCalloutGraphic(e,t,r,i,s){B.graphic=e,B.layer=s;const n=i.screenOffset[0];return B.renderingInfo=new y.LineCalloutSymbolLayerRenderingInfo(null,t,i.translation,i.centerOffset,n,i.centerOffsetUnits,i.elevationOffset),r.createGraphics3DGraphic(B,this._calloutMaterials)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const r=e.labelingContext,i=r.labelClassContexts;if(L(i)||!r.emptySymbolLabelSupported&&0===t.layers.length)return!1;let s=!1;const n=t.graphic,o=r.layer,a=U(r.layer);for(let l=0;l<i.length;l++){const c=e.textRenderers[l],u=e.textLabelPlacements[l];if(null==c||null==u)continue;const d=i[l],h=d.graphics3DSymbol,p=V(h),f=h.symbolLayers[0];if(!f)continue;f.setElevationInfoOverride(r.elevationInfoOverride);const m=new b.LabelInfo(t,p,d.labelClass),g=this._createTextSymbolGraphic(c,n,u,o,f,m);if(null==g)return!1;g.labelClass=d.labelClass,g.labelClassContextIndex=l,t.addLabelGraphic(g,r.stageLayer),this.deconflictor.setPriority(t,d.textRenderParameters?.definition.size??0),t.setVisibilityFlag(16,1,a),t.setVisibilityFlag(16,2,d.scaleVisibility??!0),t.setVisibilityFlag(16,8,!1),M.hasLayerBasedScaleVisibility()&&d.graphics.set(n.uid,t),s=!0;const y=d.graphics3DCalloutSymbolLayer;if(y&&u.hasLabelVerticalOffset){y.setElevationInfoOverride(r.elevationInfoOverride);const e=this._createLineCalloutGraphic(n,p,y,u,o);null!=e&&(d.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,r.stageLayer))}break}return s&&r.scaleVisibility?.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const r of e.graphics3DGraphic.labelLayers){if(null==r.labelClass)continue;const e=t[r.labelClassContextIndex].graphics3DSymbol.symbolLayers[0];e?.onRemoveGraphic(r)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,r=t.labelClassContexts;if(L(r))return;const i=e.graphics3DGraphic.graphic;for(let s=0;s<r.length;s++){const n=r[s];if(e.textRenderers[s]=null,e.textLabelPlacements[s]=null,null==n?.textRenderParameters)continue;const o=n.labelFunction;let a;if("arcade"===o.type)try{const e=o.needsHydrationToEvaluate()?p.hydrateGraphic(i,t.layer):i;a=o.evaluate(e)}catch(e){a=null}else a=o.evaluate(i);if(null==a||""===a||/^\s+$/.test(a))continue;const l=n.graphics3DSymbol;if(!l.symbolLayers[0])continue;const c=e.graphics3DGraphic,u="label-3d"===l.symbol?.type?l.symbol:null,d=n.labelClass,h=t.disablePlacement,f=new b.LabelInfo(c,u,d,h).placement;if(null==f)continue;const m=w.horizontalPlacementFromAnchor(f.anchor),g=w.textRenderAlignmentFromHorizontalPlacement(m);e.textRenderers[s]=new S.TextRenderer(a,g,n.textRenderParameters,C.TextTextureAtlas.maxSize),e.textLabelPlacements[s]=f}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const r=t.graphic.uid;if(e.graphics.set(r,t),e.active){const i=new I(e,t);this._labels.set(r,i),e.labelsToInitialize.set(r,i)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const r=t.graphic.uid,i=this._labels.get(r);if(!i)return!0;for(const r of i.graphics3DGraphic.labelLayers)if(null!=r.labelClass&&!e.labelClassContexts[r.labelClassContextIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(r,t.graphic.geometry))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const r=t.graphic.uid,i=this._labels.get(r);e.graphics.delete(r),e.labelClassContexts.forEach(e=>e.graphics.delete(r)),i&&(this._destroyGraphic(i,r),e.labelsToInitialize.delete(r),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const r of t){const t=e.graphics.get(r);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const r of t.labelClassContexts){const i=new Map;t.graphics.forEach(e=>i.set(e.graphic.uid,e));const s=e=>e.labelLayers[0];if(r.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,i,s),r.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[r.calloutSymbolLayerIndex];r.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,i,t)}}}_visibilityInfoChange(e){const t=U(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((t,r)=>{const i=this._labels.get(r);i&&(this._destroyGraphic(i,r),i.visible=!1,e.labelsToInitialize.set(r,i))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,r){const i=r?.emptySymbolLabelSupported||!1,s=r?.elevationInfoOverride||null,n=r?.disablePlacement||null;if(this._findLabelingContext(e))return;const o=e.layer,a=new A(this.view.stage,o,e,t,i,s,n,U(o));return this._labelingContexts.push(a),this.setDirty(),{addGraphic:e=>this._addGraphic(a,e),removeGraphic:e=>this._removeGraphic(a,e),updateGraphicGeometry:e=>this._updateGraphicGeometry(a,e),layerLabelsEnabled:()=>U(a.layer),labelingInfoChange:e=>this._labelingInfoChange(a,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",a),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",a),visibilityInfoChange:()=>this._visibilityInfoChange(a),reset:()=>this._resetLabels(a),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const r=this._labelingContexts.indexOf(t);this._labelingContexts.splice(r,1),t.graphics.forEach(e=>this._removeGraphic(t,e)),t.destroy(),this.setDirty()}_updateScaleVisibility(){for(const e of this._labelingContexts)if(e.active&&!E(e))for(const t of e.labelClassContexts)this._updateLabelClassContextVisibility(t)}_updateLabelClassContextVisibility(e){if(!M.hasLayerBasedScaleVisibility())return;const{labelClass:t,graphics:r}=e,i={minScale:t.minScale,maxScale:t.maxScale},s=M.isInEffectiveScaleRange(i,this.view.scale),n=null==e.scaleVisibility||e.scaleVisibility!==s;e.scaleVisibility=s,n&&r.size&&(r.forEach(e=>e.setVisibilityFlag(16,2,s)),this.deconflictor.setDirty(),this.setDirty())}setLabelGraphicVisibility(e,t){const r=e.graphic.uid,i=this._labels.get(r);i&&i.visible!==t&&(t&&!i.textureAtlasHandles.length?(this._addLabelTextureToAtlas(i),i.textInitialized||i.labelingContext.labelsToInitialize.set(r,i)):!t&&i.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(i),i.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some(e=>E(e))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((e,t)=>e+(E(t)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get usedMemory(){return this._textTextureAtlas?.usedMemory??0}get test(){}},t.__decorate([c.property({constructOnly:!0})],e.Labeler.prototype,"view",void 0),t.__decorate([c.property({constructOnly:!0})],e.Labeler.prototype,"deconflictor",void 0),t.__decorate([c.property()],e.Labeler.prototype,"_textTextureAtlas",void 0),t.__decorate([c.property({type:Boolean,readOnly:!0})],e.Labeler.prototype,"updating",null),e.Labeler=t.__decorate([d.subclass("esri.views.3d.layers.graphics.Labeler")],e.Labeler);const B=new y.LineCalloutCreationContext(null,null,null);e.areLabelsVisible=U,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/hydratedFeatures":function(){define(["exports","../../Graphic","../../core/has","../../core/lang","../../core/typedArrayUtil","../../geometry/SpatialReference","../../geometry/support/jsonUtils","./dehydratedPoint"],function(e,t,r,i,s,n,o,a){"use strict";function l(e){return"declaredClass"in e}function c(e){return"declaredClass"in e}function u(e){return"declaredClass"in e}function d(e){return null==e?null:l(e)?e:o.fromJSON(function(e){const{wkid:t,wkt:r,wkt2:i,latestWkid:s}=e.spatialReference,n={wkid:t,wkt:r,wkt2:i,latestWkid:s};switch(e.type){case"point":{const{x:t,y:r,z:i,m:s}=e;return{x:t,y:r,z:i,m:s,spatialReference:n}}case"polygon":{const{rings:t,hasZ:r,hasM:i}=e;return{rings:h(t),hasZ:r,hasM:i,spatialReference:n}}case"polyline":{const{paths:t,hasZ:r,hasM:i}=e;return{paths:h(t),hasZ:r,hasM:i,spatialReference:n}}case"extent":{const{xmin:t,xmax:r,ymin:i,ymax:s,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:u,hasM:d}=e;return{xmin:t,xmax:r,ymin:i,ymax:s,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:u,hasM:d,spatialReference:n}}case"multipoint":{const{points:t,hasZ:r,hasM:i}=e;return{points:f(t)?p(t):t,hasZ:r,hasM:i,spatialReference:n}}default:return}}(e))}function h(e){return function(e){for(const t of e)if(0!==t.length)return f(t);return!1}(e)?e.map(e=>p(e)):e}function p(e){return e.map(e=>Array.from(e))}function f(e){return e.length>0&&(s.isFloat32Array(e[0])||s.isFloat64Array(e[0]))}e.clonePoint=function(e,t){if(!e)return null;let r;if(c(e)){if(null==t)return e.clone();if(c(t))return t.copy(e)}return null!=t?(r=t,r.x=e.x,r.y=e.y,r.spatialReference=e.spatialReference,e.hasZ?(r.z=e.z,r.hasZ=e.hasZ):(r.z=void 0,r.hasZ=!1),e.hasM?(r.m=e.m,r.hasM=!0):(r.m=void 0,r.hasM=!1)):(r=a.makeDehydratedPoint(e.x,e.y,e.z,e.spatialReference),e.hasM&&(r.m=e.m,r.hasM=!0)),r},e.hydrateGeometry=d,e.hydrateGraphic=function(e,r){return e?u(e)?e:new t({layer:r,sourceLayer:r,visible:e.visible,symbol:i.clone(e.symbol),attributes:i.clone(e.attributes),geometry:d(e.geometry)}):null},e.hydratedSpatialReference=function(e){const{wkid:t,wkt:r,wkt2:i,latestWkid:s}=e,o={wkid:t,wkt:r,wkt2:i,latestWkid:s};return n.fromJSON(o)},e.isHydratedGeometry=l,e.isHydratedGraphic=u,e.isHydratedPoint=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/labelFormatUtils":function(){define(["exports","../../core/Error","../../core/Logger","../../core/sql","../../intl/date","../../intl/number","./domainUtils","./fieldUtils","./labelUtils","../../support/ArcadeExpression","../../support/arcadeExpressionUtils"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=()=>r.getLogger("esri.layers.support.labelFormatUtils"),h={type:"simple",evaluate:()=>null},p={getAttribute:(e,t)=>e.field(t)};function f(e,t){if(null==e)return"";const r=t.domain;if(r)if("codedValue"===r.type||"coded-value"===r.type){const t=e;for(const e of r.codedValues)if(e.code===t)return e.name}else if("range"===r.type){const{max:i,min:s}=o.getDomainRange(t),n=+e;if(null!=s&&null!=i&&s<=n&&n<=i)return r.name}let i=e;return a.isDateField(t)?i=s.formatDate(i,s.convertDateFormatToIntlOptions("short-date")):a.isNumericField(t)&&(i=n.formatNumber(+i)),i||""}e.createLabelFunction=async function(e,r,s){if(!e||!e.symbol||!r)return h;const n=e.where,o=l.getLabelExpression(e);let m;if("arcade"===o.type){const e=u.getFieldNameFromSimpleExpression(o.expression),i=r.get(e);if(i&&(a.isIntegerField(i)||a.isNumericField(i)||a.isStringField(i)))m={type:"simple",evaluate(e){const t="attributes"in e?e.attributes?.[i.name]:e.field(i.name);return null==t?"":t.toString()}};else{const e=await c.createLabelExpression(o.expression,s);if(null==e)return h;m={type:"arcade",evaluate(i,s){try{const t="attributes"in i?e.repurposeFeature(i,r):i;t.contextTimeZone=s??null;const n=e.evaluate(t,{$view:{timeZone:s}});if(null!=n)return n.toString()}catch(e){d().error(new t("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:e,feature:i,expression:o}))}return null},needsHydrationToEvaluate:()=>null==l.getSingleFieldArcadeExpression(o.expression)}}}else m={type:"simple",evaluate:e=>o.expression.replaceAll(/{[^}]*}/g,t=>{const i=t.slice(1,-1),s=r.get(i);if(!s)return t;let n=null;return n="attributes"in e?e?.attributes?.[s.name]:e.field(s.name),null==n?"":f(n,s)})};if(n){let e;try{e=await i.parseWhereClause(n,r)}catch(e){return d().error(new t("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:n,error:e})),h}const s=m.evaluate;m.evaluate=(r,i)=>{const o="attributes"in r?void 0:p;try{if(e.testFeature(r,o))return s(r,i)}catch(e){d().error(new t("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:n,feature:r,error:e}))}return null}}return m},e.formatField=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DCalloutSymbolLayerFactory":function(){define(["exports","../../../../core/Logger","../../../../symbols/callouts/calloutUtils","./Graphics3DLineCalloutSymbolLayer"],function(e,t,r,i){"use strict";const s=()=>t.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory"),n={line:i.Graphics3DLineCalloutSymbolLayer};e.make=function(e,t){if(!r.hasCalloutSupport(e))return s().error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=n[e.callout.type];return i?new i(e,t):(s().error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DLineCalloutSymbolLayer":function(){define(["exports","../../../../Color","../../../../core/has","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../renderers/support/RenderingInfo","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DGraphicCreationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DObjectMetadata","./Graphics3DSymbolLayer","./graphicUtils","./pointUtils","./SymbolComplexity","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/Geometry","../../webgl-engine/materials/LineCalloutMaterial"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v){"use strict";class w extends f.Graphics3DSymbolLayer{static{this.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:1,onTheGroundChanged:2}}constructor(e,t){super(e,null,t,T),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new v.LineCalloutMaterial(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const e=new v.Parameters,s=this.symbol,o=s.callout;if(o.color){const r=t.toUnitRGBA(o.color);r[3]*=this._getLayerOpacity(),e.color=r}else e.color=n.ZEROS;if(e.size=i.pt2px(o.size||0),s.verticalOffset){const{screenLength:t,minWorldLength:r,maxWorldLength:n}=s.verticalOffset;e.verticalOffset={screenLength:i.pt2px(t),minWorldLength:r||0,maxWorldLength:null!=n?n:1/0}}e.borderColor=null!=o.border?.color?t.toUnitRGBA(o.border.color):null;const a="object"===s.symbolLayers.at(0).type,l="label-3d"===s.type;return e.occlusionTest=!a&&!!r("disable-feature:non-occluded-hud"),a&&(e.shaderPolygonOffset=0),e.hudDepthAlignStart=l,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return S}createGraphics3DGraphic(e,t){const r=e.renderingInfo,i=e.graphic,s=this.setGraphicElevationContext(i,new u.ElevationContext,r.elevationOffset||0),n=r.symbol,o="on-the-ground"===this._elevationContext.mode&&("cim"===n.type||!n.symbolLayers.some(e=>"object"===e.type||"text"===e.type));if("label-3d"!==n.type&&o)return null;if("point-3d"===n.type&&n.symbolLayers.every(e=>"text"===e.type&&!a.textSymbolLayerSupportsVerticalOffset(e)))return null;const l=m.computeCentroid(i.geometry);return null==l?null:this._createAs3DShape(l,s,r,i.uid,t)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,r){const i=this._elevationContext.mode,s=c.elevationModeChangeUpdateType(w.elevationModeChangeTypes,r,i);return 1!==s||e?.forEach(e=>{const r=t(e);null!=r&&this.updateGraphicElevationContext(e.graphic,r)}),s}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t,r=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(r),t}updateGraphicElevationContext(e,t){const{elevationContext:r,metadata:i}=t;this.setGraphicElevationContext(e,r,i?.elevationOffset??0),t.needsElevationUpdates=c.needsElevationUpdates2D(r.mode)}computeComplexity(){return new y.SymbolComplexity({verticesPerFeature:6})}_getOrCreateMaterial(e,t){const r=this._perInstanceMaterialParameters(e),i=v.uniqueMaterialIdentifier(r);if(i===this._materials[0]?.uniqueMaterialIdentifier)return this._materials[0];if(t){let e=t.get(i);return null==e&&(e=new v.LineCalloutMaterial(r,this._context.spherical),t.set(i,e)),e}return new v.LineCalloutMaterial(r,this._context.spherical)}_createAs3DShape(e,t,r,i,s){const n=this._context.layerViewUid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:n}),a=this._getOrCreateMaterial(r,s),u=new b.Geometry(a,function(e){const{translation:t,centerOffset:r}=e,i=t?new _.Attribute([t[0],t[1],t[2]],x,3,!0):new _.Attribute([0,0,0],x,3,!0),s=r?new _.Attribute([r[0],r[1],r[2],r[3]],x,4,!0):new _.Attribute([0,0,0,1],x,4,!0);return[["position",i],["normal",new _.Attribute([0,0,1],x,3,!0)],["centerOffsetAndDistance",s]]}(r),null,1,o),d=g.createStageObject(this._context,e,u,t,i);if(null==d)return null;const f=new h.Graphics3DObject3DGraphicLayer(this,d.object,null,l.perObjectElevationAligner,t);return f.metadata=new p.Graphics3DObjectMetadata(r.elevationOffset),f.alignedSampledElevation=d.sampledElevation,f.needsElevationUpdates=c.needsElevationUpdates2D(t.mode),g.extendPointGraphicElevationContext(f,e,this._context.elevationProvider),f}}const x=[0],S={mode:"relative-to-ground",offset:0},T={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class C extends o.RenderingInfo{constructor(e,t,r=s.create(),i=n.create(),o=0,a="world",l=0){super(e,t),this.translation=r,this.centerOffset=i,this.horizontalScreenOffset=o,this.centerOffsetUnits=a,this.elevationOffset=l}}class P extends d.Graphics3DGraphicCreationContext{}e.Graphics3DLineCalloutSymbolLayer=w,e.LineCalloutCreationContext=P,e.LineCalloutSymbolLayerRenderingInfo=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/renderers/support/RenderingInfo":function(){define(["exports"],function(e){"use strict";e.RenderingInfo=class{constructor(e,t){this.renderer=e,this.symbol=t,this.color=null,this.size=null,this.opacity=null,this.outlineSize=null,this.heading=null,this.tilt=null,this.roll=null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/ElevationAligners":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../geometry/projection/projectBuffer","./elevationAlignmentUtils","../../support/debugFlags","../../support/ElevationProvider","../../webgl-engine/lib/GeometryWithMapPositions"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=r.create(),h=.01,p=s.create(),f=s.create(),m=s.create(),g=r.create(),y=s.create(),_=new a.SampleElevationInfo;function b(e,t,r,i,s){let n=!1;const a=e.transformation,u=t.requiresSampledElevationInfo;f[0]=a[12],f[1]=a[13],f[2]=a[14],e.invalidateBoundingInfo();const d=e.getMutableAttribute("position"),g=d.data,y=d.size,b=g.length/y,v=new c.SamplePosition(e.mapPositions,r);let w=0,x=0;for(let e=0;e<b;e++){if(m[0]=g[w],m[1]=g[w+1],m[2]=g[w+2],i(v,_),u&&(x+=_.sampledElevation),l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS)g[w]=v.array[v.offset],g[w+1]=v.array[v.offset+1],g[w+2]=_.z,o.projectBuffer(g,r,w,g,s.spatialReference,w,1),g[w]-=f[0],g[w+1]-=f[1],g[w+2]-=f[2],n=!0;else{p[0]=g[w]+f[0],p[1]=g[w+1]+f[1],p[2]=g[w+2]+f[2],s.setAltitude(p,_.z),g[w]=p[0]-f[0],g[w+1]=p[1]-f[1],g[w+2]=p[2]-f[2];const e=h/s.unitInMeters;(Math.abs(m[0]-g[w])>=e||Math.abs(m[1]-g[w+1])>=e||Math.abs(m[2]-g[w+2])>=e)&&(n=!0)}w+=y,v.offset+=3}return x/=b,{update:n,averageGeometrySampledElevation:x}}e.perLodInstanceElevationAligner=function(e,t,r,s,o){const a=e.graphics3DSymbolLayer.lodRenderer;if(null==a)return 0;const c=t.centerPointInElevationSR;s(c,_);const u="absolute-height"!==t.mode?_.sampledElevation:0,d=a.instanceData,f=e.instanceIndex,m=g;d.getGlobalTransform(f,m);const b=i.set(y,m[12],m[13],m[14]);l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(p[0]=c.x,p[1]=c.y,p[2]=_.z,n.computeTranslationToOriginAndRotation(c.spatialReference,p,m,o.spatialReference)&&d.setGlobalTransform(f,m)):o.setAltitudeOfTransformation(_.z,m);const v=h/o.unitInMeters;return(l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(m[12]-b[0])>=v||Math.abs(m[13]-b[1])>=v||Math.abs(m[14]-b[2])>=v)&&d.setGlobalTransform(f,m),u},e.perObjectElevationAligner=function(e,r,s,o,c,u){const f=e.stageObject,m=r.centerPointInElevationSR;let g=0;f.usesVerticalDistanceToGround?(o(m,_),a.updateVertexPointGroundDistance(f,_.verticalDistanceToGround),g=_.sampledElevation):(o(m,_),"absolute-height"!==r.mode&&(g=_.sampledElevation));const b=t.copy(d,u??f.transformation),v=i.set(y,b[12],b[13],b[14]);l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(p[0]=m.x,p[1]=m.y,p[2]=_.z,n.computeTranslationToOriginAndRotation(m.spatialReference,p,b,c.spatialReference)&&(u?t.copy(u,b):f.transformation=b)):c.setAltitudeOfTransformation(_.z,b);const w=h/c.unitInMeters;return(Math.abs(b[12]-v[0])>=w||Math.abs(b[13]-v[1])>=w||Math.abs(b[14]-v[2])>=w)&&(u?t.copy(u,b):f.transformation=b),g},e.perVertexElevationAligner=function(e,t,r,i,s){const n=e.stageObject,o=n.geometries;let a=0;for(const e of o){if(!u.isGeometryWithMapPositions(e))continue;const{update:o,averageGeometrySampledElevation:l}=b(e,t,r,i,s);a+=l,o&&n.geometryVertexAttributeUpdated(e,"position")}return a/o.length},e.sharedGeometryElevationAligner=function(e,t,r,i,s){const n=e.stageObject,o=n.geometries;if(0===o.length)return 0;let a=0,l=null,c=0,d=!1;for(const e of o){if(!u.isGeometryWithMapPositions(e))continue;const o=e.attributes.get("position");if(o!==l){const{update:n,averageGeometrySampledElevation:a}=b(e,t,r,i,s);c=a,l=o,d=n}d&&n.geometryVertexAttributeUpdated(e,"position"),a+=c}return a/o.length},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/elevationAlignmentUtils":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../geometry/projection/projectBuffer","../../../../layers/graphics/dehydratedFeatureUtils","../../support/ElevationProvider"],function(e,t,r,i,s,n,o,a){"use strict";function l(e,t,r,i,s){const n=(o.isDehydratedPoint(e)?e.z:a.isSamplePosition(e)?e.array[e.offset+2]:e[2])||0;switch(r.mode){case"on-the-ground":{const r=a.getElevationAtPoint(t,e,"ground")??0;return s.verticalDistanceToGround=0,s.sampledElevation=r,void(s.z=r)}case"relative-to-ground":{const o=a.getElevationAtPoint(t,e,"ground")??0,l=r.geometryZWithOffset(n,i);return s.verticalDistanceToGround=l,s.sampledElevation=o,void(s.z=l+o)}case"relative-to-scene":{const o=a.getElevationAtPoint(t,e,"scene")??0,l=r.geometryZWithOffset(n,i);return s.verticalDistanceToGround=l,s.sampledElevation=o,void(s.z=l+o)}case"absolute-height":{const o=r.geometryZWithOffset(n,i),l=a.getElevationAtPoint(t,e,"ground")??0;return s.verticalDistanceToGround=o-l,s.sampledElevation=l,void(s.z=o)}default:return void(s.z=0)}}function c(e,t){for(let r=0;r<e.geometries.length;++r){const i=e.geometries[r].getMutableAttribute("centerOffsetAndDistance");i&&i.data[3]!==t&&(i.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[r],"centerOffsetAndDistance"))}}class u{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}const d={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,r,i,s,n,o,a){const l=a.calculateOffsetRenderUnits(o),c=a.featureExpressionInfoContext;t*=3,i*=3;for(let n=0;n<s;++n){const s=e[t],n=e[t+1],o=e[t+2];r[i]=s,r[i+1]=n,r[i+2]=null==c?o+l:l,t+=3,i+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,r=e.featureExpressionInfoContext;return 0!==t||null!=r}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,r,i,s,n){let o=0;const a=n.spatialReference;t*=3,i*=3;for(let l=0;l<s;++l){const s=e[t],l=e[t+1],c=e[t+2],u=n.getElevation(s,l,c,a,"ground")??0;o+=u,r[i]=s,r[i+1]=l,r[i+2]=u,t+=3,i+=3}return o/s},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,r,i,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),u=a.featureExpressionInfoContext,d=n.spatialReference;t*=3,i*=3;for(let o=0;o<s;++o){const s=e[t],o=e[t+1],a=e[t+2],h=n.getElevation(s,o,a,d,"ground")??0;l+=h,r[i]=s,r[i+1]=o,r[i+2]=null==u?a+h+c:h+c,t+=3,i+=3}return l/s},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,r,i,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),u=a.featureExpressionInfoContext,d=n.spatialReference;t*=3,i*=3;for(let o=0;o<s;++o){const s=e[t],o=e[t+1],a=e[t+2],h=n.getElevation(s,o,a,d,"scene")??0;l+=h,r[i]=s,r[i+1]=o,r[i+2]=null==u?a+h+c:h+c,t+=3,i+=3}return l/s},requiresAlignment:()=>!0}},h=r.create(),p=new u,f=i.create();e.SampleElevationInfo=u,e.applyElevationAlignmentForHUD=function(e,r,i,n,o){l(r,i,o,n,p),c(e,p.verticalDistanceToGround);const a=p.sampledElevation,u=t.copy(h,e.transformation);return f[0]=r.x,f[1]=r.y,f[2]=p.z,s.computeTranslationToOriginAndRotation(r.spatialReference,f,u,n.spatialReference)?e.transformation=u:console.warn("Could not locate symbol object properly, it might be misplaced"),a},e.applyPerVertexElevationAlignment=function(e,t,r,i,s,o,a,l,c,u,h){const p=d[h.mode];let f,m,g=0;if(n.projectBuffer(e,t,r,i,c.spatialReference,s,l))return p?.requiresAlignment(h)?(g=p.applyElevationAlignmentBuffer(i,s,o,a,l,c,u,h),f=o,m=a):(f=i,m=s),n.projectBuffer(f,c.spatialReference,m,o,u.spatialReference,a,l)?g:void 0},e.elevationModeChangeUpdateType=function(e,t,r){return"on-the-ground"===t&&"on-the-ground"===r?e.staysOnTheGround:t===r||"on-the-ground"!==t&&"on-the-ground"!==r?null==t||null==r?e.definedChanged:1:e.onTheGroundChanged},e.evaluateElevationAlignmentAtPoint=function(e,t,r,i){return l(e,t,r,i,p),p.z},e.evaluateElevationInfoAtPoint=l,e.needsElevationUpdates2D=function(e){return"relative-to-ground"===e||"relative-to-scene"===e},e.needsElevationUpdates3D=function(e){return"absolute-height"!==e},e.updateVertexPointGroundDistance=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/GeometryWithMapPositions":function(){define(["exports","./Geometry"],function(e,t){"use strict";class r extends t.Geometry{}e.GeometryWithMapPositions=r,e.isGeometryWithMapPositions=function(e){return null!=e.mapPositions},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Geometry":function(){define(["exports","../../../../core/uid","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../geometry/support/Indices","./AttributeArray","./BoundingInfo","./geometryDataUtils","./Object3DStateID","./Util","../../../webgl/checkWebGLError"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";class d{constructor(e,r,i=null,n=0,o=null,a=-1){this.material=e,this.mapPositions=i,this.type=n,this.olidColor=o,this.edgeIndicesLength=a,this._highlights=null,this._highlightOptionsCounts=null,this.id=t.generateUID(),this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[e,t]of r)this._attributes.set(e,{...t,indices:s.compactIndices(t.indices)}),"position"===e&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(e).indices.length:this.edgeIndicesLength)}instantiate(e={}){const t=new d(e.material||this.material,[],this.mapPositions,this.type,this.olidColor,this.edgeIndicesLength);return this._attributes.forEach((e,r)=>{e.exclusive=!1,t._attributes.set(r,e)}),t._boundingInfo=this._boundingInfo,t.transformation=e.transformation||this.transformation,t}get attributes(){return this._attributes}getMutableAttribute(e){let t=this._attributes.get(e);return t&&!t.exclusive&&(t={...t,exclusive:!0,data:n.cloneAttributeData(t.data)},this._attributes.set(e,t)),t}setAttributeData(e,t){const r=this._attributes.get(e);r?this._attributes.set(e,{...r,exclusive:!0,data:t}):u.webglDebugEnabled()&&console.warn(`Setting undefined attribute ${e} data`)}get indexCount(){const e=this._attributes.values().next().value?.indices;return e?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo??=this._calculateBoundingInfo(),this._boundingInfo}computeAttachmentOrigin(e){return!!(0===this.type?this._computeAttachmentOriginTriangles(e):2===this.type?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(null!=this._transformation&&i.transformMat4(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){const t=this.attributes.get("position");return a.computeAttachmentOriginTriangles(t,e)}_computeAttachmentOriginLines(e){const t=this.attributes.get("position");return a.computeAttachmentOriginLines(t,function(e,t){return!(!("isClosed"in e)||!e.isClosed)&&t.indices.length>2}(this.material.parameters,t),e)}_computeAttachmentOriginPoints(e){const t=this.attributes.get("position");return a.computeAttachmentOriginPoints(t,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.attributes.get("position");if(!e||0===e.indices.length)return null;const t=0===this.type?3:1;c.assert(e.indices.length%t===0,"Indexing error: "+e.indices.length+" not divisible by "+t);const r=s.getContinuousIndexArray(e.indices.length/t);return new o.BoundingInfo(r,t,e)}get transformation(){return this._transformation??r.IDENTITY}set transformation(e){this._transformation=e&&e!==r.IDENTITY?r.clone(e):null}get highlights(){return this._highlights||h}get hasHighlights(){return(this._highlightOptionsCounts?.size??0)>0}foreachHighlightOptions(e){this._highlightOptionsCounts?.forEach((t,r)=>e(r))}allocateIdAndHighlight(e){const t=new l.Object3DHighlightStateID(e);return this.addHighlight(t)}addHighlight(e){this._ensureHighlights().add(e);const{highlightName:t}=e,r=(this._highlightOptionsCounts?.get(t)??0)+1;return this._ensureHighlightOptionsCounts().set(t,r),e}_ensureHighlights(){let e=this._highlights;return e||(e=new Set,this._highlights=e),e}_ensureHighlightOptionsCounts(){let e=this._highlightOptionsCounts;return e||(e=new Map,this._highlightOptionsCounts=e),e}removeHighlight(e){if(this._highlights?.delete(e)){const{highlightName:t}=e,r=this._highlightOptionsCounts?.get(t)??0;r<=1?this._highlightOptionsCounts?.delete(t):this._ensureHighlightOptionsCounts().set(t,r-1)}}}const h=new Set;e.Geometry=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/AttributeArray":function(){define(["exports","../../../../core/typedArrayUtil","../../../../geometry/support/float16"],function(e,t,r){"use strict";e.cloneAttributeData=function(e){if(e.length<t.nativeArrayMaxSize)return Array.from(e);if(Array.isArray(e))return Float64Array.from(e);if(!("BYTES_PER_ELEMENT"in e))return Array.from(e);switch(e.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(e);case 2:return t.isFloat16Array(e)?r.getFloat16ArrayConstructor().from(e):t.isUint16Array(e)?Uint16Array.from(e):Int16Array.from(e);case 4:return Float32Array.from(e);default:return Float64Array.from(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/BoundingInfo":function(){define(["exports","../../../../core/PooledArray","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","./Util"],function(e,t,r,i,s){"use strict";class n{get center(){return i.fromValues(this._data[0],this._data[1],this._data[2])}get radius(){return this._data[3]}get bbMin(){return i.fromValues(this._data[4],this._data[5],this._data[6])}get bbMax(){return i.fromValues(this._data[7],this._data[8],this._data[9])}constructor(e,t,n){this.primitiveIndices=e,this._numIndexPerPrimitive=t,this.position=n,this._data=[.1,0,0,0,0,0,0,0,0,0],this._children=void 0,s.assert(e.length>=1),s.assert(3===n.size||4===n.size);const{data:a,size:l,indices:c}=n;s.assert(c.length%this._numIndexPerPrimitive===0),s.assert(c.length>=e.length*this._numIndexPerPrimitive);const u=e.length;let d=l*c[this._numIndexPerPrimitive*e[0]];o.clear(),o.push(d);const h=i.fromValues(a[d],a[d+1],a[d+2]),p=i.clone(h);for(let t=0;t<u;++t){const r=this._numIndexPerPrimitive*e[t];for(let e=0;e<this._numIndexPerPrimitive;++e){d=l*c[r+e],o.push(d);let t=a[d];h[0]=Math.min(t,h[0]),p[0]=Math.max(t,p[0]),t=a[d+1],h[1]=Math.min(t,h[1]),p[1]=Math.max(t,p[1]),t=a[d+2],h[2]=Math.min(t,h[2]),p[2]=Math.max(t,p[2])}}for(let e=0;e<3;++e)this._data[4+e]=h[e],this._data[7+e]=p[e];const f=r.lerp(i.create(),this.bbMin,this.bbMax,.5);let m=.5*Math.max(Math.max(p[0]-h[0],p[1]-h[1]),p[2]-h[2]),g=m*m;for(let e=0;e<o.length;++e){d=o.at(e);const t=a[d]-f[0],r=a[d+1]-f[1],i=a[d+2]-f[2],s=t*t+r*r+i*i;if(s<=g)continue;const n=Math.sqrt(s),l=.5*(n-m);m+=l,g=m*m;const c=l/n;f[0]+=t*c,f[1]+=r*c,f[2]+=i*c}this._data[3]=m;for(let e=0;e<3;++e)this._data[0+e]=f[e];o.clear()}getChildren(){if(this._children||r.squaredDistance(this.bbMin,this.bbMax)<=1)return this._children;const e=r.lerp(i.create(),this.bbMin,this.bbMax,.5),t=this.primitiveIndices.length,s=new Uint8Array(t),o=new Array(8);for(let e=0;e<8;++e)o[e]=0;const{data:a,size:l,indices:c}=this.position;for(let r=0;r<t;++r){let t=0;const i=this._numIndexPerPrimitive*this.primitiveIndices[r];let n=l*c[i],u=a[n],d=a[n+1],h=a[n+2];for(let e=1;e<this._numIndexPerPrimitive;++e){n=l*c[i+e];const t=a[n],r=a[n+1],s=a[n+2];t<u&&(u=t),r<d&&(d=r),s<h&&(h=s)}u<e[0]&&(t|=1),d<e[1]&&(t|=2),h<e[2]&&(t|=4),s[r]=t,++o[t]}let u=0;for(let e=0;e<8;++e)o[e]>0&&++u;if(u<2)return;const d=new Array(8);for(let e=0;e<8;++e)d[e]=o[e]>0?new Uint32Array(o[e]):void 0;for(let e=0;e<8;++e)o[e]=0;for(let e=0;e<t;++e){const t=s[e];d[t][o[t]++]=this.primitiveIndices[e]}this._children=new Array;for(let e=0;e<8;++e)void 0!==d[e]&&this._children.push(new n(d[e],this._numIndexPerPrimitive,this.position));return this._children}static prune(){o.prune()}}const o=new t({deallocator:null});e.BoundingInfo=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/geometryDataUtils":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/triangle"],function(e,t,r,i){"use strict";const s=r.create(),n=r.create(),o=r.create(),a=r.create();e.computeAttachmentOriginLines=function(e,r,i){if(!e)return!1;t.set(i,0,0,0),t.set(a,0,0,0);let o=0,l=0;const{size:c,data:u,indices:d}=e,h=d.length-1,p=h+(r?2:0);for(let e=0;e<p;e+=2){const r=e<h?e+1:0,p=d[e<h?e:h]*c,f=d[r]*c;s[0]=u[p],s[1]=u[p+1],s[2]=u[p+2],n[0]=u[f],n[1]=u[f+1],n[2]=u[f+2],t.scale(s,t.add(s,s,n),.5);const m=t.dist(s,n);m>0?(t.add(i,i,t.scale(s,s,m)),o+=m):0===o&&(t.add(a,a,s),l++)}return 0!==o?(t.scale(i,i,1/o),!0):0!==l&&(t.scale(i,a,1/l),!0)},e.computeAttachmentOriginPoints=function(e,r){if(!e)return!1;const{size:i,data:s,indices:n}=e;t.set(r,0,0,0);let o=-1,a=0;for(let e=0;e<n.length;e++){const t=n[e]*i;o!==t&&(r[0]+=s[t],r[1]+=s[t+1],r[2]+=s[t+2],a++),o=t}return a>1&&t.scale(r,r,1/a),a>0},e.computeAttachmentOriginTriangles=function(e,r){if(!e)return!1;const{size:l,data:c,indices:u}=e;t.set(r,0,0,0),t.set(a,0,0,0);let d=0,h=0;for(let e=0;e<u.length-2;e+=3){const p=u[e]*l,f=u[e+1]*l,m=u[e+2]*l;t.set(s,c[p],c[p+1],c[p+2]),t.set(n,c[f],c[f+1],c[f+2]),t.set(o,c[m],c[m+1],c[m+2]);const g=i.areaPoints3d(s,n,o);g?(t.add(s,s,n),t.add(s,s,o),t.scale(s,s,1/3*g),t.add(r,r,s),d+=g):(t.add(a,a,s),t.add(a,a,n),t.add(a,a,o),h+=3)}return!(0===h&&0===d||(0!==d?(t.scale(r,r,1/d),0):0===h||(t.scale(r,a,1/h),0)))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/triangle":function(){define(["exports","../../core/ObjectStack","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","./lineSegment","./vectorStacks"],function(e,t,r,i,s,n){"use strict";function o(e){return e?{p0:i.clone(e.p0),p1:i.clone(e.p1),p2:i.clone(e.p2)}:{p0:i.create(),p1:i.create(),p2:i.create()}}function a(e,t,i,s=o()){return r.copy(s.p0,e),r.copy(s.p1,t),r.copy(s.p2,i),s}const l=new t.ObjectStack(s.create),c=new t.ObjectStack(()=>o()),u=i.create(),d=i.create();e.areaPoints2d=function(e,t,r){const i=t[0]-e[0],s=t[1]-e[1],n=r[0]-e[0],o=r[1]-e[1];return.5*Math.abs(i*o-s*n)},e.areaPoints3d=function(e,t,i){return r.subtract(u,t,e),r.subtract(d,i,e),.5*r.length(r.cross(u,u,d))},e.copy=function(e,t=o()){return a(e.p0,e.p1,e.p2,t)},e.create=o,e.distance2=function(e,t){const i=e.p0,o=e.p1,a=e.p2,c=r.subtract(n.sv3d.get(),o,i),u=r.subtract(n.sv3d.get(),a,o),d=r.subtract(n.sv3d.get(),i,a),h=r.subtract(n.sv3d.get(),t,i),p=r.subtract(n.sv3d.get(),t,o),f=r.subtract(n.sv3d.get(),t,a),m=r.cross(c,c,d),g=r.dot(r.cross(n.sv3d.get(),c,m),h),y=r.dot(r.cross(n.sv3d.get(),u,m),p),_=r.dot(r.cross(n.sv3d.get(),d,m),f);if(g>0&&y>0&&_>0){const e=r.dot(m,h);return e*e/r.dot(m,m)}const b=s.distance2(s.fromValues(i,c,l.get()),t),v=s.distance2(s.fromValues(o,u,l.get()),t),w=s.distance2(s.fromValues(a,d,l.get()),t);return Math.min(b,v,w)},e.fromValues=a,e.intersectRay=function(e,t,i){const s=1e-5,{direction:n,origin:o}=t,{p0:a,p1:l,p2:c}=e,u=l[0]-a[0],d=l[1]-a[1],h=l[2]-a[2],p=c[0]-a[0],f=c[1]-a[1],m=c[2]-a[2],g=n[1]*m-f*n[2],y=n[2]*p-m*n[0],_=n[0]*f-p*n[1],b=u*g+d*y+h*_;if(b>-s&&b<s)return!1;const v=1/b,w=o[0]-a[0],x=o[1]-a[1],S=o[2]-a[2],T=v*(w*g+x*y+S*_);if(T<0||T>1)return!1;const C=x*h-d*S,P=S*u-h*w,M=w*d-u*x,R=v*(n[0]*C+n[1]*P+n[2]*M);if(R<0||T+R>1)return!1;if(i){const e=v*(p*C+f*P+m*M);r.scale(i,n,e),r.add(i,o,i)}return!0},e.wrap=function(e,t,r){const i=c.get();return i.p0=e,i.p1=t,i.p2=r,i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Object3DStateID":function(){define(["exports","../../../../core/uid"],function(e,t){"use strict";class r{constructor(){this.uid=t.generateUID()}}e.Object3DHighlightStateID=class extends r{constructor(e){super(),this.highlightName=e,this.channel=0}},e.Object3DOccludeeStateID=class extends r{constructor(){super(...arguments),this.channel=1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/ElevationContext":function(){define(["exports","../../../../symbols/support/unitConversionUtils","./featureExpressionInfoUtils"],function(e,t,r){"use strict";class i{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=t.getMetersPerUnit(e)}get requiresSampledElevationInfo(){return"absolute-height"!==this.mode}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const r=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?r:e+r}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return null!=i&&(t+=r.execute(i)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=t.supportsUnit(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,t,i){if(null==e)return void(this._featureExpressionInfoContext=null);const s=e?.arcade;s&&null!=t&&null!=i?(this._featureExpressionInfoContext=r.clone(e),r.setContextFeature(this._featureExpressionInfoContext,r.createFeature(s.modules,t,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new i;return null!=e&&t.setFromElevationInfo(e),t}}e.ElevationContext=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/featureExpressionInfoUtils":function(){define(["exports","../../../../core/Logger","../../../../core/promiseUtils","../../../../layers/graphics/hydratedFeatures","../../../../support/loadArcade"],function(e,t,r,i,s){"use strict";function n(e){return null!=e.cachedResult}function o(e){return"0"===e?0:null}e.clone=function(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}},e.createContext=async function(e,t,i,n){const a=e?.expression;if("string"!=typeof a)return null;const l=o(a);if(null!=l)return{cachedResult:l};const c=await s.loadArcade();r.throwIfAborted(i);const u=c.arcadeUtils,d=u.createSyntaxTree(a);return u.dependsOnView(d)?(null!=n&&n.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:u.createFunction(d),context:u.createExecContext(null,{sr:t}),modules:c}}},e.createContextWithoutExpressionSupport=function(e){const t=e?.expression;if("string"==typeof t){const e=o(t);if(null!=e)return{cachedResult:e}}return null},e.createFeature=function(e,t,r){return e.arcadeUtils.createFeature(t.attributes,t.geometry,r)},e.execute=function(e){if(null!=e){if(n(e))return e.cachedResult;const t=e.arcade;let r=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof r&&(e.cachedResult=0,r=0),r}return 0},e.extractExpressionInfo=function(e,t=!1){let r=e?.featureExpressionInfo;const i=r?.expression;return t||"0"===i||(r=null),r??null},e.setContextFeature=function(e,r){if(null!=e&&!n(e)){if(!r||!e.arcade)return void t.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils").errorOncePerTick("Arcade support required but not provided");const s=r;s._geometry&&(s._geometry=i.hydrateGeometry(s._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,r)}},e.zeroContext={cachedResult:0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DGraphicCreationContext":function(){define(["exports"],function(e){"use strict";e.Graphics3DGraphicCreationContext=class{constructor(e,t,r){this.graphic=e,this.renderingInfo=t,this.layer=r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DObject3DGraphicLayer":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../chunks/sphere","./elevationAlignmentUtils","./featureExpressionInfoUtils","./graphicUtils"],function(e,t,r,i,s,n,o,a){"use strict";function l(e){return e.transparent?0:1}const c=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],u=r.create(),d=r.create(),h=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];e.Graphics3DObject3DGraphicLayer=class{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,r,i,s,n=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._sharedResource=r,this.elevationAligner=i,this.elevationContext=s,this._edgeState=n,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e}destroy(){if(!this._stageLayer)return;const e=this._stageLayer.stage;this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),e.renderer.edgeView?.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource?.release(),this._visible=!1,this._stageLayer=null}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}layerOpacityChanged(e,t){const{stageObject:r,_edgeState:i,_stageLayer:s}=this;if(null==i)return;const n=l(i.baseMaterial);i.edgeMaterial.objectTransparency!==n&&(i.edgeMaterial.objectTransparency=n,this.resetEdgeObject(t)),s.stage.renderer.withEdgeView(t=>t.updateAllComponentOpacities(r,[e]))}updateHighlights(e){}slicePlaneEnabledChanged(e,t){const{stageObject:r,_edgeState:i,_stageLayer:s}=this;null!=i&&s.stage.renderer.withEdgeView(s=>{s.updateAllComponentMaterials(r,i.edgeMaterial,e,!t),i.hasSlicePlane=e})}setVisibility(e){const{_edgeState:t,stageObject:r,_stageLayer:i}=this;null!=i&&this.visible!==e&&(this._visible=e,r.visible=e,e&&!this._addedToStage&&(i.add(r),this._addedToStage=!0),null!=t&&i.stage.renderer.withEdgeView(i=>{i.hasObject(r)?i.updateObjectVisibility(r,e):e&&this._addOrUpdateEdgeObject(t,i,!1)}))}get visible(){return this._visible}alignWithElevation(e,t,r,i){null!=this.elevationAligner&&(null!=r&&o.setContextFeature(this.elevationContext.featureExpressionInfoContext,r),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,(r,i)=>n.evaluateElevationInfoAtPoint(r,e,this.elevationContext,t,i),t),this.resetEdgeObject(i))}alignWithAbsoluteElevation(e,t,r){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,(t,r)=>{r.sampledElevation=e,r.verticalDistanceToGround=0,r.z=e},t),this.resetEdgeObject(r)}getCenterObjectSpace(e=r.create()){return t.copy(e,s.getCenter(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=i.create()){const t=this.stageObject.boundingVolumeObjectSpace;return i.setMin(e,t.min),i.setMax(e,t.max),e}computeAttachmentOrigin(e){const r=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=r[12],e.render.origin[1]+=r[13],e.render.origin[2]+=r[14],e.render.num++;else for(const i of this.stageObject.geometries)i.computeAttachmentOrigin(d)&&(t.transformMat4(d,d,r),t.add(e.render.origin,e.render.origin,d),e.render.num++)}async getProjectedBoundingBox(e,r,s,n,o){const l=this.getBoundingBoxObjectSpace(o),p=h,f=i.isPoint(l)?1:p.length;for(let e=0;e<f;e++){const r=p[e];u[0]=l[r[0]],u[1]=l[r[1]],u[2]=l[r[2]],t.transformMat4(u,u,this.stageObject.transformation),c[3*e]=u[0],c[3*e+1]=u[1],c[3*e+2]=u[2]}if(!e(c,0,f))return null;i.empty(l);let m=null;this.calculateRelativeScreenBounds&&(m=this.calculateRelativeScreenBounds());for(let e=0;e<3*f;e+=3){for(let t=0;t<3;t++)l[t]=Math.min(l[t],c[e+t]),l[t+3]=Math.max(l[t+3],c[e+t]);m&&s.push({location:c.slice(e,e+3),screenSpaceBoundingRect:m})}if(r?.service&&"absolute-height"!==this.elevationContext.mode){i.center(l,d);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let t=0;if(r.useViewElevation)t=r.service.getElevation(d[0],d[1],e)??0;else try{const i=a.demResolutionForBoundingBox(l,r.service.spatialReference,r);t=await r.service.queryElevation(d[0],d[1],n,i,e)??0}catch(e){}i.offset(l,0,0,-this.alignedSampledElevation+t)}return l}addObjectState(e){0===e.stateType&&e.addObject(this.stageObject,this.stageObject.highlight(e.highlightName)),1===e.stateType&&e.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeByObject(this.stageObject)}resetEdgeObject(e){const{_edgeState:t,stageObject:r,_stageLayer:i,_visible:s}=this;null!=t&&i.stage.renderer.withEdgeView(i=>{s?this._addOrUpdateEdgeObject(t,i,e):i.removeObject(r)})}_addOrUpdateEdgeObject(e,t,r){const i=l(e.baseMaterial);e.edgeMaterial.objectTransparency=i,t.addOrUpdateObject3D(this.stageObject,e.edgeMaterial,e.hasSlicePlane,!r).then(()=>this._stageLayer?.sync())}},e.Object3DEdgeState=class{constructor(e,t,r){this.baseMaterial=e,this.edgeMaterial=t,this.hasSlicePlane=r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/graphicUtils":function(){define(["exports","../../../../core/unitUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/projectionUtils","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/centroid","../../../../geometry/support/coordsUtils","../../../../geometry/support/meshVertexSpaceUtils","../../../../layers/graphics/dehydratedPoint","../../../../layers/graphics/hydratedFeatures"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";function m(e){const t=e.paths[0];if(!t||0===t.length)return null;const r=d.getPointOnPath(t,d.getPathLength(t)/2);return p.makeDehydratedPoint(r[0],r[1],r[2],e.spatialReference)}function g(e,t,r){const i=r?e:f.clonePoint(e);return t&&e?a.projectPoint(e,i,t)?i:null:i}function y(e){const t=e=>null==e||e>=0;return Array.isArray(e)?e.every(t):t(e)}e.computeCentroid=function(e,t){if("point"===e.type)return g(e,t,!1);if(f.isHydratedGeometry(e))switch(e.type){case"extent":return g(e.center,t,!1);case"polygon":return g(e.centroid,t,!1);case"polyline":return g(m(e),t,!0);case"mesh":return g(h.vertexSpaceOriginToPoint(e.vertexSpace,e.spatialReference)??e.extent.center,t,!1);case"multipoint":return}else switch(e.type){case"extent":return g(function(e){return p.makeDehydratedPoint(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),null!=e.zmin&&null!=e.zmax&&isFinite(e.zmin)&&isFinite(e.zmax)?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return g(function(e){const t=e.rings[0];if(!t||0===t.length)return null;const r=u.ringsCentroid(e.rings,!!e.hasZ);return p.makeDehydratedPoint(r[0],r[1],r[2],e.spatialReference)}(e),t,!0);case"polyline":return g(m(e),t,!0);case"multipoint":return}},e.computeMaxZ=function(e){if(!e)return 0;switch(e.type){case"point":return e.z;case"extent":return e.zmax;case"polygon":return e.hasZ?e.rings.reduce((e,t)=>t.reduce((e,t)=>Math.max(e,t[2]),e),-1/0):void 0;case"polyline":return e.hasZ?e.paths.reduce((e,t)=>t.reduce((e,t)=>Math.max(e,t[2]),e),-1/0):void 0;case"mesh":return e.extent.zmax;case"multipoint":return}},e.computeObjectRotation=function(e,t,s,n=i.create()){return e&&r.rotateZ(n,n,-e/180*Math.PI),t&&r.rotateX(n,n,t/180*Math.PI),s&&r.rotateY(n,n,s/180*Math.PI),n},e.computeObjectScale=function(e=s.ONES,t,r,i=1){const n=new Array(3);if(null==t||null==r)n[0]=1,n[1]=1,n[2]=1;else{let i,s=0;for(let o=2;o>=0;o--){const a=e[o],l=null!=a,c=0===o&&!i&&!l,u=r[o];let d;"symbol-value"===a||c?d=0!==u?t[o]/u:1:l&&"proportional"!==a&&isFinite(a)&&(d=0!==u?a/u:1),null!=d&&(n[o]=d,i=d,s=Math.max(s,Math.abs(d)))}for(let e=2;e>=0;e--)null==n[e]?n[e]=i:0===n[e]&&(n[e]=.001*s)}for(let e=2;e>=0;e--)n[e]/=i;return s.fromArray(n)},e.demResolutionForBoundingBox=function(e,r,i){if(null!=i.minDemResolution)return i.minDemResolution;const s=t.getMetersPerUnitForSR(r),n=l.width(e)*s,o=l.depth(e)*s,a=l.height(e)*(r.isGeographic?1:s);return 0===n&&0===o&&0===a?i.minDemResolutionForPoints:.01*Math.max(n,o,a)},e.enlargeExtent=function(e,t,r,i=0){if(e){t||(t=c.create());const s=e;let o=.5*s.width*(r-1),a=.5*s.height*(r-1);return s.width<1e-7*s.height?o+=a/20:s.height<1e-7*s.width&&(a+=o/20),n.set(t,s.xmin-o-i,s.ymin-a-i,s.xmax+o+i,s.ymax+a+i),t}return null},e.isValidSize=y,e.mixinColorAndOpacity=function(e,t,r=null){const i=o.clone(o.ONES);return null!=e&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],e.length>3&&(i[3]=e[3])),null!=t&&(i[3]=t),r&&n.scale(i,i,r),i},e.overrideColor=function(e,t,r,i,s,n){for(let t=0;t<3;++t)n[t]=null!=e?.[t]?e[t]:null!=r?.[t]?r[t]:s[t];return n[3]=null!=t?t:null!=i?i:s[3],n},e.validateSymbolLayerSize=function(e){return y(null!=e.isPrimitive?[e.width,e.depth,e.height]:e)?null:"Symbol sizes may not be negative values"},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DObjectMetadata":function(){define(["exports"],function(e){"use strict";e.Graphics3DObjectMetadata=class{constructor(e,t=null){this.labelText=t,this.elevationOffset=e??0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DSymbolLayer":function(){define(["exports","../../../../Color","../../../../core/has","../../../../core/Logger","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/coordsUtils","./defaultSymbolComplexity","./ElevationContext","./featureExpressionInfoUtils","./graphicUtils","./Loadable","../support/FastSymbolUpdates","../support/symbolColorUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";const m=()=>i.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class g extends h.Loadable{constructor(e,t,r,i,s=!0){super(r.schedule),this.symbol=e,this.symbolLayer=t,this._context=r,this._drivenOpacityFallbackAlwaysOpaque=s,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1,rotation:!1},this._materials=[],this.logger=m(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=i.renderPriority,this._renderPriorityStep=i.renderPriorityStep,this._elevationContext=new c.ElevationContext,this.updateComplexity(),this.ignoreDrivers=i.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=y(this._context.renderer,s)),this._updateElevationContext()}destroy(){this.complexity=null,this._materials.length=0,super.destroy()}get view(){return this._context.stage.view}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}get estimatedMemory(){const{complexity:e}=this;return null==e?0:(this.draped?e.memory.draped:e.memory).bytesPerFeature}get usedMemory(){return this.estimatedMemory}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;const t=this._drivenProperties,r=y(e,this._drivenOpacityFallbackAlwaysOpaque);return r.color!==t.color||r.opacity!==t.opacity||r.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||r.size!==t.size||r.rotation!==t.rotation}get needsDrivenTransparentPass(){return this._hasDrivenColorOrOpacity&&!this._drivenProperties.opacityAlwaysOpaque}get _hasDrivenColorOrOpacity(){return this._drivenProperties.color||this._drivenProperties.opacity}_logGeometryCreationWarnings(e,t,r,i){const s=e.projectionSuccess,n="polygons"in e?e.polygons:null,o=`${i} geometry failed to be created`;s?!this._logGeometryValidationWarnings(t,r,i)&&n&&0===n.length&&"rings"===r&&t.length>0&&t[0].length>2&&m().warnOncePerTick(`${o} (filled rings should use clockwise winding - try reversing the order of vertices)`):m().warnOncePerTick(`${o} (failed to project geometry to view spatial reference)`)}updateFocus(e,t){}_logGeometryValidationWarnings(e,t,r){const i=`${r} geometry failed to be created`;return!e.length||1===e.length&&!e[0].length?(m().warnOncePerTick(`${i} (no ${t} were defined)`),!0):!(Array.isArray(e)&&Array.isArray(e[0])||(m().warnOncePerTick(`${i} (${t} should be defined as a 2D array)`),0))}_validateGeometry(e,t=null,r=null){if(null!=t&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+r+` symbol: ${e.type}`),!1;switch(e.type){case"point":{const t=e;if(!isFinite(t.x)||!isFinite(t.y))return m().warn("point coordinate is not a valid number, graphic skipped"),!1;break}case"polygon":a.closeRings(e)}return!0}_defaultElevationInfoNoZ(){return _}_defaultElevationInfoZ(){return b}_updateElevationContext(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t=new c.ElevationContext){const r=e.geometry,i=this.getDefaultElevationInfo(r);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:i.unit,t.mode=this.getGeometryElevationMode(r,i),t.offsetMeters=this._elevationContext.meterUnitOffset??i.offset??0;const s=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;s&&(t.mode="relative-to-ground",t.offsetMeters=0);const n=s?u.zeroContext:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(n,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}updateTransform(e,t,r,i){return!1}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,t=v){const r=this.draped?1:this._getLayerOpacity();return this._drivenProperties.color?r:e?r*(this._drivenProperties.opacity?1:e.a):t.hasIntrinsicColor?r:0}_getCombinedOpacityAndColor(e,r=v){const i=this._getCombinedOpacity(e,r);if(this._drivenProperties.color)return d.mixinColorAndOpacity(null,i);const n=null!=e?t.toUnitRGB(e):s.ONES;return d.mixinColorAndOpacity(n,i)}_getDrivenUInt8Color({color:e,opacity:r},i,s){const{color:n,opacity:a}=this._drivenProperties,l=t.toUnitRGBA(i)??(s?o.ONES:o.ZEROS),c=n?e??l:null,u=e||i||s,h=n?null:l[3],p=a&&u?r??h:null;return d.mixinColorAndOpacity(c,p,255)}_getDrivenUInt8ColorWithNaNSupport({color:e,opacity:r},i,s){const a=i?o.fromArray(t.toUnitRGBA(i)):o.fromValues(NaN,NaN,NaN,s?NaN:0);return this._drivenProperties.color&&null!=e&&n.copy(a,e),this._drivenProperties.opacity&&null!=r&&(a[3]=r),n.scale(a,a,255),f.encodeNaNUInt8(a,a)}isFastUpdatesEnabled(){return null!=this._fastUpdates}updateComplexity(){this.complexity=this.computeComplexity()}computeComplexity(){return l.defaultSymbolLayerComplexity(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,r){switch(e){case"opacity":return this.layerOpacityChanged(t,r),!0;case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),2!==this.layerElevationInfoChanged(t,r,e)}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,r);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,t,r){let i=1;return e?.forEach(e=>{const s=t(e);if(null!=s){const t=e.graphic;this.setGraphicElevationContext(t,s.elevationContext),s.needsElevationUpdates=r(s.elevationContext.mode)}else i=2}),i}applyRendererDiff(e,t){return 0}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;const t=this._fastUpdates.visualVariables,r=t.size?p.getAttributeValue(t.size.field,e):0,i=t.color?p.getAttributeValue(t.color.field,e):0,s=t.opacity?p.getAttributeValue(t.opacity.field,e):0;return o.fromValues(r,i,s,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&m().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null})}}}function y(e,t){const r={color:!1,opacity:!1,opacityAlwaysOpaque:t,size:!1,rotation:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach(e=>{switch(e.type){case"color":if(r.color=!0,e.stops)for(let t=0;t<e.stops.length;t++){const i=e.stops[t].color;i&&i.a<1&&(r.opacityAlwaysOpaque=!1)}break;case"opacity":r.opacity=!0,r.opacityAlwaysOpaque=!1;break;case"size":r.size=!0;break;case"rotation":r.rotation=!0}}),r}const _={mode:"on-the-ground",offset:0,unit:"meters"},b={mode:"absolute-height",offset:0,unit:"meters"},v={hasIntrinsicColor:!1},w=o.fromValues(NaN,NaN,NaN,NaN);e.Graphics3DSymbolLayer=g,e.getDrivenProperties=y,e.nanFallbackColor=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/defaultSymbolComplexity":function(){define(["exports","../../../../core/compilerUtils","../../../../core/has","../../../../symbols/support/ObjectSymbol3DLayerResource","./Graphics3DPathSymbolLayerConstants","./primitiveObjectSymbolUtils","./SymbolComplexity","../support/edgeUtils","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,i,s,n,o,a,l){"use strict";const c=new o.EstimatedSymbolComplexity({});function u(e){let t=0,r=0,i=0,s=!1,n=0;const a=new o.SymbolComplexityMemory;for(const o of e)null!=o&&(t+=o.verticesPerFeature,r+=o.verticesPerCoordinate,i+=o.drawCallsPerFeature,a.bytesPerFeature+=o.memory.bytesPerFeature,a.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,a.resourceBytes+=o.memory.resourceBytes,a.draped.bytesPerFeature+=o.memory.bytesPerFeature,a.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,s=s||o.estimated,++n);return s?new o.EstimatedAggregateSymbolComplexity(n,{verticesPerFeature:t,verticesPerCoordinate:r,drawCallsPerFeature:i,memory:a}):new o.AggregateSymbolComplexity(n,{verticesPerFeature:t,verticesPerCoordinate:r,drawCallsPerFeature:i,memory:a})}const d={};function h(e,r){const n=p(e,r),l=a.hasEdges(r)?2:0;switch(r.type){case"extrude":return new o.SymbolComplexity({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:l,memory:n});case"fill":if("mesh-3d"===e.type)return new o.SymbolComplexity({drawCallsPerFeature:l,memory:n});if(null!=r.outline&&r.outline.size>0)return new o.SymbolComplexity({verticesPerFeature:-12,verticesPerCoordinate:9,memory:n});case"water":return new o.SymbolComplexity({verticesPerFeature:-6,verticesPerCoordinate:3,memory:n});case"line":return new o.SymbolComplexity({verticesPerFeature:-6,verticesPerCoordinate:6,memory:n});case"object":return r.resource?.href?new o.EstimatedSymbolComplexity({verticesPerFeature:100,memory:n}):{...f(r.resource?.primitive??i.defaultPrimitive),memory:n};case"path":{let e=0,i=0;switch(r.profile){case"circle":e=s.pathNumCircleProfileSubdivisions;break;case"quad":e=4;break;default:return void t.neverReached(r.profile)}switch(r.join){case"round":i=s.pathNumRoundJoinSubdivisions;break;case"miter":case"bevel":i=1;break;default:return}const a=2*e,l=e*i*2,c=l+a;let u=-2*l-a;switch(r.cap){case"none":break;case"butt":case"square":u+=2*(e-1);break;case"round":u+=2*(e*(s.pathNumRoundCapExtrusionSubdivisions-1)*2+e);break;default:return}return new o.SymbolComplexity({verticesPerFeature:u,verticesPerCoordinate:c,memory:n})}case"text":{const t="label-3d"===e.type?0:2;return new o.SymbolComplexity({verticesPerFeature:6,memory:n,drawCallsPerFeature:t})}case"icon":return new o.SymbolComplexity({verticesPerFeature:6,memory:n});default:return}}function p(e,r){const i="point-3d"===e.type;switch(r.type){case"extrude":return r.edges&&r.edges.size>0?g.EXTRUDE_EDGES:g.EXTRUDE;case"fill":return null!=r.outline&&r.outline.size>0?g.FILL_OUTLINE:g.FILL;case"water":return g.FILL;case"line":return"round"===r.join?g.LINE_ROUND:g.LINE_MITER;case"path":switch(r.join){case"round":switch(r.profile){case"circle":return g.PATH_ROUND_CIRCLE;case"quad":return g.PATH_ROUND_QUAD;default:return void t.neverReached(r.profile)}case"miter":case"bevel":switch(r.profile){case"circle":return g.PATH_MITER_CIRCLE;case"quad":return g.PATH_MITER_QUAD;default:return void t.neverReached(r.profile)}default:return}case"object":return i?g.OBJECT_POINT:g.OBJECT_POLYGON;case"icon":case"text":return i?g.ICON_POINT:g.ICON_POLYGON;default:return}}function f(e){const t=d[e];if(t)return t;const r=m(n.primitiveLodResources(e,new l.DefaultMaterial({},{spherical:!0})).levels);return d[e]=new o.SymbolComplexity({verticesPerFeature:r}),d[e]}function m(e){return e.reduce((e,t,r)=>e+t.numVertices*(1/10**r),0)/e.reduce((e,t,r)=>e+1/10**r,0)}const g={ICON_POINT:{bytesPerFeature:3063,bytesPerFeatureLabel:3813,resourceBytes:0,draped:{bytesPerFeature:2010,bytesPerFeatureLabel:3851}},ICON_POLYGON:{bytesPerFeature:3222,bytesPerFeatureLabel:2792,resourceBytes:0,draped:{bytesPerFeature:1408,bytesPerFeatureLabel:2523}},OBJECT_POINT:{bytesPerFeature:477,bytesPerFeatureLabel:3260,resourceBytes:0,draped:{bytesPerFeature:477,bytesPerFeatureLabel:3260}},OBJECT_POLYGON:{bytesPerFeature:586,bytesPerFeatureLabel:2250,resourceBytes:0,draped:{bytesPerFeature:586,bytesPerFeatureLabel:2250}},LINE_MITER:{bytesPerFeature:1660,bytesPerFeatureLabel:2326,resourceBytes:0,draped:{bytesPerFeature:1221,bytesPerFeatureLabel:1970}},LINE_ROUND:{bytesPerFeature:544,bytesPerFeatureLabel:2173,resourceBytes:0,draped:{bytesPerFeature:383,bytesPerFeatureLabel:1808}},PATH_MITER_CIRCLE:{bytesPerFeature:22559,bytesPerFeatureLabel:2885,resourceBytes:0,draped:{bytesPerFeature:22559,bytesPerFeatureLabel:2885}},PATH_ROUND_CIRCLE:{bytesPerFeature:25707,bytesPerFeatureLabel:2666,resourceBytes:0,draped:{bytesPerFeature:25707,bytesPerFeatureLabel:2666}},PATH_MITER_QUAD:{bytesPerFeature:24444,bytesPerFeatureLabel:3248,resourceBytes:0,draped:{bytesPerFeature:24444,bytesPerFeatureLabel:3248}},PATH_ROUND_QUAD:{bytesPerFeature:24060,bytesPerFeatureLabel:3228,resourceBytes:0,draped:{bytesPerFeature:24060,bytesPerFeatureLabel:3228}},FILL:{bytesPerFeature:3558,bytesPerFeatureLabel:2829,resourceBytes:0,draped:{bytesPerFeature:1418,bytesPerFeatureLabel:2381}},FILL_OUTLINE:{bytesPerFeature:3793,bytesPerFeatureLabel:2371,resourceBytes:0,draped:{bytesPerFeature:1583,bytesPerFeatureLabel:2050}},EXTRUDE:{bytesPerFeature:4051,bytesPerFeatureLabel:2286,resourceBytes:0,draped:{bytesPerFeature:4051,bytesPerFeatureLabel:2286}},EXTRUDE_EDGES:{bytesPerFeature:3037,bytesPerFeatureLabel:1960,resourceBytes:0,draped:{bytesPerFeature:3037,bytesPerFeatureLabel:1960}}};if(r("esri-tests-disable-symbol-memory-estimators"))for(const e in g){const t=g[e];t.bytesPerFeature=0,t.bytesPerFeatureLabel=0,t.draped.bytesPerFeature=0,t.draped.bytesPerFeatureLabel=0}e.averageSymbolComplexities=function(e){const t=u(e);return t.numComplexities>0&&(t.verticesPerFeature/=t.numComplexities,t.verticesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.resourceBytes/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities),t},e.defaultSymbolComplexity=function(e){return"web-style"===e.type?c:u(e.symbolLayers.toArray().map(t=>h(e,t)))},e.defaultSymbolLayerComplexity=h,e.defaultSymbolLayerMemoryComplexity=p,e.emptySymbolComplexity=c,e.estimateNumVerticesForLods=m,e.totalSymbolComplexities=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DPathSymbolLayerConstants":function(){define(["exports"],function(e){"use strict";e.pathNumCircleProfileSubdivisions=10,e.pathNumRoundCapExtrusionSubdivisions=3,e.pathNumRoundJoinSubdivisions=3,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/primitiveObjectSymbolUtils":function(){define(["exports","../../../../core/has","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/lodRendering/LodResources"],function(e,t,r,i){"use strict";const s=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];e.isValidPrimitive=function(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1},e.primitiveLodResources=function(e,t){const n=(e,t,s=!1)=>new i.LodResources(e.map(e=>{const n=t(e.tesselation);return s&&r.cgToGIS(n),new i.LodLevelResources([new i.LodComponentResources(new i.LodComponentEngineGeometry(n))],e.minScreenSpaceRadius)}));switch(e){case"sphere":return n([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],e=>r.createPolySphereGeometry(t,.5,e,!0));case"cube":return n([{tesselation:0,minScreenSpaceRadius:0}],()=>r.createBoxGeometry(t,1));case"cone":return n(s,e=>r.createConeGeometry(t,1,.5,e,!1),!0);case"inverted-cone":return n(s,e=>r.createConeGeometry(t,1,.5,e,!0),!0);case"cylinder":return n(s,e=>r.createCylinderGeometry(t,1,.5,e,[0,0,1],[0,0,.5]));case"tetrahedron":return n([{tesselation:0,minScreenSpaceRadius:0}],()=>r.createTetrahedronGeometry(t,1),!0);case"diamond":return n([{tesselation:0,minScreenSpaceRadius:0}],()=>r.createDiamondGeometry(t,1),!0);default:return}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/GeometryUtil":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/DoubleArray","../../../../geometry/support/FloatArray","../../../../geometry/support/Indices","../../../../geometry/support/plane","../../../../geometry/support/ray","../../support/engineContent/line","./Attribute","./bufferVectorMath","./Geometry","./Util"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const f=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],m=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],g=[0,0,1,0,1,1,0,1],y=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],_=new Array(36);for(let e=0;e<6;e++)for(let t=0;t<6;t++)_[6*e+t]=e;const b=new Array(36);for(let e=0;e<6;e++)b[6*e]=0,b[6*e+1]=1,b[6*e+2]=2,b[6*e+3]=2,b[6*e+4]=3,b[6*e+5]=0;const v=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],w=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],x=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],S=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7],T=r.fromValues(-.5,0,-.5),C=r.fromValues(.5,0,-.5),P=r.fromValues(0,0,.5),M=r.fromValues(0,.5,0),R=r.create(),O=r.create(),I=r.create(),F=r.create(),A=r.create();t.subtract(R,T,M),t.subtract(O,T,C),t.cross(I,R,O),t.normalize(I,I),t.subtract(R,C,M),t.subtract(O,C,P),t.cross(F,R,O),t.normalize(F,F),t.subtract(R,P,M),t.subtract(O,P,T),t.cross(A,R,O),t.normalize(A,A);const D=[T,C,P,M],E=[0,-1,0,I[0],I[1],I[2],F[0],F[1],F[2],A[0],A[1],A[2]],L=[0,1,2,3,1,0,3,2,1,3,0,2],V=[0,0,0,1,1,1,2,2,2,3,3,3];function U(e,t,r){const i=e;let s,o;if(r)s=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],o=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const e=i*(1+Math.sqrt(5))/2;s=[-i,e,0,i,e,0,-i,-e,0,i,-e,0,0,-i,e,0,i,e,0,-i,-e,0,i,-e,e,0,-i,e,0,i,-e,0,-i,-e,0,i],o=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let t=0;t<s.length;t+=3)d.scale(s,t,e/d.length(s,t));let a={};function l(t,r){t>r&&([t,r]=[r,t]);const i=t.toString()+"."+r.toString();if(a[i])return a[i];let n=s.length;return s.length+=3,d.add(s,3*t,s,3*r,s,n),d.scale(s,n,e/d.length(s,n)),n/=3,a[i]=n,n}for(let e=0;e<t;e++){const e=o.length,t=new Array(4*e);for(let r=0;r<e;r+=3){const e=o[r],i=o[r+1],s=o[r+2],n=l(e,i),a=l(i,s),c=l(s,e),u=4*r;t[u]=e,t[u+1]=n,t[u+2]=c,t[u+3]=i,t[u+4]=a,t[u+5]=n,t[u+6]=s,t[u+7]=c,t[u+8]=a,t[u+9]=n,t[u+10]=a,t[u+11]=c}o=t,a={}}const c=n.floatArrayFrom(s);for(let e=0;e<c.length;e+=3)d.normalize(c,e);return[["position",new u.Attribute(n.floatArrayFrom(s),o,3,!0)],["normal",new u.Attribute(c,o,3,!0)]]}const B=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function N(e,t,i,s,o=!0,a=!0){let l=0;const c=t,d=e;let h=r.fromValues(0,l,0),p=r.fromValues(0,l+d,0),f=r.fromValues(0,-1,0),m=r.fromValues(0,1,0);s&&(l=d,p=r.fromValues(0,0,0),h=r.fromValues(0,l,0),f=r.fromValues(0,1,0),m=r.fromValues(0,-1,0));const g=[p,h],y=[f,m],_=i+2,b=Math.sqrt(d*d+c*c);if(s)for(let e=i-1;e>=0;e--){const t=e*(2*Math.PI/i),s=r.fromValues(Math.cos(t)*c,l,Math.sin(t)*c);g.push(s);const n=r.fromValues(d*Math.cos(t)/b,-c/b,d*Math.sin(t)/b);y.push(n)}else for(let e=0;e<i;e++){const t=e*(2*Math.PI/i),s=r.fromValues(Math.cos(t)*c,l,Math.sin(t)*c);g.push(s);const n=r.fromValues(d*Math.cos(t)/b,c/b,d*Math.sin(t)/b);y.push(n)}const v=new Array,w=new Array;if(o){for(let e=3;e<g.length;e++)v.push(1),v.push(e-1),v.push(e),w.push(0),w.push(0),w.push(0);v.push(g.length-1),v.push(2),v.push(1),w.push(0),w.push(0),w.push(0)}if(a){for(let e=3;e<g.length;e++)v.push(e),v.push(e-1),v.push(0),w.push(e),w.push(e-1),w.push(1);v.push(0),v.push(2),v.push(g.length-1),w.push(1),w.push(2),w.push(y.length-1)}const x=n.newFloatArray(3*_);for(let e=0;e<_;e++)x[3*e]=g[e][0],x[3*e+1]=g[e][1],x[3*e+2]=g[e][2];const S=n.newFloatArray(3*_);for(let e=0;e<_;e++)S[3*e]=y[e][0],S[3*e+1]=y[e][1],S[3*e+2]=y[e][2];return[["position",new u.Attribute(x,v,3,!0)],["normal",new u.Attribute(S,w,3,!0)]]}function k(e,s,o,c,d,p,f=r.fromValues(0,0,0)){const m=s.length,g=n.newFloatArray(o.length*m*3+(6*c.length||0)),y=n.newFloatArray(o.length*m*3+(c?6:0)),_=new Array,b=new Array;let v=0,w=0;const x=i.create(),S=i.create(),T=i.create(),C=i.create(),P=i.create(),M=i.create(),R=i.create(),O=i.create(),I=i.create(),F=i.create(),A=i.create(),D=i.create(),E=i.create(),L=a.create();t.set(I,0,1,0),t.subtract(S,o[1],o[0]),t.normalize(S,S),p?(t.add(O,o[0],f),t.normalize(T,O)):t.set(T,0,0,1),j(S,T,I,I,P,T,G),t.copy(C,T),t.copy(D,P);for(let e=0;e<c.length;e++)t.scale(M,P,c[e][0]),t.scale(O,T,c[e][2]),t.add(M,M,O),t.add(M,M,o[0]),g[v++]=M[0],g[v++]=M[1],g[v++]=M[2];y[w++]=-S[0],y[w++]=-S[1],y[w++]=-S[2];for(let e=0;e<d.length;e++)_.push(d[e][0]>0?d[e][0]:-d[e][0]-1+c.length),_.push(d[e][1]>0?d[e][1]:-d[e][1]-1+c.length),_.push(d[e][2]>0?d[e][2]:-d[e][2]-1+c.length),b.push(0),b.push(0),b.push(0);let V=c.length;const U=c.length-1;for(let e=0;e<o.length;e++){let r=!1;e>0&&(t.copy(x,S),e<o.length-1?(t.subtract(S,o[e+1],o[e]),t.normalize(S,S)):r=!0,t.add(F,x,S),t.normalize(F,F),t.add(A,o[e-1],C),a.fromPositionAndNormal(o[e],F,L),a.intersectRay(L,l.wrap(A,x),O)?(t.subtract(O,O,o[e]),t.normalize(T,O),t.cross(P,F,T),t.normalize(P,P)):j(F,C,D,I,P,T,G),t.copy(C,T),t.copy(D,P)),p&&(t.add(O,o[e],f),t.normalize(E,O));for(let i=0;i<m;i++)if(t.scale(M,P,s[i][0]),t.scale(O,T,s[i][1]),t.add(M,M,O),t.normalize(R,M),y[w++]=R[0],y[w++]=R[1],y[w++]=R[2],t.add(M,M,o[e]),g[v++]=M[0],g[v++]=M[1],g[v++]=M[2],!r){const e=(i+1)%m;_.push(V+i),_.push(V+m+i),_.push(V+e),_.push(V+e),_.push(V+m+i),_.push(V+m+e);for(let e=0;e<6;e++){const t=_.length-6;b.push(_[t+e]-U)}}V+=m}const B=o[o.length-1];for(let e=0;e<c.length;e++)t.scale(M,P,c[e][0]),t.scale(O,T,c[e][1]),t.add(M,M,O),t.add(M,M,B),g[v++]=M[0],g[v++]=M[1],g[v++]=M[2];const N=w/3;y[w++]=S[0],y[w++]=S[1],y[w++]=S[2];const k=V-m;for(let e=0;e<d.length;e++)_.push(d[e][0]>=0?V+d[e][0]:-d[e][0]-1+k),_.push(d[e][2]>=0?V+d[e][2]:-d[e][2]-1+k),_.push(d[e][1]>=0?V+d[e][1]:-d[e][1]-1+k),b.push(N),b.push(N),b.push(N);const z=[["position",new u.Attribute(g,_,3,!0)],["normal",new u.Attribute(y,b,3,!0)]];return new h.Geometry(e,z)}function z(e,r,i,s,n){return!(Math.abs(t.dot(r,e))>n||(t.cross(i,e,r),t.normalize(i,i),t.cross(s,i,e),t.normalize(s,s),0))}function j(e,t,r,i,s,n,o){return z(e,t,s,n,o)||z(e,r,s,n,o)||z(e,i,s,n,o)}const G=.99619469809,q=i.create();e.cgToGIS=function(e,t=e){const r=e.attributes,i=r.get("position").data,s=r.get("normal").data;if(s){const e=t.getMutableAttribute("normal").data;for(let t=0;t<s.length;t+=3){const r=s[t+1];e[t+1]=-s[t+2],e[t+2]=r}}if(i){const e=t.getMutableAttribute("position").data;for(let t=0;t<i.length;t+=3){const r=i[t+1];e[t+1]=-i[t+2],e[t+2]=r}}},e.createBoxGeometry=function(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(24);for(let e=0;e<8;e++)r[3*e]=f[e][0]*t[0],r[3*e+1]=f[e][1]*t[1],r[3*e+2]=f[e][2]*t[2];return new h.Geometry(e,[["position",new u.Attribute(r,y,3,!0)],["normal",new u.Attribute(m,_,3)],["uv0",new u.Attribute(g,b,2)]])},e.createConeGeometry=function(e,t,r,i,s,n=!0,o=!0){return new h.Geometry(e,N(t,r,i,s,n,o))},e.createConeGeometryData=N,e.createCylinderGeometry=function(e,i,s,o,a,l,c){const d=a?r.clone(a):r.fromValues(1,0,0),p=l?r.clone(l):r.fromValues(0,0,0);c??=!0;const f=r.create();t.normalize(f,d);const m=r.create();t.scale(m,f,Math.abs(i));const g=r.create();t.scale(g,m,-.5),t.add(g,g,p);const y=r.fromValues(0,1,0);Math.abs(1-t.dot(f,y))<.2&&t.set(y,0,0,1);const _=r.create();t.cross(_,f,y),t.normalize(_,_),t.cross(y,_,f);const b=2*o+(c?2:0),v=o+(c?2:0),w=n.newFloatArray(3*b),x=n.newFloatArray(3*v),S=n.newFloatArray(2*b),T=new Array(3*o*(c?4:2)),C=new Array(3*o*(c?4:2));c&&(w[3*(b-2)]=g[0],w[3*(b-2)+1]=g[1],w[3*(b-2)+2]=g[2],S[2*(b-2)]=0,S[2*(b-2)+1]=0,w[3*(b-1)]=w[3*(b-2)]+m[0],w[3*(b-1)+1]=w[3*(b-2)+1]+m[1],w[3*(b-1)+2]=w[3*(b-2)+2]+m[2],S[2*(b-1)]=1,S[2*(b-1)+1]=1,x[3*(v-2)]=-f[0],x[3*(v-2)+1]=-f[1],x[3*(v-2)+2]=-f[2],x[3*(v-1)]=f[0],x[3*(v-1)+1]=f[1],x[3*(v-1)+2]=f[2]);const P=(e,t,r)=>{T[e]=t,C[e]=r};let M=0;const R=r.create(),O=r.create();for(let e=0;e<o;e++){const r=e*(2*Math.PI/o);t.scale(R,y,Math.sin(r)),t.scale(O,_,Math.cos(r)),t.add(R,R,O),x[3*e]=R[0],x[3*e+1]=R[1],x[3*e+2]=R[2],t.scale(R,R,s),t.add(R,R,g),w[3*e]=R[0],w[3*e+1]=R[1],w[3*e+2]=R[2],S[2*e]=e/o,S[2*e+1]=0,w[3*(e+o)]=w[3*e]+m[0],w[3*(e+o)+1]=w[3*e+1]+m[1],w[3*(e+o)+2]=w[3*e+2]+m[2],S[2*(e+o)]=e/o,S[2*e+1]=1;const i=(e+1)%o;P(M++,e,e),P(M++,e+o,e),P(M++,i,i),P(M++,i,i),P(M++,e+o,e),P(M++,i+o,i)}if(c){for(let e=0;e<o;e++){const t=(e+1)%o;P(M++,b-2,v-2),P(M++,e,v-2),P(M++,t,v-2)}for(let e=0;e<o;e++){const t=(e+1)%o;P(M++,e+o,v-1),P(M++,b-1,v-1),P(M++,t+o,v-1)}}const I=[["position",new u.Attribute(w,T,3,!0)],["normal",new u.Attribute(x,C,3,!0)],["uv0",new u.Attribute(S,T,2,!0)]];return new h.Geometry(e,I)},e.createDiamondGeometry=function(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(18);for(let e=0;e<6;e++)r[3*e]=v[e][0]*t[0],r[3*e+1]=v[e][1]*t[1],r[3*e+2]=v[e][2]*t[2];return new h.Geometry(e,[["position",new u.Attribute(r,x,3,!0)],["normal",new u.Attribute(w,S,3)]])},e.createExtrudedTriangle=function(e,t,r,i,s,n=0){const o=new Array(18),a=[[-r,n,s/2],[i,n,s/2],[0,t+n,s/2],[-r,n,-s/2],[i,n,-s/2],[0,t+n,-s/2]];for(let e=0;e<6;e++)o[3*e]=a[e][0],o[3*e+1]=a[e][1],o[3*e+2]=a[e][2];return new h.Geometry(e,[["position",new u.Attribute(o,[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5],3,!0)]])},e.createPathExtrusionGeometry=k,e.createPointGeometry=function(e,{normal:t,position:r,color:s,rotation:n,size:a,centerOffsetAndDistance:l,uvi:c,featureAttribute:d,olidColor:p=null}={}){const f=r?i.clone(r):i.create(),m=t?i.clone(t):i.fromValues(0,0,1),g=s?[s[0],s[1],s[2],s.length>3?s[3]:255]:[255,255,255,255],y=null!=a&&2===a.length?a:[1,1],_=null!=n?[n]:[0],b=o.getZeroIndexArray(1),v=[["position",new u.Attribute(f,b,3,!0)],["normal",new u.Attribute(m,b,3,!0)],["color",new u.Attribute(g,b,4,!0)],["size",new u.Attribute(y,b,2)],["rotation",new u.Attribute(_,b,1,!0)]];if(c&&v.push(["uvi",new u.Attribute(c,b,c.length)]),null!=l){const e=[l[0],l[1],l[2],l[3]];v.push(["centerOffsetAndDistance",new u.Attribute(e,b,4)])}if(d){const e=[d[0],d[1],d[2],d[3]];v.push(["featureAttribute",new u.Attribute(e,b,4)])}return new h.Geometry(e,v,null,1,p)},e.createPolySphereData=U,e.createPolySphereGeometry=function(e,t,r,i){const s=U(t,r,i);return new h.Geometry(e,s)},e.createPolylineGeometry=function(e,t,r,i,a){const l=s.newDoubleArray(3*t.length),d=new Array(2*(t.length-1));let p=0,f=0;for(let e=0;e<t.length;e++){for(let r=0;r<3;r++)l[p++]=t[e][r];e>0&&(d[f++]=e-1,d[f++]=e)}const m=[["position",new u.Attribute(l,d,3,!0)]];if(r&&r.length===t.length&&3===r[0].length){const e=n.newFloatArray(3*r.length);let i=0;for(let s=0;s<t.length;s++)for(let t=0;t<3;t++)e[i++]=r[s][t];m.push(["normal",new u.Attribute(e,d,3,!0)])}if(i&&m.push(["color",new u.Attribute(i,o.getContinuousIndexArray(i.length/4),4)]),a&&a.length===t.length){const e=c.timeStampsToAttribute(a);m.push(["timeStamps",new u.Attribute(e,d,3,!0)])}return new h.Geometry(e,m,null,2)},e.createSphereGeometry=function(e,t,r,i,s={uv:!0}){const a=-Math.PI,l=2*Math.PI,c=-Math.PI/2,d=Math.PI,p=Math.max(3,Math.floor(r)),f=Math.max(2,Math.floor(i)),m=(p+1)*(f+1),g=n.newFloatArray(3*m),y=n.newFloatArray(3*m),_=n.newFloatArray(2*m),b=[];let v=0;for(let e=0;e<=f;e++){const r=[],i=e/f,s=c+i*d,n=Math.cos(s);for(let e=0;e<=p;e++){const o=e/p,c=a+o*l,u=Math.cos(c)*n,d=Math.sin(s),h=-Math.sin(c)*n;g[3*v]=u*t,g[3*v+1]=d*t,g[3*v+2]=h*t,y[3*v]=u,y[3*v+1]=d,y[3*v+2]=h,_[2*v]=o,_[2*v+1]=i,r.push(v),++v}b.push(r)}const w=new Array;for(let e=0;e<f;e++)for(let t=0;t<p;t++){const r=b[e][t],i=b[e][t+1],s=b[e+1][t+1],n=b[e+1][t];0===e?(w.push(r),w.push(s),w.push(n)):e===f-1?(w.push(r),w.push(i),w.push(s)):(w.push(r),w.push(i),w.push(s),w.push(s),w.push(n),w.push(r))}const x=[["position",new u.Attribute(g,w,3,!0)],["normal",new u.Attribute(y,w,3,!0)]];return s.uv&&x.push(["uv0",new u.Attribute(_,w,2,!0)]),s.offset&&(x[0][0]="offset",x.push(["position",new u.Attribute(Float64Array.from(s.offset),o.getZeroIndexArray(w.length),3,!0)])),new h.Geometry(e,x)},e.createSquareGeometry=function(e,t=B){const r=new Array(12);for(let e=0;e<4;e++)for(let i=0;i<3;i++)r[3*e+i]=t[e][i];const i=[0,1,2,2,3,0],s=[0,0,0,0,0,0],n=[["position",new u.Attribute(r,i,3,!0)],["normal",new u.Attribute([0,0,1],s,3,!0)],["uv0",new u.Attribute([0,0,1,0,1,1,0,1],i,2,!0)],["color",new u.Attribute([255,255,255,255],s,4,!0)]];return new h.Geometry(e,n)},e.createTetrahedronGeometry=function(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(12);for(let e=0;e<4;e++)r[3*e]=D[e][0]*t[0],r[3*e+1]=D[e][1]*t[1],r[3*e+2]=D[e][2]*t[2];return new h.Geometry(e,[["position",new u.Attribute(r,L,3,!0)],["normal",new u.Attribute(E,V,3)]])},e.createTubeGeometry=function(e,t,r,i,s,n){i=i||10,s=null==s||s,p.assert(t.length>1);const o=[],a=[];for(let e=0;e<i;e++){o.push([0,-e-1,-(e+1)%i-1]);const t=e/i*2*Math.PI;a.push([Math.cos(t)*r,Math.sin(t)*r])}return k(e,a,t,[[0,0,0]],o,s,n)},e.makeOrthoBasisDirUpFallback=j,e.transformInPlace=function(e,r){const i=e.getMutableAttribute("position").data;for(let e=0;e<i.length;e+=3){const s=i[e],n=i[e+1],o=i[e+2];t.set(q,s,n,o),t.transformMat4(q,q,r),i[e]=q[0],i[e+1]=q[1],i[e+2]=q[2]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/FloatArray":function(){define(["exports","../../core/typedArrayUtil"],function(e,t){"use strict";e.compactFloatArray=function(e){return Array.isArray(e)?e.length<t.nativeArrayMaxSize?e:new Float32Array(e):e.length<t.nativeArrayMaxSize?Array.from(e):e},e.floatArrayFrom=function(e){return(Array.isArray(e)?e.length:e.byteLength/8)<=t.nativeArrayMaxSize?Array.from(e):new Float32Array(e)},e.floatSubArray=function(e,t,r){return Array.isArray(e)?e.slice(t,t+r):e.subarray(t,t+r)},e.newFloatArray=function(e,r=!1){return e<=t.nativeArrayMaxSize?r?new Array(e).fill(0):new Array(e):new Float32Array(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/engineContent/line":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/ellipsoidUtils","../../../../geometry/projection/projectors","../../../../geometry/support/DoubleArray","../../../../geometry/support/FloatArray","../../../../geometry/support/HalfFloatArray","../../../../geometry/support/Indices","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/Geometry"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h=r.create(),p=r.create();function f(e){const t=l.newHalfFloatArray(3*e.length),r=e[0],i=e[e.length-1];for(let s=0;s<e.length;s++)t[3*s]=e[s],t[3*s+1]=r,t[3*s+2]=i;return t}e.createGeometry=function(e,r,l=null){const f=[],m=r.mapPositions;!function(e,t){const{attributeData:{position:r},removeDuplicateStartEnd:i}=e,s=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(r)&&i,n=r.length/3-(s?1:0),o=new Array(2*(n-1)),a=s?r.slice(0,-3):r;let l=0;for(let e=0;e<n-1;e++)o[l++]=e,o[l++]=e+1;t.push(["position",new u.Attribute(a,o,3,s)])}(r,f);const g=f[0][1].data,y=f[0][1].indices.length,_=c.getZeroIndexArray(y);return function(e,t,r){if(null!=e.attributeData.colorFeature)return;const s=e.attributeData.color;t.push(["color",new u.Attribute(s??i.ONES,r,4)])}(r,f,_),function(e,t,r){null==e.attributeData.sizeFeature&&t.push(["size",new u.Attribute([e.attributeData.size??1],r,1,!0)])}(r,f,_),function(e,t,r){e.attributeData.normal&&t.push(["normal",new u.Attribute(e.attributeData.normal,r,3)])}(r,f,_),function(e,t,r){null!=e.attributeData.colorFeature&&t.push(["colorFeatureAttribute",new u.Attribute([e.attributeData.colorFeature],r,1,!0)])}(r,f,_),function(e,t,r){null!=e.attributeData.sizeFeature&&t.push(["sizeFeatureAttribute",new u.Attribute([e.attributeData.sizeFeature],r,1,!0)])}(r,f,_),function(e,t){const{attributeData:{position:r,timeStamps:i}}=e;if(!i)return;const s=r.length/3,n=new Array(2*(s-1));let o=0;for(let e=0;e<s-1;e++)n[o++]=e,n[o++]=e+1;t.push(["timeStamps",new u.Attribute(i,n,3)])}(r,f),function(e,t,r){null!=e.attributeData.opacityFeature&&t.push(["opacityFeatureAttribute",new u.Attribute([e.attributeData.opacityFeature],r,1,!0)])}(r,f,_),function(e,r,i){if(null==e.overlayInfo||1!==e.overlayInfo.renderCoordsHelper.viewingMode||!e.overlayInfo.spatialReference.isGeographic)return;const l=o.newDoubleArray(i.length),c=s.getReferenceEllipsoid(e.overlayInfo.spatialReference);for(let e=0;e<l.length;e+=3)n.lonLatToWebMercatorComparable(i,e,l,e,c);const d=i.length/3,f=a.newFloatArray(d+1);let m=h,g=p,y=0,_=0;t.set(m,l[_++],l[_++]),_++,f[0]=0;for(let e=1;e<d+1;++e)e===d&&(_=0),t.set(g,l[_++],l[_++]),_++,y+=t.dist(m,g),f[e]=y,[m,g]=[g,m];r.push(["distanceToStart",new u.Attribute(f,r[0][1].indices,1,!0)])}(r,f,g),new d.Geometry(e,f,m,2,l)},e.getLinearTimeStamps=function(e,t=0,r=.01){const i=l.newHalfFloatArray(e.length);i[0]=0;for(let t=1;t<e.length;t++){const r=e[t-1],s=e[t],n=Math.sqrt((s[0]-r[0])**2+(s[1]-r[1])**2+(s[2]-r[2])**2);i[t]=i[t-1]+n}const s=i.map(e=>e*r);if(0!==t&&t<s.length){const e=s[t];for(let t=0;t<s.length;t++)s[t]-=e}return s},e.lineStripsToParameters=function(e,t,r){if(null==e||0===e.length)return[];const i=[];return e.forEach((e,s)=>{const n=e.length,a=o.newDoubleArray(3*n);e.forEach((e,t)=>{a[3*t]=e[0],a[3*t+1]=e[1],a[3*t+2]=e[2]});const l=null!=r?f(r[s]):void 0,c={attributeData:{position:a,normal:t,timeStamps:l},removeDuplicateStartEnd:!1};i.push(c)}),i},e.timeStampsToAttribute=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/HalfFloatArray":function(){define(["exports","../../core/typedArrayUtil","./float16"],function(e,t,r){"use strict";e.compactHalfFloatArray=function(e){return Array.isArray(e)?e.length<t.nativeArrayMaxSize?e:r.makeFloat16Array(e):e.length<t.nativeArrayMaxSize?Array.from(e):e},e.halfFloatSubArray=function(e,t,r){return Array.isArray(e)?e.slice(t,t+r):e.subarray(t,t+r)},e.newHalfFloatArray=function(e,i=!1){return e<=t.nativeArrayMaxSize?i?new Array(e).fill(0):new Array(e):r.makeFloat16Array(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/bufferVectorMath":function(){define(["exports"],function(e){"use strict";e.add=function(e,t,r,i,s,n=t){(s=s||e)[n]=e[t]+r[i],s[n+1]=e[t+1]+r[i+1],s[n+2]=e[t+2]+r[i+2]},e.length=function(e,t){const r=e[t],i=e[t+1],s=e[t+2];return Math.sqrt(r*r+i*i+s*s)},e.normalize=function(e,t){const r=e[t],i=e[t+1],s=e[t+2],n=1/Math.sqrt(r*r+i*i+s*s);e[t]*=n,e[t+1]*=n,e[t+2]*=n},e.scale=function(e,t,r){e[t]*=r,e[t+1]*=r,e[t+2]*=r},e.subtract=function(e,t,r,i,s,n=t){(s=s||e)[n]=e[t]-r[i],s[n+1]=e[t+1]-r[i+1],s[n+2]=e[t+2]-r[i+2]},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/lodRendering/LodResources":function(){define(["exports","../../../../../core/arrayUtils","../../../../../core/memoryEstimations","../IntersectorResult","./Intersector"],function(e,t,r,i,s){"use strict";class n{constructor(e,t,r,i){this.material=e,this.buffer=t,this.numVertices=r,this.boundingInfo=i,this.bufferWriter=e.createBufferWriter()}get layout(){return this.bufferWriter.layout}get numTriangles(){return this.numVertices/3}computeUsedMemory(){return this.buffer.byteLength+r.baseTypedArrayMemory}get renderGeometry(){return this}intersect(e,t,r,i,s,n,a,l){const c=this.bufferWriter,u=this.buffer;c.intersect(u,this.material.parameters,null,e,r,i,(r,i,c)=>o(r,i,c,e,t,n,a,s,l))}}function o(e,t,r,n,o,a,l,c,u){if(e<0)return;if(o&&!o(n.rayBegin,n.rayEnd,e))return;const d=new s.LodTarget(a.layerViewUid,a.graphicUid(c),r,l,u);if((null==n.results.min.distance||e<n.results.min.distance)&&n.results.min.set(6,d,e,t,n.transform.transform),(null==n.results.max.distance||e>n.results.max.distance)&&n.results.max.set(6,d,e,t,n.transform.transform),2===n.options.store){const r=new i.IntersectorResult(n.results.min.ray);r.set(6,d,e,t,n.transform.transform),n.results.all.push(r)}}e.LodComponentEngineGeometry=class{constructor(e){this.engineGeometry=e;const t=this.material,r=this.engineGeometry,i=r.attributes,s=r.boundingInfo,o=t.createBufferWriter(),a=o.layout,l=o.elementCount(i),c=a.createBuffer(l);o.write(null,null,i,null,c,0),this.renderGeometry=new n(t,c.buffer,l,s)}get material(){return this.engineGeometry.material}get numVertices(){return this.engineGeometry.indexCount}get numTriangles(){return this.numVertices/3}get boundingInfo(){return this.engineGeometry.boundingInfo}computeUsedMemory(){return Array.from(this.engineGeometry.attributes.values()).reduce((e,t)=>e+r.estimateNumberArrayMemory(t.data,t.indices),0)}intersect(e,t,r,i,s,n,a,l){const c=this.engineGeometry;this.material.intersect(c,e.transform.transform,e,r,i,(r,i,c)=>o(r,i,c,e,t,n,a,s,l))}},e.LodComponentRenderGeometry=n,e.LodComponentResources=class{constructor(e,t=null){this.geometry=e,this.textures=t}get material(){return this.geometry.material}get numTriangles(){return this.geometry.numTriangles}},e.LodLevelResources=class{constructor(e,r,i){this.components=e,this.minScreenSpaceRadius=r,this.pivotOffset=i;const s=t.unique(this.components.map(e=>e.geometry));this.numVertices=s.reduce((e,t)=>e+t.numVertices,0)}},e.LodResources=class{constructor(e){this.levels=e,this.levels.sort((e,t)=>e.minScreenSpaceRadius===t.minScreenSpaceRadius?e.numVertices-t.numVertices:e.minScreenSpaceRadius-t.minScreenSpaceRadius)}get materialParameters(){return this.levels[0].components[0].geometry.material.parameters}getMaterials(){const e=[];return this.levels.forEach(t=>t.components.forEach(t=>e.push(t.geometry.material))),t.unique(e)}getTextures(){const e=new Array;return this.levels.forEach(t=>t.components.forEach(t=>{null!=t.textures&&e.push(...t.textures)})),t.unique(e)}getGeometries(){const e=new Array;return this.levels.forEach(t=>t.components.forEach(t=>{e.push(t.geometry)})),t.unique(e)}getEngineGeometries(){return this.getGeometries().map(e=>e.engineGeometry).filter(e=>null!=e)}computeUsedMemory(){const e=this.getGeometries(),t=this.getTextures(),r=e.reduce((e,t)=>e+t.computeUsedMemory(),0);return t.reduce((e,t)=>e+t.usedMemory,0)+r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/lodRendering/Intersector":function(){define(["exports","../IntersectorResult","../IntersectorTarget"],function(e,t,r){"use strict";class i extends r.Graphic3DTarget{constructor(e,t,r,i,s){super(e,t),this.layerViewUid=e,this.graphicUid=t,this.triangleNr=r,this.baseBoundingSphere=i,this.numLodLevels=s}}e.LodTarget=i,e.isLodIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&6===e.intersector&&!!e.target},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/IntersectorTarget":function(){define(["exports"],function(e){"use strict";class t{constructor(e){this.layerViewUid=e}}e.Graphic3DTarget=class extends t{constructor(e,t){super(e),this.graphicUid=t}},e.LayerTarget=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/SymbolComplexity":function(){define(["exports"],function(e){"use strict";class t{constructor(e){this.estimated=!1,this.verticesPerFeature=e.verticesPerFeature??0,this.verticesPerCoordinate=e.verticesPerCoordinate??0,this.drawCallsPerFeature=e.drawCallsPerFeature??0,this.memory=e.memory??new i}}class r extends t{constructor(e){super(e),this.estimated=!0}}class i{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}}e.AggregateSymbolComplexity=class extends t{constructor(e,t){super(t),this.numComplexities=e}},e.EstimatedAggregateSymbolComplexity=class extends r{constructor(e,t){super(t),this.numComplexities=e}},e.EstimatedSymbolComplexity=r,e.SymbolComplexity=t,e.SymbolComplexityMemory=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/edgeUtils":function(){define(["exports","../../../../Color","../../../../core/has","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec4f64","./layerUtils"],function(e,t,r,i,s,n){"use strict";function o(e,r){if(null==e)return null;const n=null!=e.color?s.fromArray(t.toUnitRGBA(e.color)):s.fromValues(0,0,0,0),o=i.pt2px(e.size),l=i.pt2px(e.extensionLength);switch(e.type){case"solid":return a({color:n,size:o,extensionLength:l,...r});case"sketch":return function(e){return{...c,...e,type:1}}({color:n,size:o,extensionLength:l,...r});default:return}}function a(e){return{...l,...e,type:0}}const l={color:s.fromValues(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:1,hasSlicePlane:!1},c={color:s.fromValues(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:1,hasSlicePlane:!1};e.createMaterial=function(e,t){return o(function(e){return e&&e.enabled&&e.edges||null}(e),t)},e.createMaterialFromEdges=o,e.createSolidEdgeMaterial=a,e.hasEdges=function(e){return e&&e.enabled&&(n.isExtrudeSymbol3DLayer(e)||n.isFillSymbol3DLayer(e))&&null!=e.edges},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/layerUtils":function(){define(["exports"],function(e){"use strict";e.isExtrudeSymbol3DLayer=function(e){return"extrude"===e.type},e.isFillSymbol3DLayer=function(e){return"fill"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/DefaultMaterial":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../core/shaderLibrary/ShaderOutput","../lib/GLTextureMaterial","../lib/Material","../lib/OrderIndependentTransparency","../lib/RayIntersections","../lib/verticalOffsetUtils","./DefaultBufferWriter","./internal/MaterialUtil","../shaders/DefaultMaterialTechnique","../shaders/DefaultMaterialTechniqueConfiguration","../shaders/RealisticTreeTechnique","../../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";class m extends n.Material{constructor(e,t){super(e,y),this.materialType="default",this.supportsEdges=!0,this.intersectDraped=void 0,this.produces=new Map([[2,e=>(i.is3DGeometryOutputMRT(e)||i.isShadowRelatedOutput(e))&&!this.transparent],[4,e=>(i.is3DGeometryOutputMRT(e)||i.isShadowRelatedOutput(e))&&this.transparent&&this.parameters.writeDepth],[8,e=>(i.is3DGeometryOutputMRT(e)||i.isShadowRelatedOutput(e))&&this.transparent&&!this.parameters.writeDepth]]),this._layout=d.getLayout(this.parameters),this._configuration=new h.DefaultMaterialTechniqueConfiguration(t.spherical)}isVisibleForOutput(e){return 4!==e&&6!==e&&5!==e||this.parameters.castShadows}get visible(){const{layerOpacity:e,colorMixMode:t,opacity:r,externalColor:i}=this.parameters;return e*("replace"===t?1:r)*("ignore"===t||isNaN(i[3])?1:i[3])>=f.alphaCutoff}get _hasEmissiveBase(){return!!this.parameters.emissiveTextureId||!t.exactEquals(this.parameters.emissiveBaseColor,r.ZEROS)}get hasEmissions(){return this.parameters.emissiveStrength>0&&(0===this.parameters.emissiveSource&&this._hasEmissiveBase||1===this.parameters.emissiveSource)}getConfiguration(e,t){const{parameters:r,_configuration:s}=this,{treeRendering:n,doubleSided:a,doubleSidedType:l}=r;return super.getConfiguration(e,t,this._configuration),s.hasNormalTexture=r.hasNormalTexture,s.hasColorTexture=r.hasColorTexture,s.hasMetallicRoughnessTexture=r.hasMetallicRoughnessTexture,s.hasOcclusionTexture=r.hasOcclusionTexture,s.hasVertexTangents=!n&&r.hasVertexTangents,s.instanced=r.instanced,s.instancedDoublePrecision=r.instancedDoublePrecision,s.hasVVColor=!!r.vvColor,s.hasVVSize=!!r.vvSize,s.hasVerticalOffset=null!=r.verticalOffset,s.hasScreenSizePerspective=null!=r.screenSizePerspective,s.hasSlicePlane=r.hasSlicePlane,s.alphaDiscardMode=r.textureAlphaMode,s.normalType=n?0:r.normalType,s.transparent=this.transparent,s.writeDepth=r.writeDepth,s.customDepthTest=r.customDepthTest??0,s.hasOccludees=t.hasOccludees,s.cullFace=r.hasSlicePlane?0:r.cullFace,s.cullAboveTerrain=t.cullAboveTerrain,s.hasModelTransformation=!n&&null!=r.modelTransformation,s.hasVertexColors=r.hasVertexColors,s.hasSymbolColors=r.hasSymbolColors,s.doubleSidedMode=n?2:a&&"normal"===l?1:a&&"winding-order"===l?2:0,s.instancedFeatureAttribute=r.instancedFeatureAttribute,s.instancedColor=r.instancedColor,i.isColorOrColorEmission(e)?(s.terrainDepthTest=t.terrainDepthTest,s.receiveShadows=r.receiveShadows,s.receiveAmbientOcclusion=r.receiveAmbientOcclusion&&null!=t.ssao):(s.terrainDepthTest=!1,s.receiveShadows=s.receiveAmbientOcclusion=!1),s.textureAlphaPremultiplied=!!r.textureAlphaPremultiplied,s.pbrMode=r.usePBR?r.isSchematic?2:1:0,s.emissionSource=r.emissionSource,s.offsetBackfaces=!(!this.transparent||!r.offsetTransparentBackfaces),s.oitPass=t.oitPass,s.enableOffset=t.camera.relativeElevation<o.OITPolygonOffsetLimit,s.snowCover=t.snowCover,s.hasBloom=i.isColorEmission(e),s.hasColorTextureTransform=!!r.colorTextureTransformMatrix,s.hasNormalTextureTransform=!!r.normalTextureTransformMatrix,s.hasEmissionTextureTransform=!!r.emissiveTextureTransformMatrix,s.hasOcclusionTextureTransform=!!r.occlusionTextureTransformMatrix,s.hasMetallicRoughnessTextureTransform=!!r.metallicRoughnessTextureTransformMatrix,s}intersect(e,r,i,s,n,o){if(null!=this.parameters.verticalOffset){const e=i.camera;t.set(T,r[12],r[13],r[14]);let o=null;switch(i.viewingMode){case 1:o=t.normalize(x,T);break;case 2:o=t.copy(x,w)}let a=0;const l=t.subtract(C,T,e.eye),c=t.length(l),d=t.scale(l,l,1/c);let h=null;this.parameters.screenSizePerspective&&(h=t.dot(o,d)),a+=u.verticalOffsetAtDistance(e,c,this.parameters.verticalOffset,h??0,this.parameters.screenSizePerspective),t.scale(o,o,a),t.transformMat3(S,o,i.transform.inverseRotation),s=t.subtract(b,s,S),n=t.subtract(v,n,S)}a.intersectTriangleGeometry(e,i,s,n,l.getVerticalOffsetObject3D(i.verticalOffset),o)}createGLMaterial(e){return new g(e)}createBufferWriter(){return new c.DefaultBufferWriter(this._layout)}get transparent(){return _(this.parameters)}}class g extends s.GLTextureMaterial{constructor(e){super({...e,...e.material.parameters})}beginSlot(e){this._material.setParameters({receiveShadows:e.shadowMap.enabled});const r=this._material.parameters;this.updateTexture(r.textureId);const i=e.camera.viewInverseTransposeMatrix;return t.set(r.origin,i[3],i[7],i[11]),this._material.setParameters(this.textureBindParameters),this.getTechnique(r.treeRendering?p.RealisticTreeTechnique:d.DefaultMaterialTechnique,e)}}class y extends d.DefaultMaterialPassParameters{constructor(){super(...arguments),this.treeRendering=!1,this.hasVertexTangents=!1}get hasNormalTexture(){return!this.treeRendering&&!!this.normalTextureId}get hasColorTexture(){return!!this.textureId}get hasMetallicRoughnessTexture(){return!this.treeRendering&&!!this.metallicRoughnessTextureId}get hasOcclusionTexture(){return!this.treeRendering&&!!this.occlusionTextureId}get emissionSource(){return this.treeRendering?0:null!=this.emissiveTextureId&&0===this.emissiveSource?3:this.usePBR?0===this.emissiveSource?2:1:0}get hasTextures(){return this.hasColorTexture||this.hasNormalTexture||this.hasMetallicRoughnessTexture||3===this.emissionSource||this.hasOcclusionTexture}}function _(e){const{drivenOpacity:t,opacity:r,externalColor:i,layerOpacity:s,texture:n,textureId:o,textureAlphaMode:a,colorMixMode:l}=e,c=i[3];return t||r<1&&"replace"!==l||c<1&&"ignore"!==l||s<1||(null!=n||null!=o)&&1!==a&&2!==a&&"replace"!==l}const b=r.create(),v=r.create(),w=r.fromValues(0,0,1),x=r.create(),S=r.create(),T=r.create(),C=r.create();e.DefaultGLMaterial=g,e.DefaultMaterial=m,e.DefaultMaterialParameters=y,e.isTransparent=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/RayIntersections":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","./Util"],function(e,t,r,i,s){"use strict";class n{constructor(e=!1,t=!0){this.isVerticalRay=e,this.normalRequired=t}}const o=i.create(),a=r.create();function l(e,t,r,s,n,u,d){if(null==e)return;const h=_(r,a);if(i.setMin(o,e.bbMin),i.setMax(o,e.bbMax),null!=n&&n.applyToAabb(o),b(o,t,h,s)){const{primitiveIndices:i,position:o}=e,a=i?i.length:o.indices.length/3;if(a>w){const i=e.getChildren();if(void 0!==i){for(const e of i)l(e,t,r,s,n,u,d);return}}!function(e,t,r,i,s,n,o,a,l,u,d){const h=e[0],p=e[1],m=e[2],g=t[0],y=t[1],_=t[2],{normalRequired:b}=u;for(let e=0;e<i;++e){const t=a[e],r=3*t,i=o*s[r];let u=n[i],v=n[i+1],w=n[i+2];const S=o*s[r+1];let T=n[S],C=n[S+1],P=n[S+2];const M=o*s[r+2];let R=n[M],O=n[M+1],I=n[M+2];null!=l&&([u,v,w]=l.applyToVertex(u,v,w,e),[T,C,P]=l.applyToVertex(T,C,P,e),[R,O,I]=l.applyToVertex(R,O,I,e));const F=T-u,A=C-v,D=P-w,E=R-u,L=O-v,V=I-w,U=y*V-L*_,B=_*E-V*g,N=g*L-E*y,k=F*U+A*B+D*N;if(Math.abs(k)<=x)continue;const z=h-u,j=p-v,G=m-w,q=z*U+j*B+G*N;if(k>0){if(q<0||q>k)continue}else if(q>0||q<k)continue;const H=j*D-A*G,W=G*F-D*z,$=z*A-F*j,Q=g*H+y*W+_*$;if(k>0){if(Q<0||q+Q>k)continue}else if(Q>0||q+Q<k)continue;const Z=(E*H+L*W+V*$)/k;Z>=0&&d(Z,t,b?f(F,A,D,E,L,V,c):null)}}(t,r,0,a,o.indices,o.data,o.stride,i,n,u,d)}}const c=r.create();function u(e,r,i,s,n,o,a,l,c,u){const f=r,g=T,y=Math.abs(f[0]),_=Math.abs(f[1]),b=Math.abs(f[2]),v=y>=_?y>=b?0:2:_>=b?1:2,w=v,x=f[w]<0?2:1,S=(v+x)%3,C=(v+(3-x))%3,P=f[S]/f[w],M=f[C]/f[w],R=1/f[w],O=d,I=h,F=p,{normalRequired:A}=c;for(let r=i;r<s;++r){const i=3*r,s=a*n[i];t.set(g[0],o[s+0],o[s+1],o[s+2]);const c=a*n[i+1];t.set(g[1],o[c+0],o[c+1],o[c+2]);const d=a*n[i+2];t.set(g[2],o[d+0],o[d+1],o[d+2]),l&&(t.copy(g[0],l.applyToVertex(g[0][0],g[0][1],g[0][2],r)),t.copy(g[1],l.applyToVertex(g[1][0],g[1][1],g[1][2],r)),t.copy(g[2],l.applyToVertex(g[2][0],g[2][1],g[2][2],r))),t.sub(O,g[0],e),t.sub(I,g[1],e),t.sub(F,g[2],e);const h=O[S]-P*O[w],p=O[C]-M*O[w],f=I[S]-P*I[w],y=I[C]-M*I[w],_=F[S]-P*F[w],b=F[C]-M*F[w],v=_*y-b*f,x=h*b-p*_,T=f*p-y*h;if((v<0||x<0||T<0)&&(v>0||x>0||T>0))continue;const D=v+x+T;if(0===D)continue;const E=v*(R*O[w])+x*(R*I[w])+T*(R*F[w]);if(E*Math.sign(D)<0)continue;const L=E/D;L>=0&&u(L,r,A?m(g):null)}}const d=r.create(),h=r.create(),p=r.create();function f(e,r,i,s,n,o,a){return t.set(g,e,r,i),t.set(y,s,n,o),t.cross(a,g,y),t.normalize(a,a),a}function m(e){return t.sub(g,e[1],e[0]),t.sub(y,e[2],e[0]),t.cross(c,g,y),t.normalize(c,c),c}const g=r.create(),y=r.create();function _(e,r){return t.set(r,1/e[0],1/e[1],1/e[2])}function b(e,t,r,i){return v(e,t,r,i,1/0)}function v(e,t,r,i,s){const n=(e[0]-i-t[0])*r[0],o=(e[3]+i-t[0])*r[0];let a=Math.min(n,o),l=Math.max(n,o);const c=(e[1]-i-t[1])*r[1],u=(e[4]+i-t[1])*r[1];if(l=Math.min(l,Math.max(c,u)),l<0)return!1;if(a=Math.max(a,Math.min(c,u)),a>l)return!1;const d=(e[2]-i-t[2])*r[2],h=(e[5]+i-t[2])*r[2];return l=Math.min(l,Math.max(d,h)),!(l<0)&&(a=Math.max(a,Math.min(d,h)),!(a>l)&&a<s)}const w=1e3,x=1e-7,S=r.create(),T=[r.create(),r.create(),r.create()];e.MeshIntersectionOptions=n,e.computeInvDir=function(e,r,i){return t.set(i,1/(r[0]-e[0]),1/(r[1]-e[1]),1/(r[2]-e[2]))},e.computeInvDirFromDirection=_,e.computeNormalFromBarycentric=f,e.intersectAabbInvDir=b,e.intersectAabbInvDirBefore=v,e.intersectRayTriangles=function(e,t,r,i,s,n,o,a,l,u=null,d=0){const h=e[0],p=e[1],m=e[2],g=t[0],y=t[1],_=t[2];for(let e=r;e<i;++e){const t=d+(u?u[e]:e),r=3*t,i=o*s[r],b=n[i],v=n[i+1],w=n[i+2],S=o*s[r+1],T=n[S],C=n[S+1],P=n[S+2],M=o*s[r+2],R=T-b,O=C-v,I=P-w,F=n[M]-b,A=n[M+1]-v,D=n[M+2]-w,E=y*D-A*_,L=_*F-D*g,V=g*A-F*y,U=R*E+O*L+I*V;if(Math.abs(U)<=x)continue;const B=h-b,N=p-v,k=m-w,z=B*E+N*L+k*V;if(U>0){if(z<0||z>U)continue}else if(z>0||z<U)continue;const j=N*I-O*k,G=k*R-I*B,q=B*O-R*N,H=g*j+y*G+_*q;if(U>0){if(H<0||z+H>U)continue}else if(H>0||z+H<U)continue;const W=(F*j+A*G+D*q)/U;W>=0&&l(W,t,a?f(R,O,I,F,A,D,c):null)}},e.intersectRayTrianglesWithDisplacementWatertight=u,e.intersectRayTrianglesWithVerticalOffsetENUGlobal=function(e,t,r,i,s,n,o,a,l,u,d,h=null,p=0){const m=e[0],g=e[1],y=e[2],_=t[0],b=t[1],v=t[2];for(let e=r;e<i;++e){const t=p+(h?h[e]:e),r=3*t,i=o*s[r],w=n[i],S=n[i+1],T=n[i+2],C=o*s[r+1],P=n[C],M=n[C+1],R=n[C+2],O=o*s[r+2],I=n[O],F=n[O+1],A=n[O+2],D=T-l,E=a/Math.sqrt(w*w+S*S+D*D),L=w+w*E,V=S+S*E,U=T+D*E,B=R-l,N=a/Math.sqrt(P*P+M*M+B*B),k=P+P*N,z=M+M*N,j=R+B*N,G=A-l,q=a/Math.sqrt(I*I+F*F+G*G),H=k-L,W=z-V,$=j-U,Q=I+I*q-L,Z=F+F*q-V,Y=A+G*q-U,X=b*Y-Z*v,J=v*Q-Y*_,K=_*Z-Q*b,ee=H*X+W*J+$*K;if(Math.abs(ee)<=x)continue;const te=m-L,re=g-V,ie=y-U,se=te*X+re*J+ie*K;if(ee>0){if(se<0||se>ee)continue}else if(se>0||se<ee)continue;const ne=re*$-W*ie,oe=ie*H-$*te,ae=te*W-H*re,le=_*ne+b*oe+v*ae;if(ee>0){if(le<0||se+le>ee)continue}else if(le>0||se+le<ee)continue;const ce=(Q*ne+Z*oe+Y*ae)/ee;ce>=0&&d(ce,t,u?f(H,W,$,Q,Z,Y,c):null)}},e.intersectRenderGeometryTriangles=function(e,t,r,i,s,n,o,a){const l=e[0],u=e[1],d=e[2],h=t[0],p=t[1],m=t[2];for(let e=r;e<i;++e){const t=3*e,r=t+1,i=t+2,g=n*t,y=s[g],_=s[g+1],b=s[g+2],v=n*r,w=n*i,S=s[v]-y,T=s[v+1]-_,C=s[v+2]-b,P=s[w]-y,M=s[w+1]-_,R=s[w+2]-b,O=p*R-M*m,I=m*P-R*h,F=h*M-P*p,A=S*O+T*I+C*F;if(Math.abs(A)<=x)continue;const D=l-y,E=u-_,L=d-b,V=D*O+E*I+L*F;if(A>0){if(V<0||V>A)continue}else if(V>0||V<A)continue;const U=E*C-T*L,B=L*S-C*D,N=D*T-S*E,k=h*U+p*B+m*N;if(A>0){if(k<0||V+k>A)continue}else if(k>0||V+k<A)continue;const z=(P*U+M*B+R*N)/A;z>=0&&a(z,e,o?f(S,T,C,P,M,R,c):null)}},e.intersectTriangleGeometry=function(e,r,i,o,a,c){if(!e.visible)return;const d=t.sub(S,o,i),h=(e,t,r)=>{c(e,r,t)},p=new n(!1,r.options.normalRequired);if(e.boundingInfo){s.assert(0===e.type);const t=r.tolerance;l(e.boundingInfo,i,d,t,a,p,h)}else{const t=e.attributes.get("position"),r=t.indices;u(i,d,0,r.length/3,r,t.data,t.stride,a,p,h)}},e.intersectTriangles=function(e,r,i,s,n,o,a,l,c){const{data:d,stride:h}=o;u(e,t.sub(S,r,e),i,s,n,d,h,a,l,c)},e.triangleRayParallelTolerance=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/DefaultBufferWriter":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/buffer/BufferView","../lib/RayIntersections","./internal/bufferWriterUtils"],function(e,t,r,i,s,n){"use strict";const o=r.create();e.DefaultBufferWriter=class{constructor(e){this.layout=e}elementCount(e){return e.get("position").indices.length}write(e,t,r,i,s,o){return n.writeAttributes(r,i,this.layout,e,t,s,o)}intersect(e,r,n,a,l,c,u){const d=this.layout.createView(e).getField("position",i.BufferViewVec3f);if(null==d)return;const h=t.sub(o,c,l),p=d.count/3,f=a.options.normalRequired;s.intersectRenderGeometryTriangles(l,h,0,p,d.typedBuffer,d.typedBufferStride,f,(e,t,r)=>u(e,r,t))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/DefaultMaterialTechnique":function(){define(["require","exports","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../support/buffer/glUtil","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/attributes/VertexNormal.glsl","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../effects/geometry/olidUtils","../lib/OrderIndependentTransparency","../lib/StencilUtils","../lib/lodRendering/RenderInstanceData","../materials/pbrUtils","../../../../chunks/DefaultMaterial.glsl","../../../webgl/renderState","../../../webgl/VertexAttributeLocations","../../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";class b extends a.VertexNormalPassParameters{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=f.advancedMRRFactors,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=2,this.instanced=!1,this.instancedFeatureAttribute=!1,this.instancedColor=!1,this.instanceColorEncodesAlphaIgnore=!1,this.emissiveStrength=0,this.emissiveSource=1,this.emissiveBaseColor=r.ZEROS,this.instancedDoublePrecision=!1,this.normalType=0,this.receiveShadows=!0,this.receiveAmbientOcclusion=!0,this.castShadows=!0,this.ambient=r.freeze(.2,.2,.2),this.diffuse=r.freeze(.8,.8,.8),this.externalColor=i.fromValues(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=r.create(),this.hasSlicePlane=!1,this.offsetTransparentBackfaces=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.modelTransformation=null,this.drivenOpacity=!1,this.writeDepth=!0,this.customDepthTest=0,this.textureAlphaMode=0,this.textureAlphaCutoff=_.alphaCutoff,this.textureAlphaPremultiplied=!1,this.renderOccluded=1,this.isDecoration=!1}get hasVVSize(){return!!this.vvSize}get hasVVColor(){return!!this.vvColor}get hasVVOpacity(){return!!this.vvOpacity}}class v extends a.VertexNormalDrawParameters{constructor(){super(...arguments),this.origin=r.create(),this.slicePlaneLocalOrigin=this.origin}}class w extends c.ShaderTechnique{constructor(t,r,i=new l.ReloadableShaderModule(m.DefaultMaterial,()=>new Promise((t,r)=>e(["./DefaultMaterial.glsl"],t,r)))){const n=[s.glLayout(x(r))];r.instanced&&r.instancedDoublePrecision&&n.push(s.glLayout(p.getRenderInstanceDataLayout(r))),super(t,r,i,y.fromLayouts(n))}_makePipeline(e,t){const{oitPass:r,output:i,transparent:s,cullFace:n,customDepthTest:a,hasOccludees:l}=e;return g.makePipelineState({blending:o.isColorOrColorEmission(i)&&s?d.blending(r):null,culling:(u=e,0===u.cullFace&&(u.hasSlicePlane||u.transparent||u.doubleSidedMode)?null:g.cullingParams(n)),depthTest:{func:d.oitDepthTest(r,(p=a,1===p?515:513))},depthWrite:d.depthWrite(e),drawBuffers:c.depthOnlyOutputBuffersOr(i,d.getDrawBuffers(r,i)),colorWrite:g.defaultColorWrite,stencilWrite:l?h.stencilWriteMaskOn:null,stencilTest:l?t?h.stencilToolMaskBaseParams:h.stencilBaseAllZerosParams:null,polygonOffset:d.oitPolygonOffset(e)});var u,p}initializePipeline(e){return this._occludeePipelineState=this._makePipeline(e,!0),this._makePipeline(e,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}function x(e){const t=n.newLayout().vec3f("position");return 1===e.normalType?t.vec2i16("normalCompressed",{glNormalized:!0}):t.vec3f("normal"),e.hasVertexTangents&&t.vec4f("tangent"),e.hasTextures&&t.vec2f16("uv0"),e.hasVertexColors&&t.vec4u8("color"),e.hasSymbolColors&&t.vec4u8("symbolColor"),!e.instanced&&u.olidEnabled()&&t.vec4u8("olidColor"),t}t.DefaultMaterialDrawParameters=v,t.DefaultMaterialPassParameters=b,t.DefaultMaterialTechnique=w,t.getLayout=x,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VertexNormal.glsl":function(){define(["exports","../../../../../../core/compilerUtils","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","./NormalAttribute.glsl","./VertexPosition.glsl","../../shaderModules/glsl","../../shaderModules/Matrix3DrawUniform","../../shaderModules/Matrix3PassUniform"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends n.VertexPositionPassParameters{constructor(){super(...arguments),this.transformNormalViewFromGlobal=r.create()}}class u extends n.VertexPositionDrawParameters{constructor(){super(...arguments),this.transformNormalGlobalFromModel=r.create(),this.toMapSpace=i.create()}}e.VertexNormal=function(e,r){switch(r.normalType){case 0:case 1:e.include(s.NormalAttribute,r),e.varyings.add("vNormalWorld","vec3"),e.varyings.add("vNormalView","vec3"),e.vertex.uniforms.add(new a.Matrix3DrawUniform("transformNormalGlobalFromModel",e=>e.transformNormalGlobalFromModel),new l.Matrix3PassUniform("transformNormalViewFromGlobal",e=>e.transformNormalViewFromGlobal)).code.add(o.glsl`void forwardNormal() {
vNormalWorld = transformNormalGlobalFromModel * normalModel();
vNormalView = transformNormalViewFromGlobal * vNormalWorld;
}`);break;case 2:e.vertex.code.add(o.glsl`void forwardNormal() {}`);break;default:t.neverReached(r.normalType);case 3:}},e.VertexNormalDrawParameters=u,e.VertexNormalPassParameters=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl":function(){define(["exports","../../../../../../core/compilerUtils","../../shaderModules/glsl"],function(e,t,r){"use strict";e.NormalAttribute=function(e,i){switch(i.normalType){case 1:e.attributes.add("normalCompressed","vec2"),e.vertex.code.add(r.glsl`vec3 decompressNormal(vec2 normal) {
float z = 1.0 - abs(normal.x) - abs(normal.y);
return vec3(normal + sign(normal) * min(z, 0.0), z);
}
vec3 normalModel() {
return decompressNormal(normalCompressed);
}`);break;case 0:e.attributes.add("normal","vec3"),e.vertex.code.add(r.glsl`vec3 normalModel() {
return normal;
}`);break;case 2:e.fragment.code.add(r.glsl`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`);break;default:t.neverReached(i.normalType);case 3:}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VertexPosition.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../util/DoublePrecision.glsl","../../shaderModules/Float3DrawUniform","../../shaderModules/Float3PassUniform","../../shaderModules/glsl","../../shaderModules/Matrix3DrawUniform","../../shaderModules/Matrix3PassUniform","../../shaderModules/Matrix4PassUniform","../../../../../webgl/NoParameters"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h extends d.NoParameters{constructor(){super(...arguments),this.transformWorldFromViewTH=i.create(),this.transformWorldFromViewTL=i.create(),this.transformViewFromCameraRelativeRS=t.create(),this.transformProjFromView=r.create()}}class p extends d.NoParameters{constructor(){super(...arguments),this.transformWorldFromModelRS=t.create(),this.transformWorldFromModelTH=i.create(),this.transformWorldFromModelTL=i.create()}}e.VertexPosition=function(e,t){const{attributes:r,vertex:i,varyings:d,fragment:h}=e;i.include(s.DoublePrecision,t),r.add("position","vec3"),d.add("vPositionWorldCameraRelative","vec3"),d.add("vPosition_view","vec3",{invariant:!0}),i.uniforms.add(new o.Float3PassUniform("transformWorldFromViewTH",e=>e.transformWorldFromViewTH),new o.Float3PassUniform("transformWorldFromViewTL",e=>e.transformWorldFromViewTL),new c.Matrix3PassUniform("transformViewFromCameraRelativeRS",e=>e.transformViewFromCameraRelativeRS),new u.Matrix4PassUniform("transformProjFromView",e=>e.transformProjFromView),new l.Matrix3DrawUniform("transformWorldFromModelRS",e=>e.transformWorldFromModelRS),new n.Float3DrawUniform("transformWorldFromModelTH",e=>e.transformWorldFromModelTH),new n.Float3DrawUniform("transformWorldFromModelTL",e=>e.transformWorldFromModelTL)),i.code.add(a.glsl`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}`),i.code.add(a.glsl`
    void forwardPosition(float fOffset) {
      vPositionWorldCameraRelative = positionWorldCameraRelative();
      if (fOffset != 0.0) {
        vPositionWorldCameraRelative += fOffset * ${t.spherical?a.glsl`normalize(transformWorldFromViewTL + vPositionWorldCameraRelative)`:a.glsl`vec3(0.0, 0.0, 1.0)`};
      }

      vPosition_view = transformViewFromCameraRelativeRS * vPositionWorldCameraRelative;
      gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
    }
  `),h.uniforms.add(new o.Float3PassUniform("transformWorldFromViewTL",e=>e.transformWorldFromViewTL)),i.code.add(a.glsl`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),h.code.add(a.glsl`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)},e.VertexPositionDrawParameters=p,e.VertexPositionPassParameters=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/DoublePrecision.glsl":function(){define(["exports","../../shaderModules/FloatBindUniform","../../shaderModules/glsl"],function(e,t,r){"use strict";e.DoublePrecision=function({code:e,uniforms:i},s){i.add(new t.FloatBindUniform("dpDummy",()=>1)),e.add(r.glsl`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 hiD = hiA + hiB;
vec3 loD = loA + loB;
return  dpDummy * hiD + loD;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Matrix3DrawUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"mat3",2,(i,s,n)=>i.setUniformMatrix3fv(e,t(s,n),r))}}e.Matrix3DrawUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Matrix4PassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"mat4",1,(i,s,n)=>i.setUniformMatrix4fv(e,t(s,n),r))}}e.Matrix4PassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/StencilUtils":function(){define(["exports"],function(e){"use strict";e.depthCompareAlways={func:519},e.depthCompareLess={func:513},e.renderWhenBitIsNotSet=e=>({function:{func:517,ref:e,mask:e},operation:{fail:7680,zFail:7680,zPass:7680}}),e.replaceBitWhenDepthTestPasses=e=>({function:{func:519,ref:e,mask:e},operation:{fail:7680,zFail:7680,zPass:7681}}),e.stencilBaseAllZerosParams={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:0}},e.stencilToolMaskBaseParams={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7681}},e.stencilToolMaskOccluderParams={function:{func:514,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}},e.stencilToolTransparentOccluderParams={function:{func:517,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}},e.stencilWriteMaskOff={mask:0},e.stencilWriteMaskOn={mask:255},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/lodRendering/RenderInstanceData":function(){define(["exports","../../../../../core/arrayUtils","../../../../../geometry/support/buffer/BufferView","../../../support/buffer/InterleavedLayout","../Util","./BackedBufferObject","./InstanceData"],function(e,t,r,i,s,n,o){"use strict";class a{constructor(e){this.model=e.instanceModel,this.modelNormal=e.instanceModelNormal,this.modelOriginHi=e.instanceModelOriginHi,this.modelOriginLo=e.instanceModelOriginLo,this.featureAttribute=e.getField("instanceFeatureAttribute",r.BufferViewVec4f),this.color=e.getField("instanceColor",r.BufferViewVec4u8),this.olidColor=e.getField("instanceOlidColor",r.BufferViewVec4u8)}}const l=i.newLayout().vec3f("instanceModelOriginHi").vec3f("instanceModelOriginLo").mat3f("instanceModel").mat3f("instanceModelNormal");e.RenderInstanceData=class{constructor(e,t){this._rctx=e,this._layout=t,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){s.assert(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){s.assert(this._updating,"not updating"),this.size<t.reallocShrinkThreshold*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){s.assert(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),s.assert(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){s.assert(this._updating,"not updating"),s.assert(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(o.initialCapacity,Math.floor(this._capacity*t.reallocGrowthFactor));this._resize(e)}_shrink(){const e=Math.max(o.initialCapacity,Math.floor(this._capacity*t.reallocShrinkFactor));this._resize(e)}_resize(e){if(s.assert(this._updating,"not updating"),e===this._capacity)return;const t=new n.BackedBufferObject(this._rctx,this._layout,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,r=this._compactInstances(t);s.assert(r===e,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=r,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new a(this._layout.createView(this._buffer.array))}_compactInstances(e){const t=this._headIndex,r=this._tailIndex;return r<t?(this._buffer.copyRange(r,t,e),t-r):r>t?(this._buffer.copyRange(r,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-r),t+(this._capacity-r)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}},e.RenderInstanceDataView=a,e.getRenderInstanceDataLayout=function(e){return o.addOptionalLayoutFields(l.clone(),e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/lodRendering/BackedBufferObject":function(){define(["exports","../../../support/buffer/glUtil","../../../../webgl/VertexBuffer"],function(e,t,r){"use strict";e.BackedBufferObject=class{constructor(e,i,s){this.elementSize=i.stride,this._buffer=new r.VertexBuffer(e,t.glLayout(i,1)),this.resize(s)}destroy(){this._buffer.dispose()}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,t,r,i=0){const s=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(r.array,i*this.elementSize).set(s)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const r=e*this.elementSize,i=t*this.elementSize;this._buffer.setSubData(new Uint8Array(this._array),r,r,i)}resize(e){const t=e*this.elementSize,r=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(r).set(new Uint8Array(this._array)):new Uint8Array(r).set(new Uint8Array(this._array).subarray(0,e*this.elementSize))),this._array=r,this._buffer.setSize(t),this._capacity=e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/lodRendering/InstanceData":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/arrayUtils","../../../../../core/Evented","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/buffer/BufferView","../../../support/mathUtils","../../../support/buffer/InterleavedLayout","../../effects/geometry/olidUtils","../Util"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b){"use strict";class v{constructor(e){this.localTransform=e.localTransform,this.globalTransform=e.globalTransform,this.modelOrigin=e.modelOrigin,this.model=e.instanceModel,this.modelNormal=e.instanceModelNormal,this.modelScaleFactors=e.modelScaleFactors,this.boundingSphere=e.boundingSphere,this.featureAttribute=e.getField("instanceFeatureAttribute",m.BufferViewVec4f),this.color=e.getField("instanceColor",m.BufferViewVec4u8),this.olidColor=e.getField("instanceOlidColor",m.BufferViewVec4u8),this.state=e.getField("state",m.BufferViewUint8),this.lodLevel=e.getField("lodLevel",m.BufferViewUint8)}}e.InstanceData=class extends r{constructor(e,t){super(e),this.events=new s.EventEmitter,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=function(e){return x(w.clone(),e).u8("state").u8("lodLevel")}(t),this._capacity=M,this._buffer=this._layout.createBuffer(this._capacity),this._view=new v(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,1),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const t=this._view.state;b.assert(e>=0&&e<this._capacity&&!!(1&t.get(e)),"invalid instance handle"),this._getStateFlag(e,18)?this._setStateFlags(e,32):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const t=this._view.state;b.assert(e>=0&&e<this._capacity&&!!(1&t.get(e)),"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,r=!0){this._view.localTransform.setMat(e,t),r&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,r=!0){this._view.globalTransform.setMat(e,t),r&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,r=S,i=T;t.localTransform.getMat(e,C),t.globalTransform.getMat(e,P);const s=d.multiply(P,P,C);p.set(r,s[12],s[13],s[14]),t.modelOrigin.setVec(e,r),c.fromMat4(i,s),t.model.setMat(e,i);const n=g.scaleFromMatrix(S,s);n.sort(),t.modelScaleFactors.set(e,0,n[1]),t.modelScaleFactors.set(e,1,n[2]),c.invert(i,i),c.transpose(i,i),t.modelNormal.setMat(e,i),this._setStateFlags(e,64),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const r=this._view;r.model.getMat(e,T),r.modelOrigin.getVec(e,S),t[0]=T[0],t[1]=T[1],t[2]=T[2],t[3]=0,t[4]=T[3],t[5]=T[4],t[6]=T[5],t[7]=0,t[8]=T[6],t[9]=T[7],t[10]=T[8],t[11]=0,t[12]=S[0],t[13]=S[1],t[14]=S[2],t[15]=1}applyShaderTransformation(e,t){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){this._view.localTransform.getMat(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(S,this,e),t*=Math.max(S[0],S[1],S[2])),t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);var r,i,s;return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(S,this,e),t*=(r=S[0],i=S[1],s=S[2],Math.max(Math.min(r,i),Math.min(Math.max(r,i),s)))),t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute?.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute?.getVec(e,t)}setColor(e,t){this._view.color?.setVec(e,t)}setObjectAndLayerIdColor(e,t){this._view.olidColor?.setVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,4,t),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,4)}setHighlight(e,t){const{_highlightOptionsMap:r}=this,i=r.get(e);t?t!==i&&(r.set(e,t),this._setStateFlag(e,8,!0),this.events.emit("instance-highlight-changed")):i&&(r.delete(e),this._setStateFlag(e,8,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(e){return this._getStateFlag(e,8)}geHighlightOptionsPrev(e){const t=this._highlightOptionsMapPrev.get(e)??null;return this._highlightOptionsMapPrev.delete(e),t}getHighlightName(e){const t=this.highlightOptionsMap.get(e)??null;return t?this._highlightOptionsMapPrev.set(e,t):this._highlightOptionsMapPrev.delete(e),t}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let r=0;r<this._capacity;++r)this.getState(r)&e&&++t;return t}_setStateFlags(e,t){const r=this._view.state;t=r.get(e)|t,r.set(e,t)}_clearStateFlags(e,t){const r=this._view.state;t=r.get(e)&~t,r.set(e,t)}_setStateFlag(e,t,r){r?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){this._capacity=Math.max(M,Math.floor(this._capacity*i.reallocGrowthFactor)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new v(this._buffer)}_findSlot(){const e=this._view.state;let t=this._next;for(;1&e.get(t);)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}},t.__decorate([n.property({constructOnly:!0})],e.InstanceData.prototype,"shaderTransformation",void 0),t.__decorate([n.property()],e.InstanceData.prototype,"_size",void 0),t.__decorate([n.property({readOnly:!0})],e.InstanceData.prototype,"size",null),e.InstanceData=t.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],e.InstanceData);const w=y.newLayout().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("instanceModel").mat3f("instanceModelNormal").vec2f("modelScaleFactors");function x(e,t){return t.instancedFeatureAttribute&&e.vec4f("instanceFeatureAttribute"),t.instancedColor&&e.vec4u8("instanceColor"),_.olidEnabled()&&e.vec4u8("instanceOlidColor"),e}const S=f.create(),T=u.create(),C=h.create(),P=h.create(),M=64;e.InstanceDataView=v,e.addOptionalLayoutFields=x,e.initialCapacity=M,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/pbrUtils":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64"],function(e,t,r){"use strict";const i=r.freeze(1,1,.5),s=r.freeze(0,.6,.2),n=r.freeze(0,1,.2);e.advancedMRRFactors=i,e.esriSymbologyMRRFactors=n,e.schematicMRRFactors=s,e.useSchematicPBR=function({normalTexture:e,metallicRoughnessTexture:i,metallicFactor:s,roughnessFactor:n,emissiveTexture:o,emissiveFactor:a,occlusionTexture:l}){return null==e&&null==i&&null==o&&(null==a||t.exactEquals(a,r.ZEROS))&&null==l&&(null==n||1===n)&&(null==s||1===s)},e.useSchematicPBRI3S=function({normalTexture:e,metallicRoughnessTexture:i,metallicFactor:s,roughnessFactor:n,emissiveTexture:o,emissiveFactor:a,occlusionTexture:l}){return null==e&&null==i&&null==o&&(null==a||t.exactEquals(a,r.ZEROS))&&null==l&&(null==n||1===n)&&(null==s||1===s||0===s)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/DefaultMaterial.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/Offset.glsl","../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/Transform.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/InstanceColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/InstancedDoublePrecision.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/MaskedColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/SymbolColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexNormal.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VerticalOffset.glsl","../views/3d/webgl-engine/core/shaderLibrary/default/DefaultMaterialAuxiliaryPasses.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ComputeNormalTexture.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientOcclusion.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateSceneLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Normals.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRendering.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/TerrainDepthTest.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/TextureTransformUV.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/VisualVariables.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/DiscardOrAdjustAlpha.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/MixExternalColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/effects/weather/SnowCover.glsl","../views/3d/webgl-engine/materials/internal/MaterialUtil","../views/3d/webgl-engine/shaders/OutputColorHighlightOID.glsl","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V,U,B){"use strict";function N(e){const N=new U.ShaderBuilder,{attributes:k,vertex:z,fragment:j,varyings:G}=N,{output:q,normalType:H,offsetBackfaces:W,spherical:$,snowCover:Q,pbrMode:Z,textureAlphaPremultiplied:Y,instancedDoublePrecision:X,hasVertexColors:J,hasVertexTangents:K,hasColorTexture:ee,hasNormalTexture:te,hasNormalTextureTransform:re,hasColorTextureTransform:ie,hasBloom:se}=e;if(R.addProjViewLocalOrigin(z,e),k.add("position","vec3"),G.add("vpos","vec3",{invariant:!0}),N.include(C.VisualVariables,e),N.include(o.InstancedDoublePrecision,e),N.include(p.VerticalOffset,e),N.include(T.colorTextureUV,e),!r.isColorOrColorEmission(q))return N.include(f.DefaultMaterialAuxiliaryPasses,e),N;N.include(T.normalTextureUV,e),N.include(T.emissiveTextureUV,e),N.include(T.occlusionTextureUV,e),N.include(T.metallicRoughnessTextureUV,e),R.addCameraPosition(z,e),N.include(l.NormalAttribute,e),N.include(s.Transform,e);const ne=0===H||1===H;return ne&&W&&N.include(t.Offset),N.include(m.ComputeNormalTexture,e),N.include(h.VertexNormal,e),N.include(n.InstanceColor,e),G.add("vPositionLocal","vec3"),N.include(u.TextureCoordinateAttribute,e),N.include(c.SymbolColor,e),N.include(d.VertexColor,e),z.uniforms.add(new I.Float4PassUniform("externalColor",e=>e.externalColor,{supportsNaN:!0})),G.add("vcolorExt","vec4"),N.include(S.terrainDepthTest,e),z.include(a.MaskedColorDefinition),z.include(a.CreateMaskedFromNaNColor),N.include(X?x.ReadShadowMapPass:x.ReadShadowMapDraw,e),z.main.add(A.glsl`
    forwardNormalizedVertexColor();

    MaskedColor maskedColor =
      applySymbolColor(applyVVColor(applyInstanceColor(createMaskedFromNaNColor(externalColor))));

    vcolorExt = maskedColor.color;
    forwardColorMixMode(maskedColor.mask);

    vpos = getVertexInLocalOriginSpace();
    vPositionLocal = vpos - view[3].xyz;
    vpos = subtractOrigin(vpos);
    ${A.If(ne,"vNormalWorld = dpNormal(vvLocalNormal(normalModel()));")}
    vpos = addVerticalOffset(vpos, localOrigin);
    ${A.If(K,"vTangent = dpTransformVertexTangent(tangent);")}
    gl_Position = transformPosition(proj, view, vpos);
    ${A.If(ne&&W,"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);")}

    forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
    forwardTextureCoordinates();
    forwardColorUV();
    forwardNormalUV();
    forwardEmissiveUV();
    forwardOcclusionUV();
    forwardMetallicRoughnessUV();

    if (opacityMixMode != ${A.glsl.int(L.colorMixModes.ignore)} && vcolorExt.a < ${A.glsl.float(B.alphaCutoff)}) {
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
    }
    forwardLinearDepthToReadShadowMap();
  `),N.include(y.EvaluateSceneLighting,e),j.include(g.EvaluateAmbientOcclusion,e),N.include(P.DiscardOrAdjustAlphaPass,e),j.include(i.SliceDraw,e),N.include(V.outputColorHighlightOID,e),R.addCameraPosition(j,e),j.uniforms.add(z.uniforms.get("localOrigin"),new O.Float3PassUniform("ambient",e=>e.ambient),new O.Float3PassUniform("diffuse",e=>e.diffuse),new F.FloatPassUniform("opacity",e=>e.opacity),new F.FloatPassUniform("layerOpacity",e=>e.layerOpacity)),ee&&j.uniforms.add(new D.Texture2DPassUniform("tex",e=>e.texture)),N.include(w.PhysicallyBasedRenderingParameters,e),j.include(v.PhysicallyBasedRendering,e),j.include(M.MixExternalColor),N.include(b.Normals,e),j.include(E.SnowCover,e),y.addAmbientBoostFactor(j),y.addLightingGlobalFactor(j),_.addMainLightIntensity(j),j.main.add(A.glsl`
    discardBySlice(vpos);
    discardByTerrainDepth();
    ${ee?A.glsl`
            vec4 texColor = texture(tex, ${ie?"colorUV":"vuv0"});
            ${A.If(Y,"texColor.rgb /= texColor.a;")}
            discardOrAdjustAlpha(texColor);`:A.glsl`vec4 texColor = vec4(1.0);`}
    shadingParams.viewDirection = normalize(vpos - cameraPosition);
    ${2===H?A.glsl`vec3 normal = screenDerivativeNormal(vPositionLocal);`:A.glsl`shadingParams.normalView = vNormalWorld;
                vec3 normal = shadingNormal(shadingParams);`}
    applyPBRFactors();
    float ssao = evaluateAmbientOcclusionInverse() * getBakedOcclusion();

    vec3 posWorld = vpos + localOrigin;

    float additionalAmbientScale = additionalDirectedAmbientLight(posWorld);
    float shadow = readShadow(additionalAmbientScale, vpos);

    vec3 matColor = max(ambient, diffuse);
    vec3 albedo = mixExternalColor(${A.If(J,"vColor.rgb *")} matColor, texColor.rgb, vcolorExt.rgb, colorMixMode);
    float opacity_ = layerOpacity * mixExternalOpacity(${A.If(J,"vColor.a * ")} opacity, texColor.a, vcolorExt.a, opacityMixMode);

    ${te?`mat3 tangentSpace = computeTangentSpace(${K?"normal":"normal, vpos, vuv0"});\n            vec3 shadingNormal = computeTextureNormal(tangentSpace, ${re?"normalUV":"vuv0"});`:"vec3 shadingNormal = normal;"}
    vec3 normalGround = ${$?"normalize(posWorld);":"vec3(0.0, 0.0, 1.0);"}

    ${A.If(Q,A.glsl`
          float snow = getSnow(normal, normalGround);
          albedo = mix(albedo, vec3(1), snow);
          shadingNormal = mix(shadingNormal, normal, snow);
          ssao = mix(ssao, 1.0, snow);`)}

    vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

    ${1===Z||2===Z?A.glsl`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
            vec4 emission = ${se?"vec4(0.0)":"getEmissions(albedo)"};
            ${A.If(Q,"mrr = applySnowToMRR(mrr, snow);\n               emission = snowCoverForEmissions(emission, snow);")}
            vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:A.glsl`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
    vec4 finalColor = vec4(shadedColor, opacity_);
    outputColorHighlightOID(finalColor, vpos, albedo ${A.If(Q,", snow")});
  `),N}const k=Object.freeze(Object.defineProperty({__proto__:null,build:N},Symbol.toStringTag,{value:"Module"}));e.DefaultMaterial=k,e.build=N})},"esri/views/3d/webgl-engine/core/shaderLibrary/Offset.glsl":function(){define(["exports","../shaderModules/glsl"],function(e,t){"use strict";e.Offset=function(e){e.vertex.code.add(t.glsl`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/Transform.glsl":function(){define(["exports","./ForwardLinearDepthToWriteShadowMap.glsl","../shaderModules/glsl"],function(e,t,r){"use strict";e.Transform=function(e){t.addCalculateLinearDepth(e),e.vertex.code.add(r.glsl`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = calculateLinearDepth(nearFar,eye.z);
return proj * eye;
}`),e.vertex.code.add(r.glsl`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepthToWriteShadowMap.glsl":function(){define(["exports","./ForwardLinearDepth.glsl","./ShaderOutput","./attributes/VertexPosition.glsl","../shaderModules/Float2BindUniform","../shaderModules/glsl"],function(e,t,r,i,s,n){"use strict";function o(e){e.vertex.uniforms.add(new s.Float2BindUniform("nearFar",e=>e.camera.nearFar))}function a(e){e.vertex.code.add(n.glsl`float calculateLinearDepth(vec2 nearFar,float z) {
return (-z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)}e.ForwardLinearDepthToWriteShadowMap=function(e,s){const{vertex:l}=e,c=r.isShadowRelatedOutput(s.output);c&&(e.include(i.VertexPosition,s),t.ForwardLinearDepth(e,!0),o(e),a(e)),l.code.add(n.glsl`
    void forwardLinearDepthToWriteShadowMap() {
      ${n.If(c,"forwardLinearDepth(calculateLinearDepth(nearFar, vPosition_view.z));")}
    }
  `)},e.addCalculateLinearDepth=a,e.addNearFar=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepth.glsl":function(){define(["exports","../shaderModules/glsl"],function(e,t){"use strict";function r(e){e.varyings.add("linearDepth","float",{invariant:!0})}e.ForwardLinearDepth=function(e,i){i&&r(e),e.vertex.code.add(t.glsl`
    void forwardLinearDepth(float _linearDepth) { ${t.If(i,"linearDepth = _linearDepth;")} }
  `)},e.addLinearDepth=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/InstanceColor.glsl":function(){define(["exports","./MaskedColor.glsl","../../shaderModules/glsl"],function(e,t,r){"use strict";e.InstanceColor=function(e,i){i.instancedColor?(e.attributes.add("instanceColor","vec4"),e.vertex.include(t.MaskedColorDefinition),e.vertex.include(t.CreateMaskedFromUInt8NaNColor),e.vertex.include(t.MultiplyMaskedColors),e.vertex.code.add(r.glsl`
      MaskedColor applyInstanceColor(MaskedColor color) {
        return multiplyMaskedColors( color, createMaskedFromUInt8NaNColor(${"instanceColor"}));
      }
    `)):e.vertex.code.add(r.glsl`MaskedColor applyInstanceColor(MaskedColor color) {
return color;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/InstancedDoublePrecision.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../util/DoublePrecision.glsl","../util/View.glsl","../../shaderModules/Float3BindUniform","../../shaderModules/glsl","../../shaderModules/Matrix3PassUniform","../../shaderModules/Matrix4PassUniform","../../../../../webgl/doublePrecisionUtils","../../../../../webgl/NoParameters"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";class f extends p.NoParameters{constructor(){super(...arguments),this.modelTransformation=null}}const m=r.create(),g=n.create();e.InstancedDoublePassParameters=f,e.InstancedDoublePrecision=function(e,r){const{hasModelTransformation:n,instancedDoublePrecision:p,instanced:f,output:y,hasVertexTangents:_}=r;n&&(e.vertex.uniforms.add(new d.Matrix4PassUniform("model",e=>e.modelTransformation??i.IDENTITY)),e.vertex.uniforms.add(new u.Matrix3PassUniform("normalLocalOriginFromModel",e=>(t.normalFromMat4(m,e.modelTransformation??i.IDENTITY),m)))),f&&p&&(e.attributes.add("instanceModelOriginHi","vec3"),e.attributes.add("instanceModelOriginLo","vec3"),e.attributes.add("instanceModel","mat3"),e.attributes.add("instanceModelNormal","mat3"));const b=e.vertex;p&&(b.include(o.DoublePrecision,r),b.uniforms.add(new l.Float3BindUniform("viewOriginHi",e=>h.encodeDoubleHi(s.set(g,e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]),g)),new l.Float3BindUniform("viewOriginLo",e=>h.encodeDoubleLo(s.set(g,e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]),g)))),b.code.add(c.glsl`
    vec3 getVertexInLocalOriginSpace() {
      return ${n?p?"(model * vec4(instanceModel * localPosition().xyz, 1.0)).xyz":"(model * localPosition()).xyz":p?"instanceModel * localPosition().xyz":"localPosition().xyz"};
    }

    vec3 subtractOrigin(vec3 _pos) {
      ${p?c.glsl`
          // Issue: (should be resolved now with invariant position) https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/56280
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -instanceModelOriginHi, -instanceModelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `),b.code.add(c.glsl`
    vec3 dpNormal(vec4 _normal) {
      return normalize(${n?p?"normalLocalOriginFromModel * (instanceModelNormal * _normal.xyz)":"normalLocalOriginFromModel * _normal.xyz":p?"instanceModelNormal * _normal.xyz":"_normal.xyz"});
    }
    `),3===y&&(a.addViewNormal(b),b.code.add(c.glsl`
    vec3 dpNormalView(vec4 _normal) {
      return normalize((viewNormal * ${n?p?"vec4(normalLocalOriginFromModel * (instanceModelNormal * _normal.xyz), 1.0)":"vec4(normalLocalOriginFromModel * _normal.xyz, 1.0)":p?"vec4(instanceModelNormal * _normal.xyz, 1.0)":"_normal"}).xyz);
    }
    `)),_&&b.code.add(c.glsl`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${n?p?"return vec4(normalLocalOriginFromModel * (instanceModelNormal * _tangent.xyz), _tangent.w);":"return vec4(normalLocalOriginFromModel * _tangent.xyz, _tangent.w);":p?"return vec4(instanceModelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}
    }`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/doublePrecisionUtils":function(){define(["exports"],function(e){"use strict";const t=new Float32Array(2);e.decodeDoubleArray=function(e,t,r){for(let i=0;i<r;++i)t[i]=e[2*i]+e[2*i+1]},e.encodeDoubleArray=function(e,t,r){for(let i=0;i<r;++i)t[2*i]=e[i],t[2*i+1]=e[i]-t[2*i]},e.encodeDoubleHi=function(e,r){const i=e.length;for(let s=0;s<i;++s)t[0]=e[s],r[s]=t[0];return r},e.encodeDoubleLo=function(e,r){const i=e.length;for(let s=0;s<i;++s)t[0]=e[s],t[1]=e[s]-t[0],r[s]=t[1];return r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/SymbolColor.glsl":function(){define(["exports","./MaskedColor.glsl","../../shaderModules/glsl","../../shaderModules/IntegerPassUniform","../../../materials/internal/MaterialUtil"],function(e,t,r,i,s){"use strict";e.SymbolColor=function(e,n){e.varyings.add("colorMixMode","int"),e.varyings.add("opacityMixMode","int"),e.vertex.uniforms.add(new i.IntegerPassUniform("symbolColorMixMode",e=>s.colorMixModes[e.colorMixMode])),n.hasSymbolColors?(e.vertex.include(t.MaskedColorDefinition),e.vertex.include(t.CreateMaskedFromUInt8NaNColor),e.vertex.include(t.MultiplyMaskedColors),e.attributes.add("symbolColor","vec4"),e.vertex.code.add(r.glsl`
    MaskedColor applySymbolColor(MaskedColor color) {
      return multiplyMaskedColors(color, createMaskedFromUInt8NaNColor(${"symbolColor"}));
    }
  `)):e.vertex.code.add(r.glsl`MaskedColor applySymbolColor(MaskedColor color) {
return color;
}`),e.vertex.code.add(r.glsl`
    void forwardColorMixMode(bvec4 mask) {
      colorMixMode = mask.r ? ${r.glsl.int(s.colorMixModes.ignore)} : symbolColorMixMode;
      opacityMixMode = mask.a ? ${r.glsl.int(s.colorMixModes.ignore)} : symbolColorMixMode;
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/IntegerPassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"int",1,(r,i,s)=>r.setUniform1i(e,t(i,s)))}}e.IntegerPassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl":function(){define(["exports","../../../../../../core/compilerUtils","../../shaderModules/glsl"],function(e,t,r){"use strict";e.TextureCoordinateAttribute=function(e,i){switch(i.textureCoordinateType){case 1:return e.attributes.add("uv0","vec2"),e.varyings.add("vuv0","vec2"),void e.vertex.code.add(r.glsl`void forwardTextureCoordinates() { vuv0 = uv0; }`);case 2:return e.attributes.add("uv0","vec2"),e.attributes.add("uvRegion","vec4"),e.varyings.add("vuv0","vec2"),e.varyings.add("vuvRegion","vec4"),void e.vertex.code.add(r.glsl`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:t.neverReached(i.textureCoordinateType);case 0:return void e.vertex.code.add(r.glsl`void forwardTextureCoordinates() {}`);case 3:return}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VertexColor.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.VertexColor=function(e,r){r.hasVertexColors?(e.attributes.add("color","vec4"),e.varyings.add("vColor","vec4"),e.vertex.code.add(t.glsl`void forwardVertexColor() { vColor = color; }`),e.vertex.code.add(t.glsl`
      void forwardNormalizedVertexColor() { vColor = color * ${t.glsl.float(1/255)}; }
    `)):e.vertex.code.add(t.glsl`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/default/DefaultMaterialAuxiliaryPasses.glsl":function(){define(["exports","../ForwardLinearDepthToWriteShadowMap.glsl","../Slice.glsl","../Transform.glsl","../attributes/NormalAttribute.glsl","../attributes/ObjectAndLayerIdColor.glsl","../attributes/TextureCoordinateAttribute.glsl","../attributes/VertexNormal.glsl","../output/OutputDepth.glsl","../output/OutputHighlight.glsl","../shading/VisualVariables.glsl","../util/DiscardOrAdjustAlpha.glsl","../util/View.glsl","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";e.DefaultMaterialAuxiliaryPasses=function(e,m){const{vertex:g,fragment:y,varyings:_}=e,{hasColorTexture:b,alphaDiscardMode:v}=m,w=b&&1!==v,{output:x,normalType:S,hasColorTextureTransform:T}=m;switch(x){case 2:h.addProjViewLocalOrigin(g,m),e.include(i.Transform,m),y.include(r.SliceDraw,m),e.include(o.TextureCoordinateAttribute,m),w&&y.uniforms.add(new f.Texture2DPassUniform("tex",e=>e.texture)),g.main.add(p.glsl`vpos = getVertexInLocalOriginSpace();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPosition(proj, view, vpos);
forwardTextureCoordinates();`),e.include(d.DiscardOrAdjustAlphaPass,m),y.main.add(p.glsl`
        discardBySlice(vpos);
        ${p.If(w,p.glsl`vec4 texColor = texture(tex, ${T?"colorUV":"vuv0"});
                discardOrAdjustAlpha(texColor);`)}`);break;case 4:case 5:case 6:case 7:case 9:h.addProjViewLocalOrigin(g,m),e.include(i.Transform,m),e.include(o.TextureCoordinateAttribute,m),e.include(u.VisualVariables,m),e.include(l.OutputDepth,m),y.include(r.SliceDraw,m),e.include(n.ObjectAndLayerIdColor,m),t.addNearFar(e),_.add("depth","float",{invariant:!0}),w&&y.uniforms.add(new f.Texture2DPassUniform("tex",e=>e.texture)),g.main.add(p.glsl`vpos = getVertexInLocalOriginSpace();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
forwardTextureCoordinates();
forwardObjectAndLayerIdColor();`),e.include(d.DiscardOrAdjustAlphaPass,m),y.main.add(p.glsl`
        discardBySlice(vpos);
        ${p.If(w,p.glsl`vec4 texColor = texture(tex, ${T?"colorUV":"vuv0"});
               discardOrAdjustAlpha(texColor);`)}
        ${9===x?p.glsl`outputObjectAndLayerIdColor();`:p.glsl`outputDepth(depth);`}`);break;case 3:{h.addProjViewLocalOrigin(g,m),e.include(i.Transform,m),e.include(s.NormalAttribute,m),e.include(a.VertexNormal,m),e.include(o.TextureCoordinateAttribute,m),e.include(u.VisualVariables,m),w&&y.uniforms.add(new f.Texture2DPassUniform("tex",e=>e.texture)),2===S&&_.add("vPositionView","vec3",{invariant:!0});const t=0===S||1===S;g.main.add(p.glsl`
        vpos = getVertexInLocalOriginSpace();
        ${t?p.glsl`vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:p.glsl`vPositionView = (view * vec4(vpos, 1.0)).xyz;`}
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, vpos);
        forwardTextureCoordinates();`),y.include(r.SliceDraw,m),e.include(d.DiscardOrAdjustAlphaPass,m),y.main.add(p.glsl`
        discardBySlice(vpos);
        ${p.If(w,p.glsl`vec4 texColor = texture(tex, ${T?"colorUV":"vuv0"});
                discardOrAdjustAlpha(texColor);`)}

        ${2===S?p.glsl`vec3 normal = screenDerivativeNormal(vPositionView);`:p.glsl`vec3 normal = normalize(vNormalWorld);
                    if (gl_FrontFacing == false){
                      normal = -normal;
                    }`}
        fragColor = vec4(0.5 + 0.5 * normal, 1.0);`);break}case 8:h.addProjViewLocalOrigin(g,m),e.include(i.Transform,m),e.include(o.TextureCoordinateAttribute,m),e.include(u.VisualVariables,m),w&&y.uniforms.add(new f.Texture2DPassUniform("tex",e=>e.texture)),g.main.add(p.glsl`vpos = getVertexInLocalOriginSpace();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPosition(proj, view, vpos);
forwardTextureCoordinates();`),y.include(r.SliceDraw,m),e.include(d.DiscardOrAdjustAlphaPass,m),e.include(c.OutputHighlight,m),y.main.add(p.glsl`
        discardBySlice(vpos);
        ${p.If(w,p.glsl`vec4 texColor = texture(tex, ${T?"colorUV":"vuv0"});
                discardOrAdjustAlpha(texColor);`)}
        calculateOcclusionAndOutputHighlight();`)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/output/OutputDepth.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.OutputDepth=function(e,r){switch(r.output){case 4:case 5:case 6:case 7:e.fragment.code.add(t.glsl`float _calculateFragDepth(const in float depth) {
const float SLOPE_SCALE = 2.0;
const float BIAS = 20.0 * .000015259;
float m = max(abs(dFdx(depth)), abs(dFdy(depth)));
return depth + SLOPE_SCALE * m + BIAS;
}
void outputDepth(float _linearDepth){
float fragDepth = _calculateFragDepth(_linearDepth);
gl_FragDepth = fragDepth;
}`)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/DiscardOrAdjustAlpha.glsl":function(){define(["exports","../../shaderModules/FloatDrawUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../../../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s){"use strict";function n(e,t,r){const n=e.fragment,o=t.alphaDiscardMode,a=0===o;2!==o&&3!==o||n.uniforms.add(r),n.code.add(i.glsl`
    void discardOrAdjustAlpha(inout vec4 color) {
      ${1===o?"color.a = 1.0;":`if (color.a < ${a?i.glsl.float(s.alphaCutoff):"textureAlphaCutoff"}) {\n              discard;\n             } ${i.If(2===o,"else { color.a = 1.0; }")}`}
    }
  `)}e.DiscardOrAdjustAlphaDraw=function(e,r){n(e,r,new t.FloatDrawUniform("textureAlphaCutoff",e=>e.textureAlphaCutoff))},e.DiscardOrAdjustAlphaPass=function(e,t){n(e,t,new r.FloatPassUniform("textureAlphaCutoff",e=>e.textureAlphaCutoff))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/FloatDrawUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"float",2,(i,s,n)=>i.setUniform1f(e,t(s,n),r))}}e.FloatDrawUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ComputeNormalTexture.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../../core/libs/gl-matrix-2/factories/vec2f64","../attributes/VertexTextureCoordinates.glsl","../../shaderModules/Float2PassUniform","../../shaderModules/glsl","../../shaderModules/Matrix3PassUniform","../../shaderModules/Texture2DDrawUniform","../../shaderModules/Texture2DPassUniform"],function(e,t,r,i,s,n,o,a,l){"use strict";e.ComputeNormalTexture=function(e,c){const u=e.fragment,{hasVertexTangents:d,doubleSidedMode:h,hasNormalTexture:p,textureCoordinateType:f,bindType:m,hasNormalTextureTransform:g}=c;d?(e.attributes.add("tangent","vec4"),e.varyings.add("vTangent","vec4"),2===h?u.code.add(n.glsl`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):u.code.add(n.glsl`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):u.code.add(n.glsl`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`),p&&0!==f&&(e.include(i.VertexTextureCoordinates,c),u.uniforms.add(1===m?new l.Texture2DPassUniform("normalTexture",e=>e.textureNormal):new a.Texture2DDrawUniform("normalTexture",e=>e.textureNormal)),g&&(u.uniforms.add(new s.Float2PassUniform("scale",e=>e.scale??r.ONES)),u.uniforms.add(new o.Matrix3PassUniform("normalTextureTransformMatrix",e=>e.normalTextureTransformMatrix??t.IDENTITY))),u.code.add(n.glsl`vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
vec3 rawNormal = textureLookup(normalTexture, uv).rgb * 2.0 - 1.0;`),g&&u.code.add(n.glsl`mat3 normalRotation = mat3(normalTextureTransformMatrix[0][0]/scale[0], normalTextureTransformMatrix[0][1]/scale[1], 0.0,
normalTextureTransformMatrix[1][0]/scale[0], normalTextureTransformMatrix[1][1]/scale[1], 0.0,
0.0, 0.0, 0.0 );
rawNormal.xy = (normalRotation * vec3(rawNormal.x, rawNormal.y, 1.0)).xy;`),u.code.add(n.glsl`return tangentSpace * rawNormal;
}`))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VertexTextureCoordinates.glsl":function(){define(["exports","./TextureCoordinateAttribute.glsl","../util/TextureAtlasLookup.glsl","../../shaderModules/glsl"],function(e,t,r,i){"use strict";e.VertexTextureCoordinates=function(e,s){const{textureCoordinateType:n}=s;if(0===n||3===n)return;e.include(t.TextureCoordinateAttribute,s);const o=2===n;o&&e.include(r.TextureAtlasLookup),e.fragment.code.add(i.glsl`
    vec4 textureLookup(sampler2D tex, vec2 uv) {
      return ${o?"textureAtlasLookup(tex, uv, vuvRegion)":"texture(tex, uv)"};
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/TextureAtlasLookup.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.TextureAtlasLookup=function(e){e.fragment.code.add(t.glsl`vec4 textureAtlasLookup(sampler2D tex, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
return textureGrad(tex, uvAtlas, dUVdx, dUVdy);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DDrawUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"sampler2D",2,(r,i,s)=>r.bindTexture(e,t(i,s)))}}e.Texture2DDrawUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientOcclusion.glsl":function(){define(["exports","../../shaderModules/glsl","../../shaderModules/Texture2DBindUniform","../../../effects/ssao/SSAO"],function(e,t,r,i){"use strict";e.EvaluateAmbientOcclusion=function(e,s){s.receiveAmbientOcclusion?(e.uniforms.add(new r.Texture2DBindUniform("ssaoTex",e=>e.ssao?.getTexture())),e.constants.add("blurSizePixelsInverse","float",1/i.blurSizePixels),e.code.add(t.glsl`float evaluateAmbientOcclusionInverse() {
vec2 ssaoTextureSizeInverse = 1.0 / vec2(textureSize(ssaoTex, 0));
return texture(ssaoTex, gl_FragCoord.xy * blurSizePixelsInverse * ssaoTextureSizeInverse).r;
}
float evaluateAmbientOcclusion() {
return 1.0 - evaluateAmbientOcclusionInverse();
}`)):e.code.add(t.glsl`float evaluateAmbientOcclusionInverse() { return 1.0; }
float evaluateAmbientOcclusion() { return 0.0; }`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/ssao/SSAO":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/time","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../webgl","../../../webgl/RenderNode","../../core/shaderLibrary/shading/ScreenSpaceConstants","./SSAOBlurTechnique","./SSAONoiseData","./SSAOParameters","./SSAOTechnique","../../../../../chunks/SSAO.glsl","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x){"use strict";e.SSAO=class extends p{constructor(e){super(e),this.consumes={required:["normals"]},this.produces=h.InternalRenderCategory.SSAO,this.isEnabled=()=>!1,this._enableTime=n.Milliseconds(0),this._passParameters=new y.SSAOPassParameters,this._drawParameters=new y.BlurDrawParameters}initialize(){const e=Uint8Array.from(atob(g.noiseData),e=>e.charCodeAt(0)),t=new x.TextureDescriptor(32);t.wrapMode=33071,t.pixelFormat=6407,t.wrapMode=10497,t.hasMipmap=!0,this._passParameters.noiseTexture=new w.Texture(this.renderingContext,t,e),this.techniques.precompile(_.SSAOTechnique),this.techniques.precompile(m.SSAOBlurTechnique),this.addHandles(s.watch(()=>this.isEnabled(),()=>this._enableTime=n.Milliseconds(0)))}destroy(){this._passParameters.noiseTexture=i.disposeMaybe(this._passParameters.noiseTexture)}render(e){const t=e.find(({name:e})=>"normals"===e),i=t?.getTexture(),s=t?.getTexture(v.DepthStencilAttachment);if(!i||!s)return;const o=this.techniques.get(_.SSAOTechnique),a=this.techniques.get(m.SSAOBlurTechnique);if(!o.compiled||!a.compiled)return this._enableTime=n.Milliseconds(performance.now()),void this.requestRender(1);0===this._enableTime&&(this._enableTime=n.Milliseconds(performance.now()));const l=this.renderingContext,c=this.view.qualitySettings.fadeDuration,u=this.bindParameters,p=u.camera,g=p.relativeElevation,y=r.clamp((f.distanceFadeEnd-g)/(f.distanceFadeEnd-f.distanceFadeStart),0,1),w=c>0?Math.min(c,performance.now()-this._enableTime)/c:1,x=w*y;this._passParameters.normalTexture=i,this._passParameters.depthTexture=s,this._passParameters.projScale=1/p.computeScreenPixelSizeAtDist(1),this._passParameters.intensity=4*S/b.getRadius(p)**6*x;const T=p.fullViewport[2],C=p.fullViewport[3],P=this.fboCache.acquire(T,C,"ssao input",2);l.bindFramebuffer(P.fbo),l.setViewport(0,0,T,C),l.bindTechnique(o,u,this._passParameters,this._drawParameters),l.screen.draw();const M=Math.round(T/2),R=Math.round(C/2),O=this.fboCache.acquire(M,R,"ssao blur",0);l.bindFramebuffer(O.fbo),this._drawParameters.colorTexture=P.getTexture(),d.set(this._drawParameters.blurSize,0,2/C),l.bindTechnique(a,u,this._passParameters,this._drawParameters),l.setViewport(0,0,M,R),l.screen.draw(),P.release();const I=this.fboCache.acquire(M,R,h.InternalRenderCategory.SSAO,0);return l.bindFramebuffer(I.fbo),l.setViewport(0,0,T,C),l.setClearColor(1,1,1,0),l.clear(16384),this._drawParameters.colorTexture=O.getTexture(),d.set(this._drawParameters.blurSize,2/T,0),l.bindTechnique(a,u,this._passParameters,this._drawParameters),l.setViewport(0,0,M,R),l.screen.draw(),l.setViewport4fv(p.fullViewport),O.release(),w<1&&this.requestRender(1),I}},t.__decorate([o.property()],e.SSAO.prototype,"consumes",void 0),t.__decorate([o.property()],e.SSAO.prototype,"produces",void 0),t.__decorate([o.property({constructOnly:!0})],e.SSAO.prototype,"isEnabled",void 0),e.SSAO=t.__decorate([u.subclass("esri.views.3d.webgl-engine.effects.ssao.SSAO")],e.SSAO);const S=.5;e.blurSizePixels=2,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ScreenSpaceConstants":function(){define(["exports"],function(e){"use strict";e.distanceFadeEnd=5e5,e.distanceFadeStart=3e5,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/ssao/SSAOBlurTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../lib/DefaultVertexBufferLayouts","../../../../../chunks/SSAOBlur.glsl","../../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.SSAOBlur,()=>new Promise((t,r)=>e(["../../shaders/SSAOBlur.glsl"],t,r))),s.Pos2Locations)}initializePipeline(){return o.makePipelineState({colorWrite:o.defaultColorWrite})}}t.SSAOBlurTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/SSAOBlur.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderModules/Float2DrawUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DDrawUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l){"use strict";function c(){const e=new l.ShaderBuilder,c=e.fragment;return e.include(t.ScreenSpacePass),c.include(r.ReadDepth),c.uniforms.add(new a.Texture2DPassUniform("depthMap",e=>e.depthTexture),new o.Texture2DDrawUniform("tex",e=>e.colorTexture),new i.Float2DrawUniform("blurSize",e=>e.blurSize),new s.FloatPassUniform("projScale",(e,t)=>{const r=t.camera.distance;return r>5e4?Math.max(0,e.projScale-(r-5e4)):e.projScale})),c.code.add(n.glsl`
    void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
      float c = texture(tex, uv).r;
      float d = linearDepthFromTexture(depthMap, uv);

      float ddiff = d - center_d;

      float w = exp(-r * r * ${n.glsl.float(.08)} - ddiff * ddiff * sharpness);
      wTotal += w;
      bTotal += w * c;
    }
  `),e.outputs.add("fragBlur","float"),c.main.add(n.glsl`
    float b = 0.0;
    float w_total = 0.0;

    float center_d = linearDepthFromTexture(depthMap, uv);

    float sharpness = -0.05 * projScale / center_d;
    for (int r = -${n.glsl.int(4)}; r <= ${n.glsl.int(4)}; ++r) {
      float rf = float(r);
      vec2 uvOffset = uv + rf * blurSize;
      blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
    }
    fragBlur = b / w_total;`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}));e.SSAOBlur=u,e.build=c})},"esri/views/3d/webgl-engine/core/shaderModules/Float2DrawUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r){super(e,"vec2",2,(i,s,n,o)=>i.setUniform2fv(e,t(s,n,o),r))}}e.Float2DrawUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/ssao/SSAONoiseData":function(){define(["exports"],function(e){"use strict";e.noiseData="eXKEvZaUc66cjIKElE1jlJ6MjJ6Ufkl+jn2fcXp5jBx7c6KEflSGiXuXeW6OWs+tfqZ2Yot2Y7Zzfo2BhniEj3xoiXuXj4eGZpqEaHKDWjSMe7palFlzc3BziYOGlFVzg6Zzg7CUY5JrjFF7eYJ4jIKEcyyEonSXe7qUfqZ7j3xofqZ2c4R5lFZ5Y0WUbppoe1l2cIh2ezyUho+BcHN2cG6DbpqJhqp2e1GcezhrdldzjFGUcyxjc3aRjDyEc1h7Sl17c6aMjH92pb6Mjpd4dnqBjMOEhqZleIOBYzB7gYx+fnqGjJuEkWlwnCx7fGl+c4hjfGyRe5qMlNOMfnqGhIWHc6OMi4GDc6aMfqZuc6aMzqJzlKZ+lJ6Me3qRfoFue0WUhoR5UraEa6qMkXiPjMOMlJOGe7JrUqKMjK6MeYRzdod+Sl17boiPc6qEeYBlcIh2c1WEe7GDiWCDa0WMjEmMdod+Y0WcdntzhmN8WjyMjKJjiXtzgYxYaGd+a89zlEV7e2GJfnd+lF1rcK5zc4p5cHuBhL6EcXp5eYB7fnh8iX6HjIKEeaxuiYOGc66RfG2Ja5hzjlGMjEmMe9OEgXuPfHyGhPeEdl6JY02McGuMfnqGhFiMa3WJfnx2l4hwcG1uhmN8c0WMc39og1GBbrCEjE2EZY+JcIh2cIuGhIWHe0mEhIVrc09+gY5+eYBlnCyMhGCDl3drfmmMgX15aGd+gYx+fnuRfnhzY1SMsluJfnd+hm98WtNrcIuGh4SEj0qPdkqOjFF7jNNjdnqBgaqUjMt7boeBhnZ4jDR7c5pze4GGjEFrhLqMjHyMc0mUhKZze4WEa117kWlwbpqJjHZ2eX2Bc09zeId+e0V7WlF7jHJ2l72BfId8l3eBgXyBe897jGl7c66cgW+Xc76EjKNbgaSEjGx4fId8jFFjgZB8cG6DhlFziZhrcIh2fH6HgUqBgXiPY8dahGFzjEmMhEFre2dxhoBzc5SGfleGe6alc7aUeYBlhKqUdlp+cH5za4OEczxza0Gcc4J2jHZ5iXuXjH2Jh5yRjH2JcFx+hImBjH+MpddCl3dreZeJjIt8ZW18bm1zjoSEeIOBlF9oh3N7hlqBY4+UeYFwhLJjeYFwaGd+gUqBYxiEYot2fqZ2ondzhL6EYyiEY02Ea0VjgZB8doaGjHxoc66cjEGEiXuXiXWMiZhreHx8frGMe75rY02Ec5pzfnhzlEp4a3VzjM+EhFFza3mUY7Zza1V5e2iMfGyRcziEhDyEkXZ2Y4OBnCx7g5t2eyBjgV6EhEFrcIh2dod+c4Z+nJ5zjm15jEmUeYxijJp7nL6clIpjhoR5WrZraGd+fnuRa6pzlIiMg6ZzfHx5foh+eX1ufnB5eX1ufnB5aJt7UqKMjIh+e3aBfm5lbYSBhGFze6J4c39oc0mUc4Z+e0V7fKFVe0WEdoaGY02Ec4Z+Y02EZYWBfH6HgU1+gY5+hIWUgW+XjJ57ebWRhFVScHuBfJ6PhBx7WqJzlM+Ujpd4gHZziX6HjHmEgZN+lJt5boiPe2GJgX+GjIGJgHZzeaxufnB5hF2JtdN7jJ57hp57hK6ElFVzg6ZzbmiEbndzhIWHe3uJfoFue3qRhJd2j3xoc65zlE1jc3p8lE1jhniEgXJ7e657vZaUc3qBh52BhIF4aHKDa9drgY5+c52GWqZzbpqJe8tjnM+UhIeMfo2BfGl+hG1zSmmMjKJjZVaGgX15c1lze0mEp4OHa3mUhIWHhDyclJ6MeYOJkXiPc0VzhFiMlKaEboSJa5Jze41re3qRhn+HZYWBe0mEc4p5fnORbox5lEp4hGFjhGGEjJuEc1WEhLZjeHeGa7KlfHx2hLaMeX1ugY5+hIWHhKGPjMN7c1WEho1zhoBzZYx7fnhzlJt5exyUhFFziXtzfmmMa6qMYyiEiXxweV12kZSMeWqXSl17fnhzxmmMrVGEe1mcc4p5eHeGjK6MgY5+doaGa6pzlGV7g1qBh4KHkXiPeW6OaKqafqZ2eXZ5e1V7jGd7boSJc3BzhJd2e0mcYot2h1RoY8dahK6EQmWEWjx7e1l2lL6UgXyBdnR4eU9zc0VreX1umqaBhld7fo2Bc6KEc5Z+hDyEcIeBWtNrfHyGe5qMhMuMe5qMhEGEbVVupcNzg3aHhIF4boeBe0mEdlptc39ofFl5Y8uUlJOGiYt2UmGEcyxjjGx4jFF7a657ZYWBnElzhp57iXtrgZN+tfOEhIOBjE2HgU1+e8tjjKNbiWCDhE15gUqBgYN7fnqGc66ce9d7iYSBj0qPcG6DnGGcT3eGa6qMZY+JlIiMl4hwc3aRdnqBlGV7eHJ2hLZjfnuRhDyEeX6MSk17g6Z+c6aUjHmEhIF4gXyBc76EZW18fGl+fkl+jCxrhoVwhDyUhIqGlL2DlI6EhJd2tdN7eYORhEGMa2Faa6pzc3Bzc4R5lIRznM+UY9eMhDycc5Z+c4p5c4iGY117pb6MgXuPrbJafnx2eYOJeXZ5e657hDyEcziElKZjfoB5eHeGj4WRhGGEe6KGeX1utTStc76EhFGJnCyMa5hzfH6HnNeceYB7hmN8gYuMhIVrczSMgYF8h3N7c5pza5hzjJqEYIRdgYuMlL2DeYRzhGGEeX1uhLaEc4iGeZ1zdl6JhrVteX6Me2iMfm5lWqJzSpqEa6pzdnmchHx2c6OMhNdrhoR5g3aHczxzeW52gV6Ejm15frGMc0Vzc4Z+l3drfniJe+9rWq5rlF1rhGGEhoVwe9OEfoh+e7pac09+c3qBY0lrhDycdnp2lJ6MiYOGhGCDc3aRlL2DlJt5doaGdnp2gYF8gWeOjF2Uc4R5c5Z+jEmMe7KEc4mEeYJ4dmyBe0mcgXiPbqJ7eYB7fmGGiYSJjICGlF1reZ2PnElzbpqJfH6Hc39oe4WEc5eJhK6EhqyJc3qBgZB8c09+hEmEaHKDhFGJc5SGiXWMUpaEa89zc6OMnCyMiXtrho+Be5qMc7KEjJ57dmN+hKGPjICGbmiEe7prdod+hGCDdnmchBx7eX6MkXZ2hGGEa657hm98jFFjY5JreYOJgY2EjHZ2a295Y3FajJ6Mc1J+YzB7e4WBjF2Uc4R5eV12gYxzg1qBeId+c9OUc5pzjFFjgY5+hFiMlIaPhoR5lIpjjIKBlNdSe7KEeX2BfrGMhIqGc65zjE2UhK6EklZ+QmWEeziMWqZza3VzdnR4foh+gYF8n3iJiZhrnKp7gYF8eId+lJ6Me1lrcIuGjKJjhmN8c66MjFF7a6prjJ6UnJ5zezyUfruRWlF7nI5zfHyGe657h4SEe8tjhBx7jFFjc09+c39ojICMeZeJeXt+YzRzjHZ2c0WEcIeBeXZ5onSXkVR+gYJ+eYFwdldzgYF7eX2BjJ6UiXuXlE1jh4SEe1mchLJjc4Z+hqZ7eXZ5bm1zlL6Ue5p7iWeGhKqUY5pzjKJjcIeBe8t7gXyBYIRdlEp4a3mGnK6EfmmMZpqEfFl5gYxzjKZuhGFjhoKGhHx2fnx2eXuMe3aBiWeGvbKMe6KGa5hzYzB7gZOBlGV7hmN8hqZlYot2Y117a6pzc6KEfId8foB5rctrfneJfJ6PcHN2hFiMc5pzjH92c0VzgY2EcElzdmCBlFVzg1GBc65zY4OBboeBcHiBeYJ4ewxzfHx5lIRzlEmEnLKEbk1zfJ6PhmN8eYBljBiEnMOEiXxwezyUcIeBe76EdsKEeX2BdnR4jGWUrXWMjGd7fkl+j4WRlEGMa5Jzho+BhDyEfnqMeXt+g3aHlE1jczClhNN7ZW18eHx8hGFjZW18iXWMjKJjhH57gYuMcIuGWjyMe4ZtjJuExmmMj4WRdntzi4GDhFFzYIRdnGGcjJp7Y0F7e4WEkbCGiX57fnSHa657a6prhBCMe3Z+SmmMjH92eHJ2hK6EY1FzexhrvbKMnI5za4OEfnd+eXuMhImBe897hLaMjN+EfG+BeIOBhF1+eZeJi4GDkXZ2eXKEgZ6Ejpd4c2GHa1V5e5KUfqZuhCx7jKp7lLZrg11+hHx2hFWUoot2nI5zgbh5mo9zvZaUe3qRbqKMfqZ2kbCGhFiM",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/ssao/SSAOParameters":function(){define(["exports","../../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../webgl/NoParameters"],function(e,t,r){"use strict";class i extends r.NoParameters{constructor(){super(...arguments),this.projScale=1}}class s extends r.NoParameters{}e.BlurDrawParameters=class extends s{constructor(){super(...arguments),this.blurSize=t.create()}},e.BlurPassParameters=i,e.SSAODrawParameters=s,e.SSAOPassParameters=class extends i{constructor(){super(...arguments),this.intensity=1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/ssao/SSAOTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../lib/DefaultVertexBufferLayouts","../../../../../chunks/SSAO.glsl","../../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.SSAO,()=>new Promise((t,r)=>e(["../../shaders/SSAO.glsl"],t,r))),s.Pos2Locations)}initializePipeline(){return o.makePipelineState({colorWrite:o.defaultColorWrite})}}t.SSAOTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/SSAO.glsl":function(){define(["exports","../core/libs/gl-matrix-2/math/vec2","../core/libs/gl-matrix-2/factories/vec2f64","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/CameraSpace.glsl","../views/3d/webgl-engine/core/shaderModules/Float2BindUniform","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatBindUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";function p(){const e=new h.ShaderBuilder,r=e.fragment;return e.include(i.ScreenSpacePass),e.include(n.CameraSpace),r.include(s.ReadDepth),r.uniforms.add(new l.FloatBindUniform("radius",e=>f(e.camera))).code.add(u.glsl`vec3 sphere[16] = vec3[16](
vec3(0.186937, 0.0, 0.0),
vec3(0.700542, 0.0, 0.0),
vec3(-0.864858, -0.481795, -0.111713),
vec3(-0.624773, 0.102853, -0.730153),
vec3(-0.387172, 0.260319, 0.007229),
vec3(-0.222367, -0.642631, -0.707697),
vec3(-0.01336, -0.014956, 0.169662),
vec3(0.122575, 0.1544, -0.456944),
vec3(-0.177141, 0.85997, -0.42346),
vec3(-0.131631, 0.814545, 0.524355),
vec3(-0.779469, 0.007991, 0.624833),
vec3(0.308092, 0.209288,0.35969),
vec3(0.359331, -0.184533, -0.377458),
vec3(0.192633, -0.482999, -0.065284),
vec3(0.233538, 0.293706, -0.055139),
vec3(0.417709, -0.386701, 0.442449)
);
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn - bias, 0.0);
}`),r.code.add(u.glsl`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),e.outputs.add("fragOcclusion","float"),r.uniforms.add(new d.Texture2DPassUniform("normalMap",e=>e.normalTexture),new d.Texture2DPassUniform("depthMap",e=>e.depthTexture),new c.FloatPassUniform("projScale",e=>e.projScale),new d.Texture2DPassUniform("rnm",e=>e.noiseTexture),new a.Float2PassUniform("rnmScale",(e,r)=>t.set(m,r.camera.fullWidth/e.noiseTexture.descriptor.width,r.camera.fullHeight/e.noiseTexture.descriptor.height)),new c.FloatPassUniform("intensity",e=>e.intensity),new o.Float2BindUniform("screenSize",e=>t.set(m,e.camera.fullWidth,e.camera.fullHeight))).main.add(u.glsl`
    float depth = depthFromTexture(depthMap, uv);

    // Early out if depth is out of range, such as in the sky
    if (depth >= 1.0 || depth <= 0.0) {
      fragOcclusion = 1.0;
      return;
    }

    // get the normal of current fragment
    ivec2 iuv = ivec2(uv * vec2(textureSize(normalMap, 0)));
    vec4 norm4 = texelFetch(normalMap, iuv, 0);
    if(norm4.a != 1.0) {
      fragOcclusion = 1.0;
      return;
    }
    vec3 norm = normalize(norm4.xyz * 2.0 - 1.0);

    float currentPixelDepth = linearizeDepth(depth);
    vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy, currentPixelDepth);

    float sum = 0.0;
    vec3 tapPixelPos;

    vec3 fres = normalize(2.0 * texture(rnm, uv * rnmScale).xyz - 1.0);

    // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
    // bug or deviation from CE somewhere else?
    float ps = projScale / (2.0 * currentPixelPos.z * zScale.x + zScale.y);

    for(int i = 0; i < ${u.glsl.int(16)}; ++i) {
      vec2 unitOffset = reflect(sphere[i], fres).xy;
      vec2 offset = vec2(-unitOffset * radius * ps);

      // don't use current or very nearby samples
      if( abs(offset.x) < 2.0 || abs(offset.y) < 2.0){
        continue;
      }

      vec2 tc = vec2(gl_FragCoord.xy + offset);
      if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenSize.x || tc.y > screenSize.y) continue;
      vec2 tcTap = tc / screenSize;
      float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap);

      tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

      sum += aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
    }

    // output the result
    float A = max(1.0 - sum * intensity / float(${u.glsl.int(16)}), 0.0);

    // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4) / 2.2
    A = (pow(A, 0.2) + 1.2 * A * A * A * A) / 2.2;

    fragOcclusion = A;
  `),e}function f(e){return Math.max(10,20*e.computeScreenPixelSizeAtDist(Math.abs(4*e.relativeElevation)))}const m=r.create(),g=Object.freeze(Object.defineProperty({__proto__:null,build:p,getRadius:f},Symbol.toStringTag,{value:"Module"}));e.SSAO=g,e.build=p,e.getRadius=f})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/CameraSpace.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../../../chunks/vec42","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../shaderModules/Float2BindUniform","../../shaderModules/Float4BindUniform","../../shaderModules/glsl"],function(e,t,r,i,s,n,o,a){"use strict";function l(e){const t=e.projectionMatrix;return 0===t[11]?i.set(c,2/(e.fullWidth*t[0]),2/(e.fullHeight*t[5]),(1+t[12])/t[0],(1+t[13])/t[5]):i.set(c,-2/(e.fullWidth*t[0]),-2/(e.fullHeight*t[5]),(1-t[8])/t[0],(1-t[9])/t[5])}const c=s.create();function u(e){return 0===e.projectionMatrix[11]?t.set(d,0,1):t.set(d,1,0)}const d=r.create();e.CameraSpace=function(e){e.fragment.uniforms.add(new o.Float4BindUniform("projInfo",e=>l(e.camera))),e.fragment.uniforms.add(new n.Float2BindUniform("zScale",e=>u(e.camera))),e.fragment.code.add(a.glsl`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)},e.getProjectionInfo=l,e.getZScale=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateSceneLighting.glsl":function(){define(["exports","../../../../../../colorUtils","../../../../../../core/has","./EvaluateAmbientLighting.glsl","./EvaluateAmbientOcclusion.glsl","./MainLighting.glsl","./PhysicallyBasedRendering.glsl","./PiUtils.glsl","../../shaderModules/BooleanBindUniform","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../../lighting/SceneLighting","../../../shaders/BlackLevelLightSoftCompression.glsl","../../../shaders/ToneMapping.glsl"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";function f(e){e.constants.add("ambientBoostFactor","float",d.ambientBoost)}function m(e){e.uniforms.add(new c.FloatBindUniform("lightingGlobalFactor",e=>e.lighting.globalFactor))}e.EvaluateSceneLighting=function(e,r){const d=e.fragment,{pbrMode:g,spherical:y,hasColorTexture:_}=r;d.include(s.EvaluateAmbientOcclusion,r),0!==g&&d.include(o.PhysicallyBasedRendering,r),e.include(i.EvaluateAmbientLighting,r),d.include(a.PiUtils),d.include(p.ToneMapping,r);const b=!(2===g&&!_);switch(b&&d.include(h.BlackLevelLightSoftCompression),d.code.add(u.glsl`
    const float GAMMA_SRGB = ${u.glsl.float(t.colorGamma)};
    const float INV_GAMMA_SRGB = 0.4761904;
    ${u.If(0!==g,"const float GROUND_REFLECTANCE = 0.2;")}
  `),f(d),m(d),n.addMainLightDirection(d),d.code.add(u.glsl`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${y?u.glsl`normalize(vPosWorld)`:u.glsl`vec3(0.0, 0.0, 1.0)`}, mainLightDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),n.addMainLightIntensity(d),d.code.add(u.glsl`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * mainLightIntensity;
}`),g){case 0:case 4:case 3:e.include(n.applyShading),d.code.add(u.glsl`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight) {
vec3 mainLighting = applyShading(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`);break;case 1:case 2:d.code.add(u.glsl`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight,
vec3 viewDir, vec3 groundNormal, vec3 mrr, vec4 _emission,
float additionalAmbientIrradiance) {
vec3 viewDirection = -viewDir;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotNG = clamp(dot(normal, groundNormal), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, groundNormal), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),d.code.add(u.glsl`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),r.useFillLights?d.uniforms.add(new l.BooleanBindUniform("hasFillLights",e=>e.enableFillLights)):d.constants.add("hasFillLights","bool",!1),d.code.add(u.glsl`vec3 ambientDir = vec3(5.0 * groundNormal[1] - groundNormal[0] * groundNormal[2], - 5.0 * groundNormal[0] - groundNormal[2] * groundNormal[1], groundNormal[1] * groundNormal[1] + groundNormal[0] * groundNormal[0]);
ambientDir = ambientDir != vec3(0.0) ? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;
float NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
vec3 mainLightIrradianceComponent = NdotL * (1.0 - shadow) * mainLightIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * mainLightIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),d.uniforms.add(new c.FloatBindUniform("lightingSpecularStrength",e=>e.lighting.mainLight.specularStrength),new c.FloatBindUniform("lightingEnvironmentStrength",e=>e.lighting.mainLight.environmentStrength)).code.add(u.glsl`vec3 horizonRingDir = inputs.RdotNG * groundNormal - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
float NdotH = clamp(dot(normal, h), 0.0, 1.0);
vec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(NdotH, inputs.roughness) * mainLightIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * mainLightIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;
float normalDirectionModifier = mix(1., min(mix(0.1, 2.0, (inputs.NdotNG + 1.) * 0.5), 1.0), clamp(inputs.roughness * 5.0, 0.0 , 1.0));
inputs.skyRadianceToSurface = (ambientLightRadianceComponent + horizonLightRadianceComponent) * normalDirectionModifier + mainLightRadianceComponent;
inputs.groundRadianceToSurface = 0.5 * GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) * normalDirectionModifier + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE);`),d.code.add(u.glsl`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = _emission.rgb == vec3(0.0) ? _emission.rgb : tonemapACES(pow(_emission.rgb, vec3(GAMMA_SRGB)));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${b?u.glsl`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:u.glsl`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `);break;case 5:case 6:n.addMainLightDirection(d),n.addMainLightIntensity(d),d.code.add(u.glsl`const float roughnessTerrain = 0.5;
const float specularityTerrain = 0.5;
const vec3 fresnelReflectionTerrain = vec3(0.04);
vec3 evaluatePBRSimplifiedLighting(vec3 n, vec3 c, float shadow, float ssao, vec3 al, vec3 vd, vec3 nup) {
vec3 viewDirection = -vd;
vec3 h = normalize(viewDirection + mainLightDirection);
float NdotL = clamp(dot(n, mainLightDirection), 0.001, 1.0);
float NdotV = clamp(abs(dot(n, viewDirection)), 0.001, 1.0);
float NdotH = clamp(dot(n, h), 0.0, 1.0);
float NdotNG = clamp(dot(n, nup), -1.0, 1.0);
vec3 albedoLinear = pow(c, vec3(GAMMA_SRGB));
float lightness = 0.3 * albedoLinear[0] + 0.5 * albedoLinear[1] + 0.2 * albedoLinear[2];
vec3 f0 = (0.85 * lightness + 0.15) * fresnelReflectionTerrain;
vec3 f90 =  vec3(clamp(dot(f0, vec3(50.0 * 0.33)), 0.0, 1.0));
vec3 mainLightIrradianceComponent = (1. - shadow) * NdotL * mainLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(n, ssao) + al;
vec3 ambientSky = ambientLightIrradianceComponent + mainLightIrradianceComponent;
vec3 indirectDiffuse = ((1.0 - NdotNG) * mainLightIrradianceComponent + (1.0 + NdotNG ) * ambientSky) * 0.5;
vec3 outDiffColor = albedoLinear * (1.0 - f0) * indirectDiffuse / PI;
vec3 mainLightRadianceComponent = normalDistribution(NdotH, roughnessTerrain) * mainLightIntensity;
vec2 dfg = prefilteredDFGAnalytical(roughnessTerrain, NdotV);
vec3 specularColor = f0 * dfg.x + f90 * dfg.y;
vec3 specularComponent = specularityTerrain * specularColor * mainLightRadianceComponent;
vec3 outColorLinear = outDiffColor + specularComponent;
vec3 outColor = pow(outColorLinear, vec3(INV_GAMMA_SRGB));
return outColor;
}`)}},e.addAmbientBoostFactor=f,e.addLightingGlobalFactor=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientLighting.glsl":function(){define(["exports","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../chunks/vec42","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../shaderModules/Float3BindUniform","../../shaderModules/Float4BindUniform","../../shaderModules/glsl"],function(e,t,r,i,s,n,o,a){"use strict";const l=r.create(),c=s.create();e.EvaluateAmbientLighting=function(e,r){const s=e.fragment,u=void 0!==r.lightingSphericalHarmonicsOrder?r.lightingSphericalHarmonicsOrder:2;0===u?(s.uniforms.add(new n.Float3BindUniform("lightingAmbientSH0",({lighting:e})=>t.set(l,e.sh.r[0],e.sh.g[0],e.sh.b[0]))),s.code.add(a.glsl`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):1===u?(s.uniforms.add(new o.Float4BindUniform("lightingAmbientSH_R",({lighting:e})=>i.set(c,e.sh.r[0],e.sh.r[1],e.sh.r[2],e.sh.r[3])),new o.Float4BindUniform("lightingAmbientSH_G",({lighting:e})=>i.set(c,e.sh.g[0],e.sh.g[1],e.sh.g[2],e.sh.g[3])),new o.Float4BindUniform("lightingAmbientSH_B",({lighting:e})=>i.set(c,e.sh.b[0],e.sh.b[1],e.sh.b[2],e.sh.b[3]))),s.code.add(a.glsl`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):2===u&&(s.uniforms.add(new n.Float3BindUniform("lightingAmbientSH0",({lighting:e})=>t.set(l,e.sh.r[0],e.sh.g[0],e.sh.b[0])),new o.Float4BindUniform("lightingAmbientSH_R1",({lighting:e})=>i.set(c,e.sh.r[1],e.sh.r[2],e.sh.r[3],e.sh.r[4])),new o.Float4BindUniform("lightingAmbientSH_G1",({lighting:e})=>i.set(c,e.sh.g[1],e.sh.g[2],e.sh.g[3],e.sh.g[4])),new o.Float4BindUniform("lightingAmbientSH_B1",({lighting:e})=>i.set(c,e.sh.b[1],e.sh.b[2],e.sh.b[3],e.sh.b[4])),new o.Float4BindUniform("lightingAmbientSH_R2",({lighting:e})=>i.set(c,e.sh.r[5],e.sh.r[6],e.sh.r[7],e.sh.r[8])),new o.Float4BindUniform("lightingAmbientSH_G2",({lighting:e})=>i.set(c,e.sh.g[5],e.sh.g[6],e.sh.g[7],e.sh.g[8])),new o.Float4BindUniform("lightingAmbientSH_B2",({lighting:e})=>i.set(c,e.sh.b[5],e.sh.b[6],e.sh.b[7],e.sh.b[8]))),s.code.add(a.glsl`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),1!==r.pbrMode&&2!==r.pbrMode||s.code.add(a.glsl`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl":function(){define(["exports","../../shaderModules/Float3BindUniform","../../shaderModules/glsl"],function(e,t,r){"use strict";function i(e){e.uniforms.add(new t.Float3BindUniform("mainLightDirection",e=>e.lighting.mainLight.direction))}function s(e){e.uniforms.add(new t.Float3BindUniform("mainLightIntensity",e=>e.lighting.mainLight.intensity))}e.addMainLightDirection=i,e.addMainLightIntensity=s,e.applyShading=function(e){i(e.fragment),s(e.fragment),e.fragment.code.add(r.glsl`vec3 applyShading(vec3 shadingNormal, float shadow) {
float dotVal = clamp(dot(shadingNormal, mainLightDirection), 0.0, 1.0);
return mainLightIntensity * ((1.0 - shadow) * dotVal);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRendering.glsl":function(){define(["exports","./AnalyticalSkyModel.glsl","./PiUtils.glsl","../../shaderModules/glsl"],function(e,t,r,i){"use strict";e.PhysicallyBasedRendering=function(e,s){e.include(r.PiUtils),1!==s.pbrMode&&2!==s.pbrMode&&5!==s.pbrMode&&6!==s.pbrMode||(e.code.add(i.glsl`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),e.code.add(i.glsl`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`)),1!==s.pbrMode&&2!==s.pbrMode||(e.include(t.AnalyticalSkyModel),e.code.add(i.glsl`struct PBRShadingInfo
{
float NdotV;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),e.code.add(i.glsl`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`))},e.PhysicallyBasedRenderingWater=function(e,t){e.include(r.PiUtils),e.code.add(i.glsl`
  struct PBRShadingWater {
      float NdotL;   // cos angle between normal and light direction
      float NdotV;   // cos angle between normal and view direction
      float NdotH;   // cos angle between normal and half vector
      float VdotH;   // cos angle between view direction and half vector
      float LdotH;   // cos angle between light direction and half vector
      float VdotN;   // cos angle between view direction and normal vector
  };

  float dtrExponent = ${t.useCustomDTRExponentForWater?"2.2":"2.0"};
  `),e.code.add(i.glsl`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),e.code.add(i.glsl`float normalDistributionWater(float NdotH, float roughness) {
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),e.code.add(i.glsl`float geometricOcclusionKelemen(float LoH) {
return 0.25 / (LoH * LoH);
}`),e.code.add(i.glsl`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max) {
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze) * strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/AnalyticalSkyModel.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.AnalyticalSkyModel=function(e){e.code.add(t.glsl`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG) {
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),e.code.add(t.glsl`float integratedRadiance(float cosTheta2, float roughness) {
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),e.code.add(t.glsl`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness) {
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/PiUtils.glsl":function(){define(["exports"],function(e){"use strict";e.PiUtils=function(e){const t=.3183098861837907;e.constants.add("PI","float",3.141592653589793),e.constants.add("LIGHT_NORMALIZATION","float",t),e.constants.add("INV_PI","float",t),e.constants.add("HALF_PI","float",1.570796326794897),e.constants.add("TWO_PI","float",6.28318530717958)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lighting/SceneLighting":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","./Lightsources","./SphericalHarmonics"],function(e,t,r,i,s,n){"use strict";class o{constructor(){this.color=i.create(),this.intensity=1}}class a{constructor(){this.direction=i.create(),this.ambient=new o,this.diffuse=new o}}const l=i.create();e.SceneLighting=class{constructor(){this._shOrder=2,this._legacy=new a,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new s.SphericalHarmonicsAmbientLight,this._mainLight=new s.MainLight(i.create(),i.fromValues(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(e){n.combineLights(e,this._shOrder,this._mainLight,this._sphericalHarmonics),r.copy(this._legacy.direction,this._mainLight.direction);const t=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*t,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*t,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*t,r.scale(this._legacy.diffuse.color,this._mainLight.intensity,t),r.copy(l,this._legacy.diffuse.color),r.scale(l,l,.4*this.globalFactor),r.add(this._legacy.ambient.color,this._legacy.ambient.color,l)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),r.copy(this._mainLight.direction,e.mainLight.direction),r.copy(this._mainLight.intensity,e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,i,s){if(r.lerp(this._mainLight.intensity,e.mainLight.intensity,i.mainLight.intensity,s),this._mainLight.environmentStrength=t.lerp(e.mainLight.environmentStrength,i.mainLight.environmentStrength,s),this._mainLight.specularStrength=t.lerp(e.mainLight.specularStrength,i.mainLight.specularStrength,s),r.copy(this._mainLight.direction,i.mainLight.direction),this._mainLight.castShadows=i.mainLight.castShadows,this.globalFactor=t.lerp(e.globalFactor,i.globalFactor,s),this.noonFactor=t.lerp(e.noonFactor,i.noonFactor,s),e.sh.r.length===i.sh.r.length)for(let r=0;r<i.sh.r.length;r++)this._sphericalHarmonics.r[r]=t.lerp(e.sh.r[r],i.sh.r[r],s),this._sphericalHarmonics.g[r]=t.lerp(e.sh.g[r],i.sh.g[r],s),this._sphericalHarmonics.b[r]=t.lerp(e.sh.b[r],i.sh.b[r],s);else for(let e=0;e<i.sh.r.length;e++)this._sphericalHarmonics.r[e]=i.sh.r[e],this._sphericalHarmonics.g[e]=i.sh.g[e],this._sphericalHarmonics.b[e]=i.sh.b[e]}},e.SunLight=a,e.ambientBoost=.4,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lighting/SphericalHarmonics":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../lib/LongVectorMath","./Lightsources"],function(e,t,r,i,s,n){"use strict";function o(e){return(e+1)*(e+1)}function a(e){return t.clamp(Math.floor(Math.sqrt(e)-1),0,2)}function l(e,t,r){const i=e[0],s=e[1],n=e[2],a=r||[];return a.length=o(t),t>=0&&(a[0]=.28209479177),t>=1&&(a[1]=.4886025119*i,a[2]=.4886025119*n,a[3]=.4886025119*s),t>=2&&(a[4]=1.09254843059*i*s,a[5]=1.09254843059*s*n,a[6]=.31539156525*(3*n*n-1),a[7]=1.09254843059*i*n,a[8]=.54627421529*(i*i-s*s)),a}function c(e,t){const r=o(e),i=t||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=r;for(let e=0;e<r;e++)i.r[e]=i.g[e]=i.b[e]=0;return i}function u(e,t){const i=a(t.r.length);for(const n of e)r.negate(y,n.direction),l(y,i,m),s.elementwiseProduct(m,_),s.scalarProduct(m,n.intensity[0],g),s.add(t.r,g),s.scalarProduct(m,n.intensity[1],g),s.add(t.g,g),s.scalarProduct(m,n.intensity[2],g),s.add(t.b,g);return t}function d(e,t){l(y,0,m);for(const r of e)t.r[0]+=m[0]*_[0]*r.intensity[0]*4*Math.PI,t.g[0]+=m[0]*_[0]*r.intensity[1]*4*Math.PI,t.b[0]+=m[0]*_[0]*r.intensity[2]*4*Math.PI;return t}const h=[],p=[],f=[],m=[0],g=[0],y=i.create(),_=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];e.combineLights=function(e,t,i,o){c(t,o),r.set(i.intensity,0,0,0);let a=!1;const l=h,m=p,g=f;l.length=0,m.length=0,g.length=0;for(const t of e)t instanceof n.MainLight&&!a?(r.copy(i.direction,t.direction),r.copy(i.intensity,t.intensity),i.specularStrength=t.specularStrength,i.environmentStrength=t.environmentStrength,i.castShadows=t.castShadows,a=!0):t instanceof n.MainLight||t instanceof n.FillLight?l.push(t):t instanceof n.AmbientLight?m.push(t):t instanceof n.SphericalHarmonicsAmbientLight&&g.push(t);u(l,o),d(m,o);for(const e of g)s.add(o.r,e.r),s.add(o.g,e.g),s.add(o.b,e.b)},e.computeCoefficients=l,e.initSHCoefficients=c,e.numberOfCoefficients=o,e.orderFromNumberOfCoefficients=a,e.projectAmbientLights=d,e.projectFillLights=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/LongVectorMath":function(){define(["exports"],function(e){"use strict";e.add=function(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]+t[i];return r},e.dotProduct=function(e,t){let r=0;for(let i=0;i<e.length;i++)r+=e[i]*t[i];return r},e.elementwiseProduct=function(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]*t[i];return r},e.scalarProduct=function(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]*t;return r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/BlackLevelLightSoftCompression.glsl":function(){define(["exports","../core/shaderModules/glsl"],function(e,t){"use strict";e.BlackLevelLightSoftCompression=function(e){e.code.add(t.glsl`float mapChannel(float x, vec2 p) {
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),e.code.add(t.glsl`vec3 blackLevelSoftCompression(vec3 color, float averageAmbientRadiance) {
vec2 p = vec2(0.02, 0.0075) * averageAmbientRadiance;
return vec3(mapChannel(color.x, p), mapChannel(color.y, p), mapChannel(color.z, p));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/ToneMapping.glsl":function(){define(["exports","../core/shaderModules/glsl"],function(e,t){"use strict";e.ToneMapping=function(e){e.code.add(t.glsl`vec3 tonemapACES(vec3 x) {
return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/Normals.glsl":function(){define(["exports","../../../../../../core/compilerUtils","../../shaderModules/glsl"],function(e,t,r){"use strict";e.Normals=function(e,i){const s=e.fragment;switch(s.code.add(r.glsl`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),i.doubleSidedMode){case 0:s.code.add(r.glsl`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`);break;case 1:s.code.add(r.glsl`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`);break;case 2:s.code.add(r.glsl`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`);break;default:t.neverReached(i.doubleSidedMode);case 3:}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl":function(){define(["exports","../attributes/VertexTextureCoordinates.glsl","../../shaderModules/Float3DrawUniform","../../shaderModules/Float3PassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DDrawUniform","../../shaderModules/Texture2DPassUniform","../../../materials/pbrUtils","../../../../../webgl/NoParameters"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends l.NoParameters{constructor(e,t){super(),this.textureOcclusion=e,this.textureMetallicRoughness=t,this.mrrFactors=a.schematicMRRFactors}}e.PBRRenderingParameters=c,e.PhysicallyBasedRenderingParameters=function(e,a){const l=a.pbrMode,c=e.fragment;if(2!==l&&0!==l&&1!==l)return void c.code.add(s.glsl`void applyPBRFactors() {}`);if(0===l)return void c.code.add(s.glsl`void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`);if(2===l)return void c.code.add(s.glsl`vec3 mrr = vec3(0.0, 0.6, 0.2);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`);const{hasMetallicRoughnessTexture:u,hasMetallicRoughnessTextureTransform:d,hasOcclusionTexture:h,hasOcclusionTextureTransform:p,bindType:f}=a;(u||h)&&e.include(t.VertexTextureCoordinates,a),c.code.add(s.glsl`vec3 mrr;
float occlusion;`),u&&c.uniforms.add(1===f?new o.Texture2DPassUniform("texMetallicRoughness",e=>e.textureMetallicRoughness):new n.Texture2DDrawUniform("texMetallicRoughness",e=>e.textureMetallicRoughness)),h&&c.uniforms.add(1===f?new o.Texture2DPassUniform("texOcclusion",e=>e.textureOcclusion):new n.Texture2DDrawUniform("texOcclusion",e=>e.textureOcclusion)),c.uniforms.add(1===f?new i.Float3PassUniform("mrrFactors",e=>e.mrrFactors):new r.Float3DrawUniform("mrrFactors",e=>e.mrrFactors)),c.code.add(s.glsl`
    ${s.If(u,s.glsl`void applyMetallicRoughness(vec2 uv) {
            vec3 metallicRoughness = textureLookup(texMetallicRoughness, uv).rgb;
            mrr[0] *= metallicRoughness.b;
            mrr[1] *= metallicRoughness.g;
          }`)}

    ${s.If(h,"void applyOcclusion(vec2 uv) { occlusion *= textureLookup(texOcclusion, uv).r; }")}

    float getBakedOcclusion() {
      return ${h?"occlusion":"1.0"};
    }

    void applyPBRFactors() {
      mrr = mrrFactors;
      occlusion = 1.0;

      ${s.If(u,`applyMetallicRoughness(${d?"metallicRoughnessUV":"vuv0"});`)}
      ${s.If(h,`applyOcclusion(${p?"occlusionUV":"vuv0"});`)}
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../ForwardLinearDepthToReadShadowMap.glsl","./calculateUVZShadow.glsl","./ShadowmapFiltering.glsl","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../shaderModules/Texture2DShadowBindUniform","../../../../../webgl/NoParameters"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends i.ReadShadowMapOrigin{}class u extends l.NoParameters{constructor(){super(...arguments),this.origin=t.create()}}function d(e,t){e.fragment.uniforms.add(new n.FloatBindUniform("lightingGlobalFactor",e=>e.lighting.globalFactor));const{receiveShadows:i,spherical:l}=t;e.include(r.ForwardLinearDepthToReadShadowMap,t),i&&function(e){e.include(s.ShadowmapFiltering),e.fragment.uniforms.add(new a.Texture2DShadowBindUniform("shadowMap",({shadowMap:e})=>e.depthTexture)).code.add(o.glsl`float readShadowMap(const in vec3 _worldPos, float _linearDepth) {
vec3 uvzShadow = calculateUVZShadow(_worldPos, _linearDepth, textureSize(shadowMap,0));
if (uvzShadow.z < 0.0) {
return 0.0;
}
return readShadowMapUVZ(uvzShadow, shadowMap);
}`)}(e),e.fragment.code.add(o.glsl`
    float readShadow(float additionalAmbientScale, vec3 vpos) {
      return ${i?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), readShadowMap(vpos, linearDepth))":o.If(l,"lightingGlobalFactor * (1.0 - additionalAmbientScale)","0.0")};
    }
  `)}e.ReadShadowMapDraw=function(e,t){t.receiveShadows&&e.include(i.calculateUVZShadowDraw),d(e,t)},e.ReadShadowMapDrawParameters=c,e.ReadShadowMapPass=function(e,t){t.receiveShadows&&e.include(i.calculateUVZShadowPass),d(e,t)},e.ReadShadowMapPassParameters=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepthToReadShadowMap.glsl":function(){define(["exports","./ForwardLinearDepth.glsl","./ShaderOutput","../shaderModules/glsl"],function(e,t,r,i){"use strict";e.ForwardLinearDepthToReadShadowMap=function(e,s){const n=r.isColorOrColorEmission(s.output)&&s.receiveShadows;n&&t.ForwardLinearDepth(e,!0),e.vertex.code.add(i.glsl`
    void forwardLinearDepthToReadShadowMap() { ${i.If(n,"forwardLinearDepth(gl_Position.w);")} }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/calculateUVZShadow.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../shaderModules/Float4BindUniform","../../shaderModules/glsl","../../shaderModules/IntegerBindUniform","../../shaderModules/Matrix4sDrawUniform","../../shaderModules/Matrix4sPassUniform","../../../../../webgl/NoParameters"],function(e,t,r,i,s,n,o,a){"use strict";class l extends a.NoParameters{constructor(){super(...arguments),this.origin=t.create()}}function c(e){const{fragment:t}=e;t.uniforms.add(new r.Float4BindUniform("cascadeDistances",e=>e.shadowMap.cascadeDistances),new s.IntegerBindUniform("numCascades",e=>e.shadowMap.numCascades)),t.code.add(i.glsl`const vec3 invalidShadowmapUVZ = vec3(0.0, 0.0, -1.0);
vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
vec4 lv = mat * vec4(_vpos, 1.0);
lv.xy /= lv.w;
return 0.5 * lv.xyz + vec3(0.5);
}
vec2 cascadeCoordinates(int i, ivec2 textureSize, vec3 lvpos) {
float xScale = float(textureSize.y) / float(textureSize.x);
return vec2((float(i) + lvpos.x) * xScale, lvpos.y);
}
vec3 calculateUVZShadow(in vec3 _worldPos, in float _linearDepth, in ivec2 shadowMapSize) {
int i = _linearDepth < cascadeDistances[1] ? 0 : _linearDepth < cascadeDistances[2] ? 1 : _linearDepth < cascadeDistances[3] ? 2 : 3;
if (i >= numCascades) {
return invalidShadowmapUVZ;
}
mat4 shadowMatrix = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];
vec3 lvpos = lightSpacePosition(_worldPos, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
return invalidShadowmapUVZ;
}
vec2 uvShadow = cascadeCoordinates(i, shadowMapSize, lvpos);
return vec3(uvShadow, lvpos.z);
}`)}e.ReadShadowMapOrigin=l,e.calculateUVZShadowDraw=function(e){e.fragment.uniforms.add(new n.Matrix4sDrawUniform("shadowMapMatrix",(e,t)=>t.shadowMap.getShadowMapMatrices(e.origin),4)),c(e)},e.calculateUVZShadowPass=function(e){e.fragment.uniforms.add(new o.Matrix4sPassUniform("shadowMapMatrix",(e,t)=>t.shadowMap.getShadowMapMatrices(e.origin),4)),c(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Matrix4sDrawUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r,i){super(e,"mat4",2,(r,s,n,o)=>r.setUniformMatrix4fv(e,t(s,n,o),i),r)}}e.Matrix4sDrawUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Matrix4sPassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t,r,i){super(e,"mat4",1,(r,s,n)=>r.setUniformMatrix4fv(e,t(s,n),i),r)}}e.Matrix4sPassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ShadowmapFiltering.glsl":function(){define(["exports","./calculateUVZShadow.glsl","../../shaderModules/glsl"],function(e,t,r){"use strict";class i extends t.ReadShadowMapOrigin{}e.ReadShadowMapDrawParameters=i,e.ShadowmapFiltering=function(e){e.fragment.code.add(r.glsl`float readShadowMapUVZ(vec3 uvzShadow, sampler2DShadow _shadowMap) {
return texture(_shadowMap, uvzShadow);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DShadowBindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"sampler2DShadow",0,(r,i)=>r.bindTexture(e,t(i)))}}e.Texture2DShadowBindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/TextureTransformUV.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../shaderModules/glsl","../../shaderModules/Matrix3PassUniform"],function(e,t,r,i){"use strict";e.colorTextureUV=function(e,s){s.hasColorTextureTransform?(e.varyings.add("colorUV","vec2"),e.vertex.uniforms.add(new i.Matrix3PassUniform("colorTextureTransformMatrix",e=>e.colorTextureTransformMatrix??t.IDENTITY)).code.add(r.glsl`void forwardColorUV(){
colorUV = (colorTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(r.glsl`void forwardColorUV(){}`)},e.emissiveTextureUV=function(e,s){s.hasEmissionTextureTransform&&0!==s.textureCoordinateType?(e.varyings.add("emissiveUV","vec2"),e.vertex.uniforms.add(new i.Matrix3PassUniform("emissiveTextureTransformMatrix",e=>e.emissiveTextureTransformMatrix??t.IDENTITY)).code.add(r.glsl`void forwardEmissiveUV(){
emissiveUV = (emissiveTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(r.glsl`void forwardEmissiveUV(){}`)},e.metallicRoughnessTextureUV=function(e,s){s.hasMetallicRoughnessTextureTransform&&0!==s.textureCoordinateType?(e.varyings.add("metallicRoughnessUV","vec2"),e.vertex.uniforms.add(new i.Matrix3PassUniform("metallicRoughnessTextureTransformMatrix",e=>e.metallicRoughnessTextureTransformMatrix??t.IDENTITY)).code.add(r.glsl`void forwardMetallicRoughnessUV(){
metallicRoughnessUV = (metallicRoughnessTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(r.glsl`void forwardMetallicRoughnessUV(){}`)},e.normalTextureUV=function(e,s){s.hasNormalTextureTransform&&0!==s.textureCoordinateType?(e.varyings.add("normalUV","vec2"),e.vertex.uniforms.add(new i.Matrix3PassUniform("normalTextureTransformMatrix",e=>e.normalTextureTransformMatrix??t.IDENTITY)).code.add(r.glsl`void forwardNormalUV(){
normalUV = (normalTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(r.glsl`void forwardNormalUV(){}`)},e.occlusionTextureUV=function(e,s){s.hasOcclusionTextureTransform&&0!==s.textureCoordinateType?(e.varyings.add("occlusionUV","vec2"),e.vertex.uniforms.add(new i.Matrix3PassUniform("occlusionTextureTransformMatrix",e=>e.occlusionTextureTransformMatrix??t.IDENTITY)).code.add(r.glsl`void forwardOcclusionUV(){
occlusionUV = (occlusionTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(r.glsl`void forwardOcclusionUV(){}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/MixExternalColor.glsl":function(){define(["exports","./ColorConversion.glsl","../../shaderModules/glsl"],function(e,t,r){"use strict";e.MixExternalColor=function(e){e.include(t.ColorConversion),e.code.add(r.glsl`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in macOS using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${r.glsl.int(1)}) {
        return allMixed;
      }
      if (mode == ${r.glsl.int(2)}) {
        return internalMixed;
      }
      if (mode == ${r.glsl.int(3)}) {
        return externalColor;
      }

      // tint (or something invalid)
      float vIn = rgb2v(internalMixed);
      vec3 hsvTint = rgb2hsv(externalColor);
      vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
      return hsv2rgb(hsvOut);
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in macOS using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${r.glsl.int(2)}) {
        return internalMixed;
      }
      if (mode == ${r.glsl.int(3)}) {
        return externalOpacity;
      }

      // multiply or tint (or something invalid)
      return allMixed;
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/weather/SnowCover.glsl":function(){define(["exports","../../core/shaderModules/glsl"],function(e,t){"use strict";e.SnowCover=function(e,r){r.snowCover&&(e.code.add(t.glsl`float getSnow(vec3 normal, vec3 normalGround) {
return smoothstep(0.5, 0.55, dot(normal, normalGround));
}`),e.code.add(t.glsl`vec3 applySnowToMRR(vec3 mrr, float snow) {
return mix(mrr, vec3(0.0, 1.0, 0.04), snow);
}
vec4 snowCoverForEmissions(vec4 emission, float snow) {
return mix(emission, vec4(0.0), snow);
}`))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/OutputColorHighlightOID.glsl":function(){define(["exports","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/output/Emissions.glsl","../core/shaderLibrary/output/OutputHighlight.glsl","../core/shaderLibrary/util/ColorConversion.glsl","../core/shaderModules/glsl","../../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o){"use strict";e.outputColorHighlightOID=function(e,a){e.include(i.OutputHighlight,a),e.include(r.Emissions,a),e.fragment.include(s.ColorConversion);const{output:l,oitPass:c,discardInvisibleFragments:u,snowCover:d}=a,h=9===l,p=t.isColorEmission(l),f=t.isColorOrColorEmission(l)&&1===c,m=t.isColorOrColorEmission(l)&&1!==c;let g=0;(m||p||f)&&e.outputs.add("fragColor","vec4",g++),p&&e.outputs.add("fragEmission","vec4",g++),f&&e.outputs.add("fragAlpha","float",g++),e.fragment.code.add(n.glsl`
    void outputColorHighlightOID(vec4 finalColor, const in vec3 vWorldPosition, vec3 emissiveSymbolColor ${n.If(d,", float snow")}) {
      ${n.If(h,"finalColor.a = 1.0;")}

      ${n.If(u,`if (finalColor.a < ${n.glsl.float(o.alphaCutoff)}) { discard; }`)}

      finalColor = applySlice(finalColor, vWorldPosition);
      ${n.If(f,n.glsl`fragColor = premultiplyAlpha(finalColor);
             fragAlpha = finalColor.a;`)}
      ${n.If(m,"fragColor = finalColor;")}
      ${n.If(p,`fragEmission = ${n.If(d,"mix(finalColor.a * getEmissions(emissiveSymbolColor), vec4(0.0), snow);","finalColor.a * getEmissions(emissiveSymbolColor);")}`)}
      calculateOcclusionAndOutputHighlight();
      ${n.If(h,"outputObjectAndLayerIdColor();")}
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/output/Emissions.glsl":function(){define(["exports","../ShaderOutput","../attributes/VertexTextureCoordinates.glsl","../shading/Gamma.glsl","../../shaderModules/Float3DrawUniform","../../shaderModules/Float3PassUniform","../../shaderModules/FloatDrawUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DDrawUniform","../../shaderModules/Texture2DPassUniform","../../../lib/GLTextureMaterial"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h extends d.GLEmissiveTexturePassParameters{}e.Emissions=function(e,d){if(!t.isColorOrColorEmission(d.output))return;e.fragment.include(i.Gamma);const{emissionSource:h,hasEmissiveTextureTransform:p,bindType:f}=d,m=3===h||4===h||5===h;m&&(e.include(r.VertexTextureCoordinates,d),e.fragment.uniforms.add(1===f?new u.Texture2DPassUniform("texEmission",e=>e.textureEmissive):new c.Texture2DDrawUniform("texEmission",e=>e.textureEmissive)));const g=2===h||m;g&&e.fragment.uniforms.add(1===f?new n.Float3PassUniform("emissiveBaseColor",e=>e.emissiveBaseColor):new s.Float3DrawUniform("emissiveBaseColor",e=>e.emissiveBaseColor));const y=0!==h;y&&7!==h&&6!==h&&4!==h&&5!==h&&e.fragment.uniforms.add(1===f?new a.FloatPassUniform("emissiveStrength",e=>e.emissiveStrength):new o.FloatDrawUniform("emissiveStrength",e=>e.emissiveStrength));const _=7===h,b=5===h,v=1===h||6===h||_;e.fragment.code.add(l.glsl`
    vec4 getEmissions(vec3 symbolColor) {
      vec4 emissions = ${g?b?"emissiveSource == 0 ? vec4(emissiveBaseColor, 1.0): vec4(linearizeGamma(symbolColor), 1.0)":"vec4(emissiveBaseColor, 1.0)":v?_?"emissiveSource == 0 ? vec4(0.0): vec4(linearizeGamma(symbolColor), 1.0)":"vec4(linearizeGamma(symbolColor), 1.0)":"vec4(0.0)"};
      ${l.If(m,`${l.If(b,`if(emissiveSource == 0) {\n              vec4 emissiveFromTex = textureLookup(texEmission, ${p?"emissiveUV":"vuv0"});\n              emissions *= vec4(linearizeGamma(emissiveFromTex.rgb), emissiveFromTex.a);\n           }`,`vec4 emissiveFromTex = textureLookup(texEmission, ${p?"emissiveUV":"vuv0"});\n           emissions *= vec4(linearizeGamma(emissiveFromTex.rgb), emissiveFromTex.a);`)}\n         emissions.w = emissions.rgb == vec3(0.0) ? 0.0: emissions.w;`)}
      ${l.If(y,"emissions.rgb *= emissiveStrength;")}
      return emissions;
    }
  `)},e.EmissionsParameters=h,e.emissiveStrengthDefault=1,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl":function(){define(["exports","../../../../../../colorUtils","../../shaderModules/glsl"],function(e,t,r){"use strict";e.Gamma=function(e){e.code.add(r.glsl`
    const float GAMMA = ${r.glsl.float(t.colorGamma)};
    const float INV_GAMMA = ${r.glsl.float(1/t.colorGamma)};

    vec4 delinearizeGamma(vec4 color) {
      return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.a);
    }

    vec3 linearizeGamma(vec3 color) {
      return pow(color, vec3(GAMMA));
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/DefaultMaterialTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(e){super(),this.spherical=e,this.alphaDiscardMode=1,this.doubleSidedMode=0,this.pbrMode=0,this.cullFace=0,this.normalType=0,this.customDepthTest=0,this.emissionSource=0,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.instanced=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instancedFeatureAttribute=!1,this.instancedColor=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.snowCover=!1,this.hasBloom=!1,this.hasColorTextureTransform=!1,this.hasEmissionTextureTransform=!1,this.hasNormalTextureTransform=!1,this.hasOcclusionTextureTransform=!1,this.hasMetallicRoughnessTextureTransform=!1,this.occlusionPass=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!0,this.draped=!1}get textureCoordinateType(){return this.hasTextures?1:0}get hasTextures(){return this.hasColorTexture||this.hasNormalTexture||this.hasMetallicRoughnessTexture||3===this.emissionSource||this.hasOcclusionTexture}get hasVVInstancing(){return this.instanced}get discardInvisibleFragments(){return this.transparent}}t.__decorate([r.parameter({count:4})],s.prototype,"alphaDiscardMode",void 0),t.__decorate([r.parameter({count:3})],s.prototype,"doubleSidedMode",void 0),t.__decorate([r.parameter({count:7})],s.prototype,"pbrMode",void 0),t.__decorate([r.parameter({count:3})],s.prototype,"cullFace",void 0),t.__decorate([r.parameter({count:3})],s.prototype,"normalType",void 0),t.__decorate([r.parameter({count:2})],s.prototype,"customDepthTest",void 0),t.__decorate([r.parameter({count:8})],s.prototype,"emissionSource",void 0),t.__decorate([r.parameter()],s.prototype,"hasVertexColors",void 0),t.__decorate([r.parameter()],s.prototype,"hasSymbolColors",void 0),t.__decorate([r.parameter()],s.prototype,"hasVerticalOffset",void 0),t.__decorate([r.parameter()],s.prototype,"hasColorTexture",void 0),t.__decorate([r.parameter()],s.prototype,"hasMetallicRoughnessTexture",void 0),t.__decorate([r.parameter()],s.prototype,"hasOcclusionTexture",void 0),t.__decorate([r.parameter()],s.prototype,"hasNormalTexture",void 0),t.__decorate([r.parameter()],s.prototype,"hasScreenSizePerspective",void 0),t.__decorate([r.parameter()],s.prototype,"hasVertexTangents",void 0),t.__decorate([r.parameter()],s.prototype,"hasOccludees",void 0),t.__decorate([r.parameter()],s.prototype,"instanced",void 0),t.__decorate([r.parameter()],s.prototype,"instancedDoublePrecision",void 0),t.__decorate([r.parameter()],s.prototype,"hasModelTransformation",void 0),t.__decorate([r.parameter()],s.prototype,"offsetBackfaces",void 0),t.__decorate([r.parameter()],s.prototype,"hasVVSize",void 0),t.__decorate([r.parameter()],s.prototype,"hasVVColor",void 0),t.__decorate([r.parameter()],s.prototype,"receiveShadows",void 0),t.__decorate([r.parameter()],s.prototype,"receiveAmbientOcclusion",void 0),t.__decorate([r.parameter()],s.prototype,"textureAlphaPremultiplied",void 0),t.__decorate([r.parameter()],s.prototype,"instancedFeatureAttribute",void 0),t.__decorate([r.parameter()],s.prototype,"instancedColor",void 0),t.__decorate([r.parameter()],s.prototype,"writeDepth",void 0),t.__decorate([r.parameter()],s.prototype,"transparent",void 0),t.__decorate([r.parameter()],s.prototype,"enableOffset",void 0),t.__decorate([r.parameter()],s.prototype,"terrainDepthTest",void 0),t.__decorate([r.parameter()],s.prototype,"cullAboveTerrain",void 0),t.__decorate([r.parameter()],s.prototype,"snowCover",void 0),t.__decorate([r.parameter()],s.prototype,"hasBloom",void 0),t.__decorate([r.parameter()],s.prototype,"hasColorTextureTransform",void 0),t.__decorate([r.parameter()],s.prototype,"hasEmissionTextureTransform",void 0),t.__decorate([r.parameter()],s.prototype,"hasNormalTextureTransform",void 0),t.__decorate([r.parameter()],s.prototype,"hasOcclusionTextureTransform",void 0),t.__decorate([r.parameter()],s.prototype,"hasMetallicRoughnessTextureTransform",void 0),e.DefaultMaterialTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/RealisticTreeTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","./DefaultMaterialTechnique","../../../../chunks/RealisticTree.glsl"],function(e,t,r,i,s){"use strict";class n extends i.DefaultMaterialTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.RealisticTree,()=>new Promise((t,r)=>e(["./RealisticTree.glsl"],t,r))))}}t.RealisticTreeTechnique=n,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/RealisticTree.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/Offset.glsl","../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/Transform.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/InstanceColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/InstancedDoublePrecision.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/MaskedColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/SymbolColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VerticalOffset.glsl","../views/3d/webgl-engine/core/shaderLibrary/default/DefaultMaterialAuxiliaryPasses.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientOcclusion.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateSceneLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRendering.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/TerrainDepthTest.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/VisualVariables.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/DiscardOrAdjustAlpha.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/MixExternalColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/materials/internal/MaterialUtil","../views/3d/webgl-engine/shaders/OutputColorHighlightOID.glsl","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D){"use strict";function E(e){const E=new A.ShaderBuilder,{attributes:L,vertex:V,fragment:U,varyings:B}=E,{output:N,offsetBackfaces:k,pbrMode:z,snowCover:j,spherical:G,hasBloom:q}=e,H=1===z||2===z;if(T.addProjViewLocalOrigin(V,e),L.add("position","vec3"),B.add("vpos","vec3",{invariant:!0}),E.include(w.VisualVariables,e),E.include(o.InstancedDoublePrecision,e),E.include(h.VerticalOffset,e),E.include(v.terrainDepthTest,e),!r.isColorOrColorEmission(N))return E.include(p.DefaultMaterialAuxiliaryPasses,e),E;T.addCameraPosition(E.vertex,e),E.include(l.NormalAttribute,e),E.include(s.Transform,e),k&&E.include(t.Offset),B.add("vNormalWorld","vec3"),B.add("localvpos","vec3",{invariant:!0}),E.include(u.TextureCoordinateAttribute,e),E.include(c.SymbolColor,e),E.include(n.InstanceColor,e),E.include(d.VertexColor,e),V.include(a.MaskedColorDefinition),V.include(a.CreateMaskedFromNaNColor),V.uniforms.add(new P.Float4PassUniform("externalColor",e=>e.externalColor,{supportsNaN:!0})),B.add("vcolorExt","vec4"),E.include(e.instancedDoublePrecision?b.ReadShadowMapPass:b.ReadShadowMapDraw,e),V.main.add(R.glsl`
      forwardNormalizedVertexColor();

      MaskedColor maskedColorExt =
        applySymbolColor(applyVVColor(applyInstanceColor(createMaskedFromNaNColor(externalColor))));

      vcolorExt = maskedColorExt.color;
      forwardColorMixMode(maskedColorExt.mask);

      bool alphaCut = opacityMixMode != ${R.glsl.int(I.colorMixModes.ignore)} && vcolorExt.a < ${R.glsl.float(D.alphaCutoff)};
      vpos = getVertexInLocalOriginSpace();
      localvpos = vpos - view[3].xyz;
      vpos = subtractOrigin(vpos);
      vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
      vpos = addVerticalOffset(vpos, localOrigin);
      vec4 basePosition = transformPosition(proj, view, vpos);

      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
      forwardTextureCoordinates();
      forwardLinearDepthToReadShadowMap();
      gl_Position = alphaCut ? vec4(1e38, 1e38, 1e38, 1.0) :
      ${R.If(k,"offsetBackfacingClipPosition(basePosition, vpos, vNormalWorld, cameraPosition);","basePosition;")}
    `);const{hasColorTexture:W,hasColorTextureTransform:$}=e;return E.include(m.EvaluateSceneLighting,e),U.include(f.EvaluateAmbientOcclusion,e),E.include(x.DiscardOrAdjustAlphaPass,e),U.include(i.SliceDraw,e),E.include(F.outputColorHighlightOID,e),T.addCameraPosition(U,e),g.addMainLightDirection(U),m.addAmbientBoostFactor(U),m.addLightingGlobalFactor(U),U.uniforms.add(V.uniforms.get("localOrigin"),V.uniforms.get("view"),new C.Float3PassUniform("ambient",e=>e.ambient),new C.Float3PassUniform("diffuse",e=>e.diffuse),new M.FloatPassUniform("opacity",e=>e.opacity),new M.FloatPassUniform("layerOpacity",e=>e.layerOpacity)),W&&U.uniforms.add(new O.Texture2DPassUniform("tex",e=>e.texture)),E.include(_.PhysicallyBasedRenderingParameters,e),U.include(y.PhysicallyBasedRendering,e),U.include(S.MixExternalColor),g.addMainLightIntensity(U),U.main.add(R.glsl`
      discardBySlice(vpos);
      discardByTerrainDepth();
      vec4 texColor = ${W?`texture(tex, ${$?"colorUV":"vuv0"})`:" vec4(1.0)"};
      ${R.If(W,`${R.If(e.textureAlphaPremultiplied,"texColor.rgb /= texColor.a;")}\n        discardOrAdjustAlpha(texColor);`)}
      vec3 viewDirection = normalize(vpos - cameraPosition);
      applyPBRFactors();
      float ssao = evaluateAmbientOcclusionInverse();
      ssao *= getBakedOcclusion();

      float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
      vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
      float shadow = readShadow(additionalAmbientScale, vpos);
      vec3 matColor = max(ambient, diffuse);
      ${e.hasVertexColors?R.glsl`vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, colorMixMode);
             float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, opacityMixMode);`:R.glsl`vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, colorMixMode);
             float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, opacityMixMode);`}

      ${R.If(j,"albedo = mix(albedo, vec3(1), 0.9);")}
      ${R.glsl`vec3 shadingNormal = normalize(vNormalWorld);
             albedo *= 1.2;
             vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
             float alignmentLightView = clamp(dot(viewForward, -mainLightDirection), 0.0, 1.0);
             float transmittance = 1.0 - clamp(dot(viewForward, shadingNormal), 0.0, 1.0);
             float treeRadialFalloff = vColor.r;
             float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
             additionalLight += backLightFactor * mainLightIntensity;`}
      ${R.If(H,`vec3 normalGround = ${G?"normalize(vpos + localOrigin)":"vec3(0.0, 0.0, 1.0)"};`)}
      ${H?R.glsl`float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
                 ${R.If(j,R.glsl`mrr = applySnowToMRR(mrr, 1.0)`)}
            vec4 emission = ${j||q?"vec4(0.0)":"getEmissions(albedo)"};
            vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:R.glsl`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
      vec4 finalColor = vec4(shadedColor, opacity_);
      outputColorHighlightOID(finalColor, vpos, albedo ${R.If(j,", 1.0")});`),E}const L=Object.freeze(Object.defineProperty({__proto__:null,build:E},Symbol.toStringTag,{value:"Module"}));e.RealisticTree=L,e.build=E})},"esri/views/3d/layers/graphics/Loadable":function(){define(["exports","../../../../core/maybe","../../../../core/promiseUtils"],function(e,t,r){"use strict";e.Loadable=class{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=0,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){return 1===this._loadStatus?(e&&e(),this._loader??Promise.resolve()):2===this._loadStatus?(t&&t(this._loadError),this._loader??Promise.resolve()):(null==this._loader&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=1},e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=2,!r.isAbortError(e)&&this.logger&&e.message&&this.logger.warn(e.message),e})),this._loader.then(e,t).catch(()=>{}),this._loader)}abortLoad(){null!=this._abortController?this._abortController=t.abortMaybe(this._abortController):0===this._loadStatus&&(this._loadStatus=2),this._loader=null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/symbolColorUtils":function(){define(["exports","../../../../core/mathUtils"],function(e,t){"use strict";function r(e){return isNaN(e)?255:e*(254/255)}const i=255;e.encodeNaNUInt8=function(e,t){for(let i=0;i<4;i++)e[i]=r(t[i]);return e},e.encodeSymbolColor=function(e,r,s){if(null==e||2===r)return s[0]=255,s[1]=255,s[2]=255,void(s[3]=255);const n=t.clamp(Math.round(85*e[3]),0,85),o=0===n||4===r?0:3===r?85:170;s[0]=t.clamp(Math.round(e[0]*i),0,i),s[1]=t.clamp(Math.round(e[1]*i),0,i),s[2]=t.clamp(Math.round(e[2]*i),0,i),s[3]=n+o},e.parseColorMixMode=function(e){switch(e){case"multiply":default:return 1;case"ignore":return 2;case"replace":return 3;case"tint":return 4}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/pointUtils":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectPointToVector","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/coordsUtils","../../../../layers/graphics/dehydratedPoint","./elevationAlignmentUtils","./graphicUtils","../../webgl-engine/lib/Object3D"],function(e,t,r,i,s,n,o,a,l){"use strict";function c(e,t){const s=e.clippingExtent;return!!s&&(r.projectPointToVector(t,d,e.elevationProvider.spatialReference),!i.containsPoint(s,d))}function u(e,t){return r.projectPointToVector(t,d,e.renderCoordsHelper.spatialReference),e.localOriginFactory.getOrigin(d)}const d=t.create();e.createStageObject=function(e,t,r,i,s){if(c(e,t))return null;r.localOrigin=u(e,t);const n=new l.Object3D({geometries:[r],castShadow:!1,layerViewUid:e.layerViewUid,graphicUid:s,usesVerticalDistanceToGround:!0});return{object:n,sampledElevation:o.applyElevationAlignmentForHUD(n,t,e.elevationProvider,e.renderCoordsHelper,i)}},e.extendPointGraphicElevationContext=function(e,t,i){const s=e.elevationContext,o=i.spatialReference;r.projectPointToVector(t,d,o),s.centerPointInElevationSR=n.makeDehydratedPoint(d[0],d[1],t.hasZ?d[2]:0,null!=o?o:null)},e.getLocalOriginForPoint=u,e.placePointOnGeometry=function(e){switch(e.type){case"point":return e;case"polygon":case"extent":return a.computeCentroid(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const r=s.getPointOnPath(t,s.getPathLength(t)/2);return n.makeDehydratedPoint(r[0],r[1],r[2],e.spatialReference)}case"mesh":return e.extent.center}return null},e.updateStageObjectGeometry=function(e,t,r,i){return c(t,r)?null:o.applyElevationAlignmentForHUD(e,r,t.elevationProvider,t.renderCoordsHelper,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Object3D":function(){define(["exports","../../../../core/has","../../../../core/uid","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/sphere","../../support/mathUtils","./Object3DStateID","./Util","./VertexAttribute","../materials/renderers/utils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";class p{constructor(){this._data=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE]}get min(){return o.fromValues(this._data[0],this._data[1],this._data[2])}get max(){return o.fromValues(this._data[3],this._data[4],this._data[5])}minWith(e){const{_data:t}=this;t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2])}maxWith(e){const{_data:t}=this;t[3]=Math.max(t[3],e[0]),t[4]=Math.max(t[4],e[1]),t[5]=Math.max(t[5],e[2])}assignMinMax(e,t){for(let r=0;r<3;++r)this._data[0+r]=e[r],this._data[3+r]=t[r]}isEmpty(){return this._data[3]<this._data[0]&&this._data[4]<this._data[1]&&this._data[5]<this._data[2]}}class f extends p{constructor(){super(...arguments),this.bounds=a.create()}}function m(e,t,r){const s=e.bbMin,o=e.bbMax;if(i.hasIdentityRotation(r)){const e=n.set(g,r[12],r[13],r[14]);return n.add(y,s,e),n.add(_,o,e),t.minWith(y),void t.maxWith(_)}if(n.transformMat4(y,s,r),n.exactEquals(s,o))return t.minWith(y),void t.maxWith(y);n.transformMat4(_,o,r),t.minWith(y),t.minWith(_),t.maxWith(y),t.maxWith(_);for(let e=0;e<3;++e)n.copy(y,s),n.copy(_,o),y[e]=o[e],_[e]=s[e],n.transformMat4(y,y,r),n.transformMat4(_,_,r),t.minWith(y),t.minWith(_),t.maxWith(y),t.maxWith(_)}const g=o.create(),y=o.create(),_=o.create(),b=o.create();e.BoundingVolume=f,e.Object3D=class{constructor(e={}){this.id=r.generateUID(),this._highlightIds=new Set,this._shaderTransformation=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerViewUid=e.layerViewUid,e.isElevationSource&&(this.lastValidElevationBB=new p),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get layer(){return this._layer}set layer(e){u.assert(null==this._layer||null==e,"Object3D can only be added to a single Layer"),this._layer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e);for(const t of this._highlightIds)e.addHighlight(t);this._emit("geometryAdded",{object:this,geometry:e}),this._highlightIds.size&&this._emit("highlightChanged",this),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];if(t){for(const e of this._highlightIds)t.removeHighlight(e);this._emit("geometryRemoved",{object:this,geometry:t}),this._highlightIds.size&&this._emit("highlightChanged",this),this._invalidateBoundingVolume()}}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,r=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:t,sync:r}),d.affectsGeometry(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometries)e.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new c.Object3DOccludeeStateID;for(const t of this._geometries)t.occludees=h.addObject3DStateID(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=h.removeObject3DStateID(t.occludees,e);this._emit("occlusionChanged",this)}highlight(e){const t=new c.Object3DHighlightStateID(e);for(const e of this._geometries)e.addHighlight(t);return this._emit("highlightChanged",this),this._highlightIds.add(t),t}removeHighlight(e){this._highlightIds.delete(e);for(const t of this._geometries)t.removeHighlight(e);this._emit("highlightChanged",this)}removeStateID(e){0===e.channel?this.removeHighlight(e):this.removeOcclude(e)}getCombinedStaticTransformation(e,t){return i.multiply(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e,t=s.create()){return i.multiply(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new f,this._validateBoundingVolume(this._bvWorldSpace,0)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new f,this._validateBoundingVolume(this._bvObjectSpace,1)),this._bvObjectSpace}_validateBoundingVolume(e,t){const r=1===t;for(const t of this._geometries){const i=t.boundingInfo;i&&m(i,e,r?t.transformation:this.getCombinedShaderTransformation(t))}n.lerp(a.getCenter(e.bounds),e.min,e.max,.5);for(const t of this._geometries){const i=t.boundingInfo;if(null==i)continue;const s=r?t.transformation:this.getCombinedShaderTransformation(t),o=l.maxScale(s);n.transformMat4(b,i.center,s);const c=n.distance(b,a.getCenter(e.bounds)),u=i.radius*o;e.bounds[3]=Math.max(e.bounds[3],c+u)}}_invalidateBoundingVolume(){const e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this.layer&&e&&this.layer.notifyObjectBBChanged(this,e)}_emit(e,t){this.layer?.events.emit(e,t)}get geometries(){return this._geometries}get transformation(){return this._transformation??s.IDENTITY}set transformation(e){this._transformation=i.copy(this._transformation??s.create(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?i.copy(this._shaderTransformation??s.create(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/VertexAttribute":function(){define(["exports"],function(e){"use strict";e.affectsGeometry=function(e){return"position"===e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/renderers/utils":function(){define(["exports","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../webgl/doublePrecisionUtils"],function(e,t,r){"use strict";const i=t.create(),s=new Float32Array(6);e.addObject3DStateID=function(e,t){return null==e&&(e=[]),e.push(t),e},e.encodeDoubleVec3=function(e,t,n,o,a){i[0]=e.get(t,0),i[1]=e.get(t,1),i[2]=e.get(t,2),r.encodeDoubleArray(i,s,3),n.set(a,0,s[0]),o.set(a,0,s[1]),n.set(a,1,s[2]),o.set(a,1,s[3]),n.set(a,2,s[4]),o.set(a,2,s[5])},e.removeObject3DStateID=function(e,t){if(null==e)return null;const r=e.filter(e=>e!==t);return 0===r.length?null:r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/LineCalloutMaterial":function(){define(["exports","../../../../core/string","../../../../core/libs/gl-matrix-2/factories/vec2f32","../../../../core/libs/gl-matrix-2/factories/vec4f64","../core/shaderLibrary/ShaderOutput","../lib/GLMaterial","../lib/Material","./internal/bufferWriterUtils","../shaders/LineCalloutTechnique","../shaders/LineCalloutTechniqueConfiguration","../../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";class d extends o.Material{constructor(e,t){super(e,f),this.intersectDraped=void 0,this.produces=new Map([[15,e=>s.isColorOrColorEmission(e)],[16,e=>s.isColorOrColorEmission(e)]]),this._configuration=new c.LineCalloutTechniqueConfiguration(t),this._uniqueMaterialIdentifier=h(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.hudDepth=16===t.slot,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration}get visible(){return this.parameters.color[3]>=u.alphaCutoff||(this.parameters.borderColor?.[3]??0)>=u.alphaCutoff}intersect(){}createGLMaterial(e){return new p(e)}createBufferWriter(){return new g}validateParameters(e){this._uniqueMaterialIdentifier=h(e)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}}function h({renderOccluded:e,isDecoration:r,horizontalScreenOffset:i,color:s,size:n,occlusionTest:o,shaderPolygonOffset:a,hudDepthAlignStart:l,centerOffsetUnits:c,hasSlicePlane:u,screenSizePerspective:d,verticalOffset:h,borderColor:p}){return t.safeToString`${e}:${r}:${i}:[${s}]:${n}:${o}:${a}:${l}:${c}:${u}:${null!=d}:{${h?.screenLength}:${h?.minWorldLength}:${h?.maxWorldLength}}:[${p}]`}class p extends n{beginSlot(e){return this.getTechnique(l.LineCalloutTechnique,e)}}class f extends o.MaterialParameters{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=i.fromValues(0,0,0,1),this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const m=[r.fromValues(0,0),r.fromValues(1,0),r.fromValues(0,1),r.fromValues(1,0),r.fromValues(1,1),r.fromValues(0,1)];class g{constructor(){this.layout=l.layout}elementCount(e){return 6*e.get("position").indices.length}write(e,t,r,i,s,n){a.writePosition(r.get("position"),e,s.position,n,6),a.writeNormal(r.get("normal"),t,s.normal,n,6),a.writeBufferVec4(r.get("centerOffsetAndDistance"),s.centerOffsetAndDistance,n,6);for(let e=0;e<m.length;++e)s.uv0.setVec(n+e,m[e]);return null}}e.LineCalloutMaterial=d,e.Parameters=f,e.uniqueMaterialIdentifier=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/libs/gl-matrix-2/factories/vec2f32":function(){define(["exports"],function(e){"use strict";function t(){return new Float32Array(2)}function r(e){const t=new Float32Array(2);return t[0]=e[0],t[1]=e[1],t}function i(e,t){const r=new Float32Array(2);return r[0]=e,r[1]=t,r}function s(){return t()}function n(){return i(1,1)}function o(){return i(1,0)}function a(){return i(0,1)}const l=s(),c=n(),u=o(),d=a(),h=Object.freeze(Object.defineProperty({__proto__:null,ONES:c,UNIT_X:u,UNIT_Y:d,ZEROS:l,clone:r,create:t,fromValues:i,ones:n,unitX:o,unitY:a,zeros:s},Symbol.toStringTag,{value:"Module"}));e.ONES=c,e.UNIT_X=u,e.UNIT_Y=d,e.ZEROS=l,e.clone=r,e.create=t,e.fromValues=i,e.ones=n,e.unitX=o,e.unitY=a,e.vec2f32=h,e.zeros=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/LineCalloutTechnique":function(){define(["require","exports","../../support/buffer/InterleavedLayout","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../../../../chunks/LineCallout.glsl","../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends s.ShaderTechnique{constructor(t,r){super(t,r,new i.ReloadableShaderModule(n.LineCallout,()=>new Promise((t,r)=>e(["./LineCallout.glsl"],t,r))),l.locations)}initializePipeline(e){const{hudDepth:t,terrainDepthTest:r}=e,i={func:r?519:513};return o.makePipelineState(t?{depthTest:i,depthWrite:o.defaultDepthWrite}:{blending:o.separateBlendingParams(1,770,771,771),depthTest:i,colorWrite:o.defaultColorWrite})}}const l=r.newLayout().vec3f("position").vec3f("normal").vec2f16("uv0").vec4f("centerOffsetAndDistance");t.LineCalloutTechnique=a,t.layout=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/LineCallout.glsl":function(){define(["exports","../core/libs/gl-matrix-2/math/vec2","../core/libs/gl-matrix-2/factories/vec2f64","../core/libs/gl-matrix-2/factories/vec4f64","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/AlignPixel.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/HUD.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/HUDVisibility.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MultipassGeometryTest.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ScreenSizePerspective.glsl","../views/3d/webgl-engine/core/shaderModules/Float2BindUniform","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/Float4BindUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g){"use strict";function y(e){const r=new g.ShaderBuilder,{vertex:y,fragment:b}=r,{terrainDepthTest:v}=e;return y.include(n.AlignPixel),r.include(o.HUD,e),r.vertex.include(s.RejectBySlice,e),r.attributes.add("uv0","vec2"),y.uniforms.add(new h.Float4BindUniform("viewport",e=>e.camera.fullViewport),new f.FloatPassUniform("lineSize",(e,t)=>e.size>0?Math.max(1,e.size)*t.camera.pixelRatio:0),new u.Float2BindUniform("pixelToNDC",e=>t.set(_,2/e.camera.fullViewport[2],2/e.camera.fullViewport[3])),new f.FloatPassUniform("borderSize",(e,t)=>e.borderColor?t.camera.pixelRatio:0),new d.Float2PassUniform("screenOffset",(e,r)=>t.set(_,e.horizontalScreenOffset*r.camera.pixelRatio,0))),r.varyings.add("coverageSampling","vec4"),r.varyings.add("lineSizes","vec2"),v&&r.varyings.add("depth","float"),e.occlusionTestEnabled&&r.include(a.HUDVisibility),e.hasScreenSizePerspective&&c.addScreenSizePerspectiveAlignment(y),y.main.add(m.glsl`
    ProjectHUDAux projectAux;
    vec4 endPoint = projectPositionHUD(projectAux);

    vec3 vpos = projectAux.posModel;
    if (rejectBySlice(vpos)) {
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
    ${m.If(e.occlusionTestEnabled,m.glsl`if (!testHUDVisibility(endPoint)) {
             gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
             return;
           }`)}

    ${e.hasScreenSizePerspective?m.glsl`vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
               vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);`:"vec2 screenOffsetScaled = screenOffset;"}
    // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the
    // correct depth value
    vec3 posView = (view * vec4(position, 1.0)).xyz;
    ${m.If(v,"depth = posView.z;")}

    applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);
    vec4 startPoint = proj * vec4(posView, 1.0);

    // Apply screen offset to both start and end point
    vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
    startPoint.xy += screenOffsetNorm * startPoint.w;
    endPoint.xy += screenOffsetNorm * endPoint.w;

    // Align start and end to pixel origin
    vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
    vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${m.If(e.hudDepth,e.hudDepthAlignStart?"endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);":"startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);")}
    vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);

    // The direction of the line in screen space
    vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
    vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.hasScreenSizePerspective?m.glsl`float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
               float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);`:m.glsl`float lineSizeScaled = lineSize;
               float borderSizeScaled = borderSize;`}
    float halfPixelSize = lineSizeScaled * 0.5;

    // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
    float padding = 1.0 + borderSizeScaled;
    vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

    // Offset x/y from the center of the line in screen space
    projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

    // Compute a coverage varying which we can use in the fragment shader to determine
    // how much a pixel is actually covered by the line (i.e. to anti alias the line).
    // This works by computing two coordinates that can be linearly interpolated and then
    // subtracted to find out how far away from the line edge we are.
    float edgeDirection = (uv0.x * 2.0 - 1.0);

    float halfBorderSize = 0.5 * borderSizeScaled;
    float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
    float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

    float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

    coverageSampling = vec4(
      // Edge coordinate
      outerEdgeCoverageSampler,

      // Border edge coordinate
      outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

      // Line offset
      halfPixelSize - 0.5,

      // Border offset
      halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
    );

    lineSizes = vec2(lineSizeScaled, borderSizeScaled);
    gl_Position = projectedPosition;`),b.uniforms.add(new p.Float4PassUniform("uColor",e=>e.color??i.ZEROS),new p.Float4PassUniform("borderColor",e=>e.borderColor??i.ZEROS)),v&&(b.include(l.multipassGeometryTest,e),b.uniforms.add(new u.Float2BindUniform("inverseViewport",e=>e.inverseViewport))),b.main.add(m.glsl`
    ${m.If(v,"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }")}

    vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

    float borderAlpha = uColor.a * borderColor.a * coverage.y;
    float colorAlpha = uColor.a * coverage.x;

    float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);
    ${m.If(!e.hudDepth,m.glsl`vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
           fragColor = vec4(finalRgb, finalAlpha);`)}`),r}const _=r.create(),b=Object.freeze(Object.defineProperty({__proto__:null,build:y},Symbol.toStringTag,{value:"Module"}));e.LineCallout=b,e.build=y})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/MultipassGeometryTest.glsl":function(){define(["exports","../output/ReadDepth.glsl","../../shaderModules/glsl","../../shaderModules/Texture2DBindUniform"],function(e,t,r,i){"use strict";e.multipassGeometryTest=function(e){e.include(t.ReadDepth),e.uniforms.add(new i.Texture2DBindUniform("geometryDepthTexture",e=>e.geometryDepth?.attachment)),e.code.add(r.glsl`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);
return (elementDepth < (geometryDepth - 1.0));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/LineCalloutTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.terrainDepthTest=!1,this.draped=!1}}t.__decorate([r.parameter()],s.prototype,"screenCenterOffsetUnitsEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"occlusionTestEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"hasVerticalOffset",void 0),t.__decorate([r.parameter()],s.prototype,"hasScreenSizePerspective",void 0),t.__decorate([r.parameter()],s.prototype,"hudDepth",void 0),t.__decorate([r.parameter()],s.prototype,"hudDepthAlignStart",void 0),t.__decorate([r.parameter()],s.prototype,"terrainDepthTest",void 0),e.LineCalloutTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/graphicSymbolUtils":function(){define(["exports","./Graphics3DSymbol","./Graphics3DWebStyleSymbol"],function(e,t,r){"use strict";e.getGraphics3DSymbol=function(e){return e instanceof r.Graphics3DWebStyleSymbol?e.graphics3DSymbol:e instanceof t.Graphics3DSymbol?e:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DSymbol":function(){define(["require","exports","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/has","../../../../core/promiseUtils","./defaultSymbolComplexity","./Graphics3DGraphic","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCreationContext","./Loadable","./symbolMemory"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h extends u.Loadable{set symbol(e){this._symbol=e,e.symbolLayers.forEach((t,r)=>{const i=this.symbolLayers[r];null!=i&&(i.symbol=e,i.symbolLayer=t)})}get symbol(){return this._symbol}constructor(e,t,r){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(t){let r=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(r=this._backgroundLayers.concat(r));const s=r.length;for(;this.symbolLayers.length<r.length;)this.symbolLayers.push(null);this.symbolLayers.length=r.length;const o=[];if(!p){const{make:t}=await new Promise((t,r)=>e(["./Graphics3DSymbolLayerFactory"],t,r));p=t}for(let e=0;e<s;e++){const i=r.at(e);if(!1===i.enabled)continue;f.renderPriority=1-(1+e)/s,f.renderPriorityStep=1/s,f.ignoreDrivers=i.ignoreDrivers;const a=p(this.symbol,i,this._context,f),l=n.onAbortOrThrow(t,()=>{this.symbolLayers[e]=null,a.destroy()});l&&o.push(l),this.symbolLayers[e]=a}if(await i.forEach(this.symbolLayers,async(e,t)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}}),o.forEach(e=>e.remove()),n.throwIfAborted(t),this.symbolLayers.length&&!this.symbolLayers.some(e=>!!e))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return null!=t?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>e?.queryForSnapping)}updateFocus(e,t){this.symbolLayers.forEach(r=>r?.updateFocus(e,t))}createGraphics3DGraphic(e,t){const{graphic:r}=e,i=this.symbolLayers.map(t=>t?.createGraphics3DGraphic(e)??null),s=this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null;return new a.Graphics3DGraphic(r,t||this,i,e.layer,s)}get complexity(){return o.totalSymbolComplexities(this.symbolLayers.map(e=>e?.complexity))}globalPropertyChanged(e,t){const r=this.symbolLayers.length;for(let i=0;i<r;i++){const r=this.symbolLayers[i],s=e=>{const t=e.layers[i];return t instanceof l.Graphics3DObject3DGraphicLayer?t:null};if(null!=r&&!r.globalPropertyChanged(e,t,s))return!1}return!0}applyRendererDiff(e,t){return 1!==this.loadStatus?0:this.symbolLayers.reduce((r,i)=>0!==r&&null!=i?Math.min(r,i.applyRendererDiff(e,t)):r,2)}prepareSymbolPatch(e){if(2===this.loadStatus)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const r=t.symbolLayers.diff;this.symbolLayers.forEach((t,i)=>{if(null==t)return;const s=r[i];if(s){const r={diff:s,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(r),e.symbolStatePatches.push(...r.symbolLayerStatePatches),r.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((e,t)=>{const s=e.layers[i];null!=s&&r.graphics3DGraphicPatches.forEach(e=>e(s,t))})}})}updateGeometry(e,t){return this._updateGeometryOrTransform(e,(e,r)=>e.updateGeometry(r,t))}updateTransform(e,t,r,i){return this._updateGeometryOrTransform(e,(e,s)=>e.updateTransform(s,t,r,i))}_updateGeometryOrTransform(e,t){for(let r=0;r<this.symbolLayers.length;r++){const i=this.symbolLayers[r];if(null==i)continue;const s=e.layers[r];if(!s||!t(i,s))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const r=this.symbolLayers[t];if(null==r)continue;const i=e.layers[t];null!=i&&r.onRemoveGraphic(i)}}getFastUpdateStatus(){let e=!1,t=!1;for(const r of this.symbolLayers)if(null!=r){if(0===r.loadStatus)return 3;r.isFastUpdatesEnabled()?t=!0:e=!0}return t?e?2:1:e?0:4}async queryForSnapping(e,t,i,s){const o=this.symbolLayers.filter(r.isSome).filter(e=>null!=e.queryForSnapping).map(r=>r.queryForSnapping(e,t,i,s)),a=await Promise.all(o);return n.throwIfAborted(s),a.flat()}destroy(){if(!this.destroyed){super.destroy();for(const e of this.symbolLayers)null!=e&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get cachedMemory(){return d.getSymbolMemorySize(this)}}let p=null;const f=new c.Graphics3DSymbolLayerCreationContext;t.Graphics3DSymbol=h,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DGraphic":function(){define(["exports","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/has","../../../../core/memoryEstimations","../../../../core/ObjectPool","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Polygon","../../../../geometry/projection/projectBoundingRect","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","./featureExpressionInfoUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y){"use strict";const _=new n(Array,e=>h.set(e,h.zero),null,10,5),b=p.create();e.Graphics3DGraphic=class{get labelLayers(){return this._labelLayers||t.emptyArray}get extent(){return this._extent}get isElevationSource(){return this.layers.some(e=>e?.isElevationSource)}constructor(e,t,r,i,s){this.graphic=e,this.graphics3DSymbol=t,this.layers=r,this._visibleFlags=255,++t.referenced,this._featureExpressionFeature=s?y.createFeature(s,e,i):null}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic(t=>{t.initialize(e),t.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(16))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(t=>{"draped"===t.type&&(e=!0)}),e}isVisible(e=1,t){const r=t?this._visibleFlags|t|16*t:this._visibleFlags;return 1===e?!(15&~r):!(255&~r)}setVisibilityFlag(e,t,r){const i=this.isVisible(e);r?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);const s=this.isVisible(e);if(i===s)return!1;if(16===e)this._forEachLabelGraphic(e=>e.setVisibility(s));else{this._forEachSymbolLayerGraphic(e=>e.setVisibility(s));const e=this.isVisible(16);this._forEachLabelGraphic(t=>t.setVisibility(e))}return!0}getVisibilityFlag(e,t){return 0!==(this._visibleFlags&e*t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(null==t)return!1;this._extent=p.create(),m.computeAABR(t,this._extent);const r=t.spatialReference;if(!f.equals(r,e)&&!d.projectBoundingRect(this._extent,r,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,r){let i=e.geometry;return"mesh"!==i.type&&"extent"!==i.type||(i=u.fromExtent("mesh"===i.type?i.extent:i)),g.convertFromGeometry(i,t,r)}get usedMemory(){let e=s.estimateAttributesMemory(this.graphic.attributes);return this._forEachSymbolLayerGraphic(t=>e+=t.usedMemory),e}computeAttachmentOrigin(){const e={render:{origin:c.create(),num:0},draped:{origin:a.create(),num:0}};for(const t of this.layers)null!=t&&t.computeAttachmentOrigin(e);return e.render.num>1&&l.scale(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&o.scale(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,s,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?h.empty(n.boundingBox):n.boundingBox=h.empty(),n.requiresDrapedElevation=!1,await r.forEach(this.layers,async r=>{if(null==r)return;const o="draped"===r.type?t:e,a=_.acquire(),l=await r.getProjectedBoundingBox(o,i,n.screenSpaceObjects,s,a);isFinite(l[2])&&isFinite(l[5])||(n.requiresDrapedElevation=!0),l&&h.expandWithAABB(n.boundingBox,a),_.release(a)}),h.allFinite(n.boundingBox)||p.allFinite(h.toRect(n.boundingBox,b))?n:null}needsElevationUpdates(){for(const e of this.layers)if(null!=e&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;return this._labelLayers?.some(e=>e?.needsElevationUpdates??!1)??!1}alignWithElevation(e,t,r){this._forEachRenderedGraphic(i=>{"object3d"!==i.type&&"lod-instance"!==i.type||i.alignWithElevation(e,t,this._featureExpressionFeature,r)})}alignWithAbsoluteElevation(e,t,r){this._forEachRenderedGraphic(i=>{"object3d"===i.type&&i.alignWithAbsoluteElevation(e,t,r)})}addObjectStateSet(e){this._forEachSymbolLayerGraphic(t=>t.addObjectState(e))}removeObjectState(e){this._forEachSymbolLayerGraphic(t=>t.removeObjectState(e))}updateHighlights(e){this._forEachSymbolLayerGraphic(t=>t.updateHighlights(e))}_forEachGraphicList(e,t){e?.forEach(e=>e&&t(e))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this.labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/dehydratedFeatures":function(){define(["exports","../../core/has","../../core/memoryEstimations","../../core/uid","../../geometry/SpatialReference","../../geometry/support/aaBoundingBox","../../geometry/support/aaBoundingRect","../../geometry/support/quantizationUtils","../../geometry/support/typeUtils","../support/Field","../../views/2d/layers/graphics/densificationConstants","./dehydratedFeatureComparison"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(e,t,r){if(null==e)return null;switch(t){case"point":{const t=e;return{x:t.x,y:t.y,z:t.z,m:t.m,hasZ:null!=t.z,hasM:null!=t.m,type:"point",spatialReference:r}}case"polyline":{const t=e;return{paths:t.paths,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"polyline",spatialReference:r}}case"polygon":{const t=e;return{rings:t.rings,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"polygon",spatialReference:r}}case"multipoint":{const t=e;return{points:t.points,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"multipoint",spatialReference:r}}}}function p(e){if(null==e)return 0;switch(e.type){case"point":return r.baseObjectMemory+10+8+24;case"polyline":case"polygon":{let t=0;const i=2+(e.hasZ?1:0)+(e.hasM?1:0),s="polyline"===e.type?e.paths:e.rings,n="polyline"===e.type?e.curvePaths:e.curveRings;if(n?.length){const e=3*u.getApproximateMaxDensificationSegments()*128;t=8*e*i+128*e+32*(s.length+1)}else t=r.estimateNestedObjectMemory(s);return r.baseObjectMemory+64+t+34}case"multipoint":{const t=r.estimateNestedObjectMemory(e.points);return r.baseObjectMemory+t+64+34+32}case"extent":return r.baseObjectMemory+10+64+34;case"mesh":{const t=e.vertexAttributes;return r.baseObjectMemory+r.estimateNumberArrayMemory(t.position,t.normal,t.uv,t.tangent)}default:return r.baseObjectMemory}}function f(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null}function m(e,t,r,i){if(t?.size&&null!=r&&e)for(const s in e){if(!t.has(s))continue;const n=e[s];"string"==typeof n&&n.length>r&&(i(s),e[s]="")}}e.equals=d.equals,e.DehydratedFeatureClass=class{constructor(e,t,r){this.uid=e,this.geometry=t,this.attributes=r,this.visible=!0,this.objectId=null,this.centroid=null}},e.DehydratedFeatureSetClass=class{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}},e.computeAABB=function(e,t){switch(n.empty(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(let r=0;r<e.paths.length;r++)n.expandWithNestedArray(t,e.paths[r],!!e.hasZ);break;case"polygon":for(let r=0;r<e.rings.length;r++)n.expandWithNestedArray(t,e.rings[r],!!e.hasZ);break;case"multipoint":n.expandWithNestedArray(t,e.points,!!e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax)}return t},e.computeAABR=function(e,t){switch(o.empty(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(let r=0;r<e.paths.length;r++)o.expandWithNestedArray(t,e.paths[r]);break;case"polygon":for(let r=0;r<e.rings.length;r++)o.expandWithNestedArray(t,e.rings[r]);break;case"multipoint":o.expandWithNestedArray(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}},e.estimateGeometryMemory=p,e.estimateSize=function(e){let t=32;return t+=r.estimateAttributesMemory(e.attributes),t+=3,t+=8+p(e.geometry),t},e.fromFeatureSetJSON=function(e,t){const r=l.featureGeometryTypeKebabDictionary.fromJSON(e.geometryType),n=s.fromJSON(e.spatialReference),o=e.transform,u=e.objectIdFieldName,d=t?.maxStringAttributeLength,p=t?.maxStringAttributeFields;let g;const y=e.features.map(t=>{const s=function(e,t,r,s){return{uid:i.generateUID(),objectId:s&&e.attributes?e.attributes[s]:null,attributes:e.attributes,geometry:h(e.geometry,t,r),visible:!0}}(t,r,n,e.objectIdFieldName),l=s.geometry;if(m(s.attributes,p,d,e=>{g??=[];const t=f(s,u);null!=t&&g.push({objectId:t,attribute:e})}),null!=l&&o)switch(l.type){case"point":s.geometry=a.unquantizePoint(o,l,l);break;case"multipoint":s.geometry=a.unquantizeMultipoint(o,l,l);break;case"polygon":s.geometry=a.unquantizePolygon(o,l,l);break;case"polyline":s.geometry=a.unquantizePolyline(o,l,l);break;case"extent":case"mesh":s.geometry=l}return s});return{geometryType:r,features:y,spatialReference:n,fields:e.fields?.map(e=>c.fromJSON(e))??[],objectIdFieldName:e.objectIdFieldName,globalIdFieldName:e.globalIdFieldName,geohashFieldName:e.geohashFieldName,geometryProperties:e.geometryProperties,hasZ:e.hasZ,hasM:e.hasM,exceededTransferLimit:e.exceededTransferLimit,transform:null,missingAttributes:g}},e.fromJSONGeometry=h,e.getObjectId=f,e.hasGeometry=function(e){return null!=e.geometry},e.hasVertices=function(e){if(null==e)return!1;switch(e.type){case"extent":case"point":return!0;case"polyline":for(const t of e.paths)if(t.length>0)return!0;return!1;case"polygon":for(const t of e.rings)if(t.length>0)return!0;return!1;case"multipoint":return e.points.length>0;case"mesh":return!e.loaded||e.vertexAttributes.position.length>0}},e.numVertices=function(e){if(null==e)return 0;switch(e.type){case"point":return 1;case"polyline":{let t=0;for(const r of e.paths)t+=r.length;return t}case"polygon":{let t=0;for(const r of e.rings)t+=r.length;return t}case"multipoint":return e.points.length;case"extent":return 2;case"mesh":{const t=e.vertexAttributes&&e.vertexAttributes.position;return t?t.length/3:0}default:return}},e.removeLargeStringAttributes=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/quantizationUtils":function(){define(["exports","./jsonUtils"],function(e,t){"use strict";function r(e){if(function(e){return"lowerLeft"===e.originPosition&&4===e.scale.length&&4===e.translate.length}(e))return e;const{originPosition:t,scale:r,translate:i}=e,s=r[0]??1,n=r[1]??1;return{originPosition:"lowerLeft",scale:[s,"lowerLeft"===t?n:-n,r[2]??1,r[3]??1],translate:[i[0]??0,i[1]??0,i[2]??0,i[3]??0]}}function i({scale:e,translate:t},r){return Math.round((r-t[0])/e[0])}function s({scale:e,translate:t},r){return Math.round((r-t[1])/e[1])}function n({scale:e,translate:t},r){return Math.round(((r??0)-t[2])/e[2])}function o({scale:e,translate:t},r){return r?Math.round((r-t[3])/e[3]):0}function a(e,t){return e&&t?d:e&&!t?c:!e&&t?u:l}const l=(e,t)=>{const r=[];if(!t.length)return null;const n=t[0];let o=i(e,n[0]),a=s(e,n[1]);r.push([o,a]);for(let n=1;n<t.length;n++){const[l,c]=t[n],u=i(e,l),d=s(e,c);u===o&&d===a||r.push([u-o,d-a]),o=u,a=d}return r},c=(e,t)=>{const r=[];if(!t.length)return null;const o=t[0];let a=i(e,o[0]),l=s(e,o[1]),c=n(e,o[2]);r.push([a,l,c]);for(let o=1;o<t.length;o++){const[u,d,h]=t[o],p=i(e,u),f=s(e,d),m=n(e,h);p===a&&f===l&&m===c||r.push([p-a,f-l,m]),a=p,l=f,c=m}return r},u=(e,t)=>{const r=[];if(!t.length)return null;const n=t[0];let a=i(e,n[0]),l=s(e,n[1]),c=o(e,n[2]);r.push([a,l,c]);for(let n=1;n<t.length;n++){const[u,d,h]=t[n],p=i(e,u),f=s(e,d),m=o(e,h);p===a&&f===l&&m===c||r.push([p-a,f-l,m]),a=p,l=f,c=m}return r},d=(e,t)=>{const r=[];if(!t.length)return null;const a=t[0];let l=i(e,a[0]),c=s(e,a[1]),u=n(e,a[2]),d=o(e,a[3]);r.push([l,c,u,d]);for(let a=1;a<t.length;a++){const[h,p,f,m]=t[a],g=i(e,h),y=s(e,p),_=n(e,f),b=o(e,m);g===l&&y===c&&_===u&&b===d||r.push([g-l,y-c,_,b]),l=g,c=y,u=_,d=b}return r};function h({scale:e,translate:t},r){return r*e[0]+t[0]}function p({scale:e,translate:t},r){return r*e[1]+t[1]}function f({scale:e,translate:t},r){return(r??0)*e[2]+t[2]}function m({scale:e,translate:t},r){return r?r*e[3]+t[3]:0}function g(e,t){return e&&t?v:e&&!t?_:!e&&t?b:y}const y=(e,t)=>{const r=new Array(t.length);if(!t.length)return r;const i=t[0];let s=h(e,i[0]),n=p(e,i[1]);r[0]=[s,n];const{scale:o,originPosition:a}=e,l=o[0],c="lowerLeft"===a?o[1]:-o[1];for(let e=1;e<t.length;e++){const[i,o]=t[e];s+=l*i,n+=c*o,r[e]=[s,n]}return r},_=(e,t)=>{const r=new Array(t.length);if(!t.length)return r;const i=t[0];let s=h(e,i[0]),n=p(e,i[1]);r[0]=[s,n,f(e,i[2])];const{scale:o,originPosition:a}=e,l=o[0],c="lowerLeft"===a?o[1]:-o[1];for(let i=1;i<t.length;i++){const[o,a,u]=t[i];s+=l*o,n+=c*a,r[i]=[s,n,f(e,u)]}return r},b=(e,t)=>{const r=new Array(t.length);if(!t.length)return r;const i=t[0];let s=h(e,i[0]),n=p(e,i[1]);r[0]=[s,n,m(e,i[2])];const{scale:o,originPosition:a}=e,l=o[0],c="lowerLeft"===a?o[1]:-o[1];for(let i=1;i<t.length;i++){const[o,a,u]=t[i];s+=l*o,n+=c*a,r[i]=[s,n,m(e,u)]}return r},v=(e,t)=>{const r=new Array(t.length);if(!t.length)return r;const i=t[0];let s=h(e,i[0]),n=p(e,i[1]);r[0]=[s,n,f(e,i[2]),m(e,i[3])];const{scale:o,originPosition:a}=e,l=o[0],c="lowerLeft"===a?o[1]:-o[1];for(let i=1;i<t.length;i++){const[o,a,u,d]=t[i];s+=l*o,n+=c*a,r[i]=[s,n,f(e,u),m(e,d)]}return r};function w(e,t,r){const i=new Array(r.length);for(let s=0;s<r.length;s++)i[s]=t(e,r[s]);return i}function x(e,t,r){let[i,s]=r[0],n=Math.min(i,t[0]),o=Math.min(s,t[1]),a=Math.max(i,t[2]),l=Math.max(s,t[3]);for(let e=1;e<r.length;e++){const[t,c]=r[e];i+=t,s+=c,t<0&&(n=Math.min(n,i)),t>0&&(a=Math.max(a,i)),c<0?o=Math.min(o,s):c>0&&(l=Math.max(l,s))}return e[0]=n,e[1]=o,e[2]=a,e[3]=l,e}function S(e,t){if(!t.length)return null;e[0]=e[1]=Number.POSITIVE_INFINITY,e[2]=e[3]=Number.NEGATIVE_INFINITY;for(let r=0;r<t.length;r++)x(e,e,t[r]);return e}function T(e,t,a){const l=r(e);return t.xmin=i(l,a.xmin),t.ymin=s(l,a.ymin),t.xmax=i(l,a.xmax),t.ymax=s(l,a.ymax),a.hasZ&&(t.zmin=n(l,a.zmin),t.zmax=n(l,a.zmax)),a.hasM&&(t.mmin=o(l,a.mmin),t.mmax=o(l,a.mmax)),t.hasZ=a.hasZ??!1,t.hasM=a.hasM??!1,t}function C(e,t,i){const s=r(e);return t.points=a(i.hasZ,i.hasM)(s,i.points)??[],t.hasZ=i.hasZ??!1,t.hasM=i.hasM??!1,t}function P(e,t,a){const l=r(e);return t.x=i(l,a.x),t.y=s(l,a.y),null!=a.z&&(t.z=n(l,a.z)),null!=a.m&&(t.m=o(l,a.m)),t}function M(e,t,i){const s=function(e,t,r,i){const s=[],n=a(r,i);for(let r=0;r<t.length;r++){const i=n(e,t[r]);i&&i.length>=3&&s.push(i)}return s.length?s:null}(r(e),i.rings,i.hasZ,i.hasM);return s?(t.rings=s,t.hasZ=i.hasZ??!1,t.hasM=i.hasM??!1,t):null}function R(e,t,i){const s=function(e,t,r,i){const s=[],n=a(r,i);for(let r=0;r<t.length;r++){const i=n(e,t[r]);i&&i.length>=2&&s.push(i)}return s.length?s:null}(r(e),i.paths,i.hasZ,i.hasM);return s?(t.paths=s,t.hasZ=i.hasZ??!1,t.hasM=i.hasM??!1,t):null}e.getQuantizedBoundsCoordsArray=x,e.getQuantizedBoundsCoordsArrayArray=S,e.getQuantizedBoundsPaths=function(e){return S([0,0,0,0],e)},e.getQuantizedBoundsPoints=function(e){const t=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];return x(t,t,e)},e.getQuantizedBoundsRings=function(e){return S([0,0,0,0],e)},e.normalizeTransform=r,e.quantizeBounds=function(e,t,n){const o=r(e);return t[0]=i(o,n[0]),t[3]=s(o,n[1]),t[2]=i(o,n[2]),t[1]=s(o,n[3]),t},e.quantizeCoordsArrayXY=l,e.quantizeCoordsArrayXYM=u,e.quantizeCoordsArrayXYZ=c,e.quantizeCoordsArrayXYZM=d,e.quantizeExtent=T,e.quantizeGeometry=function(e,r){return e&&r?t.isPoint(r)?P(e,{},r):t.isPolyline(r)?R(e,{},r):t.isPolygon(r)?M(e,{},r):t.isMultipoint(r)?C(e,{},r):t.isExtent(r)?T(e,{},r):null:null},e.quantizeM=o,e.quantizeMultipoint=C,e.quantizePoint=P,e.quantizePolygon=M,e.quantizePolyline=R,e.quantizeX=i,e.quantizeY=s,e.quantizeZ=n,e.toQuantizationTransform=function(e){return e?{originPosition:"upper-left"===e.originPosition?"upperLeft":"lower-left"===e.originPosition?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance,1,1]:[1,1,1,1],translate:null!=e.extent?[e.extent.xmin,e.extent.ymax,e.extent.zmin??0,e.extent.mmin??0]:[0,0,0,0]}:null},e.unquantizeBounds=function(e,t,i){const s=r(e);return i?(t[0]=h(s,i[0]),t[1]=p(s,i[3]),t[2]=h(s,i[2]),t[3]=p(s,i[1]),t):[h(s,t[0]),p(s,t[3]),h(s,t[2]),p(s,t[1])]},e.unquantizeCoordsArrayArray=w,e.unquantizeCoordsArrayXY=y,e.unquantizeCoordsArrayXYM=b,e.unquantizeCoordsArrayXYZ=_,e.unquantizeCoordsArrayXYZM=v,e.unquantizeExtent=function(e,t,i,s=i.hasZ??!1,n=i.hasM??!1){const o=r(e);return t.xmin=h(o,i.xmin),t.xmax=h(o,i.xmax),t.ymin=p(o,i.ymin),t.ymax=p(o,i.ymax),s&&(t.zmin=f(o,i.zmin),t.zmax=f(o,i.zmax)),n&&(t.mmin=m(o,i.mmin),t.mmax=m(o,i.mmax)),t.hasZ=s,t.hasM=n,t},e.unquantizeM=m,e.unquantizeMultipoint=function(e,t,i,s=i?.hasZ??!1,n=i?.hasM??!1){if(null!=i){const o=r(e);t.points=g(s,n)(o,i.points),t.hasZ=s,t.hasM=n}return t},e.unquantizePoint=function(e,t,i,s=null!=i?.z,n=null!=i?.m){if(null==i)return t;const o=r(e);return t.x=h(o,i.x),t.y=p(o,i.y),s&&(t.z=f(o,i.z)),n&&(t.m=m(o,i.m)),t},e.unquantizePolygon=function(e,t,i,s=i?.hasZ??!1,n=i?.hasM??!1){if(null!=i){const o=r(e);t.rings=w(o,g(s,n),i.rings),t.hasZ=s,t.hasM=n}return t},e.unquantizePolyline=function(e,t,i,s=i?.hasZ??!1,n=i?.hasM??!1){if(null!=i){const o=r(e);t.paths=w(o,g(s,n),i.paths),t.hasZ=s,t.hasM=n}return t},e.unquantizeX=h,e.unquantizeY=p,e.unquantizeZ=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/layers/graphics/densificationConstants":function(){define(["exports","../../../../core/has"],function(e,t){"use strict";e.getApproximateMaxDensificationSegments=function(){return t("curve-densification-max-segments")},e.getCoarseSegmentsPerCurve=function(){return t("curve-densification-coarse-segments")},e.getMaxDeviationInPixels=function(){return t("curve-densification-pixel-deviation")},e.getMinSegmentsPerCurve=function(){return t("curve-densification-min-segments")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/dehydratedFeatureComparison":function(){define(["exports","../../core/has","../../core/mathUtils","../../geometry/support/spatialReferenceUtils"],function(e,t,r,i){"use strict";function s(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++){const i=e[r],s=t[r];if(i.length!==s.length)return!1;for(let e=0;e<i.length;e++)if(i[e]!==s[e])return!1}return!0}function n(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!s(e[r],t[r]))return!1;return!0}function o(e,t){return e===t||null!=e&&null!=t&&i.equals(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}e.equals=function(e,t){return e===t||null!=e&&null!=t&&e.objectId===t.objectId&&!!function(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.type!==t.type)return!1;switch(e.type){case"point":return o(e,t);case"extent":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!i.equals(e.spatialReference,t.spatialReference)&&e.xmin===t.xmin&&e.ymin===t.ymin&&e.zmin===t.zmin&&e.xmax===t.xmax&&e.ymax===t.ymax&&e.zmax===t.zmax}(e,t);case"polyline":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!i.equals(e.spatialReference,t.spatialReference)&&n(e.paths,t.paths)}(e,t);case"polygon":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!i.equals(e.spatialReference,t.spatialReference)&&n(e.rings,t.rings)}(e,t);case"multipoint":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!i.equals(e.spatialReference,t.spatialReference)&&s(e.points,t.points)}(e,t);case"mesh":return!1;default:return}}(e.geometry,t.geometry)&&!!function(e,t){if(e===t)return!0;if(!e||!t)return!1;const r=Object.keys(e),i=Object.keys(t);if(r.length!==i.length)return!1;for(const i of r)if(e[i]!==t[i])return!1;return!0}(e.attributes,t.attributes)},e.pointEquals=o,e.pointNear=function(e,t,s){return e===t||null!=e&&null!=t&&i.equals(e.spatialReference,t.spatialReference)&&r.floatEqualAbsolute(e.x,t.x,s)&&r.floatEqualAbsolute(e.y,t.y,s)&&r.floatEqualAbsolute(e.z??0,t.z??0,s)&&r.floatEqualAbsolute(e.m??0,t.m??0,s)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DSymbolCreationContext":function(){define(["exports"],function(e){"use strict";e.Graphics3DSymbolCreationContext=class{constructor(e,t,r,i){this.scheduler=e,this.schedule=t,this.layerViewUid=r,this.compressionTracker=i,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return 1===this.stage.view.state.viewingMode}},e.Graphics3DSymbolLayerCreationContext=class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/symbolMemory":function(){define(["exports"],function(e){"use strict";e.getSymbolMemorySize=function(e){return 2216+4096*e.symbolLayers.length+e.complexity.memory.resourceBytes},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DWebStyleSymbol":function(){define(["exports","./defaultSymbolComplexity","./Loadable","./symbolMemory"],function(e,t,r,i){"use strict";class s extends r.Loadable{constructor(e,t,r){super(t),this.symbol=e,this._convert=r,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),null!=this.graphics3DSymbol&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.complexity:t.emptySymbolComplexity}globalPropertyChanged(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return null!=this.graphics3DSymbol?this.graphics3DSymbol.applyRendererDiff(e,t):0}prepareSymbolPatch(e){null!=this.graphics3DSymbol&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.updateGeometry(e,t)}updateTransform(e,t,r,i){return this.graphics3DSymbol?.updateTransform(e,t,r,i)??!1}onRemoveGraphic(){}updateFocus(){}getFastUpdateStatus(){return this.graphics3DSymbol?.getFastUpdateStatus()??3}destroy(){null!=this.graphics3DSymbol&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}get cachedMemory(){return i.getSymbolMemorySize(this)}}e.Graphics3DWebStyleSymbol=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/LabelInfo":function(){define(["exports","../../../../core/has","../../../../core/Logger","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","./constants","./graphicSymbolUtils","./LabelParameters","../../webgl-engine/lib/TextRenderer","../../webgl-engine/materials/HUDMaterial"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=()=>r.getLogger("esri.views.3d.layers.graphics.labelPlacement");function h(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function p(e,t,r){const n=null!=r?r.getBoundingBoxObjectSpace(y):y,o=s.fromValues(n[3]-n[0],n[4]-n[1],n[5]-n[2]),a=Math.sqrt(o[0]*o[0]+o[1]*o[1]);e.centerOffset[0]=a/2*t.normalizedOffset[0];const l=e.translation[2],c=o[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=l+c;const u=i.length(o);e.centerOffset[2]=u/2*t.normalizedOffset[2]}const f={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},m={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in m){const t=m[e],r=f[e];t.forEach(e=>{f[e]=r})}Object.freeze&&(Object.freeze(f),Object.keys(f).forEach(e=>{Object.freeze(f[e]),Object.freeze(f[e]?.normalizedOffset)}));const g=[0,0],y=n.create();e.LabelInfo=class{constructor(e,t,r,i=null){this._graphic=e,this._symbol=t,this._class=r,this._disablePlacement=i}get placement(){const e=this._verticalOffsetPlacement;if(null==e)return null;const t=this._getPlacementInfo(e);if(null==t)return null;const r=t.anchor,i=!!e.hasLabelVerticalOffset,s=e.verticalOffset,n=new l.LabelPlacement(s,r,i);return this._calculatePlacementOffsets(n,t)}get _verticalOffsetPlacement(){const e=this._class.labelPlacement,{_symbol:t,_graphic:r}=this,i=a.getGraphics3DSymbol(r.graphics3DSymbol),s="point-3d"===i?.symbol.type?i.symbol:null,n=f[e]||this._defaultPlacementInfo;return s?.supportsCallout()&&s.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:s.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!t?.hasVisibleVerticalOffset()||null!=s&&s.supportsCallout()&&s.verticalOffset&&!r.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:n&&"above-center"===n.placement?{placement:"above-center",verticalOffset:t.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(d().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}_getPlacementInfo(e){if(e.anchor)return e;const t=this._class.labelPlacement,r=f[t],i=r||this._defaultPlacementInfo;return t&&!r&&d().warnOnce(`the requested label placement '${t}' is currently unsupported in SceneView.`),this._validatePlacementInfo(i)}_calculatePlacementOffsets(e,t){const r=this._graphic.graphic.geometry;if(null==r)return null;switch(r.type){case"point":this._setPointSpecificPlacement(e,t);break;case"mesh":this._setMeshSpecificPlacement(e,t);break;case"polygon":this._setPolygonSpecificPlacement(e,t)}const i=o.labelMarginPx-c.textVerticalPaddingPx;return e.screenOffset[0]+=i*t.normalizedOffset[0],e.screenOffset[1]+=i*t.normalizedOffset[1],e}get _defaultPlacementInfo(){const e=this._graphic.graphic.geometry;if(null==e)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:s.ZEROS,anchor:"center"};case"polygon":{const e=this._firstSymbolLayer;return"extrude"===e?.type?f["above-center"]:{placement:"center-center",normalizedOffset:s.ZEROS,anchor:"center"}}case"point":case"mesh":return f["above-center"];default:return}}_validatePlacementInfo(e){const t=this._graphic.graphic.geometry;if(null==t)return null;if(null!=this._disablePlacement){const t=this._class.labelPlacement;return t?(d().warnOncePerTick(h(t,this._disablePlacement.logEntityDescription)),this._defaultPlacementInfo):e}const r=t.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":{const e=this._class.labelPlacement;if(e)return f[e]&&d().warnOnce(h(e,`'${r}' geometries`)),this._defaultPlacementInfo;break}case"point":case"mesh":return e}return e}_setPointSpecificPlacement(e,t){const r=this._firstSymbolLayer;if(null==r)return;const s=this._graphic.layers[0];switch(null!=s?s.getCenterObjectSpace(e.translation):i.set(e.translation,0,0,0),r.type){case"icon":case"text":this._setHUDSpecificPlacement(e,t,s);break;case"object":p(e,t,s)}}_setMeshSpecificPlacement(e,t){const r=this._firstSymbolLayer;null!=r&&"fill"===r.type&&p(e,t,this._graphic.layers[0])}_setPolygonSpecificPlacement(e,t){const r=this._firstSymbolLayer;if(null!=r)switch(r.type){case"extrude":{const r=this._graphic.layers[0];null!=r?(r.getBoundingBoxObjectSpace(y),n.center(y,e.translation),e.translation[2]=n.height(y)/2):i.set(e.translation,0,0,0),p(e,t,r);break}}}_setHUDSpecificPlacement(e,t,r){const{_graphic:i}=this,s=null!=r?r.getScreenSize():null;if(i.isDraped||null==s)e.hasLabelVerticalOffset||"center"===e.anchor||(f[this._class.labelPlacement]&&d().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const r=this._normalizedSymbolAnchorPos;e.screenOffset[0]=s[0]/2*(t.normalizedOffset[0]-r[0]);const i=s[1]/2*(t.normalizedOffset[1]-r[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=i,e.centerOffsetUnits="screen"):e.screenOffset[1]=i}}get _firstSymbolLayer(){const e=this._graphic.graphics3DSymbol,t=a.getGraphics3DSymbol(e);return null!=t?t.symbol.symbolLayers.at(0):null}get _normalizedSymbolAnchorPos(){const e=this._graphic.layers[0],t=e?.stageObject.geometries[0].material??null;if(t&&t instanceof u.HUDMaterial){const e=t.parameters.anchorPosition;g[0]=2*(e[0]-.5),g[1]=2*(e[1]-.5)}else g[0]=0,g[1]=0;return g}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/constants":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec4f64"],function(e,t){"use strict";const r=t.ZEROS;e.labelMarginPx=4,e.suspendResumeExtentOptimism=1.2,e.transparentUnit=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/LabelParameters":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64"],function(e,t,r,i){"use strict";e.LabelParameters=class{constructor(e,r="center",i="center",s=null,n=t.create(),o=!0){this.placement=e,this.horizontalPlacement=r,this.verticalPlacement=i,this.text=s,this.displaySize=n,this.isFocused=o}},e.LabelPlacement=class{constructor(e,s="center",n=!1,o=t.create(),a=i.fromValues(0,0,0,-1),l="world",c=r.create(),u=0){this.verticalOffset=e,this.anchor=s,this.hasLabelVerticalOffset=n,this.screenOffset=o,this.centerOffset=a,this.centerOffsetUnits=l,this.translation=c,this.elevationOffset=u}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextRenderer":function(){define(["exports","../../../../core/mathUtils","../../support/debugFlags","./FontMetrics","./TextHelperCanvas"],function(e,t,r,i,s){"use strict";const n=[];{const e=16;for(let t=0;t<360;t+=360/e)n.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}const o={canvas:null},a=512,l="rgb(255, 0, 255, 0.5)";class c{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(e,t,r,i,s){this.firstLineAscent=e,this.lastLineDescent=t,this.maxLineAscent=r,this.maxLineDescent=i,this.displayWidth=s}}e.TextRenderer=class{constructor(e,t,r,i){this.text=e,this._alignment=t,this._parameters=r,this._maxSize=i,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${e}--${this._parameters.key}-${this._alignment}`,this._lines=e.replaceAll(" "," ").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let e=this._metrics.firstLineAscent;for(let t=0;t<this._lines.length-1;t++)e+=this._lineSpacing;return e+=this._metrics.lastLineDescent,Math.ceil(e+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const e=s.getTextHelperCanvas(o,a,a).getContext("2d"),t=this._parameters.definition.pixelRatio,r=this._fontSize*t;this._parameters.setFontProperties(e,r);let n=2*this._haloSize;const l=this._parameters.definition.font;"italic"!==l.style&&"oblique"!==l.style&&"bold"!==l.weight&&"bolder"!==l.weight||(n+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let u=0,d=0,h=0,p=0,f=0;this._lines.forEach((r,i)=>{const s=e.measureText(r),o=s.width/t,a=o+n;this._textWidths.push(o),this._lineWidths.push(a),u=Math.max(u,a),p=Math.max(p,s.actualBoundingBoxAscent/t),f=Math.max(f,s.actualBoundingBoxDescent/t),0===i&&(d=s.actualBoundingBoxAscent/t),i===this._lines.length-1&&(h=s.actualBoundingBoxDescent/t)});const m=i.getFontMetrics(this._parameters),g=Math.max(p,m.maxAscent),y=Math.max(f,m.maxDescent),_=d,b="underline"===this._parameters.definition.font.decoration?y:h,v=u;this._metricsCached=new c(_,b,g,y,v)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return.2*this._midLineHeight}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,1)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(null==this._renderPixelRatio){const e=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(e,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case 0:return this._horizontalPadding;case 1:return(this.displayWidth-this._lineWidths[e])/2;case 2:return this.displayWidth-this._horizontalPadding-this._lineWidths[e]}}render(e,t,i){e.save();const s=t/=this.renderPixelRatio,n=i/=this.renderPixelRatio,o=this._haloSize,a=this._firstLineYOffset+this._metrics.firstLineAscent;t+=o,i+=a;const c=this._haloSize>0;c&&this._renderHalo(e,s,n,o,a),this._parameters.setFontProperties(e,this._renderedFontSize);for(let r=0;r<this._lines.length;++r){const s=this._lines[r],n=this._getLineXOffset(r);c&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,s,t+n,i),this._renderLineDecoration(e,t+n,i,this._textWidths[r])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,s,t+this._getLineXOffset(r),i),this._renderLineDecoration(e,t+n,i,this._textWidths[r]),i+=this._lineSpacing}if(r.debugFlags.TEXT_SHOW_BASELINE){e.strokeStyle=l,e.setLineDash([2,2]),e.lineWidth=1;let t=n+a;for(let r=0;r<this._lines.length;++r)this._drawLine(e,[s,t],[s+this.displayWidth,t]),t+=this._lineSpacing}if(r.debugFlags.TEXT_SHOW_BORDER&&(e.strokeStyle=l,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[s,n],[this.displayWidth,this.displayHeight])),this._hasBackground){const t=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,s,n,t),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,t,r,i,s=!1){if("none"===this._parameters.definition.font.decoration||0===i)return;const n=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":r+=2*n;break;case"line-through":r-=.33*this._midLineAscent}const o=s?this._haloSize:0;e.strokeStyle=s?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(n+2*o),e.beginPath(),e.moveTo(this._toRenderUnit(t-o),this._toRenderUnit(r)),e.lineTo(this._toRenderUnit(t+i+o),this._toRenderUnit(r)),e.stroke()}_roundedRect(e,r,i,s){r=this._toRenderUnit(r),i=this._toRenderUnit(i);const n=this.renderedWidth,o=this.renderedHeight;0!==s?(s=t.clamp(s,0,Math.floor(o/2)),e.beginPath(),e.moveTo(r,i+s),e.arcTo(r,i,r+s,i,s),e.lineTo(r+n-s,i),e.arcTo(r+n,i,r+n,i+s,s),e.lineTo(r+n,i+o-s),e.arcTo(r+n,i+o,r+n-s,i+o,s),e.lineTo(r+s,i+o),e.arcTo(r,i+o,r,i+o-s,s),e.closePath()):e.rect(r,i,n,o)}_renderHalo(e,t,r,i,n){const l=this.renderedWidth,c=this.renderedHeight,u=s.getTextHelperCanvas(o,Math.max(l,a),Math.max(c,a)),d=u.getContext("2d");d.clearRect(0,0,l,c),this._parameters.setFontProperties(d,this._renderedFontSize),d.fillStyle=this._parameters.haloStyle,d.strokeStyle=this._parameters.haloStyle;const h=this._renderedHaloSize<3;d.lineJoin=h?"miter":"round",h?this._renderHaloEmulated(d,i,n):this._renderHaloNative(d,i,n);let p=n;for(let e=0;e<this._lines.length;++e){const t=this._getLineXOffset(e);this._renderLineDecoration(d,i+t,p,this._textWidths[e],!0),p+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(u,0,0,l,c,this._toRenderUnit(t),this._toRenderUnit(r),l,c),e.globalAlpha=1}_renderHaloEmulated(e,t,r){for(let i=0;i<this._lines.length;++i){const s=this._lines[i],o=this._getLineXOffset(i);for(const[i,a]of n)this._fillText(e,s,t+o+this._haloSize*i,r+this._haloSize*a);r+=this._lineSpacing}}_renderHaloNative(e,t,r){const i=2*this._haloSize;for(let s=0;s<this._lines.length;++s){const n=this._lines[s],o=this._getLineXOffset(s),a=5,l=.1;for(let s=0;s<a;s++){const c=1-(a-1)*l+s*l;e.lineWidth=this._toRenderUnit(c*i),this._strokeText(e,n,t+o,r)}r+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,t,r,i){e.fillText(t,this._toRenderUnit(r),this._toRenderUnit(i))}_strokeText(e,t,r,i){e.strokeText(t,this._toRenderUnit(r),this._toRenderUnit(i))}_drawLine(e,t,r){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(t[0])+.5,this._toRoundedRenderUnit(t[1])+.5),e.lineTo(this._toRoundedRenderUnit(r[0])+.5,this._toRoundedRenderUnit(r[1])+.5),e.stroke()}_drawBox(e,t,r){const i=this._toRenderUnit(t[0]),s=this._toRenderUnit(t[1]),n=this._toRenderUnit(r[0]),o=this._toRenderUnit(r[1]),a=Math.floor(i)+.5,l=Math.ceil(i+n)-.5,c=Math.floor(s)+.5,u=Math.ceil(s+o)-.5;e.beginPath(),e.moveTo(a,c),e.lineTo(l,c),e.lineTo(l,u),e.lineTo(a,u),e.lineTo(a,c),e.stroke()}},e.textVerticalPaddingPx=1,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/FontMetrics":function(){define(["exports","./TextHelperCanvas"],function(e,t){"use strict";const r=new Map;class i{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(e,t){this.maxAscent=e,this.maxDescent=t}}const s={canvas:null},n=(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})();e.getFontMetrics=function(e){const{size:o}=e.definition,a=e.fontString(o);let l=r.get(a);if(!l){const c=t.getTextHelperCanvas(s,0,0).getContext("2d");e.setFontProperties(c,o);const u=c.measureText(n);l=new i(u.actualBoundingBoxAscent,u.actualBoundingBoxDescent),r.set(a,l)}return l},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextHelperCanvas":function(){define(["exports"],function(e){"use strict";e.getTextHelperCanvas=function(e,t,r){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=r,e.canvas},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/placementUtils":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../webgl-engine/lib/TextRenderer"],function(e,t,r,i){"use strict";const s=Object.freeze({left:0,center:.5,right:1}),n=Object.freeze({"bottom-left":r.fromValues(0,0),bottom:r.fromValues(.5,0),"bottom-right":r.fromValues(1,0),left:r.fromValues(0,.5),center:r.fromValues(.5,.5),right:r.fromValues(1,.5),"top-left":r.fromValues(0,1),top:r.fromValues(.5,1),"top-right":r.fromValues(1,1)});e.anchorFromPlacements=function(e,t){switch(t){case"bottom":return"left"===e?"bottom-left":"right"===e?"bottom-right":"bottom";case"center":return e;case"top":return"left"===e?"top-left":"right"===e?"top-right":"top"}},e.horizontalPlacementFromAnchor=function(e){switch(e){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}},e.horizontalPlacementToAnchorX=s,e.namedAnchorToHUDMaterialAnchorPos=n,e.textRenderAlignmentFromHorizontalPlacement=function(e){switch(e){case"left":return 0;case"right":return 2;default:return 1}},e.verticalPlacementFromAlignment=function(e){return"middle"===e?"center":e},e.verticalPlacementFromAnchor=function(e){switch(e){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}},e.verticalScreenOffsetFromAlignment=function(e,s){switch(e){case"top":return t.set(s,0,i.textVerticalPaddingPx);case"bottom":return t.set(s,0,-i.textVerticalPaddingPx);default:return t.copy(s,r.ZEROS)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextRenderParameters":function(){define(["exports","../../../../Color","../../../../core/fontUtils","../../../../core/Logger","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec4f64"],function(e,t,r,i,s,n){"use strict";class o{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=a(e.color),this.haloStyle=`rgb(${e.halo.color.slice(0,3).map(e=>Math.floor(255*e)).toString()})`,this.backgroundStyle=0!==e.background.color[3]?a(e.background.color):null}fontString(e){const t=this.definition.font;return`${t.style} ${t.weight} ${e}px ${t.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(e,t){e.font=this.fontString(t),e.textAlign="left",e.textBaseline="alphabetic"}static async fromSymbol(e,a){const c=e?.material?.color,u=t.toUnitRGBA(c)??n.ZEROS,d=null!=e.size?s.pt2px(e.size):12,h=e.lineHeight,p=null!=e.background?t.toUnitRGBA(e.background.color):n.ZEROS,f={family:e.font?.family??"sans-serif",decoration:e.font?.decoration??"none",weight:e.font?.weight??"normal",style:e.font?.style??"normal"},m=e.halo,g=null!=m?.color&&m.size>0?{size:s.pt2px(m.size),color:t.toUnitRGBA(m.color)}:{size:0,color:n.ZEROS},y=new o({color:u,size:d,background:{color:p,padding:null!=e.background?[.65*d,.5*d]:[0,0],borderRadius:null!=e.background?d*(6/16):0},lineSpacingFactor:h,font:f,halo:g,pixelRatio:a});if(e.font){let t=!1;const s=y.fontString(d);try{t=(await document.fonts.load(s)).some(e=>!r.isCachedFontFace(e))}catch(e){i.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${s}'. Some text symbology may be rendered using the default browser font.`)}if(!t&&!l.has(e.font.family))try{await r.loadFont(e.font)}catch(e){}}return y}}function a(e){return`rgba(${e.slice(0,3).map(e=>Math.floor(255*e)).toString()},${e[3]})`}const l=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]);e.TextRenderParameters=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/fontUtils":function(){define(["exports","../config"],function(e,t){"use strict";const r="arial-unicode-ms",i="woff2",s=new Map,n=new Set;class o{constructor(e,t){this.fontFace=e,this.promise=t}}function a(e){if(!e)return r;const t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}function l(e){const t=c(e)+u(e);return a(e.family)+(t.length>0?t:"-regular")}function c(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function u(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}e.clearFonts=function(){const e=document.fonts;s.forEach(t=>{e.delete(t.fontFace)}),s.clear(),n.clear()},e.defaultFontFamily=r,e.getFontFamily=a,e.getFullyQualifiedFontName=l,e.isCachedFontFace=function(e){return n.has(e)},e.loadFont=async function(e){const a=function(e){const t=c(e)+u(e);return(e.family||r)+(t.length>0?t:"-regular")}(e),d=l(e),h=s.get(a);if(h)return h.promise;const p=new FontFace(e.family,`url('${t.fontsUrl}/woff2/${d}.${i}') format('${i}')`,{style:e.style,weight:e.weight}),f=document.fonts;if(f.has(p)&&"loading"===p.status)return p.loaded;const m=p.load().then(()=>(f.add(p),p));return s.set(a,new o(p,m)),n.add(p),m},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextTextureAtlas":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/has","../../../../core/maybe","../../../../core/uid","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","./testUtils","./textureUtils","../../../support/Scheduler","../../../support/Yield","../../../webgl/Texture","../../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";const b=4096;e.TextTextureAtlas=class extends r{constructor(e){super(e),this.id=o.generateUID(),this.events=new i.EventEmitter,this._glTexture=null,this._atlas=new S(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view.stage,this._stage.addTexture(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=n.disposeMaybe(this._glTexture),this._frameWorker=n.removeMaybe(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get loaded(){return null!=this._glTexture}get glTexture(){return this._glTexture}static get maxSize(){return C=p.textTextureAtlas.stableRendering?v:0,[b-v-C,b-v-C-w]}load(e){if(this._glTexture)return this._glTexture;const t=new _.TextureDescriptor;return t.wrapMode=33071,t.samplingMode=9987,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._glTexture=new y.Texture(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(m.TaskPriority.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=n.removeMaybe(this._frameWorker),this._glTexture&&(this._stage.removeTexture(this),this._glTexture=n.disposeMaybe(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.width=e.width,this._canvas.height=e.height}_resizeAtlas(e,t){const{width:r,height:i}=this._atlas;r===e&&i===t||(this._atlas.width=e,this._atlas.height=t,this._glTexture?.resize(e,t),this._glTexture?.updateData(0,0,0,r,i,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(e=>this._uvCallbacks.get(e.textRenderer.key)?.forEach(t=>t(e.uv))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,r,i){const s=this._atlas;if(s.width<r||s.height<i)return!1;let n=s.cursors.get(i);if(!n){if(s.height<s.nextY+i)return!1;n=[new T(s.nextY)],s.cursors.set(i,n),s.nextY+=i}let o=n.find(e=>s.width>=e.x+r);if(null==o){if(s.height<s.nextY+i)return!1;o=new T(s.nextY),s.nextY+=i,n.push(o)}return e.setNewPosition(o),this._elements.set(t,e),this._elementsToRender.set(t,e),o.x+=r,!0}_ensureCallbacks(e){const t=this._uvCallbacks.get(e);if(t)return t;const r=new Set;return this._uvCallbacks.set(e,r),r}_addCallback(e,t){this._ensureCallbacks(e).add(t)}_removeCallback(e,t){const r=this._uvCallbacks.get(e);return!(!r?.delete(t)||0!==r.size||(this._uvCallbacks.delete(e),0))}_processAddition(e){const t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);const r=this._atlas,i=e.textRenderer.renderedWidth,s=e.textRenderer.renderedHeight,n=i+v,o=s+v+w;if(!this._addAtlasElement(e,t,n,o)){if(this._canRepack)this._reset();else if(r.width<n){const e=f.applyTextureResizeModuloCeil(Math.max(n,1.5*r.width),b);this._resizeAtlas(e,r.height)}else{const e=r.nextY+o,t=f.applyTextureResizeModuloCeil(Math.max(e,1.5*r.height),b);if(t>r.height)this._resizeAtlas(r.width,t);else if(r.width<b){const e=f.applyTextureResizeModuloCeil(1.5*r.width,b);this._resizeAtlas(e,r.height)}}this._elements.set(t,e)}}_renderElement(e){const t=e.commitNewPosition(),r=e.textRenderer;this._ctx.clearRect(t[0]-v,t[1]-v,r.renderedWidth+2*v,r.renderedHeight+2*v),r.render(this._ctx,t[0],t[1]),this._uvCallbacks.get(r.key)?.forEach(t=>t(e.uv))}get readyToRun(){return this.updating}runTask(e){if(null==this._glTexture)return g.Yield;for(;this._needsRepack&&(this._canRepack||this._atlas.height<b&&this._atlas.height<b);){this._canRepack=this._needsRepack=!1;const t=this._elements;this._elements=new Map,t.forEach(e=>this._processAddition(e)),e.madeProgress()}if(this._elementsToRender.size>0){for(const[t,r]of this._elementsToRender){if(e.done)break;this._renderElement(r),this._elementsToRender.delete(t),e.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(e,t){const r=e.key;this._addCallback(r,t);let i=this._elements.get(r);return i?d.exactEquals(i.uv,h.ZEROS)||t(i.uv):(i=new x(e),this._processAddition(i),this.setDirty()),{remove:()=>this._removeText(e,t)}}_removeText(e,t){const r=e.key;this._elements.get(r)&&this._removeCallback(r,t)&&(this._elements.delete(r),this._elementsToRender.delete(r),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}get usedMemory(){return(this._glTexture?.usedMemory??0)+(this._canvas?.width??0)*(this._canvas?.height??0)*4}},t.__decorate([a.property({constructOnly:!0})],e.TextTextureAtlas.prototype,"view",void 0),t.__decorate([a.property({type:Boolean})],e.TextTextureAtlas.prototype,"updating",void 0),e.TextTextureAtlas=t.__decorate([u.subclass("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],e.TextTextureAtlas);const v=2,w=2;class x{constructor(e){this.textRenderer=e,this._uv=h.create(),this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return h.ZEROS;const{renderedWidth:e,renderedHeight:t}=this.textRenderer;return d.set(this._uv,this._xOffset,this._yOffset+t,this._xOffset+e,this._yOffset)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class S{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=C}}class T{constructor(e){this.y=e,this.x=C}}let C=0;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/testUtils":function(){define(["exports"],function(e){"use strict";e.gridLocalOriginFactory={rootOrigin:null},e.textTextureAtlas={stableRendering:!1},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/textureUtils":function(){define(["exports","../../../../core/Error"],function(e,t){"use strict";const r=16;function i(e,t){return t=Math.floor(t/r)*r,Math.min(Math.round(e/r)*r,t)}function s({width:e,height:t},{maxPreferredTexturePixels:r,maxTextureSize:s}){const n=Math.max(e,t),o=e*t;if(n<=s&&o<=r)return[e,t];const a=Math.min(Math.sqrt(r/o),s/n);return[i(Math.round(e*a),s),i(Math.round(t*a),s)]}function n(e,r,i){if(e instanceof ImageData)return n(function(e){const r=document.createElement("canvas");r.width=e.width,r.height=e.height;const i=r.getContext("2d");if(null==i)throw new t("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return i.putImageData(e,0,0),r}(e),r,i);const s=document.createElement("canvas");return s.width=r,s.height=i,s.getContext("2d").drawImage(e,0,0,s.width,s.height),s}e.applyTextureResizeModulo=i,e.applyTextureResizeModuloCeil=function(e,t){return t=Math.floor(t/r)*r,Math.min(Math.ceil(e/r)*r,t)},e.ensureImageMaxSize=function(e,t){const[r,i]=s(e,t);return e.width===r&&e.height===i?e:n(e,r,i)},e.ensureTextureSize=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/WebGLLayer":function(){define(["exports","../../../../core/arrayUtils","../../../../core/compilerUtils","../../../../core/Evented","../../../../core/Handles","../../../../core/has","../../../../core/maybe","../../../../core/uid","./DirtyEvents","./Octree"],function(e,t,r,i,s,n,o,a,l,c){"use strict";e.WebGLLayer=class{constructor(e,t,r=""){this.stage=e,this.apiLayerViewUid=r,this.id=a.generateUID(),this.events=new i.EventEmitter,this.visible=!0,this.sliceable=!1,this._objectsAdded=new Array,this._handles=new s,this._objects=new Map,this._pickable=!0,this.visible=t?.visible??!0,this._pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??0,e.addLayer(this);for(const t of l.DirtyEventNames)this._handles.add(this.events.on(t,r=>e.handleEvent(t,r)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.removeLayer(this),this.invalidateSpatialQueryAccelerator())}get objects(){return this._objects}getObject(e){return r.toConst(this._objects.get(e))}set pickable(e){this._pickable=e}get pickable(){return this._pickable&&this.visible}add(e){this._objects.set(e.id,e),e.layer=this,this.events.emit("layerObjectAdded",e),null!=this._octree&&this._objectsAdded.push(e)}remove(e){this._objects.delete(e.id)&&(this.events.emit("layerObjectRemoved",e),e.layer=null,null!=this._octree&&(t.removeUnordered(this._objectsAdded,e)||this._octree.remove([e])))}addMany(e){for(const t of e)this._objects.set(t.id,t),t.layer=this;this.events.emit("layerObjectsAdded",e),null!=this._octree&&this._objectsAdded.push(...e)}removeMany(e){const r=new Array;for(const t of e)this._objects.delete(t.id)&&r.push(t);if(0!==r.length&&(this.events.emit("layerObjectsRemoved",r),r.forEach(e=>e.layer=null),null!=this._octree)){for(let e=0;e<r.length;)t.removeUnordered(this._objectsAdded,r[e])?(r[e]=r[r.length-1],r.length-=1):++e;this._octree.remove(r)}}sync(){1!==this.updatePolicy&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){null==this._octree||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return null==this._octree&&this._objects.size>50?(this._octree=new c.Octree(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.values())):null!=this._octree&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded),this._objectsAdded.length=0),this._octree}invalidateSpatialQueryAccelerator(){this._octree=o.destroyMaybe(this._octree),this._objectsAdded.length=0}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/DirtyEvents":function(){define(["exports"],function(e){"use strict";e.DirtyEventNames=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"],Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Octree":function(){define(["exports","../../../../core/ObjectPool","../../../../core/PooledArray","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/frustum","../../../../geometry/support/ray","../../../../chunks/sphere","./Util"],function(e,t,r,i,s,n,o,a,l){"use strict";class c{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,t){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new u,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}destroy(){this._degenerateObjects.clear(),u.clearPool(),P[0]=null,F.prune(),U.prune()}add(e){const t=Array.from(e);this._grow(t);const r=u.acquire();for(const e of t)++this._objectCount,this._isDegenerate(e)?this._degenerateObjects.add(e):(r.init(this._root),this._add(e,r));u.release(r)}remove(e,t=null){this._objectCount-=e.length;const r=u.acquire();for(const i of e){const e=t??a.copy(this.objectToBoundingSphere(i),A);x(e[3])?(r.init(this._root),p(i,e,r)):this._degenerateObjects.delete(i)}u.release(r),this._shrink()}update(e,t){if(!x(t[3])&&this._isDegenerate(e))return;const r=function(e){return P[0]=e,P}(e);this.remove(r,t),this.add(r)}forEachAlongRay(e,t,r){const i=o.wrap(e,t);d(this._root,e=>{if(!function(e,t){return _(a.getCenter(t.bounds),2*-t.halfSize,O),_(a.getCenter(t.bounds),2*t.halfSize,I),l.rayBoxTest(e.origin,e.direction,O,I)}(i,e))return!1;const t=e.node;return t.terminals.forAll(e=>{this._intersectsObject(i,e)&&r(e)}),null!==t.residents&&t.residents.forAll(e=>{this._intersectsObject(i,e)&&r(e)}),!0})}forEachAlongRayWithVerticalOffset(e,t,r,i){const s=o.wrap(e,t);d(this._root,e=>{if(!function(e,t,r){return _(a.getCenter(t.bounds),2*-t.halfSize,O),_(a.getCenter(t.bounds),2*t.halfSize,I),r.applyToMinMax(O,I),l.rayBoxTest(e.origin,e.direction,O,I)}(s,e,i))return!1;const t=e.node;return t.terminals.forAll(e=>{this._intersectsObjectWithOffset(s,e,i)&&r(e)}),null!==t.residents&&t.residents.forAll(e=>{this._intersectsObjectWithOffset(s,e,i)&&r(e)}),!0})}forEach(e){d(this._root,t=>{const r=t.node;return r.terminals.forAll(e),null!==r.residents&&r.residents.forAll(e),!0}),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,r,s=()=>!0,o=1/0){let l=1/0,c=1/0,u=null;const d=v(e,t),p=i=>{if(--o,!s(i))return;const d=this.objectToBoundingSphere(i);if(!n.intersectsSphere(r,d))return;const h=w(e,t,a.getCenter(d)),p=h-d[3],f=h+d[3];p<l&&(l=p,c=f,u=i)};return h(this._root,s=>{if(o<=0||!n.intersectsSphere(r,s.bounds))return!1;if(i.scale(R,d,s.halfSize),i.add(R,R,a.getCenter(s.bounds)),w(e,t,R)>c)return!1;const l=s.node;return l.terminals.forAll(e=>p(e)),null!==l.residents&&l.residents.forAll(e=>p(e)),!0},e,t),u}forEachInDepthRange(e,t,r,s,o,l,c){let u=-1/0,d=1/0;const p={setRange:e=>{1===r?(u=Math.max(u,e.near),d=Math.min(d,e.far)):(u=Math.max(u,-e.far),d=Math.min(d,-e.near))}};p.setRange(s);const f=w(t,r,e),m=v(t,r),g=v(t,-r),y=e=>{if(!c(e))return;const i=this.objectToBoundingSphere(e),s=a.getCenter(i),h=w(t,r,s)-f,m=h-i[3],g=h+i[3];m>d||g<u||!n.intersectsSphere(l,i)||o(e,p)};h(this._root,e=>{if(!n.intersectsSphere(l,e.bounds))return!1;if(i.scale(R,m,e.halfSize),i.add(R,R,a.getCenter(e.bounds)),w(t,r,R)-f>d)return!1;if(i.scale(R,g,e.halfSize),i.add(R,R,a.getCenter(e.bounds)),w(t,r,R)-f<u)return!1;const s=e.node;return s.terminals.forAll(e=>y(e)),null!==s.residents&&s.residents.forAll(e=>y(e)),!0},t,r)}forEachNode(e){d(this._root,t=>e(t.node,t.bounds,t.halfSize,t.depth))}forEachNeighbor(e,t){const r=a.getRadius(t),s=a.getCenter(t),n=t=>{const n=this.objectToBoundingSphere(t),o=a.getRadius(n),l=r+o;return!(i.squaredDistance(a.getCenter(n),s)-l*l<=0)||e(t)};let o=!0;const l=e=>{o&&(o=n(e))};d(this._root,e=>{const t=a.getRadius(e.bounds),n=r+t;if(i.squaredDistance(a.getCenter(e.bounds),s)-n*n>0)return!1;const c=e.node;return c.terminals.forAll(l),o&&null!==c.residents&&c.residents.forAll(l),o}),o&&this.forEachDegenerateObject(l)}_intersectsObject(e,t){const r=this.objectToBoundingSphere(t);return!(r[3]>0)||a.intersectsRay(r,e)}_intersectsObjectWithOffset(e,t,r){const i=this.objectToBoundingSphere(t);return!(i[3]>0)||a.intersectsRay(r.applyToBoundingSphere(i),e)}_add(e,t){t.advanceTo(this.objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let r=0;r<t.length;r++){const i=u.acquire().init(e);this._add(t.at(r),i),u.release(i)}}_grow(e){if(b(e,e=>this.objectToBoundingSphere(e),D),x(D[3])&&!this._fitsInsideTree(D))if(m(this._root.node))a.copy(D,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const e=this._rootBoundsForRootAsSubNode(D);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(D,e):this._growRootAsSubNode(e),u.release(e)}}_rebuildTree(e,t){i.copy(a.getCenter(E),a.getCenter(t.bounds)),E[3]=t.halfSize,b([e,E],e=>e,L);const r=u.acquire().init(this._root);this._root.initFrom(null,L,L[3]),this._root.increaseHalfSize(1.25),d(r,e=>(this.add(e.node.terminals.data),null!==e.node.residents&&this.add(e.node.residents.data),!0)),u.release(r)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let r=0;return d(this._root,e=>(r=Math.max(r,e.depth),r+t<=this._maximumDepth)),r+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],r=e;let i=-1/0;const s=this._root.bounds,n=this._root.halfSize;for(let e=0;e<3;e++){const o=s[e]-n-(r[e]-t),a=r[e]+t-(s[e]+n),l=Math.max(0,Math.ceil(o/(2*n))),c=Math.max(0,Math.ceil(a/(2*n)))+1,u=2**Math.ceil(Math.log(l+c)*Math.LOG2E);i=Math.max(i,u),V[e].min=l,V[e].max=c}for(let e=0;e<3;e++){let t=V[e].min,r=V[e].max;const o=(i-(t+r))/2;t+=Math.ceil(o),r+=Math.floor(o);const a=s[e]-n-t*n*2;M[e]=a+(r+t)*n}const o=i*n;return M[3]=o*C,u.acquire().initFrom(null,M,o,0)}_growRootAsSubNode(e){const t=this._root.node;i.copy(a.getCenter(D),a.getCenter(this._root.bounds)),D[3]=this._root.halfSize,this._root.init(e),e.advanceTo(D,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let r=0,i=0;for(;i<t.length&&null==e;)r=i++,e=t[r];for(;i<t.length;)if(t[i++])return-1;return r}_isDegenerate(e){return!x(this.objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,r=this._root.halfSize;return e[3]<=r&&e[0]>=t[0]-r&&e[0]<=t[0]+r&&e[1]>=t[1]-r&&e[1]<=t[1]+r&&e[2]>=t[2]-r&&e[2]<=t[2]+r}toJSON(){const{maximumDepth:e,maximumObjectsPerNode:t,_objectCount:r}=this,i=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:t,objectCount:r,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:i}}}_nodeToJSON(e){const t=e.children.map(e=>e?this._nodeToJSON(e):null),r=e.residents?.map(e=>this.objectToBoundingSphere(e)),i=e.terminals?.map(e=>this.objectToBoundingSphere(e));return{children:t,residents:r,terminals:i}}static fromJSON(e){const t=new c(e=>e,{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return t._objectCount=e.objectCount,t._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),t}}class u{constructor(){this.bounds=a.create(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,r,i=this.depth){return this.node=null!=e?e:u.createEmptyNode(),t&&a.copy(t,this.bounds),this.halfSize=r,this.depth=i,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*C}advance(e){let t=this.node.children[e];t||(t=u.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const r=S[e];return this.bounds[0]+=r[0]*this.halfSize,this.bounds[1]+=r[1]*this.halfSize,this.bounds[2]+=r[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,t,r=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!r)return t&&t(this,-1),!1;this.node.residents=null}const i=this._childIndex(e);t&&t(this,i),this.advance(i)}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new r({shrink:!0}),residents:new r({shrink:!0})}}static{this._pool=new t(u)}static acquire(){return u._pool.acquire()}static release(e){u._pool.release(e)}static clearPool(){u._pool.prune()}}function d(e,t){let r=u.acquire().init(e);const i=[r];for(;0!==i.length;){if(r=i.pop(),t(r)&&!r.isLeaf())for(let e=0;e<r.node.children.length;e++)r.node.children[e]&&i.push(u.acquire().init(r).advance(e));u.release(r)}}function h(e,t,r,i=1){let s=u.acquire().init(e);const n=[s];for(function(e,t,r){if(!U.length)for(let e=0;e<8;++e)U.push({index:0,distance:0});for(let r=0;r<8;++r){const i=S[r];U.data[r].index=r,U.data[r].distance=w(e,t,i)}U.sort((e,t)=>e.distance-t.distance);for(let e=0;e<8;++e)r[e]=U.data[e].index}(r,i,B);0!==n.length;){if(s=n.pop(),t(s)&&!s.isLeaf())for(let e=7;e>=0;--e){const t=B[e];s.node.children[t]&&n.push(u.acquire().init(s).advance(t))}u.release(s)}}function p(e,t,r){F.clear();const i=r.advanceTo(t,(e,t)=>{F.push(e.node),F.push(t)})?r.node.terminals:r.node.residents;if(i.removeUnordered(e),0===i.length)for(let e=F.length-2;e>=0&&f(F.data[e],F.data[e+1]);e-=2);}function f(e,t){return t>=0&&(e.children[t]=null),!!m(e)&&(null===e.residents&&(e.residents=new r({shrink:!0})),!0)}function m(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}function g(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function y(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function _(e,t,r){r[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t}function b(e,t,r){O[0]=1/0,O[1]=1/0,O[2]=1/0,I[0]=-1/0,I[1]=-1/0,I[2]=-1/0;for(const r of e){const e=t(r);x(e[3])&&(g(O,e),y(I,e))}i.lerp(a.getCenter(r),O,I,.5),r[3]=Math.max(I[0]-O[0],I[1]-O[1],I[2]-O[2])/2}function v(e,t){let r,i=1/0;for(let s=0;s<8;++s){const n=w(e,t,T[s]);n<i&&(i=n,r=T[s])}return r}function w(e,t,r){return t*(e[0]*r[0]+e[1]*r[1]+e[2]*r[2])}function x(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}const S=[s.fromValues(-1,-1,-1),s.fromValues(1,-1,-1),s.fromValues(-1,1,-1),s.fromValues(1,1,-1),s.fromValues(-1,-1,1),s.fromValues(1,-1,1),s.fromValues(-1,1,1),s.fromValues(1,1,1)],T=[s.fromValues(-1,-1,-1),s.fromValues(-1,-1,1),s.fromValues(-1,1,-1),s.fromValues(-1,1,1),s.fromValues(1,-1,-1),s.fromValues(1,-1,1),s.fromValues(1,1,-1),s.fromValues(1,1,1)],C=Math.sqrt(3),P=[null],M=a.create(),R=s.create(),O=s.create(),I=s.create(),F=new r,A=a.create(),D=a.create(),E=a.create(),L=a.create(),V=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],U=new r,B=[0,0,0,0,0,0,0,0];e.Octree=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SLodHandling":function(){define(["../../../../core/PooledArray"],function(e){"use strict";const t=new e({deallocator:null});return class{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}destroy(){this._index=null,this._lodGlobalHandling=null,this._removeNodes=null}startNodeLoading(e,t,r){this._maxLodLevel=r.maxLodLevel,this._index=t,this._removeNodes=e}shouldLoadNode(e){if(null==e)return!1;const t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const r=this._layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(r-1)));t.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1,!!this._layerView.nodeCrossfadingEnabled);const s=t.length;this._removeNodes(t,e);const n=t.length<s;return 0!==t.length&&(this._lodGlobalDirty=!0),t.clear(),n}_lodGlobalHandling(e,r,i,s){if(null==e)return!1;const n=e.index,o=this._index,a=this._layerView,l=o.nodeTraversalState(e),c=this._isChosenMaxLOD(l),u=e.resources.isEmpty;if(c&&u)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const d=a.isNodeLoaded(n);if(s&&d&&c){const t=!i&&this.hasNoVisibleChildren(e);a.fadeNode(n,0,!t)}const h=d&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(n));if(d&&(a.updateNodeState(n,c?1:0),c))return h&&this._removeChildrenRecursive(e),h;const p=e.childCount>0;let f=p;if(p)for(let t=0;t<e.childCount;t++){const e=o.getChildIndex(n,t),a=o.getNode(e);null!=a?!o.isGeometryVisible(e)||this._lodGlobalHandling(a,r,i||h,s)||(f=!1):o.isNodeVisible(e)&&(f=!1)}const m=d&&!c&&(f||t.length<r);m&&t.push(n),!s||m||!d||i||f||a.fadeNode(n,0,!1);const g=e.resources.isEmpty;return f||h&&!m||g}_removeChildrenRecursive(e){this._index.traverseDescendants(e,e=>((this._layerView.isNodeLoaded(e.index)||this._layerView.isNodeReloading(e.index))&&t.push(e.index),e.childrenLoaded>0))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseDescendants(e,e=>!(!t||!this._index.isNodeVisible(e.index))&&(this._layerView.isNodeLoaded(e.index)?(t=!1,!1):e.childrenLoaded>0)),t}_childrenRequireLoading(e){let t=!1,r=!0;return this._index.traverseDescendants(e,e=>{if(!r||!this._index.isNodeVisible(e.index))return!1;const i=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(i)&&this._index.isGeometryVisible(e.index)&&(t=!0),this._layerView.isNodeLoaded(e.index)?(r=!1,!1):e.childrenLoaded>0}),r&&t}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}static cleanupI3SLodHandling(){t.prune()}}})},"esri/views/3d/layers/support/StageLayerElevationProvider":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Evented","../../../../core/Logger","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../symbols/support/unitConversionUtils","../../support/ElevationUpdateEvent","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/VertexAttribute"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";const m=Symbol("layerHandles");e.StageLayerElevationProvider=class extends r.EventedAccessor{get spatialReference(){return this.view?.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=new p.Intersector(this.view.state.viewingMode),this._intersector.options.store=0;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this.addHandles([t.on(["layerObjectAdded","layerObjectRemoved","transformationChanged","shaderTransformationChanged"],e=>this._objectChanged(e)),t.on(["geometryAdded","geometryRemoved"],({object:e})=>this._objectChanged(e)),t.on("attributesChanged",({attribute:e,object:t})=>f.affectsGeometry(e)&&this._objectChanged(t))],m)}dispose(){this.removeHandles(m)}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=s.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=d.getMetersPerUnit(e.unit??"meters");this._elevationOffset=(e.offset??0)*r/t}else this._elevationOffset=0}getElevation(e,t,r,s){if(_[0]=e,_[1]=t,_[2]=r,!this._renderCoordsHelper.toRenderCoords(_,s,_))return i.getLogger(this).error("could not project point for elevation alignment"),null;const n=this._elevationOffset,o=this._zmin+n,a=this._zmax+n;return this._renderCoordsHelper.setAltitude(b,a,_),this._renderCoordsHelper.setAltitude(v,o,_),this._intersector.reset(b,v,null),this._intersector.intersect(this._intersectLayers,null,1,null,e=>!!e.lastValidElevationBB),this._intersector.results.min.getIntersectionPoint(_)?this._renderCoordsHelper.getAltitude(_):null}_objectChanged(e){const t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;u.empty(g);const r=e.lastValidElevationBB;r.isEmpty()||this._expandExtent(t,r.min,r.max,g);const{min:i,max:s}=e.boundingVolumeWorldSpace;this._expandExtent(t,i,s,g),u.toRect(g,y.extent),this._zmin=Math.min(this._zmin,g[2]),this._zmax=Math.max(this._zmax,g[5]),y.spatialReference=t,this.emit("elevation-change",y),y.spatialReference=null,r.assignMinMax(i,s)}_computeLayerExtent(e,t){return u.empty(g),null!=e&&t.objects.forEach(t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,g)),g}_expandExtent(e,t,r,i){for(let s=0;s<8;++s)_[0]=1&s?t[0]:r[0],_[1]=2&s?t[1]:r[1],_[2]=4&s?t[2]:r[2],this._renderCoordsHelper.fromRenderCoords(_,_,e),u.expandWithVec3(i,_);return i}},t.__decorate([n.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"layer",void 0),t.__decorate([n.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"stageLayer",void 0),t.__decorate([n.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"view",void 0),t.__decorate([n.property()],e.StageLayerElevationProvider.prototype,"spatialReference",null),e.StageLayerElevationProvider=t.__decorate([l.subclass("esri.views.3d.layers.support.StageLayerElevationProvider")],e.StageLayerElevationProvider);const g=u.empty(),y=new h.ElevationUpdateEvent,_=c.create(),b=c.create(),v=c.create();e.cleanupStageLayerElevationProvider=function(){y.spatialReference=null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/ElevationUpdateEvent":function(){define(["exports","../../../geometry/support/aaBoundingRect"],function(e,t){"use strict";e.ElevationUpdateEvent=class{constructor(e="scene"){this.context=e,this.extent=t.empty()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/state/ViewState":function(){define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/watch","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../ViewAnimation","../../ViewingMode","./Constraints","./controllers/AnimationController","../webgl/RenderCamera","../webgl-engine/lib/DepthRange","../../support/HighlightDefaults","../../support/PropertiesPool"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b){"use strict";let v=class extends t{constructor(e){super(e),this._propertiesPool=new b.PropertiesPool({camera:g},this),this._lastSeenCameraProjectionValues=new g,this.mode=0,this._cssCamera=new g,this._camera=new g,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new f.Constraints({state:this}),this.events=new r.EventEmitter,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new b.PropertiesPool({camera:g},this)}destroy(){this.cameraController=null,this._propertiesPool?.destroy(),this._propertiesPool=null}createInitialCamera(){if(1===this.viewingMode){const e=d.getReferenceEllipsoid(this.spatialReference).radius;this.camera=new g({eye:u.fromValues(4*e,0,0),center:u.fromValues(e,0,0),up:u.fromValues(0,0,1)})}else this.camera=new g({eye:u.fromValues(0,0,100),center:u.fromValues(0,0,0),up:u.fromValues(0,1,0)})}get animation(){return this.cameraController instanceof m.AnimationController&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:r,pixelRatio:i}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/i),e.width=Math.round(r/i),e}get camera(){return this._camera}set camera(e){e!==x&&x.copyFrom(e),x.computeUp(this.viewingMode),this.events.emit("before-camera-change",{camera:x});const t=this._camera;if(r=this._lastSeenCameraProjectionValues,i=x,(r.fov!==i.fov||r.fullViewport[0]!==i.fullViewport[0]||r.fullViewport[1]!==i.fullViewport[1]||r.fullViewport[2]!==i.fullViewport[2]||r.fullViewport[3]!==i.fullViewport[3]||r.padding[0]!==i.padding[0]||r.padding[1]!==i.padding[1]||r.padding[2]!==i.padding[2]||r.padding[3]!==i.padding[3])&&(this._lastSeenCameraProjectionValues.copyFrom(x),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(x)&&(this._camera=this._propertiesPool.get("camera").copyFrom(x),this._cameraChanged=!t.almostEquals(x),this._cameraChanged)){const e=c.afterDispatch(()=>{this._cameraChanged=!1,e.remove()})}var r,i}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&2===this.mode}get updating(){return 2!==this.mode}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){if(null==e)return void(this._contentCamera=null);const t=e.clone();this.events.emit("before-camera-change",{camera:t,sceneDepthRange:y.DepthRange.infinite}),this._contentCamera=t}get fixedContentCamera(){return null!=this._contentCamera}get isGlobal(){return 1===this.viewingMode}get isLocal(){return 2===this.viewingMode}get viewingMode(){return p.viewingModeFromString(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){const e=this.view.highlights.items.slice(0,_.maximumHighlights);for(let t=0;t<e.length;){const r=e[t],i=e.findIndex(e=>e.name===r.name);i>=0&&t>i?e.splice(t,1):++t}return e}get highlightOrderMap(){const e=new Map;return this.highlights.forEach((t,r)=>e.set(t.name,r)),e}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.cameraController?.destroy(),e&&(this.removeHandles(S),this.addHandles(i.when(()=>4===e.state||3===e.state,()=>{this._set("cameraController",null),this.updateCamera(t=>e.onControllerEnd(t))},{sync:!0,once:!0}),S),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=1)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();x.copyFrom(this._get("camera")),e(x),this.camera=x,this._processingUpdates=!1,this._processUpdateQueue()}static cleanupViewstate(){x=new g}};e.__decorate([s.property({constructOnly:!0})],v.prototype,"view",void 0),e.__decorate([s.property()],v.prototype,"mode",void 0),e.__decorate([s.property({readOnly:!0,type:h})],v.prototype,"animation",null),e.__decorate([s.property({type:g})],v.prototype,"cssCamera",null),e.__decorate([s.property()],v.prototype,"_cssCamera",void 0),e.__decorate([s.property({type:g})],v.prototype,"camera",null),e.__decorate([s.property()],v.prototype,"_camera",void 0),e.__decorate([s.property({readOnly:!0})],v.prototype,"pixelRatio",null),e.__decorate([s.property()],v.prototype,"rasterPixelRatio",void 0),e.__decorate([s.property()],v.prototype,"contentPixelRatio",void 0),e.__decorate([s.property({readOnly:!0})],v.prototype,"alignPixelEnabled",null),e.__decorate([s.property({readOnly:!0})],v.prototype,"updating",null),e.__decorate([s.property({})],v.prototype,"_contentCamera",void 0),e.__decorate([s.property({type:g})],v.prototype,"contentCamera",null),e.__decorate([s.property({readOnly:!0})],v.prototype,"fixedContentCamera",null),e.__decorate([s.property({readOnly:!0})],v.prototype,"events",void 0),e.__decorate([s.property({readOnly:!0})],v.prototype,"isGlobal",null),e.__decorate([s.property({readOnly:!0})],v.prototype,"isLocal",null),e.__decorate([s.property({readOnly:!0})],v.prototype,"viewingMode",null),e.__decorate([s.property({readOnly:!0})],v.prototype,"highlights",null),e.__decorate([s.property({readOnly:!0})],v.prototype,"highlightOrderMap",null),e.__decorate([s.property({readOnly:!0})],v.prototype,"navigating",null),e.__decorate([s.property({readOnly:!0})],v.prototype,"stationary",null),e.__decorate([s.property()],v.prototype,"_cameraChanged",void 0),e.__decorate([s.property()],v.prototype,"cameraController",null),v=e.__decorate([l.subclass("esri.views.3d.state.ViewState")],v);const w=v;let x=new g;const S="ViewStateHandles";return w})},"esri/views/3d/state/helpers/SceneIntersectionHelper":function(){define(["exports","../../../../core/has","../../../../core/PooledArray","../../../../core/screenUtils","../../../../core/unitUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/ray","../../../../geometry/support/vectorStacks","../../../../support/elevationInfoUtils","../../support/hitTest","../../support/geometryUtils/ray","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorResult","../../webgl-engine/lib/intersectorUtils","../../webgl-engine/materials/HUDMaterial"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g){"use strict";const y=(()=>{const e=[];for(let t=-1;t<=1;t++)for(let r=-1;r<=1;r++)e.push([r+1,t+1]);return e})();class _{constructor(e){this.result=e,this.screenPoint=i.createRenderScreenPointArray3()}}let b;function v(e){return b&&b.viewingMode===e||(b=new p.Intersector(e)),b}class w{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t(e=>{e.pickable&&this.filterLayerViewUid(e.apiLayerViewUid)&&(e.sliceable?this.sliceableLayers:this.layers).push(e)})}filterLayerViewUid(e,t){const{include:r,exclude:i}=this;if(null==e)return null==r&&null==i;const s=r instanceof Map?r.get(e)??!1:r?.has(e),n=i instanceof Map?i.get(e)??!1:i?.has(e);return(null==s||("boolean"==typeof s?s:null!=t&&s.has(t)))&&(null==n||!("boolean"==typeof n?n:null!=t&&n.has(t)))}filterRenderGeometry(e){return this.filterLayerViewUid(e.layerViewUid)}}const x=o.create(),S=o.create(),T=i.createRenderScreenPointArray3();e.SceneIntersectionHelper=class{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new r,this._tolerance=p.defaultTolerance,this._tmpRay=l.create(),this._tmpRegion=a.create(),this._validateHUDIntersector=new p.Intersector(this.viewingMode),this._validateHUDIntersector.options.hud=!1}destroy(){this._externalIntersectionHandlers.prune()}intersectScreen(e,t,r){return this.intersectRay(this._getPickRay(e,this._tmpRay),v(this.viewingMode),t,r)}intersectScreenFreePointFallback(e,t,r){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,r)}intersectRayFreePointFallback(e,t,r){return this.intersectRay(e,v(this.viewingMode),t,r)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,r,i){return t.options.selectionMode=!1,t.options.store=0,this.computeIntersection(e,t,!1,i),!!t.results.min&&t.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(e,t,r=.5,i=.5){return e.getRenderCenter(T,r,i),T[0]+=.0466,T[1]-=.0123,h.fromRenderAtEye(e,T,t)}intersectIntersectorScreen(e,t,r){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,!1,r)}intersectToolIntersectorScreen(e,t,r){const i=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(i,t,r)}intersectToolIntersectorRay(e,t,r){t.options.selectionMode=!0,this.computeIntersection(e,t,!1,r);const i=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||f.isValidIntersectorResult(i)&&2!==i.intersector||(t.options.selectionMode=!1,this.computeIntersection(e,t,!1,r))}setTolerance(e=p.defaultTolerance){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((e,t)=>2===e.type?1:2===t.type?-1:0)}removeIntersectionHandler(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort((e,t)=>2===e.type?1:2===t.type?-1:0)}_getPickRay(e,t){const r=this._view.state.camera;return h.fromScreen(r,e,t)}_intersectRayFreePointLocal(e,t){return 2!==this.viewingMode||null==e||n.add(t,e.origin,n.normalize(c.sv3d.get(),e.direction)),!1}intersectElevationFromScreen(e,t,r=0,i=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,r,i)}_intersectElevation(e,t,r=0,o=null){if(null==e)return null;const a=this._view,{renderCoordsHelper:l}=a,h=s.getMetersPerVerticalUnitForSR(a.spatialReference),f=null!=t?t.mode:"absolute-height",g=u.getElevationOffsetInMeters(t)/h,y=("on-the-ground"!==f?g+r:0)*h/l.unitInMeters,{camera:_}=a.state;if("absolute-height"===f){const t=l?.getAltitude(_.eye),r=n.dot(n.normalize(x,e.direction),l.worldUpAtPosition(_.eye,S));if(t<y&&r<0||t>=y&&r>0)return null;if(l.intersectInfiniteManifold(e,y,x)){const e=d.computeMapPointFromVec3d(a,x);return e.z??=0,e.z-=g,e}return null}const b=i.castRenderScreenPointArray3(c.sv3d.get());_.projectToRenderScreen(e.origin,b);const v=new w(null,this._forEachLayer),{slice:{plane:T}}=a,C=null!=T?m.sliceFilterPredicate(T):null,P=new p.Intersector(this.viewingMode);P.options.store=0,P.options.verticalOffset=y,P.options.normalRequired=!1;const M=e.origin,R=n.add(c.sv3d.get(),M,e.direction);P.reset(M,R,_),P.point=b;let O=null;if(o&&"type"in o&&"graphics"===o.type){const e=a.allLayerViews.find(e=>e.layer===o)?.uid;O=e?t=>t.layerViewUid===e:null}else o&&(O=e=>e.graphicUid!==o.uid);switch(f){case"relative-to-scene":{const e=e=>(!O||O(e))&&!!e.lastValidElevationBB;P.intersect(v.layers,b,this._tolerance,null,e),this._externalIntersectionHandlers.forAll(e=>{if(4===e.type||2===e.type||8===e.type){const t=e.slicePlaneEnabled?C:null;e.intersect(P,t,P.rayBegin,P.rayEnd,b,!1)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(e=>{if(e.isGround){const t=e.slicePlaneEnabled?C:null;e.intersect(P,t,P.rayBegin,P.rayEnd,b,!1)}})}if(P.results.min.getIntersectionPoint(x)){const e=d.computeMapPointFromVec3d(a,x);return e.z=r,e}return null}computeIntersection(e,t,r,s){if(null==e)return;const o=this._view.state.camera,a=i.castRenderScreenPointArray3(c.sv3d.get());o.projectToRenderScreen(e.origin,a);const l=new w(s,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!s||!("include"in s||"exclude"in s);const u=e.origin,d=n.add(c.sv3d.get(),e.origin,e.direction);t.reset(u,d,o),t.intersect(l.layers,a,this._tolerance);const h=this._view.slice.plane,p=null!=h?m.sliceFilterPredicate(h):null;t.intersect(l.sliceableLayers,a,this._tolerance,p);const f=s&&(s.requiresGroundFeedback||s.enableDraped);this._externalIntersectionHandlers.forAll(e=>{const i=e.layerViewUid,s=e.sublayerId,n=Array.isArray(i),o=n?i:[i];n&&(t.options.filteredLayerViewUids=[]);let c=!1;for(const e of o)l.filterLayerViewUid(e,s)?c=!0:n&&t.options.filteredLayerViewUids.push(e);if(t.options.isFiltered=!c,e.isGround&&f||!t.options.isFiltered){const i=e.slicePlaneEnabled?p:null;e.intersect(t,i,u,d,a,r)}});const g=c.sv3d.get(),y=this._view.basemapTerrain;if(s&&s.enableDraped&&null!=y.spatialReference&&t.results.ground.getIntersectionPoint(g)){const e=y.overlayManager.renderer,r=this._view.renderCoordsHelper.spatialReference,i=c.sv3d.get();this._view.renderCoordsHelper.fromRenderCoords(g,i,y.spatialReference),i[2]=this._view.elevationProvider?.getElevation(g[0],g[1],g[2],r,"ground")??0,e.intersect(t,i,t.results.ground,e=>l.filterRenderGeometry(e))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;a.copy(this._tmpRegion,a.negativeInfinity);const r=this._view.state.camera,i=[],s=this._tmpRegion,n=e=>{const t=new _(e),n=t.result.target.object.geometries.every(e=>e.material instanceof g.HUDMaterial&&e.material.parameters.occlusionTest);i.push({item:t,occlusionTest:n}),n&&(r.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),a.expandPointInPlace(s,t.screenPoint))};e.sortResults(t.all),null!=t.min.distance&&n(t.min);for(const e of t.all)t.min.target.object!==e.target.object&&t.max.target.object!==e.target.object&&n(e);if(null!=t.max.distance&&t.max.target.object!==t.min.target.object&&n(t.max),!i.length)return;s[0]===s[2]&&(s[2]+=1),s[1]===s[3]&&(s[3]+=1);const o=r.fullWidth,l=r.fullHeight,c=Math.max(0,s[0]-1),u=Math.max(0,s[1]-1),d=Math.min(a.width(s)+2,o-c),h=Math.min(a.height(s)+2,l-u),p=d>0&&h>0?new Uint8Array(d*h*4):null;p&&this._view.stage.renderer.readHUDVisibility(c,u,d,h,p);let f=!0;const m=null==e.results.max.distance;let b=0;for(const{item:t,occlusionTest:r}of i){let i=!r;if(r&&p)for(const e of y){const r=4*(Math.min(t.screenPoint[0]+e[0],o)-s[0]+(Math.min(t.screenPoint[1]+e[1],l)-s[1])*d);if(r>=0&&r<p.length&&p[r]){i=!0;break}}i&&(f&&(e.results.min.copy(t.result),f=!1),m&&e.results.max.copy(t.result),2===e.options.store&&e.results.all.splice(b++,0,t.result))}}},e.isIntersectionHandler=function(e){return"object"==typeof e&&"intersect"in e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/support/elevationInfoUtils":function(){define(["exports","../core/unitUtils","../symbols/support/unitConversionUtils"],function(e,t,r){"use strict";function i(e){return e?m:g}function s(e,t){return t?.mode?t.mode:i(e).mode}function n(e,t){return null!=t?t:i(e)}function o(e,t){return s(null==e||(e.hasZ??!1),t)}function a(e){const t=u(e),r=o(e.geometry,t),i=null!=t&&"on-the-ground"!==r?f(t):0,s=t?.featureExpressionInfo;return{mode:r,offset:i,featureExpressionInfo:s}}function l(e){return"0"===e?.featureExpressionInfo?.expression}function c(e){if(!e)return!1;if("on-the-ground"===e.mode)return!1;const t=e?.featureExpressionInfo?e.featureExpressionInfo.expression:null;return!(!t||"0"===t)}function u(e){return e.layer&&"elevationInfo"in e.layer?e.layer.elevationInfo:null}function d(e,r){if(!e?.offset)return 0;const{offset:i,unit:s}=e;if("decimal-degrees"===s)return 0;const n="unknown"!==s&&s?s:"meters",o=t.verticalLengthUnitFromSpatialReference(r);return o?t.convertUnit(i,n,o):0}function h(e,t,r,i,s,n,o=null){if(null==n)return;const a=null!=o?o.mode:"absolute-height";if("on-the-ground"===a)return 0;const{absoluteZ:l}=p(t,r,i,s,e,n);return function(e,t,r,i,s,n,o,a){const l=d(o,s);switch(a){case"absolute-height":return e-l;case"relative-to-ground":return e-((n.elevationProvider.getElevation(t,r,i,s,"ground")??0)+l);case"relative-to-scene":return e-((n.elevationProvider.getElevation(t,r,i,s,"scene")??0)+l)}}(l,t,r,i,s,e,o,a)}function p(e,t,r,i,s,n){const o=d(n,i);switch(n.mode){case"absolute-height":return{absoluteZ:r+o,elevation:0};case"on-the-ground":{const r=s.elevationProvider.getElevation(e,t,0,i,"ground")??0;return{absoluteZ:r,elevation:r}}case"relative-to-ground":{const n=s.elevationProvider.getElevation(e,t,r,i,"ground")??0;return{absoluteZ:r+n+o,elevation:n}}case"relative-to-scene":{const n=s.elevationProvider.getElevation(e,t,r,i,"scene")??0;return{absoluteZ:r+n+o,elevation:n}}}}function f(e){return(e?.offset??0)*r.getMetersPerUnit(e?.unit)}const m={mode:"absolute-height",offset:0},g={mode:"on-the-ground",offset:null};e.absoluteHeightElevationInfo=m,e.elevationContextAffectsAlignment=function(e,t){if(null==t)return!1;const{mode:r}=t;return null!=r&&("scene"===e&&"relative-to-scene"===r||"ground"===e&&"absolute-height"!==r)},e.elevationModeRequiredMessage=function(e,t,r){return r&&r.mode!==t?`${e} only support ${t} elevation mode`:null},e.elevationModeUnsupportedMessage=function(e,t,r){return r?.mode===t?`${e} do not support ${t} elevation mode`:null},e.featureExpressionInfoIsZero=l,e.featureExpressionUnsupportedMessage=function(e,t){return null!=t?.featureExpressionInfo&&"0"!==t.featureExpressionInfo.expression?`${e} do not support featureExpressionInfo`:null},e.getConvertedElevation=function(e,t,r,i=null){return h(e,t.x,t.y,t.hasZ?t.z:0,t.spatialReference,r,i)},e.getConvertedElevationFromVector=function(e,t,r,i,s=null){return h(e,t[0],t[1],t.length>2?t[2]:0,r,i,s)},e.getConvertedElevationFromXYZ=h,e.getEffectiveElevationInfo=n,e.getEffectiveElevationMode=s,e.getElevationOffset=d,e.getElevationOffsetInMeters=f,e.getGeometryEffectiveElevationInfo=function(e,t){return n(null==e||(e.hasZ??!1),t)},e.getGeometryEffectiveElevationMode=o,e.getGraphicEffectiveElevationInfo=a,e.getGraphicEffectiveElevationMode=function(e){const t=u(e);return o(e.geometry,t)},e.getZForElevationMode=function(e,t,r){if(!r?.mode)return;const i=e.hasZ?e.z:0,s=d(r,e.spatialReference);switch(r.mode){case"absolute-height":return i-s;case"on-the-ground":return 0;case"relative-to-ground":return i-((t.elevationProvider.getElevation(e.x,e.y,i,e.spatialReference,"ground")??0)+s);case"relative-to-scene":return i-((t.elevationProvider.getElevation(e.x,e.y,i,e.spatialReference,"scene")??0)+s)}},e.hasEffectiveFeatureExpressionInfo=c,e.hasFeatureExpressionInfo=function(e){return c(e)||l(e)},e.hasGraphicFeatureExpressionInfo=function(e){return c(a(e))},e.logInvalidElevationInfoWarning=function(e,t){t&&e.warn(".elevationInfo=",t)},e.onTheGroundElevationInfo=g,e.zValueInAbsoluteHeightMode=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/hitTest":function(){define(["exports","../../../Graphic","../../../core/iteratorUtils","../../../core/screenUtils","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/projection/projectVectorToVector","../../../layers/LayerConstants","../../../layers/support/layerUtils","./debugFlags","./ElevationProvider","../webgl-engine/lib/Intersector","../webgl-engine/lib/IntersectorResult","../webgl-engine/lib/intersectorUtilsConversions","../webgl-engine/lib/verticalOffsetUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";function g(e,t,r){return t.getIntersectionPoint(P)?(r=v(e,P,r),2===t.intersector&&e.basemapTerrain&&(r.z=d.getElevationAtPoint(e.basemapTerrain,r)??0),r):null}function y(e){const t=e.sourceLayer,r=e.layer,i=t&&"objectIdField"in t?t:r&&"objectIdField"in r?r:t;if(i){const t=i.objectIdField??l.fallbackObjectIDAttribute,r=e.attributes?.[t];if(r)return`o-${i.id}-${r}`}return`u-${e.uid}`}function _(e,t){return b(e,y(t))}function b(e,t){return null==e||(null==e.include||e.include.has(t))&&(null==e.exclude||!e.exclude.has(t))}function v(e,t,r){let i=e.spatialReference||o.WGS84;return a.projectVectorToVector(t,e.renderSpatialReference,P,i)?t=P:(i=o.WGS84,a.projectVectorToVector(t,e.renderSpatialReference,P,i)&&(t=P)),r?(r.x=t[0],r.y=t[1],r.z=t[2],r.spatialReference=i):r=new n(t,i),r}function w(e,t){const r=x(e,t.include,0),i=x(e,t.exclude,1);return{include:r.layerViewUids,exclude:i.layerViewUids,graphics:{include:r.graphicUids,exclude:i.graphicUids},mediaElements:{include:r.mediaElements,exclude:i.mediaElements}}}function x(e,i,s,n=new S){if(!i)return n;if(i instanceof t)!function(e,t){e.graphicUids??=new Set,e.graphicUids.add(t)}(n,y(i)),0===s&&(null!=e.graphicsView&&i.layer===e?C(n,e.graphicsView.uid):i.layer&&T(n,e,i.layer.uid));else if("layer"in i&&"element"in i)!function(e,t){e.mediaElements??=new Set,e.mediaElements.add(t)}(n,i.element),0===s&&T(n,e,i.layer.uid);else if(r.isIterable(i))for(const t of i)t===e.graphics&&null!=e.graphicsView?C(n,e.graphicsView.uid):t===e.map.ground?C(n,m.terrainId):x(e,t,s,n);else"layer"in i&&function(e,t,r){const i=t.allLayerViews.find(e=>e.layer.uid===r.layer.uid);if(!i)return;e.layerViewUids??=new Map;const s=e.layerViewUids.get(i.uid);!0!==s&&(s?s.add(r.id):e.layerViewUids.set(i.uid,new Set([r.id])))}(n,e,i),"uid"in i&&T(n,e,i.uid);return n}class S{constructor(){this.layerViewUids=null,this.graphicUids=null,this.mediaElements=null}}function T(e,t,r){const i=t.allLayerViews.find(e=>e.layer.uid===r);i&&C(e,i.uid)}function C(e,t){e.layerViewUids??=new Map,e.layerViewUids.set(t,!0)}const P=s.create();e.computeMapPointFromVec3d=v,e.externalToInternalIntersectOptions=w,e.getGraphicFilterUid=y,e.hitTest=async function(e,t,r,s){const n=r?w(e,r):s,o=i.createScreenPointArray(t.x,t.y);n.requiresGroundFeedback=!0,n.enableDraped=!0;const a=new h.Intersector(e.state.viewingMode);a.options.selectionMode=!0,a.options.store=2,e.sceneIntersectionHelper.intersectIntersectorScreen(o,a,n);const l=await async function(e,t,r){const i=new Array;let s,n=null;const o={defer(e){s=e()}};for(let a=0;a<t.length;a++){const l=t[a],u=f.toOwner(l,e);if(null!=u&&(u===e.map.ground||"type"in u&&c.isIntegratedMeshLayer(u.type)))break;const d=f.toHit(l,e,o)??await s;if(s=null,null==d)continue;if("graphic"===d.type){if(null==n&&a!==t.length-1&&(n=new Set),null!=n){const e=y(d.graphic);if(n.has(e))continue;n.add(e)}if(!_(r,d.graphic))continue}const h=g(e,l),p=l.distanceInRenderSpace;if("media"===d.type){const e=d.element.toSource(h);i.push({...d,mapPoint:h,distance:p,sourcePoint:e})}else i.push({...d,mapPoint:h,distance:p})}return i}(e,a.results.all,n.graphics),d=a.results.ground,m=f.toOwner(d,e),b=null!=m&&"type"in m&&c.isIntegratedMeshLayer(m.type)?m:null,v={screenPoint:t,results:l,ground:{mapPoint:g(e,d),distance:p.isValidIntersectorResult(d)?d.distanceInRenderSpace:0,layer:b}};return u.debugFlags.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(v.intersector=a),v},e.intersectResultToMapPoint=g,e.toMap=function(e,t,r,s){const n=r?w(e,r):s,o=!(!n.graphics?.include&&!n.graphics?.exclude),a=!(!n.mediaElements?.include&&!n.mediaElements?.exclude),l=i.screenPointObjectToArray(t);n.enableDraped=n.include&&!n.include.has(m.terrainId)||n.exclude?.has(m.terrainId);const c=e.sceneIntersectionHelper,u=new h.Intersector(e.state.viewingMode);if(u.options.selectionMode=!0,u.options.store=o||a?2:0,u.options.excludeLabels=r?.excludeLabels??!1,c.intersectIntersectorScreen(l,u,n),o||a){for(const t of u.results.all){const r=f.toHit(t,e);if(null==r)return g(e,t);if(o&&("graphic"!==r.type||_(n.graphics,r.graphic)))return g(e,t);if(a&&("media"!==r.type||b(n.mediaElements,r.element)))return g(e,t)}return null}return g(e,u.results.min)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/LayerConstants":function(){define(["exports"],function(e){"use strict";e.fallbackObjectIDAttribute="OBJECTID",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/intersectorUtilsConversions":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../chunks/sphere","../../layers/i3s/Intersector","../../terrain/Intersector","./HUDIntersectorResult","./ObjectIntersectorResult","./lodRendering/Intersector"],function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(e,t,r={}){if(null==e)return null;if(l.isObjectIntersectorResult(e)||a.isHUDIntersectorResult(e))return d(e.target?.object,t,r);if(n.isPclIntersectorResult(e)){const t=e.target.createGraphic();return{type:"graphic",graphic:t,layer:t.layer}}if(n.isVoxelIntersectorResult(e)){const t=e.target.createVoxelGraphic();return{type:"graphic",graphic:t,layer:t.layer}}if(n.isTiles3DIntersectorResult(e)){const t=e.target.createTiles3DGraphic();return{type:"graphic",graphic:t,layer:t.layer}}return o.isOverlayIntersectorResult(e)||c.isLodIntersectorResult(e)?d(e.target,t,r):n.isI3sIntersectorResult(e)?function(e,t,r){const i=p(e,t);if(null==i)return null;const s=t.allLayerViews.find(e=>e.layer===i);if(!s||s.suspended||!("getGraphicFromIntersectorTarget"in s))return null;const n=r.defer;return h(s.getGraphicFromIntersectorTarget(e,{defer:n?e=>n(async()=>h(await e())):void 0}))}(e.target,t,r):null}function d(e,t,r){if(null==e?.graphicUid)return null;const i=p(e,t);if(null==i)return null;if(i===t.graphics)return null==t.graphicsView||"number"!=typeof e.graphicUid?null:t.graphicsView.getHit(e.graphicUid,r);const s=t.allLayerViews.find(e=>e.layer===i);return!s||s.suspended||null==e.graphicUid?null:"getHit"in s?s.getHit(e.graphicUid,r):null}function h(e){return null!=e?{type:"graphic",graphic:e,layer:e.layer}:null}function p(e,t){return null==e?.layerViewUid?null:null!=t.graphicsView&&e.layerViewUid===t.graphicsView.uid?t.graphics:t.allLayerViews.find(t=>t.uid===e.layerViewUid)?.layer}const f=r.create();e.getIntersectedFeatureBSRadius=function(e,r){if(l.isObjectIntersectorResult(e)||a.isHUDIntersectorResult(e))return s.getRadius(e.target.object.boundingVolumeWorldSpace.bounds);if(c.isLodIntersectorResult(e)){t.getScale(f,e.transformation);const r=Math.max(f[0],f[1],f[2]);return e.target.baseBoundingSphere.radius*r}if(n.isI3sIntersectorResult(e)){const t=function(e,t){const r=p(e,t);if(null==r)return null;const i=t.allLayerViews.find(e=>e.layer===r);return i&&!i.suspended&&"getAABBFromIntersectorTarget"in i?i.getAABBFromIntersectorTarget(e):null}(e.target,r);return t?.5*i.diameter(t):null}return null},e.hasLod=function(e){return!l.isObjectIntersectorResult(e)&&!a.isHUDIntersectorResult(e)&&(c.isLodIntersectorResult(e)?e.target.numLodLevels>1:!!n.isI3sIntersectorResult(e))},e.toGraphic=function(e,t){const r=u(e,t);return"graphic"===r?.type?r.graphic:null},e.toHit=u,e.toOwner=function(e,t){return l.isObjectIntersectorResult(e)||a.isHUDIntersectorResult(e)?p(e.target?.object,t):o.isTerrainIntersectorResult(e)?t.map?.ground:n.isPclIntersectorResult(e)||n.isI3sIntersectorResult(e)||o.isOverlayIntersectorResult(e)||n.isVoxelIntersectorResult(e)?p(e.target,t):null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/Intersector":function(){define(["exports","../../webgl-engine/lib/IntersectorResult","../../webgl-engine/lib/IntersectorTarget"],function(e,t,r){"use strict";class i extends r.Graphic3DTarget{constructor(e,t,r,i){super(t,r),this.point=e,this.createGraphic=i}}class s extends r.LayerTarget{constructor(e,t,r,i,s){super(e),this.layerViewUid=e,this.sublayerId=t,this.nodeIndex=r,this.componentIndex=i,this.triangleNr=s}}class n extends r.Graphic3DTarget{constructor(e,t,r){super(t,null),this.point=e,this.createVoxelGraphic=r}}class o extends r.Graphic3DTarget{constructor(e,t){super(e,null),this.createTiles3DGraphic=t}}e.I3sTarget=s,e.PclTarget=i,e.Tiles3DTarget=o,e.VoxelTarget=n,e.isI3sIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&4===e.intersector&&!!e.target},e.isPclIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&5===e.intersector&&!!e.target},e.isTiles3DIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&8===e.intersector&&!!e.target},e.isVoxelIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&7===e.intersector&&!!e.target},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/Intersector":function(){define(["exports","../webgl-engine/lib/IntersectorResult","../webgl-engine/lib/IntersectorTarget"],function(e,t,r){"use strict";class i extends r.Graphic3DTarget{constructor(e,t,r){super(e,t),this.triangleNr=r}}e.OverlayTarget=i,e.isOverlayIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&3===e.intersector&&!!e.target},e.isTerrainIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&2===e.intersector&&!!e.target},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/ObjectIntersectorResult":function(){define(["exports","./IntersectorResult"],function(e,t){"use strict";e.isObjectIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&0===e.intersector&&!!e.target},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/intersectorUtils":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/boundedPlane"],function(e,t,r,i){"use strict";const s=r.create();e.sliceFilterPredicate=function(e){return(r,n,o)=>!i.extrusionContainsPoint(e,t.lerp(s,r,n,o))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/CombinedElevationProvider":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Evented","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/SpatialReference","../../../geometry/support/spatialReferenceUtils","../layers/graphics/ElevationQuery","./ElevationRange"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";function f(e,t,r,i,s,n,o){for(const a of t){const t=a.getElevation(r,i,s,n,o);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}e.CombinedElevationProvider=class extends r.EventedAccessor{get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=i.destroyMaybe(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,r,i,s){if(this._cacheEnabled&&null!=this.lastElevationQuery){const n=this.lastElevationQuery;if(e===n.x&&t===n.y&&r===n.z&&d.equals(i,n.spatialReference)&&s===n.queryContext)return n.result}let n=null;return n=f(n,this._im,e,t,r,i,s),null==n&&(n=f(n,this._ground,e,t,r,i,s)),"scene"===s&&(n=f(n,this._scene,e,t,r,i,s)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:r,spatialReference:i,queryContext:s,result:n}),n}getSphereElevationBounds(e,t,r){const i=new p.ElevationRange;function s(s){for(const n of s)if(n.getSphereElevationBounds){const s=n.getSphereElevationBounds(e,t,r);null!=s&&i.expandElevationRangeValues(s.elevationRangeMin,s.elevationRangeMax)}}return s(this._ground),s(this._im),"scene"===r&&s(this._scene),i}getRootElevationBounds(){const e=new p.ElevationRange;for(const t of[this._im,this._ground,this._scene])t.forEach(t=>{if(t.getRootElevationBounds){const r=t.getRootElevationBounds();null!=r&&e.expandElevationRangeValues(r.elevationRangeMin,r.elevationRangeMax)}});return e}async queryElevation(e,t,r,i,n,o=null,a=0){const l=this._getElevationQuery(i);try{const s=await l.queryElevation(e,t,o,a);return"scene"===n?f(s,this._scene,e,t,r,i,n):s}catch(o){return s.throwIfAbortError(o),this.getElevation(e,t,r,i,n)}}register(e,t){this.addHandles(t.on("elevation-change",e=>this.emit("elevation-change",e)),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const r=t.indexOf(e);r>-1&&t.splice(r,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(null!=t&&d.equals(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:r,wkt:i,wkt2:s,latestWkid:n}=e,o=new h.ElevationQuery(this.view.resourceController.scheduler,new u({wkid:r,wkt:i,wkt2:s,latestWkid:n}),()=>this.view.map?.ground,{maximumAutoTileRequests:4});return this._cachedQuery=o,o}},t.__decorate([n.property({constructOnly:!0})],e.CombinedElevationProvider.prototype,"view",void 0),t.__decorate([n.property()],e.CombinedElevationProvider.prototype,"spatialReference",null),e.CombinedElevationProvider=t.__decorate([c.subclass("esri.views.3d.support.CombinedElevationProvider")],e.CombinedElevationProvider),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/ElevationQuery":function(){define(["exports","../../../../core/arrayUtils","../../../../core/has","../../../../core/promiseUtils","../../../../geometry/Multipoint","../../../support/Scheduler"],function(e,t,r,i,s,n){"use strict";e.ElevationQuery=class{constructor(e,t,r,i){this.spatialReference=t,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions={...i,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(n.TaskPriority.ELEVATION_QUERY,this)}destroy({completeTasks:e}={completeTasks:!1}){if(this._frameTask.remove(),this.readyToRun)if(e)this.runTask(n.noBudget);else for(const e of this._queries)e.result.reject(i.createAbortError())}queryElevation(e,r,s,n=0){const o=i.createResolver(),a={x:e,y:r,minDemResolution:n,result:o,signal:s};return this._queries.push(a),i.onAbort(s,()=>{t.remove(this._queries,a),o.reject(i.createAbortError())}),o.promise}get readyToRun(){return this._queries.length>0}runTask(e){const t=this._queries;this._queries=[];const r=this._getElevationQueryProvider();if(!r)return t.forEach(e=>e.result.reject()),void e.madeProgress();const n=t.map(e=>[e.x,e.y]),o=t.reduce((e,t)=>Math.min(e,t.minDemResolution),1/0),a=new s({points:n,spatialReference:this.spatialReference}),l=t.length>1&&t.some(e=>!!e.signal)?new AbortController:null,c=null!=l?l.signal:t[0].signal;if(null!=l){let e=0;t.forEach(r=>i.onAbort(r.signal,()=>{e++,r.result.reject(i.createAbortError()),e===t.length&&l.abort()}))}const u={...this._queryOptions,minDemResolution:o,signal:c};r.queryElevation(a,u).then(e=>{t.forEach((t,r)=>{null!=t.signal&&t.signal.aborted?t.result.reject(i.createAbortError()):t.result.resolve(e.geometry.points[r][2])})}).catch(e=>{t.forEach(t=>t.result.reject(e))}),e.madeProgress()}get test(){}},e.ViewElevationProvider=class{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,r){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,r)}async queryElevation(e,t,r,i,s){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,s,r,i)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/ElevationRange":function(){define(["exports"],function(e){"use strict";e.ElevationRange=class{constructor(e=1/0,t=-1/0){this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/DisplayQualityProfile":function(){define(["../../../core/has","../../../core/time"],function(e,t){"use strict";class r{static isValidProfile(e){return e in s}static getDefaultProfile(){return e("esri-iPhone")?"low":"medium"}static apply(e,t){const r=s[e];t.graphics3D.maxTotalNumberOfFeatures=r.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=r.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=r.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=r.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=r.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=r.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=r.graphics3D.skipHighSymbolLods;const i=t.sceneService.object,n=r.sceneService.object;i.lodFactor=n.lodFactor,t.sceneService.point.lodFactor=r.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=r.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=r.sceneService.pointCloud.lodFactor,t.tiledSurface.lodBias=r.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=r.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=r.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=r.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=r.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=r.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=r.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=r.fadeDuration,t.antialiasingEnabled=r.antialiasingEnabled,t.physicallyBasedRenderingEnabled=r.physicalBasedRenderingEnabled,t.highQualityTransparency=r.highQualityTransparency,t.highResolutionAtmosphere=r.highResolutionAtmosphere,t.reflections=r.reflections,t.ambientOcclusion=r.ambientOcclusion,t.maxTexturePixels=r.maxTexturePixels,t.memoryLimit=r.memoryLimit,t.additionalCacheMemory=r.additionalCacheMemory,t.frameRate=r.frameRate,t.maximumPixelRatio=r.maximumPixelRatio}static{this.test={reset(){const e=n();for(const t of Object.keys(e))s[t]=e[t]}}}}const i={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430},s=n();function n(){const r=!!e("esri-mobile"),s=!!e("ios"),n=t.Milliseconds(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5}},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:t.Milliseconds(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:r?1048576:4194304,memoryLimit:200+i.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:r?.8:1,polylineLodFactor:r?1.2:1.5,snapshotAvailable:!s,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!e("disable-feature:reduce-map-tile-levels")},fadeDuration:n,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:r?4194304:4096**2,memoryLimit:r?600+i.GalaxyS20:750+i.FullHD,additionalCacheMemory:r?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:r?1.2:2,polylineLodFactor:r?1.2:2,snapshotAvailable:!s,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!e("disable-feature:reduce-map-tile-levels")},fadeDuration:n,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,maxTexturePixels:r?4096**2:1/0,memoryLimit:r?900+i.SurfacePro7:1500+i.FullHDRetina,additionalCacheMemory:r?-150:0,frameRate:0,maximumPixelRatio:r?1:1/0}}}return r})},"esri/views/3d/support/popupHitTest":function(){define(["exports","../../../layers/support/layerUtils","../../support/hitTestSelectUtils"],function(e,t,r){"use strict";const i={layerUids:new Set,layerViews:[]};e.popupHitTest=async function(e,s){const{results:n,ground:o}=await r.hitTestSelectSimilarDistance(e,s),a=(!o.layer||!t.isIntegratedMeshLayer(o.layer.type))&&o.mapPoint,l=[],c=function(e){const t=new Map;for(const r of e.allLayerViews){const e=r.layer.uid;t.set(e,r)}return t}(e),u=a?function(e,t){const r=new Set,i=new Set;for(let t=e.basemapTerrain.numLayers(1)-1;t>=0;t--){const s=e.basemapTerrain.layerViewByIndex(t,1);r.add(s.layer.uid),i.add(s)}const s=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:e}of s){const s=t.get(e);s&&(r.add(e),i.add(s))}return{layerUids:r,layerViews:Array.from(i).reverse()}}(e,c):i;let d=0,h=0;const p=()=>{const e=u.layerViews[h];a&&e&&"fetchPopupFeaturesAtLocation"in e&&l.push({mapPoint:o.mapPoint,layerView:e}),++h};let f=null;for(;d<n.length||h<u.layerViews.length;){const t=n[d];if(t&&"graphic"!==t.type)++d;else if("scene"!==t?.layer?.type||t?.layer?.parent!==e?.map?.basemap)if(t){const e=t.layer?.uid,r=u.layerUids.has(e)&&t.distance===o.distance,i=c.get(t.layer?.uid);if(f??=t.mapPoint,h<u.layerViews.length&&(r||(t.distance??0)>o.distance)&&u.layerViews[h]!==i){p();continue}l.push({graphic:t.graphic,layerView:i}),++d}else p();else++d}return f??=o.mapPoint,{hits:l,location:f}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/hitTestSelectUtils":function(){define(["exports"],function(e){"use strict";function t(e){return"graphic"===e?.type}e.filterGraphicHits=function(e){return e.filter(t)},e.findFirstGraphicHit=function(e){return e.find(t)??null},e.hitTestSelectSimilarDistance=async function(e,t){if("2d"===e.type)return e.hitTest(t);const r=await e.hitTest(t);if(0===r.results.length)return r;const i=r.results[0],s=1.05*(i.distance??0),n=r.results.findIndex(e=>(e.distance??0)>s);return-1!==n&&(r.results=r.results.slice(0,n)),i&&r.ground.distance>s&&(r.ground.mapPoint=null),r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/QualitySettings":function(){define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";let l=class extends t{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};e.__decorate([i.property()],l.prototype,"minTotalNumberOfFeatures",void 0),e.__decorate([i.property()],l.prototype,"maxTotalNumberOfFeatures",void 0),e.__decorate([i.property()],l.prototype,"maxNumberOfDrawCalls",void 0),e.__decorate([i.property()],l.prototype,"maxTotalNumberOfVertices",void 0),e.__decorate([i.property()],l.prototype,"snapshotAvailable",void 0),e.__decorate([i.property()],l.prototype,"polygonLodFactor",void 0),e.__decorate([i.property()],l.prototype,"polylineLodFactor",void 0),e.__decorate([i.property()],l.prototype,"skipHighSymbolLods",void 0),l=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings.Graphics3DSettings")],l);let c=class extends t{constructor(){super(...arguments),this.lodFactor=1}};e.__decorate([i.property()],c.prototype,"lodFactor",void 0),c=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings.LoDFactorSettings")],c);let u=class extends t{constructor(){super(...arguments),this.object=new c,this.point=new c,this.integratedMesh=new c,this.pointCloud=new c}};e.__decorate([i.property({type:c})],u.prototype,"object",void 0),e.__decorate([i.property({type:c})],u.prototype,"point",void 0),e.__decorate([i.property({type:c})],u.prototype,"integratedMesh",void 0),e.__decorate([i.property({type:c})],u.prototype,"pointCloud",void 0),u=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings.SceneServiceSettings")],u);let d=class extends t{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};e.__decorate([i.property()],d.prototype,"lodBias",void 0),e.__decorate([i.property()],d.prototype,"angledSplitBias",void 0),e.__decorate([i.property()],d.prototype,"vtlContentZoom",void 0),e.__decorate([i.property()],d.prototype,"elevationLevelDelta",void 0),e.__decorate([i.property()],d.prototype,"reduceTileLevelDifferences",void 0),d=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],d);let h=class extends t{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};e.__decorate([i.property()],h.prototype,"pixelRatio",void 0),e.__decorate([i.property()],h.prototype,"maxTotalNumberOfFeatures",void 0),h=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings.HeatmapSettings")],h);let p=class extends t{constructor(){super(...arguments),this.graphics3D=new l,this.sceneService=new u,this.tiledSurface=new d,this.heatmap=new h,this.fadeDuration=r.Milliseconds(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.bloom=!1,this.maxTexturePixels=1/0,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};return e.__decorate([i.property({type:l})],p.prototype,"graphics3D",void 0),e.__decorate([i.property({type:u})],p.prototype,"sceneService",void 0),e.__decorate([i.property({type:d})],p.prototype,"tiledSurface",void 0),e.__decorate([i.property({type:h})],p.prototype,"heatmap",void 0),e.__decorate([i.property()],p.prototype,"fadeDuration",void 0),e.__decorate([i.property()],p.prototype,"antialiasingEnabled",void 0),e.__decorate([i.property()],p.prototype,"physicallyBasedRenderingEnabled",void 0),e.__decorate([i.property()],p.prototype,"highQualityTransparency",void 0),e.__decorate([i.property()],p.prototype,"highResolutionAtmosphere",void 0),e.__decorate([i.property()],p.prototype,"reflections",void 0),e.__decorate([i.property()],p.prototype,"ambientOcclusion",void 0),e.__decorate([i.property()],p.prototype,"bloom",void 0),e.__decorate([i.property()],p.prototype,"maxTexturePixels",void 0),e.__decorate([i.property()],p.prototype,"memoryLimit",void 0),e.__decorate([i.property()],p.prototype,"additionalCacheMemory",void 0),e.__decorate([i.property()],p.prototype,"frameRate",void 0),e.__decorate([i.property()],p.prototype,"maximumPixelRatio",void 0),p=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings")],p),p})},"esri/views/3d/support/RenderCoordsHelper":function(){define(["exports","../../../core/mathUtils","../../../core/unitUtils","../../../core/libs/gl-matrix-2/math/mat4","../../../chunks/vec32","../../../geometry/ellipsoidUtils","../../../geometry/spatialReferenceEllipsoidUtils","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectVectorToPoint","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingRect","../../../geometry/support/coordinateSystem","../../../geometry/support/plane","../../../geometry/support/vector","../../../geometry/support/vectorStacks","../../../layers/graphics/dehydratedFeatureUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";class g{constructor(e,t,r,i){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=r,this._coordinateSystem=i,this._tmpCoordinateSystem=d.create(i),this.referenceEllipsoid=n.getReferenceEllipsoid(t),this.sphericalPCPF=o.getSphericalPCPF(t)}set extent(e){e&&d.setExtent(this._coordinateSystem,e,this._coordinateSystem)}get extent(){return d.getExtent(this._coordinateSystem,u.create())}getAltitude(e){return d.altitudeAt(this._coordinateSystem,e)}setAltitude(e,t,r=e){return d.setAltitudeAt(this._coordinateSystem,r,t,e)}setAltitudeOfTransformation(e,t){d.setAltitudeOfTransformation(this._coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return d.normalAt(this._coordinateSystem,e,t)}worldBasisAtPosition(e,t,r){return d.axisAt(this._coordinateSystem,e,t,r)}basisMatrixAtPosition(e,t){const r=this.worldBasisAtPosition(e,0,f.sv3d.get()),s=this.worldBasisAtPosition(e,1,f.sv3d.get()),n=this.worldBasisAtPosition(e,2,f.sv3d.get());return i.set(t,r[0],r[1],r[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1),t}headingAtPosition(e,r){const i=this.worldUpAtPosition(e,f.sv3d.get()),s=this.worldBasisAtPosition(e,1,f.sv3d.get()),n=p.angleAroundAxis(r,s,i);return t.rad2deg(n)}intersectManifoldClosestSilhouette(e,t,r){return d.elevate(this._coordinateSystem,t,this._tmpCoordinateSystem),d.intersectRayClosestSilhouette(this._tmpCoordinateSystem,e,r),r}intersectManifold(e,t,r){d.elevate(this._coordinateSystem,t,this._tmpCoordinateSystem);const i=f.sv3d.get();return d.intersectRay(this._tmpCoordinateSystem,e,i)?s.copy(r,i):null}intersectInfiniteManifold(e,t,r){if(1===this.viewingMode)return this.intersectManifold(e,t,r);d.elevate(this._coordinateSystem,t,this._tmpCoordinateSystem);const i=this._tmpCoordinateSystem.value,n=f.sv3d.get();return h.intersectRay(i.plane,e,n)?s.copy(r,n):null}toRenderCoords(e,t,r){return m.isDehydratedPoint(e)?a.projectPointToVector(e,t,this.spatialReference):c.projectVectorToVector(e,t,r,this.spatialReference)}fromRenderCoords(e,t,r=null){return m.isDehydratedPoint(t)?(null!=r&&(t.spatialReference=r),l.projectVectorToPoint(e,this.spatialReference,t)?t:null):c.projectVectorToVector(e,this.spatialReference,t,r)?t:null}static create(e,t){switch(e){case 2:return new g(2,t,r.getMetersPerUnitForSR(t),d.createLocal());case 1:return new g(1,t,1,d.createGlobal(t))}}static renderUnitScaleFactor(e,t){return r.getMetersPerCartesianUnitForSR(e)/r.getMetersPerCartesianUnitForSR(t)}}e.RenderCoordsHelper=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/ResourceController":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/handleUtils","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/scheduling","../../../core/signal","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./downloadSlots","./MemoryController","./StreamDataLoader","./StreamDataRequester","../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";let b=class extends r{constructor(){super(...arguments),this.updating=!1}};t.__decorate([u.property({readOnly:!0})],b.prototype,"updating",void 0),b=t.__decorate([p.subclass("esri.views.3d.support.ResourceController.ResourceControllerMain")],b);let v=class extends b{constructor(){super(...arguments),this._immediateTask=_.ImmediateTask,this._normalTask=_.ImmediateTask,this._updatingObjects=l.signal([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=_.newScheduler(),this._memoryController=m.newMemoryController(this.view),this._streamDataLoader=new g.StreamDataLoader,this._streamDataLoader.setup(f.maxDownloadSlots,f.downloadSlotsPerClient,this._scheduler),this.addHandles([o.watch(()=>this.view.state?.mode,e=>{null!=e&&(this._scheduler.state=e)},o.sync),o.watch(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=a.addFrameTask({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(_.TaskPriority.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(_.TaskPriority.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=n.removeMaybe(this._frameTask),this._streamDataLoader=n.destroyMaybe(this._streamDataLoader),this._memoryController=n.destroyMaybe(this._memoryController),this._scheduler=n.destroyMaybe(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some(e=>e.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){return new y.StreamDataRequesterImpl(this._streamDataLoader,e)}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],i.makeHandle(()=>{t.value=t.value.filter(t=>t!==e)})}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(c.secondsFromMilliseconds(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.frame(e))}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};t.__decorate([u.property()],v.prototype,"view",void 0),t.__decorate([u.property()],v.prototype,"_scheduler",void 0),t.__decorate([u.property()],v.prototype,"_memoryController",void 0),t.__decorate([u.property()],v.prototype,"_streamDataLoader",void 0),t.__decorate([u.property()],v.prototype,"_immediateTask",void 0),t.__decorate([u.property()],v.prototype,"_normalTask",void 0),t.__decorate([u.property({readOnly:!0})],v.prototype,"updating",null),v=t.__decorate([p.subclass("esri.views.3d.support.ResourceController")],v),e.newResourceController=function(e){return new v({view:e})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/downloadSlots":function(){define(["exports"],function(e){"use strict";const t=(()=>{const e=new Array;return e[0]=10,e[1]=10,e[2]=10,e[3]=10,e[4]=5,e})();e.downloadSlotsPerClient=t,e.maxDownloadSlots=30,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/MemoryController":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/Logger","../../../core/MemCache","../../../core/scheduling","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./MemoryManagedView","../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";const p=!!i("esri-tests-disable-memory-pools");let f=class extends r{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._predictedMemory=0,this._cacheStorage=new n.MemCacheStorage,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=p?4096:750,this._additionalCacheMemory=p?-4096:0,this.addHandles(o.addFrameTask({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||p||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null==e||p||(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t,r){return new n.MemCache(e,this._cacheStorage,t,r)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._predictedMemory<=0&&!this._updating)return;let e=this._layersUpdating();if(this._predictedMemory<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e){if(this._predictedMemory>1.1||this._usedMemory>1)if(this._stableQuality>0)this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality);else if(this._quality>.1&&this._downscaleMemoryUsed<this._usedMemory){if(this._compactAndUpdate())return;this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1}}else if(this._downscaleMemoryUsed=0,this._usedMemory>1){if(this._compactAndUpdate())return;this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._predictedMemory}else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_compactAndUpdate(){const e=h.makeBudget(a.Milliseconds(100)),t=this.view.stage.compact(e);return this.view.basemapTerrain.overlayManager.renderer.compact(e)||t}_updateQuality(e){return(e=Math.min(Math.max(e,.1),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){if(!this.view||this.view.destroyed||this.view.destroying)return;this.view.stage?.renderer?.tick();const e=this.view.stage?.renderer?.usedMemory;let t=(this.view.basemapTerrain?.usedMemory??0)+(e?e.fbos+e.edges+e.plugins:0)+this.view.labeler?.usedMemory,r=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(e=>{if(d.isMemoryManagedView(e)){const i=e.ignoresMemoryFactor?this._quality:1;t+=e.usedMemory*i,r+=e.unloadedMemory*i}});const i=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),n=1048576*this.maxMemory;if(t>n&&i){this._warnMemoryUsage=t;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",i=Math.round(100*this._quality);s.getLogger(this).warn(`Memory Limit exceeded! Limit: ${e(n)} Current: ${e(t)} Projected: ${e(t+r)} Quality: ${i}%`)}this._usedMemory=t/n,this._predictedMemory=(t+r)/n;const o=n-t;this._cacheStorage.maxSize=Math.max(0,o+1048576*this.additionalCacheMemory)}get test(){}};t.__decorate([l.property({constructOnly:!0})],f.prototype,"view",void 0),t.__decorate([l.property()],f.prototype,"maxMemory",null),t.__decorate([l.property()],f.prototype,"additionalCacheMemory",null),t.__decorate([l.property({readOnly:!0})],f.prototype,"memoryFactor",null),t.__decorate([l.property({readOnly:!0})],f.prototype,"updating",null),t.__decorate([l.property({readOnly:!0})],f.prototype,"usedMemory",null),t.__decorate([l.property({readOnly:!0})],f.prototype,"usedCacheMemory",null),t.__decorate([l.property()],f.prototype,"_quality",void 0),t.__decorate([l.property()],f.prototype,"_usedMemory",void 0),t.__decorate([l.property()],f.prototype,"_updating",void 0),t.__decorate([l.property()],f.prototype,"_stableQuality",void 0),t.__decorate([l.property()],f.prototype,"_maxMemory",void 0),t.__decorate([l.property()],f.prototype,"_additionalCacheMemory",void 0),f=t.__decorate([u.subclass("esri.views.3d.support.MemoryController")],f),e.minQuality=.1,e.newMemoryController=function(e){return new f({view:e})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/MemoryManagedView":function(){define(["exports"],function(e){"use strict";e.isMemoryManagedView=function(e){return"usedMemory"in e&&"unloadedMemory"in e&&"ignoresMemoryFactor"in e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/StreamDataLoader":function(){define(["exports","../../../chunks/tslib.es6","../../../request","../../../core/Accessor","../../../core/arrayUtils","../../../core/Error","../../../core/has","../../../core/lang","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","./AsyncWorkerQueue","./ImageWithType","../terrain/TerrainData","../webgl-engine/lib/Util","../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y){"use strict";e.StreamDataLoader=class extends i{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,r){this._loadQueue=new p.AsyncWorkerQueue((e,t)=>this._startLoading(e,t),(e,t)=>this._doneLoadingCB(e,t),e,t),r&&(this._frameTask=r.registerTask(y.TaskPriority.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=l.removeMaybe(this._frameTask),this._tasks.forEach(e=>l.abortMaybe(e.abortController)),this._loadQueue=l.destroyMaybe(this._loadQueue),this._onLoadQueue.length=0,this._onLoadQueue=null,this._doneQueue.length=0,this._doneQueue=null,this._tasks.forEach(e=>e.destroy()),this._tasks.clear(),this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,r,i={}){const s=c.createResolver();return s.__signal=null!=i?i.signal:null,this._createOrUpdateTask(e,t,r,i,s),s.promise}_createTask(e,t,r,i,s,n){const o=new b(e,t,r,i,s);return this._updateTask(o,n),this._tasks.set(s,o),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){const r=this._tasks.get(e);r&&(s.removeUnordered(r.resolvers,t),t.reject(c.createAbortError()),0===r.resolvers.length&&(2===r.status&&this._loadQueue.cancel(r),r.status=4,this._removeTask(r)))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,r,i,s){const n=function(e,t,r){return`${e}:${t}:${r}`}(i?.uid||e,t,r);let o=this._tasks.get(n);o?this._updateTask(o,s):(o=this._createTask(e,i,t,r,n,s),o.abortHandle=c.onAbort(i,()=>this._cancelRequest(n,s)))}_doneLoadingCB(e,t){this._loadQueue&&(g.assert(2===e.status),e.status=3,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get readyToRun(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();c.throwIfAborted(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();3!==t.task.status&&(t.err=t.err||c.createAbortError()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!c.isAbortError(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let r=m.isImageWithType(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const i of e.resolvers)if(t)c.isAbortError(t)?i.reject(t):i.reject(new n("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--r;const t=r>0?a.clone(e.result):e.result;i.resolve(t)}this._removeTask(e)}_removeTask(e){this._tasks.delete(e.key),e.destroy(),0===this._tasks.size&&this._set("updating",!1)}_startLoading(e,t){if(4===e.status)return!1;let i,s;switch(e.startTime=performance.now(),e.status=2,e.docType){case 1:s="array-buffer",i=0;break;case 2:s="image";break;case 3:s="array-buffer";break;default:s="json"}e.abortController=new AbortController;const n=e.abortController.signal;e.request=r(e.url,{...e.options,responseType:s,timeout:i,signal:n});const o=r=>{e.duration=performance.now()-e.startTime,e.size=r instanceof ArrayBuffer?r.byteLength:e.size||0,e.result=r,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=r=>{2===e.status&&t(e,r)};return 3!==e.docType?(e.request.then(e=>o(e.data),a),!0):(e.request.then(t=>{const l=t.data,c=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(l);if(s="image",e.size=l.byteLength,"unknown"===c)return e.request=r(e.url,{responseType:s,timeout:i,signal:n}),void e.request.then(e=>o(e.data),a);const u=new Blob([l],{type:c}),d=window.URL.createObjectURL(u);e.request=r(d,{responseType:s,timeout:i,signal:n}),e.request.then(e=>o(new f.ImageWithType(e.data,c)),a).finally(()=>window.URL.revokeObjectURL(d))},a),!0)}get test(){}},t.__decorate([u.property({readOnly:!0})],e.StreamDataLoader.prototype,"updating",void 0),e.StreamDataLoader=t.__decorate([h.subclass("esri.views.3d.support.StreamDataLoader")],e.StreamDataLoader);const _={numRetries:0};class b extends p.BaseTask{constructor(e,t,r,i,s){super(i),this.url=e,this.options=t,this.docType=r,this.key=s,this.abortHandle=null,this.result=null,this.status=1,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=_.numRetries}destroy(){this.result=null,this.request=null,this.abortController?.abort(),this.abortController=null,this.resolvers.length=0,this.options=null,this.abortHandle=l.removeMaybe(this.abortHandle)}}e.test=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/AsyncWorkerQueue":function(){define(["exports","../../../core/has","../webgl-engine/lib/Util"],function(e,t,r){"use strict";class i{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new s}}class s{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}e.AsyncWorkerQueue=class{constructor(e,t,r,s){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=r,this._totalNumWorkers=0,this._clients=s.map(e=>new i(e))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(e,t)=>this._taskCallback(e,t))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,r.assert(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(e,t)=>this._taskCallback(e,t)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}},e.BaseTask=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/ImageWithType":function(){define(["exports"],function(e){"use strict";e.ImageWithType=class{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque="image/jpeg"===t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TerrainData":function(){define(["exports"],function(e){"use strict";e.isImageWithType=function(e){return null!=e&&"type"in e&&"image+type"===e.type},e.isRasterTile=function(e){return null!=e&&"type"in e&&"raster-tile"===e.type},e.isTileTexture=function(e){return null!=e&&"type"in e&&"tile-texture"===e.type},e.isVectorTile=function(e){return null!=e&&"type"in e&&"vector-tile"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/StreamDataRequester":function(){define(["exports"],function(e){"use strict";e.StreamDataRequesterImpl=class{constructor(e,t){this._loader=e,this._clientType=t}request(e,t,r={}){return this._loader.request(e,t,this._clientType,r)}get busy(){return!this._loader.hasDownloadSlots(this._clientType)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/SceneViewPerformanceInfo":function(){define(["../layers/support/LayerViewPerformanceInfo","./LayerPerformanceInfo"],function(e,t){"use strict";return class{constructor(r){if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,null!=r.resourceController){const e=r.resourceController.memoryController;this.totalMemory=1048576*(e.maxMemory??0),this.usedMemory=Math.round(e.usedMemory*this.totalMemory),this.quality=r.quality,this.load=r.resourceController.scheduler.load,this.cachedMemory=e.usedCacheMemory}this.terrainMemory=r.basemapTerrain?.usedMemory??0,this.edgesMemory=r.stage?.renderer.usedMemory.edges??0,this.fboMemory=r.stage?.renderer.usedMemory.fbos??0,r.allLayerViews?.items.forEach(r=>{e.isPerformanceInfoLayerView(r)&&this.layerPerformanceInfos.push(new t(r))}),this.layerPerformanceInfos.sort((e,t)=>t.memory-e.memory)}}})},"esri/views/3d/layers/support/LayerViewPerformanceInfo":function(){define(["exports"],function(e){"use strict";e.LayerViewPerformanceInfo=class{constructor(e,t=0,r=0,i=0,s=0,n=null){this.usedMemory=e,this.displayedFeatures=t,this.totalFeatures=r,this.maximumFeatures=i,this.nodes=s,this.core=n}},e.isPerformanceInfoLayerView=function(e){return"performanceInfo"in e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/LayerPerformanceInfo":function(){define(function(){"use strict";return class{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}}})},"esri/views/3d/support/SharedSymbolResources":function(){define(["exports","../../../core/arrayUtils","../../../core/Handles","../../../core/handleUtils","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../geometry/ellipsoidUtils","../layers/graphics/ObjectResourceCache","./StreamTextureCollection","../webgl-engine/lib/screenSizePerspectiveUtils"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d={distance:0,fovY:0};e.SharedSymbolResources=class{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(4),this.objectResourceCache=new l.ObjectResourceCache((t,r)=>e.resourceController.memoryController.newCache(t,r)),this.textures=new c.StreamTextureCollection(this.streamDataRequester,e.view.stage,e.resourceController.scheduler);const t=a.getReferenceEllipsoid(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=u.getSettings(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=u.getLabelSettings(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return i.makeHandle();this._graphicsOwners.push(e);const r=o.watch(()=>e.layer?.screenSizePerspectiveEnabled,()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),i.makeHandle(()=>{r.remove(),t.removeUnordered(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some(e=>!0===e.layer?.screenSizePerspectiveEnabled);if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new r;const e=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([o.watch(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,e,o.sync),this._viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=n.destroyMaybe(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;d.distance=e.centerOnSurfaceInfrequent.distance,d.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(d),this.screenSizePerspectiveSettingsLabels.update(d),this._view.stage.renderView.requestRender()}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/ObjectResourceCache":function(){define(["require","exports","../../../../core/maybe","../../../../core/promiseUtils","../../glTF/DefaultLoadingContext","./wosrLoader"],function(e,t,r,i,s,n){"use strict";async function o(e,t,s,n,o){i.throwIfAborted(o);const a=i.onAbort(o,()=>function(e,t){const r=e.get(t);null!=r&&--r.refCount>0||(e.delete(t),null!=r&&r.abortController.abort())}(e,s));let l=e.get(s);if(l)l.refCount++;else{const t=new AbortController;l={refCount:1,abortController:t,promise:n({...o,signal:t.signal})},e.set(s,l)}try{const r=await l.promise;return t.put(s,r),e.delete(s),i.throwIfAborted(o),r}finally{r.removeMaybe(a)}}t.ObjectResourceCache=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",()=>{}),this._wosrMemCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(t,r,i){const n=i?`gltfPBR:${t}`:`gltf:${t}`,a=this._gltfMemCache.get(n);return null!=a?Promise.resolve(a):o(this._gltfLoading,this._gltfMemCache,n,async r=>{const{loadGLTF:n}=await new Promise((t,r)=>e(["../../glTF/loader"],t,r));return n(new s.DefaultLoadingContext(r.streamDataRequester),t,r,i)},r)}loadWOSR(e,t){const r=`wosr:${e}:${t.disableTextures}`,i=this._wosrMemCache.get(r);return null!=i?Promise.resolve(i):o(this._wosrLoading,this._wosrMemCache,r,t=>n.load(e,t),t)}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/glTF/DefaultLoadingContext":function(){define(["exports","../../../request","../../../core/asyncUtils","../../../core/Error","../../../core/promiseUtils","../../../core/urlUtils"],function(e,t,r,i,s,n){"use strict";const o={2:"image",1:"array-buffer",0:"json",3:void 0};e.DefaultLoadingContext=class{constructor(e){this._streamDataRequester=e}async loadJSON(e,t){return this._load(0,e,t)}async loadBinary(e,t){return n.isDataProtocol(e)?(s.throwIfAborted(t),n.dataToArrayBuffer(e)):this._load(1,e,t)}async loadImage(e,t){return this._load(2,e,t)}async _load(e,n,a){if(null==this._streamDataRequester)return(await t(n,{responseType:o[e]})).data;const l=await r.result(this._streamDataRequester.request(n,e,a));if(!0===l.ok)return l.value;throw s.throwIfAbortError(l.error),new i("glt-loader-request-error",`Request for resource failed: ${l.error}`)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/wosrLoader":function(){define(["exports","../../../../request","../../../../core/asyncUtils","../../../../core/Error","../../../../core/Logger","../../../../core/memoryEstimations","../../../../core/NestedMap","../../../../core/promiseUtils","../../../../core/Version","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/Indices","../../../../support/requestImageUtils","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g){"use strict";const y=()=>s.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class _{constructor(e,t,r){this.resource=e,this.textures=t,this.cachedMemory=r}}function b(e){throw new i("",`Request for object resource failed: ${e}`)}function v(e){const t=e.params,r=t.topology;let i=!0;switch(t.vertexAttributes||(y().warn("Geometry must specify vertex attributes"),i=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const e=t.faces;if(e){if(t.vertexAttributes)for(const r in t.vertexAttributes){const t=e[r];t?.values?(null!=t.valueType&&"UInt32"!==t.valueType&&(y().warn(`Unsupported indexed geometry indices type '${t.valueType}', only UInt32 is currently supported`),i=!1),null!=t.valuesPerElement&&1!==t.valuesPerElement&&(y().warn(`Unsupported indexed geometry values per element '${t.valuesPerElement}', only 1 is currently supported`),i=!1)):(y().warn(`Indexed geometry does not specify face indices for '${r}' attribute`),i=!1)}}else y().warn("Indexed geometries must specify faces"),i=!1;break}default:y().warn(`Unsupported topology '${r}'`),i=!1}e.params.material||(y().warn("Geometry requires material"),i=!1);const s=e.params.vertexAttributes;for(const e in s)s[e].values||(y().warn("Geometries with externally defined attributes are not yet supported"),i=!1);return i}function w(e){const t=u.empty();return e.forEach(e=>{const r=e.boundingInfo;null!=r&&(u.expandWithVec3(t,r.bbMin),u.expandWithVec3(t,r.bbMax))}),t}async function x(e,t){const r=new Array;for(const i in e){const s=e[i],n=s.images[0].data;if(!n){y().warn("Externally referenced texture data is not yet supported");continue}const o=s.encoding+";base64,"+n,a="/textureDefinitions/"+i,l="rgba"===s.channels?s.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:1!==S(l)},u=t?.disableTextures?Promise.resolve(null):h.requestImage(o,t);r.push(u.then(e=>({refId:a,image:e,parameters:c,alphaChannelUsage:l})))}const i=await Promise.all(r),s={};for(const e of i)s[e.refId]=e;return s}function S(e){switch(e){case"mask":return 2;case"maskAndTransparency":return 3;case"none":return 1;default:return 0}}function T(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const C=new l.Version(1,2,"wosr");e.LoaderResultWOSR=_,e.createTextureResources=x,e.load=async function(e,i){const s=await async function(e,i){const s=i?.streamDataRequester;if(s)return async function(e,t,i){const s=await r.result(t.request(e,0,i));return!0===s.ok?s.value:(a.throwIfAbortError(s.error),void b(s.error.details.url))}(e,s,i);const n=await r.result(t(e,i));return!0===n.ok?n.value.data:(a.throwIfAbortError(n.error),void b(n.error))}(e,i),o=await x(s.textureDefinitions??{},i);let l=0;for(const e in o)if(o.hasOwnProperty(e)){const t=o[e];l+=t?.image?t.image.width*t.image.height*4:0}return new _(s,o,l+n.estimateNestedObjectMemory(s))},e.processLoadResult=function(e,t){const r=new Array,i=new Array,s=new Array,n=new o.NestedMap,a=e.resource,u=l.Version.parse(a.version||"1.0","wosr");C.validate(u);const h=a.model.name,y=a.model.geometries,_=a.materialDefinitions??{},b=e.textures;let x=0;const P=new Map;for(let e=0;e<y.length;e++){const o=y[e];if(!v(o))continue;const a=T(o),l=o.params.vertexAttributes,u=[],h=e=>{if("PerAttributeArray"===o.params.topology)return null;const t=o.params.faces;for(const r in t)if(r===e)return t[r].values;return null},w=l.position,C=w.values.length/w.valuesPerElement;for(const e in l){const t=l[e],r=t.values,i=h(e)??d.getContinuousIndexArray(C);u.push([e,new p.Attribute(r,i,t.valuesPerElement,!0)])}const M=a.texture,R=b&&b[M];if(R&&!P.has(M)){const{image:e,parameters:t}=R,r=new m.Texture(e,t);i.push(r),P.set(M,r)}const O=P.get(M),I=O?O.id:void 0,F=a.material;let A=n.get(F,M);if(null==A){const e=_[F.slice(F.lastIndexOf("/")+1)].params;1===e.transparency&&(e.transparency=0);const r=R?S(R.alphaChannelUsage):void 0,i={ambient:c.fromArray(e.diffuse),diffuse:c.fromArray(e.diffuse),opacity:1-(e.transparency||0),textureAlphaMode:r,textureAlphaCutoff:.33,textureId:I,doubleSided:!0,cullFace:0,colorMixMode:e.externalColorMixMode||"tint",textureAlphaPremultiplied:R?.parameters.preMultiplyAlpha??!1};t?.materialParameters&&Object.assign(i,t.materialParameters),A=new g.DefaultMaterial(i,t),n.set(F,M,A)}s.push(A);const D=new f.Geometry(A,u);x+=u.find(e=>"position"===e[0])?.[1]?.indices.length??0,r.push(D)}return{engineResources:[{name:h,stageResources:{textures:i,materials:s,geometries:r},pivotOffset:a.model.pivotOffset,numberOfVertices:x,lodThreshold:null}],referenceBoundingBox:w(r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/NestedMap":function(){define(["exports"],function(e){"use strict";e.NestedMap=class{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return 0===this._outer.size}get outerSize(){return this._outer.size}get(e,t){return this._outer.get(e)?.get(t)}getInner(e){return this._outer.get(e)}set(e,t,r){const i=this._outer.get(e);i?i.set(t,r):this._outer.set(e,new Map([[t,r]]))}delete(e,t){const r=this._outer.get(e);r&&(r.delete(t),0===r.size&&this._outer.delete(e))}forEach(e){this._outer.forEach((t,r)=>e(t,r))}forAll(e){this._outer.forEach((t,r)=>t.forEach((t,i)=>e(t,r,i)))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/support/requestImageUtils":function(){define(["exports","../request"],function(e,t){"use strict";e.requestImage=async function(e,r){const{data:i}=await t(e,{responseType:"image",...r});return i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Texture":function(){define(["exports","../../../../core/has","../../../../core/Error","../../../../core/Evented","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/typedArrayUtil","../../../../core/uid","../../../../core/urlUtils","../../../../layers/support/videoUtils","../../../../support/requestImageUtils","../../../../support/requestUtils","./BasisUtil","./DDSUtil","./textureUtils","./Util","../../../webgl/Texture","../../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y){"use strict";function _(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}const b={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};e.Texture=class{constructor(e,t){this._data=e,this.id=a.generateUID(),this.events=new i.EventEmitter,this._parameters={...b,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(e){e instanceof HTMLVideoElement?(this.update=t=>this._update(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e)}_startPreloadVideoElement(e){if(!(l.isBlobProtocol(e.src)||"auto"===e.preload&&e.crossOrigin)&&(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src,e.paused&&e.autoplay)){const t=[];c.whenVideoPlayable(e,e=>t.push(e)).then(()=>{e.play()}).finally(()=>t.forEach(e=>e.remove()))}}_startPreloadImageElement(e){l.isDataProtocol(e.src)||l.isBlobProtocol(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const t=new y.TextureDescriptor;return t.wrapMode=this._parameters.wrap??10497,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?9987:9729,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return null!=this._glTexture}get usedMemory(){return this._glTexture?.usedMemory||function(e,t){if(null==e)return 0;if(o.isArrayBuffer(e)||o.isUint8Array(e))return"image/ktx2"===t.encoding?h.estimateMemoryKTX2(e,!!t.mipmap):"image/x.basis"===t.encoding?h.estimateMemoryBasis(e,!!t.mipmap):e.byteLength;const{width:r,height:i}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?_(e):t;return(t.mipmap?4/3:1)*r*i*(t.components||4)||0}(this._data,this._parameters)}load(e){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const t=this._data;return null==t?(this._glTexture=new g.Texture(e,this._createDescriptor(e),null),this._glTexture):(this._emptyTexture=e.emptyTexture,this._parameters.reloadable||(this._data=void 0),"string"==typeof t?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):o.isUint8Array(t)&&"image/vnd-ms.dds"===this._parameters.encoding?this._loadFromDDSData(e,t):o.isArrayBuffer(t)&&"image/vnd-ms.dds"===this._parameters.encoding?this._loadFromDDSData(e,new Uint8Array(t)):(o.isArrayBuffer(t)||o.isUint8Array(t))&&"image/ktx2"===this._parameters.encoding?this._loadFromKTX2(e,t):(o.isArrayBuffer(t)||o.isUint8Array(t))&&"image/x.basis"===this._parameters.encoding?this._loadFromBasis(e,t):o.isUint8Array(t)?this._loadFromPixelData(e,t):o.isArrayBuffer(t)?this._loadFromPixelData(e,new Uint8Array(t)):null)}_update(e,t){return null==this._glTexture||e.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=p.createDDSTexture(e,this._createDescriptor(e),t),this._emptyTexture=null,this._glTexture}_loadFromKTX2(e,t){return this._loadAsync(()=>h.createTextureKTX2(e,this._createDescriptor(e),t).then(e=>(this._glTexture=e,e)))}_loadFromBasis(e,t){return this._loadAsync(()=>h.createTextureBasis(e,this._createDescriptor(e),t).then(e=>(this._glTexture=e,e)))}_loadFromPixelData(e,t){m.assert(this._parameters.width>0&&this._parameters.height>0);const r=this._createDescriptor(e);return r.pixelFormat=1===this._parameters.components?6409:3===this._parameters.components?6407:6408,6407!==r.pixelFormat&&6408!==r.pixelFormat||(r.compress=this._parameters.compressionOptions),r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new g.Texture(e,r,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync(async r=>{const i=await u.requestImage(t,{signal:r});return n.throwIfAborted(r),this._loadFromImage(e,i)})}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync(async r=>{const i=await d.loadImageAsync(t,t.src,!1,r);return n.throwIfAborted(r),this._loadFromImage(e,i)})}_loadFromVideoElement(e,t){return t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync(i=>new Promise((o,a)=>{const l=()=>{t.removeEventListener("loadeddata",c),t.removeEventListener("error",u),s.removeMaybe(d)},c=()=>{t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(l(),o(this._loadFromImage(e,t)))},u=e=>{l(),a(e||new r("texture:load-error","Failed to load video"))};t.addEventListener("loadeddata",c),t.addEventListener("error",u);const d=n.onAbort(i,()=>u(n.createAbortError()))}))}_loadFromImage(e,t){let r=t;r instanceof HTMLVideoElement||(r=f.ensureImageMaxSize(r,e.parameters));const i=_(r);this._parameters.width=i.width,this._parameters.height=i.height;const s=this._createDescriptor(e);return s.pixelFormat=3===this._parameters.components?6407:6408,s.width=i.width,s.height=i.height,s.compress=this._parameters.compressionOptions,this._glTexture=new g.Texture(e,s,r),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(e){const t=new AbortController;this._loadingController=t;const r=e(t.signal);this._loadingPromise=r;const i=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null),this._emptyTexture=null};return r.then(i,i),r}unload(){if(this._glTexture=s.disposeMaybe(this._glTexture),this._emptyTexture=null,null!=this._loadingController){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/videoUtils":function(){define(["exports","../../core/events"],function(e,t){"use strict";e.whenVideoPlayable=function(e,r){return new Promise((i,s)=>{e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?i():(r(t.once(e,"canplay",i)),r(t.once(e,"error",s)))})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/BasisUtil":function(){define(["exports","../../../../libs/basisu/BasisUTranscoder","../../../webgl/enums","../../../webgl/Texture","../../../webgl/Util"],function(e,t,r,i,s){"use strict";let n=null,o=null;async function a(){return null==o&&(o=t.getBasisTranscoder(),n=await o),o}function l(e,t,i,n,o){const a=s.getBytesPerElementFormat(t?r.CompressedTextureFormat.COMPRESSED_RGBA8_ETC2_EAC:r.CompressedTextureFormat.COMPRESSED_RGB8_ETC2),l=o&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(i*n*a*l)}function c(e){return e.getNumImages()>=1&&!e.isUASTC()}function u(e){return e.getFaces()>=1&&e.isETC1S()}function d(e,t,s,n,o,a,l,c){const{compressedTextureETC:u,compressedTextureS3TC:d}=e.capabilities,[h,p]=u?n?[1,r.CompressedTextureFormat.COMPRESSED_RGBA8_ETC2_EAC]:[0,r.CompressedTextureFormat.COMPRESSED_RGB8_ETC2]:d?n?[3,r.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,r.CompressedTextureFormat.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],f=t.hasMipmap?s:Math.min(1,s),m=[];for(let e=0;e<f;e++)m.push(new Uint8Array(l(e,h))),c(e,h,m[e]);return t.internalFormat=p,t.hasMipmap=m.length>1,t.samplingMode=t.hasMipmap?9987:9729,t.width=o,t.height=a,new i.Texture(e,t,{type:"compressed",levels:m})}e.checkKTX2=u,e.createTextureBasis=async function(e,t,r){null==n&&(n=await a());const i=new n.BasisFile(new Uint8Array(r));if(!c(i))return null;i.startTranscoding();const s=d(e,t,i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),(e,t)=>i.getImageTranscodedSizeInBytes(0,e,t),(e,t,r)=>i.transcodeImage(r,0,e,t,0,0));return i.close(),i.delete(),s},e.createTextureKTX2=async function(e,t,r){null==n&&(n=await a());const i=new n.KTX2File(new Uint8Array(r));if(!u(i))return null;i.startTranscoding();const s=d(e,t,i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),(e,t)=>i.getImageTranscodedSizeInBytes(e,0,0,t),(e,t,r)=>i.transcodeImage(r,e,0,0,t,0,-1,-1));return i.close(),i.delete(),s},e.estimateMemoryBasis=function(e,t){if(null==n)return e.byteLength;const r=new n.BasisFile(new Uint8Array(e)),i=c(r)?l(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),t):0;return r.close(),r.delete(),i},e.estimateMemoryKTX2=function(e,t){if(null==n)return e.byteLength;const r=new n.KTX2File(new Uint8Array(e)),i=u(r)?l(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),t):0;return r.close(),r.delete(),i},e.loadBasisTranscoder=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/libs/basisu/BasisUTranscoder":function(){define(["require","exports","../../assets"],function(e,t,r){"use strict";let i;t.getBasisTranscoder=function(){return i??=(async()=>{const t=await new Promise((t,r)=>e(["../../chunks/basis_transcoder"],t,r)),i=await t.default({locateFile:e=>r.getAssetUrl(`esri/libs/basisu/${e}`)});return i.initializeBasis(),i})(),i},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/DDSUtil":function(){define(["exports","../../../../core/Logger","../../../webgl/enums","../../../webgl/Texture"],function(e,t,r,i){"use strict";const s=()=>t.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function n(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const o=n("DXT1"),a=n("DXT3"),l=n("DXT5");function c(e,t){const i=new Int32Array(e.buffer,e.byteOffset,31);if(542327876!==i[0])return s().error("Invalid magic number in DDS header"),null;if(!(4&i[20]))return s().error("Unsupported format, must contain a FourCC code"),null;const n=i[21];let c,u;switch(n){case o:c=8,u=r.CompressedTextureFormat.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case a:c=16,u=r.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case l:c=16,u=r.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return s().error("Unsupported FourCC code:",(d=n,String.fromCharCode(255&d,d>>8&255,d>>16&255,d>>24&255))),null}var d;let h=1,p=i[4],f=i[3];(3&p||3&f)&&(s().warn("Rounding up compressed texture size to nearest multiple of 4."),p=p+3&-4,f=f+3&-4);const m=p,g=f;let y,_;131072&i[2]&&!1!==t&&(h=Math.max(1,i[7]));let b=e.byteOffset+i[1]+4;const v=[];for(let t=0;t<h;++t)_=(p+3>>2)*(f+3>>2)*c,y=new Uint8Array(e.buffer,b,_),v.push(y),b+=_,p=Math.max(1,p>>1),f=Math.max(1,f>>1);return{textureData:{type:"compressed",levels:v},internalFormat:u,width:m,height:g}}e.createDDSTexture=function(e,t,r){const s=c(r,t.hasMipmap??!1);if(null==s)throw new Error("DDS texture data is null");const{textureData:n,internalFormat:o,width:a,height:l}=s;return t.samplingMode=n.levels.length>1?9987:9729,t.hasMipmap=n.levels.length>1,t.internalFormat=o,t.width=a,t.height=l,new i.Texture(e,t,n)},e.createDDSTextureData=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/StreamTextureCollection":function(){define(["exports","../../../core/promiseUtils","../../../core/urlUtils","./TextureCollection","../webgl-engine/lib/Texture"],function(e,t,r,i,s){"use strict";class n extends i.TextureCollection{constructor(e,t,r){super(t,r),this._streamDataRequester=e}async fromUrl(e,r,s){t.throwIfAborted(s);const n=s?.signal,o=this.makeUid(e,r);let a=this._textureRequests.get(o);if(!a){const t=new AbortController,s=this._streamDataRequester.request(e,2,{uid:o,signal:t.signal});a=new i.TextureRequest,a.abortController=t;const n=a;this._textureRequests.set(o,a),a.textureAsync=s.then(async t=>{const s=this._createTexture(e,t,r);return n.texture=s,n.abortController=null,await s.load(this._stage.renderView.renderingContext),this._stage.addTexture(s),new i.TextureHandle(o,s,()=>this._release(o))},e=>{throw n.abortController=null,e})}a.referenceCount++;try{return await t.whenOrAbort(a.textureAsync,n)}catch(e){throw this._release(o),e}}_createTexture(e,t,i){const n={width:t.width,height:t.height,wrap:{s:33071,t:33071},preMultiplyAlpha:!0,reloadable:!0};if(r.isSVG(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(n.preMultiplyAlpha=!1)}return new s.Texture(t,n)}}e.StreamTextureCollection=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/TextureCollection":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l){"use strict";e.TextureCollection=class extends r{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=t?.registerTask(l.TaskPriority.TEXTURE_UNLOAD)??l.ImmediateTask}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const r=this.makeUid(e);let i=this._textureRequests.get(r);if(!i){const e=new u;e.texture=t(),this._stage&&(e.texture.load(this._stage.renderView.renderingContext),this._stage.addTexture(e.texture)),this._textureRequests.set(r,e),i=e}return i.referenceCount++,new c(r,i.texture,()=>this._release(r))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(t.texture?.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.texture?this._stage?.removeTexture(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return null!=t?`${e}.${t}px`:e}},t.__decorate([s.property()],e.TextureCollection.prototype,"_frameTask",void 0),t.__decorate([s.property()],e.TextureCollection.prototype,"updating",null),e.TextureCollection=t.__decorate([a.subclass("esri.views.3d.support.TextureCollection")],e.TextureCollection);class c{constructor(e,t,r){this.uid=e,this.texture=t,this.release=r}}class u{constructor(){this.referenceCount=0}}e.TextureHandle=c,e.TextureRequest=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/ViewSlice":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/handleUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/boundedPlane","../../support/PropertiesPool"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.ViewSlice=class extends r{constructor(){super(),this._propertiesPool=new u.PropertiesPool({plane:c.BoundedPlaneClass},this),this.isDecoration=!0,this.addHandles(i.destroyHandle(this._propertiesPool))}set plane(e){if(!e)return void this._set("plane",e);const t=this._propertiesPool.get("plane");c.copy(e,t),this._set("plane",t)}},t.__decorate([s.property()],e.ViewSlice.prototype,"plane",null),t.__decorate([s.property()],e.ViewSlice.prototype,"isDecoration",void 0),e.ViewSlice=t.__decorate([l.subclass("esri.views.3d.support.ViewSlice")],e.ViewSlice),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/pointsOfInterest/PointsOfInterest":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/support/UpdatingHandles","../../../../geometry/support/ray","../debugFlags","../debugUtils","../geometryUtils/ray","./CameraOnSurface","./CenterOnSurface","./ContentGeometryUpdates","./Focus","./StableSurfaceCenter","./SurfaceGeometryUpdates","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/verticalOffsetUtils","../../../support/PropertiesPool","../../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C){"use strict";e.PointsOfInterest=class extends r{constructor(e){super(e),this.renderPointOfView=u.create(),this._pois=new Array,this._updatingHandles=new d.UpdatingHandles,this._debugCenters=null,this._tmpRay=h.create(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new T.PropertiesPool({renderPointOfView:P},this),this._contentIntersector=new x.Intersector(e.view.state.viewingMode),this._surfaceIntersector=new x.Intersector(e.view.state.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=0}initialize(){const{state:e,basemapTerrain:t,renderCoordsHelper:r,map:i}=this.view,n=()=>this._estimateSurfaceAltitudeAtCenter(),o=this.view.resourceController.scheduler,a=t?.elevationQueryCache,l={state:e,scheduler:o,surface:t,renderCoordsHelper:r};this._set("centerOnSurfaceInfrequent",new y.CenterOnSurface({...l,task:C.TaskPriority.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnSurfaceFrequent",new y.CenterOnSurface({...l,task:C.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnContent",new y.CenterOnSurface({...l,task:C.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new g.CameraOnSurface({...l,cache:a,task:C.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:i})),this._set("surfaceGeometryUpdates",new w.SurfaceGeometryUpdates({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new _.ContentGeometryUpdates(this.view.allLayerViews)),this._set("surfaceOrigin",new v.StableSurfaceCenter({cache:a,view:this.view})),this._set("focus",new b.Focus({state:e,scheduler:o,surface:t,renderCoordsHelper:r,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([s.watch(()=>e.contentCamera,e=>this._cameraChanged(e),s.sync),this._updatingHandles.add(()=>t.extent,()=>this._updateCenterPointsOfInterest()),this._updatingHandles.add(()=>this.view.map?.ground?.navigationConstraint?.type,e=>{this._surfaceIntersector.options.backfacesTerrain="none"===e},s.initial),s.when(()=>!t.updating,()=>this._updateCenterPointsOfInterest(),s.sync),s.on(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),s.on(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),this._updatingHandles.add(()=>p.debugFlags.SHOW_POI,e=>this._setDebug(e),s.initial)]),this._cameraChanged(this.view.state.contentCamera);for(const e of this._pois)e.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this._pois.length=0,this.surfaceOrigin.destroy(),this._updatingHandles.destroy(),this._set("centerOnSurfaceInfrequent",null),this._set("centerOnSurfaceFrequent",null),this._set("centerOnContent",null),this._set("cameraOnSurface",null),this._set("surfaceGeometryUpdates",null),this._set("contentGeometryUpdates",null),this._set("surfaceOrigin",null),this._set("focus",null)}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some(e=>e.updating))||this._updatingHandles.updating}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return null==e||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,M,O)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(M):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(null==e)return this._surfaceAltitudeAtCenter;const t=e.origin,r=c.add(M,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,r),this._surfaceIntersector.results.min.getIntersectionPoint(M)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(M)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,r){const i=m.fromRenderAtEye(t,e,R);if(null==i)return null;const s=i.origin,n=c.add(M,i.origin,i.direction);return this._surfaceIntersector.resetWithRay(i,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,n),this._surfaceIntersector.results.min.getIntersectionPoint(r)?r:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;c.exactEquals(this.renderPointOfView,t)||this._set("renderPointOfView",c.copy(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters?.forEach(e=>e.hide()),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;const e=this.view.graphics;this._debugCenters.set(this.centerOnContent,new f.DebugPoint(e,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new f.DebugPoint(e,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new f.DebugPoint(e,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new f.DebugPoint(e,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new f.DebugPoint(e,"green","Focus"))}for(const e of this._pois)this.addHandles(this._updatingHandles.add(()=>e.renderLocation,t=>this._debugCenters?.get(e)?.show(t,e.renderCoordsHelper.spatialReference),s.initial),"debug")}get test(){}},t.__decorate([n.property()],e.PointsOfInterest.prototype,"centerOnContent",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"centerOnSurfaceFrequent",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"centerOnSurfaceInfrequent",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"cameraOnSurface",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"focus",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"renderPointOfView",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"surfaceOrigin",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"contentGeometryUpdates",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"surfaceGeometryUpdates",void 0),t.__decorate([n.property({constructOnly:!0})],e.PointsOfInterest.prototype,"view",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"updating",null),e.PointsOfInterest=t.__decorate([l.subclass("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],e.PointsOfInterest);const P=Array,M=u.create(),R=h.create(),O={exclude:new Set([S.terrainId])};Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/debugUtils":function(){define(["exports","../../../Graphic","../../../core/Collection","../../../geometry/Point","../../../geometry/Polyline","../../../symbols/IconSymbol3DLayer","../../../symbols/LineSymbol3D","../../../symbols/LineSymbol3DLayer","../../../symbols/PointSymbol3D","../../../symbols/TextSymbol3DLayer"],function(e,t,r,i,s,n,o,a,l,c){"use strict";class u{constructor(e){this.destination=e}hide(){null!=this.graphic&&(this.destination.remove(this.graphic),this.graphic=null)}}class d extends u{constructor(e,t,i=""){super(e),this._symbol=new l({symbolLayers:new r([new n({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new c({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,r){if(!r)return;this.hide();const s=new i({x:e[0],y:e[1],z:e[2],spatialReference:r});this.graphic=new t({geometry:s,symbol:this._symbol}),this.destination.add(this.graphic)}}class h extends u{constructor(e,t){super(e),this._symbol=new o({symbolLayers:new r([new a({material:{color:t},size:2})])})}show(e,r){if(!r)return;this.hide();const i=new s({paths:e,spatialReference:r});this.graphic=new t({geometry:i,symbol:this._symbol}),this.destination.add(this.graphic)}}e.DebugGraphics=class{constructor(e){this.destination=e,this._graphics=new Map}showPoint(e,t,r,i){const s=new d(this.destination,i,e);this._graphics.get(e)?.hide(),this._graphics.set(e,s),s.show(t,r)}showSegment(e,t,r,i,s){const n=[[[t[0],t[1],t[2]],[r[0],r[1],r[2]]]],o=new h(this.destination,s);this._graphics.get(e)?.hide(),this._graphics.set(e,o),o.show(n,i)}showVector(e,t,r,i,s){const n=[[[t[0],t[1],t[2]],[t[0]+r[0],t[1]+r[1],t[2]+r[2]]]],o=new h(this.destination,s);this._graphics.get(e)?.hide(),this._graphics.set(e,o),o.show(n,i)}hide(){this._graphics.forEach(e=>e.hide)}},e.DebugPoint=d,e.DebugSegment=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/pointsOfInterest/CameraOnSurface":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../cameraUtils","./PointOfInterest","../../../support/PropertiesPool","../../../support/Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g){"use strict";const y=Array;e.CameraOnSurface=class extends f.PointOfInterest{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new m.PropertiesPool({location:h,renderLocation:y},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=d.create(),this._tmpPoint=new h}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles(s.on(()=>this.map?.ground?.layers,"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=r.destroyMaybe(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=u.distance(e.eye,this.renderLocation),r={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return p.distanceToScale(r,t)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get readyToRun(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),g.Yield;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>b&&1===this.renderCoordsHelper.viewingMode&&(e.isWGS84||e.isWebMercator);let r=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:r.signal,cache:this.cache,minDemResolution:t?v:0}).then(e=>this._updateSurfaceAltitude(e.geometry.z??0)).catch(e=>{i.isAbortError(e)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===r&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),r=null}),this._pendingElevationQueryController=r,g.Yield}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(_,this._estimatedSurfaceAltitude,this._camera.eye),u.exactEquals(this._get("renderLocation"),_)||(this._set("renderLocation",u.copy(this._propertiesPool.get("renderLocation"),_)),this.notifyChange("renderLocation"))}},t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"scheduler",void 0),t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"cache",void 0),t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"task",void 0),t.__decorate([n.property()],e.CameraOnSurface.prototype,"location",null),t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"map",void 0),t.__decorate([n.property()],e.CameraOnSurface.prototype,"renderLocation",void 0),t.__decorate([n.property()],e.CameraOnSurface.prototype,"scale",null),t.__decorate([n.property()],e.CameraOnSurface.prototype,"updating",null),e.CameraOnSurface=t.__decorate([c.subclass("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],e.CameraOnSurface);const _=d.create(),b=1e5,v=1e6;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/pointsOfInterest/PointOfInterest":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";e.PointOfInterest=class extends r{constructor(e){super(e)}},t.__decorate([i.property({constructOnly:!0})],e.PointOfInterest.prototype,"renderCoordsHelper",void 0),t.__decorate([i.property({constructOnly:!0})],e.PointOfInterest.prototype,"surface",void 0),t.__decorate([i.property({constructOnly:!0})],e.PointOfInterest.prototype,"state",void 0),e.PointOfInterest=t.__decorate([a.subclass("esri.views.3d.support.pointsOfInterest.PointOfInterest")],e.PointOfInterest),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/pointsOfInterest/CenterOnSurface":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/Point","../../../../geometry/projection/projectBoundingRect","../../../../geometry/support/aaBoundingRect","../debugFlags","./PointOfInterest","../../../support/PropertiesPool","../../../support/Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";const b=Array;e.CenterOnSurface=class extends g.PointOfInterest{constructor(e){super(e),this._propertiesPool=new y.PropertiesPool({location:h,renderLocation:b},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=u.create(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=i.removeMaybe(this._frameWorker),this._propertiesPool=i.destroyMaybe(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get readyToRun(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,_.Yield}_updateRenderLocation(){const e=w;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const r=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&r&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const i=x;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,i)&&(c.copy(e,i),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=c.distance(this._camera.eye,e):(c.scale(e,this._camera.viewForward,this._get("distance")),c.add(e,e,this._camera.eye)),c.exactEquals(this._get("renderLocation"),e)||this._set("renderLocation",c.copy(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=d.getReferenceEllipsoid(this.renderCoordsHelper.spatialReference).radius,s=r+e,n=c.squaredLength(i.eye),o=n<s*s,a=c.distance(i.eye,t);if(o&&a>r/4){const e=s-Math.sqrt(n);return c.scale(t,i.viewForward,e),c.add(t,t,i.eye),!0}}else{const e=this.surface?.ready?this.surface.extent:null;null!=e&&p.projectBoundingRect(e,this.surface?.spatialReference,S,this.renderCoordsHelper.spatialReference)&&(t[0]=r.clamp(t[0],S[0],S[2]),t[1]=r.clamp(t[1],S[1],S[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(m.debugFlags.TESTS_DISABLE_OPTIMIZATIONS)return!0;const r=this._camera.eye,i=c.distance(r,e),s=c.distance(r,t);if(Math.abs(s-i)/i>v)return!0}return!1}},t.__decorate([s.property({constructOnly:!0})],e.CenterOnSurface.prototype,"scheduler",void 0),t.__decorate([s.property({constructOnly:!0})],e.CenterOnSurface.prototype,"task",void 0),t.__decorate([s.property()],e.CenterOnSurface.prototype,"distance",void 0),t.__decorate([s.property({constructOnly:!0})],e.CenterOnSurface.prototype,"estimateSurfaceAltitudeAtCenter",void 0),t.__decorate([s.property({readOnly:!0})],e.CenterOnSurface.prototype,"location",null),t.__decorate([s.property({readOnly:!0})],e.CenterOnSurface.prototype,"renderLocation",void 0),t.__decorate([s.property()],e.CenterOnSurface.prototype,"updating",void 0),e.CenterOnSurface=t.__decorate([l.subclass("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],e.CenterOnSurface);const v=.05,w=u.create(),x=u.create(),S=f.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/pointsOfInterest/ContentGeometryUpdates":function(){define(["exports","../../../../core/Evented","../../../../core/mapCollectionUtils"],function(e,t,r){"use strict";e.ContentGeometryUpdates=class{constructor(e){this.events=new t.EventEmitter,this._handles=r.mapCollection(()=>e,e=>e.on("visible-geometry-changed",e=>this.events.emit("request-update",e)))}destroy(){this._handles.destroy()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/mapCollectionUtils":function(){define(["exports","./asyncUtils","./Collection","./handleUtils","./promiseUtils","./reactiveUtils"],function(e,t,r,i,s,n){"use strict";function o(e,t,i){const s=i?.createCollection?.()??new r,o=i?.recycleItems?new a:null,l=(e,t=0)=>{if(!e?.length)return;const r=s.splice(t,e.length);o?o.processRemoved(e):r.forEach(c)},u=(e,r=0)=>{if(!e?.length)return;const i=[];for(const r of e){const e=o?.use(r);if(e)i.push(e);else{const e=t(r);o?.register(r,e),i.push(e)}}s.addMany(i,r)},d=n.on(e,"after-splice",({added:e,start:t,removed:r})=>{l(r,t),u(e,t)},{sync:!0,onListenerRemove:e=>l(e.items),onListenerAdd:e=>u(e.items)});return s.addHandles(d),s}class a{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(!e?.length)return;const{_removedItemCandidates:t}=this;for(const r of e)this._getItem(r)?.markRemoved()&&(t.add(r),this._queueGarbageCollection())}use(e){const t=this._getItem(e);return t&&(t.removed=!1),t?.item}register(e,t){this._originalToMapped.set(e,new l(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask(()=>this._garbageCollectCandidates()))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;const{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach(e=>this._garbageCollectIfRemoved(e))}_garbageCollectIfRemoved(e){const{_originalToMapped:t}=this,r=this._getItem(e);r?.removed&&(c(r.item),t.delete(e))}}class l{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}}function c(e){"object"==typeof e&&e&&("destroy"in e&&"function"==typeof e.destroy?e.destroy():i.removeIfHandle(e))}e.mapCollection=o,e.mapCollectionAsync=function(e,n,a){const l=new r,u=o(e,e=>t.createTask(async t=>{const r=await n(e,t);if(s.isAborted(t))throw c(r),s.createAbortError();return r}),a),d=()=>null,h=async e=>{const t=await e.promise,r=u.indexOf(e);r<0||l.splice(r,1,t)};l.addMany(u.items.map(d));for(const e of u)s.ignoreAbortErrors(h(e));const p=u.on("after-splice",({added:e,start:t,deleteCount:r})=>{const i=l.splice(t,r);for(const e of i)c(e);if(e?.length){l.addMany(e.map(d),t);for(const t of e)s.ignoreAbortErrors(h(t))}});return l.addHandles([i.destroyHandle(u),p]),l},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/pointsOfInterest/Focus":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../../../../geometry/support/ray","./PointOfInterest","../../../support/PropertiesPool","../../../support/Scheduler","../../../support/Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";const b=Array;e.Focus=class extends m.PointOfInterest{constructor(e){super(e),this._propertiesPool=new g.PropertiesPool({location:p,renderLocation:b},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([s.watch(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),s.watch(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.addHandles(this.scheduler.registerTask(y.TaskPriority.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=i.destroyMaybe(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get readyToRun(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,s=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,v);const n=Math.max(0,(Math.acos(d.dot(v,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(n)){if(!e||!d.equals(e,t)){const e=this._propertiesPool.get("renderLocation");d.copy(e,t),this._set("renderLocation",e)}return _.Yield}const o=1-r.clamp(n/(.5*Math.PI),0,1),a=o*o*o;this._calculateScreenHorizontalEdgeOnSurface(x);const l=this._propertiesPool.get("renderLocation");return d.lerp(l,t,x,a),e&&d.equals(e,l)||this._set("renderLocation",l),_.Yield}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,r=t.getRenderCenter(n.createRenderScreenPointArray3());if(r[1]=t.aboveGround?t.padding[2]:t.fullHeight-t.padding[0],this.estimateSurfaceIntersectionAtRenderPoint(r,e))return e;const i=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(r,w)){d.subtract(w,w,t.eye);const r=d.normalize(w,w);if(this.renderCoordsHelper.intersectInfiniteManifold(f.wrap(t.eye,r),i,e))return e}return this.renderCoordsHelper.setAltitude(e,i,t.eye)}updateRenderLocation(){this._dirty=!0}},t.__decorate([o.property()],e.Focus.prototype,"_dirty",void 0),t.__decorate([o.property({constructOnly:!0})],e.Focus.prototype,"scheduler",void 0),t.__decorate([o.property({constructOnly:!0})],e.Focus.prototype,"centerOnSurface",void 0),t.__decorate([o.property({constructOnly:!0})],e.Focus.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),t.__decorate([o.property()],e.Focus.prototype,"updating",null),t.__decorate([o.property()],e.Focus.prototype,"location",null),t.__decorate([o.property()],e.Focus.prototype,"renderLocation",void 0),t.__decorate([o.property()],e.Focus.prototype,"worldUnitsPerContentPixel",null),e.Focus=t.__decorate([u.subclass("esri.views.3d.support.pointsOfInterest.Focus")],e.Focus);const v=h.create(),w=h.create(),x=h.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/pointsOfInterest/StableSurfaceCenter":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/Error","../../../../core/Logger","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../../../../geometry/support/aaBoundingRect"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.StableSurfaceCenter=class extends r{get surface(){return this.view.map?.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=u.create();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([o.watch(()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent],()=>this._update()),o.on(()=>this.surface?.layers,"change",()=>this._update())]),this._update())}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),null==this.surfaceView?.extent||null==this.surfaceView.spatialReference)return void this._set("location",null);const e=h.center(this.surfaceView.extent),t=new d({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(e=>{this._updateController=null,this._set("location",e.geometry)}).catch(e=>{})):this._set("location",t)}},t.__decorate([a.property({constructOnly:!0})],e.StableSurfaceCenter.prototype,"view",void 0),t.__decorate([a.property({constructOnly:!0})],e.StableSurfaceCenter.prototype,"cache",void 0),t.__decorate([a.property()],e.StableSurfaceCenter.prototype,"surface",null),t.__decorate([a.property()],e.StableSurfaceCenter.prototype,"surfaceView",null),t.__decorate([a.property({readOnly:!0})],e.StableSurfaceCenter.prototype,"location",void 0),t.__decorate([a.property({readOnly:!0})],e.StableSurfaceCenter.prototype,"renderLocation",null),e.StableSurfaceCenter=t.__decorate([c.subclass("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],e.StableSurfaceCenter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/pointsOfInterest/SurfaceGeometryUpdates":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingRect","../../../support/Scheduler","../../../support/Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.SurfaceGeometryUpdates=class extends r{constructor(e){super(e),this._tileGeometryUpdateExtent=u.empty(),this._tileGeometryUpdateSpatialReference=null,this.events=new i.EventEmitter,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(d.TaskPriority.SURFACE_GEOMETRY_UPDATES,this)])}get readyToRun(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",p),u.empty(this._tileGeometryUpdateExtent),this._set("updating",!1),h.Yield):h.Yield}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,u.expand(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const r=this.centerOnSurfaces[t];r.distance>e.distance&&(e=r)}return e}_centerIntersectsExtent(e,t){const r=this.state.contentCamera.eye,i=g,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(r,f,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,m,t),f[0]<m[0]?(i[0]=f[0],i[2]=m[0]):(i[0]=m[0],i[2]=f[0]),f[1]<m[1]?(i[1]=f[1],i[3]=m[1]):(i[1]=m[1],i[3]=f[1]),u.intersects(i,e)}},t.__decorate([s.property({constructOnly:!0})],e.SurfaceGeometryUpdates.prototype,"state",void 0),t.__decorate([s.property({constructOnly:!0})],e.SurfaceGeometryUpdates.prototype,"centerOnSurfaces",void 0),t.__decorate([s.property({constructOnly:!0})],e.SurfaceGeometryUpdates.prototype,"renderCoordsHelper",void 0),t.__decorate([s.property({constructOnly:!0})],e.SurfaceGeometryUpdates.prototype,"scheduler",void 0),t.__decorate([s.property({constructOnly:!0})],e.SurfaceGeometryUpdates.prototype,"surface",void 0),t.__decorate([s.property({readOnly:!0})],e.SurfaceGeometryUpdates.prototype,"updating",void 0),e.SurfaceGeometryUpdates=t.__decorate([l.subclass("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],e.SurfaceGeometryUpdates);const p={},f=c.create(),m=c.create(),g=u.empty();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TerrainSurface":function(){define(["require","../../../chunks/tslib.es6","../../../Color","../../../core/arrayUtils","../../../core/CollectionFlattener","../../../core/compilerUtils","../../../core/Evented","../../../core/has","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/MemCachePool","../../../core/ObjectPool","../../../core/PooledArray","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/unitUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/support/UpdatingHandles","../../../geometry/ellipsoidUtils","../../../geometry/SpatialReference","../../../geometry/projection/projectors","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingRect","../../../geometry/support/frustum","../../../geometry/support/spatialReferenceUtils","../../../chunks/sphere","../../../layers/support/ElevationQueryTileCache","../../../layers/support/layerUtils","../support/debugFlags","../support/ElevationRange","../support/ElevationUpdateEvent","../support/extentUtils","../support/updatingProperties","./ElevationBounds","./ElevationData","./ExtentHelper","./LayerClass","./OverlayManager","./PlanarPatch","./ScaleRangeQueries","./SphericalPatch","./SplitLimits","./TerrainConst","./TerrainRenderer","./TerrainSurfacePerformanceInfo","./terrainUtils","./Tile","./TilePerLayerInfo","./tileUtils","./TilingSchemeLogic","./UpsampleInfo","../webgl-engine/core/shaderLibrary/output/BlendOptions","../../support/layerViewUtils","../../support/Scheduler","../../support/TextureCompressionTracker","../../support/Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V,U,B,N,k,z,j,G,q,H,W,$,Q,Z,Y,X,J,K,ee,te,re,ie,se,ne,oe){"use strict";var ae;let le=class extends o.EventedAccessor{static{ae=this}get allTiles(){return n.toConst(this._allTiles)}get demResolution(){const{_allTiles:e,tilingScheme:t}=this;if(0===e.length)return{min:1,max:1};const r=g.getMetersPerUnitForSR(t.spatialReference);let i=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(const n of e){const e=t.resolutionAtLevel(n.level)*r;i=Math.min(i,e),s=Math.max(s,e)}return{min:i,max:s}}constructor(e){super(e),this.terrainTextureCompressionTracker=new ne.TextureCompressionTracker,this._iteratorPool=new h(K.IteratorPreorder,e=>e.remove=()=>this._iteratorPool.release(e)),this._postorderIterator=new K.IteratorPostorder,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new Z,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=v.create(),this._eyePosSurfaceSR=v.create(),this._splitLimits=new W.SplitLimits,this._frustum=R.create(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new w.UpdatingHandles,this._frameTask=se.ImmediateTask,this._allTiles=new p,this._upsampleInfoPool=new h(te.UpsampleInfo),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=M.create(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=S.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new B.ElevationBounds(1/0,-1/0),this.rootTileElevationBounds=new B.ElevationBounds(1/0,-1/0),this._projectorCache=new Map,this._radiusModifier=Math.cos(Math.PI/16/16),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this._enabled=!0;const t=e.view;this.overlayManager=new j.OverlayManager({...e,surface:this}),this._isGlobal=!t.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?H.SphericalPatch:G.PlanarPatch,this._ellipsoid=x.getReferenceEllipsoid(t.spatialReference),this._renderer=new Q.TerrainRenderer(this.overlayManager.renderer,t.stage,this._allTiles,this._ellipsoid.radius,this.terrainTextureCompressionTracker,t.resourceController.memoryController),ie.hasLayerBasedScaleVisibility()||(this._scaleRangeQueries=new q.ScaleRangeQueries)}initialize(){const t=this.view,r=t.resourceController,i=r.memoryController;this._tileCache=new d.MemCachePool((e,t)=>i.newCache(e,t),"terrain-tile"),this._upsampleMapCache=i.newCache("terrain-upsample",e=>e.unloadMapData()),this._elevationQueryCache=new F.ElevationQueryTileCache(i.newCache("elevation-query"));const n=this.overlayManager;this.addHandles([m.watch(()=>n.renderer.isEmpty,()=>this._evaluateTransparency()),m.watch(()=>this.renderer.visible,e=>this.suspended=!e),m.watch(()=>this.heading,e=>{this._renderer.updateHeading(e),this._updateTileTextures(0)}),m.watch(()=>({heading:t.camera?.heading,state:t.state?.mode}),({heading:e,state:t})=>{if(null==e)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(e/90)%360);const r=Math.round(e)%360,i=Math.abs(r-this.heading);(2===t||Math.min(i,360-i)>=30)&&(this.heading=r)})],"overlayManager"),this.addHandles([m.watch(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?1:2)},m.syncAndInitial),m.watch(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?1:2),m.syncAndInitial),m.watch(()=>this.backgroundColor,(e,t)=>{e?.equals(t)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(e))},m.sync),m.watch(()=>this.snapLevel,()=>this._viewChanged=!0,m.sync),m.watch(()=>this.view.pointsOfInterest,e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add(()=>e.focus?.renderLocation,()=>this._allTilesSorted=!1)}),m.watch(()=>D.debugFlags.TERRAIN_TILE_TREE_SHOW_TILES,r=>{r&&!this._treeDebugger?new Promise((t,r)=>e(["../layers/support/TerrainTileTree3DDebugger"],t,r)).then(({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&D.debugFlags.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:t}))}):r||(this._treeDebugger=u.destroyMaybe(this._treeDebugger))},m.initial)]);const{spatialReference:o}=t;this._extentHelper=k.create(this.viewingMode,{layers:t.map.allLayers,layerViews:t.allLayerViews,viewSpatialReference:o});const a=new s({getCollections:()=>t.defaultsFromMap?.mapCollections?.map(({layers:e})=>e),getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),l=new ee.TilingSchemeLogic({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:o});this._set("tilingSchemeLogic",l),this._updateTilingScheme(),this._elevationDataRequester=r.createStreamDataRequester(0),this._mapDataRequester=r.createStreamDataRequester(1);const c=r.scheduler;this._frameTask=c.registerTask(se.TaskPriority.TERRAIN_SURFACE,this),this.addHandles([m.watch(()=>this._extentHelper.stencilEnabledExtents,e=>this._renderer.setStencilEnabledLayerExtents(e),m.initial),m.watch(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),m.sync),m.watch(()=>this.extent,()=>this._updateRootTiles(),m.initial),t.on("resize",()=>this._viewChangeUpdate()),m.watch(()=>{const e=t.state;return[this._lodBias,this.lodSnappingEnabled,t.quality,e.camera,e.contentCamera,e.fixedContentCamera]},()=>this._viewChangeUpdate(),m.syncAndInitial),m.watch(()=>t.qualitySettings?.fadeDuration,e=>this._renderer.textureFadingEnabled=e>0,m.initial),m.watch(()=>t.qualitySettings?.physicallyBasedRenderingEnabled,e=>this._renderer.pbrMode=e?5:0,m.initial),m.watch(()=>t.qualitySettings?.tiledSurface.elevationLevelDelta,()=>this._updateAllTileGeometries()),m.watch(()=>this._userClippingExtent,()=>this._updateClippingExtent(),m.sync)]),this.addHandles(t.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}clearHandles(){this._watchUpdatingTracking?.removeAll(),this.removeAllHandles(),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._basemapLayerViewHandles.clear()}destroy(){this._frameTask.remove(),this._frameTask=se.ImmediateTask,this._watchUpdatingTracking?.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",u.destroyMaybe(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._basemapLayerViewHandles.clear(),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",u.destroyMaybe(this.overlayManager)),this._tileCache=u.destroyMaybe(this._tileCache),this._allTiles.prune(),X.Tile.prune(),this._treeDebugger=u.destroyMaybe(this._treeDebugger),this._renderer.destroyed||this._renderer.destroy(),this._renderer=null,this._iteratorPool=u.destroyMaybe(this._iteratorPool),this._upsampleMapCache=u.destroyMaybe(this._upsampleMapCache),this._elevationQueryCache=u.destroyMaybe(this._elevationQueryCache),this._set("view",null),this._extentHelper=u.destroyMaybe(this._extentHelper),this._upsampleInfoPool=u.destroyMaybe(this._upsampleInfoPool),J.printAllocations(),this._layerViews.forEach(e=>e.length=0),this._performanceInfo=null}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnappingEnabled){const{view:e,tilingScheme:t}=this,r=e.scale;if(t&&r){const i=t.levelAtScale(r)+e.qualitySettings.tiledSurface.lodBias,s=t.getMaxLod();return i<=0?null:Math.min(i,s||1/0)}}return null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){const{spatialReference:e}=this,t=this.view?.clippingArea;if(null==t||null==e)return null;const r=M.create(),i=V.toBoundingRect(t,r,e)?r:null,s=this._get("extent");return M.equals(i,s)?s:i}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=M.intersection(this.groundExtent,this._userClippingExtent,M.create()),t=this._get("extent");return M.equals(e,t)?t:e}get groundExtent(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.readyToRun||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating||this.terrainTextureCompressionTracker.compressing)}get readyToRun(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries?.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return null!=this._rootTiles}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return 0===this._renderer.transparency}get invisible(){return 3===this._renderer.transparency}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(e,t,r,i){this._renderer.intersect(e,t,r,i)}getElevationLevelDelta(e){return e<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(e,t,r,i){const s=this._rootTiles;if(!s?.length||!this._enabled)return null;if(0===s[0].layerInfo[0].length)return null;let n=this._elevationProjectorCache.get(i);if(void 0===n&&(n=T.getProjector(i,this._spatialReference)??null,this._elevationProjectorCache.set(i,n)),null==n)return l.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const o=b.set(ue,e,t,r);return n(o,0,o,0),ge(s,o[0],o[1])}getElevations(e,t,r){const i=this._rootTiles,s=i?i[0].layerInfo[0].length:0;if(i?.length&&0!==s&&this._enabled)for(let s=0;s<t;++s){const t=3*s;r(s,ge(i,e[t],e[t+1]))}else for(let e=0;e<t;++e)r(e,null)}getLayerIndexByUID(e,t){return this._layerIndexByUid[e].get(t)}getScale(e){if(!this.tilingScheme)return null;if(!C.projectPointToVector(e,ue,this.spatialReference))return l.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(null!=t)for(const e of t)if(e?.containsPoint(ue)){let t=e;for(;t.children[0]&&!t.rendered;){const e=t.children[0].extent;let r=0;ue[0]>e[2]&&(r+=1),ue[1]<e[1]&&(r+=2),t=t.children[r]}return this._getLodBiasCorrectedScale(t.level)}return 1/0}_ensureProjector(e){const t=this._projectorCache.get(e);if(t)return t;const r=T.getProjector(e,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(e,r),r}getSphereElevationBounds(e,t){const r=this._ensureProjector(t);if(null==r)return l.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;I.copy(e,de);const i=I.getCenter(de);r(i,0,i,0);const s=new E.ElevationRange,n=this._rootTiles;if(null!=n){const e=[];for(const t of n)e.push(t);let t=0;for(;t<e.length;){const r=e[t];if(++t,!M.intersectsSphere(r.extent,de))continue;const i=r.children;if(null==i[0]||r.rendered)s.expandElevationRangeValues(r.elevationBoundsMin,r.elevationBoundsMax);else for(const t of i)e.push(t)}}return s}getRootElevationBounds(){return new E.ElevationRange(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getLowerBoundRadius(){const e=(this._ellipsoid.radius+this.visibleElevationBounds.min)*this._radiusModifier;return Math.min(e,this._ellipsoid.radius)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!C.projectPointToVector(e,I.getCenter(de),this.spatialReference))return l.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;de[3]=t;let r=null;const i=e=>{if(e&&M.intersectsSphere(e.extent,de)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)i(e);else{const t=this._getLodBiasCorrectedScale(e.level);r=null==r?t:Math.min(r,t)}}},s=this._rootTiles;if(null!=s)for(const e of s)i(e);return r}queryVisibleScaleRange(e,t,r,i){if(!this._scaleRangeQueries)return;const s=t?this.tilingScheme.levelAtScale(t):0,n=r?this.tilingScheme.levelAtScale(r):1/0,o=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,s+o,n+o,i)}_evaluateTransparency(){const e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,r=this._renderer.transparency,i=this._isFullyTransparent?t?3:2:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?0:1;return this._renderer.transparency=i,r!==i}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;Y.weakAssert(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const t=e?.spatialReference??S.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&O.isPlateCarree(this.view?.renderSpatialReference),this._isGeographic=t?.isGeographic??!1,this._set("tilingScheme",e),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.tileSize=e.pixelSize,this.overlayManager.spatialReference=e.spatialReference,this._updateRootTiles())}static{this._tileMemcacheKey="TerrainTileMemcache"}_acquireTile(e,t,r,i){const s=this._tileCache.pop(ae._tileMemcacheKey);return s?(s.init(e,t,r,i,this),s):new this._tileConstructor(e,t,r,i,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const r=he;let s=t.rootTilesInExtent(e,r,5*$.maxRootTiles);if(null!=this._rootTiles){if(s.length>$.maxRootTiles)return void l.getLogger(this).warn($.tooManyRootTilesAfterChangeError);const e=this._rootTiles.map(e=>e.lij),t=i.difference(e,s,X.lijEquals);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter(e=>!(t.removed.findIndex(t=>X.lijEquals(t,e.lij))>-1&&(this._purgeTile(e),1)));t.added.forEach(t=>e.push(this._newRootTile(t))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,s.length>$.maxRootTiles&&(l.getLogger(this).warn($.tooManyRootTilesForLayerError),s=t.rootTilesInExtent(e,r,$.maxRootTiles)),this._setRootTiles(s.map(e=>this._newRootTile(e)));M.equals(r,this._rootTilesExtent)||(this._rootTilesExtent=M.create(r)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter(e=>e.loaded&&e.intersectsClippingArea);e.sort(K.compareTilesByLij),e.forEach(e=>this._renderer.updateTileGeometryState(e)),e.forEach(e=>e.renderData.updateNeighborData()),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(0===e.length)return;e.sort(K.compareTilesByLij);const t=this.renderer;e.forEach(e=>t.updateGeometryIfNeeded(e)),e.forEach(e=>this._pendingTilesForElevationUpdateEvent.add(e))}_shouldSplit(e){return 1===e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(1),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles})}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(8)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(null==e)return;const t=K.hasLoadableSiblings(e),r=this.visibleElevationBounds;let i=t?r.min:1/0,s=t?r.max:-1/0;const n=this.extent,o=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();const a=this._iteratorPool.acquire();for(a.reset(e);!a.done;){const e=a.next();e.updateClippingStatus(n)&&e.resetPendingUpdate(8)&&this._updateTileGeometryState(e),e.computeVisibility(),e.updateScreenDepth(o),e.renderData&&(i=Math.min(e.elevationBoundsMin,i),s=Math.max(e.elevationBoundsMax,s))}a.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(i)&&isFinite(s)&&(r.min!==i||r.max!==s)&&(this.visibleElevationBounds=new B.ElevationBounds(i,s))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;const r=this._rootTiles;null!=r&&r.forEach(({elevationBoundsMin:r,elevationBoundsMax:i})=>{e=Math.min(e,r),t=Math.max(t,i)});const i=this.rootTileElevationBounds;i.min===e&&i.max===t||(this.rootTileElevationBounds=new B.ElevationBounds(e,t))}_updateViewDependentParameters(){const{camera:e,contentCamera:t}=this.view.state,r=Math.tan(.5*t.fovX),i=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,n=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=r,this._splitLimits.fovY=i,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=R.copy(this._splitLimits.frustum??R.create(),t.frustum):this._splitLimits.frustum=null,R.copy(this._frustum,e.frustum),b.copy(this._eyePosRenderSR,t.eye),P.projectVectorToVector(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor(e=>{this._layerViews[1].some(Y.isVectorTileLayerView)&&e.setPendingUpdate(32),this._pendingTilesToUpdate.add(e)})}_updateTileTexture(e,t){const r=e.resetPendingUpdate(32)?32:!!e.resetPendingUpdate(16)&&16;r&&(this._renderer.updateTileTexture(e,r),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const e=fe.extent;M.empty(e),this._pendingTilesForElevationUpdateEvent.forEach(t=>M.expand(e,t.extent,e)),this._pendingTilesForElevationUpdateEvent.clear(),fe.spatialReference=this.spatialReference,this.emit("elevation-change",fe),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),Y.enableTerrainInternalChecks&&this._checkTileInvariant(),!e.hasProgressed)return oe.Yield}_checkTileInvariant(){const e=new Map;this._allTiles.forAll(t=>e.set(t,new Set)),this._allTiles.forAll(t=>{if(Y.weakAssert(t.rendered===t.leaf,` rendered ${t.rendered} != ${t.leaf} leaf`),!t.leaf){const e=e=>0===e.unmergableChildCount&&0===e.maxLevelDeltaNeighborCount,r=t.children.reduce((t,r)=>t+(e(r)?0:1),0);if(Y.weakAssert(t.unmergableChildCount===r,` Tile[${t.lij.toString()}] unmergeable child count mismatch: actual ${t.unmergableChildCount} vs ${r}`),t.hasPendingUpdate(4)){Y.weakAssert(!t.hasPendingUpdate(1),"Tile can be both split and merge at the same time");for(const e of t.children)Y.weakAssert(e.leaf||e.hasPendingUpdate(4),"Child of tile to merge must also merge")}}for(let r=0;r<4;++r){if(t.rendered){const e=t.renderData?.geometryState.edgePeerNeighbors[r];if(null!=e){{const i=t.level-e.level<=$.maxTileNeighborLevelDelta;i||(console.log(`tile level delta [${t.lij.toString()}] vs [${e.lij.toString()}] > ${$.maxTileNeighborLevelDelta}  (edge[${r}])`),Y.weakAssert(i,`tile level delta [${t.level}] vs [${e.level}] > ${$.maxTileNeighborLevelDelta}`))}Y.weakAssert(t.level-e.level<=$.maxTileNeighborLevelDelta,`Max tile lod delta exceeded: [${t.lij.toString()}] vs [${e.lij.toString()}]`)}}const i=t.level-$.maxTileNeighborLevelDelta,s=e=>e.leaf||e.level===t.level,n=t.findNeighborTile(Y.neighborEdgeIndices[r],s);if(null!=n){if(t.leaf&&t.level>=$.maxTileNeighborLevelDelta){let r=n;for(;t.level-r.level<$.maxTileNeighborLevelDelta;)r=r.parent;const s=[i,t.lij[1]>>$.maxTileNeighborLevelDelta,t.lij[2]>>$.maxTileNeighborLevelDelta];if(!X.lijEquals(s,r.lij)){const i=e.get(r);Y.weakAssert(!i.has(t),"Cannot already have neighbor"),i.add(t)}}Y.weakAssert(n.rendered||n.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),Y.weakAssert(t.level-n.level<=$.maxTileNeighborLevelDelta,`Tile level delta [${t.level}] vs [${n.level}] > ${$.maxTileNeighborLevelDelta}`)}}}),this._allTiles.forAll(t=>{const r=t.maxLevelDeltaNeighborCount,i=e.get(t);Y.weakAssert(r===i.size,`Tile[${t.lij.toString()}] merge-blocker mismatch: actual ${r} vs ${i.size}`)})}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=new ye(this._allTiles.length);t.pushAll(this._rootTiles);const r=this.snapLevel,i=this._splitLimits,s=this._eyePosRenderSR;this._allTiles.forAll(e=>{e.maxLevelDeltaNeighborCount=0,e.unmergableChildCount=0});const n=this.view.state.contentCamera.viewProjectionMatrix;for(;!t.empty;){const e=t.pop(),o=e.parent,a=null!=o&&o.hasPendingUpdate(4),l=a?4:e.shouldSplit(i,s,r),c=1===l;e.leaf?_e(e,c):t.pushAll(e.children),a?(e.resetPendingUpdate(1),e.leaf||e.setPendingUpdate(4),this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(n)):c?(e.resetPendingUpdate(4),e.leaf&&e.setPendingUpdate(1)):(e.resetPendingUpdate(1)&&e.updateAgentSuspension(),2===l&&e.updateAgents(0),e.leaf||(e.setPendingUpdate(4),e.resetPendingUpdate(1)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||!this.view.pointsOfInterest?.focus||(K.sortTilesByPOI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){Y.internalAssert(e.loaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){const e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter(e=>e.loaded&&e.intersectsClippingArea);if(0===t.length)return void e.clear();const r=(r,i)=>{!i?.loaded||!i.intersectsClippingArea||i.level<r.level||e.has(i)||(e.add(i),t.push(i),i.renderData.updateNeighborData())};t.sort(K.compareTilesByLij);const i=t.length;for(let s=0;s<i;++s){const i=t[s];Y.internalAssert(i.loaded),Y.internalAssert(i.intersectsClippingArea);const n=i.renderData;n.updateNeighborData();const o=n.dirtyEdgeResolutions,a=n.geometryState,l=e=>{const t=Y.neighborCornerIndices[e];r(i,a.cornerPeerNeighbors[e]?.findCorner(Y.oppositeCorner(t),e=>e.loaded))};for(let t=0;t<4;++t)if(o&1<<t){const s=n.geometryState.edgePeerNeighbors[t];s&&s?.level>=i.level&&s.forAllSubtreeOnSide(Y.oppositeEdge(Y.neighborEdgeIndices[t]),t=>!(!t.loaded||!t.intersectsClippingArea||(Y.internalAssert(e.has(t)||K.compareTilesByLij(i,t)<0),r(i,t),0))),l((t+1)%4),l(t)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,Y.enableTerrainInternalChecks&&Y.enableWaterproofTests&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let r=!1;const i=this.view.state.fixedContentCamera;let s=!1;for(;!e.done;){s=!0;let n=!1;const o=!this._allTiles.some(s=>{if(!r&&!i&&!s.visible)return e.done;let o=s;if(s.hasPendingUpdate(4)){if(!t||s.unmergableChildCount>0)return e.done;for(s.resetPendingUpdate(4);null!=o.parent&&0===o.parent.unmergableChildCount&&o.parent.resetPendingUpdate(4);)o=o.parent;this._mergeTile(o),n=!0,e.madeProgress()}else if(s.resetPendingUpdate(1)){let t=!0;const r=s.level;if(r>=$.maxTileNeighborLevelDelta){const e=e=>e.leaf||r-e.level<$.maxTileNeighborLevelDelta;for(let i=0;i<4;++i){const n=s.findNeighborTile(Y.neighborEdgeIndices[i],e);null!=n&&r-n.level===$.maxTileNeighborLevelDelta&&(t=!1,Y.enableTerrainInternalChecks&&(Y.internalAssert(n.leaf),Y.internalAssert(n.hasPendingUpdate(1))))}}t?(this._splitTile(s),e.madeProgress(),n=!0):s.setPendingUpdate(1)}return e.done});if(n&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),o){if(!r){r=!0;continue}if(!n)break}else this._allTilesDirty=!0}s?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some(t=>(t.resetPendingUpdate(8)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done)),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some(t=>(this._updateTileTexture(t,e),e.done))}_updateClippingExtent(){this.spatialReference&&(this.overlayManager?.updateOverlayParameters(1),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*$.maxMemoryLodBias}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,r=c.clamp(e-this._lodBias,0,t.length-1),i=r-Math.floor(r);return t[Math.floor(r)].scale*(1-i)+t[Math.ceil(r)].scale*i}_removeAllTiles(){null!=this._rootTiles&&(this._rootTiles.forEach(e=>this._purgeTile(e)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles}),this.renderer.visible=!1}_purgeSubtree(e){const t=e.children;t[0]&&(this._purgeTile(t[0]),this._purgeTile(t[1]),this._purgeTile(t[2]),this._purgeTile(t[3]),e.clearChildren())}_purgeTile(e){e.leaf?ve(e):this._purgeSubtree(e),this._allTiles.removeUnordered(e),this._unloadTile(e),e.dispose(),this._tileCache.put(ae._tileMemcacheKey,e),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles})}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload()}_splitTile(e){Y.weakAssert(e.leaf,"Tile that is already split should not be split again!"),Y.weakAssert(e.rendered,"Tile marked to split is not rendered"),ve(e);const t=e.createChildren();this._allTiles.pushArray(t),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles}),e.updateAgentSuspension(),Y.weakAssert(e.rendered,"parent should be rendered"),t.forEach(e=>this._loadTile(e)),t.forEach(e=>this._pendingTilesToUpdate.add(e)),this._unloadTile(e),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),t.forEach(e=>_e(e,e.hasPendingUpdate(1))),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){me.spatialReference=this.spatialReference,me.extent=e.extent,me.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",me)}createTile(e,t,r,i){Y.weakAssert(!!i,"createTile sanity check");const s=this._acquireTile(e,t,r,i);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(1),s}get _shortBatches(){return 2!==this.view.state.mode}_mergeTile(e){Y.weakAssert(!e.hasPendingUpdate(1),"_mergeTile sanity check"),Y.weakAssert(!e.leaf,"Cannot merge a leaf"),e.leaf||(this._purgeSubtree(e),Y.weakAssert(!e.renderData,"Merging tile with existing render data?"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),_e(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager?.hasOverlays&&this.overlayManager.updateTileOverlayParameters(e)}_handleLayerViewChanges(e=se.noBudget){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const r=new Set;let i=-1;for(let e=this.view.allLayerViews.length-1;e>=0;e--){const s=this.view.allLayerViews.items[e];if(r.add(s.uid),Y.isSurfaceLayerView(s)||Y.isGroupLayerView(s))if(this._basemapLayerViewHandles.has(s.uid)&&!Y.isGroupLayerView(s)){const e=this._layerClassFromLayerView(s),r=this.getLayerIndexByUID(e,s.uid);null!=r&&((r<i||null==i)&&(t=!0),i=r)}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach((e,i)=>{r.has(i)||(this._unregisterTiledLayerView(i),t=!0)}),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}get _isFullyTransparent(){if(this.view.map?.ground?.opacity>0)return!1;for(const e of this.view.allLayerViews.items)if(Y.isMapTileLayerView(e)&&!A.isBaseLayer(e.layer)&&0!==e.fullOpacity)return!1;return!0}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if((Y.isBlendableLayerView(e)||Y.isGroupLayerView(e))&&re.isCompositeBlendMode(re.blendModeFromString[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return Y.isElevationLayerView(e)?0:1}_registerTiledLayerView(e){const t=[];if((Y.isBlendableLayerView(e)||Y.isGroupLayerView(e))&&t.push(m.watch(()=>e.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(2)})),!Y.isGroupLayerView(e)){const r=this._layerClassFromLayerView(e);t.push(m.watch(()=>!e.destroyed&&e.suspended,()=>this._updateTiledLayers())),t.push(m.watch(()=>!e.destroyed&&e.fullOpacity,()=>this._updateTileTextures(2)));const{layer:i}=e;"effectiveScaleRange"in i&&t.push(m.watch(()=>!e.destroyed&&i.effectiveScaleRange,()=>this._restartAllAgents(r))),t.push(e.on("data-changed",()=>{const t=this.getLayerIndexByUID(r,e.uid);null!=t&&this._invalidateLayerData(t,r)}))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let r=null;e.forEach(e=>{if(!e.layer||e.suspended||!Y.isSurfaceLayerView(e)||!e.fullExtent)return;const i=this._layerClassFromLayerView(e);if(1===i){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===r||t>r)&&(r=t)}t[i].push(e)});for(const e of z.LayerClasses){const r=this._layerViews[e],i=t[e];i.reverse();const s=i.length;let n=r.length!==s;const o=new Array(s),a=new Array(r.length);this._layerIndexByUid[e].clear();for(let t=0;t<s;t++){const s=i[t].uid;this._layerIndexByUid[e].set(s,t);const l=r.indexOf(i[t]);o[t]=l,t!==l&&(n=!0),l>-1&&(a[l]=t)}if(n){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;)t.next().modifyLayers(a,o,e);this._layerViews[e]=i,this._restartAllAgents(e),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(r)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const r=t.next();r.restartAgents(e),0===e&&r.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(t=>{t.updateAgents(1),1===e?this.renderer.updateTileTexture(t,16):t.updateRenderData(1,e)}),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll(r=>r.removeLayerAgent(e,t)),this._allTiles.forAll(r=>r.invalidateLayerData(e,t))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=1){this.renderer.setNeedsRender(e)}requestUpdate(){1===++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,r,i){const s=this.layerViewByIndex(t,r),n=s.layer;return!n.tilemapCache||Y.isVectorTileLayerView(s)?this._requestTileData(e,r,s,i):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.level,e.lij[1],e.lij[2],{...i,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(t=>{throw--this._asyncWorkItems,f.throwIfAborted(i),f.isAbortError(t)||this._dataMissing(e,r,s),t}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,r,s,i),i.signal)))}_requestTileData(e,t,r,i){if(this.destroying)return Promise.resolve();const s=0===t;return i.requester??=s?this._elevationDataRequester:this._mapDataRequester,s?Y.isElevationLayerView(r)?this._requestElevationTileData(e,r,i):Promise.reject():Y.isMapTileLayerView(r)?this._requestMapTileData(e,r,i):Promise.reject()}_requestElevationTileData(e,t,r){++this._asyncWorkItems;const i=i=>{!f.isAborted(r)&&i&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(e,t,i))};return t.fetchElevationTile(e,r).then(e=>this._frameTask.schedule(()=>i(e)),r=>{f.isAbortError(r)||(l.getLogger(this).error(`Tile ${e.lij.toString()} layer 0/${t.uid} error ${r}`),this._dataMissing(e,0,t),this.requestUpdate())}).finally(()=>--this._asyncWorkItems)}_elevationDataArrived(e,t,r){const i=this._layerIndexByUid[0].get(t.uid);if(null==i)return void l.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString());const s=new N.ElevationData(e.lij,e.extent,r);e.dataArrived(i,0,s),this.emit("tile-data-changed",{tile:e,layerIndex:i,layerClass:0});const n=[e],o=e.level,a=this._iteratorPool.acquire();for(a.reset(n);!a.done;){const e=a.next();e.findElevationBoundsForLayer(i,o),e.computeElevationBounds()}0===o&&this._updateRootTileElevationBounds(),a.remove(),this._updateTilesVisibility(n)}_requestMapTileData(e,t,r){++this._asyncWorkItems;const i=(i,s)=>{Y.releaseTerrainData(s),f.isAborted(r)||(console.error(`Tile ${e.lij.toString()} layer 1/${t.uid} error ${i}`),this._dataMissing(e,1,t),this.requestUpdate())},s=e=>t=>i(t,e);return t.fetchTile(e.lij,r).then(i=>this._frameTask.schedule(()=>{this.requestUpdate(),f.isAborted(r)?Y.releaseTerrainData(i):this._mapTileDataArrived(e,t,i)},r.signal,s(i)).catch(s(i)),(e,t=null)=>this._frameTask.schedule(()=>i(e,t))).finally(()=>--this._asyncWorkItems)}_mapTileDataArrived(e,t,r){const i=this.getLayerIndexByUID(1,t.uid);if(null==i)return Y.releaseTerrainData(r),void l.getLogger(this).warn("TerrainSurface: received data from unknown layer");e.dataArrived(i,1,r),this.emit("tile-data-changed",{tile:e,layerIndex:i,layerClass:1})}_dataMissing(e,t,r){const i=this.getLayerIndexByUID(t,r.uid);null!=i?(e.dataMissing(i,t),this.emit("tile-data-changed",{tile:e,layerIndex:i,layerClass:t})):l.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(t=>{t.leaf&&e.numLeaves++;const r=t.level;t.renderData&&(e.numLoadedPerLevel[r]=(e.numLoadedPerLevel[r]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[r]=(e.numRenderedPerLevel[r]||0)+1,e.numRendered++))}),e}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce((e,t)=>e+t.usedMemory,0)):null}getUsedMemoryForLayerView(e){let t=0;const r=this._layerClassFromLayerView(e),i=this.getLayerIndexByUID(r,e.uid);return null!=i&&this._allTiles.forAll(e=>t+=e.getUsedMemoryForLayer(r,i)),t}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){}checkAllTilesWaterproofness(){if(!Y.enableWaterproofTests)return;const e=this._rootTiles;if(null==e)return;const t=e=>e?.renderData?.geometry?.indices?.length>0,r=(e,r)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",r.lij,"] has geom")},i=e=>{if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometry&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!e.renderData?.geometry||(e.renderData.geometry.indices?.length??0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometry),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)r(t,e)}else if(e.leaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)i(t)},s=e=>{const t=e.parent?.visible??!0,r=e.visible;e.computeVisibility();const i=e.visible;if(r!==i&&t&&console.error(" Tile[",e.lij,"] has out of date visibility: ",r," instead of ",i),!e.leaf)for(const t of e.children)s(t)};for(const t of e)i(t),s(t)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&0===e[2]}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){const t=this.lijEastEnd(e[0]),r=e[2];if(0<=r&&r<t)return e;if(!this._isGlobal)return null;const i=(r+(r<0?t:0))%t;return[e[0],e[1],i]}enableInternalChecks(e){Y.enableInternalTerrainChecks(e)}enableWaterproofnessChecks(e){Y.enableTerrainWaterproofChecks(e)}static cleanupTerrainSurface(){pe.prune()}enable(e){e!==this._enabled&&(e?(this._updateRootTiles(),this.suspended=!1):(this.suspended=!0,this._removeAllTiles(),this._setRootTiles(null)),this._enabled=e)}};t.__decorate([y.property()],le.prototype,"_renderer",void 0),t.__decorate([y.property({constructOnly:!0})],le.prototype,"_scaleRangeQueries",void 0),t.__decorate([y.property({constructOnly:!0})],le.prototype,"view",void 0),t.__decorate([y.property({constructOnly:!0})],le.prototype,"overlayManager",void 0),t.__decorate([y.property({constructOnly:!0})],le.prototype,"terrainTextureCompressionTracker",void 0),t.__decorate([y.property()],le.prototype,"_hasPendingUpdates",void 0),t.__decorate([y.property()],le.prototype,"_asyncWorkItems",void 0),t.__decorate([y.property()],le.prototype,"_allTilesDirty",void 0),t.__decorate([y.property()],le.prototype,"_allTilesSorted",void 0),t.__decorate([y.property()],le.prototype,"_viewChanged",void 0),t.__decorate([y.property({type:Number})],le.prototype,"heading",void 0),t.__decorate([y.property()],le.prototype,"_splitLimits",void 0),t.__decorate([y.property({readOnly:!0})],le.prototype,"_watchUpdatingTracking",void 0),t.__decorate([y.property()],le.prototype,"_frameTask",void 0),t.__decorate([y.property()],le.prototype,"demResolution",null),t.__decorate([y.property({readOnly:!0})],le.prototype,"snapLevel",null),t.__decorate([y.property({readOnly:!0})],le.prototype,"lodSnappingEnabled",null),t.__decorate([y.property()],le.prototype,"_userClippingExtent",null),t.__decorate([y.property()],le.prototype,"_rootTilesExtent",void 0),t.__decorate([y.property({readOnly:!0})],le.prototype,"extent",null),t.__decorate([y.property({readOnly:!0})],le.prototype,"groundExtent",null),t.__decorate([y.property({readOnly:!0})],le.prototype,"_tilingSchemeExtent",null),t.__decorate([y.property({readOnly:!0})],le.prototype,"updating",null),t.__decorate([y.property({readOnly:!0})],le.prototype,"readyToRun",null),t.__decorate([y.property(U.updatingProgress)],le.prototype,"updatingProgress",void 0),t.__decorate([y.property({readOnly:!0})],le.prototype,"updatingProgressValue",null),t.__decorate([y.property()],le.prototype,"_maxNumUpdating",void 0),t.__decorate([y.property()],le.prototype,"baseOpacity",null),t.__decorate([y.property()],le.prototype,"hasCompositeBlendMode",void 0),t.__decorate([y.property({readOnly:!0})],le.prototype,"viewingMode",null),t.__decorate([y.property()],le.prototype,"maxTextureScale",void 0),t.__decorate([y.property({readOnly:!0})],le.prototype,"ready",null),t.__decorate([y.property({readOnly:!0})],le.prototype,"rootTiles",null),t.__decorate([y.property()],le.prototype,"_rootTiles",void 0),t.__decorate([y.property({readOnly:!0})],le.prototype,"spatialReference",null),t.__decorate([y.property({type:r})],le.prototype,"backgroundColor",null),t.__decorate([y.property({value:!1})],le.prototype,"slicePlaneEnabled",null),t.__decorate([y.property({readOnly:!0})],le.prototype,"tilingScheme",void 0),t.__decorate([y.property({readOnly:!0})],le.prototype,"tilingSchemeLocked",null),t.__decorate([y.property({readOnly:!0})],le.prototype,"tilingSchemeLogic",void 0),t.__decorate([y.property()],le.prototype,"wireframe",null),t.__decorate([y.property({value:!1})],le.prototype,"suspended",null),t.__decorate([y.property()],le.prototype,"fadeDuration",null),t.__decorate([y.property()],le.prototype,"visibleElevationBounds",void 0),t.__decorate([y.property()],le.prototype,"rootTileElevationBounds",void 0),t.__decorate([y.property()],le.prototype,"_layerViewsDirty",void 0),t.__decorate([y.property()],le.prototype,"renderPatchBorders",null),t.__decorate([y.property()],le.prototype,"visualizeNormals",null),t.__decorate([y.property()],le.prototype,"renderingDisabled",null),le=ae=t.__decorate([_.subclass("esri.views.3d.terrain.TerrainSurface")],le);const ce=le,ue=v.create(),de=I.create(),he=M.create(),pe=new p,fe=new L.ElevationUpdateEvent("ground"),me={spatialReference:null,extent:null,scale:0};function ge(e,t,r){for(const i of e){if(!i.containsPointXY(t,r))continue;let e=i;for(;e&&!e.renderData;){const i=(t>e.extentMidX?1:0)+(r<e.extentMidY?2:0);e=e.children[i]}const s=e?.renderData?.geometryState.samplerData??null;return N.sampleElevation(t,r,s)}return null}class ye{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(0===t)return;const r=this._tail;if(!(r+t<=this.capacity))throw new Error("Queue full");for(let i=0;i<t;++i)this._data[r+i]=e[i];this._tail=r+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function _e(e,t){!e.leaf||e.level<$.maxTileNeighborLevelDelta||xe(e,e=>{t&&be(e);const r=we(e);if(e.maxLevelDeltaNeighborCount++,r){let t=e.parent;for(;t;){const e=we(t);if(t.unmergableChildCount++,!e)break;t=t.parent}}})}function be(e){if(e.hasPendingUpdate(1))return;let t=e.parent;for(;t?.resetPendingUpdate(4);)t=t.parent;e.resetPendingUpdate(4),e.leaf&&e.setPendingUpdate(1),e.level<$.maxTileNeighborLevelDelta||xe(e,e=>{be(e)})}function ve(e){e.level<$.maxTileNeighborLevelDelta||xe(e,e=>{if(e.maxLevelDeltaNeighborCount--,0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount){let t=e.parent;for(;t&&(t.unmergableChildCount--,we(t));)t=t.parent}})}function we(e){return 0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount}function xe(e,t){if(e.level<$.maxTileNeighborLevelDelta)return;const r=e.level-$.maxTileNeighborLevelDelta,i=e.lij[1]>>$.maxTileNeighborLevelDelta,s=e.lij[2]>>$.maxTileNeighborLevelDelta,n=e=>e.leaf||e.level===r;for(let o=0;o<4;++o){const a=e.findNeighborTile(Y.neighborEdgeIndices[o],n);if(!a||a.level!==r)continue;const l=a.lij;l[1]===i&&l[2]===s||t(a)}}return ce})},"esri/core/MemCachePool":function(){define(["exports","./Logger","./MemCache"],function(e,t,r){"use strict";class i extends Array{constructor(e){super(),this.item=e,this.cachedMemory=e.cachedMemory,this.push(e)}}e.MemCachePool=class{constructor(e,r){this._cache=e(r,(e,r,i)=>{switch(r){case 0:return e.forEach(e=>e.dispose()),0;case 1:{const r=e.shift();return r?(i-=Math.round(r.cachedMemory),r.dispose()):i>0&&(t.getLogger("esri/core/MemCachePool").warn("Encountered empty MemCachePool with non-zero memory."),i=0),i}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const r=t.pop();return t.length>0?r&&(t.cachedMemory=this._cache.getSize(e)-Math.round(r.cachedMemory),this._cache.updateSize(e,t)):this._cache.pop(e),r}put(e,t,s=r.NoPriority){const n=this._cache.peek(e);if(!n){const r=new i(t);return void this._cache.put(e,r,s)}n.push(t),n.cachedMemory=this._cache.getSize(e)+Math.round(t.cachedMemory),this._cache.updateSize(e,n)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/ElevationQueryTileCache":function(){define(["exports"],function(e){"use strict";e.ElevationQueryTileCache=class{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,t){this._store.put(e,t)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/extentUtils":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/projection/projectBuffer"],function(e,t,r){"use strict";const i=t.create();e.projectToBoundingBox=function(e,t,s){if(null==e||null==s)return!1;let n=!0;return i[0]=null!=e.xmin?e.xmin:0,i[1]=null!=e.ymin?e.ymin:0,i[2]=null!=e.zmin?e.zmin:0,n=n&&r.projectBuffer(i,e.spatialReference,0,t,s,0),i[0]=null!=e.xmax?e.xmax:0,i[1]=null!=e.ymax?e.ymax:0,i[2]=null!=e.zmax?e.zmax:0,n=n&&r.projectBuffer(i,e.spatialReference,0,t,s,3),null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.zmin&&(t[2]=-1/0),null==e.xmax&&(t[3]=1/0),null==e.ymax&&(t[4]=1/0),null==e.zmax&&(t[5]=1/0),n},e.toBoundingRect=function(e,t,s){if(null==e||null==s)return!1;let n=!0;return i[0]=null!=e.xmin?e.xmin:0,i[1]=null!=e.ymin?e.ymin:0,i[2]=null!=e.zmin?e.zmin:0,n=n&&r.projectBuffer(i,e.spatialReference,0,i,s,0),t[0]=i[0],t[1]=i[1],i[0]=null!=e.xmax?e.xmax:0,i[1]=null!=e.ymax?e.ymax:0,i[2]=null!=e.zmax?e.zmax:0,n=n&&r.projectBuffer(i,e.spatialReference,0,i,s,0),t[2]=i[0],t[3]=i[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/updatingProperties":function(){define(["exports"],function(e){"use strict";const t={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};e.updatingProgress=t,e.updatingProgressValue={value:.5,readOnly:!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/ElevationBounds":function(){define(["exports"],function(e){"use strict";e.ElevationBounds=class{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/ElevationData":function(){define(["exports","../../../core/mathUtils","../../../layers/support/ElevationSamplerData","../support/mathUtils","./TerrainConst"],function(e,t,r,i,s){"use strict";const n=.5*s.elevationNoDataValue;e.ElevationData=class{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new r.ElevationSamplerData(i,t)}computeMinMaxValue(e,t,r,n){n.min=1/0,n.max=-1/0,n.hasNoDataValues=!1;const o=e-this.level;if(o<=0)return n;const a=2**o;if(Math.floor(t/a)!==this.i||Math.floor(r/a)!==this.j)return n;let l=1/0,c=-1/0;const u=this.samplerData.data.width,d=this.samplerData.data.values,h=.5*s.elevationNoDataValue;let p=(u-1)/a,f=(r-this.j*a)*p,m=(t-this.i*a)*p;if(p<1){const e=Math.floor(f),t=Math.floor(m),r=e+t*u,s=d[r],o=d[r+1],a=d[r+u],l=d[r+u+1];if(s+o+a+l<h){const r=f-e,c=m-t,u=i.bilerp(s,o,a,l,r,c),d=i.bilerp(s,o,a,l,r+p,c),h=i.bilerp(s,o,a,l,r,c+p),g=i.bilerp(s,o,a,l,r+p,c+p);return n.min=Math.min(u,d,h,g),n.max=Math.max(u,d,h,g),n}f=e,m=t,p=1}else f=Math.floor(f),m=Math.floor(m),p=Math.ceil(p);for(let e=f;e<=f+p;e++)for(let t=m;t<=m+p;t++){const r=d[e+t*u];r<h?(l=Math.min(l,r),c=Math.max(c,r)):n.hasNoDataValues=!0}return n.min=l,n.max=c,n}},e.sampleElevation=function(e,r,i){if(null==i)return null;for(const s of i){if(!s)continue;const i=s.safeWidth;let o=t.clamp(s.dy*(s.y1-r),0,i),a=t.clamp(s.dx*(e-s.x0),0,i);const l=Math.floor(o),c=Math.floor(a),u=s.data.width,d=l*u+c,h=s.data.values,p=h[d],f=h[d+1],m=d+u,g=h[m],y=h[m+1];if(p+g+f+y<n){o-=l,a-=c;const e=p+(f-p)*a;return e+(g+(y-g)*a-e)*o}}return null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/ElevationSamplerData":function(){define(["exports"],function(e){"use strict";e.ElevationSamplerData=class{constructor(e,t){this.data=e,this.safeWidth=.99999999*(e.width-1),this.dx=(e.width-1)/(t[2]-t[0]),this.dy=(e.width-1)/(t[3]-t[1]),this.x0=t[0],this.y1=t[3]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/ExtentHelper":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/projectionUtils","../../../geometry/support/aaBoundingRect","../../../layers/support/layerUtils","./TerrainConst","./terrainUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.ExtentHelper=class extends r{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const r=t.layer;if("operationalLayerType"in r&&u.isIntegratedMeshOperationalLayer(r.operationalLayerType)&&null!=this.viewSpatialReference){const t=m(r.fullExtent,this.viewSpatialReference);null!=t&&e.push(c.fromExtent(t))}}),e}},t.__decorate([i.property({readOnly:!0})],e.ExtentHelper.prototype,"layerViewsExtent",null),t.__decorate([i.property({readOnly:!0})],e.ExtentHelper.prototype,"tiledLayersExtent",null),t.__decorate([i.property({readOnly:!0})],e.ExtentHelper.prototype,"stencilEnabledExtents",null),t.__decorate([i.property()],e.ExtentHelper.prototype,"viewSpatialReference",void 0),t.__decorate([i.property()],e.ExtentHelper.prototype,"tilingScheme",void 0),t.__decorate([i.property()],e.ExtentHelper.prototype,"defaultTiledLayersExtent",void 0),t.__decorate([i.property({constructOnly:!0})],e.ExtentHelper.prototype,"layers",void 0),t.__decorate([i.property({constructOnly:!0})],e.ExtentHelper.prototype,"layerViews",void 0),e.ExtentHelper=t.__decorate([a.subclass("esri.views.3d.terrain.ExtentHelper")],e.ExtentHelper);let p=class extends e.ExtentHelper{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?d.webMercatorWorldExtent:d.geographicWorldExtent}};p=t.__decorate([a.subclass("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],p);let f=class extends e.ExtentHelper{_computeLayerViewsExtent(){const e=c.empty(),t=this.viewSpatialReference;this.layerViews.forEach(r=>{const i=r.layer;if(r.isResolved()&&("graphics"!==i.type||!i.internal)){const i=m("fullExtentInLocalViewSpatialReference"in r&&r.fullExtentInLocalViewSpatialReference||r.layer.fullExtent,t);c.expand(e,i,e)}});const r=c.allFinite(e)?e:null,i=this._get("layerViewsExtent");return c.equals(r,i)?i:r}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,r=c.empty();this.layers.forEach(i=>{if(i.loaded&&u.isTiledLayer(i)){const s=h.getTiledLayerInfo(i,t,2);if(null==s)return;const{tileInfo:n,fullExtent:o}=s,a="tilemapCache"in i?i.tilemapCache?.effectiveMaxLOD:void 0;null!=n&&null!=o&&(h.isProjectableRasterLayer(i)||e.compatibleWith(n,a)&&o.spatialReference.equals(e.spatialReference))&&c.expand(r,o,r)}}),c.expand(r,this.defaultTiledLayersExtent,r);const i=c.allFinite(r)?r:null,s=this._get("tiledLayersExtent");return c.equals(i,s)?s:i}};function m(e,t){return null==e||e.spatialReference.equals(t)?e:l.projectWithoutEngine(e,e.spatialReference,t)}f=t.__decorate([a.subclass("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],f),e.create=function(e,t){return 1===e?new p(t):new f(t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/terrainUtils":function(){define(["exports","../../../core/Collection","../../../geometry/support/spatialReferenceUtils","../../../layers/support/layerUtils","./TerrainData","../../../chunks/terrainUtilsPlanar","../../../chunks/terrainUtilsSpherical"],function(e,t,r,i,s,n,o){"use strict";const a={1:o.terrainUtilsSpherical,2:n.terrainUtilsPlanar};function l(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function c(e){return"imagery-tile-3d"===e?.type}function u(e){return"tile-3d"===e?.type}function d(e){return"vector-tile-3d"===e?.type}function h(e){return"wmts-3d"===e?.type}function p(e){return"elevation-3d"===e?.type}function f(e){return e&&(u(e)||c(e)||d(e)||h(e))}function m(e){return s.isVectorTile(e?.data)}function g(e,t,r,i,s){return a[i].checkIfTileInfoSupportedForViewSR(e,r,t,s)}function y(e,r,s){const n=i.getTileMaxtrixSetFromActiveLayer(e);if(null!=n){if(!t.isCollection(n))return{tileInfo:n.tileInfo,fullExtent:n.fullExtent};{const e=n.find(e=>null==g(e.tileInfo,e.fullExtent,r,s));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}function _(e){return e.isWGS84||e.isWebMercator||r.isCGCS2000(e)||!r.isEarth(e)}e.enableTerrainInternalChecks=!1,e.enableWaterproofTests=!1;const b={force512VTL:!1},v=1e-5;e.almostEquals=function(e,t,r=v){return Math.abs(e-t)<r},e.checkIfTileInfoSupportedForView=g,e.enableInternalTerrainChecks=function(t){e.enableTerrainInternalChecks=t},e.enableTerrainWaterproofChecks=function(t){e.enableWaterproofTests=t,e.enableTerrainInternalChecks=e.enableTerrainInternalChecks||t},e.eps=v,e.getTileInfoAndExtentFromWMTSLayer=y,e.getTiledLayerInfo=function(e,t,r){let i=null,s=null;if("wmts"===e?.type){const n=y(e,t,r);i=n.tileInfo,s=n.fullExtent}else{s=l(e)?e.getCompatibleFullExtent(t):e.fullExtent;const n=2===r;i=l(e)?e.getCompatibleTileInfo(t,s,n):"vector-tile"===e?.type?n&&!_(t)||b.force512VTL?e.tileInfo:e.tileInfo.getCompatibleForVTL(256):e.tileInfo}const n="tilemapCache"in e?e.tilemapCache?.effectiveMaxLOD:void 0;return null!=i&&null!=s&&null==g(i,s,t,r,n)?{tileInfo:i,fullExtent:s}:null},e.internalAssert=function(t,r){if(e.enableTerrainInternalChecks&&!t){const e=(new Error).stack?.slice(5);throw console.warn("Terrain internal: "+(r??"")+" at "+e),new Error("Assertion failed"+(r?": "+r:""))}},e.isBlendableLayerView=function(e){return e&&(u(e)||h(e)||c(e)||d(e))},e.isEast=function(e){return 1===e||2===e||3===e},e.isElevationLayer=function(e){return"elevation"===e?.type},e.isElevationLayerView=p,e.isGroupLayerView=function(e){return"group"===e?.type},e.isImageSourceRenderInfo=function(e){const t=e?.sourceLayerInfo?.data;return s.isImageWithType(t)||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData},e.isImageryTileLayerView=c,e.isImageryTileRenderInfo=function(e){return s.isRasterTile(e?.sourceLayerInfo?.data)},e.isMapTileLayerView=f,e.isNorth=function(e){return 1===e||0===e||7===e},e.isNorthCorner=function(e){return 7===e||1===e},e.isProjectableRasterLayer=l,e.isSouth=function(e){return 3===e||4===e||5===e},e.isSurfaceLayerView=function(e){return f(e)||p(e)},e.isTextureTileRenderInfo=function(e){return s.isTileTexture(e?.sourceLayerInfo?.data)},e.isTileLayerView=u,e.isVectorTileLayerView=d,e.isVectorTilePerLayerInfo=m,e.isVectorTileRenderInfo=function(e){return m(e?.sourceLayerInfo)||!!e?.isVTLBackground},e.isWMTSLayerView=h,e.isWest=function(e){return 7===e||6===e||5===e},e.isWestCorner=function(e){return 7===e||5===e},e.lij2s=function(e){return"["+e[0]+","+e[1]+","+e[2]+"]"},e.neighborCornerIndices=[1,3,5,7],e.neighborEdgeIndices=[0,2,4,6],e.oppositeCorner=function(e){return 1===e?5:7===e?3:5===e?1:7},e.oppositeEdge=function(e){return 0===e?4:2===e?6:4===e?0:2},e.releaseTerrainData=function(e){return null!=e&&"release"in e&&e.release(),null},e.test=b,e.useFetchTileForLayer=function(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile},e.v32s=function(e){return"("+e[0]+","+e[1]+","+e[2]+")"},e.vtlAssumes256PixelSizeAsDefault=_,e.weakAssert=function(e,t){e||console.warn("Terrain: "+t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/terrainUtilsPlanar":function(){define(["exports","../core/Error","../geometry/support/aaBoundingRect","../views/3d/support/supportedSpatialReference","../views/3d/terrain/TerrainConst","../views/3d/terrain/TilingScheme"],function(e,t,r,i,s,n){"use strict";function o(e,o,a,l){if(null==e)return n.getMissingTileInfoError();const c=e.spatialReference;if(c.isGeographic&&!i.isSupportedEarthGCS(c))return new t("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const u=n.TilingScheme.checkUnsupported(e);if(null!=u)return u;if(null==a)return new t("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const d=function(e,i){const o=e.lods,a=o[0].resolution*2**o[0].level,l=[a*e.size[0],a*e.size[1]],c=[e.origin.x,e.origin.y],u=r.fromExtent(i),d=r.create();n.TilingScheme.computeRowColExtent(u,l,c,d);const h=(d[2]-d[0])*(d[3]-d[1]);if(h>s.maxRootTiles){const r=o[0].scale*2**o[0].level;let i=Math.max((u[3]-u[1])/e.size[1],(u[2]-u[0])/e.size[0])*r/a;const n=Math.floor(Math.log(i)/Math.log(10));return i=Math.ceil(i/10**n)*10**n,new t("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(r).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+i.toLocaleString()+".",{level0Scale:r,suggestedLevel0Scale:i,requiredNumRootTiles:h,allowedNumRootTiles:s.maxRootTiles})}return null}(e,a);return d||(null==o||c.equals(o)||o.isWGS84&&c.isWebMercator?null:new t("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"))}const a=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:o},Symbol.toStringTag,{value:"Module"}));e.checkIfTileInfoSupportedForViewSR=o,e.terrainUtilsPlanar=a})},"esri/views/3d/support/supportedSpatialReference":function(){define(["exports","../../../geometry/support/spatialReferenceUtils"],function(e,t){"use strict";function r(e){return t.isWGS84(e)||t.isCGCS2000(e)}e.isSupportedEarthGCS=r,e.isSupportedGCSOnGlobe=function(e){return r(e)||t.isMars(e)||t.isMoon(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/terrainUtilsSpherical":function(){define(["exports","../core/Error","../views/3d/support/supportedSpatialReference","../views/3d/terrain/TilingScheme"],function(e,t,r,i){"use strict";function s(e,s,n,o){if(null==e)return i.getMissingTileInfoError();const a=e?.lods.length-1,l=e.spatialReference;if(l.isWebMercator){if(!i.TilingScheme.makeWebMercatorAuxiliarySphere(a).compatibleWith(e,o))return new t("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!r.isSupportedGCSOnGlobe(l))return new t("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!i.TilingScheme.makeGCSWithTileSize(e.spatialReference,e.size[0],a).compatibleWith(e,o))return e.spatialReference.isWGS84?new t("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new t("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return null==s||e.spatialReference.equals(s)?null:new t("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}const n=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:s},Symbol.toStringTag,{value:"Module"}));e.checkIfTileInfoSupportedForViewSR=s,e.terrainUtilsSpherical=n})},"esri/views/3d/terrain/LayerClass":function(){define(["exports"],function(e){"use strict";e.LayerClasses=[0,1],Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/OverlayManager":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Cyclical","../../../core/has","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/vec2","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/ellipsoidUtils","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingRect","../../../geometry/support/ray","../../../chunks/sphere","../../../geometry/support/vector","../../../geometry/support/webMercatorUtils","../state/utils/viewUtils","../support/debugFlags","../support/debugUtils","./OverlayRenderer","../webgl-engine/lib/Intersector","../webgl-engine/lib/LocalOriginFactory","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/textureUtils","../webgl-engine/parts/renderUtils","../../support/Scheduler","../../support/Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E){"use strict";const L=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let V;e.OverlayManager=class extends r{constructor(e){super(e),this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._latestOriginId=0}initialize(){const e=this.view;this.renderer=new M.OverlayRenderer({parent:this}),e.stage.renderer.plugins.add(this.renderer);const t=()=>this.requestRender();this._groundIntersector=new R.Intersector(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([a.watch(()=>this.renderer.hasHighlights,t),this.renderer.events.on("has-water",()=>e.stage?.renderer.updateHasFlags()),this.renderer.events.on("content-changed",t),a.watch(()=>e.state.camera.pixelRatio,t),a.watch(()=>e.state.alignPixelEnabled,t),this.renderer.events.on("textures-disposed",()=>this.surface.requestRender()),a.watch(()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location],()=>this.setPlacementDirty()),a.watch(()=>[e.state?.pixelRatio,e.state?.contentPixelRatio],()=>this.setPlacementDirty(),a.sync),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(D.TaskPriority.OVERLAY,this)]),e.stage.renderer.overlay=this}destroy(){this.view?.stage&&(this.view.stage.renderer.plugins.remove(this.renderer),this.view.stage.renderer.overlay=null,o.destroyMaybe(this.renderer)),V&&(V.hide(),V=null),this.renderer=null}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.renderer.longitudeCyclical=null;const t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this.renderer.longitudeCyclical=e.isWebMercator?new i.Cyclical(-20037508.342787,20037508.342787):new i.Cyclical(-180,180))):this.renderer.disposeOverlays()}get readyToRun(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||C.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get worldToPCSRatio(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?y.getReferenceEllipsoid(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return 1.3/this.view.resolutionScale}get _longitudeCyclical(){return this.renderer.longitudeCyclical}get suspended(){return this.surface.suspended}get updating(){return this.readyToRun||!!this.renderer?.updating||this._contentUpdated}render(){return this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.precompileShaders(this.view.state)?this._drawOverlays():null}get hasOverlays(){return this.renderer.hasOverlays}registerDrapeSource(e,t){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this.renderer.registerDrapeSource(e,t),this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("readyToRun")}registerGeometryDrapeSource(e){const t=new I.SortedRenderGeometryRenderer({stage:this.view.stage,drapeSource:e,rendererContext:this.renderer});return this.registerDrapeSource(e,t),t}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("readyToRun"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.requestRender()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this.updateOverlays(e,this.view.state.contentCamera,1)}updateOverlays(e,t,r){if(!this._spatialReference)return E.Yield;const i=this._computeOverlayHeight(t);this._computeOverlayExtents(t,i,N),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,N.stretch);const s=this._updateOverlay(0,N.inner,i,1*N.pixelRatioAdjustment,N.mapUnitsPerPixel),n=b.width(N.inner)/b.width(N.outer),o=this._updateOverlay(1,N.outer,i,n*N.pixelRatioAdjustment,N.mapUnitsPerPixel);1!==s&&1!==o||(this._drapeSources.forEach(e=>this._updateDrapeSourceExtent(e)),this.updateOverlayParameters(r)),0===s&&0===o||this.requestRender(),this._placementDirty=!1,e.madeProgress()}_computeOverlayHeight(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,r=e.fullWidth/e.pixelRatio*t,i=e.fullHeight/e.pixelRatio*t,s=Math.ceil(1.5*Math.max(r,i)),{maxPreferredTexturePixels:n,maxTextureSize:o}=this.view.stage.renderView.renderingContext.parameters,a=.5*o;return F.applyTextureResizeModulo(F.ensureTextureSize({width:s,height:s},{maxPreferredTexturePixels:2*n,maxTextureSize:a})[1],a)}_updateOverlay(e,t,r,i,s){if(0===this.renderer.overlays.length)return 0;const n=this.renderer.overlays[e],o=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=s,n.pixelRatio=i,function(e,t){const r=C.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r}(t,n.extent)&&r===n.resolution)return o===s?0:2;b.copy(n.extent,t),n.resolution=r;const a=b.center(n.extent);return n.renderLocalOrigin=O.fromValues(a[0],a[1],0,"OV_"+this._latestOriginId++),1}updateOverlayParameters(e){this.surface.allTiles.forAll(e=>this.updateTileOverlayParameters(e)),this.surface.requestRender(e)}updateTileOverlayParameters(e){if(!e.renderData)return;const t=e.renderData.overlay;if(0===this.renderer.overlays.length)this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t);else{const[r,i]=this.renderer.overlays,s=e.extent;this._rectInsideRect(r.extent,s)||this._rectanglesOverlap(s,r.extent)||this._rectanglesOverlap(s,i.extent)?(this._setTileOverlayData(s,0,t),this._setTileOverlayData(s,1,t)):(this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t))}}overlayPixelSizeInMapUnits(e,t){if(0===this.renderer.overlays.length)return t();const r=this.renderer.overlays[0],i=this.renderer.overlays[1],s=this._pointIsInExtent(e,r.extent)?r:i;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,t,r){if(0===this.renderer.overlays.length)return;const i=this.renderer.overlays[t].extent,s=b.width(i),n=b.height(i);let o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(i[0],o);const t=this._longitudeCyclical.minimalMonotonic(i[0],e[2]);o>t&&(o=t-(e[2]-e[0]))}r.setScale(t,b.width(e)/s,b.height(e)/n),r.setOffset(t,(o-i[0])/s,(e[1]-i[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}reloadShaders(){A.removeLoadedShaderModules(),this.requestRender(),this.runTask(D.noBudget)}requestRender(e=1){this.renderer.hasOverlays?(1===e?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this._drawTexturesAnimateDirty=!0,this.view.stage.renderView.requestRender(e)):this.setPlacementDirty()}_intersectGroundFromView(e,t,r,i,s){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,j,t,r);if(null==n)return!1;const o=n.origin,a=p.add(B,n.origin,n.direction);this._groundIntersector.reset(o,a,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,o,a);const l=this._groundIntersector.results.min;return l.getIntersectionPoint(s)&&l.withinDistance(i)}_findHorizonBasedPointOfInterest(e,t){let r=.5;const s=.55,o=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,l=1e-5,c=n.clamp(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:o+l,e.aboveGround?o-l:1/0),u=e.aboveGround;if("global"===this.view.viewingMode){const t=B;w.closestPointOnSilhouette(w.fromRadius(w.tmpSphere,y.getReferenceEllipsoid(this.view.spatialReference).radius+c),v.wrap(e.eye,e.viewForward),t),p.subtract(t,t,e.eye);const n=i.cyclicalPI.normalize(x.angleAroundAxis(e.viewForward,t,e.viewRight))/e.fovY+.5,o=n<=0||n>=1?.5:s;r=u?o*n:n+o*(1-n)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),i=Math.tan(t),o=g.fromValues(0,i,1,0),a=m.transformMat4(o,o,e.projectionMatrix)[1],l=n.clamp(.5+.5*a,0,1);r=1===l||0===l?.5:u?l*s:1-(1-l)*s}return this._intersectGroundFromView(e,.5,r,a.distance,t)}_computeOverlayExtents(e,t,r){const i=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=f.create();this._findHorizonBasedPointOfInterest(e,s)||p.copy(s,i),C.debugFlags.OVERLAY_SHOW_CENTER?(null==V&&(V=new P.DebugPoint(this.view.graphics,"red")),V.show(s,this._renderSR)):null!=V&&V.hide();const o=Math.max(.1,p.distance(e.eye,s)),a=T.viewAngle(this.view.renderCoordsHelper,i,e.eye);this._overlaySREqualsRenderSR||_.projectVectorToVector(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent,c=!this._isSpherical&&this._spatialReference?.isGeographic,u=c&&this._spatialReference?1/y.getReferenceEllipsoid(this._spatialReference).metersPerDegree:1,d=this.view.state.contentPixelRatio,g=e.perScreenPixelRatio/d*o*u;r.mapUnitsPerPixel=g/this.worldToPCSRatio,r.stretch=this._overlayStretch;let v=t*g/2*r.stretch,w=!1,x=c?90:1/0;this._isSpherical&&l&&this._spatialReference&&(this._spatialReference.isWebMercator?(v/=Math.cos(S.y2lat(s[1])),x=l[3]):(w=!0,v/=y.getReferenceEllipsoid(this._spatialReference).metersPerDegree,x=90),v>=x&&(v=x,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let M=1;w&&(M=1/Math.max(.2,Math.cos(Math.abs(n.deg2rad(s[1])))),v*M>180&&(M=180/v),r.mapUnitsPerPixel*=M);const R=Math.log(2)/12;v=Math.exp(Math.round(Math.log(v)/R)*R);const O=v*M,I=.5*t/(32*O),F=.5*t/(32*v);s[0]=Math.round(s[0]*I)/I,s[1]=Math.round(s[1]*F)/F;const A=r.inner;A[0]=s[0]-O,A[1]=s[1]-v,A[2]=s[0]+O,A[3]=s[1]+v,this._isSpherical&&this._shiftExtentToFitBounds(A,1/0,x);const D=r.outer;if(6*O>b.width(l))b.copy(D,l);else if(Math.PI/2-Math.abs(a-Math.PI/2)<=.25*Math.PI)D[0]=A[0]-O,D[1]=A[1]-v,D[2]=A[2]+O,D[3]=A[3]+v;else{_.projectVectorToVector(e.eye,this._renderSR,B,this._spatialReference),h.subtract(U,s,B);let t=-Math.atan2(U[1],U[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const r=Math.floor(t/(.25*Math.PI));m.scale(U,L[r],2*v),U[0]*=M,U[2]*=M,m.add(D,A,U)}if(this._isSpherical)D[0]=this._longitudeCyclical.clamp(D[0]),D[2]=this._longitudeCyclical.clamp(D[2]),D[1]=Math.max(D[1],-x),D[3]=Math.min(D[3],x);else{const e=b.intersection(A,l,k),t=b.intersection(D,l,z);b.contains(e,t)&&(D[2]=D[0],D[3]=D[1])}const E=Math.abs(A[2]-A[0])/t;r.mapUnitsPerPixel=Math.max(r.mapUnitsPerPixel,E),r.pixelRatioAdjustment=r.mapUnitsPerPixel/E}_drawOverlays(e=this.view.state){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const t=!this._drawTexturesDirty&&this._drawTexturesAnimateDirty?0:1;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const r=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(t),this.renderer.drawOverlays(e,t),r!==this.renderer.computeValidity()&&this.updateOverlayParameters(1),this.surface.requestRender(t),1===t&&this.surface.requestUpdate(),this.renderer}_rectanglesOverlap(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):b.intersects(e,t))}_rectInsideRect(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:b.contains(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const r=e.x,i=e.y;return r>t[0]&&r<t[2]&&i>t[1]&&i<t[3]}_shiftExtentToFitBounds(e,t,r){let i=0,s=0;e[0]<-t?i=e[0]+t:e[2]>t&&(i=t-e[2]),e[1]<-r?s=e[1]+r:e[3]>r&&(s=r-e[3]),b.offset(e,i,s)}get test(){}},t.__decorate([l.property()],e.OverlayManager.prototype,"_spatialReference",void 0),t.__decorate([l.property({readOnly:!0})],e.OverlayManager.prototype,"readyToRun",null),t.__decorate([l.property()],e.OverlayManager.prototype,"_placementDirty",void 0),t.__decorate([l.property()],e.OverlayManager.prototype,"_contentUpdated",void 0),t.__decorate([l.property()],e.OverlayManager.prototype,"_isSpherical",null),t.__decorate([l.property()],e.OverlayManager.prototype,"worldToPCSRatio",null),t.__decorate([l.property()],e.OverlayManager.prototype,"renderer",void 0),t.__decorate([l.property({constructOnly:!0})],e.OverlayManager.prototype,"view",void 0),t.__decorate([l.property({constructOnly:!0})],e.OverlayManager.prototype,"surface",void 0),t.__decorate([l.property()],e.OverlayManager.prototype,"suspended",null),t.__decorate([l.property()],e.OverlayManager.prototype,"updating",null),e.OverlayManager=t.__decorate([d.subclass("esri.views.3d.terrain.OverlayManager")],e.OverlayManager);const U=g.create(),B=f.create(),N=new class{constructor(){this.inner=b.create(),this.outer=b.create(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=1.3}},k=b.create(),z=b.create(),j=v.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/OverlayRenderer":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Evented","../../../core/has","../../../core/MapUtils","../../../core/maybe","../../../core/PooledArray","../../../core/reactiveUtils","../../../core/SetUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat4","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../support/debugFlags","./Overlay","./OverlayRenderTargets","../webgl/RenderCamera","../../../chunks/TextureOnly.glsl","../webgl-engine/effects/RenderPlugin","../webgl-engine/effects/highlight/Highlight","../webgl-engine/lib/GLMaterialRepository","../webgl-engine/lib/GridLocalOriginFactory","../webgl-engine/lib/RenderContext","../webgl-engine/lib/ShadowMap","../webgl-engine/lib/TextureTechnique","../webgl-engine/lib/TextureTechniqueConfiguration","../webgl-engine/lighting/Lightsources","../../../chunks/OverlayCompositing.glsl","../webgl-engine/shaders/OverlayCompositingTechnique","../../support/Scheduler","../../webgl/Texture","../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E){"use strict";e.OverlayRenderer=class extends w.SyncRenderPlugin{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new I.OverlayCompositingPassParameters,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new o,this._passParameters=new v.TextureOnlyPassParameters,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new b,this.events=new r.EventEmitter,this.longitudeCyclical=null,this.produces=new Map([[18,e=>8!==e||this.hasHighlights],[19,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){const e=this._view,t=e.stage,r=t.renderer.fboCache,{waterTextures:i,techniques:s}=t.renderView;this._renderContext=new C.RenderContext(this._rctx,new P.ShadowMap(r,e.state.viewingMode),s),this.addHandles([a.watch(()=>i.updating,()=>this.events.emit("content-changed"),a.syncAndInitial),a.watch(()=>this.spatialReference,e=>this._localOriginFactory=new T.GridLocalOriginFactory(e),a.syncAndInitial),a.on(()=>e.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),a.watch(()=>x.trackHighlightOptions(e.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,a.initial),a.watch(()=>e.state.highlights,t=>{this._bindParameters.highlights=t,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap},a.initial),e.resourceController.scheduler.registerTask(A.TaskPriority.OVERLAY_RENDERER,this)]);const{_bindParameters:n,_camera:o}=this;o.near=1,o.far=1e4,o.relativeElevation=null,n.slot=18,n.mainDepth=null,n.camera=o,n.oitPass=0,n.updateLighting([new O.AmbientLight(m.ones())],0,0,0)}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=n.disposeMaybe(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){const t=new S.GLMaterialRepository(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));this._pluginContext={...e,materials:t},this._techniques.precompile(F.OverlayCompositingTechnique)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||s.someMap(this._renderers,e=>e.updating||e.canCompact)}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMaterialRenderer(e){for(const t of this._renderers.values()){const r=t.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e)}registerDrapeSource(e,t){const r=this._renderers.get(e);null!=r&&r.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(a.watch(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e)}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(e){this._renderTargets?.dispose(e)}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&l.someSet(e,e=>1===e.drapeTargetType)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=l.someSet(e,e=>1===e.drapeSourceType),this._hasDrapedRasterSource=l.someSet(e,e=>0===e.drapeSourceType),this._hasDrapedFlowSource=l.someSet(e,e=>2===e.drapeSourceType)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){null==this._overlays&&(this._renderTargets=new _.OverlayRenderTargets(this._stage.renderer.fboCache),this._overlays=[new y.Overlay,new y.Overlay]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets?.dispose(1),this._renderTargets=null,this.events.emit("textures-disposed")}_useOverlayColorInsteadOfColorNoRasterImage(e){return 1===e&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(e){return this._useOverlayColorInsteadOfColorNoRasterImage(e)?this._renderTargets?.getTexture(0):this._renderTargets?.getTexture(e)}get readyToRun(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=s.someMap(this._renderers,e=>e.hasOccluders)?U:1}_processDrapeSources(e,t){let r=!1;for(const[i,s]of this._renderers){if(e.done)break;(i.destroyed||t(i))&&s.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),r&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this._onMaterialOrContentChanged(),this.hasHighlights=s.someMap(this._renderers,e=>e.hasHighlights),this.events.emit("content-changed"))}compact(e){let t=!1;for(const r of this._renderers.values()){if(e.done)break;t=r.compact(e)||t}return t&&this.notifyChange("updating"),t}hasHighlight(e){return s.someMap(this._renderers,t=>t.hasHighlight(e))}processSyncDrapeSources(){this._processDrapeSources(A.noBudget,e=>1===e.updatePolicy)}get isEmpty(){return!g.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE&&s.everyMap(this._renderers,e=>e.isEmpty)}get hasWater(){const e=s.someMap(this._renderers,({hasWater:e})=>e);return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}renders(e){if(g.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE&&4!==e&&2!==e)return!0;if(!this._overlays)return!1;const t=this._overlays[0];for(const e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;const r=this._renderContext.output;this._renderContext.output=this._renderTargets?.targets.find(t=>t.content===e)?.output??0,++this._techniques.precompiling;const i=this._sortedRenderers.some(({renderer:e})=>e.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.output=r,i}get mode(){return this.isEmpty?0:this.hasWater&&this.renders(3)?2:this._renderTargets?.getTexture(0)?1:0}updateAnimation(e){let t=!1;return this._renderers.forEach(r=>t=r.updateAnimation(e)||t),t&&this.parent.requestRender(0),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return!1;const t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const e of this._renderTargets.targets){if(1===e.content&&!this._needsColorWithoutRasterImage)continue;const r=e.output;this._renderContext.output=r,t.slot=3===r?19:18,8===r&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null);const i=this._renderContext.renderOccludedMask;4===e.content&&(this._renderContext.renderOccludedMask=U),this._sortedRenderers.forAll(({drapeSource:t,renderer:r})=>{1===e.content&&0===t.drapeSourceType||4===e.content&&r.hasOnlyOccluders||r.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=i,t.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(e,t){if(!this._overlays||!this._renderTargets)return;for(const e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;const r=this.allSourcesOccluders;for(const e of this._renderTargets.targets){if((0!==e.content||!this._hasDrapedFlowSource)&&!e.handleRenderRequest(t)||1===e.content&&!this._needsColorWithoutRasterImage||4===e.content&&r)continue;const i=this._drawTarget(0,e),s=this._drawTarget(1,e);(i||s)&&e.fbo.generateMipMap()}}_drawTarget(e,t){const r=this._overlays[e],i=r.canvasGeometries;if(0===i.numViews)return!1;const s=this._view.state.contentPixelRatio;this._screenToWorldRatio=s*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:n}=t;if(this.isEmpty||3===n&&!this.hasWater||!r.hasSomeSizedView())return!1;const{_rctx:o,_camera:a,_renderContext:l,_bindParameters:c}=this;if(a.pixelRatio=r.pixelRatio*s,l.output=n,c.screenToWorldRatio=this._screenToWorldRatio,c.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,c.slot=3===n?19:18,4===t.content&&(l.renderOccludedMask=U),!this.renders(t.content))return l.renderOccludedMask=C.defaultRenderOccludedMask,!1;const{resolution:u}=r,d=0===e,h=d?0:u;if(o.setViewport(h,0,u,u),this._bindTargetFBO(t),d)if(8!==t.output)o.setClearColor(0,0,0,0),o.clear(16384);else{const{gl:e}=o;e.clearBufferuiv(e.COLOR,0,[0,0,0,0])}if(g.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE&&4!==t.content&&2!==t.content){this._techniques.precompile(M.TextureTechnique,B);const t=this._techniques.get(M.TextureTechnique,B);for(let s=0;s<i.numViews;s++)this._setViewParameters(i.extents[s],r),this._ensureDebugPatternResources(r.resolution,V[e]),o.bindTechnique(t,c,this._passParameters),o.screen.draw()}if(8===t.output){const{fboCache:r}=this._stage.renderer,i=this._resolution;this._bindTargetFBO(t),x.renderHighlightBuffer(o,r,{width:i,height:i},c,()=>this._renderAllGeometry(e,t),h)}else this._renderAllGeometry(e,t);return o.bindFramebuffer(null),l.renderOccludedMask=C.defaultRenderOccludedMask,!0}get allSourcesOccluders(){return s.everyMap(this._renderers,e=>e.hasOnlyOccluders)}_renderAllGeometry(e,t){const r=this._overlays[e],i=r.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:s,renderer:n})=>{if(1===t.content&&0===s.drapeSourceType)return;const{fullOpacity:o}=s,a=null!=o&&o<1&&0===t.output&&this._bindTemporaryFBO();for(let e=0;e<i.numViews;e++)this._setViewParameters(i.extents[e],r),n.render(this._renderContext);if(a){this._bindTargetFBO(t),this._overlayParameters.texture=a.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=e;const r=this._techniques.get(F.OverlayCompositingTechnique);this._rctx.bindTechnique(r,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),a.release()}})}_bindTargetFBO(e){const t=this._resolution,r=2*t;e.fbo.ensureFramebuffer(r,t),e.fbo.bind(this._rctx)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,r=this._stage.renderer.fboCache,i=r.acquire(t,e,"overlay tmp");return r.rctx.bindFramebuffer(i.fbo),r.rctx.clear(16384),i}get _resolution(){return this._overlays?.[0].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,i){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let s=0;for(const{renderer:n}of this._sortedRenderers)s=n.intersect?.(e,t,r,i,s)??s}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this._view.map.allLayers,t=e.length;this._renderers.forEach((r,i)=>{const s=e.indexOf(i.layer),n=s>=0,o=i.renderGroup??(n?0:1),a=i.drapeSourcePriorityOffset??0,l=t*o+(n?s:0)+a;this._sortedRenderers.push(new L(i,r,l))}),this._sortedRenderers.sort((e,t)=>e.index-t.index)}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],p.ortho(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),p.fromTranslation(r.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if(f.set(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let i=0;for(let t=0;t<e;t++)for(let s=0;s<e;s++){const n=Math.floor(s/10),o=Math.floor(t/10);n<2||o<2||10*n>e-20||10*o>e-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&n&&1&o?1&s^1&t?0:255:1&n^1&o?0:128)}const s=new E.TextureDescriptor(e);s.samplingMode=9728,this._passParameters.texture=new D.Texture(this._rctx,s,r)}get test(){}},t.__decorate([c.property()],e.OverlayRenderer.prototype,"hasHighlights",void 0),t.__decorate([c.property()],e.OverlayRenderer.prototype,"renderOccludedFlags",void 0),t.__decorate([c.property()],e.OverlayRenderer.prototype,"_sortedDrapeSourceRenderersDirty",void 0),t.__decorate([c.property({constructOnly:!0})],e.OverlayRenderer.prototype,"parent",void 0),t.__decorate([c.property({readOnly:!0})],e.OverlayRenderer.prototype,"_techniques",null),t.__decorate([c.property({type:Boolean,readOnly:!0})],e.OverlayRenderer.prototype,"updating",null),t.__decorate([c.property()],e.OverlayRenderer.prototype,"isEmpty",null),e.OverlayRenderer=t.__decorate([h.subclass("esri.views.3d.terrain.OverlayRenderer")],e.OverlayRenderer);class L{constructor(e,t,r){this.drapeSource=e,this.renderer=t,this.index=r}}const V=[[1,.5,.5],[.5,.5,1]],U=4,B=new R.TextureTechniqueConfiguration;B.hasAlpha=!0,e.drapedZ=-2,e.overlayRenderOccludedFlag=U,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/Overlay":function(){define(["exports","../../../geometry/support/aaBoundingRect","../webgl-engine/lib/LocalOriginFactory"],function(e,t,r){"use strict";class i{constructor(){this.extents=[t.create(),t.create(),t.create()],this.numViews=0}}e.Overlay=class{constructor(){this._extent=t.create(),this.resolution=0,this.renderLocalOrigin=r.fromValues(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new i}get extent(){return this._extent}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;const r=.001*e.range;if(this._extent[0]-r<=e.min){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];t.offset(this._extent,e.range,0,r)}if(this._extent[2]+r>=e.max){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];t.offset(this._extent,-e.range,0,r)}}_setupGeometryView(){this.canvasGeometries.numViews=1,t.copy(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/LocalOriginFactory":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec3f64"],function(e,t){"use strict";class r{constructor(e,t){this.vec3=e,this.id=t}}e.LocalOrigin=r,e.fromValues=function(e,i,s,n){return new r(t.fromValues(e,i,s),n)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/OverlayRenderTargets":function(){define(["exports","./OverlayFramebufferObject","../webgl-engine/effects/geometry/olidUtils"],function(e,t,r){"use strict";class i{constructor(e,r,i,s,n=1,o=6){this.output=i,this.content=s,this.redrawOnRequest=n,this.fbo=new t.OverlayFramebufferObject(e,o,r)}handleRenderRequest(e){return 1===e||e===this.redrawOnRequest}get valid(){return this.fbo.valid}}e.OverlayRenderTargets=class{constructor(e){this.targets=[new i(e,"overlay color",0,0),new i(e,"overlay IM color",0,1),new i(e,"overlay highlight",8,2,1,3),new i(e,"overlay water",3,3,0),new i(e,"overlay occluded",0,4)],r.olidEnabled()&&this.targets.push(new i(e,"overlay olid",9,5,1,5))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(e){if(0!==e)for(const e of this.targets)e.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,t,r)=>t.valid?e|=1<<r:e,0)}},e.RenderTargetDescriptor=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/OverlayFramebufferObject":function(){define(["exports","../../../core/maybe"],function(e,t){"use strict";e.OverlayFramebufferObject=class{constructor(e,t,r){this._fbos=e,this._format=t,this._name=r}get valid(){return null!=this._handle?.getTexture()}dispose(){this._handle=t.releaseMaybe(this._handle)}get texture(){return this._handle?.getTexture()}ensureFramebuffer(e,t){this._handle&&this._handle.fbo?.width===e&&this._handle.fbo?.height===t||(this._handle?.release(),this._handle=this._fbos.acquire(e,t,this._name,this._format))}bind(e){e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/TextureOnly.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a){"use strict";class l extends o.NoParameters{constructor(){super(...arguments),this.color=t.fromValues(1,1,1)}}function c(){const e=new a.ShaderBuilder;return e.include(r.ScreenSpacePass),e.fragment.uniforms.add(new n.Texture2DPassUniform("tex",e=>e.texture),new i.Float3PassUniform("uColor",e=>e.color)),e.fragment.main.add(s.glsl`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:l,build:c},Symbol.toStringTag,{value:"Module"}));e.TextureOnly=u,e.TextureOnlyPassParameters=l,e.build=c})},"esri/views/3d/webgl-engine/effects/highlight/Highlight":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../webgl","../../../webgl/RenderNode","./HighlightApplyTechnique","./HighlightBlurTechnique","./HighlightDownsampleTechnique","./HighlightPassParameters","./HighlightToSingleTechnique","../../lib/DefaultVertexBufferLayouts","../../lib/VertexArrayObject","../../../../../chunks/HighlightBlur.glsl","../../../../../chunks/HighlightDownsample.glsl","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor","../../../../webgl/VertexBuffer"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C){"use strict";e.Highlight=class extends d{constructor(){super(...arguments),this.produces=u.InternalRenderCategory.HIGHLIGHTS,this.consumes={required:[u.InternalRenderCategory.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new v.HighlightDownsampleDrawParameters,this._passParameters=new m.HighlightPassParameters,this._highlightBlurDrawParameters=new b.HighlightBlurDrawParameters,this._grid=new P}initialize(){this.addHandles([s.watch(()=>this._updateOptionsTexture(),()=>{},s.initial)])}destroy(){this._grid.coverage=i.releaseMaybe(this._grid.coverage),this._grid.vao=i.disposeMaybe(this._grid.vao),this._passParameters.highlightOptionsTexture=i.releaseMaybe(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(null==this._passParameters.highlightOptionsTexture){const e=new T.TextureDescriptor(16,2);e.internalFormat=6408,e.samplingMode=9728,this._passParameters.highlightOptionsTexture=new S.Texture(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(function(e){const t=new Uint8Array(128);let r=0;for(const i of e){const e=4*r,s=4*r+64;++r;const{color:n}=i,o=i.haloColor??n;t[e+0]=n.r,t[e+1]=n.g,t[e+2]=n.b,t[e+3]=i.fillOpacity*n.a*255,t[s+0]=o.r,t[s+1]=o.g,t[s+2]=o.b,t[s+3]=i.haloOpacity*o.a*255}return t}(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(f.HighlightDownsampleTechnique),this.techniques.precompile(g.HighlightToSingleTechnique),this.techniques.precompile(p.HighlightBlurTechnique),this.techniques.precompile(h.HighlightApplyTechnique)}render(e){const t=e.find(({name:e})=>e===u.InternalRenderCategory.HIGHLIGHTS),{techniques:r,bindParameters:i}=this;if(!i.decorations)return t;if(!r.get(f.HighlightDownsampleTechnique).compiled)return this.requestRender(1),t;const s=e.find(({name:e})=>"highlights"===e).getTexture();return this._renderHighlightPostprocess(s,t),t}_prepareAndDownSample(e){this._gridUpdateResources(e);const t=this.techniques.get(f.HighlightDownsampleTechnique),r=this._gridComputeCoverage(t,e),{horizontalCellCount:i,verticalCellCount:s}=r,n=this._passParameters;return n.horizontalCellCount=i,n.verticalCellCount=s,n.coverageTexture=r.coverage?.getTexture(),r}_renderGrid(e){const t=e.verticalCellCount*e.horizontalCellCount;this.renderingContext.bindVAO(e.vao),this.renderingContext.drawElementsInstanced(x.PrimitiveType.TRIANGLES,6,x.DataType.UNSIGNED_BYTE,0,t)}_renderHighlightPostprocess(e,t){const{fboCache:r,techniques:i,bindParameters:s,_passParameters:n,renderingContext:o}=this,a=i.get(g.HighlightToSingleTechnique),l=i.get(p.HighlightBlurTechnique),u=i.get(h.HighlightApplyTechnique);if(!u.compiled||!l.compiled||!a.compiled)return void this.requestRender(1);n.highlightTexture=e;const d=this._prepareAndDownSample(e),{width:f,height:m}=e.descriptor;n.highlightTexture=e;const{camera:y}=s,{fullWidth:_,fullHeight:b,pixelRatio:v,fullViewport:w}=y,x=Math.ceil(_/v),S=Math.ceil(b/v),{_highlightBlurDrawParameters:T}=this,C=this.view.stage.renderView.renderer,{highlights:P}=s;for(let e=0;e<P.length;++e){const{name:i}=P[e];if(!C.hasHighlight(i))continue;n.highlightLevel=e,o.setClearColor(0,0,0,0);const h=r.acquire(f,m,"single highlight",2);o.bindFramebuffer(h.fbo),o.setViewport(0,0,f,m),o.clear(16384),o.bindTechnique(a,s,n),this._renderGrid(d),T.blurInput=h.getTexture(),c.set(T.blurSize,1/x,0);const p=r.acquire(x,S,"single highlight blur h",2);o.unbindTexture(p.fbo?.colorTexture),o.bindFramebuffer(p.fbo),o.setViewport(0,0,x,S),o.clear(16384),o.bindTechnique(l,s,n,T),this._renderGrid(d),h.release(),c.set(T.blurSize,0,1/S),n.highlightBlurTexture=p.getTexture(),o.bindFramebuffer(t.fbo),o.setViewport4fv(w),o.bindTechnique(u,s,n,T),this._renderGrid(d),p.release()}n.coverageTexture=n.highlightTexture=null}_gridUpdateResources(e){const t=this._grid,{width:r,height:i}=e.descriptor;if(t.horizontalCellCount=Math.ceil(r/v.gridCellPixelSize),t.verticalCellCount=Math.ceil(i/v.gridCellPixelSize),t.vao)return;const s=this.renderingContext,n=w.BufferObject.createIndex(s,35044,R);t.vao=new _.VertexArrayObject(s,new C.VertexBuffer(s,y.NoVertex),n)}_gridComputeCoverage(e,t){const r=this.renderingContext,i=this._grid,s=t.descriptor,n=Math.ceil(s.width/v.gridCellPixelSize),o=Math.ceil(s.height/v.gridCellPixelSize);this._downsampleDrawParameters.input=t;const{highlights:a}=this.bindParameters;i.coverage?.release();const l=this.fboCache.acquire(n,o,"highlight coverage",a.length>O?3:1);return i.coverage=l,r.bindFramebuffer(l.fbo),r.bindTechnique(e,this.bindParameters,this._passParameters,this._downsampleDrawParameters),r.setViewport(0,0,n,o),r.screen.draw(),i}get test(){}},t.__decorate([n.property()],e.Highlight.prototype,"produces",void 0),t.__decorate([n.property()],e.Highlight.prototype,"consumes",void 0),e.Highlight=t.__decorate([l.subclass("esri.views.3d.webgl-engine.effects.highlight.Highlight")],e.Highlight);class P{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}}let M=0;const R=new Uint8Array([0,1,2,2,1,3]),O=4;e.maxHighlightsPerChannel=O,e.renderHighlightBuffer=function(e,t,r,i,s,n=0){const{highlights:o}=i,a=o.length>1?t.acquire(r.width,r.height,"highlight mix",o.length>O?3:1):null,{gl:l}=e;if(a){const t=e.getBoundFramebufferObject();e.bindFramebuffer(a.fbo),l.clearBufferuiv(l.COLOR,0,[0,0,0,0]),e.bindFramebuffer(t)}const u=a?.getTexture();i.highlightMixTexture=u,c.set(i.highlightMixOrigin,n,0),o.forEach((t,o)=>{if(o>0){const t=S.Texture.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(u,t),e.setActiveTexture(t),l.copyTexSubImage2D(3553,0,0,0,n,0,r.width,r.height),e.bindTexture(null,t)}e.clear(256),i.highlightLevel=o,s()}),i.highlightLevel=null,i.highlightMixTexture=null,a?.release()},e.trackHighlightOptions=function(e){let t=0;for(const r of e){const{name:e}=r;t+=e.length;const{color:i,fillOpacity:s,haloColor:n,haloOpacity:o}=r;t+=i.r+i.g+i.b+i.a+s,t+=n?n.r+n.g+n.b+n.a+o:0}const r=e.at(0);if(r){const{shadowOpacity:e,shadowDifference:i,shadowColor:s}=r;t+=e+i+s.r+s.g+s.b+s.a}return M+++(t>=0?0:1)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/highlight/HighlightApplyTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../lib/DefaultVertexBufferLayouts","../../../../../chunks/HighlightApply.glsl","../../../../webgl/renderState","../../../../webgl/VertexAttributeLocations"],function(e,t,r,i,s,n,o,a){"use strict";class l extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.HighlightApply,()=>new Promise((t,r)=>e(["../../shaders/HighlightApply.glsl"],t,r))),a.fromLayout(s.NoVertex))}initializePipeline(){return o.makePipelineState({blending:o.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:o.defaultColorWrite})}}t.HighlightApplyTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/HighlightApply.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/HighlightCellGridScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/HighlightReadBitmap.glsl","../views/3d/webgl-engine/core/shaderModules/Float2DrawUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/IntegerPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DUintPassUniform","./HighlightDownsample.glsl","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";function d(){const e=new u.ShaderBuilder;e.include(t.HighlightCellGridScreenSpacePass);const{fragment:d}=e;return d.uniforms.add(new a.Texture2DPassUniform("blurInput",e=>e.highlightBlurTexture),new i.Float2DrawUniform("blurSize",e=>e.blurSize),new l.Texture2DUintPassUniform("highlightTexture",e=>e.highlightTexture),new a.Texture2DPassUniform("highlightOptionsTexture",e=>e.highlightOptionsTexture),new o.IntegerPassUniform("highlightLevel",e=>e.highlightLevel),new s.FloatPassUniform("occludedIntensityFactor",e=>e.occludedFactor)),d.constants.add("inner","float",1-(c.outlineSize-c.blurSize)/c.outlineSize),e.include(r.HighlightReadBitmap),d.main.add(n.glsl`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
uvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),e}const h=Object.freeze(Object.defineProperty({__proto__:null,build:d},Symbol.toStringTag,{value:"Module"}));e.HighlightApply=h,e.build=d})},"esri/views/3d/webgl-engine/core/shaderLibrary/HighlightCellGridScreenSpacePass.glsl":function(){define(["exports","../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../core/libs/gl-matrix-2/factories/vec2f64","../shaderModules/glsl","../shaderModules/Integer2PassUniform","../shaderModules/IntegerPassUniform","../shaderModules/Texture2DUintPassUniform","../../../../../chunks/HighlightDownsample.glsl"],function(e,t,r,i,s,n,o,a){"use strict";const l=r.create();e.HighlightCellGridScreenSpacePass=function(e){const{vertex:r}=e;r.uniforms.add(new o.Texture2DUintPassUniform("coverageTexture",e=>e.coverageTexture),new s.Integer2PassUniform("highlightRenderCellCount",e=>t.set(l,e.horizontalCellCount,e.verticalCellCount)),new s.Integer2PassUniform("highlightTextureResolution",({highlightTexture:e})=>t.set(l,e.descriptor.width,e.descriptor.height)),new n.IntegerPassUniform("highlightLevel",e=>e.highlightLevel)).constants.add("cellSize","int",a.gridCellPixelSize),e.varyings.add("sUV","vec2"),e.varyings.add("vOutlinePossible","float"),r.code.add(i.glsl`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),r.main.add(i.glsl`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Integer2PassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"ivec2",1,(r,i,s)=>r.setUniform2iv(e,t(i,s)))}}e.Integer2PassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DUintPassUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"usampler2D",1,(r,i,s)=>r.bindTexture(e,t(i,s)))}}e.Texture2DUintPassUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/HighlightDownsample.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DUintPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n){"use strict";class o extends s.NoParameters{}function a(){const e=new n.ShaderBuilder,{outputs:s,fragment:o}=e;return e.include(t.ScreenSpacePass),o.uniforms.add(new i.Texture2DUintPassUniform("highlightTexture",e=>e.highlightTexture)),o.constants.add("outlineWidth","int",Math.ceil(c)),o.constants.add("cellSize","int",l),s.add("fragGrid","uvec2"),o.main.add(r.glsl`ivec2 inputTextureSize = textureSize(highlightTexture, 0);
ivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
texelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = outputValue;`),e}const l=32,c=9,u=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:o,blurSize:.4,build:a,gridCellPixelSize:l,outlineSize:c},Symbol.toStringTag,{value:"Module"}));e.HighlightDownsample=u,e.HighlightDownsampleDrawParameters=o,e.blurSize=.4,e.build=a,e.gridCellPixelSize=l,e.outlineSize=c})},"esri/views/3d/webgl-engine/effects/highlight/HighlightBlurTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../lib/DefaultVertexBufferLayouts","../../../../../chunks/HighlightBlur.glsl","../../../../webgl/renderState","../../../../webgl/VertexAttributeLocations"],function(e,t,r,i,s,n,o,a){"use strict";class l extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.HighlightBlur,()=>new Promise((t,r)=>e(["../../shaders/HighlightBlur.glsl"],t,r))),a.fromLayout(s.NoVertex))}initializePipeline(){return o.makePipelineState({colorWrite:o.defaultColorWrite})}}t.HighlightBlurTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/HighlightBlur.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec2f64","../views/3d/webgl-engine/core/shaderLibrary/HighlightCellGridScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/Float2DrawUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DDrawUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a){"use strict";class l extends o.NoParameters{constructor(){super(...arguments),this.blurSize=t.create()}}function c(){const e=new a.ShaderBuilder;return e.include(r.HighlightCellGridScreenSpacePass),e.outputs.add("fragHighlight","vec2",0),e.fragment.uniforms.add(new i.Float2DrawUniform("blurSize",e=>e.blurSize),new n.Texture2DDrawUniform("blurInput",e=>e.blurInput)).main.add(s.glsl`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragHighlight = sum;
}`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:l,build:c},Symbol.toStringTag,{value:"Module"}));e.HighlightBlur=u,e.HighlightBlurDrawParameters=l,e.build=c})},"esri/views/3d/webgl-engine/effects/highlight/HighlightDownsampleTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../lib/DefaultVertexBufferLayouts","../../../../../chunks/HighlightDownsample.glsl","../../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.HighlightDownsample,()=>new Promise((t,r)=>e(["../../shaders/HighlightDownsample.glsl"],t,r))),s.Pos2Locations)}initializePipeline(){return o.makePipelineState({colorWrite:o.defaultColorWrite})}}t.HighlightDownsampleTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/highlight/HighlightPassParameters":function(){define(["exports","../../../../support/HighlightDefaults","../../../../webgl/NoParameters"],function(e,t,r){"use strict";class i extends r.NoParameters{constructor(){super(...arguments),this.occludedFactor=t.defaultOccludedFactor,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}}e.HighlightPassParameters=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/highlight/HighlightToSingleTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../lib/DefaultVertexBufferLayouts","../../../../../chunks/HighlightToSingle.glsl","../../../../webgl/renderState","../../../../webgl/VertexAttributeLocations"],function(e,t,r,i,s,n,o,a){"use strict";class l extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.HighlightToSingle,()=>new Promise((t,r)=>e(["../../shaders/HighlightToSingle.glsl"],t,r))),a.fromLayout(s.NoVertex))}initializePipeline(){return o.makePipelineState({colorWrite:o.defaultColorWrite})}}t.HighlightToSingleTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/HighlightToSingle.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/HighlightCellGridScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/HighlightReadBitmap.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/IntegerPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DUintPassUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o){"use strict";function a(){const e=new o.ShaderBuilder;e.include(t.HighlightCellGridScreenSpacePass),e.include(r.HighlightReadBitmap);const{fragment:a}=e;return e.outputs.add("fragSingleHighlight","vec2",0),a.uniforms.add(new n.Texture2DUintPassUniform("highlightTexture",e=>e.highlightTexture),new s.IntegerPassUniform("highlightLevel",e=>e.highlightLevel)),a.main.add(i.glsl`ivec2 iuv = ivec2(gl_FragCoord.xy);
uvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),e}const l=Object.freeze(Object.defineProperty({__proto__:null,build:a},Symbol.toStringTag,{value:"Module"}));e.HighlightToSingle=l,e.build=a})},"esri/views/3d/webgl-engine/lib/GLMaterialRepository":function(){define(["exports","../../../../core/Logger","../../../../core/maybe","../../../../core/NestedMap","./GLMaterialParameters","./Util"],function(e,t,r,i,s,n){"use strict";class o{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,n.assert(this._refCnt>=0)}get referenced(){return this._refCnt>0}}e.GLMaterialRepository=class{constructor(e,t,r,s){this._textures=e,this._techniques=t,this.materialChanged=r,this.requestRender=s,this._id2glMaterialRef=new i.NestedMap}dispose(){this._textures.destroy()}acquire(e,t,r){this._ownMaterial(e);const i=e.produces.get(t);if(!i?.(r))return null;let n=this._id2glMaterialRef.get(r,e.id);if(null==n){const t=e.createGLMaterial(new s.GLMaterialParameters(e,r,this._techniques,this._textures));n=new o(t),this._id2glMaterialRef.set(r,e.id,n)}return n.ref(),n.glMaterial}release(e,t){const i=this._id2glMaterialRef.get(t,e.id);null!=i&&(i.unref(),i.referenced||(r.disposeMaybe(i.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&t.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/GLMaterialParameters":function(){define(["exports"],function(e){"use strict";e.GLMaterialParameters=class{constructor(e,t,r,i){this.material=e,this.output=t,this.techniques=r,this.textures=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/GridLocalOriginFactory":function(){define(["exports","../../../../core/has","../../../../core/uid","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/projection/projectBuffer","./Attribute","./Geometry","./LocalOriginFactory","./Object3D","./testUtils","./WebGLLayer","../materials/RibbonLineMaterial"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const f=s.create();e.GridLocalOriginFactory=class{constructor(e){this._originSR=e,this._rootOriginId="root/"+r.generateUID(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){const t=d.gridLocalOriginFactory.rootOrigin;if(null!=t)return this._origins.set(this._rootOriginId,c.fromValues(t[0],t[1],t[2],this._rootOriginId)),this.getOrigin(e);const r=c.fromValues(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,r),r}const r=this._gridSize,s=Math.round(e[0]/r),n=Math.round(e[1]/r),o=Math.round(e[2]/r),a=`${s}/${n}/${o}`;let l=this._origins.get(a);const u=.5*r;if(i.subtract(f,e,t.vec3),f[0]=Math.abs(f[0]),f[1]=Math.abs(f[1]),f[2]=Math.abs(f[2]),f[0]<u&&f[1]<u&&f[2]<u){if(l){const t=Math.max(...f);if(i.subtract(f,e,l.vec3),f[0]=Math.abs(f[0]),f[1]=Math.abs(f[1]),f[2]=Math.abs(f[2]),Math.max(...f)<t)return l}return t}return l||(l=c.fromValues(s*r,n*r,o*r,a),this._origins.set(a,l)),l}_drawOriginBox(e,t=n.fromValues(1,1,0,1)){const r=window.view,i=r.stage,s=t.toString();if(!this._objects.has(s)){this._material=new p.RibbonLineMaterial({width:2,color:t});const e=new h.WebGLLayer(i,{pickable:!1}),r=new u.Object3D({castShadow:!1});e.add(r),this._objects.set(s,r)}const c=this._objects.get(s),d=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],f=d.length,m=new Array(3*f),g=new Array,y=.5*this._gridSize;for(let t=0;t<f;t++)m[3*t]=e[0]+(1&d[t]?y:-y),m[3*t+1]=e[1]+(2&d[t]?y:-y),m[3*t+2]=e[2]+(4&d[t]?y:-y),t>0&&g.push(t-1,t);o.projectBuffer(m,this._originSR,0,m,r.renderSpatialReference,0,f);const _=new l.Geometry(this._material,[["position",new a.Attribute(m,g,3,!0)]],null,2);c.addGeometry(_)}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/RibbonLineMaterial":function(){define(["exports","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/time","../../../../core/libs/gl-matrix-2/math/vec2","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/float16","../../../../geometry/support/lineSegment","../../../../geometry/support/plane","../core/shaderLibrary/ShaderOutput","../effects/geometry/olidUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./VisualVariablePassParameters","./internal/bufferWriterUtils","../../../../chunks/RibbonLine.glsl","../shaders/RibbonLineTechnique","../shaders/RibbonLineTechniqueConfiguration","../../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x){"use strict";class S extends m.Material{constructor(e){super(e,C),this._configuration=new w.RibbonLineTechniqueConfiguration,this.produces=new Map([[2,e=>h.isHighlightOrOID(e)||h.isColorOrColorEmission(e)&&8===this.parameters.renderOccluded],[3,e=>h.isDepth(e)],[10,e=>h.isColorEmissionHighlightOIDOrDepth(e)&&8===this.parameters.renderOccluded],[11,e=>h.isColorEmissionHighlightOIDOrDepth(e)&&8===this.parameters.renderOccluded],[4,e=>h.isColorOrColorEmission(e)&&this.parameters.writeDepth&&8!==this.parameters.renderOccluded],[8,e=>h.isColorOrColorEmission(e)&&!this.parameters.writeDepth&&8!==this.parameters.renderOccluded],[18,e=>h.is2DGeometryOutput(e)]])}getConfiguration(e,t){super.getConfiguration(e,t,this._configuration),this._configuration.oitPass=t.oitPass,this._configuration.draped=18===t.slot;const r=null!=this.parameters.stipplePattern&&8!==e;var i;return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&null!=this.parameters.stippleOffColor,this._configuration.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=null!=this.parameters.markerParameters&&1===(i=this.parameters.markerParameters).anchor&&i.hideOnShortSegments&&"begin-end"===i.placement&&i.worldSpace,this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&null!=this.parameters.innerColor,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.hasOccludees=t.hasOccludees,this._configuration.occluder=8===this.parameters.renderOccluded,this._configuration.terrainDepthTest=t.terrainDepthTest&&h.isColorOrColorEmission(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.wireframe=this.parameters.wireframe,this._configuration.animation=this.parameters.animation,this._configuration.emissionSource=this.hasEmissions?1:0,this._configuration}get visible(){return this.parameters.color[3]>=x.alphaCutoff||null!=this.parameters.stipplePattern&&(this.parameters.stippleOffColor?.[3]??0)>x.alphaCutoff}setParameters(e,t){e.animation=this.parameters.animation,super.setParameters(e,t)}intersectDraped({attributes:e,screenToWorldRatio:t},i,s,n,o){if(!i.options.selectionMode)return;const a=e.get("size");let l=this.parameters.width;if(this.parameters.vvSize){const t=e.get("sizeFeatureAttribute").data[0];Number.isNaN(t)?l*=this.parameters.vvSize.fallback[0]:l*=r.clamp(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else a&&(l*=a.data[0]);const c=s[0],u=s[1],d=(l/2+4)*t;let h=Number.MAX_VALUE,p=0;const f=e.get("position").data,m=R(this.parameters,e)?f.length-2:f.length-5;for(let e=0;e<m;e+=3){const t=f[e],i=f[e+1],s=(e+3)%f.length,n=c-t,o=u-i,a=f[s]-t,l=f[s+1]-i,d=a*n+l*o,m=a*a+l*l,g=r.clamp(d/m,0,1),y=a*g-n,_=l*g-o,b=y*y+_*_;b<h&&(h=b,p=e/3)}h<d*d&&n(o.distance,o.normal,p)}intersect(e,i,s,a,l,c){const{options:h,camera:p,rayBegin:f,rayEnd:m}=s;if(!h.selectionMode||!e.visible||!p)return;if(!g.isTranslationMatrix(i))return void t.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const y=e.attributes,_=y.get("position").data;let b=this.parameters.width;if(this.parameters.vvSize){const e=y.get("sizeFeatureAttribute").data[0];Number.isNaN(e)||(b*=r.clamp(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0]))}else y.has("size")&&(b*=y.get("size").data[0]);const v=D;n.copy(v,s.point);const w=b*p.pixelRatio/2+4*p.pixelRatio;o.set(q[0],v[0]-w,v[1]+w,0),o.set(q[1],v[0]+w,v[1]+w,0),o.set(q[2],v[0]+w,v[1]-w,0),o.set(q[3],v[0]-w,v[1]-w,0);for(let e=0;e<4;e++)if(!p.unprojectFromRenderScreen(q[e],H[e]))return;d.fromPoints(p.eye,H[0],H[1],W),d.fromPoints(p.eye,H[1],H[2],$),d.fromPoints(p.eye,H[2],H[3],Q),d.fromPoints(p.eye,H[3],H[0],Z);let x=Number.MAX_VALUE,S=0;const T=R(this.parameters,y)?_.length-2:_.length-5;for(let e=0;e<T;e+=3){O[0]=_[e]+i[12],O[1]=_[e+1]+i[13],O[2]=_[e+2]+i[14];const t=(e+3)%_.length;if(I[0]=_[t]+i[12],I[1]=_[t+1]+i[13],I[2]=_[t+2]+i[14],d.signedDistance(W,O)<0&&d.signedDistance(W,I)<0||d.signedDistance($,O)<0&&d.signedDistance($,I)<0||d.signedDistance(Q,O)<0&&d.signedDistance(Q,I)<0||d.signedDistance(Z,O)<0&&d.signedDistance(Z,I)<0)continue;if(p.projectToRenderScreen(O,E),p.projectToRenderScreen(I,L),E[2]<0&&L[2]>0){o.subtract(F,O,I);const e=p.frustum,t=-d.signedDistance(e[4],O)/o.dot(F,d.getNormal(e[4]));o.scale(F,F,t),o.add(O,O,F),p.projectToRenderScreen(O,E)}else if(E[2]>0&&L[2]<0){o.subtract(F,I,O);const e=p.frustum,t=-d.signedDistance(e[4],I)/o.dot(F,d.getNormal(e[4]));o.scale(F,F,t),o.add(I,I,F),p.projectToRenderScreen(I,L)}else if(E[2]<0&&L[2]<0)continue;E[2]=0,L[2]=0;const r=u.distance2(u.fromPoints(E,L,B),v);r<x&&(x=r,o.copy(V,O),o.copy(U,I),S=e/3)}if(x<w*w){let e=Number.MAX_VALUE;if(u.closestLineSegmentPoint(u.fromPoints(V,U,B),u.fromPoints(f,m,N),A)){o.subtract(A,A,f);const t=o.length(A);o.scale(A,A,1/t),e=t/o.distance(f,m)}c(e,A,S)}}get hasEmissions(){return this.parameters.emissiveStrength>0}createBufferWriter(){return new P(v.getLayout(this.parameters),this.parameters)}createGLMaterial(e){return new T(e)}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),null!=e.markerParameters&&(e.markerScale=e.markerParameters.width/e.width)}update(e){const{hasAnimation:t,animationSpeed:r}=this.parameters;return!!t&&(this.setParameters({timeElapsed:s.secondsFromMilliseconds(e.time)*r},!1),0!==e.dt)}}class T extends f{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures?.release(this._stipplePattern),this._stipplePattern=null}beginSlot(e){const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.getTechnique(v.RibbonLineTechnique,e)}}class C extends y.VisualVariablePassParameters{constructor(){super(...arguments),this.width=0,this.color=l.ONES,this.join="miter",this.cap=0,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.wireframe=!1,this.timeElapsed=0,this.animation=0,this.animationSpeed=1,this.trailLength=1,this.emissiveStrength=0}get transparent(){return this.color[3]<1||this.hasAnimation||null!=this.stipplePattern&&(this.stippleOffColor?.[3]??0)<1}get hasAnimation(){return 0!==this.animation}}class P{constructor(e,t){this.layout=e,this._parameters=t;const r=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=b.ribbonlineNumRoundJoinSubdivisions+r}}_isClosed(e){return R(this._parameters,e)}allocate(e){return this.layout.createBuffer(e)}elementCount(e){const t=e.get("position").indices.length/2+1,r=this._isClosed(e);let i=r?2:4;return i+=((r?t:t-1)-(r?0:1))*(2*this.numJoinSubdivisions+4),i+=2,this._parameters.wireframe&&(i=2+4*(i-2)),i}write(e,t,r,i,s,n){const a=r.get("position"),l=a.indices,u=a.data.length/3,d=r.get("distanceToStart")?.data;l&&l.length!==2*(u-1)&&console.warn("RibbonLineMaterial does not support indices");const h=(this.layout.fields.has("sizeFeatureAttribute")?r.get("sizeFeatureAttribute")?.data[0]:r.get("size")?.data[0])??1;let f=[1,1,1,1],m=0;const g=this.layout.fields.has("colorFeatureAttribute");g?m=r.get("colorFeatureAttribute").data[0]:r.has("color")&&(f=r.get("color").data);const y=r.get("timeStamps")?.data,b=y&&this.layout.fields.has("timeStamps"),v=this.layout.fields.has("opacityFeatureAttribute"),w=v?r.get("opacityFeatureAttribute").data[0]:0,x=new Float32Array(s.buffer),S=c.makeFloat16Array(s.buffer),T=new Uint8Array(s.buffer),C=this.layout.stride/4;let P=n*C;const R=P;let O=0;const I=d?(e,t,r)=>O=d[r]:(e,t,r)=>O+=o.distance(e,t),F=x.BYTES_PER_ELEMENT/S.BYTES_PER_ELEMENT,A=4/F,D=(e,t,r,s,n,o,a,l)=>{x[P++]=t[0],x[P++]=t[1],x[P++]=t[2],_.writeDeltaF16Vector(e,t,S,P*F),P+=A,_.writeDeltaF16Vector(r,t,S,P*F),P+=A,x[P++]=l;let c=P*F;if(S[c++]=n,S[c++]=o,P=Math.ceil(c/F),g)x[P]=m;else{const e=Math.min(4*a,f.length-4),t=4*P;T[t]=255*f[e],T[t+1]=255*f[e+1],T[t+2]=255*f[e+2],T[t+3]=255*f[e+3]}if(P++,x[P++]=h,v&&(x[P++]=w),p.olidEnabled()){let e=4*P;i?(T[e++]=i[0],T[e++]=i[1],T[e++]=i[2],T[e++]=i[3]):(T[e++]=0,T[e++]=0,T[e++]=0,T[e++]=0),P=Math.ceil(.25*e)}b&&(c=P*F,S[c++]=s[0],S[c++]=s[1],S[c++]=s[2],P=Math.ceil(c/F))};P+=C,o.set(z,a.data[0],a.data[1],a.data[2]),b&&o.set(G,y[0],y[1],y[2]),e&&o.transformMat4(z,z,e);const E=this._isClosed(r);if(E){const t=a.data.length-3;o.set(k,a.data[t],a.data[t+1],a.data[t+2]),e&&o.transformMat4(k,k,e)}else o.set(j,a.data[3],a.data[4],a.data[5]),e&&o.transformMat4(j,j,e),D(z,z,j,G,1,-4,0,0),D(z,z,j,G,1,4,0,0),o.copy(k,z),o.copy(z,j),b&&o.set(G,y[3],y[4],y[5]);const L=E?0:1,V=E?u:u-1;for(let t=L;t<V;t++){const r=(t+1)%u*3;o.set(j,a.data[r],a.data[r+1],a.data[r+2]),e&&o.transformMat4(j,j,e),I(k,z,t),D(k,z,j,G,0,-1,t,O),D(k,z,j,G,0,1,t,O);const i=this.numJoinSubdivisions;for(let e=0;e<i;++e){const r=(e+1)/(i+1);D(k,z,j,G,r,-1,t,O),D(k,z,j,G,r,1,t,O)}D(k,z,j,G,1,-2,t,O),D(k,z,j,G,1,2,t,O),o.copy(k,z),o.copy(z,j),b&&o.set(G,y[r],y[r+1],y[r+2])}return E?(o.set(j,a.data[3],a.data[4],a.data[5]),e&&o.transformMat4(j,j,e),O=I(k,z,V),D(k,z,j,G,0,-1,L,O),D(k,z,j,G,0,1,L,O)):(O=I(k,z,V),D(k,z,z,G,0,-5,V,O),D(k,z,z,G,0,5,V,O)),M(x,R+C,x,R,C),P=M(x,P-C,x,P,C),this._parameters.wireframe&&this._addWireframeVertices(s,R,P,C),null}_addWireframeVertices(e,t,r,i){const s=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT),n=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,r-t);let o=0;const a=e=>o=M(n,e,s,o,i);for(let e=0;e<n.length-1;e+=2*i)a(e),a(e+2*i),a(e+1*i),a(e+2*i),a(e+1*i),a(e+3*i)}}function M(e,t,r,i,s){for(let n=0;n<s;n++)r[i++]=e[t++];return i}function R(e,t){return!!e.isClosed&&t.get("position").indices.length>2}const O=a.create(),I=a.create(),F=a.create(),A=a.create(),D=a.create(),E=i.createRenderScreenPointArray3(),L=i.createRenderScreenPointArray3(),V=a.create(),U=a.create(),B=u.create(),N=u.create(),k=a.create(),z=a.create(),j=a.create(),G=a.create(),q=[i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3()],H=[a.create(),a.create(),a.create(),a.create()],W=d.create(),$=d.create(),Q=d.create(),Z=d.create();e.Parameters=C,e.RibbonLineMaterial=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/RibbonLine.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/ObjectAndLayerIdColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/RibbonVertexPosition.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/LineStipple.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MarkerSizing.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PiUtils.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/TerrainDepthTest.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/Float2BindUniform","../views/3d/webgl-engine/core/shaderModules/Float4BindUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatBindUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4BindUniform","../views/3d/webgl-engine/shaders/AnimatedLine.glsl","../views/3d/webgl-engine/shaders/OutputColorHighlightOID.glsl","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v){"use strict";function w(e){const w=new b.ShaderBuilder,{attributes:x,varyings:S,vertex:T,fragment:C}=w,{applyMarkerOffset:P,draped:M,output:R,capType:O,stippleEnabled:I,falloffEnabled:F,roundJoins:A,wireframe:D,innerColorEnabled:E,hasAnimation:L}=e;C.include(o.PiUtils),w.include(i.RibbonVertexPosition,e),w.include(s.LineStipple,e),w.include(r.ObjectAndLayerIdColor,e),w.include(a.terrainDepthTest,e),w.include(y.AnimatedLine,e);const V=P&&!M;V&&(T.uniforms.add(new f.FloatPassUniform("markerScale",e=>e.markerScale)),w.include(n.MarkerSizing,{space:2})),c.addProjViewLocalOrigin(T,e),T.uniforms.add(new g.Matrix4BindUniform("inverseProjectionMatrix",e=>e.camera.inverseProjectionMatrix),new u.Float2BindUniform("nearFar",e=>e.camera.nearFar),new f.FloatPassUniform("miterLimit",e=>"miter"!==e.join?0:e.miterLimit),new d.Float4BindUniform("viewport",e=>e.camera.fullViewport)),T.constants.add("LARGE_HALF_FLOAT","float",65500),x.add("position","vec3"),x.add("previousDelta","vec4"),x.add("nextDelta","vec4"),x.add("lineParameters","vec2"),x.add("u0","float"),S.add("vColor","vec4"),S.add("vpos","vec3",{invariant:!0}),S.add("vLineDistance","float"),S.add("vLineWidth","float");const U=I;U&&S.add("vLineSizeInv","float");const B=2===O,N=I&&B,k=F||N;k&&S.add("vLineDistanceNorm","float"),B&&(S.add("vSegmentSDF","float"),S.add("vReverseSegmentSDF","float")),T.code.add(m.glsl`vec2 perpendicular(vec2 v) {
return vec2(v.y, -v.x);
}
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),T.code.add(m.glsl`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),T.code.add(m.glsl`void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
float vnp = nearFar[0] * 0.99;
if(pos.z > -nearFar[0]) {
if (!isStartVertex) {
if(prev.z < -nearFar[0]) {
pos = mix(prev, pos, interp(vnp, prev, pos));
next = pos;
} else {
pos = vec4(0.0, 0.0, 0.0, 1.0);
}
} else {
if(next.z < -nearFar[0]) {
pos = mix(pos, next, interp(vnp, pos, next));
prev = pos;
} else {
pos = vec4(0.0, 0.0, 0.0, 1.0);
}
}
} else {
if (prev.z > -nearFar[0]) {
prev = mix(pos, prev, interp(vnp, pos, prev));
}
if (next.z > -nearFar[0]) {
next = mix(next, pos, interp(vnp, next, pos));
}
}
forwardViewPosDepth(pos.xyz);
pos = projectAndScale(pos);
next = projectAndScale(next);
prev = projectAndScale(prev);
}`),c.addPixelRatio(T),T.constants.add("aaWidth","float",I?0:1).main.add(m.glsl`
    // unpack values from vertex type
    bool isStartVertex = abs(abs(lineParameters.y)-3.0) == 1.0;
    vec3 prevPosition = position + previousDelta.xyz * previousDelta.w;
    vec3 nextPosition = position + nextDelta.xyz * nextDelta.w;

    float coverage = 1.0;

    // Check for special value of lineParameters.y which is used by the Renderer when graphics are removed before the
    // VBO is recompacted. If this is the case, then we just project outside of clip space.
    if (lineParameters.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(lineParameters.y) < 3.0;
      float lineSize = getSize();

      if (lineSize < 1.0) {
        coverage = lineSize; // convert sub-pixel coverage to alpha
        lineSize = 1.0;
      }
      lineSize += aaWidth;

      float lineWidth = lineSize * pixelRatio;
      vLineWidth = lineWidth;
      ${U?m.glsl`vLineSizeInv = 1.0 / lineSize;`:""}

      vec4 pos  = view * vec4(position, 1.0);
      vec4 prev = view * vec4(prevPosition, 1.0);
      vec4 next = view * vec4(nextPosition, 1.0);
  `),V&&T.main.add(m.glsl`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),T.main.add(m.glsl`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(I||B)&&T.main.add(m.glsl`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${B?m.glsl`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),T.main.add(m.glsl`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * lineParameters.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = perpendicular(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
float subdivisionFactor = lineParameters.x;
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),A?T.main.add(m.glsl`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = perpendicular(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = perpendicular(endDir);

        float factor = ${I?m.glsl`min(1.0, subdivisionFactor * ${m.glsl.float(1.5)})`:m.glsl`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(lineParameters.y) * factor * rotationAngle);
      `):T.main.add(m.glsl`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = perpendicular(joinDisplacementDir);`);const z=0!==O;return T.main.add(m.glsl`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = perpendicular(joinDisplacementDir);

      ${z?m.glsl`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),T.main.add(m.glsl`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(lineParameters.y) * displacementLen + capDisplacementDir * displacementLen;
    float lineDistNorm = sign(lineParameters.y) * pos.w;

    vLineDistance =  lineWidth * lineDistNorm;
    ${k?m.glsl`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),B&&T.main.add(m.glsl`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),I&&(M?T.uniforms.add(new p.FloatBindUniform("worldToScreenRatio",e=>1/e.screenToPCSRatio)):T.main.add(m.glsl`vec3 segmentCenter = mix((nextPosition + position) * 0.5, (position + prevPosition) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),T.main.add(m.glsl`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(nextPosition - position, position - prevPosition, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),M?T.main.add(m.glsl`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = u0 * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):T.main.add(m.glsl`float startPseudoScreen = mix(u0, u0 - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),T.uniforms.add(new f.FloatPassUniform("stipplePatternPixelSize",e=>s.computePixelSize(e))),T.main.add(m.glsl`float patternLength = lineSize * stipplePatternPixelSize;
vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);
if (segmentLengthScreenDouble >= 0.001) {
vec2 stippleDisplacement = pos.xy - segmentOrigin;
float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);
vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
}
vStippleDistanceLimits *= pos.w;
vStippleDistance *= pos.w;
vStippleDistanceLimits = isJoin ?
vStippleDistanceLimits :
isStartVertex ?
vec2(-1e34, vStippleDistanceLimits.y) :
vec2(vStippleDistanceLimits.x, 1e34);`)),T.main.add(m.glsl`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${D&&!M?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }`),w.fragment.include(t.SliceDraw,e),w.include(_.outputColorHighlightOID,e),C.include(l.ColorConversion),C.main.add(m.glsl`discardBySlice(vpos);
discardByTerrainDepth();`),D?C.main.add(m.glsl`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(B&&C.main.add(m.glsl`
        float sdf = min(vSegmentSDF, vReverseSegmentSDF);
        vec2 fragmentPosition = vec2(
          min(sdf, 0.0),
          vLineDistance
        ) * gl_FragCoord.w;

        float fragmentRadius = length(fragmentPosition);
        float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
        float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

        if (capCoverage < ${m.glsl.float(v.alphaCutoff)}) {
          discard;
        }
      `),N?C.main.add(m.glsl`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${m.glsl.float(v.alphaCutoff)}, stippleCoverage);
      `):C.main.add(m.glsl`float stippleAlpha = getStippleAlpha();`),9!==R&&C.main.add(m.glsl`discardByStippleAlpha(stippleAlpha, ${m.glsl.float(v.alphaCutoff)});`),C.uniforms.add(new h.Float4PassUniform("intrinsicColor",e=>e.color)),C.main.add(m.glsl`vec4 color = intrinsicColor * vColor;`),E&&(C.uniforms.add(new h.Float4PassUniform("innerColor",e=>e.innerColor??e.color),new f.FloatPassUniform("innerWidth",(e,t)=>e.innerWidth*t.camera.pixelRatio)),C.main.add(m.glsl`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),C.main.add(m.glsl`vec4 finalColor = blendStipple(color, stippleAlpha);`),F&&(C.uniforms.add(new f.FloatPassUniform("falloff",e=>e.falloff)),C.main.add(m.glsl`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`)),I||C.main.add(m.glsl`float featherStartDistance = max(vLineWidth - 2.0, 0.0);
float value = abs(vLineDistance) * gl_FragCoord.w;
float feather = (value - featherStartDistance) / (vLineWidth - featherStartDistance);
finalColor.a *= 1.0 - clamp(feather, 0.0, 1.0);`),L&&C.main.add(m.glsl`
        finalColor = animate(finalColor);

        ${m.If(9!==R,m.glsl`
            if (finalColor.a <= ${m.glsl.float(v.alphaCutoff)}) {
              discard;
            }`)}
      `)),C.main.add(m.glsl`outputColorHighlightOID(finalColor, vpos, finalColor.rgb);`),w}const x=Object.freeze(Object.defineProperty({__proto__:null,build:w,ribbonlineNumRoundJoinSubdivisions:1},Symbol.toStringTag,{value:"Module"}));e.RibbonLine=x,e.build=w,e.ribbonlineNumRoundJoinSubdivisions=1})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/RibbonVertexPosition.glsl":function(){define(["exports","../shading/VisualVariables.glsl","../../shaderModules/Float3PassUniform","../../shaderModules/FloatPassUniform","../../shaderModules/FloatsPassUniform","../../shaderModules/glsl"],function(e,t,r,i,s,n){"use strict";e.RibbonVertexPosition=function(e,o){const{vertex:a,attributes:l}=e;a.uniforms.add(new i.FloatPassUniform("intrinsicWidth",e=>e.width)),o.hasVVSize?(l.add("sizeFeatureAttribute","float"),a.uniforms.add(new r.Float3PassUniform("vvSizeMinSize",e=>e.vvSize.minSize),new r.Float3PassUniform("vvSizeMaxSize",e=>e.vvSize.maxSize),new r.Float3PassUniform("vvSizeOffset",e=>e.vvSize.offset),new r.Float3PassUniform("vvSizeFactor",e=>e.vvSize.factor),new r.Float3PassUniform("vvSizeFallback",e=>e.vvSize.fallback)),a.code.add(n.glsl`float getSize() {
if (isnan(sizeFeatureAttribute)) {
return vvSizeFallback.x;
}
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(l.add("size","float"),a.code.add(n.glsl`float getSize(){
return intrinsicWidth * size;
}`)),o.hasVVOpacity?(l.add("opacityFeatureAttribute","float"),a.constants.add("vvOpacityNumber","int",8),a.uniforms.add(new s.FloatsPassUniform("vvOpacityValues",e=>e.vvOpacity.values,8),new s.FloatsPassUniform("vvOpacityOpacities",e=>e.vvOpacity.opacityValues,8),new i.FloatPassUniform("vvOpacityFallback",e=>e.vvOpacity.fallback,{supportsNaN:!0})),a.code.add(n.glsl`
    float interpolateOpacity(float value) {
      if (value <= vvOpacityValues[0]) {
        return vvOpacityOpacities[0];
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
        }
      }

      return vvOpacityOpacities[vvOpacityNumber - 1];
    }

    vec4 applyOpacity(vec4 color) {
      if (isnan(opacityFeatureAttribute)) {
        // If there is a color vv then it will already have taken care of applying the fallback
        return ${n.If(o.hasVVColor,"color","vec4(color.rgb, vvOpacityFallback)")};
      }

      return vec4(color.rgb, interpolateOpacity(opacityFeatureAttribute));
    }
    `)):a.code.add(n.glsl`vec4 applyOpacity(vec4 color) {
return color;
}`),o.hasVVColor?(e.include(t.VisualVariables,o),l.add("colorFeatureAttribute","float"),a.code.add(n.glsl`vec4 getColor() {
vec4 color = interpolateVVColor(colorFeatureAttribute);
if (isnan(color.r)) {
return vec4(0);
}
return applyOpacity(color);
}`)):(l.add("color","vec4"),a.code.add(n.glsl`vec4 getColor() {
return applyOpacity(color);
}`))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/LineStipple.glsl":function(){define(["exports","../util/RgbaFloatEncoding.glsl","../util/View.glsl","../../shaderModules/Float4PassUniform","../../shaderModules/FloatBindUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform","../../../materials/stippleTextureRepository","../../../shaders/ensureColor4"],function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(e){const t=e.stipplePattern;return t?l.computeTextureSize(e.stipplePattern)/t.pixelRatio:1}e.LineStipple=function(e,d){if(!d.stippleEnabled)return void e.fragment.code.add(o.glsl`float getStippleAlpha() { return 1.0; }
void discardByStippleAlpha(float stippleAlpha, float threshold) {}
vec4 blendStipple(vec4 color, float stippleAlpha) { return color; }`);const h=!(d.draped&&d.stipplePreferContinuous),{vertex:p,fragment:f}=e;f.include(t.RgbaFloatEncoding),d.draped||(r.addCameraPosition(p,d),p.uniforms.add(new s.FloatBindUniform("worldToScreenPerDistanceRatio",({camera:e})=>1/e.perScreenPixelRatio)).code.add(o.glsl`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),e.varyings.add("vStippleDistanceLimits","vec2"),e.varyings.add("vStipplePatternStretch","float"),p.code.add(o.glsl`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${o.glsl.float(.4)};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),p.code.add(o.glsl`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),p.code.add(o.glsl`
    if (segmentLengthPseudoScreen >= ${h?"patternLength":"1e4"}) {
  `),r.addPixelRatio(p),p.code.add(o.glsl`float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
float segmentLengthScreenRounded = flooredRepetitions * patternLength;
float stretch = repetitions / flooredRepetitions;
vStipplePatternStretch = max(0.75, stretch);
return vec2(0.0, segmentLengthScreenRounded);
}
return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
}`),f.uniforms.add(new a.Texture2DPassUniform("stipplePatternTexture",e=>e.stippleTexture),new n.FloatPassUniform("stipplePatternSDFNormalizer",e=>{return(t=e.stipplePattern)?(Math.floor(.5*(l.computeLongestPattern(t)-1))+.5)/t.pixelRatio:1;var t}),new n.FloatPassUniform("stipplePatternPixelSizeInv",e=>1/u(e))),d.stippleOffColorEnabled&&f.uniforms.add(new i.Float4PassUniform("stippleOffColor",e=>c.ensureColor4(e.stippleOffColor))),f.code.add(o.glsl`float getStippleSDF(out bool isClamped) {
float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;
float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv * vLineSizeInv;
u = fract(u);
float encodedSDF = rgbaTofloat(texture(stipplePatternTexture, vec2(u, 0.5)));
float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;
return (sdf - 0.5) * vStipplePatternStretch + 0.5;
}
float getStippleSDF() {
bool ignored;
return getStippleSDF(ignored);
}
float getStippleAlpha() {
bool isClamped;
float stippleSDF = getStippleSDF(isClamped);
float antiAliasedResult = clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);
return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
}`),f.code.add(o.glsl`
    void discardByStippleAlpha(float stippleAlpha, float threshold) {
     ${o.If(!d.stippleOffColorEnabled,"if (stippleAlpha < threshold) { discard; }")}
    }

    vec4 blendStipple(vec4 color, float stippleAlpha) {
      return ${d.stippleOffColorEnabled?"mix(color, stippleOffColor, stippleAlpha)":"vec4(color.rgb, color.a * stippleAlpha)"};
    }
  `)},e.computePixelSize=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/stippleTextureRepository":function(){define(["exports","../../../../core/floatRGBA","./ProceduralTextureRepository","../../../webgl/Texture","../../../webgl/TextureDescriptor"],function(e,t,r,i,s){"use strict";function n(e){return e.pattern.map(t=>Math.round(t*e.pixelRatio))}function o(e){if(null==e)return 1;const t=n(e);return Math.floor(t.reduce((e,t)=>e+t))}function a(e){return n(e).reduce((e,t)=>Math.max(e,t))}e.computeLongestPattern=a,e.computeTextureSize=o,e.createStippleTextureRepository=function(e,l){return new r.ProceduralTextureRepository(r=>{const{encodedData:l,textureSize:c}=function(e){const r=n(e),i=1/e.pixelRatio,s=o(e),l=a(e),c=(Math.floor(.5*(l-1))+.5)*i,u=[];let d=1;for(const e of r){for(let t=0;t<e;t++){const r=d*(Math.min(t,e-1-t)+.5)*i/c*.5+.5;u.push(r)}d=-d}const h=Math.round(r[0]/2),p=[...u.slice(h),...u.slice(0,h)],f=new Uint8Array(4*s);let m=0;for(const e of p)t.packFloatRGBA(e,f,m),m+=4;return{encodedData:f,textureSize:s}}(r),u=new s.TextureDescriptor(c,1);return u.internalFormat=6408,u.wrapMode=10497,new i.Texture(e,u,l)},e=>`${e.pattern.join(",")}-r${e.pixelRatio}`,l)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/floatRGBA":function(){define(["exports","./mathUtils"],function(e,t){"use strict";function r(e,t=0){let r=0;for(let i=0;i<4;i++)r+=e[t+i]*s[i];return r}const i=[1,256,65536,16777216],s=[1/256,1/65536,1/16777216,1/4294967296],n=r(new Uint8ClampedArray([255,255,255,255])),o=r(new Uint8ClampedArray([255,255,255,0]));function a(e){return e-Math.floor(e)}e.maxRgbFloat=o,e.maxRgbaFloat=n,e.packFloatRGB=function(e,r,s=0){const n=t.clamp(e,0,o);for(let e=0;e<3;e++)r[s+e]=Math.floor(256*a(n*i[e]))},e.packFloatRGBA=function(e,r,s=0){const o=t.clamp(e,0,n);for(let e=0;e<4;e++)r[s+e]=Math.floor(256*a(o*i[e]))},e.unpackFloatRGBA=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/ProceduralTextureRepository":function(){define(["exports","../../../../core/uid"],function(e,t){"use strict";class r{constructor(e){this.texture=e,this.refCount=1}}e.ProceduralTextureRepository=class{constructor(e,r,i){this._createTexture=e,this._parametersKey=r,this._repository=new Map,this._orphanCache=i.newCache(`procedural-texture-repository:${t.generateUID()}`,e=>e.dispose())}destroy(){for(const{texture:e}of this._repository.values())e.dispose();this._repository.clear(),this._orphanCache.destroy()}swap(e,t=null){const r=this._acquire(e);return this.release(t),r}release(e){if(null==e)return;const t=this._parametersKey(e),r=this._repository.get(t);if(r&&(r.refCount--,0===r.refCount)){this._repository.delete(t);const{texture:e}=r;this._orphanCache.put(t,e)}}_acquire(e){if(null==e)return null;const t=this._parametersKey(e),i=this._repository.get(t);if(i)return i.refCount++,i.texture;const s=this._orphanCache.pop(t)??this._createTexture(e),n=new r(s);return this._repository.set(t,n),s}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/ensureColor4":function(){define(["exports","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64"],function(e,t,r){"use strict";const i=r.create();e.ensureColor4=function(e){return null==e?r.ZEROS:4===e.length?e:t.set(i,e[0],e[1],e[2],1)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/MarkerSizing.glsl":function(){define(["exports","../../../../support/engineContent/marker","../util/View.glsl","../../shaderModules/FloatBindUniform","../../shaderModules/glsl"],function(e,t,r,i,s){"use strict";e.MarkerSizing=function(e,n){const o=e.vertex;r.addPixelRatio(o),null==o.uniforms.get("markerScale")&&o.constants.add("markerScale","float",1),o.constants.add("markerSizePerLineWidth","float",t.markerSizePerLineWidth).code.add(s.glsl`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),2===n.space&&(o.constants.add("maxSegmentLengthFraction","float",.45),o.uniforms.add(new i.FloatBindUniform("perRenderPixelRatio",e=>e.camera.perRenderPixelRatio)),o.code.add(s.glsl`bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}
float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}`))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/engineContent/marker":function(){define(["exports","./sdfPrimitives","../../../webgl/Texture","../../../webgl/TextureDescriptor"],function(e,t,r,i){"use strict";e.createMarkerTexture=function(e,s){const n=t.createPrimitive(e,64,32,6.4),o=new i.TextureDescriptor(64);return o.internalFormat=6408,o.wrapMode=33071,new r.Texture(s,o,n)},e.markerSizePerLineWidth=10,e.markerSymbolSize=32,e.markerTextureSize=64,e.markerThickness=6.4,e.markerTipThicknessFactor=.25,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/engineContent/sdfPrimitives":function(){define(["exports","../../../../core/has","../../../../core/floatRGBA","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../webgl-engine/lib/Texture"],function(e,t,r,i,s){"use strict";const n=.5,o=i.freeze(.25,.25,.75,.75);function a(e,t=128,r=t*n,i=0){return{data:l(e,t,r,i),parameters:{mipmap:!1,wrap:{s:33071,t:33071},width:t,height:t,components:4,noUnpackFlip:!0,reloadable:!0}}}function l(e,t=128,r=t*n,i=0){switch(e){case"circle":default:return c(t,r);case"square":return u(t,r);case"cross":return h(t,r,i);case"x":return p(t,r,i);case"kite":return d(t,r);case"triangle":return f(t,r);case"arrow":return m(t,r)}}function c(e,t){const r=e/2-.5;return v(e,_(r,r,t/2))}function u(e,t){return g(e,t,!1)}function d(e,t){return g(e,t,!0)}function h(e,t,r=0){return y(e,t,!1,r)}function p(e,t,r=0){return y(e,t,!0,r)}function f(e,t){return v(e,b(e/2,t,t/2))}function m(e,t){const r=t,i=t/2,s=e/2,n=.8*r,o=_(s,(e-t)/2-n,Math.sqrt(n*n+i*i)),a=b(s,r,i);return v(e,(e,t)=>Math.max(a(e,t),-o(e,t)))}function g(e,t,r){return r&&(t/=Math.SQRT2),v(e,(i,s)=>{let n=i-.5*e+.25,o=.5*e-s-.75;if(r){const e=(n+o)/Math.SQRT2;o=(o-n)/Math.SQRT2,n=e}return Math.max(Math.abs(n),Math.abs(o))-.5*t})}function y(e,t,r,i=0){t-=i,r&&(t*=Math.SQRT2);const s=.5*t;return v(e,(t,n)=>{let o,a=t-.5*e,l=.5*e-n-1;if(r){const e=(a+l)/Math.SQRT2;l=(l-a)/Math.SQRT2,a=e}return a=Math.abs(a),l=Math.abs(l),o=a>l?a>s?Math.sqrt((a-s)*(a-s)+l*l):l:l>s?Math.sqrt(a*a+(l-s)*(l-s)):a,o-=i/2,o})}function _(e,t,r){return(i,s)=>{const n=i-e,o=s-t;return Math.sqrt(n*n+o*o)-r}}function b(e,t,r){const i=Math.sqrt(t*t+r*r);return(s,n)=>{const o=Math.abs(s-e)-r,a=n-e+t/2+.75,l=(t*o+r*a)/i,c=-a;return Math.max(l,c)}}function v(e,t){const i=new Uint8Array(4*e*e);for(let s=0;s<e;s++)for(let n=0;n<e;n++){const o=n+e*s;let a=t(n,s);a=a/e+.5,r.packFloatRGBA(a,i,4*o)}return i}e.createArrow=m,e.createCircle=c,e.createCross=h,e.createKite=d,e.createPrimitive=l,e.createSquare=u,e.createTexture=function(e,t=128,r=t*n,i=0){const{data:o,parameters:l}=a(e,t,r,i);return new s.Texture(o,l)},e.createTextureInfo=a,e.createTriangle=f,e.createX=p,e.defaultBoundingBox=o,e.defaultSymbolSizeRatio=n,e.defaultTexSize=128,e.requiresHalfTexelOffset=function(e){return"cross"===e||"x"===e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/AnimatedLine.glsl":function(){define(["exports","../core/shaderModules/FloatPassUniform","../core/shaderModules/glsl"],function(e,t,r){"use strict";e.AnimatedLine=function(e,i){if(!i.hasAnimation)return;const{attributes:s,varyings:n,vertex:o,fragment:a}=e;s.add("timeStamps","vec3"),n.add("vTimeStamp","float"),n.add("vFirstTime","float"),n.add("vLastTime","float"),o.main.add(r.glsl`vTimeStamp = timeStamps.x;
vFirstTime = timeStamps.y;
vLastTime = timeStamps.z;`);const{animation:l}=i;3===l&&a.constants.add("decayRate","float",2.3),a.code.add(r.glsl`
    float getTrailOpacity(float x) {
      ${function(e){switch(e){case 2:return"return x >= 0.0 && x <= 1.0 ? 1.0 : 0.0;";case 3:return"float cutOff = exp(-decayRate);\n        return (exp(-decayRate * x) - cutOff) / (1.0 - cutOff);";default:return"return 1.0;"}}(l)}
    }`),a.uniforms.add(new t.FloatPassUniform("timeElapsed",e=>e.timeElapsed),new t.FloatPassUniform("trailLength",e=>e.trailLength)).code.add(r.glsl`vec4 animate(vec4 color) {
float totalTimeWithTrail = vLastTime - vFirstTime + trailLength;
float timeAtHead = mod(timeElapsed - vFirstTime, totalTimeWithTrail) + vFirstTime;
float t = timeAtHead - vTimeStamp;
vec4 animatedColor = color * step(0.0, t);
animatedColor.a *= getTrailOpacity(t / trailLength);
return animatedColor;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/RibbonLineTechnique":function(){define(["require","exports","../../../../core/has","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../effects/geometry/olidUtils","../lib/OrderIndependentTransparency","../lib/StencilUtils","../../../../chunks/RibbonLine.glsl","../../../webgl/enums","../../../webgl/renderState"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";class p extends o.ShaderTechnique{constructor(t,r){super(t,r,new n.ReloadableShaderModule(u.RibbonLine,()=>new Promise((t,r)=>e(["./RibbonLine.glsl"],t,r))),m(r).locations),this.primitiveType=r.wireframe?d.PrimitiveType.LINES:d.PrimitiveType.TRIANGLE_STRIP}_makePipelineState(e,t){const{oitPass:r,output:i,hasOccludees:n,hasPolygonOffset:a}=e,u=0===r,d=2===r;return h.makePipelineState({blending:s.isColorOrColorEmission(i)?l.blending(r):null,depthTest:{func:l.oitDepthTest(r)},depthWrite:l.depthWrite(e),drawBuffers:o.depthOnlyOutputBuffersOr(i,l.getDrawBuffers(r,i)),colorWrite:h.defaultColorWrite,stencilWrite:n?c.stencilWriteMaskOn:null,stencilTest:n?t?c.stencilToolMaskBaseParams:c.stencilBaseAllZerosParams:null,polygonOffset:u||d?a?f:null:l.OITPolygonOffset})}initializePipeline(e){if(e.occluder){const t=e.hasPolygonOffset?f:null,{output:r,hasOccludees:i}=e;this._occluderPipelineTransparent=h.makePipelineState({blending:h.unpremultipliedAlphaToPremultipliedAlpha,polygonOffset:t,depthTest:c.depthCompareAlways,depthWrite:null,colorWrite:h.defaultColorWrite,stencilWrite:null,stencilTest:i?c.stencilToolTransparentOccluderParams:null,drawBuffers:o.depthOnlyOutputBuffersOr(r)}),this._occluderPipelineOpaque=h.makePipelineState({blending:h.unpremultipliedAlphaToPremultipliedAlpha,polygonOffset:t,depthTest:i?c.depthCompareAlways:c.depthCompareLess,depthWrite:null,colorWrite:h.defaultColorWrite,stencilWrite:i?c.stencilWriteMaskOff:null,stencilTest:i?c.stencilToolMaskOccluderParams:null,drawBuffers:o.depthOnlyOutputBuffersOr(r)}),this._occluderPipelineMaskWrite=h.makePipelineState({blending:null,polygonOffset:t,depthTest:c.depthCompareLess,depthWrite:null,colorWrite:null,stencilWrite:i?c.stencilWriteMaskOn:null,stencilTest:i?c.stencilToolMaskBaseParams:null,drawBuffers:o.depthOnlyOutputBuffersOr(r)})}return this._occludeePipeline=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){if(e)return this._occludeePipeline;switch(t){case 11:return this._occluderPipelineTransparent??super.getPipeline();case 10:return this._occluderPipelineOpaque??super.getPipeline();default:return this._occluderPipelineMaskWrite??super.getPipeline()}}}const f={factor:0,units:-4};function m(e){const t=i.newLayout().vec3f("position").vec4f16("previousDelta").vec4f16("nextDelta").f32("u0").vec2f16("lineParameters");return e.hasVVColor?t.f32("colorFeatureAttribute"):t.vec4u8("color",{glNormalized:!0}),e.hasVVSize?t.f32("sizeFeatureAttribute"):t.f32("size"),e.hasVVOpacity&&t.f32("opacityFeatureAttribute"),a.olidEnabled()&&t.vec4u8("olidColor"),e.hasAnimation&&t.vec3f16("timeStamps"),t}t.RibbonLineTechnique=p,t.getLayout=m,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/RibbonLineTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(){super(...arguments),this.capType=0,this.emissionSource=0,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.occluder=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.wireframe=!1,this.discardInvisibleFragments=!1,this.animation=2,this.textureCoordinateType=0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasSliceTranslatedView=!0,this.overlayEnabled=!1,this.snowCover=!1}get hasAnimation(){return 0!==this.animation}}t.__decorate([r.parameter({count:3})],s.prototype,"capType",void 0),t.__decorate([r.parameter({count:8})],s.prototype,"emissionSource",void 0),t.__decorate([r.parameter()],s.prototype,"hasPolygonOffset",void 0),t.__decorate([r.parameter()],s.prototype,"writeDepth",void 0),t.__decorate([r.parameter()],s.prototype,"draped",void 0),t.__decorate([r.parameter()],s.prototype,"stippleEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"stippleOffColorEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"stipplePreferContinuous",void 0),t.__decorate([r.parameter()],s.prototype,"roundJoins",void 0),t.__decorate([r.parameter()],s.prototype,"applyMarkerOffset",void 0),t.__decorate([r.parameter()],s.prototype,"hasVVSize",void 0),t.__decorate([r.parameter()],s.prototype,"hasVVColor",void 0),t.__decorate([r.parameter()],s.prototype,"hasVVOpacity",void 0),t.__decorate([r.parameter()],s.prototype,"falloffEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"innerColorEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"hasOccludees",void 0),t.__decorate([r.parameter()],s.prototype,"occluder",void 0),t.__decorate([r.parameter()],s.prototype,"terrainDepthTest",void 0),t.__decorate([r.parameter()],s.prototype,"cullAboveTerrain",void 0),t.__decorate([r.parameter()],s.prototype,"wireframe",void 0),t.__decorate([r.parameter()],s.prototype,"discardInvisibleFragments",void 0),t.__decorate([r.parameter({count:4})],s.prototype,"animation",void 0),e.RibbonLineTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/RenderContext":function(){define(["exports","../../../../core/time","../../webgl/RenderCamera","./BindParameters"],function(e,t,r,i){"use strict";e.RenderContext=class{constructor(e,s,n){this.rctx=e,this.techniques=n,this.lastFrameCamera=new r,this.output=0,this.renderOccludedMask=13,this.time=t.Milliseconds(0),this.bind=new i.BindParameters(s),this.bind.alignPixelEnabled=!0}},e.defaultRenderOccludedMask=13,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/BindParameters":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../environment/CloudsParameters","../../webgl/RenderCamera","../lighting/SceneLighting"],function(e,t,r,i,s,n){"use strict";class o{constructor(){this.fadeFactor=1,this.reprojectionMatrix=t.create()}}e.BindParameters=class{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new s,this._inverseViewport=r.create(),this._oldLighting=new n.SceneLighting,this._newLighting=new n.SceneLighting,this._fadedLighting=new n.SceneLighting,this._lighting=this._newLighting,this.ssr=new o,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=r.create(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=!1,this.clouds=new i.CloudsParameters,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,r,i){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=r,this._newLighting.set(e),1===i&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return null==this.highlightLevel?null:this.highlights[this.highlightLevel]}},e.ViewportSize=class{constructor(e,t){this.width=e,this.height=t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/CloudsParameters":function(){define(["exports","../../../core/compilerUtils","../../../core/mathUtils","../../../core/signal","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/axisAngleDegrees","../../../geometry/support/Ellipsoid","./Clouds","./weather"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h{constructor(){this.anchorPoint=a.create(),this.radiusCurvatureCorrection=0,this.transform=n.create()}}const p=a.fromValues(0,0,1),f=l.create(),m=a.create();e.CloudsParameters=class{constructor(){this.startTime=0,this._data=i.signal(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new h,this.parallaxNew=new h,this._anchorPoint=a.create(),this._fadeState=i.signal(0),this._fadeFactor=i.signal(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,t,i){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=i?r.clamp((t-this.startTime)/(1.25*i),0,1):1,1===this.fadeFactor&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(e,t){const r=e.relativeElevation,i=this._updateAnchorPoint(e);(r>1.7*d.heightLimit||r<-d.heightLimit||i>2e5)&&this.opacity>0?this._startFade(0,t):this.isFading||(r>d.heightLimit||r<-.35*d.heightLimit||i>1e5?this.opacity>0&&this._startFade(4,t):u.ensureClouds(this.data)&&(0===this.opacity?this._startFade(1,t):2===this.data.state&&(2===this.fadeState?this._startFade(3,t):this._startFade(2,t))))}_updateParallax(e){const t=o.squaredLength(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-c.earth.radius*c.earth.radius,0))/Math.sqrt(t),l.fromPoints(p,this.parallax.anchorPoint,f),s.rotate(this.parallax.transform,n.IDENTITY,f[3],l.axis(f)),l.fromPoints(p,this.parallaxNew.anchorPoint,f),s.rotate(this.parallaxNew.transform,n.IDENTITY,f[3],l.axis(f))}_updateAnchorPoint(e){return o.normalize(this._anchorPoint,e.eye),o.scale(this._anchorPoint,this._anchorPoint,c.earth.radius),0===this.fadeState&&2===this.data?.state?(o.copy(this.parallax.anchorPoint,this._anchorPoint),0):o.length(o.subtract(m,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,t){switch(this._fadeState.value=e,this.startTime=t,e){case 3:this.requestFade(),this._switchReadChannels(),o.copy(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),o.copy(this.parallax.anchorPoint,this._anchorPoint),o.copy(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),o.copy(this.parallax.anchorPoint,this._anchorPoint),o.copy(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&2!==this.data.state&&(this.data.state=0),this.fadeState){case 3:o.copy(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:t.neverReached(this.fadeState)}}_switchReadChannels(){2===this.data?.state&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return 4===this.fadeState||1===this.fadeState||3===this.fadeState}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/Clouds":function(){define(["exports"],function(e){"use strict";e.ensureClouds=function(e){return null!=e&&!e.readyToRun},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/ShadowMap":function(){define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","./CascadeCamera","./textureUtils","./Util","../../../webgl/enums"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g){"use strict";class y{constructor(){this.camera=new p.CascadeCamera,this.lightMat=o.create()}}class _{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}const b=o.create(),v=h.create(),w=[];for(let e=0;e<8;++e)w.push(h.create());const x=l.create(),S=l.create(),T=l.create(),C=l.create(),P=l.create(),M=u.create(),R=[],O=o.create(),I=o.IDENTITY.concat(o.IDENTITY,o.IDENTITY,o.IDENTITY,o.IDENTITY),F=l.create(),A=l.create(),D=[l.create(),l.create(),l.create(),l.create()],E=l.create(),L=l.create(),V=l.create(),U=l.create(),B=l.create(),N=l.create(),k=l.create();function z(e,t){return 3*t+e}const j=l.create();function G(e,t){return a.set(j,e[t],e[t+3]),j}const q=l.create(),H=s.create();e.ShadowMap=class{constructor(e,r){this._fbos=e,this._viewingMode=r,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new _,this._projectionView=o.create(),this._projectionViewInverse=o.create(),this._modelViewLight=o.create(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=h.create(),this._cascades=[new y,new y,new y,new y],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(t("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(g.DepthStencilAttachment)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return d.set(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=i.releaseMaybe(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=r.clamp(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let e=0;e<this._numCascades;++e)R[e]=this._cascades[e];return R.length=this._numCascades,R}start(e,t,r,i,s){m.assert(this.enabled);const{near:n,far:o}=function(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}(r);this._computeCascadeDistances(n,o,i),this._textureHeight=this._computeTextureHeight(e,s,i),this._setupMatrices(e,t);const{viewMatrix:a,projectionMatrix:l}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,l,a,t);this._lastOrigin=null,this.clear()}finish(){m.assert(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!c.exactEquals(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||u.create(),c.copy(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){n.translate(O,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)I[16*t+e]=O[e]}}return I}moveSnapshot(e){m.assert(this.enabled),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle?.setName(0===e?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(e){if(!this.enabled)return;const t=this._handle?.getTexture(g.DepthStencilAttachment)?.descriptor;if(!t)return;this._snapshots[e]?.release();const r=0===e?"shadow map highlight":"shadow map excluding highlight",i=this._acquireFBO(r);this._snapshots[e]=i;const s=this._handle?.fbo;if(!s||!i?.fbo)return void console.error("No FBO");const{rctx:n}=this._fbos;n.blitFramebuffer(s,i.fbo,256)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture(g.DepthStencilAttachment):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:e,fullWidth:t,fullHeight:r},i,s){const n=Math.min(window.devicePixelRatio,i)/e,o=s?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return f.applyTextureResizeModulo(Math.max(t,r)*n*o,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(e){const t=this._fbos.acquire(this._textureWidth,this._textureHeight,e,10);return t.getTexture(g.DepthStencilAttachment)?.setShadowFiltering(!0),t}_discardSnapshot(e){this._snapshots[e]=i.releaseMaybe(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,i,s){const o=this._cascades[e],l=-this._cascadeDistances[e],u=-this._cascadeDistances[e+1],h=(t[10]*l+t[14])/Math.abs(t[11]*l+t[15]),p=(t[10]*u+t[14])/Math.abs(t[11]*u+t[15]);m.assert(h<p);for(let e=0;e<8;++e){d.set(v,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?h:p,1);const t=w[e];d.transformMat4(t,v,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}c.negate(M,w[0]),o.camera.viewMatrix=n.translate(b,this._modelViewLight,M);for(let e=0;e<8;++e)c.transformMat4(w[e],w[e],o.camera.viewMatrix);let f=w[0][2],g=w[0][2];for(let e=1;e<8;++e)f=Math.min(f,w[e][2]),g=Math.max(g,w[e][2]);f-=200,g+=200,o.camera.near=-g,o.camera.far=-f,function(e,t,i,s,n){const o=1/w[0][3],l=1/w[4][3];m.assert(o<l);let c=o+Math.sqrt(o*l);const u=Math.sin(r.acosClamped(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));c/=u,function(e,t,r,i,s,n,o,l){a.set(F,0,0);for(let t=0;t<4;++t)a.add(F,F,e[t]);a.scale(F,F,.25),a.set(A,0,0);for(let t=4;t<8;++t)a.add(A,A,e[t]);a.scale(A,A,.25),a.lerp(D[0],e[4],e[5],.5),a.lerp(D[1],e[5],e[6],.5),a.lerp(D[2],e[6],e[7],.5),a.lerp(D[3],e[7],e[4],.5);let c=0,u=a.squaredDistance(D[0],F);for(let e=1;e<4;++e){const t=a.squaredDistance(D[e],F);t<u&&(u=t,c=e)}a.subtract(E,D[c],e[c+4]);const d=E[0];let h,p;E[0]=-E[1],E[1]=d,a.subtract(L,A,F),a.dot(L,E)<0&&a.negate(E,E),a.lerp(E,E,L,r),a.normalize(E,E),h=p=a.dot(a.subtract(V,e[0],F),E);for(let t=1;t<8;++t){const r=a.dot(a.subtract(V,e[t],F),E);r<h?h=r:r>p&&(p=r)}a.copy(i,F),a.scale(V,E,h-t),a.add(i,i,V);let f=-1,g=1,y=0,_=0;for(let t=0;t<8;++t){a.subtract(U,e[t],i),a.normalize(U,U);const r=E[0]*U[1]-E[1]*U[0];r>0?r>f&&(f=r,y=t):r<g&&(g=r,_=t)}m.verify(f>0,"leftArea"),m.verify(g<0,"rightArea"),a.scale(B,E,h),a.add(B,B,F),a.scale(N,E,p),a.add(N,N,F),k[0]=-E[1],k[1]=E[0];const b=m.rayRay2D(i,e[_],N,a.add(V,N,k),1,s),v=m.rayRay2D(i,e[y],N,V,1,n),w=m.rayRay2D(i,e[y],B,a.add(V,B,k),1,o),x=m.rayRay2D(i,e[_],B,V,1,l);m.verify(b,"rayRay"),m.verify(v,"rayRay"),m.verify(w,"rayRay"),m.verify(x,"rayRay")}(w,c,u,x,S,T,C,P),function(e,t,r,i,s){a.subtract(q,r,i),a.scale(q,q,.5),H[0]=q[0],H[1]=q[1],H[2]=0,H[3]=q[1],H[4]=-q[0],H[5]=0,H[6]=q[0]*q[0]+q[1]*q[1],H[7]=q[0]*q[1]-q[1]*q[0],H[8]=1,H[z(0,2)]=-a.dot(G(H,0),e),H[z(1,2)]=-a.dot(G(H,1),e);let n=a.dot(G(H,0),r)+H[z(0,2)],o=a.dot(G(H,1),r)+H[z(1,2)],l=a.dot(G(H,0),i)+H[z(0,2)],c=a.dot(G(H,1),i)+H[z(1,2)];n=-(n+l)/(o+c),H[z(0,0)]+=H[z(1,0)]*n,H[z(0,1)]+=H[z(1,1)]*n,H[z(0,2)]+=H[z(1,2)]*n,n=1/(a.dot(G(H,0),r)+H[z(0,2)]),o=1/(a.dot(G(H,1),r)+H[z(1,2)]),H[z(0,0)]*=n,H[z(0,1)]*=n,H[z(0,2)]*=n,H[z(1,0)]*=o,H[z(1,1)]*=o,H[z(1,2)]*=o,H[z(2,0)]=H[z(1,0)],H[z(2,1)]=H[z(1,1)],H[z(2,2)]=H[z(1,2)],H[z(1,2)]+=1,n=a.dot(G(H,1),t)+H[z(1,2)],o=a.dot(G(H,2),t)+H[z(2,2)],l=a.dot(G(H,1),r)+H[z(1,2)],c=a.dot(G(H,2),r)+H[z(2,2)],n=-.5*(n/o+l/c),H[z(1,0)]+=H[z(2,0)]*n,H[z(1,1)]+=H[z(2,1)]*n,H[z(1,2)]+=H[z(2,2)]*n,n=a.dot(G(H,1),t)+H[z(1,2)],o=a.dot(G(H,2),t)+H[z(2,2)],l=-o/n,H[z(1,0)]*=l,H[z(1,1)]*=l,H[z(1,2)]*=l,s[0]=H[0],s[1]=H[1],s[2]=0,s[3]=H[2],s[4]=H[3],s[5]=H[4],s[6]=0,s[7]=H[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=H[6],s[13]=H[7],s[14]=0,s[15]=H[8]}(x,S,C,P,n.projectionMatrix),n.projectionMatrix[10]=2/(i-s),n.projectionMatrix[14]=-(i+s)/(i-s)}(i,s,f,g,o.camera),n.multiply(o.lightMat,o.camera.projectionMatrix,o.camera.viewMatrix);const y=this._textureHeight;o.camera.viewport=[e*y,0,y,y]}_setupMatrices(e,t){n.multiply(this._projectionView,e.projectionMatrix,e.viewMatrix),n.invert(this._projectionViewInverse,this._projectionView);const r=1===this._viewingMode?e.eye:c.set(M,0,0,1);n.lookAt(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],r)}_computeCascadeDistances(e,t,i){const s=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(m.logWithBase(t/e,4)),s);const n=(t-e)/this._numCascades,o=(t/e)**(1/this._numCascades);let a=e,l=e;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=r.lerp(a,l,this.settings.splitSchemeLambda),a*=o,l+=n}get test(){}},e.cleanupShadowmap=function(){R.length=0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/CascadeCamera":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../webgl/RenderCamera"],function(e,t,r,i,s,n,o,a,l){"use strict";e.CascadeCamera=class extends l{constructor(){super(...arguments),this._projectionMatrix=a.create()}get projectionMatrix(){return this._projectionMatrix}},t.__decorate([r.property()],e.CascadeCamera.prototype,"_projectionMatrix",void 0),t.__decorate([r.property({readOnly:!0})],e.CascadeCamera.prototype,"projectionMatrix",null),e.CascadeCamera=t.__decorate([o.subclass("esri.views.3d.webgl-engine.lib.CascadeCamera")],e.CascadeCamera),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextureTechnique":function(){define(["require","exports","../../../../chunks/TextureOnly.glsl","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","./DefaultVertexBufferLayouts","../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.TextureOnly,()=>new Promise((t,r)=>e(["../core/shaderLibrary/util/TextureOnly.glsl"],t,r))),n.Pos2Locations)}initializePipeline(e){return e.hasAlpha?o.makePipelineState({blending:o.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:o.defaultColorWrite}):o.makePipelineState({colorWrite:o.defaultColorWrite})}}t.TextureTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextureTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.hasAlpha=!1}}t.__decorate([r.parameter()],i.prototype,"hasAlpha",void 0),e.TextureTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/OverlayCompositing.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/IntegerPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a){"use strict";class l extends o.NoParameters{constructor(){super(...arguments),this.overlayIndex=0,this.opacity=1}}function c(){const e=new a.ShaderBuilder;return e.include(t.ScreenSpacePass),e.fragment.uniforms.add(new n.Texture2DPassUniform("tex",e=>e.texture)),e.fragment.uniforms.add(new s.IntegerPassUniform("overlayIdx",e=>e.overlayIndex)),e.fragment.uniforms.add(new r.FloatPassUniform("opacity",e=>e.opacity)),e.fragment.main.add(i.glsl`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:l,build:c},Symbol.toStringTag,{value:"Module"}));e.OverlayCompositing=u,e.OverlayCompositingPassParameters=l,e.build=c})},"esri/views/3d/webgl-engine/shaders/OverlayCompositingTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/DefaultVertexBufferLayouts","../../../../chunks/OverlayCompositing.glsl"],function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.OverlayCompositing,()=>new Promise((t,r)=>e(["./OverlayCompositing.glsl"],t,r))),s.Pos2Locations)}}t.OverlayCompositingTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/SortedRenderGeometryRenderer":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/arrayUtils","../../../../core/has","../../../../core/MapUtils","../../../../core/PooledArray","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/sphere","../../terrain/Intersector","./ChangeSet","./IntersectorResult","./RendererBase","../../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";e.SortedRenderGeometryRenderer=class extends f.RendererBase{constructor(e){super(e),this._pending=new g,this._changes=new h.ChangeSet,this._sortedRenderers=new n,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this.destroyed||(this._changes.prune(),this._sortedRenderers.prune(),this._geometries.clear(),this._pending.clear())}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}hasHighlight(e){return s.someMap(this.renderers,t=>t.hasHighlight(e))}get hasWater(){return this._hasWater}get hasOccluders(){return this.renderers&&s.someMap(this.renderers,e=>e.hasOnlyOccluders)}get hasOnlyOccluders(){return s.everyMap(this.renderers,e=>e.hasOnlyOccluders)}get isEmpty(){return!this.updating&&0===this.renderers.size&&0===this._geometries.size}get sortedRenderers(){return this._sortedRenderers}commitChanges(){return!!this.updating&&(this._processAddsRemoves(),this.commit(this._changes,m.noBudget,this.rendererContext.pluginContext)&&(this._updateSortedMaterialRenderers(),this._hasHighlights=s.someMap(this.renderers,e=>{const t=e.produces.get(18);return!!t&&t(8)}),this._hasWater=s.someMap(this.renderers,e=>{const t=e.produces.get(19);return!!t&&t(3)})),this.notifyChange("updating"),!0)}rendererAdded(){this._sortedRenderers.clear()}rendererRemoved(){this._sortedRenderers.clear()}addGeometries(e,t){if(0===e.length)return;const r=this._validateRenderGeometries(e);for(const e of r)this._geometries.set(e.id,e);const i=this._pending.empty;for(const e of r)this._pending.adds.add(e);switch(i&&this.notifyChange("updating"),t){case 0:this._notifyGraphicVisibilityChanged(e);break;case 1:this._notifyGraphicGeometryChanged(e)}}removeGeometries(e,t){if(this.destroyed)return;const r=this._pending.empty,i=this._pending.adds;for(const t of e)i.has(t)?(this._pending.removed.add(t),i.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t),this._geometries.delete(t.id);r&&!this._pending.empty&&this.notifyChange("updating"),1===t&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const r=0===this._changes.updates.length;for(const r of e){const e=new h.RenderGeometryUpdate;this._changes.updates.push(e),e.renderGeometry=this._ensureValidRenderGeometry(r),e.updateType=t}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case 4:case 2:return this._notifyGraphicGeometryChanged(e);case 1:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedRenderers.forAll(r=>t=!!r.updateAnimation&&r.updateAnimation(e)||t),t}precompile(e){return this._sortedRenderers.reduce((t,r)=>r.precompile(e)||t,!1)}render(e){this._sortedRenderers.forAll(t=>{const r=t.acquireTechniques(e);r&&t.render(e,r)})}intersect(e,t,r,i,s){for(const n of this._geometries.values()){if(!i(n))continue;this._intersectRenderGeometry(n,r,t,0,e,s);const o=this.rendererContext.longitudeCyclical;o&&(n.boundingSphere[0]-n.boundingSphere[3]<o.min&&this._intersectRenderGeometry(n,r,t,o.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>o.max&&this._intersectRenderGeometry(n,r,t,-o.range,e,s)),s++}return s}_updateSortedMaterialRenderers(){if(!(this._sortedRenderers.length>0)){for(const e of this.renderers.values())this._sortedRenderers.push(e);this._sortedRenderers.sort((e,t)=>t.material?.renderPriority===e.material?.renderPriority?e.drapedPriority-t.drapedPriority:(t.material?.renderPriority||0)-(e.material?.renderPriority||0))}}_processAddsRemoves(){this._changes.adds.length=0,this._changes.removes.length=0,r.addMany(this._changes.adds,Array.from(this._pending.adds)),r.addMany(this._changes.removes,Array.from(this._pending.removes)),r.filterInPlace(this._changes.updates,({renderGeometry:e})=>!this._pending.has(e)),this._pending.clear()}_intersectRenderGeometry(e,t,r,i,s,n){if(!e.visible||!e.material.visible||!e.material.intersectDraped)return;let o=0;i+=e.transformation[12],o=e.transformation[13],y[0]=r[0]-i,y[1]=r[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,s,y,(r,i,o)=>{!function(e,t,r,i,s,n,o){const a=new d.OverlayTarget(n,o,t),l=t=>{t.set(3,a,e.distance,e.normal,e.transformation,r,i)};if((null==s.results.min.drapedLayerOrder||r>=s.results.min.drapedLayerOrder)&&(null==s.results.min.distance||s.results.ground.distance<=s.results.min.distance)&&l(s.results.min),0!==s.options.store&&(null==s.results.max.drapedLayerOrder||r<s.results.max.drapedLayerOrder)&&(null==s.results.max.distance||s.results.ground.distance>s.results.max.distance)&&l(s.results.max),2===s.options.store){const e=new p.IntersectorResult(s.ray);l(e),s.results.all.push(e)}}(t,o,n,e.material.renderPriority,s,e.layerViewUid,e.graphicUid)},t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const{graphicUid:r}of e)null!=r&&r!==t&&(this.drapeSource.notifyGraphicGeometryChanged(r),t=r)}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const{graphicUid:r}of e)null!=r&&r!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(r),t=r)}_validateRenderGeometries(e){for(const t of e)this._ensureValidRenderGeometry(t);return e}_ensureValidRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin(u.getCenter(e.boundingSphere))),e}get test(){}},t.__decorate([o.property({constructOnly:!0})],e.SortedRenderGeometryRenderer.prototype,"drapeSource",void 0),t.__decorate([o.property({constructOnly:!0})],e.SortedRenderGeometryRenderer.prototype,"rendererContext",void 0),t.__decorate([o.property()],e.SortedRenderGeometryRenderer.prototype,"updating",null),t.__decorate([o.property()],e.SortedRenderGeometryRenderer.prototype,"rctx",null),t.__decorate([o.property()],e.SortedRenderGeometryRenderer.prototype,"_localOriginFactory",null),t.__decorate([o.property({readOnly:!0})],e.SortedRenderGeometryRenderer.prototype,"isEmpty",null),t.__decorate([o.property()],e.SortedRenderGeometryRenderer.prototype,"_geometries",void 0),e.SortedRenderGeometryRenderer=t.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],e.SortedRenderGeometryRenderer);class g{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const y=c.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/ChangeSet":function(){define(["exports","../../../../core/arrayUtils"],function(e,t){"use strict";e.ChangeSet=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}clear(){this.adds.length=0,this.removes.length=0,this.updates.length=0}prune(){this.clear()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}},e.MaterialChangeSet=class{constructor(e){this.pending=e,this.adds=new Array,this.removes=new Array,this.updates=new Array}clearAddsAndRemoves(){this.adds.forEach(e=>t.removeUnordered(this.pending.adds,e)),this.removes.forEach(e=>t.removeUnordered(this.pending.removes,e)),this.adds.length=0,this.removes.length=0}clearUpdates(){this.updates.forEach(e=>t.removeUnordered(this.pending.updates,e)),this.updates.length=0}clear(){this.clearUpdates(),this.clearAddsAndRemoves()}},e.RenderGeometryUpdate=class{},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/RendererBase":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./rendererUtils","../materials/renderers/MergedRenderer"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.RendererBase=class extends r{constructor(e){super(e),this._renderers=new Map}destroy(){this._renderers.forEach(e=>!e.destroyed&&e.destroy()),this._renderers.clear()}initialize(){this.addHandles(i.watch(()=>this.stage.view.state.highlights,()=>this.updateHighlights()))}getMaterialRenderer(e){return this._renderers.get(e)}updateHighlights(){this._renderers.forEach(e=>e.updateHighlights(this.stage.view.state.highlightOrderMap))}commit(e,t,r){const{adds:i,removes:s,updates:n}=e;if(0===i.length&&0===s.length&&0===n.length)return!1;c.splitRenderGeometryChangeSetByMaterial(e).forEach((e,i)=>{if(t.done)return;let s=this._renderers.get(i);null==s&&e.adds.length>0&&(s=new u.MergedRenderer({material:i,highlightOrderMap:this.stage.view.state.highlightOrderMap}),s.initializeRenderContext(r),this.rendererAdded(s),this._renderers.set(i,s)),s?(s.modify(e,t),s.updateHighlights(this.stage.view.state.highlightOrderMap),0===s.numGeometries&&(this._renderers.delete(s.material),this.rendererRemoved(s),s.destroy())):(e.clear(),t.madeProgress())});let o=0;for(const e of this._renderers.values())e.drapedPriority=o++;return!0}get canCompact(){for(const e of this._renderers.values())if(e.canCompact)return!0;return!1}compact(e){let t=!1;for(const r of this._renderers.values()){if(e.done)return t;t=r.compact(e)||t}return t}get renderers(){return this._renderers}},t.__decorate([s.property({constructOnly:!0})],e.RendererBase.prototype,"stage",void 0),e.RendererBase=t.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.RendererBase")],e.RendererBase),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/rendererUtils":function(){define(["exports","./ChangeSet"],function(e,t){"use strict";function r(e){return e.geometry.indexCount>=1}e.splitRenderGeometryChangeSetByMaterial=function(e){const i=new Map,s=r=>{let s=i.get(r);return s||(s=new t.MaterialChangeSet(e),i.set(r,s)),s};return e.removes.forEach(e=>{r(e)&&s(e.material).removes.push(e)}),e.adds.forEach(e=>{r(e)&&s(e.material).adds.push(e)}),e.updates.forEach(e=>{r(e.renderGeometry)&&s(e.renderGeometry.material).updates.push(e)}),i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/renderers/MergedRenderer":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../effects/RenderPlugin","./MergedBuffer","./VaoRenderer"],function(e,t,r,i,s,n,o,a,l,c){"use strict";e.MergedRenderer=class extends a.SyncRenderPlugin{constructor(e){super(e),this._dataByOrigin=new Map,this._buffer=null,this._renderer=null,this.drapedPriority=0}initialize(){this._buffer=new l.MergedBuffer({material:this.material,dataByOrigin:this._dataByOrigin,highlightOrderMap:this.highlightOrderMap}),this._renderer=new c.VaoRenderer({material:this.material,dataByOrigin:this._dataByOrigin})}destroy(){for(const e of this._dataByOrigin.values())e.dispose();this._dataByOrigin.clear(),this._buffer.destroy(),this._renderer.destroy()}hasHighlight(e){return this._renderer.hasHighlight(e)}initializeRenderContext(e){this._buffer.initializeRenderContext(e),this._renderer.initializeRenderContext(e)}uninitializeRenderContext(){this._buffer.uninitializeRenderContext(),this._renderer.uninitializeRenderContext()}get produces(){return this._renderer.produces}get hasOccludees(){return this._buffer.hasOccludees}get hasOnlyOccluders(){return!!(-2&this.renderOccludedFlags)}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}get renderOccludedFlags(){return this.material.renderOccludedFlags}get numGeometries(){let e=0;return this._dataByOrigin.forEach(t=>e+=t.buffers.reduce((e,t)=>e+t.instances.size,0)),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach(t=>e+=t.buffers.reduce((e,t)=>e+t.vao.cachedMemory,0)),e}forEachGeometry(e){this._dataByOrigin.forEach(t=>t.buffers.forEach(t=>t.instances.forEach(({geometry:t})=>e(t))))}modify(e,t){this._buffer.modify(e,t),this._renderer.updateHighlights()}get canCompact(){return this._buffer.canCompact}compact(e){return this._buffer.compact(e)}updateHighlights(e){this.highlightOrderMap=e,this._buffer.updateHighlights(e),this._renderer.updateHighlights()}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){return this._renderer.acquireTechniques(e)}render(e,t){return this._renderer.render(e,t)}static prune(){l.MergedBuffer.prune()}get test(){}},t.__decorate([i.property({constructOnly:!0})],e.MergedRenderer.prototype,"material",void 0),t.__decorate([i.property()],e.MergedRenderer.prototype,"highlightOrderMap",void 0),e.MergedRenderer=t.__decorate([o.subclass("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],e.MergedRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/renderers/MergedBuffer":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/arrayUtils","../../../../../core/mathUtils","../../../../../core/NestedMap","../../../../../core/PooledArray","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../support/buffer/glUtil","../../lib/Util","./BufferRange","./Instance","./PerBufferData","./PerOriginData"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";e.MergedBuffer=class extends r{constructor(e){super(e),this._vaoCache=null,this._bufferWriter=null,this._useMetalWorkaround=!1,this._hasOccludees=!1}destroy(){this.uninitializeRenderContext()}initializeRenderContext(e){this._useMetalWorkaround=e.renderContext.rctx.isAssumedMetalDriver,this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(p.glLayout(this._bufferWriter.layout))}uninitializeRenderContext(){this._useMetalWorkaround=!1,this._bufferWriter=null,this._vaoCache=null}get hasOccludees(){return this._hasOccludees}modify(e,t){this._applyUpdates(e,t),this._applyAddsAndRemoves(e),this._updateDrawCommands()}get canCompact(){for(const e of this.dataByOrigin.values())if(e.buffers.some(e=>e.holes.length>1))return!0;return!1}compact(e){if(!this.canCompact)return!1;let t=!1;for(const r of this.dataByOrigin.values()){const i=new Array;for(let t=0;t<r.buffers.length&&!e.done;){const s=r.buffers[t];s.holes.length<=1?++t:(s.instances.forEach(({geometry:e})=>i.push(e)),this._vaoCache.deleteVao(s.vao),r.buffers[t]=r.buffers[r.buffers.length-1],--r.buffers.length,e.madeProgress())}if(i.length>0){for(r.buffers.forEach(e=>this._applyAdds(e,i));i.length>0;)r.buffers.push(this._applyAndRebuild(new y.PerBufferData,i,null));t=!0}}return t}updateHighlights(e){this.highlightOrderMap=e,this.dataByOrigin.forEach(t=>t.buffers.forEach(t=>t.updateHighlights(e)))}_applyUpdates(e,t){const r=this._bufferWriter;if(null==r)return void e.clearUpdates();const s=r.layout.stride/4;for(const n of e.updates){if(t.done)return;const{renderGeometry:o,updateType:a}=n;i.removeUnordered(e.pending.updates,n),t.madeProgress();const l=this.dataByOrigin.get(o.localOrigin.id),c=l?.findBuffer(o.id);if(null==c)return;const u=c.instances.get(o.id);if(6&a){const e=I(r.elementCount(u.geometry.geometry.attributes)*s),t=r.layout.createView(e.buffer);this._writeGeometry(o,t,0),c.vao.buffer()?.setSubData(e,u.from*s,0,u.numElements*s)}25&a&&(c.drawCommandsDirty=!0)}}_computeDeltas(e,t){const r=new n.NestedMap;for(const t of e){const e=t.localOrigin;if(null==e)continue;let i=r.get(e.id,null);null==i&&(i=new b(e.vec3),r.set(e.id,null,i)),i.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const i=this.dataByOrigin.get(t.id),s=i?.findBuffer(e.id);if(null==s)continue;let n=r.get(t.id,s);null==n&&(n=new b(t.vec3),r.set(t.id,s,n)),n.changes.push(e)}return r}_applyAddsAndRemoves(e){const{_bufferWriter:t,dataByOrigin:r,_vaoCache:s}=this;if(null==t||null==s)return void e.clearAddsAndRemoves();const n=t.layout.stride/4,o=this._computeDeltas(e.adds,e.removes);o.forEach((e,a)=>{const l=e.get(null),c=l?.changes??[];o.delete(a,null);let u=r.get(a);if(e.forEach((e,l)=>{if(o.delete(a,l),null==l&&f.assert(!1,"No VAO for removed geometries"),l.instances.size===e.changes.length)return s.deleteVao(l.vao),i.removeUnordered(u.buffers,l),void(0===u.buffers.length&&0===c.length&&r.delete(a));const d=l.numElements,h=l.vao.getByteLength("geometry")/4,p=c.reduce((e,r)=>e+t.elementCount(r.geometry.attributes),0),m=e.changes.reduce((e,r)=>e+t.elementCount(r.geometry.attributes),0),g=Math.min((d+p-m)*n,R),y=g>h;g>T&&g<h/2?(e.changes.forEach(({id:e})=>l.deleteInstance(e)),l.instances.forEach(({geometry:e})=>c.push(e)),this._vaoCache.deleteVao(l.vao),i.removeUnordered(u.buffers,l)):y?this._applyAndRebuild(l,c,e):this._applyRemoves(l,e)}),c.length>0)for(null==u&&(u=new _.PerOriginData(l.origin),r.set(a,u)),u.buffers.forEach(e=>this._applyAdds(e,c));c.length>0;)u.buffers.push(this._applyAndRebuild(new y.PerBufferData,c,null))}),e.clearAddsAndRemoves()}_updateDrawCommands(){this._hasOccludees=!1,this.dataByOrigin.forEach(e=>{e.buffers.forEach(e=>{e.updateIfDrawCommandsDirty(this.highlightOrderMap,this._bufferWriter.layout.stride),this._hasOccludees||=e.hasOccludees})})}_applyAndRebuild(e,t,r){if(r)for(const t of r.changes)e.deleteInstance(t.id);const i=this._bufferWriter,s=i.layout.stride,n=s/4,o=Math.floor(R/n);let a=e.numElements;for(;t.length>0;){const r=t.pop(),s=i.elementCount(r.geometry.attributes);if(a+s>o&&a>0){t.push(r);break}a+=s;const n=new g.Instance(r,0,0,this.highlightOrderMap);f.assert(null==e.instances.get(r.id)),e.addInstance(r.id,n)}const l=a*n,c=I(l),u=i.layout.createView(c.buffer);let d=0;e.resetInstanceSummary(),e.instances.forEach((t,r)=>{this._writeGeometry(t.geometry,u,d);const s=d;d+=i.elementCount(t.geometry.geometry.attributes),e.updateInstance(r,s,d),e.updateDrawState(t)}),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(F(l)),e.vao.buffer()?.setSubData(c,0,0,d*n),e.holes.clear();const h=e.holes.pushNew();return h.from=d,h.to=Math.floor(e.vao.getByteLength("geometry")/s),e.updateDrawCommands(this.highlightOrderMap,s),e}_applyRemoves(e,t){if(0===t.changes.length||null==this._bufferWriter)return;let r=1/0,i=-1/0;for(const s of t.changes){const t=s.id,n=e.instances.get(t);if(!n)continue;e.deleteInstance(t),this._useMetalWorkaround&&(r=Math.min(r,n.from),i=Math.max(i,n.to));const o=S.back();if(o){if(o.to===n.from){o.to=n.to;continue}if(o.from===n.to){o.from=n.from;continue}}const a=S.pushNew();a.from=n.from,a.to=n.to}m.mergeAdjacentRanges(S);const s=this._bufferWriter.layout.stride/4,n=e.vao.buffer();if(this._useMetalWorkaround){const t=(i-r)*s,o=I(t),a=this._bufferWriter.layout.createView(o.buffer);o.fill(0,0,t),e.instances.forEach(e=>{if(!(e.from>=r&&e.to<=i))return;const t=e.from-r;this._writeGeometry(e.geometry,a,t)}),n?.setSubData(o,r*s,0,t)}else{const e=S.reduce((e,t)=>Math.max(e,t.numElements),0)*s,t=I(e);t.fill(0,0,e),S.forAll(e=>n?.setSubData(t,e.from*s,0,e.numElements*s))}e.holes.pushArray(S.data,S.length),S.forAll((e,t)=>S.data[t]=null),S.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null==this._bufferWriter)return;if(!y.hasVao(e))return void this._applyAndRebuild(e,t,null);const r=this._bufferWriter,s=r.layout.stride/4,n=e.numElements,o=t.reduce((e,t)=>e+r.elementCount(t.geometry.attributes),0),a=Math.min((n+o)*s,R),l=4*a;if(e.vao.getByteLength("geometry")<F(R-T)&&l>e.vao.getByteLength("geometry"))return void this._applyAndRebuild(e,t,null);m.mergeAdjacentRanges(e.holes);const c=new Array;let u=1/0,d=-1/0;for(const i of t){const t=r.elementCount(i.geometry.attributes),s=v(e.holes,t);c.push(s),this._useMetalWorkaround&&null!=s&&(u=Math.min(s,u),d=Math.max(s+t,d))}const h=e.vao.buffer();let p=0,_=0,b=0;const w=this._useMetalWorkaround?I((d-u)*s):I(a),x=r.layout.createView(w.buffer);if(t.forEach((t,i)=>{const n=c[i];if(null==n)return;const o=r.elementCount(t.geometry.attributes);if(!this._useMetalWorkaround){if(b!==n){const e=b-_;e>0&&h?.setSubData(w,_*s,0,e*s),_=n,p=0}this._writeGeometry(t,x,p),p+=o,b=n+o}const a=new g.Instance(t,n,n+o,this.highlightOrderMap);f.assert(null==e.instances.get(t.id)),e.addInstance(t.id,a),e.drawCommandsDirty=!0}),this._useMetalWorkaround){const t=(d-u)*s;w.fill(0,0,t),e.instances.forEach(e=>{if(!(e.from>=u&&e.to<=d))return;const t=e.from-u;this._writeGeometry(e.geometry,x,t)}),_=u,b=d}const S=b-_;S>0&&h?.setSubData(w,_*s,0,S*s),i.filterInPlace(t,(e,t)=>null==c[t])}_writeGeometry(e,t,r){null!=this._bufferWriter&&(d.copy(w,e.transformation),w[12]-=e.localOrigin.vec3[0],w[13]-=e.localOrigin.vec3[1],w[14]-=e.localOrigin.vec3[2],d.invert(x,w),d.transpose(x,x),this._bufferWriter.write(w,x,e.geometry.attributes,e.geometry.olidColor,t,r))}static prune(){O=new Float32Array(T)}},t.__decorate([a.property({constructOnly:!0})],e.MergedBuffer.prototype,"dataByOrigin",void 0),t.__decorate([a.property({constructOnly:!0})],e.MergedBuffer.prototype,"material",void 0),t.__decorate([a.property()],e.MergedBuffer.prototype,"highlightOrderMap",void 0),e.MergedBuffer=t.__decorate([u.subclass("esri.views.3d.webgl-engine.materials.renderers.MergedBuffer")],e.MergedBuffer);class b{constructor(e){this.origin=e,this.changes=new Array}}function v(e,t){const r=e.find(e=>e.numElements>=t);if(null==r)return null;const i=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),i}const w=h.create(),x=h.create(),S=new o({allocator:e=>e||new m.BufferRange,deallocator:null}),T=65536,C=4*T,P=1024,M=16777216,R=M/4;let O=new Float32Array(T);function I(e){return O.length<e&&(O=new Float32Array(e)),O}function F(e){const t=4*e;return t<=P?P:t<C?s.nextHighestPowerOfTwo(t):Math.max(Math.min(Math.ceil(1.5*t/C)*C,M),t)}e.sizeForVao=F,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/renderers/BufferRange":function(){define(["exports"],function(e){"use strict";e.BufferRange=class{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}},e.mergeAdjacentRanges=function(e){if(e.length<2)return;const t=new Map;e.forAll(e=>t.set(e.from,e));let r=!0;for(;r;){r=!1;for(let i=0;i<e.length;++i){const s=e.data[i],n=t.get(s.to);n&&(s.to=n.to,t.delete(n.from),e.removeUnordered(n),r=!0)}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/renderers/Instance":function(){define(["exports","./BufferRange"],function(e,t){"use strict";class r extends t.BufferRange{constructor(e,t,r,i){super(t,r),this.geometry=e,this._highlightName=null,this.updateHighlightOptions(i)}updateHighlightOptions(e){const{geometry:t}=this;if(!t.hasHighlights)return void(this._highlightName=null);let r=-1,i=null;t.foreachHighlightOptions(t=>{const s=e.get(t)??-1;s>r&&(r=s,i=t)}),this._highlightName=i}get highlightName(){return this._highlightName}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}get hasOccludees(){return null!=this.geometry.occludees}}e.Instance=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/renderers/PerBufferData":function(){define(["exports","../../../../../core/MapUtils","../../../../../core/PooledArray","./BufferRange","./DrawCommand","../../../../support/HighlightDefaults"],function(e,t,r,i,s,n){"use strict";class o{constructor(){this._numElements=0,this._instances=new Map,this.holes=new r({allocator:e=>e||new i.BufferRange,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightNames=new Set,this.drawCommandsDefault=a(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=a(),this.drawCommandsShadowHighlightRest=a()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightNames.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightNames.clear()}updateIfDrawCommandsDirty(e,t){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const e of this.instances.values())this.updateDrawState(e);this.updateDrawCommands(e,t)}}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,r){const i=this._instances.get(e);i&&(this._numElements-=i.numElements,i.from=t,i.to=r,this._numElements+=i.numElements)}updateDrawState(e){if(e.isVisible){const{highlightName:t}=e;t&&this.highlightNames.add(t),e.hasOccludees&&(this.hasOccludees=!0)}else this.hasHiddenInstances=!0}updateDrawCommands(e,t){if(this.drawCommandsDefault.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;const{sortedInstances:r}=this;if(this._updateHighlightDrawCommands(e,r),!this.needsMultipleCommands){const e=this.drawCommandsDefault.pushNew(),r=this.holes.front();return this.vao&&1===this.holes.length&&r.to===Math.floor(this.vao.getByteLength("geometry")/t)?(e.first=0,void(e.count=r.from)):(e.first=1/0,e.count=0,this._instances.forEach(t=>{e.first=Math.min(e.first,t.from),e.count=Math.max(e.count,t.to)}),void(e.count-=e.first))}for(const e of r)e.isVisible&&l(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e)}get sortedInstances(){return Array.from(this._instances.values()).sort((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from)}updateHighlights(e){this.highlightNames.clear();const t=this.sortedInstances;for(const r of t)r.updateHighlightOptions(e),r.isVisible&&r.highlightName&&this.highlightNames.add(r.highlightName);this._updateHighlightDrawCommands(e)}_updateHighlightDrawCommands(e,r=this.sortedInstances){const{drawCommandsHighlights:i,drawCommandsShadowHighlightRest:s}=this;i.clear(),s.clear();for(const o of r){if(o.updateHighlightOptions(e),!o.isVisible)continue;const{highlightName:r}=o;r&&(this.highlightNames.add(r),l(t.getOrCreateMapValue(i,r,a),o)),r&&r===n.defaultHighlightName||l(s,o)}}get needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function a(){return new r({allocator:e=>e||new s.DrawCommand,deallocator:e=>e})}function l(e,t){const r=e.back();if(null==r){const r=e.pushNew();return r.first=t.from,void(r.count=t.numElements)}if(s=t,(i=r).first+i.count>=s.from){const e=t.from-r.first+t.numElements;r.count=e}else{const r=e.pushNew();r.first=t.from,r.count=t.numElements}var i,s}e.PerBufferData=o,e.PerVaoData=class extends o{},e.hasVao=function(e){return null!=e.vao},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/renderers/DrawCommand":function(){define(["exports"],function(e){"use strict";e.DrawCommand=class{constructor(){this.first=0,this.count=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/renderers/PerOriginData":function(){define(["exports"],function(e){"use strict";e.PerOriginData=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(t=>t.instances.has(e))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/renderers/VaoRenderer":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/has","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../lib/GLMaterials","../DrawParameters","../../../../support/HighlightDefaults"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";e.VaoRenderer=class extends r{constructor(e){super(e),this._glMaterials=null,this._drawParameters=new u.DrawParameters,this._highlightNames=new Set,this._produces=new Map}initialize(){this._updateProduces()}destroy(){this.uninitializeRenderContext()}get _hasHighlights(){return this._highlightNames.size>0}hasHighlight(e){return this._highlightNames.has(e)}get produces(){return this._produces}_updateProduces(){this.material.produces.forEach((e,t)=>{this._produces.set(t,t=>!(0===this.dataByOrigin.size||!(8!==t&&5!==t||this._hasHighlights))&&e(t))})}initializeRenderContext(e){this._glMaterials=new c.GLMaterials(this.material,e.materials)}uninitializeRenderContext(){this._glMaterials=s.disposeMaybe(this._glMaterials)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:r}=e,i=this.material.produces.get(r.slot);if(!i?.(t))return null;const{highlight:s,slot:n}=r,o=5===t,a=8===t,l=a||o,c=s?.name;if(l&&(0===this._highlightNames.size||a&&c&&!this._highlightNames.has(c)))return null;const u=e=>a&&!!c&&!e.has(c),h=6===t,p=!(l||h);for(const{buffers:i}of this.dataByOrigin.values())for(const s of i){if(u(s.highlightNames))continue;const i=o?s.drawCommandsHighlights.get(d.defaultHighlightName):l?c?s.drawCommandsHighlights.get(c):s.drawCommandsHighlights.size>0:((h&&s.needsMultipleCommands?s.drawCommandsShadowHighlightRest:s.drawCommandsDefault)||null)?.length??!1,a=p&&s.drawCommandsOccludees||null;if(i||a?.length){const i=this._glMaterials.load(e.rctx,n,t),s=i?.beginSlot(r);if(s)return s}}return null}render(e,t){const{output:r,bind:i}=e,{slot:s,highlight:n}=i,o=8===r,a=n?.name??"";if(o&&!n)return;const l=5===r,c=o||l,u=6===r,h=!(c||u),p=10===s||11===s?s:null,{rctx:f}=e;f.runAppleAmdDriverHelper();const m=f.bindTechnique(t,i,this.material.parameters);for(const e of this.dataByOrigin.values())for(const r of e.buffers){if(o&&(!r.hasHighlights||!r.drawCommandsHighlights.has(a)))continue;if(l&&(!r.hasHighlights||!r.drawCommandsHighlights.has(d.defaultHighlightName)))continue;const s=c&&!l?r.drawCommandsHighlights.get(a)??null:null,n=l?r.drawCommandsHighlights.get(d.defaultHighlightName):c?s:u&&r.needsMultipleCommands?r.drawCommandsShadowHighlightRest:r.drawCommandsDefault,g=null!=n,y=h&&r.drawCommandsOccludees||null;if(g||y?.length){if(this._drawParameters.origin=e.origin,m.bindDraw(i,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(r.vao),f.bindVAO(r.vao),g)for(const e of n)f.setPipelineState(t.getPipeline(!1,p)),f.drawArrays(t.primitiveType,e.first,e.count);if(y?.length){f.setPipelineState(t.getPipeline(!0,p));for(const e of y)f.drawArrays(t.primitiveType,e.first,e.count)}}}}updateHighlights(){const{_highlightNames:e}=this;e.clear();for(const t of this.dataByOrigin.values())for(const r of t.buffers)for(const t of r.highlightNames)e.add(t);this._updateProduces()}get test(){}},t.__decorate([n.property({constructOnly:!0})],e.VaoRenderer.prototype,"material",void 0),t.__decorate([n.property({constructOnly:!0})],e.VaoRenderer.prototype,"dataByOrigin",void 0),e.VaoRenderer=t.__decorate([l.subclass("esri.views.3d.webgl-engine.materials.renderers.VaoRenderer")],e.VaoRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/GLMaterials":function(){define(["exports"],function(e){"use strict";e.GLMaterials=class{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach((e,t)=>{null!=e&&this._repository.release(this._material,t)})}load(e,t,r){const i=this._material.produces.get(t);if(!i?.(r))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,t,r));const s=this._map.get(r);if(s){if(2===s.ensureResources(e))return s;this._repository.requestRender()}return null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/DrawParameters":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec3f64","../core/shaderLibrary/attributes/VertexNormal.glsl"],function(e,t,r){"use strict";class i extends r.VertexNormalDrawParameters{constructor(e=t.create()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}}e.DrawParameters=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/parts/renderUtils":function(){define(["exports"],function(e){"use strict";e.RenderSceneResult=class{constructor(e,t){this.screen=e,this.olid=t}},e.removeLoadedShaderModules=function(){const e=globalThis.require?.modules;if(e){const t=Object.keys(e);for(const r of t)r.includes(".glsl")&&delete e[r]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/PlanarPatch":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/SpatialReference","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/spatialReferenceUtils","./PatchGeometryFactory","./Tile","../webgl-engine/lib/RayIntersections"],function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends l.Tile{constructor(e,t,r,i,s){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=n.create(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,r,i,s)}init(e,s,n,a,l){super.init(e,s,n,a,l);const c=l.view.renderSpatialReference,u=l.spatialReference,d=null!=c&&o.isPlateCarree(c)&&null!=u&&u.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=d;const{isWebMercatorOnPlateCarree:h}=l,p=this._extentInRenderSR,f=this.extent;if(h){const e=t.fromValues(f[0],f[1],0);i.projectVectorToVector(e,r.WebMercator,e,r.PlateCarree);const s=t.fromValues(f[2],f[3],0);i.projectVectorToVector(s,r.WebMercator,s,r.PlateCarree),p[0]=e[0],p[1]=e[1],p[2]=s[0],p[3]=s[1]}else for(let e=0;e<4;++e)p[e]=f[e]*d;this.centerAtSeaLevel[0]=.5*(p[0]+p[2]),this.centerAtSeaLevel[1]=.5*(p[1]+p[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(p[2]-p[0],p[3]-p[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),r=.5*(e[3]-e[1]),i=Math.sqrt(t*t+r*r),s=.5*(this.elevationBoundsMax-this.elevationBoundsMin),n=Math.max(i,s);this._center[1][3]=n}_calculateFrustumVisibility(e){const t=this._aabb(),r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5];let l=!0;for(let t=0;t<6;t++){const c=e[t],u=c[0],d=c[1],h=c[2],p=c[3];if(u*(u>0?r:n)+d*(d>0?i:o)+h*(h>0?s:a)+p>=0)return 2;l=l&&u*(u<0?r:n)+d*(d<0?i:o)+h*(h<0?s:a)+p<=0}return l?0:1}_aabb(){const e=this._extentInRenderSR;return s.wrap(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,r,i){return d[0]=1/t[0],d[1]=1/t[1],d[2]=1/t[2],c.intersectAabbInvDirBefore(this._aabb(),e,d,r,i)}createGeometry(){a.createPlanarGlobePatch(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,r=this.renderData;let i=e,s=t;if(r){const e=r.geometry.boundingBox;i=e[2],s=e[5]}else if(!this.leaf){i=1/0,s=-1/0;for(const e of this.children){const t=e;i=Math.min(i,t._subtreeGeometryElevationBoundMin),s=Math.max(s,t._subtreeGeometryElevationBoundMax)}}if(i!==this._subtreeGeometryElevationBoundMin||s!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=i,this._subtreeGeometryElevationBoundMax=s;const e=this.parent;e?._updateSubtreeGeometryElevationsBounds()}}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){a.updateCornersPlanar(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){a.updateEdgesAndCornersPlanar(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){a.updateEdgeElevationsAndResolutionsPlanar(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}}const d=t.create();e.PlanarPatch=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/PatchGeometryFactory":function(){define(["exports","../../../core/mathUtils","../../../core/typedArrayUtil","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","./ElevationData","./PatchGeometryLUT","./PatchRenderData","./terrainUtils","./Tile","./tileUtils","../webgl-engine/lib/Normals"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(e){e.tile.intersectsClippingArea&&(f(e),p(e))}function p(e,i=!1){const{geometry:s,geometryState:o,tile:c,localOrigin:d}=e,{level:h,extent:p,extentInRadians:f,ellipsoid:m}=c,y=m.radius,_=f[0],b=f[2],v=f[1],w=f[3],{samplerData:x}=o,S=p[0],T=p[2],C=p[1],M=p[3],R=g(e),{boundingBox:O,vertexAttributes:I}=s,F=d[0],A=d[1],D=d[2],{position:E,uv0:L}=I,U=E.typedBuffer,B=E.typedBufferStride;for(let d=0;d<4;++d){const f=1===d||3===d,m=o.edgeResolutions[d];l.internalAssert(t.isPowerOfTwo(m));const g=m+1,I=a.neighborTileIfLoadedOrSelf(c,o.edgePeerNeighbors[d]);if(V(c,I,d)){P(e,d,I);continue}const E=null!=I;l.internalAssert(!E||I.level===c.level),l.internalAssert(!E||u.compareTilesByLij(c,I)<=0);const k=I?.renderData,z=k?.geometryState;if(l.enableTerrainInternalChecks){const e=c.surface;if(!I&&e&&!e.updatingRootTiles){const t=l.neighborEdgeIndices[d],r=c.findNeighborTile(t,e=>e.loaded||e.leaf||e.level===c.level);r?r.intersectsClippingArea&&(l.internalAssert(!r.loaded),l.internalAssert(!r.leaf),l.internalAssert(r.level===h)):l.internalAssert(null==e?.rootTiles||!c.shouldHaveNeighbor(t))}}const j=1===d?p[2]:p[0],G=I?.extent,q=G&&f?1===d?G[0]:G[2]:j,H=0===d?p[3]:p[1],W=1===d?1:0,$=0===d?1:0,Q=1===d?b:_,Z=0===d?w:v,Y=Math.sin(Q),X=Math.cos(Q),J=Math.sin(Z),K=Math.cos(Z),ee=z?.samplerData,te=E?(e,t,r)=>.5*(n.sampleElevation(e,t,x)+n.sampleElevation(r,t,ee)):(e,t,r)=>n.sampleElevation(e,t,x),re=s.outerEdgesOffsetAndLength[2*d+0],ie=i&&g>3?g-3:1,se=null!=x&&x.some(e=>null!=e),ne=null!=ee&&ee.some(e=>null!=e),oe=se||ne,ae=1/m,le=re;l.internalAssert(!G||l.almostEquals(G[2]-G[0],p[2]-p[0])),(()=>{const e=1===d?-1:3===d?1:0,t=0===d?-1:2===d?1:0,i=(p[2]-p[0])*ae,o=e*i,a=t*i,l=f?e*((b-_)*ae):0,c=f?0:t*ae,u=$,h=f?Q+l:Q,m=f?Math.sin(h):Y,v=f?Math.cos(h):X,w=f?Q-l:Q,P=f?Math.sin(w):Y,I=f?Math.cos(w):X,V=f?Z:R(u+c),k=f?J:Math.sin(V),z=f?K:Math.cos(V),G=f?Z:R(u-c),re=f?J:Math.sin(G),se=f?K:Math.cos(G);let ne=0,ce=0,ue=0;{const e=0*ae,t=f?j:S*(1-e)+T*e,r=f?q:t,i=f?C*(1-e)+M*e:H,s=f?Q:_*(1-e)+b*e,n=f?Y:Math.sin(s),o=f?X:Math.cos(s),a=f?R(e):Z,l=f?Math.sin(a):J,c=f?Math.cos(a):K,u=y+te(t,i,r);ne=o*c*u,ce=n*c*u,ue=l*u}let de=0,he=0,pe=0;{const e=1*ae,t=f?j:S*(1-e)+T*e,r=f?q:t,i=f?C*(1-e)+M*e:H,s=f?Q:_*(1-e)+b*e,n=f?Y:Math.sin(s),o=f?X:Math.cos(s),a=f?R(e):Z,l=f?Math.sin(a):J,c=f?Math.cos(a):K,u=y+te(t,i,r);de=o*c*u,he=n*c*u,pe=l*u}for(let e=1;e<g-1;e+=ie){let t=0,i=0,l=0;{const r=(e+1)*ae,s=f?j:S*(1-r)+T*r,n=f?q:s,o=f?C*(1-r)+M*r:H,a=f?Q:_*(1-r)+b*r,c=f?Y:Math.sin(a),u=f?X:Math.cos(a),d=f?R(r):Z,h=f?Math.sin(d):J,p=f?Math.cos(d):K,m=y+te(s,o,n);t=u*p*m,i=c*p*m,l=h*m}const c=t,u=i,h=l,p=de,g=he,w=pe;de=c,he=u,pe=h;{const t=le+e,i=t*B,s=p-F,n=g-A,o=w-D;U[i]=s,U[i+1]=n,U[i+2]=o,N(s,n,o,O);const a=e*ae,l=f?W:a,c=f?a:$;L.setValues(t,Math.round(l*r.maxUint16),Math.round(c*r.maxUint16))}const V=ne,G=ce,ie=ue;ne=p,ce=g,ue=w;const fe=p,me=g,ge=w,ye=1/Math.sqrt(fe*fe+me*me+ge*ge),_e=ge*ye;let be=0,ve=0,we=0;if(oe&&_e*_e<.999){let t=0,r=0,i=0;{const e=0===d?-1:1;t=e*(c-V),r=e*(u-G),i=e*(h-ie)}{const s=e*ae,l=f?j:S*(1-s)+T*s,c=f?q:l,u=f?C*(1-s)+M*s:H,h=f?Q:_*(1-s)+b*s,p=f?Y:Math.sin(h),g=f?X:Math.cos(h),w=f?R(s):Z,O=f?Math.sin(w):J,F=f?Math.cos(w):K;let A=fe,D=me,L=ge;if(E){const e=c-o,t=u-a,r=y+n.sampleElevation(e,t,ee),i=f?F:se;A=(f?I:g)*i*r,D=(f?P:p)*i*r,L=(f?O:re)*r}{const e=l+o,s=u+a,c=y+n.sampleElevation(e,s,x),h=f?F:z,_=(f?v:g)*h*c,b=(f?m:p)*h*c,w=(f?O:k)*c;E||(A=2*fe-_,D=2*me-b,L=2*ge-w);const S=3===d?-1:1,T=S*(A-_),C=S*(D-b),P=S*(L-w);be=i*C-r*P,ve=t*P-i*T,we=r*T-t*C;const M=1/Math.sqrt(be*be+ve*ve+we*we);be*=M,ve*=M,we*=M}}}else be=fe*ye,ve=me*ye,we=ge*ye;s.setEdgeNormalFromValues(d,e,be,ve,we)}})()}}function f(e){M(e)}function m(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function g(e){const{tile:t}=e;if(t.surface.isWebMercator){const e=t.extent,r=t.ellipsoid.radius,i=t=>function(e,t,r,i){return m(e*(1-i)+t*i,r)}(e[1],e[3],r,t);return i}const r=t.extentInRadians;return e=>function(e,t,r){return e*(1-r)+t*r}(r[1],r[3],e)}function y(e,t){e.tile.intersectsClippingArea&&(b(e),_(e,!1))}function _(e,r){const{geometry:i,geometryState:s,localOrigin:o}=e,c=e.tile,{surface:d,extent:h}=c,{clippingArea:p,samplerData:f}=s,m=null!=p?p:E,g=h[0],y=h[2],_=h[1],b=h[3],w=[b>m[3],y>m[2],_<m[1],g<m[0]],x=c.horizontalScale,S=v(d.isWebMercatorOnPlateCarree,c.ellipsoid.radius,x),{minu:T,minv:C,maxu:M,maxv:R,boundingBox:O}=i,I=Math.max(g,m[0]),F=Math.min(y,m[2]),A=Math.max(_,m[1]),D=Math.min(b,m[3]),L=o[0],U=o[1],B=o[2];for(let o=0;o<4;++o){const h=1===o||3===o,p=s.edgeResolutions[o];l.internalAssert(t.isPowerOfTwo(p));const m=p+1,v=w[o],E=a.neighborTileIfLoadedOrSelf(c,s.edgePeerNeighbors[o]);if(!v&&V(c,E,o)){P(e,o,E);continue}const k=null!=E&&!v,z=E?.renderData,j=z?.geometryState;if(l.enableTerrainInternalChecks&&(l.internalAssert(!k||E.level===c.level),l.internalAssert(!k||u.compareTilesByLij(c,E)<=0),c&&!E&&!d.updatingRootTiles)){const e=l.neighborEdgeIndices[o],t=c.findNeighborTile(e,e=>e.loaded||e.leaf||e.level===c.level);d.updatingRootTiles||(t?t.intersectsClippingArea&&(l.internalAssert(!t.loaded),l.internalAssert(!t.leaf),l.internalAssert(t.level===c.level)):l.internalAssert(null==d?.rootTiles||!c.shouldHaveNeighbor(e)))}const G=t.clamp(1===o?y:g,I,F),q=t.clamp(0===o?b:_,A,D),H=j?.samplerData,W=r&&m>3?m-3:1,$=t.clamp(1===o?1:0,T,M),Q=t.clamp(0===o?1:0,C,R),Z=k?(e,t)=>.5*(n.sampleElevation(e,t,H)+n.sampleElevation(e,t,f)):(e,t)=>n.sampleElevation(e,t,f),Y=(y-g)/p,X=h?1===o?Y:-Y:0,J=h?0:0===o?Y:-Y,K=-X,ee=-J;let te=0,re=0,ie=0;{const e=0/p,r=h?G:t.clamp(g*(1-e)+y*e,I,F),i=h?t.clamp(_*(1-e)+b*e,A,D):q,s=Z(r,i);te=r*x,re=S(i),ie=s}let se=0,ne=0,oe=0;{const e=1/p,r=h?G:t.clamp(g*(1-e)+y*e,I,F),i=h?t.clamp(_*(1-e)+b*e,A,D):q,s=Z(r,i);se=r*x,ne=S(i),oe=s}for(let e=1;e<m-1;e+=W){const r=e/p,s=se,a=ne,l=oe;{const n=h?$:t.clamp(r,T,M),c=h?t.clamp(r,C,R):Q,u=s-L,d=a-U,p=l-B;N(s,d,p,O),i.setEdgeVertexFromValuesRawPositionUV(o,e,u,d,p,n,c)}{const r=(e+1)/p,i=h?G:t.clamp(g*(1-r)+y*r,I,F),s=h?t.clamp(_*(1-r)+b*r,A,D):q,n=Z(i,s);se=i*x,ne=S(s),oe=n}const c=se,u=oe,d=te,m=re,v=ie;te=s,re=a,ie=l;let w=0,P=0,E=0;if(h){const e=ne-a,i=u-l,c=m-a,d=v-l,h=t.clamp(_*(1-r)+b*r,A,D),p=G+K,g=h,y=p*x-s,S=n.sampleElevation(p,g,f)-l,T=3===o?-1:1;if(w=T*(-c+e)*S,P=T*y*(-d+i),E=-T*y*(-c+e),k){const t=G+X,r=h,o=t*x-s;w=(-c+e)*(S-(n.sampleElevation(t,r,H)-l)),P=(y-o)*(-d+i),E=-(y-o)*(-c+e)}}else{const e=c-s,i=u-l,h=d-s,p=v-l,m=t.clamp(g*(1-r)+y*r,I,F),_=m,b=q+ee,x=n.sampleElevation(_,b,f)-l,T=S(b)-a,C=2===o?-1:1;if(w=C*T*(-p+i),P=C*(-h+e)*x,E=-C*T*(-h+e),k){const t=m,r=q+J,s=S(r)-a;w=(-T+s)*(-p+i),P=(-h+e)*(-x+(n.sampleElevation(t,r,H)-l)),E=-(-T+s)*(-h+e)}}const V=1/Math.sqrt(w*w+P*P+E*E);i.setEdgeNormalFromValues(o,e,w*V,P*V,E*V)}}}function b(e,t){M(e)}function v(e,t,r){return e?e=>function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t):e=>function(e,t){return e*t}(e,r)}function w(e,t,r){const{numVerticesPerSide:i,vertexAttributes:s,maxEdgeVertexCount:n}=e,o=i-1,l=s.count,c=2*(i-3)*(i-3),u=4*(o+n-3),d=a.zeroToFour.reduce((t,r)=>t+(o+e.getEdgeCount(r)-3),0),h=t.reduce((e,t)=>e+o*(2*(t.latitudeResolution-1)+1),0),p=3*(r?2:1),f=(c+u+h)*p,m=l>=65536?new Uint32Array(f):new Uint16Array(f);for(let e=0;e<f;++e)m[e]=0;e.indices=m,e.indexCount=(c+d+h)*p,e.poleIndicesStartIndex=c*p,e.edgeIndicesStartIndex=(c+h)*p,r?(function(e){const{indices:t,numVerticesPerSide:r,vertexAttributes:i}=e,{position:s}=i,{typedBuffer:n,typedBufferStride:o}=s,a=r-2;let l=0;for(let e=0;e<r-3;++e){const i=e*a;for(let s=0;s<r-3;++s){const r=e*a+s,c=r+1,u=c+a,d=u-1,h=i+s,p=h+1,f=p+a;z(h,p,f,f-1,o,n)?(j(t,l,r,c,u),l+=6,j(t,l,u,d,r)):(j(t,l,r,c,d),l+=6,j(t,l,d,u,c)),l+=6}}}(e),function(e,t){const{indices:r,numVerticesPerSide:i,poleIndicesStartIndex:s}=e,n=i-1;let o=s;for(const s of t){const t=s.connectedOuterEdgeOffset;let a=e.getEdgeVertexIndex(t,0),l=1;for(let e=0;e<s.latitudeResolution;++e){const t=0===e?s.rowOffset:a+i;for(let i=0;i<n;i++)j(r,o,a,a+1,t+i),o+=6,e<s.latitudeResolution-1&&(j(r,o,a+1,t+i+1,t+i),o+=6),a+=l;a=t,l=1}}}(e,t),S(e)):(function(e){const{numVerticesPerSide:t,indices:r,vertexAttributes:i}=e,{position:s}=i,{typedBuffer:n,typedBufferStride:o}=s,a=t-2,l=t-3,c=t-3;let u=0;for(let e=0;e<l;++e){const t=e*a;for(let e=0;e<c;++e){const i=t+e,s=i+1,l=s+a,c=l-1;z(i,s,l,c,o,n)?(r[u]=i,r[u+1]=s,r[u+2]=l,r[u+3]=l,r[u+4]=c,r[u+5]=i):(r[u]=i,r[u+1]=s,r[u+2]=c,r[u+3]=c,r[u+4]=s,r[u+5]=l),u+=6}}}(e),function(e,t){const{numVerticesPerSide:r,indices:i,poleIndicesStartIndex:s}=e,n=r-1;let o=s;for(const s of t){const t=s.isNorth?1:2,a=s.isNorth?2:1,l=s.isNorth?3:4,c=s.isNorth?4:3;let u=e.getEdgeVertexIndex(s.connectedOuterEdgeOffset,0),d=1;for(let e=0;e<s.latitudeResolution;++e){const h=0===e?s.rowOffset:u+r;for(let r=0;r<n;r++){const n=h+r;i[o]=u,i[o+t]=u+1,i[o+a]=n,e<s.latitudeResolution-1?(i[o+l]=u+1,i[o+c]=n+1,i[o+5]=n,o+=6):o+=3,u+=d}u=h,d=1}}}(e,t),x(e))}function x(e){const{indices:t,numVerticesPerSide:r,edgeIndicesStartIndex:i}=e,s=r-1,n=s-2;let o=i;for(let r=0;r<4;++r){const i=B[r];let a=0,c=0;const u=e.getEdgeCount(r),d=i.count;l.internalAssert(d===s-1);const h=1===r||2===r,p=h?1:2,f=h?2:1,m=e.getEdgeFirstVertexIndex(r),g=1,y=i.vertex0Index,_=i.stride;for(;a<u-1||c<d-1;){const e=y+c*_,r=m+a*g,i=a<u-1,l=c<d-1,h=i&&(!l||(i?0+s*(a+.5)/(u-1):0)<=(l?1+n*(c+.5)/(d-1):0));h?++a:++c;const b=h?r+g:e+_;t[o]=e,t[o+p]=r,t[o+f]=b,o+=3}}e.indexCount=o}function S(e){const{indices:t,numVerticesPerSide:r,edgeIndicesStartIndex:i}=e,s=r-1,n=s-2;let o=i;for(let r=0;r<4;++r){const i=B[r];let a=0,c=0;const u=e.getEdgeCount(r),d=i.count;l.internalAssert(d===s-1);const h=1===r||2===r,p=h?1:3,f=h?3:1,m=e.getEdgeFirstVertexIndex(r),g=1,y=i.vertex0Index,_=i.stride;for(;a<u-1||c<d-1;){const e=y+c*_,r=m+a*g,i=a<u-1,l=c<d-1,h=i&&(!l||(i?0+s*(a+.5)/(u-1):0)<=(l?1+n*(c+.5)/(d-1):0));h?++a:++c;const b=h?r+g:e+_;t[o]=e,t[o+p]=r,t[o+p+1]=r,t[o+f]=b,t[o+f+1]=b,t[o+5]=e,o+=6}}e.indexCount=o}function T(e){const{geometry:t,geometryState:r}=e,{edgeResolutions:i}=r,{numVerticesPerSide:s,edgeVerticesStartIndex:n}=t,o=s-2;let a=n;for(let e=0;e<4;++e){{const t=0===e||2===e,r=(0===e?o-1:0)*o+(1===e?o-1:0),i=(t?0:1)*o+(t?1:0),s=B[e];s.vertex0Index=r,s.stride=i,s.count=o}{const r=i[e]+1;t.outerEdgesOffsetAndLength[2*e+0]=a,t.outerEdgesOffsetAndLength[2*e+1]=r,a+=r}}}function C(e){T(e),e.geometryState.wireframe?S(e.geometry):x(e.geometry)}function P(e,i,s){const{geometryState:n,geometry:o,tile:a,localOrigin:c}=e,u=1===i||3===i,d=n.edgeResolutions[i];l.internalAssert(t.isPowerOfTwo(d));const h=d+1,{boundingBox:p,minu:f,minv:m,maxu:g,maxv:y,vertexAttributes:_}=o,b=t.clamp(1===i?1:0,f,g),v=t.clamp(0===i?1:0,m,y),w=s.renderData,x=w.geometryState,S=w.geometry,T=(i+2)%4,C=S.getEdgeCount(T),P=a.getNeighborEdgeStartVertexIndex(i,s)*d,M=d*2**(a.level-s.level);l.internalAssert(x.edgeResolutions[T]===M),l.internalAssert(C-1===M);const R=w.localOrigin[0]-c[0],O=w.localOrigin[1]-c[1],I=w.localOrigin[2]-c[2],F=o.getEdgeFirstVertexIndex(i),{position:A,uv0:D}=_,E=A.typedBuffer,L=A.typedBufferStride,V=_.normalCompressed,U=V.typedBuffer,B=V.typedBufferStride,k=S.vertexAttributes,z=S.getEdgeFirstVertexIndex(T),j=k.position.typedBuffer,G=k.position.typedBufferStride,q=k.normalCompressed.typedBuffer,H=k.normalCompressed.typedBufferStride;for(let e=1;e<h-1;++e){const i=F+e,s=z+(P+e),n=i*L,o=s*G,a=j[o]+R,l=j[o+1]+O,c=j[o+2]+I;E[n]=a,E[n+1]=l,E[n+2]=c,N(a,l,c,p);const h=i*B,_=s*H;U[h]=q[_],U[h+1]=q[_+1];const w=e/d,x=u?b:t.clamp(w,f,g),S=u?t.clamp(w,m,y):v;D.setValues(i,Math.round(x*r.maxUint16),Math.round(S*r.maxUint16))}}function M(e){const{geometry:i,geometryState:s,localOrigin:o}=e,{clippingArea:a,samplerData:c}=s,{minu:d,minv:h,maxu:p,maxv:f,boundingBox:m,vertexAttributes:y}=i,_=e.tile,{surface:b,ellipsoid:w,extent:x,extentInRadians:S,horizontalScale:T}=_,C="local"===b.view?.viewingMode,P=w.radius;let M=0,O=0,I=0;const F=C?(()=>{const e=a,r=null!=e&&(x[3]>e[3]||x[2]>e[2]||x[1]<e[1]||x[0]<e[0]),i=v(b.isWebMercatorOnPlateCarree,P,T);return(s,n,o)=>{const a=0===s?x[0]:x[2],l=0===n?x[1]:x[3],c=r?t.clamp(a,e[0],e[2]):a,u=r?t.clamp(l,e[1],e[3]):l,d=o;M=c*T,O=i(u),I=d}})():(e,t,r)=>{const i=S[0===t?1:3],s=S[0===e?0:2],n=Math.cos(i),o=Math.sin(i),a=Math.sin(s),l=Math.cos(s),c=P+r;M=l*n*c,O=a*n*c,I=o*c};let D=0,V=0,U=0,B=0,k=0,z=0,j=0,G=0,q=0;const H=C&&b.isWebMercatorOnPlateCarree,W=(e,t,r,i,s)=>{let n=0,o=0,a=0;if(C){const e=t*T,s=H?(Math.PI/2-2*Math.atan(Math.exp(-r/P)))*P:r*T;n=e-M,o=s-O,a=i-I}else{const s=g(e),l=e.tile,c=l.extent,u=l.extentInRadians,d=(t-c[0])/(c[2]-c[0]),h=(r-c[1])/(c[3]-c[1]),p=u[0]*(1-d)+u[2]*d,f=s(h),m=Math.cos(f),y=Math.sin(f),_=Math.sin(p),b=Math.cos(p),v=P+i;n=b*m*v-M,o=_*m*v-O,a=y*v-I}switch(s){case 0:j+=n,G+=o,q+=a;break;case 1:B-=n,k-=o,z-=a;break;case 2:j-=n,G-=o,q-=a;break;case 3:B+=n,k+=o,z+=a}},$=a??E,Q=x[0],Z=x[2],Y=x[1],X=x[3],J=[X>$[3],Z>$[2],Y<$[1],Q<$[0]],K=Math.max(Q,$[0]),ee=Math.min(Z,$[2]),te=Math.max(Y,$[1]),re=Math.min(X,$[3]),ie=e=>Math.max($[0],Math.min($[2],e)),se=e=>Math.max($[1],Math.min($[3],e)),ne=e=>{const t=s.cornerNeighborCornerTiles;D=0,V=0,U=1,B=0,k=0,z=0,j=0,G=0,q=0;let r=1/0;for(let i=0;i<4;++i){const s=t[4*e+i];r=Math.min(r,s?.level??1/0)}for(let i=0;i<4;++i){const s=t[4*e+i];L[i]=s?.level===r?s:null}let i=1,o=0;for(let e=0;e<4;++e){const t=L[e];t&&(i=Math.max(i,t?.renderData.geometryState.numVerticesPerSide),o=t.extent[2]-t.extent[0])}const a=o,c=i;l.internalAssert(c>1);const u=a/c;for(let e=0;e<4;++e){const t=L[(e+3)%4],r=L[e%4];if(!t&&!r)continue;const i=0===e?1:1===e?2:2===e?3:0,s=0===e?2:1===e?3:2===e?0:1;if(t&&r){const o=A[e][0]*u,a=A[e][1]*u,l=t.extent,c=ie(l[0===i||1===i?2:0]+o),d=se(l[0===i||3===i?3:1]+a),h=r.extent,p=ie(h[0===s||1===s?2:0]+o),f=se(h[0===s||3===s?3:1]+a),m=t.renderData,g=r.renderData,y=n.sampleElevation(c,d,m.geometryState.samplerData),_=n.sampleElevation(p,f,g.geometryState.samplerData);W(m,c,d,.5*(y+_),e)}else{const o=t??r,a=t?i:s,l=o.extent,c=A[e],d=ie(l[0===a||1===a?2:0]+c[0]*u),h=se(l[0===a||3===a?3:1]+c[1]*u),p=o.renderData,f=n.sampleElevation(d,h,p.geometryState.samplerData);W(p,d,h,f,e)}}if(!C){const e=Math.sqrt(M*M+O*O+I*I);D=M/e,V=O/e,U=I/e}if(C||U*U<.999){const e=Math.sqrt(B*B+k*k+z*z);B/=e,k/=e,z/=e;const t=Math.sqrt(j*j+G*G+q*q);j/=t,G/=t,q/=t,D=z*G-k*q,V=B*q-z*j,U=k*j-B*G;const r=1/Math.sqrt(D*D+V*V+U*U);D*=r,V*=r,U*=r}},oe=s.cornerNeighborCornerTiles;for(let e=0;e<4;++e){const a=e,g=(e+1)%4,b=0===e||1===e?1:0,v=0===e||3===e?1:0,w=t.clamp(b,d,p),x=t.clamp(v,h,f),S=i.getEdgeFirstVertexIndex(a),T=i.getEdgeCount(a),C=0===e||3===e?T-1:0,P=i.getEdgeFirstVertexIndex(g),A=i.getEdgeCount(g),E=0===e||1===e?A-1:0;let L=-1;for(let t=0;t<4;++t){const r=oe[4*e+t],i=oe[4*e+L];r&&(-1===L||u.compareTilesByLij(i,r)>0)&&(L=t)}const B=L,k=oe[4*e+B];if(k!==_){const t=_.level-k.level,i=2**t,n=[k.lij[0]+t,k.lij[1]*i,k.lij[2]*i],a=[n[1]+i===_.lij[1],0===e&&(1===B||0===B&&k!==oe[4*e+3])||1===e&&(0===B||1===B&&k!==oe[4*e+2]),n[1]===_.lij[1]+1,2===e&&(3===B||2===B&&k!==oe[4*e+1])||3===e&&(2===B||3===B&&k!==oe[4*e+0])],c=a.reduce((e,t)=>e+(t?1:0),0);l.internalAssert(1===c||2===c);let u=-1,d=-1;const h=k.renderData;if(1===c){const t=a.findIndex(e=>e);l.internalAssert(0<=t&&t<=3),u=(t+2)%4;const r=s.edgeResolutions[t];d=_.getNeighborEdgeStartVertexIndex(t,k)*r+r*(0===t&&0===e||1===t&&0===e||2===t&&1===e||3===t&&3===e?1:0)}else{l.internalAssert(a[1]||a[3]),u=a[1]?3:1;const t=h.geometryState.edgeResolutions[u];d=0===e||3===e?0:t}const p=h.geometry;{const e=S+C,t=P+E,i=p.getEdgeFirstVertexIndex(u)+d,s=p.vertexAttributes,n=h.localOrigin,a=s.position,l=a.typedBuffer,c=i*a.typedBufferStride,f=l[c]+n[0]-o[0],g=l[c+1]+n[1]-o[1],_=l[c+2]+n[2]-o[2];N(f,g,_,m);const b=y.position,v=b.typedBuffer,T=e*b.typedBufferStride;v[T]=f,v[T+1]=g,v[T+2]=_;const M=t*b.typedBufferStride;v[M]=f,v[M+1]=g,v[M+2]=_;const R=y.uv0;R.setValues(e,Math.round(w*r.maxUint16),Math.round(x*r.maxUint16)),R.setValues(t,Math.round(w*r.maxUint16),Math.round(x*r.maxUint16));{const r=s.normalCompressed.typedBuffer,n=i*s.normalCompressed.typedBufferStride,o=y.normalCompressed,a=o.typedBuffer;{const t=e*o.typedBufferStride;a[t]=r[n],a[t+1]=r[n+1]}{const e=t*o.typedBufferStride;a[e]=r[n],a[e+1]=r[n+1]}}}}else{let r;if(J[a]||J[g]){const e=t.clamp(Q*(1-b)+Z*b,K,ee),i=t.clamp(Y*(1-v)+X*v,te,re);r=n.sampleElevation(e,i,c)}else r=R(oe,e);F(b,v,r),ne(e);const s=M-o[0],l=O-o[1],u=I-o[2];N(s,l,u,m),i.setEdgeVertexFromValuesRawPositionUVNormal(a,C,s,l,u,w,x,D,V,U),i.setEdgeVertexFromValuesRawPositionUVNormal(g,E,s,l,u,w,x,D,V,U)}}for(let e=0;e<4;++e)L[e]=null}function R(e,t){const r=4*t,i=a.zeroToFour.reduce((t,i)=>Math.min(t,e[r+i]?.level??1/0),1/0);l.enableTerrainInternalChecks&&(l.internalAssert(!e[r+0]||!e[r+2]||c.isCornerNeighbor(e[r+0],e[r+2],5)),l.internalAssert(!e[r+1]||!e[r+3]||c.isCornerNeighbor(e[r+1],e[r+3],7)));let s=0,o=0;for(let t=0;t<4;++t){const a=e[r+t];if(a&&a.level===i){const e=0===t||1===t,r=0===t||3===t,i=a.extent,l=i[e?0:2],c=i[r?1:3],u=a.renderData?.geometryState?.samplerData;o+=n.sampleElevation(l,c,u),s++}}const u=s?o/s:0;return l.internalAssert(null!=u),u}function O(e){const{vao:t,geometry:r}=e,{vertexAttributes:i,edgeVerticesStartIndex:s}=r,n=i.position.typedBuffer;t.buffer()?.setSubData(n,s,s,n.length)}function I(e){const{vao:t,geometry:r}=e,{indices:i,indexCount:s,edgeIndicesStartIndex:n}=r;t.indexBuffer.setSubData(i,n,n,s)}class F{constructor(e,t,r,i,s){this.isNorth=e,this.connectedRowOffset=t,this.connectedOuterEdgeOffset=r,this.rowOffset=i,this.latitudeResolution=s}}const A=[[0,1],[1,0],[0,-1],[-1,0]],D=new o.PatchGeometryLUT,E=s.fromValues(-1/0,-1/0,1/0,1/0),L=[null,null,null,null];function V(e,t,r){if(!t)return!1;const i=u.compareTilesByLij(e,t);return i>0||0===i&&r>=2}class U{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return l.internalAssert(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}const B=[new U,new U,new U,new U];function N(e,t,r,i){e<i[0]?i[0]=e:e>i[3]&&(i[3]=e),t<i[1]?i[1]=t:t>i[4]&&(i[4]=t),r<i[2]?i[2]=r:r>i[5]&&(i[5]=r)}function k(e){const{edgeResolutions:t,numVerticesPerSide:r}=e,i=1+Math.max(...t);return Math.max(r,i)}function z(e,t,r,i,s,n){const o=e*s,a=n[o],l=n[o+1],c=n[o+2],u=t*s,d=n[u],h=n[u+1],p=n[u+2],f=r*s,m=n[f],g=n[f+1],y=n[f+2],_=i*s,b=n[_],v=n[_+1],w=n[_+2];return(d-b)*(d-b)+(h-v)*(h-v)+(p-w)*(p-w)>(a-m)*(a-m)+(l-g)*(l-g)+(c-y)*(c-y)}function j(e,t,r,i,s){e[t]=r,e[t+1]=i,e[t+2]=i,e[t+3]=s,e[t+4]=s,e[t+5]=r}e.createPlanarGlobePatch=function(e,s){const{tile:o,geometryState:a,geometry:l}=e,{extent:c,surface:u}=o,{wireframe:h}=a,p=c[0],f=c[1],m=c[2]-p,g=c[3]-f,{numVerticesPerSide:_,clippingArea:b}=a,v=null!=b?Math.max(0,(b[0]-p)/m):0,x=null!=b?Math.max(0,(b[1]-f)/g):0,S=null!=b?Math.min(1,(b[2]-p)/m):1,C=null!=b?Math.min(1,(b[3]-f)/g):1,P=(_-2)**2,M=k(a),R=P+4*M,O=u.renderer.tileGeometryCache.acquire(R),{boundingBox:I}=l;i.empty(I),l.numVerticesPerSide=_,l.vertexAttributes=O,l.maxEdgeVertexCount=M,l.minu=v,l.minv=x,l.maxu=S,l.maxv=C,function(e){const i=e.tile;if(!i.intersectsClippingArea)return;const{geometry:s,geometryState:o,localOrigin:a}=e,{samplerData:l,clippingArea:c,numVerticesPerSide:u}=o,{surface:h,extent:p,ellipsoid:f}=i,{isWebMercatorOnPlateCarree:m}=h,g=null!=c?c:E,y=p[0],_=p[1],b=p[2],v=p[3],w=Math.max(y,g[0]),x=Math.min(b,g[2]),S=Math.max(_,g[1]),T=Math.min(v,g[3]),C=f.radius,P=i.horizontalScale,M=u-1,R=u-2,{minu:O,minv:I,maxu:F,maxv:A,boundingBox:D,vertexAttributes:L}=s,{position:V,uv0:U}=L,{typedBuffer:B,typedBufferStride:k}=L.normalCompressed,z=a[0],j=a[1],G=a[2],q=V.typedBuffer,H=V.typedBufferStride;let W=0;const $=t.clamp(_,S,T),Q=m?(Math.PI/2-2*Math.atan(Math.exp(-$/C)))*C:$*P,Z=1/M,Y=t.clamp(_*(1-Z)+v*Z,S,T);let X=Q,J=m?(Math.PI/2-2*Math.atan(Math.exp(-Y/C)))*C:Y*P;for(let e=1;e<=R;e++){const i=e/M,s=t.clamp(_*(1-i)+v*i,S,T),o=t.clamp(i,I,A),a=J,c=(e-1)/M,u=t.clamp(_*(1-c)+v*c,S,T),h=X,p=(e+1)/M,f=t.clamp(_*(1-p)+v*p,S,T),g=m?(Math.PI/2-2*Math.atan(Math.exp(-f/C)))*C:f*P,E=t.clamp(p,I,A);X=J,J=g;const L=t.clamp(y,w,x);let V=L*P,$=n.sampleElevation(L,s,l);const Q=1/M,Z=t.clamp(Q,O,F),Y=t.clamp(y*(1-Z)+b*Z,w,x);let K=Z,ee=Y,te=Y*P,re=n.sampleElevation(Y,s,l);if(1===e){const e=te-z,i=X-j,s=re-G,n=0*H;q[n]=e,q[n+1]=i,q[n+2]=s,N(e,i,s,D);const a=t.clamp(Q,O,F);U.setValues(W,Math.round(a*r.maxUint16),Math.round(o*r.maxUint16))}for(let i=1;i<=R;i++){const c=te,p=re,m=(i+1)/M,_=t.clamp(m,O,F),v=t.clamp(y*(1-m)+b*m,w,x),S=ee;ee=v;{const t=W+1,c=t*H;if(1===e||i===R){const u=v*P,d=n.sampleElevation(v,s,l);if(1===e&&i<R){const e=u-z,i=a-j,s=d-G;q[c]=e,q[c+1]=i,q[c+2]=s,N(e,i,s,D),U.setValues(t,Math.round(_*r.maxUint16),Math.round(o*r.maxUint16))}te=u,re=d}else te=q[c]+z,re=q[c+2]+G}const T=te,C=re,I=V,A=$;V=c,$=p;const L=(W-R)*H,Q=1===e?n.sampleElevation(S,u,l):q[L+2]+G,Z=n.sampleElevation(S,f,l);if(e<R){const e=W+R,t=e*H,i=c-z,s=g-j,n=Z-G;q[t]=i,q[t+1]=s,q[t+2]=n,N(i,s,n,D);const o=K;K=_,U.setValues(e,Math.round(o*r.maxUint16),Math.round(E*r.maxUint16))}{const e=T-I,t=h-g,r=t*(C-A),i=e*(Q-Z),s=-t*e,n=r*r+i*i+s*s;if(0===n)d.compressNormal(B,W,0,0,1,k);else{const e=1/Math.sqrt(n);d.compressNormal(B,W,r*e,i*e,s*e,k)}}++W}}}(e),l.edgeVerticesStartIndex=P,T(e),y(e),w(l,[],h),e.intersectionData=null},e.createSphericalGlobePatch=function(e,t){const{tile:s,geometry:o,geometryState:a}=e,{extentInRadians:l,surface:c}=s,{isWebMercator:u,renderer:p}=c,{numVerticesPerSide:f,wireframe:y}=a,_=f-1,b=(f-2)**2,v=u&&(2===t||3===t),x=u&&(1===t||3===t),S=6*((v?1:0)+(x?1:0))*f,C=k(a),P=b+S+4*C,M=p.tileGeometryCache.acquire(P);o.numVerticesPerSide=f,o.vertexAttributes=M,o.maxEdgeVertexCount=C;const{boundingBox:R}=o;i.empty(R);const O=g(e);D.update(_,l,O),function(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:s,localOrigin:o}=e,{numVerticesPerSide:a,samplerData:l}=s,c=a-2,u=a-1,{vertexAttributes:h,boundingBox:p}=i,{position:f,uv0:m}=h,{typedBuffer:g,typedBufferStride:y}=h.normalCompressed,{extent:_}=t,b=_[0],v=_[2],w=_[1],x=_[3],S=t.ellipsoid.radius,T=o[0],C=o[1],P=o[2],M=f.typedBuffer,R=f.typedBufferStride,O=1/u;let I=0;if(1<=c){const e=O,t=w*(1-e)+x*e,i=D.sinLatLUT[1],s=D.cosLatLUT[1];for(let o=1;o<=c;o++){const a=o*O,c=b*(1-a)+v*a,u=D.sinLonLUT[o],d=D.cosLonLUT[o],h=S+n.sampleElevation(c,t,l),f=h*d*s-T,g=h*u*s-C,y=h*i-P;N(f,g,y,p);const _=(o-1)*R;M[_]=f,M[_+1]=g,M[_+2]=y,m.setValues(o-1,Math.round(a*r.maxUint16),Math.round(e*r.maxUint16))}}for(let e=1;e<=c;e++){const t=e*O,i=w*(1-t)+x*t,s=D.sinLatLUT[e],o=D.cosLatLUT[e],a=e+1,h=a*O,f=w*(1-h)+x*h,_=D.sinLatLUT[a],F=D.cosLatLUT[a],A=D.sinLonLUT[0],E=D.cosLonLUT[0],L=S+n.sampleElevation(b,i,l);let V=E*o*L-T,U=A*o*L-C,B=s*L-P;const k=I*R;let z=M[k],j=M[k+1],G=M[k+2];for(let t=1;t<=c;t++){const a=t*O,x=b*(1-a)+v*a,A=D.sinLonLUT[t],E=D.cosLonLUT[t];let L=0,k=0,q=0;if(t<c){const e=(I+1)*R;L=M[e],k=M[e+1],q=M[e+2]}else{const e=D.sinLonLUT[u],t=D.cosLonLUT[u],r=S+n.sampleElevation(v,i,l);L=t*o*r-T,k=e*o*r-C,q=s*r-P}const H=V,W=U,$=B;V=z,U=j,B=G,z=L,j=k,G=q;const Q=L-H,Z=k-W,Y=q-$;let X=0,J=0,K=0;if(e>1){const e=(I-c)*R;X=M[e],J=M[e+1],K=M[e+2]}else{const e=D.sinLatLUT[0],t=D.cosLatLUT[0],r=S+n.sampleElevation(x,w,l);X=E*t*r-T,J=A*t*r-C,K=e*r-P}const ee=S+n.sampleElevation(x,f,l),te=E*F*ee-T,re=A*F*ee-C,ie=_*ee-P;if(e<c){const e=I+c,t=e*R;M[t]=te,M[t+1]=re,M[t+2]=ie,N(te,re,ie,p),m.setValues(e,Math.round(a*r.maxUint16),Math.round(h*r.maxUint16))}const se=X-te,ne=J-re,oe=K-ie;let ae=E*o,le=A*o,ce=s;ce*ce<.999&&(ae=Y*ne-Z*oe,le=Q*oe-Y*se,ce=Z*se-Q*ne);const ue=1/Math.sqrt(ae*ae+le*le+ce*ce);d.compressNormal(g,I,ae*ue,le*ue,ce*ue,y),++I}}}(e),o.poleVerticesStartIndex=b;const I=function(e,t,i){const{tile:s,localOrigin:n,geometry:o}=e,{extent:a,ellipsoid:l}=s,{boundingBox:c,numVerticesPerSide:u,vertexAttributes:h,poleVerticesStartIndex:p}=o,f=u-1,g=n[0],y=n[1],_=n[2],b=l.radius,v=a[1],w=a[3],x=[];let S=p;const T=(e,t)=>{const i=t*u;N(-g,-y,e*b-_,c),x.push(new F(1===e,i,1===e?0:2,S,6));const s=m(-1===e?v:w,b),n=e*Math.PI/2-s,o=.99*(1===e?1:-1),a=b+0,{position:l,uv0:p}=h,{typedBuffer:T,typedBufferStride:C}=h.normalCompressed;for(let e=1;e<=6;++e){const t=s+n*(e/6),i=Math.cos(t),u=Math.sin(t);for(let e=0;e<=f;e++){const t=e/f,s=D.sinLonLUT[e],n=D.cosLonLUT[e]*i,h=s*i,m=u,b=n*a-g,v=h*a-y,w=m*a-_;N(b,v,w,c),l.setValues(S,b,v,w),p.setValues(S,Math.round(t*r.maxUint16),Math.round(o*r.maxUint16)),d.compressNormal(T,S,n,h,m,C),++S}}};return t&&T(-1,0),i&&T(1,f),x}(e,v,x);o.edgeVerticesStartIndex=b+S,T(e),h(e),w(o,I,y),e.intersectionData=null},e.updateCornerSpherical=function(e){e.tile.intersectsClippingArea&&(f(e),p(e,!0),O(e),e.intersectionData=null)},e.updateCornersPlanar=function(e,t){e.tile.intersectsClippingArea&&(b(e),_(e,!0),O(e),e.intersectionData=null)},e.updateEdgeElevationsAndResolutionsPlanar=function(e,t){e.tile.intersectsClippingArea&&(C(e),y(e),O(e),I(e),e.intersectionData=null)},e.updateEdgeElevationsAndResolutionsSpherical=function(e){e.tile.intersectsClippingArea&&(C(e),h(e),O(e),I(e),e.intersectionData=null)},e.updateEdgesAndCornersPlanar=function(e,t){e.tile.intersectsClippingArea&&(y(e),O(e),e.intersectionData=null)},e.updateEdgesAndCornersSpherical=function(e){e.tile.intersectsClippingArea&&(h(e),O(e),e.intersectionData=null)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/PatchGeometryLUT":function(){define(["exports","./TerrainConst"],function(e,t){"use strict";e.PatchGeometryLUT=class{constructor(){this.sinLonLUT=new Array(t.maxPatchTesselation+1),this.cosLonLUT=new Array(t.maxPatchTesselation+1),this.sinLatLUT=new Array(t.maxPatchTesselation+1),this.cosLatLUT=new Array(t.maxPatchTesselation+1)}update(e,t,r){const i=t[0],s=t[2];for(let t=0;t<=e;t++){const n=t/e,o=i*(1-n)+s*n;this.sinLonLUT[t]=Math.sin(o),this.cosLonLUT[t]=Math.cos(o);const a=r(n);this.sinLatLUT[t]=Math.sin(a),this.cosLatLUT[t]=Math.cos(a)}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/PatchRenderData":function(){define(["exports","../../../core/arrayUtils","../../../core/has","../../../core/mathUtils","../../../core/maybe","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/aaBoundingRect","../../../geometry/support/Ellipsoid","../support/buffer/glUtil","./GeometryState","./PatchGeometry","./TerrainConst","./terrainUtils","./TextureFader","./TextureReference","./TileOverlayData","./tileUtils","../webgl-engine/lib/VertexArrayObject","../../webgl/BufferObject","../../webgl/VertexBuffer"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v){"use strict";const w=o.create(),x=o.create(),S=o.create(),T=o.create(),C=o.create(),P=o.create(),M=[null,null,null,null];function R(e,t){return t?.loaded||t===e?t:null}const O=[0,1,2,3];e.PatchRenderData=class{constructor(){this.geometry=new d.PatchGeometry,this.geometryState=null,this._texture=null,this._textureOpacity=1,this._textureRef=new f.TextureFader(()=>this._tile.surface.fadeDuration),this.overlay=new g,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new u.GeometryState,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),p.enableTerrainInternalChecks&&this.tile.intersectsClippingArea)for(let e=0;e<4;++e)p.internalAssert(this.geometry.getEdgeCount(e)===this.geometryState.edgeResolutions[e]+1)}_calculateEdgeResolution(e,t){const r=this.tile,i=this.geometryState.numVerticesPerSide-1;if(!r.surface.isGlobal){const t=r.surface.extent;if(null!=t&&(0===e&&r.extent[3]>t[3]||1===e&&r.extent[2]>t[2]||2===e&&r.extent[1]<t[1]||3===e&&r.extent[0]<t[0]))return i}const s=r.level,n=p.neighborEdgeIndices[e];if(!t)return p.internalAssert(null==r.surface?.rootTiles||r.surface.updatingRootTiles||!r.shouldHaveNeighbor(n)),i;if(t.loaded){const r=t,n=r.renderData.geometryState,o=s-r.level;if(p.internalAssert(o>=0),0===o){const e=n.numVerticesPerSide-1;return Math.max(e,i)}const a=2**o,l=n.edgeResolutions[(e+2)%4]/a;return Math.max(1,l)}p.internalAssert(!t.leaf);let o=i;return t.forAllSubtreeOnSide(p.oppositeEdge(n),e=>e===r||(e.loaded?(o=Math.max(o,2**(e.level-s)),!0):(p.internalAssert(!e.leaf),!1))),o}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,r=t=>(t.loaded||t.level===e.level)&&t?.intersectsClippingArea,s=t.edgePeerNeighbors,n=t.edgePeerNeighborSamplerVersions;for(let o=0;o<4;++o){const a=e.findNeighborTile(p.neighborEdgeIndices[o],r),l=R(e,a),c=l?.renderData?.geometryState.samplerDataVersion??-1,u=s[o],d=l!==R(e,u),f=n[o]!==c;p.enableTerrainInternalChecks&&a&&(p.internalAssert(e.level>=a.level),p.internalAssert(e.level-a.level<=h.maxTileNeighborLevelDelta)),s[o]=a,(d||f)&&(n[o]=c,this._markEdgeDirty(o));const m=t.edgeResolutions[o],g=this._calculateEdgeResolution(o,a);p.internalAssert(i.isPowerOfTwo(g)),p.internalAssert(g>=1),t.edgeResolutions[o]=g,m!==g&&this._markEdgeResolutionDirty(o)}for(let i=0;i<4;++i){const n=e.findNeighborTile(p.neighborCornerIndices[i],r);t.cornerPeerNeighbors[i]=n;const o=R(e,s[i]),a=R(e,s[(i+1)%4]),l=R(e,n);M[i]=l,M[(i+1)%4]=a,M[(i+2)%4]=e,M[(i+3)%4]=o,p.internalAssert(M.some(t=>t?.loaded||t===e));const c=M.reduce((e,t)=>Math.min(e,t?.level??1/0),1/0);M.forEach((e,t)=>{e&&e?.level>c&&(M[t]=null)}),p.internalAssert(M.some(t=>t?.loaded||t===e));const u=t.cornerNeighborCornerTiles,d=t.cornerNeighborCornerTileSamplerVersions;for(let e=0;e<4;++e){const t=M[e],r=t?.renderData.geometryState.samplerDataVersion??-1,s=4*i+e,n=u[s]!==t,o=!n&&d[s]!==r;(n||o)&&(u[s]=t,d[s]=r,this._markCornerDirty(i))}p.enableTerrainInternalChecks&&p.internalAssert(O.some(t=>u[4*i+t]?.loaded||u[4*i+t]===e))}p.enableTerrainInternalChecks&&p.internalAssert(this.geometryState.edgeResolutions.every(e=>e>0));for(let e=0;e<4;++e)M[e]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;p.enableTerrainInternalChecks&&p.internalAssert(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every(e=>e>0)),this.intersectionData=null;const{tile:t,_vao:r,geometry:i,geometryState:s}=this,n=!r||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,o=0!==this.dirtyEdgeResolutions,a=s.edgeResolutions.reduce((e,t)=>e+t+1,0),l=n||o&&a>(i?.maxEdgeVertexCount??0),c=!l&&o,u=!c&&(0!==this.dirtyEdges||o),d=!u&&0!==this.dirtyCorners;l?(this.releaseGeometry(),this._createGeometry(e)):c?t.updateEdgeElevationsAndResolutions():u||d?t.updateEdgeElevations():d?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=s.disposeMaybe(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,r,i){const s=t?6408:6407;return null!=this._texture&&(0===r&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==e||this._texture.descriptor.pixelFormat!==s)&&this.releaseTexture(),null==this._texture&&(this._texture=i(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture&&(this._texture=s.releaseMaybe(this._texture),this.tile.setMemoryDirty())}reuseTexture(e,t){return!(!e||!this._texture||(e.setTextureReference(new m.TextureReference(this._texture,0,t,this._textureOpacity,0,1)),0))}get numVerticesPerSideChanged(){return!!(1&this._modifiedFlags)}get samplerDataChanged(){return!!(2&this._modifiedFlags)}get clippingAreaChanged(){return!!(4&this._modifiedFlags)}get wireframeChanged(){return!!(8&this._modifiedFlags)}get dirtyEdges(){return this._modifiedFlags>>4&15}get dirtyCorners(){return this._modifiedFlags>>8&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>12&15}_markCornerDirty(e){const t=1<<e<<8;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<4;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<12;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=65520}updateGeometryState(){const e=this._elevationInfo,r=this.tile,i=e.samplerData?r.getElevationVerticesPerSide(e.maxTileLevel):r.minimumVerticesPerSide,s=Math.max(i,5);let n=r.clippingArea;r.intersectsClippingArea&&!r.withinClippingArea||(n=null);const o=this.geometryState;let a=!1;o.numVerticesPerSide!==s&&(this._modifiedFlags|=1,o.numVerticesPerSide=s,o.samplerDataVersion++,a=!0),e.changed&&(this._modifiedFlags|=2,o.samplerData=e.samplerData,o.samplerDataVersion++,a=!0),t.equals(o.clippingArea,n)||(this._modifiedFlags=4,o.clippingArea=n,a=!0);const l=r.surface.wireframe;return o.wireframe!==l&&(this._modifiedFlags=8,o.wireframe=l,a=!0),this._geometryStateChangedSinceLastUpdate||=a,a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const{vertexAttributes:t,indices:r}=this.geometry,i=e.gl;this._vao=new _.VertexArrayObject(e,new v.VertexBuffer(e,c.glLayout(t.layout),t.buffer),b.BufferObject.createIndex(e,i.STATIC_DRAW,r)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=0){e?.texture===this._texture?this._textureOpacity=e.opacities[0]:this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(e){return this._textureRef.current?.texture===e||this._textureRef.next?.texture===e&&this._textureRef.fadeFactor<1}get _elevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],r=t.length,i=new Array(r);let s=0,n=0,o=!1;for(let a=0;a<r;a++){const r=t[a],l=r.upsampleInfo?.tile;if(l){const t=l.layerInfo[0][a].data,r=t&&t.samplerData;e&&e[s]===r||(o=!0),i[s++]=r,n=Math.max(n,l.lij[0])}else if(r.data){const t=this.tile.surface.layerViewByIndex(a,0);if(y.fallsWithinLayerView(this.tile,t)){const t=r.data;e&&e[s]===t.samplerData||(o=!0),i[s++]=t.samplerData,n=this.tile.level}}}null!=e&&e.length!==s&&(o=!0);const a=s>0,l=a?i:null;return a&&(i.length=s),{changed:o,samplerData:l,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){const e=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!p.enableTerrainInternalChecks)return;const e=this.tile;if(!e.loaded||!e.intersectsClippingArea||0===e.level)return void p.internalAssert(e?.loaded);const t=e.surface.extent;if(null!=t&&!e.intersectsExtent(t))return;const r=p.neighborEdgeIndices.map((r,i)=>null!=t&&(i<2?-1:1)*(e.extent[3-i]-t[3-i])<0),s=e.level;p.internalAssert(0===this.dirtyCorners),p.internalAssert(0===this.dirtyEdges),p.internalAssert(0===this.dirtyEdgeResolutions),p.internalAssert(!this.numVerticesPerSideChanged),p.internalAssert(!this.samplerDataChanged),p.internalAssert(!this.clippingAreaChanged),p.internalAssert(!this.wireframeChanged);const c=p.neighborCornerIndices.map(t=>e.findNeighborCornerTileExact(t,t=>!t.intersectsClippingArea||t.loaded||t.level===e.level)??null).map(e=>e?.intersectsClippingArea?e:null),u=this.geometryState;for(let t=0;t<4;++t){const r=u.cornerPeerNeighbors[t],i=c[t];p.internalAssert(i===r,`Tile[${e.lij}].corner[${t}] out of date: cur=[${r?.lij}] exp=[${i?.lij}]`)}p.neighborEdgeIndices.forEach((t,c)=>{if(r[c])return;const u=e.findNeighborTile(t,e=>(e.level===s||e?.loaded)&&e?.intersectsClippingArea);if(!u){const r=!e.surface.updatingRootTiles&&null!=e.surface.rootTiles&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(t);return void p.internalAssert(!r)}p.internalAssert(u.loaded||u.level===e.level),p.internalAssert(u===this.geometryState.edgePeerNeighbors[c]);const d=s-u.level;if(!u.loaded)return p.internalAssert(!u.leaf),void p.internalAssert(0===d);const h=u.renderData;p.internalAssert(e.isEdgeNeighbor(u,t)),p.internalAssert(d>=0);const f=2**d;if(d<0)return void p.internalAssert(!1);const m=e.renderData,g=m.geometry,y=m.localOrigin,_=g.getEdgeCount(c),b=g.numVerticesPerSide-1,v=h.geometry;if(!v)return void p.internalAssert(!1);const M=h.localOrigin,R=this.geometryState.edgePeerNeighbors[c];if(R?.loaded){const e=R.renderData;p.internalAssert(m.geometryState.edgePeerNeighborSamplerVersions[c]===e.geometryState.samplerDataVersion),p.internalAssert(this.geometryState.edgePeerNeighborSamplerVersions[c]===e.geometryState.samplerDataVersion)}const O=(c+2)%4,I=v.getEdgeCount(O),F=_-1,A=I-1;p.internalAssert(F*f===A,`Tile[${e.lij}]:e${c},res=${F} edgeRes mismatch with Neighbor[${u.lij}]:e${O},res=${A} (expected:${F*f})`);const D=e.extent,E=0===t||4===t,L=I-1,V=L>>d,U=_-1;if(V<1)return void p.internalAssert(1===U);p.internalAssert(V===U),p.internalAssert(i.isPowerOfTwo(V));const B=v.numVerticesPerSide-1;p.internalAssert(d>0||V===Math.max(B,b));const N=e.getNeighborEdgeStartVertexIndex(c,u);p.internalAssert(0<=N&&N<f);const k=N*V;p.internalAssert(0<=k&&k<=L-V);let z=0,j=k;g.getEdgeVertexPosition(c,w,y,0),g.getEdgeVertexPosition(c,x,y,_-1);const G=n.distance(w,x),q=Math.max(1,1e-4*G);for(let r=0;r<=V;++r){g.getEdgeVertexPosition(c,w,y,z),v.getEdgeVertexPosition(O,x,M,j);const i=r/V,s=E?D[0]+i*(D[2]-D[0]):6===t?D[0]:D[2],d=E?4===t?D[1]:D[3]:D[1]+i*(D[3]-D[1]),f=e.surface.extent;if(null==f||a.containsXY(f,s,d)){const t=n.dist(w,x),r=n.len(w)-l.earth.radius,i=n.len(x)-l.earth.radius,a=t<q;if(!a){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${c}[${z}/${_}] and [${u.lij}].edge${O}[${j}/${I}]`),null!=f&&console.warn("  surface extent= ",f," x,y=",s,",",d);const l=o.create();n.subtract(l,m.localOrigin,h.localOrigin),n.len(l)>0&&console.warn(`   localOrigins: ${m.localOrigin} vs ${h.localOrigin} d=${n.len(l)} [${l}]`),(()=>{const t=o.clone(w),r=o.clone(x);e.updateEdgeElevations(),u.updateEdgeElevations(),g.getEdgeVertexPosition(c,w,y,z),v.getEdgeVertexPosition(O,x,M,j);const i=o.create();n.sub(i,w,t),n.len(i)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${t} vs ${w} d=${n.len(i)} [${i}]`),n.sub(i,x,r),n.len(i)>0&&console.warn(`  XXX Neighbor[${u.lij}] edge out of date: ${r} vs ${x} d=${n.len(i)} [${i}]`)})();const b=g.getEdgeCount(c),S=v.getEdgeCount(I);p.internalAssert(a,`Mismatch in tile [${e.lij}].edge[${c}][${z}/${b}] vs neighbor [${u.lij}].edge[${O}][${j}/${S}] ${p.v32s(w)} vs ${p.v32s(x)}  dist=${t} h(t|n|d)=${r}|${i}|${i-r}`)}g.getEdgeNormal(c,S,z),v.getEdgeNormal(O,T,j),n.normalize(C,S),n.normalize(P,T);const b=n.dot(C,P),R=1-b<.01||e===u;if(!R){const t=o.create();n.sub(t,S,T);const r=()=>`Mismatch in tile edge normal ${p.lij2s(e.lij)} (${z}/${_-1}) edge ${c} vs neighbor ${p.lij2s(u.lij)}  (${j}/${I-1}) nedge ${O} :${p.v32s(S)} vs ${p.v32s(T)}  dot = ${b} : ${p.v32s(t)}`;console.warn("Mismatch in tile edge normal: ",r());{e.updateEdgeElevations(),u.updateEdgeElevations();const t=o.create(),r=o.create();g.getEdgeNormal(c,t,z),v.getEdgeNormal(O,r,j),n.equals(S,t)||console.warn("Missing update in tile normal: ",p.v32s(S)," => ",p.v32s(t)),n.equals(T,r)||console.warn("Missing update in neighbor normal: ",p.v32s(T)," => ",p.v32s(r))}p.internalAssert(R,r())}}z+=1,j+=1}})}},e.neighborTileIfLoadedOrSelf=R,e.zeroToFour=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/GeometryState":function(){define(["exports"],function(e){"use strict";e.GeometryState=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/PatchGeometry":function(){define(["exports","../../../core/maybe","../../../core/typedArrayUtil","../../../chunks/vec32","../../../geometry/support/aaBoundingBox","./terrainUtils","../webgl-engine/lib/Normals"],function(e,t,r,i,s,n,o){"use strict";e.PatchGeometry=class{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=s.empty(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=t.releaseMaybe(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,s.empty(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,r,s){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,s),t),i.add(t,t,r)}getEdgeNormal(e,t,r){const{typedBuffer:i,typedBufferStride:s}=this.vertexAttributes.normalCompressed;o.decompressNormal(t,i,this.getEdgeAttributeIndex(e,r),s)}setEdgeNormalFromValues(e,t,r,i,s){this._setNormal(this.getEdgeAttributeIndex(e,t),r,i,s)}setEdgeVertexFromValuesRawPositionUV(e,t,r,i,s,n,o){const a=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(a,r,i,s),this._setUV(a,n,o)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,r,i,s,n,o,a,l,c){const u=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(u,r,i,s),this._setUV(u,n,o),this._setNormal(u,a,l,c)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,r,i){const{typedBuffer:s,typedBufferStride:n}=this.vertexAttributes.normalCompressed;o.compressNormal(s,e,t,r,i,n)}_setUV(e,t,i){this.vertexAttributes.uv0.setValues(e,Math.round(t*r.maxUint16),Math.round(i*r.maxUint16))}getEdgeAttributeIndex(e,t){return n.internalAssert(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Normals":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/FloatArray","../../../../geometry/support/ShortArray"],function(e,t,r,i,s,n){"use strict";function o(e,t,r,i,s,n=2){const o=1/(Math.abs(r)+Math.abs(i)+Math.abs(s)),a=r*o,c=i*o,u=s<=0?(a>=0?1:-1)*(1-Math.abs(c)):a,d=s<=0?(c>=0?1:-1)*(1-Math.abs(a)):c,h=t*n;e[h]=l(u),e[h+1]=l(d)}function a(e,t,i,s=2){const n=i*s,o=c(t[n]),a=c(t[n+1]),l=1-Math.abs(o)-Math.abs(a);return e[2]=l,l<0?(e[0]=(o>=0?1:-1)*(1-Math.abs(a)),e[1]=(a>=0?1:-1)*(1-Math.abs(o))):(e[0]=o,e[1]=a),r.normalize(e,e)}function l(e){return t.clamp(Math.round(32767*e),-32767,32767)}function c(e){return t.clamp(e/32767,-1,1)}e.compressAndTransformNormals=function(e,t){const s=e.length/3,n=new Int16Array(2*s);let a=0;const l=i.create();for(let i=0;i<s;++i)l[0]=e[a++],l[1]=e[a++],l[2]=e[a++],r.transformMat3(l,l,t),o(n,i,l[0],l[1],l[2]);return n},e.compressNormal=o,e.compressNormals=function(e){const t=e.length/3,r=n.newShortArray(2*t);let i=0;for(let s=0;s<t;++s)o(r,s,e[i++],e[i++],e[i++]);return r},e.decodeInt16=c,e.decompressNormal=a,e.decompressNormals=function(e,t=2){const r=e.length/t,n=s.newFloatArray(3*r),o=i.create();let l=0;for(let i=0;i<r;++i)a(o,e,i,t),n[l++]=o[0],n[l++]=o[1],n[l++]=o[2];return n},e.encodeInt16=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/ShortArray":function(){define(["exports","../../core/typedArrayUtil"],function(e,t){"use strict";e.compactShortArray=function(e){return Array.isArray(e)?e.length<t.nativeArrayMaxSize?e:new Int16Array(e):e.length<t.nativeArrayMaxSize?Array.from(e):e},e.newShortArray=function(e){return e<=t.nativeArrayMaxSize?new Array(e):new Int16Array(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TextureFader":function(){define(["exports","../../../core/maybe"],function(e,t){"use strict";class r{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=t.destroyMaybe(this._current),this._next=t.destroyMaybe(this._next),this._waiting=t.destroyMaybe(this._waiting),this._delayed=t.destroyMaybe(this._delayed)}get current(){if(null==this._current)return null;if(!this._isFadingEnabled){let e=null;this._delayed?(e=this._delayed,this._delayed=null):this._waiting?(e=this._waiting,this._waiting=null):this._next&&(e=this._next,this._next=null),e&&(this.clear(),this._current=e)}let e=r.test.fadeMoment;if(this._delayed&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null)),this._next){e=e||performance.now();const r=this._fadeDuration,i=null!=this._current&&this._next.texture===this._current.texture,s=0!==this._next.type,n=e-this._fadeStart>=r;(i||s||n)&&(t.destroyMaybe(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(null==this._next)return 1;const e=r.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return null!=this._next||null!=this._delayed}push(e,r=0){this._delayed=t.destroyMaybe(this._delayed),this._push(e,r)}_push(e,i){if(this._isFadingEnabled||this.clear(),null==this._current)return void(this._current=e);const s=r.test.fadeMoment||performance.now();return 0!==i?(this._delayed=e,void(this._delayedTime=s+i)):null==this._next?(this._next=e,void(this._fadeStart=this._alignFadeStart(s))):void(null!=e&&(t.destroyMaybe(this._waiting),this._waiting=e))}get _fadeDuration(){const e=this._getFadeDuration();return this._waiting?.5*e:e}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}static{this.test={fadeMoment:0}}}e.TextureFader=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TextureReference":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec3f64"],function(e,t){"use strict";e.TextureReference=class{constructor(e,r,i,s,n,o){this.texture=e,this.type=r,this.offsetAndScale=i,e.retain(),this.opacities=t.fromValues(s,n,o)}destroy(){this.texture.release()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TileOverlayData":function(){define(["../../../core/libs/gl-matrix-2/factories/vec4f64"],function(e){"use strict";return class{constructor(){this._scales=e.fromValues(-1,-1,-1,-1),this._offsets=e.fromValues(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,r){this._scales[2*e]=t,this._scales[2*e+1]=r}setOffset(e,t,r){this._offsets[2*e]=t,this._offsets[2*e+1]=r}get scales(){return this._scales}get offsets(){return this._offsets}}})},"esri/views/3d/terrain/tileUtils":function(){define(["exports","../../../core/PooledArray","./terrainUtils"],function(e,t,r){"use strict";function i(e,t,r=()=>!0){if(t(e),!e.leaf&&r(e))for(const r of e.children)i(r,t)}function s(e,t){const r=e.lij,i=t.lij;return r[0]-i[0]||r[1]-i[1]||r[2]-i[2]}function n(e,t){const r=e.screenDepth-t.screenDepth;if(0!==r)return r;const i=e.lij,s=t.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function o(e,t){const r=e.screenDepth,i=t.screenDepth;return r<i?-1:r>i?1:s(e,t)}function a(e,t,r){return l(e,r)===l(t,r)?o(e,t):e?1:-1}function l(e,t){for(const r of t)if(e.intersectsExtent(r))return!0;return!1}function c(e,t){const r=e.distanceToPOI-t.distanceToPOI;if(0!==r)return r;const i=e.lij,s=t.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}e.IteratorPostorder=class{constructor(){this._q=new t}get done(){return 0===this._q.length}reset(e){if(this._q.clear(),null!=e){this._q.pushArray(e);for(let e=0;e<this._q.length;++e){const t=this._q.data[e];t.leaf||this._q.pushArray(t.children)}}}next(){return this._q.pop()}},e.IteratorPreorder=class{constructor(){this._queue=new t,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.leaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),null!=e&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){const e=this._last?.children;return e?.[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},e.compareTiles=o,e.compareTilesByLij=s,e.compareTilesWithStencil=a,e.computeUpsampleInfo=function(e,t,r){let i=1,s=0,n=0;for(;e!==t;)if(i*=.5,s*=.5,n*=.5,1&e.lij[2]&&(s+=.5),1&e.lij[1]||(n+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");r.init(t,s,n,i)},e.fallsWithinLayerView=function(e,t){if(null==t||t.destroyed)return!1;const i=(s=t,r.isImageryTileLayerView(s)?{fullExtent:s.fullExtent,minScale:s.layer.minScale,maxScale:s.layer.maxScale}:s.layer);var s;if(null==i?.fullExtent)return!1;const n=i.fullExtent,o=e.extent;if(n.xmin>o[2]||n.ymin>o[3]||n.xmax<o[0]||n.ymax<o[1])return!1;const a=e.surface.tilingScheme.levels[e.level].scale,l=i.minScale;if(l>0&&a>1.00000001*l)return!1;const c=i.maxScale;return!(c>0&&a<.99999999*c)},e.getTileMapCache=function(e){return!r.isImageryTileLayerView(e)&&e.layer&&"tilemapCache"in e.layer?e.layer.tilemapCache:null},e.hasLoadableSiblings=function(e){for(let t=0;t<e.length;t++){const r=e[t],i=r.parent;if(i)for(let e=0;e<4;e++){const t=i.children[e];if(t&&t!==r)return!0}}return!1},e.sortTiles=function(e,t=null){null==t||0===t.length?e.sort(n):e.sort((e,r)=>a(e,r,t))},e.sortTilesByPOI=function(e,t){const r=e.length;for(let i=0;i<r;++i)e.at(i).updateDistanceToPOI(t);e.sort(c)},e.tilesAreRelated=function(e,t){if(!e||!t||e[0]===t[0])return!1;const r=e[0]<t[0],i=r?e:t,s=r?t:e,n=1<<s[0]-i[0];return Math.floor(s[1]/n)===i[1]&&Math.floor(s[2]/n)===i[2]},e.traverseTilesPreorder=function(e,t,r=()=>!0){if(Array.isArray(e))for(let s=0;s<e.length;s++)i(e[s],t,r);else i(e,t,r)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/Tile":function(){define(["exports","../../../core/mathUtils","../../../core/maybe","../../../core/ObjectPool","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/support/aaBoundingRect","../../../chunks/sphere","../../../layers/support/layerUtils","./ElevationBounds","./ElevationTileAgent","./LayerClass","./MapTileAgent","./TerrainConst","./TerrainData","./terrainUtils","./TileAgent","./TilePerLayerInfo","./tileUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b){"use strict";function v(e,t,r,i){const s=0===r?S.acquire():x.acquire();return s.init(e,t,r,i),s}function w(e){e.dispose(),d.isElevationTileAgent(e)?S.release(e):p.isMapTileAgent(e)&&x.release(e)}const x=new i(p.MapTileAgent),S=new i(d.ElevationTileAgent),T=new u.ElevationBounds;function C(e,t){const r=e.lij,i=t[0]-r[0];return!(i<0)&&t[1]>>i===r[1]&&t[2]>>i===r[2]}function P(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function M(e,t,r){return null!=e&&null!=t&&t!==e&&(e.level>=t.level?R(e,t,r):R(t,e,g.oppositeCorner(r)))}function R(e,t,r){g.internalAssert(e.level>=t.level);const i=g.isWestCorner(r),s=g.isNorthCorner(r),n=e.extent,o=t.extent,a=[i?n[0]:n[2],s?n[3]:n[1]],l=[i?o[2]:o[0],s?o[1]:o[3]],c=1e-5*(n[2]-n[0]),u=g.almostEquals(a[0],l[0],c)||e.surface.isGlobal&&g.almostEquals(a[0],-l[0],c),d=g.almostEquals(a[1],l[1],c);if(u&&d)return!0;if(e.level===t.level)return g.internalAssert(!1),!1;if(!u&&!d)return g.internalAssert(!1),!1;const h=u?O(o[1],o[3],n[1],n[3],c):O(o[0],o[2],n[0],n[2],c);return g.internalAssert(h),h}function O(e,t,r,i,s){return e-s<=r&&r<=i&&i<=t+s}const I=n.create(),F=n.create(),A=n.create(),D=n.create();e.Tile=class{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=a.create(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=a.create(),this.centerAtSeaLevel=n.create(),this._center=[n.create(),l.create(),n.create()],this.up=n.unitZ(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.onCompressionFinished=()=>{this.setPendingUpdate(16),this.setMemoryDirty()},this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=n.create(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get spatialReference(){return this._surface.spatialReference??this._surface.tilingScheme.spatialReference}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){x.prune(0),S.prune(0),_.TilePerLayerInfo.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,t=e?.frustumVisibility??1;this._frustumVisibility=0===t?0:2===t?2:this._calculateFrustumVisibility(this.surface.frustum);const r=2!==this._frustumVisibility&&this._intersectsClippingArea;r!==this._visible&&(this._visible=r,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get _loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,r,i,s){this._lij[0]=e,this._lij[1]=t,this._lij[2]=r,this.ellipsoid=o.getReferenceEllipsoid(s.tilingScheme.spatialReference),s.tilingScheme.getExtent(e,t,r,this.extent),s.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,s.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.elevationLevel=e,i&&!Number.isNaN(i.elevationBoundsMin)?(this._elevationBoundsMin=i.elevationBoundsMin,this._elevationBoundsMax=i.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=i,this.clearChildren(),this._surface=s,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const e of h.LayerClasses){const t=s.numLayers(e),r=this.layerInfo[e];for(const e of r)e.release();r.length=t;for(let i=0;i<t;i++)r[i]=_.TilePerLayerInfo.acquire(this._surface.upsampleInfoPool),0===e&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(s.tilingScheme.pixelSize,f.maxPatchTesselation)}dispose(){g.weakAssert(!this.renderData,"tile.renderData was not unloaded"),this._surface?.upsampleMapCache.pop(this.key),this.layerInfo.forEach(e=>{e.forEach(e=>e.release()),e.length=0}),this._surface=this._parent=null,this.clearChildren(),this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){--this._mapDataRefCount,this._cached&&this.cachedMemory>0&&this._surface.upsampleMapCache.put(this.key,this)}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this._mapTileMemory)}get cachedMemory(){return this._ensureUsedMemory(),null==this._surface?this.usedMemory:this._cached?this._mapTileMemory:0}get _mapTileMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_ensureUsedMemory(){if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[1].reduce((e,{data:t})=>e+(m.isVectorTile(t)?t.usedMemoryPerReference:0),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(const{data:e}of this.layerInfo[1])m.isVectorTile(e)?this._vectorTileMemory+=e.usedMemoryPerReference:this._rasterTileMemory+=this.getTerrainDataMemory(e);for(const e of this.layerInfo[0])this._usedMemory+=e.data?this._cpuImageMemorySize:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=this.renderData.texture?.cachedMemory??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key,this),this._usedMemory}getUsedMemoryForLayer(e,t){const r=this.layerInfo[e][t];return r?.data?1===e?this._cached?0:this.getTerrainDataMemory(r.data):0===e?this._cpuImageMemorySize:0:0}getTerrainDataMemory(e){return m.isTileTexture(e)?e.texture.usedMemory:m.isRasterTile(e)?e.memoryUsage:m.isVectorTile(e)?e.usedMemoryPerReference:m.isImageWithType(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(e){const t=this._center[1],r=e,i=t[0],s=t[1],n=t[2],o=r[2]*i+r[6]*s+r[10]*n+r[14];this.screenDepth=o<0?0:o/(r[3]*i+r[7]*s+r[11]*n+r[15])}shouldSplit(e,t,r){if(!this.visible)return 0;if(e.frustum&&(!this._intersectsClippingArea||2===this._calculateFrustumVisibility(e.frustum)))return 0;const i=this.level;s.subtract(I,l.getCenter(this._center[1]),t);let n=s.squaredLength(I),o=I,a=l.getCenter(this._center[1]);s.subtract(F,this._center[0],t);const c=s.squaredLength(F);c<n&&(n=c,o=F,a=this._center[0]),s.subtract(A,this._center[2],t);const u=s.squaredLength(A);if(u<n&&(n=u,o=A,a=this._center[2]),this._edgeLen2>n&&i<e.maxLod)return 1;const d=Math.sqrt(n),h=e.fovX*d*2,p=this._edgeLen/h,f=()=>{if(i<e.maxLod)return this.elevationLevel=i,0;const t=i+Math.ceil(-Math.log2(e.relativeWidthLimit/p));return t!==this.elevationLevel?(this.elevationLevel=t,2):0},m=null!=r?r-i:1/0;if(m<=.5)return f();const g=s.dot(this.up,I),y=this._elevationBoundsMax-this._elevationBoundsMin,_=y/this.edgeLen;if(e.aboveGround&&g>0&&_<.001&&g/d-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-_>0)return 0;const b=null!=r?3-Math.min(m,2):1;if(p*b<e.relativeWidthLimit||i>=e.maxLod)return f();if(i<7)return 1;s.scale(D,this.up,g),s.subtract(D,D,o);const v=s.squaredLength(D);if(v<=this.radius*this.radius)return 1;s.scale(D,D,this.radius/Math.sqrt(v)),s.add(D,D,a),s.subtract(D,t,D);const w=Math.min(1,(Math.abs(s.dot(D,this.up))+.5*y+this._curvatureHeight)/s.length(D)),x=.1/e.angledSplitBias,S=e.fovY*d*2;return w*(this._edgeLen/S*b)<x*e.relativeHeightLimit?0:1}createChildren(){const e=this._children,t=this.lij[0]+1,r=2*this.lij[1],i=2*this.lij[2];return e[0]=this.surface.createTile(t,r,i,this),e[1]=this.surface.createTile(t,r,i+1,this),e[2]=this.surface.createTile(t,r+1,i,this),e[3]=this.surface.createTile(t,r+1,i+1,this),e}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(const e of h.LayerClasses)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(){this.renderData&&this.unrefMapData(),this.surface.renderer.unloadTile(this);for(const e of h.LayerClasses){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==y.tileAgentDone&&(w(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(8),this.resetPendingUpdate(16),this.resetPendingUpdate(32)}unloadMapData(){const e=this.layerInfo[1];for(const t of e)t.loadingAgent&&t.loadingAgent!==y.tileAgentDone&&(w(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0,t.invalidateSourceData();this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(a.equals(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,r=this._withinClippingArea;null!=e?(this._intersectsClippingArea=this.intersectsExtent(e),this._withinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const i=r&&this._withinClippingArea,s=!(r||t||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||i||s||this.setPendingUpdate(8),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const r=this.layerInfo[t][e];return!(!r?.data||r.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of h.LayerClasses){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==y.tileAgentDone&&e.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(1)||0!==e&&!this._loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,1===e||4===e?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const s=this.layerInfo[t][e];if(s.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e),!0;if(s.waitingAgents.push(i),s.data&&!s.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e);const r=m.isVectorTile(s.data);return i.dataArrived(this,r),!0}if(s.requestPromise)return!0;r.abortMaybe(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,e,t,s.requestAbort);if(!n)return s.requestAbort=null,!1;const o=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(o,o),!0}get leaf(){return null==this._children[0]}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return s.squaredLength(s.subtract(D,l.getCenter(this._center[1]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const r=this.extent;return e>=r[0]&&t>=r[1]&&e<=r[2]&&t<=r[3]}unrequestLayerData(e,t,r){const i=this.layerInfo[t][e],s=i.waitingAgents,n=null!=s.removeUnordered(r);g.weakAssert(n,"agent has not requested this piece of map data"),s.length<1&&(i.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,r){const i=m.isVectorTile(r),s=this.layerInfo[t][e];s.data=r,s.dataInvalidated=!1,s.waitingAgents.forAll(e=>e.dataArrived(this,i)),s.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t){const r=this.layerInfo[t][e];r.dataMissing=!0,r.waitingAgents.forAll(e=>e.dataMissing()),r.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,r){switch(r&&this.forEachLoadedNeighbor(r=>r.updateRenderData(e,t)),e){case 1:return this._updateTexture(t);case 0:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(0===e?16:32),this.setPendingUpdate(0===e?32:16))}_updateGeometry(){this.setPendingUpdate(8);for(const e of this.layerInfo[0])e.pendingUpdates|=8}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let r=1/0,i=-1/0;const s=this.layerInfo[0];let n=!0;for(const e of s)null!=e.elevationBounds&&(r=Math.min(r,e.elevationBounds.min),i=Math.max(i,e.elevationBounds.max),e.elevationBounds.hasNoDataValues||(n=!1));n&&(r=Math.min(r,0),i=Math.max(i,0)),e===r&&t===i||(this._elevationBoundsMin=r,this._elevationBoundsMax=i,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,r=.5*(e+t),i=this._center;s.scale(D,this.up,r),s.add(l.getCenter(i[1]),this.centerAtSeaLevel,D),s.scale(D,this.up,e),s.add(i[0],this.centerAtSeaLevel,D),s.scale(D,this.up,t),s.add(i[2],this.centerAtSeaLevel,D)}findElevationBoundsForLayer(e,t){const r=this.layerInfo[0][e],i=this.elevationLevelDelta,s=Math.max(this.elevationLevel-i,0),n=r.elevationBounds;if(null!=n&&n.level>=t&&n.level<=s)return;const o=this._surface.layerViewByIndex(e,0);if(!b.fallsWithinLayerView(this,o))return;const a=T;let l=!1;const c=r.data;if(c&&c.level<=s){const e=r.data;a.min=e.samplerData.data.minValue,a.max=e.samplerData.data.maxValue,a.hasNoDataValues=e.samplerData.data.hasNoDataValues,a.level=this.level,l=!0}else{let t,r,n=0;for(let o=this._parent;o&&(!r||n<i)&&(n=this.elevationLevel-o.level,t=r||t,r=o.layerInfo[0][e].data,!(!r&&t&&o.level<=s));o=o.parent);r=r||t,r&&(r.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],a),a.min!==1/0&&(a.level=r.level,l=!0))}l&&(null==r.elevationBounds&&(r.elevationBounds=new u.ElevationBounds),r.elevationBounds.copyFrom(a))}modifyLayers(e,t,r){const i=this.layerInfo[r];for(const e of i)e.loadingAgent&&e.loadingAgent!==y.tileAgentDone&&(w(e.loadingAgent),e.loadingAgent=null),e.waitingAgents.clear();for(let t=0;t<i.length;++t)void 0===e[t]&&i[t].release();const s=new Array(...i),n=t.length;i.length=n;for(let e=0;e<n;e++){const r=t[e];i[e]=r>-1?s[r]:_.TilePerLayerInfo.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,0))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===y.tileAgentDone&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of h.LayerClasses){const t=this._isSuspended(e);for(const r of this.layerInfo[e])r.loadingAgent&&r.loadingAgent!==y.tileAgentDone&&(r.loadingAgent.setSuspension(t),r.loadingAgent===y.tileAgentDone&&this.updateRenderData(e,0))}}removeLayerAgent(e,t){const r=this.layerInfo[t][e];r.loadingAgent&&r.loadingAgent!==y.tileAgentDone&&r.loadingAgent.dispose(),r.loadingAgent=null}agentDone(e,t){const r=this.layerInfo[t][e];r.loadingAgent=y.tileAgentDone,r.data||null!=r.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return"normal"!==e.blendMode||c.isGroupLayer(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,r){for(let i=e;i<t;++i){const e=this._surface.layerViewByIndex(i,r);if(g.isBlendableLayerView(e)&&"normal"!==e?.layer?.blendMode||c.isGroupLayer(e?.layer?.parent)&&this._hasBlendableAncestor(e?.layer?.parent))return!0}return!1}_createOrUpdateAgents(e,t){const r=this.layerInfo[t];if(0===r.length)return;const i=this._isSuspended(t);for(let s=e;s<r.length;++s){const n=r[s],o=this._surface.layerViewByIndex(s,t);let a=!1;if(n.loadingAgent?b.fallsWithinLayerView(this,o)?(n.loadingAgent!==y.tileAgentDone&&n.loadingAgent.setSuspension(i),n.loadingAgent!==y.tileAgentDone&&(a=n.loadingAgent.update())):n.dispose():b.fallsWithinLayerView(this,o)&&(n.loadingAgent=v(this,s,t,i),a=n.loadingAgent.startLoading(),a?n.loadingAgent===y.tileAgentDone&&this.setPendingUpdate(8):(w(n.loadingAgent),n.loadingAgent=y.tileAgentDone)),n.loadingAgent===y.tileAgentDone&&this.updateRenderData(t,0),!o.destroyed&&!this._hasBlendModes(e,r.length,t)&&a&&o.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const r=this.elevationLevel-this.level,i=Math.max(this.level-e,this.elevationLevelDelta-r),s=t.clamp(1+(this._maxTesselation>>i),2,this._maxTesselation+1),n=this.minimumVerticesPerSide;return Math.max(s,n)}_findLIJ(e,t){if(!e)return null;const r=this.surface.rootTiles;if(null!=r)for(const i of r)if(C(i,e)){let r=i,s=e[0]-r.level-1;for(;s>=0&&!r.leaf&&!t(r);){const t=e[1]>>s&1,i=e[2]>>s&1;r=r.children[2*t+i],s--}return t(r)?r:null}return null}findNeighborTile(e,t){const r=this._lij,i=this._getNeighborLIJ(r,e);return i?P(r,i)?t(this)?this:null:this._findLIJ(i,t):null}findCorner(e,t){const r=1===e?1:7===e?0:5===e?2:3;let i=this;for(;i.children[0]&&(!t||!t(i));)i=i.children[r];return i}findNeighborCornerTileExact(e,t){return this.findNeighborTile(e,e=>t(e)||e.level===this.level)?.findCorner(g.oppositeCorner(e),t)||null}forAllSubtreeOnSide(e,t){const r=0===e?[0,1]:1===e?[1]:2===e?[1,3]:3===e?[3]:4===e?[2,3]:5===e?[2]:6===e?[0,2]:[0],i=e=>{const s=e.children;!t(e)&&s[0]&&r.forEach(e=>i(s[e]))};i(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const r=this.level-t.level;if(g.internalAssert(!g.enableTerrainInternalChecks||r>=0),0===r)return 0;const i=2**r,s=!(1&~e),n=s?0:1,o=t.lij[n+1]*i,a=this._lij[n+1],l=a-o,c=s?i-1-l:l;return g.enableTerrainInternalChecks&&(g.internalAssert(o<=a&&a<o+i),g.internalAssert(0<=c&&c<i)),c}forEachLoadedNeighbor(e){const t=this.level,r=e=>e.level===t||e.loaded;g.neighborEdgeIndices.forEach(t=>{const i=this.findNeighborTile(t,r);null!=i&&i!==this&&i.forAllSubtreeOnSide(g.oppositeEdge(t),r=>!!r.loaded&&(e(r,t),!0))}),g.neighborCornerIndices.forEach(t=>{const i=this.findNeighborTile(t,r)?.findCorner(g.oppositeCorner(t),e=>e.loaded);g.internalAssert(!i||M(this,i,t)),i?.loaded&&e(i,t)})}_getNeighborLIJ(e,t){const r=g.isNorth(t)?-1:g.isSouth(t)?1:0,i=g.isWest(t)?-1:g.isEast(t)?1:0,s=[e[0],e[1]+r,e[2]+i];return s[1]<0?null:this.surface.isGlobal?this._wrapLIJ(s):s[2]<0?null:s}_wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}isEdgeNeighbor(e,t){if(null==e)return!1;if(0===this.level&&0===e.level){if(this._eastEnd&&e._westEnd&&2===t)return!0;if(this._westEnd&&e._eastEnd&&6===t)return!0}const r=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(t){case 0:return g.almostEquals(this.extent[3],e.extent[1],r);case 4:return g.almostEquals(this.extent[1],e.extent[3],r);case 2:return g.almostEquals(this.extent[2],e.extent[0],r)||g.almostEquals(this.extent[2],-e.extent[0],r);case 6:return g.almostEquals(this.extent[0],e.extent[2],r)||g.almostEquals(this.extent[0],-e.extent[2],r)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return 0===this._lij[2]}checkGeometryWaterproofness(){g.enableWaterproofTests&&(g.internalAssert(this.loaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,r=this.surface.rootTilesExtent,i=.25*(t[2]-t[0]);if(g.isNorth(e)&&t[3]+i>=r[3])return!1;if(g.isSouth(e)&&t[1]-i<=r[1])return!1;const s=this.surface.isGlobal;return!(!s&&g.isWest(e)&&t[0]-i<=r[0]||!s&&g.isEast(e)&&t[2]+i>=r[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;s.copy(this._lastPOI,e);const r=this._center[1],i=e[0]-r[0],n=e[1]-r[1],o=e[2]-r[2];this.distanceToPOI=i*i+n*n+o*o}},e.isCornerNeighbor=M,e.lijEquals=P,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/ElevationTileAgent":function(){define(["exports","./TileAgent"],function(e,t){"use strict";class r extends t.TileAgent{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}e.ElevationTileAgent=r,e.isElevationTileAgent=function(e){return"elevation"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TileAgent":function(){define(["exports","../../../core/has","./TerrainConst","./tileUtils"],function(e,t,r,i){"use strict";class s{get updating(){return!!this._tileRequested}init(e,t,r,i){this.tile=e,this._layerIdx=t,this._layerClass=r,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,r),this._tileRequested=null;const s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,0,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,s=this.tile.surface.layerViewByIndex(e,t),{minLevel:n,maxLevel:o}=s.dataLevelRange,a=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+a,c=this._scaleRangeEnabled?i.fallsWithinLayerView:()=>!0;let u=this.tile;const d=u.level;let h;const p=this._tileLayerInfo.upsampleInfo,f=p?.tile?.level??-1,m=null!=p&&f-d>=a,g=i.getTileMapCache(s),y="vector-tile-3d"===s.type?s.schemaHelper:null;for(;u&&c(u,s)&&u.level>=n;){const i=u.level,s=d-i,c=u.layerInfo[t][e];if(c.data&&s>=a){(!m||i>f)&&this._setUpsampleTile(u),c.dataInvalidated&&(h=u);break}const p=y?.getLevelRowColumn(u.lij)??u.lij;if("unavailable"!==g?.getAvailability(p[0],p[1],p[2])&&i<=o&&!c.data&&!c.dataMissing&&((!h||u.level===n||i%r.progressiveLoadingModulo===0||d-h.level<a)&&(h=u),s>=l))break;u=u.parent}if(null!=h&&d-h.level<a)if(p)h=null;else{const r=this._findAncestorWithData();null!=r&&(this._setUpsampleTile(r),h=r.layerInfo[t][e].dataInvalidated?r:null)}return h}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let r;for(let i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(e-i.level>=t)return i;r=i}return r}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,0,t)}get test(){}}const n=new Error("Abstract method called on TileAgent"),o=new class extends s{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw n}get _progressiveLevelModulo(){throw n}dispose(){}};e.TileAgent=s,e.tileAgentDone=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/MapTileAgent":function(){define(["exports","./TerrainConst","./TileAgent"],function(e,t,r){"use strict";class i extends r.TileAgent{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return t.progressiveLoadingModulo}}e.MapTileAgent=i,e.isMapTileAgent=function(e){return"map"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TilePerLayerInfo":function(){define(["exports","../../../core/maybe","../../../core/ObjectPool","../../../core/PooledArray","./terrainUtils","./tileUtils"],function(e,t,r,i,s,n){"use strict";class o{constructor(){this.waitingAgents=new i,this.pendingUpdates=0}static acquire(e){const t=a.acquire();return t._init(e),t}release(){this.dispose(),l.delete(this),a.release(this)}dispose(){this.loadingAgent=t.disposeMaybe(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=s.releaseTerrainData(this._data)}static prune(){a.prune(0)}_init(e){this.waitingAgents.clear(),this._data=s.releaseTerrainData(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=t.abortMaybe(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){this.upsampleInfo&&(this.upsampleInfo.tile?.unrefMapData(),this._pool.release(this.upsampleInfo),this.upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&null!=t){if(null==this.upsampleInfo)this.upsampleInfo=this._pool.acquire();else{if(this.upsampleInfo.tile===t)return;this.upsampleInfo.tile?.unrefMapData()}t.refMapData(),n.computeUpsampleInfo(e,t,this.upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){s.releaseTerrainData(this._data),this._data=e}}const a=new r(o,null,()=>{}),l=new Map;e.TilePerLayerInfo=o,e.clearTilePerLayerInfo=function(){a.prune(),l.clear()},e.printAllocations=function(){l.size>0&&(console.log(`${l.size} live TilePerLayerInfo allocations:`),l.forEach(e=>console.log(e,"\n")))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/ScaleRangeQueries":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/ObjectPool","../../../core/PooledArray","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h{constructor(){this.extent=d.create(),this.minLevel=0,this.maxLevel=0,this.callback=null}}e.ScaleRangeQueries=class extends r{constructor(){super(...arguments),this._queries=new s({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new s({initialSize:30}),this._queryPool=new i(h)}queryVisibleLevelRange(e,t,r,i){const s=this._queryPool.acquire();u.copy(s.extent,e),s.minLevel=t??-Number.MAX_VALUE,s.maxLevel=r??Number.MAX_VALUE,s.callback=i,this._queryQueue.push(s),this.notifyChange("updating")}get updating(){return 0!==this._queryQueue.length}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let r=0;for(;r<this._queriesInvPtr;){const i=this._queries.data[r],s=i.extent;t>=i.minLevel&&t<=i.maxLevel&&s[0]<=e.extent[2]&&s[2]>=e.extent[0]&&s[1]<=e.extent[3]&&s[3]>=e.extent[1]?(this._queries.swapElements(r,this._queriesInvPtr-1),this._queriesInvPtr--):r++}}},t.__decorate([n.property()],e.ScaleRangeQueries.prototype,"updating",null),e.ScaleRangeQueries=t.__decorate([c.subclass("esri.views.3d.terrain.ScaleRangeQueries")],e.ScaleRangeQueries),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/SphericalPatch":function(){define(["exports","../../../core/mathUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/projection/lonLatToSphericalPCPF","../../../geometry/support/DoubleArray","../../../geometry/support/frustum","../../../chunks/sphere","./PatchGeometryFactory","./terrainUtils","./Tile","./tileUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h extends u.Tile{constructor(e,t,r,i,s){super(),this._convexHull=new Array(24),this._boundingSphere=a.create(),this._baseUsedMemory=1816,this.init(e,t,r,i,s)}init(e,i,n,o,a){super.init(e,i,n,o,a);const l=this.ellipsoid.radius,c=this.extentInRadians[0],u=this.extentInRadians[1],d=this.extentInRadians[2],h=this.extentInRadians[3],p=t.lerp(u,h,.5),f=t.lerp(c,d,.5),m=0===e?0:Math.min(Math.abs(u),Math.abs(h));this._edgeLen=(d-c)*Math.cos(m)*l,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=l-Math.sqrt(l*l-this._edgeLen2/4),s.lonLatToSphericalPCPF(this.centerAtSeaLevel,f,p,this.ellipsoid.radius),r.normalize(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(0===this.lij[0])r.set(a.getCenter(e[1]),0,0,0),r.set(e[0],0,0,0),r.set(e[2],0,0,0),e[1][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[1],r=this.convexHull;let i=0;for(let e=0;e<8;++e)i=Math.max(i,f(a.getCenter(t),r,3*e));e[1][3]=Math.sqrt(i)}}_calculateFrustumVisibility(e){if(!o.intersectsSphere(e,this._boundingSphere))return 2;if(this.lij[0]<10)return 1;const t=this.convexHull,r=this.surface.view.state.camera.near;let i=!0;for(let s=0;s<o.numPlanes;s++){const n=4===s,o=e[s],a=o[0],l=o[1],c=o[2],u=o[3]-(n?r:0);let d=!1;for(let e=0;e<8;++e){const r=3*e;if(a*t[r]+l*t[r+1]+c*t[r+2]+u<0){if(d=!0,!i)break}else i=!1}if(!d)return 2}return i?0:1}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){l.createSphericalGlobePatch(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),c.enableTerrainInternalChecks&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=a.getCenter(e),i=this.elevationBoundsMin,s=this.elevationBoundsMax,n=this.ellipsoid.radius,o=s;if(0===this.level)r.set(t,0,0,0),e[3]=n+o;else{const o=this.extentInRadians,a=.5*(o[0]+o[2]),l=o[1],c=o[3];g(_,a,l,n),g(b,a,c,n),r.add(t,_,b);const u=n+.5*(i+s);r.scale(t,t,u/r.len(t));const d=this.convexHull;let h=0;const p=(e,t)=>{const r=e[0]-d[3*t],i=e[1]-d[3*t+1],s=e[2]-d[3*t+2];return Math.sqrt(r*r+i*i+s*s)};for(let e=0;e<8;++e){const r=p(t,e);h=Math.max(h,r)}const f=h;e[3]=f+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(0===this.level)return;const s=this.elevationBoundsMin,n=this.elevationBoundsMax,o=this._getPatchType(),a=this.surface.isWebMercator,l=a&&1===o,u=a&&2===o,d=u||l,h=Math.PI/2,p=e[0],f=e[2],m=u?-h:e[1],_=l?h:e[3],b=.5*(p+f),v=s,w=t+(d?Math.min(0,v-1):v),x=(e,t,r)=>g(e,t,r,w),S=i.create(),T=i.create(),C=i.create(),P=i.create();x(S,p,m),x(T,p,_),x(C,f,_),x(P,f,m);const M=(e,t)=>{for(let r=0;r<3;++r)this._convexHull[3*t+r]=e[r]};M(S,0),M(T,1),M(C,2),M(P,3);const R=n,O=t+(d?Math.max(0,R+1):R),I=i.create(),F=i.create(),A=i.create();g(F,b,_,w),g(A,b,m,w),r.add(I,F,A),r.normalize(I,I);const D=i.create(),E=i.create(),L=(e,t)=>{r.sub(E,e,t),r.normalize(E,E);const i=-r.dot(e,D)/r.dot(E,D);c.internalAssert(i>=0),r.scale(E,E,i),r.add(e,e,E)};if(2**this.lij[0]>2*this.lij[1]){const e=A,t=i.create();r.cross(t,y,e),r.normalize(t,t),r.cross(D,e,t),r.normalize(D,D),c.internalAssert(c.almostEquals(r.dot(D,e)/r.len(e),0)),L(S,T),L(P,C),M(S,0),M(P,3)}else if(2**this.lij[0]!==2*this.lij[1]){const e=F,t=i.create();r.cross(t,y,e),r.normalize(t,t),r.cross(D,t,e),r.normalize(D,D),L(T,S),L(C,P),M(T,1),M(C,2)}const V=(e,t)=>{const i=O/r.dot(t,I);for(let r=0;r<3;++r)this._convexHull[3*e+r]=t[r]*i};V(4,S),V(5,T),V(6,C),V(7,P)}_getPatchType(){const e=this.lij[1],t=0===e,r=e===(1<<this.level)-1;return t?r?3:1:r?2:0}intersectsRay(e,t,r,i){const s=this._boundingSphere,n=s[3]+r,o=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],a=s[0]-e[0],l=s[1]-e[1],c=s[2]-e[2],u=(a*t[0]+l*t[1]+c*t[2])/o,d=t[0]*u-a,h=t[1]*u-l,p=t[2]*u-c;return d*d+h*h+p*p<n*n}get minimumVerticesPerSide(){return this.level<p.length?p[this.level]+1:2}updateCornerElevations(){l.updateCornerSpherical(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){l.updateEdgesAndCornersSpherical(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){l.updateEdgeElevationsAndResolutionsSpherical(this.renderData),this._updateBoundingVolumes()}_checkBVs(){if(!c.enableTerrainInternalChecks)return;if(this.level<=2)return;const e=this._boundingSphere,t=e[3],s=a.getCenter(e),o=i.create(),l=this.ellipsoid.radius,u=this.elevationBoundsMin,h=this.elevationBoundsMax,p=l+u,f=this._center[1][3],y=this.convexHull,_=(e,t)=>{for(let r=0;r<3;++r)e[r]=y[3*t+r]};{const e=i.create(),t=i.create(),s=i.create(),n=i.create(),o=i.create(),a=(i,a,l,u)=>{_(t,i),_(s,a),_(n,l),r.sub(t,t,s),r.sub(n,n,s),r.cross(e,t,n),r.normalize(e,e);const d=r.dot(e,s);_(o,u);const h=r.dot(e,o),p=Math.abs(h-d);c.internalAssert(c.almostEquals(p,0),`Non coplanar ${i},${a},${l},${u} diff = ${p}`)};a(0,1,2,3),a(4,5,6,7),a(0,1,4,5),a(1,2,5,6),a(2,3,6,7),a(3,0,7,4)}const b=n.newDoubleArray(24),v=i.create(),w=i.create(),x=i.create(),S=i.create(),T=(e,t,i,s)=>{_(v,t),_(w,i),_(x,s),r.sub(v,v,w),r.normalize(v,v),r.sub(x,x,w),r.normalize(x,x),r.cross(S,v,x),r.normalize(S,S);const n=r.dot(S,w);((e,t,r)=>{const i=4*e;for(let e=0;e<3;++e)b[i+e]=t[e];b[i+3]=r})(e,S,n)};T(0,0,1,2),T(1,1,0,4),T(2,1,5,2),T(3,3,2,6),T(4,4,0,3),T(5,4,6,5);const C=(e,t,r,i)=>{const s=4*e;return b[s]*t+b[s+1]*r+b[s+2]*i-b[s+3]},P=(e,t,r,i)=>C(e,t,r,i)>=-1,M=(e,t)=>P(e,t[0],t[1],t[2]),R=2**this.lij[0]>2*this.lij[1],O=(e,r,i)=>Math.sqrt(m(e,r,i,s[0],s[1],s[2]))<t,I=e=>O(e[0],e[1],e[2]),F=(e,t)=>O(e[t],e[t+1],e[t+2]),A=this.extentInRadians,D=.5*(A[0]+A[2]),E=A[1],L=A[3],V=i.create(),U=i.create();g(V,D,L,p),g(U,D,E,p);const B=R?"Upper":"Lower";let N=!0;for(let e=0;e<6;++e){for(let t=0;t<8;++t){const r=3*t,i=P(e,y[r],y[r+1],y[r+2]);N&&=i,c.internalAssert(i,`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}c.internalAssert(M(e,U),`Tile[${this.lij}] (${B}) bottom mid outside of plane ${e}`),c.internalAssert(M(e,V),`Tile[${this.lij}] (${B}) top mid outside of plane ${e}`)}c.internalAssert(N,"Not all convex hull points are inside  convex hull polyhedron"),c.internalAssert(I(U),`Tile[${this.lij}] (${B}) bottom mid outside of bounding sphere`),c.internalAssert(I(V),`Tile[${this.lij}] (${B}) top mid outside of bounding sphere`);for(let e=0;e<8;++e){const t=F(y,3*e);c.internalAssert(t,`Tile[${this.lij}] Convex hull point ${e} outside of bounding sphere`)}for(let e=0;e<6;++e)for(let t=0;t<8;++t){const r=3*t;P(e,y[r],y[r+1],y[r+2])||console.error(`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}const{extentInRadians:k}=this,z=Math.max(k[2]-k[0],k[3]-k[1]),j=Math.round(z*l),{renderData:G}=this;if(!G)return;const{geometry:q,geometryState:H,localOrigin:W}=G,$=q.vertexAttributes?.position;if(!$)return;const Q=i.create(),Z=q.numVerticesPerSide-2,{indices:Y,indexCount:X,edgeVerticesStartIndex:J,poleVerticesStartIndex:K}=q;if(!Y)return;const ee=new Set;for(let e=0;e<X;++e){const i=Y[e];if(ee.has(i))continue;ee.add(i);const n=i<K,a=i>=J;let c=!1,p=-1;if(a){let e=J;for(let t=0;t<4;++t){const r=H.edgeResolutions[t];if(i===e||i===e+r-1){c=!0;break}if(e+=r,i<e){p=t;break}}}const m=a?H.edgePeerNeighbors[p]:null,g=a&&m&&d.compareTilesByLij(this,m)>0;$.getVec(i,o),r.add(Q,o,W);const y=r.len(Q)-l;let _=0,b=!1;const v=u-y,w=y-h,x=v>1,S=w>1,T=x||S,M=()=>{const e=n?"internal":a&&!c?"edge":c?"corner":"pole";return`Tile[${this.lij}].vertex[${i}]:${e}`+(x?"(below)":S?"(above)":"")+(g?"(Neighbor)":"")},R=r.dist(Q,s);if(R>=t+0){const e=R-t;T||(console.error(`${M()} is out of the bounding sphere by ${e.toFixed(0)} / ${t.toFixed(0)}[tol=0] h=${y.toFixed(0)} / [${u.toFixed(0)}..${h.toFixed(0)}] (${(e/t).toFixed(0)})`),b=!0)}for(let e=0;e<6;++e)if(!P(e,Q[0],Q[1],Q[2])){const r=C(e,Q[0],Q[1],Q[2]),s=i%Z,n=(i-s)/Z;0===e&&v||5===e&&w||(console.error(`${M()} (${s},${n})|${Z}] is out of the bounding trapezoid plane ${e} h=${Math.round(y)} / [${Math.round(u)}..${Math.round(h)}] dist=${Math.round(r)} radii = ${Math.round(t)}/${Math.round(f)}} : maxL = ${j}`),++_)}if(b||_>0)break}}get convexHull(){return this._convexHull}}const p=[128,64,64,32,16,8,8,4];function f(e,t,r){return m(e[0],e[1],e[2],t[r],t[r+1],t[r+2])}function m(e,t,r,i,s,n){const o=i-e,a=s-t,l=n-r;return o*o+a*a+l*l}const g=(e,t,r,i)=>{const s=Math.cos(t),n=Math.sin(t),o=Math.cos(r),a=Math.sin(r);e[0]=i*o*s,e[1]=i*o*n,e[2]=i*a},y=[0,0,1],_=i.create(),b=i.create();e.SphericalPatch=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/projection/lonLatToSphericalPCPF":function(){define(["exports"],function(e){"use strict";e.lonLatToSphericalPCPF=function(e,t,r,i){const s=Math.cos(r);e[0]=Math.cos(t)*s*i,e[1]=Math.sin(t)*s*i,e[2]=Math.sin(r)*i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/SplitLimits":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";e.SplitLimits=class extends r{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}},t.__decorate([i.property()],e.SplitLimits.prototype,"fovX",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"fovY",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"relativeWidthLimit",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"relativeHeightLimit",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"maxLod",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"angledSplitBias",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"aboveGround",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"frustum",void 0),e.SplitLimits=t.__decorate([a.subclass("esri.views.3d.terrain.SplitLimits")],e.SplitLimits),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TerrainRenderer":function(){define(["exports","../../../chunks/tslib.es6","../../../Color","../../../core/has","../../../core/maybe","../../../core/MemCachePool","../../../core/ObjectPool","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/buffer/BufferView","./OverlayRenderer","./PatchRenderData","./TerrainAttributesCache","./terrainUtils","./TileRenderer","./tileUtils","../webgl-engine/collections/Component/ComponentIntersectionData","../webgl-engine/core/shaderLibrary/terrain/Overlay.glsl","../webgl-engine/effects/RenderPlugin","../webgl-engine/lib/Attribute","../webgl-engine/lib/IntersectorResult","../webgl-engine/lib/RayIntersections","../webgl-engine/lib/screenSizePerspectiveUtils","../webgl-engine/lib/verticalOffsetUtils","../webgl-engine/materials/DrawParameters","../../../chunks/Terrain.glsl","../webgl-engine/shaders/TerrainTechnique","../webgl-engine/shaders/TerrainTechniqueConfiguration","../../webgl/enums"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L){"use strict";const V=m.create();e.TerrainRenderer=class extends C.SyncRenderPlugin{get visibleTiles(){return Array.from(this._visiblePatchesByOrigin.values()).flat()}get _isGlobal(){return 1===this._stage.viewingMode}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,r,i,s,a){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=r,this._ellipsoidRadius=i,this._compressionTracker=s,this.type=2,this.isGround=!0,this._passParameters=new A.TerrainPassParameters,this._drawParameters=new F.DrawParameters,this._renderDataPool=new o(_.PatchRenderData),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new x.IteratorPreorder,this._castShadows=!1,this._inViewshed=!1,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=1,this.produces=new Map([[1,()=>this._produces()&&0===this.transparency],[6,()=>this._produces()&&(1===this.transparency||2===this.transparency)],[9,()=>this._produces()&&this.renderOccludedFlags===y.overlayRenderOccludedFlag]]),this._tileSize=256,this._configuration=new E.TerrainTechniqueConfiguration(1===t.viewingMode),this._tileTextureCache=new n.MemCachePool((e,t)=>a.newCache(e,t),"TileTexture"),this.tileGeometryCache=new b.TerrainAttributesCache(a)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(a.watch(()=>this._overlayRenderer.renderOccludedFlags,e=>{this.renderOccludedFlags=e,this.setNeedsRender()},a.sync))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy(),this._allTiles.prune(),this._tileRenderer=null}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?C.ConsumesDepth:C.ConsumesNone}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){this._tileRenderer?.updateHeading(e)}set transparency(e){this._configuration.transparencyMode!==e&&(this._configuration.transparencyMode=e,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(e){this._configuration.tileBorders!==e&&(this._configuration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(e){this._configuration.visualizeNormals!==e&&(this._configuration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(e){this._configuration.backfaceCullingEnabled!==e&&(this._configuration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}get layerViewUid(){return I.terrainId}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(e){this._configuration.hasSlicePlane!==e&&(this._configuration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._configuration.textureFadingEnabled!==e&&(this._configuration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._configuration.pbrMode!==e&&(this._configuration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._configuration.screenSizePerspective!==e&&(this._configuration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}set tileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._ensureRenderData(e),this.updateTileGeometryState(e),this.reuseTextureFromParent(e)||this.updateTileTexture(e,32)}reuseTextureFromParent(e){const t=e.parent;if(!t)return!1;const r=f.fromValues(1&e.lij[2]?.5:0,1&e.lij[1]?0:.5,.5,.5);return t.renderData?.reuseTexture(e.renderData,r)??!1}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,32===t?0:2),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const t of e.layerInfo[0])t.pendingUpdates&=-9;e.resetPendingUpdate(8);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.loaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return p.ZEROS;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=1){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=1){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=1){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new w.TileRenderer(this._rctx,this._tileSize,this._techniques,this._tileTextureCache,this._compressionTracker),this.updateTileBackground()}uninitializeRenderContext(){this._tileRenderer=s.disposeMaybe(this._tileRenderer)}intersect(e,t,r,i){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&0!==this.transparency)return;const s=U,n=B;h.subtract(s,i,r),h.set(n,1/s[0],1/s[1],1/s[2]);const o=e.results.min,a=e.results.max,l=e.results.ground,c=0===e.options.store,u=!!e.results.ground.target,d=I.getVerticalOffsetTerrain(e.verticalOffset),p=e.tolerance;let f,y=c&&null!=o.distance?o.distance:1/0;const _=e.options,b=_.normalRequired||!_.backfacesTerrain,v=new R.MeshIntersectionOptions(!1,b),w=u=>{const w=u.renderData;if(!w?.vao)return;const x=w.geometry;m.set(V,x.boundingBox);const T=w.localOrigin;null!=d&&(d.localOrigin=T,d.applyToAabb(V));const C=V;if(N[0]=r[0]-T[0],N[1]=r[1]-T[1],N[2]=r[2]-T[2],!R.intersectAabbInvDirBefore(C,N,n,p,y))return;const O=(e,t,r)=>{e.set(this.type,u,t,r),y=c&&null!=o.distance?o.distance:1/0},I=(n,c,u)=>{if((!b||null!=u)&&n>=0&&(_.backfacesTerrain||h.dot(u,s)<0)&&(_.invisibleTerrain||!_.selectionMode||null==t||t(r,i,n))){if((null==l.distance||n<l.distance)&&O(l,n,u),_.isFiltered)return;2===_.store&&(null==f?(f=new M.IntersectorResult(e.ray),O(f,n,u),e.results.all.push(f)):n<f.distance&&O(f,n,u)),(null==o.distance||n<o.distance)&&O(o,n,u),0!==_.store&&(null==a.distance||n>a.distance)&&O(a,n,u)}},F=k;h.subtract(F,i,T);const{indices:A,indexCount:D}=x,E=x.vertexAttributes,L=E.getField("position",g.BufferViewVec3f),U=new P.Vertices(L.typedBuffer,3,E.stride/4),B=D/3;if(!d&&B>S.componentMinimalSizeForIntersectionData){const e=u.renderData;null==e.intersectionData&&(e.intersectionData=new S.ComponentIntersectionData(A,0,B,U)),e.intersectionData.intersectRay(N,F,v,I)}else R.intersectTriangles(N,F,0,B,A,U,d,v,I)},x=this._rootTiles;null!=x&&(()=>{const t=this._tileIterator;t.reset(x);const i=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||i&&e.intersectsClippingArea)||null==d&&!e.intersectsRay(r,s,p,y)||u&&this._useStencilForTile(e)?t.skipSubtree():w(e)})()}processScaleRangeQueries(e,t){if(!t.done&&e)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const r of t)null!=r.renderData?.textureReference&&e.queriesForTile(r);e.process(),t.madeProgress()}}acquireTechniques(e){const t=!!i("enable-feature:terrain-shadows")&&e.bind.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);const r=e.bind.viewshedEnabled;if(this._inViewshed!==r&&(this._inViewshed=r,this._patchesByOriginDirty=!0),9===e.bind.slot){if(0===(e.renderOccludedMask&y.overlayRenderOccludedFlag))return null}else{const t=0===this.transparency?1:6;if(e.bind.slot!==t)return null}if(3===this.transparency)return null;const s=this._configuration;switch(s.screenSpaceReflections=s.cloudReflections=s.receiveShadows=s.receiveAmbientOcclusion=s.renderOccluded=s.hasHighlightMixTexture=!1,s.overlayMode=this._overlayRenderer.mode,e.output){case 0:case 1:{s.screenSpaceReflections=null!=e.bind.ssr.lastFrameColor,s.cloudReflections=null!=e.bind.clouds.data;const t=9===e.bind.slot;return s.receiveShadows=e.bind.shadowMap.ready&&!t,s.renderOccluded=t,s.receiveAmbientOcclusion=!t&&null!=e.bind.ssao,this._acquireTechnique(e.output)}case 4:case 6:return this._castShadows?this._acquireTechnique(4):null;case 7:return this._inViewshed?this._acquireTechnique(7):null;case 2:case 3:return this._acquireTechnique(e.output);case 9:return this._acquireTechnique(9);case 8:return s.hasHighlightMixTexture=null!=e.bind.highlightMixTexture,this._overlayRenderer.hasHighlights?this._acquireTechnique(8):null}return null}render(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,this._passParameters.overlayContent=T.getOverlayContentForOutputTerrain(e.output,e.bind),e.output){case 0:case 1:this._renderMaterialPass(e,t);break;case 2:case 3:case 9:this._renderAuxiliaryPass(e,t,this._visiblePatchesByOrigin);break;case 8:{const r=e.bind.highlight?.name;r&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(2)&&this._overlayRenderer.hasHighlight(r)&&this._renderAuxiliaryPass(e,t,this._visiblePatchesByOrigin);break}case 4:case 6:case 7:this._renderAuxiliaryPass(e,t,this._allPatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=r.toUnitRGBA(e);i=p.fromValues(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll(e=>t.updateTileTexture(e,0)),this._configuration.tileBlendInput=t.backgroundIsGrid?2:null!=t.backgroundColor?1:0,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const r of e)x.sortTiles(r,t);e.sort((e,t)=>x.compareTiles(e[0],t[0])),this._visiblePatchesByOrigin=new Map(e.map(e=>[e[0].renderData.localOrigin,e])),this.notifyChange("visibleTiles"),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),r=e.renderData;if(!r){this._numTilesCulled++;continue}const i=r.localOrigin;if(this._castShadows||this._inViewshed){let t=this._allPatchesByOrigin.get(i);t||(t=[],this._allPatchesByOrigin.set(i,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let s=this._visiblePatchesByOrigin.get(i);s||(s=[],this._visiblePatchesByOrigin.set(i,s)),s.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,r){const{rctx:i,bind:s}=e;i.bindTechnique(t,s,this._passParameters);const n=this._stencilEnabledLayerExtents.length>0;r.forEach(e=>{this._drawParameters.origin=e[0].renderData.localOrigin,t.program.bindDraw(s,this._passParameters,this._drawParameters);for(let r=0;r<e.length;r++)this._renderPatch(i,t,e[r],L.PrimitiveType.TRIANGLES,n,null===this._passParameters.overlayContent)}),i.bindVAO(null)}_renderMaterialPass(e,t){const{rctx:r,bind:i}=e;r.bindTechnique(t,i,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const s=i.camera,n=t.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){const e=O.getSettings(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:s.fovY})}const o=this._stencilEnabledLayerExtents.length>0,a=9===i.slot;a&&(n.bindTexture("tex",r.emptyTexture),n.setUniform3fv("textureOpacities",p.ZEROS),n.setUniform4fv("texOffsetAndScale",f.ZEROS));const l=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:p.ZEROS;1===this._configuration.tileBlendInput&&n.setUniform3fv("backgroundColor",l);const c=this.wireframe?L.PrimitiveType.LINES:L.PrimitiveType.TRIANGLES;this._configuration.textureFadingEnabled&&n.bindTexture("texNext",r.emptyTexture);const u=this._visiblePatchesByOrigin;for(const e of u.values()){const s=e[0].renderData.localOrigin;this._drawParameters.origin=s,t.program.bindDraw(i,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const i of e){const e=i.renderData,s=e.textureReference;if(null!=s){if(!a){n.setUniform4fv("texOffsetAndScale",s.offsetAndScale),n.bindTexture("tex",s.texture.texture);const t=e.textureFadeFactor,r=t<1?e.nextTextureReference:null;this._configuration.textureFadingEnabled&&r&&t<1?(n.setUniform1f("fadeFactor",t),n.setUniform4fv("nextTexOffsetAndScale",r.offsetAndScale),n.setUniform3fv("nextTexOpacities",r.opacities),n.bindTexture("texNext",r.texture.texture)):n.setUniform1f("fadeFactor",1),e.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",s.opacities)}this._renderPatch(r,t,i,c,o),i.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}r.bindVAO(null)}_renderPatch(e,t,r,i,s,n=!1){const o=r.renderData,a=o.vao,l=a?.indexBuffer;if(!a||null==l)return void(v.enableTerrainInternalChecks&&console.error("Rendered tile with no indices: ",r.lij," : ",o));const c=t.program;n||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(c,o.overlay),s&&(t.useStencil=this._useStencilForTile(r),e.setPipelineState(t.getPipeline()));const u=o.geometry.indexCount;e.bindVAO(a),c.assertCompatibleVertexAttributeLocations(a),e.drawElements(i,u,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_acquireTechnique(e){return this._configuration.output=e,this._techniques.get(D.TerrainTechnique,this._configuration)}get test(){}hasHighlight(e){return this._overlayRenderer.hasHighlight(e)}},t.__decorate([l.property({readOnly:!0})],e.TerrainRenderer.prototype,"visibleTiles",null),t.__decorate([l.property({readOnly:!0})],e.TerrainRenderer.prototype,"_isGlobal",null),t.__decorate([l.property()],e.TerrainRenderer.prototype,"renderOccludedFlags",void 0),t.__decorate([l.property({value:!1})],e.TerrainRenderer.prototype,"renderingDisabled",null),t.__decorate([l.property({value:!0})],e.TerrainRenderer.prototype,"visible",null),t.__decorate([l.property()],e.TerrainRenderer.prototype,"renderPatchBorders",null),t.__decorate([l.property()],e.TerrainRenderer.prototype,"visualizeNormals",null),t.__decorate([l.property()],e.TerrainRenderer.prototype,"cullBackFaces",null),t.__decorate([l.property()],e.TerrainRenderer.prototype,"wireframe",null),e.TerrainRenderer=t.__decorate([d.subclass("esri.views.3d.terrain.TerrainRenderer")],e.TerrainRenderer);const U=p.create(),B=p.create(),N=p.create(),k=p.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TerrainAttributesCache":function(){define(["exports","../../../core/MemCachePool","./TerrainAttributes"],function(e,t,r){"use strict";e.TerrainAttributesCache=class{constructor(e){this._storage=new t.MemCachePool((t,r)=>e.newCache(t,r),"TileGeometry")}acquire(e){const t=4*Math.ceil(e/4),i=this._storage,s=function(e){return e.toString()}(t),n=i.pop(s);if(n)return n;const o=r.layout.createBuffer(t);return o.release=()=>i.put(s,o),o}clear(){this._storage.clear()}destroy(){this._storage.destroy()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TerrainAttributes":function(){define(["exports","../support/buffer/InterleavedLayout"],function(e,t){"use strict";const r=t.newLayout().vec3f("position").vec2u16("uv0",{glNormalized:!0}).vec2i16("normalCompressed",{glNormalized:!0});e.layout=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TileRenderer":function(){define(["exports","../../../core/has","../../../core/maybe","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../layers/support/layerUtils","../support/flowUtils","./BlendLayersTechnique","./TerrainData","./terrainUtils","./TextureReference","./TileCompositor","./TileRenderInfo","./TileTexture","./tileUtils","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/lib/glUtil3D","../../support/TextureCompressionWorkerHandle","../../webgl/Texture","../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v){"use strict";class w{constructor(e,t,r,i,s,n){this.start=e,this.end=t,this.blendMode=r,this.opacity=i,this.output=s,this.baseOpacity=n}}function x(e,t,r){R.layerIndex=t,R.vtlNeighborInfos.clear();const s=e.layerInfo[1][t];if(i.set(R.offset,0,0),R.tile=e,R.scale=1,R.sourceLod=e.lij,R.sourceLayerInfo=s,R.isVTLBackground=r,s.data)return r&&e.forEachLoadedNeighbor((r,i)=>{if(r.level!==e.level)return;const n=r.layerInfo[1][t];if(!u.isVectorTilePerLayerInfo(n)||s.data===n.data)return;const o=R.vtlNeighborInfos.pushNew();o.offset=I[i],o.sourceLod=r.lij,o.sourceLayerInfo=n}),R;const n=s.upsampleInfo,o=n?.tile?.layerInfo[1][t];return o&&n.tile?(R.tile=n.tile,i.copy(R.offset,n.offset),R.scale=n.scale,R.sourceLod=n.tile.lij,R.sourceLayerInfo=o,R):r?R:null}function S(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}function T(e){let t="normal"!==e.blendMode;return o.isGroupLayer(e.parent)&&(t=T(e.parent)||t),t}function C(e,t){o.isGroupLayer(e.parent)&&C(e.parent,t);const r=e.uid;if(null!=r&&""!==r){const i=P.get(r);i?i.start=t:P.set(r,new w(t,t,e.blendMode,e.opacity,1,1))}}const P=new Map,M=new Array,R=new p.TileRenderInfo,O=n.fromValues(0,0,1,1),I=new Array;I[0]=[0,-1],I[1]=[-1,-1],I[2]=[-1,0],I[3]=[-1,1],I[4]=[0,1],I[5]=[1,1],I[6]=[1,0],I[7]=[1,-1],e.GroupInfo=w,e.TileRenderer=class{constructor(e,t,r,i,s){this._rctx=e,this.tileSize=t,this._techniques=r,this._cache=i,this._compressionTracker=s,this._passParameters=new l.BlendLayersPassParameters,this._backgroundColor=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new h.TileCompositor(this._rctx,this._techniques)}dispose(){this._compositor=r.disposeMaybe(this._compositor),this._backgroundTexture=r.releaseMaybe(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const r=e.surface,i=r.baseOpacity;let s=0,n=0,l=this.tileSize,c=!1,d=!1;const h=r.view.state.contentPixelRatio;let p=!1;P.clear(),M.length=0;const f=e.layerInfo[1];let g=0,y=null;for(;g<f.length;g++){const t=r.layerViewByIndex(g,1),_=t.layer,b=!m.fallsWithinLayerView(e,t),v=_.opacity,w=t.fullOpacity;if(d=d||o.isBaseLayer(_),a.isLayerViewWithFlowRenderer(t))continue;if(u.isBlendableLayerView(t)){let e="normal"!==t.layer.blendMode;if(o.isGroupLayer(_.parent)){const t=_.parent.uid;null!=t&&""!==t&&(e=T(_.parent)||e)}e&&(p=e,c=!1)}if((b||0===v)&&!p){f[g].pendingUpdates&=-1;continue}++n;const S=u.isVectorTileLayerView(t),P=x(e,g,S);if(P){if(f[g].pendingUpdates&=-1,o.isGroupLayer(_.parent)){const e=_.parent.uid;null!=e&&""!==e&&C(_.parent,g)}S?l=Math.max(l,this.tileSize*h):1===i&&1===w&&(t.isOpaque||this._dataToTexture(P,o.isReferenceLayer(_))&&P.sourceLayerInfo.data.descriptor.isOpaque)&&(c=!0),++s,null===y&&(y=g)}}const _=l/this.tileSize;0!==s&&null!==y?1===s&&!p&&this._useLayerTexture(e,y)||this._composeLayers(e,t,g-1,d,l,_,!c||p,P,p):this._useBackgroundTexture(e,n,0!==t)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundTexture&&this._drawBackgroundTexture(this._backgroundTexture))}_ensureBackgroundTexture(){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(this.tileSize,!1),this._drawBackgroundTexture(this._backgroundTexture)),this._backgroundTexture}_drawBackgroundTexture(e){this._compositor.bind(this.tileSize),this._passParameters.offset=s.ZEROS,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(e),this._compositor.unbind()}_useBackgroundTexture(e,t,r){const i=e.renderData,s=!r&&null!=i.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?5e3:0,n=this._ensureBackgroundTexture();i.setTextureReference(new d.TextureReference(n,0,O,e.surface.baseOpacity,0,1),s)}_useLayerTexture(e,t){const r=e.surface.layerViewByIndex(t,1),i=o.isBaseLayer(r.layer),s=i?e.surface.baseOpacity:1,a=i?1:e.surface.baseOpacity,l=r.fullOpacity,c=x(e,t,!1);return!!this._dataToTexture(c,o.isReferenceLayer(r.layer))&&(e.renderData.setTextureReference(new d.TextureReference(c.sourceLayerInfo.data,0,n.fromValues(c.offset[0],c.offset[1],c.scale,c.scale),s,a,l)),!0)}_composeLayers(e,t,r,i,n,l,c,h,p){this._compositor.ensureBuffer(n);const f=e.surface.baseOpacity;let y=!1,_=9987,b=!1,v=0;for(let t=r;t>=0;t--){const r=e.surface.layerViewByIndex(t,1),d=r.layer,w=u.isVectorTileLayerView(r),T=x(e,t,w),C=d.opacity,P=!m.fallsWithinLayerView(e,r);if(!T||(0===C||P)&&!p)continue;if(a.isLayerViewWithFlowRenderer(r))continue;const R=!o.isBaseLayer(d)&&!y;R&&(y=!0);let O=!1;h.forEach(e=>{e.start===t&&(e.output=i?1:c&&R?this.backgroundIsGrid?3:2:1,e.baseOpacity=R?f:1,M.push(e),this._compositor.openGroup(n),O=!0)});const I=O?4:c&&0===v?this.backgroundIsGrid?3:2:1,F=g.blendModeFromString[u.isBlendableLayerView(r)?r.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=R&&!O&&f<1?f:1,this._passParameters.opacity=C,u.isVectorTileRenderInfo(T)?b=this._compositor.drawVectorData(this._passParameters,I,n,F,T,l,this.tileSize,b):u.isImageryTileRenderInfo(T)?(this._compositor.drawRasterData(this._passParameters,I,n,F,T),S(T)&&(_=9728)):this._dataToTexture(T,o.isReferenceLayer(d))&&(this._passParameters.texture=T.sourceLayerInfo.data.texture,this._passParameters.offset=T.offset,this._passParameters.scale=T.scale,this._compositor.drawImageData(this._passParameters,I,n,F));M.length>0&&M[M.length-1].end===t;){const e=M.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=s.ZEROS,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,e.output,n,g.blendModeFromString[e.blendMode])}v++}const w=e.renderData,T=p||y&&f<1,C=w.ensureTexture(n,T,t,()=>this._buildTexture(n,T,_));this._compositor.copyFBOToTexture(C),this._compositor.unbind(),w.setTextureReference(new d.TextureReference(C,t,O,y?1:f,0,1))}_dataToTexture(e,t){if(u.isImageSourceRenderInfo(e)){const r=e.sourceLayerInfo,i=1===e.scale&&!t;r.data=this._buildTexture(r.data,!0,i,e.tile.onCompressionFinished),e.tile.setMemoryDirty()}return u.isTextureTileRenderInfo(e)}_buildTexture(e,t,r=9987,i=()=>{}){if(null==e)return null;const s=new v.TextureDescriptor;s.wrapMode=33071,s.samplingMode="boolean"==typeof r?9987:r,s.maxAnisotropy=this._maxAnisotropy,s.preMultiplyAlpha=!0,s.flipped=!0,s.hasMipmap=!0,t||(s.pixelFormat=6407);const n=this._rctx,o="boolean"==typeof r&&r;let a;if("number"==typeof e)s.width=s.height=e,a=this._buildTileTexture(s);else if(c.isImageWithType(e))s.isOpaque=e.isOpaque,s.isOpaque&&(s.pixelFormat=6407),s.width=e.element.width,s.height=e.element.height,a=this._buildTileTexture(s,o,i,e.element);else try{s.width=e.width,s.height=e.height,a=this._buildTileTexture(s,o,i,e)}catch(e){a=new f.TileTexture(y.createEmptyTexture(n)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const l=n.bindTexture(a.texture,b.Texture.TEXTURE_UNIT_FOR_UPDATES);return a.generateMipmap(),n.bindTexture(l,b.Texture.TEXTURE_UNIT_FOR_UPDATES),a}_buildTileTexture(e,t=!1,r=()=>{},i){const s=this._cache.pop(f.getCacheKey(e,!1))??this._cache.pop(f.getCacheKey(e,!0));if(t&&=_.isCompressible(i,e),s)return s.retain(),t?s.texture.enableCompression({compressionTracker:this._compressionTracker,compressionCallback:r}):s.texture.disableCompression(),s.texture.setData(i),s;e.compress=t?{compressionTracker:this._compressionTracker,compressionCallback:r}:void 0;const n=new b.Texture(this._rctx,e,i);return new f.TileTexture(n,this._cache)}get test(){}},e.cleanupTileRenderer=function(){R.sourceLayerInfo=null,R.tile=null,R.vtlNeighborInfos.prune()},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/flowUtils":function(){define(["exports","../../../layers/support/layerUtils"],function(e,t){"use strict";e.isLayerViewWithFlowRenderer=function(e){return t.isLayerWithFlowRenderer(e.layer)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/BlendLayersTechnique":function(){define(["require","exports","../../../core/libs/gl-matrix-2/factories/vec3f64","../webgl-engine/core/shaderLibrary/terrain/TileComposite.glsl","../../../chunks/BlendLayers.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../webgl-engine/lib/DefaultVertexBufferLayouts","../../webgl/VertexAttributeLocations"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends i.TileCompositePassParameters{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=r.ZEROS}}class u extends o.ShaderTechnique{constructor(t,r){super(t,r,new n.ReloadableShaderModule(s.BlendLayers,()=>new Promise((t,r)=>e(["../webgl-engine/core/shaderLibrary/util/BlendLayers.glsl"],t,r))),l.fromLayout(a.Pos2TexF16))}}t.BlendLayersPassParameters=c,t.BlendLayersTechnique=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/TileComposite.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/vec2f64","../../shaderModules/Float2PassUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../../../../webgl/NoParameters"],function(e,t,r,i,s,n){"use strict";class o extends n.NoParameters{constructor(){super(...arguments),this.scale=1,this.offset=t.ZEROS}}e.TileComposite=function(e){e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.uniforms.add(new i.FloatPassUniform("scale",e=>e.scale),new r.Float2PassUniform("offset",e=>e.offset)).main.add(s.glsl`gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;`)},e.TileCompositePassParameters=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/BlendLayers.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/terrain/BackgroundGrid.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/TileComposite.glsl","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l){"use strict";function c(e){const c=new l.ShaderBuilder,u=c.fragment;if(c.include(i.TileComposite),1===e.background){const r=2===e.output;return r?u.uniforms.add(new s.Float3PassUniform("backgroundColor",e=>e.backgroundColor)):u.include(t.BackgroundGrid),u.main.add(o.glsl`fragColor = vec4(${r?o.glsl`backgroundColor`:o.glsl`gridColor(uv)`}, 1.0);`),c}return c.include(r.TileBackground,e),u.uniforms.add(new a.Texture2DPassUniform("tex",e=>e.texture),new n.FloatPassUniform("opacity",e=>e.opacity)),u.main.add(o.glsl`fragColor = blendLayers(uv, texture(tex, uv), opacity);`),c}const u=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}));e.BlendLayers=u,e.build=c})},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/BackgroundGrid.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.BackgroundGrid=function(e){e.code.add(t.glsl`
    float lineFactorAtPosition(float value) {
      float pos = value * ${t.glsl.float(257)};
      if(pos < 0.5 || pos > ${t.glsl.float(256.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl":function(){define(["exports","../../../../../../core/has","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","./BackgroundGrid.glsl","../util/BlendModes.glsl","../../shaderModules/Float3PassUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform","../../../../../webgl/NoParameters"],function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends c.NoParameters{constructor(){super(...arguments),this.baseOpacity=1,this.backgroundColor=r.ZEROS,this.fboTexture=null}}e.TileBackground=function(e,t){const{output:r,blendMode:c,baseOpacityMode:u,premultipliedSource:d}=t,h=e.fragment,p=1===u;p&&h.uniforms.add(new o.FloatPassUniform("baseOpacity",e=>e.baseOpacity));const f=0!==c,m=!(f||1===d||(1!==r||p)&&4!==r);h.include(s.BlendModes,t);let g="";switch(r){case 4:case 0:g=a.glsl`vec4(0.0)`;break;case 2:h.uniforms.add(new n.Float3PassUniform("backgroundColor",e=>e.backgroundColor)),g=a.glsl`vec4(backgroundColor, 1.0)`;break;case 3:h.include(i.BackgroundGrid),g=a.glsl`vec4(gridColor(uv), 1.0)`;break;case 1:h.uniforms.add(new l.Texture2DPassUniform("fboColor",e=>e.fboTexture)),g=a.glsl`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`}h.code.add(a.glsl`
    vec4 getBackground(vec2 uv) {
      return ${a.If(p,a.glsl`baseOpacity *`)} ${g};
    }

    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {
      ${f?a.glsl`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec4 bgColor = getBackground(bgUV);
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:a.glsl`
          float composeAlpha = colorLayer.a * opacity;
          ${m?a.glsl`return colorLayer * opacity;`:a.glsl`
            vec4 bgColor = getBackground(bgUV);
            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)},e.TileBackgroundPassParameters=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/BlendModes.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.BlendModes=function(e,r){const i=r.blendMode;0!==i&&(30===i&&e.code.add(t.glsl`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),6!==i&&13!==i||e.code.add(t.glsl`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),9!==i&&13!==i||e.code.add(t.glsl`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),10===i&&e.code.add(t.glsl`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),12===i&&e.code.add(t.glsl`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),11===i&&e.code.add(t.glsl`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),13===i&&e.code.add(t.glsl`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),14!==i&&15!==i&&17!==i&&16!==i||(e.code.add(t.glsl`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),14!==i&&15!==i||e.code.add(t.glsl`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),e.code.add(t.glsl`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${8===i?t.glsl`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:1===i?t.glsl`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:2===i?t.glsl`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:7===i?t.glsl`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:3===i?t.glsl`return vec4(cl * ol + cb * ob, ol + ob);`:4===i?t.glsl`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:28===i?t.glsl`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:5===i?t.glsl`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:26===i?t.glsl`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:29===i?t.glsl`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:18===i?t.glsl`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:19===i?t.glsl`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:21===i?t.glsl`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:22===i?t.glsl`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:24===i?t.glsl`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:25===i?t.glsl`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:20===i?t.glsl`return vec4(cb * ob * ol, ol * ob);`:23===i?t.glsl`return vec4(cl * ol * ob, ol * ob);`:14===i?t.glsl`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:15===i?t.glsl`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:17===i?t.glsl`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:16===i?t.glsl`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:27===i?t.glsl`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:30===i?t.glsl`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:6===i?t.glsl`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:9===i?t.glsl`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:10===i?t.glsl`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:11===i?t.glsl`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:12===i?t.glsl`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:13===i?t.glsl`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t.glsl``}
    }
  `))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TileCompositor":function(){define(["exports","../../../core/Logger","../../../core/maybe","../../../core/libs/gl-matrix-2/factories/vec2f64","../../2d/engine/vectorTiles/VectorTileRendererHelper3D","./BlendLayersTechnique","./BlendLayersTechniqueConfiguration","./RasterColorizerTechnique","./RasterColorizerTechniqueConfiguration","./support/MultiSizeFramebuffer","../webgl-engine/lib/BindParameters","../webgl-engine/lib/glUtil3D","../../webgl/enums","../../webgl/Texture"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";e.TileCompositor=class{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new s.VectorTileRendererHelper3D,this._bindParameters=new u.BindParameters(null),this._blendConfiguration=new o.BlendLayersTechniqueConfiguration,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vao=d.createQuadVAO(this._rctx,1)}dispose(){this._fbos.forEach(r.disposeMaybe),this._fbos=null,this._vtFBO=r.disposeMaybe(this._vtFBO),this._vao=r.disposeMaybe(this._vao),this._vectorTileHelper=r.disposeMaybe(this._vectorTileHelper)}updateHeading(e){this._vectorTileHelper?.updateHeading(e)}_acquireBlendTechnique(e,t,r,i=0,s=0){return this._blendConfiguration.output=t,this._blendConfiguration.blendMode=e,this._blendConfiguration.baseOpacityMode=r,this._blendConfiguration.premultipliedSource=i,this._blendConfiguration.background=s,this._techniques.precompile(n.BlendLayersTechnique,this._blendConfiguration),this._techniques.get(n.BlendLayersTechnique,this._blendConfiguration)}drawBackground(e,t){const r=this._acquireBlendTechnique(0,t?2:3,0,0,1),i=this._rctx.bindTechnique(r,this._bindParameters,e);this._render(i)}_render(e){this._rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),this._rctx.drawArrays(h.PrimitiveType.TRIANGLE_STRIP,0,this._vao.vertexCount("geometry"))}drawGroup(e,t,r,i,s=1){1===t&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(r).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture)),e.texture=this.currentFBO(r).colorTexture,this.closeGroup(r);const n=e.baseOpacity<1?1:0,o=this._acquireBlendTechnique(i,t,n,s),a=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(a)}drawImageData(e,t,r,i,s=0){if(null==e.texture)return;const n=e.baseOpacity<1?1:0;e.fboTexture=4===t||0===i&&0===n&&0===s?null:this.switch(r).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture);const o=this._acquireBlendTechnique(i,t,n,s),a=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(a)}drawRasterData(e,t,r,i,s){const n=s.sourceLayerInfo.data;if(!n.source)return;if(s.tile.surface.layerViewByIndex(s.layerIndex,1).ensureSymbolizerParameters(n),!n.bind(this._rctx))return;const o=e.baseOpacity<1?1:0;e.fboTexture=0===i&&0===o?null:this.switch(r).colorTexture;const a=this._acquireRasterTechnique(n,t,i,o);if(!a)return;n.opacity=e.opacity;const l=n.getUniforms(this._rctx);l.scale=s.scale,l.offset=s.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;const c=this._rctx.bindTechnique(a,this._bindParameters,l);this._render(c)}_acquireRasterTechnique(e,t,r,i){if(!this._rctx.capabilities.colorBufferFloat)return null;const s=e.symbolizerParameters,n=["stretch","lut","hillshade"].indexOf(s.type);return this._rasterConfiguration??=new l.RasterColorizerTechniqueConfiguration,this._rasterConfiguration.output=t,this._rasterConfiguration.blendMode=r,this._rasterConfiguration.baseOpacityMode=i,this._rasterConfiguration.colorizerType=n,this._rasterConfiguration.applyColormap=!!s.colormap,this._rasterConfiguration.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterConfiguration.stretchType=e.hasStretchTypeNone()?0:1,this._techniques.precompile(a.RasterColorizerTechnique,this._rasterConfiguration),this._techniques.get(a.RasterColorizerTechnique,this._rasterConfiguration)}drawVectorData(e,r,s,n,o,a,l,u){const d=this._rctx,h=o.sourceLayerInfo.data,p=o.tile.surface.layerViewByIndex(o.layerIndex,1),f=e.baseOpacity<1?1:0,m=1===f||e.opacity<1||0!==n||1!==r,g=m?1:0,y=this._acquireBlendTechnique(n,r,f,g);d.setPipelineState(y.getPipeline());let _=null,b=null;m?(b=this.currentFBO(s),null==this._vtFBO&&(this._vtFBO=new c.MultiSizeFramebuffer(this._rctx)),_=this._vtFBO.get(s),d.bindFramebuffer(_),this._clearCurrentFBO()):u&&d.clear(256);try{this._vectorTileHelper.renderBackground(d,o.sourceLod,p.painter,p.layer.styleRepository,p.schemaHelper,Math.round(1/o.scale),o.offset,l,a,p.contentZoom),h&&this._vectorTileHelper.renderContent(d,o.sourceLod,h,o.vtlNeighborInfos,p.painter,p.layer.styleRepository,p.schemaHelper,Math.round(1/o.scale),o.offset,l,a,p.contentZoom)}catch(e){t.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",e)}return!_||(d.bindFramebuffer(b),e.texture=_.colorTexture,e.offset=i.ZEROS,e.scale=1,this.drawImageData(e,r,s,n,g),u)}copyFBOToTexture(e){const t=this._rctx,r=t.bindTexture(e.texture,p.Texture.TEXTURE_UNIT_FOR_UPDATES),i=e.descriptor;t.gl.copyTexImage2D(3553,0,i.pixelFormat,0,0,i.width,i.height,0),e.generateMipmap(),t.bindTexture(r,p.Texture.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(17664)}_initFBO(e,t,r){this._rctx.bindFramebuffer(e),r&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,r=!0){if(this._current=t,t>=this._fbos.length)for(let e=this._fbos.length;e<=t;e++)this._fbos.push(new c.MultiSizeFramebuffer(this._rctx));this._initFBO(this._fbos[t].get(e),e,r)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),r=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(r),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/vectorTiles/VectorTileRendererHelper3D":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/common","../../tiling/TileInfoView","../../tiling/TileKey","../../tiling/TileQueue","../../tiling/TileStrategy","./constants","./decluttering/jobsUtil","../webgl/RenderableTile","../webgl/TileReshuffleManager"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=r.create(),this.displayViewMat3=r.create(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}}e.VectorTileRendererHelper3D=class{constructor(){this._renderParams={reshuffleManager:new d.TileReshuffleManager,context:null,drawPhase:1,state:new h,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new u.RenderableTile(new n(0,0,0,0),0,0,0,l.tilePixelSize,l.tilePixelSize,l.tileCoordSize,l.tileCoordSize),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,r,i,s,n,o,a,l,c){const u=this._backgroundTile;this._updateRenderParameters(e,t,u,r,s,n,o,a,l,c),this._renderParams.stencilSymbols=!1,r.drawBackground(this._renderParams,u,i)}renderContent(e,t,r,i,s,n,o,a,l,c,u,d){this._declutter(r),i.forAll(({sourceLayerInfo:{data:e}})=>this._declutter(e));const h=i.length>0;h&&this._stencilSymbols(e,t,r,i,s,n,o,a,l,c,u,d);let p=1;r.stencilRef=h?p:0,e.setStencilFunction(514,r.stencilRef,255),this._render(e,t,r,s,n,o,a,l,c,u,d),i.forAll(({sourceLod:t,offset:r,sourceLayerInfo:{data:i}})=>{i.stencilRef=++p,this._renderSymbols(e,t,i,s,n,o,a,r,c,u,d)})}_stencilSymbols(e,t,r,i,s,n,o,a,l,c,u,d){let h=1;r.stencilRef=h,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,r.stencilRef,255),this._stencilTileSymbols(e,t,r,s,n,o,a,l,c,u,d),i.forAll(({sourceLod:t,offset:r,sourceLayerInfo:{data:i}})=>{i.stencilRef=++h,e.setStencilFunction(519,i.stencilRef,255),this._stencilTileSymbols(e,t,i,s,n,o,a,r,c,u,d)}),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,r,i,s,n,o,a,l,c,u){e.setStencilFunction(514,r.stencilRef,255),this._render(e,t,r,i,s,n,o,a,l,c,u,3)}_render(e,t,r,i,s,n,o,a,l,c,u,d){this._updateRenderParameters(e,t,r,i,n,o,a,l,c,u),this._renderParams.stencilSymbols=!1,i.drawTile(this._renderParams,r,s,d)}_stencilTileSymbols(e,t,r,i,s,n,o,a,l,c,u){this._updateRenderParameters(e,t,r,i,n,o,a,l,c,u),this._renderParams.stencilSymbols=!0,r.triangleCount=0,i.drawSymbols(this._renderParams,r,s)}_updateRenderParameters(e,r,s,n,o,a,c,u,d,h){"type"in s&&"vector-tile"===s.type&&!s.stage&&s.attachWithContext(e);const p=r[0]-o.getLevelShift(r[0]),f=this._renderParams;f.context=e,f.painter=n,f.glyphMosaic=n.glyphMosaic,f.spriteMosaic=n.spriteMosaic,f.pixelRatio=d*h,f.displayLevel=p,f.requiredLevel=p;const m=o.getScale(r[0]),[g,y]=o.getOffset(r,a*m),_=l.tileCoordinateScale*a*m/u,b=s.transforms.displayViewScreenMat3;b[0]=_,b[4]=-_,b[6]=-1-g-c[0]*a*2,b[7]=1+y+(1-c[1])*a*2-2;const v=f.state,w=u/h;v.size[0]=w,v.size[1]=w,v.pixelRatio=h,v.rotation=(360-this._heading)%360;const x=2/w;t.set(v.displayViewMat3,x,0,0,0,-x,0,-1,1,1);const S=t.identity(v.displayMat3),T=i.toRadian(this._heading);t.translate(S,S,[w/2,w/2]),t.rotate(S,S,T),t.translate(S,S,[-w/2,-w/2]),t.multiply(S,v.displayViewMat3,S)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(c.declutterSingleTile(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/tiling/TileInfoView":function(){define(["../../../geometry/support/spatialReferenceUtils","./LODInfo","./TileCoverage","./TileKey","./TileSpan"],function(e,t,r,i,s){"use strict";const n=new i("0/0/0/0");class o{static create(e,t){e[1]>t[1]&&([e,t]=[t,e]);const[r,i]=e,[s,n]=t,a=s-r,l=n-i,c=0!==l?a/l:0,u=(Math.ceil(i)-i)*c,d=(Math.floor(i)-i)*c;return new o(r,Math.floor(i),Math.ceil(n),c,a<0?u:d,a<0?d:u,a<0?s:r,a<0?r:s)}constructor(e,t,r,i,s,n,o,a){this.x=e,this.ymin=t,this.ymax=r,this.invM=i,this.leftAdjust=s,this.rightAdjust=n,this.leftBound=o,this.rightBound=a}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}const a=[[0,0],[0,0],[0,0],[0,0]];return class{constructor(e,r=null,i=e.lods[0].level,s=e.lods[e.lods.length-1].level){this.tileInfo=e,this.fullExtent=r,this.scales=[],this._infoByScale={},this._infoByLevel={};const n=e.lods.filter(e=>e.level>=i&&e.level<=s);this.minScale=n[0].scale,this.maxScale=n[n.length-1].scale;const o=this._lodInfos=n.map(i=>t.create(e,i,r));n.forEach((e,t)=>{this._infoByLevel[e.level]=o[t],this._infoByScale[e.scale]=o[t],this.scales[t]=e.scale},this),this._wrap=e.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(e){return this._infoByLevel["number"==typeof e?e:e.level]}getTileBounds(e,t,r=!1){n.set(t);const i=this._infoByLevel[n.level];return i?i.getTileBounds(e,n,r):e}getTileCoords(e,t,r=!1){n.set(t);const i=this._infoByLevel[n.level];return i?i.getTileCoords(e,n,r):e}getTileCoverage(e,t=192,i=!0,n="closest"){if(!i&&(e.scale>this.minScale||e.scale<this.maxScale))return null;const l="closest"===n?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),c=r.pool.acquire(l),u=this._wrap;let d,h,p,f=1/0,m=-1/0;const g=c.spans;a[0][0]=a[0][1]=a[1][1]=a[3][0]=-t,a[1][0]=a[2][0]=e.size[0]+t,a[2][1]=a[3][1]=e.size[1]+t;for(const t of a)e.toMap(t,t),t[0]=l.getColumnForX(t[0]),t[1]=l.getRowForY(t[1]);const y=[];let _=3;for(let e=0;e<4;e++){if(a[e][1]===a[_][1]){_=e;continue}const t=o.create(a[e],a[_]);f=Math.min(t.ymin,f),m=Math.max(t.ymax,m),void 0===y[t.ymin]&&(y[t.ymin]=[]),y[t.ymin].push(t),_=e}if(null==f||null==m||m-f>100)return null;let b=[];for(d=f;d<m;){null!=y[d]&&(b=b.concat(y[d])),h=1/0,p=-1/0;for(let e=b.length-1;e>=0;e--){const t=b[e];h=Math.min(h,t.getLeftCol()),p=Math.max(p,t.getRightCol())}if(h=Math.floor(h),p=Math.floor(p),d>=l.first[1]&&d<=l.last[1])if(u)if(l.size[0]<l.worldSize[0]){const e=Math.floor(p/l.worldSize[0]);for(let t=Math.floor(h/l.worldSize[0]);t<=e;t++)g.push(new s(d,Math.max(l.getFirstColumnForWorld(t),h),Math.min(l.getLastColumnForWorld(t),p)))}else g.push(new s(d,h,p));else h>l.last[0]||p<l.first[0]||(h=Math.max(h,l.first[0]),p=Math.min(p,l.last[0]),g.push(new s(d,h,p)));d+=1;for(let e=b.length-1;e>=0;e--){const t=b[e];t.ymax>=d?t.incrRow():b.splice(e,1)}}return c}getTileParentId(e){n.set(e);const t=this._infoByLevel[n.level],r=this._lodInfos.indexOf(t)-1;return r<0?null:(this._getTileIdAtLOD(n,this._lodInfos[r],n),n.id)}getTileResolution(e){const t=this._infoByLevel["object"==typeof e?e.level:e];return t?t.resolution:-1}getTileScale(e){const t=this._infoByLevel[e.level];return t?t.scale:-1}intersects(e,t){n.set(t);const r=this._infoByLevel[n.level],i=e.lodInfo;if(i.resolution>r.resolution){this._getTileIdAtLOD(n,i,n);const t=i.denormalizeCol(n.col,n.world);for(const r of e.spans)if(r.row===n.row&&r.colFrom<=t&&r.colTo>=t)return!0}if(i.resolution<r.resolution){const[t,s,o,a]=e.spans.reduce((e,t)=>(e[0]=Math.min(e[0],t.row),e[1]=Math.max(e[1],t.row),e[2]=Math.min(e[2],t.colFrom),e[3]=Math.max(e[3],t.colTo),e),[1/0,-1/0,1/0,-1/0]),l=r.denormalizeCol(n.col,n.world),c=i.getColumnForX(r.getXForColumn(l)),u=i.getRowForY(r.getYForRow(n.row)),d=i.getColumnForX(r.getXForColumn(l+1))-1,h=i.getRowForY(r.getYForRow(n.row+1))-1;return!(c>a||d<o||u>s||h<t)}const s=i.denormalizeCol(n.col,n.world);return e.spans.some(e=>e.row===n.row&&e.colFrom<=s&&e.colTo>=s)}normalizeBounds(t,r,i){if(t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],this._wrap){const r=e.getInfo(this.tileInfo.spatialReference),s=-i*(r.valid[1]-r.valid[0]);t[0]+=s,t[2]+=s}return t}getSmallestInfoForScale(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(let r=1;r<t.length-1;r++)if(e>t[r]+1e-6)return this._infoByScale[t[r-1]];return this._infoByScale[t[t.length-1]]}getClosestInfoForScale(e){const t=this.scales;return this._infoByScale[e]||(e=t.reduce((t,r)=>Math.abs(r-e)<Math.abs(t-e)?r:t,t[0])),this._infoByScale[e]}scaleToLevel(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let r=t.length-1;r>=0;r--)if(e<t[r])return r===t.length-1?this._infoByScale[t[t.length-1]].level:this._infoByScale[t[r]].level+(t[r]-e)/(t[r]-t[r+1]);return this._infoByScale[t[0]].level}scaleToZoom(e){return this.tileInfo.scaleToZoom(e)}zoomToScale(e){return this.tileInfo.zoomToScale(e)}_getTileIdAtLOD(e,t,r){const i=this._infoByLevel[r.level];return e.set(r),t.resolution<i.resolution?null:(t.resolution===i.resolution||(e.level=t.level,e.col=Math.floor(r.col*i.resolution/t.resolution+.01),e.row=Math.floor(r.row*i.resolution/t.resolution+.01)),e)}}})},"esri/views/2d/tiling/LODInfo":function(){define(["../../../geometry/support/spatialReferenceUtils","./TileKey"],function(e,t){"use strict";function r(e,t){return[e,t]}function i(e,t,r){return e[0]=t,e[1]=r,e}const s=new t("0/0/0/0");class n{static create(t,s,o=null){const a=e.getInfo(t.spatialReference),l=s.origin||r(t.origin.x,t.origin.y),c=r(t.size[0]*s.resolution,t.size[1]*s.resolution),u=r(-1/0,-1/0),d=r(1/0,1/0),h=r(1/0,1/0);null!=o&&(i(u,Math.max(0,Math.floor((o.xmin-l[0])/c[0])),Math.max(0,Math.floor((l[1]-o.ymax)/c[1]))),i(d,Math.max(0,Math.floor((o.xmax-l[0])/c[0])),Math.max(0,Math.floor((l[1]-o.ymin)/c[1]))),i(h,d[0]-u[0]+1,d[1]-u[1]+1));const{cols:p,rows:f}=s;let m,g,y,_;return!o&&p&&f&&(i(u,p[0],f[0]),i(d,p[1],f[1]),i(h,p[1]-p[0]+1,f[1]-f[0]+1)),t.isWrappable?(m=r(Math.ceil(Math.round((a.valid[1]-a.valid[0])/s.resolution)/t.size[0]),h[1]),g=!0,y=a.origin,_=a.valid):(m=h,g=!1),new n(s.level,s.resolution,s.scale,l,u,d,h,c,m,g,y,_)}constructor(e,t,r,i,s,n,o,a,l,c,u,d){this.level=e,this.resolution=t,this.scale=r,this.origin=i,this.first=s,this.last=n,this.size=o,this.norm=a,this.worldSize=l,this.wrap=c,this._spatialReferenceOrigin=u,this._spatialReferenceValid=d}normalizeCol(e){if(!this.wrap)return e;const t=this.worldSize[0];return e<0?t-1-Math.abs((e+1)%t):e%t}normalizeKey(e){if(!this.wrap)return;const t=this.worldSize[0],r=e.col;r<0?(e.col=r+t,e.world-=1):r>=t&&(e.col=r-t,e.world+=1)}denormalizeCol(e,t){return this.wrap?this.worldSize[0]*t+e:e}getWorldForColumn(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}getFirstColumnForWorld(e){return e*this.worldSize[0]+this.first[0]}getLastColumnForWorld(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(e){return(e-this.origin[0])/this.norm[0]}getXForColumn(e){const t=this.origin[0]+e*this.norm[0],r=this._spatialReferenceOrigin,i=this._spatialReferenceValid;return this.wrap&&r&&i?t===r[0]?i[0]:this.origin[0]===r[0]&&e===this.worldSize[0]?i[1]:t:t}getRowForY(e){return(this.origin[1]-e)/this.norm[1]}getYForRow(e){return this.origin[1]-e*this.norm[1]}getTileBounds(e,t,r=!1){s.set(t);const i=r?s.col:this.denormalizeCol(s.col,s.world),n=s.row;return function(e,t,r,i,s){e[0]=t,e[1]=r,e[2]=i,e[3]=s}(e,this.getXForColumn(i),this.getYForRow(n+1),this.getXForColumn(i+1),this.getYForRow(n)),e}getTileCoords(e,t,r=!1){s.set(t);const n=r?s.col:this.denormalizeCol(s.col,s.world);return Array.isArray(e)?i(e,this.getXForColumn(n),this.getYForRow(s.row)):(e.x=this.getXForColumn(n),e.y=this.getYForRow(s.row)),e}}return n})},"esri/views/2d/tiling/TileKey":function(){define(["../../../core/ObjectPool"],function(e){"use strict";class t{static{this.pool=new e(t,null,null,25,50)}static getId(e,t,r,i){return"object"==typeof e?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${t}/${r}/${i}`}constructor(e,t,r,i){this.set(e,t,r,i)}get key(){return this}get id(){return this.toString()}get normalizedId(){return`${this.level}/${this.row}/${this.col}`}set id(e){this.set(e)}get hash(){const e=4095&this.row,t=4095&this.col,r=63&this.level;return(3&this.world)<<30|t<<22|e<<8|r}acquire(e,t,r,i){this.set(e,t,r,i)}contains(e){const t=e.level-this.level;return t>=0&&this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}containsChild(e){const t=e.level-this.level;return t>0&&this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new t(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,t,r,i){if(null==e)this.level=0,this.row=0,this.col=0,this.world=0;else if("object"==typeof e)this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if("string"==typeof e){const[t,r,i,s]=e.split("/");this.level=parseFloat(t),this.row=parseFloat(r),this.col=parseFloat(i),this.world=parseFloat(s)}else this.level=+e,this.row=+t,this.col=+r,this.world=+i||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new t(this.level-1,this.row>>1,this.col>>1,this.world)}getNormalizedNeighbor(e,t,r){const i=this.clone();return i.col+=e,i.row+=t,r.normalizeKey(i),i}getChildKeys(){const e=this.level+1,r=this.row<<1,i=this.col<<1,s=this.world;return[new t(e,r,i,s),new t(e,r,i+1,s),new t(e,r+1,i,s),new t(e,r+1,i+1,s)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}}return t})},"esri/views/2d/tiling/TileCoverage":function(){define(["../../../core/ObjectPool","./TileKey"],function(e,t){"use strict";class r{constructor(){this.spans=[]}static{this.pool=new e(r)}acquire(e){this.lodInfo=e}release(){this.lodInfo=null,this.spans.length=0}*keys(){const e=this.lodInfo;for(const{row:r,colFrom:i,colTo:s}of this.spans)for(let n=i;n<=s;n++){const i=e.getWorldForColumn(n);yield new t(e.level,r,e.normalizeCol(n),i)}}forEach(e,t){const{spans:r,lodInfo:i}=this,{level:s}=i;if(0!==r.length)for(const{row:n,colFrom:o,colTo:a}of r)for(let r=o;r<=a;r++)e.call(t,s,n,i.normalizeCol(r),i.getWorldForColumn(r))}}return r})},"esri/views/2d/tiling/TileSpan":function(){define(function(){"use strict";return class{constructor(e,t,r){this.row=e,this.colFrom=t,this.colTo=r}}})},"esri/views/2d/tiling/TileQueue":function(){define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/MapUtils","../../../core/maybe","../../../core/SetUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/vec2","../../support/ScheduledQueueProcessor"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h=[0,0];let p=class extends t{constructor(e){super(e),this._keyToItem=new Map,this._tilesByScale=new Map,this.concurrency=6}initialize(){const{concurrency:e,process:t,scheduler:r,priority:i}=this;this._queue=new d.ScheduledQueueProcessor({concurrency:e,scheduler:r,priority:i,process:(e,r)=>{const i=this._keyToItem.get(e);return t(i,{signal:r})},peeker:e=>this._peek(e)})}destroy(){this.clear(),this._queue=i.destroyMaybe(this._queue)}get length(){return this._queue?this._queue.length:0}abort(e){const t="string"==typeof e?e:e.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear(),this._tilesByScale.clear()}has(e){return"string"==typeof e?this._keyToItem.has(e):this._keyToItem.has(e.id)}pause(){this._queue.pause()}push(e){const t=e.key.id;if(this._queue.has(t))return this._queue.get(t);const i=this._queue.push(t),s=this.tileInfoView.getTileScale(e.key),n=r.getOrCreateMapValue(this._tilesByScale,s,()=>new Set),o=()=>{n.delete(e.key),0===n.size&&this._tilesByScale.delete(s),this._keyToItem.delete(t)};return n.add(e.key),this._keyToItem.set(t,e),i.then(o,o),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peek(e){if(!this.state)return e.values().next().value;const t=new Set;for(const r of e)t.add(this._keyToItem.get(r).key);const r=this.state.scale;let i,n=Number.POSITIVE_INFINITY;for(const[e,o]of this._tilesByScale)if(s.someSet(o,e=>t.has(e))){const t=Math.abs(e-r);t<n&&(i=o,n=t)}return this._getClosestTileKey(i,e).id}_getClosestTileKey(e,t){const r=this.tileInfoView,i=this.state.center;let s,n=Number.POSITIVE_INFINITY;for(const o of e)if(t.has(o.id)){r.getTileCoords(h,o);const e=u.distance(h,i);e<n&&(n=e,s=o)}return s}};return e.__decorate([n.property({constructOnly:!0})],p.prototype,"concurrency",void 0),e.__decorate([n.property({constructOnly:!0})],p.prototype,"priority",void 0),e.__decorate([n.property({constructOnly:!0})],p.prototype,"process",void 0),e.__decorate([n.property({constructOnly:!0})],p.prototype,"scheduler",void 0),e.__decorate([n.property()],p.prototype,"state",void 0),e.__decorate([n.property({constructOnly:!0})],p.prototype,"tileInfoView",void 0),p=e.__decorate([c.subclass("esri.views.2d.tiling.TileQueue")],p),p})},"esri/views/support/ScheduledQueueProcessor":function(){define(["exports","../../core/has","../../core/maybe","../../core/promiseUtils","../../core/Queue","../../core/ReactiveMap","../../core/scheduling","../../core/signal"],function(e,t,r,i,s,n,o,a){"use strict";class l{constructor(e,t){this.item=e,this.controller=t,this.promise=null}}e.ScheduledQueueProcessor=class{constructor(e){this._schedule=null,this._task=null,this._deferreds=new n,this._controllers=new n,this._processingItems=new n,this._pausedSignal=a.signal(!1),this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new s(e.peeker),this.process=e.process;const t=e.scheduler;e.priority&&t&&(this._task=t.registerTask(e.priority,this))}destroy(){this.clear(),this._schedule=r.removeMaybe(this._schedule),this._task=r.removeMaybe(this._task)}get updating(){return!!this._task?.updating||this.readyToRun}get length(){return this._processingItems.size+this._queue.length}abort(e){const t=this._controllers.get(e);t&&t.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach(t=>e.push(t)),this._controllers.clear(),e.forEach(e=>e.abort()),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach((t,r)=>e(r))}get(e){const t=this._deferreds.get(e);return t?t.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(e,t){const r=this.get(e);if(r)return r;const s=new AbortController;let n=null;t&&(n=i.onAbort(t,()=>s.abort()));const o=()=>{a.remove(),null!=n&&n.remove(),this._removeItem(e),this._queue.remove(e),this._scheduleNext()},a=i.onAbortOrThrow(s.signal,()=>{const t=this._processingItems.get(e);t&&t.controller.abort(),o(),l.reject(i.createAbortError())}),l=i.createResolver();return this._deferreds.set(e,l),this._controllers.set(e,s),l.promise.then(o,o),this._queue.push(e),this._scheduleNext(),l.promise}last(){return this._queue.last()}lastPromise(){const e=this.last();return e?this.get(e):null}peek(){return this._queue.peek()}popLast(){const e=this._queue.popLast();return e&&(this._deferreds.get(e)?.reject(i.createAbortError()),this._removeItem(e)),e}reset(){const e=Array.from(this._processingItems.values());this._processingItems.clear();for(const t of e)this._queue.push(t.item),t.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get readyToRun(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_removeItem(e){this._deferreds.delete(e),this._controllers.delete(e),this._processingItems.delete(e)}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=o.schedule(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))}_processError(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(null==e)return;let t;const r=new AbortController,s=new l(e,r);this._processingItems.set(e,s);try{t=this.process(e,r.signal)}catch(e){this._processError(s,e)}i.isPromiseLike(t)?(s.promise=t,t.then(e=>this._processResult(s,e),e=>this._processError(s,e))):this._processResult(s,t)}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/tiling/TileStrategy":function(){define(["../../../geometry/support/aaBoundingRect","./TileCache","./TileCoverage","./TileKey"],function(e,t,r,i){"use strict";const s=new i(0,0,0,0),n=new Map,o=[],a=[];return class{constructor(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,null!=e.resampling&&(this.resampling=e.resampling),e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),null!=e.buffer&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new t(e.cacheSize,this.tileInfoView,e=>{this.releaseTile(e)}))}destroy(){this.tileIndex.clear()}update(e){const{resampling:t,tileIndex:i}=this,{scale:l,center:c,resolution:u}=e.state,{minScale:d,maxScale:h}=this.tileInfoView,p=!e.stationary&&l>this._previousScale;if(this._previousScale=l,!t&&(l>d||l<h))return this.tiles.length=0,void this.clear();const f=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.resampling,this.coveragePolicy);if(!f)return this.tiles.length=0,void this.clear();const{spans:m,lodInfo:g}=f,{level:y}=g;this.tiles.length=0,i.forEach(e=>e.visible=!0);let _=0,b=0;if(m.length>0)for(const{row:e,colFrom:t,colTo:r}of m)for(let o=t;o<=r;o++){_++;const t=s.set(y,e,g.normalizeCol(o),g.getWorldForColumn(o)).id;let r=i.get(t);if(r)r.isReady?(n.set(t,r),b++):p||this._addParentTile(t,n);else{if(this._tileCache?.has(t)){if(r=this._tileCache.pop(t),this.tileIndex.set(t,r),r.isReady){n.set(t,r),b++;continue}}else r=this.acquireTile(s),this.tileIndex.set(t,r);p||this._addParentTile(t,n)}}const v=b===_;for(const[e,t]of i){if(n.has(e))continue;s.set(e);const r=this.tileInfoView.intersects(f,s),i="purge"===this.cachePolicy?s.level!==y:s.level>y;!r||!p&&v?!i&&r||o.push(t):t.isReady?i&&"purge"===this.cachePolicy&&this._hasReadyAncestor(s,y)?o.push(t):a.push(t):i&&o.push(t)}for(const e of a)e.isReady&&n.set(e.key.id,e);for(const e of o)this._tileCache?this._tileCache.add(e):this.releaseTile(e),i.delete(e.key.id);for(const e of n.values())this.tiles.push(e);for(const e of i.values())n.has(e.key.id)||(e.visible=!1);this._tileCache?.prune(y,c,u),r.pool.release(f),a.length=0,o.length=0,n.clear()}clear(){const{tileIndex:e}=this;for(const t of e.values())this.releaseTile(t);e.clear()}refresh(e){for(const t of this.tileIndex.values())e(t);this._tileCache?.clear()}updateCacheSize(e){this._tileCache&&(this._tileCache.maxSize=e)}_addParentTile(e,t){let r=e,i=null;for(;r=this.tileInfoView.getTileParentId(r),r;)if(this.tileIndex.has(r)){if(i=this.tileIndex.get(r),i?.isReady){t.has(i.key.id)||t.set(i.key.id,i);break}}else if(this._tileCache?.has(r)&&(i=this._tileCache.pop(r),this.tileIndex.set(r,i),i?.isReady)){t.has(i.key.id)||t.set(i.key.id,i);break}}_hasReadyAncestor(t,r){const i=e.create();this.tileInfoView.getTileBounds(i,t,!0);for(const s of this.tileIndex.values())if(s.isReady&&s.key.level>=r&&s.key.level<t.level){const t=e.create();if(this.tileInfoView.getTileBounds(t,s.key,!0),e.contains(t,i))return!0}return!1}}})},"esri/views/2d/tiling/TileCache":function(){define(["../../../core/libs/gl-matrix-2/math/vec2"],function(e){"use strict";function t(e,t){e.delete(t)}return class{constructor(e,t,r){this.maxSize=e,this._tileInfoView=t,this._removedFunc=r,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(e){return this._tilePerId.has(e)}get(e){return this._tilePerId.get(e)}pop(e){const r=this._tilePerId.get(e);if(!r)return;const i=r.key.level,s=this._tileKeysPerLevel[i];t(this._tilePerId,e);for(let t=0;t<s.length;t++)if(s[t].id===e){s.splice(t,1);break}return r.visible=!0,r}add(e){e.visible=!1;const t=e.key,r=t.id;if(this._tilePerId.has(r))return;this._tilePerId.set(r,e);const i=t.level;this._tileKeysPerLevel[i]||(this._tileKeysPerLevel[i]=[]),this._tileKeysPerLevel[i].push(t)}prune(e,t,r){let i=this._tilePerId.size;if(i<=this.maxSize)return;let s=this._tileKeysPerLevel.length-1;for(;i>this.maxSize&&s>=0;)s!==e&&(i=this._pruneAroundCenterTile(i,t,r,s)),s--;i>this.maxSize&&(i=this._pruneAroundCenterTile(i,t,r,e))}_pruneAroundCenterTile(t,r,i,s){const n=this._tileKeysPerLevel[s];if(!n||0===n.length)return t;const{size:o,origin:a}=this._tileInfoView.tileInfo,l=i*o[0],c=i*o[1],u=[0,0],d=[0,0];for(n.sort((t,i)=>(u[0]=a.x+l*(t.col+.5),u[1]=a.y-c*(t.row+.5),d[0]=a.x+l*(i.col+.5),d[1]=a.y-c*(i.row+.5),e.squaredDistance(u,r)-e.squaredDistance(d,r)));n.length>0;){const e=n.pop();if(this._removeTile(e.id),--t===this.maxSize)break}return t}_removeTile(e){const r=this._tilePerId.get(e);this._removedFunc&&r&&this._removedFunc(r),t(this._tilePerId,e)}}})},"esri/views/2d/engine/vectorTiles/constants":function(){define(["exports"],function(e){"use strict";e.tileCoordSize=4096,e.tileCoordinateScale=.125,e.tilePixelRatio=8,e.tilePixelSize=512,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/vectorTiles/decluttering/jobsUtil":function(){define(["exports","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f32","../../../../../core/libs/gl-matrix-2/math/common","../constants","./CollisionJob","./SymbolDeclutterer","./SymbolRepository","./util"],function(e,t,r,i,s,n,o,a,l){"use strict";const c=r.create();e.declutterSingleTile=function(e,r){const u=e.transforms.tileUnitsToPixels,d=i.toRadian(r),h=Math.cos(d),p=Math.sin(d),f=Math.ceil(512*(Math.abs(p)+Math.abs(h)));t.identity(c),t.translate(c,c,[f/2,f/2]),t.rotate(c,c,d),t.translate(c,c,[-256,-256]),t.scale(c,c,[1/8,1/8,1]),e.transforms.tileUnitsToPixels=c;const m=[],g=new a.SymbolRepository(s.tileCoordSize,m),y=new o.SymbolDeclutterer("vector-tile",m,g,null,(t,i,s)=>new n.CollisionJob(t,i,s,e.styleRepository,e.key.level,r),(e,t)=>{l.writeOpacityToBuffers(e,t,!1)},()=>0,t=>{const r=e.styleRepository.getStyleLayerByUID(t).getLayoutProperty("visibility");return!r||1!==r.getValue()});m.push(e),g.registerVectorTile(e),y.setScreenSize(f,f),y.continue(1/0),g.unregisterVectorTile(e),e.transforms.tileUnitsToPixels=u},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/libs/gl-matrix-2/factories/mat3f32":function(){define(["exports"],function(e){"use strict";function t(){const e=new Float32Array(9);return e[0]=1,e[4]=1,e[8]=1,e}function r(e){const t=new Float32Array(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function i(e,t,r,i,s,n,o,a,l){const c=new Float32Array(9);return c[0]=e,c[1]=t,c[2]=r,c[3]=i,c[4]=s,c[5]=n,c[6]=o,c[7]=a,c[8]=l,c}const s=Object.freeze(Object.defineProperty({__proto__:null,clone:r,create:t,fromValues:i},Symbol.toStringTag,{value:"Module"}));e.clone=r,e.create=t,e.fromValues=i,e.mat3f32=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/vectorTiles/decluttering/CollisionJob":function(){define(["exports","../../../../../core/libs/gl-matrix-2/factories/mat3f32","./config","./util"],function(e,t,r,i){"use strict";e.CollisionJob=class{constructor(e,s,n,o,a,l){this._symbols=e,this._styleRepository=o,this._zoom=a,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new i.GridIndex(s,n,r.collisionGridCellSize),this._si=Math.sin(Math.PI*l/180),this._co=Math.cos(Math.PI*l/180),o.cachedStyles&&(this._styleProps=o.cachedStyles);for(const r of e)for(const e of r.symbols)this._allNeededMatrices.has(e.tile)||this._allNeededMatrices.set(e.tile,t.clone(e.tile.transforms.tileUnitsToPixels))}work(e){const t=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const r=this._symbols[this._currentLayerCursor],i=this._getProperties(r.styleLayerUID),s=this._styleRepository.layerContexts?.get(r.styleLayerUID);for(;this._currentSymbolCursor<r.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-t>e)return!1;const n=r.symbols[this._currentSymbolCursor];if(!n.uniqueSymbol?.show)continue;const o=this._computeCoordinates(n,i,s),a=n.uniqueSymbol;if(!a.show)continue;const{iconAllowOverlap:l,textAllowOverlap:c}=i;for(const e of o){if(!e.enabled)continue;const t=a.parts[e.partIndex];t.show&&!(e.partIndex?c:l)&&this._doesCollide(e)&&(e.hard?a.show=!1:t.show=!1)}a.show&&this._insertColliders(a.parts,o,i)}}return!0}_insertColliders(e,t,r){const{iconIgnorePlacement:i,textIgnorePlacement:s}=r;for(const r of t){if(!r.enabled)continue;if(r.partIndex?s:i)continue;if(!e[r.partIndex].show)continue;const t=r.xScreen+r.dxScreen,n=r.yScreen+r.dyScreen,o=t+r.width,a=n+r.height,[l,c,u,d]=this._gridIndex.getCellSpan(t,n,o,a);for(let e=c;e<=d;e++)for(let t=l;t<=u;t++)this._gridIndex.cells[e][t].push(r)}}_computeCoordinates(e,t,r){const{iconRotationAlignment:i,textRotationAlignment:s,iconTranslate:n,iconTranslateAnchor:o,textTranslate:a,textTranslateAnchor:l}=t,c=this._si,u=this._co,d=this._zoom,h=this._allNeededMatrices.get(e.tile),p=e.uniqueSymbol,f=e.colliders(r);let m=0;for(const e of f){const[t,r]=0===e.partIndex?n:a,p=0===e.partIndex?o:l,f=e.minLod<=d&&d<=e.maxLod;m+=f?0:1,e.enabled=f,e.xScreen=e.xTile*h[0]+e.yTile*h[3]+h[6],e.yScreen=e.xTile*h[1]+e.yTile*h[4]+h[7],0===p?(e.xScreen+=u*t-c*r,e.yScreen+=c*t+u*r):(e.xScreen+=t,e.yScreen+=r),1===(0===e.partIndex?i:s)?(e.dxScreen=e.dxPixels,e.dyScreen=e.dyPixels):(e.dxScreen=u*(e.dxPixels+e.width/2)-c*(e.dyPixels+e.height/2)-e.width/2,e.dyScreen=c*(e.dxPixels+e.width/2)+u*(e.dyPixels+e.height/2)-e.height/2)}return f.length>0&&m===f.length&&p&&(p.show=!1),f}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const r=this._styleRepository.getLayerStyleProperties?.(e,this._zoom);return this._styleProps.set(e,r),r}_doesCollide(e){const t=e.xScreen+e.dxScreen,r=e.yScreen+e.dyScreen,i=t+e.width,s=r+e.height,[n,o,a,l]=this._gridIndex.getCellSpan(t,r,i,s);for(let c=o;c<=l;c++)for(let o=n;o<=a;o++){const n=this._gridIndex.cells[c][o];for(const o of n){if(null!=o.labelId&&null!=e.labelId&&o.labelId===e.labelId)continue;const n=o.xScreen+o.dxScreen,a=o.yScreen+o.dyScreen,l=n+o.width,c=a+o.height;if(!(i<n||t>l||s<a||r>c))return!0}}return!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/vectorTiles/decluttering/config":function(){define(["exports"],function(e){"use strict";e.collisionGridCellSize=32,e.declutterBudget=1.5,e.declutterTiles=!0,e.fadeDuration=200,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/vectorTiles/decluttering/util":function(){define(["exports","../GeometryUtils","./core"],function(e,t,r){"use strict";function i(e,t,r,i,s,n){const o=r-s;if(o>=0)return(t>>o)+(i-(n<<o))*(e>>o);const a=-o;return t-(n-(i<<a))*(e>>a)<<a}function s(e,t,r,i,s){const n=e.layerData.get(s);if(3===n.type){for(const t of i){const i=t.uniqueSymbol;let s;if(t.selectedForRendering){const t=i.parts[0],n=t.startOpacity,o=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===o;const a=r?Math.floor(127*n)|o<<7:o?255:0;s=a<<24|a<<16|a<<8|a}else s=0;for(const[e,r]of t.iconVertexRanges)for(let t=e;t<e+r;t+=4)n.iconOpacity[t/4]=s;if(t.selectedForRendering){const t=i.parts[1],n=t.startOpacity,o=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===o;const a=r?Math.floor(127*n)|o<<7:o?255:0;s=a<<24|a<<16|a<<8|a}else s=0;for(const[e,r]of t.textVertexRanges)for(let t=e;t<e+r;t+=4)n.textOpacity[t/4]=s}n.lastOpacityUpdate=t,n.opacityChanged=!0}}e.GridIndex=class{constructor(e,t,r){this._rows=Math.ceil(t/r),this._columns=Math.ceil(e/r),this._cellSize=r,this.cells=new Array(this._rows);for(let e=0;e<this._rows;e++){this.cells[e]=new Array(this._columns);for(let t=0;t<this._columns;t++)this.cells[e][t]=[]}}getCell(e,t){const r=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),i=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[r]&&this.cells[r][i]||null}getCellSpan(e,t,r,i){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}},e.deserializeSymbols=function(e,t,i,s,n,o,a){const l=t[s++];for(let c=0;c<l;c++){const l=new r.VTLSymbol(o,a);l.xTile=t[s++],l.yTile=t[s++],l.hash=t[s++],l.priority=t[s++],l.featureIndex=t[s++];const c=t[s++],u=l.colliders();for(let e=0;e<c;e++){const e=t[s++],r=t[s++],n=t[s++],o=t[s++],a=!!t[s++],l=t[s++],c=i[s++],d=i[s++],h=t[s++],p=t[s++];u.push({xTile:e,yTile:r,dxPixels:n,dyPixels:o,hard:a,partIndex:l,width:h,height:p,minLod:c,maxLod:d})}const d=e[s++];for(let t=0;t<d;t++)l.textVertexRanges.push([e[s++],e[s++]]);const h=e[s++];for(let t=0;t<h;t++)l.iconVertexRanges.push([e[s++],e[s++]]);n.push(l)}return s},e.isSearchCircleOverlapingSymbol=function(e,r,i,s){const n=e.colliders();let o,a,l,c;for(const u of n)if(e.uniqueSymbol?.show&&e.uniqueSymbol.parts[u.partIndex].show&&(o=u.xScreen-s[0]+u.dxScreen,a=u.yScreen-s[1]+u.dyScreen,l=o+u.width,c=a+u.height,t.isCircleOverlapingRect(i,r.x,r.y,o,a,l,c)))return!0;return!1},e.tileCoordChangeX=function(e,t,r,s){return i(e,t,r.level,r.col,s.key.level,s.key.col)},e.tileCoordChangeY=function(e,t,r,s){return i(e,t,r.level,r.row,s.level,s.row)},e.writeOpacityToBuffers=function(e,t,r){for(const[i,n]of e.symbols)s(e,t,r,n,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/vectorTiles/GeometryUtils":function(){define(["exports","../../../../geometry/support/coordsUtils","../../../../geometry/support/TileClipper"],function(e,t,r){"use strict";const i=Number.POSITIVE_INFINITY,s=Math.PI,n=2*s,o=128/s,a=256/360,l=s/180,c=1/Math.LN2;function u(e,t){return(e%=t)>=0?e:e+t}e.between=function(e,t,r){return e>=t&&e<=r||e>=r&&e<=t},e.c2pi=n,e.cDegTo256=a,e.cDegToRad=l,e.cInfinity=i,e.cPi=s,e.cRadTo256=o,e.degToByte=function(e){return u(e*a,256)},e.distanceFromToPolylineWithinThreshold=function(e,r,i,s){let n,o,a,l;const c=s*s;for(const s of i){const i=s.length;if(!(i<2)){n=s[0].x,o=s[0].y;for(let u=1;u<i;++u){if(a=s[u].x,l=s[u].y,t.distanceToSegmentSquared(e,r,n,o,a,l)<c)return!0;n=a,o=l}}}return!1},e.getTileMargins=function(e){return 8+Math.max(16*(e-14),0)},e.interpolate=function(e,t,r){return e*(1-r)+t*r},e.isCircleOverlapingRect=function(e,t,r,i,s,n,o){const a=Math.max(i,Math.min(t,n))-t,l=Math.max(s,Math.min(r,o))-r;return a*a+l*l<=e*e},e.log2=function(e){return Math.log(e)*c},e.offsetLine=function(e,t){if(0===t||Number.isNaN(t))return e;const i=[],s=new r.Point(0,0),n=new r.Point(0,0),o=new r.Point(0,0);for(let a=0;a<e.length;a++){const l=e[a],c=[];for(let e=0;e<l.length;e++){const i=l[e-1],a=l[e],u=l[e+1];0===e?s.setCoords(0,0):s.assignSub(a,i).normalize().rightPerpendicular(),e===l.length-1?n.setCoords(0,0):n.assignSub(u,a).normalize().rightPerpendicular(),o.assignAdd(s,n).normalize();const d=o.x*n.x+o.y*n.y;0!==d&&o.scale(1/d),c.push(r.Point.add(a,o.scale(t)))}i.push(c)}return i},e.pointInPolygon=function(e,t,r){let i,s,n,o=0;for(const a of r){i=a.length;for(let r=1;r<i;++r)s=a[r-1],n=a[r],s.y>t!=n.y>t&&((n.x-s.x)*(t-s.y)-(n.y-s.y)*(e-s.x)>0?o++:o--)}return 0!==o},e.positiveMod=u,e.radToByte=function(e){return u(e*o,256)},e.sqr=function(e){return e*e},e.translateAnchor=function(e,t,i,s){const n=new r.Point(e[0],e[1]);if(n.scale(s),"viewport"===t){const e=-i*(Math.PI/180),t=Math.cos(e),r=Math.sin(e);n.rotate(t,r)}return n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/TileClipper":function(){define(["exports"],function(e){"use strict";class t{constructor(e,t){this.x=e,this.y=t}static fromArray(e){return new t(e[0],e[1])}clone(){return new t(this.x,this.y)}equals(e,t){return e===this.x&&t===this.y}isEqual(e){return e.x===this.x&&e.y===this.y}setCoords(e,t){return this.x=e,this.y=t,this}normalize(){const e=this.x,t=this.y,r=Math.sqrt(e*e+t*t);return this.x/=r,this.y/=r,this}rightPerpendicular(){const e=this.x;return this.x=this.y,this.y=-e,this}leftPerpendicular(){const e=this.x;return this.x=-this.y,this.y=e,this}move(e,t){return this.x+=e,this.y+=t,this}assign(e){return this.x=e.x,this.y=e.y,this}assignAdd(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}assignSub(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}rotate(e,t){const r=this.x,i=this.y;return this.x=r*e-i*t,this.y=r*t+i*e,this}rotateReverse(e,t){const r=this.x,i=this.y;return this.x=r*e+i*t,this.y=-r*t+i*e,this}scale(e){return this.x*=e,this.y*=e,this}length(){const e=this.x,t=this.y;return Math.sqrt(e*e+t*t)}sub(e){return this.x-=e.x,this.y-=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}static distance(e,t){const r=t.x-e.x,i=t.y-e.y;return Math.sqrt(r*r+i*i)}static add(e,r){return new t(e.x+r.x,e.y+r.y)}static sub(e,r){return new t(e.x-r.x,e.y-r.y)}}class r{constructor(e,t,r){this.ratio=e,this.x=t,this.y=r}}class i{static simplify(e,t,r){if(!r)return;const s=-t,n=e+t,o=-t,a=e+t,l=[],c=[],u=r.length;for(let e=0;e<u;++e){const t=r[e];if(!t||t.length<2)continue;let i,u=t[0];const d=t.length;for(let r=1;r<d;++r)i=t[r],u.x===i.x&&(u.x<=s&&(u.y>i.y?(l.push(e),l.push(r),l.push(0),l.push(-1)):(c.push(e),c.push(r),c.push(0),c.push(-1))),u.x>=n&&(u.y<i.y?(l.push(e),l.push(r),l.push(1),l.push(-1)):(c.push(e),c.push(r),c.push(1),c.push(-1)))),u.y===i.y&&(u.y<=o&&(u.x<i.x?(l.push(e),l.push(r),l.push(2),l.push(-1)):(c.push(e),c.push(r),c.push(2),c.push(-1))),u.y>=a&&(u.x>i.x?(l.push(e),l.push(r),l.push(3),l.push(-1)):(c.push(e),c.push(r),c.push(3),c.push(-1)))),u=i}if(0===l.length||0===c.length)return;i.fillParent(r,c,l),i.fillParent(r,l,c);const d=[];i.calcDeltas(d,c,l),i.calcDeltas(d,l,c),i.addDeltas(d,r)}static fillParent(e,t,r){const i=r.length,n=t.length;for(let o=0;o<n;o+=4){const n=t[o],a=t[o+1],l=t[o+2],c=e[n][a-1],u=e[n][a];let d=8092,h=-1;for(let t=0;t<i;t+=4){if(r[t+2]!==l)continue;const i=r[t],n=r[t+1],o=e[i][n-1],a=e[i][n];switch(l){case 0:case 1:if(s(c.y,o.y,a.y)&&s(u.y,o.y,a.y)){const e=Math.abs(a.y-o.y);e<d&&(d=e,h=t)}break;case 2:case 3:if(s(c.x,o.x,a.x)&&s(u.x,o.x,a.x)){const e=Math.abs(a.x-o.x);e<d&&(d=e,h=t)}}}t[o+3]=h}}static calcDeltas(e,t,r){const s=t.length;for(let n=0;n<s;n+=4){const s=[],o=i.calcDelta(n,t,r,s);e.push(t[n]),e.push(t[n+1]),e.push(t[n+2]),e.push(o)}}static calcDelta(e,t,r,s){const n=t[e+3];if(-1===n)return 0;const o=s.length;return o>1&&s[o-2]===n?0:(s.push(n),i.calcDelta(n,r,t,s)+1)}static addDeltas(e,t){const r=e.length;let i=0;for(let t=0;t<r;t+=4){const r=e[t+3];r>i&&(i=r)}for(let s=0;s<r;s+=4){const r=t[e[s]],n=e[s+1],o=i-e[s+3];switch(e[s+2]){case 0:r[n-1].x-=o,r[n].x-=o,1===n&&(r[r.length-1].x-=o),n===r.length-1&&(r[0].x-=o);break;case 1:r[n-1].x+=o,r[n].x+=o,1===n&&(r[r.length-1].x+=o),n===r.length-1&&(r[0].x+=o);break;case 2:r[n-1].y-=o,r[n].y-=o,1===n&&(r[r.length-1].y-=o),n===r.length-1&&(r[0].y-=o);break;case 3:r[n-1].y+=o,r[n].y+=o,1===n&&(r[r.length-1].y+=o),n===r.length-1&&(r[0].y+=o)}}}}const s=(e,t,r)=>e>=t&&e<=r||e>=r&&e<=t;e.Point=t,e.SimpleBuilder=class{setExtent(e){this._ratio=4096===e?1:4096/e}get validateTessellation(){return this._ratio<1}reset(e){this._lines=[],this._line=null}moveTo(e,r){this._line&&this._lines.push(this._line),this._line=[];const i=this._ratio;this._line.push(new t(e*i,r*i))}lineTo(e,r){const i=this._ratio;this._line.push(new t(e*i,r*i))}close(){const e=this._line;e&&!e[0].isEqual(e[e.length-1])&&e.push(e[0])}result(){return this._line&&this._lines.push(this._line),0===this._lines.length?null:this._lines}},e.TileClipper=class{constructor(e,t,r,i=8,s=8){this._lines=[],this._starts=[],this.validateTessellation=!0,this._pixelRatio=i,this._pixelMargin=s,this._tileSize=512*i,this._dz=e,this._yPos=t,this._xPos=r}setPixelMargin(e){e!==this._pixelMargin&&(this._pixelMargin=e,this.setExtent(this._extent))}setExtent(e){this._extent=e,this._finalRatio=this._tileSize/e*(1<<this._dz);let t=this._pixelRatio*this._pixelMargin;t/=this._finalRatio;const r=e>>this._dz;t>r&&(t=r),this._margin=t,this._xmin=r*this._xPos-t,this._ymin=r*this._yPos-t,this._xmax=this._xmin+r+2*t,this._ymax=this._ymin+r+2*t}reset(e){this._type=e,this._lines=[],this._starts=[],this._line=null,this._start=0}moveTo(e,r){this._pushLine(),this._prevIsIn=this._isIn(e,r),this._moveTo(e,r,this._prevIsIn),this._prevPt=new t(e,r),this._firstPt=new t(e,r),this._dist=0}lineTo(e,i){const s=this._isIn(e,i),n=new t(e,i),o=t.distance(this._prevPt,n);let a,l,c,u,d,h,p,f;if(s)this._prevIsIn?this._lineTo(e,i,!0):(a=this._prevPt,l=n,c=this._intersect(l,a),this._start=this._dist+o*(1-this._r),this._lineTo(c.x,c.y,!0),this._lineTo(l.x,l.y,!0));else if(this._prevIsIn)l=this._prevPt,a=n,c=this._intersect(l,a),this._lineTo(c.x,c.y,!0),this._lineTo(a.x,a.y,!1);else{const e=this._prevPt,t=n;if(e.x<=this._xmin&&t.x<=this._xmin||e.x>=this._xmax&&t.x>=this._xmax||e.y<=this._ymin&&t.y<=this._ymin||e.y>=this._ymax&&t.y>=this._ymax)this._lineTo(t.x,t.y,!1);else{const i=[];if((e.x<this._xmin&&t.x>this._xmin||e.x>this._xmin&&t.x<this._xmin)&&(u=(this._xmin-e.x)/(t.x-e.x),f=e.y+u*(t.y-e.y),f<=this._ymin?h=!1:f>=this._ymax?h=!0:i.push(new r(u,this._xmin,f))),(e.x<this._xmax&&t.x>this._xmax||e.x>this._xmax&&t.x<this._xmax)&&(u=(this._xmax-e.x)/(t.x-e.x),f=e.y+u*(t.y-e.y),f<=this._ymin?h=!1:f>=this._ymax?h=!0:i.push(new r(u,this._xmax,f))),(e.y<this._ymin&&t.y>this._ymin||e.y>this._ymin&&t.y<this._ymin)&&(u=(this._ymin-e.y)/(t.y-e.y),p=e.x+u*(t.x-e.x),p<=this._xmin?d=!1:p>=this._xmax?d=!0:i.push(new r(u,p,this._ymin))),(e.y<this._ymax&&t.y>this._ymax||e.y>this._ymax&&t.y<this._ymax)&&(u=(this._ymax-e.y)/(t.y-e.y),p=e.x+u*(t.x-e.x),p<=this._xmin?d=!1:p>=this._xmax?d=!0:i.push(new r(u,p,this._ymax))),0===i.length)d?h?this._lineTo(this._xmax,this._ymax,!0):this._lineTo(this._xmax,this._ymin,!0):h?this._lineTo(this._xmin,this._ymax,!0):this._lineTo(this._xmin,this._ymin,!0);else if(i.length>1&&i[0].ratio>i[1].ratio)this._start=this._dist+o*i[1].ratio,this._lineTo(i[1].x,i[1].y,!0),this._lineTo(i[0].x,i[0].y,!0);else{this._start=this._dist+o*i[0].ratio;for(let e=0;e<i.length;e++)this._lineTo(i[e].x,i[e].y,!0)}this._lineTo(t.x,t.y,!1)}}this._dist+=o,this._prevIsIn=s,this._prevPt=n}close(){if(this._line.length>2){const e=this._firstPt,t=this._prevPt;e.x===t.x&&e.y===t.y||this.lineTo(e.x,e.y);const r=this._line;let i=r.length;for(;i>=4&&(r[0].x===r[1].x&&r[0].x===r[i-2].x||r[0].y===r[1].y&&r[0].y===r[i-2].y);)r.pop(),r[0].x=r[i-2].x,r[0].y=r[i-2].y,--i}}result(e=!0){return this._pushLine(),0===this._lines.length?null:(3===this._type&&e&&i.simplify(this._tileSize,this._margin*this._finalRatio,this._lines),this._lines)}resultWithStarts(){if(2!==this._type)throw new Error("Only valid for lines");this._pushLine();const e=this._lines,t=e.length;if(0===t)return null;const r=[];for(let i=0;i<t;i++)r.push({line:e[i],start:this._starts[i]||0});return r}_isIn(e,t){return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax}_intersect(e,r){let i,s,n;if(r.x>=this._xmin&&r.x<=this._xmax)s=r.y<=this._ymin?this._ymin:this._ymax,n=(s-e.y)/(r.y-e.y),i=e.x+n*(r.x-e.x);else if(r.y>=this._ymin&&r.y<=this._ymax)i=r.x<=this._xmin?this._xmin:this._xmax,n=(i-e.x)/(r.x-e.x),s=e.y+n*(r.y-e.y);else{s=r.y<=this._ymin?this._ymin:this._ymax,i=r.x<=this._xmin?this._xmin:this._xmax;const t=(i-e.x)/(r.x-e.x),o=(s-e.y)/(r.y-e.y);t<o?(n=t,s=e.y+t*(r.y-e.y)):(n=o,i=e.x+o*(r.x-e.x))}return this._r=n,new t(i,s)}_pushLine(){this._line&&(1===this._type?this._line.length>0&&(this._lines.push(this._line),this._starts.push(this._start)):2===this._type?this._line.length>1&&(this._lines.push(this._line),this._starts.push(this._start)):3===this._type&&this._line.length>3&&(this._lines.push(this._line),this._starts.push(this._start))),this._line=[],this._start=0}_moveTo(e,r,i){3!==this._type?i&&(e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),r=Math.round((r-(this._ymin+this._margin))*this._finalRatio),this._line.push(new t(e,r))):(i||(e<this._xmin&&(e=this._xmin),e>this._xmax&&(e=this._xmax),r<this._ymin&&(r=this._ymin),r>this._ymax&&(r=this._ymax)),e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),r=Math.round((r-(this._ymin+this._margin))*this._finalRatio),this._line.push(new t(e,r)),this._isH=!1,this._isV=!1)}_lineTo(e,r,i){let s,n;if(3!==this._type)if(i){if(e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),r=Math.round((r-(this._ymin+this._margin))*this._finalRatio),this._line.length>0&&(s=this._line[this._line.length-1],s.equals(e,r)))return;this._line.push(new t(e,r))}else this._line&&this._line.length>0&&this._pushLine();else if(i||(e<this._xmin&&(e=this._xmin),e>this._xmax&&(e=this._xmax),r<this._ymin&&(r=this._ymin),r>this._ymax&&(r=this._ymax)),e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),r=Math.round((r-(this._ymin+this._margin))*this._finalRatio),this._line&&this._line.length>0){s=this._line[this._line.length-1];const i=s.x===e,o=s.y===r;if(i&&o)return;this._isH&&i||this._isV&&o?(s.x=e,s.y=r,n=this._line[this._line.length-2],n.x===e&&n.y===r?(this._line.pop(),this._line.length<=1?(this._isH=!1,this._isV=!1):(n=this._line[this._line.length-2],this._isH=n.x===e,this._isV=n.y===r)):(this._isH=n.x===e,this._isV=n.y===r)):(this._line.push(new t(e,r)),this._isH=i,this._isV=o)}else this._line.push(new t(e,r))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/vectorTiles/decluttering/core":function(){define(["exports"],function(e){"use strict";e.UniqueSymbol=class{constructor(e){this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1,this.lastShow=!1,this.tileSymbols=[e],this.id=e.id}},e.VTLSymbol=class{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.uniqueSymbol=null,this._colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}colliders(){return this._colliders}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/vectorTiles/decluttering/SymbolDeclutterer":function(){define(["exports","../VectorTile","./config","../../webgl/definitions"],function(e,t,r,i){"use strict";function s(e){return(e.uniqueSymbol?.show&&e.uniqueSymbol?.lastShow)??!1}function n(e,t){if(e.priority-t.priority)return e.priority-t.priority;if(s(e)&&!s(t))return-1;if(s(t)&&!s(e))return 1;const r=e.tile.key,i=t.tile.key;return r.world-i.world?r.world-i.world:r.level-i.level?r.level-i.level:r.row-i.row?r.row-i.row:r.col-i.col?r.col-i.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}function o(e,t){for(const i of e){const e=i.uniqueSymbol;for(const i of e.parts){const s=i.targetOpacity>.5?1:-1;i.startOpacity+=s*((t-i.startTime)/r.fadeDuration),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=t,i.targetOpacity=e.show&&i.show?1:0}}}function a(e){let t=null,r=null,i=null;for(const s of e.tileSymbols){const e=s.tile;e.isReady&&e.isCoverage?t=s:e.isReady?r=s:e.rendering&&(i=s)}return t??r??i}function l(e){let t=null,r=!1,i=!1;for(const s of e.tileSymbols)if(!i||!r){const e=s.tile;(!t||e.isCoverage||e.neededForCoverage&&!r)&&(t=s,(e.neededForCoverage||e.isCoverage)&&(i=!0),e.isCoverage&&(r=!0))}return i?t:null}e.SymbolDeclutterer=class{get running(){return this._running}constructor(e,t,r,i,s,n,o,a){this.selectionMode=e,this._visibleTiles=t,this._symbolRepository=r,this._styleRepository=i,this._createCollisionJob=s,this._assignTileSymbolsOpacity=n,this._symbolLayerSorter=o,this._isLayerVisible=a,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}return this._running=!1,!0}_isFeatureFiltered(e,t,r){const s=t.getFilterFlags(e),n=s&i.filterFlag0,o=null==r.featureEffect||r.featureEffect.excludedLabelsVisible||s&i.effectFlag0;return!(n&&o)}_getFilteredByLayer(){let e;if(this._styleRepository?.layerContexts)for(const t of this._symbolRepository.uniqueSymbols){const r=this._styleRepository.layerContexts?.get(t.styleLayerUID);if(r?.attributeView)for(const i of t.uniqueSymbols){e??=new Map,e.get(t.styleLayerUID)||e.set(t.styleLayerUID,new Set);const s=e.get(t.styleLayerUID),n=r.attributeView,o=r.layerView;this._isFeatureFiltered(i.id,n,o)&&s.add(i.id)}}return e}_resetSelection(){for(let e=0;e<this._symbolRepository.uniqueSymbols.length;e++){const t=this._symbolRepository.uniqueSymbols[e];for(let e=0;e<t.uniqueSymbols.length;e++){const r=t.uniqueSymbols[e];for(const e of r.tileSymbols)e.selectedForRendering=!1}}}_createSelectionJob(){const e="feature-tile"===this.selectionMode?a:l,t=this._symbolRepository.uniqueSymbols;this._resetSelection();const r=[];let i=0,s=0;const o=this._isLayerVisible,c=this._getFilteredByLayer(),u=this._styleRepository?.layerContexts,d=this._symbolLayerSorter;return{work:function(a){let l;const d=performance.now();for(;s<t.length;s++,i=0){const n=t[s],h=n.styleLayerUID,p=c?.get(h);let f=0;if(u){const e=u.get(h).layerView;f=e.view.allLayerViews.items.indexOf(e)}if(!o(h)){r[s]||(r[s]={styleLayerUID:h,layerOrder:f,symbols:[]});continue}r[s]||={styleLayerUID:h,symbols:[],layerOrder:f};const m=r[s];for(;i<n.uniqueSymbols.length;i++){if(l=n.uniqueSymbols[i],i%100==99&&performance.now()-d>a)return!1;if(l.lastShow=l.show,l.id&&p?.has(l.id)){l.show=!1,l.parts[0].show=!1,l.parts[1].show=!1;continue}const t=e(l);if(t){t.selectedForRendering=!0,m.symbols.push(t),l.show=!0;for(const e of l.parts)e.show=!0}else l.show=!1}}for(const e of r)e.symbols.sort(n);return r.sort((e,t)=>t.layerOrder-e.layerOrder),!0},get sortedSymbols(){return r.sort(d)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,r=this._visibleTiles;let i=0;function s(t,r){for(const e of t.symbols.values())o(e,r);e(t,r);for(const e of t.childrenTiles)s(e,r)}return{work(n){const o=performance.now();for(;i<r.length;i++){if(performance.now()-o>n)return!1;const a=r[i];if(null!=a.parentTile)continue;const l=performance.now();a instanceof t.VectorTile?s(a,l):e(a,l)}return!0}}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/vectorTiles/VectorTile":function(){define(["exports","../../../../core/has","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f32","./constants","./RenderBucket","./decluttering/config","../webgl/TiledDisplayObject"],function(e,t,r,i,s,n,o,a){"use strict";class l extends a.TiledDisplayObject{constructor(e,t,r,i,n,o,a,l=null){super(e,t,r,i,n,o,s.tileCoordSize,s.tileCoordSize),this.styleRepository=a,this._owner=l,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=e.id}get styleLayerUIDs(){return Array.from(this.layerData.keys())}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<o.fadeDuration}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<o.fadeDuration)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){let t=!1;for(const r of e){const e=this.layerData.get(r);e&&(this._usedMemory-=e.usedMemory,3===e.type&&this.symbols.delete(r)&&(t=!0),e.destroy(),this.layerData.delete(r))}this._owner?.updateTileSize(this),t&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){const e=this.layerData.values();for(const t of e)if(t.hasData())return!0;return!1}dispose(){"unloaded"!==this.status&&(l._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){0===--this._referenced&&(this._owner?.onDisposeTile(this),this.dispose(),this.stage=null)}retain(){++this._referenced}get cachedMemory(){return this._usedMemory}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(e){this.featureIndex?.clear();let t=!1;if(e){const{bucketsWithData:r,emptyBuckets:i}=e,s=this._createRenderBuckets(r);if(i&&i.byteLength>0){const e=new Uint32Array(i);for(const t of e)this._deleteLayerData(t)}for(const[e,r]of s)this._deleteLayerData(e),3===r.type&&(this.symbols.set(e,r.symbols),t=!0),this._usedMemory+=r.usedMemory,this.layerData.set(e,r);this._owner?.updateTileSize(this)}this._hasSymbolBuckets=!1;for(const e of this.layerData.values())3===e.type&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const t=this.resolution/(e.resolution*e.pixelRatio),i=this.width/this.rangeX*t,s=this.height/this.rangeY*t,n=[0,0];e.toScreen(n,[this.x,this.y]);const o=this.transforms.tileUnitsToPixels;r.identity(o),r.translate(o,o,n),r.rotate(o,o,Math.PI*e.rotation/180),r.scale(o,o,[i,s,1])}_createTransforms(){return{displayViewScreenMat3:i.create(),tileMat3:i.create(),tileUnitsToPixels:i.create()}}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;for(const r of e.values())t.has(r)||(r.destroy(),t.add(r));e.clear()}_createRenderBuckets(e){const t=new Map,r=new Map;for(const i of e){const e=this._deserializeBucket(i,r);for(const r of e.layerUIDs)t.set(r,e)}return t}_deserializeBucket(e,t){let r=t.get(e);if(r)return r;switch(new Uint32Array(e)[0]){case 1:r=new n.FillRenderBucket(e,this.styleRepository);break;case 2:r=new n.LineRenderBucket(e,this.styleRepository);break;case 3:r=new n.SymbolRenderBucket(e,this.styleRepository,this);break;case 4:r=new n.CircleRenderBucket(e,this.styleRepository)}return t.set(e,r),r}_deleteLayerData(e){if(!this.layerData.has(e))return;const t=this.layerData.get(e);this._usedMemory-=t.usedMemory,t.destroy(),this.layerData.delete(e)}}e.VectorTile=l,e.tracer=null,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/vectorTiles/RenderBucket":function(){define(["exports","../../../../core/maybe","../../../../core/memoryEstimations","../../tiling/TileInfoView","../../tiling/TileKey","../../tiling/TileQueue","../../tiling/TileStrategy","./decluttering/util","../../../webgl/BufferObject","../../../webgl/VertexArrayObject","../../../webgl/VertexBuffer"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";class d{constructor(e,t){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let r=1;const i=new Uint32Array(e);this.layerUIDs=[];const s=i[r++];for(let e=0;e<s;e++)this.layerUIDs[e]=i[r++];this.bufferDataOffset=r,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(e){null!=this._data&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}}e.CircleRenderBucket=class extends d{constructor(e,t){super(e,t),this.type=4,this.circleIndexStart=0,this.circleIndexCount=0;const r=new Uint32Array(e);let i=this.bufferDataOffset;this.circleIndexStart=r[i++],this.circleIndexCount=r[i++],this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=t.disposeMaybe(this.vao)}doPrepareForRendering(e,t,r){const i=new Uint32Array(t),s=new Int32Array(i.buffer),n=i[r++],o=this.layer.circleMaterial,a=new u.VertexBuffer(e,o.geometryLayout,new Int32Array(s.buffer,4*r,n));r+=n;const d=i[r++],h=l.BufferObject.createIndex(e,35044,new Uint32Array(i.buffer,4*r,d));r+=d,this.vao=new c.VertexArrayObject(e,a,h)}},e.FillRenderBucket=class extends d{constructor(e,t){super(e,t),this.type=1,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const r=new Uint32Array(e);let i=this.bufferDataOffset;this.fillIndexStart=r[i++],this.fillIndexCount=r[i++],this.outlineIndexStart=r[i++],this.outlineIndexCount=r[i++];const s=r[i++];if(s>0){this.patternMap=new Map;for(let e=0;e<s;e++){const e=r[i++],t=r[i++],s=r[i++];this.patternMap.set(e,[t,s])}}this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.fillVAO?.cachedMemory??0)+(this.outlineVAO?.cachedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=t.disposeMaybe(this.fillVAO),this.outlineVAO=t.disposeMaybe(this.outlineVAO)}doPrepareForRendering(e,t,r){const i=new Uint32Array(t),s=new Int32Array(i.buffer),n=i[r++],o=this.layer,a=o.fillMaterial,d=new u.VertexBuffer(e,a.geometryLayout,new Int32Array(s.buffer,4*r,n));r+=n;const h=i[r++],p=l.BufferObject.createIndex(e,35044,new Uint32Array(i.buffer,4*r,h));r+=h;const f=i[r++],m=o.outlineMaterial,g=new u.VertexBuffer(e,m.geometryLayout,new Int32Array(s.buffer,4*r,f));r+=f;const y=i[r++],_=l.BufferObject.createIndex(e,35044,new Uint32Array(i.buffer,4*r,y));r+=y,this.fillVAO=new c.VertexArrayObject(e,d,p),this.outlineVAO=new c.VertexArrayObject(e,g,_)}},e.LineRenderBucket=class extends d{constructor(e,t){super(e,t),this.type=2,this.lineIndexStart=0,this.lineIndexCount=0;const r=new Uint32Array(e);let i=this.bufferDataOffset;this.lineIndexStart=r[i++],this.lineIndexCount=r[i++];const s=r[i++];if(s>0){this.patternMap=new Map;for(let e=0;e<s;e++){const e=r[i++],t=r[i++],s=r[i++];this.patternMap.set(e,[t,s])}}this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=t.disposeMaybe(this.vao)}doPrepareForRendering(e,t,r){const i=new Uint32Array(t),s=new Int32Array(i.buffer),n=i[r++],o=this.layer.lineMaterial,a=new u.VertexBuffer(e,o.geometryLayout,new Int32Array(s.buffer,4*r,n));r+=n;const d=i[r++],h=l.BufferObject.createIndex(e,35044,new Uint32Array(i.buffer,4*r,d));r+=d,this.vao=new c.VertexArrayObject(e,a,h)}},e.RenderBucketBase=d,e.SymbolRenderBucket=class extends d{constructor(e,t,r){super(e,t),this.type=3,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const i=new Uint32Array(e),n=new Int32Array(e),o=new Float32Array(e);let l=this.bufferDataOffset;this.isIconSDF=!!i[l++];const c=i[l++],u=i[l++],d=i[l++],h=new s(c,u,d,0),p=i[l++];for(let e=0;e<p;e++){const e=i[l++],t=i[l++],r=i[l++];this.iconPerPageElementsMap.set(e,[t,r])}const f=i[l++];for(let e=0;e<f;e++){const e=i[l++],t=i[l++],r=i[l++];this.glyphPerPageElementsMap.set(e,[t,r])}const m=i[l++],g=i[l++];this.iconOpacity=new Int32Array(m),this.textOpacity=new Int32Array(g),l=a.deserializeSymbols(i,n,o,l,this.symbols,r,h),this.bufferDataOffset=l}get usedMemory(){return(this.data?.byteLength??0)+(this.iconVAO?.cachedMemory??0)+(this.textVAO?.cachedMemory??0)+r.estimateNumberArrayMemory(this.iconOpacity)+r.estimateNumberArrayMemory(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const t of this.iconPerPageElementsMap.values())e+=t[1];for(const t of this.glyphPerPageElementsMap.values())e+=t[1];return e/3}doDestroy(){this.iconVAO=t.disposeMaybe(this.iconVAO),this.textVAO=t.disposeMaybe(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,t=this.iconVAO.buffer("opacity");e.length>0&&e.byteLength===t.usedMemory&&t.setSubData(e,0,0,e.length);const r=this.textOpacity,i=this.textVAO.buffer("opacity");r.length>0&&r.byteLength===i.usedMemory&&i.setSubData(r,0,0,r.length)}doPrepareForRendering(e,t,r){const i=new Uint32Array(t),s=new Int32Array(i.buffer),n=i[r++],o=this.layer,a=o.iconMaterial,d=new u.VertexBuffer(e,a.geometryLayout,new Int32Array(s.buffer,4*r,n));r+=n;const h=i[r++],p=l.BufferObject.createIndex(e,35044,new Uint32Array(i.buffer,4*r,h));r+=h;const f=i[r++],m=o.textMaterial,g=new u.VertexBuffer(e,m.geometryLayout,new Int32Array(s.buffer,4*r,f));r+=f;const y=i[r++],_=l.BufferObject.createIndex(e,35044,new Uint32Array(i.buffer,4*r,y));r+=y;const b=new u.VertexBuffer(e,a.opacityLayout,this.iconOpacity.buffer),v=new u.VertexBuffer(e,m.opacityLayout,this.textOpacity.buffer);this.iconVAO=new c.VertexArrayObject(e,new Map([["geometry",d],["opacity",b]]),p),this.textVAO=new c.VertexArrayObject(e,new Map([["geometry",g],["opacity",v]]),_)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/webgl/TiledDisplayObject":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat3","../DisplayObject","../../tiling/TileKey"],function(e,t,r,i){"use strict";class s extends r.DisplayObject{constructor(e,t,r,s,n,o,a=n,l=o){super(),this.tileDebugInfoTexture=null,this.debugInfo={display:{length:0,minOrderedLength:0,minUnorderedLength:0,triangleCount:0},memory:{bytesUsed:0,bytesReserved:0}},this._destroyed=!1,this.key=new i(e),this.resolution=t,this.x=r,this.y=s,this.width=n,this.height=o,this.rangeX=a,this.rangeY=l}destroy(){super.destroy(),this.tileDebugInfoTexture&&(this.tileDebugInfoTexture.dispose(),this.tileDebugInfoTexture=null),this._destroyed=!0}get debugSlot(){let e=this;for(;e.parent!==this._stage;){if(!e.parent)return 0;e=e.parent}return this._stage.children.indexOf(e)}setTransform(e){const r=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[s,n]=e.toScreenNoRotation([0,0],[this.x,this.y]),o=this.width/this.rangeX*r,a=this.height/this.rangeY*r;t.set(i,o,0,0,0,a,0,s,n,1),t.multiply(this.transforms.displayViewScreenMat3,e.displayViewMat3,i)}get destroyed(){return this._destroyed}}e.TiledDisplayObject=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/DisplayObject":function(){define(["exports","../../../core/arrayUtils","../../../core/Evented","./transitions/FadeTransition"],function(e,t,r,i){"use strict";class s extends r.Evented{constructor(){super(...arguments),this._transitionables=null,this._clips=null,this._fadeTransition=null,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get computedOpacity(){return this._fadeTransition?.computedOpacity??this.opacity}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get fadeTransitionEnabled(){return null!==this._fadeTransition}set fadeTransitionEnabled(e){!this._fadeTransition&&e?(this._fadeTransition=new i.FadeTransition({opacity:this.opacity,visible:this.visible}),this.addTransitionable(this._fadeTransition)):this._fadeTransition&&!e&&(this.removeTransitionable(this._fadeTransition),this._fadeTransition=null)}get inFadeTransition(){return this._fadeTransition?.transitioning??!1}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this._fadeTransition&&(this._fadeTransition.opacity=this._opacity),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const t=this._stage;this._stage=e,e?this._stage?.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):t?.trashDisplayObject(this)}get transforms(){return null==this._transforms&&(this._transforms=this._createTransforms()),this._transforms}get transitioning(){return this.isTransitioning()}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._fadeTransition&&(this._fadeTransition.visible=this._visible),this.requestRender())}get hasLabels(){return!1}get hasHighlight(){return!1}get hasBlending(){return!1}addTransitionable(e){this._transitionables??=[],this._transitionables.push(e),this.requestRender()}removeTransitionable(e){e.endTransition(),this._transitionables&&t.remove(this._transitionables,e),this.requestRender()}fadeIn(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeIn();return this.opacity=1,this.requestRender(),e}fadeOut(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeOut();return this.opacity=0,this.requestRender(),e}endTransitions(){if(this._transitionables){for(const e of this._transitionables)e.endTransition();this.requestRender()}}beforeRender(e){this.transitionStep(e.deltaTime,e.state.scale),this.setTransform(e.state)}afterRender(e){this.transitioning&&this.requestRender()}remove(){this.parent?.removeChild(this)}setTransform(e){}processRender(e){this.stage&&(this._fadeTransition?.computedVisible??this.visible)&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.endTransitions(),this.onDetach(),this.emit("detach")}isTransitioning(){return this._transitionables?.some(e=>e.transitioning)??!1}transitionStep(e,t){if(this._transitionables)for(const r of this._transitionables)r.transitionStep(e,t)}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}e.DisplayObject=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/transitions/FadeTransition":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a,l){"use strict";e.FadeTransition=class extends r{constructor(e){super(e),this.computedOpacity=1,this.computedVisible=!0,this.opacity=1,this.visible=!0,this._fadeOutResolver=null,this._fadeInResolver=null}get transitioning(){return(this._fadeOutResolver||!this.visible?0:this.opacity)!==this.computedOpacity}endTransition(){this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeInResolver=this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0}fadeIn(){return this._fadeInResolver||(this.opacity=1,this.computedOpacity=0,this._fadeOutResolver?.(),this._fadeOutResolver=null,this._fadeInResolver=s.createResolver()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver?.(),this._fadeInResolver=null,this._fadeOutResolver=s.createResolver()),this._fadeOutResolver.promise}transitionStep(e,t){const r=i("mapview-transitions-duration"),s=r?1/r:0;if(0===s)this.computedOpacity=this.opacity,this.computedVisible=this.visible;else{const t=this._fadeOutResolver||!this.visible?0:this.opacity,r=this.computedOpacity;if(r===t)this.computedVisible=this.visible;else{const i=e*s;this.computedOpacity=r>t?Math.max(t,r-i):Math.min(t,r+i),this.computedVisible=this.computedOpacity>0}}this.transitioning||(this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeOutResolver=this._fadeInResolver=null)}},t.__decorate([n.property()],e.FadeTransition.prototype,"computedOpacity",void 0),t.__decorate([n.property()],e.FadeTransition.prototype,"computedVisible",void 0),t.__decorate([n.property()],e.FadeTransition.prototype,"opacity",void 0),t.__decorate([n.property()],e.FadeTransition.prototype,"visible",void 0),t.__decorate([n.property()],e.FadeTransition.prototype,"transitioning",null),t.__decorate([n.property()],e.FadeTransition.prototype,"_fadeOutResolver",void 0),t.__decorate([n.property()],e.FadeTransition.prototype,"_fadeInResolver",void 0),e.FadeTransition=t.__decorate([l.subclass("esri.views.2d.engine.transitions.FadeTransition")],e.FadeTransition),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/webgl/definitions":function(){define(["exports"],function(e){"use strict";e.MAX_TILE_RESHUFFLES_PER_FRAME=1,e.RESHUFFLING_EXEMPT_DRAW_CALLS=10,e.RESHUFFLING_EXEMPT_MEMORY_BYTES=1<<20,e.RESHUFFLING_TARGET_DRAW_EFFICIENCY=.75,e.RESHUFFLING_TARGET_MEMORY_EFFICIENCY=.75,e.angleFactor256=256/360,e.animationUnit=2,e.attributeStoreInitialSize=256,e.attributeStoreTextureSize=1024,e.averageGlyphMosaicItem={metrics:{width:15,height:17,left:0,top:-7,advance:14}},e.backbufferStencilClipped=1,e.backbufferStencilVisible=0,e.bitsetFillHasPatternHeightPrecisionFactor=32,e.bitsetFillHasPatternWidthPrecisionFactor=64,e.bitsetFillHasUnresolvedReplacementColor=8,e.bitsetFillRandomPatternOffset=4,e.bitsetGenericConsiderAlphaOnly=16,e.bitsetGenericLockColor=2,e.bitsetLineScaleDash=4,e.bitsetMarkerAlignmentMap=1,e.bitsetMarkerAlignmentScreen=0,e.bitsetMarkerOutlineAllowColorOverride=4,e.bitsetMarkerScaleSymbolsProportionally=8,e.bitsetTypeFillOutline=1,e.bufferDataMinimumSize=128,e.bufferDataPoolSize=4,e.chartMaxFields=10,e.collisionBoxPadding=16,e.collisionBucketSize=128,e.collisionEarlyRejectBucketSize=16,e.collisionMaxZoomDelta=1,e.collisionPlacementPadding=8,e.collisionTileBoxSize=4,e.compressionFactorForU16=128,e.dataDrivenUnit0=4,e.dataDrivenUnit1=5,e.dataDrivenUnit2=6,e.debugLabels=!1,e.defaultSdfTextureSize=128,e.displayRecordIntPerElement=8,e.dotDensityMaxFields=8,e.effectFlag0=128,e.enableEarlyLabelDiscard=!1,e.extrudeScale=64,e.filterFlag0=64,e.filterFlagsUnit=1,e.glyphSize=24,e.gpgpuUnit=12,e.gradientTextureExternalPadding=1,e.heuristicGlyphsPerFeature=10,e.heuristicGlyphsPerLine=50,e.hittestSmallSymbolThreshold=3,e.hittestToleranceDesktop=1,e.hittestToleranceMobile=3,e.hittestToleranceSmallSymbol=3,e.labelPlacementOffsetPadding=4,e.localTimeOriginUnit=13,e.magicLabelLineHeight=29,e.maxGeohashLevel=12,e.maxGpuUploadsPerFrame=2,e.maxHighlightReasons=6,e.maxRepresentableInt=16777216,e.maxTextLineWidth=512,e.minMaxZoomPrecisionFactor=10,e.minTextLineWidth=32,e.nanMagicNumber=1e-30,e.patchPixelBufferAllocSize=500,e.patternFillRasterizationScale=2,e.pictureFillColor=4294967295,e.randomInsidePolygonTextureSize=1024,e.rasterTileSize=256,e.rasterizedVectorMarkerMinSize=128,e.spritePadding=4,e.svgSdfTextureInnerSize=248,e.svgSdfTextureSize=256,e.textureBindingBitmap=0,e.textureBindingGlyphAtlas=0,e.textureBindingHighlight0=5,e.textureBindingHighlight1=6,e.textureBindingRenderer0=5,e.textureBindingRenderer1=6,e.textureBindingSpriteAtlas=0,e.textureUploadManagerBudget=4,e.textureUploadManagerChunkSize=128,e.thinLineHalfWidthThreshold=1.05,e.tileSize=512,e.visualVariableUnit=3,e.vtlHighResCutoff=1.15,e.vtlTextureBindingUnitGlyphs=6,e.vtlTextureBindingUnitSprites=5,e.webglMaxInnerStops=6,e.webglMaxStops=8,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/vectorTiles/decluttering/SymbolRepository":function(){define(["exports","./core","./util"],function(e,t,r){"use strict";class i{static fromSymbols(e,t){let a=e.length;if(a>=s){let s=t;do{s/=2,a/=4}while(a>n&&s>o);const l=new r.GridIndex(t,t,s);for(const t of e)l.getCell(t.xTile,t.yTile).push(t);return new i(t,e,l)}return new i(t,e,null)}constructor(e,t,r){this.tileCoordRange=e,this._symbols=t,this._index=r}addSymbols(e){for(const t of e)this._symbols.push(t);if(this._index)for(const t of e)this._index.getCell(t.xTile,t.yTile).push(t)}removeSymbols(e){const t=new Set(e);if(this._symbols=this._symbols.filter(e=>!t.has(e)),this._index)for(const e of this._index.cells)for(let r=0;r<e.length;r++)e[r]=e[r].filter(e=>!t.has(e))}getSymbols(){return this._symbols}getCandidate(e,t,r,i){if(!this._index){for(const s of this._symbols)if(r===s.hash&&Math.abs(e-s.xTile)<=i&&Math.abs(t-s.yTile)<=i)return s;return null}const s=this._index.getCellSpan(e-i,t-i,e+i,t+i),[n,o,a,l]=s;for(let s=o;s<=l;s++)for(let o=n;o<=a;o++){const n=this._index.cells[s][o];for(const s of n)if(r===s.hash&&Math.abs(e-s.xTile)<=i&&Math.abs(t-s.yTile)<=i)return s}return null}}const s=32,n=8,o=64;function a(e){const t=new Map;for(const r of e){const e=r.labelClassId;let i=t.get(e);i||(i=[],t.set(e,i)),i.push(r)}return t}e.SymbolRepository=class{constructor(e,t){this.tileCoordRange=e,this._visibleTiles=t,this._indexMapByTile=new Map,this._uniqueSymbolsByStyleLayerId=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}registerVectorTile(e,t){const r=this._ensureIndexMap(e),i=t?.values()??r.keys();for(const e of i){const t=r.get(e);t&&(this._removeSymbols(e,t.getSymbols()),r.delete(e))}this._addSymbols(e.key,r,e.symbols),this._invalidate()}unregisterVectorTile(e){this._removeTile(e),this._invalidate()}registerFeatureTile(e){this._ensureIndexMap(e),this._invalidate()}unregisterFeatureTile(e){this._removeTile(e),this._invalidate()}insertFeatureTileMetrics(e,t){const r=this._indexMapByTile.get(e);if(!r)throw new Error(`tile ${e.id} not registered!`);this._addSymbols(e.key,r,a(t)),this._invalidate()}removeFeatureTileMetrics(e,t){const r=this._indexMapByTile.get(e);if(!r)return;const i=a(t);for(const[e,t]of r.entries()){const r=i.get(e);r&&(t.removeSymbols(r),this._removeSymbols(e,r))}this._invalidate()}deleteStyleLayers(e){for(const t of this._indexMapByTile.values())for(const r of e){const e=t.get(r);e&&(this._removeSymbols(r,e.getSymbols()),t.delete(r))}this._invalidate()}querySymbols(e,t,i,s){const n=[];for(const[s,o]of this._uniqueSymbolsByStyleLayerId.entries())for(const a of o){const o=a.tileSymbols.find(e=>e.selectedForRendering);o&&r.isSearchCircleOverlapingSymbol(o,e,t*(window.devicePixelRatio||1),i)&&n.push({vtlSymbol:o,styleLayerUID:s,tileKey:o.tile.key})}return n}_ensureIndexMap(e){let t=this._indexMapByTile.get(e);return t||(t=new Map,this._indexMapByTile.set(e,t)),t}_invalidate(){this._uniqueSymbolLayerArray=null}_addSymbols(e,t,r){for(const[e,s]of r){let r=t.get(e);r?r.addSymbols(s):(r=i.fromSymbols(s,this.tileCoordRange),t.set(e,r))}this._updateUniqueSymbols(e,r)}_removeTile(e){const t=this._indexMapByTile.get(e);if(t){for(const[e,r]of t.entries())this._removeSymbols(e,r.getSymbols());this._indexMapByTile.delete(e),this._invalidate()}}_removeSymbols(e,t){for(const r of t){const t=r.uniqueSymbol;if(t){if(t.tileSymbols=t.tileSymbols.filter(e=>e!==r),0===t.tileSymbols.length){const r=this._uniqueSymbolsByStyleLayerId.get(e);r.delete(t),0===r.size&&this._uniqueSymbolsByStyleLayerId.delete(e)}r.uniqueSymbol=null}}}_updateUniqueSymbols(e,r){if(0!==r.size){for(const t of this._visibleTiles)t.parentTile||t.key.world!==e.world||t.key.level===e.level&&!t.key.equals(e)||this._matchSymbols(t,e,r);for(const[e,i]of r)for(const r of i)if(!r.uniqueSymbol){r.uniqueSymbol=new t.UniqueSymbol(r);let i=this._uniqueSymbolsByStyleLayerId.get(e);i||(i=new Set,this._uniqueSymbolsByStyleLayerId.set(e,i)),i.add(r.uniqueSymbol)}}}_matchSymbols(e,t,i){if(e.key.level>t.level){const r=e.key.level-t.level;if(e.key.row>>r!==t.row||e.key.col>>r!==t.col)return}if(t.level>e.key.level){const r=t.level-e.key.level;if(t.row>>r!==e.key.row||t.col>>r!==e.key.col)return}const s=new Map;for(const[n,o]of i){const i=[],a=20+(e.key.level<t.level?1:1<<e.key.level-t.level),l=this._indexMapByTile.get(e),c=l?.get(n);if(c)for(const s of o){if(s.uniqueSymbol)continue;const n=r.tileCoordChangeX(this.tileCoordRange,s.xTile,t,e.key),o=r.tileCoordChangeY(this.tileCoordRange,s.yTile,t,e.key),l=-20,u=this.tileCoordRange+20;if(!(n>=l&&n<u&&o>=l&&o<u)){i.push(s);continue}const d=c.getCandidate(n,o,s.hash,a),h=d?.uniqueSymbol;h?(s.uniqueSymbol=h,h.tileSymbols.push(s)):i.push(s)}i.length>0&&s.set(n,i)}for(const r of e.childrenTiles||[])this._matchSymbols(r,t,s)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsByStyleLayerId,t=new Array(e.size);let r,i=0;for(const[s,n]of e){const e=new Array(n.size);r=0;for(const t of n)e[r++]=t;t[i]={styleLayerUID:s,uniqueSymbols:e},i++}return t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/webgl/RenderableTile":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/mat3f32","./TiledDisplayObject"],function(e,t,r){"use strict";class i extends r.TiledDisplayObject{_createTransforms(){return{displayViewScreenMat3:t.create(),tileMat3:t.create()}}}e.RenderableTile=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/webgl/TileReshuffleManager":function(){define(["exports"],function(e){"use strict";e.TileReshuffleManager=class{constructor(){this._candidateTiles=[]}schedule(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}reshuffle(e){const t=[];for(const r of this._candidateTiles)e>0?(r.reshuffle(),e--):t.push(r);this._candidateTiles=t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/BlendLayersTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","./TileBlendTechniqueConfiguration","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends r.TileBlendTechniqueConfiguration{constructor(){super(...arguments),this.background=0}}t.__decorate([i.parameter({count:2})],s.prototype,"background",void 0),e.BlendLayersTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TileBlendTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","./BlendModeTechniqueConfiguration","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends r.BlendModeTechniqueConfiguration{constructor(){super(...arguments),this.output=1,this.baseOpacityMode=0,this.premultipliedSource=0}}t.__decorate([i.parameter({count:5})],s.prototype,"output",void 0),t.__decorate([i.parameter({count:2})],s.prototype,"baseOpacityMode",void 0),t.__decorate([i.parameter({count:2})],s.prototype,"premultipliedSource",void 0),e.TileBlendTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/BlendModeTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.blendMode=0}}t.__decorate([r.parameter({count:31})],i.prototype,"blendMode",void 0),e.BlendModeTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/RasterColorizerTechnique":function(){define(["require","exports","../../../chunks/RasterColorizer.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../webgl-engine/lib/DefaultVertexBufferLayouts","../../webgl/VertexAttributeLocations"],function(e,t,r,i,s,n,o){"use strict";class a extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.RasterColorizer,()=>new Promise((t,r)=>e(["../webgl-engine/core/shaderLibrary/raster/RasterColorizer.glsl"],t,r))),o.fromLayout(n.Pos2TexF16))}}t.RasterColorizerTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/RasterColorizer.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/webgl-engine/core/shaderLibrary/raster/Colormap.glsl","../views/3d/webgl-engine/core/shaderLibrary/raster/Common.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/TileComposite.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl","../views/3d/webgl-engine/core/shaderModules/BooleanPassUniform","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/FloatsPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/IntegerPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";class m extends i.CommonPassParameters{constructor(e,r,i,s,n,o){super(e,s,n),this.colormap=r,this.symbolizer=i,this.u_colormap=o,this.backgroundColor=t.ZEROS,this.fboTexture=null,this.baseOpacity=1}}class g extends m{}class y extends m{}function _(e){const t=new f.ShaderBuilder;return t.include(n.TileComposite),t.include(i.Common,e),t.include(r.Colormap,e),t.include(s.TileBackground,e),t.fragment.code.add(d.glsl`vec4 applyBackgroundBlend(vec4 layerColor) {
return blendLayers(vuv, layerColor, u_opacity);
}`),0===e.colorizerType?function(e,t){e.fragment.uniforms.add(new h.IntegerPassUniform("u_bandCount",e=>e.symbolizer.u_bandCount),new u.FloatsPassUniform("u_minCutOff",e=>e.symbolizer.u_minCutOff,3),new u.FloatsPassUniform("u_maxCutOff",e=>e.symbolizer.u_maxCutOff,3),new u.FloatsPassUniform("u_factor",e=>e.symbolizer.u_factor,3),new c.FloatPassUniform("u_minOutput",e=>e.symbolizer.u_minOutput),new c.FloatPassUniform("u_maxOutput",e=>e.symbolizer.u_maxOutput),new a.BooleanPassUniform("u_useGamma",e=>e.symbolizer.u_useGamma),new u.FloatsPassUniform("u_gamma",e=>e.symbolizer.u_gamma,3),new u.FloatsPassUniform("u_gammaCorrection",e=>e.symbolizer.u_gammaCorrection,3),new c.FloatPassUniform("u_opacity",e=>e.common.u_opacity)),e.fragment.code.add(d.glsl`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const r=t.applyColormap?d.glsl`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:d.glsl`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;e.fragment.main.add(d.glsl`
    vec2 pixelLocation = getPixelLocation(uv);
    if (isOutside(pixelLocation)) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }

    vec4 currentPixel = getPixel(pixelLocation);
    ${0===t.stretchType?d.glsl`fragColor = applyBackgroundBlend(currentPixel);`:d.glsl`
    if (currentPixel.a == 0.0) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }
    if (u_bandCount == 1) {
      float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      ${r}
    } else {
      float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
      float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
      fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
    }`}`)}(t,e):1===e.colorizerType?function(e){e.fragment.main.add(d.glsl`vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));`)}(t):2===e.colorizerType&&function(e,t){const r=e.fragment;r.uniforms.add(new p.Texture2DPassUniform("u_image",e=>e.u_image),new h.IntegerPassUniform("u_hillshadeType",e=>e.symbolizer.u_hillshadeType),new u.FloatsPassUniform("u_sinZcosAs",e=>e.symbolizer.u_sinZcosAs,6),new u.FloatsPassUniform("u_sinZsinAs",e=>e.symbolizer.u_sinZsinAs,6),new u.FloatsPassUniform("u_cosZs",e=>e.symbolizer.u_cosZs,6),new u.FloatsPassUniform("u_weights",e=>e.symbolizer.u_weights,6),new l.Float2PassUniform("u_factor",e=>e.symbolizer.u_factor),new c.FloatPassUniform("u_minValue",e=>e.symbolizer.u_minValue),new c.FloatPassUniform("u_maxValue",e=>e.symbolizer.u_maxValue),new l.Float2PassUniform("u_srcImageSize",e=>e.common.u_srcImageSize)),r.include(o.ColorConversion),r.code.add(d.glsl`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),r.code.add(d.glsl`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=t.applyColormap?d.glsl`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:d.glsl`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;r.main.add(d.glsl`
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}`)}(t,e),t}const b=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:y,ColorizerStretchUniforms:g,ColorizerUniforms:m,build:_},Symbol.toStringTag,{value:"Module"}));e.ColorizerHillshadeUniforms=y,e.ColorizerStretchUniforms=g,e.ColorizerUniforms=m,e.RasterColorizer=b,e.build=_})},"esri/views/3d/webgl-engine/core/shaderLibrary/raster/Colormap.glsl":function(){define(["exports","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform"],function(e,t,r,i){"use strict";e.Colormap=function(e){e.fragment.uniforms.add(new i.Texture2DPassUniform("u_colormap",e=>e.u_colormap),new t.FloatPassUniform("u_colormapOffset",e=>e.colormap.u_colormapOffset),new t.FloatPassUniform("u_colormapMaxIndex",e=>e.colormap.u_colormapMaxIndex),new t.FloatPassUniform("u_opacity",e=>e.common.u_opacity)),e.fragment.code.add(r.glsl`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/raster/Common.glsl":function(){define(["exports","./Projection.glsl","../terrain/TileComposite.glsl","../../shaderModules/BooleanPassUniform","../../shaderModules/Float2PassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform"],function(e,t,r,i,s,n,o){"use strict";class a extends r.TileCompositePassParameters{constructor(e,t,r){super(),this.common=e,this.u_image=t,this.u_transformGrid=r}}e.Common=function(e,r){e.include(t.Projection),e.fragment.uniforms.add(new o.Texture2DPassUniform("u_image",e=>e.u_image),new i.BooleanPassUniform("u_flipY",e=>e.common.u_flipY),new i.BooleanPassUniform("u_applyTransform",e=>e.common.u_applyTransform));const{requireBilinearWithNN:a}=r;a&&e.fragment.uniforms.add(new s.Float2PassUniform("u_srcImageSize",e=>e.common.u_srcImageSize)),e.fragment.code.add(n.glsl`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),a?e.fragment.code.add(n.glsl`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):e.fragment.code.add(n.glsl`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)},e.CommonPassParameters=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/raster/Projection.glsl":function(){define(["exports","../../shaderModules/Float2PassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform"],function(e,t,r,i){"use strict";e.Projection=function(e){e.fragment.uniforms.add(new i.Texture2DPassUniform("u_transformGrid",e=>e.u_transformGrid),new t.Float2PassUniform("u_transformSpacing",e=>e.common.u_transformSpacing),new t.Float2PassUniform("u_targetImageSize",e=>e.common.u_targetImageSize)),e.fragment.code.add(r.glsl`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/RasterColorizerTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","./TileBlendTechniqueConfiguration","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends r.TileBlendTechniqueConfiguration{constructor(){super(...arguments),this.colorizerType=0,this.stretchType=0,this.applyColormap=!0,this.requireBilinearWithNN=!1}}t.__decorate([i.parameter({count:3})],s.prototype,"colorizerType",void 0),t.__decorate([i.parameter({count:2})],s.prototype,"stretchType",void 0),t.__decorate([i.parameter()],s.prototype,"applyColormap",void 0),t.__decorate([i.parameter()],s.prototype,"requireBilinearWithNN",void 0),e.RasterColorizerTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/support/MultiSizeFramebuffer":function(){define(["exports","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/RenderbufferDescriptor","../../../webgl/TextureDescriptor"],function(e,t,r,i,s){"use strict";e.MultiSizeFramebuffer=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const n=this._fbos.get(e);if(n)return n;const o=new r.FramebufferObject(this._rctx,new s.TextureDescriptor(e),new i.RenderbufferDescriptor(t.SizedDepthStencilFormat.DEPTH24_STENCIL8,e));return this._fbos.set(e,o),o}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/glUtil3D":function(){define(["exports","../../../../geometry/support/float16","./DefaultVertexBufferLayouts","./VertexArrayObject","../../../webgl/Texture","../../../webgl/TextureDescriptor","../../../webgl/VertexBuffer"],function(e,t,r,i,s,n,o){"use strict";e.createEmptyTexture=function(e){const t=new n.TextureDescriptor(4);return t.samplingMode=9728,new s.Texture(e,t)},e.createQuadVAO=function(e,s=0,n=-1,a=1){const l=1===s,c=l?t.hasNativeFloat16Array?new Float32Array([n,n,0,a,n,0,n,a,0,a,a,0]):new Float32Array([n,n,0,0,a,n,1,0,n,a,0,1,a,a,1,1]):new Float32Array([n,n,a,n,n,a,a,a]);if(l&&t.hasNativeFloat16Array){const e=t.makeFloat16Array(c.buffer);e[10]=e[17]=e[22]=e[23]=1}const u=l?t.hasNativeFloat16Array?r.Pos2TexF16:r.Pos2TexF32:r.Pos2;return new i.VertexArrayObject(e,new o.VertexBuffer(e,u,c))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TileRenderInfo":function(){define(["exports","../../../core/PooledArray"],function(e,t){"use strict";class r{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}}e.TileRenderInfo=class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new t({allocator:e=>e||new r})}},e.VTLNeighhborInfo=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TileTexture":function(){define(["exports","../../webgl/enums","../../webgl/textureUtils"],function(e,t,r){"use strict";function i(e,t=r.isCompressedFormat(e.internalFormat)){return`${e.width} ${e.pixelFormat} ${t}`}e.TileTexture=class{constructor(e,r){this._texture=e,this._cache=r,this.type="tile-texture",this._refCount=1,this._texture.descriptor.context.instanceCounter.increment(t.ResourceType.TileTexture,this)}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&(this._cache?(this._texture.abortCompression(),this._cache.put(i(this.descriptor),this)):this.dispose())}dispose(){this._texture.descriptor.context.instanceCounter.decrement(t.ResourceType.TileTexture,this),this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get cachedMemory(){return this._texture.usedMemory}},e.getCacheKey=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/output/BlendOptions":function(){define(["exports"],function(e){"use strict";e.blendModeFromString={normal:0,average:1,lighten:2,lighter:3,screen:5,plus:4,"color-dodge":6,darken:7,multiply:8,"color-burn":9,overlay:10,"soft-light":11,"hard-light":12,"vivid-light":13,hue:14,saturation:15,luminosity:16,color:17,difference:26,exclusion:27,minus:28,invert:29,reflect:30,"destination-over":18,"destination-atop":19,"destination-in":20,"destination-out":21,"source-atop":22,"source-in":23,"source-out":24,xor:25},e.isCompositeBlendMode=function(e){return 18===e||19===e||20===e||21===e||22===e||23===e||24===e||25===e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/TextureCompressionWorkerHandle":function(){define(["exports","../../core/mathUtils","../../core/workers/WorkerHandle"],function(e,t,r){"use strict";function i(e,r){let i=r.width,s=r.height;return(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(i=e.width,s=e.height),(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof Uint8Array)&&(6408===r.pixelFormat||6407===r.pixelFormat)&&t.isPowerOfTwo(i)&&t.isPowerOfTwo(s)&&i>=16&&s>=16}class s extends r.WorkerHandle{constructor(e){super("TextureCompressionWorker","compress",{compress:e=>[e.data]},e)}async destroyWorkerAndSelf(){await this.broadcast({},"destroy"),this.destroy()}isCompressible(e,t){return i(e,t)}}e.TextureCompressionWorkerHandle=s,e.isCompressible=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/workers/WorkerHandle":function(){define(["exports","../arrayUtils","../handleUtils","../Logger","../promiseUtils","./workers"],function(e,t,r,i,s,n){"use strict";function o(){}e.WorkerHandle=class{constructor(e,t,r,s,o={}){this._mainMethod=t,this._transferLists=r,this._listeners=[],this._promise=n.open(e,{...o,schedule:s}).then(e=>{if(void 0===this._thread){this._thread=e,this._promise=null,o.hasInitialize&&this.broadcast({},"initialize");for(const e of this._listeners)this._connectListener(e)}else e.close()}),this._promise.catch(t=>i.getLogger("esri.core.workers.WorkerHandle").error(`Failed to initialize ${e} worker: ${t}`))}on(e,i){const s={removed:!1,eventName:e,callback:i,threadHandle:null};return this._listeners.push(s),this._connectListener(s),r.makeHandle(()=>{s.removed=!0,t.remove(this._listeners,s),this._thread&&null!=s.threadHandle&&s.threadHandle.remove()})}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null,this._listeners.length=0,this._transferLists={}}invoke(e,t,r){return this.invokeMethod(this._mainMethod,e,t,r)}invokeMethod(e,t,r,i){if(this._thread){const s=this._transferLists[e],n=s?s(t):[];return this._thread.invoke(e,t,{transferList:n,signal:r,priority:i})}return this._promise?this._promise.then(()=>(s.throwIfAborted(r),this.invokeMethod(e,t,r))):Promise.reject(null)}broadcast(e,t){return this._thread?Promise.all(this._thread.broadcast(t,e)).then(o):this._promise?this._promise.then(()=>this.broadcast(e,t)):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then(t=>{e.removed||(e.threadHandle=t)})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/ComponentIntersectionData":function(){define(["exports","../../../../../core/mathUtils","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingBox","../../lib/RayIntersections"],function(e,t,r,i,s){"use strict";const n=1e-6;class o{constructor(e,t,r,i,s){this.aabb=e,this.axis=t,this.d=r,this.midStartIndex=i,this.rightStartIndex=s}}class a{constructor(e,s,n,a){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=s,this.positions=a,this._rayDirection=r.create(),this._callback=p,this._intersectionOptions=h,this.bspNodeTree=new Array;const f=n-s,m=new(f<u?Uint8Array:f<d?Uint16Array:Uint32Array)(f);this.triangleIndexMap=m;for(let e=0;e<f;++e)m[e]=e;{const r=function(e,t,r,i,s){const n=r-t,o=new Float32Array(6*n);for(let r=0;r<n;++r){const n=3*(r+t),a=e[n]*s,l=e[n+1]*s,c=e[n+2]*s;for(let e=0;e<3;++e){const t=i[a+e],s=i[l+e],n=i[c+e];o[6*r+e]=Math.min(t,s,n),o[6*r+3+e]=Math.max(t,s,n)}}return o}(e,s,n,a.data,a.stride),u=t.clamp(Math.log2(f/40),2,10),d=(e,t,s)=>{const n=function(e,t,r,s){if(s<=r)return i.fromValues(NaN,NaN,NaN,NaN,NaN,NaN);{const i=6*e[r];for(let e=0;e<3;++e)l[e]=t[i+0+e],c[e]=t[i+3+e]}for(let i=r+1;i<s;++i){const r=6*e[i];for(let e=0;e<3;++e)l[e]=Math.min(l[e],t[r+0+e]),c[e]=Math.max(c[e],t[r+3+e])}return i.fromValues(l[0],l[1],l[2],c[0],c[1],c[2])}(m,r,e,t),a=t-e;if(a<=40){const r=new o(n,void 0,0,e,t);return this.bspNodeTree.push(r),r}const{axis:h,midValue:p}=function(e){const t=e[3]-e[0],r=e[4]-e[1],i=e[5]-e[2],s=t>r?t>i?0:r>i?1:2:r>i?1:i>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}(n),f=function(e,t,r,i,s,n){let o=r,a=i;for(;o<a;){const r=e[o];t[6*r+s+3]<=n?++o:(--a,e[o]=e[a],e[a]=r)}let l=o;for(a=i;l<a;){const r=e[a-1];t[6*r+s]>=n?--a:(e[a-1]=e[l],e[l]=r,++l)}return{next:o,mid:l}}(m,r,e,t,h,p),g=(e,t)=>{if(s>u)return;const r=t-e;return r<40||r>=.8*a?void 0:d(e,t,s+1)},y=new o(n,h,p,f.next,f.mid);return this.bspNodeTree.push(y),y.leftNode=g(e,f.next),y.rightNode=g(f.mid,t),y};d(0,f,0)}}intersectRayTriangleRange(e,t){if(e>=t)return;const r=this.positions;s.intersectRayTriangles(this._rayFrom,this._rayDirection,e,t,this.globalTriangleVertexIndices,r.data,r.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),a.numFacesTested+=t-e}intersectRay(e,t,r,i){a.numFacesTested=0;const s=e,o=t,l=o[0]-s[0],c=o[1]-s[1],u=o[2]-s[2];if(l*l+c*c+u*u<n)return;this._rayFrom=s;const d=this._rayDirection;d[0]=l,d[1]=c,d[2]=u;const f=this.triangleIndexMap.length;this._callback=i,this._intersectionOptions=r,this.intersectRayBSP(this.bspNodeTree[0],0,f),this._callback=p,this._intersectionOptions=h}intersectRayBSP(e,t,r){const i=this._rayFrom,s=this._rayDirection;if(!function(e,t,r){const i=t,s=r;let o=0,a=1/0;for(let t=0;t<3;++t){{const r=e[t];if(i[t]<r){if(s[t]<=n)return!1;const e=(r-i[t])/s[t];o=Math.max(o,e)}else if(s[t]<=-n){const e=(r-i[t])/s[t];a=Math.min(a,e)}if(o>a)return!1}{const r=e[t+3];if(i[t]>r){if(s[t]>=-n)return!1;const e=(r-i[t])/s[t];o=Math.max(o,e)}else if(s[t]>=n){const e=(r-i[t])/s[t];a=Math.min(a,e)}if(o>a)return!1}}return!0}(e.aabb,i,s))return;const o=e.axis,a=e.d;if(i[o]<a||s[o]<0){const r=t,i=e.midStartIndex;if(r<i){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,r,i):this.intersectRayTriangleRange(r,i)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),i[o]>a||s[o]>0){const t=e.rightStartIndex,i=r;if(t<i){const r=e.rightNode;void 0!==r?this.intersectRayBSP(r,t,i):this.intersectRayTriangleRange(t,i)}}}static{this.numFacesTested=0}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}}const l=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0],u=255,d=65535,h=new s.MeshIntersectionOptions,p=()=>{};e.ComponentIntersectionData=a,e.componentMinimalSizeForIntersectionData=200,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/Overlay.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../../../geometry/support/aaBoundingRect","../ShaderOutput","../shading/MainLighting.glsl","../shading/Water.glsl","../../shaderModules/Float4DrawUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform","../../shaderModules/Texture2DUintPassUniform","../../../../../webgl/Uniform"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(e,t){return 0===e.identifier&&i.isColorOrColorEmission(e.output)?e.occludedGround?t.overlay?.allSourcesOccluders?t.overlay?.getTexture(1):t.overlay?.getTexture(4):t.overlay?.getTexture(1):0===e.identifier&&9===e.output?t.overlay?.getTexture(5):2===e.identifier?t.overlay?.getTexture(2):null}function p(e,t){const r=3===t.pbrMode||4===t.pbrMode||6===t.pbrMode;r&&e.include(n.Water,t);const{vertex:i,fragment:o,varyings:a}=e;a.add("vtcOverlay","vec4");const{output:c}=t,d=8===c;i.code.add(l.glsl`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),o.code.add(l.glsl`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),d?o.uniforms.add(new u.Texture2DUintPassUniform("overlayHighlightTexture",(e,t)=>t.overlay?.getTexture(2))).code.add(l.glsl`uvec2 getAllOverlayHighlightValuesEncoded() {
vec4 texCoords = vtcOverlay;
vec2 uvInner = texCoords.xy;
vec2 uvOuter = texCoords.zw;
bool isValidInner = isValid(uvInner, fwidth(uvInner));
bool isValidOuter = isValid(uvOuter, vec2(0.0, 0.0));
vec2 texelCoordInner = uvInner * vec2(0.5, 1.0);
vec2 texelCoordOuter = uvOuter * vec2(0.5, 1.0) + vec2(0.5,0.0);
vec2 texDim =  vec2(textureSize(overlayHighlightTexture, 0));
uvec2 texelValueInner = texelFetch(overlayHighlightTexture, ivec2(texelCoordInner * texDim), 0).rg;
uvec2 texelValueOuter = texelFetch(overlayHighlightTexture, ivec2(texelCoordOuter * texDim), 0).rg;
return
isValidInner ? texelValueInner :
isValidOuter ? texelValueOuter :
uvec2(0);
}`):(o.code.add(l.glsl`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),o.code.add(l.glsl`vec4 getOverlayColorTexel() {
vec4 texCoords = vtcOverlay;
vec2 texDim =  vec2(textureSize(ovColorTex, 0));
vec4 color0 = texelFetch(ovColorTex, ivec2(vec2(texCoords.x * 0.5, texCoords.y) * texDim), 0);
vec4 color1 = texelFetch(ovColorTex, ivec2(vec2(texCoords.z * 0.5 + 0.5, texCoords.w) * texDim), 0);
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`)),r&&(s.addMainLightDirection(o),s.addMainLightIntensity(o),o.code.add(l.glsl`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}const f=t.create();class m extends d.Uniform{constructor(e){super(e,"vec4")}}e.OverlayIM=function(e,t){const{vertex:i,fragment:s}=e;i.uniforms.add(new o.Float4DrawUniform("overlayTexOffset",(e,t)=>function(e,t){const i=t.overlay?.overlays[0]?.extent;r.hasArea(i)&&(f[0]=e.toMapSpace[0]/r.width(i)-i[0]/r.width(i),f[1]=e.toMapSpace[1]/r.height(i)-i[1]/r.height(i));const s=t.overlay?.overlays[1]?.extent;return r.hasArea(s)&&(f[2]=e.toMapSpace[0]/r.width(s)-s[0]/r.width(s),f[3]=e.toMapSpace[1]/r.height(s)-s[1]/r.height(s)),f}(e,t)),new o.Float4DrawUniform("overlayTexScale",(e,t)=>function(e,t){const i=t.overlay?.overlays[0]?.extent;r.hasArea(i)&&(f[0]=e.toMapSpace[2]/r.width(i),f[1]=e.toMapSpace[3]/r.height(i));const s=t.overlay?.overlays[1]?.extent;return r.hasArea(s)&&(f[2]=e.toMapSpace[2]/r.width(s),f[3]=e.toMapSpace[3]/r.height(s)),f}(e,t))),s.constants.add("overlayOpacity","float",1),s.uniforms.add(new c.Texture2DPassUniform("ovColorTex",(e,t)=>h(e,t))),p(e,t)},e.OverlayTerrain=function(e,t){const{vertex:r,fragment:i}=e,{output:s}=t;r.uniforms.add(new m("overlayTexOffset"),new m("overlayTexScale")),i.uniforms.add(new a.FloatPassUniform("overlayOpacity",e=>e.overlayOpacity)),8!==s&&i.uniforms.add(new c.Texture2DPassUniform("ovColorTex",(e,t)=>t.overlay?.getTexture(e.overlayContent))),p(e,t)},e.getIMColorTexture=h,e.getOverlayContentForOutputTerrain=function(e,t){switch(e){case 0:case 1:return 9!==t.slot||t.overlay?.allSourcesOccluders?0:4;case 2:case 3:return 0;case 8:return 2;case 4:case 6:case 7:return null;case 9:return 5}return null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/Water.glsl":function(){define(["exports","./FoamRendering.glsl","./Gamma.glsl","./PhysicallyBasedRendering.glsl","./ScreenSpaceConstants","./ScreenSpaceReflections.glsl","../util/CloudsParallaxShading.glsl","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../shaderModules/Matrix4BindUniform","../../shaderModules/Texture2DBindUniform","../../../shaders/ToneMapping.glsl"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";e.Water=function(e,h){const p=e.fragment;p.include(i.PhysicallyBasedRenderingWater,h),p.include(r.Gamma),p.include(t.FoamColor),h.cloudReflections&&e.include(o.CloudsParallaxShading),e.include(n.ScreenSpaceReflections,h),p.include(d.ToneMapping,h),p.constants.add("fresnelSky","vec3",[.02,1,15]),p.constants.add("fresnelMaterial","vec2",[.02,.1]),p.constants.add("roughness","float",.015),p.constants.add("foamIntensityExternal","float",1.7),p.constants.add("ssrIntensity","float",.65),p.constants.add("ssrHeightFadeStart","float",s.distanceFadeStart),p.constants.add("ssrHeightFadeEnd","float",s.distanceFadeEnd),p.constants.add("waterDiffusion","float",.92),p.constants.add("waterSeaColorMod","float",.8),p.constants.add("correctionViewingPowerFactor","float",.4),p.constants.add("skyZenitColor","vec3",[.52,.68,.9]),p.constants.add("skyColor","vec3",[.67,.79,.9]),p.constants.add("cloudFresnelModifier","vec2",[1.2,.01]),p.code.add(l.glsl`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),p.uniforms.add(new a.FloatBindUniform("lightingSpecularStrength",e=>e.lighting.mainLight.specularStrength),new a.FloatBindUniform("lightingEnvironmentStrength",e=>e.lighting.mainLight.environmentStrength)),p.code.add(l.glsl`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
float NdotL = clamp(dot(n, l), 0.0, 1.0);
specular = lightingSpecularStrength * NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),h.cloudReflections&&p.uniforms.add(new a.FloatBindUniform("cloudsOpacity",e=>e.clouds.opacity)).code.add(l.glsl`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * cloudsOpacity;`),h.screenSpaceReflections?p.uniforms.add(new c.Matrix4BindUniform("view",e=>e.camera.viewMatrix),new u.Texture2DBindUniform("lastFrameColorTexture",e=>e.ssr.lastFrameColor?.getTexture()),new a.FloatBindUniform("fadeFactorSSR",e=>e.ssr.fadeFactor)).code.add(l.glsl`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view * vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`):p.code.add(l.glsl`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),h.cloudReflections?h.screenSpaceReflections?p.code.add(l.glsl`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):p.code.add(l.glsl`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):p.code.add(l.glsl`return waterRenderedColor;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/FoamRendering.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.FoamColor=function(e){e.code.add(t.glsl`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)},e.FoamIntensity=function(e){e.code.add(t.glsl`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ScreenSpaceReflections.glsl":function(){define(["exports","../output/ReadDepth.glsl","../../shaderModules/Float2BindUniform","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../shaderModules/Matrix4BindUniform","../../shaderModules/Texture2DBindUniform"],function(e,t,r,i,s,n,o){"use strict";e.ScreenSpaceReflections=function(e,a){if(!a.screenSpaceReflections)return;const l=e.fragment;l.include(t.ReadDepth),l.uniforms.add(new r.Float2BindUniform("nearFar",e=>e.camera.nearFar),new o.Texture2DBindUniform("depthMap",e=>e.depth?.attachment),new n.Matrix4BindUniform("proj",e=>e.camera.projectionMatrix),new i.FloatBindUniform("invResolutionHeight",e=>1/e.camera.height),new n.Matrix4BindUniform("reprojectionMatrix",e=>e.ssr.reprojectionMatrix)).code.add(s.glsl`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${a.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);
    float dDepthBefore = 0.0;

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        float weight = dDepth / (dDepth - dDepthBefore);
        vec2 Pf = mix(P - dP, P, 1.0 - weight);
        if (abs(Pf.y - projectedCoordStart.y) > invResolutionHeight) {
          return vec3(Pf, depth);
        }
        else {
          return vec3(P, depth);
        }
      }

      // continue with ray marching
      P = clamp(P + dP, vec2(0.0), vec2(0.999));
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
      dDepthBefore = dDepth;
    }
    return vec3(P, 0.0);
  }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/CloudsParallaxShading.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../geometry/support/Ellipsoid","../../../../environment/weather","../shading/MainLighting.glsl","./LookupCloudsFromTextureArray.glsl","../../shaderModules/BooleanBindUniform","../../shaderModules/Float3BindUniform","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../shaderModules/Matrix4BindUniform","../../shaderModules/Texture2DArrayBindUniform"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h=(r.earth.radius+i.cloudsHeight)**2;e.CloudsParallaxShading=function(e){const r=e.fragment;r.constants.add("radiusCloudsSquared","float",h).code.add(c.glsl`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos) {
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusCloudsSquared;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
return (cameraPosition + dir * pointIntDist) - spherePos;
}`),r.uniforms.add(new l.FloatBindUniform("radiusCurvatureCorrection",({clouds:e})=>e.parallax.radiusCurvatureCorrection)).code.add(c.glsl`vec3 correctForPlanetCurvature(vec3 dir) {
dir.z = dir.z * (1.0 - radiusCurvatureCorrection) + radiusCurvatureCorrection;
return dir;
}`),r.code.add(c.glsl`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec) {
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),s.addMainLightDirection(r),s.addMainLightIntensity(r);const i=t.fromValues(.28,.175,.035);r.constants.add("RIM_COLOR","vec3",i),r.code.add(c.glsl`
    vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds) {
      float upDotLight = dot(cameraPosition, mainLightDirection);
      float dirDotLight = max(dot(worldSpaceRay, mainLightDirection), 0.0);
      float sunsetTransition = clamp(pow(max(upDotLight, 0.0), ${c.glsl.float(.3)}), 0.0, 1.0);

      // Base color of the clouds that depends on lighting of the sun and sky
      vec3 ambientLight = calculateAmbientIrradiance(cameraPosition,  0.0);
      vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
      vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));

      // Rim light around the edge of the clouds simulating scattering of the direct lun light
      float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
      float rimLightIntensity = 0.5 + 0.5 * pow(max(upDotLight, 0.0), 0.35);
      vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, ${c.glsl.float(140)})) * scatteringMod;

      // Brighten the clouds around the sun at the sunsets
      float additionalLight = ${c.glsl.float(.2)} * pow(dirDotLight, ${c.glsl.float(10)}) * (1. - pow(sunsetTransition, ${c.glsl.float(.3)})) ;

      return vec3(baseCloudColor * (1.0 + additionalLight) + directSunScattering);
    }
  `),e.include(n.LookupCloudsFromTextureArray),r.uniforms.add(new o.BooleanBindUniform("readChannelsRG",e=>0===e.clouds.readChannels),new d.Texture2DArrayBindUniform("cubeMap",e=>e.clouds.data?.cubeMap?.colorTexture)).code.add(c.glsl`vec4 sampleCloud(vec3 rayDir, bool readOtherChannel) {
vec4 s = lookupCloudsFromTextureArray(cubeMap, rayDir);
bool readRG = readChannelsRG ^^ readOtherChannel;
s = readRG ? vec4(vec3(s.r), s.g) : vec4(vec3(s.b), s.a);
return length(s) == 0.0 ? vec4(s.rgb, 1.0) : s;
}`),r.uniforms.add(new a.Float3BindUniform("anchorPoint",e=>e.clouds.parallax.anchorPoint),new a.Float3BindUniform("anchorPointNew",e=>e.clouds.parallaxNew.anchorPoint),new u.Matrix4BindUniform("rotationClouds",e=>e.clouds.parallax.transform),new u.Matrix4BindUniform("rotationCloudsNew",e=>e.clouds.parallaxNew.transform),new l.FloatBindUniform("cloudsOpacity",e=>e.clouds.opacity),new l.FloatBindUniform("fadeFactor",e=>e.clouds.fadeFactor),new o.BooleanBindUniform("crossFade",e=>3===e.clouds.fadeState)).code.add(c.glsl`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition) {
vec3 intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPoint);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = sampleCloud(worldRayRotatedCorrected, crossFade);
vec3 cameraPositionN = normalize(cameraPosition);
vec4 cloudColor = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
if(crossFade) {
intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPointNew);
worldRayRotated = rotateDirectionToAnchorPoint(rotationCloudsNew, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = sampleCloud(worldRayRotatedCorrected, false);
vec4 cloudColorNew = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorNew, fadeFactor);
}
float totalTransmittance = length(cloudColor.rgb) == 0.0 ?
1.0 :
clamp(cloudColor.a * cloudsOpacity + (1.0 - cloudsOpacity), 0.0 , 1.0);
return vec4(cloudColor.rgb, totalTransmittance);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/LookupCloudsFromTextureArray.glsl":function(){define(["exports","../../shaderModules/FloatBindUniform","../../shaderModules/glsl"],function(e,t,r){"use strict";e.LookupCloudsFromTextureArray=function(e){e.fragment.uniforms.add(new t.FloatBindUniform("cloudAbsorption",e=>e.clouds.absorption),new t.FloatBindUniform("cloudCoverage",e=>e.clouds.coverage)).code.add(r.glsl`vec4 lookupCloudsFromTextureArray(sampler2DArray cubeMap, vec3 rayDir) {
int faceIndex;
vec2 uv;
if(rayDir.z <= 0.0) {
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudCoverage), abs(dot(rayDir, vec3(0, 0, 1))));
float shading = clamp(1.0 - cloudAbsorption, 0.6, 1.0) * (1.0 - hazeFactor);
float totalTransmittance = hazeFactor;
return vec4(shading, totalTransmittance, shading, totalTransmittance);
}
if (abs(rayDir.x) >= abs(rayDir.y) && abs(rayDir.x) >= abs(rayDir.z)) {
if(rayDir.x > 0.0) {
faceIndex = 0;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, uv.y);
} else {
faceIndex = 1;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, -uv.y);
}
} else if (abs(rayDir.y) >= abs(rayDir.x) && abs(rayDir.y) >= abs(rayDir.z)) {
if(rayDir.y > 0.0) {
faceIndex = 2;
uv = rayDir.xz / rayDir.y;
} else {
faceIndex = 3;
uv = rayDir.xz / rayDir.y;
uv = vec2(uv.x, -uv.y);
}
} else {
if(rayDir.y < 0.0) {
faceIndex = 4;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
} else {
faceIndex = 5;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
}
}
uv = 0.5 * (uv + 1.0);
if(faceIndex != 5) {
uv.y = uv.y - 0.5;
}
uv.y = uv.y * 2.0;
vec4 s = texture(cubeMap, vec3(uv, float(faceIndex)));
return s;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DArrayBindUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"sampler2DArray",0,(r,i)=>r.bindTexture(e,t(i)))}}e.Texture2DArrayBindUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/Terrain.glsl":function(){define(["exports","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepthToWriteShadowMap.glsl","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/Transform.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexTangent.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlightOverlay","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientOcclusion.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateSceneLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/NormalUtils.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/Overlay.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/TerrainTexture.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4DrawUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R){"use strict";class O extends w.OverlayTerrainPassParameters{}function I(e){const r=new M.ShaderBuilder,{attributes:s,vertex:O,fragment:I,varyings:D}=r;s.add("position","vec3"),r.include(c.NormalAttribute,e),r.include(u.TextureCoordinateAttribute,e);const E=()=>{r.include(_.NormalUtils,e),O.code.add(T.glsl`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};x.addProjViewLocalOrigin(O,e),r.include(l.Transform,e);const{output:L,pbrMode:V,overlayMode:U,tileBorders:B,spherical:N,transparencyMode:k,screenSizePerspective:z,overlayEnabled:j}=e,G=2===k||3===k,q=j&&G;switch(L){case 1:case 0:{r.include(w.TerrainTexture,e),r.include(g.EvaluateSceneLighting,e),j&&(e.pbrMode=5===V?6:3,r.include(v.OverlayTerrain,e),e.pbrMode=V);const s=2===U;s&&r.include(d.VertexTangent,e),D.add("vnormal","vec3"),D.add("vpos","vec3",{invariant:!0}),D.add("vup","vec3"),E(),z&&x.addViewNormal(O),z&&(D.add("screenSizeDistanceToCamera","float"),D.add("screenSizeCosAngle","float")),O.main.add(T.glsl`
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);
          vnormal = getNormal();
          vup = getLocalUp(position, localOrigin);
          ${T.If(s,T.glsl`forwardVertexTangent(vnormal);`)}

          forwardTextureCoordinatesWithTransform(uv0);
          ${T.If(j,"setOverlayVTC(uv0);")}
          ${T.If(B,"forwardTextureCoordinates();")}
          ${T.If(z,T.glsl`vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
                 screenSizeDistanceToCamera = length(viewPos);
                 vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
                 screenSizeCosAngle = abs(viewSpaceNormal.z);`)}
          forwardLinearDepthToReadShadowMap();`),r.include(b.ReadShadowMapDraw,e),I.include(a.SliceDraw,e),r.include(g.EvaluateSceneLighting,e),I.include(m.EvaluateAmbientOcclusion,e),x.addCameraPosition(I,e),g.addAmbientBoostFactor(I),g.addLightingGlobalFactor(I),I.uniforms.add(O.uniforms.get("localOrigin"),new S.Float3BindUniform("viewDirection",({camera:e})=>i.normalize(A,i.set(A,e.viewMatrix[12],e.viewMatrix[13],e.viewMatrix[14])))),s&&I.uniforms.add(new P.Texture2DBindUniform("ovWaterTex",e=>e.overlay?.getTexture(3)),new C.Matrix4DrawUniform("view",({origin:e},{camera:r})=>t.translate(F,r.viewMatrix,e)));const n=.2;I.code.add(T.glsl`float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),y.addMainLightDirection(I),y.addMainLightIntensity(I),I.main.add(T.glsl`
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = readShadow(additionalAmbientScale, vpos);
          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${T.If(j,T.glsl`vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
                   vec4 overlayColor = overlayOpacity * overlayColorOpaque;
                   ${T.If(G,`if (overlayColor.a < ${T.glsl.float(R.alphaCutoff)}) { discard; }`)}
                   vec4 groundColor = tileColor;
                   tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`)}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a < ${T.glsl.float(R.alphaCutoff)}) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= ${T.glsl.float(n)};
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${5===V||6===V?T.glsl`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:T.glsl`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${T.If(s,T.glsl`vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
                   float waterNormalLength = length(overlayWaterMask);
                   if (waterNormalLength > 0.95) {
                     mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                     vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                     vec4 viewPosition = view*vec4(vpos, 1.0);
                     vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                     vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                     float opacity = sliced ? ${T.glsl.float(n)} : 1.0;
                     // un-gamma the ground color to mix in linear space
                     fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
                   }`)}
          ${T.If(z,T.glsl`float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0));
                   if (perspectiveScale <= 0.25) {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
                   } else if (perspectiveScale <= 0.5) {
                     fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
                   } else if (perspectiveScale >= 0.99) {
                     fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
                   } else {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
                   }`)}
          ${T.If(e.visualizeNormals,N?T.glsl`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`:T.glsl`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`)}
          ${T.If(B,T.glsl`vec2 dVuv = fwidth(vuv0);
                 vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
                 float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
                 fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`)}
          fragColor = applySlice(fragColor, vpos);`)}break;case 2:q&&r.include(v.OverlayTerrain,e),O.main.add(T.glsl`
        ${T.If(q,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),I.main.add(`${T.If(q,`if (getCombinedOverlayColor().a < ${T.glsl.float(R.alphaCutoff)}) discard;`)}`);break;case 4:case 5:case 6:case 7:r.include(h.OutputDepth,e),n.addLinearDepth(r),o.addNearFar(r),O.main.add(T.glsl`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);`),I.main.add(T.glsl`outputDepth(linearDepth);`);break;case 3:q&&r.include(v.OverlayTerrain,e),D.add("vnormal","vec3"),x.addViewNormal(O),E(),O.main.add(T.glsl`
        ${T.If(q,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);
        vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);`),I.main.add(T.glsl`
        ${T.If(q,`if (getCombinedOverlayColor().a < ${T.glsl.float(R.alphaCutoff)}) discard;`)}
        vec3 normal = normalize(vnormal);
        if (gl_FrontFacing == false) {
          normal = -normal;
        }
        fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);`);break;case 8:j&&(r.include(v.OverlayTerrain,e),r.include(f.OutputHighlightOverlay,e)),O.main.add(T.glsl`
        ${T.If(j,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),r.include(p.OutputHighlight,e),I.main.add(T.glsl`
        ${T.If(j,T.glsl`
           calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,"calculateOcclusionAndOutputHighlight();")}
      `)}if(9===L)if(j)e.pbrMode=0,r.include(v.OverlayTerrain,e),e.pbrMode=V,O.main.add(T.glsl`gl_Position = transformPosition(proj, view, position);
setOverlayVTC(uv0);`),I.main.add(T.glsl`fragColor = getOverlayColorTexel();`);else{const e=0===k;O.main.add(T.glsl`${T.If(e,"gl_Position = transformPosition(proj, view, position);")}`),I.main.add(T.glsl`fragColor = vec4(0.0);`)}return r}const F=r.create(),A=s.create(),D=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:O,build:I},Symbol.toStringTag,{value:"Module"}));e.Terrain=D,e.TerrainPassParameters=O,e.build=I})},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VertexTangent.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.VertexTangent=function(e,r){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),r.spherical?e.vertex.code.add(t.glsl`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(t.glsl`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(t.glsl`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlightOverlay":function(){define(["exports","./OutputHighlight.glsl","../../shaderModules/glsl"],function(e,t,r){"use strict";e.OutputHighlightOverlay=function(e,i){8===i.output&&(e.include(t.OutputHighlight,i),e.fragment.code.add(r.glsl`
    void calculateOcclusionAndOutputHighlight(uvec2 highlightToAdd) {
      uint levelBits = readLevelBits(highlightToAdd, highlightLevel);
      if ((levelBits & 1u) == 0u) discard;
      outputHighlight(isHighlightOccluded());
    }
  `))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/NormalUtils.glsl":function(){define(["exports","../../shaderModules/glsl"],function(e,t){"use strict";e.NormalUtils=function(e,r){r.spherical?e.vertex.code.add(t.glsl`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(t.glsl`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),r.spherical?e.vertex.code.add(t.glsl`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(t.glsl`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/TerrainTexture.glsl":function(){define(["exports","../shading/ReadShadowMap.glsl","./BackgroundGrid.glsl","../../shaderModules/glsl","../../../../../webgl/Uniform"],function(e,t,r,i,s){"use strict";class n extends t.ReadShadowMapPassParameters{constructor(){super(...arguments),this.overlayOpacity=1}}class o extends s.Uniform{constructor(e){super(e,"float")}}class a extends s.Uniform{constructor(e){super(e,"vec3")}}class l extends s.Uniform{constructor(e){super(e,"vec4")}}class c extends s.Uniform{constructor(e){super(e,"sampler2D")}}e.Float3Uniform=a,e.OverlayTerrainPassParameters=n,e.TerrainTexture=function(e,t){const{vertex:s,fragment:n,varyings:u}=e;u.add("vtc","vec2"),s.uniforms.add(new l("texOffsetAndScale")),n.uniforms.add(new c("tex")),n.uniforms.add(new a("textureOpacities"));const d=t.textureFadingEnabled&&!t.renderOccluded;d&&(s.uniforms.add(new l("nextTexOffsetAndScale")),u.add("nvtc","vec2"),n.uniforms.add(new c("texNext")),n.uniforms.add(new a("nextTexOpacities")),n.uniforms.add(new o("fadeFactor")));const h=1===t.tileBlendInput,p=2===t.tileBlendInput;p&&n.include(r.BackgroundGrid),h&&n.uniforms.add(new a("backgroundColor")),s.code.add(i.glsl`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = texOffsetAndScale.xy + uv * texOffsetAndScale.zw;
    ${i.If(d,"nvtc = nextTexOffsetAndScale.xy + uv * nextTexOffsetAndScale.zw;")}
  }`),n.code.add(i.glsl`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${i.If(p||h,i.glsl`if (opacities.y <= 0.0) {
           return color * opacities.z * opacities.x;
         }
         vec4 bg = vec4(${h?i.glsl`backgroundColor`:i.glsl`gridColor(uv)`} * opacities.y, opacities.y);
         vec4 layer = color * opacities.z;
         return (bg * (1.0 - layer.a) + layer) * opacities.x;`,"return color;")}
    }`),d?n.code.add(i.glsl`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):n.code.add(i.glsl`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)},e.Texture2DUniform=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/TerrainTechnique":function(){define(["require","exports","../../terrain/TerrainAttributes","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/StencilUtils","../../../../chunks/Terrain.glsl","../../../webgl/renderState"],function(e,t,r,i,s,n,o,a){"use strict";class l extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(o.Terrain,()=>new Promise((t,r)=>e(["./Terrain.glsl"],t,r))),r.layout.locations),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(e){return this._stencilPipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}_createPipeline(e,t){const{renderOccluded:r,output:i}=e,o=e.backfaceCullingEnabled&&!r;return a.makePipelineState({blending:r?a.premultipliedAlpha:null,culling:o?a.backFaceCullingParams:null,depthTest:r?null:{func:513},depthWrite:r?null:a.defaultDepthWrite,colorWrite:a.defaultColorWrite,stencilTest:t?n.renderWhenBitIsNotSet(1):null,drawBuffers:s.depthOnlyOutputBuffersOr(i)})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}}t.TerrainTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/TerrainTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(e){super(),this.spherical=e,this.overlayMode=0,this.tileBlendInput=0,this.transparencyMode=0,this.pbrMode=5,this.receiveShadows=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.normalType=1,this.textureCoordinateType=1,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.draped=!1}get overlayEnabled(){return 0!==this.overlayMode}}t.__decorate([r.parameter({count:3})],s.prototype,"overlayMode",void 0),t.__decorate([r.parameter({count:3})],s.prototype,"tileBlendInput",void 0),t.__decorate([r.parameter({count:4})],s.prototype,"transparencyMode",void 0),t.__decorate([r.parameter({count:7})],s.prototype,"pbrMode",void 0),t.__decorate([r.parameter()],s.prototype,"receiveShadows",void 0),t.__decorate([r.parameter()],s.prototype,"backfaceCullingEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"textureFadingEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"renderOccluded",void 0),t.__decorate([r.parameter()],s.prototype,"screenSpaceReflections",void 0),t.__decorate([r.parameter()],s.prototype,"cloudReflections",void 0),t.__decorate([r.parameter()],s.prototype,"screenSizePerspective",void 0),t.__decorate([r.parameter()],s.prototype,"receiveAmbientOcclusion",void 0),t.__decorate([r.parameter()],s.prototype,"tileBorders",void 0),t.__decorate([r.parameter()],s.prototype,"visualizeNormals",void 0),e.TerrainTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/TerrainSurfacePerformanceInfo":function(){define(function(){"use strict";return class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}})},"esri/views/3d/terrain/TilingSchemeLogic":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/aaBoundingRect","../../../layers/support/layerUtils","../support/supportedSpatialReference","./terrainUtils","./TilingScheme"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";e.TilingSchemeLogic=class extends r{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",()=>this._update()),s.watch(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!u.isTiledLayer(t)||t.isRejected()||t.isFulfilled()&&!function(e,t,r){return null!=h.getTiledLayerInfo(e,t,r)}(t,this.viewSpatialReference,this.viewingMode)||(e=t,"vector-tile"===t?.type||h.isProjectableRasterLayer(t)))),e)if(e.isResolved()){const t=e,r=h.getTiledLayerInfo(t,this.viewSpatialReference,this.viewingMode);if(null!=r){const e=new p.TilingScheme(r.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(1===this.viewingMode){const t=e.levels.length-1,r=e.spatialReference;r.isWebMercator?e=p.TilingScheme.makeWebMercatorAuxiliarySphere(t):d.isSupportedEarthGCS(r)&&(e=p.TilingScheme.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(s.watch(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(1===this.viewingMode){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=p.TilingScheme.WebMercatorAuxiliarySphere:d.isSupportedGCSOnGlobe(e)&&(this.tilingScheme=p.TilingScheme.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;null==e||c.equals(e,this.extent)||(this.tilingScheme=p.TilingScheme.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}},t.__decorate([n.property()],e.TilingSchemeLogic.prototype,"tilingScheme",void 0),t.__decorate([n.property({readOnly:!0})],e.TilingSchemeLogic.prototype,"extent",void 0),t.__decorate([n.property({value:!1})],e.TilingSchemeLogic.prototype,"tilingSchemeLocked",void 0),t.__decorate([n.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"viewSpatialReference",void 0),t.__decorate([n.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"layers",void 0),t.__decorate([n.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"extentHelper",void 0),t.__decorate([n.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"viewingMode",void 0),e.TilingSchemeLogic=t.__decorate([l.subclass("esri.views.3d.terrain.TilingSchemeLogic")],e.TilingSchemeLogic),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/terrain/UpsampleInfo":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec2f64"],function(e,t){"use strict";e.UpsampleInfo=class{constructor(){this._offset=t.create(),this.scale=0}get offset(){return this._offset}init(e,t,r,i){this.tile=e,this._offset[0]=t,this._offset[1]=r,this.scale=i}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/TextureCompressionTracker":function(){define(["exports","../../core/signal"],function(e,t){"use strict";e.TextureCompressionTracker=class{constructor(){this._pendingCompressionTasks=t.signal(0)}get compressing(){return!!this._pendingCompressionTasks.value}increment(){this._pendingCompressionTasks.value++}decrement(){this._pendingCompressionTasks.value--}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/Stage":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/arrayUtils","../../../core/compilerUtils","../../../core/has","../../../core/maybe","../../../core/promiseUtils","../../../core/signal","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../state/helpers/SceneIntersectionHelper","../support/TextureCollection","./lib/ChangeSet","./parts/Model","./parts/RenderView","../../support/Scheduler","../../support/Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";e.Stage=class extends r{constructor(e){super(e),this._model=new m.Model,this._canCompact=l.signal(!1),this._layers=new Array,this._asyncChangeSet=new f.ChangeSet,this._syncChangeSet=new f.ChangeSet,this._layerSyncSet=new Set,this._textures=new p.TextureCollection(this,e.view.resourceController.scheduler),this._frameTask=e.view.resourceController.scheduler.registerTask(y.TaskPriority.STAGE,this),this.addHandles(this._frameTask)}initialize(){this._renderView=new g.RenderView({stage:this})}destroy(){this.removeAllHandles(),this._textures.destroy(),this._set("textures",null),this._renderView=o.destroyMaybe(this._renderView),this._set("renderView",null),this._layers.length=0,this._model=null,this._set("renderer",null),this.options.canvas=null,this._set("options",null)}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.readyToRun||this.renderView.updating||this._frameTask.updating||this.textures.updating}get renderView(){return this._renderView}get renderer(){return this.renderView?.renderer}get textures(){return this._textures}addTexture(e){this._model.addTexture(e),this.renderView.requestRender()}removeTexture(e){null!=e&&!this.destroyed&&this._model.hasTexture(e)&&(this._model.removeTexture(e),this.renderView.requestRender())}addTextures(e){null!=e&&(this._model.addTextures(e),this.renderView.requestRender())}removeTextures(e){null!=e&&(this._model?.removeTextures(e),this.renderView.requestRender())}forEachTexture(e){this._model.forEachTexture(e)}getTexture(e){return this._model.getTexture(e)}addLayer(e){this._layers.includes(e)||(this._model.addLayer(e),this._layers.push(e),this._model.dirtySet.layerAdded(e),this.renderView.requestRender())}removeLayer(e){null!=e&&!this.destroyed&&this._model.hasLayer(s.toConst(e))&&(this._model.dirtySet.layerRemoved(e),this._commitLayer(e),i.removeUnordered(this._layers,e),this._model.dirtySet.assertLayerClean(e.id),this._model.removeLayer(e),this.renderView.requestRender())}getLayer(e){return this._model.getLayer(e)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get readyToRun(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty||this._canCompact.value}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),this.renderer.compact(e),this._canCompact.value=this.renderer.canCompact,!e.hasProgressed)return _.Yield}compact(e){return this._canCompact.value=!1,this.renderer.compact(e)}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forEach(r=>{if(e.done)return;const i=this._layerSyncSet.has(r.id)||1===r.updatePolicy,s=i?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(r.id,s),this._layerSyncSet.delete(r.id),s.empty||(this.renderer.commit(s,i?y.noBudget:e),this.renderView.requestRender(),e.madeProgress())}),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,y.noBudget),this.renderView.requestRender(),e.madeProgress()),this._layers.forEach(r=>{e.done||this._layerSyncSet.has(r.id)||0!==r.updatePolicy||(t.commitLayer(r.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("readyToRun")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forEach(t=>{this._layerSyncSet.has(t.id)||1===t.updatePolicy?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)});for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,y.noBudget),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,y.noBudget),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}get layers(){return this._layers}addRenderPlugin(e,t){const r=this.renderer.plugins.add(e,t),i=()=>{h.isIntersectionHandler(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if(a.isPromiseLike(r))return r.then(i);i()}removeRenderPlugin(e){this.destroyed||(h.isIntersectionHandler(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get test(){}},t.__decorate([c.property({constructOnly:!0})],e.Stage.prototype,"view",void 0),t.__decorate([c.property({constructOnly:!0})],e.Stage.prototype,"options",void 0),t.__decorate([c.property({readOnly:!0})],e.Stage.prototype,"viewingMode",null),t.__decorate([c.property({constructOnly:!0})],e.Stage.prototype,"container",void 0),t.__decorate([c.property({readOnly:!0})],e.Stage.prototype,"updating",null),t.__decorate([c.property({readOnly:!0})],e.Stage.prototype,"renderView",null),t.__decorate([c.property({readOnly:!0})],e.Stage.prototype,"renderer",null),t.__decorate([c.property({readOnly:!0})],e.Stage.prototype,"textures",null),t.__decorate([c.property({readOnly:!0})],e.Stage.prototype,"readyToRun",null),e.Stage=t.__decorate([d.subclass("esri.views.3d.webgl-engine.Stage")],e.Stage),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/parts/Model":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/sphere","../lib/GridLocalOriginFactory","../lib/ModelDirtySet","../lib/RenderGeometry","../lib/Util"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";e.Model=class extends r{constructor(){super(...arguments),this.dirtySet=new d({model:this}),this._originFactory=new u.GridLocalOriginFactory(null),this._textures=new Map,this._layers=new Map}hasTexture(e){return this._textures.has(e.id)}getTexture(e){return null==e?null:this._textures.get(e)}addTexture(e){const t=e.id;p.assert(!this._textures.has(t),"Model/Stage already contains texture to be added"),this._textures.set(t,e)}removeTexture(e){return this._textures.delete(e.id)}addTextures(e){for(const t of e)t&&(p.assert(!this._textures.has(t.id),"Model/Stage already contains object to be added"),this._textures.set(t.id,t))}removeTextures(e){for(const t of e)t&&(p.assert(this._textures.has(t.id),"Model/Stage doesn't contain object to be removed"),this._textures.delete(t.id))}forEachTexture(e){this._textures.forEach(t=>e(t))}hasLayer(e){return this._layers.has(e.id)}getLayer(e){return null==e?null:this._layers.get(e)}addLayer(e){const t=e.id;p.assert(!this._layers.has(t),"Model/Stage already contains layer to be added"),this._layers.set(t,e)}removeLayer(e){return this._layers.delete(e.id)}getRenderGeometry(e,t){const r=new h.RenderGeometry(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation}),i=t.localOrigin;return r.transformation=e.getCombinedStaticTransformation(t,f),r.localOrigin=i??this._originFactory.getOrigin(c.getCenter(r.boundingSphere)),r}updateRenderGeometryTransformation(e,t,r){if(null==e)return!1;r.transformation=e.getCombinedStaticTransformation(t,f);const i=this._originFactory.getOrigin(c.getCenter(r.boundingSphere));return r.localOrigin!==i}get test(){}},t.__decorate([s.property({constructOnly:!0})],e.Model.prototype,"dirtySet",void 0),e.Model=t.__decorate([a.subclass("esri.views.3d.webgl-engine.parts.Model")],e.Model);const f=l.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/ModelDirtySet":function(){define(["../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/NestedMap","../../../../core/uid","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./Util"],function(e,t,r,i,s,n,o,a,l,c){"use strict";class u{constructor(e,t,r,i){this.operation=e,this.geometry=t,this.states=r,this.sync=i}}let d=class extends t{constructor(e){super(e),this._residentGeomRecords=new i.NestedMap,this._dirtyGeomRecords=new i.NestedMap,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(e,t){const r=this._dirtyGeomRecords.getInner(e),i=this.model.getLayer(e);if(!r||!i)return;let s=0;r.forEach((r,n)=>{const o=this._ensureGeomRecord(e,n);this._dirtyGeomRecords.delete(e,n),s+=r.size,r.forEach(({geometry:e,operation:r,states:s},a)=>{let l=!1;if(1===r){const r=o.get(a);if(r){if(4&s){const t=i.getObject(n);this.model.updateRenderGeometryTransformation(t,e,r)&&(l=!0)}l||t.updates.push({renderGeometry:r,updateType:s})}else c.assert(!1,"ModelDirtySet.commitLayer: invalid update")}if(2===r||l){const e=o.get(a);e?(t.removes.push(e),o.delete(a)):2===r&&c.assert(!1,"ModelDirtySet.commitLayer: invalid remove")}if(0===r||l){const r=i.getObject(n);if(null!=r){const i=this.model.getRenderGeometry(r,e);t.adds.push(i),o.set(a,i)}}}),0===o.size&&this._residentGeomRecords.delete(e,n)}),this._dirtyRecordCount-=s}commitSyncUpdates(e,t){const r=this._dirtyGeomRecords.getInner(e),i=this.model.getLayer(e);r&&i&&r.forEach((r,s)=>{const n=this._ensureGeomRecord(e,s);r.forEach(({geometry:e,operation:r,states:o,sync:a},l)=>{let u=!1;if(1===r&&a){const r=n.get(l);if(r){if(4&o){const t=i.getObject(s);this.model.updateRenderGeometryTransformation(t,e,r)&&(u=!0)}u||t.updates.push({renderGeometry:r,updateType:o})}else c.assert(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}})})}_objectStateChanged(e,t){for(const r of t.geometries)this._updateOrCreateDirtyRecord(t,r,1,e)}visibilityChanged(e){this._objectStateChanged(1,e)}highlightChanged(e){this._objectStateChanged(8,e)}occlusionChanged(e){this._objectStateChanged(16,e)}attributesChanged({object:e,geometry:t,sync:r}){this._updateOrCreateDirtyRecord(e,t,1,2,r)}layerAdded(e){e.objects.forEach(e=>this.layerObjectAdded(e))}layerRemoved(e){e.objects.forEach(e=>this.layerObjectRemoved(e))}layerObjectAdded(e){for(const t of e.geometries)this._geometryAdded(e,t)}layerObjectRemoved(e){for(const t of e.geometries)this._geometryRemoved(e,t)}layerObjectsAdded(e){for(const t of e)this.layerObjectAdded(t)}layerObjectsRemoved(e){for(const t of e)this.layerObjectRemoved(t)}transformationChanged(e){const t=this._getLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach(({geometry:t})=>this._updateOrCreateDirtyRecord(e,t,1,4))}shaderTransformationChanged(e){const t=this._getLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach(t=>t.objectShaderTransformationChanged(e.shaderTransformation))}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t){this._updateOrCreateDirtyRecord(e,t,0)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t){this._updateOrCreateDirtyRecord(e,t,2)}_updateOrCreateDirtyRecord(e,t,r,i=0,s=!1){const n=this._getLayerId(e),o=e.id,a=t.id,l=this._ensureDirtyRecord(n,o),d=l.get(a);if(d){const e=d.operation;2===e&&0===r&&0!==d.states?d.operation=1:2===e&&0===r||0===e&&2===r?(l.delete(a),this._dirtyRecordCount--):1!==e||2!==r&&1!==r?(c.assert((2===e||0===e)&&1===r,"ModelDirtySet.objectGeometryAdded: inconsistent state"),d.states|=i):(d.operation=r,d.states|=i),d.sync=d.sync||s}else l.set(a,new u(r,t,i,s)),this._dirtyRecordCount++}_ensureGeomRecord(e,t){let r=this._residentGeomRecords.get(e,t);return r||(r=new Map,this._residentGeomRecords.set(e,t,r)),r}assertLayerClean(e){c.assert(null==this._dirtyGeomRecords.getInner(e),"Dirty geometry records for removed layer")}_ensureDirtyRecord(e,t){const r=this.model.getLayer(e);c.assert(null!=r,"Updating geometry record for an unregistered layer");let i=this._dirtyGeomRecords.get(e,t);return i||(i=new Map,this._dirtyGeomRecords.set(e,t,i)),i}_getLayerId(e){return e.layer?.id??s.nullUid}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forAll((r,i,s)=>{t.length>0&&(t+="\n"),t+=i+"."+s;const n=[];r.forEach(e=>{const t=e.operation;n[t]||(n[t]=[]),n[t].push(e.geometry.id)});for(let r=0;r<n.length;r++)if(n[r]){t+=" "+e[r-1]+": ";for(let e=0;e<n[r].length;e++)t+=n[r][e]+", "}}),t}get test(){}};return e.__decorate([n.property({constructOnly:!0})],d.prototype,"model",void 0),e.__decorate([n.property()],d.prototype,"_dirtyRecordCount",void 0),d=e.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.ModelDirtySet")],d),d})},"esri/views/3d/webgl-engine/lib/RenderGeometry":function(){define(["exports","../../../../core/uid","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../chunks/sphere","../../support/mathUtils"],function(e,t,r,i,s,n,o){"use strict";class a{constructor(e,r={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=i.create(),this._shaderTransformation=null,this._boundingSphere=null,this.id=t.generateUID(),this.layerViewUid=r.layerViewUid,this.graphicUid=r.graphicUid,this.castShadow=r.castShadow??!1,r.objectShaderTransformation&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){r.copy(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){null==e?this._shaderTransformation=null:(this._shaderTransformation??=i.create(),r.multiply(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(null==this._boundingSphere&&(this._boundingSphere??=n.create(),s.transformMat4(n.getCenter(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*o.maxScale(this.shaderTransformation)),this._boundingSphere):n.NullSphere}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}e.RenderGeometry=a,e.ValidatedRenderGeometry=class extends a{},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/parts/RenderView":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/compilerUtils","../../../../core/floatRGBA","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/scheduling","../../../../core/time","../../../../core/accessorSupport/decorators/property","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/spatialReferenceUtils","../../environment/ChapmanAtmosphere","../../environment/CloudsComposition","../../environment/Fog","../../environment/LocalAtmosphere","../../environment/MarsAtmosphere","../collections/Component/ComponentObjectCollection","../core/shaderTechnique/ShaderTechniqueConstructionContext","../core/shaderTechnique/ShaderTechniqueRepository","../effects/bloom/BloomRenderNode","../effects/geometry/ObjectAndLayerIDRenderNode","../effects/geometry/olidUtils","../effects/geometry/RenderOccludedRenderNode","../effects/haze/Haze","../effects/highlight/Highlight","../effects/highlight/ShadowHighlight","../effects/magnifier/Magnifier","../effects/smaa/SMAA","../effects/ssao/SSAO","../effects/stars/Stars","../lib/CompositingHelper","../lib/GLMaterialRepository","../lib/ObjectAndLayerIdRenderHelper","../lib/Renderer","../lib/RenderingContext","../lib/RenderingContextOptions","../lib/TextureRepository","../materials/markerTextureRepository","../materials/stippleTextureRepository","../materials/internal/WaterTextureRepository","./contextCache","./renderUtils","./ScreenshotManager","./testUtils","../../../support/Scheduler","../../../webgl/checkWebGLError"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V,U,B,N,k,z,j,G,q,H,W,$,Q,Z){"use strict";e.RenderView=class extends r{constructor(e){super(e),this._waterTextures=new G.WaterTextureRepository,this.olidRenderHelper=C.olidEnabled()?new V.ObjectAndLayerIdRenderHelper:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this.bloom=null,this.test=null;const t=e.stage;try{this._initializeContext(t)}catch(e){return void console.error("Failed to initialize context",e)}const{memoryController:r}=t.view.resourceController;this._stippleTextures=j.createStippleTextureRepository(this._rctx,r),this.notifyChange("stippleTextures"),this._markerTextures=z.createMarkerTextureRepository(this._rctx,r),this.notifyChange("markerTextures"),this._techniques=new x.ShaderTechniqueRepository(new w.ShaderTechniqueConstructionContext(this._rctx,t.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new k.TextureRepository(t),this.addHandles(this._textures.events.on("changed",e=>this.requestRender(e)));const i=new L.GLMaterialRepository(this._textures,this._techniques,()=>this.requestRender(),()=>this.requestRender());this._compositingHelper=new E(this._rctx,this._techniques),this._renderer=new U.Renderer(t,i,this._techniques,this._rctx,this._compositingHelper,e=>this.requestRender(e)),this.notifyChange("renderer"),this.addHandles([l.watch(()=>t.view.ready,e=>{e&&this._createRenderNodes()},l.initial),l.watch(()=>this.waterTextures?.updating,()=>this.requestRender(),l.initial),l.watch(()=>t.view.qualityProfile,e=>this.renderer?.updateRenderFeatures(e),l.syncAndInitial)]);const s={renderScene:(e,t,r,i)=>this.renderer.render(e,t,r,i),requestRenderScene:e=>this.requestRender(e),prepareOverlay:()=>t.options.screenshot.prepareOverlay(),renderOverlay:(e,r,i)=>t.options.screenshot.renderOverlay(e,r,i)};this._screenshotManager=new W.ScreenshotManager(this._rctx,s,e=>t.view.basemapTerrain.overlayManager.updateOverlays(Q.noBudget,e.camera,0)),this._registerFrameTask(t)}destroy(){const e=this.stage?.container;e?.contains(this._canvas)&&e.removeChild(this._canvas),this._frameTask=a.removeMaybe(this._frameTask),this._techniques=a.destroyMaybe(this._techniques),this._componentObjectCollection=a.destroyMaybe(this._componentObjectCollection),this._set("componentObjectCollection",null),this._screenshotManager=a.destroyMaybe(this._screenshotManager),a.destroyMaybe(this.renderer),this._textures=a.destroyMaybe(this._textures),a.destroyMaybe(this.waterTextures),a.destroyMaybe(this.markerTextures),a.destroyMaybe(this.stippleTextures),this._waterTextures=null,this._markerTextures=null,this._stippleTextures=null,this._canvas=null,this._rctx=a.destroyMaybe(this._rctx),this._compositingHelper=null,this._renderer=null,this._set("renderer",null),this.test?.destroy()}_createRenderNodes(){const{view:e,viewingMode:t}=this.stage;new D.Stars({view:e}),f.isMoon(e.spatialReference)||(2===t?(new _.LocalAtmosphere({view:e}),this.bloom=new S.BloomRenderNode({view:e})):f.isMars(e.spatialReference)?(new b.MarsAtmosphere({view:e}),this.bloom=new S.BloomRenderNode({view:e})):(new m.ChapmanAtmosphere({view:e}),new g.CloudsComposition({view:e}),this.bloom=new S.BloomRenderNode({view:e}),new M.Haze({view:e}),new y.Fog({view:e}))),new A.SSAO({view:e,isEnabled:()=>this.renderer.hasSSAO}),new F.SMAA({view:e,isEnabled:()=>this.renderer.hasSMAA}),new I.Magnifier({view:e}),new R.Highlight({view:e}),new O.ShadowHighlight({view:e,viewingMode:t}),new P.RenderOccludedRenderNode({view:e}),C.olidEnabled()&&new T.ObjectAndLayerIDRenderNode({view:e})}requestRender(e=1){this._needsRender=!0,1===e&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(i.toConst(e))}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,r,i,n,o=n){const a=i.constrainWindowSize(t,r,n*i.pixelRatio,o*i.pixelRatio),l=this._ensureLinearDepthArrayBuffer(a);this.renderer.readMainDepth(a,l);const c=(e,t,r)=>s.unpackFloatRGBA(t,e)*(r[1]-r[0])+r[0];let u=Number.MAX_VALUE;for(let e=0;e<a[2]*a[3];e++){const t=c(4*e,l,i.nearFar);u>t&&t!==i.nearFar[0]&&t!==i.nearFar[1]&&(u=t)}if(e){const s=e.pickDepth(t*i.pixelRatio,r*i.pixelRatio,i);null!=s&&u>s&&s!==i.nearFar[0]&&s!==i.nearFar[1]&&(u=s)}return u===Number.MAX_VALUE?void 0:u}_ensureLinearDepthArrayBuffer(e){const t=4*e[2]*e[3];return(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){H.removeLoadedShaderModules(),await this._techniques.reloadAll(),this.renderer.overlay?.reloadShaders(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let r=!1,i=0,s=!1;const n={preRender:({time:s})=>{r=this.updating,i=this._needsUpdate?1:0,this._needsRender&&this.renderer.updateSceneDepthRange(t.camera),e.commitSyncLayers(),s=this.test?.time??s,(u.Milliseconds(s-this._lastAnimationUpdate)>this.renderer.animationTimestep||r||this._needsRender)&&(this.renderer.updateAnimation(t,s)&&this.requestRender(0),this._lastAnimationUpdate=s)},render:({time:e})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const r=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,e=this.test?.time??e,this.renderer.render(t,e,0),s=!0,r&&this.renderer.hasReflections&&(this.requestRender(0),this._needsWaterReflectionUpdate=!0)}},update:({time:e})=>{this._textures.update();const r=new W.ScreenshotContext(t,this.renderer.fboCache);e=this.test?.time??e,this._screenshotManager.update(r,e)},finish:()=>{s&&(this.renderer.finish(2===t.mode?i:1),s=!1)}};this._frameTask=c.addFrameTask(n)}_initializeContext(e){const{options:t}=e,r=t.canvas??document.createElement("canvas");r.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=r;const i={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},s=r.getContext("webgl2",i);if(null==s)return void o.getLogger(this).error("A WebGL2 context could not be created.");Z.checkWebGLError(s,!0),this._rctx=function(e,t){const r=new N.RenderingContextOptions(t);if($.contextCache.enabled){let t=Y.get(e);return t&&1===t.refCount?(t.configure(r),t.ref(),t):(t=new B.RenderingContext(e,r),Y.set(e,t),t.ref(),t)}return new B.RenderingContext(e,r)}(s,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&o.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");const{container:a}=e;!this._rctx.contextAttributes.alpha&&n("safari")>=11&&(a.style.backgroundColor="black"),a.contains(r)||a.appendChild(r)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}get stippleTextures(){return this._stippleTextures}get markerTextures(){return this._markerTextures}get waterTextures(){return this._waterTextures}getObjectAndLayerIdColor(e){return this.olidRenderHelper?.getObjectAndLayerIdColor(e)}get renderer(){return this._renderer}get componentObjectCollection(){return null==this._componentObjectCollection&&(this._componentObjectCollection=new v.ComponentObjectCollection(this.renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}updateQualitySettings(e){null!=this.test?.time&&(this.test.savedFadeDuration=e.fadeDuration,e.fadeDuration=u.Milliseconds(0)),this._rctx.updateOptions({maxPreferredTexturePixels:this.stage.view.qualitySettings.maxTexturePixels})}},t.__decorate([d.property({type:Boolean,readOnly:!0})],e.RenderView.prototype,"updating",null),t.__decorate([d.property({constructOnly:!0})],e.RenderView.prototype,"stage",void 0),t.__decorate([d.property({readOnly:!0})],e.RenderView.prototype,"stippleTextures",null),t.__decorate([d.property({readOnly:!0})],e.RenderView.prototype,"markerTextures",null),t.__decorate([d.property({readOnly:!0})],e.RenderView.prototype,"waterTextures",null),t.__decorate([d.property({readOnly:!0})],e.RenderView.prototype,"olidRenderHelper",void 0),t.__decorate([d.property()],e.RenderView.prototype,"_textures",void 0),t.__decorate([d.property({readOnly:!0})],e.RenderView.prototype,"renderer",null),t.__decorate([d.property()],e.RenderView.prototype,"_screenshotManager",void 0),t.__decorate([d.property()],e.RenderView.prototype,"componentObjectCollection",null),t.__decorate([d.property()],e.RenderView.prototype,"_componentObjectCollection",void 0),t.__decorate([d.property()],e.RenderView.prototype,"_needsUpdate",void 0),t.__decorate([d.property()],e.RenderView.prototype,"_needsWaterReflectionUpdate",void 0),e.RenderView=t.__decorate([p.subclass("esri.views.3d.webgl-engine.parts.RenderView")],e.RenderView);const Y=q.getContextCache();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/ChapmanAtmosphere":function(){define(["exports","../../../chunks/tslib.es6","../../../core/colorUtils","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/Logger","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/vec2","../../../chunks/vec32","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/support/Ellipsoid","../webgl","./atmosphereUtils","./ChapmanAtmosphereTechnique","./ChapmanAtmosphereTechniqueConfiguration","../webgl-engine/effects/OpaqueEnvironment","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/textureUtils","../../../chunks/AtmosphereCompositing.glsl","../webgl-engine/shaders/AtmosphereCompositingTechnique","../../webgl/enums","../../../webscene/background/ColorBackground"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P){"use strict";e.ChapmanAtmosphere=class extends v.OpaqueEnvironment{constructor(){super(...arguments),this.requireGeometryDepth=!0,this._compositingPassParameters=new S.AtmosphereCompositingPassParameters,this._vao=null,this._passParameters=new _.ChapmanAtmospherePassParameters,this._configuration=new b.ChapmanAtmosphereTechniqueConfiguration}initialize(){this.techniques.precompile(_.ChapmanAtmosphereTechnique,this._configuration),this.techniques.precompile(T.AtmosphereCompositingTechnique),this._configuration.reduced=!0,this.techniques.precompile(_.ChapmanAtmosphereTechnique,this._configuration),this._configuration.reduced=!1,this.addHandles([n.watch(()=>this.view.environment.background,e=>{const t=e instanceof P?r.unitRGBAFromColor(e.color):f.ZEROS;h.set(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])},n.syncAndInitial),n.watch(()=>this.view.stage?.renderer?.fullResolutionAtmosphere,e=>this._configuration.reduced=!e,n.syncAndInitial),n.watch(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),n.syncAndInitial)])}destroy(){this._vao=s.disposeMaybe(this._vao)}render(e){const t=e.find(({name:e})=>e===g.InternalRenderCategory.OPAQUE_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const r=this.renderingContext;this._vao??=w.createQuadVAO(r,1);const s=t.getAttachment(C.DepthStencilAttachment);this._update();const n=this.techniques.get(_.ChapmanAtmosphereTechnique,this._configuration);if(!n.compiled)return this.requestRender(1),t;if(!this._configuration.reduced)return t.detachDepth(),r.bindFramebuffer(t.fbo),r.bindTechnique(n,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(C.PrimitiveType.TRIANGLE_STRIP,0,4),t.attachDepth(s),t;const o=this.techniques.get(T.AtmosphereCompositingTechnique);if(!o.compiled)return this.requestRender(1),t;const a=r.getViewport(),l=this.bindParameters.camera,c=h.length(l.eye)-m.earth.radius;let u;const d=m.earth.atmosphereHeight;if(c<d){const e=Math.min(1,Math.max(0,c/d));u=i.lerp(.2,.3,e)}else{const e=Math.min(1,Math.max(0,(c-d)/(15*d)));u=i.lerp(.3,.6,e)}const p=this.renderingContext.parameters.maxTextureSize,f=x.applyTextureResizeModulo(Math.round(u*l.fullViewport[2]),p),y=x.applyTextureResizeModulo(Math.round(u*l.fullViewport[3]),p);r.setViewport(0,0,f,y);const b=this.fboCache.acquire(f,y,"chapman",5);return r.bindFramebuffer(b.fbo),r.clearFramebuffer([0,0,0,1],!0,!0),r.bindTechnique(n,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(C.PrimitiveType.TRIANGLE_STRIP,0,4),r.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=b.getTexture(),t.detachDepth(),r.bindFramebuffer(t.fbo),r.bindTechnique(o,this.bindParameters,this._compositingPassParameters),r.screen.draw(),t.attachDepth(s),b.release(),t}_update(){const e=this.bindParameters.camera,t=h.squaredLength(e.eye),r=Math.sqrt(t),s=t-this._passParameters.radii[1]**2,n=i.clamp((r-this._passParameters.radii[0])/m.earth.atmosphereHeight,0,1);p.set(this._passParameters.heightParameters,r,t,s,n);const o=this.view.basemapTerrain?.getLowerBoundRadius()??0;d.set(this._passParameters.radii,o,o+m.earth.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*o-y.innerAtmosphereDepth)*y.innerAtmosphereDepth),this._passParameters.altitudeFade=y.computeInnerAltitudeFade(r-o)}},e.ChapmanAtmosphere=t.__decorate([u.subclass("esri.views.3d.environment.ChapmanAtmosphere")],e.ChapmanAtmosphere),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/colorUtils":function(){define(["exports","../Color","./arrayUtils","./lang","./mathUtils","../chunks/vec42","./libs/gl-matrix-2/factories/vec4f64"],function(e,t,r,i,s,n,o){"use strict";function a(e){return"r"in e&&"g"in e&&"b"in e}function l(e){return"h"in e&&"s"in e&&"v"in e}function c(e){return"l"in e&&"a"in e&&"b"in e}function u(e){return"l"in e&&"c"in e&&"h"in e}const d=[[.4124,.3576,.1805],[.2126,.7152,.0722],[.0193,.1192,.9505]],h=[[3.2406,-1.5372,-.4986],[-.9689,1.8758,.0415],[.0557,-.204,1.057]];function p(e,t){const r=[];let i,s;if(e[0].length!==t.length)throw new Error("dimensions do not match");const n=e.length,o=e[0].length;let a=0;for(i=0;i<n;i++){for(a=0,s=0;s<o;s++)a+=e[i][s]*t[s];r.push(a)}return r}function f(e){const t=[e.r/255,e.g/255,e.b/255].map(e=>e<=.04045?e/12.92:((e+.055)/1.055)**2.4),r=p(d,t);return{x:100*r[0],y:100*r[1],z:100*r[2]}}function m(e){const t=p(h,[e.x/100,e.y/100,e.z/100]).map(e=>{const t=e<=.0031308?12.92*e:1.055*e**(1/2.4)-.055;return Math.min(1,Math.max(t,0))});return{r:Math.round(255*t[0]),g:Math.round(255*t[1]),b:Math.round(255*t[2])}}function g(e){const t=[e.x/95.047,e.y/100,e.z/108.883].map(e=>e>(6/29)**3?e**(1/3):1/3*(29/6)**2*e+4/29);return{l:116*t[1]-16,a:500*(t[0]-t[1]),b:200*(t[1]-t[2])}}function y(e){const t=e.l,r=[(t+16)/116+e.a/500,(t+16)/116,(t+16)/116-e.b/200].map(e=>e>6/29?e**3:3*(6/29)**2*(e-4/29));return{x:95.047*r[0],y:100*r[1],z:108.883*r[2]}}function _(e){return a(e)?e:u(e)?function(e){return m(y(function(e){const t=e.l,r=e.c,i=e.h;return{l:t,a:r*Math.cos(i),b:r*Math.sin(i)}}(e)))}(e):c(e)?function(e){return m(y(e))}(e):function(e){return"x"in e&&"y"in e&&"z"in e}(e)?m(e):l(e)?function(e){const t=(e.h+360)%360/60,r=e.s/100,i=e.v/100*255,s=i*r,n=s*(1-Math.abs(t%2-1));let o;switch(Math.floor(t)){case 0:o={r:s,g:n,b:0};break;case 1:o={r:n,g:s,b:0};break;case 2:o={r:0,g:s,b:n};break;case 3:o={r:0,g:n,b:s};break;case 4:o={r:n,g:0,b:s};break;case 5:case 6:o={r:s,g:0,b:n};break;default:o={r:0,g:0,b:0}}return o.r=Math.round(o.r+i-s),o.g=Math.round(o.g+i-s),o.b=Math.round(o.b+i-s),o}(e):e}function b(e){return l(e)?e:function(e){const t=e.r,r=e.g,i=e.b,s=Math.max(t,r,i),n=s-Math.min(t,r,i);let o=s,a=0===n?0:s===t?(r-i)/n%6:s===r?(i-t)/n+2:(t-r)/n+4,l=0===n?0:n/o;return a<0&&(a+=6),a*=60,l*=100,o*=100/255,{h:a,s:l,v:o}}(_(e))}function v(e){return c(e)?e:function(e){return g(f(e))}(_(e))}function w(e){let{r,g:i,b:s,a:n}=e;return n<1&&(r=Math.round(n*r+255*(1-n)),i=Math.round(n*i+255*(1-n)),s=Math.round(n*s+255*(1-n))),new t({r,g:i,b:s})}function x(e,t){const{r,g:i,b:s}=t?.ignoreAlpha?e:w(e);return.2126*r+.7152*i+.0722*s}function S(e){return e[0]??=0,e[1]??=0,e[2]??=0,e}const T=(e,t)=>{const r=Math.floor(10*t())-5;return Math.min(255,Math.max(0,e+r))};function C(e,i,s,n={}){const o=e.r,a=e.g,l=e.b,c=i.r,u=i.g,d=i.b,h=Math.round(o+(c-o)*s),p=Math.round(a+(u-a)*s),f=Math.round(l+(d-l)*s);if(!n.offset)return new t([h,p,f]);const m=r.getRandomNumberGenerator(n.seed);return new t([T(h,m),T(p,m),T(f,m)])}e.colorEquals=function(e,t){return e===t||null!=e&&e.equals(t)},e.colorVectorEquals=function(e,t){return e===t||null!=e&&null!=t&&n.equals(e,t)},e.colorVectorToColorAndOpacity=function(e){return o.fromValues(e[0],e[1],e[2],e.length>3?e[3]:1)},e.createUniqueColors=function(e,s,n={}){if(0===e.length||s<=0)return[];if(1===(e=e.map(e=>"string"==typeof e?new t(e):e)).length||1===s){const t=[],r=e[0];for(let e=0;e<s;e++)t.push(r.clone());return t}if(n.shuffle&&(e=r.shuffle(i.clone(e),n.seed)),e.length>=s){const t=[],r=(e.length-1)/(s-1);for(let i=0;i<s;i++){const s=Math.round(i*r);t.push(e[s].clone())}return t}return function(e,t,i={}){const s=[],n=e.length-1,o=Math.ceil((t-e.length)/n);e:for(let r=0;r<n;r++){const n=e[r],a=e[r+1];for(let r=1;r<=o;r++){const l=r/(o+1);if(s.push(C(n,a,l,i)),s.length+e.length===t)break e}}return[...e.map(e=>e.clone()),...r.shuffle(s,i.seed??1)]}(e,s,n)},e.darken=function(e,t){const r=v(e);r.l*=1-t;const i=_(r),s=e.clone();return s.setColor(i),s.a=e.a,s},e.desaturate=function(e,t){const r=b(e);r.s*=t;const i=_(r),s=e.clone();return s.setColor(i),s.a=e.a,s},e.getColorLuminance=x,e.getColorTheme=function(e){return w(e).isBright?"light":"dark"},e.getContrast=function(e,r=225){return x(e,{ignoreAlpha:!0})>r?new t([0,0,0,e.a]):new t([255,255,255,e.a])},e.isRGB=a,e.multiplyOpacity=function(e,t){const r=e.clone();return r.a*=t,r},e.multiplyOpacityToUnitRGBA=function(e,r){const i=t.toUnitRGBA(e);return i[3]*=r,i},e.toHSV=b,e.toLAB=v,e.toLCH=function(e){return u(e)?e:function(e){return function(e){const t=e.l,r=e.a,i=e.b,s=Math.sqrt(r*r+i*i);let n=Math.atan2(i,r);return n=n>0?n:n+2*Math.PI,{l:t,c:s,h:n}}(g(f(e)))}(_(e))},e.toRGB=_,e.unitRGBAFromColor=function(e){return t.toUnitRGBA(e)},e.validateColor=S,e.validateColorAndOpacity=function(e){return e.length=4,S(e),e[3]??=1,s.clamp(e[3],0,1),e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/ChapmanAtmosphereTechnique":function(){define(["require","exports","../../../core/libs/gl-matrix-2/factories/vec3f64","./ChapmanApproximation.glsl","../../../chunks/ChapmanAtmosphere.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../webgl-engine/lib/DefaultVertexBufferLayouts","../../webgl/renderState","../../webgl/VertexAttributeLocations"],function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends i.ChapmanApproximationParameters{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=r.create()}}class d extends o.ShaderTechnique{constructor(t,r){super(t,r,new n.ReloadableShaderModule(s.ChapmanAtmosphere,()=>new Promise((t,r)=>e(["./ChapmanAtmosphere.glsl"],t,r))),c.fromLayout(a.Pos2TexF16))}initializePipeline(e){return l.makePipelineState({blending:e.reduced?l.copySource:l.simpleBlendingParams(770,771),depthTest:{func:e.reduced?519:515},colorWrite:l.defaultColorWrite})}}t.ChapmanAtmospherePassParameters=u,t.ChapmanAtmosphereTechnique=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/ChapmanApproximation.glsl":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/support/Ellipsoid","../webgl-engine/core/shaderModules/Float2PassUniform","../webgl-engine/core/shaderModules/Float4PassUniform","../webgl-engine/core/shaderModules/glsl","../../webgl/NoParameters"],function(e,t,r,i,s,n,o,a){"use strict";class l extends a.NoParameters{constructor(){super(...arguments),this.radii=t.create(),this.heightParameters=r.create()}}e.ChapmanApproximation=function(e){e.uniforms.add(new s.Float2PassUniform("radii",e=>e.radii),new n.Float4PassUniform("heightParameters",e=>e.heightParameters)),e.constants.add("scaleHeight","float",i.earth.scaleHeight*i.earth.atmosphereHeight),e.code.add(o.glsl`float chapmanApproximation(float thickness, float height, float cosZenith) {
float c = sqrt(thickness + height);
float cExpH = c * exp(-height);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (thickness + height);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(thickness - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),e.code.add(o.glsl`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),e.code.add(o.glsl`vec4 planetIntersect(vec3 cameraPos, vec3 rayDir) {
float reducedPlanetRadius = radii[0] - 20000.0;
float rayPlanetDistance = heightParameters[1] - reducedPlanetRadius * reducedPlanetRadius;
vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, rayPlanetDistance);
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, heightParameters[2]);
bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
bool insideAtmosphere = heightParameters[0] < radii[1];
if (!(hitsAtmosphere || insideAtmosphere)) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;
if (heightParameters[0] < reducedPlanetRadius) {
if (dot(rayDir, normalize(cameraPos)) < -0.025) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
start = rayPlanetIntersect.y;
}
float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
return vec4(0.0, hitsPlanet ? 1.0 : 0.0, start, end);
}`)},e.ChapmanApproximationParameters=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/ChapmanAtmosphere.glsl":function(){define(["exports","../views/3d/environment/ChapmanRaymarching.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/shaders/ScreenSpacePassAtmosphere.glsl","../views/3d/webgl-engine/shaders/SphereIntersect.glsl","../views/3d/webgl-engine/shaders/ToneMapping.glsl","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(e){const h=new d.ShaderBuilder;h.include(l.ScreenSpacePassAtmosphere);const{reduced:p}=e,{fragment:f}=h;return i.addMainLightDirection(f),f.include(r.Gamma),f.include(c.SphereIntersect),f.include(u.ToneMapping),f.include(t.ChapmanRaymarching,!1),f.uniforms.add(new s.Float3PassUniform("backgroundColor",e=>e.backgroundColor),new n.FloatPassUniform("innerFadeDistance",e=>e.innerFadeDistance),new n.FloatPassUniform("altitudeFade",e=>e.altitudeFade),new a.Texture2DBindUniform("depthTexture",e=>e.mainDepth)).code.add(o.glsl`vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
float rayPlanetDistance = heightParameters[1] - radii[0] * radii[0];
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, rayPlanetDistance);
if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
return fragColor;
}
float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
if (relDist > 1.0) {
return surfaceColor;
}
return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
}
float getGlow(float dist, float radius, float intensity) {
return pow(radius / max(dist, 1e-6), intensity);
}
vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){
float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));
vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));
float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));
return normalize(sunTransmittance) * sunDisc;
}`).main.add(o.glsl`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${o.If(!p,o.glsl`float depthSample = texture(depthTexture, uv).r;
             if (depthSample != 1.0) {
                fragColor = vec4(0);
                return;
             }`)}

      vec3 col = linearizeGamma(backgroundColor);
      col += raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      col += getSun(cameraPosition, rayDir, mainLightDirection);
      float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);
  `),h}const p=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}));e.ChapmanAtmosphere=p,e.build=h})},"esri/views/3d/environment/ChapmanRaymarching.glsl":function(){define(["exports","./atmosphereUtils","./ChapmanApproximation.glsl","../webgl-engine/core/shaderModules/Float3BindUniform","../webgl-engine/core/shaderModules/glsl"],function(e,t,r,i,s){"use strict";e.ChapmanRaymarching=function(e,n){e.include(r.ChapmanApproximation),e.uniforms.add(new i.Float3BindUniform("cameraPosition",e=>e.camera.eye)),e.constants.add("betaRayleigh","vec3",t.betaRayleigh),e.constants.add("betaCombined","vec3",t.betaCombined),e.constants.add("betaMie","float",t.betaMie),e.code.add(s.glsl`
    vec3 raymarchAtmosphere(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      vec4 ray = planetIntersect(cameraPos, rayDir);
      if(ray.x == 1.0) {
        return vec3(0);
      }
      ${s.If(n,"if (terrainDepth != -1.0) { ray.w = terrainDepth; }")}

      vec3 samplePoint = cameraPos + rayDir * ray.w;
      float multiplier = ray.y == 1.0 ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (ray.w - ray.z) / ${s.glsl.float(6)};

      for (int i = 0; i < ${s.glsl.int(6)}; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
          ${s.If(!n,"scattering *= mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0))")};
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {
          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);
          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${s.If(!n,"scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);")}
        }
        lastOpticalDepth = opticalDepth;
      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;
      ${n?"return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;":s.glsl`const float g = 0.8;
             const float gg = g * g;
             float phaseMie = 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg));
             phaseMie = clamp(phaseMie, 0.0, 128.0);
             return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/ScreenSpacePassAtmosphere.glsl":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../core/shaderModules/glsl","../core/shaderModules/Matrix4BindUniform"],function(e,t,r,i,s){"use strict";const n=r.create();e.ScreenSpacePassAtmosphere=function(e,r={needUVs:!0,needEyeDirection:!0}){e.attributes.add("position","vec2"),e.varyings.add("worldRay","vec3");const{needUVs:o,needEyeDirection:a}=r;o&&e.varyings.add("uv","vec2"),a&&e.varyings.add("eyeDir","vec3"),e.vertex.uniforms.add(new s.Matrix4BindUniform("inverseProjectionMatrix",e=>e.camera.inverseProjectionMatrix),new s.Matrix4BindUniform("inverseViewMatrix",e=>t.invertOrIdentity(n,e.camera.viewMatrix))),e.vertex.main.add(i.glsl`
    vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
    ${i.If(a,"eyeDir = posViewNear;")}
    worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
    ${i.If(o,"uv = position * 0.5 + vec2(0.5);")}
    gl_Position = vec4(position, 1, 1);
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/ChapmanAtmosphereTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.reduced=!1}}t.__decorate([r.parameter()],i.prototype,"reduced",void 0),e.ChapmanAtmosphereTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/AtmosphereCompositing.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o){"use strict";class a extends n.NoParameters{}function l(){const e=new o.ShaderBuilder;return e.include(t.ScreenSpacePass),e.fragment.uniforms.add(new s.Texture2DPassUniform("colorTexture",e=>e.color),new i.Texture2DBindUniform("depthTexture",e=>e.mainDepth)),e.fragment.main.add(r.glsl`float depthSample = texture(depthTexture, uv).r;
if (depthSample != 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const c=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:a,build:l},Symbol.toStringTag,{value:"Module"}));e.AtmosphereCompositing=c,e.AtmosphereCompositingPassParameters=a,e.build=l})},"esri/views/3d/webgl-engine/shaders/AtmosphereCompositingTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/DefaultVertexBufferLayouts","../../../../chunks/AtmosphereCompositing.glsl","../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.AtmosphereCompositing,()=>new Promise((t,r)=>e(["./AtmosphereCompositing.glsl"],t,r))),s.Pos2Locations)}initializePipeline(){return o.makePipelineState({blending:o.simpleBlendingParams(770,771),depthTest:{func:519},colorWrite:o.defaultColorWrite})}}t.AtmosphereCompositingTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/CloudsComposition":function(){define(["exports","../../../chunks/tslib.es6","../../../core/maybe","../../../core/reactiveUtils","../../../core/Logger","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../../../geometry/ellipsoidUtils","../webgl","./CloudsCompositionTechnique","../webgl-engine/effects/OpaqueEnvironment","../webgl-engine/lib/glUtil3D","../../webgl/enums"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";e.CloudsComposition=class extends h.OpaqueEnvironment{constructor(e){super(e),this._planetRadius=c.getReferenceEllipsoid(e.view.spatialReference).radius}initialize(){this.techniques.precompile(d.CloudsCompositionTechnique),this.addHandles([i.watch(()=>null!=this.view.environment.weather&&this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),i.initial)])}destroy(){this._vao=r.disposeMaybe(this._vao)}render(e){const t=e.find(({name:e})=>e===u.InternalRenderCategory.OPAQUE_ENVIRONMENT),r=this.bindParameters.clouds;if(!r.data)return t;const i=this.techniques.get(d.CloudsCompositionTechnique);if(!i.compiled)return this.requestRender(1),t;const s=this.renderingContext;this._vao??=p.createQuadVAO(s);const n=s.bindTechnique(i,this.bindParameters);return s.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(f.PrimitiveType.TRIANGLE_STRIP,0,4),r.isFading&&this.requestRender(1),t}},e.CloudsComposition=t.__decorate([l.subclass("esri.views.3d.environment.CloudsComposition")],e.CloudsComposition),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/CloudsCompositionTechnique":function(){define(["require","exports","../../../chunks/CloudsComposition.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../webgl-engine/lib/DefaultVertexBufferLayouts","../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.CloudsComposition,()=>new Promise((t,r)=>e(["./CloudsComposition.glsl"],t,r))),n.Pos2Locations)}initializePipeline(){return o.makePipelineState({blending:o.separateBlendingParams(1,0,770,1),depthTest:{func:515},colorWrite:o.defaultColorWrite})}}t.CloudsCompositionTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/CloudsComposition.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PiUtils.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/CloudsParallaxShading.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/FloatBindUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/shaders/ScreenSpacePassAtmosphere.glsl","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(){const e=new d.ShaderBuilder,{fragment:h}=e;return e.include(u.ScreenSpacePassAtmosphere,{needUVs:!1,needEyeDirection:!1}),h.include(n.ColorConversion),h.include(o.RgbaFloatEncoding),e.include(t.EvaluateAmbientLighting,{pbrMode:0,lightingSphericalHarmonicsOrder:2}),h.include(i.PiUtils),h.include(r.Gamma),e.include(s.CloudsParallaxShading),h.uniforms.add(new a.Float3BindUniform("cameraPosition",e=>e.camera.eye),new l.FloatBindUniform("cloudsOpacity",e=>e.clouds.opacity)).main.add(c.glsl`vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4(cloudsOpacity * cloudsColor.rgb, cloudsColor.a);`),e}const p=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}));e.CloudsComposition=p,e.build=h})},"esri/views/3d/environment/Fog":function(){define(["exports","../../../chunks/tslib.es6","../../../core/mathUtils","../../../core/reactiveUtils","../../../core/Logger","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../webgl","../../../chunks/Fog.glsl","./FogTechnique","./weather","../webgl-engine/effects/TransparentEnvironment","../../webgl/enums"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y){"use strict";e.Fog=class extends g.TransparentEnvironment{constructor(e){super(e),this.requireGeometryDepth=!0,this._newParameters=new _,this._oldParameters=new _,this._fadedParameters=new _,this._parameters=this._newParameters,this._passParameters=new p.FogPassParameters;const t=d.getReferenceEllipsoid(e.view.spatialReference);this._planetRadius=t.radius,this._atmosphereRadius=t.radius+t.atmosphereHeight,e.view.stage?.renderView.techniques.precompile(f.FogTechnique)}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([i.watch(()=>this.view.environment.atmosphereEnabled,()=>this.toogle(),i.syncAndInitial),i.watch(()=>this.view.environment.weather,()=>this.toogle(),i.syncAndInitial),i.watch(()=>this._updateFogParameters(),()=>{},i.syncAndInitial)]),this.addHandles(i.watch(()=>this._fadeFactor,e=>this._fade(e),i.syncAndInitial))}get _fadeFactor(){return this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1}_fade(e){const{_newParameters:t,_oldParameters:r}=this;e>=1?(this._parameters=t,this._oldParameters.copyFrom(this._newParameters)):e<=0?this._parameters=r:(this._fadedParameters.lerp(r,t,e),this._parameters=this._fadedParameters)}_updateFogParameters(){const e=this.view.environment.weather,t="foggy"===e.type||"snowy"===e.type||"rainy"===e.type;this._newParameters.strength="foggy"===e.type?r.lerp(3e-5,.005,e.fogStrength**3):"snowy"===e.type||"rainy"===e.type?r.lerp(4e-6,2e-4,(e.precipitation??0)**3):0,this._newParameters.amount=t?1:0,"foggy"!==e.type&&"snowy"!==e.type||c.copy(this._newParameters.color,x),"rainy"===e.type&&c.copy(this._newParameters.color,w),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(1)}render(e){const t=e.find(({name:e})=>e===h.InternalRenderCategory.TRANSPARENT_ENVIRONMENT);if(0===this._parameters.amount)return t;if(this._update(),this._passParameters.amount<=0)return t;const r=this.techniques.get(f.FogTechnique);if(!r.compiled)return this.requestRender(1),t;const i=this.renderingContext,s=t.getAttachment(y.DepthStencilAttachment);return t.attachDepth(null),i.bindFramebuffer(t.fbo),i.bindTechnique(r,this.bindParameters,this._passParameters),i.screen.draw(),t.attachDepth(s),t}_update(){const e=this.bindParameters.camera;c.normalize(b,e.eye);const t=Math.max(0,c.dot(b,this.bindParameters.lighting.mainLight.direction)),i=this._parameters.color;c.scale(v,i,.1),c.lerp(this._passParameters.color,v,i,t);const s=c.length(e.eye);this._passParameters.atmosphereC=s**2-this._atmosphereRadius**2,this._passParameters.amount=(1-r.smoothstep(.95*m.heightLimit,1*m.heightLimit,Math.abs(s-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}},e.Fog=t.__decorate([l.subclass("esri.views.3d.environment.Fog")],e.Fog);class _{constructor(){this.color=u.create(),this.strength=0,this.amount=0}copyFrom(e){this.amount=e.amount,this.strength=e.strength,c.copy(this.color,e.color)}lerp(e,t,i){this.amount=r.lerp(e.amount,t.amount,i),this.strength=r.lerp(e.strength,t.strength,i),c.lerp(this.color,e.color,t.color,i)}}const b=u.create(),v=u.create(),w=u.fromValues(.5,.5,.5),x=u.fromValues(1.5,1.5,1.5);e.FogParameters=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/Fog.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/shaders/ScreenSpacePassAtmosphere.glsl","../views/3d/webgl-engine/shaders/SphereIntersect.glsl","../views/3d/webgl-engine/shaders/ToneMapping.glsl","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";class f extends h.NoParameters{constructor(){super(...arguments),this.color=t.create(),this.strength=4e-6,this.atmosphereC=1,this.amount=0}}function m(){const e=new p.ShaderBuilder;e.include(c.ScreenSpacePassAtmosphere,{needUVs:!0,needEyeDirection:!0});const t=e.fragment;return t.uniforms.add(new o.FloatPassUniform("atmosphereC",e=>e.atmosphereC),new s.Float3BindUniform("cameraPosition",e=>e.camera.eye),new l.Texture2DBindUniform("depthTexture",e=>e.mainDepth),new o.FloatPassUniform("fogStrength",e=>e.strength),new o.FloatPassUniform("fogAmount",e=>e.amount),new n.Float3PassUniform("fogColor",e=>e.color)),t.include(i.Gamma),t.include(u.SphereIntersect),t.include(d.ToneMapping),t.include(r.ReadDepth),t.code.add(a.glsl`float getFogAmount(float dist, vec3 rayDir) {
if(dist == -1.0){
dist = 0.055 * sphereIntersect(cameraPosition, rayDir, atmosphereC).y;
}
return fogAmount * (1.0 - exp(-dist * fogStrength));
}`),t.main.add(a.glsl`vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = depthFromTexture(depthTexture, uv);
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linearizeDepth(depthSample);;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
float fogAmount = getFogAmount(terrainDepth, rayDir);
vec4 fog = vec4(fogColor, 1.0) * fogAmount;
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));`),e}const g=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:f,build:m},Symbol.toStringTag,{value:"Module"}));e.Fog=g,e.FogPassParameters=f,e.build=m})},"esri/views/3d/environment/FogTechnique":function(){define(["require","exports","../../../chunks/Fog.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../webgl-engine/lib/DefaultVertexBufferLayouts","../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.Fog,()=>new Promise((t,r)=>e(["./Fog.glsl"],t,r))),n.Pos2Locations)}initializePipeline(){return o.makePipelineState({blending:o.separateBlendingParams(770,0,771,1),colorWrite:o.defaultColorWrite})}}t.FogTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/LocalAtmosphere":function(){define(["exports","../../../chunks/tslib.es6","../../../core/maybe","../../../core/reactiveUtils","../../../core/Logger","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../webgl","../../../chunks/SimpleAtmosphere.glsl","./SimpleAtmosphereTechnique","./SimpleAtmosphereTechniqueConfiguration","./resources/SimpleAtmosphereTexture","../support/buffer/glUtil","../webgl-engine/effects/OpaqueEnvironment","../webgl-engine/lib/GeometryUtil","../webgl-engine/lib/VertexArrayObject","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor","../../webgl/VertexBuffer"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S){"use strict";e.LocalAtmosphere=class extends y.OpaqueEnvironment{constructor(){super(...arguments),this._configuration=new f.SimpleAtmosphereTechniqueConfiguration,this._passParameters=new h.SimpleAtmospherePassParameters,this._vao=null,this._vaoCount=0}initialize(){this._configuration.geometry=1,this.addHandles([i.watch(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),i.initial)])}destroy(){this._passParameters.texture=r.disposeMaybe(this._passParameters.texture),this._vao=r.disposeMaybe(this._vao)}precompile(){this.techniques.precompile(p.SimpleAtmosphereTechnique,this._configuration)}render(e){const t=e.find(({name:e})=>e===d.InternalRenderCategory.OPAQUE_ENVIRONMENT),r=this.techniques.get(p.SimpleAtmosphereTechnique,this._configuration);if(!r.compiled)return this.requestRender(1),t;const i=this.renderingContext;if(this._vao||(this._vao=function(e){const t=_.createPolySphereData(1,2,!1),{data:r,indices:i}=t[0][1],s=p.layout.createBuffer(i.length),n=s.position;for(let e=0;e<i.length;++e){const t=3*i[e%3==0?e+2:e%3==2?e-2:e];n.set(e,0,r[t]),n.set(e,1,r[t+1]),n.set(e,2,r[t+2])}return new b.VertexArrayObject(e,new S.VertexBuffer(e,g.glLayout(p.layout),s.buffer))}(i),this._vaoCount=this._vao.vertexCount("geometry")),!this._passParameters.texture){const e=new x.TextureDescriptor(1,512);e.wrapMode=33071,e.flipped=!0,this._passParameters.texture=new w.Texture(i,e,m.earthAtmosphereTextureSimple)}const s=i.bindTechnique(r,this.bindParameters,this._passParameters);var n,o;return n=T,o=this.bindParameters.camera.viewMatrix,c.copy(n,o),n[12]=0,n[13]=0,n[14]=0,n[15]=1,s.setUniformMatrix4fv("view",T),i.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(v.PrimitiveType.TRIANGLES,0,this._vaoCount),t}},e.LocalAtmosphere=t.__decorate([l.subclass("esri.views.3d.environment.LocalAtmosphere")],e.LocalAtmosphere);const T=u.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/SimpleAtmosphere.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec2f64","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/webgl-engine/core/shaderLibrary/Transform.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4BindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";class f extends h.NoParameters{constructor(){super(...arguments),this.texV=t.create(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new m}}class m{constructor(){this.center=r.create(),this.v1=r.create(),this.v2=r.create()}}function g(e){const t=new p.ShaderBuilder,{vertex:r,fragment:h}=t;if(s.addMainLightDirection(r),2===e.geometry)t.attributes.add("position","vec2"),t.varyings.add("color","vec4"),r.uniforms.add(new o.Float3BindUniform("cameraPosition",e=>e.camera.eye),new l.FloatPassUniform("undergroundFadeAlpha",e=>e.undergroundFadeAlpha)),r.main.add(c.glsl`float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);`),h.main.add(c.glsl`fragColor = color;`);else{t.include(i.Transform,e),t.attributes.add("position","vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const s=1===e.geometry;r.uniforms.add(new u.Matrix4BindUniform("proj",e=>e.camera.projectionMatrix),new u.Matrix4BindUniform("view",e=>e.camera.viewMatrix)),s||(t.varyings.add("innerFactor","float"),r.uniforms.add(new a.Float3PassUniform("silCircleCenter",e=>e.silhouette.center)),r.uniforms.add(new a.Float3PassUniform("silCircleV1",e=>e.silhouette.v1)),r.uniforms.add(new a.Float3PassUniform("silCircleV2",e=>e.silhouette.v2)),r.uniforms.add(new n.Float2PassUniform("texV",e=>e.texV)),r.uniforms.add(new l.FloatPassUniform("innerScale",e=>e.innerScale)));const o=6.2831853,p=1/128;r.main.add(c.glsl`
      ${s?c.glsl`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:c.glsl`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${c.glsl.float(o*p)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${c.glsl.float(p)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
	  `),h.uniforms.add(new d.Texture2DPassUniform("tex",e=>e.texture)),s||h.uniforms.add(new l.FloatPassUniform("altitudeFade",e=>e.altitudeFade)),h.main.add(c.glsl`
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${s?c.glsl`fragColor = atmosphereColor;`:c.glsl`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));`}`)}return t}const y=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:m,SimpleAtmospherePassParameters:f,build:g},Symbol.toStringTag,{value:"Module"}));e.SilhouetteCircle=m,e.SimpleAtmosphere=y,e.SimpleAtmospherePassParameters=f,e.build=g})},"esri/views/3d/environment/SimpleAtmosphereTechnique":function(){define(["require","exports","../../../chunks/SimpleAtmosphere.glsl","../support/buffer/InterleavedLayout","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends n.ShaderTechnique{constructor(t,i){super(t,i,new s.ReloadableShaderModule(r.SimpleAtmosphere,()=>new Promise((t,r)=>e(["./SimpleAtmosphere.glsl"],t,r))),l.locations)}initializePipeline(e){const t=1===e.geometry;return o.makePipelineState({blending:o.unpremultipliedAlphaToPremultipliedAlpha,culling:t?o.backFaceCullingParams:void 0,depthTest:{func:515},colorWrite:o.defaultColorWrite})}}const l=i.newLayout().vec3f("position").freeze();t.SimpleAtmosphereTechnique=a,t.layout=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/SimpleAtmosphereTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration","../webgl-engine/materials/DefaultTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(){super(...arguments),this.geometry=0}}t.__decorate([r.parameter({count:3})],s.prototype,"geometry",void 0),e.SimpleAtmosphereTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/resources/SimpleAtmosphereTexture":function(){define(["exports"],function(e){"use strict";const t=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);e.earthAtmosphereTextureSimple=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/MarsAtmosphere":function(){define(["exports","../../../chunks/tslib.es6","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/Logger","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/vec2","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/support/FloatArray","../webgl","./atmosphereUtils","../../../chunks/SimpleAtmosphere.glsl","./SimpleAtmosphereTechnique","./SimpleAtmosphereTechniqueConfiguration","./resources/MarsAtmosphereTexture","../support/mathUtils","../support/buffer/glUtil","../webgl-engine/effects/OpaqueEnvironment","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/Util","../webgl-engine/lib/VertexArrayObject","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor","../../webgl/VertexBuffer"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A){"use strict";const D=-_.innerAtmosphereDepth,E=S.makePiecewiseLinearFunction([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);function L(e,t,r,i,s){const n=p.length(e),o=i*Math.sqrt(n*n-i*i)/n,a=Math.sqrt(i*i-o*o),l=s.v1,c=s.v2;return p.scale(s.center,e,a/n),p.cross(l,e,t),p.squaredLength(l)<1&&p.cross(l,e,r),p.scale(l,l,o/p.length(l)),p.cross(c,l,e),p.scale(c,c,o/p.length(c)),o}e.MarsAtmosphere=class extends C.OpaqueEnvironment{constructor(e){super(e),this._passParameters=new b.SimpleAtmospherePassParameters,this._configuration=new w.SimpleAtmosphereTechniqueConfiguration,this._vao=null,this._fadeVao=null,this._texV1=1;const t=e.view,r=m.getReferenceEllipsoid(t.spatialReference),{outerAtmosphereRimWidth:i,radius:s}=r;this._planetRadius=s,this._innerRimFactor=1+D/s,this._middleRimFactor=1+0/s,this._outerRimFactor=1+i/s,this._texV0=0/i,this._texVScale=this._texV1-this._texV0;const n=t.stage.renderView.techniques;n.precompile(v.SimpleAtmosphereTechnique,this._configuration),this._configuration.geometry=2,n.precompile(v.SimpleAtmosphereTechnique,this._configuration)}initialize(){this.addHandles(s.watch(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),s.initial))}destroy(){this._passParameters.texture=i.disposeMaybe(this._passParameters.texture),this._fadeVao=i.disposeMaybe(this._fadeVao),this._vao=i.disposeMaybe(this._vao)}render(e){const t=e.find(({name:e})=>e===y.InternalRenderCategory.OPAQUE_ENVIRONMENT);this._update();const r=this.renderingContext;if(!this._passParameters.texture){const e=new F.TextureDescriptor(1,512);e.wrapMode=33071,e.flipped=!0,this._passParameters.texture=new I.Texture(r,e,x.marsAtmosphereTextureSimple)}if(this._passParameters.undergroundFadeAlpha<1){this._vao??=this._createRibbon(r),this._configuration.geometry=0;const e=this.techniques.get(v.SimpleAtmosphereTechnique,this._configuration);if(!e.compiled)return this.requestRender(1),t;r.bindTechnique(e,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(O.PrimitiveType.TRIANGLES,0,this._vao.vertexCount("geometry"))}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao??=P.createQuadVAO(r),this._configuration.geometry=2;const e=this.techniques.get(v.SimpleAtmosphereTechnique,this._configuration);if(!e.compiled)return this.requestRender(1),t;r.bindTechnique(e,this.bindParameters,this._passParameters),r.bindVAO(this._fadeVao),r.drawArrays(O.PrimitiveType.TRIANGLE_STRIP,0,this._fadeVao.vertexCount("geometry"))}return t}_update(){const e=this.bindParameters.camera,t=f.create(),i=this._planetRadius,s=p.length(e.eye),n=s-i;if(n<0){const e=Math.min(-n/5e3,1);this._passParameters.undergroundFadeAlpha=e}else this._passParameters.undergroundFadeAlpha=0;const o=Math.max(50,n),a=i+D;var l,c,u;this._passParameters.innerScale=(c=i,u=a,(l=i+o)*l/(Math.sqrt(l*l-c*c)*Math.sqrt(l*l-u*u)+c*u)-1),this._passParameters.altitudeFade=_.computeInnerAltitudeFade(n),p.scale(t,e.eye,(i+50)/s),L(t,e.center,e.up,i,this._passParameters.silhouette);const d=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),m=1-511/512,g=E(n);let y=this._texV0+m*this._texVScale,b=this._texV0+d*g*this._texVScale;if(n>50){L(e.eye,e.center,e.up,i,this._passParameters.silhouette);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),s=r.clamp((t-1.5)/(d-1.5),0,1);y=this._texV0+s*m*this._texVScale,b=this._texV0+r.lerp(this._texV1,d*g,s)*this._texVScale}h.set(this._passParameters.texV,y,b)}_createRibbon(e){const t=g.newFloatArray(1155),r=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let e=0;e<128;e++){const i=9*e+3;t[i]=e,t[i+1]=this._innerRimFactor,t[i+2]=-1,t[i+3]=e,t[i+4]=this._middleRimFactor,t[i+5]=0,t[i+6]=e,t[i+7]=this._outerRimFactor,t[i+8]=1;const s=3*e+1,n=127===e?1:s+3,o=15*e;r[o]=s,r[o+1]=s+1,r[o+2]=n+1,r[o+3]=n+1,r[o+4]=n,r[o+5]=s,r[o+6]=s+1,r[o+7]=s+2,r[o+8]=n+2,r[o+9]=n+2,r[o+10]=n+1,r[o+11]=s+1,r[o+12]=s,r[o+13]=n,r[o+14]=0}const i=v.layout.createBuffer(r.length),s=i.position;for(let e=0;e<r.length;++e){const i=3*r[e];s.set(e,0,t[i]),s.set(e,1,t[i+1]),s.set(e,2,t[i+2])}return new R.VertexArrayObject(e,new A.VertexBuffer(e,T.glLayout(v.layout),i.buffer))}_computeScreenRimWidth(e,t,r,i){return p.add(U,i.center,i.v2),p.scale(B,U,this._outerRimFactor),u.lookAt(V,t,U,r),M.project(U,V,e.projectionMatrix,e.viewport,U),M.project(B,V,e.projectionMatrix,e.viewport,B),p.distance(U,B)/e.height}},e.MarsAtmosphere=t.__decorate([c.subclass("esri.views.3d.environment.MarsAtmosphere")],e.MarsAtmosphere);const V=d.create(),U=f.create(),B=f.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/environment/resources/MarsAtmosphereTexture":function(){define(["exports"],function(e){"use strict";const t=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]);e.marsAtmosphereTextureSimple=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/ComponentObjectCollection":function(){define(["require","exports","../../../../../core/Logger","../../../../../core/MapUtils","../../../../../core/PooledArray","../../../../../core/typedArrayUtil","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/Indices","../../../../../chunks/vec3","../../../../../chunks/vec33","../../../layers/support/symbolColorUtils","../../../support/orientedBoundingBox","../../../support/buffer/glUtil","./ComponentData","./ComponentObject","./IntersectionGeometry","./Renderable","./RenderGeometry","./RenderSubmitSystem","./SourceGeometry","./UniformComponentParameters","./Material/ComponentMaterial","./Material/ComponentTechnique","./Material/shader/ComponentData.glsl","../../effects/geometry/olidUtils","../../lib/ComponentUtils","../../lib/Util","../../lib/VertexArrayObject","../../lib/verticalOffsetUtils","../../lib/TextureBackedBuffer/BufferManager","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexBuffer"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E){"use strict";const L=()=>r.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");function V(e,t){return e===t?0:0===e?2:1}const U=l.create();t.ComponentObjectCollection=class{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._activeHighlightOptions=new Map,this._visible=new s,this._hidden=new s,this._renderSubmit=new v.RenderSubmitSystem(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new F.BufferManager(e.rctx,C.getComponentFieldCount())}destroy(){R.assert(0===this._hidden.length&&0===this._visible.length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._componentBufferManager=null,this._visible.forAll(e=>e.destroy()),this._visible.prune(),this._hidden.forAll(e=>e.destroy()),this._hidden.prune(),this._renderSubmit.destroy()}createObject(e){const t=e.geometry,r=new m.ComponentData(this._componentBufferManager,c.compactIndices(t.componentOffsets)),i=this._createRenderable(e,r),s=new y.IntersectionGeometry(this._viewingMode,t.positionData,r),n=new g.ComponentObject(e.transform,e.toMapSpace,e.obb.clone(),r,i,s);return(n.visible?this._visible:this._hidden).push(n),n}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const r=e;t!==r.visible&&(t?(this._hidden.removeUnordered(r),this._visible.push(r)):(this._visible.removeUnordered(r),this._hidden.push(r)),r.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll(e=>e.renderable.meta.cameraDepthSquared=o.squaredDistance(t,e.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const r=e.renderable.material;t(r),r.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const r=e;r.componentData.visibility.reset(t),r.componentData.markVisibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.componentData.visibility.forEachComponent(t)}getComponentCount(e){const t=e,r=t.componentData.visibility.componentCount;return{visible:r,invisible:t.componentData.count-r}}setComponentData(e,t){const r=e,{renderable:i,componentData:s}=r,n=i.material,o=s.materialDataBuffer,a=s.materialDataIndices,l=new x.UniformComponentParameters,c=o.textureBuffer,u=new Uint8Array(4),d=new Uint32Array(u.buffer);let f=0,m=0,g=0,y=0,_=0,b=s.verticalOffsets,v=1/0,w=-1/0,T=!1,R=!1,O=!1,I=0;for(let e=0;e<s.count;e++){t(e,l),f+=+(l.externalColor[3]<1),m+=+(3===l.externalColorMixMode&&1===l.externalColor[3]),y+=+(l.emissiveStrength>0),_+=+(1===l.emissiveSource),R||=1!==l.emissiveStrength,g+=+l.castShadows,h.encodeSymbolColor(l.externalColor,l.externalColorMixMode,u),u[2]=254&u[2]|+l.castShadows,c.setData(a[e],0,u[0],u[1],u[2],u[3]),T||=e>0&&I!==d[0],I=d[0],O||=0!==l.elevationOffset,O&&null==b&&(b=new Array(e).fill(0)),null!=b&&(b[e]=l.elevationOffset),v=Math.min(v,l.elevationOffset),w=Math.max(w,l.elevationOffset),C.encodeElevationOffset(l.elevationOffset,u),c.setData(a[e],1,u[0],u[1],u[2],u[3]),C.encodeEmissiveStrength(l.emissiveStrength,u),c.setData(a[e],2,u[0],u[1],u[2],0===l.emissiveSource?0:255);const r=l.olidColor;null!=r&&c.setData(a[e],3,r[0],r[1],r[2],r[3]),l.pickable!==M.getVisibility(s.pickability,e)&&M.updatePickabilityWithCount(s,e,l.pickable)}s.verticalOffsets=O?b:null,r.offsetObb=O?p.computeOffsetObb(r.obb,v,w,this._viewingMode,r.offsetObb??r.obb.clone()):null,T||O||P.olidEnabled()||(R||_>0)&&y>0?(n.componentParameters=new S.ComponentParametersVarying,n.componentParameters.castShadows=V(g,s.count),n.componentParameters.transparent=V(f,s.count),n.componentParameters.opaqueOverride=V(m,s.count),n.componentParameters.emissiveOverride=V(y,s.count),n.componentParameters.emissiveSourceOverride=V(_,s.count),n.componentParameters.texture=c,c.updateTexture()):(n.componentParameters=new S.ComponentParametersUniform,n.componentParameters.castShadows=l.castShadows?0:2,n.componentParameters.externalColor=l.externalColor,n.componentParameters.externalColorMixMode=l.externalColorMixMode,n.componentParameters.emissiveStrength=l.emissiveStrength,n.componentParameters.emissiveSource=l.emissiveSource),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,r,i=!1){e.intersectionGeometry.getComponentAabb(t,r);const s=e,n=s.componentData.verticalOffsets;if(i||null==n)return r;const o=n[t];if(2===this._viewingMode||0===o)return r[2]+=o,r[5]+=o,r;const a=I.getVerticalOffsetI3S(o);return a.localOrigin=s.transform.position,a.applyToAabb(r)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,r){return e.intersectionGeometry.getComponentPositions(t,r)}expandRangeWithComponentObjectElevationRange(e,t,r,i){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||i.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const s=e,n=s.componentData,o=n.count,a=n.verticalOffsets,l=s.intersectionGeometry,c=2===this._viewingMode,u=l.getComponentAabbs(),d=U;let h=1/0,p=-1/0;for(let e=0;e<o;e++){const n=6*e,o=a?.[e]??0;let l=1/0,f=-1/0;if(c)l=u[n+2]+o+t,f=u[n+5]+o+t;else{if(d[0]=u[n],d[1]=u[n+1],d[2]=u[n+2],d[3]=u[n+3],d[4]=u[n+4],d[5]=u[n+5],0!==o){const e=I.getVerticalOffsetI3S(o);e.localOrigin=s.transform.position,e.applyToAabb(d)}const e=Math.max(Math.abs(d[3]),Math.abs(d[0])),a=Math.max(Math.abs(d[4]),Math.abs(d[1])),l=t+d[5]+r;i.expandElevationRangeValues(t+d[2],Math.sqrt(e*e+a*a+l*l)-r)}i.expandElevationRangeValues(l,f),h=Math.min(h,l),p=Math.max(p,f)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=h,this._elevationRangeCacheMax=p}intersect(e,t,r,i,s,n,o){const a=e,{transform:l,componentData:c,intersectionGeometry:u}=a;return null!=s&&(s.localOrigin=l.position),u.intersect(t,r,i,s,c.verticalOffsets,l,n,o)}addEdges(e,t,r,i,s){const n=e,{indices:o,positions:a}=n.intersectionGeometry,l=n.componentData.offsets;return t.addComponentObject(n,a,o,l,r,i,s)}async extractEdgeInformation(t,r,i){const s=t,n=s.componentData.visibility;if(n.allInvisible()){const{extractComponentsEdgeLocationsLayout:t}=await new Promise((t,r)=>e(["../../lib/edgeRendering/edgeProcessing"],t,r));return{buffer:t.createBuffer(0),origin:[0,0,0]}}const{indices:o,positions:l}=s.intersectionGeometry,c=s.componentData.offsets,{EdgeInputBufferLayout:h}=await new Promise((t,r)=>e(["../../lib/edgeRendering/bufferLayouts"],t,r)),p=h.createBuffer(l.length/3);d.copy(p.position.typedBuffer,l,p.position.typedBufferStride,3),u.transformMat3View(p.position,p.position,s.transform.rotationScale),this._setComponentIndices(p.componentIndex,o,c);const f=p.count,m=this._computeVisibilityIndices(o,n,c,f);return{origin:a.clone(s.transform.position),buffer:await r.extractComponentsEdgeLocations({indices:m,indicesLength:m.length,skipDeduplicate:!0,data:p,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,t,r){let i=0;for(let s=0;s<r.length-1;s++){const n=r[s],o=r[s+1];for(let r=n;r<o;r++){const s=t?t[r]:r;e.set(s,i)}i++}}_computeVisibilityIndices(e,t,r,i){if(e&&t.allVisible())return e;let s=0;t.forEachComponentRange((e,t)=>(s+=r[t]-r[e],!0));const o=n.isTypedArray(e)?2===e?.BYTES_PER_ELEMENT||i<=65536?new Uint16Array(s):new Uint32Array(s):new Array(s);let a=0;return t.forEachComponentRange((t,i)=>{const s=r[t],n=r[i];for(let t=s;t<n;t++)o[a++]=e?e[t]:t;return!0}),o}addComponentHighlight(e,t,r){const s=e.componentData,n=i.getOrCreateMapValue(s.componentHighlights,r,()=>new Uint32Array(s.count+1));{const e=this._activeHighlightOptions.get(r)??0;this._activeHighlightOptions.set(r,e+1)}0===n[t]++&&(s.markHighlightsDirty(),this._notifyDirty()),n[s.count]++}removeComponentHighlight(e,t,r){const{componentData:i}=e,s=i.componentHighlights.get(r);if(void 0===s)return void L().warn("Removing non-existing highlight.");const n=s[t];if(0===n)return void L().warn("Removing non-existing highlight.");this._removeActiveHighlight(r);const o=s[i.count];if(n>1)return s[t]=n-1,void(s[i.count]=o-1);s[t]=0,1===o?i.componentHighlights.delete(r):s[i.count]=o-1,i.markHighlightsDirty(),this._notifyDirty()}_removeActiveHighlight(e,t=1){const r=this._activeHighlightOptions.get(e);if(void 0===r)L().warn("Removing non-existing highlight.");else{const i=r-t;i<0&&L().warn("Removing non-existing highlight."),i<=0?this._activeHighlightOptions.delete(e):this._activeHighlightOptions.set(e,i)}}clearHighlights(e){const{componentData:t}=e,{componentHighlights:r}=t;if(r.size>0){for(const e of r)this._removeActiveHighlight(e[0],e[1][t.count]);r.clear(),t.markHighlightsDirty(),this._notifyDirty()}}hasHighlight(e){return this._activeHighlightOptions.has(e)}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const r=this._renderManager.rctx,i=e.geometry,s=i.vertices.layoutParameters,n=f.glLayout(w.createVertexBufferLayout(s)),o=new E.VertexBuffer(r,n,i.vertices.data),a=i.indices?A.BufferObject.createIndex(r,35044,i.indices):null,l=new Uint16Array(i.vertices.count);for(let e=0;e<t.count;e++){const r=t.offsets[e],s=t.offsets[e+1],n=t.materialDataIndices[e];if(null!=i.indices)for(let e=r;e<s;e++)l[i.indices[e]]=n;else for(let e=r;e<s;e++)l[e]=n}const c=new E.VertexBuffer(r,T.indexGlLayout,l.buffer),u=new S.ComponentMaterial(e.transform,e.toMapSpace),d=new O.VertexArrayObject(r,new Map([["geometry",o],["componentIndices",c]]),a),h=new b.RenderGeometry(d,D.PrimitiveType.TRIANGLES,s,null!=a),p={cameraDepthSquared:.5,gpuMemoryEstimate:o.usedMemory+c.usedMemory+(null!=a?a.usedMemory:0)};return new _.Renderable(u,h,p)}_notifyDirty(){this._renderManager.notifyDirty()}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/vec3":function(){define(["exports","../colorUtils","../core/has","../core/Logger"],function(e,t,r,i){"use strict";function s(e,t,r){n(e.typedBuffer,t.typedBuffer,r,e.typedBufferStride,t.typedBufferStride)}function n(e,t,r,i=3,s=i){if(e.length/i!==Math.ceil(t.length/s))return e;const n=e.length/i,o=r[0],a=r[1],l=r[2],c=r[4],u=r[5],d=r[6],h=r[8],p=r[9],f=r[10],m=r[12],g=r[13],y=r[14];let _=0,b=0;for(let r=0;r<n;r++){const r=t[_],n=t[_+1],v=t[_+2];e[b]=o*r+c*n+h*v+m,e[b+1]=a*r+u*n+p*v+g,e[b+2]=l*r+d*n+f*v+y,_+=s,b+=i}return e}function o(e,t,r){a(e.typedBuffer,t.typedBuffer,r,e.typedBufferStride,t.typedBufferStride)}function a(e,t,r,i=3,s=i){if(e.length/i!==Math.ceil(t.length/s))return;const n=e.length/i,o=r[0],a=r[1],l=r[2],c=r[3],u=r[4],d=r[5],h=r[6],p=r[7],f=r[8];let m=0,g=0;for(let r=0;r<n;r++){const r=t[m],n=t[m+1],y=t[m+2];e[g]=o*r+c*n+h*y,e[g+1]=a*r+u*n+p*y,e[g+2]=l*r+d*n+f*y,m+=s,g+=i}}function l(e,t,r){c(e.typedBuffer,t.typedBuffer,r,e.typedBufferStride,t.typedBufferStride)}function c(e,t,r,i=3,s=i){const n=Math.min(e.length/i,t.length/s);let o=0,a=0;for(let l=0;l<n;l++)e[a]=r*t[o],e[a+1]=r*t[o+1],e[a+2]=r*t[o+2],o+=s,a+=i;return e}function u(e,t,r,i){d(e.typedBuffer,t.typedBuffer,r,i,e.typedBufferStride,t.typedBufferStride)}function d(e,r,i,s,n=3,o=n){const a=Math.min(e.length/n,r.length/o);let l=0,c=0;const u=1/t.colorGamma;for(let t=0;t<a;t++)e[c]=s*(i*r[l])**u,e[c+1]=s*(i*r[l+1])**u,e[c+2]=s*(i*r[l+2])**u,l+=o,c+=n}function h(e,t,r,i=3,s=i){const n=e.length/i;if(n!==Math.ceil(t.length/s))return e;let o=0,a=0;for(let l=0;l<n;l++)e[a]=t[o]+r[0],e[a+1]=t[o+1]+r[1],e[a+2]=t[o+2]+r[2],o+=s,a+=i;return e}function p(e,t){f(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)}function f(e,t,r=3,i=r){const s=Math.min(e.length/r,t.length/i);let n=0,o=0;for(let a=0;a<s;a++){const s=t[n],a=t[n+1],l=t[n+2],c=s*s+a*a+l*l;if(c>0){const t=1/Math.sqrt(c);e[o]=t*s,e[o+1]=t*a,e[o+2]=t*l}n+=i,o+=r}}function m(e,t,r){const i=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;let l=0,c=0;for(let e=0;e<i;e++)s[c]=o[l]>>r,s[c+1]=o[l+1]>>r,s[c+2]=o[l+2]>>r,l+=a,c+=n}const g=Object.freeze(Object.defineProperty({__proto__:null,linearToSRGB:d,linearToSRGBView:u,normalize:f,normalizeView:p,scale:c,scaleView:l,shiftRight:m,transformMat3:a,transformMat3View:o,transformMat4:n,transformMat4View:s,translate:h},Symbol.toStringTag,{value:"Module"}));e.linearToSRGB=d,e.linearToSRGBView=u,e.normalize=f,e.normalizeView=p,e.scale=c,e.scaleView=l,e.shiftRight=m,e.transformMat3=a,e.transformMat3View=o,e.transformMat4=n,e.transformMat4View=s,e.translate=h,e.vec3=g})},"esri/chunks/vec33":function(){define(["exports"],function(e){"use strict";function t(e,t){r(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)}function r(e,t,r=3,i=r){const s=t.length/i;let n=0,o=0;for(let a=0;a<s;++a)e[n]=t[o],e[n+1]=t[o+1],e[n+2]=t[o+2],n+=r,o+=i}function i(e,t,r,i,s){const n=e.typedBuffer,o=e.typedBufferStride,a=s?.count??e.count;let l=(s?.dstIndex??0)*o;for(let e=0;e<a;++e)n[l]=t,n[l+1]=r,n[l+2]=i,l+=o}const s=Object.freeze(Object.defineProperty({__proto__:null,copy:r,copyView:t,fill:i},Symbol.toStringTag,{value:"Module"}));e.copy=r,e.copyView=t,e.fill=i,e.vec3=s})},"esri/views/3d/webgl-engine/collections/Component/ComponentData":function(){define(["exports","../../../../../core/MapUtils","./IndexRange/ComponentRange","../../../../support/HighlightDefaults"],function(e,t,r,i){"use strict";e.ComponentData=class{constructor(e,t){this.offsets=t,this._highlightsInOrder=[],this.pickability=null,this.componentHighlights=new Map,this.verticalOffsets=null,this._cachedGeometryRanges=null,this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null;const i=this.count;this.visibility=new r.ComponentRange(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let e=0;e<i;e++)this.materialDataIndices[e]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return null==this._cachedGeometryRanges&&(this._cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this._cachedGeometryRanges}get highlightRangesMap(){return 0===this.componentHighlights.size?null:(this._updateCachedHighlightRanges(),this._cachedHighlightRangesMap)}get shadowmapRanges(){return 0===this.componentHighlights.size?this.geometryRanges:(this._updateCachedHighlightRanges(),this._cachedShadowmapRanges)}markHighlightsDirty(){this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null}markVisibilityDirty(){this._cachedGeometryRanges=null,this.markHighlightsDirty()}updateHighlights(e){this._updateHighlightOrder(e)&&(this.markHighlightsDirty(),this._updateCachedHighlightRanges())}_updateHighlightOrder(e){const{_highlightsInOrder:t}=this;let r=t.length!==e.length;t.length=Math.min(e.length,8);for(let i=0;i<e.length;++i){const s=e.at(i).name;t.length<i?(r=!0,t.push(s)):t[i]!==s&&(t[i]=s,r=!0)}return r}_updateCachedHighlightRanges(){if(null==this._cachedHighlightRangesMap||null==this._cachedShadowmapRanges){const{highlightRangesMap:e,shadowmapRangesMap:r}=function(e,r,s,n){const o=new Map,a=[];if(e.size>0){let l=s.length;r.forEachComponent(r=>{let c=!1;for(let a=n.length-1;a>=0;--a){const l=n[a],u=e.get(l);if((u?.[r]??0)>0){const e=t.getOrCreateMapValue(o,l,()=>[]),n=s[r],a=s[r+1];e.push(n),e.push(a-n),c||=l===i.defaultHighlightName;break}}return c||(l!==r-1&&(a.length>0&&a.push(s[l+1]-a[a.length-1]),a.push(s[r])),l=r),!0}),a.length>0&&a.push(s[l+1]-a[a.length-1])}return{highlightRangesMap:o,shadowmapRangesMap:a}}(this.componentHighlights,this.visibility,this.offsets,this._highlightsInOrder);this._cachedHighlightRangesMap=e,this._cachedShadowmapRanges=r}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/IndexRange/ComponentRange":function(){define(["exports"],function(e){"use strict";e.ComponentRange=class{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return 0===this._indexRanges.length}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;const t=this._indexRanges;let r=0,i=t.length/2;if(e<t[2*r]||e>t[2*i]+t[2*i+1])return!1;for(;i-r>0;){const s=Math.floor(.5*(r+i)),n=t[2*s];if(e<n){if(i-r===1)return!1;i=s}else{if(e<n+t[2*s+1])return!0;if(i-r===1)return!1;r=s+1}}return!1}get componentCount(){if(-1===this._componentCountCache){const e=this._indexRanges;let t=0;for(let r=0;r<e.length;r+=2)t+=e[r+1];this._componentCountCache=t}return this._componentCountCache}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let r=e[0],i=1;for(let s=1;s<e.length;s++){const n=e[s];r+i===n?i+=1:(t.push(r),t.push(i),r=n,i=1)}return t.push(r),t.push(i),t}(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let r=0;r<t.length;r+=2){const i=t[r],s=i+t[r+1];for(let t=i;t<s;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let r=0;r<t.length;r+=2){const i=t[r];if(!e(i,i+t[r+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),r=this._indexRanges;for(let i=0;i<r.length;i+=2){const s=r[i],n=s+r[i+1],o=e[s],a=e[n];t[i]=o,t[i+1]=a-o}return t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/ComponentObject":function(){define(["exports","../../../../../core/maybe"],function(e,t){"use strict";e.ComponentObject=class{constructor(e,t,r,i,s,n){this.transform=e,this.toMapSpace=t,this.obb=r,this.componentData=i,this.renderable=s,this.intersectionGeometry=n,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=t.destroyMaybe(this.intersectionGeometry),this.renderable=t.destroyMaybe(this.renderable),this.componentData=t.destroyMaybe(this.componentData)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/IntersectionGeometry":function(){define(["exports","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/FloatArray","../../../../../geometry/support/Indices","./ComponentObjectElevationAgnosticComponentBVH"],function(e,t,r,i,s,n,o,a,l){"use strict";const c=s.create(),u=s.create(),d=r.create(),h=s.create(),p=r.create();e.IntersectionGeometry=class{constructor(e,t,r){this.viewingMode=e,this.positionData=t,this._components=r,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=s.create(),this._componentBvh=null,this._aabb=n.create(),this._indices=t.indices?a.compactIndices(t.indices):a.getContinuousIndexArray(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const r=this._ensureComponentAabbs(),i=6*e;return t[0]=r[i],t[1]=r[i+1],t[2]=r[i+2],t[3]=r[i+3],t[4]=r[i+4],t[5]=r[i+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,r,s,n,o,a,l,f){this.verticalOffset=n,this.componentVerticalOffsets=o;const{position:m}=a,g=i.sub(c,e,m),y=i.sub(u,r,m),_=t.invert(d,a.rotationScale);i.transformMat3(g,g,_),i.transformMat3(y,y,_);const b=t.transpose(p,_);if(1===this.viewingMode){const e=this._planetCenter;i.negate(e,m),i.transformMat3(e,e,_)}this._intersectComponents(g,y,o,n,(e,t,r,s)=>{f(r,e,s?i.transformMat3(h,s,b):null,t)},s,l)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),r=.5*(e[1]+e[4]),i=.5*(e[2]+e[5]),s=this._components.count,n=o.newFloatArray(6*s),a=this._indices,l=this._positions,c=this._components.offsets;let u=0,d=1/0,h=1/0,p=1/0,f=-1/0,m=-1/0,g=-1/0;for(let e=0;e<s;e++){const s=c[e],o=c[e+1];let y=1/0,_=1/0,b=1/0,v=-1/0,w=-1/0,x=-1/0;if(s<o)for(let e=s;e<o;e++){const t=3*a[e],r=l[t],i=l[t+1],s=l[t+2];y=Math.min(y,r),_=Math.min(_,i),b=Math.min(b,s),v=Math.max(v,r),w=Math.max(w,i),x=Math.max(x,s)}else y=t,_=r,b=i,v=t,w=r,x=i;n[u++]=y,n[u++]=_,n[u++]=b,n[u++]=v,n[u++]=w,n[u++]=x,d=Math.min(d,y),h=Math.min(h,_),p=Math.min(p,b),f=Math.max(f,v),m=Math.max(m,w),g=Math.max(g,x)}return this._aabb[0]=d,this._aabb[1]=h,this._aabb[2]=p,this._aabb[3]=f,this._aabb[4]=m,this._aabb[5]=g,n}_intersectComponents(e,t,r,i,s,n,o){let a=this._componentBvh;null==a&&(a=new l.ComponentObjectElevationAgnosticComponentBVH(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=a),a.intersectRay(e,t,r,i,s,n,o)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return 2===this.viewingMode}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/ComponentObjectElevationAgnosticComponentBVH":function(){define(["exports","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/DoubleArray","./ComponentObjectElevationAgnosticComponentGeometryBVH","./ElevationAgnosticBVH","../../lib/ComponentUtils","../../lib/RayIntersections"],function(e,t,r,i,s,n,o,a,l){"use strict";const c=i.create(),u=r.create(),d=r.create(),h=r.create(),p=r.create(),f=()=>{},m=new l.MeshIntersectionOptions;e.ComponentObjectElevationAgnosticComponentBVH=class{constructor(e,t,i,s,n,a,l,c){this.vertexData=e,this.vertexStride=t,this.indexData=i,this._components=s,this._componentAabbs3D=n,this.geometryMinZ=a,this.planetCenterZ=l,this.localMode=c,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=h,this._ray1=p,this._invDir=r.create(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=m,this._callback=f,this.rayDirectionC=r.create(),this._componentIndexMap=null,this._bvh=new o.ElevationAgnosticBVH(s.count,this),this.componentIntersectionData=new Array(s.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:r}=this,i=s.newDoubleArray(4*e),n=this._componentAabbs3D;for(let s=0;s<e;++s){const e=6*s,o=n[e+0],a=n[e+1],l=n[e+2],c=n[e+3],u=n[e+4],d=r/(l-t),h=r/(n[e+5]-t),p=Math.min(o*d,o*h),f=Math.min(a*d,a*h),m=Math.max(c*d,c*h),g=Math.max(u*d,u*h),y=4*s;i[y+0]=p,i[y+1]=f,i[y+2]=m,i[y+3]=g}return i}getAabbs2DLocal(){const{numComponents:e}=this,t=s.newDoubleArray(4*e),r=this._componentAabbs3D;for(let i=0;i<e;++i){const e=6*i,s=r[e+0],n=r[e+1],o=r[e+3],a=r[e+4],l=4*i;t[l+0]=s,t[l+1]=n,t[l+2]=o,t[l+3]=a}return t}intersectRay(e,t,r,i,s,n,o){const{isVerticalRay:a}=o;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=r,this._verticalOffset=i,this._tolerance=n,this._intersectionOptions=o,this._componentIndexMap=this._bvh.elementIndexMap,l.computeInvDir(e,t,this._invDir),this._callback=s,this._bvh.intersectRay(e,t,a),this._callback=f}intersectRange(e,t){const r=this._componentIndexMap,{pickability:i,visibility:s}=this._components;for(let n=e;n<t;++n){const e=r?r[n]:n;a.getVisibility(i,e)&&s.isVisible(e)&&this._intersectComponent(e)}}getComponentTriangleCount(e){const t=this._components.offsets,r=t[e]/3;return t[e+1]/3-r}getComponentAabb3D(e,t){const r=this._componentAabbs3D,i=6*e;return t[0]=r[i],t[1]=r[i+1],t[2]=r[i+2],t[3]=r[i+3],t[4]=r[i+4],t[5]=r[i+5],t}_intersectComponent(e){const r=this.getComponentAabb3D(e,c);let i=!1;const{localMode:s,_componentVerticalOffsets:o,_verticalOffset:a,_ray0:h,_ray1:p,_invDir:f,planetCenterZ:m,_tolerance:g,rayDirectionC:y,componentIntersectionData:_}=this,{isVerticalRay:b}=this._intersectionOptions,v=this._components.offsets,w=t.copy(u,h),x=t.copy(d,p),S=o?.[e]??0,T=S+(a?.offset??0);if(0!==T&&(s?(w[2]=h[2]-T,x[2]=p[2]-T,i=!0):null!=a&&(a.componentOffset=S)),null==a||i||0===T||a.applyToAabb(r),!l.intersectAabbInvDir(r,w,f,g))return;t.sub(y,x,w);const C=v[e]/3,P=v[e+1]/3,M=P-C,R=(t,r,i)=>{this._callback(t,r,e,i)},{vertexData:O,vertexStride:I,indexData:F,_intersectionOptions:A}=this,{normalRequired:D}=A;if(M>40){let t=_[e];null==t&&(t=new n.ComponentObjectElevationAgnosticComponentGeometryBVH(e,O,I,F,C,P,this.geometryMinZ,m,s),_[e]=t),t.intersectRay(w,x,b,i?0:T,R,D)}else{const e=i?0:T;n.intersectTriangleRangeForComponent(w,y,C,P,F,O,I,e,m,D,R)}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/ComponentObjectElevationAgnosticComponentGeometryBVH":function(){define(["exports","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./ElevationAgnosticBVH","../../lib/RayIntersections","../../lib/triangleIntersectionUtils"],function(e,t,r,i,s,n){"use strict";function o(e,t,r,i,n,o,a,l,c,u,d,h=null,p=0){0!==l?s.intersectRayTrianglesWithVerticalOffsetENUGlobal(e,t,r,i,n,o,a,l,c,u,d,h,p):s.intersectRayTriangles(e,t,r,i,n,o,a,u,d,h,p)}function a(){}e.ComponentObjectElevationAgnosticComponentGeometryBVH=class{constructor(e,t,s,n,o,l,c,u,d){this.componentIndex=e,this.vertexData=t,this.vertexStride=s,this.indexData=n,this.startTriangleNumber=o,this.endTriangleNumber=l,this.geometryMinZ=c,this.planetCenterZ=u,this.localMode=d,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=r.create(),this.ray0=r.create(),this.isVerticalRay=!1,this._triangleHitCallback=a,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new i.ElevationAgnosticBVH(l-o,this)}getAabbs2D(){return this.localMode?n.generateTriangleAabbsLocal(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):n.generateTriangleAabbsGlobal(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,r,i,s,n,o){t.copy(this.ray0,e),t.sub(this.rayDirection,r,e),this.isVerticalRay=i,this.totalElevationOffset=s,this.normalRequired=o,this._triangleHitCallback=n,this._bvh.intersectRay(e,r,i),this._triangleHitCallback=a}intersectRange(e,t){const r=this._bvh.elementIndexMap;o(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,r,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}},e.intersectTriangleRangeForComponent=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/ElevationAgnosticBVH":function(){define(["exports","../../../../../core/mathUtils","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingRect","../../lib/triangleIntersectionUtils"],function(e,t,r,i,s){"use strict";function n(e,t,r,i){const s=4*e,n=i[s+0+t];return i[s+2+t]<r?-1:n>r?1:0}class o{constructor(e,t,r,i,s,n,o){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=r,this.maxIndexIndex=i,this.dim=s,this.d=n,this.aabb2D=o,this.child0=-1,this.child1=-1}}e.ElevationAgnosticBVH=class{constructor(e,t){this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=r.fromValues(0,0,this.planetCenterZ),this.maxBspNodeDepth=t.maxBspNodeDepth??8,this.minElementCountForBVH=t.minElementCountForBVH??15,this.minBspNodeElementCount=t.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||0===this._bspNodes.length&&this._generateBsp()}intersectRay(e,t,r){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(r):this._intersectRayWithBVH(e,t,r))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,r){this._ensureBVH(),r?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],r=e[1];if(!this.localMode){const{geometryMinZ:i,planetCenterZ:s}=this,n=(i-s)/(e[2]-s);t=e[0]*n,r=e[1]*n}const{_bspNodes:i}=this;let s=0;for(;s>=0;){const e=i[s],{d:n,dim:o,minIndexIndex:a,minMidIndexIndex:l,maxMidIndexIndex:c,maxIndexIndex:u,aabb2D:d}=e;if(t<d[0]||t>d[2]||r<d[1]||r>d[3])break;if(-1===o||-1===e.child0&&-1===e.child1){this._intersectRange(a,u);break}{this._intersectRange(l,c);const i=(0===o?t:r)-n;if(i<0){if(-1===e.child0){this._intersectRange(a,l);break}s=e.child0}else{if(!(i>0))break;if(-1===e.child1){this._intersectRange(c,u);break}s=e.child1}}}}_intersectGeometryWithBVHGeneralRay(e,r){let i=e[0],s=e[1],n=r[0],o=r[1];const{geometryMinZ:a}=this;if(!this.localMode){let t=0,l=1;const c=Math.min(.5*this.planetCenterZ,a),u=e[2],d=r[2];if(u<c&&d<c)return;if(u<c&&(t=(c-u)/(d-u)),d<c&&(l=(c-u)/(d-u)),t>l)return;const h=(1-t)*e[0]+t*r[0],p=(1-t)*e[1]+t*r[1],f=(1-t)*e[2]+t*r[2],m=(1-l)*e[0]+l*r[0],g=(1-l)*e[1]+l*r[1],y=(1-l)*e[2]+l*r[2],{planetCenterZ:_}=this,b=a-_,v=b/(f-_);i=h*v,s=p*v;const w=b/(y-_);n=m*w,o=g*w}const l=n-i,c=o-s,u=this._bspNodes;let d=1;{const{aabb2D:e}=u[0],t=(e,t,r,i)=>{if(Math.abs(t)<1e-5*Math.max(i-r,1))return!1;const s=t>0,n=s?i:r,o=e+d*t;return(s?o<n:o>n)&&(d=Math.max((n-e)/t,d),!0)},r=()=>t(i,l,e[0],e[2]),n=()=>t(s,c,e[1],e[3]);Math.abs(l)>=Math.abs(c)?r()||n():n()||r()}const h=[0,0,d];let p=0;for(;p<h.length;){const e=h[p];let r=h[p+1],n=h[p+2];if(p+=3,r>n)continue;const o=u[e],{minIndexIndex:a,maxIndexIndex:f}=o,{child0:m,child1:g,minMidIndexIndex:y,maxMidIndexIndex:_,aabb2D:b,d:v,dim:w}=o;{const e=i+r*l,t=i+n*l,s=Math.min(e,t),o=Math.max(e,t),a=b[0],c=b[2];if(o<a||c<s)continue;if(s<a){const e=(a-i)/l;l>0?r=Math.max(r,e):n=Math.min(n,e)}if(c<o){const e=(c-i)/l;l>0?n=Math.min(n,e):r=Math.max(r,e)}}{const e=s+r*c,t=s+n*c,i=Math.min(e,t),o=Math.max(e,t),a=b[1],l=b[3];if(o<a||l<i)continue;if(i<a){const e=(a-s)/c;c>0?r=Math.max(r,e):n=Math.min(n,e)}if(l<o){const e=(l-s)/c;c>0?n=Math.min(n,e):r=Math.max(r,e)}}if(-1===m&&-1===g)this._intersectRange(a,f);else{const e=0===w?i:s,o=0===w?l:c,u=e+r*o,p=e+n*o,b=Math.min(u,p),x=Math.max(u,p),S=t.clamp((v-e)/o,0,d);a<y&&b<=v&&(-1!==m?(h.push(m),h.push(o>=0?r:Math.max(r,S)),h.push(o>=0?Math.min(n,S):n)):this._intersectRange(a,y)),this._intersectRange(y,_),_<f&&v<=x&&(-1!==g?(h.push(g),h.push(o>=0?Math.max(r,S):r),h.push(o>=0?n:Math.min(n,S))):this._intersectRange(_,f))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=s.createUintArray(e,e);this._elementIndexMap=t;for(let r=0;r<e;++r)t[r]=r;const r=this.model.getAabbs2D();let a=0;const l=this._bspNodes;l.length=0;const{localMode:c}=this;let u=!1;if(!c){const{planetCenterZ:e,geometryMinZ:t}=this;u=e>=0||t<.5*e}const d=[],h=(e,t,r,i,s)=>{d.push(e),d.push(t),d.push(r),d.push(i<0?-1:(s?0:1)+2*i)},{maxBspNodeDepth:p,minBspNodeElementCount:f}=this,m=(e,s,a,d,m)=>{const g=l.length;if(g>0&&(u||a>=p||s-e<f))return;const y=i.create();!function(e,t,r,i,s){let n=1/0,o=1/0,a=-1/0,l=-1/0;for(let e=t;e<r;++e){const t=4*i[e];n=Math.min(n,s[t+0]),o=Math.min(o,s[t+1]),a=Math.max(a,s[t+2]),l=Math.max(l,s[t+3])}e[0]=n,e[1]=o,e[2]=a,e[3]=l}(y,e,s,t,r);const{d:_,dim:b}=c?function(e){const t=e[0],r=e[1],i=e[2],s=e[3];let n,o;return i-t>=s-r?(o=.5*(t+i),n=0):(o=.5*(r+s),n=1),{d:o,dim:n}}(y):function(e){const t=e[0],r=e[1],i=e[2],s=e[3];let n,o;return i-t>=s-r?(n=0,o=.5*(t+i)):(n=1,o=.5*(r+s)),{dim:n,d:o}}(y),{rangeMidStart:v,rangeMidEnd:w}=function(e,t,r,i,s,o){let a=e;{let e=t;for(;a<e;){const t=s[a];n(t,r,i,o)<0?++a:(--e,s[a]=s[e],s[e]=t)}}const l=a;let c=a,u=t;for(;c<u;){const e=s[u-1];n(e,r,i,o)>0?--u:(s[u-1]=s[c],s[c]=e,++c)}return{rangeMidStart:l,rangeMidEnd:u}}(e,s,b,_,t,r),x=a===p-1,S=!x&&v>=e+f,T=!x&&s>=w+f;if(S||T||0===g){const t=new o(e,v,w,s,b,_,y);if(S&&h(e,v,a+1,g,!0),T&&h(w,s,a+1,g,!1),l.push(t),-1!==d){const e=l[d];m?e.child0=g:e.child1=g}}};for(h(0,e,0,-1,!1);a<d.length;){const e=d[a],t=d[a+1],r=d[a+2],i=d[a+3];a+=4;const s=i>>1;m(e,t,r,s,i-(s<<1)==0)}this._generatedBVH=!0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/triangleIntersectionUtils":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64"],function(e,t,r){"use strict";function i(e,r,i){const s=t.dot(e,r)-i;return Math.abs(s)<=1e-5}function s(e,i,s){const n=r.create(),o=r.create();t.sub(o,i,e);const a=r.create();return t.sub(a,s,e),t.cross(n,o,a),t.normalize(n,n),n}function n(e,n,o,a){const l=[n,o,a],c=s(n,o,a);if(!i(e,c,t.dot(l[0],c)))return!1;for(let e=0;e<3;++e){const i=l[e],s=l[(e+1)%3],n=l[(e+2)%3],o=r.create();t.sub(o,s,i),t.normalize(o,o);const a=r.create();t.sub(a,n,i);const c=t.dot(a,o),u=r.create();t.scaleAndAdd(u,i,o,c);const d=r.create();t.sub(d,n,u),t.normalize(d,d);const h=t.dot(i,d);if(!(t.dot(d,u)-h>=-1e-4))return!1}return!0}function o(e){const i=r.create();t.sub(i,e[1],e[0]),t.normalize(i,i);const s=r.create();t.sub(s,e[2],e[0]),t.normalize(s,s);const n=r.create();return t.cross(n,i,s),t.normalize(n,n),n}function a(e,i,s){const n=r.create();t.sub(n,s,i),t.normalize(n,n);const o=r.create();t.sub(o,e,i);const a=t.dot(o,n),l=r.create();return t.scaleAndAdd(l,i,n,a),l}function l(e,i,s){const n=r.create();t.sub(n,s,i);const o=t.len(n);t.normalize(n,n);const a=r.create();t.sub(a,e,i);const l=t.dot(a,n);if(l<0)return t.dist(i,e);if(l>o)return t.dist(s,e);const c=r.create();return t.scaleAndAdd(c,i,n,l),t.dist(c,e)}function c(e,r,i){return t.dot(e,r)-i}function u(e,i,s){const n=r.create(),o=r.create();t.sub(o,i,e);const a=r.create();return t.sub(a,s,e),t.cross(n,o,a),t.normalize(n,n),{normal:n,d:t.dot(n,e)}}function d(e,i,s,o){const{normal:a,d}=u(i,s,o),h=c(e,a,d),p=r.create();return t.scaleAndAdd(p,e,a,-h),n(p,i,s,o)?h:Math.min(l(e,i,s),l(e,s,o),l(e,o,i))}function h(e){return e<128?Uint8Array:e<32768?Uint16Array:e<1<<31?Uint32Array:Array}e.binarySearchSortedArray=function(e,t){const r=e.length;if(0===r)return 0;if(t<e[0])return-1;if(t>=e[r-1])return r;let i=0,s=r-1;for(;s-i>1;){const r=Math.floor(.5*(s+i));t>=e[r]?i=r:s=r}return i},e.calculateNormalFromVertices=o,e.createUintArray=function(e,t){return new(h(e))(t)},e.distancePointLine=function(e,r,i){const s=a(e,r,i);return t.dist(s,e)},e.distancePointPlane=c,e.distancePointSegment=l,e.distancePointTriangle=d,e.elevationAlignVertexGlobal=function(e,t,r,i){const[s,n,o]=i??e,a=o-r,l=t/Math.sqrt(s*s+n*n+a*a);e[0]+=s*l,e[1]+=n*l,e[2]+=a*l},e.elevationAlignVertexLocal=function(e,t){e[2]+=t},e.generateTriangleAabbsGlobal=function(e,t,r,i,s,n,o){const a=n-o,l=t-e,c=new Float64Array(4*l);for(let t=0;t<l;++t){const n=3*(t+e),l=s*r[n+0],u=i[l+0],d=i[l+1],h=a/(i[l+2]-o),p=u*h,f=d*h,m=s*r[n+1],g=i[m+0],y=i[m+1],_=a/(i[m+2]-o),b=g*_,v=y*_,w=s*r[n+2],x=i[w+0],S=i[w+1],T=a/(i[w+2]-o),C=x*T,P=S*T,M=4*t;c[M+0]=Math.min(p,b,C),c[M+1]=Math.min(f,v,P),c[M+2]=Math.max(p,b,C),c[M+3]=Math.max(f,v,P)}return c},e.generateTriangleAabbsLocal=function(e,t,r,i,s){const n=t-e,o=new Float64Array(4*n);for(let t=0;t<n;++t){const n=3*(t+e),a=s*r[n+0],l=i[a+0],c=i[a+1],u=s*r[n+1],d=i[u+0],h=i[u+1],p=s*r[n+2],f=i[p+0],m=i[p+1],g=4*t;o[g+0]=Math.min(l,d,f),o[g+1]=Math.min(c,h,m),o[g+2]=Math.max(l,d,f),o[g+3]=Math.max(c,h,m)}return o},e.getConstructorForValueCount=h,e.getNearestPointOnLine=a,e.getRayTriangleIntersectionDistance=function(e,i,s){const a=r.create();t.sub(a,i,e);const l=o(s),c=t.dot(l,s[0]),u=t.dot(l,e)-c,h=t.dot(l,i)-c;if(u*h>0)return 1/0;const p=r.create(),f=(0-u)/(h-u);return t.scaleAndAdd(p,e,a,f),n(p,s[0],s[1],s[2])?0:d(p,s[0],s[1],s[2])},e.getTriangleNormal=s,e.getTrianglePlane=u,e.isPointInPlane=i,e.isPointInTriangle=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/ComponentUtils":function(){define(["exports","../../../../core/arrayUtils"],function(e,t){"use strict";function r(e){return 8*e.BYTES_PER_ELEMENT}e.getVisibility=function(e,t){if(null==e)return!0;const i=r(e);return!(t<e.length*i)||function(e,t,r){const i=t/r|0,s=t-i*r;return!function(e,t){return!!(e&1<<t)}(e[i],s)}(e,t,i)},e.updatePickabilityWithCount=function(e,i,s){const n=e.count;if(i>=n)return;e.pickability??=new Uint32Array(0);let o=e.pickability;const a=r(o),l=i/a|0,c=i-a*l,u=(n-1)/a|0,d=o;if(!(i<d.length*a||s)){const r=l+1,i=Math.ceil(d.length*t.reallocGrowthFactor),s=u+1;let n=Math.max(r,i);n=Math.min(n,s),e.pickability=o=new Uint32Array(n),o.set(d)}l<o.length&&(o[l]=function(e,t,r){return e&~(1<<t)|(r?1:0)<<t}(o[l],c,!s))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/Renderable":function(){define(["exports"],function(e){"use strict";e.Renderable=class{constructor(e,t,r){this.material=e,this.geometry=t,this.meta=r}destroy(){this.material.dispose(),this.geometry.dispose()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/RenderGeometry":function(){define(["exports"],function(e){"use strict";e.RenderGeometry=class{constructor(e,t,r,i){this.vao=e,this.primitiveType=t,this.parameters=r,this.indexed=i}dispose(){this.vao.dispose()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/RenderSubmitSystem":function(){define(["exports","./DepthRange"],function(e,t){"use strict";e.RenderSubmitSystem=class{constructor(e){this._objects=e}destroy(){this._objects=null}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll(r=>r.renderable.material.submit(e,t,r))}queryDepthRange(e){return this._objects.visibleObjects.length?t.computeDepthRange(e,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some(e=>e.renderable.material.hasEmissions)}hasHighlight(e){return this._objects.hasHighlight(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/DepthRange":function(){define(["exports","../../../../../core/PooledArray","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../core/libs/gl-matrix-2/math/quat","../../../../../core/libs/gl-matrix-2/factories/quatf64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/plane","../../lib/DepthRange"],function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=new t({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),d=new c.DepthRange,h=a.create(),p=a.create(),f=new t({deallocator:null}),m=new t({deallocator:null});function g(e,t,r){r.length=0;const i=t.length-3;y(h,t,i);const s=l.signedDistance(e,h);s<=0&&(r.push(h[0]),r.push(h[1]),r.push(h[2]));let n=0,a=s;for(;n<i;n+=3){y(p,t,n);const i=l.signedDistance(e,p);if(a*i<0){const e=i/(i-a);o.lerp(h,p,h,e),_(r,h)}i<=0&&_(r,p),a=i,o.copy(h,p)}if(a*s<0){y(p,t,i);const e=s/(s-a);o.lerp(h,p,h,e),_(r,h)}}function y(e,t,r){return o.set(e,t.data[r],t.data[r+1],t.data[r+2])}function _(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function b(e,t,i,n){s.conjugate(x,e.quaternion),o.sub(S,t,e.center),o.transformQuat(S,S,x);const a=e.halfSize,l=8*((S[0]<-a[0]?-1:S[0]>a[0]?1:0)+3*(S[1]<-a[1]?-1:S[1]>a[1]?1:0)+9*(S[2]<-a[2]?-1:S[2]>a[2]?1:0)+13),c=v[l];if(0===c)return c;r.fromQuat(w,e.quaternion),r.scale(w,w,e.halfSize);const u=(t,r)=>{const i=v[l+r+1];return o.set(t,((1&i)<<1)-1,(2&i)-1,((4&i)>>1)-1),o.transformMat3(t,t,w),o.add(t,e.center,t)};return i.length=0,_(i,u(T,0)),_(i,u(C,1)),_(i,u(S,2)),_(i,u(P,3)),n(i),1===c||(i.length=0,_(i,T),_(i,P),_(i,u(S,4)),_(i,u(M,5)),n(i),2===c||(i.length=0,_(i,T),_(i,M),_(i,u(S,6)),_(i,C),n(i))),c}const v=(()=>{const e=new Array(216);let t=0;const r=r=>{for(let i=0;i<r.length;i++)e[t+i]=r[i];t+=8};return r([3,0,6,2,3,1,5,4]),r([2,0,2,3,1,5,4,0]),r([3,1,0,2,3,7,5,4]),r([2,0,1,3,2,6,4,0]),r([1,0,1,3,2,0,0,0]),r([2,1,5,7,3,2,0,0]),r([3,2,0,1,3,7,6,4]),r([2,2,0,1,3,7,6,0]),r([3,3,0,1,5,7,6,2]),r([2,0,1,5,4,6,2,0]),r([1,0,1,5,4,0,0,0]),r([2,1,3,7,5,4,0,0]),r([1,0,2,6,4,0,0,0]),r([0,0,0,0,0,0,0,0]),r([1,1,3,7,5,0,0,0]),r([2,2,3,7,6,4,0,0]),r([1,2,3,7,6,0,0,0]),r([2,3,1,5,7,6,2,0]),r([3,4,0,1,5,7,6,2]),r([2,5,7,6,4,0,1,0]),r([3,5,0,1,3,7,6,4]),r([2,4,5,7,6,2,0,0]),r([1,4,5,7,6,0,0,0]),r([2,5,1,3,7,6,4,0]),r([3,6,0,2,3,7,5,4]),r([2,6,2,3,7,5,4,0]),r([3,7,6,2,3,1,5,4]),e})(),w=i.create(),x=n.create(),S=a.create(),T=a.create(),C=a.create(),P=a.create(),M=a.create();e.computeDepthRange=function(e,t){const r=new c.DepthRange,{eye:i,frustum:s,viewForward:n}=e;t.forAll(e=>{const t=null!=e.offsetObb?e.offsetObb:e.obb,a=o.dot(o.sub(S,t.center,i),n),l=t.projectedRadius(n);if(r.within(a-l)&&r.within(a+l))return;const c=function(e,t){let r=0;for(let i=0;i<4;i++){const s=e.intersectPlane(t[i]);if(s>0)return-1;0===s&&(r|=1<<i)}return r}(t,s);if(-1===c)return;if(0===c)return d.far=a+l,d.near=a-l,void r.union(d);const h=u.pushNew();h.near=a-l,h.far=a+l,h.mask=c,h.object=e});for(let e=0;e<u.length;e++){const t=u.data[e];if(r.within(t.near)&&r.within(t.far))continue;d.far=t.far,d.near=1/0;const a=b(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,i,f,e=>{let r=m;for(let i=0;i<4&&e.length>0;i++){if(!(t.mask&1<<i))continue;g(s[i],e,r);const n=e;e=r,r=n}for(let t=0;t<e.length;t+=3){o.set(h,e.data[t],e.data[t+1],e.data[t+2]);const r=o.dot(o.sub(h,h,i),n);d.near=Math.min(d.near,r)}});0===a&&(d.near=0),r.union(d)}return u.length=0,r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/SourceGeometry":function(){define(["exports","../../../support/buffer/InterleavedLayout","../../../../webgl/NoParameters"],function(e,t,r){"use strict";class i extends r.NoParameters{constructor(e,t,r,i,s){super(),this.hasVertexColors=e,this.textureCoordinateType=t,this.hasNormals=r,this.shadeNormals=i,this.applySSAO=s}}e.GeometryParameters=i,e.createVertexBufferLayout=function(e){const r=t.newLayout().vec3f("position");return e.hasNormals&&r.vec2i16("normalCompressed",{glNormalized:!0}),1===e.textureCoordinateType?r.vec2f("uv0"):2===e.textureCoordinateType&&(r.vec2f("uv0"),r.vec4u16("uvRegion",{glNormalized:!0})),e.hasVertexColors&&r.vec4u8("color",{glNormalized:!0}),r.freeze()},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/UniformComponentParameters":function(){define(["exports","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../core/shaderLibrary/output/Emissions.glsl"],function(e,t,r){"use strict";e.UniformComponentParameters=class{constructor(){this.externalColor=t.create(),this.externalColorMixMode=1,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0,this.emissiveStrength=r.emissiveStrengthDefault,this.emissiveSource=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/Material/ComponentMaterial":function(){define(["exports","../../../../../../chunks/tslib.es6","../../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../chunks/vec42","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","./ComponentTechnique","./ComponentTechniqueConfiguration","../../../core/material/MaterialBase","../../../core/shaderLibrary/ShaderOutput","../../../core/util/TwoVectorPosition","../../../materials/pbrUtils","../../../../../support/HighlightDefaults","../../../../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";class g extends u.MaterialBase{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=a.freeze(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=p.advancedMRRFactors,this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.normalTexture=null,this.occlusionTexture=null,this.emissionTexture=null,this.emissiveBaseColor=n.freeze(0,0,0),this.emissiveStrength=0,this.commonMaterialParameters=new y,this.componentParameters=new _,this.objectOpacity=1,this.textureAlphaCutoff=m.alphaCutoff,this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.hasOccludees=!1;const s=new h.TwoVectorPosition(e.position),o=i.clone(e.rotationScale);r.invert(o,o),r.transpose(o,o),this.transformNormalGlobalFromModel=o,this.transformWorldFromModelTL=s.low,this.transformWorldFromModelTH=s.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get _hasEmissiveBase(){return null!=this.emissionTexture||!s.exactEquals(this.emissiveBaseColor,n.ZEROS)}get _hasEmissiveStrength(){return 2!==this.componentParameters.emissiveOverride}get hasEmissions(){return this._hasEmissiveStrength&&(this._hasEmissiveBase||2!==this.componentParameters.emissiveSourceOverride)}get texture(){return this.baseColorTexture?.glTexture}get textureMetallicRoughness(){return this.metallicRoughnessTexture?.glTexture}get textureEmissive(){return this.emissionTexture?.glTexture}get textureOcclusion(){return this.occlusionTexture?.glTexture}get textureNormal(){return this.normalTexture?.glTexture}acquireTechnique(e,t,r,i){const s=new c.ComponentTechniqueConfiguration(e.context.spherical);s.renderOccluded=9===r.slot,s.hasVertexColors=i.hasVertexColors,s.hasNormals=i.hasNormals,s.textureCoordinateType=i.textureCoordinateType,s.hasMetallicRoughnessTexture=null!=this.metallicRoughnessTexture,s.hasOcclusionTexture=null!=this.occlusionTexture,s.hasNormalTexture=null!=this.normalTexture,s.oitPass=0===t.identifier&&null!=r.oitPass?r.oitPass:0,s.terrainDepthTest=0===t.identifier&&r.terrainDepthTest,s.cullAboveTerrain=0===t.identifier&&r.cullAboveTerrain,s.ellipsoidMode=this.ellipsoidMode,s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,s.hasColorTexture=null!=this.baseColorTexture;const n=this._computeWhichMaterialPass();s.blendingEnabled=1===n||2===n,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?function(e){return null!=e.overlay?.getTexture(1)}(r)?function(e){return null!=e.overlay?.getTexture(3)}(r)?3:2:1:0,s.hasPolygonOffset=this.polygonOffsetEnabled,s.pbrMode=3===s.integratedMeshMode?4:this.usePBR?this.hasParametersFromSource?i.shadeNormals&&this.isIntegratedMesh?0:2:1:0;const o=1===this.componentParameters.emissiveSourceOverride,a=2===this.componentParameters.emissiveSourceOverride,u=null!=this.emissionTexture;if(s.emissionSource=this.hasEmissions?this._hasEmissiveBase&&1===s.pbrMode?a?u?4:2:o?u?5:7:6:o?7:6:0,s.shadeNormals=i.shadeNormals,s.normalType=s.hasNormals?1:2,s.hasSlicePlane=null!=r.slicePlane&&this.commonMaterialParameters.hasSlicePlane,s.receiveAmbientOcclusion=s.hasOccludees=s.receiveShadows=s.screenSpaceReflections=s.cloudReflections=s.hasHighlightMixTexture=!1,1===t.identifier)s.output=4,s.vertexDiscardMode=0;else if(3===t.identifier)s.output=7,s.vertexDiscardMode=0;else if(2===t.identifier)s.output=8,s.vertexDiscardMode=0,s.hasHighlightMixTexture=null!=r.highlightMixTexture;else{switch(s.vertexDiscardMode=2===n?t.transparent?2:1:0,s.hasBloom=d.isColorEmission(t.output),s.output=t.output,t.output){case 0:case 1:s.receiveAmbientOcclusion=i.applySSAO&&null!=r.ssao?.getTexture(),s.hasOccludees=r.hasOccludees,s.receiveShadows=r.shadowMap.ready,s.screenSpaceReflections=null!=r.ssr.lastFrameColor,s.cloudReflections=null!=r.clouds.data?.cubeMap?.colorTexture;break;case 9:s.olidColor=!0}s.snowCover=r.snowCover}const h=e.get(l.ComponentTechnique,s);return this._setClean(),h}submit(e,t,r){if(this.objectOpacity<=0)return;const{componentData:i,renderable:s}=r,{geometry:n}=s,o=s.meta.cameraDepthSquared;i.updateHighlights(t.highlights);const{geometryRanges:a,highlightRangesMap:l,shadowmapRanges:c}=i;switch(this._computeWhichMaterialPass()){case 0:e.opaque.submitDraw(this,n,a,o);break;case 1:e.transparent.submitDraw(this,n,a,o);break;case 2:e.opaque.submitDraw(this,n,a,o),e.transparent.submitDraw(this,n,a,o);break;case 3:e.integratedMesh.submitDraw(this,n,a,o),function(e){return null!=e.overlay?.getTexture(e.overlay?.allSourcesOccluders?1:4)}(t)&&e.occludedGround.submitDraw(this,n,a,o),function(e){return null!=e.overlay?.getTexture(2)}(t)&&e.highlightIntegratedMesh.submitDraw(this,n,a,o);break;case 4:e.transparentIntegratedMesh.submitDraw(this,n,a,o)}if(2!==this.componentParameters.castShadows){if(null!=l)for(const t of l)t[0]===f.defaultHighlightName&&e.highlightShadowMap.submitDraw(this,n,t[1],o,t[0]);null!=c&&e.defaultShadowMap.submitDraw(this,n,c,o),e.shadowMap.submitDraw(this,n,a,o)}if(null!=l)for(const t of l)e.highlight.submitDraw(this,n,t[1],o,t[0]);t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,n,a,o)}_computeWhichMaterialPass(){if(this.isIntegratedMesh&&this.objectOpacity>=1)return 3;if(this.isIntegratedMesh&&this.objectOpacity<1)return 4;if(this.objectOpacity<1)return 1;if(0===this.componentParameters.opaqueOverride)return 0;if(this.baseColor[3]<1||0===this.alphaDiscardMode||3===this.alphaDiscardMode)return 1;switch(this.componentParameters.transparent){case 2:return 0;case 0:return 1;case 1:return 2}}}t.__decorate([u.parameter({vectorOps:o.vec4})],g.prototype,"baseColor",void 0),t.__decorate([u.parameter()],g.prototype,"usePBR",void 0),t.__decorate([u.parameter()],g.prototype,"hasParametersFromSource",void 0),t.__decorate([u.parameter({vectorOps:s.vec3})],g.prototype,"mrrFactors",void 0),t.__decorate([u.parameter({dispose:!0})],g.prototype,"baseColorTexture",void 0),t.__decorate([u.parameter({dispose:!0})],g.prototype,"metallicRoughnessTexture",void 0),t.__decorate([u.parameter({dispose:!0})],g.prototype,"normalTexture",void 0),t.__decorate([u.parameter({dispose:!0})],g.prototype,"occlusionTexture",void 0),t.__decorate([u.parameter({dispose:!0})],g.prototype,"emissionTexture",void 0),t.__decorate([u.parameter({vectorOps:s.vec3})],g.prototype,"emissiveBaseColor",void 0),t.__decorate([u.parameter()],g.prototype,"emissiveStrength",void 0),t.__decorate([u.parameterBlock()],g.prototype,"commonMaterialParameters",void 0),t.__decorate([u.parameterBlock()],g.prototype,"componentParameters",void 0),t.__decorate([u.parameter()],g.prototype,"objectOpacity",void 0),t.__decorate([u.parameter()],g.prototype,"textureAlphaCutoff",void 0),t.__decorate([u.parameter()],g.prototype,"alphaDiscardMode",void 0),t.__decorate([u.parameter()],g.prototype,"isIntegratedMesh",void 0),t.__decorate([u.parameter()],g.prototype,"polygonOffsetEnabled",void 0),t.__decorate([u.parameter()],g.prototype,"ellipsoidMode",void 0),t.__decorate([u.parameter()],g.prototype,"hasOccludees",void 0);class y extends u.MaterialParameterBlock{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.hasSlicePlane=!0}}t.__decorate([u.parameter()],y.prototype,"doubleSided",void 0),t.__decorate([u.parameter()],y.prototype,"cullFace",void 0),t.__decorate([u.parameter()],y.prototype,"hasSlicePlane",void 0);class _ extends u.MaterialParameterBlock{constructor(){super(...arguments),this.externalColor=a.fromValues(1,1,1,1),this.externalColorMixMode=1,this.emissiveStrength=0,this.emissiveSource=0,this.castShadows=0}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return 3===this.externalColorMixMode&&1===this.externalColor[3]?0:2}get emissiveOverride(){return this.emissiveStrength>0?0:2}get emissiveSourceOverride(){return 1===this.emissiveSource?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}}t.__decorate([u.parameter({vectorOps:o.vec4})],_.prototype,"externalColor",void 0),t.__decorate([u.parameter()],_.prototype,"externalColorMixMode",void 0),t.__decorate([u.parameter()],_.prototype,"emissiveStrength",void 0),t.__decorate([u.parameter()],_.prototype,"emissiveSource",void 0),t.__decorate([u.parameter()],_.prototype,"castShadows",void 0);class b extends u.MaterialParameterBlock{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.emissiveOverride=2,this.emissiveSourceOverride=2,this.castShadows=2}get type(){return 1}}t.__decorate([u.parameter()],b.prototype,"texture",void 0),t.__decorate([u.parameter()],b.prototype,"transparent",void 0),t.__decorate([u.parameter()],b.prototype,"opaqueOverride",void 0),t.__decorate([u.parameter()],b.prototype,"emissiveOverride",void 0),t.__decorate([u.parameter()],b.prototype,"emissiveSourceOverride",void 0),t.__decorate([u.parameter()],b.prototype,"castShadows",void 0),e.CommonMaterialParameters=y,e.ComponentMaterial=g,e.ComponentParametersUniform=_,e.ComponentParametersVarying=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/Material/ComponentTechnique":function(){define(["require","exports","../../../../support/buffer/glUtil","../../../../support/buffer/InterleavedLayout","../SourceGeometry","../../../../../../chunks/ComponentShader.glsl","../../../core/shaderLibrary/ShaderOutput","../../../core/shaderTechnique/ReloadableShaderModule","../../../core/shaderTechnique/ShaderTechnique","../../../lib/OrderIndependentTransparency","../../../lib/StencilUtils","../../../../../webgl/renderState","../../../../../webgl/VertexAttributeLocations"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";class p extends l.ShaderTechnique{constructor(t,i){super(t,i,new a.ReloadableShaderModule(n.ComponentShader,()=>new Promise((t,r)=>e(["./shader/ComponentShader.glsl"],t,r))),h.fromLayouts([r.glLayout(s.createVertexBufferLayout(i)),f]))}initializePipeline(e){const{integratedMeshMode:t,output:r,blendingEnabled:i,cullFace:s,hasOccludees:n,hasPolygonOffset:a,oitPass:h,renderOccluded:p}=e,f=0!==t,m=0===h,g=2===h;return d.makePipelineState({blending:p?d.premultipliedAlpha:o.isColorOrColorEmission(r)&&i?c.blending(h):null,culling:d.cullingParams(s),depthTest:p?null:{func:c.oitDepthTest(h)},depthWrite:p||!m&&!g?null:d.defaultDepthWrite,drawBuffers:l.depthOnlyOutputBuffersOr(r,c.getDrawBuffers(h,r)),colorWrite:d.defaultColorWrite,stencilWrite:!p&&f||n?u.stencilWriteMaskOn:null,stencilTest:f?u.replaceBitWhenDepthTestPasses(1):n?u.stencilBaseAllZerosParams:null,polygonOffset:m||g?a?{factor:2,units:2}:null:c.OITPolygonOffset})}}const f=r.glLayout(i.newLayout().u16("componentIndex"));t.ComponentTechnique=p,t.indexGlLayout=f,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/ComponentShader.glsl":function(){define(["exports","../geometry/support/Ellipsoid","../views/3d/webgl-engine/collections/Component/Material/shader/ComponentData.glsl","../views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepthToWriteShadowMap.glsl","../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexNormal.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexPosition.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlightOverlay","../views/3d/webgl-engine/core/shaderLibrary/shading/ComputeFragmentNormals.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ComputeMaterialColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ComputeNormalTexture.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateSceneLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ReadBaseColorTexture.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/TerrainDepthTest.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/Overlay.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/DiscardOrAdjustAlpha.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/effects/weather/SnowCover.glsl","../views/3d/webgl-engine/shaders/OutputColorHighlightOID.glsl","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O){"use strict";function I(e){const I=new R.ShaderBuilder,{vertex:F,fragment:A}=I;I.include(c.VertexPosition,e),I.include(l.VertexNormal,e),I.include(a.VertexColor,e),I.include(o.TextureCoordinateAttribute,e),I.include(r.ComponentData,e),I.include(S.DiscardOrAdjustAlphaDraw,e),A.include(n.SlicePass,e),I.include(b.ReadBaseColorTexture,e),I.include(w.terrainDepthTest,e);const{output:D,pbrMode:E,hasNormalTexture:L,snowCover:V,receiveShadows:U,shadeNormals:B,spherical:N,ellipsoidMode:k,overlayEnabled:z,componentData:j,vertexDiscardMode:G,hasBloom:q,renderOccluded:H}=e,W=1===E||2===E;W&&(I.include(_.PhysicallyBasedRenderingParameters,e),L&&I.include(m.ComputeNormalTexture,e));const $=4===D||5===D||6===D,Q=$&&1===j;if(z){I.include(g.EvaluateSceneLighting,e),I.include(x.OverlayIM,e);const r=1===k,i=1===k?t.earth.radius:r?t.mars.radius:t.moon.radius;F.code.add(`\n      ${T.If(N,`const float invRadius = ${T.glsl.float(1/i)};`)}\n      vec2 projectOverlay(vec3 pos) { return pos.xy ${T.If(N,"/ (1.0 + invRadius * pos.z);")}; }`)}const Z=z&&s.isColorOrColorEmission(D)&&4===E;Z&&(I.varyings.add("tbnTangent","vec3"),I.varyings.add("tbnBiTangent","vec3"),I.varyings.add("groundNormal","vec3"));const Y=0===G,X=2===G;if(I.include(v.ReadShadowMapPass,e),I.include(i.ForwardLinearDepthToWriteShadowMap,e),F.main.add(T.glsl`
    bool castShadows;
    vec4 externalColor = forwardExternalColor(castShadows);
    ${T.If(Q,"if(!castShadows) { gl_Position = vec4(vec3(1e38), 1.0); return; }")}

    ${T.If(!Y,`{ if (externalColor.a ${X?">":"<="} ${T.glsl.float(1-1/255)}) { gl_Position = vec4(vec3(1e38), 1.0); return; } }`)}

    ${T.If(9===D,"externalColor.a = 1.0;")}

    forwardPosition(readElevationOffset());
    forwardViewPosDepth(vPosition_view);
    forwardNormal();
    forwardTextureCoordinates();
    forwardVertexColor();
    forwardLinearDepthToReadShadowMap();
    forwardLinearDepthToWriteShadowMap();
    forwardEmissiveStrength();
    forwardObjectAndLayerIdColor();
    ${T.If(Z,N?T.glsl`
            groundNormal = normalize(positionWorld());
            tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
            tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:T.glsl`
            groundNormal = vec3(0.0, 0.0, 1.0);
            tbnTangent = vec3(1.0, 0.0, 0.0);
            tbnBiTangent = vec3(0.0, 1.0, 0.0);`)}
    ${T.If(z,"setOverlayVTC(projectOverlay(position));")}

    if (externalColor.a < ${T.glsl.float(O.alphaCutoff)}) {
      // Discard this vertex
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
  `),s.isColorOrColorEmission(D))return I.include(f.ComputeMaterialColor,e),I.include(p.computeFragmentNormals,e),I.include(g.EvaluateSceneLighting,e),I.include(M.outputColorHighlightOID,e),A.include(P.SnowCover,e),A.code.add(T.glsl`
      float evaluateShadow() {
        return ${U?"readShadowMap(vPositionWorldCameraRelative, linearDepth)":"0.0"};
      }`),A.main.add(T.glsl`
      discardBySlice(vPositionWorldCameraRelative);
      discardByTerrainDepth();

      vec4 textureColor = readBaseColorTexture();
      discardOrAdjustAlpha(textureColor);

      /* When rendering the occluded overlay, we still need to read the base color texture
       * because we need to use the same discard logic. However after that to render only the
       * draped overlay, we simply set the base texture color to zero. */
      ${T.If(H,T.glsl`textureColor = vec4(0);`)}

      ${T.If(z,T.glsl`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`)}

      /* Early discard to only emit when we have overlay */
      ${T.If(z&&H,T.glsl`if (overlayColor.a < ${T.glsl.float(O.alphaCutoff)}) { discard; }`)}

      vec4 externalColor;
      int externalColorMixMode;
      readExternalColor(externalColor, externalColorMixMode);

      vec4 materialColor = computeMaterialColor(textureColor, externalColor, externalColorMixMode);
    `),W?(y.addMainLightIntensity(A),N&&g.addLightingGlobalFactor(A),A.main.add(T.glsl`
        applyPBRFactors();
        ${T.If(1===E,T.glsl`if (externalColorMixMode == 3) {
              mrr = vec3(0.0, 0.6, 0.2);
            }`)}
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
        ${T.If(L,"mat3 tangentSpace = computeTangentSpace(fragmentFaceNormal, vPositionWorldCameraRelative, vuv0);")}
        vec3 shadingNormal = ${L?"computeTextureNormal(tangentSpace, vuv0)":"fragmentShadingNormal"};
        vec3 groundNormal = ${N?T.glsl`normalize(positionWorld())`:T.glsl`vec3(0.0, 0.0, 1.0)`};

        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();
        ${T.If(V,T.glsl`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
                 materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                 ssao = mix(ssao, 0.5 * ssao, snow);
                 shadingNormal = mix(shadingNormal, fragmentFaceNormal, snow);`)}
        ${T.If(z,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 emission = ${q?"vec4(0.0)":"getEmissions(materialColor.rgb)"};
        ${T.If(N,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        ${N?T.glsl`float shadow = max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow());`:"float shadow = evaluateShadow();"}
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, shadow, ssao, additionalLight, viewDir, groundNormal, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(y.addMainLightDirection(A),N&&g.addLightingGlobalFactor(A),Z&&A.uniforms.add(new C.Texture2DBindUniform("ovNormalTex",e=>e.overlay?.getTexture(3))),A.main.add(T.glsl`
        ${T.If(N,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        float shadow = ${U?N?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow())":"evaluateShadow()":N?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        ${T.If(U&&!B,T.glsl`
            float dotFL = dot(fragmentFaceNormal, mainLightDirection);
            if( dotFL <= 0.0) shadow = 1.0;
        `)}
        ${T.If(V,T.glsl`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
               materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)}

        // At global scale we create some additional ambient light based on the main light to simulate global illumination
        float ssao = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());

        ${T.If(z,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec4 shadedColor = vec4(evaluateSceneLighting(fragmentShadingNormal, materialColor.rgb, shadow, ssao, additionalLight), materialColor.a);
        ${T.If(Z,T.glsl`vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
                 float waterNormalLength = length(overlayWaterMask);
                 if (waterNormalLength > 0.95) {
                   mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                   vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                   vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                   // un-gamma the ground color to mix in linear space
                   shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
                 }`)}
      `)),A.main.add(`outputColorHighlightOID(shadedColor, vPositionWorldCameraRelative, materialColor.rgb ${T.If(V,", snow")});`),I;const J=3===D,K=9===D,ee=8===D,te=$||7===D;return te&&I.include(u.OutputDepth,e),J&&I.include(p.computeFragmentNormals,e),z&&I.include(h.OutputHighlightOverlay,e),I.include(d.OutputHighlight,e),A.main.add(T.glsl`
    discardBySlice(vPositionWorldCameraRelative);

    vec4 textureColor = readBaseColorTexture();
    discardOrAdjustAlpha(textureColor);

    ${T.If(te,"outputDepth(linearDepth);")}
    ${T.If(J,T.glsl`fragColor = vec4(vec3(0.5) + 0.5 * fragmentFaceNormalView, 1.0);`)}
    ${T.If(K,z?"fragColor = getOverlayColorTexel();":"outputObjectAndLayerIdColor();")}
    ${T.If(ee,T.If(z,T.glsl`calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,T.glsl`calculateOcclusionAndOutputHighlight();`))}`),I}const F=Object.freeze(Object.defineProperty({__proto__:null,build:I},Symbol.toStringTag,{value:"Module"}));e.ComponentShader=F,e.build=I})},"esri/views/3d/webgl-engine/collections/Component/Material/shader/ComponentData.glsl":function(){define(["exports","../../../../../../../core/compilerUtils","../../../../../../../core/floatRGBA","./DecodeSymbolColor.glsl","../../../../core/shaderLibrary/util/RgbaFloatEncoding.glsl","../../../../core/shaderModules/Float4DrawUniform","../../../../core/shaderModules/FloatDrawUniform","../../../../core/shaderModules/glsl","../../../../core/shaderModules/IntegerDrawUniform","../../../../core/shaderModules/Texture2DDrawUniform","../../../../effects/geometry/olidUtils"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=429496.7296,h=1e6;function p(){return 3+(u.olidEnabled()?1:0)}e.ComponentData=function(e,r){switch(r.componentData){case 1:return function(e,t){const{vertex:r,fragment:n}=e;r.include(s.RgbaFloatEncoding),r.uniforms.add(new c.Texture2DDrawUniform("componentColorTex",e=>e.componentParameters.texture.texture)),e.attributes.add("componentIndex","float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4");const{output:o}=t,l=9===o;l&&e.varyings.add("vObjectAndLayerIdColor","vec4");const u=1===o;u&&(e.varyings.add("emissiveStrength","float"),e.varyings.add("emissiveSource","int",{flat:!0})),e.include(i.DecodeSymbolColor),r.constants.add("stride","float",p()),r.code.add(a.glsl`vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
float index = componentIndex * stride + typeOffset;
float texSize = float(textureSize(componentColorTex, 0).x);
float coordX = mod(index, texSize);
float coordY = floor(index / texSize);
return vec2(coordX, coordY) + 0.5;
}`),r.code.add(a.glsl`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);
    return texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
   }

  float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);
    vec4 encodedElevation = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
    return uninterpolatedRGBAToFloat(encodedElevation) * ${a.glsl.float(d)};
  }

  void forwardEmissiveStrength() {
    ${a.If(u,a.glsl`vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);
           vec4 encodedEmissive = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
           emissiveStrength = uninterpolatedRGBToFloat(encodedEmissive.rgb) * ${a.glsl.float(h)};
           emissiveSource = encodedEmissive.a == 0.0 ? 0 : 1;`)}
  }

  void forwardObjectAndLayerIdColor() {
    ${a.If(l,a.glsl`vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 3.0);
           vObjectAndLayerIdColor = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);`)}
  }

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),n.code.add(a.glsl`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${l?a.glsl`fragColor = vObjectAndLayerIdColor;`:""}
  }
`)}(e,r);case 0:return function(e,t){const{vertex:r,fragment:i}=e;e.varyings.add("vExternalColor","vec4"),i.uniforms.add(new o.FloatDrawUniform("emissiveStrength",e=>e.componentParameters.emissiveStrength)),r.uniforms.add(new n.Float4DrawUniform("externalColor",e=>e.componentParameters.externalColor)).code.add(a.glsl`float readElevationOffset() {
return 0.0;
}
void forwardObjectAndLayerIdColor() {}
void forwardEmissiveStrength() {}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`);const s=9===t.output;i.uniforms.add(new l.IntegerDrawUniform("externalColorMixMode",e=>e.componentParameters.externalColorMixMode)).code.add(a.glsl`
    void readExternalColor(out vec4 color, out int colorMixMode) {
      color = vExternalColor;
      colorMixMode = externalColorMixMode;
    }

    void outputObjectAndLayerIdColor() {
      ${a.If(s,"fragColor = vec4(0, 0, 0, 0);")}
    }
  `)}(e,r);case 2:return;default:t.neverReached(r.componentData)}},e.encodeElevationOffset=function(e,t){r.packFloatRGBA(e/d*.5+.5,t)},e.encodeEmissiveStrength=function(e,t){r.packFloatRGB(e/h*.5+.5,t)},e.getComponentFieldCount=p,e.maxElevationOffset=d,e.maxPackedRGBEmission=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/Material/shader/DecodeSymbolColor.glsl":function(){define(["exports","../../../../core/shaderModules/glsl"],function(e,t){"use strict";e.DecodeSymbolColor=function(e){e.vertex.code.add(t.glsl`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${t.glsl.int(1)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${t.glsl.int(3)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${t.glsl.int(4)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${t.glsl.int(1)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderModules/IntegerDrawUniform":function(){define(["exports","../../../../webgl/Uniform"],function(e,t){"use strict";class r extends t.Uniform{constructor(e,t){super(e,"int",2,(r,i,s)=>r.setUniform1i(e,t(i,s)))}}e.IntegerDrawUniform=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ComputeFragmentNormals.glsl":function(){define(["exports","../../../../../../core/compilerUtils","../attributes/VertexNormal.glsl","../attributes/VertexPosition.glsl","../../shaderModules/glsl"],function(e,t,r,i,s){"use strict";e.computeFragmentNormals=function(e,n){const o=e.fragment;switch(n.doubleSidedMode){case 0:o.code.add(s.glsl`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case 1:e.include(i.VertexPosition,n),o.code.add(s.glsl`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case 2:o.code.add(s.glsl`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:t.neverReached(n.doubleSidedMode);case 3:}switch(n.normalType){case 0:case 1:e.include(r.VertexNormal,n),o.main.add(s.glsl`vec3 fragmentFaceNormal = _adjustDoublesided(normalize(vNormalWorld));
vec3 fragmentFaceNormalView = gl_FrontFacing ? normalize(vNormalView) : -normalize(vNormalView);`);break;case 2:e.include(i.VertexPosition,n),o.main.add(s.glsl`vec3 fragmentFaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
vec3 fragmentFaceNormalView = normalize(cross(dFdx(vPosition_view), dFdy(vPosition_view)));`)}n.shadeNormals?o.main.add(s.glsl`vec3 fragmentShadingNormal = fragmentFaceNormal;`):n.spherical?(e.include(i.VertexPosition,n),o.main.add(s.glsl`vec3 fragmentShadingNormal = normalize(positionWorld());`)):o.main.add(s.glsl`vec3 fragmentShadingNormal = vec3(0.0, 0.0, 1.0);`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ComputeMaterialColor.glsl":function(){define(["exports","../attributes/VertexColor.glsl","../util/MixExternalColor.glsl","../../shaderModules/Float4DrawUniform","../../shaderModules/FloatDrawUniform","../../shaderModules/glsl"],function(e,t,r,i,s,n){"use strict";e.ComputeMaterialColor=function(e,o){e.include(t.VertexColor,o),e.fragment.include(r.MixExternalColor);const a=e.fragment;a.uniforms.add(new i.Float4DrawUniform("baseColor",e=>e.baseColor)),a.uniforms.add(new s.FloatDrawUniform("objectOpacity",e=>e.objectOpacity)),o.hasVertexColors?a.code.add(n.glsl`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):a.code.add(n.glsl`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),a.code.add(n.glsl`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ReadBaseColorTexture.glsl":function(){define(["exports","../ShaderOutput","../attributes/VertexTextureCoordinates.glsl","../../shaderModules/glsl","../../shaderModules/Texture2DDrawUniform"],function(e,t,r,i,s){"use strict";e.ReadBaseColorTexture=function(e,n){const o=n.hasColorTexture&&(t.isColorOrColorEmission(n.output)||1!==n.alphaDiscardMode);o&&(e.include(r.VertexTextureCoordinates,n),e.fragment.uniforms.add(new s.Texture2DDrawUniform("baseColorTexture",e=>e.texture))),e.fragment.code.add(i.glsl`
    vec4 readBaseColorTexture() {
      return ${o?"textureLookup(baseColorTexture, vuv0)":"vec4(1.0)"};
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/Material/ComponentTechniqueConfiguration":function(){define(["exports","../../../../../../chunks/tslib.es6","../../../core/shaderLibrary/ShaderOutput","../../../core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends i.ShaderTechniqueConfiguration{constructor(e){super(),this.spherical=e,this.output=0,this.textureCoordinateType=0,this.componentData=0,this.cullFace=2,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.oitPass=0,this.ellipsoidMode=1,this.pbrMode=0,this.normalType=0,this.emissionSource=0,this.hasVertexColors=!1,this.hasNormals=!1,this.shadeNormals=!0,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.hasHighlightMixTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.screenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasNormalTextureTransform=!1,this.cloudReflections=!0,this.snowCover=!1,this.olidColor=!1,this.hasBloom=!1,this.renderOccluded=!1,this.discardInvisibleFragments=!1,this.occlusionPass=!1,this.bindType=2,this.useCustomDTRExponentForWater=!1,this.hasVertexTangents=!1,this.highStepCount=!1,this.instanced=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.useFillLights=!0,this.draped=!1}get overlayEnabled(){return(2===this.integratedMeshMode||3===this.integratedMeshMode)&&r.isColorEmissionHighlightOrOID(this.output)}}t.__decorate([i.parameter({count:10})],s.prototype,"output",void 0),t.__decorate([i.parameter({count:3})],s.prototype,"textureCoordinateType",void 0),t.__decorate([i.parameter({count:2})],s.prototype,"componentData",void 0),t.__decorate([i.parameter({count:3})],s.prototype,"cullFace",void 0),t.__decorate([i.parameter({count:3})],s.prototype,"vertexDiscardMode",void 0),t.__decorate([i.parameter({count:3})],s.prototype,"doubleSidedMode",void 0),t.__decorate([i.parameter({count:4})],s.prototype,"alphaDiscardMode",void 0),t.__decorate([i.parameter({count:4})],s.prototype,"integratedMeshMode",void 0),t.__decorate([i.parameter({count:3})],s.prototype,"oitPass",void 0),t.__decorate([i.parameter({count:4})],s.prototype,"ellipsoidMode",void 0),t.__decorate([i.parameter({count:7})],s.prototype,"pbrMode",void 0),t.__decorate([i.parameter({count:3})],s.prototype,"normalType",void 0),t.__decorate([i.parameter({count:8})],s.prototype,"emissionSource",void 0),t.__decorate([i.parameter()],s.prototype,"hasVertexColors",void 0),t.__decorate([i.parameter()],s.prototype,"hasNormals",void 0),t.__decorate([i.parameter()],s.prototype,"shadeNormals",void 0),t.__decorate([i.parameter()],s.prototype,"hasSlicePlane",void 0),t.__decorate([i.parameter()],s.prototype,"hasColorTexture",void 0),t.__decorate([i.parameter()],s.prototype,"hasHighlightMixTexture",void 0),t.__decorate([i.parameter()],s.prototype,"receiveAmbientOcclusion",void 0),t.__decorate([i.parameter()],s.prototype,"receiveShadows",void 0),t.__decorate([i.parameter()],s.prototype,"blendingEnabled",void 0),t.__decorate([i.parameter()],s.prototype,"screenSpaceReflections",void 0),t.__decorate([i.parameter()],s.prototype,"hasPolygonOffset",void 0),t.__decorate([i.parameter()],s.prototype,"hasMetallicRoughnessTexture",void 0),t.__decorate([i.parameter()],s.prototype,"hasOcclusionTexture",void 0),t.__decorate([i.parameter()],s.prototype,"hasNormalTexture",void 0),t.__decorate([i.parameter()],s.prototype,"hasOccludees",void 0),t.__decorate([i.parameter()],s.prototype,"terrainDepthTest",void 0),t.__decorate([i.parameter()],s.prototype,"cullAboveTerrain",void 0),t.__decorate([i.parameter()],s.prototype,"hasNormalTextureTransform",void 0),t.__decorate([i.parameter()],s.prototype,"cloudReflections",void 0),t.__decorate([i.parameter()],s.prototype,"snowCover",void 0),t.__decorate([i.parameter()],s.prototype,"olidColor",void 0),t.__decorate([i.parameter()],s.prototype,"hasBloom",void 0),t.__decorate([i.parameter()],s.prototype,"renderOccluded",void 0),e.ComponentTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/material/MaterialBase":function(){define(["exports","../../../../webgl/NoParameters"],function(e,t){"use strict";class r extends t.NoParameters{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}e.MaterialBase=r,e.MaterialParameterBlock=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}},e.parameter=function(e={}){return(t,r)=>{const i=t._parameterCount??0;if(t._parameterCount=i+1,e.vectorOps){const s=e.vectorOps;Object.defineProperty(t,r,{get(){return this[i]},set(e){const t=this[i];if(null==t)this[i]=[...e];else{if(s.equals(t,e))return;s.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,r,{get(){return this[i]},set(t){this[i]!==t&&(e.dispose&&this[i]&&this[i].dispose(),this[i]=t,this._setDirty())}})}},e.parameterBlock=function(){return(e,t)=>{const r=e._parameterCount??0;e._parameterCount=r+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(r),Object.defineProperty(e,t,{get(){return this[r]},set(e){this[r]!==e&&(this[r]=e,this._setDirty())}})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/util/TwoVectorPosition":function(){define(["exports","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f32","../../../../../core/libs/gl-matrix-2/factories/vec3f64"],function(e,t,r,i){"use strict";const s=r.create();e.TwoVectorPosition=class{constructor(e){this._low=i.create(),this._high=i.create(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){t.copy(this._low,t.copy(s,e));const r=t.sub(s,e,this._low);t.copy(this._high,r)}get(e){return t.add(e,this._low,this._high)}getLowScaled(e){return t.scale(e,this._low,1)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextureBackedBuffer/BufferManager":function(){define(["exports","./ManagedTextureBackedBuffer"],function(e,t){"use strict";e.BufferManager=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>0!==e.activeCount||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const t of this._buffers)if(t.availableCount>=e)return t;if(e>t.maxIndexCount)return null;const r=new t.ManagedTextureBackedBuffer(this._rctx,this._fieldCount);return this._buffers.push(r),r}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextureBackedBuffer/ManagedTextureBackedBuffer":function(){define(["exports","./SimpleIndexManager","./TextureBackedBuffer"],function(e,t,r){"use strict";e.ManagedTextureBackedBuffer=class{constructor(e,i=1){this.textureBuffer=new r.TextureBackedBuffer(e,i),this._indexManager=new t.SimpleIndexManager(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},e.maxIndexCount=65536,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextureBackedBuffer/SimpleIndexManager":function(){define(["exports"],function(e){"use strict";e.SimpleIndexManager=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextureBackedBuffer/TextureBackedBuffer":function(){define(["exports","../../../../../geometry/support/buffer/BufferView","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],function(e,t,r,i){"use strict";e.TextureBackedBuffer=class{constructor(e,s=1){this._rctx=e,this._fieldCount=s,this.textureWidth=4096,this._dirty=!0;const n=new i.TextureDescriptor(this.textureWidth,1);n.samplingMode=9728,n.wrapMode=33071,this._texture=new r.Texture(this._rctx,n),this._data=new t.BufferViewVec4u8(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,r,i,s,n){const o=e*this._fieldCount+t;this._dirty=!0,this._data.set(o,0,r),this._data.set(o,1,i),this._data.set(o,2,s),this._data.set(o,3,n)}setDataElement(e,t,r,i){const s=e*this._fieldCount+t;this._dirty=!0,this._data.set(s,r,i)}getDataElement(e,t,r){const i=e*this._fieldCount+t;return this._dirty=!0,this._data.get(i,r)}resizeToFit(e){const r=(e+1)*this._fieldCount;if(r>this._data.count){const e=Math.ceil(r/this.textureWidth)*this.textureWidth,i=new t.BufferViewVec4u8(new ArrayBuffer(4*e));i.typedBuffer.set(this._data.typedBuffer),this._data=i}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderTechnique/ShaderTechniqueConstructionContext":function(){define(["exports"],function(e){"use strict";e.ShaderTechniqueConstructionContext=class{constructor(e,t,r,i,s){this.rctx=e,this.viewingMode=t,this.stippleTextures=r,this.waterTextures=i,this.markerTextures=s}get spherical(){return 1===this.viewingMode}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderTechnique/ShaderTechniqueRepository":function(){define(["exports","../../../../../core/Error","../../../../../core/has","../../../../../core/NestedMap","./ShaderTechniqueConfiguration"],function(e,t,r,i,s){"use strict";const n=new s.ShaderTechniqueConfiguration;e.NoConfiguration=n,e.ShaderTechniqueRepository=class{constructor(e){this._context=e,this._debug=!1,this._precompiling=this._debug?0:1,this._cache=new i.NestedMap}get context(){return this._context}get precompiling(){return this._precompiling}set precompiling(e){this._precompiling=e,0===e&&this.context.rctx.gl.flush()}get viewingMode(){return this.context.viewingMode}destroy(){this._cache.forAll(e=>e.destroy()),this._cache.clear(),this._context=null}precompile(e,t=n){++this.precompiling,this.get(e,t),--this.precompiling}get(e,r=n){const i=r.key.code;let s=this._cache.get(e,i);if(null==s){if(0===this._precompiling){let i=`Uncached shader compile in ${(new Error).stack}\n  for configuration\n${r.decode()}`;const s=this._cache.getInner(e);throw s?.size&&(i+="\n\n  cached configurations:\n",i+=Array.from(s.values()).map(e=>r.decode(e.key)).sort().join("\n\n")),console.log(i),new t("shader:uncached-compile",i)}s=new e(this.context,r),this._cache.set(e,i,s)}return s}async reloadAll(){const e=new Array;this._cache.forEach(t=>e.push(async function(e){let t=!0;e.forEach(async e=>{await e.reload(t),t=!1})}(t))),await Promise.all(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/bloom/BloomRenderNode":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../webgl","../TransparentEnvironment","../../../../../chunks/BloomBlur.glsl","./BloomBlurTechnique","./BloomBlurTechniqueConfiguration","../../../../../chunks/BloomComposition.glsl","./BloomCompositionTechnique","./BloomPresets.glsl","../../../../webgl/enums"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y){"use strict";e.BloomRenderNode=class extends u.TransparentEnvironment{constructor(e){super(e),this.consumes={required:[c.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,"emissive"]},this._blurHorizontalConfiguration=new p.BloomBlurTechniqueConfiguration,this._blurVerticalConfiguration=new p.BloomBlurTechniqueConfiguration,this._compositionParameters=new f.BloomCompositionPassParameters,this._blurParameters=new d.BloomBlurPassParameters,this._blurScale=3.06,this._bloomResults=new Array}initialize(){this.addHandles([i.watch(()=>this._updateFogParameters(),()=>{},i.syncAndInitial),i.watch(()=>this.view.qualitySettings.bloom,e=>{e?(this._enable(),this.precompile()):this._disable()},i.syncAndInitial)])}_updateFogParameters(){const e=this.view.environment.weather;if("sunny"===e.type||"cloudy"===e.type)this._blurParameters.blurRadius=g.blurRadiusPresets[e.type];else{const t="foggy"===e.type?e.fogStrength:e.precipitation;this._blurParameters.blurRadius=r.lerp(g.blurRadiusPresets.cloudy,g.blurRadiusPresets[e.type],t)}this._compositionParameters.lodFactors=g.lodFactorsPresets[e.type].far,this._compositionParameters.lodFactorsFront=g.lodFactorsPresets[e.type].near,this.requestRender(1)}precompile(){this.techniques.precompile(h.BloomBlurTechnique,this._blurHorizontalConfiguration),this._blurVerticalConfiguration.bloomStage=1,this.techniques.precompile(h.BloomBlurTechnique,this._blurVerticalConfiguration),this.techniques.precompile(m.BloomCompositionTechnique)}render(e){const t=e.find(({name:e})=>e===c.InternalRenderCategory.TRANSPARENT_ENVIRONMENT),r=t.getAttachment(y.ColorAttachment1)?.attachment;if(!r)return t;const i=this.techniques.get(h.BloomBlurTechnique,this._blurHorizontalConfiguration),s=this.techniques.get(h.BloomBlurTechnique,this._blurVerticalConfiguration),n=this.techniques.get(m.BloomCompositionTechnique);if(!i.compiled||!s.compiled||!n.compiled)return this.requestRender(1),t;const o=t.getTexture(),a=this.fboCache,{fullWidth:l,fullHeight:u}=this.bindParameters.camera,d=this.renderingContext;let p=r,f=Math.ceil(l/2),g=Math.ceil(u/2);const _=this._blurParameters.blurRadius;for(let e=0;e<5;e++){const t=a.acquire(f,g,"bloomHorizontal",8);this._blurParameters.color=p,this._prepareFBO(t,f,g),d.bindTechnique(i,this.bindParameters,this._blurParameters),d.screen.draw();const r=a.acquire(f,g,"bloomVertical",8);this._blurParameters.color=t.getTexture(),this._prepareFBO(r,f,g),d.bindTechnique(s,this.bindParameters,this._blurParameters),d.screen.draw(),t.release(),this._bloomResults[e]=r,f=Math.ceil(f/2),g=Math.ceil(g/2),p=this._bloomResults[e].getTexture(),this._blurParameters.blurRadius*=this._blurScale}this._blurParameters.blurRadius=_,this._compositionParameters.color=o,this._compositionParameters.emission=r,this._compositionParameters.bloomTexture0=this._bloomResults[0].getTexture(),this._compositionParameters.bloomTexture1=this._bloomResults[1].getTexture(),this._compositionParameters.bloomTexture2=this._bloomResults[2].getTexture(),this._compositionParameters.bloomTexture3=this._bloomResults[3].getTexture(),this._compositionParameters.bloomTexture4=this._bloomResults[4].getTexture();const b=a.acquire(o.descriptor.width,o.descriptor.height,this.produces);return this._prepareFBO(b,l,u),d.bindTechnique(n,this.bindParameters,this._compositionParameters),d.screen.draw(),this._bloomResults.forEach(e=>e.release()),b.attachDepth(t.getAttachment(y.DepthStencilAttachment)),b.attachColor(t.getAttachment(y.ColorAttachment1),y.ColorAttachment1),b}_prepareFBO(e,t,r){const i=this.renderingContext;i.bindFramebuffer(e.fbo),i.setViewport(0,0,t,r),i.setClearColor(0,0,0,0),i.clear(16384)}get test(){return{compositionParameters:this._compositionParameters,blurParameters:this._blurParameters,setLodFactors:e=>{this._compositionParameters.lodFactors=g.normalizePreset(e)}}}},t.__decorate([s.property()],e.BloomRenderNode.prototype,"consumes",void 0),e.BloomRenderNode=t.__decorate([l.subclass("esri.views.3d.webgl-engine.effects.bloom.BloomRenderNode")],e.BloomRenderNode),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/BloomBlur.glsl":function(){define(["exports","../core/mathUtils","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/effects/bloom/BloomPresets.glsl","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends l.NoParameters{constructor(){super(...arguments),this.blurRadius=a.blurRadiusPresets.sunny}}function d(e){const a=new c.ShaderBuilder,l=a.fragment;a.include(r.ScreenSpacePass),l.include(i.Gamma),l.uniforms.add(new o.Texture2DPassUniform("colorTexture",e=>e.color),new s.FloatPassUniform("blurRadius",e=>e.blurRadius));let u="";for(let e=0;e<15;e++)u+=`locations1D[${e}] = ${(e/14*2-1).toFixed(3).toString()};`;let d="";for(let e=0;e<15;e++)d+=`locations1DWeights[${e}] = ${t.gauss(e-Math.floor(7.5),2).toFixed(7).toString()};`;const h=0===e.bloomStage;return l.code.add(n.glsl`
    float locations1D[${n.glsl.int(15)}];
    float locations1DWeights[${n.glsl.int(15)}];

    vec4 blurUniformSamples(sampler2D toBlur) {
      vec4 res = vec4(0.0);
      vec2 size = vec2(textureSize(toBlur, 0));
      vec2 aspectCorrection = vec2(1.0, size.x / size.y);
      vec2 uvInPixel = uv * size;

      ${u}
      ${d}
      vec2 pixelCenterShift = 0.5 / size;

      for(int i=0;i < ${n.glsl.int(15)}; i++) {
        float uv1D = locations1D[i] + ${h?"pixelCenterShift.x":"pixelCenterShift.y"};
        vec2 uvOffset = ${h?"vec2(uv1D, 0.0)":"vec2(0.0, uv1D)"};

        vec2 uvDistorted = uv + uvOffset * blurRadius * aspectCorrection;
        vec4 sampleColor = texture(toBlur, uvDistorted);
        res += sampleColor * locations1DWeights[i];
      }
      res.a = clamp(res.a, 0.0, 1.0);
      return res;
    }
  `).main.add(n.glsl`fragColor = blurUniformSamples(colorTexture);`),a}const h=Object.freeze(Object.defineProperty({__proto__:null,BloomBlurPassParameters:u,build:d},Symbol.toStringTag,{value:"Module"}));e.BloomBlur=h,e.BloomBlurPassParameters=u,e.build=d})},"esri/views/3d/webgl-engine/effects/bloom/BloomPresets.glsl":function(){define(["exports"],function(e){"use strict";class t{constructor(e,t){this.near=e,this.far=t,this.near=i(e),this.far=i(t)}}const r={sunny:new t([1,.15,.05,.01,0,0],[2.1,.8,.6,.4,.2,.1]),cloudy:new t([1,.15,.05,.01,0,0],[1,.8,.6,.4,.2,.1]),rainy:new t([1,.15,.05,.01,0,0],[1,.8,.6,.4,.2,.1]),snowy:new t([1,.15,.05,.01,0,0],[1,.8,.6,.4,.2,.1]),foggy:new t([1,.15,.05,.01,0,0],[1,.8,.6,.4,.2,.1])};function i(e,t=1){const r=e[0]+e[1]+e[2]+e[3]+e[4]+e[5];return r<t?e:[e[0]/r,e[1]/r,e[2]/r,e[3]/r,e[4]/r,e[5]/r]}e.blurRadiusPresets={sunny:.0022,cloudy:.0022,rainy:.0022,snowy:.0022,foggy:.0022},e.defaultExposure=2.6,e.lodFactorsPresets=r,e.normalizePreset=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/bloom/BloomBlurTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/BloomBlur.glsl","../../lib/DefaultVertexBufferLayouts","../../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.BloomBlur,()=>new Promise((t,r)=>e(["./BloomBlur.glsl"],t,r))),n.Pos2Locations)}initializePipeline(){return o.makePipelineState({colorWrite:o.defaultColorWrite})}}t.BloomBlurTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/bloom/BloomBlurTechniqueConfiguration":function(){define(["exports","../../../../../chunks/tslib.es6","../../core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.bloomStage=0}}t.__decorate([r.parameter({count:2})],i.prototype,"bloomStage",void 0),e.BloomBlurTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/BloomComposition.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/FloatsPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/IntegerPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/effects/bloom/BloomPresets.glsl","../views/3d/webgl-engine/shaders/ToneMapping.glsl","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";class p extends d.NoParameters{constructor(e=c.defaultExposure,t=c.lodFactorsPresets.sunny.far,r=c.lodFactorsPresets.sunny.near){super(),this.exposure=e,this.lodFactors=t,this.lodFactorsFront=r}}const f=new p;class m extends p{constructor(){super(...arguments),this.bloomLod=-1}}function g(){const e=new h.ShaderBuilder,c=e.fragment;return e.include(t.ScreenSpacePass),c.include(i.Gamma),c.include(r.ReadDepth),c.include(u.ToneMapping),c.uniforms.add(new l.Texture2DPassUniform("colorTexture",e=>e.color),new l.Texture2DPassUniform("emissionTexture",e=>e.emission),new l.Texture2DPassUniform("bloomTexture0",e=>e.bloomTexture0),new l.Texture2DPassUniform("bloomTexture1",e=>e.bloomTexture1),new l.Texture2DPassUniform("bloomTexture2",e=>e.bloomTexture2),new l.Texture2DPassUniform("bloomTexture3",e=>e.bloomTexture3),new l.Texture2DPassUniform("bloomTexture4",e=>e.bloomTexture4),new s.FloatPassUniform("exposure",e=>e.exposure),new a.IntegerPassUniform("bloomLod",e=>e.bloomLod),new n.FloatsPassUniform("lodFactors",e=>e.lodFactors,6),new n.FloatsPassUniform("lodFactorsFront",e=>e.lodFactorsFront,6)).main.add(o.glsl`vec4 color = texture(colorTexture, uv);
color = vec4(linearizeGamma(color.rgb), color.a);
vec4 lod0 = texture(emissionTexture, uv);
vec4 lod1 = texture(bloomTexture0, uv);
vec4 lod2 = texture(bloomTexture1, uv);
vec4 lod3 = texture(bloomTexture2, uv);
vec4 lod4 = texture(bloomTexture3, uv);
vec4 lod5 = texture(bloomTexture4, uv);
vec4 emission = lodFactors[0] * lod0;
emission += lodFactors[1] * lod1;
emission += lodFactors[2] * lod2;
emission += lodFactors[3] * lod3;
emission += lodFactors[4] * lod4;
emission += lodFactors[5] * lod5;
emission = bloomLod == 0 ? lodFactors[0] * lod0 : bloomLod == 1 ? lodFactors[1] * lod1 : bloomLod == 2 ? lodFactors[2] * lod2 : bloomLod == 3 ? lodFactors[3] * lod3 : bloomLod == 4 ? lodFactors[4] * lod4 : bloomLod == 5 ? lodFactors[5] * lod5 : emission;
emission = vec4(tonemapACES(emission.rgb), emission.a);
fragColor = emission + color;
fragColor = delinearizeGamma(fragColor);`),e}const y=Object.freeze(Object.defineProperty({__proto__:null,BloomCompositionPassParameters:m,build:g,defaultCompositionParameters:f},Symbol.toStringTag,{value:"Module"}));e.BloomComposition=y,e.BloomCompositionPassParameters=m,e.build=g,e.defaultCompositionParameters=f})},"esri/views/3d/webgl-engine/effects/bloom/BloomCompositionTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/BloomComposition.glsl","../../lib/DefaultVertexBufferLayouts","../../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.BloomComposition,()=>new Promise((t,r)=>e(["./BloomComposition.glsl"],t,r))),n.Pos2Locations)}initializePipeline(){return o.makePipelineState({colorWrite:o.defaultColorWrite})}}t.BloomCompositionTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/geometry/ObjectAndLayerIDRenderNode":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../webgl/RenderNode"],function(e,t,r,i,s,n,o,a,l){"use strict";e.ObjectAndLayerIDRenderNode=class extends l{constructor(e){super(e),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(e){const t=e.find(({name:e})=>"olid"===e),r=this.renderingContext;return r.bindFramebuffer(t.fbo),r.clearFramebuffer(a.ZEROS,!0,!0),this.view.stage.renderer.renderAllGeometry(9),r.clear(1280),this.view.stage.renderer.renderHUD(1),t}},t.__decorate([r.property()],e.ObjectAndLayerIDRenderNode.prototype,"consumes",void 0),t.__decorate([r.property()],e.ObjectAndLayerIDRenderNode.prototype,"produces",void 0),e.ObjectAndLayerIDRenderNode=t.__decorate([o.subclass("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],e.ObjectAndLayerIDRenderNode),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/geometry/RenderOccludedRenderNode":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/PooledArray","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../webgl","../../../webgl/RenderNode","../blit/Blit","../../../../webgl/enums"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.RenderOccludedRenderNode=class extends u{constructor(e){super(e),this.consumes={required:[c.InternalRenderCategory.OCCLUDED]},this.produces=c.InternalRenderCategory.OCCLUDED,this._blit=new d.Blit(e.view.stage.renderView.techniques,2)}precompile(){const e=this.view.stage.renderer;e.plugins.plugins.forEach(t=>{e.precompileSlots(t,9,11),t.material&&e.precompileOccludedSlots(t,f)})}render(e){const t=e.find(({name:e})=>e===this.produces);return this._renderOccludedAndTransparentStencil(t),this._renderOccludedComposite(t),t}_renderOccludedAndTransparentStencil(e){const t=this.view.stage.renderer,r=p;r.clear();for(const e of t.plugins.plugins)8&e.renderOccludedFlags&&r.push(e);0!==r.length&&(t.renderSlots(r,10),this._renderAndComposite(e,e.getAttachment(h.DepthStencilAttachment),.5,()=>t.renderSlots(r,11),!1,!1),r.clear())}_renderOccludedComposite(e){const t=this.view.stage.renderer,r=p;r.clear();let i=0;for(const e of t.plugins.plugins){const t=e.renderOccludedFlags&m;i|=t,t&&r.push(e)}if(!i)return void r.clear();const s=this._getDepthStencilAttachment(e);let n=s.clearStencil;for(const o of f)i&o&&(this._renderAndComposite(e,s.depth,16===o?1:.5,()=>t.renderOccludedSlots(r,o),!0,n),n=!1);s.release(),r.clear()}_renderAndComposite(e,t,r,i,s,n){const o=this.renderingContext,{width:a,height:c}=e.fbo,u=this.fboCache.acquire(a,c,"tmp color");u.attachDepth(t),o.bindFramebuffer(u.fbo),o.clearFramebuffer(l.ZEROS,s,n),i(),u.detachDepth(),this._blit.blend(o,u,e,this.bindParameters,r),u.release()}_getDepthStencilAttachment(e){const{width:t,height:r}=e.fbo;if(!this.view.stage.renderer.occludedRequiresIntegratedMeshStencil){const e=this.fboCache.acquireDepth(11,t,r,"retained stencil");return{depth:e,release:()=>e.release(),clearStencil:!0}}const i=this.fboCache.acquire(t,r,"retained stencil",11);return this.renderingContext.blitFramebuffer(e.fbo,i.fbo,1024),{depth:i.getAttachment(h.DepthStencilAttachment),release:()=>i.release(),clearStencil:!1}}},t.__decorate([i.property()],e.RenderOccludedRenderNode.prototype,"consumes",void 0),t.__decorate([i.property()],e.RenderOccludedRenderNode.prototype,"produces",void 0),e.RenderOccludedRenderNode=t.__decorate([a.subclass("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],e.RenderOccludedRenderNode);const p=new r,f=[4,2,16],m=f.reduce((e,t)=>e|t,0);e.cleanupRenderOccluded=function(){p.prune()},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/blit/Blit":function(){define(["exports","../../../../../chunks/Compositing.glsl","../../shaders/CompositingTechnique","../../shaders/CompositingTechniqueConfiguration"],function(e,t,r,i){"use strict";e.Blit=class{constructor(e,s=0){this._techniques=e,this._parameters=new t.CompositingPassParameters,this._configuration=new i.CompositingTechniqueConfiguration,this._configuration.blitMode=s,e.precompile(r.CompositingTechnique,this._configuration)}blit(e,t,i,s){e.bindFramebuffer(i.fbo),e.setClearColor(0,0,0,1),e.clear(16384),this._parameters.texture=t.getTexture();const n=this._techniques.get(r.CompositingTechnique,this._configuration);e.bindTechnique(n,s,this._parameters),e.screen.draw()}blend(e,t,i,s,n=1){this._configuration.hasOpacityFactor=n<1;const o=this._techniques.get(r.CompositingTechnique,this._configuration);return!!o.compiled&&(e.bindFramebuffer(i.fbo),this._parameters.texture=t.getTexture(),this._parameters.opacity=n,e.bindTechnique(o,s,this._parameters),e.screen.draw(),!0)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/Compositing.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl","../views/3d/webgl-engine/core/shaderModules/Float2BindUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends l.NoParameters{constructor(){super(...arguments),this.opacity=1}}function d(e){const l=new c.ShaderBuilder;l.include(t.ScreenSpacePass),l.fragment.uniforms.add(new a.Texture2DPassUniform("tex",e=>e.texture)),e.hasOpacityFactor&&l.fragment.uniforms.add(new n.FloatPassUniform("opacity",e=>e.opacity));const u=3===e.blitMode;return u&&(l.fragment.uniforms.add(new s.Float2BindUniform("nearFar",e=>e.camera.nearFar)),l.fragment.include(r.ReadDepth),l.fragment.include(i.RgbaFloatEncoding)),l.fragment.main.add(o.glsl`
    ${u?o.glsl`
          float normalizedLinearDepth = (-linearDepthFromTexture(tex, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]);
          fragColor = float2rgba(normalizedLinearDepth);`:o.glsl`
          fragColor = texture(tex, uv) ${e.hasOpacityFactor?"* opacity":""};`}`),l}const h=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:u,build:d},Symbol.toStringTag,{value:"Module"}));e.Compositing=h,e.CompositingPassParameters=u,e.build=d})},"esri/views/3d/webgl-engine/shaders/CompositingTechnique":function(){define(["require","exports","../../../../core/compilerUtils","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/DefaultVertexBufferLayouts","../../../../chunks/Compositing.glsl","../../../webgl/renderState"],function(e,t,r,i,s,n,o,a){"use strict";class l extends s.ShaderTechnique{constructor(t,r){super(t,r,new i.ReloadableShaderModule(o.Compositing,()=>new Promise((t,r)=>e(["./Compositing.glsl"],t,r))),n.Pos2Locations)}initializePipeline(e){switch(e.blitMode){case 0:case 3:return a.makePipelineState({colorWrite:a.defaultColorWrite});case 1:return a.makePipelineState({blending:a.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:a.defaultColorWrite});default:r.neverReached(e.blitMode);case 2:case 4:return a.makePipelineState({blending:a.premultipliedAlpha,colorWrite:a.defaultColorWrite})}}}t.CompositingTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/CompositingTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.blitMode=0,this.hasOpacityFactor=!1}}t.__decorate([r.parameter({count:4})],i.prototype,"blitMode",void 0),t.__decorate([r.parameter()],i.prototype,"hasOpacityFactor",void 0),e.CompositingTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/haze/Haze":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/Logger","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../chunks/vec32","../../../../../chunks/vec42","../../../../../geometry/support/Ellipsoid","../../../webgl","../TransparentEnvironment","../../../../../chunks/HazeCompositing.glsl","./HazeCompositingTechnique","./HazeTechnique","./HazeTechniqueConfiguration","../../lib/glUtil3D","../../lib/textureUtils","../../../../webgl/enums"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x){"use strict";e.Haze=class extends m.TransparentEnvironment{constructor(e){super(e),this._compositingPassParameters=new g.HazeCompositingPassParameters,this._passParameters=new _.HazePassParameters,this._hazeConfiguration=new b.HazeTechniqueConfiguration,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;const t=e.view.stage.renderView.techniques;t.precompile(_.HazeTechnique,new b.HazeTechniqueConfiguration);const r=new b.HazeTechniqueConfiguration;r.reduced=!0,t.precompile(_.HazeTechnique,r),t.precompile(y.HazeCompositingTechnique)}initialize(){this.addHandles([s.watch(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),s.syncAndInitial),s.watch(()=>this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1,e=>this._fade(e),s.syncAndInitial),s.watch(()=>this.view.environment.weather.type,e=>this._newAmount="rainy"===e?0:1,s.syncAndInitial),s.watch(()=>this.view.stage.renderer?.fullResolutionAtmosphere,e=>this._hazeConfiguration.reduced=!e,s.syncAndInitial)])}_fade(e){e>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=e<=0?this._oldAmount:r.lerp(this._oldAmount,this._newAmount,e)}destroy(){this._vao=i.disposeMaybe(this._vao)}render(e){const t=e.find(({name:e})=>e===f.InternalRenderCategory.TRANSPARENT_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext,s=this.techniques.get(_.HazeTechnique,this._hazeConfiguration);if(!s.compiled)return t;const n=t.getAttachment(x.DepthStencilAttachment);if(this._update(),!this._hazeConfiguration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(s,this.bindParameters,this._passParameters),this._renderCommon(i),t.attachDepth(n),t;const o=this.techniques.get(y.HazeCompositingTechnique);if(!o.compiled)return t;const a=i.getViewport(),l=this.camera,c=d.length(l.eye)-p.earth.radius;let u;const h=p.earth.atmosphereHeight;if(c<h){const e=Math.min(1,Math.max(0,c/h));u=r.lerp(.4,.5,e)}else{const e=Math.min(1,Math.max(0,(c-h)/(15*h)));u=r.lerp(.5,1,e)}const m=this.renderingContext.parameters.maxTextureSize,g=w.applyTextureResizeModulo(Math.round(u*l.fullViewport[2]),m),b=w.applyTextureResizeModulo(Math.round(u*l.fullViewport[3]),m);i.setViewport(0,0,g,b);const v=this.fboCache.acquire(g,b,"haze",5);return i.bindFramebuffer(v.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(s,this.bindParameters,this._passParameters),this._renderCommon(i),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=v.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(o,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(n),v.release(),t}_renderCommon(e){this._vao??=v.createQuadVAO(e,1),e.bindVAO(this._vao),e.drawArrays(x.PrimitiveType.TRIANGLE_STRIP,0,4)}_update(){const e=this.bindParameters.camera,t=d.squaredLength(e.eye),i=Math.sqrt(t),s=t-this._passParameters.radii[1]*this._passParameters.radii[1],n=r.clamp((i-this._passParameters.radii[0])/p.earth.atmosphereHeight,0,1);h.set(this._passParameters.heightParameters,i,t,s,n);const o=this.view.basemapTerrain?.getLowerBoundRadius()??0;u.set(this._passParameters.radii,o,o+p.earth.atmosphereHeight),this._passParameters.hazeStrength=r.lerp(r.lerp(.6,1,r.smoothstep(9500,10500,i-p.earth.radius)),1,this._amount)}},e.Haze=t.__decorate([c.subclass("esri.views.3d.webgl-engine.effects.haze.Haze")],e.Haze),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/HazeCompositing.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o){"use strict";class a extends n.NoParameters{}function l(){const e=new o.ShaderBuilder;return e.include(t.ScreenSpacePass),e.fragment.uniforms.add(new s.Texture2DPassUniform("colorTexture",e=>e.color),new i.Texture2DBindUniform("depthTexture",e=>e.mainDepth)),e.fragment.main.add(r.glsl`float depthSample = texture(depthTexture, uv).r;
if (depthSample == 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const c=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:a,build:l},Symbol.toStringTag,{value:"Module"}));e.HazeCompositing=c,e.HazeCompositingPassParameters=a,e.build=l})},"esri/views/3d/webgl-engine/effects/haze/HazeCompositingTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/HazeCompositing.glsl","../../lib/DefaultVertexBufferLayouts","../../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.HazeCompositing,()=>new Promise((t,r)=>e(["./HazeCompositing.glsl"],t,r))),n.Pos2Locations)}initializePipeline(){return o.makePipelineState({blending:o.separateBlendingParams(1,0,769,1),depthTest:{func:519},colorWrite:o.defaultColorWrite})}}t.HazeCompositingTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/haze/HazeTechnique":function(){define(["require","exports","../../../environment/ChapmanApproximation.glsl","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/Haze.glsl","../../lib/DefaultVertexBufferLayouts","../../../../webgl/renderState","../../../../webgl/VertexAttributeLocations"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends r.ChapmanApproximationParameters{constructor(){super(...arguments),this.hazeStrength=1}}class u extends s.ShaderTechnique{constructor(t,r){super(t,r,new i.ReloadableShaderModule(n.Haze,()=>new Promise((t,r)=>e(["./Haze.glsl"],t,r))),l.fromLayout(o.Pos2TexF16))}initializePipeline(e){return e.reduced?a.makePipelineState({blending:a.copySource,depthTest:{func:519},colorWrite:a.defaultColorWrite}):a.makePipelineState({blending:a.separateBlendingParams(1,0,769,1),colorWrite:a.defaultColorWrite})}}t.HazePassParameters=c,t.HazeTechnique=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/Haze.glsl":function(){define(["exports","../views/3d/environment/ChapmanRaymarching.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/shaders/ScreenSpacePassAtmosphere.glsl","../views/3d/webgl-engine/shaders/SphereIntersect.glsl","../views/3d/webgl-engine/shaders/ToneMapping.glsl","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(e){const h=new d.ShaderBuilder,{fragment:p}=h;h.include(l.ScreenSpacePassAtmosphere),s.addMainLightDirection(p),p.include(i.Gamma),p.include(r.ReadDepth),p.include(c.SphereIntersect),p.include(u.ToneMapping),p.include(t.ChapmanRaymarching,!0),p.uniforms.add(new a.Texture2DBindUniform("depthTexture",e=>e.mainDepth),new n.FloatPassUniform("hazeStrength",e=>e.hazeStrength));const{reduced:f}=e;return f&&p.code.add(o.glsl`float getDepth(vec2 uv){
return linearDepthFromTexture(depthTexture, uv);
}
float textureBilinear(vec2 uv) {
vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
vec2 texelSize = 1.0 / depthTextureSize;
vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);
vec2 f = fract(depthUV);
vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;
float d0 = getDepth(snapUV);
float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
float d3 = getDepth(snapUV + texelSize);
return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
}`),p.main.add(o.glsl`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture(depthTexture, uv).r;
      if (depthSample != 1.0) {
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;

        cameraSpaceRay *= ${o.If(f,"-textureBilinear(uv)","-linearDepthFromTexture(depthTexture, uv)")};
        terrainDepth = max(0.0, length(cameraSpaceRay));
      } else {
        discard;
      }

      // Alpha is ignored for haze blending
      vec3 col = vec3(0);
      float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
      if(depthSample != 1.0){
        col = (1.0 - fadeOut) * hazeStrength * raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      }
      float alpha = 1.0;

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
  `),h}const p=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}));e.Haze=p,e.build=h})},"esri/views/3d/webgl-engine/effects/haze/HazeTechniqueConfiguration":function(){define(["exports","../../../../../chunks/tslib.es6","../../core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.reduced=!1}}t.__decorate([r.parameter()],i.prototype,"reduced",void 0),e.HazeTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/highlight/ShadowHighlight":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/colorUtils","../../../../../core/mathUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../webgl","../../../webgl/RenderNode","./ShadowHighlightTechnique","../../../../support/HighlightDefaults"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";const g=1/512;e.ShadowHighlight=class extends p{constructor(e){super(e),this.produces=h.RenderCategory.COMPOSITE,this.consumes={required:[h.RenderCategory.COMPOSITE,"highlights"]},this._passParameters=new f.ShadowHighlightPassParameters,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([s.watch(()=>this.view.highlightOptions.shadowOpacity,e=>{this._passParameters.shadowOpacity=e??m.defaultShadowOpacity,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},s.syncAndInitial),s.watch(()=>this.view.highlightOptions.shadowDifference,e=>{this._shadowDifference=e??m.defaultShadowDifference,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},s.syncAndInitial),s.watch(()=>this.view.highlightOptions.shadowColor,e=>{this._passParameters.shadowColor=r.unitRGBAFromColor(e??m.defaultShadowColor),this._ensureMaxOpacity()},s.syncAndInitial)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(1)}precompile(){this.techniques.precompile(f.ShadowHighlightTechnique)}render(e){const t=e.find(({name:e})=>e===h.RenderCategory.COMPOSITE),r=this.bindParameters;if(!r.shadowHighlightsVisible||!r.depth||!this._ensureIfVisible(r.camera,r.lighting.mainLight.direction))return t;const i=this.techniques.get(f.ShadowHighlightTechnique);if(!i.compiled)return this.requestRender(1),t;this._passParameters.highlightTexture=e.find(({name:e})=>"highlights"===e)?.getTexture(),this._passParameters.origin=r.camera.center;const s=this.renderingContext;return s.bindFramebuffer(t.fbo),s.bindTechnique(i,r,this._passParameters),s.screen.draw(),t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-i.smoothstep(4e4,5e4,e.relativeElevation);const r=1===this.viewingMode?u.normalize(y,e.center):u.set(y,0,0,1),s=u.dot(r,t);return this._passParameters.dayNightTerminator=i.smoothstep(0,1,i.clamp(30*s,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=g}},t.__decorate([n.property()],e.ShadowHighlight.prototype,"produces",void 0),t.__decorate([n.property()],e.ShadowHighlight.prototype,"consumes",void 0),t.__decorate([n.property({constructOnly:!0})],e.ShadowHighlight.prototype,"viewingMode",void 0),e.ShadowHighlight=t.__decorate([c.subclass("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],e.ShadowHighlight);const y=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/highlight/ShadowHighlightTechnique":function(){define(["require","exports","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../core/shaderLibrary/shading/ReadShadowMap.glsl","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../lib/DefaultVertexBufferLayouts","../../../../../chunks/ShadowHighlight.glsl","../../../../webgl/enums","../../../../webgl/renderState"],function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends i.ReadShadowMapPassParameters{constructor(){super(...arguments),this.shadowColor=r.fromValues(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class d extends n.ShaderTechnique{constructor(t,r){super(t,r,new s.ReloadableShaderModule(a.ShadowHighlight,()=>new Promise((t,r)=>e(["../../shaders/ShadowHighlight.glsl"],t,r))),o.Pos2Locations),this.primitiveType=l.PrimitiveType.TRIANGLE_STRIP}initializePipeline(){return c.makePipelineState({blending:c.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:c.defaultColorWrite,depthTest:null,depthWrite:null})}}t.ShadowHighlightPassParameters=u,t.ShadowHighlightTechnique=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/ShadowHighlight.glsl":function(){define(["exports","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/webgl-engine/core/shaderLibrary/NormalFromDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/calculateUVZShadowFromDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ShadowmapFiltering.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DShadowBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DUintPassUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";function g(){const e=new m.ShaderBuilder;e.include(n.calculateUVZShadowFromDepthPass),e.include(o.ShadowmapFiltering),e.include(s.ScreenSpacePass),e.include(i.NormalFromDepth);const r=e.fragment;return r.include(a.RgbaFloatEncoding),r.uniforms.add(new p.Texture2DShadowBindUniform("shadowMapExcludingHighlight",e=>e.shadowMap.getSnapshot(1)),new p.Texture2DShadowBindUniform("shadowMapHighlight",e=>e.shadowMap.getSnapshot(0)),new h.Texture2DBindUniform("depthMap",e=>e.depth?.attachment),new f.Texture2DUintPassUniform("highlightTexture",e=>e.highlightTexture),new c.Float4PassUniform("uColor",e=>e.shadowColor),new u.FloatPassUniform("opacity",e=>e.shadowOpacity),new u.FloatPassUniform("occludedOpacity",e=>e.occludedShadowOpacity),new u.FloatPassUniform("terminationFactor",e=>e.opacityElevation*e.dayNightTerminator),new l.Float3BindUniform("lightingMainDirectionView",({lighting:e,camera:r})=>t.normalize(y,t.transformMat4(y,e.mainLight.direction,r.viewInverseTransposeMatrix)))),r.main.add(d.glsl`
    ivec2 highlightTextureSize = textureSize(highlightTexture, 0);
    ivec2 highlightIUV = ivec2(uv * vec2(highlightTextureSize));
    uvec2 highlightInfo = texelFetch(highlightTexture, highlightIUV, 0).rg;

    fragColor = vec4(0.0);

    // Calculate bit mask to check if pixel is highlit unoccluded at any level
    uint ored = (highlightInfo.r << 0) | (highlightInfo.g << 8);

    bool visiblyHighlighted = ((ored & ~(ored >> 1)) & (1u+4u+16u+64u)) != 0u;
    if (visiblyHighlighted) {
      return;
    }

    vec4 currentPixelPos;
    vec3 uvzShadow = calculateUVZShadowAndPixelPosFromDepth(uv, textureSize(shadowMapHighlight,0), depthMap, currentPixelPos);
    if (uvzShadow.z < 0.0) {
      return;
    }

    float shadowHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapHighlight);
    if (shadowHighlightFactor == 0.0) {
      return;
    }

    float shadowExcludingHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapExcludingHighlight);

    vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);
    bool shaded = dot(normal, lightingMainDirectionView) < ${d.glsl.float(.025)};

    float occludedFactor = max(shadowExcludingHighlightFactor, shaded ? 1.0 : 0.0);
    float fragOpacity = mix(opacity, occludedOpacity, occludedFactor);
    fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
  `),e}const y=r.create(),_=Object.freeze(Object.defineProperty({__proto__:null,build:g},Symbol.toStringTag,{value:"Module"}));e.ShadowHighlight=_,e.build=g})},"esri/views/3d/webgl-engine/core/shaderLibrary/NormalFromDepth.glsl":function(){define(["exports","./output/ReadDepth.glsl","./util/CameraSpace.glsl","../shaderModules/glsl"],function(e,t,r,i){"use strict";e.NormalFromDepth=function(e){const s=e.fragment;e.include(r.CameraSpace),s.include(t.ReadDepth),s.code.add(i.glsl`vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
float leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);
float rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);
float bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);
float topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/calculateUVZShadowFromDepth.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../../core/libs/gl-matrix-2/factories/mat4f64","../output/ReadDepth.glsl","./calculateUVZShadow.glsl","../util/CameraSpace.glsl","../../shaderModules/glsl","../../shaderModules/Matrix4BindUniform"],function(e,t,r,i,s,n,o,a){"use strict";function l(e){e.fragment.include(i.ReadDepth),e.include(n.CameraSpace),e.fragment.uniforms.add(new a.Matrix4BindUniform("inverseViewMatrix",({camera:e})=>t.invert(c,t.translate(c,e.viewMatrix,e.center)))).code.add(o.glsl`vec3 calculateUVZShadowAndPixelPosFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap,
out vec4 currentPixelPos
) {
float depth = depthFromTexture(_depthMap, _uv);
if (depth >= 1.0 || depth <= 0.0) {
return invalidShadowmapUVZ;
}
float currentPixelDepth = linearizeDepth(depth);
currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
float linearDepth = -currentPixelDepth;
return calculateUVZShadow(worldSpacePos.xyz, linearDepth, shadowMapSize);
}
vec3 calculateUVZShadowFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap
) {
vec4 currentPixelPos;
return calculateUVZShadowAndPixelPosFromDepth(_uv, shadowMapSize, _depthMap, currentPixelPos);
}`)}const c=r.create();e.calculateUVZShadowFromDepthDraw=function(e){e.include(s.calculateUVZShadowDraw),l(e)},e.calculateUVZShadowFromDepthPass=function(e){e.include(s.calculateUVZShadowPass),l(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/magnifier/Magnifier":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/asyncUtils","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/screenUtils","../../../../../core/urlUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../support/requestImageUtils","../../../webgl","../../../webgl/RenderNode","./MagnifierTechnique","../../lib/glUtil3D","../../../../../chunks/Magnifier.glsl","../../../../magnifier/resources","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x){"use strict";e.Magnifier=class extends m{constructor(){super(...arguments),this.produces=f.InternalRenderCategory.MAGNIFIER,this.consumes={required:[f.InternalRenderCategory.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new _.MagnifierPassParameters,this._magnifier=null,this._tmpScreenPoint=o.createScreenPointArray(),this._tmpRenderPoint=o.createRenderScreenPointArray()}initialize(){this.addHandles([n.watch(()=>this.view.magnifier,e=>this._update(e),n.syncAndInitial)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const e=this._validMagnifier;e?(this._loadResources(e),this.produces=f.InternalRenderCategory.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles(n.watch(()=>this._magnifier?.version,t)),t()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=s.disposeMaybe(this._vao)}_disposeTextures(){this._passParameters.mask=s.disposeMaybe(this._passParameters.mask),this._passParameters.overlay=s.disposeMaybe(this._passParameters.overlay),this._passParameters.input=s.disposeMaybe(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(g.MagnifierTechnique)}render(e){const t=this._validMagnifier,r=e.find(({name:e})=>e===f.InternalRenderCategory.MAGNIFIER);if(null==t)return r;if(null==this._imageSources)return this.requestRender(1),r;const s=this.renderingContext,n=this.camera.pixelRatio,a=Math.ceil(n*t.size);this._vao??=y.createQuadVAO(s,0,0,1);const l=this.techniques.get(g.MagnifierTechnique);if(this._ensureTextureResources(s,a),!l.compiled||!this._passParameters.input)return this.requestRender(1),r;const c=Math.ceil(1/this._factor*a),u=this._passParameters.input;u.resize(c,c),o.screenPointObjectToArray(t.position,this._tmpScreenPoint);const d=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),h=this.camera.fullWidth,p=this.camera.fullHeight,m=.5*c,_=.5*c;d[0]=i.clamp(d[0],m,h-m-1),d[1]=i.clamp(d[1],_,p-_-1);const b=Math.floor(d[0]-m),w=Math.floor(d[1]-_);return s.bindFramebuffer(r.fbo),l.program.bindTexture("textureInput",u),s.gl.copyTexImage2D(u.descriptor.target,0,u.descriptor.pixelFormat,b,w,c,c,0),this._passParameters.magnifier=t,s.bindTechnique(l,this.bindParameters,this._passParameters),s.bindVAO(this._vao),s.drawArrays(v.PrimitiveType.TRIANGLE_STRIP,0,4),r}_loadResources(e){const{maskUrl:t,overlayUrl:i}=e;this._imageLoadTask?.maskUrl===t&&this._imageLoadTask?.overlayUrl===i||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:r.createTask(async e=>{const r=null==t||null==i?b.loadMagnifierResources(e):null,s=null!=t?p.requestImage(t,{signal:e}):r.then(e=>e.mask),n=null!=i?p.requestImage(i,{signal:e}):r.then(e=>e.overlay);this._imageSources={mask:await s,overlay:await n}})})}_ensureTextureResources(e,t){null==this._imageSources||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay||(this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t,this._passParameters.overlay=new w.Texture(e,this._createTextureDescriptor(t,6408,this._imageSources.overlay),this._imageSources.overlay),this._passParameters.mask=new w.Texture(e,this._createTextureDescriptor(t,6406,this._imageSources.mask),this._imageSources.mask),this._passParameters.input=new w.Texture(e,this._createTextureDescriptor(t,6408,null)))}_createTextureDescriptor(e,t,r){const i=this.renderingContext,s=new x.TextureDescriptor(e);return s.pixelFormat=s.internalFormat=t,s.wrapMode=33071,s.flipped=!!r,s.preMultiplyAlpha=!(6408!==t||!r||a.isSVG(r.src)&&i.driverTest.svgPremultipliesAlpha.result),s}},t.__decorate([l.property()],e.Magnifier.prototype,"produces",void 0),t.__decorate([l.property()],e.Magnifier.prototype,"consumes",void 0),t.__decorate([l.property()],e.Magnifier.prototype,"_imageSources",void 0),t.__decorate([l.property()],e.Magnifier.prototype,"_imageLoadTask",void 0),e.Magnifier=t.__decorate([h.subclass("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],e.Magnifier),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/magnifier/MagnifierTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../lib/DefaultVertexBufferLayouts","../../../../../chunks/Magnifier.glsl","../../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.Magnifier,()=>new Promise((t,r)=>e(["../../shaders/Magnifier.glsl"],t,r))),s.Pos2Locations)}initializePipeline(){return o.makePipelineState({blending:o.premultipliedAlpha,depthTest:null,depthWrite:null,colorWrite:o.defaultColorWrite})}}t.MagnifierTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/Magnifier.glsl":function(){define(["exports","../core/screenUtils","./vec42","../core/libs/gl-matrix-2/factories/vec4f64","../views/3d/webgl-engine/core/shaderModules/BooleanPassUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends l.NoParameters{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}}function d(){const e=new c.ShaderBuilder;return e.attributes.add("position","vec2"),e.vertex.uniforms.add(new n.Float4PassUniform("drawPosition",(e,i)=>function(e,i){const s=i.camera.pixelRatio,n=e.magnifier.offset.x*s,o=e.magnifier.offset.y*s;t.screenPointObjectToArray(e.magnifier.position,h);const a=i.camera.screenToRender(h,p),l=Math.ceil(s*e.magnifier.size),{fullWidth:c,fullHeight:u}=i.camera;return r.set(f,(a[0]+n)/c*2-1,(a[1]-o)/u*2-1,l/c*2,l/u*2)}(e,i))),e.varyings.add("vUV","vec2"),e.vertex.main.add(o.glsl`vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);`),e.fragment.uniforms.add(new a.Texture2DPassUniform("textureInput",e=>e.input)),e.fragment.uniforms.add(new a.Texture2DPassUniform("textureMask",e=>e.mask)),e.fragment.uniforms.add(new a.Texture2DPassUniform("textureOverlay",e=>e.overlay)),e.fragment.uniforms.add(new s.BooleanPassUniform("maskEnabled",e=>e.magnifier.maskEnabled)),e.fragment.uniforms.add(new s.BooleanPassUniform("overlayEnabled",e=>e.magnifier.overlayEnabled)),e.fragment.code.add(o.glsl`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}`),e.fragment.main.add(o.glsl`float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;`),e}const h=t.createScreenPointArray(),p=t.createRenderScreenPointArray(),f=i.create(),m=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:u,build:d},Symbol.toStringTag,{value:"Module"}));e.Magnifier=m,e.MagnifierPassParameters=u,e.build=d})},"esri/views/magnifier/resources":function(){define(["require","exports","../../core/promiseUtils","../../support/requestImageUtils"],function(e,t,r,i){"use strict";const s=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));t.loadMagnifierResources=async function(t){const n=new Promise((t,r)=>e(["./mask-svg"],e=>t(s(e)),r)),o=new Promise((t,r)=>e(["./overlay-svg"],e=>t(s(e)),r)),a=i.requestImage((await n).default,{signal:t}),l=i.requestImage((await o).default,{signal:t}),c={mask:await a,overlay:await l};return r.throwIfAborted(t),c},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/smaa/SMAA":function(){define(["require","exports","../../../../../chunks/tslib.es6","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../support/requestImageUtils","../../../webgl","../../../webgl/RenderNode","./SMAABlendWeightsTechnique","./SMAABlurTechnique","./SMAAEdgeDetectTechnique","./SMAAPassParameters","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b){"use strict";function v(e,t,r,i){const s=new b.TextureDescriptor(i.width,i.height);return s.pixelFormat=r,s.wrapMode=33071,s.samplingMode=t,new _.Texture(e,s,i)}t.SMAA=class extends p{constructor(e){super(e),this.produces="disabled",this.consumes={required:[h.InternalRenderCategory.ANTIALIASING],optional:[h.RenderCategory.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new y.SMAAPassParameters}initialize(){this.addHandles([n.watch(()=>this.isEnabled(),e=>e?this.enable():this.disable(),n.syncAndInitial)])}async enable(){if(this.produces=h.InternalRenderCategory.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const t=this._abortController.signal;try{const r=await new Promise((t,r)=>e(["./SMAAData"],t,r));await this._loadTextures(r,t),this.requestRender(1)}catch{}this._abortController=null}async _loadTextures(e,t){s.throwIfAborted(t);const[r,i]=await Promise.allSettled([d.requestImage(e.areaTexture,{signal:t}),d.requestImage(e.searchTexure,{signal:t})]);if(s.throwIfAborted(t),"fulfilled"!==r.status||"fulfilled"!==i.status)return;const n=this.renderingContext;this._areaTexture=v(n,9729,6407,r.value),this._searchTexture=v(n,9728,6409,i.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=i.disposeMaybe(this._searchTexture),this._areaTexture=i.disposeMaybe(this._areaTexture)}precompile(){this.techniques.precompile(g.SMAAEdgeDetectTechnique),this.techniques.precompile(f.SMAABlendWeightsTechnique),this.techniques.precompile(m.SMAABlurTechnique)}render(e){const t=e.find(({name:e})=>e===h.InternalRenderCategory.ANTIALIASING);if(!this._areaTexture||!this._searchTexture)return this.requestRender(1),t;const r=this.techniques.get(g.SMAAEdgeDetectTechnique),i=this.techniques.get(f.SMAABlendWeightsTechnique),s=this.techniques.get(m.SMAABlurTechnique);if(!r.compiled||!i.compiled||!s.compiled)return this.requestRender(1),t;const n=e.find(({name:e})=>e===h.RenderCategory.COMPOSITE);if(!n)return t;const o=n.fbo.width,a=n.fbo.height,l=this.renderingContext;l.setViewport(0,0,o,a);const c=this.fboCache.acquire(o,a,"smaa edges",2);l.bindFramebuffer(c.fbo),l.setClearColor(0,0,0,1),l.clear(16384),this._smaaParameters.color=n.getTexture();const u=this.bindParameters;l.bindTechnique(r,u,this._smaaParameters),l.screen.draw();const d=this.fboCache.acquire(o,a,"smaa blend");return l.bindFramebuffer(d.fbo),l.setClearColor(0,0,1,1),l.clear(16384),this._smaaParameters.inputTexture=c.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(i,u,this._smaaParameters),l.screen.draw(),c.release(),l.bindFramebuffer(t.fbo),l.setClearColor(0,1,0,1),l.clear(16384),this._smaaParameters.inputTexture=d.getTexture(),l.bindTechnique(s,u,this._smaaParameters),l.screen.draw(),d.release(),t}},r.__decorate([o.property()],t.SMAA.prototype,"produces",void 0),r.__decorate([o.property()],t.SMAA.prototype,"consumes",void 0),r.__decorate([o.property({constructOnly:!0})],t.SMAA.prototype,"isEnabled",void 0),r.__decorate([o.property()],t.SMAA.prototype,"_abortController",void 0),t.SMAA=r.__decorate([u.subclass("esri.views.3d.webgl-engine.effects.smaa.SMAA")],t.SMAA),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/smaa/SMAABlendWeightsTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../lib/DefaultVertexBufferLayouts","../../../../../chunks/BlendWeights.glsl","../../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.BlendWeights,()=>new Promise((t,r)=>e(["../../shaders/BlendWeights.glsl"],t,r))),s.Pos2Locations)}initializePipeline(){return o.makePipelineState({colorWrite:o.defaultColorWrite})}}t.SMAABlendWeightsTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/BlendWeights.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s){"use strict";function n(){const e=new s.ShaderBuilder;return e.include(t.ScreenSpacePass),e.fragment.uniforms.add(new i.Texture2DPassUniform("edgesTexture",e=>e.inputTexture),new i.Texture2DPassUniform("areaTexture",e=>e.areaTexture),new i.Texture2DPassUniform("searchTexture",e=>e.searchTexture)),e.fragment.constants.add("smaaAreaTexPixelSize","vec2",[1/160,1/560]),e.fragment.code.add(r.glsl`
    vec4 sampleLevelZeroOffset(vec2 coord, vec2 offset, vec2 resolution) {
      return texture(edgesTexture, coord + offset.x * resolution);
    }

    float searchLength(vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture(searchTexture, e).r;
    }

    float searchLeft(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${r.glsl.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x > end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${r.glsl.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x < end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength(e, 0.5, 0.5);
      return texcoord.x;
    }

    float searchUp(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${r.glsl.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y > end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength(e.gr, 0.0, 0.5);
      return texcoord.y;
    }

    float searchDown(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${r.glsl.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y < end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength(e.gr, 0.5, 0.5);
      return texcoord.y;
    }

    vec2 getArea(sampler2D areaTex, vec2 dist, float e1, float e2, float offset) {
      vec2 texcoord = float(${r.glsl.int(16)}) * round(4.0 * vec2(e1, e2)) + dist;
      texcoord = smaaAreaTexPixelSize * texcoord + (0.5 * smaaAreaTexPixelSize);
      texcoord.y += ${r.glsl.float(1/7)} * offset;
      return texture(areaTex, texcoord).rg;
    }`),e.fragment.main.add(r.glsl`
    vec2 size = vec2(textureSize(edgesTexture, 0));
    vec2 resolution = 1.0 / size;
    vec2 pixelCoord = uv * size;
    vec4 offsets[2];
    offsets[0] = uv.xyxy + resolution.xyxy * vec4(-0.25, 0.125, 1.25, 0.125);
    offsets[1] = uv.xyxy + resolution.xyxy * vec4(-0.125, 0.25, -0.125, -1.25);
    vec4 maxOffset = vec4(offsets[0].xz, offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * resolution.xxyy * float(${r.glsl.int(8)});
    ivec4 subsampleIndices = ivec4(0.0);
    vec4 weights = vec4(0.0);
    vec2 e = texture(edgesTexture, uv).rg;
    if (e.r > 0.0) {
      vec2 d;
      vec2 coords;
      coords.y = searchUp(offsets[1].xy, maxOffset.z, resolution);
      coords.x = offsets[0].x;
      d.x = coords.y;
      float e1 = texture(edgesTexture, coords).g;
      coords.y = searchDown(offsets[1].zw, maxOffset.w, resolution);
      d.y = coords.y;
      d = d * size.y - pixelCoord.y;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(0.0, 1.0), resolution).g;
      weights.ba = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.x));
      // for some reason the following lines are necessary to prevent
      // texture lookup precision issues on some Intel integrated graphics chips
      vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
      weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
    }
    if (e.g > 0.0) {
      vec2 d;
      vec2 coords;
      coords.x = searchLeft(offsets[0].xy, maxOffset.x, resolution);
      coords.y = offsets[1].y;
      d.x = coords.x;
      float e1 = texture(edgesTexture, coords).r;
      coords.x = searchRight(offsets[0].zw, maxOffset.y, resolution);
      d.y = coords.x;
      d = d * size.x - pixelCoord.x;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(1.0, 0.0), resolution).r;
      weights.rg = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.y));
    }
    fragColor = weights;
  `),e}const o=Object.freeze(Object.defineProperty({__proto__:null,build:n},Symbol.toStringTag,{value:"Module"}));e.BlendWeights=o,e.build=n})},"esri/views/3d/webgl-engine/effects/smaa/SMAABlurTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../lib/DefaultVertexBufferLayouts","../../../../../chunks/Blur.glsl","../../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.Blur,()=>new Promise((t,r)=>e(["../../shaders/Blur.glsl"],t,r))),s.Pos2Locations)}initializePipeline(){return o.makePipelineState({colorWrite:o.defaultColorWrite})}}t.SMAABlurTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/Blur.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s){"use strict";function n(){const e=new s.ShaderBuilder;return e.include(t.ScreenSpacePass),e.fragment.uniforms.add(new i.Texture2DPassUniform("blendWeightsTexture",e=>e.inputTexture),new i.Texture2DPassUniform("colorTexture",e=>e.color)),e.fragment.main.add(r.glsl`vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}`),e}const o=Object.freeze(Object.defineProperty({__proto__:null,build:n},Symbol.toStringTag,{value:"Module"}));e.Blur=o,e.build=n})},"esri/views/3d/webgl-engine/effects/smaa/SMAAEdgeDetectTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../lib/DefaultVertexBufferLayouts","../../../../../chunks/EdgeDetect.glsl","../../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.EdgeDetect,()=>new Promise((t,r)=>e(["../../shaders/EdgeDetect.glsl"],t,r))),s.Pos2Locations)}initializePipeline(){return o.makePipelineState({colorWrite:o.defaultColorWrite})}}t.SMAAEdgeDetectTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/EdgeDetect.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s){"use strict";function n(){const e=new s.ShaderBuilder;return e.include(t.ScreenSpacePass),e.outputs.add("fragEdges","vec2"),e.fragment.code.add(r.glsl`float absMax3(vec3 v) {
vec3 t = abs(v);
return max(max(t.r, t.g), t.b);
}`),e.fragment.uniforms.add(new i.Texture2DPassUniform("colorTexture",e=>e.color)).main.add(r.glsl`
    vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
    vec4 offsets[3];
    offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
    offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
    offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

    // Calculate color deltas:
    vec3 C = texture(colorTexture, uv).rgb;
    vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
    vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
    vec2 delta = vec2(absMax3(C - Cleft), absMax3(C - Ctop));
    vec2 edges = step(vec2(${r.glsl.float(.05)}), delta);

    // discard if there is no edge:
    if (dot(edges, vec2(1.0)) == 0.0) {
      fragEdges = vec2(0.0);
    }
    else {
      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      float horizontal = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      float vertical = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), horizontal), vertical);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      horizontal = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      vertical = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, horizontal), vertical);

      // Local contrast adaptation in action:
      fragEdges = edges * step(maxDelta, float(${r.glsl.float(2)}) * delta);
    }
  `),e}const o=Object.freeze(Object.defineProperty({__proto__:null,build:n},Symbol.toStringTag,{value:"Module"}));e.EdgeDetect=o,e.build=n})},"esri/views/3d/webgl-engine/effects/smaa/SMAAPassParameters":function(){define(["exports","../../../../webgl/NoParameters"],function(e,t){"use strict";class r extends t.NoParameters{}e.SMAAPassParameters=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/stars/Stars":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../assets","../../../../../core/asyncUtils","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/reactiveUtils","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../webgl","../../../support/buffer/glUtil","../OpaqueEnvironment","./StarsTechnique","../../lib/VertexArrayObject","../../../../webgl/enums","../../../../webgl/VertexBuffer"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v){"use strict";function w(e){return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)]}function x(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}e.Stars=class extends g.OpaqueEnvironment{constructor(){super(...arguments),this._numPoints=0,this._passParameters=new y.StarPassParameters}initialize(){this.addHandles([l.watch(()=>this.view.environment.starsEnabled,e=>e?this._enable():this._disable(),l.initial),l.watch(()=>"virtual"===this.view.environment.lighting.type?null:this.view.environment.lighting.date,e=>this._update(e),l.syncAndInitial)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=o.abortMaybe(this._loadDataTask),this._numPoints=0,this._vao=o.disposeMaybe(this._vao),this._starData=null}precompile(){this.techniques.precompile(y.StarsTechnique)}render(e){const t=e.find(({name:e})=>e===f.InternalRenderCategory.OPAQUE_ENVIRONMENT),r=this.renderingContext;if(this.loading)return this.requestRender(1),t;if(!this._starData)return t;this._vao??=this._ensureResources(this._starData,r);const i=this.techniques.get(y.StarsTechnique);return i.compiled?(r.bindTechnique(i,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(b.PrimitiveType.POINTS,0,this._numPoints),t):(this.requestRender(1),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/P,function(e,t,r,i){const s=y.layout.createBuffer(i),n=s.position,o=s.color,a=s.size;for(let e=0;e<i;e++){const i=t[2*e],s=t[2*e+1];n.set(e,0,-Math.cos(i)*Math.sin(s)),n.set(e,1,-Math.sin(i)*Math.sin(s)),n.set(e,2,-Math.cos(s));const l=x(r[e]),c=w(S[l[1]]);o.set(e,0,255*c[0]),o.set(e,1,255*c[1]),o.set(e,2,255*c[2]),o.set(e,3,255),a.set(e,l[0])}return new _.VertexArrayObject(e,new v.VertexBuffer(e,m.glLayout(y.layout),s.buffer))}(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,r=2*function(e){const t=e,r=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+r)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+r)}(e),i=h.copy(this._passParameters.modelMatrix,C);h.rotateZ(i,i,-r*Math.PI),h.multiply(i,T,i),h.rotateZ(i,i,-t*Math.PI),this.requestRender(1)}_createLoadDataTask(){if(this._starData)return null;const e=i.createTask(async e=>{const{data:t}=await r.fetchAsset("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});!function(e){if(!e)throw new s("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/P;if(t%1!=0||t>5e4||t<5e3)throw new s("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}(t),this._starData=t});return e.promise.catch(e=>{a.isAbortError(e)||n.getLogger(this).error(e)}).then(()=>{this.destroyed||this.requestRender(1)}),e}},e.Stars=t.__decorate([d.subclass("esri.views.3d.webgl-engine.effects.stars.Stars")],e.Stars);const S=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],T=p.fromValues(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),C=p.fromValues(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),P=9;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/stars/StarsTechnique":function(){define(["require","exports","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../support/buffer/InterleavedLayout","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/Stars.glsl","../../../../webgl/NoParameters","../../../../webgl/renderState"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends a.NoParameters{constructor(){super(...arguments),this.modelMatrix=r.create()}}class u extends n.ShaderTechnique{constructor(t,r){super(t,r,new s.ReloadableShaderModule(o.Stars,()=>new Promise((t,r)=>e(["./Stars.glsl"],t,r))),d.locations)}initializePipeline(){return l.makePipelineState({blending:l.unpremultipliedAlphaToPremultipliedAlpha,depthTest:{func:515},colorWrite:l.defaultColorWrite})}}const d=i.newLayout().vec3f("position").vec4u8("color").f32("size").freeze();t.StarPassParameters=c,t.StarsTechnique=u,t.layout=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/Stars.glsl":function(){define(["exports","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","../views/3d/webgl-engine/core/shaderModules/Float4BindUniform","../views/3d/webgl-engine/core/shaderModules/FloatBindUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4PassUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a){"use strict";function l(){const e=new a.ShaderBuilder;return e.attributes.add("position","vec3"),e.attributes.add("color","vec4"),e.attributes.add("size","float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add(new o.Matrix4PassUniform("transform",(e,r)=>function(e,r){const i=24e-8;return t.copy(c,r.camera.projectionMatrix),c[10]=i-1,c[11]=-1,c[14]=(i-2)*r.camera.near,t.multiply(c,c,r.camera.viewMatrix),t.multiply(c,c,e.modelMatrix)}(e,r)),new i.Float4BindUniform("viewport",e=>e.camera.fullViewport),new s.FloatBindUniform("pixelRatio",e=>e.camera.pixelRatio)),e.vertex.main.add(n.glsl`gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;`),e.fragment.main.add(n.glsl`float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);`),e}const c=r.create(),u=Object.freeze(Object.defineProperty({__proto__:null,build:l},Symbol.toStringTag,{value:"Module"}));e.Stars=u,e.build=l})},"esri/views/3d/webgl-engine/lib/CompositingHelper":function(){define(["../../../../chunks/Compositing.glsl","../shaders/CompositingTechnique","../shaders/CompositingTechniqueConfiguration","../../../../chunks/HUDCompositing.glsl","../shaders/HUDCompositingTechnique"],function(e,t,r,i,s){"use strict";return class{constructor(n,o){this._rctx=n,this._techniques=o,this._configuration=new r.CompositingTechniqueConfiguration,this._passParameters=new e.CompositingPassParameters,this._hudParameters=new i.HUDCompositingPassParameters,this._configuration.blitMode=2,this._techniques.precompile(t.CompositingTechnique,this._configuration),this._configuration.hasOpacityFactor=!0,this._techniques.precompile(t.CompositingTechnique,this._configuration),this._configuration.hasOpacityFactor=!1,this._configuration.blitMode=1,this._techniques.precompile(t.CompositingTechnique,this._configuration),this._configuration.blitMode=3,this._techniques.precompile(t.CompositingTechnique,this._configuration),this._techniques.precompile(s.HUDCompositingTechnique)}compositeHUD(e,t){this._hudParameters.texture=t;const r=this._techniques.get(s.HUDCompositingTechnique);this._rctx.bindTechnique(r,e,this._hudParameters),this._rctx.screen.draw()}compositePreMultipliedAlpha(e,t,r=1){this._composite(e,t,2,r)}composite(e,t){this._composite(e,t,1,1)}blitDepthToLinearDepth(e,t){this._composite(e,t,3,1)}_composite(e,r,i,s){this._configuration.blitMode=i,this._configuration.hasOpacityFactor=1!==s,this._passParameters.texture=r,this._passParameters.opacity=s;const n=this._techniques.get(t.CompositingTechnique,this._configuration);this._rctx.bindTechnique(n,e,this._passParameters),this._rctx.screen.draw()}}})},"esri/chunks/HUDCompositing.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n){"use strict";class o extends s.NoParameters{}function a(){const e=new n.ShaderBuilder;return e.include(t.ScreenSpacePass),e.fragment.uniforms.add(new i.Texture2DPassUniform("tex",e=>e.texture)),e.fragment.main.add(r.glsl`fragColor = vec4(1.0 - texture(tex, uv).a);`),e}const l=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:o,build:a},Symbol.toStringTag,{value:"Module"}));e.HUDCompositing=l,e.HUDCompositingPassParameters=o,e.build=a})},"esri/views/3d/webgl-engine/shaders/HUDCompositingTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/DefaultVertexBufferLayouts","../../../../chunks/HUDCompositing.glsl","../../../webgl/renderState"],function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.HUDCompositing,()=>new Promise((t,r)=>e(["./HUDCompositing.glsl"],t,r))),s.Pos2Locations)}initializePipeline(){return o.makePipelineState({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}t.HUDCompositingTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/ObjectAndLayerIdRenderHelper":function(){define(["exports","../../../../core/has","../../../../core/NestedMap","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/buffer/BufferView"],function(e,t,r,i,s){"use strict";e.ObjectAndLayerIdRenderHelper=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new s.BufferViewVec4u8(new ArrayBuffer(4)),this._layerToOidToColor=new r.NestedMap,this._colorToUID=new Map,this._layerViewUidToGraphicsUidToObjectId=new r.NestedMap,this._layerViewUidToLayerId=new Map,this._layerViewUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,r,i,s,n=null,o=null,a=null){e&&t&&r&&i&&(this._layerViewUidToLayerId.set(i,r),this._layerViewUidToPopupEnabled.set(i,s),s&&this._layerViewUidToGraphicsUidToObjectId.set(i,t,{objectId:e,attributeNodeId:n,attributeIndex:o,subLayerId:a}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return i.fromValues(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerViewUid||!e.graphicUid)return this.colorZero;const r=this._layerViewUidToPopupEnabled.get(e.layerViewUid);if(void 0===r)return this.colorZero;if(!1===r)return this.colorZero;const i=this._layerViewUidToGraphicsUidToObjectId.get(e.layerViewUid,e.graphicUid)?.objectId;if(!i)return this.colorZero;let n=this._layerToOidToColor.get(e.layerViewUid,i);if(!n){if(t("enable-feature:objectAndLayerId-screenshot-testing"))n=i;else for(;!n;){const e=Math.floor(16777214*Math.random())+1;this._colorToUID.has(e)||(n=e)}if(n>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerViewUid,i,n),this._colorToUID.set(n,e)}const o=new ArrayBuffer(4);return new DataView(o).setUint32(0,n,!1),new s.BufferViewVec4u8(o)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,r]of this._colorToUID.entries()){const i=this._layerViewUidToGraphicsUidToObjectId.get(r.layerViewUid,r.graphicUid),s=this._layerViewUidToLayerId.get(r.layerViewUid);i&&s&&e.set(t,i.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:i.objectId,lid:s,attrId:i.attributeNodeId,attrIdx:i.attributeIndex,subLayerId:i.subLayerId}:{type:"object-and-layer-id",olid:i.objectId,lid:s})}return e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Renderer":function(){define(["require","exports","../../../../chunks/tslib.es6","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/colorUtils","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/time","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f32","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/Indices","../../webgl","../../environment/atmosphereUtils","../../state/NearFarHeuristic","../../support/debugFlags","../core/FBOCache","../core/renderPasses/RenderPassManager","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/shading/ScreenSpaceConstants","../effects/RenderNodes","../effects/RenderPluginManager","../effects/blit/Blit","../effects/highlight/Highlight","../effects/transparency/OITBlend","./AnimationTimer","./AnimationTimeStep","./BoundingInfo","./DepthRange","./depthRangeUtils","./hudFragmentOpacityParameters","./MainFramebuffer","./RenderContext","./RendererBase","./RenderFeature","./RenderPluginInput","./ShadowAccumulator","./ShadowMap","./SliceHelper","../materials/renderers/MergedRenderer","../parts/renderUtils","../statistics/RendererPerformanceInfo","../../../webgl/enums"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V,U,B,N,k,z,j,G,q,H,W,$,Q,Z,Y,X,J){"use strict";t.Renderer=class extends G.RendererBase{constructor(e,t,r,i,s,a){super({stage:e}),this._techniques=r,this._rctx=i,this._compositingHelper=s,this._requestRender=a,this._pluginsHas={hudElements:!1,water:!1},this.renderPassManager=new M.RenderPassManager,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=v.fromValues(0,0,0,1),this._sliceHelper=new Q,this._blit=null,this._oitblend=null,this.sceneDepthRange=d.signal(B.DepthRange.infinite),this._state=d.signal(2),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new V.AnimationTimeStep,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=d.signal(0),this._lastFrameTime=h.Milliseconds(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new H.RenderPluginInput,this._releaseNormals=e=>{e.some(({name:e})=>"normals"===e)&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this._fboCache=new P.FBOCache(i),this._renderStateFeatures=d.signal(q.setupFeatureDefaults(!o("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new z.MainFramebuffer(this.fboCache),this._performanceInfo=new X.RendererPerformanceInfo(this._rctx),this._shadowMap=new $.ShadowMap(this.fboCache,e.viewingMode),this._shadowAccumulator=new W.ShadowAccumulator(this.fboCache,r,e,e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=t},(t,r,i)=>{const s=e.view.qualitySettings.maximumPixelRatio;t.shadowMap.start(t.camera,r,i,!0,s),this._renderShadowCascades(4,t.shadowMap),t.shadowMap.finish(),t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.contentCamera)},a),this._renderContext=new j.RenderContext(this._rctx,this._shadowMap,r),this._nodes=new I.RenderNodes(this._renderContext),this._plugins=new F.RenderPluginManager({renderContext:this._renderContext,techniques:r,materials:t,requestRender:a,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this._plugins.add(this.renderPassManager),this.addHandles([u.watch(()=>e.view.state.camera,()=>a(),u.syncAndInitial),u.watch(()=>C.debugFlags.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(0):()=>{},a()},u.initial),u.watch(()=>e.view.environment.background?.color,e=>{const t=e?n.unitRGBAFromColor(e):v.ZEROS;_.set(this._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),a()},u.syncAndInitial),u.watch(()=>e.view.state.camera.relativeElevation,e=>this._inGlobeView=(e??1/0)>=O.distanceFadeEnd,u.syncAndInitial),u.watch(()=>this._bindParameters.clouds.fadeFactor,()=>this._bindParameters.fadeLighting(),u.sync),u.watch(()=>this._bindParameters.clouds.data?.state,()=>a(),u.sync),u.watch(()=>e.view.state.highlights,e=>{this._bindParameters.highlights=e,a()},u.initial)])}destroy(){this._gpuTimerHandle=l.removeMaybe(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._shadowAccumulator=null,this._loadEdgeViewTask=l.abortMaybe(this._loadEdgeViewTask),this._edgeView=l.destroyMaybe(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this._fboCache.destroy(),this._fboCache=null,this._plugins.destroy(),this._plugins=null,this._pluginInput=null,this._blit=null,this._oitblend=null,this._compositingHelper=null,this._nodes=null,this._framebuffer=null,this._shadowMap=null,this._renderContext=null,this._performanceInfo=null,U.BoundingInfo.prune(),Z.MergedRenderer.prune(),w.pruneIndexArrays()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}get performanceInfo(){return this._performanceInfo}updateRenderFeatures(e=null,t=!o("disable-feature:high-quality-idle")){this._renderStateFeatures.value=q.setupFeatureDefaults(t,e),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,r){this._renderStateFeatures.mutate(i=>i.set(t,e,r)),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(1)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(5))}get _hasHighlights(){return this._plugins.produces(8,2,4,18,13,14)}hasHighlight(e){return this._plugins.hasHighlight(e)}get _hasHUDHighlights(){return this._plugins.produces(8,13,14)}get hasSSAO(){return(this.stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(4))&&!this._inGlobeView}get hasSMAA(){return this.stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(0)}get fullResolutionAtmosphere(){return this.stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(3)}get fboCache(){return this._fboCache}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=l.releaseMaybe(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=l.releaseMaybe(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=l.releaseMaybe(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=l.releaseMaybe(this._bindParameters.depth),this._bindParameters.hudVisibility=l.releaseMaybe(this._bindParameters.hudVisibility)}get updating(){return this._loadEdgeViewTask&&!this._loadEdgeViewTask.finished||this._edgeView?.updating||this._shadowAccumulator.readyToRun||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=s.createTask(async t=>{const{EdgeView:r}=await new Promise((t,r)=>e(["./edgeRendering/EdgeView"],t,r));c.throwIfAborted(t);const i=this._edgeView=new r({rctx:this._rctx,renderSR:this.stage.view.renderSpatialReference,viewingMode:this.stage.view.stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:(s=this.stage.view.resourceController,e=>s.immediate.schedule(e))});var s;return this.addHandles(u.watch(()=>i.updating,()=>this._requestRender(),u.sync)),this._requestRender(),this._edgeViewCallbacks.forEach(e=>e(i)),this._edgeViewCallbacks.length=0,i})),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),null==this._edgeView?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&g.equals(this._bindParameters.ssr.reprojectionMatrix,y.IDENTITY)}set _reprojectionMatrix(e){i.update(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:t,_bindParameters:r}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){if(null!=e.environment.weather){const t=e.environment.weather;this._bindParameters.weather=t,this._bindParameters.snowCover=!!e.weatherVisible&&null!=t&&"snowy"===t.type&&"enabled"===t.snowCover}const t="virtual"!==e.environment.lighting.type;r.enableFillLights!==t&&(r.enableFillLights=t,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.shadowCast&&this._shadowAccumulator.setOptions(e.shadowCast)}set slice(e){this._sliceHelper.update(e)&&this._requestRender()}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}commit(e,t){return this._isRendering&&console.warn("Renderer.modify called while rendering"),!!super.commit(e,t,this._plugins.context)&&(this.updateHasFlags(),!0)}rendererAdded(e){this._plugins.add(e)}rendererRemoved(e){this._plugins.remove(e)}get occludedRequiresStencil(){return this.occludedRequiresOccludeeStencil||this.occludedRequiresIntegratedMeshStencil}get occludedRequiresOccludeeStencil(){return this._bindParameters.hasOccludees&&!!(8&this.plugins.renderOccludedFlags)}get occludedRequiresIntegratedMeshStencil(){return this._plugins.produces(0,0)&&this._plugins.produces(0,9)}updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(0,...se),e.water=this._plugins.produces(3,19),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,t){this._animationTimer??=new L.AnimationTimer(e.camera,t),this._animationTimer.advance(e.camera,t,this._animationTimeDilation);const r=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?l.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,r,i=!1){try{return this._isRendering=!0,this._render(e,t,r,i)}catch(e){console.error(`Exception during rendering: ${e}`)}finally{this._isRendering=!1}return new Y.RenderSceneResult(this._pluginInput.get(x.RenderCategory.FINAL),null)}_updateHUDOccludedFragmentOpacity(e,t){const{idleOpacity:r,navigatingOpacity:i,maxDelta:s,tiltFadeStart:n,tiltFadeEnd:o,altitudeStart:l,altitudeEnd:c}=k.hudFragmentOpacityParameters,u=this.stage.view,d=u.stateManager.camera,h=u.qualitySettings.fadeDuration,p=2===e?r:i,f=a.clamp((d.tilt-n)/(o-n),0,1),m=a.clamp(((d.position.z??0)-l)/(c-l),0,1),g=a.lerp(a.lerp(1,p,f),1,m),y=this._bindParameters.hudOccludedFragmentOpacity;if(h<=0||y===g||0===this._lastFrameTime||this._lastFrameTime>t)return this._bindParameters.hudOccludedFragmentOpacity=g,void(this._lastFrameTime=t);const _=t-this._lastFrameTime;this._lastFrameTime=t;const b=Math.max(1-r,Math.abs(r-i)),v=Math.min(b*_/h,s);v>=Math.abs(g-y)?this._bindParameters.hudOccludedFragmentOpacity=g:(this._bindParameters.hudOccludedFragmentOpacity=y+Math.sign(g-y)*v,this._requestRender())}_render(e,t,r,i){const s=0===r;this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=s,this._disposeBindBuffers();const{camera:n,contentCamera:o,mode:a,alignPixelEnabled:l}=e;this._state.value=a;const c=this._nodes.produces("magnifier-color"),u=this._nodes.produces(x.RenderCategory.FINAL),d=this._nodes.require("emissive",x.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,x.RenderCategory.COMPOSITE,x.RenderCategory.FINAL)>0&&this._plugins.hasEmissions,h=d?1:0;this._renderContext.time=t,this._renderContext.output=h,this._bindParameters.oitPass=0,this._bindParameters.alignPixelEnabled=l,this._bindParameters.decorations=!i,this._bindParameters.mainDepth=null;const p=!i||!this._sliceHelper.isDecoration;this._bindParameters.slicePlane=p?this._sliceHelper.plane:null,this._bindParameters.viewshedEnabled=this._nodes.produces(x.InternalRenderCategory.VIEWSHED),this._renderOverlay(),n.setGLViewport(this._rctx);const f=this._framebuffer,m=f.initialize(n.fullWidth,n.fullHeight,this._backgroundColor,d);this.hasReflections?(m?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=m):m?.release(),this._ensureBindParametersCamera(n,o),this._updateHUDOccludedFragmentOpacity(a,t),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!i;const g=this._highQualityTransparency&&this._hasTransparentTerrain,y=this._plugins.produces(0,...re);this._precompilePrepasses(),this.performanceInfo.advance(X.PerformanceCategory.PREPARE);const _=this._computeShadowDepthRange(n);this._renderShadowMap(n,this._bindParameters.lighting.mainLight.direction,_),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(_,n,o,!s),this._ensureBindParametersSSR(t),this._precompileShaders(g,y,h),this._renderContext.output=h,f.bind(),this._bindParameters.mainDepth=f.depth.attachment,this._renderOpaque(g),this._renderTransparent(y,g,h),this._shadowMap.disposeMainBuffer(),this._pluginInput.set(x.InternalRenderCategory.FOCUSAREA,this._renderFocusAreaGeometry()),f.update(e=>this._renderNodes(x.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,e)),f.update(e=>this._renderNodes(x.InternalRenderCategory.VIEWSHED,e)),f.update(e=>this._renderNodes(x.InternalRenderCategory.LASERLINES,e)),f.update(e=>this._renderNodes(x.InternalRenderCategory.FOCUSAREA_COLOR,e)),this._pluginInput.release(x.InternalRenderCategory.FOCUSAREA),f.update(e=>this._renderNodes(x.InternalRenderCategory.OCCLUDED,e)),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._renderHighlightShadowMap(n,this._bindParameters.lighting.mainLight.direction,_);const b=2===r?this._renderObjectAndLayerIdColor():null;f.update(e=>this._renderNodes(x.RenderCategory.COMPOSITE,e)),this._shadowMap.disposeOffscreenBuffers();const v=s&&!u&&!(c&&!i),w=this._pluginInput.get(x.RenderCategory.COMPOSITE),S=v?P.defaultWebGLFBO:this.fboCache.acquire(w.fbo.width,w.fbo.height,x.InternalRenderCategory.ANTIALIASING),T=this._nodes.produces(x.InternalRenderCategory.ANTIALIASING)?this._renderNodes(x.InternalRenderCategory.ANTIALIASING,S):this._blitFBO(w,S,!1);let C;this._pluginInput.set(x.InternalRenderCategory.ANTIALIASING,T),this._hasHUDHighlights?(this._renderHUD(1,T,h),C=this._renderNodes(x.InternalRenderCategory.HIGHLIGHTS,T)):(C=this._renderNodes(x.InternalRenderCategory.HIGHLIGHTS,T),this._renderHUD(1,C,h));const M=this._renderNodes(x.InternalRenderCategory.MAGNIFIER,C);return s&&c&&!i&&!u&&this._blitFBO(M),u?(M.attachDepth(f.depth),this._blitFBO(this._renderNodes(x.RenderCategory.FINAL,M)),M.detachDepth()):this._pluginInput.set(x.RenderCategory.FINAL,M),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),f.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),s||(this._releaseFBOs(),this._disposeOffscreenBuffers()),new Y.RenderSceneResult(this._pluginInput.get(x.RenderCategory.FINAL),b)}_precompileShaders(e,t,r){++this._plugins.context.techniques.precompiling,this._renderContext.output=r,this._precompileOpaqueGeometry(),this._nodes.precompile(x.InternalRenderCategory.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,this._renderContext.output=2,this._plugins.precompile(6),this._plugins.precompile(7),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=r,this._plugins.precompile(6),this._plugins.precompile(7),t&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=e)),this._nodes.precompile(x.InternalRenderCategory.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(12),this._plugins.precompile(15),this._precompileHUD(0),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(x.InternalRenderCategory.VIEWSHED,x.InternalRenderCategory.LASERLINES,x.InternalRenderCategory.FOCUSAREA_COLOR,x.InternalRenderCategory.OCCLUDED,x.InternalRenderCategory.ANTIALIASING,x.InternalRenderCategory.HIGHLIGHTS);const i=this._bindParameters;i.highlightMixTexture=i.highlights.length>1?this._rctx.emptyTexture:null,this._precompileHUD(1),this._hasHighlights&&(i.highlights.forEach((e,t)=>{i.highlightLevel=t,this._precompileAllGeometry(8)}),i.highlightLevel=null),i.highlightMixTexture=null,this._nodes.precompile(x.RenderCategory.COMPOSITE,x.InternalRenderCategory.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(8),--this._plugins.context.techniques.precompiling}_renderFocusAreaGeometry(){const e=this._nodes.produce(x.InternalRenderCategory.FOCUSAREA,this._pluginInput);return e&&this.performanceInfo.advance(X.PerformanceCategory.FOCUS_AREA_MASK),e}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;const e=this._renderContext.output;++this._techniques.precompiling;const t=this._framebufferSize;let r=this.fboCache.acquire(t.width,t.height,"olid");return r.acquireDepth(11),r=this._nodes.render(r,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(X.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=e,r}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,r=0===e;if(r||t){const e=r?this.performanceInfo.elapsedTime:0;let i=0;t?i=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const s=Math.max(e,i);this._animationTimestep.frame(s,r)}}readMainDepth(e,t){const{mainDepth:r,camera:i}=this._bindParameters;if(!r)return;const s=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(s.fbo),i.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(v.ZEROS),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,r),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),s.fbo?.readPixels(e[0],e[1],e[2],e[3],6408,J.PixelType.UNSIGNED_BYTE,t),s.release()}readHUDVisibility(e,t,r,i,s){this._bindParameters.hudVisibility?.fbo?.readPixels(e,t,r,i,6408,J.PixelType.UNSIGNED_BYTE,s)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_renderEdges(e){const t=this._edgeView;if(!t?.shouldRender())return;const r=this._framebufferSize,i=this.fboCache.acquire(r.width,r.height,"edges"),s=this._bindParameters.geometryDepth;this.renderToTargets(()=>t.render(this._bindParameters,e),i,s??this._framebuffer.depth,v.ZEROS),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,i.getTexture()),i.release(),this.performanceInfo.advance(1===e?X.PerformanceCategory.OPAQUE_EDGES:X.PerformanceCategory.TRANSPARENT_EDGES)}_renderOverlay(){this._bindParameters.overlay=this.overlay?.render(),this._bindParameters.overlay&&this.performanceInfo.advance(X.PerformanceCategory.OVERLAY)}_renderShadowMap(e,t,r){if(!this.shadowsEnabled)return;const{contentCamera:i}=this._bindParameters,s=this._shadowMap;s.start(e,t,r,this.isFeatureEnabled(6),this.stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(6,this._shadowMap),s.copySnapshot(1),this._renderShadowCascades(5,this._shadowMap)):this._renderShadowCascades(4),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,i),this.performanceInfo.advance(X.PerformanceCategory.SHADOW_MAP)}_renderHighlightShadowMap(e,t,r){if(!this.shadowsEnabled||!this._needsShadowHighlight)return;const{contentCamera:i}=this._bindParameters,s=this._shadowMap;s.start(e,t,r,this.isFeatureEnabled(6),this.stage.view.qualitySettings.maximumPixelRatio),this._renderShadowCascades(5,this._shadowMap),s.moveSnapshot(0),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,i),this.performanceInfo.advance(X.PerformanceCategory.SHADOW_MAP)}_precompileShadowCascades(e){for(const t of this._shadowMap.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e,t=this._shadowMap){t.bindFbo();for(const r of t.cascades)r.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(r.camera,r.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(2)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._shadowAccumulator.active||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const e=this._pluginInput.get("normals");e?(this._pluginInput.set(x.InternalRenderCategory.SSAO,this._renderSSAO()),this._needsDepth?(this._rctx.bindFramebuffer(e.fbo),this._rctx.clear(1024),this._renderGeometryWithoutNormals(2),l.releaseMaybe(this._bindParameters.depth),this._bindParameters.depth=e.obtainDepthTexture(),this.performanceInfo.advance(X.PerformanceCategory.DEPTH)):(e.detachDepth(),this._bindParameters.depth=l.releaseMaybe(this._bindParameters.depth)),this.hasSSAO&&this._pluginInput.release("normals")):this._renderAllGeometryDepth()}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=l.releaseMaybe(this._bindParameters.depth));const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"depth",11);this._rctx.bindFramebuffer(t.fbo),this._rctx.clear(1280),this.renderAllGeometry(2),l.releaseMaybe(this._bindParameters.depth),this._bindParameters.depth=t.obtainDepthTexture(),t.release(),this.performanceInfo.advance(X.PerformanceCategory.DEPTH)}_renderTerrainDepth(e){if(this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,!e)return void(this._bindParameters.terrainDepth=l.releaseMaybe(this._bindParameters.terrainDepth));const t=this._renderContext.output;this._renderContext.output=2;const r=this._framebufferSize,i=this.fboCache.acquire(r.width,r.height,"terrain depth",11);this._rctx.bindFramebuffer(i.fbo),this._rctx.clear(1280),this._renderTransparentTerrain(),l.releaseMaybe(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=i.obtainDepthTexture(),this._renderContext.output=t,i.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=l.releaseMaybe(this._bindParameters.geometryDepth));const t=this._renderContext.output,{width:r,height:i}=this._framebufferSize,s=this.fboCache.acquire(r,i,"geometry depth",11);this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(1280),this._renderOpaqueAndTransparentGeometry(2),this._renderContext.output=t,l.releaseMaybe(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=s.obtainDepthTexture(),s.release()}get _needsShadowDepthRange(){return this._shadowMap.enabled||this._shadowAccumulator.active}_computeShadowDepthRange(e){if(!this._needsShadowDepthRange)return B.DepthRange.zero;const t=N.depthRangeFromScene(e,this._plugins.plugins,this.stage.layers,0);return t.union(this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}updateSceneDepthRange(e){if(!this.stage.view.state.isGlobal)return void(this.sceneDepthRange.value=B.DepthRange.infinite);if((this.stage.view.renderCoordsHelper?.getAltitude(e.eye)??0)<S.innerAtmosphereFadeStart)return void(this.sceneDepthRange.value=B.DepthRange.infinite);const t=e.clone();t.near=T.minNearDistanceInMeters,t.far=1e10;const r=N.depthRangeFromScene(t,this._plugins.plugins,this.stage.layers,1);r.union(this._plugins.queryDepthRange(t)),this.sceneDepthRange.value.far===r.far&&this.sceneDepthRange.value.near===r.near||(this.sceneDepthRange.value=r)}get _normalsRequired(){const e=this._nodes.require("normals",x.RenderCategory.FINAL,x.RenderCategory.COMPOSITE,x.RenderCategory.OPAQUE,x.RenderCategory.TRANSPARENT,x.InternalRenderCategory.VIEWSHED,x.InternalRenderCategory.LASERLINES);return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(3),this._needsDepth&&this._precompileAllGeometry(2),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(5),this._precompileShadowCascades(6),this._precompileShadowCascades(5)):this._precompileShadowCascades(4)),this._shadowAccumulator.active&&this._precompileAllGeometry(4)}_renderNormals(){const e=this._normalsRequired;if(0===e)return;const t=this._framebufferSize,r=this.fboCache.acquire(t.width,t.height,"normals",5);r.acquireDepth(11),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer(v.ZEROS,!0,!0),this._renderGeometryWithNormals(3);const i=this._nodes.optional("normals",x.RenderCategory.FINAL,x.RenderCategory.COMPOSITE,x.RenderCategory.OPAQUE,x.RenderCategory.TRANSPARENT,x.InternalRenderCategory.VIEWSHED);return r.retain(e+i-1),this.performanceInfo.advance(X.PerformanceCategory.NORMALS),r}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return;const t=this._nodes.produce(x.InternalRenderCategory.SSAO,this._pluginInput);return this._bindParameters.ssao=t,t&&this.performanceInfo.advance(X.PerformanceCategory.SSAO),t}_precompileAllGeometry(e){const t=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(6),this._plugins.precompile(7),this._renderContext.output=t}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e,...t){for(const r of t)this._bindParameters.slot=r,e.precompile(this._renderContext)}precompileOccludedSlots(e,t){for(const r of t)this._renderContext.renderOccludedMask=r,this.precompileSlots(e,...ie);this._renderContext.renderOccludedMask=j.defaultRenderOccludedMask}renderSlots(e,...t){for(const r of t)this._bindParameters.slot=r,e.forAll(e=>{const t=e.acquireTechniques(this._renderContext);t&&e.render(this._renderContext,t)})}renderOccludedSlots(e,t){this._renderContext.renderOccludedMask=t,this.plugins.renderOccludedFlags>1&&this._plugins.render(9),this.renderSlots(e,...ie),this._renderContext.renderOccludedMask=j.defaultRenderOccludedMask}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(13)}precompileViewshedShadowMap(){this._precompileAllGeometry(7)}renderViewshedShadowMap(e){const{camera:t,contentCamera:r}=this._bindParameters,i=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(7),this._ensureBindParametersCamera(t,r),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=i}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(...K),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(...ee)}_precompileOpaqueGeometry(){this._plugins.precompile(...te)}_renderOpaqueGeometry(){this._plugins.render(...te)}_renderTransparentGeometry(){this._plugins.render(...re)}get _hasTransparentTerrain(){return this._plugins.produces(0,6)}get _hasTransparentIntegratedMesh(){return this._plugins.produces(this._renderContext.output,7)}_renderTransparentTerrain(){const e=()=>this._plugins.render(6);if(!R.isColorOrColorEmission(this._renderContext.output))return void e();const t=this._framebufferSize,r=this.fboCache.acquire(t.width,t.height,"transparent terrain");return this.renderToTargets(e,r,this._framebuffer.depth,v.ZEROS),r}_renderTransparentIntegratedMesh(){const e=()=>this._plugins.render(7);if(!R.isColorOrColorEmission(this._renderContext.output))return void e();const t=this._framebufferSize,r=this.fboCache.acquire(t.width,t.height,"transparent integrated mesh");return this.renderToTargets(e,r,this._framebuffer.depth,v.ZEROS),r}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,12)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=l.releaseMaybe(this._bindParameters.hudVisibility));const{width:e,height:t}=this._framebufferSize;let r=this._bindParameters.hudVisibility;r?.fbo?.width===e&&r?.fbo?.height===t||(r?.release(),r=this.fboCache.acquire(e,t,"hud visibility",4),this._bindParameters.hudVisibility=r);const i=this._bindParameters.geometryDepth;r.attachDepth(i||this._framebuffer.depth),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(12),r.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(X.PerformanceCategory.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,0===e){const e=()=>this._plugins.render(15),t=this._framebufferSize,r=this.fboCache.acquireDepth(10,t.width,t.height,"line callouts");this.renderToTargets(e,this._framebuffer.color,r,void 0,!0,!0),r.release()}else this._plugins.render(15)}_precompileHUD(e){if(this._precompileHUDOutput(e),this._hasHighlights){const t=this._renderContext.output;this._renderContext.output=8,this._precompileHUDOutput(e),this._renderContext.output=t}}_precompileHUDOutput(e){const t=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=e,this._oitEnabled&&R.isColorOrColorEmission(this._renderContext.output)?(this._bindParameters.oitPass=1,this._plugins.precompile(...se),this._bindParameters.oitPass=2,this._plugins.precompile(...se),this._bindParameters.oitPass=0):this._plugins.precompile(...se),this._bindParameters.hudRenderStyle=t}_renderHUD(e,t,r){if(this._pluginsHas.hudElements){if(this._oitEnabled){const i=this._renderOIT(1,r,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,i.getTexture()),i.release()}else if(this._renderContext.output=r,0===e){const t=()=>this._renderHUDElements(e),r=this._framebufferSize,i=this.fboCache.acquireDepth(10,r.width,r.height,"hud");this.renderToTargets(t,this._framebuffer.color,i,void 0,!0,!0),i.release()}else t.acquireDepth(10),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(0===e?X.PerformanceCategory.HUD_OCCLUDED:X.PerformanceCategory.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(...se)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(5,2)}_renderHighlightPrepass(){if(!this._hasHighlights)return;const{fboCache:e,_rctx:t,_bindParameters:r}=this,i=this._framebufferSize,{highlights:s}=r,n=e.acquire(i.width,i.height,"highlights",s.length>D.maxHighlightsPerChannel?3:1);n.acquireDepth(11),t.bindFramebuffer(n.fbo);const{gl:o}=t;return o.clearBufferuiv(o.COLOR,0,[0,0,0,0]),this._renderContext.output=8,t.bindFramebuffer(n.fbo),D.renderHighlightBuffer(t,e,i,r,()=>this._renderHighlightGeometries()),this.performanceInfo.advance(X.PerformanceCategory.HIGHLIGHTS),n}_renderHighlightGeometries(){this._plugins.render(...ne),this._rctx.clear(256),this._renderHUDElements(2)}_renderShadowAccumulation(e,t,r,i){this._shadowAccumulator.updateDepthRange(e),this._shadowAccumulator.accumulating&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,t,r,i)&&this.performanceInfo.advance(X.PerformanceCategory.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&R.isColorOrColorEmission(this._renderContext.output)?(this._bindParameters.oitPass=1,this._plugins.precompile(...re),this._bindParameters.oitPass=2,this._plugins.precompile(...re),this._bindParameters.oitPass=0):this._plugins.precompile(...re)}_renderOIT(e,t,r=2){const i=1===e,s=this._framebufferSize,n=i?this.fboCache.acquire(s.width,s.height,"oit hud composite"):null,o=i?()=>this._renderHUDElements(r):()=>this._renderTransparentGeometry(),a=this._bindParameters,l=this._renderContext.output;this._renderContext.output=t,a.oitPass=1;const c=n?"oit hud color+alpha":"oit color+alpha",u=this.fboCache.acquire(s.width,s.height,c,8),d=1===t;d&&u.acquireColor(J.ColorAttachment1,8,"oit emissive"),u.acquireColor(d?J.ColorAttachment2:J.ColorAttachment1,7),n||u.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(u.fbo),this._rctx.clearFramebuffer([0,0,0,1]),d&&this._rctx.clearBuffer(1,b.ZEROS),o(),u.detachDepth(),a.oitPass=2;const h=this.fboCache.acquire(s.width,s.height,n?"oit hud front":"oit front");return d&&h.acquireColor(J.ColorAttachment1,8,"oit emissive front"),n?h.acquireDepth(10):h.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(h.fbo),this._rctx.clearFramebuffer(v.ZEROS,!!n),o(),h.detachDepth(),a.oitPass=0,n?(this._rctx.bindFramebuffer(n.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(16384)):this._framebuffer.bind(),this._oitblend??=new E.OITBlend(this._techniques),this._oitblend.blend(this._rctx,u,h,a,d),n?.detachDepth(),h.release(),u.release(),this._renderContext.output=l,n}_renderOpaque(e){const t=this.plugins.produces(0,...te);if(t){this._plugins.render(0,1);const e=this._framebuffer;e.update(e=>this._renderNodes(x.InternalRenderCategory.OPAQUE_TERRAIN,e)),e.bind(),this._plugins.render(2,3)}const r=this._framebuffer;r.update(e=>this._renderNodes(x.RenderCategory.OPAQUE,e,t)),this.fboCache.debugCallback?.(x.RenderCategory.OPAQUE,r.color.fbo),r.update(e=>this._renderNodes(x.InternalRenderCategory.OPAQUE_ENVIRONMENT,e)),this.fboCache.debugCallback?.(x.InternalRenderCategory.OPAQUE_ENVIRONMENT,r.color.fbo),this._renderTerrainDepth(e),this._renderEdges(1)}_renderTransparent(e,t,r){const i=this._framebuffer;i.bind(),this._renderPlugins(20,X.PerformanceCategory.VOXEL),this._renderHiddenTransparentEdges(),e&&(this._oitEnabled?this._renderOIT(0,r):this._renderTransparentGeometry()),i.update(t=>this._renderNodes(x.RenderCategory.TRANSPARENT,t,e)),this.fboCache.debugCallback?.(x.RenderCategory.TRANSPARENT,i.color.fbo),this._renderGeometryDepth(t),this._renderHUDVisibility(),t||this._plugins.render(15),this._renderEdges(0);const s=this._hasTransparentTerrain?this._renderTransparentTerrain():null;s&&(this.performanceInfo.advance(X.PerformanceCategory.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(t?this._renderLineCallouts(0):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,s.getTexture())),this._renderHUD(0,i.color,r))),this._bindParameters.cullAboveTerrain=!1,s&&(i.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,s.getTexture()),s.release(),t&&(this._renderEdges(1),e&&(this._oitEnabled?this._renderOIT(0,r):this._renderTransparentGeometry(),this.performanceInfo.advance(X.PerformanceCategory.TRANSPARENT)),this._renderEdges(0)));const n=this._hasTransparentIntegratedMesh?this._renderTransparentIntegratedMesh():null;n&&(i.bind(),this._compositingHelper.composite(this._bindParameters,n.getTexture()),n.release()),this._bindParameters.ssao=l.releaseMaybe(this._bindParameters.ssao),t&&this._renderLineCallouts(1),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment()}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(X.PerformanceCategory.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(8),this.performanceInfo.advance(X.PerformanceCategory.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(e),this.performanceInfo.advance(t))}_renderNodes(e,t,r=!1){if(t.setName(e),this._pluginInput.set(e,t),!this._nodes.produces(e))return r&&this.performanceInfo.advance(e),t;const i=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),i}_blitFBO(e,t=P.defaultWebGLFBO,r=!0){return this._blit??=new A.Blit(this._techniques),this._blit.blit(this._rctx,e,t,this._bindParameters),this._pluginInput.set(e.name,t),r&&e.release(),t}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=y.IDENTITY:(g.invert(ae,this._bindParameters.camera.viewMatrix),g.invert(oe,this._bindParameters.camera.projectionMatrix),g.multiply(le,ae,oe),g.multiply(le,this._renderContext.lastFrameCamera.viewMatrix,le),g.multiply(le,this._renderContext.lastFrameCamera.projectionMatrix,le),this._reprojectionMatrix=le);const t=this.stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=y.IDENTITY,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,t,r,i){this._bindParameters.updateLighting(e,t,r,i),this._requestRender(1)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(e,t,r,i,s=!1,n=!1){t.attachDepth(r),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(i,s,n),e(),t.detachDepth()}get test(){}},r.__decorate([p.property({readOnly:!0})],t.Renderer.prototype,"fullResolutionAtmosphere",null),r.__decorate([p.property()],t.Renderer.prototype,"_edgeView",void 0),r.__decorate([p.property()],t.Renderer.prototype,"updating",null),t.Renderer=r.__decorate([m.subclass("esri.views.3d.webgl-engine.lib.Renderer")],t.Renderer);const K=[0,1,2,4],ee=[3,5],te=[0,1,2,3],re=[4,5],ie=[2,4,8],se=[16,13,14],ne=[4,5,2,3,6,0,1],oe=y.create(),ae=y.create(),le=y.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/core/libs/gl-matrix-2/factories/vec4f32":function(){define(["exports"],function(e){"use strict";function t(){return new Float32Array(4)}function r(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function i(e,t,r,i){const s=new Float32Array(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s}function s(){return t()}function n(){return i(1,1,1,1)}function o(){return i(1,0,0,0)}function a(){return i(0,1,0,0)}function l(){return i(0,0,1,0)}function c(){return i(0,0,0,1)}const u=s(),d=n(),h=o(),p=a(),f=l(),m=c(),g=Object.freeze(Object.defineProperty({__proto__:null,ONES:d,UNIT_W:m,UNIT_X:h,UNIT_Y:p,UNIT_Z:f,ZEROS:u,clone:r,create:t,fromValues:i,ones:n,unitW:c,unitX:o,unitY:a,unitZ:l,zeros:s},Symbol.toStringTag,{value:"Module"}));e.ONES=d,e.UNIT_W=m,e.UNIT_X=h,e.UNIT_Y=p,e.UNIT_Z=f,e.ZEROS=u,e.clone=r,e.create=t,e.fromValues=i,e.ones=n,e.unitW=c,e.unitX=o,e.unitY=a,e.unitZ=l,e.vec4f32=g,e.zeros=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/FBOCache":function(){define(["exports","../../../../core/Error","../../webgl/ManagedColorAttachment","../../webgl/ManagedDepthTexture","../../webgl/ManagedFBO","./FBOCacheFormats","./FBOPool","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture"],function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(e,t=0){return`${e}.color${t}`}function d(e){return`${e}.depth`}const h=new s("default","default",null,()=>h,()=>h,()=>{});function p(e,t,r){return`${t}x${r}:${e}`}h.release=()=>!1,e.FBOCache=class{constructor(e){this.rctx=e,this._interactive=!1,this._acquired=new Set,this._cache=new o.FBOPool(e.newCache,"FBOCache"),this._depthCache=new o.FBOPool(e.newCache,"DepthAttachmentCache"),this._colorCache=new o.FBOPool(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.()}frameEnd(){const{debugCallback:e}=this;e&&this._acquired.forEach(t=>e(t.name,t.fbo))}get usedMemory(){return Array.from(this._acquired.values()).reduce((e,t)=>e+t.cachedMemory,this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e,this._interactive=e}get interactive(){return this._interactive}acquire(e,r,i,o=5){const c=p(o,e,r);let h=this._cache.pop(c);const{rctx:f}=this;if(h){h.retain(),h.setName(i);const e=h.getAttachment(a.DepthStencilAttachment);e&&(e.name=d(i));const r=h.getAttachment(a.ColorAttachment0);r&&(r.name=u(i,0));const{fbo:s}=h;if(!s)throw new t("renderer","attempt to use a none existing framebuffer");f.temporaryBindFramebufferObject(s,()=>{f.setDrawBuffers([a.ColorAttachment0]),f.unbindTexture(s.colorTexture)})}else{const t=new l.FramebufferObject(f),p=(t,i,s)=>{i??=5;const n=this._acquireColor(i,e,r,s??u(h.name,t-a.ColorAttachment0));return this.rctx.unbindTexture(n.attachment),h.attachColor(n,t),n.release(),h},m=t=>{t??=11;const i=this.acquireDepth(t,e,r,d(h.name));return h.attachDepth(i),i.release(),h},g=()=>{if(!h)return;this.debugCallback?.(h.name,h.fbo),this._acquired.delete(h);const e=n.isDepthFormat(o);e&&null!=h.getAttachment(a.DepthStencilAttachment)||!e&&null!=h.getAttachment(a.ColorAttachment0)?(e?(h.fbo?.invalidateAttachments([a.DepthStencilAttachment]),h.detachAllColors()):(h.fbo?.invalidateAttachments([a.ColorAttachment0]),h.detachAllButColor0()),this._cache.put(h)):h.dispose()};h=new s(c,i,t,p,m,g),n.isDepthFormat(o)?h.acquireDepth(o):h.acquireColor(a.ColorAttachment0,o,i)}return this._trackHandle(h)}acquireDepth(e,t,r,s){const o=p(e,t,r);let a=this._depthCache.pop(o);if(a)a.retain(),a.attachment.setShadowFiltering(!1);else{const s=new c.Texture(this.rctx,{...n.DepthTextureFormats[e],width:t,height:r});a=new i.ManagedDepthTexture(o,s,()=>this._depthCache.put(a))}return a.name=s,a}_acquireColor(e,t,i,s){const o=p(e,t,i);let a=this._colorCache.pop(o);if(a)a.retain();else{const s=new c.Texture(this.rctx,{...n.ColorFormats[e],width:t,height:i});a=new r.ManagedColorAttachment(o,s,()=>this._colorCache.put(a))}return a.name=s,a}_trackHandle(e){return this._acquired.add(e),e}},e.defaultWebGLFBO=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl/ManagedColorAttachment":function(){define(["exports","./ManagedFBOAttachment"],function(e,t){"use strict";class r extends t.ManagedFBOAttachment{constructor(e,t,r){super(e,t,r),this.attachment=t,this.type=2}}e.ManagedColorAttachment=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl/ManagedFBOAttachment":function(){define(["exports","./ManagedFBOResource"],function(e,t){"use strict";class r extends t.ManagedFBOResource{constructor(e,t,r){super(e,r),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get cachedMemory(){return this.attachment.usedMemory}}e.ManagedFBOAttachment=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl/ManagedFBOResource":function(){define(["exports","../../../core/has"],function(e,t){"use strict";e.ManagedFBOResource=class{constructor(e,t){this.key=e,this._free=t,this.incarnation=0,this._refCount=1}retain(e=1){this._refCount+=e}release(){return 0===this._refCount?(console.log(`Releasing already released FBO attachment "${this.name}" in ${(new Error).stack}`),!0):(--this._refCount,0===this._refCount&&(this._free(),!0))}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl/ManagedDepthTexture":function(){define(["exports","./ManagedDepthAttachment"],function(e,t){"use strict";class r extends t.ManagedDepthAttachment{constructor(e,t,r){super(e,t,r),this.attachment=t}}e.ManagedDepthTexture=r,e.isManagedDepthTexture=function(e){return 1===e?.attachment.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl/ManagedDepthAttachment":function(){define(["exports","./ManagedFBOAttachment"],function(e,t){"use strict";class r extends t.ManagedFBOAttachment{constructor(){super(...arguments),this.type=1}}e.ManagedDepthAttachment=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl/ManagedFBO":function(){define(["../../../core/MapUtils","../../../core/maybe","../webgl","./ManagedDepthTexture","./ManagedFBOResource","../../webgl/enums"],function(e,t,r,i,s,n){"use strict";class o extends s.ManagedFBOResource{constructor(e,t,i,s,n,o){super(e,o),this.fbo=i,this.type=0,this._colors=new Map,this._name=r.RenderCategory.COMPOSITE,this.acquireColor=null,this.acquireDepth=null,this._name=t,this.acquireColor=s,this.acquireDepth=n}dispose(){this.fbo?.dispose()}get cachedMemory(){return this.fbo?.usedMemory||0}get numberOfColorAttachments(){return this._colors.size}get name(){return this._name}setName(e){this._name=e}getTexture(e=n.ColorAttachment0){return e===n.DepthStencilAttachment?this.fbo?.depthStencilTexture:this.fbo?.getColorTexture(e)}get depthTexture(){return this.getTexture(n.DepthStencilAttachment)}getAttachment(e=n.ColorAttachment0){return e===n.DepthStencilAttachment?this._depth:this._colors.get(e)}hasAttachment(t){return e.someMap(this._colors,e=>e.name===t)}attachDepth(e){return e?.retain(),this.detachDepth(),e&&this.fbo?.attachDepthStencil(e.attachment),this._depth=e,this}detachDepth(){this.fbo?.detachDepthStencilTexture(),this.fbo?.detachDepthStencilBuffer(),this._depth=t.releaseMaybe(this._depth)}obtainDepthTexture(){const e=this._depth;return i.isManagedDepthTexture(e)?(this.fbo?.detachDepthStencilTexture(),this._depth=null,e):null}attachColor(e,t){return e.retain(),this.detachColor(t),this.fbo?.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){this.fbo?.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),t?.release()}detachAllColors(){this._colors.forEach((e,t)=>this.detachColor(t))}detachAll(){this.detachAllColors(),this.detachDepth()}detachAllColorsBut0(){this._colors.forEach((e,t)=>{t!==n.ColorAttachment0&&this.detachColor(t)})}detachAllButColor0(){this.detachAllColorsBut0(),this.detachDepth()}}return o})},"esri/views/3d/webgl-engine/core/FBOCacheFormats":function(){define(["exports","../../../webgl/enums","../../../webgl/TextureDescriptor","../../../webgl/textureUtils"],function(e,t,r,i){"use strict";const s=new r.TextureDescriptor;s.pixelFormat=6403,s.internalFormat=t.SizedPixelFormat.R8,s.wrapMode=33071;const n=new r.TextureDescriptor;n.pixelFormat=36244,n.internalFormat=t.SizedPixelFormat.R8UI,n.wrapMode=33071,n.samplingMode=9728;const o=new r.TextureDescriptor;o.pixelFormat=33319,o.internalFormat=t.SizedPixelFormat.RG8,o.wrapMode=33071;const a=new r.TextureDescriptor;a.pixelFormat=33320,a.internalFormat=t.SizedPixelFormat.RG8UI,a.wrapMode=33071,a.samplingMode=9728;const l=new r.TextureDescriptor;l.internalFormat=t.SizedPixelFormat.RGBA4,l.dataType=t.PixelType.UNSIGNED_SHORT_4_4_4_4,l.wrapMode=33071;const c=new r.TextureDescriptor;c.wrapMode=33071;const u=new r.TextureDescriptor;u.wrapMode=33071,u.samplingMode=9987,u.hasMipmap=!0,u.maxAnisotropy=8;const d=new r.TextureDescriptor;d.pixelFormat=6403,d.dataType=t.PixelType.HALF_FLOAT,d.internalFormat=t.SizedPixelFormat.R16F,d.samplingMode=9728;const h=new r.TextureDescriptor;h.dataType=t.PixelType.HALF_FLOAT,h.internalFormat=t.SizedPixelFormat.RGBA16F,h.wrapMode=33071;const p=new r.TextureDescriptor;p.pixelFormat=6403,p.dataType=t.PixelType.FLOAT,p.internalFormat=t.SizedPixelFormat.R32F,p.samplingMode=9728;const f={0:s,1:n,2:o,3:a,4:l,5:c,6:u,7:d,8:h,9:p,10:null},m={[t.SizedDepthFormat.DEPTH_COMPONENT16]:t.PixelType.UNSIGNED_SHORT,[t.SizedDepthFormat.DEPTH_COMPONENT24]:t.PixelType.UNSIGNED_INT,[t.SizedDepthFormat.DEPTH_COMPONENT32F]:t.PixelType.FLOAT,[t.SizedDepthStencilFormat.DEPTH24_STENCIL8]:t.PixelType.UNSIGNED_INT_24_8,[t.SizedDepthStencilFormat.DEPTH32F_STENCIL8]:t.PixelType.FLOAT_32_UNSIGNED_INT_24_8_REV},g={11:y(t.SizedDepthStencilFormat.DEPTH24_STENCIL8),10:y(t.SizedDepthFormat.DEPTH_COMPONENT16)};function y(e){const t=new r.TextureDescriptor;return t.pixelFormat=i.isSizedDepthFormat(e)?6402:34041,t.dataType=m[e],t.samplingMode=9728,t.wrapMode=33071,t.internalFormat=e,t.hasMipmap=!1,t.isImmutable=!0,t}e.ColorFormats=f,e.DepthTextureFormats=g,e.format2String={0:"R8",1:"R8UI",7:"R16F",9:"R32F",2:"RG8",3:"RG8UI",5:"RGBA8",4:"RGBA4",6:"RGBA8_MM",8:"RGBA16F",10:"D16",11:"D24S8"},e.isDepthFormat=function(e){return e>=10},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/FBOPool":function(){define(["exports","../../../../core/MemCachePool","../../../../core/PooledArray"],function(e,t,r){"use strict";e.FBOPool=class{constructor(e,i){this._last=new r,this._incarnation=0,this._cache=new t.MemCachePool(e,i)}destroy(){this._last?.forAll(e=>e.dispose()),this._last?.prune(),this._last=null,this._cache.destroy()}set interactive(e){e&&!this._last?this._last=new r:e||(this._last?.forAll(e=>e.dispose()),this._last=null)}clean(){this._last?.filterInPlace(e=>!(e.incarnation<this._incarnation&&(this._cache.put(e.key,e),1)))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find(t=>t.key===e);if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){return this._last?.reduce((e,t)=>e+t.cachedMemory,0)??0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/renderPasses/RenderPassManager":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Logger","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./AllRenderPasses","../util/TwoVectorPosition","../../effects/RenderPlugin","../../lib/DepthRange"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";e.RenderPassManager=class extends f.SyncRenderPlugin{constructor(){super({}),this.produces=new Map([[2,e=>this._produces(e,2)],[4,e=>this._produces(e,4)],[0,e=>this._produces(e,0)],[7,e=>this._produces(e,7)],[9,e=>this._produces(e,9)]]),this._materialPassParameters=new h.MaterialPassParameters,this._shadowPassParameters=new h.ShadowMapPassParameters,this._highlightPassParameters=new h.HighlightPassParameters,this._viewshedPassParameters=new h.ViewshedShadowMapPassParameters,this._systems=new Set}initializeRenderContext(e){this._context=e,this._passes=new h.AllRenderPasses(e)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear(),this._passes=null}register(e){this._systems.add(e)}_produces(e,t){return!!this._invoke(e,t,e=>e.count>0)}prepareRender(e){const{_systems:t,_passes:r}=this;if(0!==t.size&&null!=r){for(const e of Object.values(r))e.prepareSubmit();t.forEach(t=>t.submit(r,e.bind));for(const e of Object.values(r))e.finishSubmit()}}acquireTechniques(e){if(0===this._systems.size)return null;const t=4===e.output||5===e.output||6===e.output?this._shadowPassParameters:7===e.output?this._viewshedPassParameters:8===e.output?this._highlightPassParameters:this._materialPassParameters,r=e.bind;return this._updateParameters(r.camera,t,r.slot),this._materialPassParameters.output=e.output,this._invoke(e.output,e.bind.slot,(t,r)=>t.acquire(r,e.bind))}render(e,t){this._invoke(e.output,e.bind.slot,(r,i)=>r.dispatch(i,e.bind,t))}_invoke(e,t,r){if(null==this._passes)return null;switch(t){case 2:switch(e){case 0:case 1:case 2:case 3:case 9:return r(this._passes.opaque,this._materialPassParameters);case 8:return r(this._passes.highlight,this._highlightPassParameters);case 4:return r(this._passes.shadowMap,this._shadowPassParameters);case 5:return r(this._passes.highlightShadowMap,this._shadowPassParameters);case 6:return r(this._passes.defaultShadowMap,this._shadowPassParameters);case 7:return r(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case 4:switch(e){case 0:case 1:case 2:case 3:case 9:return r(this._passes.transparent,this._materialPassParameters)}break;case 0:switch(e){case 0:case 1:case 2:case 3:case 9:return r(this._passes.integratedMesh,this._materialPassParameters);case 8:return r(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}break;case 7:switch(e){case 0:case 1:return r(this._passes.transparentIntegratedMesh,this._materialPassParameters)}break;case 9:switch(e){case 0:case 1:case 2:case 3:case 9:return r(this._passes.occludedGround,this._materialPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new m.DepthRange;return this._systems.forEach(r=>t.union(r.queryDepthRange(e))),t}get hasEmissions(){let e=!1;return this._systems.forEach(t=>e=t.hasEmissions||e),e}_updateParameters(e,t,r){const i=e.viewInverseTransposeMatrix,s=4===r,n=9===r;u.set(g,i[3],i[7],i[11]),_.set(g),u.copy(t.transformWorldFromViewTH,_.high),u.copy(t.transformWorldFromViewTL,_.low),u.copy(t.slicePlaneLocalOrigin,g),a.fromMat4(t.transformViewFromCameraRelativeRS,e.viewMatrix),c.copy(t.transformProjFromView,e.projectionMatrix),0===t.identifier&&(this._materialPassParameters.transparent=s,this._materialPassParameters.occludedGround=n,a.transpose(y,t.transformViewFromCameraRelativeRS),a.invert(t.transformNormalViewFromGlobal,y))}hasHighlight(e){for(const t of this._systems)if(t.hasHighlight(e))return!0;return!1}},e.RenderPassManager=t.__decorate([o.subclass("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],e.RenderPassManager);const g=d.create(),y=l.create(),_=new p.TwoVectorPosition;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/renderPasses/AllRenderPasses":function(){define(["exports","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./RenderPass","../shaderLibrary/attributes/VertexNormal.glsl"],function(e,t,r,i){"use strict";class s extends i.VertexNormalPassParameters{constructor(){super(...arguments),this.slicePlaneLocalOrigin=t.create(),this.origin=this.slicePlaneLocalOrigin}}class n extends i.VertexNormalDrawParameters{}e.AllRenderPasses=class{constructor(e){const t=e.renderContext.rctx,i=e.techniques;this.opaque=new r.RenderPass(t,i),this.transparent=new r.RenderPass(t,i,1),this.integratedMesh=new r.RenderPass(t,i),this.transparentIntegratedMesh=new r.RenderPass(t,i),this.occludedGround=new r.RenderPass(t,i),this.shadowMap=new r.RenderPass(t,i),this.highlight=new r.RenderPass(t,i),this.highlightIntegratedMesh=new r.RenderPass(t,i),this.highlightShadowMap=new r.RenderPass(t,i),this.viewshedShadowMap=new r.RenderPass(t,i),this.defaultShadowMap=new r.RenderPass(t,i)}},e.DrawParameters=n,e.HighlightPassParameters=class extends s{constructor(){super(...arguments),this.identifier=2}},e.MaterialPassParameters=class extends s{constructor(){super(...arguments),this.identifier=0,this.output=0,this.transparent=!1,this.occludedGround=!1}},e.PassParameters=s,e.ShadowMapPassParameters=class extends s{constructor(){super(...arguments),this.identifier=1}},e.ViewshedShadowMapPassParameters=class extends s{constructor(){super(...arguments),this.identifier=3}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/renderPasses/RenderPass":function(){define(["exports","../../../../../core/PooledArray","../../../../webgl/enums"],function(e,t,r){"use strict";const i=new Map;i.set(r.DataType.UNSIGNED_BYTE,1),i.set(r.DataType.UNSIGNED_SHORT,2),i.set(r.DataType.UNSIGNED_INT,4),e.RenderPass=class{constructor(e,r,i=0){this._rctx=e,this._techniques=r,this._sorting=i,this._draws=new t({allocator:e=>e??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,r,i,s){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=r,n.material=e,n.depthSquaredHint=i,n.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,n.highlightName=s}acquire(e,t){return this._draws.map(r=>r.material.acquireTechnique(this._techniques,e,t,r.geometry.parameters))}dispatch(e,t,r){const s=this._rctx;this._previouslyBoundDraw.clear();let n=null;const o=this._draws.length,a=t.highlight?.name;for(let l=0;l<o;l++){const o=this._draws.data[l];if(2===e.identifier){const e=o.highlightName;if(e){if(e!==a)continue}else if(!a||!t.overlay?.hasHighlight(a))continue}const c=r[l];c===n&&0===t.oitPass||(s.bindTechnique(c,t,e),n=c);const{geometryRanges:u,indexType:d,geometry:h,material:p}=o;s.bindVAO(h.vao),this._previouslyBoundDraw.get(c)!==p&&(c.program.bindDraw(t,e,p),this._previouslyBoundDraw.set(c,p));const f=u.length,{primitiveType:m}=h;for(let e=0;e<f;e+=2){const t=u[e],r=u[e+1];if(0!==d){const e=i.get(d);s.drawElements(m,r,d,t*e)}else s.drawArrays(m,t,r)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort((t,r)=>e*(t.depthSquaredHint-r.depthSquaredHint)||t.geometry.vao.usedMemory-r.geometry.vao.usedMemory)}get count(){return this._draws.length}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/RenderNodes":function(){define(["exports","../../../../core/Logger","../../../../core/PooledArray","../../webgl/utils","../core/FBOCache"],function(e,t,r,i,s){"use strict";e.RenderNodes=class{constructor(e){this._context=e,this._nodes=new r}destroy(){this._nodes.forEach(e=>e.destroy()),this._nodes.prune()}add(e){this._nodes.push(e)}remove(e){this._nodes.remove(e)}produces(e){return this._nodes.some(({produces:t})=>t===e)}require(e,...t){const r=this._nodes,i=t=>r.reduce((r,{consumes:i,produces:s})=>r+(!i.required.includes(e)||null!=t&&s!==t?0:1),0);return 0===t.length?i():t.reduce((e,t)=>e+i(t),0)}optional(e,...t){const r=this._nodes,i=t=>r.reduce((r,{consumes:i,produces:s})=>r+(!i.optional?.includes(e)||null!=t&&s!==t?0:1),0);return 0===t.length?i():t.reduce((e,t)=>e+i(t),0)}updateAnimation(e){return this._nodes.reduce((t,r)=>r.updateAnimation(e)||t,!1)}precompile(...e){++this._context.techniques.precompiling;for(const t of e)this._nodes.forEach(e=>{e.produces===t&&e.precompile()});--this._context.techniques.precompiling}render(e,t,r=()=>{}){return this._render(e,t,r)??(i.isManagedFBO(e)?e:s.defaultWebGLFBO)}produce(e,t,r=()=>{}){return this._render(e,t,r)}_render(e,r,i=()=>{}){const s="string"==typeof e?e:e.name,n=this._nodes.filter(({produces:e})=>e===s);if(0===n.length)return;let o="string"==typeof e?null:e;return n.some(e=>{const n=o?[o]:[],a=null==o;for(const t of e.consumes.required){if(t===s){if(a)return!1;continue}const e=r.get(t);if(e)n.push(e);else if("emissive"!==t||!r.get(s)?.hasAttachment(t))return i?.(n),!1}if(e.consumes.optional)for(const t of e.consumes.optional){if(t===s)continue;const e=r.get(t);e&&n.push(e)}try{const i=e.doRender(n);i&&i!==o&&(s!==i.name&&(t.getLogger(e).errorOnce(`RenderNode produced ${i.name}, expected ${s}`),i.setName(s)),o?.release(),o=i,r.set(s,o))}catch(r){t.getLogger(e).errorOnce(r)}return i?.(n),a&&null!=o}),this._context.rctx.enforceState(),o}requireGeometryDepth(){return this._nodes.some(e=>"disabled"!==e.produces&&e.requireGeometryDepth)}get test(){return{nodes:this._nodes}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl/utils":function(){define(["exports"],function(e){"use strict";e.isManagedFBO=function(e){return e.name},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/RenderPluginManager":function(){define(["exports","../../../../core/arrayUtils","../../../../core/has","../../../../core/promiseUtils","../../../../core/signal","../lib/DepthRange"],function(e,t,r,i,s,n){"use strict";const o=[2,4,18,13,14];e.RenderPluginManager=class{constructor(e){this.context=e,this._renderPlugins=new Array,this._slots=new Array,this._version=s.signal(0);for(let e=0;e<21;++e)this._slots[e]=[]}destroy(){this._renderPlugins.forEach(e=>e.destroy()),this._renderPlugins.length=0}get plugins(){return this._renderPlugins}add(e,t){const r=()=>{if(t?.aborted)throw e.uninitializeRenderContext(),i.createAbortError();this._renderPlugins.push(e),e.produces.forEach((t,r)=>this._slots[r].push(e)),this.context.requestRender(),this._version.value++},s=e.initializeRenderContext(this.context,t);if(i.isPromiseLike(s))return s.then(r);r()}remove(e){t.removeUnordered(this._renderPlugins,e),e.uninitializeRenderContext();for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter(t=>t!==e);this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forEach(e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)})}updateAnimation(e){let t=!1;return this._renderPlugins.forEach(r=>t=r.updateAnimation?.(e)||t),t}precompile(...e){++this.context.techniques.precompiling;const t=this.context.renderContext.bind.slot;for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender(()=>{});this.context.renderContext.bind.slot=t,--this.context.techniques.precompiling}render(...e){for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender((e,t)=>e.render(this.context.renderContext,t))}_forEachRender(e){const t=this.context.renderContext.bind.slot,r=this.context.renderContext.output;this._slots[t].forEach(i=>{const s=i.produces.get(t);if(!s?.(r)||i.isDecoration&&!this.context.renderContext.bind.decorations)return;const n=i.acquireTechniques(this.context.renderContext);n&&e(i,n)})}queryDepthRange(e){const t=new n.DepthRange;return this._renderPlugins.forEach(r=>{const i=r.queryDepthRange?.(e);t.union(i)}),t}get updating(){return this._version.value>=0&&this._renderPlugins.some(e=>e.readyToRun)}produces(e,...t){return t.some(t=>this._slots[t].some(r=>{const i=r.produces.get(t);return!!i&&i(e)}))}consumes(e){return this._renderPlugins.some(t=>t.consumes().required.includes(e))}hasHighlight(e){return o.some(t=>this._slots[t].some(t=>t.hasHighlight(e)))}get hasDecorations(){return this._renderPlugins.some(e=>e.isDecoration)}get hasOccludees(){return this._renderPlugins.some(e=>e.hasOccludees)}get hasEmissions(){return this._renderPlugins.some(e=>e.hasEmissions)}get renderOccludedFlags(){return this._renderPlugins.reduce((e,t)=>e|(t.renderOccludedFlags??0),0)}get usedMemory(){return this._renderPlugins.reduce((e,t)=>t.material?e:e+(t.usedMemory??0),0)}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/transparency/OITBlend":function(){define(["exports","../../../../../chunks/OITBlend.glsl","./OITBlendTechnique","./OITBlendTechniqueConfiguration","../../../../webgl/enums"],function(e,t,r,i,s){"use strict";e.OITBlend=class{constructor(e){this._techniques=e,this._parameters=new t.OITBlendPassParameters,this._configuration=new i.OITBlendTechniqueConfiguration,e.precompile(r.OITBlendTechnique,this._configuration),this._configuration.hasEmission=!0,e.precompile(r.OITBlendTechnique,this._configuration)}blend(e,t,i,n,o){this._parameters.colorTexture=t.getTexture(),o&&(this._parameters.emissionTexture=t.getTexture(s.ColorAttachment1),this._parameters.emissionFrontFaceTexture=i.getTexture(s.ColorAttachment1)),this._parameters.alphaTexture=t.getTexture(o?s.ColorAttachment2:s.ColorAttachment1),this._parameters.frontFaceTexture=i.getTexture(),this._configuration.hasEmission=o;const a=this._techniques.get(r.OITBlendTechnique,this._configuration);e.bindTechnique(a,n,this._parameters),e.screen.draw()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/OITBlend.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n){"use strict";class o extends s.NoParameters{}function a(e){const s=new n.ShaderBuilder;s.include(t.ScreenSpacePass);const o=e.hasEmission,a=s.fragment;return a.uniforms.add(new i.Texture2DPassUniform("colorTexture",e=>e.colorTexture),new i.Texture2DPassUniform("alphaTexture",e=>e.alphaTexture),new i.Texture2DPassUniform("frontFaceTexture",e=>e.frontFaceTexture)),s.outputs.add("fragColor","vec4",0),o&&(s.outputs.add("fragEmission","vec4",1),a.uniforms.add(new i.Texture2DPassUniform("emissionTexture",e=>e.emissionTexture)),a.uniforms.add(new i.Texture2DPassUniform("emissionFrontFaceTexture",e=>e.emissionFrontFaceTexture))),a.main.add(r.glsl`
      float srcAlpha = texture(alphaTexture, uv).r;
      if(srcAlpha == 0.0){
        fragColor = vec4(0.0);
        ${r.If(o,"fragEmission = vec4(0.0);")}
        return;
      }

      vec4 srcColor = texture(colorTexture, uv);
      vec4 frontFace = texture(frontFaceTexture, uv);

      vec4 transparentColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);
      fragColor = transparentColor;

      ${r.If(o,"vec4 emission = texture(emissionTexture, uv);\n         vec4 emissionFrontFace = texture(emissionFrontFaceTexture, uv);\n        fragEmission = vec4(mix(emission.rgb / srcAlpha, emissionFrontFace.rgb, emissionFrontFace.a), emissionFrontFace.a);")}
    `),s}const l=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:o,build:a},Symbol.toStringTag,{value:"Module"}));e.OITBlend=l,e.OITBlendPassParameters=o,e.build=a})},"esri/views/3d/webgl-engine/effects/transparency/OITBlendTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/OITBlend.glsl","../../lib/DefaultVertexBufferLayouts","../../../../webgl/enums","../../../../webgl/renderState"],function(e,t,r,i,s,n,o,a){"use strict";class l extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.OITBlend,()=>new Promise((t,r)=>e(["./OITBlend.glsl"],t,r))),n.Pos2Locations)}initializePipeline(e){return a.makePipelineState({blending:a.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:a.defaultColorWrite,drawBuffers:e.hasEmission?{buffers:[o.ColorAttachment0,o.ColorAttachment1]}:{buffers:[o.ColorAttachment0]}})}}t.OITBlendTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/transparency/OITBlendTechniqueConfiguration":function(){define(["exports","../../../../../chunks/tslib.es6","../../core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.hasEmission=!1}}t.__decorate([r.parameter()],i.prototype,"hasEmission",void 0),e.OITBlendTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/AnimationTimer":function(){define(["exports","../../../../core/time"],function(e,t){"use strict";e.AnimationTimer=class{constructor(e,r){this._camera=e,this._dt=t.Milliseconds(0),this._time=t.Milliseconds(0),this._lastUpdate=t.Milliseconds(0),this._lastUpdate=r,this._time=r}advance(e,r,i){const s=t.Milliseconds(r-this._lastUpdate);this._dt=t.Milliseconds(s/i),this._time=t.Milliseconds(this._time+s),this._lastUpdate=r,this._camera=e}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/AnimationTimeStep":function(){define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/time"],function(e,t,r,i){"use strict";const s=i.Milliseconds(12e4),n=i.Milliseconds(1e4),o=i.Milliseconds(1e3),a=i.Milliseconds(1e3/30);e.AnimationTimeStep=class{constructor(){this._step=o,this._dilation=1,this._firstIdleTime=i.Milliseconds(0)}frame(e,l){if(l?0===this._firstIdleTime&&(this._firstIdleTime=i.Milliseconds(performance.now())):this._firstIdleTime=i.Milliseconds(0),t("disable-feature:high-quality-idle"))this._dilation=1;else{const e=l?performance.now()-this._firstIdleTime:0;if(e>=s+n)return this._step=i.Milliseconds(1/0),void(this._dilation=1);this._dilation=e>=s?10:1}const c=r.clamp(e/.5,o,a);this._step===1/0?this._step=i.Milliseconds(c):this._step=i.Milliseconds(.9*this._step+c*(1-.9))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=i.Milliseconds(0)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/depthRangeUtils":function(){define(["exports","../../../../core/PooledArray","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/frustum","../../../../chunks/sphere","../../support/mathUtils","./DepthRange","./Util"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(e,t,i){if(!i.visible)return;if(!a.intersectsSphere(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const s=i.transformation,n=w;i.geometries.forEach(i=>{r.multiply(n,s,i.transformation);const o=c.maxScale(n);p(e,t,i.boundingInfo,n,o)})}function p(e,t,r,i,n){if(null==r)return;s.transformMat4(l.getCenter(v),r.center,i);const{eye:o,viewForward:c}=t,u=c[0]*(v[0]-o[0])+c[1]*(v[1]-o[1])+c[2]*(v[2]-o[2]);if(v[3]=r.radius*n,!(u-v[3]>e.near&&u+v[3]<e.far)&&a.intersectsSphere(t.frustum,v))if(r.radius>100&&r.getChildren())for(const s of r.getChildren())p(e,t,s,i,n);else C.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,i,r.bbMin,r.bbMax)}function f(e,t,r){const i=t.eye,s=t.viewForward,n=(r[0]-i[0])*s[0]+(r[1]-i[1])*s[1]+(r[2]-i[2])*s[2];e.near=Math.min(e.near,n-r[3]),e.far=Math.max(e.far,n+r[3])}class m{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new u.DepthRange(0,0)}compute(e,t,r){this._reset();const{viewMatrix:i}=e;t.forEach(e=>{e.forEachGeometry(e=>{if(!e.visible||0===r&&!e.castShadow)return;const t=e.boundingSphere,s=i[2]*t[0]+i[6]*t[1]+i[10]*t[2]+i[14],n=s-t[3],o=s+t[3];this._geometries.push(e),this._near.push(-o),this._far.push(-n)})});const s=new u.DepthRange;if(0===this._geometries.length)return s;for(let e=0;e<this._geometries.length;++e)this._near[e]>s.far&&(s.far=this._near[e]),this._near[e]>2&&this._far[e]<s.near&&(s.near=this._far[e]);const n=this._looseRange;n.near=Math.max(.5*s.near,2),n.far=2*s.far;let o=0,a=0;for(let e=0;e<this._geometries.length;++e)this._near[e]<s.near&&(this._near[e]>=n.near?s.near=this._near[e]:this._nearCandidates[o++]=e),this._far[e]>s.far&&(this._far[e]<=n.far?s.far=this._far[e]:this._farCandidates[a++]=e);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return s;this._nearCandidates.sort((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0),this._farCandidates.sort((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0);for(let t=0;t<this._nearCandidates.length;++t){const r=this._nearCandidates[t];if(this._near[r]<s.near){const t=this._geometries[r],{boundingInfo:i,shaderTransformation:n}=t;this._includeNearBoundingInfoRec(e,i,n,s)}}for(let t=0;t<this._farCandidates.length;++t){const r=this._farCandidates[t];if(this._far[r]>s.far){const t=this._geometries[r],{boundingInfo:i,shaderTransformation:n}=t;this._includeFarBoundingInfoRec(e,i,n,s)}}return this._reset(),s}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(e,t){const r=l.getCenter(e),i=l.getRadius(e);return t[0][0]*r[0]+t[0][1]*r[1]+t[0][2]*r[2]+t[0][3]>i||t[1][0]*r[0]+t[1][1]*r[1]+t[1][2]*r[2]+t[1][3]>i||t[2][0]*r[0]+t[2][1]*r[1]+t[2][2]*r[2]+t[2][3]>i||t[3][0]*r[0]+t[3][1]*r[1]+t[3][2]*r[2]+t[3][3]>i}_includeNearBoundingInfoRec(e,t,r,i){if(null==t)return;const n=t.center;s.transformMat4(l.getCenter(v),n,r),v[3]=t.radius*c.maxScale(r);const{frustum:o}=e;if(this._isOutsideSidePlanes(v,o))return;const a=v[0],u=v[1],d=v[2],h=v[3],{viewMatrix:p}=e,f=p[2]*a+p[6]*u+p[10]*d+p[14],m=f+h;if(!(-(f-h)<2||-m>=i.near))if(-m>this._looseRange.near)i.near=-m;else{if(h>100){const s=t.getChildren();if(void 0!==s){for(const t of s)this._includeNearBoundingInfoRec(e,t,r,i);return}}C.unionDepthRangeWithAABB(i,e.viewProjectionMatrix,r,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(e,t,r,i){if(null==t)return;const n=t.center;s.transformMat4(l.getCenter(v),n,r),v[3]=t.radius*c.maxScale(r);const{frustum:o}=e;if(this._isOutsideSidePlanes(v,o))return;const[a,u,d,h]=v,{viewMatrix:p}=e,f=p[2]*a+p[6]*u+p[10]*d+p[14]-h;if(!(-f<=i.far))if(-f<this._looseRange.far)i.far=-f;else{if(h>100){const s=t.getChildren();if(void 0!==s){for(const t of s)this._includeFarBoundingInfoRec(e,t,r,i);return}}C.unionDepthRangeWithAABB(i,e.viewProjectionMatrix,r,t.bbMin,t.bbMax)}}}function g(e,t,r){let i=[e,t,r];for(let e=0;e<4;++e){const t=i;i=[];for(let r=0;r<t.length;++r){const s=t[r],n=t[(r+1)%t.length];y(n,e)?(y(s,e)||i.push(_(s,n,e)),i.push(n)):y(s,e)&&i.push(_(s,n,e))}}return i}function y(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void d.assert(!1)}function _(e,t,r){let i=0;return 0===r?i=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?i=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?i=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(i=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),n.lerp(o.create(),e,t,i)}const b=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],v=l.create(),w=i.create(),x=new u.DepthRange,S=new class{constructor(){this._items=new t({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,r=e.viewForward;this._items.forAll(e=>{const i=e.object.boundingVolumeWorldSpace.bounds,s=(i[0]-t[0])*r[0]+(i[1]-t[1])*r[1]+(i[2]-t[2])*r[2];e.distance=s,e.near=s-i[3],e.far=s+i[3]}),this._items.sort((e,t)=>e.distance-t.distance)}forEachInDepthRange(e,t,r){if(1===t)for(let t=0;t<this._items.length;++t){const i=this._items.data[t];i.far<e.near||i.near>e.far||r(i.object,i.near,i.far)}else for(let t=this._items.length-1;t>=0;--t){const i=this._items.data[t];i.far<e.near||i.near>e.far||r(i.object,i.near,i.far)}}},T=new m,C=new class{constructor(){this._modelViewProj=i.create(),this._clipPosition=[o.create(),o.create(),o.create(),o.create(),o.create(),o.create(),o.create(),o.create()]}unionDepthRangeWithAABB(e,t,i,s,n){const o=this._modelViewProj;r.multiply(o,t,i);let a=!1;for(let e=0;e<8;++e){const t=this._clipPosition[e],r=0===e||3===e||4===e||7===e?s[0]:n[0],i=0===e||1===e||4===e||5===e?s[1]:n[1],a=e<4?s[2]:n[2];t[0]=o[0]*r+o[4]*i+o[8]*a+o[12],t[1]=o[1]*r+o[5]*i+o[9]*a+o[13],t[2]=o[2]*r+o[6]*i+o[10]*a+o[14],t[3]=o[3]*r+o[7]*i+o[11]*a+o[15]}for(let t=0;t<12;++t){const r=g(this._clipPosition[b[t][0]],this._clipPosition[b[t][1]],this._clipPosition[b[t][2]]);let i=!0;for(let e=0;e<r.length;++e)if(r[e][3]>=2){i=!1;break}if(!i){a=!0;for(let t=0;t<r.length;++t){const i=r[t][3];Number.isFinite(i)&&(e.near=Math.min(i,e.near),e.far=Math.max(i,e.far))}}}return a}};e.DepthRangeFromRenderGeometries=m,e.depthRangeFromScene=function(e,t,r,i){let s=0;if(!t.some(e=>!!e.material&&(s+=e.numGeometries,s>=1e4)))return T.compute(e,t,i);const n=new u.DepthRange;return r.forEach(t=>n.union(function(e,t){if(!t.visible)return;const r=new u.DepthRange,i=t.getSpatialQueryAccelerator();return i?function(e,t,r){const{eye:i,viewForward:s,frustum:n}=t,o=e=>e.visible,a=r.objectCount;if(a<500)x.set(t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(i,s,1,x,(r,i)=>{h(e,t,r),x.far=e.near,i.setRange(x)},n,o),x.set(Math.max(e.far,t.near),t.far),r.forEachInDepthRange(i,s,-1,x,(r,i)=>{h(e,t,r),x.near=e.far,i.setRange(x)},n,o);else{const i=Math.max(Math.min(a,500),Math.ceil(.1*a)),l=r.findClosest(s,1,n,o,i),c=r.findClosest(s,-1,n,o,i);l&&c&&(f(e,t,l.boundingVolumeWorldSpace.bounds),f(e,t,c.boundingVolumeWorldSpace.bounds))}}(r,e,i):function(e,t,r){S.clear(),r.forEach(e=>{e.visible&&0!==e.geometries.length&&S.add(e)}),S.empty||(S.sort(t),x.set(t.near,Math.min(e.near,t.far)),S.forEachInDepthRange(x,1,(r,i)=>{i<e.near&&h(e,t,r)}),x.set(Math.max(e.far,t.near),t.far),S.forEachInDepthRange(x,-1,(t,r,i)=>{e.far=Math.max(e.far,i)}))}(r,e,t.objects),r}(e,t))),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/hudFragmentOpacityParameters":function(){define(["exports"],function(e){"use strict";e.hudFragmentOpacityParameters={idleOpacity:.8,navigatingOpacity:.4,maxDelta:.1,tiltFadeStart:20,tiltFadeEnd:30,altitudeStart:1e4,altitudeEnd:2e4},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/MainFramebuffer":function(){define(["exports","../../../../core/maybe","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f32","../../../../core/libs/gl-matrix-2/factories/vec4f64","./BindParameters","../../../webgl/enums","../../../webgl/FramebufferObject"],function(e,t,r,i,s,n,o,a){"use strict";e.MainFramebuffer=class{constructor(e){this._fbos=e,this._requiresEmission=!1,this._size=new n.ViewportSize(0,0),this._clearColor=s.create()}dispose(){this._color=t.releaseMaybe(this._color),this.releaseDepth()}initialize(e,t,i,s){this._size.width=e,this._size.height=t,a.ensureAttachmentMaxSize(this._size,this._fbos.rctx.parameters.maxTextureSize);const n=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=s,r.copy(this._clearColor,i),n}releaseDepth(){this._color?.detachDepth(),this._depth=t.releaseMaybe(this._depth)}update(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}bind(){const{rctx:e}=this._fbos,t=null==this._color;this.color.attachDepth(this.depth),e.bindFramebuffer(this.color.fbo),t&&(e.setClearStencil(0),e.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),e.clear(17664),this._requiresEmission&&e.clearBuffer(1,i.ZEROS))}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"acquired-color").acquireColor(o.ColorAttachment1,8,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"acquired-color")}_acquireDepth(){return this._fbos.acquireDepth(11,this._size.width,this._size.height,"depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??=this._acquireDepth(),this._depth}_ensureColor(){return this._color??=this._acquireColor(),this._color}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/RenderFeature":function(){define(["exports","../../../../core/has","../../../../core/NestedMap"],function(e,t,r){"use strict";e.setupFeatureDefaults=function(e=!t("disable-feature:high-quality-idle"),i=null){const s=new r.NestedMap;return e?(s.set(2,0,"low"!==i),s.set(2,3,"low"!==i),s.set(2,1,!0),s.set(2,4,!0),s.set(2,5,!0),s.set(2,8,!0)):(s.set(0,6,!0),s.set(0,7,!0),s.set(1,6,!0),s.set(1,7,!0)),s.set(2,6,!0),s.set(2,7,!0),s.set(2,2,!0),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/RenderPluginInput":function(){define(["exports"],function(e){"use strict";e.RenderPluginInput=class{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){this._inputs.get(e)?.release()&&this._inputs.delete(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/ShadowAccumulator":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../core/shaderLibrary/shading/ReadShadowMap.glsl","./BindParameters","./DepthRange","./glUtil3D","./ShadowCastRenderer","./ShadowMap","../../../../chunks/ShadowCastAccumulate.glsl","../shaders/ShadowCastAccumulateTechnique","../shaders/ShadowCastAccumulateTechniqueConfiguration","../shaders/ShadowCastClearTechnique","../../../support/Scheduler","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M){"use strict";e.ShadowAccumulator=class extends r{updateDepthRange(e){this._depthRange.equals(e)||(this._depthRange=e)}constructor(e,t,r,i,s,n){super({}),this.fbos=e,this._techniques=t,this._stage=r,this._prepareForShadowMapPass=i,this._renderToShadowMap=s,this._requestRender=n,this._primarySet=new I(new x.ShadowCastAccumulateTechniqueConfiguration(0),()=>this._requestRenderIfEnabled()),this._contextSet=new I(new x.ShadowCastAccumulateTechniqueConfiguration(1),()=>this._requestRenderIfEnabled()),this._passParameters=new f.ReadShadowMapPassParameters,this._depthRange=g.DepthRange.zero,this._previewing=!1,this._shadowAccumulatorKey=Symbol("shadowAccumulator"),this._rctx=e.rctx,this._bindParameters=new m.BindParameters(new b.ShadowMap(e,r.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=y.createQuadVAO(this._rctx),this._accumulationRenderer=new _.ShadowCastRenderer(t,this._rctx,this,n);const o=this._stage.view.resourceController.scheduler;this.addHandles([o.registerTask(T.TaskPriority.SHADOW_ACCUMULATOR,this),a.watch(()=>this._previewing,()=>this._requestRenderIfEnabled(),a.sync),a.watch(()=>2===this._numActive,()=>this._numActiveChanged(),a.sync),a.watch(()=>this._depthRange,()=>this._invalidateAccumulationSets(),a.sync)],this._shadowAccumulatorKey);for(const e of this._accumulationSets())e.precompile(t)}*_accumulationSets(){yield this._primarySet,yield this._contextSet}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=o.disposeMaybe(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=o.disposeMaybe(this._fbo),this._vao=o.disposeMaybe(this._vao);for(const e of this._accumulationSets())e.destroy();this._contextSet=null,this._primarySet=null,this._bindParameters.destroy()}get computedSamples(){return[this._primarySet.progress,this._contextSet.progress]}get shadowCastTexture(){return this._fbo?.colorTexture}get accumulating(){return this.active&&this._previewing||this._refining}get _refining(){return this.active&&!this._doneAccumulating&&!this._previewing}get active(){return null!=this._fbo&&[...this._accumulationSets()].some(e=>e.active)}get canAccumulate(){return null!=this._bindParameters.depth&&this._depthRange!==g.DepthRange.zero&&this._opacityFromElevation>_.shadowCastDisabledElevationThreshold}get _doneAccumulating(){return[...this._accumulationSets()].every(e=>e.doneAccumulating)}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get _numActive(){return[...this._accumulationSets()].reduce((e,t)=>e+(t.active?1:0),0)}get _pixelFormat(){return 2===this._numActive?{pixelFormat:33319,internalFormat:C.SizedPixelFormat.RG8}:{pixelFormat:6403,internalFormat:C.SizedPixelFormat.R8}}get readyToRun(){return this._refining&&this.canAccumulate&&[...this._accumulationSets()].some(e=>e.running)}runTask(e){this._clearBuffersOnAccumulationStart(),this._prepareForShadowMapPass(this._bindParameters);let t=!1;for(const r of this._accumulationSets())this._runTaskForSet(r,e)&&(t=!0);t&&this._requestRender()}_runTaskForSet(e,t){let r=!1;for(;!t.done&&!e.doneAccumulating;)this._accumulateShadow(e),t.madeProgress(),r=!0;return r}renderAccumulation(e,t,r,i){return this._updateCamera(t),this._bindParameters.contentCamera=r,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!(!this.accumulating||!this.canAccumulate)&&(this._previewing||i?(this._clearFramebuffer(),this._reset()):this._clearBuffersOnAccumulationStart(),this._accumulateSetsForRenderFrame(i))}_clearBuffersOnAccumulationStart(){if([...this._accumulationSets()].every(e=>0===e.progress))this._clearFramebuffer();else for(const e of this._accumulationSets())0===e.progress&&this._clearFramebufferForSet(this._fbo,e)}_accumulateSetsForRenderFrame(e){let t=!1;for(const r of this._accumulationSets())this._accumulateSetForRenderFrame(r,e)&&(t=!0);return t&&this._requestRender(),t}_accumulateSetForRenderFrame(e,t){let r=t?e.sampleCount:Math.min(R,e.sampleCount);r-=e.progress;for(let t=0;t<r;++t)this._accumulateShadow(e);return r>0}precompile(){this._accumulationRenderer.precompile()}render(e){this._accumulationRenderer.render(e)}setOptions(e){void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._primarySet.lightDirections=e.lightDirections),void 0!==e.lightDirectionsContext&&(this._contextSet.lightDirections=e.lightDirectionsContext),!0===e.enabled?this._enable():!1===e.enabled&&this._disable(),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){const r=this._primarySet.progress;return!this.active||!this._fbo||r<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,6408,C.PixelType.UNSIGNED_BYTE,O),O[0]/r)}_numActiveChanged(){if(!this._fbo)return;const e=2===this._numActive,t=this._createFBO();t.resize(this._fbo.width,this._fbo.height),e&&(this._clearFramebuffer(t),this._contextSet.reset()),this._fbo.width&&this._fbo.height&&this._rctx.blitFramebuffer(this._fbo,t),this._fbo.dispose(),this._fbo=t,this._requestRender()}_enable(){this._fbo||(this._fbo=this._createFBO(),this._invalidateAccumulationSets())}_createFBO(){const{pixelFormat:e,internalFormat:t}=this._pixelFormat,r=new M.TextureDescriptor;return r.pixelFormat=e,r.internalFormat=t,r.wrapMode=33071,new P.FramebufferObject(this._rctx,r)}_invalidateAccumulationSets(){for(const e of this._accumulationSets())e.reset();this._requestRenderIfEnabled()}_disable(){this._fbo&&(this._fbo=o.disposeMaybe(this._fbo),this._requestRender())}_reset(){for(const e of this._accumulationSets())e.reset()}_clearFramebuffer(e=this._fbo){e&&e.width&&e.height&&(this._rctx.bindFramebuffer(e),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(16384))}_clearFramebufferForSet(e,t){if(!e)return;const r=this._techniques.get(S.ShadowCastClearTechnique,t.configuration);this._rctx.bindFramebuffer(e),this._rctx.bindTechnique(r,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(r.primitiveType,0,this._vao.vertexCount("geometry"))}_accumulateShadow(e){this._renderToShadowMap(this._bindParameters,e.lightDirections[e.progress++],this._depthRange);const t=this._techniques.get(w.ShadowCastAccumulateTechnique,e.configuration);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(t,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,this._vao.vertexCount("geometry"))}_updateCamera(e){const t=this._fbo;if(null==t)return;const r=this._bindParameters.camera;e.equals(r)||r.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-n.smoothstep(_.shadowCastDisableElevationMin,_.shadowCastDisableElevationMax,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}},t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_fbo",void 0),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_depthRange",void 0),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_previewing",void 0),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_accumulationRenderer",void 0),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_refining",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"active",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"canAccumulate",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_doneAccumulating",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_opacityFromElevation",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_numActive",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_pixelFormat",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"readyToRun",null),e.ShadowAccumulator=t.__decorate([d.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],e.ShadowAccumulator);const R=6,O=new Uint8Array(4);class I{constructor(e,t){this.configuration=e,this._notifyChange=t,this._cachedLightDirections=[],this._progress=l.signal(0),this._sampleCount=l.signal(0)}get progress(){return this._progress.value}set progress(e){this._progress.value=e}get sampleCount(){return this._sampleCount.value}get doneAccumulating(){return this.progress>=this.sampleCount}get running(){return this.progress>0}get active(){return this.sampleCount>0}get lightDirections(){return this._cachedLightDirections}set lightDirections(e){const t=this._cachedLightDirections,r=Math.min(v.ShadowCastMaxSamples,e.length);if(!i.sliceEquals(t,0,t.length,e,0,r,h.equals)){t.length=r,this._sampleCount.value=r;for(let i=0;i<r;++i)t[i]=h.copy(t[i]??p.create(),e[i]);this.reset(),this._notifyChange()}}destroy(){this._cachedLightDirections.length=0,this._sampleCount.value=0}reset(){this.progress=0}precompile(e){e.precompile(w.ShadowCastAccumulateTechnique,this.configuration),e.precompile(S.ShadowCastClearTechnique,this.configuration)}}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/ShadowCastRenderer":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec42","./glUtil3D","../../../../chunks/ShadowCastVisualize.glsl","../shaders/ShadowCastVisualizeTechnique","../shaders/ShadowCastVisualizeTechniqueConfiguration"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const f=1/512;e.ShadowCastRenderer=class extends r{constructor(e,t,r,i){super({}),this._techniques=e,this._rctx=t,this._data=r,this._requestRender=i,this._passParameters=new d.ShadowCastVisualizePassParameters(this._data),this._configuration=new p.ShadowCastVisualizeTechniqueConfiguration,this._enabled=!1,this._vao=u.createQuadVAO(t)}dispose(){this._stop(),this._vao=i.disposeMaybe(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile(h.ShadowCastVisualizeTechnique,this._configuration)}render(e){if(!this._showVisualization)return;const[t,r]=this._data.computedSamples;this._passParameters.sampleScale=[t?1/t:0,r?1/r:0];const i=this._techniques.get(h.ShadowCastVisualizeTechnique,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(i,e,this._passParameters),this._rctx.drawArrays(i.primitiveType,0,this._vao.vertexCount("geometry"))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.thresholdColor&&this._setThresholdColor(e.thresholdColor),void 0!==e.gradientColor&&this._setGradientColor(e.gradientColor),void 0!==e.bandedGradientColor&&this._setBandedGradientColor(e.bandedGradientColor),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&(this._data.computedSamples[0]>0||this._data.computedSamples[1]>0)&&this.opacityFromElevation>f}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(e){e!==this._visualization&&(this._configuration.visualization=e,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfEnabled())}_setThresholdColor(e){const t=this._passParameters.thresholdColor;c.exactEquals(e,t)||(c.copy(this._passParameters.thresholdColor,e),this._requestRenderIfEnabled())}_setGradientColor(e){const t=this._passParameters.gradientColor;c.exactEquals(e,t)||(c.copy(this._passParameters.gradientColor,e),this._requestRenderIfEnabled())}_setBandedGradientColor(e){const t=this._passParameters.bandedGradientColor;c.exactEquals(e,t)||(c.copy(this._passParameters.bandedGradientColor,e),this._requestRenderIfEnabled())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}},t.__decorate([s.property()],e.ShadowCastRenderer.prototype,"opacityFromElevation",null),e.ShadowCastRenderer=t.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],e.ShadowCastRenderer),e.shadowCastDisableElevationMax=5e4,e.shadowCastDisableElevationMin=4e4,e.shadowCastDisabledElevationThreshold=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/ShadowCastVisualize.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec2f64","../core/libs/gl-matrix-2/factories/vec4f64","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/BlendColorsPremultiplied.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/CameraSpace.glsl","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","./ShadowCastAccumulate.glsl","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";class f extends h.NoParameters{constructor(e){super(),this._data=e,this.sampleScale=t.create(),this.opacityFromElevation=1,this.gradientColor=r.clone(g),this.thresholdColor=r.clone(y),this.bandedGradientColor=r.clone(_),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}}const m=50/255,g=r.fromValues(0,0,1,.7),y=r.fromValues(1,0,0,.7),_=r.fromValues(m,m,m,.7);function b(e){const t=new p.ShaderBuilder,r=t.fragment;t.include(n.CameraSpace),t.include(i.ScreenSpacePass);const{visualization:h}=e;r.constants.add("inverseSampleValue","float",d.ShadowCastMaxSamples),r.uniforms.add(new u.Texture2DPassUniform("shadowCastMap",e=>e.shadowCastMap),new o.Float2PassUniform("sampleScale",e=>e.sampleScale),new l.FloatPassUniform("opacityFromElevation",e=>e.opacityFromElevation));const f=2===h,m=3===h,g=1===h;switch(m&&r.include(s.BlendColorsPremultiplied),h){case 0:r.uniforms.add(new a.Float4PassUniform("uColor",e=>s.premultiplyAlpha(v,e.gradientColor)));break;case 1:r.uniforms.add(new a.Float4PassUniform("uColor",e=>s.premultiplyAlpha(v,e.bandedGradientColor)),new l.FloatPassUniform("bandSize",e=>e.bandSize));break;case 3:r.uniforms.add(new a.Float4PassUniform("uColor",e=>s.premultiplyAlpha(v,e.thresholdColor)),new a.Float4PassUniform("gradientColor",e=>s.premultiplyAlpha(v,e.gradientColor)),new l.FloatPassUniform("threshold",e=>e.threshold));break;case 2:r.uniforms.add(new a.Float4PassUniform("uColor",e=>s.premultiplyAlpha(v,e.thresholdColor)),new l.FloatPassUniform("threshold",e=>e.threshold))}const{type:y,selector:_,thresholdStrengthSelector:b}=m?{type:"vec2",selector:"rg",thresholdStrengthSelector:"strength.x"}:{type:"float",selector:"r",thresholdStrengthSelector:"strength"};return r.main.add(c.glsl`
    ${y} numSamples = texture(shadowCastMap, uv).${_} * inverseSampleValue;

    fragColor = vec4(0.0);

    // early out if we do not have any samples in one or more channels
    if (dot(numSamples, ${y}(1)) < 1.0) {
      return;
    }

    // sampleScale is the number of total samples taken, so this brings strength to a 0-1 range.
    // note that sampleScale is always a vec2 even if we have only the primary channel.
    ${y} strength = numSamples * sampleScale.${_};

    // in threshold mode, step the strength to 0 if we are at or below the threshold, 1 otherwise.
    ${c.If(f||m,c.glsl`
      ${b} = 1.0 - step(${b}, threshold);
    `)}

    // bail out if we are below the threshold
    ${c.If(f,c.glsl`if (${b} == 0.0) { return; }`)}

    ${c.If(g,c.glsl`strength = ceil(strength / bandSize) * bandSize;`)}

    ${y} attenuation = opacityFromElevation * strength;

    // in ThresholdAndGradient mode we blend the threshold color on top of the gradient color
    fragColor = ${c.If(m,c.glsl`blendColorsPremultiplied(uColor * attenuation.r, gradientColor * attenuation.g)`,c.glsl`uColor * attenuation`)};
  `),t}const v=r.create(),w=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:f,build:b},Symbol.toStringTag,{value:"Module"}));e.ShadowCastVisualize=w,e.ShadowCastVisualizePassParameters=f,e.build=b})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/BlendColorsPremultiplied.glsl":function(){define(["exports"],function(e){"use strict";e.BlendColorsPremultiplied=function(e){e.code.add("\n  vec4 blendColorsPremultiplied(vec4 source, vec4 dest) {\n    float oneMinusSourceAlpha = 1.0 - source.a;\n    return source + dest * oneMinusSourceAlpha;\n  }\n  ")},e.premultiplyAlpha=function(e,t){return e[0]=t[0]*t[3],e[1]=t[1]*t[3],e[2]=t[2]*t[3],e[3]=t[3],e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/ShadowCastAccumulate.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/calculateUVZShadowFromDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ShadowmapFiltering.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DShadowBindUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a){"use strict";const l=1/255;function c(e){const c=new a.ShaderBuilder,{fragment:u}=c;c.include(t.ScreenSpacePass),c.include(r.calculateUVZShadowFromDepthPass),c.include(i.ShadowmapFiltering),u.uniforms.add(new o.Texture2DShadowBindUniform("shadowMap",e=>e.shadowMap.depthTexture),new n.Texture2DBindUniform("depthMap",e=>e.depth?.attachment)),u.constants.add("sampleValue","float",l);const d=1===e.index?"vec2":"float";return c.outputs.add("sampleCount",d),u.main.add(s.glsl`
    sampleCount = ${d}(0.0);

    vec3 uvzShadow = calculateUVZShadowFromDepth(uv, textureSize(shadowMap,0), depthMap);
    if (uvzShadow.z < 0.0) {
      return;
    }

    // The shadow map sampler returns a value between 0 and 1, we take the midpoint as we count discrete samples
    bool shadow = readShadowMapUVZ(uvzShadow, shadowMap) > 0.5;

    if (shadow) {
      sampleCount = ${d}(sampleValue); // Add 1 to the sample count
    }
  `),c}const u=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:255,build:c},Symbol.toStringTag,{value:"Module"}));e.ShadowCastAccumulate=u,e.ShadowCastMaxSamples=255,e.build=c})},"esri/views/3d/webgl-engine/shaders/ShadowCastVisualizeTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/DefaultVertexBufferLayouts","../../../../chunks/ShadowCastVisualize.glsl","../../../webgl/enums","../../../webgl/renderState"],function(e,t,r,i,s,n,o,a){"use strict";class l extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.ShadowCastVisualize,()=>new Promise((t,r)=>e(["./ShadowCastVisualize.glsl"],t,r))),s.Pos2Locations),this.primitiveType=o.PrimitiveType.TRIANGLE_STRIP}initializePipeline(){return a.makePipelineState({blending:a.premultipliedAlpha,colorWrite:a.defaultColorWrite,depthTest:null,depthWrite:null})}}t.ShadowCastVisualizeTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/ShadowCastVisualizeTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.visualization=0}}t.__decorate([r.parameter({count:4})],i.prototype,"visualization",void 0),e.ShadowCastVisualizeTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/ShadowCastAccumulateTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/DefaultVertexBufferLayouts","../../../../chunks/ShadowCastAccumulate.glsl","../../../webgl/enums","../../../webgl/renderState"],function(e,t,r,i,s,n,o,a){"use strict";class l extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.ShadowCastAccumulate,()=>new Promise((t,r)=>e(["./ShadowCastAccumulate.glsl"],t,r))),s.Pos2Locations),this.primitiveType=o.PrimitiveType.TRIANGLE_STRIP}initializePipeline(e){const t={r:0===e.index,g:1===e.index,b:!1,a:!1};return a.makePipelineState({blending:a.add,colorWrite:t,depthTest:null,depthWrite:null})}}t.ShadowCastAccumulateTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/ShadowCastAccumulateTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration"],function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(e){super(),this.index=0,this.index=e}}t.__decorate([r.parameter({count:2})],i.prototype,"index",void 0),e.ShadowCastAccumulateTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/ShadowCastClearTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/DefaultVertexBufferLayouts","../../../../chunks/ShadowCastClear.glsl","../../../webgl/enums","../../../webgl/renderState"],function(e,t,r,i,s,n,o,a){"use strict";class l extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.ShadowCastClear,()=>new Promise((t,r)=>e(["./ShadowCastClear.glsl"],t,r))),s.Pos2Locations),this.primitiveType=o.PrimitiveType.TRIANGLE_STRIP}initializePipeline(e){const t={r:0===e.index,g:1===e.index,b:!1,a:!1};return a.makePipelineState({blending:null,colorWrite:t,depthTest:null,depthWrite:null})}}t.ShadowCastClearTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/ShadowCastClear.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/webgl/ShaderBuilder"],function(e,t,r,i){"use strict";function s(e){const s=new i.ShaderBuilder,{fragment:n}=s;s.include(t.ScreenSpacePass);const o=1===e.index?"vec2":"float",a="value";return s.outputs.add(a,o),n.main.add(r.glsl`${a} = ${o}(0.0);`),s}const n=Object.freeze(Object.defineProperty({__proto__:null,build:s},Symbol.toStringTag,{value:"Module"}));e.ShadowCastClear=n,e.build=s})},"esri/views/3d/webgl-engine/lib/SliceHelper":function(){define(["../../../../chunks/boundedPlane"],function(e){"use strict";const t=e.create();return class{constructor(){this._plane=e.create(),this._isDecoration=!0}get plane(){return this._plane}get isDecoration(){return this._isDecoration}update({plane:r,isDecoration:i}){let s=!1;return this._isDecoration!==i&&(this._isDecoration=i,s=!0),r??=t,e.equals(r,this._plane)?s:(e.copy(r,this._plane),!0)}}})},"esri/views/3d/webgl-engine/statistics/RendererPerformanceInfo":function(){define(["exports","../../../../core/maybe","../../../../core/PerformanceSampler","../../../../core/time","../../webgl","../../../webgl/TimerPool"],function(e,t,r,i,s,n){"use strict";const o={OVERLAY:"overlay",PREPARE:"prepare",SHADOW_MAP:"shadow map",DEPTH:"depth",ACCUMULATED_SHADOWS:"accumulated shadows",APPLY_ACCUMULATED_SHADOWS:"apply accumulated shadows",OBJECT_AND_LAYER_ID_COLOR:"object/layer id color",NORMALS:"normals",SSAO:"SSAO",HIGHLIGHTS:"highlights",OPAQUE_EDGES:"opaque edges",VOXEL:"voxel",TRANSPARENT:"transparent",TRANSPARENT_EDGES:"transparent edges",HUD_VISIBILITY:"HUD visibility",TRANSPARENT_TERRAIN:"transparent terrain",TRANSPARENT_MATERIAL_WITHOUT_DEPTH:"transparent material without depth",OPAQUE_ENVIRONMENT:"opaque environment",TRANSPARENT_ENVIRONMENT:"transparent environment",OCCLUDED:"occluded",HUD:"HUD",HUD_OCCLUDED:"HUD occluded",FINISH:"finish",FOCUS_AREA_MASK:"focus area mask"},a=Object.values(s.RenderCategory).concat(Object.values(s.InternalRenderCategory)).concat(Object.values(o)),l="Total";e.PerformanceCategories=a,e.PerformanceCategory=o,e.RendererPerformanceInfo=class{constructor(e){this._rctx=e,this._startTimeStampCPU=i.Milliseconds(0),this._lastTimeStampCPU=i.Milliseconds(0),this._totalCPUTime=new r(l),this._cpuTimeSamplers=new Map(a.map(e=>[e,new r(e)])),this._enableGPUTimer=0,this._totalGPUTime=new r("GPU"),this._gpuTimeSamplers=new Map(a.map(e=>[e,new r(e)])),this._totalTime=i.Milliseconds(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return null!=this._gpuTimerPool}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return i.Milliseconds(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(null==this._gpuTimerPool){const e=[...a,l];this._gpuTimerPool=n.createElapsedTimerPool(this._rctx,e)}if(null==this._gpuTimerPool)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,0===this._enableGPUTimer&&(this._gpuTimerPool=t.disposeMaybe(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=i.Milliseconds(performance.now()),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach(e=>e.push(0)),this._gpuTimerPool.start())}advance(e){const t=i.Milliseconds(performance.now());if(this._cpuTimeSamplers.get(e).push(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const t=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).set(t),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const e=this._gpuTimerPool.stop(o.FINISH);this._gpuTimeSamplers.get(o.FINISH).set(e),this._rctx.gl.flush()}const e=i.Milliseconds(performance.now()-this._startTimeStampCPU);this._totalTime=i.Milliseconds(this._totalTime+e),this._totalCPUTime.push(e),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce((e,t)=>e+(t.last||0),0)),++this._totalFrameCount}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/TimerPool":function(){define(["exports","./capabilities/DisjointTimerQuery"],function(e,t){"use strict";class r{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach(e=>{const t=this._timer.createQuery(),r=this._timer.createQuery();this._queryPool.push(t,r),this._queryResults.set(e,null)})}start(){t.hasRunningElapsedTimer||(this._currentQuery=this._queryPool.pop(),null!=this._currentQuery&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||null==this._currentQuery||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(null==t)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const r=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,r}abort(){null!=this._currentQuery&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){null!=this._currentQuery&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{null!=e&&this._timer.deleteQuery(e)})}}e.createElapsedTimerPool=function(e,t){const i=e.capabilities.disjointTimerQuery;return null==i?null:new r(i,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/capabilities/DisjointTimerQuery":function(){define(["exports"],function(e){"use strict";class t{constructor(e,t,r,i,s,n,o,a,l){this.createQuery=e,this.deleteQuery=t,this.resultAvailable=r,this.getResult=i,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=o,this.createTimestamp=a,this.timestampBits=l}}e.hasRunningElapsedTimer=!1,e.DisjointTimerQuery=t,e.createDisjointTimerQuery=function(r,i){if(i.disjointTimerQuery)return null;let s=r.getExtension("EXT_disjoint_timer_query_webgl2");return s?new t(()=>r.createQuery(),t=>{r.deleteQuery(t),e.hasRunningElapsedTimer=!1},e=>r.getQueryParameter(e,r.QUERY_RESULT_AVAILABLE),e=>r.getQueryParameter(e,r.QUERY_RESULT),()=>r.getParameter(s.GPU_DISJOINT_EXT),t=>{e.hasRunningElapsedTimer||(e.hasRunningElapsedTimer=!0,r.beginQuery(s.TIME_ELAPSED_EXT,t))},()=>{r.endQuery(s.TIME_ELAPSED_EXT),e.hasRunningElapsedTimer=!1},e=>s.queryCounterEXT(e,s.TIMESTAMP_EXT),()=>r.getQuery(s.TIMESTAMP_EXT,s.QUERY_COUNTER_BITS_EXT)):(s=r.getExtension("EXT_disjoint_timer_query"),s?new t(()=>s.createQueryEXT(),t=>{s.deleteQueryEXT(t),e.hasRunningElapsedTimer=!1},e=>s.getQueryObjectEXT(e,s.QUERY_RESULT_AVAILABLE_EXT),e=>s.getQueryObjectEXT(e,s.QUERY_RESULT_EXT),()=>r.getParameter(s.GPU_DISJOINT_EXT),t=>{e.hasRunningElapsedTimer||(e.hasRunningElapsedTimer=!0,s.beginQueryEXT(s.TIME_ELAPSED_EXT,t))},()=>{s.endQueryEXT(s.TIME_ELAPSED_EXT),e.hasRunningElapsedTimer=!1},e=>s.queryCounterEXT(e,s.TIMESTAMP_EXT),()=>s.getQueryEXT(s.TIMESTAMP_EXT,s.QUERY_COUNTER_BITS_EXT)):null)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/RenderingContext":function(){define(["exports","../../../../core/has","../effects/ScreenSpaceGeometry","./glUtil3D","../materials/renderers/VaoCache","../../../webgl/AppleAmdDriverHelper","../../../webgl/RenderingContext"],function(e,t,r,i,s,n,o){"use strict";class a extends o.RenderingContext{constructor(e,t){super(e,t),this.emptyTexture=i.createEmptyTexture(this),this._vaoCaches=new Map,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=t.newCache,this._screen=new r.ScreenSpaceGeometry(this)}configure(e){super.configure(e),this._newCache=e.newCache}destroy(){this._vaoCaches.forEach(e=>e.dispose()),this._vaoCaches.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}get refCount(){return this._refCount}dispose(){this.emptyTexture.dispose(),this._screen.destroy(),this._screen=null,super.dispose(),this._appleAmdDriverHelper?.dispose(),this._vaoCaches.forEach(e=>e.dispose()),this._vaoCaches.clear()}get newCache(){return this._newCache}get screen(){return this._screen}getVaoCache(e){const t=JSON.stringify(e),r=this._vaoCaches.get(t);if(r)return r;const i=new s.VaoCache(this,e);return this._vaoCaches.set(t,i),i}bindTechnique(e,t,r,i){return this.useProgram(e.program),this.setPipelineState(e.getPipeline()),e.program.bind(t),r&&(e.program.bindPass(r,t),i&&e.program.bindDraw(t,r,i)),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??=new n.AppleAmdDriverHelper(this),this._appleAmdDriverHelper.run())}get isAssumedMetalDriver(){if(null==this._isAssumedMetalDriver&&(this._isAssumedMetalDriver=!!t("ios")||!!t("safari"),!this._isAssumedMetalDriver&&t("mac")&&t("chrome"))){const e=this.capabilities.rendererInfo?.getUnmaskedRenderer().toLowerCase(),t=e?.includes("apple")&&e?.includes("angle")&&e?.includes("metal");this._isAssumedMetalDriver=t??!0}return this._isAssumedMetalDriver}get test(){}}e.RenderingContext=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/effects/ScreenSpaceGeometry":function(){define(["exports","../../../../core/has","../../../../core/maybe","../lib/DefaultVertexBufferLayouts","../lib/VertexArrayObject","../../../webgl/enums","../../../webgl/VertexBuffer"],function(e,t,r,i,s,n,o){"use strict";e.ScreenSpaceGeometry=class{constructor(e){this._rctx=e,this._vao=function(e){const t=new Float32Array([-1,-1,3,-1,-1,3]);return new s.VertexArrayObject(e,new o.VertexBuffer(e,i.Pos2,t))}(e)}destroy(){this._vao=r.disposeMaybe(this._vao)}draw(){null!=this._vao&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(n.PrimitiveType.TRIANGLES,0,3))}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/renderers/VaoCache":function(){define(["exports","../../../../../core/MemCachePool","../../lib/VertexArrayObject","../../../../webgl/VertexBuffer"],function(e,t,r,i){"use strict";e.VaoCache=class{constructor(e,r){this._rctx=e,this._layout=r,this._cache=new t.MemCachePool(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let s=this._cache.pop(t);return s||(s=new r.VertexArrayObject(this._rctx,new i.VertexBuffer(this._rctx,this._layout)),s.buffer()?.setSize(e),s)}deleteVao(e){if(null==e)return;const t=e.getByteLength("geometry").toString();this._cache.put(t,e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/AppleAmdDriverHelper":function(){define(["exports","../../core/has","./BufferObject","./enums"],function(e,t,r,i){"use strict";class s{constructor(e){this._rctx=e,this._indexBuffer=this._createIndexbuffer(),this._program=this._createHelperProgram()}static getShaderSources(){return{vertex:"#version 300 es\n    precision highp float;\n\n    void main(void) {\n      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);\n    }",fragment:"#version 300 es\n    precision highp float;\n\n    out vec4 fragColor;\n\n    void main(void) {\n      fragColor = vec4(0.0, 0.0, 0.0, 1.0);\n    }"}}_createHelperProgram(){const e=s.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}_createIndexbuffer(){return r.BufferObject.createIndex(this._rctx,35044,new Uint32Array([0]))}run(){this._program.compiled&&this._indexBuffer&&(this._rctx.bindVAO(null),this._rctx.useProgram(this._program),this._rctx.bindBuffer(this._indexBuffer,34963),this._rctx.drawElements(i.PrimitiveType.POINTS,1,i.DataType.UNSIGNED_INT,0))}dispose(){this._program.dispose(),this._indexBuffer.dispose()}get test(){}}e.AppleAmdDriverHelper=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/RenderingContext":function(){define(["exports","../../core/has","../../core/maybe","../../core/promiseUtils","../../core/time","./checkWebGLError","./ContextState","./enums","./InstanceCounter","./Parameters","./ProgramCache","./renderState","./Texture","./WebGLDriverTest","./capabilities/Capabilities"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";function m(e,t,r,i){return t?i!==t&&e.bindBuffer(r,t.glName):e.bindBuffer(r,null),t}function g(e,t){switch(e){case a.PrimitiveType.POINTS:return 2*t;case a.PrimitiveType.TRIANGLES:return t/3;case a.PrimitiveType.TRIANGLE_STRIP:case a.PrimitiveType.TRIANGLE_FAN:return t-2;default:return 0}}e.RenderingContext=class{constructor(e,t){this.gl=e,this.instanceCounter=new l.InstanceCounter,this._programCache=new u.ProgramCache(this),this._transformFeedbackRequestInfo=null,this._state=new o.ContextState,this._numOfDrawCalls=0,this._numOfTriangles=0,this._options=t,this.configure(t)}configure(e){this._options=e,this._capabilities=new f.Capabilities(this.gl,e),this._parameters=new c.Parameters(this.gl,this._capabilities,e),h.Texture.TEXTURE_UNIT_FOR_UPDATES=this._parameters.maxTextureImageUnits-1;const t=this.gl.getParameter(this.gl.VIEWPORT);this._state=new o.ContextState,this._state.viewport={x:t[0],y:t[1],width:t[2],height:t[3]},this._stateTracker=new d.StateTracker({setBlending:e=>{if(e){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(e.opRgb,e.opAlpha),this.setBlendFunctionSeparate(e.srcRgb,e.dstRgb,e.srcAlpha,e.dstAlpha);const t=e.color;this.setBlendColor(t.r,t.g,t.b,t.a)}else this.setBlendingEnabled(!1)},setCulling:e=>{e?(this.setFaceCullingEnabled(!0),this.setCullFace(e.face),this.setFrontFace(e.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:e=>{e?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(e.factor,e.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:e=>{e?(this.setDepthTestEnabled(!0),this.setDepthFunction(e.func)):this.setDepthTestEnabled(!1)},setStencilTest:e=>{if(e){this.setStencilTestEnabled(!0);const t=e.function;this.setStencilFunction(t.func,t.ref,t.mask);const r=e.operation;this.setStencilOp(r.fail,r.zFail,r.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:e=>{e?(this.setDepthWriteEnabled(!0),this.setDepthRange(e.zNear,e.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:e=>{e?this.setColorMask(e.r,e.g,e.b,e.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:e=>{e?this.setStencilWriteMask(e.mask):this.setStencilWriteMask(0)},setDrawBuffers:e=>{if(e)this.setDrawBuffers(e.buffers);else{const{drawFramebuffer:e}=this._state;null===e?this.setDrawBuffers([1029]):0===e.colorAttachments.length?this.setDrawBuffers([0]):this.setDrawBuffers([a.ColorAttachment0])}}}),this.enforceState(),r.disposeMaybe(this._driverTest),this._driverTest=new p.WebGLDriverTest(this)}updateOptions(e){this._options={...this._options,...e},this._parameters=new c.Parameters(this.gl,this._capabilities,this._options)}dispose(){this._driverTest=r.disposeMaybe(this._driverTest),this._programCache=r.disposeMaybe(this._programCache),this.bindVAO(null),this.unbindBuffer(34962),this.unbindBuffer(34963),this.unbindBuffer(35345),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(35051),this.unbindBuffer(35052),this.unbindBuffer(36662),this.unbindBuffer(36663),this._state.textureUnitMap.length=0,this._state=null,this._capabilities=null,this._stateTracker=null,n.webglDebugEnabled()&&console.log(this.instanceCounter.resourceInformation)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}get programCache(){return this._programCache}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._state.blend!==e&&(!0===e?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){this._state.program?.stop(),this._state.program=null}externalTextureUnitUpdate(e,t){for(let t=0;t<e.length;++t)this._state.textureUnitMap[e[t]]=null;t>=0&&(this._state.activeTexture=t)}externalVertexArrayObjectUpdate(){this.gl.bindVertexArray(null),this._state.vertexArrayObject=null,this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(e,t,r,i){e===this._state.blendColor.r&&t===this._state.blendColor.g&&r===this._state.blendColor.b&&i===this._state.blendColor.a||(this.gl.blendColor(e,t,r,i),this._state.blendColor.r=e,this._state.blendColor.g=t,this._state.blendColor.b=r,this._state.blendColor.a=i,this._stateTracker.invalidateBlending())}setBlendFunction(e,t){e===this._state.blendFunction.srcRGB&&t===this._state.blendFunction.dstRGB||(this.gl.blendFunc(e,t),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=e,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=t,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,t,r,i){this._state.blendFunction.srcRGB===e&&this._state.blendFunction.srcAlpha===r&&this._state.blendFunction.dstRGB===t&&this._state.blendFunction.dstAlpha===i||(this.gl.blendFuncSeparate(e,t,r,i),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=r,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=i,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._state.blendEquation.mode!==e&&(this.gl.blendEquation(e),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,t){this._state.blendEquation.mode===e&&this._state.blendEquation.modeAlpha===t||(this.gl.blendEquationSeparate(e,t),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=t,this._stateTracker.invalidateBlending())}setColorMask(e,t,r,i){this._state.colorMask.r===e&&this._state.colorMask.g===t&&this._state.colorMask.b===r&&this._state.colorMask.a===i||(this.gl.colorMask(e,t,r,i),this._state.colorMask.r=e,this._state.colorMask.g=t,this._state.colorMask.b=r,this._state.colorMask.a=i,this._stateTracker.invalidateColorWrite())}setClearColor(e,t,r,i){this._state.clearColor.r===e&&this._state.clearColor.g===t&&this._state.clearColor.b===r&&this._state.clearColor.a===i||(this.gl.clearColor(e,t,r,i),this._state.clearColor.r=e,this._state.clearColor.g=t,this._state.clearColor.b=r,this._state.clearColor.a=i)}setFaceCullingEnabled(e){this._state.faceCulling!==e&&(!0===e?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._state.polygonOffsetFill!==e&&(!0===e?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,t){this._state.polygonOffset[0]===e&&this._state.polygonOffset[1]===t||(this._state.polygonOffset[0]=e,this._state.polygonOffset[1]=t,this.gl.polygonOffset(e,t),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._state.cullFace!==e&&(this.gl.cullFace(e),this._state.cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._state.frontFace!==e&&(this.gl.frontFace(e),this._state.frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._state.scissorTest!==e&&(!0===e?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=e)}setScissorRect(e,t,r,i){this._state.scissorRect.x===e&&this._state.scissorRect.y===t&&this._state.scissorRect.width===r&&this._state.scissorRect.height===i||(this.gl.scissor(e,t,r,i),this._state.scissorRect.x=e,this._state.scissorRect.y=t,this._state.scissorRect.width=r,this._state.scissorRect.height=i)}setDepthTestEnabled(e){this._state.depthTest!==e&&(!0===e?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._state.clearDepth!==e&&(this.gl.clearDepth(e),this._state.clearDepth=e)}setDepthFunction(e){this._state.depthFunction!==e&&(this.gl.depthFunc(e),this._state.depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._state.depthWrite!==e&&(this.gl.depthMask(e),this._state.depthWrite=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,t){this._state.depthRange.zNear===e&&this._state.depthRange.zFar===t||(this.gl.depthRange(e,t),this._state.depthRange.zNear=e,this._state.depthRange.zFar=t,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._state.stencilTest!==e&&(!0===e?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._state.clearStencil&&(this.gl.clearStencil(e),this._state.clearStencil=e)}setStencilFunction(e,t,r){this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===t&&this._state.stencilFunction.mask===r||(this.gl.stencilFunc(e,t,r),this._state.stencilFunction.face=1032,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=t,this._state.stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,t,r,i){this._state.stencilFunction.face===e&&this._state.stencilFunction.func===t&&this._state.stencilFunction.ref===r&&this._state.stencilFunction.mask===i||(this.gl.stencilFuncSeparate(e,t,r,i),this._state.stencilFunction.face=e,this._state.stencilFunction.func=t,this._state.stencilFunction.ref=r,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._state.stencilWriteMask!==e&&(this.gl.stencilMask(e),this._state.stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,t,r){1032===this._state.stencilOperation.face&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===t&&this._state.stencilOperation.zPass===r||(this.gl.stencilOp(e,t,r),this._state.stencilOperation.face=1032,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=t,this._state.stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,t,r,i){this._state.stencilOperation.face===e&&this._state.stencilOperation.fail===t&&this._state.stencilOperation.zFail===r&&this._state.stencilOperation.zPass===i||(this.gl.stencilOpSeparate(e,t,r,i),this._state.stencilOperation.face=e,this._state.stencilOperation.fail=t,this._state.stencilOperation.zFail=r,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,t=!1){const r=this._state.activeTexture;return e>=0&&(t||e!==this._state.activeTexture)&&(this.gl.activeTexture(a.baseTextureUnit+e),this._state.activeTexture=e),r}setDrawBuffers(e){const{drawFramebuffer:t}=this._state,r=null===t,i=r?this._state.drawBuffers.defaultFramebuffer:this._state.drawBuffers.fbos.get(t);if(i?.length!==e.length||!i.every((t,r)=>t===e[r]))if(e.length>this.parameters.maxDrawBuffers)console.error("Setting more active draw buffers than GL.MAX_DRAW_BUFFERS allows.");else{if(r){if(e.length>1)return void console.error("The default framebuffer can only have one active draw buffer.");if(1029!==e[0]&&0!==e[0])return void console.error("The default framebuffer can only use the constants GL.BACK or GL.NONE as draw buffers.")}r||!e.includes(1029)?(this.gl.drawBuffers(e),r?this._state.drawBuffers.defaultFramebuffer=e:this._state.drawBuffers.fbos.set(t,e),this._stateTracker.invalidateDrawBuffers()):console.error("A framebuffer object can only use the constants GL.COLOR_ATTACHMENTi or GL.NONE as draw buffers.")}}clear(e,t=255){if(e){if(16384&e){const e=this._state.drawFramebuffer?.colorAttachments;e&&this.setDrawBuffers(e),this.setColorMask(!0,!0,!0,!0)}256&e&&this.setDepthWriteEnabled(!0),1024&e&&this.setStencilWriteMask(t),this.gl.clear(e)}}clearFramebuffer(e,t=!1,r=!1){let i=0;if(e){const t=1e-13,r=Math.max(t,e[3]);this.setClearColor(e[0],e[1],e[2],r),i|=16384}t&&(i|=256),!1===r?r=0:(!0===r&&(r=255),i|=1024),i&&this.clear(i,r)}clearBuffer(e,t,r=6144,i=void 0){this.gl.clearBufferfv(r,e,t,i)}clearBufferInteger(e,t,r=6144,i=void 0){this.gl.clearBufferiv(r,e,t,i)}clearBufferUnsignedInteger(e,t,r=6144,i=void 0){this.gl.clearBufferuiv(r,e,t,i)}drawArrays(e,r,i){if(this._transformFeedbackRequestInfo){if(e!==this._transformFeedbackRequestInfo.primitiveType)throw new Error("DrawArrays called during transform feedback, but primitiveType does not match that of the current transform feedback request");if(null==this._state.program?.hasTransformFeedbackVaryings)throw new Error("DrawArrays called during transform feedback, but the shader program was not linked with a transform feedback varying")}if(n.webglDebugEnabled()&&(this._numOfDrawCalls++,this._numOfTriangles+=g(e,i),t("enable-feature:webgl-debug:textureReadWrite"))){const e=this._state.textureUnitMap;for(let t=0;t<e.length;t++){const r=e[t];if(null!=r&&r===this._state.drawFramebuffer?.colorTexture)throw new Error(`Detected readWrite. Texture already bound at index ${t}`)}}this.gl.drawArrays(e,r,i),n.checkWebGLError(this.gl)}drawArraysInstanced(e,t,r,i){this.gl.drawArraysInstanced(e,t,r,i),n.checkWebGLError(this.gl)}drawElements(e,t,r,i){if(this._transformFeedbackRequestInfo)throw new Error("Cannot called drawElements during a transform feedback request");if(n.webglDebugEnabled()&&(this._numOfDrawCalls++,this._numOfTriangles+=g(e,t)),this.gl.drawElements(e,t,r,i),n.webglDebugEnabled()){const s=n.getErrorMessage(this.gl);if(s){const n=this.getBoundVAO(),o=n?.indexBuffer,a=n?.buffers,l={indexBuffer:o,vertexBuffers:a},c={mode:e,count:t,type:r,offset:i},u=o?.size??0,d=i+t,h=u<d?`. Buffer is too small. Attempted to draw index ${d} of ${u}`:"";console.error(`drawElements: ${s}${h}`,{args:c,vao:l})}}}drawElementsInstanced(e,t,r,i,s){this.gl.drawElementsInstanced(e,t,r,i,s),n.checkWebGLError(this.gl)}logInfo(){n.webglDebugEnabled()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){n.webglDebugEnabled()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(e,t,r,i){r=Math.max(Math.round(r),1),i=Math.max(Math.round(i),1);const s=this._state.viewport;s.x===e&&s.y===t&&s.width===r&&s.height===i||(s.x=e,s.y=t,s.width=r,s.height=i,this.gl.viewport(e,t,r,i))}setViewport4fv(e){this.setViewport(e[0],e[1],e[2],e[3])}restoreViewport({x:e,y:t,width:r,height:i}){this.setViewport(e,t,r,i)}getViewport(){const e=this._state.viewport;return{x:e.x,y:e.y,width:e.width,height:e.height}}useProgram(e){this._state.program!==e&&(this._state.program?.stop(),this._state.program=e,this.gl.useProgram(e?.glName??null))}bindTexture(e,t,r=!1){(t>=this.parameters.maxTextureImageUnits||t<0)&&console.error("Input texture unit is out of range of available units!");const i=this._state.textureUnitMap[t];return null==e?.glName?(null!=i&&(this.setActiveTexture(t,r),this.gl.bindTexture(i.descriptor.target,null)),this._state.textureUnitMap[t]=null,i):r||i!==e?(this.setActiveTexture(t,r),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._state.textureUnitMap[t]=e,i):(e.isDirty&&(this.setActiveTexture(t,r),e.applyChanges()),i)}unbindTexture(e){if(null!=e)for(let t=0;t<this.parameters.maxTextureImageUnits;t++)this._state.textureUnitMap[t]===e&&(this.bindTexture(null,t),this._state.textureUnitMap[t]=null)}bindFramebuffer(e,t=!1){if(t||this._state.readFramebuffer!==e||this._state.drawFramebuffer!==e){if(this._stateTracker.invalidateDrawBuffers(),null==e)return this.gl.bindFramebuffer(36160,null),void(this._state.readFramebuffer=this._state.drawFramebuffer=null);e.initializeAndBind(36160),this._state.readFramebuffer=e,this._state.drawFramebuffer=e}}bindFramebufferSeparate(e,t,r=!1){const i=36008===t,s=i?this._state.readFramebuffer:this._state.drawFramebuffer;(r||s!==e)&&(null==e?this.gl.bindFramebuffer(t,null):e.initializeAndBind(t),i?this._state.readFramebuffer=e??null:(this._stateTracker.invalidateDrawBuffers(),this._state.drawFramebuffer=e??null))}blitFramebuffer(e,t,r=16384,i=9728,s=0,n=0,o=e.width,a=e.height,l=0,c=0,u=t.width,d=t.height){this.bindFramebufferSeparate(e,36008,!0),this.bindFramebufferSeparate(t,36009,!0),this.gl.blitFramebuffer(s,n,o,a,l,c,u,d,r,i)}bindBuffer(e,t){if(e)switch(t??=e.bufferType,t){case 34962:this._state.vertexBuffer=m(this.gl,e,t,this._state.vertexBuffer);break;case 34963:this._state.indexBuffer=m(this.gl,e,t,this._state.indexBuffer);break;case 35345:this._state.uniformBuffer=m(this.gl,e,t,this._state.uniformBuffer);break;case 35051:this._state.pixelPackBuffer=m(this.gl,e,t,this._state.pixelPackBuffer);break;case 35052:this._state.pixelUnpackBuffer=m(this.gl,e,t,this._state.pixelUnpackBuffer);break;case 36662:this._state.copyReadBuffer=m(this.gl,e,t,this._state.copyReadBuffer);break;case 36663:this._state.copyWriteBuffer=m(this.gl,e,t,this._state.copyWriteBuffer);break;case 35982:this._state.transformFeedbackBuffer=m(this.gl,e,t,this._state.transformFeedbackBuffer)}}bindRenderbuffer(e){const t=this.gl;e||(t.bindRenderbuffer(t.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==e&&(t.bindRenderbuffer(t.RENDERBUFFER,e.glName),this._state.renderbuffer=e)}_getBufferBinding(e,t){if(t>=this.parameters.maxUniformBufferBindings||t<0)return console.error("Uniform buffer binding point is out of range!"),null;const r=35345===e?this._state.uniformBufferBindingPoints:this._state.transformBufferBindingPoints;let i=r[t];return null==i&&(i={buffer:null,offset:0,size:0},r[t]=i),i}bindBufferBase(e,t,r){const i=this._getBufferBinding(e,t);null!=i&&(i.buffer===r&&0===i.offset&&0===i.size||(this.gl.bindBufferBase(e,t,r?r.glName:null),i.buffer=r,i.offset=0,i.size=0))}bindBufferRange(e,t,r,i,s){const n=this._getBufferBinding(e,t);null!=n&&(n.buffer===r&&n.offset===i&&n.size===s||(i%this._parameters.uniformBufferOffsetAlignment===0?(this.gl.bindBufferRange(e,t,r.glName,i,s),n.buffer=r,n.offset=i,n.size=s):console.error("Uniform buffer binding offset is not a multiple of the context offset alignment")))}bindUBO(e,t,r,i){null!=t?(n.webglDebugEnabled()&&(i??t.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),t.initialize(),void 0!==r&&void 0!==i?this.bindBufferRange(35345,e,t.buffer,r,i):this.bindBufferBase(35345,e,t.buffer)):this.bindBufferBase(35345,e,null)}unbindUBO(e){for(let t=0,r=this._state.uniformBufferBindingPoints.length;t<r;t++){const r=this._state.uniformBufferBindingPoints[t];null!=r&&r.buffer===e.buffer&&this.bindBufferBase(35345,t,null)}}unbindBuffer(e){switch(e){case 34962:this._state.vertexBuffer=m(this.gl,null,e,this._state.vertexBuffer);break;case 34963:this._state.indexBuffer=m(this.gl,null,e,this._state.indexBuffer);break;case 35345:this._state.uniformBuffer=m(this.gl,null,e,this._state.uniformBuffer);break;case 35051:this._state.pixelPackBuffer=m(this.gl,null,e,this._state.pixelPackBuffer);break;case 35052:this._state.pixelUnpackBuffer=m(this.gl,null,e,this._state.pixelUnpackBuffer);break;case 36662:this._state.copyReadBuffer=m(this.gl,null,e,this._state.copyReadBuffer);break;case 36663:this._state.copyWriteBuffer=m(this.gl,null,e,this._state.copyWriteBuffer)}}bindVAO(e,t){if(null==e)return this._state.vertexArrayObject?.unbind(),void(this._state.vertexArrayObject=null);this._state.vertexArrayObject!==e&&(e.bind(t),this._state.vertexArrayObject=e)}bindTransformFeedback(e){const{gl:t}=this;t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,e.glName)}beginTransformFeedback(e,t){if(this._transformFeedbackRequestInfo)throw new Error("Already in a transform feedback request");const{gl:r}=this;r.bindTransformFeedback(r.TRANSFORM_FEEDBACK,e.glName),r.beginTransformFeedback(t),this._transformFeedbackRequestInfo={primitiveType:t}}endTransformFeedback(){if(!this._transformFeedbackRequestInfo)throw new Error("Not in a transform feedback request");const{gl:e}=this;e.endTransformFeedback(),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null),this._transformFeedbackRequestInfo=null}async clientWaitAsync(e=s.Milliseconds(10)){const{gl:t}=this,r=t.fenceSync(37143,0);if(!r)throw new Error("Client wait failed, could not create sync object");let n;this.instanceCounter.increment(a.ResourceType.Sync,r),t.flush();do{await i.after(e),n=t.clientWaitSync(r,0,0)}while(37147===n);if(this.instanceCounter.decrement(a.ResourceType.Sync,r),t.deleteSync(r),37149===n)throw new Error("Client wait failed")}getBoundFramebufferObject(e=36160){return 36008===e?this._state.readFramebuffer:this._state.drawFramebuffer}temporaryBindFramebufferObject(e,t,r=!1){const i=this.getBoundFramebufferObject();try{this.bindFramebuffer(e,r),t()}finally{this.bindFramebuffer(i,r)}}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(34962),this.unbindBuffer(34963),this.unbindBuffer(35345),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(35051),this.unbindBuffer(35052),this.unbindBuffer(36662),this.unbindBuffer(36663);for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(1,0),this.setBlendEquation(32774),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(1029),this.setFrontFace(2305),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(513),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(519,0,0),this.setStencilOp(7680,7680,7680),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setDrawBuffers([1029]),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){const{gl:e}=this;e.bindVertexArray(null);for(let t=0;t<this.parameters.maxVertexAttributes;t++)e.disableVertexAttribArray(t);this._state.vertexBuffer?e.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):e.bindBuffer(34962,null),this._state.indexBuffer?e.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):e.bindBuffer(34963,null),this._state.uniformBuffer?e.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):e.bindBuffer(35345,null);for(let t=0;t<this._parameters.maxUniformBufferBindings;t++){const r=this._state.uniformBufferBindingPoints[t];if(null!=r){const{buffer:i,offset:s,size:n}=r;null!==i?0===s&&0===n?e.bindBufferBase(35345,t,i.glName):e.bindBufferRange(35345,t,i.glName,s,n):e.bindBufferBase(35345,t,null)}}if(this._state.pixelPackBuffer?e.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):e.bindBuffer(35051,null),this._state.pixelUnpackBuffer?e.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):e.bindBuffer(35052,null),this._state.copyReadBuffer?e.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):e.bindBuffer(36662,null),this._state.copyWriteBuffer?e.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):e.bindBuffer(36663,null),e.bindFramebuffer(36008,null),e.readBuffer(e.BACK),this._state.readFramebuffer&&(e.bindFramebuffer(36008,this._state.readFramebuffer.glName),e.readBuffer(a.ColorAttachment0)),e.bindFramebuffer(36009,this._state.drawFramebuffer?.glName??null),null===this._state.drawFramebuffer){const t=this._state.drawBuffers.defaultFramebuffer;e.drawBuffers(t??[1029])}else{const t=this._state.drawBuffers.fbos.get(this._state.drawFramebuffer);e.drawBuffers(t??[a.ColorAttachment0])}if(this._state.vertexArrayObject){const e=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(e)}e.useProgram(this._state.program?.glName??null),e.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),e.bindRenderbuffer(e.RENDERBUFFER,this._state.renderbuffer?.glName??null),!0===this._state.blend?e.enable(this.gl.BLEND):e.disable(this.gl.BLEND),e.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),e.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),e.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),e.clearDepth(this._state.clearDepth),e.clearStencil(this._state.clearStencil),e.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),e.cullFace(this._state.cullFace),e.depthFunc(this._state.depthFunction),e.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),!0===this._state.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthMask(this._state.depthWrite),e.frontFace(this._state.frontFace),e.lineWidth(1),!0===this._state.faceCulling?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),!0===this._state.polygonOffsetFill?e.enable(e.POLYGON_OFFSET_FILL):e.disable(e.POLYGON_OFFSET_FILL),e.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),!0===this._state.scissorTest?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),e.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),e.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),!0===this._state.stencilTest?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),e.stencilMask(this._state.stencilWriteMask);for(let t=0;t<this.parameters.maxTextureImageUnits;t++){e.activeTexture(a.baseTextureUnit+t),e.bindTexture(3553,null),e.bindTexture(34067,null),e.bindTexture(32879,null),e.bindTexture(35866,null);const r=this._state.textureUnitMap[t];null!=r&&e.bindTexture(r.descriptor.target,r.glName)}e.activeTexture(a.baseTextureUnit+this._state.activeTexture);const t=this._state.viewport;e.viewport(t.x,t.y,t.width,t.height),this.resetInfo()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/ContextState":function(){define(["exports"],function(e){"use strict";e.ContextState=class{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0},this.blendEquation={mode:32774,modeAlpha:32774},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=1029,this.frontFace=2305,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=513,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:1032,func:519,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:1032,fail:7680,zFail:7680,zPass:7680},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.transformFeedbackBuffer=null,this.uniformBufferBindingPoints=new Array,this.transformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.drawBuffers={defaultFramebuffer:[1029],fbos:new WeakMap},this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array,this.vertexArrayObject=null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/InstanceCounter":function(){define(["exports","../../core/object","./AllocationTracer","./enums"],function(e,t,r,i){"use strict";const s={RECORD_ALLOCATIONS:!1};e.InstanceCounter=class{constructor(){for(this._current=new Array,this._allocations=s.RECORD_ALLOCATIONS?new r.AllocationTracer("WebGLObject"):null;this._current.length<i.ResourceType.COUNT;)this._current.push(0)}increment(e,t,r=1){this._current[e]+=r,this._allocations?.add(t)}decrement(e,t,r=1){this._current[e]-=r,this._allocations?.remove(t)}get current(){return this._current}get total(){return this.current.reduce((e,t,r)=>e+(r<i.ResourceType.UNCOUNTED?t:0),0)}get resourceInformation(){let e="";if(this.total>0){e+="Live objects:\n";for(let r=0;r<i.ResourceType.COUNT;++r){const s=this._current[r];s>0&&(e+=`${t.getKey(i.ResourceType,r)}: ${s}\n`)}}return e+=this._allocations?.resetLog(),e}},e.test=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/AllocationTracer":function(){define(["exports"],function(e){"use strict";class t{constructor(e){this.from=e,this.retains=new Array,this.releases=new Array}}e.AllocationTracer=class{constructor(e){this._objectType=e,this._active=new Map}get _stack(){const e=(new Error).stack.split("\n");return e.shift(),e.shift(),e.shift(),e.join("\n")}add(e){this._active.set(e,new t(this._stack))}remove(e){this._active.delete(e)}addReference(e){const t=this._active.get(e);t&&t.retains.push(this._stack)}removeReference(e){const t=this._active.get(e);t&&t.releases.push(this._stack)}resetLog(){const e=new Map;let t="";this._active.forEach((r,{usedMemory:i})=>{e.has(r.from)||(e.set(r.from,new Map),r.retains.length>0&&(t+=`  First reference count mismatch:\n  Retain:\n    ${r.retains.join("\n\n    ")}\n\n  Release:    ${r.releases.join("\n\n    ")}\n`));const s=e.get(r.from);s.set(i??0,s.get(i??0)??1)}),this._active.clear();let r=0;const i=new Array;return e.forEach((e,t)=>{let s=0;e.forEach((e,t)=>s+=e*t),e.set(-1,s),r+=s,i.push([t,e])}),e.clear(),i.sort((e,t)=>t[1].get(-1)-e[1].get(-1)),i.reduce((e,[t,r])=>{const i=Math.round(r.get(-1)/1024);return r.delete(-1),e+`  ${i}KB from ${Array.from(r.values()).reduce((e,t)=>e+t,0)} allocations at ${t}\n`},`Total ${this._objectType} memory: ${Math.round(r/1024)}KB\n${t}`)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/Parameters":function(){define(["exports"],function(e){"use strict";e.Parameters=class{constructor(e,t,r){const i=t.textureFilterAnisotropic;this.versionString=e.getParameter(e.VERSION),this.maxVertexTextureImageUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS);const s=r.maxAnisotropy;this.maxMaxAnisotropy=i?Math.min(e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY),s):1,this.maxTextureImageUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxPreferredTexturePixels=r.maxPreferredTexturePixels,this.maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxViewportDims=e.getParameter(e.MAX_VIEWPORT_DIMS),this.maxUniformBufferBindings=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS),this.maxVertexUniformBlocks=e.getParameter(e.MAX_VERTEX_UNIFORM_BLOCKS),this.maxFragmentUniformBlocks=e.getParameter(e.MAX_FRAGMENT_UNIFORM_BLOCKS),this.maxUniformBlockSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),this.uniformBufferOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this.maxArrayTextureLayers=e.getParameter(e.MAX_ARRAY_TEXTURE_LAYERS),this.maxSamples=e.getParameter(e.MAX_SAMPLES),this.maxDrawBuffers=e.getParameter(e.MAX_DRAW_BUFFERS)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/ProgramCache":function(){define(["exports","../../core/has","./Program"],function(e,t,r){"use strict";e.ProgramCache=class{constructor(e){this._rctx=e,this._store=new Map}dispose(){this._store.forEach(e=>e.dispose()),this._store.clear()}acquire(e,t,i,s){const n=e+t+JSON.stringify(Array.from(i.entries())),o=this._store.get(n);if(null!=o)return o.ref(),o;const a=new r.Program(this._rctx,e,t,i,s);return a.ref(),this._store.set(n,a),a}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/Program":function(){define(["exports","../../core/has","./checkWebGLError","./enums","./ShaderTranspiler"],function(e,t,r,i,s){"use strict";const n=!!t("esri-tests-disable-gpu-memory-measurements");function o(e,t,i){const s=e.gl,n=s.createShader(t);return s.shaderSource(n,i),s.compileShader(n),r.webglValidateShadersEnabled()&&!s.getShaderParameter(n,s.COMPILE_STATUS)&&(console.error("Compile error in ".concat(35633===t?"vertex":"fragment"," shader")),console.error(s.getShaderInfoLog(n)),console.error(function(e){let t=2;return e.replaceAll("\n",()=>{return"\n"+((e=t++)>=1e3?e.toString():("  "+e).slice(-3))+":";var e})}(i))),n}function a(e,t,r){const i=e.get(t);if(!i)return e.set(t,Array.from(r)),!0;const s=r.length;if(i.length!==s)return e.set(t,Array.from(r)),!0;for(let e=0;e<s;++e){const t=r[e];if(i[e]!==t){for(i[e]=t;e<s;++e)i[e]=r[e];return!0}}return!1}const l={enabled:!1},c=r.webglDebugEnabled()?(e,...t)=>u(e,t):()=>{},u=r.webglDebugEnabled()?(e,t)=>{if(e?.supportsNaN)return;const r=t.length;for(let e=0;e<r;++e){const r=t[e];Number.isNaN(r)&&console.error(`Got ${r} as uniform value from ${(new Error).stack}`)}}:()=>{};e.Program=class{constructor(e,t,a,c,u=new Map,d=[]){this._context=e,this._refCount=1,this._compiled=!1,this._linesOfCode=0,this._nameToUniformLocation=new Map,this._nameToUniform1=new Map,this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),0===t.length&&console.error("Shaders source should not be empty!"),t=s.transpileShader(t,35633),a=s.transpileShader(a,35632),this._vShader=o(this._context,35633,t),this._fShader=o(this._context,35632,a),l.enabled&&(this._linesOfCode=t.match(/\n/g).length+a.match(/\n/g).length+2,e.instanceCounter.increment(i.ResourceType.LinesOfCode,this._vShader,this._linesOfCode)),this._vShader&&this._fShader||console.error("Error loading shaders!"),e.instanceCounter.increment(i.ResourceType.Shader,this),r.webglValidateShadersEnabled()&&(this.vertexShader=t,this.fragmentShader=a),this.usedMemory=n?0:t.length+a.length;const h=this._context.gl,p=h.createProgram();h.attachShader(p,this._vShader),h.attachShader(p,this._fShader),c.forEach((e,t)=>h.bindAttribLocation(p,e,t)),this.hasTransformFeedbackVaryings=!!d?.length,this.hasTransformFeedbackVaryings&&h.transformFeedbackVaryings(p,d,h.SEPARATE_ATTRIBS),h.linkProgram(p),r.webglValidateShadersEnabled()&&!h.getProgramParameter(p,h.LINK_STATUS)&&console.error(`Could not link shader\nvalidated: ${h.getProgramParameter(p,h.VALIDATE_STATUS)}, gl error ${h.getError()}, vertex: ${h.getShaderParameter(this._vShader,h.COMPILE_STATUS)}, fragment: ${h.getShaderParameter(this._fShader,h.COMPILE_STATUS)}, info log: ${h.getProgramInfoLog(p)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`);for(const[e,t]of u){const r=h.getUniformBlockIndex(p,e);r<4294967295&&h.uniformBlockBinding(p,r,t)}this._glName=p,e.instanceCounter.increment(i.ResourceType.Program,this)}get glName(){return this._glName}get hasGLName(){return null!=this._glName}get compiled(){return!!this._compiled||(this._context.capabilities.parallelShaderCompile&&null!=this.glName?(this._compiled=!!this._context.gl.getProgramParameter(this.glName,37297),this._compiled):(this._compiled=!0,!0))}dispose(){if(--this._refCount>0)return;const e=this._context.gl,t=this._context.instanceCounter;this._nameToUniformLocation.forEach(e=>e&&t.decrement(i.ResourceType.Uniform,e)),this._nameToUniformLocation.clear(),this._vShader&&(this._linesOfCode>0&&(t.decrement(i.ResourceType.LinesOfCode,this._vShader,this._linesOfCode),this._linesOfCode=0),e.deleteShader(this._vShader),this._vShader=null,t.decrement(i.ResourceType.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,t.decrement(i.ResourceType.Program,this))}ref(){++this._refCount}_getUniformLocation(e){const t=this._nameToUniformLocation.get(e);if(void 0!==t)return t;if(this.glName){const t=this._context.gl.getUniformLocation(this.glName,e);return this._nameToUniformLocation.set(e,t),t&&this._context.instanceCounter.increment(i.ResourceType.Uniform,t),t}return null}hasUniform(e){return null!=this._getUniformLocation(e)}setUniform1i(e,t,r){c(r,t);const i=this._nameToUniform1.get(e);void 0!==i&&t===i||(this._context.gl.uniform1i(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1iv(e,t,r){u(r,t),a(this._nameToUniform1v,e,t)&&this._context.gl.uniform1iv(this._getUniformLocation(e),t)}setUniform2iv(e,t,r){u(r,t),a(this._nameToUniform2,e,t)&&this._context.gl.uniform2iv(this._getUniformLocation(e),t)}setUniform3iv(e,t,r){u(r,t),a(this._nameToUniform3,e,t)&&this._context.gl.uniform3iv(this._getUniformLocation(e),t)}setUniform4iv(e,t,r){u(r,t),a(this._nameToUniform4,e,t)&&this._context.gl.uniform4iv(this._getUniformLocation(e),t)}setUniform1f(e,t,r){c(r,t);const i=this._nameToUniform1.get(e);void 0!==i&&t===i||(this._context.gl.uniform1f(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1fv(e,t,r){u(r,t),a(this._nameToUniform1v,e,t)&&this._context.gl.uniform1fv(this._getUniformLocation(e),t)}setUniform2f(e,t,r,i){c(i,t,r);const s=this._nameToUniform2.get(e);void 0===s?(this._context.gl.uniform2f(this._getUniformLocation(e),t,r),this._nameToUniform2.set(e,[t,r])):t===s[0]&&r===s[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),t,r),s[0]=t,s[1]=r)}setUniform2fv(e,t,r){u(r,t),a(this._nameToUniform2,e,t)&&this._context.gl.uniform2fv(this._getUniformLocation(e),t)}setUniform3f(e,t,r,i,s){c(s,t,r,i);const n=this._nameToUniform3.get(e);void 0===n?(this._context.gl.uniform3f(this._getUniformLocation(e),t,r,i),this._nameToUniform3.set(e,[t,r,i])):t===n[0]&&r===n[1]&&i===n[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),t,r,i),n[0]=t,n[1]=r,n[2]=i)}setUniform3fv(e,t,r){u(r,t);const i=this._getUniformLocation(e);null!=i&&a(this._nameToUniform3,e,t)&&this._context.gl.uniform3fv(i,t)}setUniform4f(e,t,r,i,s,n){c(n,t,r,i,s);const o=this._nameToUniform4.get(e);void 0===o?(this._context.gl.uniform4f(this._getUniformLocation(e),t,r,i,s),this._nameToUniform4.set(e,[t,r,i,s])):void 0!==o&&t===o[0]&&r===o[1]&&i===o[2]&&s===o[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),t,r,i,s),o[0]=t,o[1]=r,o[2]=i,o[3]=s)}setUniform4fv(e,t,r){u(r,t);const i=this._getUniformLocation(e);null!=i&&a(this._nameToUniform4,e,t)&&this._context.gl.uniform4fv(i,t)}setUniformMatrix3fv(e,t,r=!1,i){u(i,t);const s=this._getUniformLocation(e);null!=s&&a(this._nameToUniformMatrix3,e,t)&&this._context.gl.uniformMatrix3fv(s,r,t)}setUniformMatrix4fv(e,t,r=!1,i){u(i,t);const s=this._getUniformLocation(e);null!=s&&a(this._nameToUniformMatrix4,e,t)&&this._context.gl.uniformMatrix4fv(s,r,t)}stop(){}},e.test=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/ShaderTranspiler":function(){define(["exports","../../core/has","./reservedWordsGLSL3","./testUtils"],function(e,t,r,i){"use strict";const s=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","uvec2","uvec3","uvec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","usampler1D","usampler2D","usampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"],n=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"],o=["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT","textureSize","texelFetch"];var a=999,l=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];const c=new Set(["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"]);function u(e,t){for(let r=t-1;r>=0;r--){const t=e[r];if("whitespace"!==t.type&&"block-comment"!==t.type){if("keyword"!==t.type)break;if("attribute"===t.data||"in"===t.data)return!0}}return!1}function d(e,t,r,i){i=i||r;for(const s of e)if("ident"===s.type&&s.data===r)return i in t?t[i]++:t[i]=0,d(e,t,i+"_"+t[i],i);return r}function h(e,t,r="afterVersion"){function i(e,t){for(let r=t;r<e.length;r++){const t=e[r];if("operator"===t.type&&";"===t.data)return r}return null}const s={data:"\n",type:"whitespace"},n=t=>t<e.length&&/[^\r\n]$/.test(e[t].data);let o=function(e){let t=-1,s=0,n=-1;for(let o=0;o<e.length;o++){const a=e[o];if("preprocessor"===a.type&&(/#(if|ifdef|ifndef)\s+.+/.test(a.data)?++s:/#endif\s*.*/.test(a.data)&&--s),"afterVersion"!==r&&"afterPrecision"!==r||"preprocessor"===a.type&&a.data.startsWith("#version")&&(n=Math.max(n,o)),"afterPrecision"===r&&"keyword"===a.type&&"precision"===a.data){const t=i(e,o);if(null===t)throw new Error("precision statement not followed by any semicolons!");n=Math.max(n,t)}t<n&&0===s&&(t=o)}return t+1}(e);n(o-1)&&e.splice(o++,0,s);for(const r of t)e.splice(o++,0,r);n(o-1)&&n(o)&&e.splice(o,0,s)}function p(e,t,r,i="lowp"){h(e,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function f(e,t,r,i,s="lowp"){h(e,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:i.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:s},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function m(e,t){let r,i,s=-1;for(let n=t;n<e.length;n++){const t=e[n];if("operator"===t.type&&("["===t.data&&(r=n),"]"===t.data)){i=n;break}"integer"===t.type&&(s=parseInt(t.data,10))}return r&&i&&e.splice(r,i-r+1),s}const g=new Map;e.transpileShader=function(e,t){if(e.startsWith("#version 300"))return e;const h=function(e){return i.shaderTranspiler.enableCache?g.get(e):null}(e);if(null!=h)return h;const y=function(e){return t=e,r=function(){var e,t,r,i=0,c=0,u=a,d=[],h=[],p=1,f=0,m=0,g=!1,y=!1,_="";return function(t){return h=[],null!==t?function(t){var s;for(i=0,r=(_+=t).length;e=_[i],i<r;){switch(s=i,u){case 0:i=T();break;case 1:i=S();break;case 2:i=x();break;case 3:i=C();break;case 4:i=R();break;case 11:i=M();break;case 5:i=O();break;case 9999:i=I();break;case 9:i=w();break;case a:i=v()}s!==i&&("\n"===_[s]?(f=0,++p):++f)}return c+=i,_=_.slice(i),h}(t.replace?t.replace(/\r\n/g,"\n"):t):(d.length&&b(d.join("")),u=10,b("(eof)"),h)};function b(e){e.length&&h.push({type:l[u],data:e,position:m,line:p,column:f})}function v(){return d=d.length?[]:d,"/"===t&&"*"===e?(m=c+i-1,u=0,t=e,i+1):"/"===t&&"/"===e?(m=c+i-1,u=1,t=e,i+1):"#"===e?(u=2,m=c+i,i):/\s/.test(e)?(u=9,m=c+i,i):(g=/\d/.test(e),y=/[^\w_]/.test(e),m=c+i,u=g?4:y?3:9999,i)}function w(){return/[^\s]/g.test(e)?(b(d.join("")),u=a,i):(d.push(e),t=e,i+1)}function x(){return"\r"!==e&&"\n"!==e||"\\"===t?(d.push(e),t=e,i+1):(b(d.join("")),u=a,i)}function S(){return x()}function T(){return"/"===e&&"*"===t?(d.push(e),b(d.join("")),u=a,i+1):(d.push(e),t=e,i+1)}function C(){if("."===t&&/\d/.test(e))return u=5,i;if("/"===t&&"*"===e)return u=0,i;if("/"===t&&"/"===e)return u=1,i;if("."===e&&d.length){for(;P(d););return u=5,i}if(";"===e||")"===e||"("===e){if(d.length)for(;P(d););return b(e),u=a,i+1}var r=2===d.length&&"="!==e;if(/[\w_\d\s]/.test(e)||r){for(;P(d););return u=a,i}return d.push(e),t=e,i+1}function P(e){for(var t,r,i=0;;){if(t=n.indexOf(e.slice(0,e.length+i).join("")),r=n[t],-1===t){if(i--+e.length>0)continue;r=e.slice(0,1).join("")}return b(r),m+=r.length,(d=d.slice(r.length)).length}}function M(){return/[^a-fA-F0-9]/.test(e)?(b(d.join("")),u=a,i):(d.push(e),t=e,i+1)}function R(){return"."===e||/[eE]/.test(e)?(d.push(e),u=5,t=e,i+1):"x"===e&&1===d.length&&"0"===d[0]?(u=11,d.push(e),t=e,i+1):/[^\d]/.test(e)?(b(d.join("")),u=a,i):(d.push(e),t=e,i+1)}function O(){return"f"===e&&(d.push(e),t=e,i+=1),/[eE]/.test(e)||"-"===e&&/[eE]/.test(t)?(d.push(e),t=e,i+1):/[^\d]/.test(e)?(b(d.join("")),u=a,i):(d.push(e),t=e,i+1)}function I(){if(/[^\d\w_]/.test(e)){var r=d.join("");return u=s.indexOf(r)>-1?8:o.indexOf(r)>-1?7:6,b(d.join("")),u=a,i}return d.push(e),t=e,i+1}}(),[].concat(r(t)).concat(r(null));var t,r}(e);if("300 es"===function(e,t="100",r="300 es"){const i=/^\s*#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const s of e)if("preprocessor"===s.type){const e=i.exec(s.data);if(e){const i=e[1].replaceAll(/\s{2,}/g," ");if(i===r)return i;if(i===t)return s.data="#version "+r,t;throw new Error("unknown glsl version: "+i)}}return e.splice(0,0,{type:"preprocessor",data:"#version "+r},{type:"whitespace",data:"\n"}),null}(y,"100","300 es"))return e;let _=null,b=null;const v={},w={};for(let e=0;e<y.length;++e){const i=y[e];switch(i.type){case"keyword":35633===t&&"attribute"===i.data?i.data="in":"varying"===i.data&&(i.data=35633===t?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(i.data.trim())&&(i.data=i.data.replaceAll(/(2D|Cube|EXT)/g,"")),35632===t&&"gl_FragColor"===i.data&&(_||(_=d(y,v,"fragColor"),p(y,_,"vec4")),i.data=_),35632===t&&"gl_FragData"===i.data){const t=m(y,e+1),r=d(y,v,"fragData");f(y,r,"vec4",t,"mediump"),i.data=r}else 35632===t&&"gl_FragDepthEXT"===i.data&&(b||(b=d(y,v,"gl_FragDepth")),i.data=b);break;case"ident":if(r.includes(i.data)){if(35633===t&&u(y,e))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");i.data in w||(w[i.data]=d(y,v,i.data)),i.data=w[i.data]}}}for(let e=y.length-1;e>=0;--e){const t=y[e];if("preprocessor"===t.type){const r=t.data.match(/#extension\s+(.*):/);if(r?.[1]&&c.has(r[1].trim())){const t=y[e+1];y.splice(e,t&&"whitespace"===t.type?2:1)}const i=t.data.match(/#ifdef\s+(.*)/);i?.[1]&&c.has(i[1].trim())&&(t.data="#if 1");const s=t.data.match(/#ifndef\s+(.*)/);s?.[1]&&c.has(s[1].trim())&&(t.data="#if 0")}}return function(e,t){return i.shaderTranspiler.enableCache&&g.set(e,t),t}(e,function(e){return e.map(e=>"eof"!==e.type?e.data:"").join("")}(y))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/reservedWordsGLSL3":function(){define(function(){"use strict";return["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"]})},"esri/views/webgl/testUtils":function(){define(["exports"],function(e){"use strict";e.shaderTranspiler={enableCache:!1},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/WebGLDriverTest":function(){define(["exports","./testAppleAmdDrawArrays","./testFloatBufferBlend","./testSVGPremultipliedAlpha"],function(e,t,r,i){"use strict";e.WebGLDriverTest=class{constructor(e){this.rctx=e,this.floatBufferBlend=new r.FloatBufferBlend(e),this.svgPremultipliesAlpha=new i.SVGPremultipliedAlpha(e),this.drawArraysRequiresIndicesTypeReset=new t.DrawArraysRequiresIndicesTypeReset(e)}dispose(){this.svgPremultipliesAlpha.dispose(),this.floatBufferBlend.dispose(),this.drawArraysRequiresIndicesTypeReset.dispose()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/testAppleAmdDrawArrays":function(){define(["exports","../../core/has","../3d/webgl-engine/core/shaderModules/glsl","./AppleAmdDriverHelper","./BufferObject","./enums","./FramebufferObject","./TextureDescriptor","./WebGLDriverTestModule"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends l.WebGLDriverTestModule{constructor(e){super(),this._rctx=e,this._helperProgram=null,t("mac")&&t("chrome")&&(this._program=this._prepareProgram(),this._helperProgram=this._prepareHelperProgram())}dispose(){super.dispose(),this._helperProgram?.dispose(),this._helperProgram=null}_test(e){const t=this._rctx,r=t.getBoundFramebufferObject(),{x:i,y:l,width:c,height:u}=t.getViewport();t.resetState();const d=new a.TextureDescriptor(1);d.wrapMode=33071,d.samplingMode=9728;const h=new o.FramebufferObject(t,d),p=s.BufferObject.createIndex(this._rctx,35044,new Uint8Array([0]));t.bindFramebuffer(h),t.setViewport(0,0,1,1),t.useProgram(this._helperProgram),t.bindBuffer(p,34963),t.drawElements(n.PrimitiveType.POINTS,1,n.DataType.UNSIGNED_BYTE,0),t.useProgram(e),t.bindVAO(null),t.drawArrays(n.PrimitiveType.TRIANGLES,0,258);const f=new Uint8Array(4);return h.readPixels(0,0,1,1,6408,n.PixelType.UNSIGNED_BYTE,f),t.setViewport(i,l,c,u),t.bindFramebuffer(r),h.dispose(),p.dispose(),255===f[0]}_prepareProgram(){const e=`#version 300 es\n    precision highp float;\n\n    out float triangleId;\n\n    const vec3 triangleVertices[3] = vec3[3](vec3(-0.5, -0.5, 0.0), vec3(0.5, -0.5, 0.0), vec3(0.0, 0.5, 0.0));\n\n    void main(void) {\n      triangleId = floor(float(gl_VertexID)/3.0);\n\n      vec3 position = triangleVertices[gl_VertexID % 3];\n      float offset = triangleId / ${r.glsl.float(85)};\n      position.z = 0.5 - offset;\n\n      gl_Position = vec4(position, 1.0);\n    }\n    `,t=`#version 300 es\n    precision highp float;\n\n    in float triangleId;\n\n    out vec4 fragColor;\n\n    void main(void) {\n      fragColor = triangleId == ${r.glsl.float(85)} ? vec4(0.0, 1.0, 0.0, 1.0) : vec4(1.0, 0.0, 0.0, 1.0);\n    }\n    `;return this._rctx.programCache.acquire(e,t,new Map([]))}_prepareHelperProgram(){const e=i.AppleAmdDriverHelper.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}}e.DrawArraysRequiresIndicesTypeReset=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/WebGLDriverTestModule":function(){define(["exports","../../core/maybe"],function(e,t){"use strict";e.WebGLDriverTestModule=class{constructor(){this._result=!1}dispose(){this._program=t.disposeMaybe(this._program)}get result(){return null!=this._program&&(this._result=this._test(this._program),this.dispose()),this._result}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/testFloatBufferBlend":function(){define(["exports","./enums","./FramebufferObject","./renderState","./TextureDescriptor","./VertexArrayObject","./VertexAttributeLayouts","./VertexBuffer","./WebGLDriverTestModule"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends l.WebGLDriverTestModule{constructor(e){super(),this._rctx=e,e.gl&&e.capabilities.colorBufferFloat?.textureFloat&&e.capabilities.colorBufferFloat?.floatBlend&&(this._program=e.programCache.acquire("\n    precision highp float;\n    attribute vec2 position;\n\n    void main() {\n      gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);\n    }\n    ","\n     precision highp float;\n\n     void main() {\n      gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);\n     }\n    ",o.Pos2usLocations))}_test(e){const l=this._rctx,c=new s.TextureDescriptor(1);c.wrapMode=33071,c.dataType=t.PixelType.FLOAT,c.internalFormat=t.SizedPixelFormat.RGBA32F,c.samplingMode=9728;const u=new r.FramebufferObject(l,c),d=new a.VertexBuffer(l,o.Pos2us,new Uint16Array([0,0,1,0,0,1,1,1])),h=new n.VertexArrayObject(l,d);l.gl.getError(),l.useProgram(e);const p=l.getBoundFramebufferObject(),{x:f,y:m,width:g,height:y}=l.getViewport();l.bindFramebuffer(u),l.setViewport(0,0,1,1),l.bindVAO(h),l.drawArrays(t.PrimitiveType.TRIANGLE_STRIP,0,4);const _=i.makePipelineState({blending:i.destinationTimesOneMinusSourceAlpha});l.setPipelineState(_),l.drawArrays(t.PrimitiveType.TRIANGLE_STRIP,0,4);const b=l.gl.getError();return l.setViewport(f,m,g,y),l.bindFramebuffer(p),h.dispose(),u.dispose(),b!==l.gl.INVALID_OPERATION||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}}e.FloatBufferBlend=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/VertexAttributeLayouts":function(){define(["exports","./enums","./VertexAttributeLocations","./VertexElementDescriptor"],function(e,t,r,i){"use strict";const s=[new i.VertexElementDescriptor("position",2,t.DataType.UNSIGNED_SHORT,0,4)],n=[new i.VertexElementDescriptor("a_pos",2,t.DataType.BYTE,0,2)],o=[new i.VertexElementDescriptor("a_pos",2,t.DataType.BYTE,0,4),new i.VertexElementDescriptor("a_tex",2,t.DataType.BYTE,2,4)],a=r.fromLayout(s);e.Pos2b=n,e.Pos2us=s,e.Pos2usLocations=a,e.PosTex2b=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/testSVGPremultipliedAlpha":function(){define(["exports","./enums","./FramebufferObject","./Texture","./TextureDescriptor","./VertexArrayObject","./VertexAttributeLayouts","./VertexBuffer","./WebGLDriverTestModule"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends l.WebGLDriverTestModule{constructor(e){super(),this._rctx=e,this._program=e.programCache.acquire("\n    precision highp float;\n\n    attribute vec2 position;\n    varying vec2 v_uv;\n\n    void main() {\n      v_uv = position;\n      gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);\n    }\n    ","\n    precision highp float;\n\n    varying vec2 v_uv;\n\n    uniform sampler2D u_texture;\n\n    void main() {\n      gl_FragColor = texture2D(u_texture, v_uv);\n    }\n    ",o.Pos2usLocations)}dispose(){super.dispose()}_test(e){const l=this._rctx;if(!l.gl)return e.dispose(),!0;const c=new s.TextureDescriptor(1);c.wrapMode=33071,c.samplingMode=9728;const d=new r.FramebufferObject(l,c),h=new a.VertexBuffer(l,o.Pos2us,new Uint16Array([0,0,1,0,0,1,1,1])),p=new n.VertexArrayObject(l,h),f=new s.TextureDescriptor;f.samplingMode=9729,f.wrapMode=33071;const m=new i.Texture(l,f,u);l.useProgram(e),l.bindTexture(m,0),e.setUniform1i("u_texture",0);const g=l.getBoundFramebufferObject(),{x:y,y:_,width:b,height:v}=l.getViewport();l.bindFramebuffer(d),l.setViewport(0,0,1,1),l.setClearColor(0,0,0,0),l.setBlendingEnabled(!1),l.clear(16384),l.bindVAO(p),l.drawArrays(t.PrimitiveType.TRIANGLE_STRIP,0,4);const w=new Uint8Array(4);return d.readPixels(0,0,1,1,6408,t.PixelType.UNSIGNED_BYTE,w),p.dispose(),d.dispose(),m.dispose(),l.setViewport(y,_,b,v),l.bindFramebuffer(g),255!==w[0]}}const u=new Image;u.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",u.width=5,u.height=5,u.decode(),e.SVGPremultipliedAlpha=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/capabilities/Capabilities":function(){define(["exports","./DebugRendererInfo","./DisjointTimerQuery","./load","./LoseContext"],function(e,t,r,i,s){"use strict";e.Capabilities=class{constructor(e,t){this._gl=e,this._compressedTextureETC=null,this._compressedTextureS3TC=null,this._textureFilterAnisotropic=null,this._colorBufferFloat=null,this._loseContext=null,this._textureNorm16=null,this._textureFloatLinear=null,this._parallelShaderCompile=null,this._rendererInfo=null,this._disabledExtensions=t.disabledExtensions,this._debugWebGLExtensions=t.debugWebGLExtensions}get compressedTextureETC(){return this._compressedTextureETC??=i.loadCompressedTextureETC(this._gl,this._disabledExtensions),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC??=i.loadCompressedTextureS3TC(this._gl,this._disabledExtensions),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic??=i.loadTextureFilterAnisotropicCapability(this._gl,this._disabledExtensions),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery??=r.createDisjointTimerQuery(this._gl,this._disabledExtensions),this._disjointTimerQuery}get colorBufferFloat(){return this._colorBufferFloat??=i.loadColorBufferFloat(this._gl,this._disabledExtensions),this._colorBufferFloat}get textureNorm16(){return this._textureNorm16??=i.loadTextureNorm16(this._gl,this._disabledExtensions),this._textureNorm16}get textureFloatLinear(){return this._textureFloatLinear??=i.loadBooleanExtension(this._gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"]),this._textureFloatLinear}get parallelShaderCompile(){return this._parallelShaderCompile??=i.loadBooleanExtension(this._gl,this._disabledExtensions,"parallelShaderCompile",!1,["KHR_parallel_shader_compile"]),this._parallelShaderCompile}get loseContext(){return this._loseContext??=s.load(this._gl,this._debugWebGLExtensions),this._loseContext}get rendererInfo(){return this._rendererInfo??=t.loadRendererInfo(this._gl),this._rendererInfo}enable(e){return this[e]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/capabilities/DebugRendererInfo":function(){define(["exports"],function(e){"use strict";class t{constructor(e){this.getUnmaskedRenderer=e}}e.RendererInfo=t,e.loadRendererInfo=function(e){const r=e.getExtension("WEBGL_debug_renderer_info");return r?new t(()=>e.getParameter(r.UNMASKED_RENDERER_WEBGL)):null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/capabilities/load":function(){define(["exports"],function(e){"use strict";e.loadBooleanExtension=function(e,t,r,i,s){if(i)return!0;if(t[r])return!1;for(const t of s)if(e.getExtension(t))return!0;return!1},e.loadColorBufferFloat=function(e,t){const r=!t.colorBufferHalfFloat&&e.getExtension("EXT_color_buffer_half_float")||!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),i=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return r||i||s?{textureFloat:!!i,textureHalfFloat:!!r,floatBlend:!!s,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F}:null},e.loadCompressedTextureETC=function(e,t){if(t.compressedTextureETC)return null;const r=e.getExtension("WEBGL_compressed_texture_etc");return r?{COMPRESSED_R11_EAC:r.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:r.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:r.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:r.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:r.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:r.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:r.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:r.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null},e.loadCompressedTextureS3TC=function(e,t){if(t.compressedTextureS3TC)return null;const r=e.getExtension("WEBGL_compressed_texture_s3tc");return r?{COMPRESSED_RGB_S3TC_DXT1:r.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:r.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:r.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:r.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null},e.loadTextureFilterAnisotropicCapability=function(e,t){if(t.textureFilterAnisotropic)return null;const r=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return r?{MAX_TEXTURE_MAX_ANISOTROPY:r.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:r.TEXTURE_MAX_ANISOTROPY_EXT}:null},e.loadTextureNorm16=function(e,t){if(t.textureNorm16)return null;const r=e.getExtension("EXT_texture_norm16");return r?{R16:r.R16_EXT,RG16:r.RG16_EXT,RGB16:r.RGB16_EXT,RGBA16:r.RGBA16_EXT,R16_SNORM:r.R16_SNORM_EXT,RG16_SNORM:r.RG16_SNORM_EXT,RGB16_SNORM:r.RGB16_SNORM_EXT,RGBA16_SNORM:r.RGBA16_SNORM_EXT}:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/capabilities/LoseContext":function(){define(["exports"],function(e){"use strict";e.load=function(e,t){const r=t.loseContext&&e.getExtension("WEBGL_lose_context");return r?{loseRenderingContext:()=>r.loseContext()}:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/RenderingContextOptions":function(){define(["exports","../../../webgl/RenderingContextOptions"],function(e,t){"use strict";class r extends t.RenderingContextOptions{constructor(e){super(e.options.deactivatedWebGLExtensions||{},e.options.debugWebGLExtensions||{},8,e.view.qualitySettings.maxTexturePixels),this.newCache=(t,r)=>e.view.resourceController.memoryController.newCache(t,r)}}e.RenderingContextOptions=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/RenderingContextOptions":function(){define(["exports"],function(e){"use strict";e.RenderingContextOptions=class{constructor(e={},t={},r=8,i=1/0){this.disabledExtensions=e,this.debugWebGLExtensions=t,this.maxAnisotropy=r,this.maxPreferredTexturePixels=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextureRepository":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./ITexture","./TextureUpdater","../../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.TextureRepository=class extends r{constructor(e){super({}),this._stage=e,this._textures=new Map,this._loadingCount=0,this.events=new i.EventEmitter,this.updater=new d.TextureUpdater,this._frameTask=e.view.resourceController.scheduler.registerTask(h.TaskPriority.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this.updater.destroy(),this._textures.forEach(e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}acquire(e){const t=this._textures.get(e);return t?(t.ref(),t.loadingPromise??t):this._createNewRef(e)}update(){this.updater.run()&&this.events.emit("changed",0)}_createNewRef(e){const t=this._stage.getTexture(e);if(null==t)return null;const r=t.events.on("unloaded",()=>{r.remove(),this._onTextureUnloaded(t)}),i=new p(t,()=>{this._frameTask.schedule(()=>{i.isUnreferenced&&t.unload()})});return this._textures.set(e,i),i.ref(),t.loaded?(this._updateGLTexture(i,t.glTexture),u.isUpdatableTexture(t)&&this.updater.add(t),i):(this._loadingCount++,i.loadingPromise=this._stage.schedule(()=>{const e=t.load(this._stage.renderView.renderingContext),r=e=>(this._loadingCount--,i.loadingPromise=null,this._updateGLTexture(i,e),u.isUpdatableTexture(t)&&this.updater.add(t),i);return n.isPromiseLike(e)?e.then(r,e=>(t.unload(),this._loadingCount--,i.loadingPromise=null,n.isAbortError(e)||s.getLogger(this).error(e),null)):r(e)}),i.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",1)}_onTextureUnloaded(e){this._textures.delete(e.id),this.updater.remove(e)}},t.__decorate([o.property()],e.TextureRepository.prototype,"_loadingCount",void 0),t.__decorate([o.property()],e.TextureRepository.prototype,"_frameTask",void 0),t.__decorate([o.property()],e.TextureRepository.prototype,"updating",null),e.TextureRepository=t.__decorate([c.subclass("esri.views.3d.webgl-engine.lib.TextureRepository")],e.TextureRepository);class p{constructor(e,t){this._texture=e,this._release=t,this._refCount=0}get id(){return this._texture.id}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(s.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}unload(){this._texture.unload()}}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/ITexture":function(){define(["exports"],function(e){"use strict";e.isUpdatableTexture=function(e){return!!e.update},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/TextureUpdater":function(){define(["exports"],function(e){"use strict";class t{constructor(e){this.texture=e,this.previousToken=-1}}e.TextureUpdater=class{constructor(){this._updating=new Map}destroy(){this._updating.clear()}add(e){this._updating.set(e.id,new t(e))}remove(e){this._updating.delete(e.id)}run(){let e=!1;return this._updating.forEach(t=>{const r=t.texture.update(t.previousToken);r>=0&&r!==t.previousToken&&(t.previousToken=r,e=!0)}),e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/markerTextureRepository":function(){define(["exports","../../support/engineContent/marker","./ProceduralTextureRepository"],function(e,t,r){"use strict";e.createMarkerTextureRepository=function(e,i){return new r.ProceduralTextureRepository(r=>t.createMarkerTexture(r,e),e=>e,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/internal/WaterTextureRepository":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../assets","../../../../../core/Accessor","../../../../../core/asyncUtils","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../support/requestImageUtils","../../../../webgl/NoParameters","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";e.WaterTextureRepository=class extends i{constructor(){super(...arguments),this._passParameters=new g,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=o.abortMaybe(this._resourcesTask),this._passParameters.waveNormal=o.disposeMaybe(this._passParameters.waveNormal),this._passParameters.wavePerturbation=o.disposeMaybe(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=s.createTask(async t=>{await Promise.allSettled([this._loadImageResource(e,r.getAssetUrl("esri/images/materials/water/normals.jpg"),e=>this._passParameters.waveNormal=e,t),this._loadImageResource(e,r.getAssetUrl("esri/images/materials/water/perturbation.jpg"),e=>this._passParameters.wavePerturbation=e,t)])})),this._resourcesTask.finished?2:1}async _loadImageResource(e,t,r,i){try{const s=await h.requestImage(t,{signal:i});a.throwIfAborted(i);const n=new m.TextureDescriptor(s.width,s.height);n.pixelFormat=6407,n.samplingMode=9987,n.hasMipmap=!0,n.maxAnisotropy=8,r(new f.Texture(e,n,s))}catch(e){n.getLogger(this).error("Failed to load water material normal texture.",e)}}},t.__decorate([l.property()],e.WaterTextureRepository.prototype,"_resourcesTask",void 0),t.__decorate([l.property({type:Boolean,readOnly:!0})],e.WaterTextureRepository.prototype,"updating",null),e.WaterTextureRepository=t.__decorate([d.subclass("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],e.WaterTextureRepository);class g extends p.NoParameters{}e.WaterTexturePassParameters=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/parts/contextCache":function(){define(["exports"],function(e){"use strict";const t=new Map;e.getContextCache=function(){return t},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/parts/ScreenshotManager":function(){define(["exports","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../support/screenshotUtils","../../../webgl/enums","../../../webgl/FramebufferObject","../../../../core/imageUtils"],function(e,t,r,i,s,n,o){"use strict";e.ScreenshotContext=class{constructor(e,t){this.parameters=e,this.fbos=t}},e.ScreenshotManager=class{constructor(e,t,r){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=r,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(0);const r=t.createResolver();return this._screenshotQueue.push({settings:e,resolver:r}),r.promise}update(e,t){for(const r of this._screenshotQueue){if(null==this._rctx){r.resolver.reject();continue}const i={...r.settings,pixelRatio:r.settings.pixelRatio*e.parameters.camera.pixelRatio},s=this._renderScreenshot(e,i,t);r.resolver(s)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,r){e.width=t.width,e.height=t.height;const i=e.getContext("2d",{willReadFrequently:!0}),s=r.pixelRatio;return i.save(),i.translate(0,t.height),i.scale(1,-1),r.region&&i.translate(-r.region.x,-r.region.y),i.scale(s,s),t=this._renderFunctions.renderOverlay(e,r.disableDecorations,t),i.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:r,framebufferHeight:n,region:a,resample:l}=e,c=this._ensureScreenshotEncodeCanvas();let u=o.createEmptyImageData(r,n,c);this._rctx.gl.readPixels(0,0,r,n,6408,s.DataType.UNSIGNED_BYTE,new Uint8Array(u.data.buffer)),t(),u=this._renderScreenshotOverlay(c,u,{...e,region:void 0});const d=o.createEmptyImageData(a.width,a.height,c);return i.resampleHermite(u,d,!0,l.region.x,n-(l.region.y+l.region.height),l.region.width,l.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:r,region:i}=e,n=this._ensureScreenshotEncodeCanvas(),a=o.createEmptyImageData(i.width,i.height,n);return this._rctx.gl.readPixels(i.x,r-(i.y+i.height),i.width,i.height,6408,s.DataType.UNSIGNED_BYTE,new Uint8Array(a.data.buffer)),t(),this._renderScreenshotOverlay(n,a,e)}_renderScreenshot(e,t,i){const s=e.parameters.camera,{framebufferWidth:o,framebufferHeight:a,ignorePadding:l,pixelRatio:c,disableDecorations:u,olidColor:d}=t,h={width:o,height:a};n.ensureAttachmentMaxSize(h,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let p=!1;const f=h.width!==s.fullWidth||h.height!==s.fullHeight,m=l&&s.pixelRatio!==c,g=f||u||m||d;let y=null,_=null;if(g){const e=s.clone();if(l){const t=r.clone(e.padding);for(let r=0;r<4;r++)t[r]=Math.round(t[r]/e.pixelRatio*c);e.padding=t}e.fullWidth=h.width,e.fullHeight=h.height,e.pixelRatio=c;const t=s.fovX-e.fovX,n=s.fovY-e.fovY;t<0&&t<n?e.fovX=s.fovX:n<0&&n<t&&(e.fovY=s.fovY);const o={camera:e,contentCamera:e,mode:2,alignPixelEnabled:!0,contentPixelRatio:e.pixelRatio};this._forceCameraHook(o),p=!0;const a=this._renderFunctions.renderScene(o,i,d?2:1,u);_=a.screen,y=a.olid}this._rctx.bindFramebuffer(_?.fbo);const b=this._readbackScreenshot(t,()=>{this._rctx.bindFramebuffer(null),_?.release()});let v=null;if(d){const e=()=>{this._rctx.bindFramebuffer(null),y?.release()};this._rctx.bindFramebuffer(y?.fbo),v=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null)}if(g&&!this._rctx.contextAttributes.alpha)for(let e=3;e<b.data.length;e+=4)b.data[e]=255;if(v&&!this._rctx.contextAttributes.alpha)for(let e=3;e<v.data.length;e+=4)v.data[e]=255;return p&&this._forceCameraHook(e.parameters),[b,v]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??=document.createElement("canvas"),this._screenshotEncodeCanvas}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/screenshotUtils":function(){define(["exports","../../core/has","../../core/mathUtils","../../core/imageUtils"],function(e,t,r,i){"use strict";function s(e,t){const{format:i,quality:s,rotation:n,disableDecorations:o}=e||{},a=c(e,t.padding),l=function(e,t){const r={x:0,y:0,width:t.width,height:t.height};if(e?.area){null!=e.area.x&&(r.x=Math.floor(e.area.x)),null!=e.area.y&&(r.y=Math.floor(e.area.y));const i=null!=e.area.width?Math.floor(e.area.width):null,s=null!=e.area.height?Math.floor(e.area.height):null;if(r.width=t.width-r.x,r.height=t.height-r.y,null!=i&&null!=s)r.width=Math.min(r.width,i),r.height=Math.min(r.height,s);else if(null==i&&null!=s){const e=Math.min(r.width,i);r.height=e/r.width*r.height,r.width=e}else if(null!=i&&null==s){const e=Math.min(r.height,s);r.width=e/r.height*r.width,r.height=e}}return function(e,t){const r=Math.floor(Math.max(e.x,0)),i=Math.floor(Math.max(e.y,0)),s={x:r,y:i,width:Math.floor(Math.min(e.width,t.width-r)),height:Math.floor(Math.min(e.height,t.height-i))},n=s.width/s.height,o=e.width/e.height;if(o===n)return s;if(o>n){const e=Math.floor(s.width/o),t=s.height-e;return{x:s.x,y:Math.floor(s.y+t/2),width:s.width,height:e}}const a=Math.floor(s.height*o),l=s.width-a;return{x:Math.floor(s.x+l/2),y:s.y,width:a,height:s.height}}(function(e,t){if(null==t?.width||null==t.height)return e;const r=t.width/t.height,i=e.width/e.height;if(i===r)return e;if(i<r){const t=Math.floor(e.height*r);return e.x-=(t-e.width)/2,e.width=t,e}const s=Math.floor(e.width/r);return e.y-=(s-e.height)/2,e.height=s,e}(r,e),t)}(e,{width:t.width-a.left-a.right,height:t.height-a.top-a.bottom}),{width:d,height:h}=function(e,t){if(!e)return t;const r=e.width,i=e.height;if(null!=r&&null!=i)return{width:Math.floor(r),height:Math.floor(i)};if(null==r&&null==i)return t;const s=t.width/t.height;return null==i?{width:Math.floor(r),height:Math.floor(r/s)}:{width:Math.floor(i*s),height:Math.floor(i)}}(e,l),f=u(i),m=p[f];return{format:f,quality:r.clamp(null!=s?s:m,0,100),area:l,width:d,height:h,rotation:n,disableDecorations:!!o,ignoreBackground:!!e?.ignoreBackground,ignorePadding:!!e?.ignorePadding}}function n(e,t){const r=(null==a&&(a=document.createElement("canvas")),a);t.premultipliedAlpha&&function(e){const t=e.data,r=t.length;for(let e=0;e<r;e+=4){const r=t[e+3];if(255!==r&&r>0){const i=255/r;t[e]=t[e]*i,t[e+1]=t[e+1]*i,t[e+2]=t[e+2]*i}}}(e),r.width=e.width,r.height=e.height;const i=r.getContext("2d",{willReadFrequently:!0});return i.putImageData(e,0,0),t.flipY&&function(e){e.save(),e.globalCompositeOperation="copy",e.scale(1,-1),e.translate(0,-e.canvas.height),e.drawImage(e.canvas,0,0),e.restore()}(i),{ctx:i,canvas:r}}function o(e){e.width=0,e.height=0}let a=null;function l(e,t){const r=d[t.format],i=t.quality/100;return e.toDataURL(r,i)}function c(e,t){return!t||e?.ignorePadding?f:t}function u(e){switch(e){case"png":case"jpg":case"jpeg":return e;default:return h}}const d={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},h="png",p={png:100,jpg:98,jpeg:98},f={top:0,right:0,bottom:0,left:0};e.createEmptyImageData=i.createEmptyImageData,e.completeUserSettings=s,e.encode=function(e,t,r){const{ctx:i,canvas:s}=n(e,r),a=i.getImageData(0,0,e.width,e.height),c=l(s,t);return o(s),{dataUrl:c,data:a}},e.encodeData=function(e,t){const{ctx:r,canvas:i}=n(e,t),s=r.getImageData(0,0,e.width,e.height);return o(i),s},e.getFormatAndQuality=function(e,t){const i=u(e),s=p[i];return{format:i,quality:r.clamp(null!=t?t:s,0,100)}},e.getMaximumResolutionScale=function(e,t){return t/Math.max(e[0],e[1])},e.resampleHermite=function(e,t,r,i=0,s=0,n=e.width-i,o=e.height-s,a=!1){const{data:l}=e,{width:c,height:u,data:d}=t,h=n/c,p=o/u,f=Math.ceil(h/2),m=Math.ceil(p/2),g=e.width;for(let e=0;e<u;e++)for(let t=0;t<c;t++){const n=4*(t+(a?u-e-1:e)*c);let o=0,y=0,_=0,b=0,v=0,w=0;const x=(e+.5)*p;for(let n=Math.floor(e*p);n<(e+1)*p;n++){const e=Math.abs(x-(n+.5))/m,a=(t+.5)*h,c=e*e;for(let e=Math.floor(t*h);e<(t+1)*h;e++){const t=Math.abs(a-(e+.5))/f,u=Math.sqrt(c+t*t);if(u>=1)continue;let d=2*u*u*u-3*u*u+1;const h=4*(i+e+(s+n)*g);w+=d*l[h+3],y+=d,!r&&l[h+3]<255&&(d=d*l[h+3]/255),_+=d*l[h],b+=d*l[h+1],v+=d*l[h+2],o+=d}}d[n]=_/o,d[n+1]=b/o,d[n+2]=v/o,d[n+3]=w/y}return t},e.screenshotSuperSampleSettings=function(e,t,r){if(!t)return e;const{framebufferWidth:i,framebufferHeight:s,pixelRatio:n,region:o}=e,a=c(e,r),l=a.left+a.right,u=a.top+a.bottom,d=i-l,h=s-u,p=Math.min(8,Math.min((2048-l)/d,(2048-u)/h));return p<1.5?e:{...e,framebufferWidth:Math.round(d*p)+l,framebufferHeight:Math.round(h*p)+u,pixelRatio:n*p,resample:{region:{x:Math.round((o.x-a.left)*p)+a.left,y:Math.round((o.y-a.top)*p)+a.top,width:Math.round(o.width*p),height:Math.round(o.height*p)},width:i,height:s}}},e.toDataUrl=l,e.toRenderSettings=function(e,t){const r=s(e,t),i=r.area,n=r.width/i.width,o=c(r,t.padding),a=o.left+o.right,l=o.top+o.bottom,u=t.width-a,d=t.height-l,h=Math.floor(u*n+a),p=Math.floor(d*n+l),f=e?.layers??[],m=r.ignoreBackground,g=r.ignorePadding;return{framebufferWidth:h,framebufferHeight:p,region:{x:Math.floor(i.x*n)+o.left,y:Math.floor(i.y*n)+o.top,width:r.width,height:r.height},format:r.format,quality:r.quality,rotation:r.rotation,pixelRatio:n,layers:f,disableDecorations:r.disableDecorations,ignoreBackground:m,ignorePadding:g,olidColor:!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/imageUtils":function(){define(["require","exports","../request","./Error","./promiseUtils","./urlUtils","../support/base64Utils"],function(e,t,r,i,s,n,o){"use strict";let a=null,l=!0;function c(e,t,r){return r||(a||(a=document.createElement("canvas"),a.width=1,a.height=1),r=a),r.getContext("2d").createImageData(e,t)}t.createEmptyImageData=function(e,t,r){if(!e||!t)throw new Error("Cannot construct image data without dimensions");if(l)try{return new ImageData(e,t)}catch(e){l=!1}return c(e,t,r)},t.getImageData=async function(t,a){const{arrayBuffer:l,mediaType:c}=await async function(e,t){const i=n.dataComponents(e);if(i?.isBase64)return{arrayBuffer:o.base64ToArrayBuffer(i.data),mediaType:i.mediaType};const s=await r(e,{responseType:"array-buffer",...t});return{arrayBuffer:s.data,mediaType:s.getHeader?.("Content-Type")??""}}(t,a),u="image/png"===c;if("image/gif"===c){const{isAnimatedGIF:t,parseGif:r}=await new Promise((t,r)=>e(["./image/gif"],t,r));if(t(l))return r(l,a)}if(u){const{isAnimatedPNG:t,parseApng:r}=await new Promise((t,r)=>e(["./image/apng"],t,r));if(t(l))return r(l,a)}return async function(e,t){const n=window.URL.createObjectURL(e);try{const{data:e}=await r(n,{...t,responseType:"image"});return e}catch(e){if(!s.isAbortError(e))throw new i("invalid-image",`Could not fetch requested image at ${n}`);throw e}finally{window.URL.revokeObjectURL(n)}}(new Blob([l],{type:c}),a)},t.wrapImageData=function(e,t,r,i){if(!t||!r)throw new Error("Cannot construct image data without dimensions");if(l)try{return new ImageData(e,t,r)}catch(e){l=!1}const s=c(t,r,i);return s.data.set(e,0),s},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/parts/testUtils":function(){define(["exports","./contextCache"],function(e,t){"use strict";const r={enabled:!1,disposeContextCache:()=>{const e=t.getContextCache();e.forEach(e=>e.dispose()),e.clear()}};e.contextCache=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/edgeRendering/edgePreprocessing":function(){define(["exports","../../../../../core/mathUtils","../../../../../core/PooledArray","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./Edge"],function(e,t,r,i,s,n){"use strict";class o{constructor(){this.index=0,this.length=0}}const a=new r({allocator:e=>e||new o,deallocator:null}),l=new r({deallocator:null}),c=new r({deallocator:null}),u=new n.Edge,d=s.create(),h=s.create(),p=s.create(),f=s.create(),m=s.create(),g=t.deg2rad(4),y=Math.cos(g),_=t.deg2rad(35),b=Math.cos(_);e.cleanupEdgeProcessing=function(){a.prune(),l.prune(),c.prune()},e.extractEdges=function(e,r,s){const n=e.vertices.position,o=e.vertices.componentIndex,_=u.position0,v=u.position1,w=u.faceNormal0,x=u.faceNormal1,{edges:S,normals:T}=function(e){const t=e.faces.length/3,r=e.faces,s=e.neighbors,n=e.vertices.position;l.length=c.length=0;for(let e=0;e<t;e++){const t=3*e,o=s[t],a=s[t+1],u=s[t+2],d=r[t],h=r[t+1],g=r[t+2];n.getVec(d,p),n.getVec(h,f),n.getVec(g,m),i.subtract(f,f,p),i.subtract(m,m,p),i.cross(p,f,m),i.normalize(p,p),c.pushArray(p),(-1===o||d<h)&&(l.push(d),l.push(h),l.push(e),l.push(o)),(-1===a||h<g)&&(l.push(h),l.push(g),l.push(e),l.push(a)),(-1===u||g<d)&&(l.push(g),l.push(d),l.push(e),l.push(u))}return{edges:l,normals:c}}(e),C=S.length/4,P=r.allocate(C);let M=0;const R=C,O=s?.allocate(R);let I=0,F=0,A=0;a.length=0;for(let e=0;e<C;++e){const t=4*e;n.getVec(S.data[t],_),n.getVec(S.data[t+1],v);const r=a.pushNew();r.index=4*e,r.length=i.distance(_,v)}a.sort((e,t)=>t.length-e.length);const D=new Array,E=new Array;a.forAll(({length:e,index:a})=>{const l=S.data[a],c=S.data[a+1],p=S.data[a+2],f=S.data[a+3],m=-1===f;if(n.getVec(l,_),n.getVec(c,v),m){const e=3*p;i.set(w,T.data[e],T.data[e+1],T.data[e+2]),i.copy(x,w),u.componentIndex=o.get(l),u.cosAngle=i.dot(w,x)}else{let e=3*p;if(i.set(w,T.data[e],T.data[e+1],T.data[e+2]),e=3*f,i.set(x,T.data[e],T.data[e+1],T.data[e+2]),u.componentIndex=o.get(l),u.cosAngle=i.dot(w,x),C=y,u.cosAngle>C)return;u.cosAngle<-.9999&&i.copy(x,w)}var C,R;F+=e,A++,m||(R=b,u.cosAngle<R)?(r.write(P,M++,u),D.push(e)):function(e,r){const s=t.acosClamped(e.cosAngle);return i.direction(h,e.position1,e.position0),s*(i.dot(i.cross(d,e.faceNormal0,e.faceNormal1),h)>0?-1:1)>r}(u,g)&&(O&&s&&s.write(O,I++,u),E.push(e))});const L=new Float32Array(D.reverse()),V=new Float32Array(E.reverse()),U=O&&s?{instancesData:O.slice(0,I),lodInfo:{lengths:V}}:void 0;return{regular:{instancesData:P.slice(0,M),lodInfo:{lengths:L}},silhouette:U,averageEdgeLength:F/A}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/edgeRendering/Edge":function(){define(["exports","../../../../../core/libs/gl-matrix-2/factories/vec3f64"],function(e,t){"use strict";e.Edge=class{constructor(){this.position0=t.create(),this.position1=t.create(),this.faceNormal0=t.create(),this.faceNormal1=t.create(),this.componentIndex=0,this.cosAngle=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/drapedUtils":function(){define(["exports","../../core/unitUtils","../../geometry/Extent","../../renderers/support/clickToleranceUtils"],function(e,t,r,i){"use strict";function s(e,i,s,n=new r){let o=0;if("2d"===s.type)o=i*(s.resolution??0);else if("3d"===s.type){const r=s.overlayPixelSizeInMapUnits(e),n=s.basemapSpatialReference;o=null==n||n.equals(s.spatialReference)?i*r:t.getMetersPerUnitForSR(n)/t.getMetersPerUnitForSR(s.spatialReference)}const a=e.x-o,l=e.y-o,c=e.x+o,u=e.y+o,{spatialReference:d}=s;return n.xmin=Math.min(a,c),n.ymin=Math.min(l,u),n.xmax=Math.max(a,c),n.ymax=Math.max(l,u),n.spatialReference=d,n}let n=new r;e.cleanupDrapedUtils=function(){n=new r},e.createQueryGeometry=s,e.intersectsDrapedGeometry=function(e,t,r){const o=r.toMap(e);return null!=o&&s(o,i.calculateTolerance(),r,n).intersects(t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/renderers/support/clickToleranceUtils":function(){define(["exports"],function(e){"use strict";function t(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function r(e,t){return"number"==typeof e?e:e?.stops?.length?function(e){let t=0,r=0;for(let i=0;i<e.length;i++){const s=e[i].size;"number"==typeof s&&(t+=s,r++)}return t/r}(e.stops):t}e.calculateTolerance=function(e){const i=e?.renderer,s=e?.pointerType,n="touch"===s?9:6;if(!i)return n;const o="visualVariables"in i?function(e,t){if(!t)return e;const i=t.filter(e=>"size"===e.type).map(t=>{const{maxSize:i,minSize:s}=t;return(r(i,e)+r(s,e))/2});let s=0;const n=i.length;if(0===n)return e;for(let e=0;e<n;e++)s+=i[e];const o=Math.floor(s/n);return Math.max(o,e)}(n,i.visualVariables):n;if("simple"===i.type)return t(o,i.symbol);if("unique-value"===i.type){let e=o;return i.uniqueValueInfos?.forEach(r=>{e=t(e,r.symbol)}),e}if("class-breaks"===i.type){let e=o;return i.classBreakInfos.forEach(r=>{e=t(e,r.symbol)}),e}return"dot-density"===i.type||i.type,o},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/TextureCompressionHelper":function(){define(["exports","../../core/Logger","../3d/layers/support/makeScheduleFunction","./TextureCompressionWorkerHandle","../webgl/Texture"],function(e,t,r,i,s){"use strict";const n=new Set,o=()=>t.getLogger("esri/views/support/TextureCompressionHelper");e.destroyTextureCompressionWorker=function(e){const t=s.Texture.compressionWorkerHandle;t&&(n.delete(e)||o().warn("Unknown view attempted to destroy the texture compression worker."),n.size||(t.destroyWorkerAndSelf(),s.Texture.compressionWorkerHandle=null))},e.initializeTextureCompressionWorker=function(e,t){return s.Texture.compressionWorkerHandle??=new i.TextureCompressionWorkerHandle(r.makeScheduleFunction(t)),n.has(e)?o().warn("Repeated texture compression worker initialization by the same view."):n.add(e),s.Texture.compressionWorkerHandle},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/makeScheduleFunction":function(){define(["exports","../../../../core/promiseUtils","../../../support/Scheduler"],function(e,t,r){"use strict";e.makeScheduleFunction=function(e){return i=>{if(e.destroyed){const e=i(r.noBudget);return t.isPromiseLike(e)?e:Promise.resolve(e)}if(e.immediate)return e.immediate.schedule(i);const s="No immediate scheduler";throw console.error(s),new Error(s)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/WebGLRequirements":function(){define(["exports","../../core/Error","../webgl/capabilities"],function(e,t,r){"use strict";e.check=function(e){const i=r.getWebGLCapabilities();return i.available?"3d"===e&&i.majorPerformanceCaveat?new t("webgl:major-performance-caveat-detected",`Your WebGL implementation (${i.unmaskedRenderer}) doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.`):i.supportsHighPrecisionFragment?i.supportsVertexShaderSamplers?null:new t("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported."):new t("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported."):new t("webgl:required","WebGL2 is required but not supported.",(new Error).stack)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/capabilities":function(){define(["exports","./capabilities/DebugRendererInfo"],function(e,t){"use strict";let r;class i{constructor(){this.available=!1,this.majorPerformanceCaveat=!1,this.maxTextureSize=0,this.supportsVertexShaderSamplers=!1,this.supportsHighPrecisionFragment=!1,this.supportsColorBufferFloat=!1,this.supportsColorBufferFloatBlend=!1,this.supportsColorBufferHalfFloat=!1,this.unmaskedRenderer="unloaded"}}e.getWebGLCapabilities=function(){return r??=function(){const e=new i,r=function(e){if("undefined"==typeof WebGL2RenderingContext)return null;const r=document.createElement("canvas");if(!r)return null;let i=r.getContext("webgl2",{failIfMajorPerformanceCaveat:!0});if(null==i&&(i=r.getContext("webgl2"),null!=i&&(e.majorPerformanceCaveat=!0,e.unmaskedRenderer=t.loadRendererInfo(i)?.getUnmaskedRenderer()??"unknown")),null==i)return i;e.available=!0,e.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),e.supportsVertexShaderSamplers=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0;const s=i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT);return s&&(e.supportsHighPrecisionFragment=s.precision>0),i}(e);return null==r||(e.supportsColorBufferFloat=null!==r.getExtension("EXT_color_buffer_float"),e.supportsColorBufferFloatBlend=null!==r.getExtension("EXT_float_blend"),e.supportsColorBufferHalfFloat=e.supportsColorBufferFloat||null!==r.getExtension("EXT_color_buffer_half_float")),e}(),r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/ui/DefaultUI":function(){define(["../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./Component","./UI","../../widgets/Attribution","../../widgets/Compass","../../widgets/NavigationToggle","../../widgets/Zoom"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";let p=class extends l{constructor(e){super(e),this._defaultPositionLookup={attribution:"manual",compass:"top-left","navigation-toggle":"top-left",zoom:"top-left"},this.components=[],this._updateViewAwareWidgets=e=>{this.components.forEach(t=>{const r=this._find(t),i=r?.widget;(function(e){return void 0!==e?.view})(i)&&(i.view=e)})},this._componentsWatcher=(e,t)=>{this._removeComponents(t),this._addComponents(e),this._adjustPadding(e)}}initialize(){this.addHandles([i.watch(()=>this.components,this._componentsWatcher,i.initial),i.watch(()=>this.view,this._updateViewAwareWidgets,i.initial)])}_add(e,t,r,i,s){let n=e;if("string"==typeof e&&this._defaultPositionLookup[e]){if(this._find(e))return;n=this._createComponent(e)}super._add(n,t,r,i,s)}_removeComponents(e){e.forEach(e=>{const t=this._find(e);t&&(this.remove(t),t.destroy())})}_adjustPadding(e){if(!e.includes("attribution")&&!this._isOverridden("padding")){const{top:e}=this.padding;this.padding=e}}_addComponents(e){this.constructed&&e.forEach(e=>this.add(this._createComponent(e),this._defaultPositionLookup[e]))}_createComponent(e){const t=this._createWidget(e);return new a({id:e,node:t})}_createWidget(e){const t=this.view;switch(e){case"attribution":return new c({view:t});case"compass":return new u({view:t});case"navigation-toggle":return new d({view:t,isDefaultUI:!0});case"zoom":return new h({view:t})}}};return e.__decorate([s.property()],p.prototype,"components",void 0),p=e.__decorate([o.subclass("esri.views.ui.DefaultUI")],p),p})},"esri/views/ui/UI":function(){define(["../../chunks/tslib.es6","../../intl","../../core/Accessor","../../core/arrayUtils","../../core/Evented","../../core/handleUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/has","../../core/accessorSupport/decorators/subclass","../../support/modeUtils","./Component","../../widgets/support/widgetUtils","../../intl/locale"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";const m={left:0,top:0,bottom:0,right:0},g={bottom:30,top:15,right:15,left:15},y="esri-ui",_={ui:y,corner:`${y}-corner`,innerContainer:`${y}-inner-container`,manualContainer:`${y}-manual-container`,cornerContainer:`${y}-corner-container`,topLeft:`${y}-top-left`,topRight:`${y}-top-right`,bottomLeft:`${y}-bottom-left`,bottomRight:`${y}-bottom-right`};function b(e){return 0===e?"0":`${e}px`}function v(e){const t="object"==typeof e&&null!==e&&Object.getPrototypeOf(e);return null!==t&&t!==Object.prototype||!("component"in e||"index"in e||"position"in e)?null:e}function w(e,{top:t,bottom:r,left:i,right:s}){e.style.top=t,e.style.bottom=r,e.style.left=i,e.style.right=s}let x=class extends s.EventedAccessor{constructor(e){super(e),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentMap=new Map,this._removeWidgetHandleKey=Symbol("componentOnRemoveSymbol"),this._locale=f.getLocale(),this.view=null,this._applyViewPadding=()=>{const e=this.container;e&&w(e,this._toPixelPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const e=this._innerContainer;e&&w(e,this._toPixelPosition(this.padding))},this._initContainers()}initialize(){this.addHandles([o.watch(()=>[this.view?.padding,this.container],this._applyViewPadding,o.initial),o.watch(()=>this.padding,this._applyUIPadding,o.initial),o.watch(()=>[this.container,this._locale],([e,t])=>{e&&e.setAttribute("lang",t)},o.initial),f.onLocaleChange(e=>{this._locale=e})])}destroy(){this.removeAllHandles(),this.container=null;for(const e of this._components)e.destroy();this._components.length=0,this._componentMap.clear(),this.view=null,this._set("view",null)}set container(e){const t=this._get("container");e!==t&&(e&&(e.classList.add(_.ui),d.setCalciteModeClass(e),this._attachContainers(e)),t&&(t.classList.remove(_.ui),w(t,{top:"",bottom:"",left:"",right:""}),t.textContent=""),this._set("container",e))}get height(){const e=this.view?.height??0;if(0===e)return e;const t=this._getViewPadding(),{top:r,bottom:i}=t;return Math.max(e-r-i,0)}get padding(){return this._get("padding")}set padding(e){this._overrideIfSome("padding",e)}castPadding(e){return"number"==typeof e?{bottom:e,top:e,right:e,left:e}:{...g,...e}}get width(){const e=this.view?.width??0;if(0===e)return e;const t=this._getViewPadding(),{left:r,right:i}=t;return Math.max(e-r-i,0)}add(e,t){let r,i,s;if(Array.isArray(e))return void e.forEach(e=>this.add(e,t));const n=v(e);n&&({index:r,position:t,component:e,key:i}=n),t&&"object"==typeof t&&({index:r,key:i,position:t,internal:s}=t),!e||t&&!this._isValidPosition(t)||this._add(e,t,r??this._getNumComponentsAtPosition(t),i,s)}remove(e,t){if(!e)return;if(Array.isArray(e))return e.map(e=>this.remove(e,t));const r=this._find(e);if(r){const e=this._componentMap.get(r);if(!e||e.key!==t)return;const i=this._components.indexOf(r),s=r.node.parentNode;return s?.removeChild(r.node),this._componentMap.delete(r),r.widget?.removeHandlesReference(this._removeWidgetHandleKey),this._components.forEach(t=>{const r=this._componentMap.get(t);r&&r.position===e.position&&r.index>e.index&&r.index--}),this._components.splice(i,1)[0]}}empty(e,t={removeInternal:!1}){if(Array.isArray(e)){for(const r of e)this.empty(r,t);return}const r=this._positionNameToContainerLookup[e??"manual"],i=Array.prototype.slice.call(r.children).map(e=>this._findByNode(e)).filter(e=>null!=e&&(!this._componentMap.get(e)?.internal||t.removeInternal));for(const e of i)this.remove(e)}move(e,t){if(Array.isArray(e)&&e.forEach(e=>this.move(e,t)),!e)return;let r;const i=v(e)||v(t);if(i&&(r=i.index,t=i.position,e=i.component||e),t&&!this._isValidPosition(t))return;const s=this.remove(e);s&&this.add(s,{position:t,index:r})}find(e){if(!e)return null;const t=this._findById(e);return t&&(t.widget||t.node)}getComponents(e,t={includeInternal:!1}){return e?Array.isArray(e)?e.flatMap(e=>this._getComponentsAtPosition(e,t)):this._getComponentsAtPosition(e,t):this._components.filter(e=>t.includeInternal||!this._componentMap.get(e)?.internal).map(({widget:e,node:t})=>e??t)}getPosition(e){for(const t in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[t].contains(e))return t;return null}_add(e,t,i,s,o){e instanceof h||(e=new h({node:e}));const{widget:a}=e;null!=a&&a instanceof r&&a.addHandles(n.makeHandle(()=>{queueMicrotask(()=>this.remove(e))}),this._removeWidgetHandleKey),this._components.some(e=>this._componentMap.get(e)?.position===t&&this._componentMap.get(e)?.index===i)&&this._components.forEach(e=>{const r=this._componentMap.get(e);r&&r.position===t&&r.index>=i&&r.index++}),this._place({component:e,position:t,index:i}),this._components.push(e),this._componentMap.set(e,{key:s,position:t,internal:o,index:i})}_find(e){return e?e instanceof h?this._findByComponent(e):"string"==typeof e?this._findById(e):"domNode"in e?this._findByNode(e.domNode):this._findByNode(e):null}_getViewPadding(){return this.view?.padding??m}_attachContainers(e){e.appendChild(this._innerContainer),e.appendChild(this._manualContainer)}_initContainers(){const e=document.createElement("div");e.classList.add(_.innerContainer,_.cornerContainer);const t=document.createElement("div");t.classList.add(_.innerContainer,_.manualContainer);const r=document.createElement("div");r.classList.add(_.topLeft,_.corner),e.appendChild(r);const i=document.createElement("div");i.classList.add(_.topRight,_.corner),e.appendChild(i);const s=document.createElement("div");s.classList.add(_.bottomLeft,_.corner),e.appendChild(s);const n=document.createElement("div");n.classList.add(_.bottomRight,_.corner),e.appendChild(n),this._innerContainer=e,this._manualContainer=t;const o=p.isRTL();this._cornerNameToContainerLookup={"top-left":r,"top-right":i,"bottom-left":s,"bottom-right":n,"top-leading":o?i:r,"top-trailing":o?r:i,"bottom-leading":o?n:s,"bottom-trailing":o?s:n},this._positionNameToContainerLookup={manual:t,...this._cornerNameToContainerLookup}}_isValidPosition(e){return!!this._positionNameToContainerLookup[e]}_place(e){const t=e.position??"manual",{component:r,index:i}=e,s=this._positionNameToContainerLookup[t],n=null!=i&&i>-1;var o;if((o=r.widget)&&!o._started&&"function"==typeof o.postMixInProperties&&"function"==typeof o.buildRendering&&"function"==typeof o.postCreate&&"function"==typeof o.startup&&r.widget.startup(),!n)return void s.appendChild(r.node);const a=Array.from(s.children);if(0!==a.length){for(const e of a){const t=this._findByNode(e);if(t&&i<(this._componentMap.get(t)?.index??0))return void e.parentNode?.insertBefore(r.node,e)}s.appendChild(r.node)}else s.appendChild(r.node)}_toPixelPosition(e){return{top:b(e.top),left:b(e.left),right:b(e.right),bottom:b(e.bottom)}}_findByComponent(e){return this._components.find(t=>t===e)??null}_findById(e){return this._components.find(({id:t})=>t===e)??null}_findByNode(e){return e?this._components.find(({node:t})=>t===e):null}_getComponentsAtPosition(e,t){const r=this._positionNameToContainerLookup[e];return Array.prototype.slice.call(r.children).map(e=>this._findByNode(e)).filter(i.isSome).filter(e=>t.includeInternal||!this._componentMap.get(e)?.internal).map(({widget:e,node:t})=>e??t)}_getNumComponentsAtPosition(e){const t=this._positionNameToContainerLookup[e];return t?.children.length??0}};return e.__decorate([a.property()],x.prototype,"_locale",void 0),e.__decorate([a.property()],x.prototype,"container",null),e.__decorate([a.property()],x.prototype,"height",null),e.__decorate([a.property({value:g})],x.prototype,"padding",null),e.__decorate([l.cast("padding")],x.prototype,"castPadding",null),e.__decorate([a.property()],x.prototype,"view",void 0),e.__decorate([a.property()],x.prototype,"width",null),x=e.__decorate([u.subclass("esri.views.ui.UI")],x),x})},"esri/widgets/Attribution":function(){define(["../chunks/tslib.es6","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","./Attribution/AttributionViewModel","./support/globalCss","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/jsxFactory","./support/widgetUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const f="esri-attribution",m={base:f,poweredBy:`${f}__powered-by`,sources:`${f}__sources`,open:`${f}--open`,sourcesOpen:`${f}__sources--open`,link:`${f}__link`};let g=class extends a{constructor(e,t){super(e,t),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this._resizeObserver=new ResizeObserver(e=>e.forEach(({target:e})=>this._checkSourceTextOverflow(e))),this.itemDelimiter=" | ",this.messages=null,this.viewModel=new l}initialize(){this.addHandles(t.on(()=>this.viewModel?.items,"change",()=>this.scheduleRender()))}destroy(){this._resizeObserver?.disconnect()}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce((e,t)=>(e.includes(t.text)||e.push(t.text),e),[]).join(this.itemDelimiter)}get icon(){return"description"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e={[m.open]:this._isOpen};return h.tsx("div",{bind:this,class:this.classes(m.base,c.globalCss.widget,e),dir:"ltr",onclick:this._toggleState,onkeydown:this._toggleState},this._renderSourcesNode(),this._renderPoweredBy())}_renderPoweredBy(){return h.tsx("div",{class:m.poweredBy},"Powered by"," ",h.tsx("a",{class:m.link,href:"https://www.esri.com/",rel:"noreferrer",target:"_blank"},"Esri"))}_renderSourcesNode(){const e=this._isOpen,t=this._isInteractive,r=t?0:void 0,{attributionText:i}=this,s={[m.sourcesOpen]:e,[c.globalCss.interactive]:t};return h.tsx("div",{afterCreate:this._afterSourcesNodeCreate,bind:this,class:this.classes(m.sources,s),innerHTML:i,tabIndex:r})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth,this._resizeObserver.observe(e)}_checkSourceTextOverflow(e){let t=!1;const{clientHeight:r,clientWidth:i,scrollWidth:s}=e,n=s>i,o=this._attributionTextOverflowed!==n;if(this._attributionTextOverflowed=n,o&&(t=!0),this._isOpen){const e=r<this._prevSourceNodeHeight;this._prevSourceNodeHeight=r,e&&(this._isOpen=!1,t=!0)}t&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};return e.__decorate([r.property()],g.prototype,"_isOpen",void 0),e.__decorate([r.property()],g.prototype,"_isInteractive",null),e.__decorate([r.property()],g.prototype,"_attributionTextOverflowed",void 0),e.__decorate([r.property()],g.prototype,"_prevSourceNodeHeight",void 0),e.__decorate([r.property({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],g.prototype,"attributionText",null),e.__decorate([r.property()],g.prototype,"icon",null),e.__decorate([r.property()],g.prototype,"itemDelimiter",void 0),e.__decorate([r.property()],g.prototype,"label",null),e.__decorate([r.property(),d.messageBundle("esri/widgets/Attribution/t9n/Attribution")],g.prototype,"messages",void 0),e.__decorate([r.property()],g.prototype,"view",null),e.__decorate([r.property({type:l})],g.prototype,"viewModel",void 0),e.__decorate([u.accessibleHandler()],g.prototype,"_toggleState",null),g=e.__decorate([o.subclass("esri.widgets.Attribution")],g),g})},"esri/widgets/Attribution/AttributionViewModel":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/asyncUtils","../../core/Collection","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/Extent","../../geometry/SpatialReference","../../geometry/support/contains","../../geometry/support/webMercatorUtils","../../views/3d/layers/Lyr3DWasm"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";function m(e,t){return e&&"copyright"in e&&(!t||"function"==typeof e.originOf&&"user"===e.originOf("copyright"))}function g(e,t,r){r&&t&&(e.find(e=>e.layerView===t&&e.text===r)||e.push({text:r,layerView:t}))}const y=[];let _=class extends t{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.removeHandles("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new i,this.view=null,this._allLayerViewsChange=e=>{this.removeHandles("suspension"),this.removeHandles("visible-geometry-changed");const t=this.view?.allLayerViews;t&&(this.addHandles(t.map(e=>s.watch(()=>[e.suspended,e.layer?.attributionVisible],()=>this._updateAttributionItems())).toArray(),"suspension"),t.forEach(e=>{"esri.views.3d.layers.Tiles3DLayerView3D"===e.declaredClass&&this.addHandles(e.on("visible-geometry-changed",()=>this._updateAttributionItems()),"visible-geometry-changed")})),e?.removed&&e.removed.forEach(e=>{this._pendingAttributions.delete(e),this._fetchedAttributionData.delete(e)}),this._updateAttributionItems()},this.addHandles([s.on(()=>this.view?.allLayerViews,"change",e=>this._allLayerViewsChange(e),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),s.when(()=>!0===this.view?.stationary,()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.view?.ready?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const e=this.view,t=e?.allLayerViews;if(y.length=0,!e||!t)return void this._clear();t.forEach(t=>{if(t.suspended||!t.layer?.attributionVisible)return;const r=t.layer;if(m(r,"user"))return void g(y,t,r.copyright);if(r.hasAttributionData){if(this._fetchedAttributionData.has(t)){const i=this._fetchedAttributionData.get(t);return void(i?g(y,t,this._getDynamicAttribution(i,e,r)):m(r)&&g(y,t,r.copyright))}return void this._fetchAttributionData(t)}const i="portalItem"in r?r.portalItem?.accessInformation:void 0;g(y,t,i||r.copyright)});const r=t.find(e=>"integrated-mesh-3dtiles"===e.layer?.type);if(this.view&&r){const e=f.getLyr3DWasm(this.view);if(e){const t=e.getAttributionText();for(let e=0;e<t.length;++e)g(y,r,t[e])}}var i,s;i=this.items,s=y,(i.length!==s.length||i.some((e,t)=>e.text!==s[t].text))&&(this.items.removeAll(),this.items.addMany(y)),y.length=0,this.notifyChange("state")}async _fetchAttributionData(e){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);const t=await r.result(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){const r=t.ok?this._createContributionIndex(t.value,"bing-maps"===e.layer.type):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,r)}this._updateAttributionItems()}_createContributionIndex(e,t){const r=e.contributors,i={};if(!r)return i;for(let e=0;e<r.length;e++){const s=r[e],n=s.coverageAreas;if(!n)return;for(const r of n){const n=r.bbox,o=r.zoomMin-(t&&r.zoomMin?1:0),a=r.zoomMax-(t&&r.zoomMax?1:0),l=new u({xmin:n[1],ymin:n[0],xmax:n[3],ymax:n[2],spatialReference:d.WGS84}),c={extent:p.geographicToWebMercator(l),attribution:s.attribution||"",score:null!=r.score?r.score:100,id:e};for(let e=o;e<=a;e++)i[e]??=[],i[e].push(c)}}return i.maxKey=Math.max.apply(null,Object.keys(i)),i}_getDynamicAttribution(e,t,r){const{extent:i,scale:s}=t;let n=r.tileInfo?.scaleToZoom(s)??0;if(n=Math.min(e.maxKey??0,Math.round(n)),!i||null==n||n<=-1)return"";const o=e[n],a=p.project(i.center.clone().normalize(),d.WebMercator),l=new Set;return o?o.filter(e=>{const t=e.id,r=!l.has(t)&&a&&e.extent&&h.extentContainsPoint(e.extent,a);return r&&l.add(t),r}).sort((e,t)=>t.score-e.score||e.objectId-t.objectId).map(e=>e.attribution).join(", "):""}};return e.__decorate([n.property({readOnly:!0,type:i})],_.prototype,"items",void 0),e.__decorate([n.property({readOnly:!0})],_.prototype,"state",null),e.__decorate([n.property()],_.prototype,"view",void 0),_=e.__decorate([c.subclass("esri.widgets.Attribution.AttributionViewModel")],_),_})},"esri/views/3d/layers/Lyr3DWasm":function(){define(["require","exports","../../../core/Error","../../../layers/ILyr3DWasmPerSceneView"],function(e,t,r,i){"use strict";const s=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));let n,o=null;const a=new Map;t.addLayerViewToWasm=async function(t){null==o&&(null==n&&(n=new Promise((t,r)=>e(["../../../layers/Lyr3DWasmPerSceneView"],e=>t(s(e)),r))),o=await n);const l=t.view;let c=a.get(l);c||(c=new o.default({view:l}),a.set(l,c));const u=!!l.stage.renderView.renderingContext.capabilities.compressedTextureS3TC,d=!!l.stage.renderView.renderingContext.capabilities.compressedTextureETC;await c.initializeWasm(u,d);const h=c.add3DTilesLayerView(t);if(h.wasmLayerId<0)throw c.getValidLayerViewCount()<1&&(a.delete(l),0===a.size&&(n=null,o=null)),h.wasmLayerId===i.wasmFailedToInit?new r("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{}):new r("tiles3d:addLayer-failure",h.check?.errorDescription??"The 3d tiles layer description was invalid.",{});return h.wasmLayerId},t.getLyr3DWasm=function(e){return a.get(e)},t.removeLayerViewFromWasm=function(e){const t=e.view,r=a.get(t);r&&r.remove3DTilesLayerView(e)<1&&(a.delete(t),0===a.size&&(n=null,o=null))},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/layers/ILyr3DWasmPerSceneView":function(){define(["exports"],function(e){"use strict";e.invalidLayerView=-1,e.wasmFailedToInit=-2,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/widgets/support/globalCss":function(){define(["exports"],function(e){"use strict";e.globalCss={anchor:"esri-widget__anchor",anchorDisabled:"esri-widget__anchor--disabled",button:"esri-button",buttonDisabled:"esri-button--disabled",buttonHalf:"esri-button--half",buttonSecondary:"esri-button--secondary",buttonSmall:"esri-button--small",buttonTertiary:"esri-button--tertiary",buttonThird:"esri-button--third",disabled:"esri-disabled",empty:"esri-widget__content--empty",emptyIllustration:"esri-widget__content-illustration--empty",heading:"esri-widget__heading",hidden:"esri-hidden",input:"esri-input",interactive:"esri-interactive",loader:"esri-widget__loader",loaderAnimation:"esri-widget__loader-animation",loaderText:"esri-widget__loader-text",menu:"esri-menu",menuHeader:"esri-menu__header",menuItem:"esri-menu__list-item",menuItemActive:"esri-menu__list-item--active",menuItemFocus:"esri-menu__list-item--focus",menuList:"esri-menu__list",panel:"esri-widget--panel",panelHeightOnly:"esri-widget--panel-height-only",primaryTick:"primary-tick",primaryTickAmPm:"primary-tick__ampm",primaryTickLabel:"primary-tick__label",primaryTickLabelKeepAll:"primary-tick__label--keep-all",rotating:"esri-rotating",secondaryTick:"secondary-tick",select:"esri-select",table:"esri-widget__table",widget:"esri-widget",widgetButton:"esri-widget--button",widgetButtonActive:"esri-widget--button-active",widgetDisabled:"esri-widget--disabled"},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/widgets/Compass":function(){define(["require","../chunks/tslib.es6","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","./Compass/CompassViewModel","./Compass/css","../chunks/componentsUtils","./support/globalCss","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";let m=class extends a{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new l,this._reset=()=>{this.viewModel.reset()},this._toRotationTransform=e=>({transform:`rotateZ(${e.z}deg)`})}loadDependencies(){return u.loadCalciteComponents({button:()=>new Promise((t,r)=>e(["../chunks/index2"],t,r)),icon:()=>new Promise((t,r)=>e(["../chunks/index7"],t,r))})}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get icon(){return"rotation"===this.viewModel.state?"arrow-up":"compass-needle"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:t}=this.viewModel,{messages:r}=this;return f.tsx("div",{class:this.classes(c.css.base,d.globalCss.widget)},f.tsx("calcite-button",{class:d.globalCss.widgetButton,disabled:"disabled"===t,kind:"neutral",label:r.reset,onclick:this._reset,round:!0,scale:"s",title:r.reset},f.tsx("div",{"aria-hidden":"true",class:c.css.iconContainer,title:r.reset},f.tsx("calcite-icon",{icon:this.icon,styles:this._toRotationTransform(e)}))))}};return t.__decorate([r.property()],m.prototype,"goToOverride",null),t.__decorate([r.property()],m.prototype,"icon",null),t.__decorate([r.property()],m.prototype,"label",null),t.__decorate([r.property(),p.messageBundle("esri/widgets/Compass/t9n/Compass")],m.prototype,"messages",void 0),t.__decorate([r.property()],m.prototype,"view",null),t.__decorate([r.property({type:l})],m.prototype,"viewModel",void 0),m=t.__decorate([o.subclass("esri.widgets.Compass")],m),m})},"esri/widgets/Compass/CompassViewModel":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../views/2d/navigation/duration","./utils","../support/GoTo"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";let d=class extends(u.GoTo(t)){constructor(e){super(e),this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._watchForView(r.initial)}destroy(){this.view=null}get canShowNorth(){return c.canShowNorth(this.view)}get state(){return!this.view?.ready||"2d"===this.view.type&&!this.view.constraints.rotationEnabled?"disabled":this.canShowNorth?"compass":"rotation"}reset(){this.view?.ready&&("2d"===this.view?.type?this.callGoTo({target:{rotation:0},options:{animationMode:"always",duration:l.getGoToDuration()}}):this.callGoTo({target:{heading:0}}))}_updateForRotation(e){null!=e&&this._set("orientation",{z:e})}_updateForCamera(e){if(!e)return;const t=-e.heading;this._set("orientation",{x:0,y:0,z:t})}_updateRotationWatcher(e){this.removeAllHandles(),this._watchForView(),e&&this.addHandles("2d"===e.type?r.watch(()=>e?.rotation,this._updateForRotation,r.initial):r.watch(()=>e?.camera,this._updateForCamera,r.initial))}_watchForView(e){this.addHandles(r.watch(()=>this.view,this._updateRotationWatcher,e))}};return e.__decorate([i.property({readOnly:!0})],d.prototype,"canShowNorth",null),e.__decorate([i.property({readOnly:!0})],d.prototype,"orientation",void 0),e.__decorate([i.property({readOnly:!0})],d.prototype,"state",null),e.__decorate([i.property()],d.prototype,"view",void 0),d=e.__decorate([a.subclass("esri.widgets.Compass.CompassViewModel")],d),d})},"esri/views/2d/navigation/duration":function(){define(["exports","../../../core/has","../../../core/time"],function(e,t,r){"use strict";e.getGoToDuration=function(){const e=t("mapview-essential-goto-duration");return null==e?e:r.Milliseconds(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/widgets/Compass/utils":function(){define(["exports"],function(e){"use strict";e.canShowNorth=function(e){return e?.spatialReference?.isWebMercator||e?.spatialReference?.isGeographic||!1},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/widgets/support/GoTo":function(){define(["exports","../../chunks/tslib.es6","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./goToUtils"],function(e,t,r,i,s,n,o,a,l){"use strict";e.GoTo=e=>{const s=e;let n=class extends s{constructor(...e){super(...e),this.goToOverride=null,this.view=null}callGoTo(e){const{view:t}=this;return r.assertIsSome(t),this.goToOverride?this.goToOverride(t,e):l.goTo(t,e.target,e.options)}};return t.__decorate([i.property()],n.prototype,"goToOverride",void 0),t.__decorate([i.property()],n.prototype,"view",void 0),n=t.__decorate([a.subclass("esri.widgets.support.GoTo")],n),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/widgets/support/goToUtils":function(){define(["exports"],function(e){"use strict";e.goTo=function(e,t,r){return e.goTo(t,r)},e.makeGoToWithoutAnimation=function(){return(e,t)=>e.goTo(t.target,{...t.options,animate:!1})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/widgets/Compass/css":function(){define(["exports"],function(e){"use strict";const t="esri-compass",r={base:t,iconContainer:`${t}__icon-container`};e.css=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/widgets/NavigationToggle":function(){define(["require","../chunks/tslib.es6","../core/deprecate","../core/Logger","../core/accessorSupport/decorators/property","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","./NavigationToggle/css","./NavigationToggle/NavigationToggleViewModel","../chunks/componentsUtils","./support/globalCss","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";let g=class extends l{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new u({isDefaultViewModel:!0}),this.toggle=()=>this.viewModel.toggle(),this._panButton=null,this._rotateButton=null,this._toggle=()=>{const e="pan"===this.viewModel?.navigationMode?this._rotateButton:this._panButton;p.setFocus(e),this.toggle()},e?.isDefaultUI||r.deprecateWidget(i.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.32"})}normalizeCtorArgs(e={}){const{isDefaultUI:t,...r}=e;return r}loadDependencies(){return d.loadCalciteComponents({button:()=>new Promise((t,r)=>e(["../chunks/index2"],t,r))})}get icon(){return"move"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){"horizontal"!==e&&(e="vertical"),this._set("layout",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e="disabled"===this.viewModel?.state,t="pan"===this.viewModel?.navigationMode,r=this.messages.toggle;return m.tsx("div",{class:this.classes(c.css.base,h.globalCss.widget,{[c.css.isLayoutHorizontal]:"horizontal"===this.layout})},m.tsx("calcite-button",{afterCreate:e=>{this._panButton=e},appearance:t?"outline-fill":"solid",class:h.globalCss.widgetButton,disabled:e,iconStart:"move",kind:"neutral",label:r,onclick:this._toggle,tabIndex:t?void 0:-1,title:r}),m.tsx("calcite-button",{afterCreate:e=>{this._rotateButton=e},appearance:t?"solid":"outline-fill",class:h.globalCss.widgetButton,disabled:e,iconStart:"rotate",kind:"neutral",label:r,onclick:this._toggle,tabIndex:t?-1:void 0,title:r}))}};return t.__decorate([s.property()],g.prototype,"icon",null),t.__decorate([s.property()],g.prototype,"label",null),t.__decorate([s.property({value:"vertical"})],g.prototype,"layout",null),t.__decorate([s.property(),f.messageBundle("esri/widgets/NavigationToggle/t9n/NavigationToggle")],g.prototype,"messages",void 0),t.__decorate([s.property()],g.prototype,"view",null),t.__decorate([s.property({type:u})],g.prototype,"viewModel",void 0),g=t.__decorate([a.subclass("esri.widgets.NavigationToggle")],g),g})},"esri/widgets/NavigationToggle/css":function(){define(["exports"],function(e){"use strict";const t="esri-navigation-toggle",r={base:t,isLayoutHorizontal:`${t}--horizontal`};e.css=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/widgets/NavigationToggle/NavigationToggleViewModel":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/deprecate","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a,l){"use strict";let c=class extends t{constructor(e){super(e),this._navigationMode="pan",this.view=null,e?.isDefaultViewModel||r.deprecateUnnecessaryViewModel(i.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.33"})}normalizeCtorArgs(e={}){const{isDefaultViewModel:t,...r}=e;return r}initialize(){this.addHandles(s.when(()=>this.view?.navigation?.actionMap,()=>this._updateNavigationActionMap()))}destroy(){this.view=null}get state(){return this.view?.ready&&"3d"===this.view?.type?"ready":"disabled"}get navigationMode(){return this._navigationMode}set navigationMode(e){this._navigationMode=e,this._updateNavigationActionMap()}toggle(){"disabled"!==this.state&&(this.navigationMode="pan"!==this.navigationMode?"pan":"rotate")}_updateNavigationActionMap(){const e=this.view?.navigation?.actionMap;if(!e)return;const t="pan"===this._navigationMode;e.dragPrimary=t?"pan":"rotate",e.dragSecondary=t?"rotate":"pan"}};return e.__decorate([n.property({readOnly:!0})],c.prototype,"state",null),e.__decorate([n.property()],c.prototype,"_navigationMode",void 0),e.__decorate([n.property()],c.prototype,"view",void 0),c=e.__decorate([l.subclass("esri.widgets.NavigationToggle.NavigationToggleViewModel")],c),c})},"esri/widgets/Zoom":function(){define(["require","../chunks/tslib.es6","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","../chunks/componentsUtils","./support/globalCss","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory","./Zoom/ZoomViewModel"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const f="esri-zoom--horizontal";let m=class extends a{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new p,this.zoomIn=()=>this.viewModel.zoomIn(),this.zoomOut=()=>this.viewModel.zoomOut()}loadDependencies(){return l.loadCalciteComponents({button:()=>new Promise((t,r)=>e(["../chunks/index2"],t,r))})}get icon(){return"magnifying-glass-plus"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){"horizontal"!==e&&(e="vertical"),this._set("layout",e)}set view(e){this.viewModel.view=e}get view(){return this.viewModel.view}render(){const e={[f]:"horizontal"===this.layout},{canZoomIn:t,canZoomOut:r}=this.viewModel,{zoomIn:i,zoomOut:s}=this.messages;return h.tsx("div",{class:this.classes("esri-zoom",c.globalCss.widget,e)},h.tsx("calcite-button",{class:c.globalCss.widgetButton,disabled:!t,iconStart:"plus",kind:"neutral",label:i,onclick:this.zoomIn,title:i}),h.tsx("calcite-button",{class:c.globalCss.widgetButton,disabled:!r,iconStart:"minus",kind:"neutral",label:s,onclick:this.zoomOut,title:s}))}};return t.__decorate([r.property()],m.prototype,"icon",null),t.__decorate([r.property()],m.prototype,"label",null),t.__decorate([r.property({value:"vertical"})],m.prototype,"layout",null),t.__decorate([r.property(),d.messageBundle("esri/widgets/Zoom/t9n/Zoom")],m.prototype,"messages",void 0),t.__decorate([r.property()],m.prototype,"view",null),t.__decorate([r.property({type:p})],m.prototype,"viewModel",void 0),m=t.__decorate([o.subclass("esri.widgets.Zoom")],m),m})},"esri/widgets/Zoom/ZoomViewModel":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./ZoomConditions2D","./ZoomConditions3D"],function(e,t,r,i,s,n,o,a,l,c){"use strict";let u=class extends t{constructor(e){super(e)}destroy(){this.view=null}get canZoomIn(){return null!=this._zoomConditions&&this._zoomConditions.canZoomIn}get canZoomOut(){return null!=this._zoomConditions&&this._zoomConditions?.canZoomOut}get state(){return this.view?.ready?"ready":"disabled"}set view(e){e?"2d"===e.type?this._zoomConditions=new l({view:e}):"3d"===e.type&&(this._zoomConditions=new c({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){const e=this.view;this.canZoomIn&&e&&("2d"===e.type?e.mapViewNavigation.zoomIn():r.ignoreAbortErrors(e.goTo({zoomFactor:2})))}zoomOut(){const e=this.view;this.canZoomOut&&e&&("2d"===e.type?e.mapViewNavigation.zoomOut():r.ignoreAbortErrors(e.goTo({zoomFactor:.5})))}};return e.__decorate([i.property()],u.prototype,"_zoomConditions",void 0),e.__decorate([i.property()],u.prototype,"canZoomIn",null),e.__decorate([i.property()],u.prototype,"canZoomOut",null),e.__decorate([i.property({readOnly:!0})],u.prototype,"state",null),e.__decorate([i.property()],u.prototype,"view",null),u=e.__decorate([a.subclass("esri.widgets.Zoom.ZoomViewModel")],u),u})},"esri/widgets/Zoom/ZoomConditions2D":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o){"use strict";let a=class extends t{get canZoomIn(){const e=this.view?.ready;if(!e)return!1;const t=this.view?.constraints?.effectiveMaxScale;return 0===t||this._scale>t}get canZoomOut(){const{view:e}=this,t=e?.ready;if(!t)return!1;const r=e.constraints?.effectiveMinScale;return 0===r||this._scale<r}get _scale(){const e=this.view?.animation?.target;return(e&&"then"in e?void 0:e?.scale)??this.view?.scale??0}};return e.__decorate([r.property({readOnly:!0})],a.prototype,"canZoomIn",null),e.__decorate([r.property({readOnly:!0})],a.prototype,"canZoomOut",null),e.__decorate([r.property()],a.prototype,"view",void 0),e.__decorate([r.property()],a.prototype,"_scale",null),a=e.__decorate([o.subclass("esri.widgets.Zoom.ZoomConditions2D")],a),a})},"esri/widgets/Zoom/ZoomConditions3D":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o){"use strict";let a=class extends t{get canZoomIn(){return!!this.view.ready}get canZoomOut(){return!!this.view.ready}};return e.__decorate([r.property({readOnly:!0})],a.prototype,"canZoomIn",null),e.__decorate([r.property({readOnly:!0})],a.prototype,"canZoomOut",null),e.__decorate([r.property()],a.prototype,"view",void 0),a=e.__decorate([o.subclass("esri.widgets.Zoom.ZoomConditions3D")],a),a})},"esri/views/ui/3d/DefaultUI3D":function(){define(["../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../DefaultUI"],function(e,t,r,i,s,n,o){"use strict";let a=class extends o{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};return e.__decorate([t.property()],a.prototype,"components",void 0),a=e.__decorate([n.subclass("esri.views.ui.3d.DefaultUI3D")],a),a})},"esri/layers/SceneLayer":function(){define(["require","../chunks/tslib.es6","../Graphic","../PopupTemplate","../core/Clonable","../core/Collection","../core/Error","../core/handleUtils","../core/Logger","../core/maybe","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/RandomLCG","../core/accessorSupport/utils","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../geometry/Point","./Layer","./graphics/sources/support/uploadAssetErrors","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/CustomParametersMixin","./mixins/EditBusLayer","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/SceneService","./mixins/TemporalLayer","./mixins/TemporalSceneLayer","./support/arcgisLayerUrl","./support/associatedFeatureServiceUtils","./support/capabilities","./support/commonProperties","./support/featureLayerUtils","./support/FeatureReduction","./support/FeatureReductionSelection","./support/fieldProperties","./support/FieldsIndex","./support/fieldUtils","./support/I3SLayerDefinitions","./support/infoFor3D","./support/LabelClass","./support/labelingInfo","./support/LayerFloorInfo","./support/lazyLayerLoader","./support/meshSpatialReferenceScaleUtils","./support/RangeInfo","./support/SceneFilter","./support/sceneLayerCacheUtils","./support/sceneLayerStatistics","../renderers/support/styleUtils","../renderers/support/typeUtils","../rest/support/Query","../support/elevationInfoUtils","../support/popupUtils","../support/zipUtils","../views/3d/layers/i3s/I3SUtil","../views/layers/support/popupUtils","../webdoc/support/opacityUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V,U,B,N,k,z,j,G,q,H,W,$,Q,Z,Y,X,J,K,ee,te,re,ie,se,ne,oe,ae){"use strict";const le=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),ce=new Set(["3DObject","Point"]),ue=N.defineFieldProperties();let de=class extends(F.TemporalSceneLayer(C.EditBusLayer(O.SceneService(S.ArcGISService(P.OperationalLayer(M.PortalLayer(R.ScaleRangeLayer(u.MultiOriginJSONMixin(T.CustomParametersMixin(x.APIKeyMixin(s.ClonableMixin(v)))))))))))){constructor(...e){super(...e),this.featureReduction=null,this.rangeInfos=null,this.operationalLayerType="ArcGISSceneServiceLayer",this.type="scene",this.fields=null,this.floorInfo=null,this.outFields=null,this.nodePages=null,this.materialDefinitions=null,this.textureSetDefinitions=null,this.geometryDefinitions=null,this.serviceUpdateTimeStamp=null,this.excludeObjectIds=new n,this.definitionExpression=null,this.filter=null,this.path=null,this.labelsVisible=!0,this.labelingInfo=null,this.legendEnabled=!0,this.priority=null,this.semantic=null,this.cachedDrawingInfo={color:!1},this.popupEnabled=!0,this.popupTemplate=null,this.attributeTableTemplate=null,this.objectIdField=null,this.globalIdField=null,this._fieldUsageInfo={},this.screenSizePerspectiveEnabled=!0,this.serviceItemId=void 0}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}destroy(){this._set("renderer",null),this.associatedLayer=c.destroyMaybe(this.associatedLayer)}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){const r=this.getField(e)?.domain??null;return this.associatedLayer?V.getFieldDomain(this.associatedLayer,e,t,r):r}getFeatureType(e){return e&&this.associatedLayer?this.associatedLayer.getFeatureType(e):null}get types(){return this.associatedLayer?.types??[]}get typeIdField(){return this.associatedLayer?.typeIdField??null}get templates(){return this.associatedLayer?.templates??null}get formTemplate(){return this.associatedLayer?.formTemplate??null}get fieldsIndex(){return new k(this.fields)}readNodePages(e,t,r){return"Point"===t.layerType&&(e=t.pointNodePages),null==e||"object"!=typeof e?null:j.I3SNodePageDefinition.fromJSON(e,r)}set elevationInfo(e){this._set("elevationInfo",e),this.loaded&&this._validateElevationInfo()}get effectiveCapabilities(){return this._capabilitiesFromAssociatedFeatureLayer(this.associatedLayer?.effectiveCapabilities)}get effectiveEditingEnabled(){return null!=this.associatedLayer&&V.computeEffectiveEditingEnabled(this.associatedLayer)}get geometryType(){return pe[this.profile]||"mesh"}set renderer(e){z.fixRendererFields(e,this.fieldsIndex),this._set("renderer",e)}readCachedDrawingInfo(e){return null!=e&&"object"==typeof e||(e={}),null==e.color&&(e.color=!1),e}get capabilities(){return this._capabilitiesFromAssociatedFeatureLayer(this.associatedLayer?.capabilities)}_capabilitiesFromAssociatedFeatureLayer(e){e=null!=e?e:E.zeroCapabilities;const{query:t,queryRelated:r,editing:{supportsGlobalId:i,supportsRollbackOnFailure:s,supportsUploadWithItemId:n,supportsGeometryUpdate:o,supportsReturnServiceEditsInSourceSpatialReference:a},data:{supportsZ:l,supportsM:c,isVersioned:u,supportsAttachment:d},operations:{supportsEditing:h,supportsAdd:p,supportsUpdate:f,supportsDelete:m,supportsQuery:g,supportsQueryAttachments:y,supportsAsyncConvert3D:_}}=e,b=e.operations.supportsChangeTracking,v=!!this.associatedLayer?.infoFor3D;return{query:t,queryRelated:r,editing:{supportsGlobalId:i,supportsReturnServiceEditsInSourceSpatialReference:a,supportsRollbackOnFailure:s,supportsGeometryUpdate:v&&o,supportsUploadWithItemId:n},data:{supportsAttachment:d,supportsZ:l,supportsM:c,isVersioned:u},operations:{supportsQuery:g,supportsQueryAttachments:y,supportsEditing:h&&b,supportsAdd:v&&p&&b,supportsDelete:v&&m&&b,supportsUpdate:f&&b,supportsAsyncConvert3D:_}}}get editingEnabled(){return this._isOverridden("editingEnabled")?this._get("editingEnabled"):this.associatedLayer?.editingEnabled??!1}set editingEnabled(e){this._overrideIfSome("editingEnabled",e)}get infoFor3D(){return this.associatedLayer?.infoFor3D??null}get relationships(){return this.associatedLayer?.relationships}get defaultPopupTemplate(){return this.associatedLayer||this.attributeStorageInfo?this.createPopupTemplate():null}readObjectIdField(e,t){return!e&&t.fields&&t.fields.some(t=>("esriFieldTypeOID"===t.type&&(e=t.name),!!e)),e||void 0}readGlobalIdField(e,t){return!e&&t.fields&&t.fields.some(t=>("esriFieldTypeGlobalID"===t.type&&(e=t.name),!!e)),e||void 0}get displayField(){return this.associatedLayer?.displayField??null}readProfile(e,t){const r=t.store.profile;return null!=r&&he[r]?he[r]:(l.getLogger(this).error("Unknown or missing profile",{profile:r,layer:this}),"mesh-pyramids")}get useViewTime(){return this.associatedLayer?.useViewTime??!0}set useViewTime(e){this._override("useViewTime",e)}load(e){return this.addResolvingPromise(this._load(e)),Promise.resolve(this)}async _load(e){const t=null!=e?e.signal:null;await this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch(d.throwIfAbortError),await this._fetchService(t),await Promise.all([this._fetchIndexAndUpdateExtent(this.nodePages,t),this._setAssociatedFeatureLayer(t),this._loadFilterGeometries()]),this._validateElevationInfo(),this._applyAssociatedLayerOverrides(),this._populateFieldUsageInfo(),await this.loadTimeInfoFromService(e),await K.loadStyleRenderer(this,{origin:"service"},t),z.fixRendererFields(this.renderer,this.fieldsIndex),await this.finishLoadEditablePortalLayer(e)}async beforeSave(){null!=this.filter&&(this.filter=this.filter.clone(),await this.load())}async _loadFilterGeometries(){if(this.filter)try{await this.filter.loadGeometries(this.spatialReference)}catch(e){l.getLogger(this).error("#_loadFilterGeometries()",this,"Failed to load filter geometries. Geometry filter will not be applied for this layer.",{error:e}),this.filter=null}}createQuery(){const e=new te;return"mesh"===this.geometryType?this.capabilities.query.supportsReturnMesh&&(e.returnGeometry=!0):(e.returnGeometry=!0,e.returnZ=!0),e.where=this.definitionExpression||"1=1",e.sqlFormat="standard",e.outFields=["*"],e}queryExtent(e,t){return this._getAssociatedLayerForQuery().then(r=>r.queryExtent(e||this.createQuery(),t))}queryFeatureCount(e,t){return this._getAssociatedLayerForQuery().then(r=>r.queryFeatureCount(e||this.createQuery(),t))}queryFeatures(e,t){return this._getAssociatedLayerForQuery().then(r=>r.queryFeatures(e||this.createQuery(),t)).then(e=>{if(e?.features)for(const t of e.features)t.layer=this,t.sourceLayer=this;return e})}async queryRelatedFeatures(e,t){if(await this.load(),!this.associatedLayer)throw new o("scenelayer:query-not-available","SceneLayer queries are not available without an associated feature layer",{layer:this});return this.associatedLayer.queryRelatedFeatures(e,t)}async queryRelatedFeaturesCount(e,t){if(await this.load(),!this.associatedLayer)throw new o("scenelayer:query-not-available","SceneLayer queries are not available without an associated feature layer",{layer:this});return this.associatedLayer.queryRelatedFeaturesCount(e,t)}async queryCachedAttributes(e,t){const r=z.unpackFieldNames(this.fieldsIndex,await oe.getRequiredFields(this,oe.getFetchPopupTemplate(this)));return ne.queryAttributesFromCachedAttributesId(this.parsedUrl?.path??"",this.attributeStorageInfo??[],e,t,r,this.apiKey,this.customParameters)}async queryCachedFeature(e,t){const i=await this.queryCachedAttributes(e,[t]);if(!i||0===i.length)throw new o("scenelayer:feature-not-in-cached-data","Feature not found in cached data");const s=new r;return s.attributes=i[0],s.layer=this,s.sourceLayer=this,s}queryObjectIds(e,t){return this._getAssociatedLayerForQuery().then(r=>r.queryObjectIds(e||this.createQuery(),t))}queryAttachments(e,t){return this._getAssociatedLayerForQuery().then(r=>r.queryAttachments(e,t))}getFieldUsageInfo(e){const t={supportsLabelingInfo:!1,supportsRenderer:!1,supportsPopupTemplate:!1,supportsLayerQuery:!1};return this.loaded?this._fieldUsageInfo[e]||t:(l.getLogger(this).error("#getFieldUsageInfo()","Unavailable until layer is loaded"),t)}createPopupTemplate(e){return ie.createPopupTemplate(this,e)}_getAssociatedLayerForQuery(){const e=this.associatedLayer;return e?.loaded?Promise.resolve(e):this._loadAssociatedLayerForQuery()}async _loadAssociatedLayerForQuery(){if(await this.load(),!this.associatedLayer)throw new o("scenelayer:query-not-available","SceneLayer queries are not available without an associated feature layer",{layer:this});try{await this.associatedLayer.load()}catch(e){throw new o("scenelayer:query-not-available","SceneLayer associated feature layer could not be loaded",{layer:this,error:e})}return this.associatedLayer}hasCachedStatistics(e){return null!=this.statisticsInfo&&this.statisticsInfo.some(t=>t.name===e)}async queryCachedStatistics(e,t){return await this.load(t),await this.fetchStatistics(e,t)}async saveAs(e,t){return this._debouncedSaveOperations(1,{...t,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"scene"},e)}async save(){const e={getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"scene"};return this._debouncedSaveOperations(0,e)}async applyEdits(t,r){const{applyEdits:i}=await new Promise((t,r)=>e(["./graphics/editingSupport"],t,r));let s=r;await this.load();const n=this.associatedLayer;if(!n)throw new o(`${this.type}-layer:not-editable`,"Service is not editable");await n.load();const{globalIdField:a}=n,l=!!n.infoFor3D,c=s?.globalIdUsed??!0;if(l&&null==a)throw new o(`${this.type}-layer:not-editable`,"Valid globalIdField expected on editable SceneLayer");if(l&&!c)throw new o(`${this.type}-layer:globalid-required`,"globalIdUsed must not be false for SceneLayer editing as globalIds are required.");return A.isHostedAgolService(n.url)&&l&&null!=t.deleteFeatures&&null!=a&&(s={...s,globalIdToObjectId:await V.getGlobalIdToObjectIdMap(n,t.deleteFeatures,a)}),i(this,n.source,t,s)}async uploadAssets(e,t){if(await this.load(),null==this.associatedLayer)throw new o(`${this.type}-layer:not-editable`,"Service is not editable");return await this.associatedLayer.load(),this.associatedLayer.uploadAssets(e,t)}async convertMesh(t,r){r??={};const i=e=>{throw l.getLogger(this).error(".convertMesh()",e.message),e};await this.load(),this.infoFor3D||i(new o("invalid:layer","SceneLayer has no capability for mesh conversion"));const s=await this.extractAndFilterFiles(t),n=s.reduce((e,t)=>G.isFileEditFormat(this.infoFor3D,t)?e+1:e,0);0===n&&i(new w.NoModelError),n>1&&i(new w.MultipleModelsError);const a=this.spatialReference,c=r.location??new b({x:0,y:0,z:0,spatialReference:a}),u=c.spatialReference.isGeographic?"local":"georeferenced",{default:d}=await new Promise((t,r)=>e(["../geometry/Mesh"],e=>t(le(e)),r)),h=d.createWithExternalSource(c,{type:"client",files:s},{vertexSpace:u,transform:Q.getMeshTransformForMetersToSpatialReference(c.spatialReference),unitConversionDisabled:!0}),[p]=await this.uploadAssets([h],{...r,useAssetOrigin:!r.location});return p}async extractAndFilterFiles(e){await this.load();const t=this.infoFor3D;return t?(await se.extractZipFiles(e)).filter(e=>G.isFileSupported(t,e)):e}validateLayer(e){if(e.layerType&&!ce.has(e.layerType))throw new o("scenelayer:layer-type-not-supported","SceneLayer does not support this layer type",{layerType:e.layerType});if(isNaN(this.version.major)||isNaN(this.version.minor))throw new o("layer:service-version-not-supported","Service version is not supported.",{serviceVersion:this.version.versionString,supportedVersions:"1.x, 2.x"});if(this.version.major>2)throw new o("layer:service-version-too-new","Service version is too new.",{serviceVersion:this.version.versionString,supportedVersions:"1.x, 2.x"});!function(e,t){let r=!1,i=!1;if(null==e)r=!0,i=!0;else{const s=t&&t.isGeographic;switch(e){case"east-north-up":case"earth-centered":r=!0,i=s;break;case"vertex-reference-frame":r=!0,i=!s;break;default:r=!1}}if(!r)throw new o("scenelayer:unsupported-normal-reference-frame","Normal reference frame is invalid.");if(!i)throw new o("scenelayer:incompatible-normal-reference-frame","Normal reference frame is incompatible with layer spatial reference.")}(this.normalReferenceFrame,this.spatialReference)}_getTypeKeywords(){const e=[];if("points"===this.profile)e.push("Point");else{if("mesh-pyramids"!==this.profile)throw new o("scenelayer:unknown-profile","SceneLayer:save() encountered an unknown SceneLayer profile: "+this.profile);e.push("3DObject")}return e}_populateFieldUsageInfo(){if(this._fieldUsageInfo={},this.fields)for(const e of this.fields){const t=!!this.attributeStorageInfo?.some(t=>t.name===e.name),r=!!this.associatedLayer?.fields?.some(t=>t&&e.name===t.name),i={supportsLabelingInfo:t,supportsRenderer:t,supportsPopupTemplate:t||r,supportsLayerQuery:r};this._fieldUsageInfo[e.name]=i}}_applyAssociatedLayerOverrides(){this._applyAssociatedLayerFieldsOverrides(),this._applyAssociatedLayerPropertyOverrides(),this._applyAssociatedLayerExtentOverride(),this._applyAssociatedLayerPrivileges()}_applyAssociatedLayerFieldsOverrides(){if(!this.associatedLayer?.fields)return;let e=null;for(const t of this.associatedLayer.fields){const r=this.getField(t.name);r?(!r.domain&&t.domain&&(r.domain=t.domain.clone()),r.editable=t.editable,r.nullable=t.nullable,r.length=t.length):(e||(e=this.fields?this.fields.slice():[]),e.push(t.clone()))}e&&this._set("fields",e)}_applyAssociatedLayerPropertyOverrides(){if(!this.associatedLayer)return;const e=["popupTemplate","popupEnabled","attributeTableTemplate"],t=g.getProperties(this);for(let r=0;r<e.length;r++){const i=e[r],s=this.originIdOf(i),n=this.associatedLayer.originIdOf(i);s<n&&(2===n||3===n)&&t.setAtOrigin(i,this.associatedLayer[i],n)}}_applyAssociatedLayerExtentOverride(){const e=this.associatedLayer?.getAtOrigin("fullExtent","service");null!=this.associatedLayer?.infoFor3D&&e&&A.isHostedAgolService(this.associatedLayer?.url)&&X.cacheIsOutOfSync(this)&&g.getProperties(this).setAtOrigin("fullExtent",e.clone(),2)}_applyAssociatedLayerPrivileges(){const e=this.associatedLayer;e&&(this._set("userHasEditingPrivileges",e.userHasEditingPrivileges),this._set("userHasFullEditingPrivileges",e.userHasFullEditingPrivileges),this._set("userHasUpdateItemPrivileges",e.userHasUpdateItemPrivileges))}async _setAssociatedFeatureLayer(e){if(["mesh-pyramids","points"].includes(this.profile))try{const{serverUrl:t,layerId:r,portalItem:i}=await D.findAssociatedFeatureService(`${this.url}/layers/${this.layerId}`,{sceneLayerItem:this.portalItem,customParameters:this.customParameters,apiKey:this.apiKey,signal:e}),s=await $.layerLookupMap.FeatureLayer();this.associatedLayer=new s({url:t,customParameters:this.customParameters,layerId:r,portalItem:i}),await this.associatedLayer.load()}catch(e){d.isAbortError(e)||this._logWarningOnPopupEnabled()}}async _logWarningOnPopupEnabled(){const e=new AbortController;this.addHandles(a.abortHandle(e));try{await h.whenOnce(()=>this.popupEnabled&&null!=this.popupTemplate,e.signal)}catch(e){return void d.throwIfNotAbortError(e)}const t=`this SceneLayer: ${this.title}`;null==this.attributeStorageInfo?l.getLogger(this).warn(`Associated FeatureLayer could not be loaded and no binary attributes found. Popups will not work on ${t}`):l.getLogger(this).info(`Associated FeatureLayer could not be loaded. Falling back to binary attributes for Popups on ${t}`)}_validateElevationInfo(){const e=this.elevationInfo;"mesh-pyramids"===this.profile&&re.logInvalidElevationInfoWarning(l.getLogger(this),re.elevationModeUnsupportedMessage("Mesh scene layers","relative-to-scene",e)),re.logInvalidElevationInfoWarning(l.getLogger(this),re.featureExpressionUnsupportedMessage("Scene layers",e))}async fetchStatistics(e,t){return await J.fetchStatistics({fieldName:e,statisticsInfo:this.statisticsInfo,errorContext:"scenelayer",fieldsIndex:this.fieldsIndex,path:this.parsedUrl?.path??"",customParameters:this.customParameters,apiKey:this.apiKey,signal:t?.signal})}};t.__decorate([p.property({types:{key:"type",base:U.FeatureReduction,typeMap:{selection:B}},json:{origins:{"web-scene":{name:"layerDefinition.featureReduction",write:!0},"portal-item":{name:"layerDefinition.featureReduction",write:!0}}}})],de.prototype,"featureReduction",void 0),t.__decorate([p.property({type:[Z.RangeInfo],json:{read:!1,origins:{"web-scene":{name:"layerDefinition.rangeInfos",write:!0},"portal-item":{name:"layerDefinition.rangeInfos",write:!0}}},clonable:!1})],de.prototype,"rangeInfos",void 0),t.__decorate([p.property({json:{read:!1}})],de.prototype,"associatedLayer",void 0),t.__decorate([p.property({type:["show","hide"]})],de.prototype,"listMode",void 0),t.__decorate([p.property({type:["ArcGISSceneServiceLayer"]})],de.prototype,"operationalLayerType",void 0),t.__decorate([p.property({json:{read:!1},readOnly:!0})],de.prototype,"type",void 0),t.__decorate([p.property({...ue.fields,readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],de.prototype,"fields",void 0),t.__decorate([p.property()],de.prototype,"types",null),t.__decorate([p.property()],de.prototype,"typeIdField",null),t.__decorate([p.property()],de.prototype,"templates",null),t.__decorate([p.property()],de.prototype,"formTemplate",null),t.__decorate([p.property({readOnly:!0,clonable:!1})],de.prototype,"fieldsIndex",null),t.__decorate([p.property({type:W,json:{read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo"}}})],de.prototype,"floorInfo",void 0),t.__decorate([p.property(ue.outFields)],de.prototype,"outFields",void 0),t.__decorate([p.property({type:j.I3SNodePageDefinition,readOnly:!0,json:{read:!1},clonable:!1})],de.prototype,"nodePages",void 0),t.__decorate([y.reader("service","nodePages",["nodePages","pointNodePages"])],de.prototype,"readNodePages",null),t.__decorate([p.property({type:[j.I3SMaterialDefinition],readOnly:!0,clonable:!1})],de.prototype,"materialDefinitions",void 0),t.__decorate([p.property({type:[j.I3STextureSetDefinition],readOnly:!0,clonable:!1})],de.prototype,"textureSetDefinitions",void 0),t.__decorate([p.property({type:[j.I3SGeometryDefinition],readOnly:!0,clonable:!1})],de.prototype,"geometryDefinitions",void 0),t.__decorate([p.property({readOnly:!0})],de.prototype,"serviceUpdateTimeStamp",void 0),t.__decorate([p.property({readOnly:!0})],de.prototype,"attributeStorageInfo",void 0),t.__decorate([p.property({readOnly:!0})],de.prototype,"statisticsInfo",void 0),t.__decorate([p.property({type:n.ofType(Number),nonNullable:!0,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.excludeObjectIds",write:{enabled:!0}}})],de.prototype,"excludeObjectIds",void 0),t.__decorate([p.property({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],de.prototype,"definitionExpression",void 0),t.__decorate([p.property({type:Y,json:{name:"layerDefinition.polygonFilter",write:{enabled:!0,allowNull:!0},origins:{service:{read:!1,write:!1}}}})],de.prototype,"filter",void 0),t.__decorate([p.property({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],de.prototype,"path",void 0),t.__decorate([p.property(L.elevationInfo)],de.prototype,"elevationInfo",null),t.__decorate([p.property({readOnly:!0,json:{read:!1}})],de.prototype,"effectiveCapabilities",null),t.__decorate([p.property({readOnly:!0})],de.prototype,"effectiveEditingEnabled",null),t.__decorate([p.property({type:String})],de.prototype,"geometryType",null),t.__decorate([p.property(L.labelsVisible)],de.prototype,"labelsVisible",void 0),t.__decorate([p.property({type:[q],json:{origins:{service:{name:"drawingInfo.labelingInfo",read:{reader:H.reader},write:!1}},name:"layerDefinition.drawingInfo.labelingInfo",read:{reader:H.reader},write:!0}})],de.prototype,"labelingInfo",void 0),t.__decorate([p.property(L.legendEnabled)],de.prototype,"legendEnabled",void 0),t.__decorate([p.property({type:Number,json:{origins:{"web-document":{default:1,write:{enabled:!0,target:{opacity:{type:Number},"layerDefinition.drawingInfo.transparency":{type:Number}}},read:{source:["opacity","layerDefinition.drawingInfo.transparency"],reader(e,t){if("number"==typeof e&&e>=0&&e<=1)return e;const r=t.layerDefinition?.drawingInfo?.transparency;return void 0!==r?ae.transparencyToOpacity(r):void 0}}},"portal-item":{write:!0},service:{read:!1}}}})],de.prototype,"opacity",void 0),t.__decorate([p.property({type:["Low","High"],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],de.prototype,"priority",void 0),t.__decorate([p.property({type:["Labels"],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],de.prototype,"semantic",void 0),t.__decorate([p.property({types:ee.webSceneRendererTypes,json:{origins:{service:{read:{source:"drawingInfo.renderer"}}},name:"layerDefinition.drawingInfo.renderer",write:!0},value:null})],de.prototype,"renderer",null),t.__decorate([p.property({json:{read:!1}})],de.prototype,"cachedDrawingInfo",void 0),t.__decorate([y.reader("service","cachedDrawingInfo")],de.prototype,"readCachedDrawingInfo",null),t.__decorate([p.property({readOnly:!0,json:{read:!1}})],de.prototype,"capabilities",null),t.__decorate([p.property({type:Boolean,json:{read:!1}})],de.prototype,"editingEnabled",null),t.__decorate([p.property({readOnly:!0,json:{write:!1,read:!1}})],de.prototype,"infoFor3D",null),t.__decorate([p.property({readOnly:!0,json:{write:!1,read:!1}})],de.prototype,"relationships",null),t.__decorate([p.property(L.popupEnabled)],de.prototype,"popupEnabled",void 0),t.__decorate([p.property({type:i,json:{name:"popupInfo",write:!0}})],de.prototype,"popupTemplate",void 0),t.__decorate([p.property({readOnly:!0,json:{read:!1}})],de.prototype,"defaultPopupTemplate",null),t.__decorate([p.property(L.attributeTableTemplate)],de.prototype,"attributeTableTemplate",void 0),t.__decorate([p.property({type:String,json:{read:!1}})],de.prototype,"objectIdField",void 0),t.__decorate([y.reader("service","objectIdField",["objectIdField","fields"])],de.prototype,"readObjectIdField",null),t.__decorate([p.property({type:String,json:{read:!1}})],de.prototype,"globalIdField",void 0),t.__decorate([y.reader("service","globalIdField",["globalIdField","fields"])],de.prototype,"readGlobalIdField",null),t.__decorate([p.property({readOnly:!0,type:String,json:{read:!1}})],de.prototype,"displayField",null),t.__decorate([p.property({type:String,json:{read:!1}})],de.prototype,"profile",void 0),t.__decorate([y.reader("service","profile",["store.profile"])],de.prototype,"readProfile",null),t.__decorate([p.property({readOnly:!0,type:String,json:{origins:{service:{read:{source:"store.normalReferenceFrame"}}},read:!1}})],de.prototype,"normalReferenceFrame",void 0),t.__decorate([p.property(L.screenSizePerspectiveEnabled)],de.prototype,"screenSizePerspectiveEnabled",void 0),t.__decorate([p.property({json:{read:!1,origins:{service:{read:!0}}}})],de.prototype,"serviceItemId",void 0),t.__decorate([p.property(I.useViewTimeProperty)],de.prototype,"useViewTime",null),de=t.__decorate([_.subclass("esri.layers.SceneLayer")],de);const he={"mesh-pyramids":"mesh-pyramids",meshpyramids:"mesh-pyramids","features-meshes":"mesh-pyramids",points:"points","features-points":"points",lines:"lines","features-lines":"lines",polygons:"polygons","features-polygons":"polygons"},pe={"mesh-pyramids":"mesh",points:"point"};return de})},"esri/layers/graphics/sources/support/uploadAssetErrors":function(){define(["exports","../../../../core/Error"],function(e,t){"use strict";const r="upload-assets",i=()=>new Error;e.BadResponseError=class extends t{constructor(e,t){super(`${r}:bad-response`,`Bad response. Uploaded ${e} items and received ${t} results.`,i())}},e.Convert3DFailedError=class extends t{constructor(){super(`${r}:convert3D-failed`,"convert3D failed.")}},e.MultipleModelsError=class extends t{constructor(){super("invalid-input:multiple-models","Multiple supported models found")}},e.NoGlbSupportError=class extends t{constructor(){super(`${r}:no-glb-support`,"Layer does not support glb.",i())}},e.NoModelError=class extends t{constructor(){super("invalid-input:no-model","No supported model found")}},e.NoSupportedSourceError=class extends t{constructor(){super(`${r}:no-supported-source`,"No supported external source found",i())}},e.NotBase64Error=class extends t{constructor(){super(`${r}:not-base-64`,"Expected gltf data in base64 format after conversion.",i())}},e.UnableToPrepareOptionsError=class extends t{constructor(){super(`${r}:unable-to-prepare-options`,"Unable to prepare uploadAsset request options.",i())}},e.UnsupportedError=class extends t{constructor(){super(`${r}:unsupported`,"Layer does not support asset uploads.",i())}},e.UnsupportedFormatUploadedError=class extends t{constructor(e){super(`${r}-layer:unsupported-format`,`The service allowed us to upload an asset of FormatID ${e}, but it does not list it in its supported formats.`,i())}},e.UploadFailedError=class extends t{constructor(e,t){super(`${r}-layer:upload-failed`,`Failed to upload mesh file ${e}. Error code: ${t?.code??"-1"}. Error message: ${t?.messages??"unknown"}`,i())}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/mixins/SceneService":function(){define(["exports","../../chunks/tslib.es6","../../request","../../core/Error","../../core/Logger","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/originUtils","../../geometry/Extent","../../geometry/HeightModelInfo","../../geometry/SpatialReference","../support/arcgisLayerUrl","../support/commonProperties","../support/I3SIndexInfo","../support/multiLayerServiceUtils","../support/schemaValidatorLoader","../../portal/Portal","../../portal/PortalItem","../../portal/support/jsonContext","../../webdoc/support/resourceUtils","../../webdoc/support/saveUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T){"use strict";const C=-1e38;function P(e){if(null!=e.spatialReference)return f.fromJSON(e.spatialReference);const t=e.store,r=t.indexCRS||t.geographicCRS,i=r&&parseInt(r.slice(r.lastIndexOf("/")+1),10);return null!=i?new f(i):null}function M(e,t,r){e.typeKeywords||(e.typeKeywords=[]);const i=t.getTypeKeywords();for(const t of i)e.typeKeywords.push(t);e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((e,t,r)=>r.indexOf(e)===t),1===r&&(e.typeKeywords=e.typeKeywords.filter(e=>"Hosted Service"!==e)))}const R="Scene Service",O={getTypeKeywords:()=>[],portalItemLayerType:"unknown",validationOptions:{enabled:!0,ignoreUnsupported:!1,failPolicy:"throw"}};e.SceneService=e=>{const a=e;let l=class extends a{constructor(){super(...arguments),this.spatialReference=null,this.fullExtent=null,this.heightModelInfo=null,this.minScale=0,this.maxScale=0,this.version={major:Number.NaN,minor:Number.NaN,versionString:""},this.copyright=null,this.sublayerTitleMode="item-title",this.title=null,this.layerId=null,this.url=null,this.indexInfo=null,this._debouncedSaveOperations=n.debounce(async(e,t,r)=>{switch(e){case 0:return this._save(t);case 1:return this._saveAs(r,t)}})}readSpatialReference(e,t){return P(t)}readFullExtent(e,t,r){if(null!=e&&"object"==typeof e){const i=null==e.spatialReference?{...e,spatialReference:P(t)}:e;return h.fromJSON(i,r)}const i=t.store,s=P(t);return null==s||null==i?.extent||!Array.isArray(i.extent)||i.extent.some(e=>e<C)?null:new h({xmin:i.extent[0],ymin:i.extent[1],xmax:i.extent[2],ymax:i.extent[3],spatialReference:s})}parseVersionString(e){const t={major:Number.NaN,minor:Number.NaN,versionString:e},r=e.split(".");return r.length>=2&&(t.major=parseInt(r[0],10),t.minor=parseInt(r[1],10)),t}readVersion(e,t){const r=t.store,i=null!=r.version?r.version.toString():"";return this.parseVersionString(i)}readTitlePortalItem(e){return"item-title"!==this.sublayerTitleMode?void 0:e}readTitleService(e,t){const r=this.portalItem?.title;if("item-title"===this.sublayerTitleMode)return this.url?m.titleFromUrlAndName(this.url,t.name):t.name;let i=t.name;if(!i&&this.url){const e=m.parse(this.url);null!=e&&(i=e.title)}return"item-title-and-service-name"===this.sublayerTitleMode&&r&&(i=r+" - "+i),m.cleanTitle(i)}get parsedUrl(){return _.normalizeParsedUrlObject(this,{separator:"layers"})}async _fetchIndexAndUpdateExtent(e,t){this.indexInfo=y.fetchIndexInfo(this.parsedUrl?.path??"",this.rootNode,e,this.customParameters,this.apiKey,s.getLogger(this),t),null==this.fullExtent||this.fullExtent.hasZ||this._updateExtent(await this.indexInfo)}_updateExtent(e){if("page"===e?.type){const t=e.rootIndex%e.pageSize,r=e.rootPage?.nodes?.[t];if(null==r?.obb?.center||null==r.obb.halfSize)throw new i("sceneservice:invalid-node-page","Invalid node page.");if(r.obb.center[0]<C||null==this.fullExtent||this.fullExtent.hasZ)return;const s=r.obb.halfSize,n=r.obb.center[2],o=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);this.fullExtent.zmin=n-o,this.fullExtent.zmax=n+o}else if("node"===e?.type){const t=e.rootNode?.mbs;if(!Array.isArray(t)||4!==t.length||t[0]<C)return;const r=t[2],i=t[3],{fullExtent:s}=this;s&&(s.zmin=r-i,s.zmax=r+i)}}async _fetchService(e){if(null==this.url)throw new i("sceneservice:url-not-set","Scene service can not be loaded without valid portal item or url");if(null==this.layerId&&/SceneServer\/*$/i.test(this.url)){const t=await this._fetchFirstLayerId(e);null!=t&&(this.layerId=t)}return this._fetchServiceLayer(e)}async _fetchFirstLayerId(e){const t=await r(this.url??"",{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e});if(t.data&&Array.isArray(t.data.layers)&&t.data.layers.length>0)return t.data.layers[0].id}async _fetchServiceLayer(e){const t=await r(this.parsedUrl?.path??"",{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e});t.ssl&&this.url&&(this.url=this.url.replace(/^http:/i,"https:"));let i=!1;if(t.data.layerType&&"Voxel"===t.data.layerType&&(i=!0),i)return this._fetchVoxelServiceLayer();const s=t.data;this.read(s,this._getServiceContext()),this.validateLayer(s)}async _fetchVoxelServiceLayer(e){const t=(await r(this.parsedUrl?.path+"/layer",{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e})).data;this.read(t,this._getServiceContext()),this.validateLayer(t)}_getServiceContext(){return{origin:"service",portalItem:this.portalItem,portal:this.portalItem?.portal,url:this.parsedUrl}}async _ensureLoadBeforeSave(){await this.load(),"beforeSave"in this&&"function"==typeof this.beforeSave&&await this.beforeSave()}validateLayer(e){}async _saveAs(e,t){const r={...O,...t};let s=w.from(e);if(!s)throw new i("sceneservice:portal-item-required","_saveAs() requires a portal item to save to");s.id&&(s=s.clone(),s.id=null);const n=s.portal||v.getDefault();await this._ensureLoadBeforeSave(),s.type=R,s.portal=n;const o=x.createForItemWrite(s,"portal-item",!0),a={layers:[this.write({},o)]};return await Promise.all(o.resources.pendingOperations??[]),await this._validateAgainstJSONSchema(a,o,r),this.url&&(s.url=this.url),s.title||(s.title=this.title),M(s,r,1),await n.signIn(),await n.user.addItem({item:s,folder:r?.folder,data:a}),await S.saveResources(this.resourceReferences,o),this.portalItem=s,d.updateOrigins(o),o.portalItem=s,s}async _save(e){const t={...O,...e};if(!this.portalItem)throw new i("sceneservice:portal-item-not-set","Portal item to save to has not been set on this SceneService");if(this.portalItem.type!==R)throw new i("sceneservice:portal-item-wrong-type",`Portal item needs to have type "${R}"`);await this._ensureLoadBeforeSave();const r=x.createForItemWrite(this.portalItem,"portal-item",!0),s={layers:[this.write({},r)]};return await Promise.all(r.resources.pendingOperations??[]),await this._validateAgainstJSONSchema(s,r,t),this.url&&(this.portalItem.url=this.url),this.portalItem.title||(this.portalItem.title=this.title),M(this.portalItem,t,0),await S.updateItemWithResources(this.portalItem,s,this.resourceReferences,r),d.updateOrigins(r),this.portalItem}async _validateAgainstJSONSchema(e,t,r){const n=r?.validationOptions;T.evaluateWriteErrors(t,{errorName:"sceneservice:save"},{ignoreUnsupported:n?.ignoreUnsupported,supplementalUnsupportedErrors:["scenemodification:unsupported"]});const o=n?.enabled,a=b.getLoader();if(o&&a){const t=(await a()).validate(e,r.portalItemLayerType);if(!t.length)return;const o=`Layer item did not validate:\n${t.join("\n")}`;if(s.getLogger(this).error(`_validateAgainstJSONSchema(): ${o}`),"throw"===n.failPolicy){const e=t.map(e=>new i("sceneservice:schema-validation",e));throw new i("sceneservice-validate:error","Failed to save layer item due to schema validation, see `details.errors`.",{validationErrors:e})}}}};return t.__decorate([o.property(g.id)],l.prototype,"id",void 0),t.__decorate([o.property({type:f})],l.prototype,"spatialReference",void 0),t.__decorate([c.reader("spatialReference",["spatialReference","store.indexCRS","store.geographicCRS"])],l.prototype,"readSpatialReference",null),t.__decorate([o.property({type:h})],l.prototype,"fullExtent",void 0),t.__decorate([c.reader("fullExtent",["fullExtent","store.extent","spatialReference","store.indexCRS","store.geographicCRS"])],l.prototype,"readFullExtent",null),t.__decorate([o.property({readOnly:!0,type:p})],l.prototype,"heightModelInfo",void 0),t.__decorate([o.property({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:{source:"minScale"},write:!1}}}})],l.prototype,"minScale",void 0),t.__decorate([o.property({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:{source:"maxScale"},write:!1}}}})],l.prototype,"maxScale",void 0),t.__decorate([o.property({readOnly:!0})],l.prototype,"version",void 0),t.__decorate([c.reader("version",["store.version"])],l.prototype,"readVersion",null),t.__decorate([o.property({type:String,json:{read:{source:"copyrightText"}}})],l.prototype,"copyright",void 0),t.__decorate([o.property({type:String,json:{read:!1}})],l.prototype,"sublayerTitleMode",void 0),t.__decorate([o.property({type:String})],l.prototype,"title",void 0),t.__decorate([c.reader("portal-item","title")],l.prototype,"readTitlePortalItem",null),t.__decorate([c.reader("service","title",["name"])],l.prototype,"readTitleService",null),t.__decorate([o.property({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{write:{target:"id",isRequired:!0,ignoreOrigin:!0},read:!1}}}})],l.prototype,"layerId",void 0),t.__decorate([o.property(_.urlProperty({separator:"layers"}))],l.prototype,"url",void 0),t.__decorate([o.property({readOnly:!0})],l.prototype,"parsedUrl",null),t.__decorate([o.property({readOnly:!0})],l.prototype,"store",void 0),t.__decorate([o.property({type:String,readOnly:!0,json:{read:{source:"store.rootNode"}}})],l.prototype,"rootNode",void 0),l=t.__decorate([u.subclass("esri.layers.mixins.SceneService")],l),l},e.sceneServiceItemType=R,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/accessorSupport/originUtils":function(){define(["exports","../multiOriginJSONSupportUtils"],function(e,t){"use strict";e.updateOrigins=function(e){e?.writtenProperties&&e.writtenProperties.forEach(({target:e,propName:r,newOrigin:i})=>{t.isMultiOriginJSONMixin(e)&&i&&e.originOf(r)!==i&&e.updateOrigin(r,i)})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/I3SIndexInfo":function(){define(["exports","../../request","../../core/Error"],function(e,t,r){"use strict";e.fetchIndexInfo=async function(e,i,s,n,o,a,l){let c=null;if(null!=s){const r=`${e}/nodepages/`,i=r+Math.floor(s.rootIndex/s.nodesPerPage);try{return{type:"page",rootPage:(await t(i,{query:{f:"json",...n,token:o},responseType:"json",signal:l})).data,rootIndex:s.rootIndex,pageSize:s.nodesPerPage,lodMetric:s.lodSelectionMetricType,urlPrefix:r}}catch(e){null!=a&&a.warn("#fetchIndexInfo()","Failed to load root node page. Falling back to node documents.",i,e),c=e}}if(!i)return null;const u=i?.split("/").pop(),d=`${e}/nodes/`,h=d+u;try{return{type:"node",rootNode:(await t(h,{query:{f:"json",...n,token:o},responseType:"json",signal:l})).data,urlPrefix:d}}catch(e){throw new r("sceneservice:root-node-missing","Root node missing.",{pageError:c,nodeError:e,url:h})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/schemaValidatorLoader":function(){define(["exports"],function(e){"use strict";let t=null;e.getLoader=function(){return t},e.registerLoader=function(e){t=e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/portal/support/jsonContext":function(){define(["exports","../../core/urlUtils","../Portal"],function(e,t,r){"use strict";function i(e,i){return{origin:i,url:t.urlToObject(e.itemUrl),portal:e.portal||r.getDefault(),portalItem:e}}e.createForItemRead=function(e,t){return{...i(e,t),readResourcePaths:[]}},e.createForItemWrite=function(e,r,s){const n=t.urlToObject(e.itemUrl);return{...i(e,r),messages:[],writtenProperties:[],blockedRelativeUrls:[],verifyItemRelativeUrls:n?{rootPath:n.path,writtenUrls:[]}:null,resources:s?{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}:null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/webdoc/support/resourceUtils":function(){define(["require","exports","../../core/Error","../../core/promiseUtils","../../core/uuid","../../portal/support/resourceUtils"],function(e,t,r,i,s,n){"use strict";async function o(t,o,a){if(!o?.resources)return;const l=o.portalItem===t.portalItem?new Set(t.paths):new Set;t.paths.length=0,t.portalItem=o.portalItem;const c=new Set(o.resources.toKeep.map(e=>e.resource.path)),u=new Set,d=[];c.forEach(e=>{l.delete(e),t.paths.push(e)});const h=[],p=[],f=[];for(const e of o.resources.toUpdate)if(l.delete(e.resource.path),c.has(e.resource.path)||u.has(e.resource.path)){const{resource:r,content:i,finish:o}=e,a=n.getSiblingOfSameTypeI(r,s.generateUUID());t.paths.push(a.path),h.push({resource:a,content:await n.contentToBlob(i),compress:e.compress}),o&&f.push(()=>o(a))}else{t.paths.push(e.resource.path),p.push({resource:e.resource,content:await n.contentToBlob(e.content),compress:e.compress});const r=e.finish;r&&f.push(()=>r(e.resource)),u.add(e.resource.path)}for(const e of o.resources.toAdd)if(t.paths.push(e.resource.path),l.has(e.resource.path))l.delete(e.resource.path);else{h.push({resource:e.resource,content:await n.contentToBlob(e.content),compress:e.compress});const t=e.finish;t&&f.push(()=>t(e.resource))}if(h.length||p.length){const{addOrUpdateResources:t}=await new Promise((t,r)=>e(["../../portal/support/resourceUtils"],t,r));await t(o.portalItem,h,"add",a),await t(o.portalItem,p,"update",a)}if(f.forEach(e=>e()),0===d.length)return l;const m=await i.allSettledErrors(d);if(i.throwIfAborted(a),m.length>0)throw new r("save:resources","Failed to save one or more resources",{errors:m});return l}async function a(e,t,r){if(!e||!t.portalItem)return;const s=[];for(const i of e){const e=t.portalItem.resourceFromPath(i);s.push(e.portalItem.removeResource(e,r))}await i.eachAlways(s)}t.saveResources=async function(e,t,r){const i=await o(e,t,r);await a(i,t,r)},t.updateItemWithResources=async function(e,t,r,i,s){const n=await o(r,i,s);await e.update({data:t}),await a(n,i,s)},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/portal/support/resourceUtils":function(){define(["exports","../../request","../../core/Error","../../core/urlUtils"],function(e,t,r,i){"use strict";function s(e){const t=e.lastIndexOf("/");return-1===t?[".",e]:[e.slice(0,t),e.slice(t+1)]}function n(e){const[t,r]=function(e){const t=i.getPathExtension(e);return null==t?[e,""]:[e.slice(0,e.length-t.length-1),`.${t}`]}(e),[n,o]=s(t);return[n,o,r]}e.addOrUpdateResources=async function(e,t,n,o){const a=new Map;for(const{resource:e,content:i,compress:o,access:l}of t){if(!e.hasPath())throw new r(`portal-item-resource-${n}:invalid-path`,"Resource does not have a valid path");const[t,c]=s(e.path),u=`${t}/${o??""}/${l??""}`;a.has(u)||a.set(u,{prefix:t,compress:o,access:l,files:[]}),a.get(u).files.push({fileName:c,content:i})}await e.load(o);const l=i.join(e.userItemUrl,"add"===n?"addResources":"updateResources");for(const{prefix:t,compress:r,access:i,files:s}of a.values()){const n=25;for(let a=0;a<s.length;a+=n){const c=s.slice(a,a+n),u=new FormData;t&&"."!==t&&u.append("resourcesPrefix",t),r&&u.append("compress","true"),i&&u.append("access",i);let d=0;for(const{fileName:e,content:t}of c)u.append("file"+ ++d,t,e);u.append("f","json"),await e.portal.request(l,{method:"post",body:u,signal:o?.signal})}}},e.contentToBlob=async function(e){return"blob"===e.type?e.blob:"json"===e.type?new Blob([e.jsonString],{type:"application/json"}):(await t(e.url,{responseType:"blob"})).data},e.fetchResources=async function(e,t={},r){await e.load(r);const s=i.join(e.itemUrl,"resources"),{start:n=1,num:o=10,sortOrder:a="asc",sortField:l="resource"}=t,c={query:{start:n,num:o,sortOrder:a,sortField:l,token:e.apiKey},signal:r?.signal},u=await e.portal.request(s,c);return{total:u.total,nextStart:u.nextStart,resources:u.resources.map(({created:t,size:r,resource:i})=>({created:new Date(t),size:r,resource:e.resourceFromPath(i)}))}},e.getSiblingOfSameType=function(e,t){if(!e.hasPath())return null;const[r,,s]=n(e.path);return e.portalItem.resourceFromPath(i.join(r,t+s))},e.getSiblingOfSameTypeI=function(e,t){if(!e.hasPath())return null;const[r,,s]=n(e.path);return e.portalItem.resourceFromPath(i.join(r,t+s))},e.removeAllResources=async function(e,t){await e.load(t);const r=i.join(e.userItemUrl,"removeResources");return e.portal.request(r,{method:"post",query:{deleteAll:!0},signal:t?.signal})},e.removeResource=async function(e,t,s){if(!t.hasPath())throw new r("portal-item-resources-remove:invalid-path","Resource does not have a valid path");await e.load(s);const n=i.join(e.userItemUrl,"removeResources");await e.portal.request(n,{method:"post",query:{resource:t.path},signal:s?.signal}),t.portalItem=null},e.splitPrefixFileNameAndExtension=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/webdoc/support/saveUtils":function(){define(["exports","../../core/Error","../../layers/support/layerUtils"],function(e,t,r){"use strict";const i=new Set(["layer:unsupported","property:unsupported","symbol:unsupported","symbol-layer:unsupported","url:unsupported"]);e.beforeSave=async function(e){const t=[];for(const r of e.allLayers)if("beforeSave"in r&&"function"==typeof r.beforeSave){const e=r.beforeSave();e&&t.push(e)}await Promise.allSettled(t)},e.evaluateWriteErrors=function(e,r,s){let n=(e.messages??[]).filter(({type:e})=>"error"===e).map(({name:e,message:r,details:i})=>new t(e,r,i));if(e.blockedRelativeUrls&&(n=n.concat(e.blockedRelativeUrls.map(e=>new t("url:unsupported",`Relative url '${e}' is not supported`)))),s){const{ignoreUnsupported:e,supplementalUnsupportedErrors:t=[],requiredPropertyChecksDisabled:r}=s;e&&(n=n.filter(({name:e})=>!(i.has(e)||t.includes(e)))),r&&(n=n.filter(e=>"web-document-write:property-required"!==e.name))}if(n.length>0)throw new t(r.errorName,"Failed to save due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:n})},e.hasCharts=function(e){return r.getLayersWithChartSupport(e).some(e=>!!e.charts?.length)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/mixins/TemporalSceneLayer":function(){define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../support/fieldUtils","../support/sceneLayerCacheUtils","../support/TimeInfo","../../chunks/TimeExtent","../../chunks/TimeInterval"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";let p=class extends r.JSONSupport{constructor(){super(...arguments),this.endTimeField=null,this.startTimeField=null}};t.__decorate([i.property({type:String})],p.prototype,"endTimeField",void 0),t.__decorate([i.property({type:String})],p.prototype,"startTimeField",void 0),p=t.__decorate([a.subclass("esri.layers.mixins.TemporalSceneLayer.SceneServiceTimeInfo")],p),e.TemporalSceneLayer=e=>{const r=e;let s=class extends r{constructor(){super(...arguments),this.serviceTimeInfo=null}get timeInfo(){const e=this.associatedLayer?.timeInfo;if(null==e)return null;const t=e.clone();return l.fixTimeInfoFields(t,this.fieldsIndex),t}set timeInfo(e){l.fixTimeInfoFields(e,this.fieldsIndex),this._override("timeInfo",e)}get timeExtent(){return this.associatedLayer?.timeExtent}set timeExtent(e){this._override("timeExtent",e)}get timeOffset(){return this.associatedLayer?.timeOffset}set timeOffset(e){this._override("timeOffset",e)}get datesInUnknownTimezone(){return this.associatedLayer?.datesInUnknownTimezone??!1}set datesInUnknownTimezone(e){this._override("datesInUnknownTimezone",e)}async loadTimeInfoFromService(e){const{serviceTimeInfo:t}=this;if(null==t)return;const{startTimeField:r,endTimeField:i}=t;if(null==r&&null==i)return;if(c.cacheIsOutOfSync({associatedLayer:this.associatedLayer,serviceUpdateTimeStamp:this.serviceUpdateTimeStamp}))return;const s=async t=>{let i=null;try{const r=await(this.fetchStatistics?.(t,e));i=r?.stats}catch{}if(null==i)return null;const{minTimeStr:s,min:n,maxTimeStr:o,max:a}=i,l=t===r?s??n:o??a;return null!=l?new Date(l):null},[n,o]=await Promise.all([s(r),s(i)]);if(null!=r&&null==n||null!=i&&null==o)return;const a=new d.TimeExtent({start:n,end:o});this.setAtOrigin("timeInfo",new u({endField:i,startField:r,fullTimeExtent:a}),"service")}};return t.__decorate([i.property({type:u,json:{read:!1,write:!1}})],s.prototype,"timeInfo",null),t.__decorate([i.property({type:d.TimeExtent,json:{read:!1,write:!1}})],s.prototype,"timeExtent",null),t.__decorate([i.property({type:h.TimeInterval,json:{read:!1,write:!1}})],s.prototype,"timeOffset",null),t.__decorate([i.property({type:Boolean,nonNullable:!0,json:{read:!1,write:!1}})],s.prototype,"datesInUnknownTimezone",null),t.__decorate([i.property({type:p,readOnly:!0,json:{read:{source:"timeInfo"}},clonable:!1})],s.prototype,"serviceTimeInfo",void 0),s=t.__decorate([a.subclass("esri.layers.mixins.TemporalSceneLayer")],s),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/sceneLayerCacheUtils":function(){define(["exports"],function(e){"use strict";e.cacheIsOutOfSync=function({associatedLayer:e,serviceUpdateTimeStamp:t}){const r=e?.editingInfo?.lastEditDate,i=e?.serverGens,s=null!=r,n=null!=t,o=s&&n&&t.lastUpdate!==r.getTime();return s&&(o||!n&&i?.minServerGen!==i?.serverGen)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/capabilities":function(){define(["exports"],function(e){"use strict";const t={supportsDate:!1,supportsFixedInterval:!1,supportsAutoInterval:!1,supportsFixedBoundaries:!1,supportsStackBy:!1,supportsSplitBy:!1,supportsSnapToData:!1,supportsReturnFullIntervalBin:!1,supportsFirstDayOfWeek:!1,supportsNormalization:!1,supportedStatistics:void 0,supportedNormalizationTypes:void 0},r={analytics:{supportsCacheHint:!1},attachment:{supportsContentType:!1,supportsExifInfo:!1,supportsKeywords:!1,supportsName:!1,supportsSize:!1,supportsCacheHint:!1,supportsOrderByFields:!1,supportsResize:!1},data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsAsyncApplyEdits:!1,zDefault:void 0},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryBins:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},queryAttributeBins:t,query:{maxRecordCount:0,maxRecordCountFactor:0,maxUniqueIDCount:0,standardMaxRecordCount:0,supportsCacheHint:!1,supportsCentroid:!1,supportsCompactGeometry:!1,supportsCurrentUser:!1,supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:!1,supportsPagination:!1,supportsPaginationOnAggregatedQueries:!1,supportsPercentileStatistics:!1,supportsQuantization:!1,supportsQuantizationEditMode:!1,supportsQueryByAnonymous:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsReturnMesh:!1,supportsSqlExpression:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsTrueCurve:!1,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsStatistics:!1,tileMaxRecordCount:0}};e.zeroCapabilities=r,e.zeroQueryBins=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/I3SLayerDefinitions":function(){define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a,l){"use strict";e.I3SNodePageDefinition=class extends r.JSONSupport{constructor(){super(...arguments),this.nodesPerPage=null,this.rootIndex=0,this.lodSelectionMetricType=null}},t.__decorate([i.property({type:Number})],e.I3SNodePageDefinition.prototype,"nodesPerPage",void 0),t.__decorate([i.property({type:Number})],e.I3SNodePageDefinition.prototype,"rootIndex",void 0),t.__decorate([i.property({type:String})],e.I3SNodePageDefinition.prototype,"lodSelectionMetricType",void 0),e.I3SNodePageDefinition=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SNodePageDefinition")],e.I3SNodePageDefinition),e.I3SMaterialTexture=class extends r.JSONSupport{constructor(){super(...arguments),this.factor=1}},t.__decorate([i.property({type:Number,json:{read:{source:"textureSetDefinitionId"}}})],e.I3SMaterialTexture.prototype,"id",void 0),t.__decorate([i.property({type:Number})],e.I3SMaterialTexture.prototype,"factor",void 0),e.I3SMaterialTexture=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SMaterialTexture")],e.I3SMaterialTexture),e.I3SMaterialPBRMetallicRoughness=class extends r.JSONSupport{constructor(){super(...arguments),this.baseColorFactor=[1,1,1,1],this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.metallicFactor=1,this.roughnessFactor=1}},t.__decorate([i.property({type:[Number]})],e.I3SMaterialPBRMetallicRoughness.prototype,"baseColorFactor",void 0),t.__decorate([i.property({type:e.I3SMaterialTexture})],e.I3SMaterialPBRMetallicRoughness.prototype,"baseColorTexture",void 0),t.__decorate([i.property({type:e.I3SMaterialTexture})],e.I3SMaterialPBRMetallicRoughness.prototype,"metallicRoughnessTexture",void 0),t.__decorate([i.property({type:Number})],e.I3SMaterialPBRMetallicRoughness.prototype,"metallicFactor",void 0),t.__decorate([i.property({type:Number})],e.I3SMaterialPBRMetallicRoughness.prototype,"roughnessFactor",void 0),e.I3SMaterialPBRMetallicRoughness=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SMaterialPBRMetallicRoughness")],e.I3SMaterialPBRMetallicRoughness),e.I3SMaterialDefinition=class extends r.JSONSupport{constructor(){super(...arguments),this.alphaMode="opaque",this.alphaCutoff=.25,this.doubleSided=!1,this.cullFace="none",this.normalTexture=null,this.occlusionTexture=null,this.emissiveTexture=null,this.emissiveFactor=null,this.pbrMetallicRoughness=null}},t.__decorate([a.enumeration({opaque:"opaque",mask:"mask",blend:"blend"})],e.I3SMaterialDefinition.prototype,"alphaMode",void 0),t.__decorate([i.property({type:Number})],e.I3SMaterialDefinition.prototype,"alphaCutoff",void 0),t.__decorate([i.property({type:Boolean})],e.I3SMaterialDefinition.prototype,"doubleSided",void 0),t.__decorate([a.enumeration({none:"none",back:"back",front:"front"})],e.I3SMaterialDefinition.prototype,"cullFace",void 0),t.__decorate([i.property({type:e.I3SMaterialTexture})],e.I3SMaterialDefinition.prototype,"normalTexture",void 0),t.__decorate([i.property({type:e.I3SMaterialTexture})],e.I3SMaterialDefinition.prototype,"occlusionTexture",void 0),t.__decorate([i.property({type:e.I3SMaterialTexture})],e.I3SMaterialDefinition.prototype,"emissiveTexture",void 0),t.__decorate([i.property({type:[Number]})],e.I3SMaterialDefinition.prototype,"emissiveFactor",void 0),t.__decorate([i.property({type:e.I3SMaterialPBRMetallicRoughness})],e.I3SMaterialDefinition.prototype,"pbrMetallicRoughness",void 0),e.I3SMaterialDefinition=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SMaterialDefinition")],e.I3SMaterialDefinition),e.I3STextureFormat=class extends r.JSONSupport{},t.__decorate([i.property({type:String,json:{read:{source:["name","index"],reader:(e,t)=>null!=e?e:`${t.index}`}}})],e.I3STextureFormat.prototype,"name",void 0),t.__decorate([a.enumeration({jpg:"jpg",png:"png",dds:"dds","ktx-etc2":"ktx-etc2",ktx2:"ktx2",basis:"basis"})],e.I3STextureFormat.prototype,"format",void 0),e.I3STextureFormat=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3STextureFormat")],e.I3STextureFormat),e.I3STextureSetDefinition=class extends r.JSONSupport{constructor(){super(...arguments),this.atlas=!1}},t.__decorate([i.property({type:[e.I3STextureFormat]})],e.I3STextureSetDefinition.prototype,"formats",void 0),t.__decorate([i.property({type:Boolean})],e.I3STextureSetDefinition.prototype,"atlas",void 0),e.I3STextureSetDefinition=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3STextureSetDefinition")],e.I3STextureSetDefinition),e.I3SGeometryAttribute=class extends r.JSONSupport{},t.__decorate([a.enumeration({Float32:"Float32",UInt64:"UInt64",UInt32:"UInt32",UInt16:"UInt16",UInt8:"UInt8"})],e.I3SGeometryAttribute.prototype,"type",void 0),t.__decorate([i.property({type:Number})],e.I3SGeometryAttribute.prototype,"component",void 0),e.I3SGeometryAttribute=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SGeometryAttribute")],e.I3SGeometryAttribute),e.I3SGeometryCompressedAttributes=class extends r.JSONSupport{},t.__decorate([a.enumeration({draco:"draco"})],e.I3SGeometryCompressedAttributes.prototype,"encoding",void 0),t.__decorate([i.property({type:[String]})],e.I3SGeometryCompressedAttributes.prototype,"attributes",void 0),e.I3SGeometryCompressedAttributes=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SGeometryCompressedAttributes")],e.I3SGeometryCompressedAttributes),e.I3SGeometryBuffer=class extends r.JSONSupport{constructor(){super(...arguments),this.offset=0}},t.__decorate([i.property({type:Number})],e.I3SGeometryBuffer.prototype,"offset",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"position",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"normal",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"uv0",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"color",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"uvRegion",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"featureId",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"faceRange",void 0),t.__decorate([i.property({type:e.I3SGeometryCompressedAttributes})],e.I3SGeometryBuffer.prototype,"compressedAttributes",void 0),e.I3SGeometryBuffer=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SGeometryBuffer")],e.I3SGeometryBuffer),e.I3SGeometryDefinition=class extends r.JSONSupport{},t.__decorate([a.enumeration({triangle:"triangle"})],e.I3SGeometryDefinition.prototype,"topology",void 0),t.__decorate([i.property()],e.I3SGeometryDefinition.prototype,"geometryBuffers",void 0),e.I3SGeometryDefinition=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SGeometryDefinition")],e.I3SGeometryDefinition),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/meshSpatialReferenceScaleUtils":function(){define(["exports","../../core/unitUtils","../../geometry/support/MeshTransform"],function(e,t,r){"use strict";e.getMeshTransformForMetersToSpatialReference=function(e){const i=1/t.getMetersPerUnitForSR(e,1);return 1!==i?new r({scale:[i,i,i]}):void 0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/RangeInfo":function(){define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";e.RangeInfo=class extends r.JSONSupport{constructor(){super(...arguments),this.name=null,this.field=null,this.currentRangeExtent=null,this.fullRangeExtent=null,this.type="rangeInfo"}},t.__decorate([i.property({type:String,json:{read:!0,write:{isRequired:!0}}})],e.RangeInfo.prototype,"name",void 0),t.__decorate([i.property({type:String,json:{read:!0,write:{isRequired:!0}}})],e.RangeInfo.prototype,"field",void 0),t.__decorate([i.property({type:[Number],json:{read:!0,write:!0}})],e.RangeInfo.prototype,"currentRangeExtent",void 0),t.__decorate([i.property({type:[Number],json:{read:!0,write:!0}})],e.RangeInfo.prototype,"fullRangeExtent",void 0),t.__decorate([i.property({type:["rangeInfo"],readOnly:!0,json:{read:!1,write:{isRequired:!0}}})],e.RangeInfo.prototype,"type",void 0),e.RangeInfo=t.__decorate([a.subclass("esri.layers.support.RangeInfo")],e.RangeInfo),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/SceneFilter":function(){define(["../../chunks/tslib.es6","../../request","../../core/JSONSupport","../../core/lang","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/persistable","./PolygonCollection","../../chunks/persistableUrlUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";var p;let f=p=class extends r.JSONSupport{constructor(e){super(e),this.spatialRelationship="disjoint",this.geometries=new d,this._geometriesSource=null}initialize(){this.addHandles(s.on(()=>this.geometries,"after-changes",()=>this.geometries=this.geometries,s.sync))}readGeometries(e,t,r){Array.isArray(e)?this.geometries=d.fromJSON(e,r):this._geometriesSource={url:h.fromJSON(e,r),context:r}}async loadGeometries(e,r){if(null==this._geometriesSource)return;const{url:i,context:s}=this._geometriesSource,n=await t(i,{responseType:"json",signal:r?.signal}),o=e.toJSON(),a=n.data.map(e=>({...e,spatialReference:o}));this.geometries=d.fromJSON(a,s),this._geometriesSource=null}clone(){const e=new p({geometries:i.clone(this.geometries),spatialRelationship:this.spatialRelationship});return e._geometriesSource=this._geometriesSource,e}};return e.__decorate([n.property({type:["disjoint","contains"],nonNullable:!0,json:{write:{isRequired:!0}}})],f.prototype,"spatialRelationship",void 0),e.__decorate([n.property({type:d,nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}}),u.persistable({origins:["web-scene","portal-item"],type:"resource",prefix:"geometries",contentAddressed:!0})],f.prototype,"geometries",void 0),e.__decorate([l.reader(["web-scene","portal-item"],"geometries")],f.prototype,"readGeometries",null),f=p=e.__decorate([c.subclass("esri.layers.support.SceneFilter")],f),f})},"esri/layers/support/sceneLayerStatistics":function(){define(["exports","../../request","../../core/Error","../../core/urlUtils"],function(e,t,r,i){"use strict";e.fetchStatistics=async function({fieldName:e,statisticsInfo:s,errorContext:n,fieldsIndex:o,path:a,customParameters:l,apiKey:c,signal:u}){if(null==s)throw new r(`${n}:no-cached-statistics`,"Cached statistics are not available for this layer");const d=o.get(e);if(null==d)throw new r(`${n}:field-unexisting`,`Field '${e}' does not exist on the layer`);const h=s.find(e=>e.name===d.name);if(null==h)throw new r(`${n}:no-cached-statistics`,"Cached statistics for this attribute are not available");const p=i.join(a,h.href),{data:f}=await t(p,{query:{f:"json",...l,token:c},responseType:"json",signal:u});return f},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/support/zipUtils":function(){define(["require","exports"],function(e,t){"use strict";async function r(t){const{BlobReader:r,ZipReader:i,BlobWriter:s}=await new Promise((t,r)=>e(["./zipjs-wrapper"],t,r)),n=[],o=new i(new r(t));return(await o.getEntries()).forEach(e=>{if(e.directory||/^__MACOS/i.test(e.filename))return;const t=new s;n.push(e.getData(t).then(t=>new File([t],e.filename)))}),Promise.all(n)}t.extractZipFile=r,t.extractZipFiles=async function(e){const t=[];for(const i of e)i.name.toLowerCase().endsWith(".zip")?t.push(r(i)):t.push(Promise.resolve(i));return(await Promise.all(t)).flat()},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SUtil":function(){define(["exports","../../../../request","../../../../core/arrayUtils","../../../../core/Error","../../../../core/has","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projectionUtils","../../../../geometry/SpatialReference","../../../../geometry/projection/projectVectorToVector","../../../../geometry/support/aaBoundingRect","../../../../chunks/sphere","../../../../layers/support/featurePopupQueryUtils","../../../../rest/support/Query","./I3SBinaryReader","./I3SProjectionUtil","../support/edgeUtils","../support/symbolColorUtils","../../support/orientedBoundingBox","../../webgl-engine/core/shaderLibrary/output/Emissions.glsl","../../../support/layerViewUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x){"use strict";function S(e){return e?parseInt(e.slice(e.lastIndexOf("/")+1),10):void 0}const T=h.create();function C(e,t){const r=t[0],i=t[1],s=t[3],n=e[0]-r,o=r-e[2],a=e[1]-i,l=i-e[3],c=Math.max(n,o,0),u=Math.max(a,l,0),d=c*c+u*u;return d>s*s?0:d>0?1:-Math.max(n,o,a,l)>s?3:2}function P(e,t,r){const i=[],s=r?.missingFields,n=r?.originalFields;let o=!1;for(const r of e){const e=t.get(r);e?(n?.push(r),i.push(e.name),r!==e.name&&(o=!0)):s?.push(r)}return r&&"hasMismatchedCasing"in r&&(r.hasMismatchedCasing=o),i}function M(e,t,r,i){if(null!=t&&"number"==typeof t)return e.featureIds.indexOf(t);if(null==i||null==r)return-1;const s=e.attributeInfo?.attributeData?.[r];return s?s.indexOf(i):-1}async function R(e,r,i,s,n,o,a,l){const c=[];for(const t of r)if(t&&n.includes(t.name)){const r=`${e}/nodes/${i}/attributes/${t.key}/0`;c.push({url:r,storageInfo:t})}const u=await Promise.allSettled(c.map(e=>t(e.url,{responseType:"array-buffer",query:{...a,token:o},signal:l?.signal}).then(t=>g.readBinaryAttribute(e.storageInfo,t.data)))),d=[];for(const e of s){const t={};for(let r=0;r<u.length;r++){const i=u[r];if("fulfilled"===i.status){const s=i.value;t[c[r].storageInfo.name]=g.getCachedAttributeValue(s,e)}}d.push(t)}return d}function O(e){const t=e.store,r=t.indexCRS||t.geographicCRS,s=void 0===r?t.indexWKT:void 0;if(s){if(!e.spatialReference)throw new i("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(s!==e.spatialReference.wkt)throw new i("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const n=r?new u(S(r)):e.spatialReference;return n.equals(e.spatialReference)?e.spatialReference:n}function I(e){const t=e.store,r=t.vertexCRS||t.projectedCRS,s=void 0===r?t.vertexWKT:void 0;if(s){if(!e.spatialReference)throw new i("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(s!==e.spatialReference.wkt)throw new i("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const n=r?new u(S(r)):e.spatialReference;return n.equals(e.spatialReference)?e.spatialReference:n}function F(e,t,r){if(!c.canProjectWithoutEngine(e,t))throw x.spatialReferenceIncompatibleError("scene layer",e?.wkid,t?.wkid);if("local"===r&&!A(e,t))throw x.spatialReferenceIncompatibleError("scene layer",e?.wkid,t?.wkid)}function A(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function D(e,t,r){const i=O(e),s=I(e);F(i,t,r),F(s,t,r)}function E(e){return"mesh-3d"===e.type}const L=_.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0});class V{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}const U=[l.create(),l.create(),l.create(),l.create(),l.create(),l.create(),l.create(),l.create()],B=h.create(),N=h.create(),k=new v.Obb,z=l.create(),j={data:new Array(72),size:3,exclusive:!0,stride:3},G=o.create();e.SymbolInfo=V,e.addWraparound=function(e,t){return(0|e)+(0|t)|0},e.checkPointCloudLayerCompatibleWithView=function(e,t){F(e.spatialReference,t.spatialReference,t.viewingMode)},e.checkPointCloudLayerValid=function(e){if(null==e.store?.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes?.position)throw new i("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t},e.checkRecyclable=function(e,t,r){if(e.serviceUpdateTimeStamp?.lastUpdate!==t.serviceUpdateTimeStamp?.lastUpdate||!r.isEmpty||e.associatedLayer?.url!==t.associatedLayer?.url)throw new i("layerview:recycle-failed","Could not recycle layerview")},e.checkSceneLayerCompatibleWithView=function(e,t){D(e,t.spatialReference,t.viewingMode)},e.checkSceneLayerValid=function(e){if(null==e.store?.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes?.position)throw new i("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t},e.checkSpatialReference=F,e.checkSpatialReferences=D,e.computeVisibilityObb=function(e,t,r,i,s,o,l){if(!o||0===o.length||null==t||!e.serviceMbsInIndexSR)return null;const c=y.computeGlobalTransformation(e.serviceMbsInIndexSR,s,"none",r,t);n.invert(G,c);let u=null,f=1/0,m=-1/0;if(o.forEach(n=>(n=>{if("replace"!==n.type)return;const o=n.geometry;if(!o?.hasZ)return;h.empty(B);const c=o.spatialReference||i,g=o.rings.reduce((e,r)=>r.reduce((e,r)=>(a.set(z,r[0],r[1],r[2]),d.projectVectorToVector(z,c,z,t),a.transformMat4(z,z,G),h.expandPointInPlace(B,z),Math.min(z[2],e)),e),1/0);(()=>{if(!u)if(u=U,h.empty(N),null!=e.serviceObbInIndexSR){e.serviceObbInIndexSR.transform(k,r,t,s,l),k.getCorners(u);for(const e of u)a.transformMat4(e,e,G),h.expandPointInPlace(N,e)}else{const i=e.serviceMbsInIndexSR;if(!i)return;const n=i[3];d.projectVectorToVector(p.getCenter(i),r,z,t),a.transformMat4(z,z,G),z[2]+=s;for(let e=0;e<8;++e){const t=1&e?n:-n,r=2&e?n:-n,i=4&e?n:-n,s=u[e];a.copy(s,[z[0]+t,z[1]+r,z[2]+i]),h.expandPointInPlace(N,s)}}})(),h.intersects(N,B)&&(f=Math.min(f,g),m=Math.max(m,g))})(n)),f===1/0)return null;const g=(e,t,r)=>{a.transformMat4(z,r,c),e[t]=z[0],e[t+1]=z[1],e[t+2]=z[2],t+=24,r[2]=f,a.transformMat4(z,r,c),e[t]=z[0],e[t+1]=z[1],e[t+2]=z[2],t+=24,r[2]=m,a.transformMat4(z,r,c),e[t]=z[0],e[t+1]=z[1],e[t+2]=z[2]};for(let e=0;e<8;++e)g(j.data,3*e,u[e]);return v.compute(j)},e.containsDraco=function(e){if(s("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes?.encoding)return!0;return!1},e.extractWkid=S,e.filterInPlace=function(e,t,r){let i=0,s=0;for(let n=0;n<t.length&&i<e.length;n++)e[i]===t[n]&&(r(n)&&(e[s]=e[i],s++),i++);e.length=s},e.findFieldsCaseInsensitive=P,e.findIntersectingNodes=function(e,t,r,i){r.traverse(t,t=>{const r=t.serviceMbsInIndexSR;return 0!==(null!=r&&C(e,r))&&(i(t),!0)})},e.getClipRect=function(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return T[0]=(e[0]-t.position[0])/t.rotationScale[0],T[1]=(e[1]-t.position[1])/t.rotationScale[4],T[2]=(e[2]-t.position[0])/t.rotationScale[0],T[3]=(e[3]-t.position[1])/t.rotationScale[4],T},e.getIndexCrs=O,e.getSymbolInfo=function(e){const t=new V;let r=!1,i=!1;for(const s of e.symbolLayers.items)if("fill"===s.type&&s.enabled){const e=s.material,n=s.edges;if(null!=e&&!r){const i=e.color,n=b.parseColorMixMode(e.colorMixMode),o={strength:e.emissive?.strength??w.emissiveStrengthDefault,source:"color"===e.emissive?.source?1:0};t.material=null!=i?{color:[i.r/255,i.g/255,i.b/255],alpha:i.a,colorMixMode:n,emissive:o}:{color:[1,1,1],alpha:1,colorMixMode:1,emissive:o},t.castShadows=s.castShadows,r=!0}null==n||i||(t.edgeMaterial=_.createMaterialFromEdges(n,{}),i=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1,emissive:{strength:w.emissiveStrengthDefault,source:0}}),t},e.getVertexCrs=I,e.intersectBoundingRectWithMbs=C,e.invalidateMbs=function(e){null!=e&&(e[3]=-1)},e.isSupportedLocalModeProjection=A,e.isValidMbs=function(e){return e[3]>=0},e.objectIdFilter=function(e,t,i){let s=0,n=0;for(;s<i.length;)r.binaryIndexOf(e,i[s])>=0===t&&(i[n]=i[s],n++),s++;i.length=n},e.queryAttributesFromCachedAttributesId=R,e.rendererNeedsTextures=function(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.symbols;if(0===t.length)return!0;for(const e of t){if(!E(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||null==t.material?.color||"replace"!==t.material.colorMixMode)return!0}return!1},e.transparentEdgeMaterial=L,e.whenGraphicAttributes=async function(e,t,r,s,n,o){if(0===t.length)return[];const a=e.attributeStorageInfo;if(null!=e.associatedLayer)try{return await async function(e,t,r,i){const s=[],n={hasMismatchedCasing:!1,originalFields:s},o=P(r,e.fieldsIndex,n),a=new m({outFields:[...o]});if(await f.fetchFeaturePopupFeatures(e,t,a,{updateSourceAttributes:!0,...i}),!n.hasMismatchedCasing)return t;for(let e=0;e<t.length;e++){const r=t[e];if(r.attributes)for(let e=0;e<s.length;e++){const t=s[e],i=o[e];i in r.attributes&&(r.attributes[t]=r.attributes[i],delete r.attributes[i])}}return t}(e.associatedLayer,t,s,o)}catch(t){if(e.associatedLayer.loaded)throw t}if(a){const i=function({globalIdField:e},t,r,i){const s=new Map,n=[],o=i();for(const i of t){const t=i.attributes?.[r],a=null==t?i.getGlobalId():void 0;for(let r=0;r<o.length;r++){const l=o[r],c=M(l,t,e,a);if(c<0)continue;let u=s.get(l.node);u||(u={node:l.node,indices:[],graphics:[]},n.push(u),s.set(l.node,u)),u.indices.push(c),u.graphics.push(i);for(let e=r;e>0;e--)o[e]=o[e-1];o[0]=l;break}}return n}(e,t,r,n),l=e.parsedUrl.path;return await Promise.allSettled(i.map(t=>function(e,t,r,i,s,n,o,a){return R(e,t,r.resources.attributes,i,s,n,o,a)}(l,a,t.node,t.indices,s,e.apiKey,e.customParameters,o).then(e=>{for(let r=0;r<t.graphics.length;r++){const i=t.graphics[r],s=e[r];if(i.attributes)for(const e in i.attributes)e in s||(s[e]=i.attributes[e]);i.attributes=s}}))),t}throw new i("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/featurePopupQueryUtils":function(){define(["exports","../../core/promiseUtils","../../core/sql","./fieldUtils","../../support/loadArcade"],function(e,t,r,i,s){"use strict";async function n(e){if(e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some(e=>"expression"===e.type))return s.loadArcade()}e.fetchFeaturePopupFeatures=async function(e,s,o,a){const l=new Array(s.length),c=new Map,u=new Map,d=i.unpackFieldNames(e.fieldsIndex,o.outFields),h=a?.hasRequiredFields??i.featureHasFields;for(let e=0;e<s.length;e++){const r=s[e];if(r.isAggregate){l[e]=r;continue}let i=!1;if(a?.getPopupTemplate){const e=(r.origin&&"object"==typeof r.origin&&"layer"in r.origin?r.origin.layer:null)??r.sourceLayer??r.layer,s=a.getPopupTemplate(e);if(null==s)continue;const o=await n(s);t.throwIfAborted(a),i=o&&o.arcadeUtils.hasGeometryOperations(s)}if(i||!h(r,d)){const t=r.getObjectId();if(null!=t){c.set(t,{graphic:r,index:e});continue}const i=r.getGlobalId();if(null!=i){u.set(i,{graphic:r,index:e});continue}}l[e]=r}if(!e.queryFeatures||0===c.size&&0===u.size)return l.filter(Boolean);const p=[],f=(e,t)=>{t&&(e.outFields??=[],e.outFields.includes(t)||e.outFields.push(t))};if(c.size>0){const t=o.clone();f(t,e.objectIdField),"uniqueIdFields"in e&&e.uniqueIdFields?.length&&(t.outFields??=[],t.outFields.push(...e.uniqueIdFields)),t.objectIds=Array.from(c.keys()),p.push({type:"object-id",query:t,map:c})}const m="globalIdField"in e?e.globalIdField:null;if(null!=m&&u.size>0){const e=o.clone();f(e,m);const t=Array.from(u.keys());e.where=r.sqlAnd(o.where,`${m} IN (${t.map(e=>`'${e}'`).join(",")})`),p.push({type:"global-id",query:e,map:u})}const g=a?.updateSourceAttributes??!1;for(const{type:t,query:r,map:i}of p)try{const s=await e.queryFeatures(r,a);for(const e of s.features){const r="object-id"===t?e.getObjectId():e.getGlobalId();if(null==r)continue;const s=i.get(r);if(!s)continue;const{graphic:n,index:o}=s;if(g&&e.attributes){n.attributes??={};for(const t of d)t in e.attributes&&(n.attributes[t]=e.attributes[t])}const{geometry:a,origin:c}=n;e.geometry||=a,e.origin=c,l[o]=e}}catch{}return l.filter(Boolean)},e.loadFeaturePopupArcadeModules=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SBinaryReader":function(){define(["exports","../../../../core/Error","../../../../core/lang","../../../../core/Logger","../../../../core/typedArrayUtil","../../../../geometry/support/UCharArray","../../../../geometry/support/UShortArray","./LEPCC"],function(e,t,r,i,s,n,o,a){"use strict";const l=()=>i.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function c(e,r,i){let s="",n=0;for(;n<i;){const o=e[r+n];if(o<128)s+=String.fromCharCode(o),n++;else if(o>=192&&o<224){if(n+1>=i)throw new t("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");const a=(31&o)<<6|63&e[r+n+1];s+=String.fromCharCode(a),n+=2}else if(o>=224&&o<240){if(n+2>=i)throw new t("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const a=(15&o)<<12|(63&e[r+n+1])<<6|63&e[r+n+2];s+=String.fromCharCode(a),n+=3}else{if(!(o>=240&&o<248))throw new t("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");{if(n+3>=i)throw new t("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const a=(7&o)<<18|(63&e[r+n+1])<<12|(63&e[r+n+2])<<6|63&e[r+n+3];if(a>=65536){const e=55296+(a-65536>>10),t=56320+(1023&a);s+=String.fromCharCode(e,t)}else s+=String.fromCharCode(a);n+=4}}}return s}function u(e,t){const r={byteOffset:0,byteCount:0,fields:Object.create(null)};let i=0;for(let s=0;s<t.length;s++){const n=t[s],o=n.valueType||n.type,a=S[o];r.fields[n.property]=a(e,i),i+=x[o].BYTES_PER_ELEMENT}return r.byteCount=i,r}function d(e,t,r){return h(e,t,r).map(e=>{const t=e?Date.parse(e):null;return null==t||Number.isNaN(t)?null:t})}function h(e,r,i){const s=[];let n,o,a=0;for(o=0;o<e;o+=1){if(n=r[o],n>0){if(s.push(c(i,a,n-1)),0!==i[a+n-1])throw new t("string-array-error","Invalid string array: missing null termination.")}else s.push(null);a+=n}return s}function p(e,t){return new(0,x[t.valueType])(e,t.byteOffset,t.count*t.valuesPerElement)}function f(e,t){if(!e)return null;const r=e[t];return s.isInt16Array(e)?r===s.minInt16?null:r:s.isInt32Array(e)?r===s.minInt32?null:r:r!=r?null:r}function m(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}function g(e,i,s){const n=null!=i.header?u(e,i.header):{byteOffset:0,byteCount:0,fields:{count:s}},o={header:n,byteOffset:n.byteCount,byteCount:0,entries:Object.create(null)};let a=n.byteCount;for(let e=0;e<i.ordering.length;e++){const s=i.ordering[e],l=r.clone(i[s]);if(l.count=n.fields.count??0,"String"===l.valueType){if(l.byteOffset=a,l.byteCount=n.fields[s+"ByteCount"],"UTF-8"!==l.encoding)throw new t("unsupported-encoding","Unsupported String encoding.",{encoding:l.encoding});if(l.timeEncoding&&"ECMA_ISO8601"!==l.timeEncoding)throw new t("unsupported-time-encoding","Unsupported time encoding.",{timeEncoding:l.timeEncoding})}else{if(!T(l.valueType))throw new t("unsupported-value-type","Unsupported binary valueType",{valueType:l.valueType});{const e=C(l.valueType);a+=a%e!==0?e-a%e:0,l.byteOffset=a,l.byteCount=e*l.valuesPerElement*l.count}}a+=l.byteCount??0,o.entries[s]=l}return o.byteCount=a-o.byteOffset,o}function y(e,r,i){if(r!==e&&l().error(`Invalid ${i} buffer size\n expected: ${e}, actual: ${r})`),r<e)throw new t("buffer-too-small","Binary buffer is too small",{expectedSize:e,actualSize:r})}function _(e){return{isDraco:!1,isLegacy:!1,color:null!=e.color,normal:null!=e.normal,uv0:null!=e.uv0,uvRegion:null!=e.uvRegion,featureIndex:null!=e.faceRange&&null!=e.featureId}}function b(e){const t={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const r of e.ordering)if(e.vertexAttributes[r])switch(r){case"position":break;case"normal":t.normal=!0;break;case"color":t.color=!0;break;case"uv0":t.uv0=!0;break;case"region":t.uvRegion=!0}return e.featureAttributes&&e.featureAttributeOrder&&(t.featureIndex=!0),t}function v(e){const t={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const r of e)switch(r){case"position":break;case"normal":t.normal=!0;break;case"uv0":t.uv0=!0;break;case"color":t.color=!0;break;case"uv-region":t.uvRegion=!0;break;case"feature-index":t.featureIndex=!0}return t}const w={position:"position",normal:"normal",color:"color",uv0:"uv0",region:"uvRegion"},x={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},S={Float32:(e,t)=>new DataView(e,0).getFloat32(t,!0),Float64:(e,t)=>new DataView(e,0).getFloat64(t,!0),UInt8:(e,t)=>new DataView(e,0).getUint8(t),Int8:(e,t)=>new DataView(e,0).getInt8(t),UInt16:(e,t)=>new DataView(e,0).getUint16(t,!0),Int16:(e,t)=>new DataView(e,0).getInt16(t,!0),UInt32:(e,t)=>new DataView(e,0).getUint32(t,!0),Int32:(e,t)=>new DataView(e,0).getInt32(t,!0)};function T(e){return x.hasOwnProperty(e)}function C(e){return T(e)?x[e].BYTES_PER_ELEMENT:0}e.createAttributeDataIndex=g,e.createGeometryDescriptor=function(e,t){return e&&e.compressedAttributes&&"draco"===e.compressedAttributes.encoding?v(e.compressedAttributes.attributes):e?_(e):b(t)},e.createGeometryDescriptorForDraco=v,e.createGeometryDescriptorFromDefinition=_,e.createGeometryDescriptorFromSchema=b,e.createGeometryIndexFromSchema=function(e,t){const r=u(e,t&&t.header);let i=r.byteCount;const s={isDraco:!1,header:r,byteOffset:r.byteCount,byteCount:0,vertexAttributes:{}},n=r.fields,o=null!=n.vertexCount?n.vertexCount:n.count;for(const e of t.ordering){if(!t.vertexAttributes[e])continue;const r={...t.vertexAttributes[e],byteOffset:i,count:o},n=w[e]||"_"+e;s.vertexAttributes[n]=r,i+=C(r.valueType)*r.valuesPerElement*o}const a=n.faceCount;if(t.faces&&a){s.faces={};for(const e of t.ordering){if(!t.faces[e])continue;const r={...t.faces[e],byteOffset:i,count:a};s.faces[e]=r,i+=C(r.valueType)*r.valuesPerElement*a}}const l=n.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&l){s.featureAttributes={};for(const e of t.featureAttributeOrder){if(!t.featureAttributes[e])continue;const r={...t.featureAttributes[e],byteOffset:i,count:l};s.featureAttributes[e]=r,i+=("UInt64"===r.valueType?8:C(r.valueType))*r.valuesPerElement*l}}return y(i,e.byteLength,"geometry"),s.byteCount=i-s.byteOffset,s},e.createRawView=m,e.createTypedView=p,e.getBytesPerValue=C,e.getCachedAttributeValue=f,e.isValueType=T,e.readBinaryAttribute=function(e,r,i,c=!1){if("lepcc-rgb"===e.encoding)return c?a.decodeRGB(r):n.compactUCharArray(a.decodeRGB(r));if("lepcc-intensity"===e.encoding)return c?a.decodeIntensity(r):o.compactUShortArray(a.decodeIntensity(r));if(null!=e.encoding&&""!==e.encoding)throw new t("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");e["attributeByteCounts "]&&!e.attributeByteCounts&&(l().warn("Warning: Trailing space in 'attributeByteCounts '."),e.attributeByteCounts=e["attributeByteCounts "]),"ObjectIds"===e.ordering[0]&&e.hasOwnProperty("objectIds")&&(l().warn("Warning: Case error in objectIds"),e.ordering[0]="objectIds");const u=g(r,e,i);y(u.byteOffset+u.byteCount,r.byteLength,"attribute");const _=u.entries.attributeValues||u.entries.objectIds;if(_){if("String"===_.valueType){const e=u.entries.attributeByteCounts,t=p(r,e),i=m(r,_);return _.timeEncoding?d(e.count,t,i):h(e.count,t,i)}return c?p(r,_):function(e,t){const r=p(e,t);if(r.length>=s.nativeArrayMaxSize)return r;const i=new Array;return r.forEach((e,t)=>i.push(f(r,t))),i}(r,_)}throw new t("bad-attribute-storage-info","Bad attributeStorageInfo specification.")},e.readDateStringArray=d,e.readHeader=u,e.readStringArray=h,e.valueType2ArrayBufferReader=S,e.valueType2TypedArrayClassMap=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/UCharArray":function(){define(["exports","../../core/typedArrayUtil"],function(e,t){"use strict";e.compactUCharArray=function(e){return Array.isArray(e)?e.length<t.nativeArrayMaxSize?e:new Uint8Array(e):e.length<t.nativeArrayMaxSize?Array.from(e):e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/UShortArray":function(){define(["exports","../../core/typedArrayUtil"],function(e,t){"use strict";e.compactUShortArray=function(e){return Array.isArray(e)?e.length<t.nativeArrayMaxSize?e:new Uint16Array(e):e.length<t.nativeArrayMaxSize?Array.from(e):e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/LEPCC":function(){define(["exports","../../../../core/Error"],function(e,t){"use strict";const r=!0;function i(e,t,i){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,i+0,10)),version:t.getUint16(i+10,r),checksum:t.getUint32(i+12,r)}}function s(e,t,r){const i=[];t=n(e,t,i);const s=[];for(let o=0;o<i.length;o++){s.length=0,t=n(e,t,s);for(let e=0;e<s.length;e++)r.push(s[e]+i[o])}return t}function n(e,i,s){const n=new DataView(e,i),o=n.getUint8(0),a=31&o,l=!!(32&o),c=(192&o)>>6;let u=0;if(0===c)u=n.getUint32(1,r),i+=5;else if(1===c)u=n.getUint16(1,r),i+=3;else{if(2!==c)throw new t("lepcc-decode-error","Bad count type");u=n.getUint8(1),i+=2}if(l)throw new t("lepcc-decode-error","LUT not implemented");const d=Math.ceil(u*a/8),h=new Uint8Array(e,i,d);let p=0,f=0,m=0;const g=-1>>>32-a;for(let e=0;e<u;e++){for(;f<a;)p|=h[m]<<f,f+=8,m+=1;s[e]=p&g,p>>>=a,f-=a,f+a>32&&(p|=h[m-1]>>8-f)}return i+m}e.decodeIntensity=function(e){const s=new DataView(e,0);let o=0;const{identifier:a,version:l}=i(e,s,o);if(o+=16,"Intensity "!==a)throw new t("lepcc-decode-error","Bad identifier");if(l>1)throw new t("lepcc-decode-error","Unknown version");const c=function(e,t){return{sizeLo:e.getUint32(t+0,r),sizeHi:e.getUint32(t+4,r),count:e.getUint32(t+8,r),scaleFactor:e.getUint16(t+12,r),bitsPerPoint:e.getUint8(t+14),reserved:e.getUint8(t+15)}}(s,o);if(o+=16,c.sizeHi*2**32+c.sizeLo!==e.byteLength)throw new t("lepcc-decode-error","Bad size");const u=new Uint16Array(c.count);if(8===c.bitsPerPoint){if(c.count+o!==e.byteLength)throw new t("lepcc-decode-error","Bad size");const r=new Uint8Array(e,o,c.count);for(let e=0;e<c.count;e++)u[e]=r[e]*c.scaleFactor}else if(16===c.bitsPerPoint){if(2*c.count+o!==e.byteLength)throw new t("lepcc-decode-error","Bad size");const r=new Uint16Array(e,o,c.count);for(let e=0;e<c.count;e++)u[e]=r[e]*c.scaleFactor}else{const r=[];if(n(e,o,r)!==e.byteLength)throw new t("lepcc-decode-error","Bad size");for(let e=0;e<c.count;e++)u[e]=r[e]*c.scaleFactor}return u},e.decodeRGB=function(e){const s=new DataView(e,0);let n=0;const{identifier:o,version:a}=i(e,s,n);if(n+=16,"ClusterRGB"!==o)throw new t("lepcc-decode-error","Bad identifier");if(a>1)throw new t("lepcc-decode-error","Unknown version");const l=function(e,t){return{sizeLo:e.getUint32(t+0,r),sizeHi:e.getUint32(t+4,r),count:e.getUint32(t+8,r),colorMapCount:e.getUint16(t+12,r),lookupMethod:e.getUint8(t+14),compressionMethod:e.getUint8(t+15)}}(s,n);if(n+=16,l.sizeHi*2**32+l.sizeLo!==e.byteLength)throw new t("lepcc-decode-error","Bad size");if((2===l.lookupMethod||1===l.lookupMethod)&&0===l.compressionMethod){if(3*l.colorMapCount+l.count+n!==e.byteLength||l.colorMapCount>256)throw new t("lepcc-decode-error","Bad count");const r=new Uint8Array(e,n,3*l.colorMapCount),i=new Uint8Array(e,n+3*l.colorMapCount,l.count),s=new Uint8Array(3*l.count);for(let e=0;e<l.count;e++){const t=i[e];s[3*e]=r[3*t],s[3*e+1]=r[3*t+1],s[3*e+2]=r[3*t+2]}return s}if(0===l.lookupMethod&&0===l.compressionMethod){if(3*l.count+n!==e.byteLength||0!==l.colorMapCount)throw new t("lepcc-decode-error","Bad count");return new Uint8Array(e,n).slice()}if(l.lookupMethod<=2&&1===l.compressionMethod){if(n+3!==e.byteLength||1!==l.colorMapCount)throw new t("lepcc-decode-error","Bad count");const r=s.getUint8(n),i=s.getUint8(n+1),o=s.getUint8(n+2),a=new Uint8Array(3*l.count);for(let e=0;e<l.count;e++)a[3*e]=r,a[3*e+1]=i,a[3*e+2]=o;return a}throw new t("lepcc-decode-error","Bad method "+l.lookupMethod+","+l.compressionMethod)},e.decodeXYZ=function(e){const n=new DataView(e,0);let o=0;const{identifier:a,version:l}=i(e,n,o);if(o+=16,"LEPCC     "!==a)throw new t("lepcc-decode-error","Bad identifier");if(l>1)throw new t("lepcc-decode-error","Unknown version");const c=function(e,t){return{sizeLo:e.getUint32(t+0,r),sizeHi:e.getUint32(t+4,r),minX:e.getFloat64(t+8,r),minY:e.getFloat64(t+16,r),minZ:e.getFloat64(t+24,r),maxX:e.getFloat64(t+32,r),maxY:e.getFloat64(t+40,r),maxZ:e.getFloat64(t+48,r),errorX:e.getFloat64(t+56,r),errorY:e.getFloat64(t+64,r),errorZ:e.getFloat64(t+72,r),count:e.getUint32(t+80,r),reserved:e.getUint32(t+84,r)}}(n,o);if(o+=88,c.sizeHi*2**32+c.sizeLo!==e.byteLength)throw new t("lepcc-decode-error","Bad size");const u=new Float64Array(3*c.count),d=[],h=[],p=[],f=[];if(o=s(e,o,d),o=s(e,o,h),o=s(e,o,p),o=s(e,o,f),o!==e.byteLength)throw new t("lepcc-decode-error","Bad length");let m=0,g=0;for(let e=0;e<d.length;e++){g+=d[e];let t=0;for(let r=0;r<h[e];r++){t+=p[m];const e=f[m];u[3*m]=Math.min(c.maxX,c.minX+2*c.errorX*t),u[3*m+1]=Math.min(c.maxY,c.minY+2*c.errorY*g),u[3*m+2]=Math.min(c.maxZ,c.minZ+2*c.errorZ*e),m++}}return{errorX:c.errorX,errorY:c.errorY,errorZ:c.errorZ,result:u}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SProjectionUtil":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/projection/computeTranslationToOriginAndRotation"],function(e,t,r,i,s){"use strict";function n(e,t,s){const n=r.create(),o=e[3],a=2**(4*Math.ceil(Math.log(o)*Math.LOG2E/4)+1);if(s.isGeographic){const t=a/i.getReferenceEllipsoid(s).radius*180/Math.PI,r=Math.round(e[1]/t),o=Math.max(-90,Math.min(90,r*t)),l=t/Math.cos((Math.abs(o)-t/2)/180*Math.PI),c=Math.round(e[0]/l)*l;n[0]=c,n[1]=o}else{const t=Math.round(e[0]/a),r=Math.round(e[1]/a);n[0]=t*a,n[1]=r*a}const l=e[2]+t,c=Math.round(l/a);return n[2]=c*a,n}e.computeGlobalTransformation=function(e,i,o,a,l){const c="east-north-up"===o?r.clone(e):n(e,i,a),u=t.create();return s.computeTranslationToOriginAndRotation(a,c,u,l),u},e.getLocalOrigin=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/support/popupUtils":function(){define(["exports","../../../layers/support/fieldUtils"],function(e,t){"use strict";function r(e,t){return e&&"object"==typeof e?t?.checkPopupEnabled&&"popupEnabled"in e&&!e.popupEnabled?null:"popupTemplate"in e&&e.popupTemplate?e.popupTemplate:null!=t&&t.defaultPopupTemplateEnabled&&"defaultPopupTemplate"in e&&e.defaultPopupTemplate?e.defaultPopupTemplate:null:null}e.getFetchPopupTemplate=r,e.getRequiredFields=async function(e,r=e.popupTemplate){if(null==r)return[];const i=await r.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:s}=r,{objectIdField:n,typeIdField:o,globalIdField:a,relationships:l}=e;if(i.includes("*"))return["*"];const c=s?t.getFeatureEditFields(e):[],u=t.fixFields(e.fieldsIndex,[...i,...c]);return o&&u.push(o),u&&n&&e.fieldsIndex?.has(n)&&!u.includes(n)&&u.push(n),u&&a&&e.fieldsIndex?.has(a)&&!u.includes(a)&&u.push(a),l&&l.forEach(t=>{const{keyField:r}=t;u&&r&&e.fieldsIndex?.has(r)&&!u.includes(r)&&u.push(r)}),u},e.hasPopupTemplate=function(e,t){return null!=r(e,{defaultPopupTemplateEnabled:t})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/ElevationLayerView3D":function(){define(["require","../../../chunks/tslib.es6","../../../core/Error","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/support/ElevationTileData","../../../layers/support/LercDecoder","./ElevationLayerView3DModifications","./LayerView3D","./TiledLayerView3D","../terrain/TerrainConst","../terrain/terrainUtils","../../layers/LayerView"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y){"use strict";let _=class extends(f.TiledLayerView3D(p.LayerView3D(y))){constructor(){super(...arguments),this.type="elevation-3d",this.modifications=new h.ElevationLayerView3DModifications}get tileInfo(){return this.layer.tileInfo}initialize(){const e=this.view,t=e.map?.allLayers,i=t&&t.includes(this.layer),s=e.map?.ground?.layers,n=s&&s.includes(this.layer);if(i&&!n){const e=new r("layerview:elevation-layer-only",`3D elevation layer '${this.layer.id}' can only be added to layers in map.ground`);this.addResolvingPromise(Promise.reject(e))}this._lercDecoder=d.acquireDecoder(e.resourceController),this._addTilingSchemeMatchPromise()}destroy(){this._lercDecoder=s.releaseMaybe(this._lercDecoder)}async fetchElevationTile(e,t){const r=await this._fetchTileData(e.lij,t);if(!n.isAborted(t))return r&&await this.modifications.apply(r,e,t.signal),r}async _fetchTileData(e,t){const r=this.layer;if(g.useFetchTileForLayer(r)){const s=await r.fetchTile(e[0],e[1],e[2],{noDataValue:m.elevationNoDataValue,signal:t.signal});return n.isAborted(t)?void i.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."):s}const s=this.getTileUrl(e),o=await t.requester.request(s,1,t),a=await this._lercDecoder.decode(o,{noDataValue:m.elevationNoDataValue},t.signal);if(a)return new u.ElevationTileData(a);throw new Error("LERC decoding failed")}async setModifications(t){if(this.modifications.modifications.length=0,!t||0===t.length)return;this._simplifyOperatorPromise??=new Promise((t,r)=>e(["../../../geometry/operators/simplifyOperator"],t,r));const r=await this._simplifyOperatorPromise;for(const e of t){const t=e.geometry;if("polygon"===t?.type){const s=r.execute(t);if("polygon"===s?.type){const t=new h.ElevationLayerView3DModification(e.type,s);this.modifications.modifications.push(t)}else i.getLogger(this).warn("Failed to simplify modification polygon")}else i.getLogger(this).warn("Invalid modification added to elevation layer: "+(t?`non polygon geometry ${t.type}`:"no geometry"))}}};return t.__decorate([o.property()],_.prototype,"layer",void 0),t.__decorate([o.property()],_.prototype,"tileInfo",null),t.__decorate([o.property()],_.prototype,"modifications",void 0),_=t.__decorate([c.subclass("esri.views.3d.layers.ElevationLayerView3D")],_),_})},"esri/layers/support/ElevationTileData":function(){define(["exports"],function(e){"use strict";e.ElevationTileData=class{constructor(e,t,r,i){this._hasNoDataValues=null,this._minValue=null,this._maxValue=null,"pixelData"in e?(this.values=e.pixelData,this.width=e.width,this.height=e.height,this.noDataValue=e.noDataValue):(this.values=e,this.width=t,this.height=r,this.noDataValue=i)}get hasNoDataValues(){if(null==this._hasNoDataValues){const e=this.noDataValue;this._hasNoDataValues=this.values.includes(e)}return this._hasNoDataValues}get minValue(){return this._ensureBounds(),this._minValue}get maxValue(){return this._ensureBounds(),this._maxValue}get cachedMemory(){return this.values.byteLength+256}_ensureBounds(){if(null!=this._minValue)return;const{noDataValue:e,values:t}=this;let r=1/0,i=-1/0,s=!0;for(const n of t)n===e?this._hasNoDataValues=!0:(r=n<r?n:r,i=n>i?n:i,s=!1);s?(this._minValue=0,this._maxValue=0):(this._minValue=r,this._maxValue=i>-3e38?i:0)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/LercDecoder":function(){define(["exports","../../core/workers/WorkerHandle"],function(e,t){"use strict";class r extends t.WorkerHandle{constructor(e=null){super("LercWorker","_decode",{_decode:e=>[e.buffer]},e,{strategy:"dedicated"}),this.schedule=e,this.ref=0}decode(e,t,r){return e&&0!==e.byteLength?this.invoke({buffer:e,options:t},r):Promise.resolve(null)}release(){--this.ref<=0&&(i.forEach((e,t)=>{e===this&&i.delete(t)}),this.destroy())}}const i=new Map;e.acquireDecoder=function(e=null){let t=i.get(e);return t||(null!=e?(t=new r(t=>e.immediate.schedule(t)),i.set(e,t)):(t=new r,i.set(null,t))),++t.ref,t},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/ElevationLayerView3DModifications":function(){define(["require","exports","../../../core/promiseUtils","../../../geometry/Extent","../../../geometry/support/aaBoundingRect"],function(e,t,r,i,s){"use strict";let n,o;t.ElevationLayerView3DModification=class{constructor(e,t){this.type=e,this.polygon=t}apply(e,t){if("replace"!==this.type)return;const{polygon:r}=this,[n,a,l]=o,{extent:c,spatialReference:u}=t,d=s.toExtent(c,u);if(a.accelerateGeometry(r),!a.execute(r,d))return;n.accelerateGeometry(r),l.accelerateGeometry(r);const{width:h,height:p,values:f}=e,m=r.hasZ?r.rings.reduce((e,t)=>t.reduce((e,t)=>Math.min(e,t[2]??1/0),e),1/0):1/0,g=m===1/0?0:m;if(n.execute(r,d))f.fill(g);else{const e=function(e,t,r){const[s,n,a,l]=e.extent,{spatialReference:c}=e,[u,d]=r,h=(a-s)/(u-1),p=(l-n)/(d-1),f=new i({xmin:s-2*h,ymin:n-2*p,xmax:a+2*h,ymax:l+2*p,spatialReference:c}),m=o[2].execute(t,f);return"polygon"===m?.type?m:null}(t,r,[h,p]);if(!e)return;if(e.rings.every(e=>0===e.length))return;const s=function(e,t,r,i){const s=new OffscreenCanvas(r+2,i+2).getContext("2d",{willReadFrequently:!0});if(!s)throw new Error("failed to create canvas");const[n,o,a,l]=e.extent,c=a-n,u=l-o;s.fillStyle="black",s.clearRect(0,0,r,i);const d=new Path2D;for(const e of t.rings)if(e.length>0){const t=new Path2D;let s=!0;for(const[o,a]of e){const e=(o-n)/c*(r-1)+1+.5,d=(l-a)/u*(i-1)+1+.5;s?(s=!1,t.moveTo(e,d)):t.lineTo(e,d)}t.closePath(),d.addPath(t)}s.fillStyle="white",s.fill(d,"evenodd");const h=s.getImageData(0,0,r+2,i+2),p=(r+2)*(i+2),f=new Uint8Array(p);for(let e=0;e<p;++e)f[e]=h.data[4*e+0]>0?1:0;return f}(t,e,h,p);for(let e=p-1;e>=0;--e)for(let t=0;t<h;++t){const r=(e+1)*(h+2)+(t+1);let i=0;for(let e=-1;e<=1;++e){const t=r+e*(h+2);for(let e=-1;e<=1;++e)i=Math.max(i,s[t+e])}const n=e*h+t;f[n]=0===i?f[n]:g}}}},t.ElevationLayerView3DModifications=class{constructor(){this.modifications=[]}async apply(t,i,s){if(0!==this.modifications.length&&(n??=Promise.all([new Promise((t,r)=>e(["../../../geometry/operators/containsOperator"],t,r)),new Promise((t,r)=>e(["../../../geometry/operators/intersectsOperator"],t,r)),new Promise((t,r)=>e(["../../../geometry/operators/intersectionOperator"],t,r))]),o=await n,!r.isAborted(s)))for(const e of this.modifications)e.apply(t,i)}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/LayerView3D":function(){define(["exports","../../../chunks/tslib.es6","../../../core/handleUtils","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/heightModelInfoUtils"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.LayerView3D=e=>{const o=e;let a=class extends o{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),u.supportsHeightModelInfo(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles(r.makeHandle(()=>e.abort())),await s.whenOnce(()=>this.view.defaultsFromMap?.heightModelInfoReady,t),i.throwIfAborted(t);const n=u.rejectLayerError(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(n)throw n}};return t.__decorate([n.property()],a.prototype,"view",void 0),t.__decorate([n.property()],a.prototype,"slicePlaneEnabled",void 0),a=t.__decorate([c.subclass("esri.views.3d.layers.LayerView3D")],a),a},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/TiledLayerView3D":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Error","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./support/LayerViewPerformanceInfo","../support/updatingProperties","../terrain/terrainUtils","../../support/layerViewUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.TiledLayerView3D=e=>{const n=e;let o=class extends n{constructor(){super(...arguments),this.hasMixedImageFormats=!0}get imageFormatIsOpaque(){return!1}get fullExtent(){return this.layer.fullExtent}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get visibleAtCurrentScale(){const{minScale:e,maxScale:t}=this.layer;if(!h.isScaleRangeActive(e,t))return!0;const{basemapTerrain:r}=this.view,i=r.getLayerIndexByUID(1,this.uid);if(null==i)return!1;const{tilingScheme:s}=r,n=e&&s.levelAtScale(e),o=t&&s.levelAtScale(t);return r.renderer.visibleTiles.some(e=>!!e.layerInfo[1][i]&&(!n||e.level>=n)&&(!o||e.level<=o))}get dataScaleRange(){const e=this.tileInfo.lods;let t=e[0].scale,r=e[e.length-1].scale;if("tilemapCache"in this.layer&&this.layer.tilemapCache){const{effectiveMinLOD:e,effectiveMaxLOD:i}=this.layer.tilemapCache;t=this.tileInfo.lodAt(e).scale,r=this.tileInfo.lodAt(i).scale}return{minScale:t,maxScale:r}}canResume(){const e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready&&h.validateScaleRange(e)&&this.visibleAtCurrentTimeExtent||!1}get dataLevelRange(){const{minScale:e,maxScale:t}=this.dataScaleRange;return this.levelRangeFromScaleRange(e,t)}get displayLevelRange(){const e=this.layer.minScale||this.dataScaleRange.minScale,t=this.layer.maxScale||this.dataScaleRange.maxScale,r=this.levelRangeFromScaleRange(e,t);return this.layer.maxScale&&r.maxLevel++,r}get performanceInfo(){return new c.LayerViewPerformanceInfo(this.view.basemapTerrain.getUsedMemoryForLayerView(this))}getTileUrl(e){return this.layer.getTileUrl(e[0],e[1],e[2])}_addTilingSchemeMatchPromise(){if(null==this.fullExtent)return this.addResolvingPromise(Promise.reject(new r("tilingscheme:extent-not-defined","This layer doesn't define a fullExtent.")));const e=this._getTileInfoSupportError(this.tileInfo,this.fullExtent);if(e)return this.addResolvingPromise(Promise.reject(e));this.addResolvingPromise(i.whenOnce(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{const e=this.view.basemapTerrain.tilingScheme,t="tilemapCache"in this.layer?this.layer.tilemapCache?.effectiveMaxLOD:void 0,r=this._getTileInfoCompatibilityError(this.tileInfo,e,t);if(r)throw r}))}_getTileInfoSupportError(e,t){const i=d.checkIfTileInfoSupportedForView(e,t,this.view.spatialReference,this.view.state.viewingMode,"tilemapCache"in this.layer?this.layer.tilemapCache?.effectiveMaxLOD:void 0);if(!i)return;const s={layer:this.layer,error:i};switch(i.name){case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":case"tilingscheme:local-unsupported-spatial-reference":return new r("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",s);default:return new r("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",s)}}_getTileInfoCompatibilityError(e,t,i){return null!=e&&t.compatibleWith(e,i)?null:new r("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(e,t){const r={minLevel:0,maxLevel:1/0},i=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!i)return r;const s=i.levels[0],n=e=>{const t=Math.log(s.scale/e)/Math.LN2;return.5-Math.abs(.5-t%1)<1e-9?Math.round(t):Math.ceil(t)};return null!=e&&e>0&&(r.minLevel=Math.max(0,n(e))),null!=t&&t>0&&(r.maxLevel=Math.max(0,n(t))),r}isUpdating(){return!!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return t.__decorate([s.property({readOnly:!0})],o.prototype,"imageFormatIsOpaque",null),t.__decorate([s.property({readOnly:!0})],o.prototype,"updating",void 0),t.__decorate([s.property(u.updatingProgress)],o.prototype,"updatingProgress",void 0),t.__decorate([s.property(u.updatingProgressValue)],o.prototype,"updatingProgressValue",void 0),t.__decorate([s.property()],o.prototype,"hasMixedImageFormats",void 0),t.__decorate([s.property()],o.prototype,"fullExtent",null),t.__decorate([s.property({readOnly:!0})],o.prototype,"isOpaque",null),t.__decorate([s.property({readOnly:!0})],o.prototype,"visibleAtCurrentScale",null),t.__decorate([s.property()],o.prototype,"dataScaleRange",null),t.__decorate([s.property({readOnly:!0})],o.prototype,"dataLevelRange",null),t.__decorate([s.property({readOnly:!0})],o.prototype,"displayLevelRange",null),t.__decorate([s.property()],o.prototype,"layer",void 0),o=t.__decorate([l.subclass("esri.views.3d.layers.TiledLayerView3D")],o),o},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/FeatureLayerView3D":function(){define(["../../../chunks/tslib.es6","../../../core/Error","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/projectionUtils","../../../graphic/FeatureGraphicOrigin","../../../layers/support/layerUtils","./FeatureLayerViewBase3D"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";let d=class extends u{constructor(){super(...arguments),this.type="feature-3d"}initialize(){const{layer:e,view:r}=this;c.getEffectiveLayerCapabilities(e)?.operations.supportsQuery||this.addResolvingPromise(Promise.reject(new t("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e}))),null!=e.infoFor3D&&this.addResolvingPromise(Promise.reject(new t("featurelayerview3d:unsupported-geometry-type",`Unsupported geometry type ${e.geometryType}`))),"mesh"!==e.geometryType||a.canProjectWithoutEngine(e.spatialReference,r.spatialReference)||this.addResolvingPromise(Promise.reject(new t("layerview:spatial-reference-incompatible","The spatial references of the feature layer is incompatible with the spatial reference of the view")))}get graphicOrigin(){return new l(this.layer)}get featureSpatialReference(){return this.view.featureTiles?.tilingScheme?.spatialReference}};return e.__decorate([r.property()],d.prototype,"layer",void 0),e.__decorate([r.property()],d.prototype,"graphicOrigin",null),d=e.__decorate([o.subclass("esri.views.3d.layers.FeatureLayerView3D")],d),d})},"esri/views/3d/layers/FeatureLayerViewBase3D":function(){define(["require","exports","../../../chunks/tslib.es6","../../../core/Error","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/graphics/dehydratedFeatures","./FeatureLikeLayerView3D","./LayerView3D","./graphics/FeatureGraphics3DGraphicsPipeline","../support/updatingProperties","../../layers/FeatureLayerView","../../layers/LayerView","../../layers/RefreshableLayerView"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_){"use strict";return t.default=class extends(_.RefreshableLayerView(h.FeatureLikeLayerView3D(g.FeatureLayerView(p.LayerView3D(y))))){constructor(e){super(e)}initialize(){this.addHandles(o.watch(()=>this._updatingRequiredPromise,e=>this._updatingHandles.addPromise(e),o.syncAndInitial))}destroy(){this._updatingHandles.removeAll(),this._fetcherContext=n.destroyMaybe(this._fetcherContext)}get maximumNumberOfFeatures(){return this.graphicsPipeline.maximumNumberOfFeatures}set maximumNumberOfFeatures(e){this.graphicsPipeline.maximumNumberOfFeatures=e}get maximumNumberOfFeaturesExceeded(){return null!=this.graphicsPipeline&&!this.suspended&&this.graphicsPipeline.maximumNumberOfFeaturesExceeded}get updatingProgressValue(){return this.graphicsPipeline?.updatingProgressValue??0}get updatePolicy(){return this.graphicsPipeline?.updatePolicy??0}get hasZ(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&null!=e.returnZ?e.returnZ:t.supportsZ)}get hasM(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&"returnM"in e&&null!=e.returnM&&e.returnM}setVisibility(e,t){this.graphicsPipeline?.setVisibility(e,t)}createQuery(){return super.createQuery()}queryFeatures(e,t){const r=()=>super.queryFeatures(e,t);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(e),r):r()}async createGraphicsPipeline(){if(s("feature-pipeline-3d-test")){const{Feature3DPipeline:t}=await new Promise((t,r)=>e(["./graphics/pipeline/Feature3DPipeline"],t,r));return new t({layerView:this})}return new f.FeatureGraphics3DGraphicsPipeline({layerView:this})}async doRefresh(e){return await this.graphicsPipeline.doRefresh(e)}_popupFeatureHasRequiredFields(e,t){if(!super._popupFeatureHasRequiredFields(e,t))return!1;const r=d.getObjectId(e,this.layer.objectIdField);if(null==r)return!0;const i=this.graphicsPipeline.getMissingAttributesForFeature(r);if(null==i)return!0;for(const e of t)if(i.has(e))return!1;return!0}get usedMemory(){return this.graphicsPipeline?.usedMemory??0}get unloadedMemory(){return this.graphicsPipeline?.unloadedMemory??0}get ignoresMemoryFactor(){return this.graphicsPipeline?.ignoresMemoryFactor??!1}async _queryFeaturesMesh(e,t){this._validateQueryFeaturesMesh(e);const r=await t(),i=this.graphicsPipeline;if(e?.outStatistics||null==i)return r;const s=this.layer.objectIdField,n=[];for(const e of r.features)if(e.geometry){const t=i.getHydratedGeometry(e.attributes[s]);t&&(e.geometry=t,n.push(e))}else n.push(e);return r.features=n,r}_validateQueryFeaturesMesh(e){if(!e)return;const t=e=>{throw new i("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${e}'`)},r=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const i of r)null!=e[i]&&t(i);"returnM"in e&&e.returnM&&t("returnM"),"returnCentroid"in e&&e.returnCentroid&&t("returnCentroid"),null==e.outSpatialReference||e.outSpatialReference.equals(this.view.spatialReference)||t("outSpatialReference")}get test(){}},r.__decorate([a.property()],t.default.prototype,"layer",void 0),r.__decorate([a.property()],t.default.prototype,"graphicsPipeline",void 0),r.__decorate([a.property()],t.default.prototype,"maximumNumberOfFeatures",null),r.__decorate([a.property()],t.default.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([a.property(m.updatingProgress)],t.default.prototype,"updatingProgress",void 0),r.__decorate([a.property({readOnly:!0})],t.default.prototype,"updatingProgressValue",null),r.__decorate([a.property({readOnly:!0})],t.default.prototype,"updatePolicy",null),r.__decorate([a.property({readOnly:!0})],t.default.prototype,"hasZ",null),r.__decorate([a.property({readOnly:!0})],t.default.prototype,"hasM",null),t.default=r.__decorate([u.subclass("esri.views.3d.layers.FeatureLayerViewBase3D")],t.default),t.default})},"esri/views/3d/layers/FeatureLikeLayerView3D":function(){define(["exports","../../../chunks/tslib.es6","../../../Graphic","../../../core/Error","../../../core/handleUtils","../../../core/has","../../../core/maybe","../../../core/ReactiveMap","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/graphics/hydratedFeatures","../../../layers/support/timeSupport","../../../rest/support/Query","../../../support/guards","./support/attributeUtils","./support/highlightUtils","../../support/highlightOptionsUtils","../../support/layerViewUtils","../../support/projectionUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v){"use strict";e.FeatureLikeLayerView3D=e=>{const c=e;let u=class extends c{constructor(){super(...arguments),this.highlightOptions=null,this.updatePolicy=1,this.slicePlaneEnabled=!1,this._highlightCounter=new a,this.fullExtentInLocalViewSpatialReference=null,this.supportsHeightUnitConversion=!0}initialize(){const e=this.layer;"isTable"in e&&e.isTable?this.addResolvingPromise(Promise.reject(new i("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e}))):(this.addResolvingPromise(this._validateGeometryType()),this.addResolvingPromise((async()=>{if(this.destroyed)return;this.fullExtentInLocalViewSpatialReference="local"===this.view.viewingMode?await v.projectWithZConversionSilent(this.layer.fullExtent,this.view.spatialReference):null;const e=await this.createGraphicsPipeline();this.destroyed?e.destroy():(this.graphicsPipeline=e,await e.when())})()),this.notifyChange("updating"))}destroy(){this.graphicsPipeline=o.destroyMaybe(this.graphicsPipeline)}get dataUpdating(){return!!this.graphicsPipeline?.dataUpdating}get legendEnabled(){return this.canResume()&&this.graphicsPipeline?.legendEnabled}get visibleAtCurrentScale(){return b.hasLayerBasedScaleVisibility()?b.isInEffectiveScaleRange(this.layer.effectiveScaleRange,this.view.scale):!this.graphicsPipeline?.scaleVisibilitySuspended}get symbologySnappingSupported(){return this.graphicsPipeline.symbologySnappingSupported}get hasAllFeatures(){return this.graphicsPipeline.hasAllFeatures}get hasAllFeaturesInView(){return this.graphicsPipeline.hasAllFeaturesInView}get hasFullGeometries(){return this.graphicsPipeline.hasFullGeometries}get timeExtent(){return p.combineTimeExtent(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get highlightIds(){return Array.from(this._highlightCounter.keys())}get hasHighlight(){return this._highlightCounter.size>0}getHit(e,t){if(n("feature-pipeline-3d-test"))return this._getHitMock(e);const r=this.graphicsPipeline.findGraphic(t=>t.uid===e);if(null==r)return null;const i=h.hydrateGraphic(r,this.layer);return{type:"graphic",graphic:i,layer:i.layer}}_getHitMock(e){const t=this.layer,i={};i[this.layer.objectIdField]=e;const s=new r({layer:t,sourceLayer:t,origin:this.graphicOrigin,visible:!0,symbol:null,attributes:i,geometry:null});return{type:"graphic",graphic:s,layer:s.layer}}whenGraphicBounds(e,t){return this.graphicsPipeline?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphicsPipeline?.computeAttachmentOrigin(e,t)}async elevationAlignPointsInFeatures(e,t){return this.graphicsPipeline.elevationAlignPointsInFeatures(e,t)}async queryForSymbologySnapping(e,t){return this.graphicsPipeline.graphicsQuery.queryForSymbologySnapping(e,t)}queryFeatures(e,t){return this.graphicsPipeline.graphicsQuery.executeQuery(this._ensureQuery(e),t?.signal)}queryObjectIds(e,t){return this.graphicsPipeline.graphicsQuery.executeQueryForIds(this._ensureQuery(e),t?.signal)}queryFeatureCount(e,t){return this.graphicsPipeline.graphicsQuery.executeQueryForCount(this._ensureQuery(e),t?.signal)}queryExtent(e,t){return this.graphicsPipeline.graphicsQuery.executeQueryForExtent(this._ensureQuery(e),t?.signal)}_ensureQuery(e){return null==e?this.createQuery():f.from(e)}_addHighlightIds(e){for(const t of e){const e=this._highlightCounter.get(t)??0;this._highlightCounter.set(t,e+1)}}_removeHighlightIds(e){for(const t of e){let e=this._highlightCounter.get(t);null!=e&&(e--,e>0?this._highlightCounter.set(t,e):this._highlightCounter.delete(t))}}highlight(e,t){const r=_.getHighlightName(t),i=this.layer.objectIdField,n=y.normalizeHighlightTarget(e);if(0===n.length)return y.emptyHighlightHandle;if(m.isGraphic(n[0])){const e=n;if(null!=g.attributeLookup(this.layer.fieldsIndex,e[0].attributes,i)){const t=e.map(e=>g.attributeLookup(this.layer.fieldsIndex,e.attributes,i)),n=this.graphicsPipeline.highlightByObjectIds(t,r);return this._addHighlightIds(t),s.makeHandle(()=>{this._removeHighlightIds(t),n.remove()})}return this.graphicsPipeline.highlightByGraphics(e,r)}if(y.isObjectId(n[0])){const e=n;this._addHighlightIds(e);const t=this.graphicsPipeline.highlightByObjectIds(e,r);return s.makeHandle(()=>{t.remove(),this._removeHighlightIds(e)})}return y.emptyHighlightHandle}maskOccludee(e){return this.graphicsPipeline.maskOccludee(e)}getSuspendInfo(){return{...super.getSuspendInfo(),...this.graphicsPipeline.suspendInfo}}isUpdating(){return!(!this.graphicsPipeline||this.graphicsPipeline.destroyed||!this.graphicsPipeline?.updating&&this.view?.basemapTerrain?.ready)}async _validateGeometryType(){switch(this.layer.geometryType){case"multipatch":case"multipoint":throw new i("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType})}}get performanceInfo(){return this.graphicsPipeline.performanceInfo}queryAttributeBins(){throw new Error("Not implemented")}queryAggregates(){throw new Error("Not implemented")}};return t.__decorate([l.property()],u.prototype,"graphicsPipeline",void 0),t.__decorate([l.property({readOnly:!0})],u.prototype,"dataUpdating",null),t.__decorate([l.property()],u.prototype,"highlightOptions",void 0),t.__decorate([l.property()],u.prototype,"suspended",void 0),t.__decorate([l.property({readOnly:!0})],u.prototype,"legendEnabled",null),t.__decorate([l.property({readOnly:!0})],u.prototype,"visibleAtCurrentScale",null),t.__decorate([l.property()],u.prototype,"updating",void 0),t.__decorate([l.property({readOnly:!0})],u.prototype,"updatePolicy",void 0),t.__decorate([l.property({type:Boolean})],u.prototype,"slicePlaneEnabled",void 0),t.__decorate([l.property({readOnly:!0})],u.prototype,"suspendInfo",void 0),t.__decorate([l.property()],u.prototype,"symbologySnappingSupported",null),t.__decorate([l.property({readOnly:!0})],u.prototype,"hasAllFeatures",null),t.__decorate([l.property({readOnly:!0})],u.prototype,"hasAllFeaturesInView",null),t.__decorate([l.property({readOnly:!0})],u.prototype,"hasFullGeometries",null),t.__decorate([l.property({readOnly:!0})],u.prototype,"timeExtent",null),u=t.__decorate([d.subclass("esri.views.3d.layers.FeatureLikeLayerView3D")],u),u},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/timeSupport":function(){define(["exports","../../support/timeUtils"],function(e,t){"use strict";e.combineTimeExtent=function(e,r,i){if(null==e?.timeInfo)return null;const{datesInUnknownTimezone:s=!1,timeOffset:n,useViewTime:o}=e;let a=e.timeExtent;s&&(a=t.toLocalTimeExtent(a));let l=o?r&&a?r.intersection(a):r||a:a;return!l||l.isEmpty||l.isAllTime?l:(n&&(l=l.offset(-n.value,n.unit)),s&&(l=t.toUTCTimeExtent(l)),l.equals(i)?i:l)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/support/timeUtils":function(){define(["exports","../core/arrayUtils","../core/lang","../core/timeUtils","../chunks/TimeExtent","../webmap/utils","../webscene/utils"],function(e,t,r,i,s,n,o){"use strict";function a(e){return void 0!==e.timeInfo}async function l(e,r){if(0===e.length)return s.TimeExtent.allTime;await Promise.all(e.map(e=>e.load({signal:r})));const i=e.filter(a),n=e.filter(e=>!a(e)&&null!=e.visibilityTimeExtent);if(0===i.length&&0===n.length)return s.TimeExtent.allTime;const o=[],l=[];for(const e of i)"feature"!==e?.type&&"map-image"!==e?.type||!e.timeInfo?.hasLiveData?l.push(e):o.push(e);const c=e=>null==e||e.isAllTime,u=[...l.map(e=>{const t=e.timeInfo?.fullTimeExtent,{visibilityTimeExtent:r}=e;return t?.intersection(r)??r}),...n.map(e=>e.visibilityTimeExtent)];if(u.some(c))return s.TimeExtent.allTime;const d=o.map(async e=>{const t=(await e.fetchRecomputedExtents({signal:r}))?.timeExtent??e.timeInfo?.fullTimeExtent,{visibilityTimeExtent:i}=e;return t?.intersection(i)??i}),h=(await Promise.allSettled(d)).map(e=>"fulfilled"===e.status?e.value:null);if(h.some(c))return s.TimeExtent.allTime;const p=[...h,...u].filter(t.isSome);return 0===p.length?s.TimeExtent.allTime:p.reduce((e,t)=>e.union(t))}e.getTimeExtentFromLayers=l,e.getTimeSliderSettingsFromWebDocument=async function(e,t){if(!n.isWebMap(e)&&!o.isWebScene(e))return null;await e.load({signal:t});const i=e?.widgets?.timeSlider;if(!i)return null;const a=await async function(e,t){return e.widgets?.timeSlider?.fullTimeExtent??l(e.allLayers,t)}(e,t),c=i.loop,u=function(e){const t=e.numThumbs??2,r=e.currentTimeExtent;if(r){const{start:e,end:i}=r;return null!=e&&null!=i&&e.getTime()===i.getTime()?"instant":2===t?"time-window":null==e||0===e.getTime()?"cumulative-from-start":"cumulative-from-end"}return 2===t?"time-window":"cumulative-from-start"}(i),d=i.stopDelay??2e3,h=function(e){const{numStops:t,stopInterval:i,stops:s}=e;return s?{dates:r.clone(s)}:i?{interval:i.clone()}:{count:t??5}}(i),p=function(e,t){const r=e.currentTimeExtent;if(!r)return null;const{start:i,end:n}=r,o=i??n??null;switch(t){case"time-window":return new s.TimeExtent({start:i,end:n});case"cumulative-from-start":return new s.TimeExtent({start:null,end:o});case"cumulative-from-end":return new s.TimeExtent({start:o,end:null});case"instant":return new s.TimeExtent({start:o,end:o})}}(i,u);return{fullTimeExtent:a,loop:c,mode:u,playRate:d,stops:h,timeExtent:p}},e.toLocalTimeExtent=function(e){if(!e)return e;const{start:t,end:r}=e;return new s.TimeExtent({start:null!=t?i.offsetDate(t,t.getTimezoneOffset(),"minutes"):t,end:null!=r?i.offsetDate(r,r.getTimezoneOffset(),"minutes"):r})},e.toUTCTimeExtent=function(e){if(!e)return e;const{start:t,end:r}=e;return new s.TimeExtent({start:null!=t?i.offsetDate(t,-t.getTimezoneOffset(),"minutes"):t,end:null!=r?i.offsetDate(r,-r.getTimezoneOffset(),"minutes"):r})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/webmap/utils":function(){define(["exports","./Version"],function(e,t){"use strict";const r=new t.Version(2,34);e.currentVersion=r,e.isWebMap=function(e){return null!=e&&"object"==typeof e&&"declaredClass"in e&&"esri.WebMap"===e.declaredClass},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/webmap/Version":function(){define(["exports","../core/Version"],function(e,t){"use strict";class r extends t.Version{constructor(e,t){super(e,t,"webmap")}}e.Version=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/webscene/utils":function(){define(["exports","../support/tagSymbols"],function(e,t){"use strict";e.isWebScene=function(e){return null!=e&&"object"==typeof e&&t.WebSceneTag in e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/attributeUtils":function(){define(["exports"],function(e){"use strict";e.attributeLookup=function(e,t,r){if(!r||null==t)return null;if(!e)return function(e,t){const r=t.toLowerCase();for(const t in e)if(t.toLowerCase()===r)return e[t];return null}(t,r);const i=e.get(r);return i?t[i.name]:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/highlightUtils":function(){define(["exports","../../../../core/Collection","../../../../core/handleUtils","../../../../support/guards"],function(e,t,r,i){"use strict";function s(e){return"number"==typeof e||"string"==typeof e}const n=[],o=r.makeHandle();e.emptyHighlightHandle=o,e.isObjectId=s,e.normalizeHighlightTarget=function(e){return t.isCollection(e)?e.toArray():Array.isArray(e)?e:s(e)||i.isGraphic(e)||"esri.views.3d.layers.i3s.PointCloudGraphic"===e.declaredClass?[e]:n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/highlightOptionsUtils":function(){define(["exports","../../core/Collection","./HighlightDefaults","./HighlightOptions"],function(e,t,r,i){"use strict";e.createInitialHighlightOptions=function(){return new t([new i({name:r.defaultHighlightName}),new i({name:r.temporaryHighlightName,color:r.temporaryHighlightColor})])},e.getHighlightName=function(e){return e?.name??r.defaultHighlightName},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/FeatureGraphics3DGraphicsPipeline":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/hydratedFeatures","../../../../layers/graphics/controllers/FeatureTileController3D","../FeatureLayerViewPerformanceInfo","./Graphics3DGraphicsPipeline","../support/FeatureTileFetcher3DContext","../../support/EventedSet"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";e.FeatureGraphics3DGraphicsPipeline=class extends h.Graphics3DGraphicsPipeline{constructor(e){super(e),this._controllerTotal=0,this._processorTotal=0,this._needsRefresh=!1,this.suspendResumeExtentMode="data"}initialize(){this.addHandles(i.watch(()=>({controller:this.controller,suspended:this.suspended}),({controller:e,suspended:t})=>{e&&!t&&this._needsRefresh&&(e.refetch(),this._needsRefresh=!1)}))}destroy(){this._fetcherContext=r.destroyMaybe(this._fetcherContext)}get maximumNumberOfFeatures(){return this.controller?.maximumNumberOfFeatures??this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(e){this._set("maximumNumberOfFeatures",e),this.controller&&(this.controller.maximumNumberOfFeatures=e)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){let e=0;if(this.controller?.updating){const t=this.controller.updatingRemaining,r=Math.max(this.controller.updatingTotal,this._controllerTotal);r>0&&(e=(r-t)/r,this._controllerTotal=r)}let t=0;if(this.processor?.updating){const e=this.processor.updatingRemaining,r=Math.max(e,this._processorTotal);r>0&&(t=(r-e)/r,this._processorTotal=r)}return.5*(e+t)}get updatePolicy(){if(!this.controller)return 0;switch(this.controller.mode){case"snapshot":{const e=m.get(this.layer.geometryType);return null==e||this.controller.serviceDataCount>e?0:1}case"tiles":return 0}}get usedMemory(){return(this.processor?.usedMemory??0)+(this.controller?.memoryForUnusedFeatures??0)}get unloadedMemory(){const e=this.processor?.unprocessedMemoryEstimate??0,t=this.controller?.expectedFeatureDiff??0,r=this.processor?.loadedFeatures??0,i=r+t>0?r/(r+t):1;return e+t*(this.processor?.usedMemoryPerFeature??0)*i}get ignoresMemoryFactor(){return this.controller?.hasMaximumNumberOfFeaturesOverride}get performanceInfo(){const e=this.controller?.displayFeatureLimit,t=null!=e?e.averageSymbolComplexity:void 0,r=null!=t?`f:${t.verticesPerFeature},v:${t.verticesPerCoordinate}`:"n/a";return new d.FeatureLayerViewPerformanceInfo(super.performanceInfo,this.controller?.performanceInfo?.storedFeatures??0,this.controller?.performanceInfo?.totalVertices??0,this.maximumNumberOfFeaturesExceeded,this.controller?.mode??"n/a",r)}async doRefresh(e){const{controller:t,processor:r,suspended:i}=this;e&&t&&(i?this._needsRefresh=!0:(t.refetch(),this._needsRefresh=!1)),r.refreshFilter()}setVisibility(e,t){this.processor?.setObjectIdVisibility(e,t)}getMissingAttributesForFeature(e){return this.controller.getMissingAttributesForFeature(e)}getHydratedGeometry(e){const t=this.graphics3DProcessor;if(null==t)return null;const r=t.graphics3DGraphicsByObjectID;if(null==r)return null;const i=r.get(e);return null==i?null:c.hydrateGeometry(i.graphic.geometry)}createController(){this._fetcherContext=new p.FeatureTileFetcher3DContext({layerView:this.layerView,returnZ:this.hasZ,returnM:this.hasM});const e=new u.FeatureTileController3D({layerView:this.layerView,context:this._fetcherContext,graphics:new f.EventedSet,extent:this.clippingExtent});return this.updatingHandles.add(()=>e.serviceDataExtent,e=>{this.processor&&(this.processor.dataExtent=e)},i.initial),this.addHandles(i.watch(()=>this.suspended&&this.layerView.updateSuspended,t=>{t?e.suspend():e.resume()},i.syncAndInitial)),this.updatingHandles.add(()=>this.processor?.displayFeatureLimit,t=>e.displayFeatureLimit=t,i.initial),this.addHandles(i.when(()=>!this.updating,()=>{this._controllerTotal=0,this._processorTotal=0})),e}beforeSetController(e){e.maximumNumberOfFeatures=this.maximumNumberOfFeatures}get test(){return{controller:this.controller,graphics3DProcessor:this.graphics3DProcessor,heatmapProcessor:this.heatmapProcessor,loadedGraphics:this.loadedGraphics}}},t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"layerView",void 0),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"controller",void 0),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"_controllerTotal",void 0),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"_processorTotal",void 0),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"_needsRefresh",void 0),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"maximumNumberOfFeatures",null),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"maximumNumberOfFeaturesExceeded",null),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"updatingProgressValue",null),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"updatePolicy",null),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"suspendResumeExtentMode",void 0),e.FeatureGraphics3DGraphicsPipeline=t.__decorate([l.subclass("esri.views.3d.layers.graphics.FeatureGraphics3DGraphicsPipeline")],e.FeatureGraphics3DGraphicsPipeline);const m=new Map([["point",5e3],["polygon",500],["polyline",1e3]]);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/controllers/FeatureTileController3D":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/asyncUtils","../../../core/Collection","../../../core/has","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/sql","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/support/UpdatingHandles","../../../geometry/projectionUtils","../../support/arcgisLayerUrl","../../support/featureLayerUtils","../../support/layerUtils","../../../rest/support/StatisticDefinition","../../../views/3d/layers/support/FeatureTileDescriptor","../../../views/3d/layers/support/FeatureTileFetcher3D","../../../views/3d/layers/support/FeatureTileFetcher3DDebugger","../../../views/3d/support/debugFlags"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C){"use strict";e.FeatureTileController3D=class extends(u.EsriPromiseMixin(r)){get dataUpdating(){return this._tileFetcher?.dataUpdating??!1}set extent(e){if(null!=e&&!e.spatialReference.equals(this.layerView.view.spatialReference))return void l.getLogger(this).error("#extent=","extent needs to be in the same spatial reference as the view");const t=this._get("extent");if(t===e)return;if(null!=t&&e&&t.equals(e))return;const r=null!=e?e.clone():null;this._set("extent",r)}get updating(){return!!(this._tileFetcher?.updating||null!=this._fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles?.updating||this._updatingHandles?.updating)}get updatingTotal(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return null!=this._tileFetcher?this._tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(null==this._tileFetcher||!this._tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){return this.displayFeatureLimit?.maximumNumberOfFeatures??0}set maximumNumberOfFeatures(e){e!==this.maximumNumberOfFeatures&&this._overrideIfSome("maximumNumberOfFeatures",e)}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get hasAllFeatures(){return this.serviceDataCount===O.noServiceDataCount&&"snapshot"===this.mode&&this.hasAllFeaturesInView||this.serviceDataCount===this.graphics.length}get hasAllFeaturesInView(){const e=this.context.effectiveDisplayFilter?.where||null,t=null!=e&&"1=1"!==e;return("tiles"!==this.mode||!t)&&(this._tileFetcher?.showsAllFeatures??!1)}get hasFullGeometries(){return this._tileFetcher?.hasFullGeometries??!1}get mode(){const e=this.layerView.layer;if("feature"===e.type&&null!=e.infoFor3D)return"snapshot";if("catalog-footprint"===e.type)return"tiles";if(this._forceTilesMode)return"tiles";const t=this.layerView.view;if(!1===t.qualitySettings?.graphics3D?.snapshotAvailable||this.serviceDataCount===O.noServiceDataCount||this._snapshotLimitExceeded||this.maximumNumberOfFeaturesExceeded||t.quality<1)return"tiles";const r=t&&t.featureTiles,i=r?.tilingScheme;if(e&&e.minScale&&this.serviceDataExtent&&i){const t=this._approximateExtentSizeAtScale(e.minScale,i);if((this.serviceDataExtent.width/t+this.serviceDataExtent.height/t)/2>O.maxSnapshotMinScaleFactor)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){const e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&this._tileFetcher?.totalVertices||0;return Math.max(e,t)}_approximateExtentSizeAtScale(e,t){const r=this.layerView.view,i=Math.ceil((r.width/t.pixelSize+r.height/t.pixelSize)/2),s=t.levels[0];return i*((s.tileSize[0]/(s.scale/e)+s.tileSize[1]/(s.scale/e))/2)}get tileDescriptors(){if("snapshot"===this.mode){const e=new x.FeatureTileDescriptor(0,0,0,null,x.virtualSnapshotTileId);return new s([e])}const e=this.layerView.view.featureTiles;if(!e)return new s;const t=e.tiles;if(this.layerView.displayFilterEnabled&&null!=this.layerView.effectiveDisplayFilterClause&&"1=1"!==this.layerView.effectiveDisplayFilterClause){const e=new x.FeatureTileDescriptor(0,0,0,this.layerView.view.featureTiles?.tilingScheme,x.virtualDisplayFilterHighlightTileId);return new s([...t,e])}return t}get test(){}constructor(e){super(e),this.type="feature-tile-3d",this._updatingHandles=new g.UpdatingHandles,this.serviceDataExtent=null,this.serviceDataCount=O.noServiceDataCount,this._snapshotLimitExceeded=!1,this.displayFeatureLimit=null,this._forceTilesMode=!1,this._suspended=!1,this._tileFetcher=null,this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null,this._lifeCycleAbortController=new AbortController}initialize(){this._updatingHandles.add(()=>this.displayFeatureLimit,e=>this._updatingHandles.addPromise(this._updateSnapshotLimit(e,null,this._lifeCycleAbortController.signal))),this._updatingHandles.add(()=>this.mode,()=>this._modeChanged(),h.initial),this._updatingHandles.add(()=>this.mode,(e,t)=>{"tiles"===e&&"snapshot"===t&&(this._forceTilesMode=!0)},h.initial),this.addResolvingPromise(Promise.resolve().then(()=>this._verifyCapabilities()).then(()=>this._updatingHandles.addPromise(this._fetchServiceDataInfo())).then(()=>this._initializeTileFetcher()))}_verifyCapabilities(){const e=this.layerView.layer;if("ogc-feature"!==e.type&&!v.getEffectiveLayerCapabilities(e)?.operations.supportsQuery)throw new o("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})}destroy(){this._cancelFetchServiceDataInfo(),this._tileFetcher=c.destroyMaybe(this._tileFetcher),this._tilesHandle=c.removeMaybe(this._tilesHandle),this._lifeCycleAbortController=c.abortMaybe(this._lifeCycleAbortController),this._updatingHandles.destroy(),this._set("_updatingHandles",null)}suspend(){this._suspended||(this._suspended=!0,null!=this._tileFetcher&&this._tileFetcher.suspend())}resume(){this._suspended&&(this._suspended=!1,null!=this._tileFetcher&&this._tileFetcher.resume())}restart(){const e=()=>{null!=this._tileFetcher&&this._tileFetcher.restart()};this._updatingHandles.addPromise(this._fetchServiceDataInfo().then(e,e))}refetch(){this._refetch({resetForceTilesMode:!1})}getMissingAttributesForFeature(e){return this._tileFetcher?.getMissingAttributesForFeature(e)}_refetch(e){const t=()=>{null!=this._tileFetcher&&(e.resetForceTilesMode&&(this._forceTilesMode=!1),this._tileFetcher.refetch())};this._updatingHandles.addPromise(this._fetchServiceDataInfo().then(t,t))}_initializeTileFetcher(){const e=this.layerView.view;if(!e)return;const{layerView:t,tileDescriptors:r}=this,i=t.layer,s=new S.FeatureTileFetcher3D({context:this.context,filterExtent:this.extent,tileDescriptors:r,features:this.graphics});this._tileFetcher=s,this._suspended?s.suspend():s.resume(),e&&this.addHandles(h.watch(()=>e.quality,e=>s.memoryFactor=e,h.syncAndInitial));const n="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;n&&this.addHandles(h.watch(()=>this.layerView.view?.qualitySettings?.graphics3D?.[n],e=>s.lodFactor=e||1,h.initial)),"ogc-feature"!==i.type&&this._updatingHandles.add(()=>i.createQueryVersion,()=>this._dataFilterChanged()),this._updatingHandles.add(()=>this.layerView.effectiveDisplayFilter,()=>this._effectiveDisplayFilterChanged()),this._updatingHandles.add(()=>this.layerView.highlightIds,()=>this._displayFilterHighlightIdsChanged()),this._updatingHandles.add(()=>t.availableFields,(e,t)=>this._availableFieldsChanged(t,e)),this._updatingHandles.add(()=>t.requiredFields,(e,t)=>this._requiredFieldsChanged(t,e)),"customParameters"in i&&this._updatingHandles.add(()=>i.customParameters,()=>this.restart()),this.addHandles([i.on("apply-edits",e=>this._applyEdits(e)),h.watch(()=>this.extent,e=>s.filterExtent=e,h.sync),h.watch(()=>this.tileDescriptors,e=>s.tileDescriptors=e,h.sync),h.watch(()=>this.maximumNumberOfFeatures,e=>{s.maximumNumberOfFeatures=e,s.useTileCount=this.serviceDataCount>e},h.syncAndInitial),h.watch(()=>this.serviceDataCount,e=>{s.useTileCount=e>this.maximumNumberOfFeatures},h.syncAndInitial),h.watch(()=>({featureTiles:e.featureTiles,show:C.debugFlags.FEATURE_TILE_FETCH_SHOW_TILES}),({show:t,featureTiles:r})=>{t&&s&&r?s.debugger??=new T.FeatureTileFetcher3DDebugger(s,r.tilingScheme.toTileInfo(),e):s.debugger=c.destroyMaybe(s.debugger)},h.initial)]),this._supportsExceedsLimitQuery||this._updatingHandles.add(()=>this.maxTotalSnapshotVertices,()=>this._updatingHandles.addPromise(this._updateSnapshotLimit(this.displayFeatureLimit,null,this._lifeCycleAbortController.signal)))}_modeChanged(){switch(this.mode){case"tiles":this._tilesHandle||(this._tilesHandle=this.layerView.view.enableFeatureTiles());break;default:l.getLogger(this).warn("Unhandled feature layer mode "+this.mode);case"snapshot":null!=this._tilesHandle&&(this._tilesHandle.remove(),this._tilesHandle=null)}}_dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this._refetch({resetForceTilesMode:!0})}_effectiveDisplayFilterChanged(){"snapshot"!==this.mode&&this._refetch({resetForceTilesMode:!1})}_displayFilterHighlightIdsChanged(){"snapshot"!==this.mode&&null!=this._tileFetcher&&this._tileFetcher.refetchDisplayFilterHighlightTile()}_applyEdits(e){const t=this.layerView.layer;null!=this._tileFetcher&&this._tileFetcher.applyEdits(e).then(e=>{if(e){if(!this._lifeCycleAbortController)throw d.createAbortError();e.exceededTransferLimit&&"refresh"in t?t.refresh():(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&this._updatingHandles.addPromise(this._updateServiceDataExtent(this._lifeCycleAbortController.signal))}}).catch(e=>{if(!d.isAbortError(e))throw e})}_availableFieldsChanged(e,t){null!=this._tileFetcher&&R(this._tileFetcher.availableFields,t)&&this._refetch({resetForceTilesMode:!1})}_requiredFieldsChanged(e,t){null!=this._tileFetcher&&R(this._tileFetcher.availableFields,t)&&this.restart()}_createVertexLimitExceededQuery(e){const t=this.layerView.layer,r=t.createQuery();return r.returnGeometry=!1,r.outStatistics=[new w({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities?.query.supportsCacheHint&&(r.cacheHint=!0),r}_createDataInfoQuery(){const e=this.layerView.layer,t=this.layerView,r=e.createQuery();return r.returnGeometry=!1,r.outSpatialReference=this.layerView.view.spatialReference,e.capabilities?.query.supportsCacheHint&&(r.cacheHint=!0),t.effectiveDisplayFilter&&(r.where=p.sqlAnd(r.where,t.effectiveDisplayFilter.where)),r}_fullExtentIsAccurate(){const e=this.layerView.layer;if("definitionExpression"in e&&e.definitionExpression)return!1;switch(e.type){case"feature":case"catalog-footprint":case"oriented-imagery":return _.isHostedAgolService(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}async _updateServiceDataExtent(e){try{await this._tryUpdateServiceDataExtent(e)}catch(e){d.isAbortError(e)||this._set("serviceDataExtent",a.clone(this.layerView.fullExtentInLocalViewSpatialReference)??null)}}async _tryUpdateServiceDataExtent(e){const t=this.layerView,r=t.layer,i=r.capabilities?.query.supportsExtent??!1,s=a.clone(t.fullExtentInLocalViewSpatialReference),n=r.fullExtent,o=this._fullExtentIsAccurate(),l=this.serviceDataCount;if(i&&l<=O.maxFeatureCountForExtent&&(!s||!o)&&"queryExtent"in r){const t=this._createDataInfoQuery(),i=await r.queryExtent(t,{timeout:O.queryExtentTimeout,signal:e});this._set("serviceDataExtent",i.extent)}else if(s)this._set("serviceDataExtent",s);else if(null!=n){const e=n.spatialReference?await y.projectWithZConversion(n,t.view.spatialReference):null;this._set("serviceDataExtent",e??null)}else this._set("serviceDataExtent",null)}async _updateServiceDataCount(e){const t=this.layerView.layer;if(!("queryFeatureCount"in t)||!n("featurelayer-snapshot-enabled"))return void this._set("serviceDataCount",O.noServiceDataCount);const r=await i.result(t.queryFeatureCount(this._createDataInfoQuery(),{timeout:O.queryStatisticsTimeout,signal:e}));if(!0===r.ok)this._set("serviceDataCount",r.value);else{if(d.isAbortError(r.error))throw r.error;this._set("serviceDataCount",O.noServiceDataCount)}}get _supportsExceedsLimitQuery(){const e=this.layerView.layer;return null!=e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}get _minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}async _updateSnapshotLimit(e,t,r){if(null==e?.averageSymbolComplexity)return void(this._snapshotLimitExceeded=!1);const{maximumTotalNumberOfVertices:s,averageSymbolComplexity:o}=e,{verticesPerFeature:a,verticesPerCoordinate:l}=o,c=a<=0,u=this._minimumNumberOfVerticesForGeometry>1;if(!c&&!u)return void(this._snapshotLimitExceeded=!1);0!==a&&null!=t&&await t;const h=Math.min(s,P),p=this.serviceDataCount,f=p!==O.noServiceDataCount;let m=f?Math.ceil((h-p*a)/(l||1)):Math.ceil(h/(l||1));if(u&&(m=Math.min(m,M)),f&&this._minimumNumberOfVerticesForGeometry*p>m)return void(this._snapshotLimitExceeded=!0);if(!this._supportsExceedsLimitQuery||!n("featurelayer-snapshot-enabled"))return void(this._snapshotLimitExceeded=this.maxTotalSnapshotVertices>m);const g=await i.result(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(m),{timeout:O.queryStatisticsTimeout,signal:r}));if(!1===g.ok){if(d.isAbortError(g.error))throw g.error;return void(this._snapshotLimitExceeded=!1)}const y=g.value.features[0];this._snapshotLimitExceeded=!!y?.attributes&&!!y.attributes.exceedslimit}async _fetchServiceDataInfo(){this._cancelFetchServiceDataInfo(),await b.checkServiceCurrentUserSupport(this.layerView.layer);let e=new AbortController;const t=e.signal,r=this._updateServiceDataCount(t),i=Promise.allSettled([r,this._updateSnapshotLimit(this.displayFeatureLimit,r,t)]),s=i.then(()=>this._updateServiceDataExtent(t)).catch(e=>{d.isAbortError(e)||l.getLogger(this).error("#fetchServiceDataInfo()",e)}).then(()=>{s===this._fetchDataInfoPromise&&(this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null),e=null});return e&&(this._fetchDataInfoPromise=s),this._fetchDataInfoAbortController=e,i.then(()=>{},()=>{})}_cancelFetchServiceDataInfo(){const e=this._fetchDataInfoAbortController;e&&(this._fetchDataInfoAbortController=null,this._fetchDataInfoPromise=null,e.abort())}get performanceInfo(){return{storedFeatures:this._tileFetcher?.storedFeatures??0,totalFeatures:this._tileFetcher?.totalFeatures??0,totalVertices:this._tileFetcher?.totalVertices??0,missingTiles:this._tileFetcher?.missingTiles??0}}},t.__decorate([f.property({readOnly:!0})],e.FeatureTileController3D.prototype,"type",void 0),t.__decorate([f.property({constructOnly:!0})],e.FeatureTileController3D.prototype,"graphics",void 0),t.__decorate([f.property({constructOnly:!0})],e.FeatureTileController3D.prototype,"layerView",void 0),t.__decorate([f.property({constructOnly:!0})],e.FeatureTileController3D.prototype,"context",void 0),t.__decorate([f.property({readOnly:!0})],e.FeatureTileController3D.prototype,"dataUpdating",null),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"extent",null),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"updating",null),t.__decorate([f.property({readOnly:!0})],e.FeatureTileController3D.prototype,"_updatingHandles",void 0),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"updatingTotal",null),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"updatingRemaining",null),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"expectedFeatureDiff",null),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"memoryForUnusedFeatures",null),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"maximumNumberOfFeaturesExceeded",null),t.__decorate([f.property({readOnly:!0})],e.FeatureTileController3D.prototype,"serviceDataExtent",void 0),t.__decorate([f.property({readOnly:!0})],e.FeatureTileController3D.prototype,"serviceDataCount",void 0),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"_snapshotLimitExceeded",void 0),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"displayFeatureLimit",void 0),t.__decorate([f.property({type:Number})],e.FeatureTileController3D.prototype,"maximumNumberOfFeatures",null),t.__decorate([f.property({readOnly:!0})],e.FeatureTileController3D.prototype,"hasAllFeatures",null),t.__decorate([f.property({readOnly:!0})],e.FeatureTileController3D.prototype,"hasAllFeaturesInView",null),t.__decorate([f.property({readOnly:!0})],e.FeatureTileController3D.prototype,"hasFullGeometries",null),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"_forceTilesMode",void 0),t.__decorate([f.property({readOnly:!0})],e.FeatureTileController3D.prototype,"mode",null),t.__decorate([f.property({readOnly:!0})],e.FeatureTileController3D.prototype,"maxTotalSnapshotVertices",null),t.__decorate([f.property({readOnly:!0})],e.FeatureTileController3D.prototype,"tileDescriptors",null),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"_tileFetcher",void 0),t.__decorate([f.property()],e.FeatureTileController3D.prototype,"_fetchDataInfoPromise",void 0),e.FeatureTileController3D=t.__decorate([m.subclass("esri.layers.graphics.controllers.FeatureTileController3D")],e.FeatureTileController3D);const P=1e6,M=5e6;function R(e,t){if(!t)return!1;for(const r of t)if(!e.has(r))return!0;return!1}class O{static{this.noServiceDataCount=1/0}static{this.maxSnapshotMinScaleFactor=5}static reset(){O.maxFeatureCountForExtent=1e4,O.queryStatisticsTimeout=12e3,O.queryExtentTimeout=1e4}}O.reset(),e.FeatureTileController3DConstants=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/FeatureTileDescriptor":function(){define(["exports","../../../../geometry/ellipsoidUtils","../../../../geometry/support/aaBoundingRect"],function(e,t,r){"use strict";class i{constructor(e,t,i,o,a=n(e,t,i)){this._tilingScheme=o,this.id=a,this.lij=[0,0,0],this.extent=null,this.measures=new s,this.loadPriority=0,this.used=!1,this.lij[0]=this.measures.lodLevel=e,this.lij[1]=t,this.lij[2]=i,o&&(this.extent=r.create(),o?.getExtent(e,t,i,this.extent))}get planetRadius(){return t.getReferenceEllipsoid(this.spatialReference).radius}get spatialReference(){return this._tilingScheme?.spatialReference}get resolution(){return this._tilingScheme?.resolutionAtLevel(this.measures.lodLevel)??0}get level(){return this.lij[0]}get lodLevelDelta(){return this.measures.lodLevel-this.level}createChildren(){const e=this.lij[0]+1,t=2*this.lij[1],r=2*this.lij[2];return[new i(e,t,r,this._tilingScheme),new i(e,t+1,r,this._tilingScheme),new i(e,t,r+1,this._tilingScheme),new i(e,t+1,r+1,this._tilingScheme)]}}class s{constructor(){this.visible=!0,this.distance=0,this.lodLevel=0,this.splitPriority=0,this.mergeable=!0}}function n(e,t,r){return`${e}/${t}/${r}`}e.FeatureTileDescriptor=i,e.getFeatureTileId=n,e.virtualDisplayFilterHighlightTileId="virtual-display-filter-highlight-tile",e.virtualSnapshotTileId="virtual-snapshot-tile",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/FeatureTileFetcher3D":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/has","../../../../core/Logger","../../../../core/MapUtils","../../../../core/promiseUtils","../../../../core/ReactiveMap","../../../../core/reactiveUtils","../../../../core/scheduling","../../../../core/signal","../../../../core/sql","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/common","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../../../../rest/support/QuantizationParameters","../../../../rest/support/Query","./featureReference","./FeatureTile","./FeatureTileDescriptor","../../terrain/tileUtils","../../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T){"use strict";function C(e){return e.id===x.virtualSnapshotTileId}function P(e){return e.id===x.virtualDisplayFilterHighlightTileId}function M(e){return C(e)||P(e)}function R(e){return null==e?new Set:new Set(e.map(e=>e.name))}function O(e,t){if(null==e||null==t)return R(t);const r=new Set;for(const{name:i}of t)e.has(i)&&r.add(i);return r}function I(e,t){if(!t?.length)return e;e??=new Map;const r=()=>new Set;for(const{objectId:i,attribute:s}of t)o.getOrCreateMapValue(e,i,r).add(s);return e}e.FeatureTileFetcher3D=class extends r{set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set("lodFactor",e),this._supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&null!=this.context.query.queryFeatureCount}set useTileCount(e){this._useTileCount=e,this.notifyChange("useTileCount")}get updating(){return this._dirty||!!this._pendingEdits||this._isFetching||(this.tileDescriptors?.updating??!1)}get readyToRun(){return this._dirty}get memoryForUnusedFeatures(){let e=0;return this._featureTiles.forEach(t=>e+=t.estimatedUnusedSize),e}get totalVertices(){let e=0;return this._featureTiles.forEach(t=>e+=t.numVertices),e}get totalFeatures(){let e=0;return this._featureTiles.forEach(t=>e+=t.numFeatures),e}get showsAllFeatures(){if(this._paused||this.dataUpdating)return!1;for(const e of this._featureTiles.values())if(!this.hasFullGeometries&&0!==e.emptyFeatureRatio||!e.showsAllFeatures)return!1;return!0}get hasFullGeometries(){if(!this._supportsResolution)return!0;const e=this.tileDescriptors?.some(C);return e||!this.context.capabilities.supportsQuantization&&"polyline"!==this.context.geometryType}set filterExtent(e){if(null!=e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void n.getLogger(this).error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const r=null!=e?e.clone():null;this._set("filterExtent",r),this._reclip(r,t)}_updateTileZQuantization(e){if(1===this.context.viewingMode){const t=e.computeZQuantizationFactor();this._zQuantizationFactor.value<t&&(this._zQuantizationFactor.value=t)}}get _tileZQuantization(){return this.context.isDraped?1:this._zQuantizationFactor.value}constructor(e){super(e),this._useTileCount=!1,this.dataUpdating=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this._fullRatio=1,this._farRatio=1,this._zQuantizationFactor=d.signal(1),this._changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this._featureTiles=new l,this._displayingFeatureReferences=new Map,this._numDisplayingFeatureReferences=0,this._dirty=!1,this._suspended=!0,this._pendingEdits=null,this._applyEditsTilesUpdated=!1,this._isFetching=!1;const t=e.context;this._frameTask=t.scheduler?.registerTask(T.TaskPriority.FEATURE_TILE_FETCHER,this)??T.ImmediateTask,this.FeatureReferenceClass=t.capabilities.supportsMultipleResolutions?v.MultiFeatureReference:v.SingleFeatureReference,this._objectIdField=t.objectIdField}initialize(){this.addHandles([c.on(()=>this.tileDescriptors,"change",()=>this._setDirty(),{onListenerAdd:()=>this._setDirty(),onListenerRemove:()=>this._setDirty()}),c.watch(()=>this._tileZQuantization,()=>this.refetch())]),this._setDirty()}destroy(){this._frameTask.remove(),this._featureTiles.forEach(e=>{this._cancelFetchTile(e),this._removeTile(e)}),this._featureTiles.clear(),this._displayingFeatureReferences.clear(),this._pendingEdits?.controller.abort(),this._pendingEdits=null}get _paused(){return this._suspended||!!this._pendingEdits}restart(){this._featureTiles.forEach(e=>{this._cancelFetchTile(e),this._clearTile(e),this._resetFetchTile(e)}),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this._featureTiles.forEach(e=>{this._cancelFetchTile(e),this._resetFetchTile(e)}),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}refetchDisplayFilterHighlightTile(){const e=this._featureTiles.get(x.virtualDisplayFilterHighlightTileId);e&&(this._cancelFetchTile(e),this._resetFetchTile(e),this._setDirty())}suspend(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())}resume(){this._suspended&&(this._suspended=!1,this._unpause())}getMissingAttributesForFeature(e){for(const t of this._featureTiles.values()){const r=t.missingAttributes?.get(e);if(null!=r)return r}}_pause(){this._paused&&(this._featureTiles.forEach(e=>this._cancelFetchTile(e)),this._updated())}_unpause(){this._paused||this._setDirty()}get availableFields(){let e=null;return this._featureTiles.forEach(t=>{null!=t.displayingFeatures&&0!==t.displayingFeatures.length&&(null==e?e=new Set(t.availableFields):e.forEach(r=>{t.availableFields?.has(r)||e.delete(r)}))}),null!=e?e:new Set}applyEdits(e){this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const t=this._pendingEdits;t.count++;const r=t.edits.then(()=>e.result.catch(e=>{if(a.isAbortError(e))throw e;return null}).then(e=>e?(this._applyEditsDeleteFeatures(e.deletedFeatures),this._applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,t.controller.signal).then(()=>e)):e).then(e=>(0===--t.count&&(this._pendingEdits===t&&(this._pendingEdits=null),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._applyEditsTilesUpdated=!1,this._unpause()),e)));return t.edits=r,this._updated(),r}_applyEditsDeleteFeatures(e){if(0===e.length)return;const t=this.context.globalIdField,r=t&&this.availableFields.has(t),i=new Set,s=this._objectIdField;e.forEach(({objectId:e,globalId:o})=>{(!e||e<0)&&t&&o&&(r||n.getLogger(this).errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`),e=this._objectIdFromGlobalId(o,s,t)),null!=e&&e>=0&&i.add(e)}),this._featureTiles.forEach(e=>{if(!e.features)return;const t=e.features.filter(e=>!i.has(y.getObjectId(e,this._objectIdField)));t.length!==e.features.length&&(this._applyEditsTileUpdated(),e.setFeatures(t,0,e.availableFields,e.missingAttributes),this._updateTileZQuantization(e),this._invalidateCounts())})}_objectIdFromGlobalId(e,t,r){if(null==e)return null;const i=this.features.find(t=>t.attributes?.[r]===e);return i?y.getObjectId(i,t):null}async _applyEditsAddUpdateFeatures(e,t,r){const{objectIdField:i,globalIdField:s}=this.context,o=s&&this.availableFields.has(s),a=new Set,l=new Set;for(const t of e){const e=t.objectId;null!=e&&a.add(e)}for(const{objectId:e,globalId:r}of t){let t=e;(null==t||t<0)&&s&&(o||n.getLogger(this).errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${s} to be included the layer's outFields for updates to be reflected in the view`),t=this._objectIdFromGlobalId(r,i,s)),null!=t&&t>=0&&(a.add(t),l.add(t))}if(0===a.size)return;const c=[];this._featureTiles.forEach(e=>{const t=this._applyEditsAddUpdateTile(e,a,l,r);c.push(t)}),this._updated(),await Promise.allSettled(c)}async _applyEditsAddUpdateTile(e,t,r,i){if(!e.features)return;e.fetchingResolution=e.descriptor.resolution;const s=this._createQuery(e);s.resultType=void 0,s.cacheHint=!1,s.objectIds=Array.from(t);const n=await this._queryFeatures(s,i);let o=null;if(r.size>0){const t=e.features.filter(e=>!r.has(y.getObjectId(e,this._objectIdField)));t.length!==e.features.length&&(o=t)}if(n.features.length>0){o||(o=e.features.slice());for(const e of n.features)o.push(e)}o&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,o.length)),this._applyEditsTileUpdated(),e.setFeatures(o,0,O(e.availableFields,n.fields),I(e.missingAttributes,n.missingAttributes)),this._updateTileZQuantization(e),this._invalidateCounts())}_applyEditsTileUpdated(){this._applyEditsTilesUpdated||(this._applyEditsTilesUpdated=!0,this._updated())}_queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:L})}_setDirty(){this._dirty=!0,this._updated()}runTask(e){const t=this._frameTask.processQueue(e);if(!this._dirty||!this.initialized)return t;this._dirty=!1;const r=this._featureTilesArray;if(this._markTilesNotAlive(r),!e.run(()=>this._addTiles(r,e))||!e.run(()=>this._filterExtentTiles(r,e))||!e.run(()=>this._removeTiles(r,e))||e.done)return void this._setDirty();const i=this._sortTiles(r);e.run(()=>this._showTiles(i,e))&&e.run(()=>this._fetchTiles(i,e))&&e.run(()=>this._updateMemoryEstimates(i,e))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(e){for(const t of e)t.alive=!1}_addTiles(e,t){return!(this._suspended||!this.tileDescriptors)&&(this.tileDescriptors.forEach(r=>{const i=this._featureTiles.get(r.id);i?i.alive=!0:t.done||(e.push(this._addTile(r)),t.madeProgress())}),t.hasProgressed)}_filterExtentTiles(e,t){for(const r of e){if(t.done)break;r.alive&&(r.filtered=!r.intersects(this.filterExtent),r.filtered&&(this._clearTile(r),t.madeProgress()))}return t.hasProgressed}_removeTiles(e,t){for(let r=e.length-1;r>=0&&!t.done;r--){const i=e[r];i.alive||(this._removeTile(i),r!==e.length-1&&(e[r]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}_sortTiles(e){return e.sort((e,t)=>e.descriptor.loadPriority-t.descriptor.loadPriority),e}_showTiles(e,t){const r=this._updateRatio(e),i=e=>{const t=this._fullRatio<1?r(e)*this._farRatio:1;e.reduceFeatures(t,this.memoryFactor,this._objectIdField,this._reduceMode)&&this._setDirty();const{numFeatures:i,fetchingResolution:s,descriptor:n,isFetched:o}=e;return this._supportsResolution&&i>0&&s!==n.resolution&&o&&(e.requestRefetch(),this._setDirty()),this._showTile(e)};for(const r of e)if(!t.run(()=>i(r))){this._setDirty();break}return t.hasProgressed}_fetchTiles(e,t){if(this._paused)return!1;let r=!1;for(const i of e){if(!i.needsFetch)continue;const e=null!=this.context.memoryCache?this.context.memoryCache.pop(i.id):null;if(e?.resolution!==i.displayingResolution){if(this._needsNumFeatures(i)){const e=new AbortController,s=this._fetchTileCount(i,e.signal);this._handleRequest(i,s,e,()=>i.resetFetching(),()=>i.numFeatures=w.failedFeatureCount),r=!0,t.madeProgress()}if(t.done)return!0}else i.cache=e,i.numFeatures&&this._notifyDataUpdating(),this._setDirty(),this._scheduleUpdated(),t.madeProgress()}if(r)return t.hasProgressed;for(const r of e){if(!r.needsFetch)continue;const e=new AbortController,i=this._fetchTile(r,e.signal);if(this._handleRequest(r,i,e,e=>r.fetchDone(e),e=>{r.fetchFailed=!0,this.context.logFetchError(n.getLogger(this),e)}),t.madeProgress(),t.done)return!0}return t.hasProgressed}_updateMemoryEstimates(e,t){return e.some(e=>!t.run(()=>e.updateMemoryEstimates())&&(this._setDirty(),!0)),t.hasProgressed}_reclip(e,t){if(!this.initialized)return;const r=new Array;this._featureTiles.forEach(i=>{null!=i.displayingFeatures&&0!==i.displayingFeatures.length&&(i.intersectionIncludingBorrowed(t,A),i.intersectionIncludingBorrowed(e,D),g.equals(A,D)||r.push(i))}),this._refreshDisplayingFeatures(r),this._updated()}_refreshDisplayingFeatures(e){const t=new Set,r=this._changes.updates;for(const i of e)if(null!=i.displayingFeatures)for(const e of i.displayingFeatures){const i=y.getObjectId(e,this._objectIdField);if(t.has(i))continue;t.add(i);const s=this._displayingFeatureReferences.get(i).feature;r.removes.push(s),r.adds.push(s)}this._applyChanges()}_updated(){let e=0;if(this._paused||this._featureTiles.forEach(t=>t.isFetching?++e:0),this._isFetching=e>0,e>0||this._applyEditsTilesUpdated?this._notifyDataUpdating():this._dirty||this._set("dataUpdating",!1),this.updating){let t=0,r=0,i=0,s=0,n=0;const o=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach(e=>{if(++r,e.isFetching&&e.hasPreciseFeatureCount){const t=this._maximumFeaturesForTile(e)*(1-e.emptyFeatureRatio),r=null!=e.displayingFeatures?e.displayingFeatures.length*o:0;n+=t-r}e.needsFetch?++s:e.numFeatures>0&&(++i,t+=e.numFeatures)}),s+=e;let a=0,l=0;t?(l=t,a=Math.min(s*t/i,t)):(l=r,a=s),n=Math.min(this.maximumNumberOfFeatures-this.features.length,n),this._set("updatingTotal",l),this._set("updatingRemaining",a),this._set("expectedFeatureDiff",n)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger?.update()}_updateMaximumNumberOfFeaturesExceeded(){for(const{perTileMaximumNumberOfFeaturesExceeded:e}of this._featureTiles.values())if(e)return void this._set("maximumNumberOfFeaturesExceeded",!0);this._set("maximumNumberOfFeaturesExceeded",!1)}_updateRatio(e){const t=function(e){let t=0;for(const r of e)r.features&&r.features.length>0&&r.alive&&(t=Math.max(t,r.descriptor.lij[0]));return t}(e),r=e=>1/(1<<Math.max(0,t-e.descriptor.lij[0]));let i=0,s=0;for(const t of e){const e=t.numFeatures;i+=e,s+=e*r(t)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/i),this._farRatio=this.maximumNumberOfFeatures/s,this._scheduleUpdated(),r}_maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this._featureTiles.forEach(e=>{if(!e.featuresMissing)return;const t=this._maximumFeaturesForTile(e);e.isFullyFetched(t)||(this._cancelFetchTile(e),this._resetFetchTile(e))}),this._setDirty())}_addTile(e){const t=new w.FeatureTile(e);return this._featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}_referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.displayingResolution;this._featureTiles.forEach(r=>{if(null!=r.displayingFeatures&&e!==r&&S.tilesAreRelated(e.descriptor.lij,r.descriptor.lij)){null==e.displayingFeatures&&(e.displayingFeatures=[]),e.descriptor.extent&&r.descriptor.extent&&(e.extentIncludingBorrowedFeatures??=g.clone(e.descriptor.extent),g.expand(e.extentIncludingBorrowedFeatures,r.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const i of r.displayingFeatures){e.displayingFeatures.push(i);const r=this._displayingFeatureReferences.get(y.getObjectId(i,this._objectIdField));r.ref(r.feature,t),this._numDisplayingFeatureReferences++}}})}_removeTile(e){this._clearTile(e),this._featureTiles.delete(e.id)}_resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetch&&e.fetchDone(4):e.requestFetch()}_cancelFetchTile(e){const t=e.requestController;null!=t&&(e.requestController=null,e.resetFetching(),t.abort())}async _fetchTileCount(e,t){e.numFeatures=await this._fetchCount(e,t),this._updateRatio(this._featureTilesArray)}async _fetchTile(e,t){e.fetchFailed=!1;const r=this._maximumFeaturesForTile(e);if(r<=0)return e.hasPreciseFeatureCount&&0===e.numFeatures||(e.fetchFailed=!0),function(e){e.setFeatures([],0,null,void 0)}(e),e.fetchInformation.value="Empty tile",4;const i=this._getMaxRecordCount(e),s=Math.ceil(r/i);if(e.fetchingResolution=e.descriptor.resolution,M(e)||!this.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=r&&s>b.MAX_MAX_RECORD_COUNT_FACTOR)return this._fetchPagedTile(e,t);const n=this._createQuery(e);if(n.maxRecordCountFactor=s,e.isRefetching&&e.features&&e.features.length>0){const t=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/i);n.maxRecordCountFactor=Math.max(t+1,n.maxRecordCountFactor)}e.fetchInformation.value=`Single fetch\n${r} features`;const{features:o,exceededTransferLimit:l,fields:c,missingAttributes:u}=await this._queryFeatures(n,t),d=l||n.maxRecordCountFactor>=b.MAX_MAX_RECORD_COUNT_FACTOR||r===this._totalFeaturesForTile(e)?5:4,h=await this._frameTask.schedule(()=>{e.exceededTransferLimit.value=!!l;const t=this._removeEmptyFeatures(o,this._getEffectiveTileResolution(e));return e.fetchInformation.value=`Single fetch\n${o.length}/${r} features`,e.setFeatures(o,t,R(c),I(void 0,u)),this._updateTileZQuantization(e),this._maximumFeaturesForTile(e)>r?1:d},t);return a.throwIfAborted(t),this._invalidateCounts(),h}async _fetchCount(e,t){return this.context.query.queryFeatureCount(this._createFeatureCountQuery(e),{signal:t})}async _fetchPagedTile(e,t){let r,i=0,s=0,n=0,o=this._maximumFeaturesForTile(e)-n;const l=this._getMaxRecordCount(e);let c,u=null;for(;;){const d=this._createQuery(e),h=this._setPagingParameters(d,i,o,l);e.fetchInformation.value=`Paged fetch\n${e.features?.length}/${o} features`;const{features:p,exceededTransferLimit:f,fields:m,missingAttributes:g}=await this._queryFeatures(d,t);if(await this._frameTask.schedule(()=>{h&&(i+=d.num),n+=p.length,s+=this._removeEmptyFeatures(p,this._getEffectiveTileResolution(e)),e.exceededTransferLimit.value=!!f,r=r?.concat(p)??p,u=O(u,m),c=I(c,g),e.setFeatures(r,s,u,c),this._updateTileZQuantization(e),this._invalidateCounts(),this._setDirty()},t),a.throwIfAborted(t),o=this._maximumFeaturesForTile(e)-(r?.length??0),!h||!f||o<=0)return f?4:5}}_createFeatureCountQuery(e){const t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}_createQuery(e){const t=this.context.createQuery();return t.resultType=this._resultType(e),!M(e)&&e.descriptor.extent&&this.context.tilingScheme&&(t.geometry=g.toExtent(e.descriptor.extent,this.context.tilingScheme.spatialReference)),this._setResolutionParams(t,e),"tile"!==t.resultType&&this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),P(e)&&this.context.highlightIds?.length?t.objectIds=this.context.highlightIds:!C(e)&&this.context.effectiveDisplayFilter&&(t.where=h.sqlAnd(t.where,this.context.effectiveDisplayFilter.where)),t}_setPagingParameters(e,t,r,i){return!!this.context.capabilities.supportsPagination&&(e.start=t,r>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(r/i),e.num=Math.min(e.maxRecordCountFactor*i,r)):e.num=Math.min(i),!0)}_getEffectiveTileResolution(e){if(M(e)||!this._supportsResolution)return null;const t=1===this.context.viewingMode&&this.context.tilingScheme?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.fetchingResolution,t)/this.lodFactor/this._tileZQuantization}get _supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}_setResolutionParams(e,t){const r=this._getEffectiveTileResolution(t);null!=r&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new _({mode:"view",originPosition:"upper-left",tolerance:r,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=r))}_removeEmptyFeatures(e,t){const r=e.length;if(t&&this._supportsResolution){const r=t*(1+m.getEpsilon());i.filterInPlace(e,({geometry:e})=>!(!e||!y.hasVertices(e))&&(y.computeAABR(e,E),g.width(E)>r||g.height(E)>r))}else i.filterInPlace(e,({geometry:e})=>y.hasVertices(e));return r-e.length}_needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!C(e)}_getMaxRecordCount(e){switch(this._resultType(e)){case"tile":if(this.context.tileMaxRecordCount)return this.context.tileMaxRecordCount;break;case"standard":if(this.context.standardMaxRecordCount)return this.context.standardMaxRecordCount}return this.context.maxRecordCount||F}_resultType(e){if(this.context.capabilities.supportsResultType)return C(e)?"standard":"tile"}get _reduceMode(){const e=this.context.geometryType;return"polygon"===e||"polyline"===e?0:1}_handleRequest(e,t,r,i,s){e.startFetch(),e.requestController=r;let n=!1;t.then(t=>{e.requestController=null,i(t)}).catch(t=>{e.requestController===r&&(e.requestController=null,e.fetchDone(4)),a.isAbortError(t)?n=!0:s(t)}).then(()=>{n||this._setDirty(),this._scheduleUpdated()})}_scheduleUpdated(){this.hasHandles("scheduleUpdated")||this.addHandles(u.schedule(()=>{this.removeHandles("scheduleUpdated"),this._updated()}),"scheduleUpdated")}_showTile(e){if(e.displayingFeatures&&!e.needsDisplayUpdate)return!1;const t=e.features;if(0===e.featureLimit||!t){const t=null!=e.displayingFeatures&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],t}const r=e.fetchingResolution,{adds:i,updates:s}=this._changes,n=Math.min(e.featureLimit,t.length);for(let e=0;e<n;++e){const n=t[e],o=y.getObjectId(n,this._objectIdField),a=this._displayingFeatureReferences.get(o);if(a){const{oldVersion:e,newVersion:t}=a.ref(n,r);e!==t&&(e&&s.removes.push(e),t&&s.adds.push(t))}else this._displayingFeatureReferences.set(o,new this.FeatureReferenceClass(n,r)),i.push(n);this._numDisplayingFeatureReferences++}return this._hideTileFeatures(e),e.displayingResolution=e.fetchingResolution,this._applyChanges(),e.displayingFeatures=t.slice(0,n),!0}_hideTile(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}_hideTileFeatures(e){if(null==e.displayingFeatures)return;const{updates:t,removes:r}=this._changes;for(const i of e.displayingFeatures){const s=y.getObjectId(i,this._objectIdField),n=this._displayingFeatureReferences.get(s);if(!n)continue;const{oldVersion:o,newVersion:a}=n.unref(e.displayingResolution);this._numDisplayingFeatureReferences--,o!==a&&(null==a?(this._displayingFeatureReferences.delete(s),o&&r.push(o)):(t.adds.push(a),o&&t.removes.push(o)))}this._applyChanges(),e.displayingFeatures=null}_notifyDataUpdating(){this._get("dataUpdating")||this._set("dataUpdating",!0)}_applyChanges(){const e=this._changes.updates;e.removes.length>0&&(this._notifyDataUpdating(),this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this._notifyDataUpdating(),this.features.addMany(e.adds),e.adds.length=0);const t=this._changes.adds,r=this._changes.removes,i=Math.min(t.length,r.length);let s=0;for(;s<i;){const e=Math.min(s+V,i);this._notifyDataUpdating(),this.features.addMany(t.slice(s,e)),this.features.removeMany(r.slice(s,e)),s=e}t.length>i&&(this._notifyDataUpdating(),this.features.addMany(0===s?t:t.slice(s))),r.length>i&&(this._notifyDataUpdating(),this.features.removeMany(0===s?r:r.slice(s))),t.length=0,r.length=0}_clearTile(e){this._hideTile(e),e.features&&null!=this.context.memoryCache&&this.context.memoryCache.put(e.id,e.cache),e.setFeatures(null,0,null,void 0),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}get _featureTilesArray(){return Array.from(this._featureTiles.values())}get featureTiles(){return this._featureTiles}get storedFeatures(){return this._featureTilesArray.reduce((e,t)=>e+(t.features?t.features.length:0),0)}get missingTiles(){return Array.from(this._featureTiles.values()).reduce((e,t)=>e+(t.needsFetch||t.isFetching?1:0),0)}_totalFeaturesForTile(e){return e.hasPreciseFeatureCount?e.numFeatures:this.maximumNumberOfFeatures}_maximumFeaturesForTile(e){const t=this._totalFeaturesForTile(e),r=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(t*r/(1-e.emptyFeatureRatio)),t)}get test(){}},t.__decorate([p.property({constructOnly:!0})],e.FeatureTileFetcher3D.prototype,"features",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"tileDescriptors",void 0),t.__decorate([p.property({value:1/0})],e.FeatureTileFetcher3D.prototype,"maximumNumberOfFeatures",null),t.__decorate([p.property({value:1})],e.FeatureTileFetcher3D.prototype,"memoryFactor",null),t.__decorate([p.property({value:1})],e.FeatureTileFetcher3D.prototype,"lodFactor",null),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"useTileCount",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"updating",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"dataUpdating",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"updatingTotal",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"updatingRemaining",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"expectedFeatureDiff",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"memoryForUnusedFeatures",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"maximumNumberOfFeaturesExceeded",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"totalVertices",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"totalFeatures",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"showsAllFeatures",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"hasFullGeometries",null),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"filterExtent",null),t.__decorate([p.property({constructOnly:!0})],e.FeatureTileFetcher3D.prototype,"context",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_dirty",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_suspended",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_pendingEdits",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_applyEditsTilesUpdated",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_paused",null),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_isFetching",void 0),e.FeatureTileFetcher3D=t.__decorate([f.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],e.FeatureTileFetcher3D);const F=2e3,A=g.create(),D=g.create(),E=g.create(),L=6e5,V=200;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/featureReference":function(){define(["exports","../../../../core/Error","../../../../core/has","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingBox","../../../../core/mathUtils","../../../../geometry/Extent","../../../../geometry/Geometry","../../../../geometry/Multipoint","../../../../geometry/Point","../../../../geometry/Polygon","../../../../geometry/Polyline","../../../../geometry/support/typeUtils","../../../../layers/support/Field","../../../../layers/graphics/dehydratedFeatureComparison"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";class m{constructor(e,t){this.feature=e,this.resolution=t,this.refCount=1}}const g={oldVersion:null,newVersion:null},y={oldVersion:null,newVersion:null};e.FeatureVersion=m,e.MultiFeatureReference=class{get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}constructor(e,t){this._highestResolutionVersion=null,this.versions=[],this.ref(e,t)}ref(e,t){const r=this.feature;y.oldVersion=r,r&&Object.defineProperty(e,"uid",{value:r.uid,configurable:!0});const i=this._highestResolutionVersion;for(const s of this.versions)if(s.resolution===t){s.refCount++;const t=i===s&&!f.equals(e,s.feature);return(t||i!==s)&&(s.feature=e),y.newVersion=t?e:r,y}const s=new m(e,t);return this.versions.push(s),!i||t<i.resolution?(y.newVersion=e,this._highestResolutionVersion=s):y.newVersion=r,y}unref(e){const{versions:r}=this;for(let t=0;t<r.length;t++){const i=r[t];if(i.resolution===e)return i.refCount--,g.oldVersion=this.feature,0===i.refCount&&(r[t]=r[r.length-1],--r.length,this._highestResolutionVersion===i&&(this._recalculateHighestResolutionVersion(),g.oldVersion=i.feature)),g.newVersion=this.feature,g}const i=`Unref feature with no references: ${this.feature?.uid}`;throw new t(i,i,(new Error).stack?.slice(6))}get feature(){return this._highestResolutionVersion?.feature??null}_recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this._highestResolutionVersion=null);let e=this.versions[0];for(let t=1;t<this.versions.length;t++){const r=this.versions[t];r.resolution<e.resolution&&(e=r)}this._highestResolutionVersion=e}},e.SingleFeatureReference=class{get isReferenced(){return 0!==this._refCount}get isSingle(){return 1===this._refCount}constructor(e){this._feature=e,this._refCount=1}ref(e){++this._refCount;const t=this._feature;return y.oldVersion=t,t&&Object.defineProperty(e,"uid",{value:t.uid,configurable:!0}),f.equals(t,e)||(this._feature=e),y.newVersion=this._feature,y}unref(){g.oldVersion=this._feature;const e=this._refCount;if(!(e>0)){const e=`Unref feature with no references: ${this.feature?.uid}`;throw new t(e,e,(new Error).stack?.slice(6))}return this._refCount=e-1,1===e?(g.newVersion=null,g):(g.newVersion=this._feature,g)}get feature(){return this._feature}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/FeatureTile":function(){define(["exports","../../../../core/arrayUtils","../../../../core/memoryEstimations","../../../../core/signal","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../graphics/graphicUtils"],function(e,t,r,i,s,n,o,a){"use strict";class l{constructor(e,t,i,s){this.features=t,this.numFeatures=i,this.emptyFeatureRatio=s,this.cachedMemory=r.baseObjectMemory+e.estimatedSize,this.resolution=e.displayingResolution,this.availableFields=e.availableFields,this.fetchStatus=e.fetchStatus,this.exceededTransferLimit=e.exceededTransferLimit.value,this.fetchInformation=e.fetchInformation.value}}const c=n.create(),u=s.create();e.FeatureTile=class{constructor(e){this.descriptor=e,this._numVertices=0,this.exceededTransferLimit=i.signal(!1),this._fetchFailed=i.signal(!1),this._sorted=!1,this._numFeatures=i.signal(-1),this._emptyFeatureRatio=i.signal(0),this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._displayingFeatures=null,this.alive=!0,this.filtered=!1,this._features=null,this._featuresLength=i.signal(0),this._featureLimit=i.signal(0),this._fetchStatus=0,this.fetchInformation=i.signal(""),this.fetchingResolution=this.displayingResolution=e.resolution}get featuresMissing(){return this.fetchFailed||(this.hasPreciseFeatureCount?this._featuresLength.value<this.numFeatures:this.exceededTransferLimit.value)}get showsAllFeatures(){return!this.fetchFailed&&null!=this.displayingFeatures&&(this.hasPreciseFeatureCount?this.displayingFeatures.length===this.numFeatures:!this.exceededTransferLimit.value)}get missingAttributes(){return this._missingAttributes}get fetchFailed(){return this._fetchFailed.value}set fetchFailed(e){this._fetchFailed.value=e}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(e){this._displayingFeatures=e,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){const e=this.isFetched&&this.featuresMissing;return!this.filtered&&(e||this.hasFeatureLimit)}get features(){return this._features}get featureLimit(){return this._featureLimit.value}set featureLimit(e){this._featureLimit.value!==e&&(this._featureLimit.value=e,this._estimatedUnusedSizeDirty=!0)}get hasFeatureLimit(){return this.featureLimit!==this._featuresLength.value}get availableFields(){return this._availableFields}setFeatures(e,t,r,i){this._availableFields=r,this._features=e,this._featuresLength.value=e?.length??0,this._sorted=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,this._missingAttributes=i,e&&e.length>0?(this._emptyFeatureRatio.value=t/(e.length+t),this._numVertices=e.reduce((e,t)=>e+o.numVertices(t.geometry),0)):(this._emptyFeatureRatio.value=0,this._numVertices=0)}computeZQuantizationFactor(){if(this._features&&this._features.length>0){const e=this._features.reduce((e,{geometry:t})=>Math.max(e,a.computeMaxZ(t)??0),0);return Math.floor(e/this.descriptor.planetRadius)+1}return 1}get emptyFeatureRatio(){return this._emptyFeatureRatio.value}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures.value:this._features?this._featuresLength.value:0}set numFeatures(e){this._numFeatures.value=e}get hasPreciseFeatureCount(){return this._numFeatures.value>-1}get needsFeatureCount(){return-1===this._numFeatures.value}get numVertices(){return this._numVertices}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let e=0;e<this._features.length;++e){const t=o.estimateSize(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let e=this.featureLimit;e<this._features.length;++e)this._estimatedUnusedSize+=o.estimateSize(this._features[e]);return!0}return!1}get fetchStatus(){return this._fetchStatus}requestFetch(){this._fetchStatus=0}requestRefetch(){this._fetchStatus=1}startFetch(){this._fetchStatus=this.needsRefetch?3:2}fetchDone(e){this._fetchStatus=e}get isFetching(){return 2===this._fetchStatus||3===this._fetchStatus}get isRefetching(){return 3===this._fetchStatus}get needsFetch(){return 0===this._fetchStatus||1===this._fetchStatus}get needsRefetch(){return 1===this._fetchStatus}get isFetched(){return 4===this._fetchStatus||5===this._fetchStatus}isFullyFetched(e){return!!this.features&&(this.features.length>=e||5===this.fetchStatus)}resetFetching(){this._fetchStatus=this.isRefetching?1:0}get needsDisplayUpdate(){return!!this._features&&!function(e,t,r){if(null==t||null==e||r!==t.length||r>e.length)return!1;for(let i=0;i<r;++i)if(e[i]!==t[i])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(e){return null==e||!this.descriptor.extent||(n.fromExtent(e,c),n.intersects(this.descriptor.extent,c))}intersectionIncludingBorrowed(e,t){const r=null!=this.extentIncludingBorrowedFeatures?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return e||r?(null!=e?(n.fromExtent(e,t),n.intersection(t,r,t)):n.copy(t,r),t):(n.copy(t,n.positiveInfinity),t)}_shuffle(e){this._features?.sort((t,r)=>o.getObjectId(t,e)-o.getObjectId(r,e)),t.shuffle(this._features,16438)}_sortBySize(e){this._features?.sort((t,r)=>s.diameter(o.computeAABB(r.geometry,u))-s.diameter(o.computeAABB(t.geometry,u))||o.getObjectId(t,e)-o.getObjectId(r,e))}reduceFeatures(e,t,r,i){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let s=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&4===this._fetchStatus&&this._features.length>0&&(this._fetchStatus=1,s=!0),!this._sorted&&e<1&&(1===i?this._shuffle(r):this._sortBySize(r),this._sorted=!0,this._estimatedUnusedSizeDirty=!0);const n=Math.max(this.featureLimit,Math.ceil(t*this.numFeatures));return this._features.length>n&&(this._features.length=this._featuresLength.value=n,this.exceededTransferLimit.value=!1,5===this._fetchStatus&&(this._fetchStatus=4)),s}get cache(){return new l(this,this._features,this._numFeatures.value,this._emptyFeatureRatio.value)}set cache(e){this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._featuresLength.value=e.features?.length??0,this._numFeatures.value=e.numFeatures,this._emptyFeatureRatio.value=e.emptyFeatureRatio,this._fetchStatus=e.fetchStatus,this.exceededTransferLimit.value=e.exceededTransferLimit,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,this.fetchInformation.value=e.fetchInformation}},e.FeatureTileCacheItem=l,e.failedFeatureCount=-2,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/FeatureTileFetcher3DDebugger":function(){define(["exports","../../../../Color","../../../../Graphic","../../../../core/Collection","../../../../core/Handles","../../../../core/reactiveUtils","../../../../geometry/Polygon","../../../../symbols/FillSymbol3DLayer","../../../../symbols/PointSymbol3D","../../../../symbols/PolygonSymbol3D","../../../../symbols/TextSymbol3DLayer","../../../../symbols/callouts/LineCallout3D","../../../../symbols/callouts/LineCallout3DBorder","../../../../symbols/support/Symbol3DVerticalOffset","../../terrain/TilingScheme"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";const m=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];e.FeatureTileFetcher3DDebugger=class{constructor(e,t,r){this._tileFetcher=e,this._view=r,this._handles=new s,this._loadingGraphics=new Map,this._loadingSymbols=[new c({symbolLayers:new i([new a({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}})])})],this._loadedGraphics=new Map,this._loadedSymbols=m.map(e=>new c({symbolLayers:new i([new a({material:{color:[e[0],e[1],e[2],.6]},outline:{color:"black",size:1}})])})),this._pendingGraphics=new Map,this._pendingSymbols=[new c({symbolLayers:new i([new a({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}})])})],this._dataExtentGraphic=null,this._dataExtentSymbol=new c({symbolLayers:new i([new a({material:{color:[0,0,0,0]},outline:{color:"green",size:4}})])}),this._enabled=!0,this._tilingScheme=new f.TilingScheme(t),this.update()}destroy(){this.enabled=!1,this._handles.destroy()}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.update()}update(){this._enabled?(this._synchronizeMaps(this._loadingGraphics,{filter:({isFetching:e})=>e,symbols:this._loadingSymbols}),this._synchronizeMaps(this._loadedGraphics,{filter:e=>!e.isFetching,symbols:this._loadedSymbols}),this._synchronizeMaps(this._pendingGraphics,{filter:({isFetching:e})=>!e,symbols:this._pendingSymbols}),this.showDataExtent(this._tileFetcher.filterExtent)):(this._loadingGraphics.forEach(e=>this._view.graphics.removeMany(e)),this._loadingGraphics.clear(),this._loadedGraphics.forEach(e=>this._view.graphics.removeMany(e)),this._loadedGraphics.clear(),this._pendingGraphics.forEach(e=>this._view.graphics.removeMany(e)),this._pendingGraphics.clear(),this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null))}showDataExtent(e){if(this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null),null==e)return;const t=o.fromExtent(e);this._dataExtentGraphic=new r({geometry:t,symbol:this._dataExtentSymbol}),this._view.graphics.add(this._dataExtentGraphic)}_synchronizeMaps(e,t){const r=this._tileFetcher.featureTiles;e.forEach((i,s)=>{const n=r.get(s);n&&t.filter(n)||(this._view.graphics.removeMany(i),e.delete(s))}),this._handles.removeAll(),r.forEach(r=>{t.filter(r)&&!e.has(r.id)&&this._handles.add(n.watch(()=>r.fetchInformation,()=>this._showTile(r,e,t),n.initial))})}_showTile(e,s,n){const[o,a,c]=e.descriptor.lij,{numFeatures:f,featureLimit:m,features:g}=e;this._tilingScheme.ensureMaxLod(o);const y=this._tilingScheme.getExtentGeometry(o,a,c),_=new r({geometry:y,symbol:n.symbols[o%n.symbols.length]}),b=`Tile ${e.id}\nloaded/limit/total\n${g?.length}/${m}/${f}\nres ${Math.round(e.displayingResolution)} ${e.featuresMissing?"some":"all"}\n${e.fetchInformation.value}`,v=new r({geometry:y.center,symbol:new l({verticalOffset:new p({screenLength:40/.75}),callout:new d({color:new t("white"),border:new h({color:new t("black")})}),symbolLayers:new i([new u({text:b,halo:{color:"white",size:1/.75},material:{color:"black"},size:16})])})}),w=s.get(e.id);w&&this._view.graphics.removeMany(w);const x=[_,v];s.set(e.id,x),this._view.graphics.addMany(x)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/FeatureLayerViewPerformanceInfo":function(){define(["exports","./support/LayerViewPerformanceInfo"],function(e,t){"use strict";class r extends t.LayerViewPerformanceInfo{constructor(e,t,r,i,s,n){super(e.usedMemory,e.displayedFeatures,e.totalFeatures,e.maximumFeatures,e.nodes,e.core),this.storedFeatures=t,this.totalVertices=r,this.partial=i,this.mode=s,this.symbolComplexity=n}}e.FeatureLayerViewPerformanceInfo=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DGraphicsPipeline":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Error","../../../../core/maybe","../../../../core/Promise","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/UpdatingHandles","../../../../layers/graphics/controllers/FeatureTileController3D","../../../../symbols/support/utils","./elevationAlignPointsInFeatures","./Graphics3DFeatureProcessor","./QueryEngine","./QueryEngineContext","./queryForSymbologySnapping","../support/HeatmapFeatureProcessor","../support/LayerViewPerformanceInfo","../../../support/layerViewUtils","../../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x){"use strict";e.Graphics3DGraphicsPipeline=class extends s.EsriPromise{constructor(e){super(e),this._dataUpdatingState=0,this.graphicsQuery={queryForSymbologySnapping:async(e,t)=>this.symbologySnappingSupported?_.queryForSymbologySnapping(this.graphics3DProcessor,e,t):{candidates:[],sourceCandidateIndices:[]},executeQuery:(e,t)=>this.queryEngine.executeQuery(e,t),executeQueryForIds:(e,t)=>this.queryEngine.executeQueryForIds(e,t),executeQueryForCount:(e,t)=>this.queryEngine.executeQueryForCount(e,t),executeQueryForExtent:(e,t)=>this.queryEngine.executeQueryForExtent(e,t),executeQueryForLatestObservations:(e,t)=>this.queryEngine.executeQueryForLatestObservations(e,t)},this.controller=null,this.updatingHandles=new d.UpdatingHandles,this._controllerCreated=!1,this._pendingController=null}initialize(){this.addResolvingPromise(this._initializeController()),this.updatingHandles.add(()=>this.layer.renderer,e=>this._recreateProcessor(e),n.initial),this.updatingHandles.add(()=>this.updatePolicy,e=>this.processor.preferredUpdatePolicy=e);const{layer:e,view:t,hasM:r,hasZ:i}=this,{spatialReference:s,resourceController:o}=t,a=new y.QueryEngineContext(s,e,o,()=>this.processor.featureStore,i,r);this.queryEngine=new g.QueryEngine({context:a,priority:x.TaskPriority.FEATURE_QUERY_ENGINE})}destroy(){this.removeAllHandles(),this.updatingHandles.destroy(),this._destroyPendingController(),this.controller=i.destroyMaybe(this.controller),this.processor=i.destroyMaybe(this.processor),this.queryEngine=i.destroyMaybe(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this._pendingController=i.destroyMaybe(this._pendingController)}get updating(){return this.updatingHandles.updating||!this._controllerCreated||this.controller?.updating||this.processor?.updating}get legendEnabled(){return this.processor.legendEnabled}get layer(){return this.layerView.layer}get layerViewUid(){return this.layerView.uid}get view(){return this.layerView.view}get hasZ(){return this.layerView.hasZ}get hasM(){return this.layerView.hasM}get fullOpacity(){return this.layerView.fullOpacity}get suspended(){return this.layerView.suspended}get filter(){return"filter"in this.layerView?this.layerView.filter:null}get effectiveDisplayFilterClause(){return"effectiveDisplayFilterClause"in this.layerView?this.layerView.effectiveDisplayFilterClause:null}get slicePlaneEnabled(){return this.layerView.slicePlaneEnabled}get featureSpatialReference(){return"featureSpatialReference"in this.layerView?this.layerView.featureSpatialReference:null}get graphics3DProcessor(){return"graphics-3d"===this.processor?.type?this.processor:null}get heatmapProcessor(){return"heatmap"===this.processor?.type?this.processor:null}get hasAllFeatures(){return!(!this.controller||!("hasAllFeatures"in this.controller))&&this.controller.hasAllFeatures}get hasAllFeaturesInView(){return!(!this.controller||!("hasAllFeaturesInView"in this.controller))&&this.controller.hasAllFeaturesInView}get hasFullGeometries(){return!(!this.controller||!("hasFullGeometries"in this.controller))&&this.controller.hasFullGeometries}get symbologySnappingSupported(){return this.layer?.renderer?.symbols?.some(p.symbolHasExtrudeSymbolLayer)??!1}get updatePolicy(){return 1}get scaleVisibilitySuspended(){return this.processor?.scaleVisibilitySuspended}get timeExtent(){return"timeExtent"in this.layerView?this.layerView.timeExtent:null}get dataUpdating(){return 0!==this._dataUpdatingState}get suspendInfo(){return this.processor?.suspendInfo??{}}forEachGraphic(e){this.loadedGraphics.forEach(e)}findGraphic(e){return this.loadedGraphics.find(e)}queryObjectIds(e,t){return this.layerView.queryObjectIds(e,t)}whenGraphicBounds(e,t){return this.processor?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.processor?.computeAttachmentOrigin(e,t)}async elevationAlignPointsInFeatures(e,t){const i=this.graphics3DProcessor;if(null==i)throw new r("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");return f.elevationAlignPointsInFeatures(this.view,this.layer,e=>i.getGraphics3DGraphicByObjectId(e),e,t)}highlightByGraphics(e,t){return this.processor.highlightByGraphics(e,t)}highlightByObjectIds(e,t){return this.processor.highlightByObjectIds(e,this.layer.objectIdField,t)}maskOccludee(e){return this.processor.maskOccludee(e)}notifyContentGeometryUpdate(){this.layerView.emit("visible-geometry-changed")}async _initializeController(){const e=this.createController();this._pendingController=e,this._setupDataUpdating(e),await e.when(),this._setControllerWhenInitialized(e)}_setupDataUpdating(e){"dataUpdating"in e&&this.addHandles([n.watch(()=>e.dataUpdating,e=>{e&&0===this._dataUpdatingState?this._dataUpdatingState=1:e||1!==this._dataUpdatingState||(this._dataUpdatingState=0)},n.sync),n.watch(()=>!!this.graphics3DProcessor?.dataUpdating,t=>{t&&1===this._dataUpdatingState?this._dataUpdatingState=2:t||2!==this._dataUpdatingState||(this._dataUpdatingState=e.dataUpdating?1:0)},n.sync)])}async _setControllerWhenInitialized(e){try{await this.when()}catch(e){}this._controllerCreated=!0,this.isResolved()&&!this.destroyed?(await n.whenOnce(()=>this.view?.basemapTerrain?.ready),this.beforeSetController(e),this._pendingController=null,this.controller=e,this.loadedGraphics=e.graphics):this._destroyPendingController()}_recreateProcessor(e){const t="heatmap"===e?.type,r="heatmap"===this.processor?.type,i=this.processor;if(i&&t===r)return;const s=t?new b.HeatmapFeatureProcessor({owner:this}):new m.Graphics3DFeatureProcessor({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!w.hasLayerBasedScaleVisibility(),filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:e=>this._updateClippingExtent(e)});this.processor=s,i?.destroy(),this.queryEngine?.clear(),this.addResolvingPromise(s.when())}_updateClippingExtent(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}get usedMemory(){return this.processor?.usedMemory??0}get performanceInfo(){const e=this.controller instanceof h.FeatureTileController3D?this.controller:null;return new v.LayerViewPerformanceInfo(this.usedMemory,this.loadedGraphics?.length,e?.serviceDataCount??-1,e?.maximumNumberOfFeatures??-1,0,this.processor.performanceInfo)}},t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"updating",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"legendEnabled",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"layerView",void 0),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"layer",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"layerViewUid",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"view",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"hasZ",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"hasM",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"fullOpacity",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"suspended",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"filter",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"effectiveDisplayFilterClause",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"slicePlaneEnabled",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"featureSpatialReference",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"loadedGraphics",void 0),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"graphics3DProcessor",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"heatmapProcessor",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"hasAllFeatures",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"hasAllFeaturesInView",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"hasFullGeometries",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"symbologySnappingSupported",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"updatePolicy",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"scaleVisibilitySuspended",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"timeExtent",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"_dataUpdatingState",void 0),t.__decorate([o.property({readOnly:!0})],e.Graphics3DGraphicsPipeline.prototype,"dataUpdating",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"controller",void 0),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"processor",void 0),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"updatingHandles",void 0),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"_controllerCreated",void 0),e.Graphics3DGraphicsPipeline=t.__decorate([u.subclass("esri.views.3d.layers.graphics.Graphics3DGraphicsPipeline")],e.Graphics3DGraphicsPipeline),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/symbols/support/utils":function(){define(["require","exports","../../Color","../../core/asyncUtils","../../core/has","../../core/screenUtils","../../core/libs/gl-matrix-2/factories/vec3f64","../../layers/effects/jsonUtils","./cimSymbolUtils","./gfxUtils","./Symbol3DMaterial","./typeUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(e,t){if(null==t||null==e)return e;const i=e.toRgba();return i[3]=i[3]*t,new r(i)}function p(e){for(const t of e)if("number"==typeof t)return t;return null}function f(e,t,r){for(let i=0;i<3;i++){const s=e[i];switch(s){case"symbol-value":{const e=r[i];return null!=e?e/t[i]:1}case"proportional":break;default:if(s&&t[i])return s/t[i]}}return null}function m(e,t,r,i){switch(e){case"proportional":return r*i;case"symbol-value":return null!=t?t:r;default:return e}}t.applyColorToSymbol=function(e,t,i){e&&(t||null!=i)&&(t&&(t=new r(t)),d.isSymbol3D(e)?function(e,t,i){const s=e.symbolLayers;if(!s)return;const n=(e,s=!1)=>{let n=t??e??null;return null!=i?.override&&(!n&&s&&(n=new r([255,255,255])),n&&(n.a=i.override)),h(n,i?.add)};s.forEach(e=>{if("water"===e.type)return void(e.color=h(e.color,i?.add));const t=null!=e.material?e.material.color:null,r=n(t,"icon"===e.type&&null!=e.resource?.href);null==e.material?e.material=new u.Symbol3DMaterial({color:r}):e.material.color=r,"outline"in e&&e.outline?.color&&null!=i?.add&&(e.outline.color=h(e.outline.color,i.add)),"marker"in e&&null!=e.marker&&(e.marker.color=n(e.marker.color))})}(e,t,i):d.isSymbol2D(e)&&function(e,t,r){t=t??e.color,null!=r?.override&&t&&(t.a=r.override),t&&(e.color=h(t,r?.add)),"outline"in e&&e.outline?.color&&(e.outline.color=h(e.outline.color,r?.add))}(e,t,i))},t.applyOpacityToColor=h,t.applyRotationToSymbol=function(e,t,r){if(e&&null!=t)if(d.isSymbol3D(e)){const i=e.symbolLayers;i&&i.forEach(e=>{if("object"===e.type)switch(r){case"tilt":e.tilt=(e.tilt??0)+t;break;case"roll":e.roll=(e.roll??0)+t;break;default:e.heading=(e.heading??0)+t}"icon"===e.type&&(e.angle+=t)})}else d.isSymbol2D(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle+=t))},t.applySizesToSymbol=async function(t,r){if(t&&r)return d.isSymbol3D(t)?async function(t,r){const s=t.symbolLayers;s&&await i.forEach(s,async t=>async function(t,r){switch(t.type){case"extrude":!function(e,t){const r=t[2];"number"==typeof r&&(e.size=r)}(t,r);break;case"icon":case"line":case"text":!function(e,t){const r=p(t);null!=r&&(e.size=r)}(t,r);break;case"path":!function(e,t){const r=f(t,o.ONES,[e.width,void 0,e.height]);null!=r&&(e.width=m(t[0],e.width,1,r),e.height=m(t[2],e.height,1,r))}(t,r);break;case"object":await async function(t,r){const{resourceSize:i,symbolSize:s}=await async function(t){const{computeObjectLayerResourceSize:r}=await new Promise((t,r)=>e(["./symbolLayerUtils"],t,r)),i=await r(t,10),{width:s,height:n,depth:o}=t,a=[s,o,n];let l=1;for(let e=0;e<3;e++){const t=a[e];if(null!=t){l=t/i[e];break}}for(let e=0;e<3;e++)null==a[e]&&(a[e]=i[e]*l);return{resourceSize:i,symbolSize:a}}(t),n=f(r,i,s);null!=n&&(t.width=m(r[0],s[0],i[0],n),t.depth=m(r[1],s[1],i[1],n),t.height=m(r[2],s[2],i[2],n))}(t,r)}}(t,r))}(t,r):void(d.isSymbol2D(t)&&function(e,t){const r=p(t);if(null!=r)switch(e.type){case"simple-marker":e.size=r;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=r,e.height=r*t):(e.width=r*t,e.height=r);break}case"simple-line":e.width=r;break;case"text":e.font.size=r}}(t,r))},t.getCSSFilterFromEffectList=function(e){if(!e)return null;const t=e.effects.filter(e=>"bloom"!==e.type).map(e=>e.toJSON());return a.effectFunctionsFromJSON(t)},t.getColorFromSymbol=function(e,t){if(!e)return null;let i=null;return d.isSymbol3D(e)?i=function(e){const t=e.symbolLayers;if(!t)return null;let i=null;return t.forEach(e=>{"object"===e.type&&e.resource?.href||(i="water"===e.type?e.color:e.material?e.material.color:null)}),i?new r(i):null}(e):d.isSymbol2D(e)&&(i="cim"===e.type?l.getCIMSymbolColor(e):e.color?new r(e.color):null),i?h(i,t):null},t.getIconHref=function(e){return e.resource?.href??""},t.getSymbolOutlineColor=function(e){if(!e)return null;if(d.isSymbol3D(e))return function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.color}(e);const t=c.getStroke(e)?.color;return t?new r(t):null},t.getSymbolOutlineSize=function(e){if(!e)return 0;if(d.isSymbol3D(e)){const t=function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.size}(e);return null!=t?t:0}return n.px2pt(c.getStroke(e)?.width)},t.isVolumetricSymbol=function(e){if(null==e||!("symbolLayers"in e)||null==e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some(e=>"object"===e.type);case"line-3d":return e.symbolLayers.some(e=>"path"===e.type);case"polygon-3d":return e.symbolLayers.some(e=>"object"===e.type||"extrude"===e.type);default:return!1}},t.symbolHasExtrudeSymbolLayer=function(e){return null!=e&&"polygon-3d"===e.type&&e.symbolLayers.some(e=>"extrude"===e.type)},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/symbols/support/cimSymbolUtils":function(){define(["exports","../../Color","../cim/utils"],function(e,t,r){"use strict";function i(e){const t=r.toCIMSymbolJSON(e);if("CIMTextSymbol"===t?.type)return t.height??0;let i=0;if(t?.symbolLayers)for(const e of t.symbolLayers)r.isCIMMarker(e)&&null!=e.size&&e.size>i?i=e.size:r.isCIMStroke(e)&&null!=e.width&&e.width>i?i=e.width:r.isCIMFill(e);return i}function s(e,t,r,i){if(e)if("CIMTextSymbol"!==e.type){if(r&&e.effects)for(const r of e.effects)o(r,t);if(e.symbolLayers)for(const r of e.symbolLayers){switch(r.type){case"CIMPictureMarker":case"CIMVectorMarker":n(r,t,i);break;case"CIMPictureStroke":case"CIMSolidStroke":case"CIMGradientStroke":!i?.preserveOutlineWidth&&r.width&&(r.width*=t);break;case"CIMPictureFill":r.height&&(r.height*=t),r.offsetX&&(r.offsetX*=t),r.offsetY&&(r.offsetY*=t);break;case"CIMHatchFill":s(r.lineSymbol,t,!0,{...i,preserveOutlineWidth:!1}),r.offsetX&&(r.offsetX*=t),r.offsetY&&(r.offsetY*=t),r.separation&&(r.separation*=t)}if(r.effects)for(const e of r.effects)o(e,t)}}else null!=e.height&&(e.height*=t)}function n(e,t,i){if(e&&(e.markerPlacement&&function(e,t){switch(r.isCIMMarkerStrokePlacement(e)&&e.offset&&(e.offset*=t),e.type){case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineSameSize":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.placementTemplate&&e.placementTemplate.length){const r=e.placementTemplate.map(e=>e*t);e.placementTemplate=r}break;case"CIMMarkerPlacementAlongLineVariableSize":if(e.maxRandomOffset&&(e.maxRandomOffset*=t),e.placementTemplate&&e.placementTemplate.length){const r=e.placementTemplate.map(e=>e*t);e.placementTemplate=r}break;case"CIMMarkerPlacementOnLine":e.startPointOffset&&(e.startPointOffset*=t);break;case"CIMMarkerPlacementAtExtremities":e.offsetAlongLine&&(e.offsetAlongLine*=t);break;case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementOnVertices":break;case"CIMMarkerPlacementAtRatioPositions":e.beginPosition&&(e.beginPosition*=t),e.endPosition&&(e.endPosition*=t);break;case"CIMMarkerPlacementPolygonCenter":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMMarkerPlacementInsidePolygon":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.stepX&&(e.stepX*=t),e.stepY&&(e.stepY*=t)}}(e.markerPlacement,t),e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.anchorPoint&&"Absolute"===e.anchorPointUnits&&(e.anchorPoint={x:e.anchorPoint.x*t,y:e.anchorPoint.y*t}),e.size=null!=e.size?e.size*t:0,"CIMVectorMarker"===e.type&&e.markerGraphics))for(const r of e.markerGraphics)e.scaleSymbolsProportionally||s(r.symbol,t,!0,i)}function o(e,t){switch(e.type){case"CIMGeometricEffectArrow":case"CIMGeometricEffectDonut":e.width&&(e.width*=t);break;case"CIMGeometricEffectBuffer":e.size&&(e.size*=t);break;case"CIMGeometricEffectCut":e.beginCut&&(e.beginCut*=t),e.endCut&&(e.endCut*=t),e.middleCut&&(e.middleCut*=t);break;case"CIMGeometricEffectDashes":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.dashTemplate&&e.dashTemplate.length){const r=e.dashTemplate.map(e=>e*t);e.dashTemplate=r}break;case"CIMGeometricEffectExtension":case"CIMGeometricEffectJog":case"CIMGeometricEffectRadial":e.length&&(e.length*=t);break;case"CIMGeometricEffectMove":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":e.offset&&(e.offset*=t);break;case"CIMGeometricEffectRegularPolygon":e.radius&&(e.radius*=t);break;case"CIMGeometricEffectTaperedPolygon":e.fromWidth&&(e.fromWidth*=t),e.length&&(e.length*=t),e.toWidth&&(e.toWidth*=t);break;case"CIMGeometricEffectWave":e.amplitude&&(e.amplitude*=t),e.period&&(e.period*=t)}}function a(e,t){if(!e)return;let i;i="CIMTextSymbol"===e.type?e.symbol:e;const s="CIMPolygonSymbol"===e.type;if(i?.symbolLayers)for(const e of i.symbolLayers)if(!(e.colorLocked||s&&(r.isCIMStroke(e)||r.isCIMMarker(e)&&e.markerPlacement&&r.isCIMMarkerStrokePlacement(e.markerPlacement))))switch(e.type){case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":e.tintColor&&l(t,e.tintColor);break;case"CIMVectorMarker":e.markerGraphics?.forEach(e=>{a(e.symbol,t)});break;case"CIMSolidStroke":case"CIMSolidFill":l(t,e.color);break;case"CIMGradientFill":c(t,e);break;case"CIMHatchFill":a(e.lineSymbol,t)}}function l(e,t){for(const r of e)if(r.join(".")===t.join("."))return;e.push(t)}function c(e,t){const r=t.colorRamp?.type;switch(r){case"CIMMultipartColorRamp":t.colorRamp.colorRamps?.forEach(t=>{"CIMLinearContinuousColorRamp"===t.type&&u(e,t)});break;case"CIMLinearContinuousColorRamp":case"CIMPolarContinuousColorRamp":u(e,t.colorRamp)}}function u(e,t){t&&(t.fromColor&&l(e,t.fromColor),t.toColor&&l(e,t.toColor))}function d(e,t,i){if(!e)return;let s;s="CIMTextSymbol"===e.type?e.symbol:e;const n="CIMPolygonSymbol"===s?.type;if(s?.symbolLayers)for(const e of s.symbolLayers){if(e.colorLocked)continue;if(n)if(i){const{layersToColor:t}=i;if((r.isCIMStroke(e)||r.isCIMMarker(e)&&e.markerPlacement&&r.isCIMMarkerStrokePlacement(e.markerPlacement))&&"fill"===t||r.isCIMFill(e)&&"outline"===t)continue}else if(r.isCIMStroke(e)||r.isCIMMarker(e)&&e.markerPlacement&&r.isCIMMarkerStrokePlacement(e.markerPlacement))continue;const s=t.toArray();switch(e.type){case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":e.tintColor=s;break;case"CIMVectorMarker":e.markerGraphics?.forEach(e=>{d(e.symbol,t,i)});break;case"CIMSolidStroke":case"CIMSolidFill":e.color=s;break;case"CIMGradientFill":h(e,t);break;case"CIMHatchFill":d(e.lineSymbol,t,i)}}}function h(e,t){const r=e.colorRamp?.type;switch(r){case"CIMMultipartColorRamp":e.colorRamp.colorRamps?.forEach(e=>{"CIMLinearContinuousColorRamp"===e.type&&p(e,t)});break;case"CIMLinearContinuousColorRamp":case"CIMPolarContinuousColorRamp":p(e.colorRamp,t)}}function p(e,t){if(e&&(e.fromColor&&(e.fromColor=t.toArray()),e.toColor)){const r=t.clone();r.a=0,e.toColor=r.toArray()}}e.applyCIMSymbolColor=function(e,i,s){i instanceof t||(i=new t(i));const n=r.toCIMSymbolJSON(e);n&&d(n,i,s)},e.applyCIMSymbolRotation=function(e,t,i=!1){const s=r.toCIMSymbolJSON(e);if(i&&(t=360-t),"CIMTextSymbol"!==s?.type){if("CIMPointSymbol"===s?.type&&s.symbolLayers){const e=t-(s.angle||0);for(const t of s.symbolLayers)if(r.isCIMMarker(t)){let r=t.rotation||0;t.rotateClockwise?r-=e:r+=e,t.rotation=r}s.angle=t}}else s.angle=t},e.getCIMSymbolColor=function(e){const i=[];return a(r.toCIMSymbolJSON(e),i),i.length?new t(r.normalizeAlpha(i[0])):null},e.getCIMSymbolRotation=function(e,t=!1){const i=r.toCIMSymbolJSON(e);if("CIMTextSymbol"===i?.type||"CIMPointSymbol"===i?.type){const e=i.angle;return null!=e&&t?360-e:e??0}return 0},e.getCIMSymbolSize=i,e.getCIMSymbolType=function(e){const t=r.toCIMSymbolJSON(e);if(!t)return null;switch(t.type){case"CIMPointSymbol":return"CIMPointSymbol";case"CIMLineSymbol":return"CIMLineSymbol";case"CIMPolygonSymbol":return"CIMPolygonSymbol";case"CIMTextSymbol":return"CIMTextSymbol";case"CIMMeshSymbol":return"CIMMeshSymbol";default:return null}},e.scaleCIMMarker=n,e.scaleCIMSymbol=s,e.scaleCIMSymbolTo=function(e,t,n){if(!e)return;const o=r.toCIMSymbolJSON(e),a=i(e);0!==a?s(o,t/a,!1,n):function(e,t){if(e)if("CIMTextSymbol"!==e.type){if(e.symbolLayers)for(const r of e.symbolLayers)switch(r.type){case"CIMPictureMarker":case"CIMVectorMarker":r.size=t;break;case"CIMPictureStroke":case"CIMSolidStroke":case"CIMGradientStroke":r.width=t}}else e.height=t}(o,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/symbols/support/gfxUtils":function(){define(["exports","../../assets","../../Color","../../request","../../core/LRUCache","../../core/screenUtils","./cimSymbolUtils"],function(e,t,r,i,s,n,o){"use strict";const a="picture-fill",l="simple-fill",c="simple-marker",u=new Map([["dash",[4,3]],["dashdot",[4,3,1,3]],["dot",[1,3]],["longdash",[8,3]],["longdashdot",[8,3,1,3]],["longdashdotdot",[8,3,1,3,1,3]],["shortdash",[4,1]],["shortdashdot",[4,1,1,1]],["shortdashdotdot",[4,1,1,1,1,1]],["shortdot",[1,1]],["solid",[]]]),d=new s.LRUCache(1e3);function h(e){if(!e?.style)return[];const{dashArray:t,style:r,width:i}=e;if("string"==typeof t&&"none"!==t)return t.split(",").map(e=>Number(e));const s=i??0,n=u.has(r)?u.get(r).map(e=>e*s):[];if("butt"!==e.cap)for(const[e,t]of n.entries())n[e]=e%2==1?t+s:Math.max(t-s,1);return n}const p=(()=>{const e={};return t=>{if(e[t])return e[t];const r=t.replaceAll("-","");return e[t]=r,r}})(),f=new r([128,128,128]);e.defaultThematicColor=f,e.dekebabifyLineStyle=p,e.getDashArray=h,e.getFill=function(e){const r=e.style;let i=null;if(e)switch(e.type){case c:"cross"!==r&&"x"!==r&&(i=e.color);break;case l:r&&"solid"!==r?"none"!==r&&(i={type:"pattern",x:0,y:0,src:t.getAssetUrl(`esri/symbols/patterns/${r}.png`),width:5,height:5}):i=e.color;break;case a:i={type:"pattern",src:e.url,width:n.pt2px(e.width)*e.xscale,height:n.pt2px(e.height)*e.yscale,x:n.pt2px(e.xoffset),y:n.pt2px(e.yoffset)};break;case"text":i=e.color;break;case"cim":i=o.getCIMSymbolColor(e)}return i},e.getPatternUrlWithColor=function(e,t){const r=e+"-"+t,s=d.get(r);return null!=s?Promise.resolve(s):i(e,{responseType:"image"}).then(e=>{const i=e.data,s=i.naturalWidth,n=i.naturalHeight,o=document.createElement("canvas");o.width=s,o.height=n;const a=o.getContext("2d");a.fillStyle=t,a.fillRect(0,0,s,n),a.globalCompositeOperation="destination-in",a.drawImage(i,0,0);const l=o.toDataURL();return d.put(r,l),l})},e.getStroke=function e(t){if(!t)return null;let r=null;switch(t.type){case l:case a:case c:r=e(t.outline);break;case"simple-line":{const e=n.pt2px(t.width);null!=t.style&&"none"!==t.style&&0!==e&&(r={color:t.color,style:p(t.style),width:e,cap:t.cap,join:"miter"===t.join?n.pt2px(t.miterLimit):t.join},r.dashArray=h(r).join(",")||"none");break}default:r=null}return r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/elevationAlignPointsInFeatures":function(){define(["exports","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/SpatialReference","../../../../geometry/projection/projectPointToVector","../../../../layers/graphics/dehydratedPoint","../../../../support/elevationInfoUtils","./elevationAlignmentUtils","./ElevationContext","./featureExpressionInfoUtils"],function(e,t,r,i,s,n,o,a,l,c){"use strict";e.elevationAlignPointsInFeatures=async function(e,u,d,h,p){const{elevationProvider:f,renderCoordsHelper:m}=e,{elevationInfo:g}=u,{pointsInFeatures:y,spatialReference:_}=h,b=i.fromJSON(_),v=c.extractExpressionInfo(g,!0),w=await c.createContext(v,b,p);t.throwIfAborted(p);const x=[],S=new Set,T=new Set,C=new l.ElevationContext,P=n.makeDehydratedPoint(0,0,0,i.WGS84),M=new a.SampleElevationInfo,R=r.create();P.spatialReference=b;const O=e.elevationProvider.spatialReference??e.spatialReference;for(const{objectId:e,points:t}of y){const r=d(e);if(null==r){for(const e of t)x.push(e.z??0);S.add(e);continue}r.isDraped&&T.add(e);const i=r.graphic.geometry;C.setFromElevationInfo(o.getGeometryEffectiveElevationInfo(i,g)),C.updateFeatureExpressionInfoContext(w,r.graphic,u);for(const{x:e,y:r,z:i}of t)P.x=e,P.y=r,P.z=i??0,await s.projectPointToVectorAsync(P,R,O,0,{signal:p}),a.evaluateElevationInfoAtPoint(R,f,C,m,M),x.push(M.z)}return{elevations:x,drapedObjectIds:T,failedObjectIds:S}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DFeatureProcessor":function(){define(["exports","../../../../chunks/tslib.es6","../../../../arcade/functions/hash","../../../../core/asyncUtils","../../../../core/compilerUtils","../../../../core/handleUtils","../../../../core/maybe","../../../../core/Promise","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/accessorSupport/diffUtils","../../../../core/support/UpdatingHandles","../../../../geometry/support/webMercatorUtils","../../../../renderers/support/renderingInfoUtils","../../../../support/arcadeExpressionUtils","./constants","./DisplayFeatureLimit","./Graphics3DCore","./Graphics3DElevationAlignment","./Graphics3DFrustumVisibility","./Graphics3DObjectStates","./Graphics3DScaleVisibility","./graphicUtils","../support/FeatureVisibilityFilter","../support/highlightUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R){"use strict";e.Graphics3DFeatureProcessor=class extends a.EsriPromise{constructor(e){super(e),this.type="graphics-3d",this._updatingHandles=new m.UpdatingHandles,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=1,this.preferredUpdatePolicy=0,this._suspendResumeExtent=null}initialize(){const e=this.owner,t=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&"multipatch"!==e.layer.geometryType,r=new w.Graphics3DCore({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.hasZ,hasM:e.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:t=>e.view.deconflictor.addGraphicsOwner(t),labeler:(t,r)=>e.view.labeler.addGraphicsOwner(t,r),elevationAlignment:this.elevationAlignmentEnabled?(t,r)=>new x.Graphics3DElevationAlignment({graphicsCoreOwner:this,graphicsCore:t,queryGraphicUIDsInExtent:r,elevationProvider:e.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(t,r)=>new C.Graphics3DScaleVisibility({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:r,graphicsCore:t,basemapTerrain:e.view.basemapTerrain}):null,filterVisibility:t?t=>new M.FeatureVisibilityFilter({context:{...t,configuration:e}}):null,objectStates:e=>new T.Graphics3DObjectStates(e)}});this._set("graphicsCore",r),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new S.Graphics3DFrustumVisibility({graphicsCoreOwner:this})),this.elevationAlignment&&this._updatingHandles.add(()=>this.layer.elevationInfo,(e,t)=>{f.diff(e,t)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())}),this._updatingHandles.add(()=>this.layer.labelsVisible,()=>this.graphicsCore.updateVisibilityInfo()),this._updatingHandles.add(()=>this.layer.labelingInfo,(e,t)=>{f.diff(e,t)&&this.graphicsCore.updateLabelingInfo()}),this._updatingHandles.add(()=>this.preferredUpdatePolicy,e=>this.graphicsCore.preferredUpdatePolicy=e),this.addResolvingTask(i.createTask(e=>this._initializeAsync(e)))}async _initializeAsync(e){await l.logOnError(this.graphicsCore.initializePromise),l.throwIfAborted(e);const t=this.owner;this._updatingHandles.add(()=>this.renderer,e=>this._updatingHandles.addPromise(this.graphicsCore.rendererChange(e))),this._updatingHandles.add(()=>t.fullOpacity,()=>this.graphicsCore.opacityChange()),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this._updatingHandles.add(()=>t.view.clippingArea,()=>this._updateClippingExtent()),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&(await l.logOnError(this.graphicsCore.updateLabelingInfo()),l.throwIfAborted(e))}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",o.destroyMaybe(this.frustumVisibility)),this._set("graphicsCore",o.destroyMaybe(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get layerViewUid(){return this.owner.layerViewUid}get dataUpdating(){return this.graphicsCore?.dataUpdating??!1}get renderer(){const{renderer:e,objectIdField:t}=this.layer;if(!e||!t||"heatmap"===e.type||!e.visualVariables)return e;const r=e.visualVariables.findIndex(e=>"rotation"===e.type&&null!=e.valueExpression&&_.matchRandomRotationExpression(e.valueExpression)===t&&(null==e.axis||"heading"===e.axis)&&"geographic"===e.rotationType);if(r<0)return e;const i=e.clone();return i.visualVariables?(i.visualVariables.splice(r,1),this._randomRotationRenderers??=new WeakMap,this._randomRotationRenderers.set(i,t),i):e}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get filterVisibility(){return this.graphicsCore?.filterVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get suspendResumeExtentMode(){return this.owner.suspendResumeExtentMode??"computed"}get scaleVisibilitySuspended(){return null!=this.scaleVisibility&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return null==this.frustumVisibility||!this.frustumVisibility.suspended}get suspendInfo(){const e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),null!=this.frustumVisibility&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){return!!(this.graphicsCore?.updating||this.frustumVisibility?.updating||this._updatingHandles.updating)}get updatingRemaining(){return this.graphicsCore?.updatingRemaining??0}get featureStore(){return this.graphicsCore?.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner?.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get symbolUpdateType(){return this.graphicsCore?.symbolUpdateType}get displayFeatureLimit(){const e=this.view.quality,t=this.graphicsCore?.displayFeatureLimit;if(1===e)return t;const r=Math.ceil(t.maximumNumberOfFeatures*e);return new v.DisplayFeatureLimit(t.maximumTotalNumberOfVertices,r,t.averageSymbolComplexity)}get usedMemory(){return this.graphicsCore?.usedMemory??0}get loadedFeatures(){return this.graphicsCore?.numberOfGraphics??0}get usedMemoryPerFeature(){return this.graphicsCore?.usedMemoryPerGraphic??0}get unprocessedMemoryEstimate(){return this.graphicsCore?.unprocessedMemoryEstimate??0}get performanceInfo(){return this.graphicsCore.performanceInfo}maskOccludee(e){const t=this.graphicsCore?.objectStates;if(!t)return n.makeHandle();const{set:r,handle:i}=t.acquireOccludeeSet(null);return t.setUid(r,e.uid),i}highlightByGraphics(e,t){const r=this.graphicsCore?.objectStates;if(!r)return R.emptyHighlightHandle;const i=e.map(e=>e.uid),{set:s,handle:n}=r.acquireHighlightSet(t,null);return r.setUids(s,i),n}highlightByObjectIds(e,t=null,r){const i=this.graphicsCore?.objectStates;if(!i)return R.emptyHighlightHandle;const{set:s,handle:n}=i.acquireHighlightSet(r,t);return i.setObjectIds(s,e),n}resetObjectStates(){this.graphicsCore?.objectStates?.reset()}whenGraphicBounds(e,t){return this.graphicsCore?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphicsCore?.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}notifyContentGeometryUpdate(){this.owner.notifyContentGeometryUpdate?.()}getRenderingInfo(e,t,i){const s=y.getRenderingInfo(e,{renderer:t,arcade:i});if(s?.color){const e=s.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}if(null!=s&&null!=t&&this._randomRotationRenderers?.has(t)){const i=this._randomRotationRenderers.get(t),n=e.attributes[i],o=new r.XXH(0);o.updateFloatArray([n]),o.updateUint8Array([173]),s.heading=8.381e-8*o.digest()}return s}getRenderingInfoAsync(e,t,r,i){return y.getRenderingInfoAsync(e,{renderer:t,arcade:r,...i})}getSymbolLayerSize(e,t){return this.graphicsCore?.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){this.graphicsCore?.setObjectIdVisibility(e,t)}refreshFilter(){null!=this.filterVisibility&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(e){return this.graphicsCore?.getGraphics3DGraphicByObjectId(e)}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.addHandles(c.watch(()=>this.suspendResumeExtentMode,()=>{switch(this.removeHandles(O),this.suspendResumeExtentMode){case"computed":this.addHandles([c.watch(()=>this.graphicsCore.computedExtent,e=>this._updateSuspendResumeExtent(e),c.initial),c.watch(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent))],O);break;case"data":this.addHandles([c.when(()=>this.dataExtent,e=>this._updateSuspendResumeExtent(e),c.initial),c.watch(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.dataExtent))],O);break;default:s.neverReached(this.suspendResumeExtentMode)}},c.initial))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){const r=this.owner.view.spatialReference;if(!e.spatialReference.equals(r)){if(!g.canProject(e,r))return;e=g.project(e,r)}return P.enlargeExtent(e,t,b.suspendResumeExtentOptimism,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){null!=this.frustumVisibility&&this.frustumVisibility.setExtent(e),null!=this.scaleVisibility&&this.scaleVisibility.setExtent(e)}},t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"type",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"owner",void 0),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"layer",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"layerViewUid",null),t.__decorate([u.property({readOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"dataUpdating",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"renderer",null),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"updateClippingExtent",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"elevationFeatureExpressionEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"graphicsCore",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"scaleVisibilityEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"filterVisibilityEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"frustumVisibilityEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"elevationAlignmentEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"timeExtentEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"setUidToIdOnAdd",void 0),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"scaleVisibility",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"filterVisibility",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"elevationAlignment",null),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"frustumVisibility",void 0),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"suspendResumeExtentMode",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"dataExtent",void 0),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"scaleVisibilitySuspended",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"suspended",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"legendEnabled",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"suspendInfo",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"updating",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"updatingRemaining",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"featureStore",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"view",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"loadedGraphics",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"fullOpacity",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"filter",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"slicePlaneEnabled",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"drapeSourceType",void 0),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"updatePolicy",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"preferredUpdatePolicy",void 0),t.__decorate([u.property({readOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"displayFeatureLimit",null),e.Graphics3DFeatureProcessor=t.__decorate([p.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],e.Graphics3DFeatureProcessor);const O="suspendResumeExtentMode";Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/arcade/functions/hash":function(){define(["exports"],function(e){"use strict";const t=2654435761,r=2246822519,i=3266489917,s=668265263,n=374761393;function o(e){const t=[];for(let r=0,i=e.length;r<i;r++){let i=e.charCodeAt(r);i<128?t.push(i):i<2048?t.push(192|i>>6,128|63&i):i<55296||i>=57344?t.push(224|i>>12,128|i>>6&63,128|63&i):(r++,i=65536+((1023&i)<<10|1023&e.charCodeAt(r)),t.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i))}return new Uint8Array(t)}e.XXH=class{constructor(e){this._seed=e,this._totallen=0,this._bufs=[],this.init()}init(){return this._bufs=[],this._totallen=0,this}updateFloatArray(e){const t=[];for(const r of e)isNaN(r)?t.push("NaN"):r===1/0?t.push("Infinity"):r===-1/0?t.push("-Infinity"):0===r?t.push("0"):t.push(r.toString(16));this.update(o(t.join("")))}updateIntArray(e){const t=Int32Array.from(e);this.update(new Uint8Array(t.buffer))}updateUint8Array(e){this.update(Uint8Array.from(e))}updateWithString(e){return this.update(o(e))}update(e){return this._bufs.push(e),this._totallen+=e.length,this}digest(){const e=new Uint8Array(this._totallen);let t=0;for(const r of this._bufs)e.set(r,t),t+=r.length;return this.init(),this._xxHash32(e,this._seed)}_xxHash32(e,o=0){const a=e;let l=o+n&4294967295,c=0;if(a.length>=16){const i=[o+t+r&4294967295,o+r&4294967295,o+0&4294967295,o-t&4294967295],s=e,n=s.length-16;let a=0;for(c=0;(4294967280&c)<=n;c+=4){const e=c,n=s[e]+(s[e+1]<<8),o=s[e+2]+(s[e+3]<<8),l=n*r+(o*r<<16);let u=i[a]+l&4294967295;u=u<<13|u>>>19;const d=65535&u,h=u>>>16;i[a]=d*t+(h*t<<16)&4294967295,a=a+1&3}l=(i[0]<<1|i[0]>>>31)+(i[1]<<7|i[1]>>>25)+(i[2]<<12|i[2]>>>20)+(i[3]<<18|i[3]>>>14)&4294967295}l=l+e.length&4294967295;const u=e.length-4;for(;c<=u;c+=4){const e=c,t=a[e]+(a[e+1]<<8),r=a[e+2]+(a[e+3]<<8);l=l+(t*i+(r*i<<16))&4294967295,l=l<<17|l>>>15,l=(65535&l)*s+((l>>>16)*s<<16)&4294967295}for(;c<a.length;++c)l+=a[c]*n,l=l<<11|l>>>21,l=(65535&l)*t+((l>>>16)*t<<16)&4294967295;return l^=l>>>15,l=((65535&l)*r&4294967295)+((l>>>16)*r<<16),l^=l>>>13,l=((65535&l)*i&4294967295)+((l>>>16)*i<<16),l^=l>>>16,l<0?l+4294967296:l}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/renderers/support/renderingInfoUtils":function(){define(["exports","../../Color","./RenderingInfo","../visualVariables/support/visualVariableUtils"],function(e,t,r,i){"use strict";async function s(e,t){return null!=e.symbol?e.symbol:t?.renderer?.getSymbolAsync(e,t)??null}e.getDriverAxisSizeValue=function(e,t=0){const r=e[t];return"number"==typeof r&&isFinite(r)?r:null},e.getDriverAxisSizeValueAny=function(e){for(let t=0;t<3;t++){const r=e[t];if("number"==typeof r)return isFinite(r)?r:0}return 0},e.getRenderingInfo=function(e,t){const s=function(e,t){if(null!=e.symbol)return e.symbol;const r=t?.renderer;return null!=r&&"dot-density"!==r.type?r.getSymbol(e,t):null}(e,t);if(null==s)return null;const n=t?.renderer,o=new r.RenderingInfo(n,s);if(null==n||!("visualVariables"in n)||!n.visualVariables)return o;const a=i.getVisualVariableValues(n,e,t)??[],l=["proportional","proportional","proportional"];for(const{variable:e,value:t}of a)if(null!=t||"size"===e.type&&e.useSymbolValue)switch(e.type){case"color":o.color=t?.toRgba();break;case"size":if("outline"===e.target)o.outlineSize=t;else{const r=e.axis,i=e.useSymbolValue?"symbol-value":t??"proportional";switch(r){case"width":l[0]=i;break;case"depth":l[1]=i;break;case"height":l[2]=i;break;case"width-and-depth":l[0]=l[1]=i;break;default:l[0]=l[1]=l[2]=i}}break;case"opacity":o.opacity=t;break;case"rotation":switch(e.axis){case"tilt":o.tilt=t;break;case"roll":o.roll=t;break;default:o.heading=t}}return"proportional"===l[0]&&"proportional"===l[1]&&"proportional"===l[2]||(o.size=l),o},e.getRenderingInfoAsync=async function(e,n){const o=await s(e,n);if(!o)return null;const a=n?.renderer,l=new r.RenderingInfo(a,o);if(!a||!("visualVariables"in a)||!a.visualVariables)return l;const c=i.getVisualVariableValues(a,e,n)??[],u=["proportional","proportional","proportional"];for(const{variable:e,value:r}of c)if("color"===e.type)l.color=t.toUnitRGBA(r);else if("size"===e.type)if("outline"===e.target)l.outlineSize=r;else{const t=e.axis,i=e.useSymbolValue?"symbol-value":r;"width"===t?u[0]=i:"depth"===t?u[1]=i:"height"===t?u[2]=i:u[0]=u[1]="width-and-depth"===t?i:u[2]=i}else"opacity"===e.type?l.opacity=r:"rotation"===e.type&&"tilt"===e.axis?l.tilt=r:"rotation"===e.type&&"roll"===e.axis?l.roll=r:"rotation"===e.type&&(l.heading=r);return(isFinite(u[0])||isFinite(u[1])||isFinite(u[2]))&&(l.size=u),l},e.getSymbolAsync=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/DisplayFeatureLimit":function(){define(["exports"],function(e){"use strict";e.DisplayFeatureLimit=class{constructor(e,t,r){this.maximumTotalNumberOfVertices=e,this.maximumNumberOfFeatures=t,this.averageSymbolComplexity=r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DCore":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/has","../../../../core/Error","../../../../core/Logger","../../../../core/MapUtils","../../../../core/maybe","../../../../core/MemCache","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/scheduling","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/accessorSupport/diffUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Extent","../../../../geometry/Point","../../../../geometry/projectionUtils","../../../../geometry/projection/projectBuffer","../../../../geometry/projection/projectVectorToVector","../../../../geometry/projection/projectXYZToVector","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/Layer","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/hydratedFeatures","../../../../layers/support/PromiseQueue","../../../../renderers/UniqueValueRenderer","../../../../renderers/support/rendererConversion","../../../../renderers/support/RenderingInfo","../../../../support/basemapUtils","../../../../support/loadArcade","../../../../symbols/LabelSymbol3D","../../../../symbols/TextSymbol","../../../../symbols/WebStyleSymbol","../../../../symbols/support/defaults3D","../../../../symbols/support/symbolConversion","./defaultSymbolComplexity","./DisplayFeatureLimit","./ElevationQuery","./featureExpressionInfoUtils","./Graphics3DFeatureStore","./Graphics3DGraphicCreationContext","./Graphics3DSymbolCreationContext","./Graphics3DSymbolFactory","./Graphics3DWebStyleSymbol","./GraphicsCorePerformanceInfo","./GraphicStateTracking","./graphicUtils","./SpatialIndex2D","../support/StageLayerElevationProvider","../../support/extentUtils","../../webgl-engine/lib/GridLocalOriginFactory","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/lib/WebGLLayer","../../../layers/support/popupUtils","../../../support/PropertiesPool","../../../support/Scheduler","../../../support/TextureCompressionTracker","../../../support/Yield","../../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V,U,B,N,k,z,j,G,q,H,W,$,Q,Z,Y,X,J,K,ee,te,re,ie,se,ne,oe,ae,le,ce,ue,de){"use strict";var he;const pe=_.create(),fe=C.create();e.Graphics3DCore=class extends r{static{he=this}static{this.tmpVec=_.create()}get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new ee.SpatialIndex2D({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get deconflictor(){return this._deconflictor}get labeler(){return this._labeler}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return null!=this.currentRenderer&&"dictionary"===this.currentRenderer.type?0:this._forcedUpdatePolicy??this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return!!(this.dataUpdating||this._elevationAlignment?.updating||this._scaleVisibility?.updating||this._filterVisibility?.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this._updateQueue.updating||this.readyToRun)}get dataUpdating(){return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||this._spatialIndex?.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.updating||this._loadingSymbols>0||this.compressionTracker.compressing)}get readyToRun(){return this._pendingUpdates.size>0||!!this._spatialIndex?.updating||this._dataUpdateQueue.readyToRun||this._updateQueue.readyToRun}get suspendedOrOutsideOfView(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){const e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?.graphics3D.minTotalNumberOfFeatures??0,r=e?.graphics3D.maxTotalNumberOfFeatures??0,i=e?.graphics3D.maxNumberOfDrawCalls??0,s=e?.graphics3D.maxTotalNumberOfVertices??0,n=this.averageSymbolComplexity,o=Math.max(1,n?.verticesPerFeature??1),a=n&&n.drawCallsPerFeature>0&&i>0?i/n.drawCallsPerFeature:r,l=Math.ceil(s/o),c=Math.max(t,Math.min(r,l,a)),u=this._get("displayFeatureLimit");return u&&u.maximumTotalNumberOfVertices===s&&u.averageSymbolComplexity===n&&u.maximumNumberOfFeatures===c?u:new G.DisplayFeatureLimit(s,c,n)}get averageSymbolComplexity(){const e=j.averageSymbolComplexities(this._symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||null!=t&&(e.estimated&&(t.verticesPerFeature>=e.verticesPerFeature||t.verticesPerCoordinate>=e.verticesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.verticesPerFeature===e.verticesPerFeature&&t.verticesPerCoordinate===e.verticesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get usedMemory(){const e=this.labelsEnabled?(this.averageSymbolComplexity?.memory.bytesPerFeatureLabel??0)*this._numberOfGraphics:0,t=this._getSymbolComplexitiesUsed().reduce((e,t)=>e+t.memory.resourceBytes,0);if(null==this._symbolMaterials){this._symbolMaterials=[];for(const e of this._symbols.values())if(null!=e)for(const t of e.symbolLayers)if(t)for(const e of t.materials)e&&this._symbolMaterials.push(e)}const r=this.owner.view.stage.renderer,i=this.owner.view.basemapTerrain.overlayManager.renderer,s=this._symbolMaterials.reduce((e,t)=>e+((r.getMaterialRenderer(t)||i.getMaterialRenderer(t))?.usedMemory??0),0);return this._usedMemory+e+t+s}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){const e=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*e}if(null!=this.averageSymbolComplexity){const e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(e){const t=e;if("web-style"===t.type)return t.clone();const r=this._symbolConversionCache.get(t.id);if(null!=r)return r;const i=z.to3D(t,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(t),cimFallbackEnabled:!0}),s=i.symbol||null;return null==s&&i.error&&o.getLogger(this).error(i.error.message),this._symbolConversionCache.set(t.id,s),s}_getSymbolComplexitiesUsedOrRenderer(e){if(null==e)return[];const t=e.symbols,r="backgroundFillSymbol"in e?e.backgroundFillSymbol:null;if(!r&&!t.length)return[];const i=[],s=this._getSymbolComplexityUsedOrRenderer(r);null!=s&&i.push(s);for(const e of t){const t=this._getSymbolComplexityUsedOrRenderer(e);null!=t&&i.push(t)}return i}_getSymbolComplexityUsedOrRenderer(e){if(null==e)return null;const t=this._symbols.get(e.id);if(null!=t)return t.complexity;const r=this._getConvertedSymbol(e);return null!=r?j.defaultSymbolComplexity(r):null}_getSymbolComplexitiesUsed(){const e=[];return this._symbols.forEach(t=>{null!=t&&e.push(t.complexity)}),e}get _objectIdField(){return this.layer.objectIdField}constructor(e){super(e),this._propertiesPool=new ae.PropertiesPool({computedExtent:b},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=le.ImmediateTask,this._dataUpdateQueue=new F.PromiseQueue,this._updateQueue=new F.PromiseQueue,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._elevationAlignment=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._sharedSymbolResourcesOwnerHandle=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this.compressionTracker=new ce.TextureCompressionTracker,this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new u,this.preferredUpdatePolicy=1,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=e.owner.view.resourceController.memoryController.newCache("graphics-3d-unused-symbols",e=>e.destroy()),this.symbolCreationContext=new Q.Graphics3DSymbolCreationContext(e.owner.view.resourceController.scheduler,(e,t)=>this._updateQueue.push(e,t),e.owner.layerViewUid,this.compressionTracker)}initialize(){this._featureStore=new W.Graphics3DFeatureStore({objectIdField:this.owner.layer?.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:e=>this.graphics3DGraphics.forEach(e)});const e=(e,t,r)=>this.spatialIndex.queryGraphicUIDsInExtent(e,t,r),{componentFactories:t}=this;this._elevationAlignment=t.elevationAlignment?.(this,e),this._scaleVisibility=t.scaleVisibility?.(this,e),this._filterVisibility=t.filterVisibility?.({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:e=>this.modifyGraphics3DGraphicVisibilities(t=>t.setVisibilityFlag(1,4,e(O.getObjectId(t.graphic,this._objectIdField)))),setAllFeaturesVisibility:e=>this.modifyGraphics3DGraphicVisibilities(t=>t.setVisibilityFlag(1,4,e)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,4,!0))}),this._deconflictor=t.deconflictor?.(this),this._labeler=t.labeler?.(this,this._scaleVisibility),this._objectStates=t.objectStates?.(this),this._initializeAbortController=new AbortController,this.addHandles(h.when(()=>this.owner.view.state.highlights,()=>{const{highlightOrderMap:e}=this.owner.view.state;this.graphics3DGraphics.forEach(t=>t.updateHighlights(e))})),this._initializePromise=this._initializeAsync()}async _initializeAsync(){const e=this._initializeAbortController?.signal,t=this.owner.view;this._viewElevationProvider=new q.ViewElevationProvider(this._viewSpatialReference,t),this._initializeStage(t,this.owner.layerViewUid);const r=t.sharedSymbolResources;this.symbolCreationContext.sharedResources=r,this._sharedSymbolResourcesOwnerHandle=r.addGraphicsOwner(this.owner),null!=this.currentRenderer&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=r.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=t.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new ie.GridLocalOriginFactory(t.renderSpatialReference),this.symbolCreationContext.elevationProvider=t.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);const i=H.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await H.createContext(i,this._viewSpatialReference,e,o.getLogger(this)),d.throwIfAborted(e),this.symbolCreationContext.screenSizePerspectiveEnabled=t.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,"drapeSourceType"in this.owner){const{owner:e}=this;this.symbolCreationContext.drapeSourceRenderer=t.basemapTerrain.overlayManager.registerGeometryDrapeSource(e)}this.addHandles([h.watch(()=>this.suspendedOrOutsideOfView,()=>this._updateQueue.unshift(()=>this._updateLayerVisibility(),null).catch(d.ignoreAbortErrors)),h.watch(()=>[this.layer?.screenSizePerspectiveEnabled,this.owner.view?.screenSizePerspectiveEnabled],()=>{const e=t.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,this._labeler?.reset(),this.recreateAllGraphicsAndSymbols())}),h.watch(()=>this.owner.slicePlaneEnabled,e=>this._slicePlaneEnabledChange(!!e)),h.watch(()=>this.owner.view.state?.rasterPixelRatio,()=>this._pixelRatioChange()),h.watch(()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,e=>this._physicalBasedRenderingChange(e)),h.watch(()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,e=>this._skipHighSymbolLoDsChange(e)),h.watch(()=>this.owner.view.focusAreasView?.polygons,()=>this._updateFocusedLabels()),h.watch(()=>this.owner.view.map?.focusAreas.style,()=>this.recreateAllGraphicsAndSymbols()),h.when(()=>t.basemapTerrain?.tilingScheme,e=>{if(e.spatialReference.equals(this.symbolCreationContext.overlaySR)||null==t.basemapTerrain.spatialReference||(this.symbolCreationContext.overlaySR=t.basemapTerrain.spatialReference),this.hasHandles("loaded-graphics"))this.recreateAllGraphics();else{const e=()=>this.owner?.loadedGraphics;this.addHandles([h.on(e,"change",e=>{this._graphicsCollectionChanged(e),this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}},{initial:!0}),h.watch(()=>this.effectiveUpdatePolicy,e=>{null!=this.stageLayer&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=0===this.effectiveUpdatePolicy,1===e&&this.runTask(le.noBudget)},h.syncAndInitial)]),this._frameTaskHandle=t.resourceController.scheduler.registerTask(le.TaskPriority.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this.addHandles(h.watch(()=>this.layer.featureReduction,()=>this._deconflictor?.featureReductionChange())),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch(()=>{}),this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController=l.abortMaybe(this._initializeAbortController)}_updateFocusedLabels(){this.forEachGraphics3DSymbol((e,t)=>{t&&e.updateFocus(({graphic:e})=>this.recreateGraphics([e]),t)})}destroy(){if(this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._rendererChangeAbortController=l.abortMaybe(this._rendererChangeAbortController),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=le.ImmediateTask,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),this._deconflictor=l.removeMaybe(this._deconflictor),this._labeler=l.removeMaybe(this._labeler),this._elevationAlignment=l.destroyMaybe(this._elevationAlignment),this._scaleVisibility=l.destroyMaybe(this._scaleVisibility),this._filterVisibility=l.destroyMaybe(this._filterVisibility),this._objectStates=l.destroyMaybe(this._objectStates),this.clear(),"drapeSourceType"in this.owner){const{owner:e}=this;this.stage.view.basemapTerrain.overlayManager.unregisterDrapeSource(e)}this._featureStore=l.destroyMaybe(this._featureStore),this._updatingPendingLoadedGraphicsChange=l.removeMaybe(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=l.destroyMaybe(this._graphicStateTracking),this.stage&&(this.stageLayer=l.destroyMaybe(this.stageLayer),this.stage=null),this._set("owner",null);for(const e in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[e].reject(new n("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=l.removeMaybe(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=l.destroyMaybe(this._propertiesPool),this._whenSymbolRemoved.prune(),this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=l.destroyMaybe(this._spatialIndex),this._symbolMaterials=null}clear(){this._objectStates?.allGraphicsDeleted(),null!=this._graphicStateTracking&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach(e=>e.destroy()),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(l.destroyMaybe),this._symbols.clear(),this._symbolMaterials&&(this._symbolMaterials.length=0,this._symbolMaterials=null),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("dataUpdating"),this.notifyChange("readyToRun"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed"),this.owner.notifyContentGeometryUpdate?.()}_initializeStage(e,t){this.stage=e.stage,this.stageLayer=new ne.WebGLLayer(this.stage,{visible:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t);const r=this.stageLayer.events;r.on("transformationChanged",e=>this.notifyGraphicGeometryChanged(e.graphicUid)),r.on("shaderTransformationChanged",e=>this.notifyGraphicGeometryChanged(e.graphicUid)),r.on("visibilityChanged",e=>this.notifyGraphicVisibilityChanged(e.graphicUid)),r.on("geometryAdded",e=>this.notifyGraphicGeometryChanged(e.object.graphicUid)),r.on("geometryRemoved",e=>this.notifyGraphicGeometryChanged(e.object.graphicUid)),r.on("attributesChanged",e=>se.affectsGeometry(e.attribute)&&this.notifyGraphicGeometryChanged(e.object.graphicUid))}notifyGraphicGeometryChanged(e){if(null==this._graphicStateTracking||null==e)return;const t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicGeometry(t)}notifyGraphicVisibilityChanged(e){if(null==this._graphicStateTracking||null==e)return;const t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicVisibility(t)}_updateLayerVisibility(){const e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this._numberOfGraphics>e*ge,r=!this.suspendedOrOutsideOfView&&!t;r!==this._visible&&(this._visible=r,this._updateStageLayerVisibility())}_updateStageLayerVisibility(){const e=this._visible&&(null==this.layer.opacity||this.layer.opacity>=de.alphaCutoff);this.stageLayer.visible!==e&&(this.stageLayer.visible=e,e?this.updateGraphicsVisibilities():this._hideAllGraphics(),this.owner.notifyContentGeometryUpdate?.())}getGraphics3DGraphicById(e){return null!=e?this.graphics3DGraphics.get(e):void 0}getGraphics3DGraphicByObjectId(e){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e,t=this.owner.layer?.objectIdField){return O.getObjectId(e,t)}get graphics3DGraphicsByObjectID(){const e=this.owner.layer?.objectIdField;if(!e)return;const t=new Map;return this.graphics3DGraphics.forEach(r=>{if(!r)return;const i=r.graphic,s=this._getGraphicObjectID(i,e);null!=s&&t.set(s,r)}),t}get labelsEnabled(){return!!this._labeler?.layerLabelsEnabled()}async updateLabelingInfo(e){const t=this._deconflictor?.labelingInfoChange(e),r=this._labeler?.labelingInfoChange(e);await Promise.allSettled([t,r])}updateVisibilityInfo(){this._deconflictor?.labelingInfoChange(),this._labeler?.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return"unknown";let e=!1,t=!1;for(const[r,i]of this._symbols)if(null!=i)switch(i.getFastUpdateStatus()){case 3:return"unknown";case 1:this._graphicsBySymbol.has(r)&&(t=!0);break;case 0:this._graphicsBySymbol.has(r)&&(e=!0);break;case 2:this._graphicsBySymbol.has(r)&&(t=e=!0)}return t?e?"mixed":"fast":e?"slow":"mixed"}runTask(e){if(this._dataUpdateQueue.runTask(e),this._updateQueue.runTask(e),this._applyPendingUpdates(e),this.notifyChange("readyToRun"),this.readyToRun||this.notifyChange("dataUpdating"),this.notifyChange("updatingRemaining"),!e.hasProgressed)return ue.Yield}setObjectIdVisibility(e,t){t?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);const r=this._findGraphics3DGraphicByObjectId(e);null!=r&&this._updateUserVisibility(r)}_findGraphics3DGraphicByObjectId(e){return a.findInMap(this.graphics3DGraphics,t=>this._getGraphicObjectID(t.graphic)===e)}_updateUserVisibility(e){if(null==e)return!1;const t=e.graphic,r=this._getGraphicObjectID(t),i=t.visible&&!this.owner.suspended&&this.stageLayer.visible&&(null==r||!this._objectIdInvisibleSet.has(r));return e.setVisibilityFlag(1,1,i)}_whenGraphics3DGraphic(e){const t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);const r=this._whenGraphics3DGraphicRequests[e.uid];if(r)return r.promise;const i=d.createResolver();return this._whenGraphics3DGraphicRequests[e.uid]=i,i.promise}async _boundsForGraphics3DGraphic(e,t){const r=this._viewSpatialReference,i=this.owner.view.renderSpatialReference,s=this.owner.view.basemapTerrain.spatialReference,n=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:null!=t&&!!t.useViewElevation,minDemResolution:null!=t?t.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,o=await e.getProjectedBoundingBox((e,t,s)=>x.projectBuffer(e,i,t,e,r,t,s),(e,t,i)=>x.projectBuffer(e,s,t,e,r,t,i),n,t?.signal);if(!o)return null;const a=o.boundingBox;if(o.requiresDrapedElevation){const e=this.symbolCreationContext.elevationProvider;if(e){C.center(a,pe);const t=e.getElevation(pe[0],pe[1],0,r,"ground")??0;a[2]=Math.min(a[2],t),a[5]=Math.max(a[5],t)}}return{boundingBox:a,screenSpaceObjects:o.screenSpaceObjects}}async whenGraphicBounds(e,t){await h.whenOnce(()=>this.owner?.loadedGraphics);const r=this.owner.layer?.objectIdField,i=this.owner.loadedGraphics.find(t=>t===e||null!=r&&null!=t.attributes&&e.attributes&&t.attributes[r]===e.attributes[r]);if(!i)throw new n("internal:graphic-not-part-of-view","Graphic is not part of this view");const s=await this._whenGraphics3DGraphic(i);return this._boundsForGraphics3DGraphic(s,t)}computeAttachmentOrigin(e,t){const r=this.graphics3DGraphics.get(e.uid);if(!r)return null;const i=r.computeAttachmentOrigin();if(0===i.render.num&&0===i.draped.num)return null;y.set(ye,0,0,0);let s=0;if(i.render.num>0){if(!S.projectVectorToVector(i.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,_e,t))return null;y.add(ye,ye,_e),s++}if(i.draped.num>0){const[e,r]=i.draped.origin,n=this._viewElevationProvider.getElevation(e,r,"ground")??0;if(y.set(_e,e,r,n),!S.projectVectorToVector(_e,this._viewElevationProvider.spatialReference,_e,t))return null;y.add(ye,ye,_e),s++}return s>1&&y.scale(ye,ye,1/s),new v({x:ye[0],y:ye[1],z:ye[2],spatialReference:t})}getSymbolLayerSize(e,t){const r=this._symbols.get(e.id);if(null==r)throw new n("internal:symbol-not-part-of-view","Symbol is not part of this view");const i=e.symbolLayers.indexOf(t);if(-1===i)throw new n("internal:missing-symbol-layer","Symbol layer is not in symbol");const s=r.getSymbolLayerSize(i);if(null==s)throw new n("internal:missing-size","Symbol layer has no valid size");return s}_graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}graphicUpdateHandler(e){const t=e.graphic.uid,r=this.graphics3DGraphics.get(t);if(null!=r||null!=this._graphicsWithoutSymbol.get(t)){switch(e.property){case"visible":this._graphicUpdateVisibleHandler(r);break;case"geometry":this._graphicUpdateGeometryHandler(r,e);break;case"symbol":this._graphicUpdateSymbolHandler(r,e);break;case"attributes":case"popupTemplate":break;case"origin-transform":this._graphicUpdateTransformHandler(r,e)}this.owner.notifyContentGeometryUpdate?.()}}_graphicUpdateGeometryHandler(e,t){this._graphicUpdateGeometryOrTransformHandler(e,t,()=>!(null==t.newValue||null==e||!e.graphics3DSymbol.updateGeometry(e,t.newValue)||!(this._labeler?.updateGraphicGeometry(e)??1)||(this._labeler?.setDirty(),0)));const r=t.graphic.geometry;null!=r&&this._expandComputedExtent(r)}_graphicUpdateTransformHandler(e,t){const r=t.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(e,t,()=>null!=t.newValue&&null!=e&&null!=r&&e.graphics3DSymbol.updateTransform(e,r.spatialReference,t.newValue,t.action))}_graphicUpdateGeometryOrTransformHandler(e,t,r){if(null!=t.graphic.geometry){if(null==e){const e=t.graphic.symbol?.id;if(e){const t=this._symbols.get(e);if(null!=t&&0===t.loadStatus)return}return void this._recreateGraphic(t.graphic)}r()||this._recreateGraphic(e.graphic)}else this._recreateGraphic(t.graphic)}_graphicUpdateSymbolHandler(e,t){const r=t.graphic,i=null!=e?e.graphics3DSymbol:null!=t.oldValue?this._symbols.get(t.oldValue.id):null;if(null==i||null==t.newValue)return void this._recreateGraphic(r);const s=i.symbol,n=this._getConvertedSymbol(t.newValue);if(null!=n&&(n.type!==s.type||"web-style"===n.type)||"web-style"===s.type)return void this._recreateGraphic(r);const o=this._graphicsBySymbol.get(s.id);if(o&&1!==o.size)return void this._recreateGraphic(r);const a=g.diff(s,n);if(null==a)return void this._updateSymbolMapping(s.id,n);const l={diff:a,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(i.prepareSymbolPatch(l),!g.isEmpty(l.diff))return void this._recreateGraphic(r);const c=this._getRenderingInfo(r,!1);if(null==c)return void this._recreateGraphic(r);const u=i.extentPadding;for(const e of l.symbolStatePatches)e();if(u!==i.extentPadding&&this._recomputeExtentPadding(),null!=e)for(const t of l.graphics3DGraphicPatches)t(e,c);this._updateSymbolMapping(s.id,n)}_graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}recreateGraphics(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,1===this.effectiveUpdatePolicy&&this._cleanupSymbols()}_recreateGraphic(e){this.recreateGraphics([e])}_beginGraphicUpdate(e){const t=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,t),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("dataUpdating"),t}_endGraphicUpdate(e,t){e&&(t&&this._graphicStateTracking?.updateGraphicError(e,t),this._graphicsWaitingForSymbol.delete(e.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating")))}_recomputeExtentPadding(){let e=0;this._symbols.forEach(t=>{null!=t&&(e=Math.max(e,t.extentPadding))}),this._set("extentPadding",e)}_expandComputedExtent(e){const t=fe,r=e.spatialReference;O.computeAABB(e,t);const i=this._viewSpatialReference,s=he.tmpVec;if(M.equals(r,i)||T.projectXYZToVector(t[0],t[1],0,r,s,i)&&(t[0]=s[0],t[1]=s[1],T.projectXYZToVector(t[3],t[4],0,r,s,i),t[3]=s[0],t[4]=s[1]),!(isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])))return;const n=this.computedExtent;let o=null;const a=isFinite(t[2])&&isFinite(t[5]),l=a&&(null==n?.zmin||t[2]<n.zmin),c=a&&(null==n?.zmax||t[5]>n.zmax);n?(t[0]<n.xmin||t[1]<n.ymin||t[3]>n.xmax||t[4]>n.ymax||l||c)&&(o=this._propertiesPool.get("computedExtent"),o.xmin=Math.min(t[0],n.xmin),o.ymin=Math.min(t[1],n.ymin),o.xmax=Math.max(t[3],n.xmax),o.ymax=Math.max(t[4],n.ymax),o.spatialReference=i):(o=this._propertiesPool.get("computedExtent"),o.xmin=t[0],o.ymin=t[1],o.xmax=t[3],o.ymax=t[4],o.spatialReference=i),o&&(l&&(o.zmin=t[2]),c&&(o.zmax=t[5]),this._set("computedExtent",o))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}async elevationInfoChange(){this._abortElevationInfoChange();const e=new AbortController;this._elevationInfoChangeAbortController=e;const t=H.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await H.createContext(t,this._viewSpatialReference,e.signal,o.getLogger(this)),d.throwIfAborted(e.signal),this._elevationInfoChangeAbortController=null,this._labeler?.elevationInfoChange(),this.forEachGraphics3DSymbol((e,t,r)=>{e.globalPropertyChanged("elevationInfo",t)?t?.forEach(e=>{const t=e.graphic,r=e.labelLayers;for(const e of r)e.graphics3DSymbolLayer.updateGraphicElevationContext(t,e)}):this._recreateSymbol(r)}),this.updateStageLayerElevationProvider(),this._elevationAlignment?.elevationInfoChange()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=l.disposeMaybe(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new te.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){this.clear(),null!=this._filterVisibility&&this._filterVisibility.clear(),this._labeler?.reset(),this._deconflictor?.clear(),this._elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=l.disposeMaybe(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(e=!1){if(!this._startCreateGraphics)return;const{loadedGraphics:t,view:r}=this.owner,i=r.basemapTerrain?.tilingScheme&&t?.length?t.toArray():null;!e&&i||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),i&&(e?this.add(i):this.recreateGraphics(i))}_recreateSymbol(e){const t=this._graphicsBySymbol.get(e),r=[];t&&(t.forEach((e,t)=>{const i=e.usedMemory;this._conditionalRemove(e,t),this._spatialIndex?.remove(e),r.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(t,i),this._updateLayerVisibility(),this._featureStore.events.emit("changed"),this.owner.notifyContentGeometryUpdate?.()}),this._graphicsBySymbol.set(e,new Map));const i=this._symbols.get(e);l.destroyMaybe(i),this._symbols.delete(e),this._symbolMaterials=null,l.destroyMaybe(this._unusedSymbolsCache.pop(e)),this.add(r)}_recreateGraphicsForSymbol(e){const t=this._graphicsBySymbol.get(e);if(t){const e=[];t.forEach(t=>e.push(t.graphic)),this.recreateGraphics(e)}}_conditionalRemove(e,t){this._graphicsDrapedUids.delete(t),this._objectStates?.removeGraphic(e),this._labeler?.removeGraphic(e),this._deconflictor?.removeGraphic(e),null!=this._graphicStateTracking&&this._graphicStateTracking.removeGraphic(e)}add(e){e&&0!==e.length&&(this.owner.view.basemapTerrain?.tilingScheme?(0===this._updatePolicyForGraphics(e)?this._addDelayed(e):this._addImmediate(e),this.notifyChange("dataUpdating")):o.getLogger(this).error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(e){if(1===this.effectiveUpdatePolicy&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const t of e)if(null!=t.geometry&&"mesh"===t.geometry.type&&!t.geometry.loaded)return 0;return this.effectiveUpdatePolicy}_addImmediate(e){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(const t of e)this._addGraphic(t,this._getRenderingInfo(t),1);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_addDelayed(e){for(const t of e){const e=t.uid;let r=this._pendingUpdates.get(e);r?r.add?0!==r.state&&r.abortController?.abort():this._pendingAdds++:(r=new me,this._pendingAdds++,this._pendingUpdates.set(e,r)),r.add=t}this.notifyChange("readyToRun"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}remove(e){0===this.effectiveUpdatePolicy?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("dataUpdating")}_removeImmediate(e){for(const t of e)this._removeGraphic(t);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_removeDelayed(e){for(const t of e){const e=t.uid,r=this._pendingUpdates.get(e);if(r)r.add&&(r.remove?r.add=null:this._pendingUpdates.delete(e),1===r.state&&r.abortController?.abort(),this._pendingAdds--);else{const r=new me;r.remove=t,this._pendingUpdates.set(e,r),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("readyToRun"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}_finishPendingUpdates(){this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&o.getLogger(this).warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyPendingUpdates(e){if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&this._spatialIndex?.updating)return this._spatialIndex.update(),void e.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const[t,r]of this._pendingUpdates){if(e.done){this._applyPendingRemovesFirst=!0;break}if(r.remove&&!r.add&&(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(r.remove),r.remove=null,this._pendingUpdates.delete(t),0===this._pendingRemoves))break}}for(const[t,r]of this._pendingUpdates){if(e.done)break;r.add&&0===r.state&&this._processPendingUpdateNew(r);let i=this.effectiveUpdatePolicy;if(!r.remove||r.add&&2!==r.state||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(r.remove),r.remove=null,i=1),r.add)switch(r.state){case 2:this._addGraphic(r.add,r.renderingInfo,i),r.add=null,this._pendingAdds--,e.madeProgress();break;case 3:r.add=null,this._pendingAdds--}null==r.remove&&null==r.add&&this._pendingUpdates.delete(t)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("readyToRun"),this.notifyChange("dataUpdating"))}_processPendingUpdateNew(e){if(!e.add)return void(e.state=2);const t=e.add.geometry;null==t||"mesh"!==t.type||t.loaded?this._processPendingUpdateNewRenderingInfo(e):this._processPendingUpdateNewMesh(e,t)}async _processPendingUpdateNewMesh(e,t){e.state=1,e.abortController=new AbortController;const r=e.abortController.signal;try{await t.load({signal:r})}catch(t){return this._processPendingUpdateNewError(e,t)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}_processPendingUpdateNewError(e,t){e.abortController=null,d.isAbortError(t)?e.state=0:e.state=3}async _processPendingUpdateNewRenderingInfo(e){if(null==this.layer.renderer||"dictionary"!==this.layer.renderer.type)return e.renderingInfo=this._getRenderingInfo(e.add),void(e.state=2);e.state=1,e.abortController=new AbortController;let t=null;try{t=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal})}catch(t){return e.abortController=null,void(d.isAbortError(t)?e.state=0:e.state=3)}null==t?.symbol?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,o.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=t,e.state=2}_addGraphic(e,t,r){if(this._graphicsWithoutSymbol.set(e.uid,e),null==t?.symbol||!O.hasGeometry(e))return;const i=this.stage.renderView.olidRenderHelper;if(i&&this.setUidToIdOnAdd){const t=L.isBasemapLayerView(this.owner.view,this.owner.layerViewUid);i.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.owner.layerViewUid,!!this.layer.popupEnabled&&!t&&oe.hasPopupTemplate(this.layer,this.owner.view.popup?.defaultPopupTemplateEnabled))}const s=t.symbol,n=this.getOrCreateGraphics3DSymbol(s,t.renderer);if(null==n)return;this._expandComputedExtent(e.geometry);const o=this._beginGraphicUpdate(e),a=new $.Graphics3DGraphicCreationContext(e,t,this.layer);let l=!1;const c=e=>{e===n.symbol.id&&(l=!0)};this._whenSymbolRemoved.push(c);const u=()=>{if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(c),this._graphicsWaitingForSymbol.get(e.uid)!==o||l||n.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==n.symbol.id)--n.referenced,this._cleanupSymbols();else{const t=this._createGraphics3DGraphic(n,a);this._spatialIndex&&null!=t&&this._spatialIndex.add(t),--n.referenced,this._endGraphicUpdate(e)}this._featureStore.events.emit("changed"),this.owner.notifyContentGeometryUpdate?.(),this._labeler?.setDirty()}},h=t=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(c),l||(d.isAbortError(t)?this.add([e]):n.destroyed||this._endGraphicUpdate(e,t)))};++this._loadingSymbols,0===r?n.load(()=>this._dataUpdateQueue.push(u,null).catch(d.ignoreAbortErrors),e=>this._dataUpdateQueue.push(()=>h(e),null).catch(d.ignoreAbortErrors)):n.load(u,h)}_removeGraphic(e){const t=e.uid,r=this.graphics3DGraphics.get(t);if(r){r.graphics3DSymbol.onRemoveGraphic(r);const e=r.usedMemory,i=r.isElevationSource;this._conditionalRemove(r,t),this._spatialIndex?.remove(r);const s=r.graphics3DSymbol.symbol.id;this._graphicsBySymbol.get(s)?.delete(t),this._graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,e,i),r.destroy(),this._featureStore.events.emit("changed"),this.owner.notifyContentGeometryUpdate?.()}else this._graphicsWithoutSymbol.delete(t),this._graphicsWaitingForSymbol.delete(t),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating"))}_hasLabelingContext(e){if(e instanceof U||e instanceof B){const t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some(t=>t.symbol===e)}return!1}_hasValidSymbolCreationContext(e){return!(e instanceof U&&!this._hasLabelingContext(e)&&(o.getLogger(this).error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),1))}_getRenderingInfo(e,t=!0){const r=e.geometry;if(null==r)return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,o.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!w.canProjectWithoutEngine(r.spatialReference,this._viewSpatialReference))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,o.getLogger(this).warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&null!=e.symbol)return t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,o.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const i=this.rendererHasGeometryOperations?I.hydrateGraphic(e,this.layer):e;let s;if(this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||null!=this.currentRenderer))s=this.owner.getRenderingInfo(i,this.currentRenderer,this._arcadeOnDemand);else{const e=i.symbol||k.getDefaultSymbol3D(i.geometry);s=new E.RenderingInfo(null,e)}return null==s?.symbol?(t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,o.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):s}_getRenderingInfoAsync(e,t){if(null==e.geometry)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,o.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&null!=e.symbol)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,o.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?I.hydrateGraphic(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,this.currentRenderer,this._arcadeOnDemand,t)}_createGraphics3DSymbol(e,t){if(!this._hasValidSymbolCreationContext(e))return null;const r=this._getConvertedSymbol(e);if(!r)return null;let i;if(null!=t&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){const e=z.to3D(t.backgroundFillSymbol,{ignoreDrivers:!0});null!=e.symbol&&(i=e.symbol.symbolLayers)}const s=Z.make(r,this.symbolCreationContext,i);return s.load(()=>{const e=s.extentPadding;e>this.extentPadding&&this._set("extentPadding",e),this.notifyChange("averageSymbolComplexity")},()=>{}),s}getOrCreateGraphics3DSymbol(e,t){let r=this._symbols.get(e.id);if(void 0===r){const i=this._unusedSymbolsCache.pop(e.id);r=null!=i?i:e instanceof N?new Y.Graphics3DWebStyleSymbol(e,e=>this._dataUpdateQueue.push(e,null),e=>this._createGraphics3DSymbol(e,t)):this._createGraphics3DSymbol(e,t),this._symbols.set(e.id,r),this._symbolMaterials=null}return null!=r&&++r.referenced,r}trackGraphicState(e){return null==this._graphicStateTracking&&(this._graphicStateTracking=new J.GraphicStateTracking(this)),this._graphicStateTracking.add(e)}_addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(e,t,r=!1){this._usedMemory-=t,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,r&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(e,t){const{graphic:r}=t;if(this._graphicsWithoutSymbol.delete(r.uid),!this._symbols.has(e.symbol.id))return this.add([r]),null;if(this.graphics3DGraphics.has(r.uid))return null;const i=e.createGraphics3DGraphic(t);if(null==i)return null;this._addGraphics3DGraphic(i);const s=e.symbol.id;if(this._graphicsBySymbol.has(s)||this._graphicsBySymbol.set(s,new Map),this._graphicsBySymbol.get(s).set(r.uid,i),i.isDraped&&this._graphicsDrapedUids.add(r.uid),i.centroid=null,null!=r.geometry&&"point"!==r.geometry.type&&(i.centroid=K.computeCentroid(r.geometry,this._viewSpatialReference)),this._updateUserVisibility(i),null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(i),null!=this._filterVisibility){const{defaultVisibility:e}=this._filterVisibility;i.setVisibilityFlag(1,4,e),e||this._filterVisibility.reapply()}this._deconflictor?.addGraphic(i),this._labeler?.addGraphic(i),this._objectStates?.addGraphic(i),i.initialize(this.stageLayer),null!=this._graphicStateTracking&&this._graphicStateTracking.addGraphic(i);const n=this._whenGraphics3DGraphicRequests[r.uid];return n&&(delete this._whenGraphics3DGraphicRequests[r.uid],n.resolve(i)),this._symbolMaterials=null,i}async rendererChange(e){if(this._rendererChangeAbortController=l.abortMaybe(this._rendererChangeAbortController),e!==this.currentRenderer)if(this._validateRenderer(e),null==e&&this._currentRendererChange(null,!1),D.isSupportedRenderer3D(e))if(e?.arcadeRequired){const t=new AbortController;this._rendererChangeAbortController=t;const{arcadeUtils:r}=await this._ensureArcade();d.throwIfAborted(t);const i=r.hasGeometryOperations(e);i&&(await r.enableGeometryOperations(),d.throwIfAborted(t)),0===this.effectiveUpdatePolicy?await this._updateQueue.push(()=>this._currentRendererChange(e,i),t.signal):this._currentRendererChange(e,i),this._rendererChangeAbortController=null}else if(0===this.effectiveUpdatePolicy){const t=new AbortController;this._rendererChangeAbortController=t,await this._updateQueue.push(()=>this._currentRendererChange(e,!1),t.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1)}async _ensureArcade(){return null==this._arcadeOnDemand?(this._arcadeOnDemand=await V.loadArcade(),this._arcadeOnDemand):this._arcadeOnDemand}_currentRendererChange(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=this._arcadeOnDemand;const r=this.symbolCreationContext.renderer;if(e===r)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),null==e)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const i=g.diff(r,e);this._updateUnchangedSymbolMappings(i,e,r),this.symbolCreationContext.renderer=e,null!=i&&("complete"===i.type?this.recreateAllGraphicsAndSymbols():"partial"===i.type&&(this._applyRendererDiff(i,e,r)?this._labeler?.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}_diffHasSymbolChange(e){for(const t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}_applySymbolSetDiff(e,t,r){e=e||[],t=t||[];const i=[];for(const s of t){const t=this._graphicsBySymbol.get(s.id);t&&t.forEach((n,o)=>{const a=n.graphic,l=this.layer instanceof R?this.layer:null,c=this._arcadeOnDemand;if(s===r.defaultSymbol&&r.getSymbol(I.hydrateGraphic(a,l),{arcade:c})===r.defaultSymbol)return;const u=n.usedMemory;e.length||r.defaultSymbol?i.push(a):this._graphicsWithoutSymbol.set(o,a);const d=this.graphics3DGraphics.get(o);this._conditionalRemove(d,o),n.destroy(),t.delete(o),this._removeGraphics3DGraphic(o,u),this._updateLayerVisibility()}),this._whenSymbolRemoved.forAll(e=>e(s.id))}(e.length||i.length)&&(this._graphicsWithoutSymbol.forEach(e=>i.push(e)),this._graphicsWithoutSymbol.clear(),this.add(i)),this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_applyUniqueValueRendererDiff(e,t,r){const s=e.diff.defaultSymbol,n=e.diff.uniqueValueInfos;if(s||n){const o=n?.changed,a=n?.unchanged;if(o&&a&&o.some(e=>a.some(t=>t.oldValue.symbol?.id===e.oldValue.symbol?.id)))return!1;const l=n?n.added.map(e=>e.symbol).filter(i.isSome):[],c=n?n.removed.map(e=>e.symbol).filter(i.isSome):[];if(o)for(let e=0;e<o.length;e++)l.push(o[e].newValue.symbol),c.push(o[e].oldValue.symbol);return s?(r.defaultSymbol&&c.push(r.defaultSymbol),t.defaultSymbol&&l.push(t.defaultSymbol)):r.defaultSymbol&&l.length&&c.push(t.defaultSymbol),this._applySymbolSetDiff(l,c,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(e,t,r){if("unique-value"!==t?.type||"unique-value"!==r?.type||null!=e&&"partial"!==e.type)return[];const i=e=>null!=e?e.id:null,s=e&&e.diff,n=s?.defaultSymbol,o=s&&s.uniqueValueInfos;let a;if(o)a=o.unchanged.map(e=>({oldId:i(e.oldValue.symbol),newId:i(e.newValue.symbol)}));else{a=[];for(const e of r.uniqueValueInfos??[]){const r=i(e.symbol),s=t.uniqueValueInfos?.find(t=>t.value===e.value);s&&r!==i(s.symbol)&&a.push({oldId:r,newId:i(s.symbol)})}}return!n&&r.defaultSymbol&&a.push({oldId:i(r.defaultSymbol),newId:i(t.defaultSymbol)}),a}_updateSymbolMapping(e,t){const r=null!=t&&t?"string"==typeof t?t:t.id:null;if(null==e||e===r)return;const i=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),void 0!==i&&this._graphicsBySymbol.set(r,i);const s=this._symbols.get(e);if(void 0!==s&&(this._symbols.delete(e),this._symbols.set(r,s),this._symbolMaterials=null,null!=s)){const e="string"==typeof t?null:t;null!=e?s.symbol=e:s.symbol.id=r}}_updateUnchangedSymbolMappings(e,t,r){const i=this._calculateUnchangedSymbolMapping(e,t,r);for(const{oldId:e,newId:t}of i)this._updateSymbolMapping(e,t)}_applyRendererDiff(e,t,r){if(this._diffHasSymbolChange(e))return!1;if(t instanceof A&&r instanceof A&&this._applyUniqueValueRendererDiff(e,t,r)&&0===Object.keys(e.diff).length)return!0;for(const r of this._graphicsBySymbol.keys()){const i=this._symbols.get(r);if(null!=i)switch(i.applyRendererDiff(e,t)){case 0:this._recreateSymbol(r);break;case 1:this._recreateGraphicsForSymbol(r)}}return!0}opacityChange(){this._updateStageLayerVisibility(),this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged("opacity",t))}_slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.sliceable=e,this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged("slicePlaneEnabled",t)),this._deconflictor?.slicePlaneEnabledChange(),this._labeler?.slicePlaneEnabledChange())}_physicalBasedRenderingChange(e){this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol((e,t,r)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",t)||this._recreateSymbol(r)})}_skipHighSymbolLoDsChange(e){this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol((e,t,r)=>{e.globalPropertyChanged("skipHighSymbolLods",t)||this._recreateSymbol(r)})}_pixelRatioChange(){this.forEachGraphics3DSymbol((e,t,r)=>{e.globalPropertyChanged("pixelRatio",t)||this._recreateSymbol(r)})}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=p.schedule(()=>{this._updatingPendingLoadedGraphicsChange=null})}setClippingExtent(e,t){const r=this.symbolCreationContext.clippingExtent,i=P.create();return re.toBoundingRect(e,i,t)?this.symbolCreationContext.clippingExtent=C.fromRect(C.create(),i):this.symbolCreationContext.clippingExtent=null,!C.equals(this.symbolCreationContext.clippingExtent,r)}modifyGraphics3DGraphicVisibilities(e){if(this.destroyed)return;let t=!1;this.graphics3DGraphics.forEach(r=>{e(r)&&(t=!0)}),t&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}forEachGraphics3DSymbol(e,t){for(const[t,r]of this._symbols){if(null==r)return;e(r,this._graphicsBySymbol.get(t)||be,t)}if(!t?.excludeUnused)for(const t of this._unusedSymbolsCache)e(t,void 0,t.symbol.id)}updateGraphicsVisibilities(){null!=this._filterVisibility&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities(e=>{const t=this._updateUserVisibility(e),r=!!this._scaleVisibility?.updateVisibility(e);return t||r})}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,1,!1))}_validateRenderer(e){const t=()=>`'${this.layer.title?`${this.layer.title}, `:""}id:${this.layer.id}'`,r=D.validateTo3D(e,{geometryType:this.layer?.geometryType,logWarning:(e,r)=>o.getLogger(this).warn(e,`Symbology conversion for layer ${t()}: ${r}`)});if(r){const e=`Renderer for layer ${t} is not supported in a SceneView`;o.getLogger(this).warn(e,r.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let e=!1;this._symbols.forEach((t,r)=>{if(null==t||t.referenced>0)return;const i=this._graphicsBySymbol.get(r);i&&0!==i.size||(this._graphicsBySymbol.delete(r),this._symbols.delete(r),this._symbolMaterials=null,this._unusedSymbolsCache.put(r,t,c.MinPriority),e=!0)}),e&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}get test(){}get performanceInfo(){return new X.GraphicsCorePerformanceInfo(this.graphics3DGraphics.size,Array.from(this.graphics3DGraphics.values()).reduce((e,t)=>e+(t.isVisible()?1:0),0),this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}},t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"computedExtent",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"currentRenderer",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_frameTaskHandle",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_dataUpdateQueue",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_updateQueue",void 0),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"_viewSpatialReference",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_rendererChangeAbortController",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_elevationInfoChangeAbortController",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_initializeAbortController",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_elevationAlignment",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_scaleVisibility",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_filterVisibility",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_initializePromise",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_spatialIndex",void 0),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"extentPadding",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_updatingPendingLoadedGraphicsChange",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_featureStore",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_objectStates",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_loadingSymbols",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"compressionTracker",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"preferredUpdatePolicy",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_forcedUpdatePolicy",void 0),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"effectiveUpdatePolicy",null),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"elevationFeatureExpressionEnabled",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"owner",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"layer",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"graphicSymbolSupported",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"getRenderingInfoWithoutRenderer",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"componentFactories",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"setUidToIdOnAdd",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"featureStore",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"initializePromise",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"scaleVisibility",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"elevationAlignment",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"objectStates",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"filterVisibility",null),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"updating",null),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"dataUpdating",null),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"readyToRun",null),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"suspendedOrOutsideOfView",null),t.__decorate([f.property({readOnly:!0,dependsOn:[]})],e.Graphics3DCore.prototype,"updatingRemaining",null),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"displayFeatureLimit",null),t.__decorate([f.property({readOnly:!0,dependsOn:[]})],e.Graphics3DCore.prototype,"averageSymbolComplexity",null),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"hasZ",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"hasM",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_objectIdField",null),e.Graphics3DCore=he=t.__decorate([m.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],e.Graphics3DCore);class me{constructor(){this.add=null,this.renderingInfo=null,this.state=0,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=0,this.abortController=null,this.remove=null}}const ge=10,ye=_.create(),_e=_.create(),be=new Map;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/renderers/support/rendererConversion":function(){define(["exports","../../core/arrayUtils","../../core/has","../../core/Error","../../symbols/support/symbolConversion"],function(e,t,r,i,s){"use strict";function n(e){return null==e||"simple"===e.type||"unique-value"===e.type||"class-breaks"===e.type||"dictionary"===e.type||"heatmap"===e.type}function o(e,t){if(!t)return null;if(Array.isArray(t)||(t=[t]),t.length>0){const r=t.map(e=>e.details.symbol.type||e.details.symbol.declaredClass).filter(e=>!!e);r.sort();const s=new Array;return r.forEach((e,t)=>{0!==t&&e===r[t-1]||s.push(e)}),new i("renderer-conversion-3d:unsupported-symbols",`Renderer contains symbols (${s.join(", ")}) which are not supported in 3D`,{renderer:e,symbolErrors:t})}return null}e.isSupportedRenderer3D=n,e.validateTo3D=function(e,r){if(null==e)return null;if(!n(e))return new i("renderer-conversion-3d:unsupported-renderer",`Unsupported renderer of type '${e.type}'`,{renderer:e});switch(e.type){case"simple":return function(e,t){const r={...s.defaultTo3DOptions,...t,cimFallbackEnabled:!0};return o(e,s.to3D(e.symbol,r).error)}(e,r);case"unique-value":return function(e,r){const i={...s.defaultTo3DOptions,...r,cimFallbackEnabled:!0},n=e.uniqueValueInfos?.map(e=>s.to3D(e.symbol,i).error).filter(t.isSome),a=s.to3D(e.defaultSymbol,i);return a.error&&n?.unshift(a.error),o(e,n)}(e,r);case"class-breaks":return function(e,r){const i={...s.defaultTo3DOptions,...r,cimFallbackEnabled:!0},n=e.classBreakInfos.map(e=>s.to3D(e.symbol,i).error).filter(t.isSome),a=s.to3D(e.defaultSymbol,i);return a.error&&n.unshift(a.error),o(e,n)}(e,r);case"dictionary":case"heatmap":return null}return null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DFeatureStore":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/projectionUtils","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/OptimizedFeature","../../../../layers/graphics/OptimizedGeometry","../../../../layers/graphics/data/optimizedFeatureQueryEngineAdapter"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f){"use strict";const m=u.create();e.Graphics3DFeatureStore=class extends r{constructor(e){super(e),this.events=new i.EventEmitter,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(e,t)=>"graphic"in e?e.graphic.attributes[t]:f.optimizedFeatureQueryEngineAdapter.getAttribute(e,t),getAttributes:e=>"graphic"in e?e.graphic.attributes:f.optimizedFeatureQueryEngineAdapter.getAttributes(e),getObjectId:e=>"graphic"in e?d.getObjectId(e.graphic,this.objectIdField)??void 0:f.optimizedFeatureQueryEngineAdapter.getObjectId(e),getGeometry:e=>"graphic"in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):f.optimizedFeatureQueryEngineAdapter.getGeometry(e),getCentroid:(e,t)=>{if("graphic"in e){let r=null;null!=e.centroid?r=e.centroid:"point"===e.graphic.geometry.type&&c.projectPoint(e.graphic.geometry,g,this.viewSpatialReference)&&(r=g);const i=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return null==r?(i[0]=0,i[1]=0,i[2]=0,i[3]=0):(i[0]=r.x,i[1]=r.y,t.hasZ&&(i[2]=r.hasZ?r.z:0),t.hasM&&(i[t.hasZ?3:2]=r.hasM?r.m:0)),new p([],i)}return f.optimizedFeatureQueryEngineAdapter.getCentroid(e,t)},cloneWithGeometry:(e,t)=>"graphic"in e?new h.OptimizedFeature(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):f.optimizedFeatureQueryEngineAdapter.cloneWithGeometry(e,t)}}forEachInBounds(e,t){this.getSpatialIndex().forEachInBounds(e,t)}forEachBounds(e,t){const r=this.getSpatialIndex();for(const i of e){const e=this.featureAdapter.getObjectId(i);null!=r.getBounds(e,m)&&t(m)}}},t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"getSpatialIndex",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"forEach",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"hasZ",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"hasM",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"objectIdField",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"viewSpatialReference",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"featureSpatialReference",void 0),e.Graphics3DFeatureStore=t.__decorate([l.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],e.Graphics3DFeatureStore);const g={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/optimizedFeatureQueryEngineAdapter":function(){define(["exports","../OptimizedFeature"],function(e,t){"use strict";const r={getObjectId:e=>e.objectId,getAttributes:e=>e.attributes,getAttribute:(e,t)=>e.attributes[t],cloneWithGeometry:(e,r)=>new t.OptimizedFeature(r,e.attributes,null,e.objectId),getGeometry:e=>e.geometry,getCentroid:(e,t)=>e.ensureCentroid(t)};e.optimizedFeatureQueryEngineAdapter=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DSymbolFactory":function(){define(["exports","./Graphics3DPointSymbol","./Graphics3DSymbol"],function(e,t,r){"use strict";e.make=function(e,i,s){return"point-3d"===e.type?new t.Graphics3DPointSymbol(e,i,s):new r.Graphics3DSymbol(e,i,s)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DPointSymbol":function(){define(["exports","../../../../core/asyncUtils","../../../../core/maybe","../../../../core/promiseUtils","./Graphics3DCalloutSymbolLayerFactory","./Graphics3DLineCalloutSymbolLayer","./Graphics3DSymbol"],function(e,t,r,i,s,n,o){"use strict";class a extends o.Graphics3DSymbol{constructor(e,t,r){super(e,t,r),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=s.make(this.symbol,t))}async doLoad(e){const r=this._calloutSymbolLayer?t.result(this._calloutSymbolLayer.load()):null;try{await super.doLoad(e),i.throwIfAborted(e)}catch(e){throw this._calloutSymbolLayer?.abortLoad(),e}r&&await r}destroy(){super.destroy(),this._calloutSymbolLayer=r.destroyMaybe(this._calloutSymbolLayer)}createGraphics3DGraphic(e,t){const r=super.createGraphics3DGraphic(e,t);if(null!=this._calloutSymbolLayer&&null!=r){const t=this._createCalloutGraphic(e);t&&r.setCalloutGraphic(t)}return r}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(e,t,e=>e.calloutLayer))}updateGeometry(e,t){const r=super.updateGeometry(e,t);if(r&&this._calloutSymbolLayer){const r=e.calloutLayer;if(r)return this._calloutSymbolLayer.updateGeometry(r,t)}return r}_createCalloutGraphic(e){const t=e.renderingInfo;return e.renderingInfo=new n.LineCalloutSymbolLayerRenderingInfo(t.renderer,t.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(e)}}e.Graphics3DPointSymbol=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/GraphicsCorePerformanceInfo":function(){define(["exports"],function(e){"use strict";e.GraphicsCorePerformanceInfo=class{constructor(e,t,r,i){this.total=e,this.visible=t,this.missing=r,this.pending=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/GraphicStateTracking":function(){define(["exports","../../../../core/arrayUtils","../../../../core/handleUtils","../../../../layers/graphics/dehydratedFeatures"],function(e,t,r,i){"use strict";e.GraphicStateTracking=class{constructor(e){this._graphicsCore=e,this._idToState=new Map,this._states=new Set;const t=e.owner.layer?.objectIdField;t?(this._getGraphicId=e=>i.getObjectId(e,t),this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicByObjectId(e)):(this._getGraphicId=e=>e.uid,this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicById(e))}destroy(){this._idToState.clear(),this._states.forEach((e,t)=>this.remove(t))}add(e){const t=r.makeHandle(()=>this.remove(e));if(this._states.has(e))return t;const i=this._getGraphicId(e.graphic),s=this._getGraphics3DGraphicById(i);return this._states.has(e)||this._states.add(e),this._ensureStateList(i).push(e),e.displaying=s?.isVisible()??!1,e.isDraped=s?.isDraped??!1,e.tracking=!0,null!=s&&e.emit("changed"),t}remove(e){if(this._states.has(e)){if(this._idToState.size){const r=this._getGraphicId(e.graphic),i=this._idToState.get(r);i&&(t.remove(i,e),0===i.length&&this._idToState.delete(r))}this._states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this._forEachState(e.graphic,t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed")})}removeGraphic(e){this._forEachState(e.graphic,e=>{e.displaying=!1,e.isDraped=!1})}updateGraphicGeometry(e){this._forEachState(e.graphic,e=>e.emit("changed"))}updateGraphicVisibility(e){this._forEachState(e.graphic,t=>t.displaying=e.isVisible())}updateGraphicError(e,t){this._forEachState(e,e=>e.error=t)}allGraphicsDeleted(){this._states.forEach(e=>e.displaying=!1)}_ensureStateList(e){const t=this._idToState.get(e);if(t)return t;const r=new Array;return this._idToState.set(e,r),r}_forEachState(e,t){if(0===this._states.size||0===this._idToState.size)return;const r=this._getGraphicId(e),i=this._idToState.get(r);null!=i&&i.forEach(t)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/SpatialIndex2D":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/rbush/PooledRBush","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";e.SpatialIndex2D=class extends r{constructor(e){super(e),this._index=new c.PooledRBush(9,i("esri-csp-restrictions")?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index=s.destroyMaybe(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,r){null!=t&&t.equals(this.spatialReference)&&(h.minX=e[0],h.minY=e[1],h.maxX=e[2],h.maxY=e[3],this.update(),this._index.search(h,e=>r(e.graphic.uid)))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);if(!e.extent)return;this._index.remove(e);const t=d.getObjectId(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}_addMany(e){if(0===e.length)return;const t=this._get("objectIdField");for(const r of e){r.computeExtent(this.spatialReference);const e=d.getObjectId(r.graphic,t);null!=e&&this._boundsByFeature.set(e,r.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){h.minX=e[0],h.minY=e[1],h.maxX=e[2],h.maxY=e[3],this.update(),this._index.search(h,e=>{t(e)})}getBounds(e,t){this.update();const r=this._boundsByFeature.get(e);return r?u.fromRect(t,r):null}},t.__decorate([n.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"spatialReference",void 0),t.__decorate([n.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"hasZ",void 0),t.__decorate([n.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"hasM",void 0),t.__decorate([n.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"objectIdField",void 0),t.__decorate([n.property()],e.SpatialIndex2D.prototype,"updating",void 0),t.__decorate([n.property({readOnly:!0})],e.SpatialIndex2D.prototype,"updatingRemaining",null),e.SpatialIndex2D=t.__decorate([l.subclass("esri.views.3d.layers.graphics.SpatialIndex2D")],e.SpatialIndex2D);const h={minX:0,minY:0,maxX:0,maxY:0};Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DElevationAlignment":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./ExtentSet","../../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(e){return null==e?d.TaskPriority.ELEVATION_ALIGNMENT:"relative-to-scene"===e?d.TaskPriority.ELEVATION_ALIGNMENT_SCENE:d.TaskPriority.ELEVATION_ALIGNMENT}e.Graphics3DElevationAlignment=class extends r{constructor(e){super(e),this._dirtyExtents=new u.ExtentSet,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new i.EventEmitter}initialize(){const e=this.elevationProvider,t=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=t.registerTask(h(this.graphicsCore.layer.elevationInfo?.mode),this),this.addHandles([e.on("elevation-change",e=>this._elevationChanged(e)),s.watch(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,s.watch(()=>h(this.graphicsCore.layer.elevationInfo?.mode),e=>this._task.priority=e)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null,this._dirtyExtents.destroy()}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.readyToRun}get readyToRun(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(e){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run(()=>this._dirtyExtents.merge(e));this.readyToRun&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.notifyChange("updating")}_updateDirtyGraphics(e){const t=this.graphicsCoreOwner.view.renderCoordsHelper,r=0===this.graphicsCore.effectiveUpdatePolicy;for(const i of this._dirtyGraphicsSet.keys()){const s=this.graphicsCore.getGraphics3DGraphicById(i);if(this._dirtyGraphicsSet.delete(i),null!=s&&(s.alignWithElevation(this.elevationProvider,t,r),this.graphicsCore.deconflictor?.setDirty(),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this._dirtyExtents.empty&&!e.done;){const t=this._dirtyExtents.pop(),r=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:r});const i=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,r,e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);null!=t&&t.needsElevationUpdates()&&this._dirtyGraphicsSet.add(e)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-i)+.9*this._averageExtentUpdateSize,e.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((e,t)=>this._dirtyGraphicsSet.add(t))}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const t=e.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",e)}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating")}},t.__decorate([n.property()],e.Graphics3DElevationAlignment.prototype,"graphicsCoreOwner",void 0),t.__decorate([n.property()],e.Graphics3DElevationAlignment.prototype,"graphicsCore",void 0),t.__decorate([n.property()],e.Graphics3DElevationAlignment.prototype,"queryGraphicUIDsInExtent",void 0),t.__decorate([n.property()],e.Graphics3DElevationAlignment.prototype,"elevationProvider",void 0),t.__decorate([n.property({readOnly:!0})],e.Graphics3DElevationAlignment.prototype,"updating",null),t.__decorate([n.property({readOnly:!0})],e.Graphics3DElevationAlignment.prototype,"updatingRemaining",null),e.Graphics3DElevationAlignment=t.__decorate([c.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],e.Graphics3DElevationAlignment),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/ExtentSet":function(){define(["exports","../../../../core/has","../../../../core/PooledArray","../../../../geometry/support/aaBoundingRect","../../../support/Scheduler"],function(e,t,r,i,s){"use strict";e.ExtentSet=class{constructor(){this._extents=new r({allocator:e=>e||i.create()}),this._tmpExtent=i.create(),this._dirty=!1}destroy(){this._extents.prune()}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this._contains(e)||(this._removeContained(e),i.copy(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(e){return this._mergeTight(e),e.hasProgressed}_mergeTight(e=s.noBudget){const t=this._extents,r=new Set;let n=0;for(;n!==t.length;){t.sort((e,t)=>e[0]-t[0]),n=t.length,r.clear();for(let s=0;s<t.length;++s){if(e.done)return;const n=t.at(s);if(n){for(let e=s+1;e<t.length;++e){const i=t.at(e);if(null==i||i[0]>=n[2])break;r.add(i)}r.forEach(s=>{if(n===s)return;if(s[2]<=n[0])return void r.delete(s);const o=i.area(n),a=i.area(s),l=this._tmpExtent;i.expand(n,s,l);const c=o+a;(i.area(l)-c)/c<.05&&(i.copy(n,l),r.delete(s),t.remove(s),e.madeProgress())}),r.add(n)}}}this._dirty=!1}_contains(e){return this._extents.some(t=>i.contains(t,e))}_removeContained(e){this._extents.filterInPlace(t=>!i.contains(e,t))}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DFrustumVisibility":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/ellipsoidUtils","../../support/FrustumExtentIntersection","../../../support/Scheduler","../../../support/Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.Graphics3DFrustumVisibility=class extends r{constructor(e){super(e),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:e}=this;this._extentIntersection=new u.FrustumExtentIntersection({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,r=t.basemapTerrain,s=t.resourceController.scheduler;this.addHandles([t.on("resize",()=>this._viewChange()),i.watch(()=>t.state.camera,()=>this._viewChange(),i.sync),s.registerTask(d.TaskPriority.FRUSTUM_VISIBILITY,this),i.watch(()=>r.visibleElevationBounds,()=>this._elevationBoundsChange())]),"local"===t.viewingMode?this._isVisibleBelowSurface=!0:this.addHandles([i.watch(()=>[r.baseOpacity,r.wireframe,t.map?.ground?.navigationConstraint?.type],()=>this._updateIsVisibleBelowSurface(),i.initial)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){const e=this.graphicsCoreOwner.view,t=e.basemapTerrain,r="local"===e.viewingMode,i="none"===e.map.ground?.navigationConstraint?.type;this._isVisibleBelowSurface=r||!t.opaque||i}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const e=this.graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurfaceInternal)t=-.3*c.getReferenceEllipsoid(e.spatialReference).radius;else{const{min:r,max:i}=e.basemapTerrain.visibleElevationBounds;t=r-Math.max(1,(i-r)*(1.2-1))}this._extentIntersection.update(this._extent,e.spatialReference,t)}get readyToRun(){return this.updating}runTask(e){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),h.Yield;this._updateExtentIntersection();const t=this.graphicsCoreOwner.view.frustum,r=c.getReferenceEllipsoid(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(t,r)),e.madeProgress()}},t.__decorate([s.property({readOnly:!0})],e.Graphics3DFrustumVisibility.prototype,"suspended",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFrustumVisibility.prototype,"graphicsCoreOwner",void 0),t.__decorate([s.property({readOnly:!0})],e.Graphics3DFrustumVisibility.prototype,"updating",void 0),e.Graphics3DFrustumVisibility=t.__decorate([l.subclass("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],e.Graphics3DFrustumVisibility),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/FrustumExtentIntersection":function(){define(["exports","../../../core/compilerUtils","../../../core/mathUtils","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/projection/computeTranslationToOriginAndRotation","../../../geometry/projection/projectBoundingRect","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/lineSegment","../../../geometry/support/plane","../../../geometry/support/ray","./intersectionUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g){"use strict";const y=.5*Math.PI,_=y/Math.PI*180,b=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],v=o.create(),w=s.create(),x=s.create(),S=d.create(),T=h.create(),C=p.create();e.FrustumExtentIntersection=class{constructor(e){this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:o.create(),direction:o.create()},this._renderCoordsHelper=e.renderCoordsHelper;for(let e=0;e<4;e++)this._extent[e]={origin:o.create(),direction:o.create(),cap:{next:null,direction:o.create()}},this._planes[e]=f.create();this._planes[4]=f.create(),this._planes[5]=f.create(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,r,i=!0){const s=this._extent;this._toRenderBoundingExtent(e,t,r),n.add(this._center.origin,s[0].origin,s[2].origin),n.scale(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),i||n.scale(this._center.direction,this._center.direction,-1);for(let e=0;e<4;e++){const t=s[e];this._renderCoordsHelper.worldUpAtPosition(t.origin,t.direction);const r=s[3===e?0:e+1];t.cap.next=r.origin,n.direction(t.cap.direction,t.origin,r.origin),f.fromVectorsAndPoint(t.direction,t.cap.direction,t.origin,this._planes[e]),i||n.scale(t.direction,t.direction,-1)}f.fromVectorsAndPoint(s[0].cap.direction,s[1].cap.direction,s[0].origin,this._planes[4]),i?f.negate(this._planes[4],this._planes[5]):(f.copy(this._planes[5],this._planes[4]),f.negate(this._planes[4],this._planes[4])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*a.getReferenceEllipsoid(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,r=!1){if(null==e)return!1;if(1===this._renderCoordsHelper.viewingMode){const r=this._maxSpanSpatialReference.isGeographic?_:y*t;if(this._maxSpan>r)return!0;if(null!=e.altitude&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(0===this._maxSpan){const t=this._extent[0];return!(r||!e.intersectsRay(m.wrap(t.origin,t.direction)))}for(let t=0;t<this._extent.length;t++){const i=this._extent[t];if(!r&&e.intersectsRay(m.wrap(i.origin,i.direction)))return!0;if(e.intersectsLineSegment(p.fromPoints(i.origin,i.cap.next,C),i.cap.direction))return!0}const i=r?this._planes:this._planesWithoutFar;for(let t=0;t<e.lines.length;t++){const r=e.lines[t];if(g.frustumLineSegment(i,r.origin,r.endpoint,r.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,s){h.center(e,v),v[2]=s,l.computeTranslationToOriginAndRotation(t,v,w,this._renderCoordsHelper.spatialReference),i.invert(x,w),d.empty(S);for(const{x0:i,x1:o,y0:a,y1:l}of b)for(let c=0;c<5;c++){const h=c/4;v[0]=r.lerp(e[i],e[o],h),v[1]=r.lerp(e[a],e[l],h),v[2]=s,u.projectVectorToVector(v,t,v,this._renderCoordsHelper.spatialReference),n.transformMat4(v,v,x),d.expandWithVec3(S,v)}n.set(this._extent[0].origin,S[0],S[1],S[2]),n.set(this._extent[1].origin,S[3],S[1],S[2]),n.set(this._extent[2].origin,S[3],S[4],S[2]),n.set(this._extent[3].origin,S[0],S[4],S[2]);for(let e=0;e<4;++e)n.transformMat4(this._extent[e].origin,this._extent[e].origin,w)}_toRenderBoundingExtentLocal(e,t,r){c.projectBoundingRect(e,t,T,this._renderCoordsHelper.spatialReference),n.set(this._extent[0].origin,T[0],T[1],r),n.set(this._extent[1].origin,T[2],T[1],r),n.set(this._extent[2].origin,T[2],T[3],r),n.set(this._extent[3].origin,T[0],T[3],r)}_toRenderBoundingExtent(e,r,i){switch(this._renderCoordsHelper.viewingMode){case 1:this._toRenderBoundingExtentGlobal(e,r,i);break;case 2:this._toRenderBoundingExtentLocal(e,r,i);break;default:t.neverReached(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if(f.signedDistance(e.planes[4],this._center.origin)<0&&n.dot(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const r=this._extent[t];if(f.signedDistance(e.planes[4],r.origin)<0&&n.dot(r.direction,e.direction)<0)return!0}return!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DObjectStates":function(){define(["exports","../../../../core/handleUtils","../../../../core/has","./Graphics3DObjectStateSet"],function(e,t,r,i){"use strict";e.Graphics3DObjectStates=class{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(e=>e.objectStateSet.removeAll()),this._stateSets.length=0)}acquireOccludeeSet(e){const r=new i.Graphics3DOccludeeStateSet(e);this._stateSets.push(r);const s=t.makeHandle(()=>this.releaseSet(r));return{set:r,handle:s}}acquireHighlightSet(e,r){const s=new i.Graphics3DObjectHighlightStateSet(e,r);this._stateSets.push(s);const n=t.makeHandle(()=>this.releaseSet(s));return{set:s,handle:n}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}setUid(e,t){e.ids.add(t);const r=this._graphicsCore.graphics3DGraphics.get(t);r&&r.addObjectStateSet(e.objectStateSet)}setUids(e,t){t.forEach(t=>this.setUid(e,t))}setObjectIds(e,t){t.forEach(t=>e.ids.add(t)),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach(t=>{!t.paused&&t.hasGraphic(e)&&e.addObjectStateSet(t.objectStateSet)})}removeGraphic(e){this._stateSets.forEach(t=>{t.hasGraphic(e)&&e.removeObjectState(t.objectStateSet)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(e=>e.objectStateSet.removeAll())}_initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach(t=>{t&&e.hasGraphic(t)&&t.addObjectStateSet(e.objectStateSet)}):e.ids.forEach(r=>{const i=t.get(r);i&&i.addObjectStateSet(e.objectStateSet)})}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DObjectStateSet":function(){define(["exports","../../webgl-engine/lib/Object3DStateSet"],function(e,t){"use strict";class r{constructor(e){this.objectIdField=e,this.ids=new Set,this.paused=!1}hasGraphic(e){const t=this.objectIdField?e.graphic.attributes[this.objectIdField]:e.graphic.uid;return this.ids.has(t)}}e.Graphics3DObjectHighlightStateSet=class extends r{constructor(e,r){super(r),this.highlightName=e,this.stateType=0,this.objectStateSet=new t.Object3DHighlightStateSet(e)}},e.Graphics3DOccludeeStateSet=class extends r{constructor(e){super(e),this.stateType=1,this.objectStateSet=new t.Object3DOccludeeStateSet}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/Object3DStateSet":function(){define(["exports"],function(e){"use strict";class t{}class r extends t{constructor(e,t){super(),this.objectStateId=e,this.object=t}remove(){this.object.removeStateID(this.objectStateId)}}class i extends t{constructor(e,t,r){super(),this.objectStateId=e,this.object=t,this.owner=r}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}}class s extends t{constructor(e,t){super(),this.objectStateId=e,this._removeCallback=t,this.object=null}remove(){this._removeCallback(this.objectStateId)}}class n{constructor(){this._items=[]}addObject(e,t){this._items.push(new r(t,e))}addRenderGeometry(e,t,r){this._items.push(new i(t,e,r))}addExternal(e,t){this._items.push(new s(t,e))}remove(e){this._remove(t=>t.objectStateId===e)}removeByObject(e){this._remove(t=>t.object===e)}removeAll(){this._items.forEach(e=>e.remove()),this._items=[]}_remove(e){const{_items:t}=this;for(let r=t.length-1;r>=0;--r){const i=t[r];e(i)&&(i.remove(),t.splice(r,1))}}}e.Object3DHighlightStateSet=class extends n{constructor(e){super(),this.highlightName=e,this.stateType=0}},e.Object3DOccludeeStateSet=class extends n{constructor(){super(...arguments),this.stateType=1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/Graphics3DScaleVisibility":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/UpdatingHandles","../../../../geometry/projection/projectBoundingRect","../../../../geometry/support/aaBoundingRect","../../../support/layerViewUtils","../../../support/Scheduler","../../../support/Yield"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";function f(e,t){return e>0||t>0}e.Graphics3DScaleVisibility=class extends r{constructor(e){super(e),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new l.UpdatingHandles,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive();const e=this.graphicsCoreOwner.view.resourceController.scheduler;this.addHandles(e.registerTask(h.TaskPriority.SCALE_VISIBILITY,this)),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.layerMinMaxScaleChangeHandler())}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(e){const t=this.graphicsCoreOwner.view.spatialReference,r=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===r)this._extent=e??null;else{const i=u.create();c.projectBoundingRect(e,t,i,r)?this._extent=i:this._extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const e=this.layer,t=e.effectiveScaleRange;let r=this.layerScaleEnabled&&null!=t&&f(t.minScale,t.maxScale);e.labelingInfo&&!r&&(r=e.labelingInfo.some(e=>e&&f(e.minScale??0,e.maxScale??0)));const i=this._scaleRangeActive!==r;return this._scaleRangeActive=r,r&&!this.hasHandles(m)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on("scale-change",e=>this._scaleUpdateHandler(e)),m),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on("tiles-visibility-changed",()=>this._setDirty()),m)):!r&&this.hasHandles(m)&&this.removeHandles(m),i}get readyToRun(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(e){const t=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return p.Yield;{this._layerScaleRangeVisibilityQuery=!0;const{minScale:e,maxScale:r}=this.layer.effectiveScaleRange;t.queryVisibleScaleRange(this._extent,e,r,e=>this._finishUpdate(e))}}else this._finishUpdate(!0);e.madeProgress()}_finishUpdate(e){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._dirty=!1}_visibleAtLayerScale(e){const t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||d.scaleBoundsPredicate(e,t.minScale||0,t.maxScale||0)}_visibleAtLabelScale(e,t){return d.scaleBoundsPredicate(e,t.minScale||0,t.maxScale||0)}_graphicScale(e){let t;return null!=e.centroid?t=e.centroid:null!=e.graphic.geometry&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}_graphicVisible(e){if(!this.layerScaleEnabled)return!0;const t=this._graphicScale(e);return this._visibleAtLayerScale(t)}updateVisibility(e){if(!this._scaleRangeActive)return!1;const t=this._graphicVisible(e);return e.setVisibilityFlag(1,2,t)}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive)return!1;if(!e.labelLayers.length)return!1;const t=this._graphicScale(e),r=this._updateLabelScaleVisibility(e,t);return r&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty()),r}_updateLabelScaleVisibility(e,t){if(!e.labelLayers.length)return!1;const r=e.labelLayers[0].labelClass;if(null!=r?.minScale&&null!=r.maxScale){const i=this._visibleAtLabelScale(t,r);if(e.setVisibilityFlag(16,2,i))return!0}return!1}_scaleUpdateHandler(e){if(this._setDirty(),!this.graphicsCore.visible)return;const t=e.extent,r=e.scale,s=this._visibleAtLayerScale(r);let n=!1;const o=this.graphicsCoreOwner.view.spatialReference,a=e.spatialReference;if(null==a)return void i.getLogger(this).error("scaleUpdate: Internal error, no SpatialReference given for tiles");const l=!a.equals(o);if(l&&!c.projectBoundingRect(t,a,g,o))return void i.getLogger(this).error("scaleUpdate: Internal error, cannot project AABR from "+a+" to wkid "+o);const u=l?g:t;this.queryGraphicUIDsInExtent(u,o,e=>{const i=this.graphicsCore.getGraphics3DGraphicById(e);if(null==i)return;const o=i.centroid;null!=o&&(t[0]>o.x||t[1]>o.y||t[2]<o.x||t[3]<o.y)||(i.setVisibilityFlag(1,2,s)&&(n=!0),this._updateLabelScaleVisibility(i,r)&&(n=!0))}),n&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,2,!0)):this._scaleRangeActive&&this.graphicsCore.updateGraphicsVisibilities(),this._setDirty()}},t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"graphicsCoreOwner",void 0),t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"layer",void 0),t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"queryGraphicUIDsInExtent",void 0),t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"graphicsCore",void 0),t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"basemapTerrain",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DScaleVisibility.prototype,"layerScaleEnabled",void 0),t.__decorate([s.property({readOnly:!0})],e.Graphics3DScaleVisibility.prototype,"suspended",void 0),t.__decorate([s.property({readOnly:!0})],e.Graphics3DScaleVisibility.prototype,"updating",null),t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"_dirty",void 0),e.Graphics3DScaleVisibility=t.__decorate([a.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],e.Graphics3DScaleVisibility);const m="terrain-events",g=u.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/FeatureVisibilityFilter":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/sql","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/UpdatingHandles","../../../../layers/support/FeatureFilter","../../../../layers/support/floorFilterUtils","../graphics/QueryEngine","../graphics/QueryEngineContext","../../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y){"use strict";e.FeatureVisibilityFilter=class extends r{constructor(e){super(e),this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new h.UpdatingHandles,this._abortController=new AbortController}initialize(){const e=y.TaskPriority.FILTER_VISIBILITY,{layer:t,view:r}=this._configuration,{featureStore:i}=this.context,{spatialReference:s,resourceController:a}=r,l=this._configuration.hasZ??!1,c=this._configuration.hasM??!1,u=new g.QueryEngineContext(s,t,a,()=>i,l,c);this._queryEngine=new m.QueryEngine({context:u,priority:e}),this._frameTask=r.resourceController.scheduler.registerTask(e),this._updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this.reapply(),o.initial),this._updatingHandles.addWhen(()=>!this._frameTask.updating&&this._updateRequested,()=>{this._frameTask.scheduleGenerator(()=>this._updateVisibility(),this._abortController.signal).catch(n.throwIfNotAbortError)},o.initial)}destroy(){this._abortController.abort(),this._updatingHandles.destroy(),this.clear(),this._frameTask=s.removeMaybe(this._frameTask),this._queryEngine=s.destroyMaybe(this._queryEngine),this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _effectiveDisplayFilterClause(){return"effectiveDisplayFilterClause"in this._configuration?this._configuration.effectiveDisplayFilterClause:null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:null}get _floorFilter(){return f.getFloorFilterClause(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:e,_effectiveDisplayFilterClause:t,_timeExtent:r,_floorFilter:i}=this;let s=e?.clone();if(null!=t&&(s??=new p,s.where=a.sqlAnd(s.where,t)),null!=r&&(s??=new p,s.timeExtent=s.timeExtent?.intersection(r)??r),null!=i){s??=new p;const e=null==s.where||""===s.where;s.where=e?i:a.sqlAnd(s.where,i)}return s}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}async*_updateVisibility(){this._updateRequested=!1;const{context:e,_sceneFilter:t,_compositedFeatureFilter:r,_abortController:{signal:s}}=this;if(n.throwIfAborted(s),null==r&&null==t||0===e.getFeatureCount())return this.clear();try{const i=await this._queryEngine.executeQueryForIdSet(r,t,s);n.throwIfAborted(s),yield,n.throwIfAborted(s),e.updateFeatureVisibilities(e=>i.has(e))}catch(t){n.throwIfAbortError(t),i.getLogger(this).warn(`FeatureFilter query failed: ${t}`,{error:t}),e.setAllFeaturesVisibility(!0)}}},t.__decorate([l.property({constructOnly:!0})],e.FeatureVisibilityFilter.prototype,"context",void 0),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"updating",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"defaultVisibility",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_featureFilter",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_effectiveDisplayFilterClause",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_sceneFilter",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_floorFilter",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_timeExtent",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_compositedFeatureFilter",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_configuration",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_updateRequested",void 0),e.FeatureVisibilityFilter=t.__decorate([d.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],e.FeatureVisibilityFilter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/floorFilterUtils":function(){define(["exports"],function(e){"use strict";function t(e,t){if(!e?.length)return null;const r=e.filter(e=>""!==e).map(e=>`'${e}'`);return r.push("''"),`${t} IN (${r.join(",")}) OR ${t} IS NULL`}e.getFloorFilterClause=function(e){const r=e.layer;return"floorInfo"in r&&r.floorInfo?.floorField&&"floors"in e.view?t(e.view.floors,r.floorInfo.floorField):null},e.getLayerFloorFilterClause=function(e,r){return"floorInfo"in r&&r.floorInfo?.floorField?t(e,r.floorInfo.floorField):null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/QueryEngine":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../geometry/support/typeUtils","../../../../layers/graphics/data/QueryEngine","../../../../layers/support/FieldsIndex","../../../../rest/support/FeatureSet","../../../../rest/support/Query","../../../2d/layers/features/layerAdapters/featureServiceUtils","./QueryEngineCache"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";const g=u.QueryEngine;e.QueryEngine=class extends r{constructor(e){super(e),this._dataQueryEngineInstance=null}destroy(){this.clear()}get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new p({outSpatialReference:this.spatialReference}).toJSON()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t,r){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t),r)}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:r,extent:i}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:l.fromJSON(i)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const r=await this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),i=h.fromJSON(r);return i.features.forEach(e=>{e.layer=this.layer,e.sourceLayer=this.layer}),i}async executeQuery(e,t){const r=await this._dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),i=h.fromJSON(r);return i.features.forEach(e=>{e.layer=this.layer,e.sourceLayer=this.layer}),i}_ensureQueryJSON(e,t){let r=this.defaultQueryJSON;if(null!=e&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),r=e.toJSON(),r.cacheHint=!0),null!=t){const e=t.geometries.map(e=>e.toJSON()).reduce((e,t)=>(e.rings=e.rings.concat(t.rings),e));r={...r,cacheHint:!0,sceneFilter:{...t,geometry:e}}}return r}get _dataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const{priority:e,layer:t}=this,r="timeInfo"in t&&t.timeInfo?.toJSON()||null,i=f.createFeatureIdInfo(t),s=c.featureGeometryTypeKebabDictionary.toJSON(this._queryGeometryType),n=t.fieldsIndex?.toJSON()||new d([]),o=this.spatialReference.toJSON(),{hasZ:a,hasM:l,featureStore:u,scheduler:h,memoryController:p}=this.context,y=new m.QueryEngineCache(p);return this._dataQueryEngineInstance=new g({hasZ:a,hasM:l,geometryType:s,fieldsIndex:n,timeInfo:r,spatialReference:o,featureIdInfo:i,featureStore:u,scheduler:h,cache:y,priority:e}),this._dataQueryEngineInstance}},t.__decorate([i.property({constructOnly:!0})],e.QueryEngine.prototype,"context",void 0),t.__decorate([i.property({constructOnly:!0})],e.QueryEngine.prototype,"priority",void 0),t.__decorate([i.property()],e.QueryEngine.prototype,"layer",null),t.__decorate([i.property()],e.QueryEngine.prototype,"spatialReference",null),t.__decorate([i.property()],e.QueryEngine.prototype,"_queryGeometryType",null),t.__decorate([i.property()],e.QueryEngine.prototype,"defaultQueryJSON",null),e.QueryEngine=t.__decorate([a.subclass("esri.views.3d.layers.graphics.QueryEngine")],e.QueryEngine),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/QueryEngine":function(){define(["exports","../../../core/arrayUtils","../../../core/compilerUtils","../../../core/Error","../../../core/has","../../../core/lang","../../../core/maybe","../../../core/promiseUtils","../../../core/unitUtils","../../../core/support/jsonUtils","../../../geometry/projectionUtils","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/boundsUtils","../../../geometry/support/jsonUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","./attributeSupport","./geometryUtils","./projectionSupport","./QueryEngineCache","./QueryEngineCapabilities","./QueryEngineResult","./queryUtils","./queryValidationUtils","./spatialQuerySupport","./timeSupport","../../support/FieldsIndex","../../../views/support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R){"use strict";function O(e){if(C.canQueryWithRBush(e)){if(f.isExtent(e))return[h.fromValues(Math.min(e.xmin,e.xmax),Math.min(e.ymin,e.ymax),Math.max(e.xmin,e.xmax),Math.max(e.ymin,e.ymax))];if(f.isPolygon(e))return e.rings.map(e=>h.fromValues(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1])))}return[p.getBoundsXY(h.create(),e)]}function I(e,t,r,i,s){const n={xmin:e[0],ymin:e[1],xmax:e[3],ymax:e[4],spatialReference:_.cleanFromGeometryEngine(i)};s&&isFinite(e[2])&&isFinite(e[5])&&(n.zmin=e[2],n.zmax=e[5],n.hasZ=!0);const o=b.project(n,t,r);if(o.spatialReference=_.cleanFromGeometryEngine(r),o.xmax-o.xmin===0){const e=l.getMetersPerUnitForSR(o.spatialReference);o.xmin-=e,o.xmax+=e}if(o.ymax-o.ymin===0){const e=l.getMetersPerUnitForSR(o.spatialReference);o.ymin-=e,o.ymax+=e}if(s&&null!=o.zmin&&null!=o.zmax&&o.zmax-o.zmin===0){const e=l.getMetersPerUnitForSR(o.spatialReference);o.zmin-=e,o.zmax+=e}return o}e.Feature=class{constructor(e,t=null,r,i,s){this.attributes=e,this.geometry=r,this.centroid=i,this.filterFlags=s,this.groupId=-1,this.displayId=t}},e.QueryEngine=class{constructor(e){this._changeHandle=null,this.capabilities={query:w.queryCapabilities},this.geometryType=e.geometryType,this.hasM=!!e.hasM,this.hasZ=!!e.hasZ,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._cache=e.cache??new v.QueryEngineCache,this.timeInfo=e.timeInfo,this.featureIdInfo=e.featureIdInfo,"object-id"===e.featureIdInfo.type&&(this.objectIdField=e.featureIdInfo.fieldName),this._changeHandle=this.featureStore.events.on("changed",()=>this._clearCache()),this.fieldsIndex=c.isSerializable(e.fieldsIndex)?e.fieldsIndex:M.fromJSON(e.fieldsIndex),!e.availableFields||1===e.availableFields.length&&"*"===e.availableFields[0]?this.availableFields=new Set(this.fieldsIndex.fields.map(e=>e.name)):this.availableFields=new Set(e.availableFields.map(e=>this.fieldsIndex.get(e)?.name).filter(e=>null!=e)),e.scheduler&&e.priority&&(this._frameTask=e.scheduler.registerTask(e.priority))}destroy(){this._changeHandle=o.removeMaybe(this._changeHandle),this._frameTask=o.removeMaybe(this._frameTask),this._clearCache(),o.destroyMaybe(this._cache)}get featureAdapter(){return this.featureStore.featureAdapter}_clearCache(){this._cache.clear(),this._allFeaturesPromise=null,this._timeExtentPromise=null,this._fullExtentPromise=null}async executeQuery(e,t){const r=a.signalFromSignalOrOptions(t);try{const t=await this._executeQuery(e,{},r);return await t.createQueryResponse()}catch(t){if(t!==S.queryEngineEmptyResult)throw t;return new x.QueryEngineResult([],e,this).createQueryResponse()}}async executeQueryForCount(e={},t){const r=a.signalFromSignalOrOptions(t);try{return(await this._executeQuery(e,{returnGeometry:!1,returnCentroid:!1,outSR:null},r)).createQueryResponseForCount()}catch(e){if(e!==S.queryEngineEmptyResult)throw e;return 0}}async executeQueryForExtent(e,t){const r=a.signalFromSignalOrOptions(t),i=e.outSR;try{const t=await this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},r),s=t.size;return s?{count:s,extent:await this._getBounds(t.items,t.spatialReference,i||this.spatialReference)}:{count:0,extent:null}}catch(e){if(e===S.queryEngineEmptyResult)return{count:0,extent:null};throw e}}async executeQueryForIds(e,t){return this.executeQueryForIdSet(e,t).then(e=>Array.from(e))}async executeQueryForIdSet(e,t){const r=a.signalFromSignalOrOptions(t);try{const t=await this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},r),i=t.items,s=new Set;return await this.reschedule(()=>{for(const e of i)s.add(t.featureAdapter.getObjectId(e))},r),s}catch(e){if(e===S.queryEngineEmptyResult)return new Set;throw e}}async executeQueryForLatestObservations(e,t){const r=a.signalFromSignalOrOptions(t);if(!this.timeInfo?.trackIdField)throw new i("unsupported-query","Missing timeInfo or timeInfo.trackIdField",{query:e,timeInfo:this.timeInfo});try{const t=await this._executeQuery(e,{},r);return await this.reschedule(()=>this._filterLatest(t),r),await t.createQueryResponse()}catch(t){if(t!==S.queryEngineEmptyResult)throw t;return new x.QueryEngineResult([],e,this).createQueryResponse()}}async executeQueryForOpaqueFeatures(e,t){const r=a.signalFromSignalOrOptions(t);return(await this._executeQuery(e,{},r)).items}async executeAttributeBinsQuery(e,t){const r=a.signalFromSignalOrOptions(t);let i;e=n.clone(e);try{e=await this.schedule(()=>S.normalizeAttributeBinsQuery(e,this.definitionExpression,this.spatialReference),r),e=await this.reschedule(()=>T.validateAttributeBinsQuery(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),r);const t=await this.reschedule(()=>this._executeSceneFilterQuery(e,r),r);i=await this.reschedule(()=>this._executeGeometryQuery(e,t,r),r),await this.reschedule(()=>this._executeAggregateIdsQuery(i),r),await this.reschedule(()=>this.executeObjectIdsQuery(i),r),await this.reschedule(()=>this.executeTimeQuery(i),r),await this.reschedule(()=>this.executeAttributesQuery(i),r)}catch(t){if(t!==S.queryEngineEmptyResult)throw t;i=new x.QueryEngineResult([],e,this)}return i.createQueryBinsResponse(e)}async executeQueryForSummaryStatistics(e={},t,r){const i=a.signalFromSignalOrOptions(r),{field:s,normalizationField:n,valueExpression:o}=t;return(await this._executeQueryForStatistics(e,{field:s,normalizationField:n,valueExpression:o},i)).createSummaryStatisticsResponse(t)}async executeQueryForUniqueValues(e={},t,r){const i=a.signalFromSignalOrOptions(r),{field:s,field2:n,field3:o,valueExpression:l}=t;return(await this._executeQueryForStatistics(e,{field:s,field2:n,field3:o,valueExpression:l},i)).createUniqueValuesResponse(t)}async executeQueryForClassBreaks(e={},t,r){const i=a.signalFromSignalOrOptions(r),{field:s,normalizationField:n,valueExpression:o}=t;return(await this._executeQueryForStatistics(e,{field:s,normalizationField:n,valueExpression:o},i)).createClassBreaksResponse(t)}async executeQueryForHistogram(e={},t,r){const i=a.signalFromSignalOrOptions(r),{field:s,normalizationField:n,valueExpression:o}=t;return(await this._executeQueryForStatistics(e,{field:s,normalizationField:n,valueExpression:o},i)).createHistogramResponse(t)}async fetchRecomputedExtents(e){const t=a.signalFromSignalOrOptions(e);this._timeExtentPromise||=P.getTimeExtent(this.timeInfo,this.featureStore);const[r,i]=await Promise.all([this._getFullExtent(),this._timeExtentPromise]);return a.throwIfAborted(t),{fullExtent:r,timeExtent:i}}async _getBounds(e,t,r){const i=d.set(d.create(),d.negativeInfinity);return await this.featureStore.forEachBounds(e,e=>d.expandWithAABB(i,e)),I(i,t,r,this.spatialReference,this.hasZ)}_getFullExtent(){return this._fullExtentPromise||="getFullExtent"in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getAllFeatures().then(e=>this._getBounds(e,this.spatialReference,this.spatialReference)),this._fullExtentPromise}async schedule(e,t){return this._frameTask?.schedule(e,t)??e(R.noBudget)}async reschedule(e,t){return this._frameTask?.reschedule(e,t)??e(R.noBudget)}async _getAllFeaturesQueryEngineResult(e){return new x.QueryEngineResult(await this._getAllFeatures(),e,this)}async _getAllFeatures(){if(null==this._allFeaturesPromise){const e=[];this._allFeaturesPromise=(async()=>await this.featureStore.forEach(t=>e.push(t)))().then(()=>r.toConst(e))}const e=this._allFeaturesPromise,t=await e;return e===this._allFeaturesPromise?t.slice():this._getAllFeatures()}async _executeQuery(e,t,r){e=n.clone(e),e=await this.schedule(()=>S.normalizeQuery(e,this.definitionExpression,this.spatialReference),r),e=await this.reschedule(()=>T.validateQuery(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),r),e={...e,...t};const i=await this.reschedule(()=>this._executeSceneFilterQuery(e,r),r),s=await this.reschedule(()=>this._executeGeometryQuery(e,i,r),r);return await this.reschedule(()=>this._executeAggregateIdsQuery(s),r),await this.reschedule(()=>this.executeObjectIdsQuery(s),r),await this.reschedule(()=>this.executeTimeQuery(s),r),await this.reschedule(()=>this.executeAttributesQuery(s),r),s}async _executeSceneFilterQuery(e,t){if(null==e.sceneFilter)return null;const{outSR:r,returnGeometry:i,returnCentroid:s}=e,n=this.featureStore.featureSpatialReference,o=e.sceneFilter.geometry,a=null==n||m.equals(n,o.spatialReference)?o:b.project(o,n);if(!a)return null;const l=i||s,c=m.isValid(r)&&!m.equals(this.spatialReference,r)&&l?async e=>this._project(e,r):e=>e,u=this.featureAdapter,d=await this.reschedule(()=>this.searchFeatures(O(a)),t);if("disjoint"===e.sceneFilter.spatialRelationship){if(!d.length)return null;const r=new Set;for(const e of d)r.add(u.getObjectId(e));const i=await this.reschedule(()=>this._getAllFeatures(),t);return c(await this.reschedule(async()=>{const s=await C.getSpatialQueryOperator("esriSpatialRelDisjoint",a,this.geometryType,this.hasZ,this.hasM),n=await this.runSpatialFilter(i,e=>!r.has(u.getObjectId(e))||s(u.getGeometry(e)),t);return new x.QueryEngineResult(n,e,this)},t))}if(!d.length)return new x.QueryEngineResult([],e,this);if(this._canExecuteSinglePass(a,e))return c(new x.QueryEngineResult(d,e,this));const h=await C.getSpatialQueryOperator("esriSpatialRelContains",a,this.geometryType,this.hasZ,this.hasM),p=await this.runSpatialFilter(d,e=>h(u.getGeometry(e)),t);return c(new x.QueryEngineResult(p,e,this))}async _executeGeometryQuery(e,r,i){if(null!=r&&0===r.items.length)return r;const{geometry:s,outSR:n,returnGeometry:o,returnCentroid:a}=e,l=r?null:this._getCacheKey(e),c=l?this._cache.get(l):null;if(c)return new x.QueryEngineResult(c,e,this);const u=m.isValid(n)&&!m.equals(this.spatialReference,n),d=o||a,h=async e=>(u&&d&&await this._project(e,n),l&&this._cache.put(l,e.items),e),p=this.featureStore.featureSpatialReference,f=!s||null==p||m.equals(p,s.spatialReference)?s:b.project(s,p);if(!f)return h(null!=r?r:await this._getAllFeaturesQueryEngineResult(e));const g=this.featureAdapter;let y=await this.reschedule(()=>this.searchFeatures(O(s)),i);const _=e.spatialRel??"esriSpatialRelIntersects";if("esriSpatialRelDisjoint"===_){if(!y.length)return h(null!=r?r:await this._getAllFeaturesQueryEngineResult(e));const t=new Set;for(const e of y)t.add(g.getObjectId(e));const s=null!=r?r.items:await this.reschedule(()=>this._getAllFeatures(),i);return h(await this.reschedule(async()=>{const r=await C.getSpatialQueryOperator(_,f,this.geometryType,this.hasZ,this.hasM),n=await this.runSpatialFilter(s,e=>!t.has(g.getObjectId(e))||r(g.getGeometry(e)),i);return new x.QueryEngineResult(n,e,this)},i))}if(null!=r){const e=new t.PositionHint;y=y.filter(i=>t.indexOf(r.items,i,r.items.length,e)>=0)}if(!y.length){const t=new x.QueryEngineResult([],e,this);return l&&this._cache.put(l,t.items),t}if(this._canExecuteSinglePass(f,e))return h(new x.QueryEngineResult(y,e,this));const v=await C.getSpatialQueryOperator(_,f,this.geometryType,this.hasZ,this.hasM),w=await this.runSpatialFilter(y,e=>v(g.getGeometry(e)),i);return h(new x.QueryEngineResult(w,e,this))}_executeAggregateIdsQuery(e){if(0===e.items.length||!e.query.aggregateIds?.length||null==this.aggregateAdapter)return;const t=new Set;for(const r of e.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(r).forEach(e=>t.add(e));const r=this.featureAdapter.getObjectId;e.items=e.items.filter(e=>t.has(r(e)))}executeObjectIdsQuery(e){if(0===e.items.length||!e.query.objectIds?.length)return;const t=new Set(e.query.objectIds),r=this.featureAdapter.getObjectId;e.items=e.items.filter(e=>t.has(r(e)))}executeTimeQuery(e){if(0===e.items.length)return;const t=P.getTimeOperator(this.timeInfo,e.query.timeExtent,this.featureAdapter);null!=t&&(e.items=e.items.filter(t))}executeAttributesQuery(e){if(0===e.items.length)return;const t=y.getWhereClause(e.query.where,this.fieldsIndex);if(t){if(!t.isStandardized)throw new TypeError("Where clause is not standardized");e.items=e.items.filter(e=>t.testFeature(e,this.featureAdapter))}}async runSpatialFilter(e,t,r){if(!t)return e;if(null==this._frameTask)return e.filter(e=>t(e));let i=0;const s=new Array,n=async o=>{for(;i<e.length;){const a=e[i++];t(a)&&(s.push(a),o.madeProgress()),o.done&&await this.reschedule(e=>n(e),r)}};return this.reschedule(e=>n(e),r).then(()=>s)}_filterLatest(e){const{trackIdField:t,startTimeField:r,endTimeField:i}=this.timeInfo,s=i||r,n=new Map,o=this.featureAdapter.getAttribute;for(const r of e.items){const e=o(r,t),i=o(r,s),a=n.get(e);(!a||i>o(a,s))&&n.set(e,r)}e.items=Array.from(n.values())}_getCacheKey(e){const{geometry:t,spatialRel:r,returnGeometry:i,returnCentroid:s,outSR:n,resultType:o,cacheHint:a}=e;if("tile"!==o&&!a)return null;const l=i||s;return m.isValid(n)&&!m.equals(this.spatialReference,n)&&l?JSON.stringify([t,r,n]):JSON.stringify([t,r])}_canExecuteSinglePass(e,t){const{spatialRel:r}=t;return C.canQueryWithRBush(e)&&("esriSpatialRelEnvelopeIntersects"===r||"esriGeometryPoint"===this.geometryType&&("esriSpatialRelIntersects"===r||"esriSpatialRelContains"===r))}async _project(e,t){if(!t||m.equals(this.spatialReference,t))return e;const i=this.featureAdapter;let s;try{const e=await this._getFullExtent();s=u.getTransformation(this.spatialReference,t,e)}catch{}const n=await b.projectMany(e.items.map(e=>_.getGeometry(this.geometryType,this.hasZ,this.hasM,i.getGeometry(e))),this.spatialReference,t,s);return e.items=r.toConst(n.map((t,r)=>i.cloneWithGeometry(e.items[r],g.convertFromGeometry(t,this.hasZ,this.hasM)))),e}async searchFeatures(e){const t=new Set;await Promise.all(e.map(e=>this.featureStore.forEachInBounds(e,e=>t.add(e))));const r=Array.from(t.values());return t.clear(),r}async _executeQueryForStatistics(e,t,r){e=n.clone(e);try{e=await this.schedule(()=>S.normalizeQuery(e,this.definitionExpression,this.spatialReference),r),e=await this.reschedule(()=>T.validateStatisticsQuery(e,t,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),r);const i=await this.reschedule(()=>this._executeSceneFilterQuery(e,r),r),s=await this.reschedule(()=>this._executeGeometryQuery(e,i,r),r);return await this.reschedule(()=>this._executeAggregateIdsQuery(s),r),await this.reschedule(()=>this.executeObjectIdsQuery(s),r),await this.reschedule(()=>this.executeTimeQuery(s),r),await this.reschedule(()=>this.executeAttributesQuery(s),r),s}catch(t){if(t!==S.queryEngineEmptyResult)throw t;return new x.QueryEngineResult([],e,this)}}get test(){}},e.getQueryBBoxes=O,e.getQueryResultExtent=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/attributeSupport":function(){define(["exports","../../../core/Error","../../../core/sql/WhereClauseCache","../../support/fieldType"],function(e,t,r,i){"use strict";const s=new r.WhereClauseCache(50,500),n="unsupported-query",o=" as ",a=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeBigInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"]),l=new Set(["esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"]),c=new Set(["esriFieldTypeString","esriFieldTypeGUID","esriFieldTypeGlobalID",...a,...l]);function u(e,r,i={}){const o=d(r,e);if(!o){const i=s.getError(r,e);throw new t(n,"invalid SQL expression",{expression:r,error:i})}const a=i.expressionName||"expression";if(i.validateStandardized&&!o.isStandardized)throw new t(n,`${a} is not standard`,{expression:r});if(i.validateAggregate&&!o.isAggregate)throw new t(n,`${a} does not contain a valid aggregate function`,{expression:r});return o.fieldNames}function d(e,t){return e?s.get(e,t):null}function h(e){return/\((.*?)\)/.test(e)?e:e.split(o)[0]}function p(e,r,i,s={}){const o=new Map;if(function(e,t,r,i,s){const n=s.includes("*")?[...r,...s.filter(e=>"*"!==e)]:s;for(const s of n)if(t.get(s))f(e,t,r,i,s);else try{const n=u(t,h(s),{validateStandardized:!0});for(const s of n)f(e,t,r,i,s)}catch(t){e.set(s,{type:"expression-error",expression:s,error:t})}}(o,e,r,s.allowedFieldTypes??c,i),o.size){const e=s.expressionName??"expression";throw new t(n,`${e} contains invalid or missing fields`,{errors:Array.from(o.values()),query:s.query})}}function f(e,t,r,s,n){const o=t.get(n);o?r.has(o.name)?"all"!==s&&!1===s?.has(o.type)&&e.set(n,{type:"invalid-type",fieldName:o.name,fieldType:i.kebabDict.fromJSON(o.type),allowedFieldTypes:Array.from(s,e=>i.kebabDict.fromJSON(e))}):e.set(n,{type:"missing-field",fieldName:o.name}):e.set(n,{type:"invalid-field",fieldName:n})}e.allDateAndTimeFieldTypes=l,e.getAliasFromFieldName=function(e){return e.split(o)[1]},e.getExpressionFromFieldName=h,e.getWhereClause=d,e.numericFieldTypes=a,e.validateFields=p,e.validateHaving=function(e,r,i,s,o){if(!i)return!0;const a="having clause",l=u(e,i,{validateAggregate:!0,expressionName:a});p(e,r,l,{expressionName:a,query:o});const c=d(i,e),h=c?.getExpressions().every(t=>{const{aggregateType:r,field:i}=t,n=e.get(i)?.name;return s.some(t=>{const{onStatisticField:i,statisticType:s}=t,o=e.get(i)?.name;return o===n&&s.toLowerCase().trim()===r})});if(!h)throw new t(n,"expressions in having clause should also exist in outStatistics",{having:i});return!0},e.validateWhere=function(e,t,r,i){if(!r)return!0;const s="where clause";return p(e,t,u(e,r,{validateStandardized:!0,expressionName:s}),{expressionName:s,query:i}),!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/sql/WhereClauseCache":function(){define(["exports","../LRUCache","./WhereClause"],function(e,t,r){"use strict";e.WhereClauseCache=class{constructor(e,r){this._cache=new t.LRUCache(e),this._invalidCache=new t.LRUCache(r)}get(e,t){const i=`${t?.uid}:${e}`,s=this._cache.get(i);if(s)return s;if(null!=this._invalidCache.get(i))return null;try{const s=r.create(e,{fieldsIndex:t});return this._cache.put(i,s),s}catch(e){return this._invalidCache.put(i,e),null}}getError(e,t){const r=`${t?.uid}:${e}`;return this._invalidCache.get(r)??null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/sql/WhereClause":function(){define(["../has","./AggregateFunctions","./DateOnly","./errorSupport","./sqlArithmeticUtils","./sqlCompareUtils","./sqlDateParsingUtils","./SqlInterval","./SqlTimestampOffset","./StandardizedFunctions","./TimeOnly","./WhereGrammar","../../support/guards","../../chunks/datetime"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const f=new Set(["current_timestamp","current_date","current_time"]);class m{constructor(e){this.staticData=e}makeBool(e){return M(e)}featureValue(e,t,r,i){return B(e,t,r,i)}equalsNull(e){return null===e}applyLike(e,t,r){return U(e,t,r)}ensureArray(e){return R(e)}applyIn(e,t){return A(e,t)}currentTimestamp(e){return D(e)}currentDate(e){return E(e)}currentTime(e){return L(e)}makeSqlInterval(e,t,r){return a.SqlInterval.createFromValueAndQualifier(e,t,r)}convertInterval(e){return a.SqlInterval.isInterval(e)?e.valueInMilliseconds():e}compare(e,t,r){return n.sqlCompare(t,r,e)}calculate(e,t,r,i){return s.sqlCalculateFunction(e,t,r,i)}evaluateTime(e){return o.parseTime(e)}evaluateTimestamp(e,t,r){return o.parseTimestamp(e,t,r)}evaluateDate(e,t){return o.parseDate(e,t)}evaluateFunction(e,t,r){return c.evaluateFunction(e,t,r)}lookup(e,t){const r=t[e];return void 0===r?null:r}between(e,t){return null==e||null==t[0]||null==t[1]?null:n.sqlCompare(e,t[0],">=")&&n.sqlCompare(e,t[1],"<=")}notbetween(e,t){return null==e||null==t[0]||null==t[1]?null:n.sqlCompare(e,t[0],"<")||n.sqlCompare(e,t[1],">")}ternaryNot(e){return O(e)}ternaryAnd(e,t){return I(e,t)}ternaryOr(e,t){return F(e,t)}}function g(e,...t){return`this.${e}(${t.join(", ")})`}function y(e){return void 0===e?"void 0":JSON.stringify(e)}function _({type:e,period:t,precision:r,secondary:i}){return JSON.stringify({type:e,period:t,precision:r,secondary:i})}const b="feature",v="lookups",w="attributeAdapter",x="fieldsIndex",S="timeZone",T="currentUser";class C{constructor(e){this._parseTree=e,this._staticData=Object.create(null),this._nextStaticDataId=0,this._tempVars=new Set,this._nextTempVarId=0}compile(){const e=this._compileNode(this._parseTree),t=`\n      ${this._tempVars.size>0?`var ${Array.from(this._tempVars).join(", ")};`:""}\n      return this.convertInterval(${e});\n    `;return new Function(b,v,w,x,S,T,t).bind(new m(this._staticData))}_storeStaticData(e){const t="static$"+this._nextStaticDataId++;return this._staticData[t]=e,t}_compileRefStaticData(e){return`this.staticData[${y(e)}]`}_generateTempVar(){const e="temp$"+this._nextTempVarId++;return this._tempVars.add(e),e}_compileSimpleCase(e){const t=this._compileNode(e.operand),r=this._generateTempVar(),i=[];for(const t of e.clauses){const e=g("compare",y("="),r,this._compileNode(t.operand)),s=this._compileNode(t.value);i.push(`${e} ? (${s}) :`)}return null!=e.else?i.push(this._compileNode(e.else)):i.push(y(null)),`(${r} = ${t}, ${i.join(" ")})`}_compileSearchedCase(e){const t=[];for(const r of e.clauses){const e=g("makeBool",this._compileNode(r.operand)),i=this._compileNode(r.value);t.push(`${e} ? (${i}) :`)}return null!=e.else?t.push(this._compileNode(e.else)):t.push(y(null)),t.join(" ")}_compileInExpr(e,t){const r=new Set,i=[];for(const e of t.value)"number"===e.type||"string"===e.type?r.add(e.value):i.push(e);const s=this._compileNode(e),n=g("ensureArray",this._compileNode({type:"expression-list",location:t.location,value:i}));if(r.size>0){const e=this._compileRefStaticData(this._storeStaticData(r)),t=this._generateTempVar();return i.length>0?`(${t} = ${s}, ${e}.has(${t}) || ${g("applyIn",t,n)})`:`(${t} = ${s}, ${t} == null ? null : ${e}.has(${t}))`}return g("applyIn",s,n)}_compileNode(e){switch(e.type){case"interval":return g("makeSqlInterval",this._compileNode(e.value),"interval-qualifier"===e.qualifier.type?function({type:e,start:t,end:r}){return`{type: ${y(e)}, start: ${_(t)}, end: ${_(r)}}`}(e.qualifier):_(e.qualifier),y(e.op));case"case-expression":return"simple"===e.format?this._compileSimpleCase(e):this._compileSearchedCase(e);case"parameter":return g("lookup",y(e.value.toLowerCase()),v);case"expression-list":return`[${e.value.map(e=>this._compileNode(e)).join(", ")}]`;case"unary-expression":return g("ternaryNot",this._compileNode(e.expr));case"binary-expression":switch(e.operator){case"AND":return g("ternaryAnd",this._compileNode(e.left),this._compileNode(e.right));case"OR":return g("ternaryOr",this._compileNode(e.left),this._compileNode(e.right));case"IS":if("null"!==e.right.type)throw new i.SqlError("UnsupportedIsRhs");return g("equalsNull",this._compileNode(e.left));case"ISNOT":if("null"!==e.right.type)throw new i.SqlError("UnsupportedIsRhs");return`!${g("equalsNull",this._compileNode(e.left))}`;case"IN":return this._compileInExpr(e.left,e.right);case"NOT IN":return g("ternaryNot",this._compileInExpr(e.left,e.right));case"BETWEEN":return g("between",this._compileNode(e.left),this._compileNode(e.right));case"NOTBETWEEN":return g("notbetween",this._compileNode(e.left),this._compileNode(e.right));case"LIKE":return g("applyLike",this._compileNode(e.left),this._compileNode(e.right),y(e.escape));case"NOT LIKE":return g("ternaryNot",g("applyLike",this._compileNode(e.left),this._compileNode(e.right),y(e.escape)));case"<>":case"<":case">":case">=":case"<=":case"=":return g("compare",y(e.operator),this._compileNode(e.left),this._compileNode(e.right));case"*":case"-":case"+":case"/":case"||":return g("calculate",y(e.operator),this._compileNode(e.left),this._compileNode(e.right),S);default:throw new i.SqlError("UnsupportedOperator",{operator:e.operator})}case"null":case"boolean":case"string":case"number":return y(e.value);case"time":try{return this._compileRefStaticData(this._storeStaticData(o.parseTime(e.value)))}catch{return g("evaluateTime",y(e.value))}case"date":try{return this._compileRefStaticData(this._storeStaticData(o.parseDate(e.value,"unknown")))}catch{return g("evaluateDate",y(e.value),y("unknown"))}case"timestamp":try{return this._compileRefStaticData(this._storeStaticData(o.parseTimestamp(e.value,"unknown")))}catch{return g("evaluateTimestamp",y(e.value),y("unknown"))}case"current-time":return"date"===e.mode?g("currentDate",S):"time"===e.mode?g("currentTime",S):g("currentTimestamp",S);case"current-user":return T;case"column-reference":return g("featureValue",b,y(e.column),x,w);case"data-type":return function({type:e,size:t,withtimezone:r}){return JSON.stringify({type:e,size:t,withtimezone:r})}(e.value);case"function":return g("evaluateFunction",y(e.name),this._compileNode(e.args),S)}throw new i.SqlError("UnsupportedSyntax",{node:e.type})}}class P{static create(e,t={}){return new P(e,t.fieldsIndex,t.timeZone??void 0,t.currentUser)}constructor(e,t,r="UTC",i=null){this.fieldsIndex=t,this.timeZone=r,this.currentUser=i,this.parameters={},this._compiledExecutor=null,this._hasDateFunctions=void 0,this.parseTree=d.WhereGrammar.parse(e);const{isStandardized:s,isAggregate:n,currentUserRequired:o,referencedFieldNames:a}=this._extractExpressionInfo(t);this._referencedFieldNames=a,this.isStandardized=s,this.isAggregate=n,this.currentUserRequired=o}static convertValueToStorageFormat(e,t=null){if(null===t)return h.isDate(e)?e.getTime():o.isDateTime(e)?e.toMillis():o.isTimestampOffset(e)?e.toStorageFormat():o.isTimeOnly(e)?e.toStorageString():o.isDateOnly(e)?e.toStorageFormat():e;switch(t){case"date":return h.isDate(e)?e.getTime():o.isDateTime(e)?e.toMillis():o.isTimestampOffset(e)?e.toMilliseconds():o.isDateOnly(e)?e.toNumber():e;case"date-only":return h.isDate(e)?r.DateOnly.fromDateJS(e).toString():o.isTimestampOffset(e)?r.DateOnly.fromSqlTimeStampOffset(e).toString():o.isDateTime(e)?r.DateOnly.fromDateTime(e).toString():e;case"time-only":return h.isDate(e)?u.TimeOnly.fromDateJS(e).toStorageString():o.isDateTime(e)?u.TimeOnly.fromDateTime(e).toStorageString():o.isTimestampOffset(e)?u.TimeOnly.fromSqlTimeStampOffset(e).toStorageString():o.isTimeOnly(e)?e.toStorageString():e;case"timestamp-offset":if(h.isDate(e))return l.SqlTimeStampOffset.fromJSDate(e).toStorageFormat();if(o.isDateTime(e))return l.SqlTimeStampOffset.fromDateTime(e).toStorageFormat();if(o.isTimestampOffset(e))return e.toStorageFormat()}return e}get fieldNames(){return this._referencedFieldNames}testSet(e,t=N,r=this.currentUser){return!!this._evaluateNode(this.parseTree,null,t,e,r)}calculateValue(e,t=N,r=this.currentUser){const i=this._evaluateNode(this.parseTree,e,t,null,r);return a.SqlInterval.isInterval(i)?i.valueInMilliseconds()/864e5:i}tryGetCompiledExecutor(){if(null!=this._compiledExecutor)return this._compiledExecutor;if(e("esri-csp-restrictions"))return null;const t=new C(this.parseTree);return this._compiledExecutor=t.compile(),this._compiledExecutor}calculateValueCompiled(e,t=N,r=this.currentUser){const i=this.tryGetCompiledExecutor();return null==i?this.calculateValue(e,t):i(e,this.parameters,t,this.fieldsIndex,this.timeZone,r??null)}testFeature(e,t=N,r=this.currentUser){return!!this._evaluateNode(this.parseTree,e,t,null,r)}testFeatureCompiled(e,t=N,r=this.currentUser){const i=this.tryGetCompiledExecutor();return null==i?this.testFeature(e,t):!!i(e,this.parameters,t,this.fieldsIndex,this.timeZone,r??null)}get hasDateFunctions(){return null!=this._hasDateFunctions||(this._hasDateFunctions=!1,d.visitAll(this.parseTree,e=>{"current-time"===e.type?this._hasDateFunctions=!0:"function"===e.type&&(this._hasDateFunctions=this._hasDateFunctions||f.has(e.name.toLowerCase()))})),this._hasDateFunctions}getFunctions(){const e=new Set;return d.visitAll(this.parseTree,t=>{"function"===t.type&&e.add(t.name.toLowerCase())}),Array.from(e)}getExpressions(){const e=new Map;return d.visitAll(this.parseTree,t=>{if("function"===t.type){const r=t.name.toLowerCase(),i=t.args.value[0];if("column-reference"===i.type){const t=i.column,s=`${r}-${t}`;e.has(s)||e.set(s,{aggregateType:r,field:t})}}}),[...e.values()]}getVariables(){const e=new Set;return d.visitAll(this.parseTree,t=>{"parameter"===t.type&&e.add(t.value.toLowerCase())}),Array.from(e)}_extractExpressionInfo(e){const r=[],i=new Set;let s=!0,n=!1,o=!1;return d.visitAll(this.parseTree,a=>{switch(a.type){case"column-reference":{const t=e?.get(a.column);let s,n;t?s=n=t.name??"":(n=a.column,s=n.toLowerCase()),i.has(s)||(i.add(s),r.push(n)),a.column=n;break}case"current-user":o=!0;break;case"function":{const{name:e,args:r}=a,i=r.value.length;s&&(s=c.isStandardized(e,i)),!1===n&&(n=t.isAggregate(e,i));break}}}),{referencedFieldNames:Array.from(r),isStandardized:s,isAggregate:n,currentUserRequired:o}}_evaluateNode(e,r,l,u,d){let f;switch(e.type){case"interval":{const t=this._evaluateNode(e.value,r,l,u,d);return a.SqlInterval.createFromValueAndQualifier(t,e.qualifier,e.op)}case"case-expression":if("simple"===e.format){const t=this._evaluateNode(e.operand,r,l,u,d);for(let i=0;i<e.clauses.length;i++)if(n.sqlCompare(t,this._evaluateNode(e.clauses[i].operand,r,l,u,d),"="))return this._evaluateNode(e.clauses[i].value,r,l,u,d);if(null!==e.else)return this._evaluateNode(e.else,r,l,u,d)}else{for(let t=0;t<e.clauses.length;t++)if(M(this._evaluateNode(e.clauses[t].operand,r,l,u,d)))return this._evaluateNode(e.clauses[t].value,r,l,u,d);if(null!==e.else)return this._evaluateNode(e.else,r,l,u,d)}return null;case"parameter":return f=this.parameters[e.value.toLowerCase()],h.isDate(f)?p.DateTime.fromJSDate(f):null!=f&&"object"==typeof f&&"toDateTime"in f?f.toDateTime():f;case"expression-list":{const t=[];for(const i of e.value)t.push(this._evaluateNode(i,r,l,u,d));return t}case"unary-expression":return O(this._evaluateNode(e.expr,r,l,u,d));case"binary-expression":switch(e.operator){case"AND":return I(this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d));case"OR":return F(this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d));case"IS":if("null"!==e.right.type)throw new i.SqlError("UnsupportedIsRhs");return null===this._evaluateNode(e.left,r,l,u,d);case"ISNOT":if("null"!==e.right.type)throw new i.SqlError("UnsupportedIsRhs");return null!==this._evaluateNode(e.left,r,l,u,d);case"IN":{const t=R(this._evaluateNode(e.right,r,l,u,d));return A(this._evaluateNode(e.left,r,l,u,d),t)}case"NOT IN":{const t=R(this._evaluateNode(e.right,r,l,u,d));return O(A(this._evaluateNode(e.left,r,l,u,d),t))}case"BETWEEN":{const t=this._evaluateNode(e.left,r,l,u,d),i=this._evaluateNode(e.right,r,l,u,d);return null==t||null==i[0]||null==i[1]?null:n.sqlCompare(t,i[0],">=")&&n.sqlCompare(t,i[1],"<=")}case"NOTBETWEEN":{const t=this._evaluateNode(e.left,r,l,u,d),i=this._evaluateNode(e.right,r,l,u,d);return null==t||null==i[0]||null==i[1]?null:n.sqlCompare(t,i[0],"<")||n.sqlCompare(t,i[1],">")}case"LIKE":return U(this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d),e.escape);case"NOT LIKE":return O(U(this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d),e.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return n.sqlCompare(this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d),e.operator);case"-":case"+":case"*":case"/":case"||":return s.sqlCalculateFunction(e.operator,this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d),this.timeZone)}case"null":case"boolean":case"string":case"number":return e.value;case"date":return e.parsedValue??=o.parseDate(e.value,"unknown"),e.parsedValue;case"timestamp":return e.parsedValue??=o.parseTimestamp(e.value,"unknown"),e.parsedValue;case"time":return o.parseTime(e.value);case"current-time":return"date"===e.mode?E(this.timeZone):"time"===e.mode?L(this.timeZone):D(this.timeZone);case"current-user":return d??null;case"column-reference":return B(r,e.column,this.fieldsIndex,l);case"data-type":return e.value;case"function":{if(this.isAggregate&&t.isAggregate(e.name,e.args.value.length)){const r=[];for(const t of e.args?.value||[]){const e=[];for(const r of u||[])e.push(this._evaluateNode(t,r,l,null,d));r.push(e)}return t.aggregateFunction(e.name,r)}const i=this._evaluateNode(e.args,r,l,u,d);return c.evaluateFunction(e.name,i,this.timeZone)}}throw new i.SqlError("UnsupportedSyntax",{node:e.type})}}function M(e){return!0===e}function R(e){return Array.isArray(e)?e:[e]}function O(e){return null!==e?!0!==e:null}function I(e,t){return null!=e&&null!=t?!0===e&&!0===t:!1!==e&&!1!==t&&null}function F(e,t){return null!=e&&null!=t?!0===e||!0===t:!0===e||!0===t||null}function A(e,t){if(null==e)return null;let r=!1;for(const i of t)if(null==i)r=null;else{if(e===i){r=!0;break}if(n.isDateOrTimeValue(e)&&n.isDateOrTimeValue(i)&&(r=n.sqlCompare(e,i,"="),r))break}return r}function D(e){return o.convertToExecutingTimeZone(new Date,e)}function E(e){return r.DateOnly.fromNow(e)}function L(e){const t=o.convertToExecutingTimeZone(new Date,e);return u.TimeOnly.fromDateTime(t)}const V="-[]/{}()*+?.\\^$|";function U(e,t,r){if(null==e)return null;const i=function(e,t){const r=t;let i="",s=0;for(let t=0;t<e.length;t++){const n=e.charAt(t);switch(s){case 0:n===r?s=1:V.includes(n)?i+="\\"+n:i+="%"===n?".*":"_"===n?".":n;break;case 1:V.includes(n)?i+="\\"+n:i+=n,s=0}}return new RegExp("^"+i+"$","m")}(t,r);return i.test(e)}function B(e,t,i,s){if("getAttributeSQL"in s)return s.getAttributeSQL(e,t);const n=s.getAttribute(e,t);if(null==n)return n;const a=i?.get(t);switch(a?.type){case"esriFieldTypeDate":case"date":return o.convertToExecutingTimeZone(new Date(n),i?.getLuxonTimeZone(a.name)??p.FixedOffsetZone.utcInstance);case"esriFieldTypeDateOnly":case"date-only":return r.DateOnly.fromReader(n);case"esriFieldTypeTimeOnly":case"time-only":return u.TimeOnly.fromReader(n);case"esriFieldTypeTimestampOffset":case"timestamp-offset":return new l.SqlTimeStampOffset(n)}return n}const N={getAttribute(e,t){var r;return((r=e)&&"object"==typeof r.attributes?e.attributes:e)[t]}};return P})},"esri/core/sql/AggregateFunctions":function(){define(["exports","./DateOnly","./errorSupport","./SqlTimestampOffset","./TimeOnly","../../chunks/datetime"],function(e,t,r,i,s,n){"use strict";const o={min:{minParams:1,maxParams:1,evaluate:e=>c(e[0],"min")},max:{minParams:1,maxParams:1,evaluate:e=>c(e[0],"max")},avg:{minParams:1,maxParams:1,evaluate:e=>a(e[0])},sum:{minParams:1,maxParams:1,evaluate:e=>function(e){if(null===e)return null;let t=0;for(let i=0;i<e.length;i++){const s=e[i];if(null!==s){if(!l(s))throw new r.SqlError("InvalidValueForAggregateFunction");t+=s}}return t}(e[0])},stddev:{minParams:1,maxParams:1,evaluate:e=>function(e){if(null===e)return null;const t=u(e);return null===t?null:Math.sqrt(t)}(e[0])},count:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].length},var:{minParams:1,maxParams:1,evaluate:e=>u(e[0])}};function a(e){if(null===e)return null;let t=0,i=0;for(let s=0;s<e.length;s++){const n=e[s];if(null!==n){if(!l(n))throw new r.SqlError("InvalidValueForAggregateFunction");i++,t+=n}}return 0===i?null:t/e.length}function l(e){return"number"==typeof e}function c(e,r){if(null===e)return null;let o=null,a=null;for(const l of e){let e=l;e=t.DateOnly.isDateOnly(l)||s.TimeOnly.isTimeOnly(l)?l.toNumber():n.DateTime.isDateTime(l)?l.toMillis():i.SqlTimeStampOffset.isTimestampOffset(l)?l.toMilliseconds():l,(null===o||"max"===r&&null!==a&&null!==e&&a<=e||"min"===r&&null!==a&&null!==e&&a>=e)&&(o=l,a=e)}return o}function u(e){if(null===e)return null;if(0===(e=e.filter(e=>null!==e)).length)return null;const t=a(e);if(null===t)return null;let i=0;for(const s of e){if(!l(s))throw new r.SqlError("InvalidValueForAggregateFunction");i+=(t-s)**2}return i/(e.length-1)}e.aggregateFunction=function(e,t){const i=o[e.toLowerCase()];if(null==i)throw new r.SqlError("FunctionNotRecognized");if(t.length<i.minParams||t.length>i.maxParams)throw new r.SqlError("InvalidParameterCount",{name:e.toUpperCase()});return i.evaluate(t)},e.isAggregate=function(e,t){const r=o[e.toLowerCase()];return null!=r&&t>=r.minParams&&t<=r.maxParams},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/sql/errorSupport":function(){define(["exports","../string"],function(e,t){"use strict";const r={InvalidValueForAggregateFunction:"Invalid value used in aggregate function",MissingStatisticParameters:"Statistic does not have 1 or 0 Parameters",InvalidFunctionParameters:"Invalid parameters for call to {function}",UnsupportedIsLhs:"Unsupported left hand expression in is statement",UnsupportedIsRhs:"Unsupported right hand expression in is statement",UnsupportedOperator:"Unsupported operator - {operator}",UnsupportedSyntax:"Unsupported syntax - {node}",UnsupportedSqlFunction:"Sql function not found = {function}",InvalidDataType:"Invalid sql data type",InvalidDate:"Invalid date encountered",InvalidOperator:"Invalid operator encountered",InvalidTime:"Invalid time encountered",IllegalInterval:"Illegal interval",FunctionNotRecognized:"Function not recognized",InvalidTimeStamp:"Invalid timestamp encountered",InvalidParameterCount:"Invalid parameter count for call to {name}",PrimarySecondaryQualifiers:"Primary and Secondary SqlInterval qualifiers not supported",YearMonthIntervals:"Year-Month Intervals not supported",CannotCastValue:"Cannot cast value to the required data type"};class i extends Error{constructor(e,s){super(t.replace(r[e],s)),this.declaredRootClass="esri.arcade.featureset.support.sqlerror",Error.captureStackTrace&&Error.captureStackTrace(this,i)}}e.SqlError=i,e.sqlErrorMessages=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/sql/SqlTimestampOffset":function(){define(["exports","../../chunks/datetime"],function(e,t){"use strict";function r(e){return Number.isNaN(e)||0===e?e:Math.trunc(e)}const i="esri.core.sql.SqlTimeStampOffset";class s{constructor(e){this._timeStampOffset=e,this.declaredRootClass=i,this._date=null}static isTimestampOffset(e){return"object"==typeof e&&null!=e&&"declaredRootClass"in e&&e.declaredRootClass===i}toDateTime(){return this._date??=t.DateTime.fromISO(this._timeStampOffset,{setZone:!0}),this._date}get isValid(){return this.toDateTime().isValid}get timezoneOffsetHour(){return r(this.toDateTime().offset/60)}get timezoneOffsetMinutes(){return r(this.toDateTime().offset%60)}toMilliseconds(){return this.toDateTime().toMillis()}get hour(){return this.toDateTime().hour}get minute(){return this.toDateTime().minute}get second(){return this.toDateTime().second}get day(){return this.toDateTime().day}get month(){return this.toDateTime().month}get year(){return this.toDateTime().year}startOfDay(){return s.fromDateTime(this.toDateTime().startOf("day"))}static fromJSDate(e){return new s(t.DateTime.fromJSDate(e).toISO({includeOffset:!0}))}static fromDateTime(e){return new s(e.toISO({includeOffset:!0}))}static fromParts(e,t,r=0,i=0,n=0,o=0,a=0,l=!1,c=0,u=0){const d=`${e.toString().padStart(4,"0")}-${t.toString().padStart(2,"0")}-${r.toString().padStart(2,"0")}`;let h="";o<10&&(h="0");let p=`${i.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${h+o.toString()}`;0!==a&&(p+="."+a.toString().padStart(3,"0"));const f=`${l?"-":"+"}${c.toString().padStart(2,"0")}:${u.toString().padStart(2,"0")}`;return new s(d+"T"+p+f)}toStorageFormat(){return this._timeStampOffset}toString(){return this._timeStampOffset}toSQLValue(){let e=this.toDateTime().toSQL({includeOffset:!0,includeOffsetSpace:!0});return e&&(e=e.replace(".000","")),e}toSQLWithKeyword(){return`timestamp '${this.toSQLValue()}'`}addMilliseconds(e){const t=this.toDateTime().plus(e);return s.fromDateTime(t)}}e.SqlTimeStampOffset=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/sql/sqlArithmeticUtils":function(){define(["exports","./errorSupport","./sqlDateParsingUtils","./SqlInterval","./StandardizedFunctions","../../support/guards"],function(e,t,r,i,s,n){"use strict";function o(e,r,i){switch(i){case"+":return e+r;case"-":return e-r;case"*":return e*r;case"/":return e/r}throw new t.SqlError("InvalidOperator")}function a(e,r,i){switch(i){case"+":return r.plus({milliseconds:e.valueInMilliseconds()});case"-":return e.valueInMilliseconds()-r.toMillis()}throw new t.SqlError("InvalidOperator")}function l(e,r,i){if("+"===i)return r.plus("milliseconds",e.valueInMilliseconds());throw new t.SqlError("InvalidOperator")}function c(e,r,i){if("+"===i)return r.plus("milliseconds",e.valueInMilliseconds());throw new t.SqlError("InvalidOperator")}function u(e,r,i){switch(i){case"+":return e.plus("milliseconds",r.valueInMilliseconds());case"-":return e.plus("milliseconds",-1*r.valueInMilliseconds())}throw new t.SqlError("InvalidOperator")}function d(e,r,i){if("+"===i)return r.addMilliseconds(e.valueInMilliseconds());throw new t.SqlError("InvalidOperator")}function h(e,r,s){switch(s){case"+":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()+r.valueInMilliseconds());case"-":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()-r.valueInMilliseconds());case"*":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()*r.valueInMilliseconds());case"/":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()/r.valueInMilliseconds())}throw new t.SqlError("InvalidOperator")}function p(e,r,s){switch(s){case"+":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()+r);case"-":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()-r);case"*":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()*r);case"/":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()/r)}throw new t.SqlError("InvalidOperator")}function f(e,r,s){switch(s){case"+":return i.SqlInterval.createFromMilliseconds(e+r.valueInMilliseconds());case"-":return i.SqlInterval.createFromMilliseconds(e-r.valueInMilliseconds());case"*":return i.SqlInterval.createFromMilliseconds(e*r.valueInMilliseconds());case"/":return i.SqlInterval.createFromMilliseconds(e/r.valueInMilliseconds())}throw new t.SqlError("InvalidOperator")}function m(e,r,i){switch(i){case"+":return e.plus("milliseconds",r.valueInMilliseconds());case"-":return e.plus("milliseconds",-1*r.valueInMilliseconds())}throw new t.SqlError("InvalidOperator")}function g(e,r,i){switch(i){case"+":return e.plus({milliseconds:r.valueInMilliseconds()});case"-":return e.minus({milliseconds:r.valueInMilliseconds()})}throw new t.SqlError("InvalidOperator")}function y(e,r,i){switch(i){case"+":return e.addMilliseconds(r.valueInMilliseconds());case"-":return e.addMilliseconds(-1*r.valueInMilliseconds())}throw new t.SqlError("InvalidOperator")}function _(e,r,i){const s=1e3*r*24*60*60;switch(i){case"+":return e.plus({milliseconds:s});case"-":return e.minus({milliseconds:s})}throw new t.SqlError("InvalidOperator")}function b(e,r,i){const s=1e3*r*24*60*60;switch(i){case"+":return e.plus("milliseconds",s);case"-":return e.plus("milliseconds",-1*s)}throw new t.SqlError("InvalidOperator")}function v(e,r,i){const s=1e3*r*24*60*60;switch(i){case"+":return e.plus("milliseconds",s);case"-":return e.plus("milliseconds",-1*s)}throw new t.SqlError("InvalidOperator")}function w(e,r,i){throw new t.SqlError("InvalidOperator")}function x(e,r,i){const s=1e3*r*24*60*60;switch(i){case"+":return e.addMilliseconds(s);case"-":return e.addMilliseconds(-1*s)}throw new t.SqlError("InvalidOperator")}function S(e,r,i){throw new t.SqlError("InvalidOperator")}function T(e,r,i){throw new t.SqlError("InvalidOperator")}function C(e,r,i){throw new t.SqlError("InvalidOperator")}function P(e,r,i){const s=parseFloat(r);if(isNaN(s))throw new t.SqlError("InvalidOperator");return o(e,s,i)}function M(e,r,i){const s=parseFloat(e);if(isNaN(s))throw new t.SqlError("InvalidOperator");return o(s,r,i)}function R(e,r,i){if("+"===i)return e+r;throw new t.SqlError("InvalidOperator")}function O(e,r,i){throw new t.SqlError("InvalidOperator")}function I(e,r,i){throw new t.SqlError("InvalidOperator")}function F(e,r,i){if("-"===i)return e.toDateTimeLuxon(r.zone).diff(r).as("days");throw new t.SqlError("InvalidOperator")}function A(e,r,i){if("-"===i)return e.toDateTimeLuxon(r.toDateTime().zone).diff(r.toDateTime()).as("days");throw new t.SqlError("InvalidOperator")}function D(e,r,i){if("-"===i)return e.toDateTimeLuxon("UTC").diff(r.toDateTimeLuxon("UTC")).as("days");throw new t.SqlError("InvalidOperator")}function E(e,r,i){throw new t.SqlError("InvalidOperator")}function L(e,r,i){throw new t.SqlError("InvalidOperator")}function V(e,r,i){if("-"===i)return e.toDateTime().diff(r.toDateTimeLuxon(e.toDateTime().zone)).as("days");throw new t.SqlError("InvalidOperator")}function U(e,r,i){if("-"===i)return e.toDateTime().diff(r).as("days");throw new t.SqlError("InvalidOperator")}function B(e,r,i){if("-"===i)return e.toDateTime().diff(r.toDateTime()).as("days");throw new t.SqlError("InvalidOperator")}function N(e,r,i){throw new t.SqlError("InvalidOperator")}function k(e,r,i){throw new t.SqlError("InvalidOperator")}function z(e,r,i){throw new t.SqlError("InvalidOperator")}function j(e,r,i){throw new t.SqlError("InvalidOperator")}function G(e,r,i){if("-"===i)return e.diff(r).as("days");throw new t.SqlError("InvalidOperator")}function q(e,r,i){if("-"===i)return e.diff(r.toDateTimeLuxon(e.zone)).as("days");throw new t.SqlError("InvalidOperator")}function H(e,r,i){if("-"===i)return e.diff(r.toDateTime()).as("days");throw new t.SqlError("InvalidOperator")}function W(e,r,i){throw new t.SqlError("InvalidOperator")}function $(e,r,i){throw new t.SqlError("InvalidOperator")}function Q(e,r,i){throw new t.SqlError("InvalidOperator")}function Z(e,r,i){throw new t.SqlError("InvalidOperator")}function Y(e,r,i){throw new t.SqlError("InvalidOperator")}function X(e,r,i){throw new t.SqlError("InvalidOperator")}function J(e,r,i){throw new t.SqlError("InvalidOperator")}function K(e,r,i){throw new t.SqlError("InvalidOperator")}function ee(e,r,i){throw new t.SqlError("InvalidOperator")}e.calculateDateOnlyAndDateOnly=D,e.calculateDateOnlyAndDateTime=F,e.calculateDateOnlyAndNumber=b,e.calculateDateOnlyAndSqlInterval=m,e.calculateDateOnlyAndString=$,e.calculateDateOnlyAndTimeOnly=E,e.calculateDateOnlyAndTimestamp=A,e.calculateDateTimeAndDateOnly=q,e.calculateDateTimeAndDateTime=G,e.calculateDateTimeAndNumber=_,e.calculateDateTimeAndSqlInterval=g,e.calculateDateTimeAndString=Z,e.calculateDateTimeAndTimeOnly=W,e.calculateDateTimeAndTimestamp=H,e.calculateNumberAndDateOnly=C,e.calculateNumberAndDateTime=w,e.calculateNumberAndNumber=o,e.calculateNumberAndSqlInterval=f,e.calculateNumberAndString=P,e.calculateNumberAndTimeOnly=T,e.calculateNumberAndTimestamp=S,e.calculateSqlIntervalAndDateOnly=c,e.calculateSqlIntervalAndDateTime=a,e.calculateSqlIntervalAndNumber=p,e.calculateSqlIntervalAndSqlInterval=h,e.calculateSqlIntervalAndString=O,e.calculateSqlIntervalAndTimeOnly=l,e.calculateSqlIntervalAndTimestamp=d,e.calculateStringAndDateOnly=J,e.calculateStringAndDateTime=K,e.calculateStringAndNumber=M,e.calculateStringAndSqlInterval=I,e.calculateStringAndString=R,e.calculateStringAndTimeOnly=X,e.calculateStringAndTimestamp=ee,e.calculateTimeOnlyAndDateOnly=k,e.calculateTimeOnlyAndDateTime=N,e.calculateTimeOnlyAndNumber=v,e.calculateTimeOnlyAndSqlInterval=u,e.calculateTimeOnlyAndString=Q,e.calculateTimeOnlyAndTimeOnly=j,e.calculateTimeOnlyAndTimestamp=z,e.calculateTimestampAndDateOnly=V,e.calculateTimestampAndDateTime=U,e.calculateTimestampAndNumber=x,e.calculateTimestampAndSqlInterval=y,e.calculateTimestampAndString=Y,e.calculateTimestampAndTimeOnly=L,e.calculateTimestampAndTimestamp=B,e.sqlCalculateFunction=function(e,i,te,re){if("||"===e)return s.evaluateFunction("concat",[i,te],re);if(null===i||null===te)return null;if(n.isNumber(i)){if(n.isNumber(te))return o(i,te,e);if(r.isSqlInterval(te))return f(i,te,e);if(r.isTimeOnly(te))return T();if(r.isDateOnly(te))return C();if(r.isTimestampOffset(te))return S();if(r.isDateTime(te))return w();if(n.isString(te))return P(i,te,e);throw new t.SqlError("InvalidOperator")}if(r.isDateOnly(i)){if(n.isNumber(te))return b(i,te,e);if(r.isSqlInterval(te))return m(i,te,e);if(r.isTimeOnly(te))return E();if(r.isDateOnly(te))return D(i,te,e);if(r.isTimestampOffset(te))return A(i,te,e);if(r.isDateTime(te))return F(i,te,e);if(n.isString(te))return $();throw new t.SqlError("InvalidOperator")}if(r.isTimeOnly(i)){if(n.isNumber(te))return v(i,te,e);if(r.isSqlInterval(te))return u(i,te,e);if(r.isTimeOnly(te))return j();if(r.isDateOnly(te))return k();if(r.isTimestampOffset(te))return z();if(r.isDateTime(te))return N();if(n.isString(te))return Q();throw new t.SqlError("InvalidOperator")}if(r.isSqlInterval(i)){if(n.isNumber(te))return p(i,te,e);if(r.isSqlInterval(te))return h(i,te,e);if(r.isTimeOnly(te))return l(i,te,e);if(r.isDateOnly(te))return c(i,te,e);if(r.isTimestampOffset(te))return d(i,te,e);if(r.isDateTime(te))return a(i,te,e);if(n.isString(te))return O();throw new t.SqlError("InvalidOperator")}if(r.isDateTime(i)){if(n.isNumber(te))return _(i,te,e);if(r.isSqlInterval(te))return g(i,te,e);if(r.isTimeOnly(te))return W();if(r.isDateOnly(te))return q(i,te,e);if(r.isTimestampOffset(te))return H(i,te,e);if(r.isDateTime(te))return G(i,te,e);if(n.isString(te))return Z();throw new t.SqlError("InvalidOperator")}if(r.isTimestampOffset(i)){if(n.isNumber(te))return x(i,te,e);if(r.isSqlInterval(te))return y(i,te,e);if(r.isTimeOnly(te))return L();if(r.isDateOnly(te))return V(i,te,e);if(r.isTimestampOffset(te))return B(i,te,e);if(r.isDateTime(te))return U(i,te,e);if(n.isString(te))return Y();throw new t.SqlError("InvalidOperator")}if(n.isString(i)){if(n.isNumber(te))return M(i,te,e);if(r.isSqlInterval(te))return I();if(r.isTimeOnly(te))return X();if(r.isDateOnly(te))return J();if(r.isTimestampOffset(te))return ee();if(r.isDateTime(te))return K();if(n.isString(te))return R(i,te,e);throw new t.SqlError("InvalidOperator")}throw new t.SqlError("InvalidOperator")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/sql/sqlDateParsingUtils":function(){define(["exports","./DateOnly","./errorSupport","./SqlInterval","./SqlTimestampOffset","./TimeOnly","./UnknownTimeZone","../../chunks/datetime"],function(e,t,r,i,s,n,o,a){"use strict";const l=/^(\d{1,2}):(\d{1,2}):(\d{1,2})$/,c=/^(\d{1,2}):(\d{1,2})$/,u=/^(\d{1,2}):(\d{1,2}):(\d{1,2}).([0-9]+)$/,d=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,h=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)?$/,p=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)? {0,1}(\+|-)(\d{1,2}):(\d{1,2})$/,f=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})? {0,1}(\+|-)(\d{1,2}):(\d{1,2})$/,m=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/;function g(e,t,i=!1){let n=h.exec(e);if(null!==n){const[,e,i,s,l,c,u,d]=n,h=a.DateTime.fromObject({year:parseInt(e,10),month:parseInt(i,10),day:parseInt(s,10),hour:parseInt(l,10),minute:parseInt(c,10),second:parseInt(u,10),millisecond:d?parseInt(d.replace(".",""),10):0},{zone:o.substituteUnknownTimezone(t)});if(!1===h.isValid)throw new r.SqlError("InvalidTimeStamp");return h}if(n=p.exec(e),null!==n){const[,e,t,i,o,a,l,c,u,d,h]=n,p=s.SqlTimeStampOffset.fromParts(parseInt(e,10),parseInt(t,10),parseInt(i,10),parseInt(o,10),parseInt(a,10),parseInt(l,10),c?parseInt(c.replace(".",""),10):0,"-"===u,parseInt(d,10),parseInt(h,10));if(!1===p.isValid)throw new r.SqlError("InvalidTimeStamp");return p}if(n=f.exec(e),null!==n){const[,e,t,i,o,a,l,c,u]=n,d=s.SqlTimeStampOffset.fromParts(parseInt(e,10),parseInt(t,10),parseInt(i,10),parseInt(o,10),parseInt(a,10),0,0,"-"===l,parseInt(c,10),parseInt(u,10));if(!1===d.isValid)throw new r.SqlError("InvalidTimeStamp");return d}if(n=m.exec(e),null!==n){const[,e,i,s,l,c]=n,u=a.DateTime.fromObject({year:parseInt(e,10),month:parseInt(i,10),day:parseInt(s,10),hour:parseInt(l,10),minute:parseInt(c,10),second:0},{zone:o.substituteUnknownTimezone(t)});if(!1===u.isValid)throw new r.SqlError("InvalidTimeStamp");return u}if(n=d.exec(e),null!==n){const[,e,i,s]=n,l=a.DateTime.fromObject({year:parseInt(e,10),month:parseInt(i,10),day:parseInt(s,10),hour:0,minute:0,second:0},{zone:o.substituteUnknownTimezone(t)});if(!1===l.isValid)throw new r.SqlError("InvalidTimeStamp");return l}throw new r.SqlError("InvalidTimeStamp")}e.convertToExecutingTimeZone=function(e,t){if(t instanceof a.Zone)return t===o.UnknownTimeZone.instance?a.DateTime.fromMillis(e.getTime(),{zone:o.UnknownTimeZone.instance}):a.DateTime.fromJSDate(e,{zone:t});switch(t){case"system":case"local":case null:return a.DateTime.fromJSDate(e);default:return"unknown"===t?.toLowerCase()?a.DateTime.fromMillis(e.getTime(),{zone:o.UnknownTimeZone.instance}):a.DateTime.fromJSDate(e,{zone:t})}},e.isDateOnly=function(e){return t.DateOnly.isDateOnly(e)},e.isDateTime=function(e){return a.DateTime.isDateTime(e)},e.isSqlInterval=function(e){return i.SqlInterval.isInterval(e)},e.isTimeOnly=function(e){return n.TimeOnly.isTimeOnly(e)},e.isTimestampOffset=function(e){return s.SqlTimeStampOffset.isTimestampOffset(e)},e.parseDate=function(e,i){const s=d.exec(e);if(null===s)try{return g(e,i)}catch{throw new r.SqlError("InvalidDate")}const[,n,o,a]=s,l=t.DateOnly.fromParts(parseInt(n,10),parseInt(o,10),parseInt(a,10));if(null===l)throw new r.SqlError("InvalidDate");return l},e.parseTime=function(e){let t=l.exec(e);if(null!==t){const[,e,i,s]=t,o=n.TimeOnly.fromParts(parseInt(e,10),parseInt(i,10),parseInt(s,10),0);if(null!==o)return o;throw new r.SqlError("InvalidTime")}if(t=c.exec(e),null!==t){const[,e,i]=t,s=n.TimeOnly.fromParts(parseInt(e,10),parseInt(i,10),0,0);if(null!==s)return s;throw new r.SqlError("InvalidTime")}if(t=u.exec(e),null!==t){const[,e,i,s,o]=t,a=n.TimeOnly.fromParts(parseInt(e,10),parseInt(i,10),parseInt(s,10),parseInt(o,10));if(null!==a)return a;throw new r.SqlError("InvalidTime")}throw new r.SqlError("InvalidTime")},e.parseTimestamp=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/sql/SqlInterval":function(){define(["exports","./errorSupport"],function(e,t){"use strict";function r(e){if(null!==e.precision||null!==e.secondary)throw new t.SqlError("PrimarySecondaryQualifiers")}function i(e,t){if(t.includes(".")){const r=t.split(".");e.second=parseFloat(r[0]),e.millis=parseInt(r[1],10)}else e.second=parseFloat(t)}const s="esri.core.sql.SqlInterval";class n{constructor(){this.declaredRootClass=s,this.op="+",this.day=0,this.second=0,this.hour=0,this.month=0,this.year=0,this.minute=0,this.millis=0}static isInterval(e){return"object"==typeof e&&null!=e&&"declaredRootClass"in e&&e.declaredRootClass===s}static createFromMilliseconds(e){const t=new n;return t.second=e/1e3,t}static createFromValueAndQualifier(e,s,o){let a=null;const l=new n;if(l.op="-"===o?"-":"+","interval-period"===s.type){r(s);const n=new RegExp("^[0-9]{1,}$");if("year"===s.period||"month"===s.period)throw new t.SqlError("YearMonthIntervals");if("second"===s.period){if(!/^[0-9]{1,}(\.[0-9]{1,}){0,1}$/.test(e))throw new t.SqlError("IllegalInterval");i(l,e)}else{if(!n.test(e))throw new t.SqlError("IllegalInterval");l[s.period]=parseFloat(e)}}else{if(r(s.start),r(s.end),"year"===s.start.period||"month"===s.start.period||"year"===s.end.period||"month"===s.end.period)throw new t.SqlError("YearMonthIntervals");switch(s.start.period){case"day":switch(s.end.period){case"hour":if(a=new RegExp("^[0-9]{1,} [0-9]{1,}$"),!a.test(e))throw new t.SqlError("IllegalInterval");l[s.start.period]=parseFloat(e.split(" ")[0]),l[s.end.period]=parseFloat(e.split(" ")[1]);break;case"minute":if(a=new RegExp("^[0-9]{1,} [0-9]{1,2}:[0-9]{1,}$"),!a.test(e))throw new t.SqlError("IllegalInterval");{l[s.start.period]=parseFloat(e.split(" ")[0]);const t=e.split(" ")[1].split(":");l.hour=parseFloat(t[0]),l.minute=parseFloat(t[1])}break;case"second":if(a=new RegExp("^[0-9]{1,} [0-9]{1,2}:[0-9]{1,2}:[0-9]{1,}(\\.[0-9]{1,}){0,1}$"),!a.test(e))throw new t.SqlError("IllegalInterval");{l[s.start.period]=parseFloat(e.split(" ")[0]);const t=e.split(" ")[1].split(":");l.hour=parseFloat(t[0]),l.minute=parseFloat(t[1]),i(l,t[2])}break;default:throw new t.SqlError("IllegalInterval")}break;case"hour":switch(s.end.period){case"minute":if(a=new RegExp("^[0-9]{1,}:[0-9]{1,}$"),!a.test(e))throw new t.SqlError("IllegalInterval");l.hour=parseFloat(e.split(":")[0]),l.minute=parseFloat(e.split(":")[1]);break;case"second":if(a=new RegExp("^[0-9]{1,}:[0-9]{1,2}:[0-9]{1,}(\\.[0-9]{1,}){0,1}$"),!a.test(e))throw new t.SqlError("IllegalInterval");{const t=e.split(":");l.hour=parseFloat(t[0]),l.minute=parseFloat(t[1]),i(l,t[2])}break;default:throw new t.SqlError("IllegalInterval")}break;case"minute":if("second"!==s.end.period)throw new t.SqlError("IllegalInterval");if(a=new RegExp("^[0-9]{1,}:[0-9]{1,}(\\.[0-9]{1,}){0,1}$"),!a.test(e))throw new t.SqlError("IllegalInterval");{const t=e.split(":");l.minute=parseFloat(t[0]),i(l,t[1])}break;default:throw new t.SqlError("IllegalInterval")}}return l}valueInMilliseconds(){return("-"===this.op?-1:1)*(this.millis+1e3*this.second+60*this.minute*1e3+60*this.hour*60*1e3+24*this.day*60*60*1e3+this.month*(365/12)*24*60*60*1e3+365*this.year*24*60*60*1e3)}}e.SqlInterval=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/sql/StandardizedFunctions":function(){define(["exports","../mathUtils","../string","./DateOnly","./errorSupport","./sqlCompareUtils","./sqlDateParsingUtils","./TimeOnly","../../support/guards","../../chunks/datetime"],function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(e){return!(l.isDate(e)||o.isDateOnly(e)||o.isDateTime(e)||o.isTimeOnly(e)||o.isTimestampOffset(e))}function d(e){return o.isDateOnly(e)||o.isTimeOnly(e)?e.toString():o.isTimestampOffset(e)?e.toSQLValue():o.isDateTime(e)?0===e.millisecond?e.toFormat("yyyy-LL-dd HH:mm:ss"):e.toSQL({includeOffset:!1}):l.isDate(e)?d(c.DateTime.fromJSDate(e)):e.toString()}const h={extract:{minParams:2,maxParams:2,evaluate:([e,t])=>{if(null==t)return null;if(l.isDate(t))switch(e.toUpperCase()){case"SECOND":return t.getSeconds();case"MINUTE":return t.getMinutes();case"HOUR":return t.getHours();case"DAY":return t.getDate();case"MONTH":return t.getMonth()+1;case"YEAR":return t.getFullYear();case"TIMEZONE_HOUR":case"TIMEZONE_MINUTE":return 0;case"DOW":return c.DateTime.fromJSDate(t,{zone:"system"}).weekday;case"DOY":return c.DateTime.fromJSDate(t,{zone:"system"}).ordinal;case"WEEK":return c.DateTime.fromJSDate(t,{zone:"system"}).weekNumber}else if(o.isDateTime(t))switch(e.toUpperCase()){case"SECOND":return t.second;case"MINUTE":return t.minute;case"HOUR":return t.hour;case"DAY":return t.day;case"MONTH":return t.month;case"YEAR":return t.year;case"TIMEZONE_HOUR":case"TIMEZONE_MINUTE":throw new s.SqlError("InvalidFunctionParameters",{function:"EXTRACT"});case"DOW":return t.weekday;case"DOY":return t.ordinal;case"WEEK":return t.weekNumber}else if(o.isDateOnly(t))switch(e.toUpperCase()){case"DAY":return t.day;case"MONTH":return t.month;case"YEAR":return t.year;case"TIMEZONE_HOUR":case"TIMEZONE_MINUTE":throw new s.SqlError("InvalidFunctionParameters",{function:"EXTRACT"});case"DOW":return t.toDateTime("unknown").weekday;case"DOY":return t.toDateTime("unknown").ordinal;case"WEEK":return t.toDateTime("unknown").weekNumber}else if(o.isTimeOnly(t))switch(e.toUpperCase()){case"SECOND":return t.second;case"MINUTE":return t.minute;case"HOUR":return t.hour}else if(o.isTimestampOffset(t))switch(e.toUpperCase()){case"SECOND":return t.second;case"MINUTE":return t.minute;case"HOUR":return t.hour;case"DAY":return t.day;case"MONTH":return t.month;case"YEAR":return t.year;case"TIMEZONE_HOUR":return t.timezoneOffsetHour;case"TIMEZONE_MINUTE":return t.timezoneOffsetMinutes;case"DOW":return t.toDateTime().weekday;case"DOY":return t.toDateTime().ordinal;case"WEEK":return t.toDateTime().weekNumber}throw new s.SqlError("InvalidFunctionParameters",{function:"EXTRACT"})}},substring:{minParams:2,maxParams:3,evaluate:e=>{if(2===e.length){const[t,r]=e;return null==t||null==r?null:t.toString().substring(r-1)}if(3===e.length){const[t,r,i]=e;return null==t||null==r||null==i?null:i<=0?"":t.toString().substring(r-1,r+i-1)}}},position:{minParams:2,maxParams:2,evaluate:([e,t])=>null==e||null==t?null:t.indexOf(e)+1},trim:{minParams:2,maxParams:3,evaluate:e=>{const t=3===e.length,i=t?e[1]:" ",n=t?e[2]:e[1];if(null==i||null==n)return null;const o=`(${r.escapeRegExpString(i)})`;switch(e[0]){case"BOTH":return n.replaceAll(new RegExp(`^${o}*|${o}*$`,"g"),"");case"LEADING":return n.replaceAll(new RegExp(`^${o}*`,"g"),"");case"TRAILING":return n.replaceAll(new RegExp(`${o}*$`,"g"),"")}throw new s.SqlError("InvalidFunctionParameters",{function:"TRIM"})}},abs:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.abs(e[0])},ceiling:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.ceil(e[0])},floor:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.floor(e[0])},log:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.log(e[0])},log10:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.log(e[0])*Math.LOG10E},sin:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.sin(e[0])},cos:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.cos(e[0])},tan:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.tan(e[0])},asin:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.asin(e[0])},acos:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.acos(e[0])},atan:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.atan(e[0])},sign:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0]>0?1:e[0]<0?-1:0},power:{minParams:2,maxParams:2,evaluate:e=>null==e[0]||null==e[1]?null:e[0]**e[1]},mod:{minParams:2,maxParams:2,evaluate:e=>null==e[0]||null==e[1]?null:e[0]%e[1]},round:{minParams:1,maxParams:2,evaluate:e=>{const t=e[0],r=2===e.length?10**e[1]:1;return null==t?null:Math.round(t*r)/r}},truncate:{minParams:1,maxParams:2,evaluate:e=>null==e[0]?null:1===e.length||0===e[1]?Math.trunc(e[0]):t.decimalAdjust("trunc",e[0],-Number(e[1]))},char_length:{minParams:1,maxParams:1,evaluate:e=>l.isString(e[0])?e[0].length:0},concat:{minParams:1,maxParams:1/0,evaluate:e=>{let t="";for(let r=0;r<e.length;r++){if(null==e[r])return null;t+=e[r].toString()}return t}},lower:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].toString().toLowerCase()},upper:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].toString().toUpperCase()},coalesce:{minParams:1,maxParams:1/0,evaluate:e=>{for(const t of e)if(null!==t)return t;return null}},cosh:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.cosh(e[0])},sinh:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.sinh(e[0])},tanh:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.tanh(e[0])},nullif:{minParams:2,maxParams:2,evaluate:e=>n.sqlCompare(e[0],e[1],"=")?null:e[0]},cast:{minParams:2,maxParams:2,evaluate:(e,t)=>{const r=e[0],n=e[1];if(null===r)return null;switch(n.type){case"integer":{if(!u(r))throw new s.SqlError("CannotCastValue");const e=parseInt(r,10);if(isNaN(e))throw new s.SqlError("CannotCastValue");return e}case"smallint":{if(!u(r))throw new s.SqlError("CannotCastValue");const e=parseInt(r,10);if(isNaN(e))throw new s.SqlError("CannotCastValue");if(e>32767||e<-32767)throw new s.SqlError("CannotCastValue");return e}case"float":case"real":{if(!u(r))throw new s.SqlError("CannotCastValue");const e=parseFloat(r);if(isNaN(e))throw new s.SqlError("CannotCastValue");return e}case"time":return function(e){if(l.isDate(e))return a.TimeOnly.fromDateJS(e);if(o.isDateTime(e))return a.TimeOnly.fromDateTime(e);if(o.isDateOnly(e))throw new s.SqlError("CannotCastValue");if(o.isTimeOnly(e))return e;if(o.isTimestampOffset(e))return a.TimeOnly.fromSqlTimeStampOffset(e);if(l.isString(e))return o.parseTime(e);throw new s.SqlError("CannotCastValue")}(r);case"date":return function(e){if(l.isDate(e))return i.DateOnly.fromDateJS(e);if(o.isDateTime(e))return i.DateOnly.fromParts(e.year,e.month,e.day);if(o.isDateOnly(e))return e;if(o.isTimeOnly(e))throw new s.SqlError("CannotCastValue");if(o.isTimestampOffset(e)&&null===i.DateOnly.fromParts(e.year,e.month,e.day))throw new s.SqlError("CannotCastValue");if(l.isString(e)){const t=i.DateOnly.fromReader(e);if(null!==t&&t.isValid)return t}throw new s.SqlError("CannotCastValue")}(r);case"timestamp":return function(e,t,r){if(l.isDate(e))return o.convertToExecutingTimeZone(e,t);if(o.isDateTime(e))return e;if(o.isDateOnly(e))return e.toDateTimeLuxon("unknown");if(o.isTimeOnly(e))throw new s.SqlError("CannotCastValue");if(o.isTimestampOffset(e))return e;if(l.isString(e))return o.parseTimestamp(e,"unknown",r);throw new s.SqlError("CannotCastValue")}(r,t,!0===n.withtimezone);case"varchar":{const e=d(r);if(e.length>n.size)throw new s.SqlError("CannotCastValue");return e}default:throw new s.SqlError("InvalidDataType")}}}};e.evaluateFunction=function(e,t,r){const i=h[e.toLowerCase()];if(null==i)throw new s.SqlError("FunctionNotRecognized");if(t.length<i.minParams||t.length>i.maxParams)throw new s.SqlError("InvalidParameterCount",{name:e.toUpperCase()});return i.evaluate(t,r)},e.isStandardized=function(e,t){const r=h[e.toLowerCase()];return null!=r&&t>=r.minParams&&t<=r.maxParams},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/sql/sqlCompareUtils":function(){define(["exports","./errorSupport","./sqlDateParsingUtils","./SqlTimestampOffset","./UnknownTimeZone","../../support/guards","../../chunks/datetime"],function(e,t,r,i,s,n,o){"use strict";function a(e){return!!r.isDateTime(e)||!!r.isTimestampOffset(e)}function l(e){return!!(r.isDateTime(e)||r.isDateOnly(e)||r.isTimestampOffset(e)||r.isTimeOnly(e))}function c(e){if(r.isDateTime(e))return e.toMillis();if(r.isDateOnly(e))return e.toNumber();if(r.isTimestampOffset(e))return e.toMilliseconds();throw new t.SqlError("InvalidDataType")}function u(e,t,r){switch(r){case"<>":return e!==t;case"=":return e===t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}}function d(e,t,r){i.SqlTimeStampOffset.isTimestampOffset(e)&&(e=e.toDateTime()),i.SqlTimeStampOffset.isTimestampOffset(t)&&(t=t.toDateTime());const s=h(e),n=h(t);switch(r){case"<>":return s!==n;case"=":return s===n;case">":return s>n;case"<":return s<n;case">=":return s>=n;case"<=":return s<=n}}function h(e){return 321408e5*e.year+26784e5*e.month+864e5*e.day+36e5*e.hour+6e4*e.minute+1e3*e.second+e.millisecond}e.dateValueInMilliseconds=c,e.isDateOrTimeValue=l,e.isDateTimeComparableValue=a,e.sqlCompare=function(e,h,p){if(null==e||null==h)return null;if(n.isNumber(e)){if(n.isNumber(h))return u(e,h,p);if(n.isString(h))return function(e,t,r){const i=parseFloat(t);if(!isNaN(i))return u(e,i,r);const s=e.toString();switch(r){case"<>":return s!==t;case"=":return s===t;case">":return s>t;case"<":return s<t;case">=":return s>=t;case"<=":return s<=t}}(e,h,p);if(l(h))throw new t.SqlError("InvalidOperator");if(r.isDateOnly(h))throw new t.SqlError("InvalidOperator")}else if(n.isString(e)){if(n.isNumber(h))return function(e,t,r){const i=parseFloat(e);if(!isNaN(i))return u(i,t,r);const s=t.toString();switch(r){case"<>":return e!==s;case"=":return e===s;case">":return e>s;case"<":return e<s;case">=":return e>=s;case"<=":return e<=s}}(e,h,p);if(n.isString(h))return function(e,t,r){switch(r){case"<>":return e!==t;case"=":return e===t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}}(e,h,p);if(r.isDateTime(h))throw new t.SqlError("InvalidOperator");if(r.isDateOnly(h))throw new t.SqlError("InvalidOperator");if(r.isTimeOnly(h))throw new t.SqlError("InvalidOperator");if(r.isTimestampOffset(h))throw new t.SqlError("InvalidOperator")}else if(r.isDateTime(e)){if(a(h)){if(s.isUnknownTimeZone(e.zone)){if(o.DateTime.isDateTime(h)&&!s.isUnknownTimeZone(h.zone))return d(e,h,p);if(i.SqlTimeStampOffset.isTimestampOffset(h))return d(e,h,p)}else if(o.DateTime.isDateTime(h)&&s.isUnknownTimeZone(h.zone)){if(!s.isUnknownTimeZone(e.zone))return d(e,h,p);if(i.SqlTimeStampOffset.isTimestampOffset(e))return d(e,h,p)}return u(c(e),c(h),p)}if(n.isString(h))throw new t.SqlError("InvalidOperator");if(r.isDateOnly(h))return function(e,t,r){const i=t.toDateTimeLuxon(e.zone);return u((e=e.startOf("day")).toMillis(),i.toMillis(),r)}(e,h,p);if(r.isTimeOnly(h))throw new t.SqlError("InvalidOperator");if(n.isNumber(h))throw new t.SqlError("InvalidOperator")}else if(r.isDateOnly(e)){if(r.isTimestampOffset(h))return function(e,t,r){const i=e.toDateTimeLuxon(t.toDateTime().zone);return t=t.startOfDay(),u(i.toMillis(),t.toMilliseconds(),r)}(e,h,p);if(r.isDateTime(h))return function(e,t,r){const i=e.toDateTimeLuxon(t.zone);return t=t.startOf("day"),u(i.toMillis(),t.toMillis(),r)}(e,h,p);if(n.isString(h))throw new t.SqlError("InvalidOperator");if(r.isDateOnly(h))return u(e.toNumber(),h.toNumber(),p);if(r.isTimeOnly(h))throw new t.SqlError("InvalidOperator");if(n.isNumber(h))throw new t.SqlError("InvalidOperator")}else if(r.isTimeOnly(e)){if(r.isTimeOnly(h))return u(e.toNumber(),h.toNumber(),p);if(n.isString(h))throw new t.SqlError("InvalidOperator");if(n.isNumber(h))throw new t.SqlError("InvalidOperator");if(r.isDateOnly(h))throw new t.SqlError("InvalidOperator");if(a(h))throw new t.SqlError("InvalidOperator")}else if(r.isTimestampOffset(e)){if(a(h))return o.DateTime.isDateTime(h)&&s.isUnknownTimeZone(h.zone)?d(e,h,p):u(c(e),c(h),p);if(n.isString(h))throw new t.SqlError("InvalidOperator");if(r.isDateOnly(h))return function(e,t,r){const i=t.toDateTimeLuxon(e.toDateTime().zone);return u((e=e.startOfDay()).toMilliseconds(),i.toMillis(),r)}(e,h,p);if(r.isTimeOnly(h))throw new t.SqlError("InvalidOperator");if(n.isNumber(h))throw new t.SqlError("InvalidOperator")}switch(p){case"<>":return e!==h;case"=":return e===h;case">":return e>h;case"<":return e<h;case">=":return e>=h;case"<=":return e<=h}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/sql/WhereGrammar":function(){define(["exports"],function(e){"use strict";class t extends SyntaxError{constructor(e,t,r,i){super(e),this.expected=t,this.found=r,this.location=i,this.name="SyntaxError"}format(e){let t="Error: "+this.message;if(this.location){let r=null;const i=e.find(e=>e.source===this.location.source);i&&(r=i.text.split(/\r\n|\n|\r/g));const s=this.location.start,n=this.location.source&&"function"==typeof this.location.source.offset?this.location.source.offset(s):s,o=this.location.source+":"+n.line+":"+n.column;if(r){const e=this.location.end,i="".padEnd(n.line.toString().length," "),a=r[s.line-1],l=(s.line===e.line?e.column:a.length+1)-s.column||1;t+="\n --\x3e "+o+"\n"+i+" |\n"+n.line+" | "+a+"\n"+i+" | "+"".padEnd(s.column-1," ")+"".padEnd(l,"^")}else t+="\n at "+o}return t}static buildMessage(e,t){function r(e){return e.codePointAt(0).toString(16).toUpperCase()}const i=Object.prototype.hasOwnProperty.call(RegExp.prototype,"unicode")?new RegExp("[\\p{C}\\p{Mn}\\p{Mc}]","gu"):null;function s(e){return i?e.replace(i,e=>"\\u{"+r(e)+"}"):e}function n(e){return s(e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,e=>"\\x0"+r(e)).replace(/[\x10-\x1F\x7F-\x9F]/g,e=>"\\x"+r(e)))}function o(e){return s(e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,e=>"\\x0"+r(e)).replace(/[\x10-\x1F\x7F-\x9F]/g,e=>"\\x"+r(e)))}const a={literal:e=>'"'+n(e.text)+'"',class(e){const t=e.parts.map(e=>Array.isArray(e)?o(e[0])+"-"+o(e[1]):o(e));return"["+(e.inverted?"^":"")+t.join("")+"]"+(e.unicode?"u":"")},any:()=>"any character",end:()=>"end of input",other:e=>e.description};function l(e){return a[e.type](e)}return"Expected "+function(e){const t=e.map(l);if(t.sort(),t.length>0){let e=1;for(let r=1;r<t.length;r++)t[r-1]!==t[r]&&(t[e]=t[r],e++);t.length=e}switch(t.length){case 1:return t[0];case 2:return t[0]+" or "+t[1];default:return t.slice(0,-1).join(", ")+", or "+t[t.length-1]}}(e)+" but "+function(e){return e?'"'+n(e)+'"':"end of input"}(t)+" found."}}e.WhereGrammar=class{static parse(e){return function(e,r){const i={},s=(r=void 0!==r?r:{}).grammarSource,n={start:wr};let o=wr;const a="!",l="=",c=">=",u=">",d="<=",h="<>",p="!=",f="||",m="@",g="'",y="N'",_="''",b=".",v="null",w="true",x="false",S="in",T="is",C="like",P="escape",M="not",R="and",O="or",I="between",F="from",A="for",D="substring",E="extract",L="trim",V="position",U="timestamp",B="date",N="time",k="leading",z="trailing",j="both",G="cast",q="as",H="integer",W="int",$="smallint",Q="float",Z="real",Y="varchar",X="to",J="interval",K="year",ee="timezone_hour",te="timezone_minute",re="month",ie="day",se="hour",ne="minute",oe="second",ae="dow",le="doy",ce="week",ue="case",de="end",he="when",pe="then",fe="else",me=",",ge="(",ye=")",_e="`",be=/^[<-=]/,ve=/^[+\-]/,we=/^[*\/]/,xe=/^[A-Za-z_\x80-\uFFFF]/,Se=/^[A-Za-z0-9_]/,Te=/^[A-Za-z0-9_.\x80-\uFFFF]/,Ce=/^["]/,Pe=/^[^']/,Me=/^[0-9]/,Re=/^[eE]/,Oe=/^[ \t\n\r]/,Ie=/^[^`]/,Fe=gr("!",!1),Ae=gr("=",!1),De=gr(">=",!1),Ee=gr(">",!1),Le=gr("<=",!1),Ve=gr("<>",!1),Ue=yr([["<","="]],!1,!1,!1),Be=gr("!=",!1),Ne=yr(["+","-"],!1,!1,!1),ke=gr("||",!1),ze=yr(["*","/"],!1,!1,!1),je=yr([["A","Z"],["a","z"],"_",["","￿"]],!1,!1,!1),Ge=yr([["A","Z"],["a","z"],["0","9"],"_"],!1,!1,!1),qe=yr([["A","Z"],["a","z"],["0","9"],"_",".",["","￿"]],!1,!1,!1),He=yr(['"'],!1,!1,!1),We=gr("@",!1),$e=gr("'",!1),Qe=gr("N'",!1),Ze=gr("''",!1),Ye=yr(["'"],!0,!1,!1),Xe=gr(".",!1),Je=yr([["0","9"]],!1,!1,!1),Ke=yr(["e","E"],!1,!1,!1),et=gr("NULL",!0),tt=gr("TRUE",!0),rt=gr("FALSE",!0),it=gr("IN",!0),st=gr("IS",!0),nt=gr("LIKE",!0),ot=gr("ESCAPE",!0),at=gr("NOT",!0),lt=gr("AND",!0),ct=gr("OR",!0),ut=gr("BETWEEN",!0),dt=gr("FROM",!0),ht=gr("FOR",!0),pt=gr("SUBSTRING",!0),ft=gr("EXTRACT",!0),mt=gr("TRIM",!0),gt=gr("POSITION",!0),yt=gr("TIMESTAMP",!0),_t=gr("DATE",!0),bt=gr("TIME",!0),vt=gr("LEADING",!0),wt=gr("TRAILING",!0),xt=gr("BOTH",!0),St=gr("CAST",!0),Tt=gr("AS",!0),Ct=gr("INTEGER",!0),Pt=gr("INT",!0),Mt=gr("SMALLINT",!0),Rt=gr("FLOAT",!0),Ot=gr("REAL",!0),It=gr("VARCHAR",!0),Ft=gr("TO",!0),At=gr("INTERVAL",!0),Dt=gr("YEAR",!0),Et=gr("TIMEZONE_HOUR",!0),Lt=gr("TIMEZONE_MINUTE",!0),Vt=gr("MONTH",!0),Ut=gr("DAY",!0),Bt=gr("HOUR",!0),Nt=gr("MINUTE",!0),kt=gr("SECOND",!0),zt=gr("DOW",!0),jt=gr("DOY",!0),Gt=gr("WEEK",!0),qt=gr("CASE",!0),Ht=gr("END",!0),Wt=gr("WHEN",!0),$t=gr("THEN",!0),Qt=gr("ELSE",!0),Zt=gr(",",!1),Yt=gr("(",!1),Xt=gr(")",!1),Jt=yr([" ","\t","\n","\r"],!1,!1,!1),Kt=gr("`",!1),er=yr(["`"],!0,!1,!1);function tr(e,t,r){return{op:t,expr:r,location:fr()}}function rr(e,t,r){return{op:t,expr:r,location:fr()}}function ir(e,t){return{op:e,expr:t,location:fr()}}function sr(e,t,r){return{op:t,expr:r,location:fr()}}function nr(e,t,r){return{op:t,expr:r,location:fr()}}function or(){return"'"}let ar=0|r.peg$currPos,lr=ar;const cr=[{line:1,column:1}];let ur,dr=ar,hr=r.peg$maxFailExpected||[],pr=0|r.peg$silentFails;if(r.startRule){if(!(r.startRule in n))throw new Error("Can't start parsing from rule \""+r.startRule+'".');o=n[r.startRule]}function fr(){return br(lr,ar)}function mr(e,r){throw function(e,r){return new t(e,null,null,r)}(e,r=void 0!==r?r:br(lr,ar))}function gr(e,t){return{type:"literal",text:e,ignoreCase:t}}function yr(e,t,r,i){return{type:"class",parts:e,inverted:t,ignoreCase:r,unicode:i}}function _r(t){let r,i=cr[t];if(i)return i;if(t>=cr.length)r=cr.length-1;else for(r=t;!cr[--r];);for(i=cr[r],i={line:i.line,column:i.column};r<t;)10===e.charCodeAt(r)?(i.line++,i.column=1):i.column++,r++;return cr[t]=i,i}function br(e,t,r){const i=_r(e),n=_r(t);return{source:s,start:{offset:e,line:i.line,column:i.column},end:{offset:t,line:n.line,column:n.column}}}function vr(e){ar<dr||(ar>dr&&(dr=ar,hr=[]),hr.push(e))}function wr(){let e,t;return e=ar,Ii(),t=Sr(),t!==i?(Ii(),lr=e,e=t):(ar=e,e=i),e}function xr(){let e,t,r,s,n,o,a,l;if(e=ar,t=Ri(),t!==i){for(Ii(),r=[],s=Sr();s!==i;)r.push(s),s=ar,n=ar,o=Ii(),a=Mi(),a!==i?(l=Ii(),o=[o,a,l],n=o):(ar=n,n=i),n!==i?(n=Sr(),n===i?(ar=s,s=i):s=n):s=n;s=Ii(),n=Oi(),n!==i?(lr=e,c=r,e={type:"expression-list",location:fr(),value:c}):(ar=e,e=i)}else ar=e,e=i;var c;return e}function Sr(){let e,t,r,s,n,o;if(e=ar,t=Tr(),t!==i){for(r=[],s=ar,Ii(),n=ci(),n!==i?(Ii(),o=Tr(),o!==i?(lr=s,s=tr(0,n,o)):(ar=s,s=i)):(ar=s,s=i);s!==i;)r.push(s),s=ar,Ii(),n=ci(),n!==i?(Ii(),o=Tr(),o!==i?(lr=s,s=tr(0,n,o)):(ar=s,s=i)):(ar=s,s=i);lr=e,e=Ei(t,r)}else ar=e,e=i;return e}function Tr(){let e,t,r,s,n,o;if(e=ar,t=Cr(),t!==i){for(r=[],s=ar,Ii(),n=li(),n!==i?(Ii(),o=Cr(),o!==i?(lr=s,s=rr(0,n,o)):(ar=s,s=i)):(ar=s,s=i);s!==i;)r.push(s),s=ar,Ii(),n=li(),n!==i?(Ii(),o=Cr(),o!==i?(lr=s,s=rr(0,n,o)):(ar=s,s=i)):(ar=s,s=i);lr=e,e=Ei(t,r)}else ar=e,e=i;return e}function Cr(){let t,r,s,n,o;return t=ar,r=ai(),r===i&&(r=ar,33===e.charCodeAt(ar)?(s=a,ar++):(s=i,0===pr&&vr(Fe)),s!==i?(n=ar,pr++,61===e.charCodeAt(ar)?(o=l,ar++):(o=i,0===pr&&vr(Ae)),pr--,o===i?n=void 0:(ar=n,n=i),n!==i?(s=[s,n],r=s):(ar=r,r=i)):(ar=r,r=i)),r!==i?(s=Ii(),n=Cr(),n!==i?(lr=t,t=function(e,t,r){return{type:"unary-expression",location:r,operator:"NOT",expr:t}}(0,n,fr())):(ar=t,t=i)):(ar=t,t=i),t===i&&(t=function(){let t,r,s,n;var o,a;return t=ar,r=Or(),r!==i?(s=ar,Ii(),n=function(){let t;return t=function(){let e,t,r,s,n;if(e=ar,t=[],r=ar,Ii(),s=Pr(),s!==i?(Ii(),n=Or(),n!==i?(lr=r,r=ir(s,n)):(ar=r,r=i)):(ar=r,r=i),r!==i)for(;r!==i;)t.push(r),r=ar,Ii(),s=Pr(),s!==i?(Ii(),n=Or(),n!==i?(lr=r,r=ir(s,n)):(ar=r,r=i)):(ar=r,r=i);else t=i;return t!==i&&(lr=e,t={type:"arithmetic",tail:t}),e=t,e}(),t===i&&(t=function(){let e,t,r;return e=ar,t=Rr(),t!==i?(Ii(),r=xr(),r!==i?(lr=e,e={op:t,right:r}):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=Rr(),t!==i?(Ii(),r=kr(),r!==i?(lr=e,e={op:t,right:r}):(ar=e,e=i)):(ar=e,e=i)),e}(),t===i&&(t=function(){let e,t,r,s,n,o,a,l;var c,u;return e=ar,t=ai(),t!==i?(Ii(),r=ui(),r!==i?(s=Ii(),n=ar,o=Or(),o!==i?(Ii(),a=li(),a!==i?(Ii(),l=Or(),l!==i?(lr=n,c=o,u=l,n=Di(fr(),c,u)):(ar=n,n=i)):(ar=n,n=i)):(ar=n,n=i),n!==i?(lr=e,e={op:"NOT"+r,right:n}):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=ui(),t!==i?(Ii(),r=ar,s=Or(),s!==i?(n=Ii(),o=li(),o!==i?(Ii(),a=Or(),a!==i?(lr=r,r=function(e,t,r){return Di(fr(),t,r)}(0,s,a)):(ar=r,r=i)):(ar=r,r=i)):(ar=r,r=i),r!==i?(lr=e,e={op:t,right:r}):(ar=e,e=i)):(ar=e,e=i)),e}(),t===i&&(t=function(){let e,t,r,s;return e=ar,t=ni(),t!==i?(Ii(),r=ai(),r!==i?(Ii(),s=Or(),s!==i?(lr=e,e={op:t+"NOT",right:s}):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=ni(),t!==i?(Ii(),r=Or(),r!==i?(lr=e,e={op:t,right:r}):(ar=e,e=i)):(ar=e,e=i)),e}(),t===i&&(t=function(){let t,r,s,n,o;return t=ar,r=Mr(),r!==i?(Ii(),s=Qr(),s!==i?(Ii(),n=function(){let t,r,s,n;return t=ar,r=e.substr(ar,6),r.toLowerCase()===P?ar+=6:(r=i,0===pr&&vr(ot)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="ESCAPE"):(ar=t,t=i)):(ar=t,t=i),t}(),n!==i?(Ii(),o=Zr(),o!==i?(lr=t,t={op:r,right:s,escape:o.value}):(ar=t,t=i)):(ar=t,t=i)):(ar=t,t=i)):(ar=t,t=i),t===i&&(t=ar,r=Mr(),r!==i?(Ii(),s=Qr(),s!==i?(lr=t,t={op:r,right:s,escape:""}):(ar=t,t=i)):(ar=t,t=i)),t}())))),t}(),n!==i?s=n:(ar=s,s=i),s===i&&(s=null),lr=t,o=r,t=""==(a=s)||null==a||null==a?o:"arithmetic"==a.type?Ei(o,a.tail):Ai(a.op,o,a.right,a.escape,fr())):(ar=t,t=i),t}()),t}function Pr(){let t;return e.substr(ar,2)===c?(t=c,ar+=2):(t=i,0===pr&&vr(De)),t===i&&(62===e.charCodeAt(ar)?(t=u,ar++):(t=i,0===pr&&vr(Ee)),t===i&&(e.substr(ar,2)===d?(t=d,ar+=2):(t=i,0===pr&&vr(Le)),t===i&&(e.substr(ar,2)===h?(t=h,ar+=2):(t=i,0===pr&&vr(Ve)),t===i&&(t=e.charAt(ar),be.test(t)?ar++:(t=i,0===pr&&vr(Ue)),t===i&&(e.substr(ar,2)===p?(t=p,ar+=2):(t=i,0===pr&&vr(Be))))))),t}function Mr(){let e,t,r,s,n;var o;return e=ar,t=ar,r=ai(),r!==i?(s=Ii(),n=oi(),n!==i?(r=[r,s,n],t=r):(ar=t,t=i)):(ar=t,t=i),t!==i&&(lr=e,t=(o=t)[0]+" "+o[2]),e=t,e===i&&(e=oi()),e}function Rr(){let e,t,r,s,n;var o;return e=ar,t=ar,r=ai(),r!==i?(s=Ii(),n=si(),n!==i?(r=[r,s,n],t=r):(ar=t,t=i)):(ar=t,t=i),t!==i&&(lr=e,t=(o=t)[0]+" "+o[2]),e=t,e===i&&(e=si()),e}function Or(){let e,t,r,s,n,o;if(e=ar,t=Fr(),t!==i){for(r=[],s=ar,Ii(),n=Ir(),n!==i?(Ii(),o=Fr(),o!==i?(lr=s,s=sr(0,n,o)):(ar=s,s=i)):(ar=s,s=i);s!==i;)r.push(s),s=ar,Ii(),n=Ir(),n!==i?(Ii(),o=Fr(),o!==i?(lr=s,s=sr(0,n,o)):(ar=s,s=i)):(ar=s,s=i);lr=e,e=Ei(t,r)}else ar=e,e=i;return e}function Ir(){let t;return t=e.charAt(ar),ve.test(t)?ar++:(t=i,0===pr&&vr(Ne)),t===i&&(e.substr(ar,2)===f?(t=f,ar+=2):(t=i,0===pr&&vr(ke))),t}function Fr(){let e,t,r,s,n,o;if(e=ar,t=Dr(),t!==i){for(r=[],s=ar,Ii(),n=Ar(),n!==i?(Ii(),o=Dr(),o!==i?(lr=s,s=nr(0,n,o)):(ar=s,s=i)):(ar=s,s=i);s!==i;)r.push(s),s=ar,Ii(),n=Ar(),n!==i?(Ii(),o=Dr(),o!==i?(lr=s,s=nr(0,n,o)):(ar=s,s=i)):(ar=s,s=i);lr=e,e=Ei(t,r)}else ar=e,e=i;return e}function Ar(){let t;return t=e.charAt(ar),we.test(t)?ar++:(t=i,0===pr&&vr(ze)),t}function Dr(){let t,r,s,n;var o;return t=function(){let t;return t=Zr(),t===i&&(t=function(){let e,t,r,s;var n;return e=ar,t=function(){let e,t,r,s;return e=ar,t=Kr(),t!==i?(r=ei(),r!==i?(s=ti(),s!==i?(lr=e,e=parseFloat(t+r+s)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=Kr(),t!==i?(r=ei(),r!==i?(lr=e,e=parseFloat(t+r)):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=Kr(),t!==i?(r=ti(),r!==i?(lr=e,e=parseFloat(t+r)):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=Kr(),t!==i&&(lr=e,t=parseFloat(t)),e=t))),e}(),t!==i?(r=ar,pr++,s=Lr(),pr--,s===i?r=void 0:(ar=r,r=i),r!==i?(lr=e,n=t,e={type:"number",location:fr(),value:n}):(ar=e,e=i)):(ar=e,e=i),e}(),t===i&&(t=function(){let t,r;return t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===w?ar+=4:(r=i,0===pr&&vr(tt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(r=[r,s],t=r):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i&&(lr=t,r={type:"boolean",location:fr(),value:!0}),t=r,t===i&&(t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,5),r.toLowerCase()===x?ar+=5:(r=i,0===pr&&vr(rt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(r=[r,s],t=r):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i&&(lr=t,r={type:"boolean",location:fr(),value:!1}),t=r),t}(),t===i&&(t=function(){let t,r;return t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===v?ar+=4:(r=i,0===pr&&vr(et)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(r=[r,s],t=r):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i&&(lr=t,r={type:"null",location:fr(),value:null}),t=r,t}(),t===i&&(t=function(){let e,t,r;var s,n;return e=ar,t=fi(),t!==i?(Ii(),r=Qr(),r!==i?(lr=e,"string"===(s=r).type&&(n=s.value,!0!==/^(\d{4})-(\d{1,2})-(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)?$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)?[ ]{0,1}(\+|\-)(\d{1,2}):(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})?[ ]{0,1}(\+|\-)(\d{1,2}):(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/.test(n)&&mr("Date literal is invalid")),e={type:"date",location:fr(),value:s.value}):(ar=e,e=i)):(ar=e,e=i),e}(),t===i&&(t=function(){let e,t,r;var s,n;return e=ar,t=pi(),t!==i?(Ii(),r=Qr(),r!==i?(lr=e,"string"===(s=r).type&&(n=s.value,!0!==/^(\d{4})-(\d{1,2})-(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)?$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)?[ ]{0,1}(\+|\-)(\d{1,2}):(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})?[ ]{0,1}(\+|\-)(\d{1,2}):(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/.test(n)&&mr("Timestamp literal is invalid")),e={type:"timestamp",location:fr(),value:s.value}):(ar=e,e=i)):(ar=e,e=i),e}(),t===i&&(t=function(){let t,r,s,n,o;var a,l,c;return t=ar,r=gi(),r!==i?(Ii(),s=e.charAt(ar),ve.test(s)?ar++:(s=i,0===pr&&vr(Ne)),s!==i?(Ii(),n=Qr(),n!==i?(Ii(),o=qr(),o!==i?(lr=t,a=s,l=n,c=o,t={type:"interval",location:fr(),value:l,qualifier:c,op:a}):(ar=t,t=i)):(ar=t,t=i)):(ar=t,t=i)):(ar=t,t=i),t===i&&(t=ar,r=gi(),r!==i?(Ii(),s=Qr(),s!==i?(Ii(),n=qr(),n!==i?(lr=t,t=function(e,t){return{type:"interval",location:fr(),value:e,qualifier:t,op:""}}(s,n)):(ar=t,t=i)):(ar=t,t=i)):(ar=t,t=i)),t}(),t===i&&(t=function(){let e,t,r;var s,n;return e=ar,t=mi(),t!==i?(Ii(),r=Qr(),r!==i?(lr=e,"string"===(s=r).type&&(n=s.value,!0!==/^(\d{1,2}):(\d{1,2}):(\d{1,2})$|^(\d{1,2}):(\d{1,2})$|^(\d{1,2}):(\d{1,2}):(\d{1,2}).([0-9]+)$/.test(n)&&mr("Time literal is invalid")),e={type:"time",location:fr(),value:s.value}):(ar=e,e=i)):(ar=e,e=i),e}()))))))),t}(),t===i&&(t=function(){let e,t,r,s,n,o,a,l;var c,u,d;return e=ar,t=hi(),t!==i?(Ii(),r=ar,s=Ri(),s!==i?(Ii(),n=Gr(),n!==i?(Ii(),o=di(),o!==i?(Ii(),a=Sr(),a!==i?(Ii(),l=Oi(),l!==i?(lr=r,u=n,d=a,r=Di(fr(),u,d)):(ar=r,r=i)):(ar=r,r=i)):(ar=r,r=i)):(ar=r,r=i)):(ar=r,r=i),r===i&&(r=ar,s=Ri(),s!==i?(Ii(),n=Gr(),n!==i?(Ii(),o=Mi(),o!==i?(Ii(),a=Sr(),a!==i?(Ii(),l=Oi(),l!==i?(lr=r,r=function(e,t){return Di(fr(),e,t)}(n,a)):(ar=r,r=i)):(ar=r,r=i)):(ar=r,r=i)):(ar=r,r=i)):(ar=r,r=i)),r!==i?(lr=e,c=r,e={type:"function",location:fr(),name:"extract",args:c}):(ar=e,e=i)):(ar=e,e=i),e}(),t===i&&(t=function(){let t,r,s,n,o,a,l,c,u,d,h;var p,f,m,g;return t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,9),r.toLowerCase()===D?ar+=9:(r=i,0===pr&&vr(pt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="SUBSTRING"):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i?(Ii(),s=ar,n=Ri(),n!==i?(Ii(),o=Sr(),o!==i?(Ii(),a=di(),a!==i?(Ii(),l=Sr(),l!==i?(Ii(),c=ar,u=function(){let t,r,s,n;return t=ar,r=e.substr(ar,3),r.toLowerCase()===A?ar+=3:(r=i,0===pr&&vr(ht)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="FOR"):(ar=t,t=i)):(ar=t,t=i),t}(),u!==i?(d=Ii(),h=Sr(),h!==i?(Ii(),c=h):(ar=c,c=i)):(ar=c,c=i),c===i&&(c=null),u=Oi(),u!==i?(lr=s,f=o,m=l,g=c,s=Di(fr(),f,m,...g?[g]:[])):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i),s===i&&(s=ar,n=Ri(),n!==i?(Ii(),o=Sr(),o!==i?(Ii(),a=Mi(),a!==i?(Ii(),l=Sr(),l!==i?(Ii(),c=Mi(),c!==i?(u=Ii(),d=Sr(),d!==i?(h=Oi(),h!==i?(lr=s,s=function(e,t,r){return Di(fr(),e,t,r)}(o,l,d)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)),s!==i?(lr=t,p=s,t={type:"function",location:fr(),name:"substring",args:p}):(ar=t,t=i)):(ar=t,t=i),t}(),t===i&&(t=function(){let t,r,s,n,o,a,l,c,u;var d,h,p,f;return t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===L?ar+=4:(r=i,0===pr&&vr(mt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="TRIM"):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i?(Ii(),s=ar,n=Ri(),n!==i?(Ii(),o=jr(),Ii(),a=Sr(),a!==i?(Ii(),l=di(),l!==i?(Ii(),c=Sr(),c!==i?(Ii(),u=Oi(),u!==i?(lr=s,h=o,p=a,f=c,s=Di(fr(),h,p,f)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i),s===i&&(s=ar,n=Ri(),n!==i?(Ii(),o=jr(),Ii(),a=Sr(),a!==i?(Ii(),l=Oi(),l!==i?(lr=s,s=function(e,t){return Di(fr(),e,t)}(o,a)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)),s!==i?(lr=t,d=s,t={type:"function",location:fr(),name:"trim",args:d}):(ar=t,t=i)):(ar=t,t=i),t}(),t===i&&(t=function(){let t,r,s,n,o,a,l,c;var u,d,h;return t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,8),r.toLowerCase()===V?ar+=8:(r=i,0===pr&&vr(gt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="POSITION"):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i?(Ii(),s=ar,n=Ri(),n!==i?(Ii(),o=Sr(),o!==i?(Ii(),a=si(),a!==i?(Ii(),l=Sr(),l!==i?(Ii(),c=Oi(),c!==i?(lr=s,d=o,h=l,s=Di(fr(),d,h)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i),s===i&&(s=ar,n=Ri(),n!==i?(Ii(),o=Sr(),o!==i?(Ii(),a=Mi(),a!==i?(Ii(),l=Sr(),l!==i?(Ii(),c=Oi(),c!==i?(lr=s,s=function(e,t){return Di(fr(),e,t)}(o,l)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)),s!==i?(lr=t,u=s,t={type:"function",location:fr(),name:"position",args:u}):(ar=t,t=i)):(ar=t,t=i),t}(),t===i&&(t=function(){let t,r,s,n,o,a,l,c;var u,d,h;return t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===G?ar+=4:(r=i,0===pr&&vr(St)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="CAST"):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i?(Ii(),s=ar,n=Ri(),n!==i?(Ii(),o=Sr(),o!==i?(Ii(),a=function(){let t,r,s,n;return t=ar,r=e.substr(ar,2),r.toLowerCase()===q?ar+=2:(r=i,0===pr&&vr(Tt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="AS"):(ar=t,t=i)):(ar=t,t=i),t}(),a!==i?(Ii(),l=zr(),l!==i?(Ii(),c=Oi(),c!==i?(lr=s,d=o,h=l,s=Di(fr(),d,h)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i),s===i&&(s=ar,n=Ri(),n!==i?(Ii(),o=Sr(),o!==i?(Ii(),a=Mi(),a!==i?(Ii(),l=zr(),l!==i?(Ii(),c=Oi(),c!==i?(lr=s,s=function(e,t){return Di(fr(),e,t)}(o,l)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)):(ar=s,s=i)),s!==i?(lr=t,u=s,t={type:"function",location:fr(),name:"cast",args:u}):(ar=t,t=i)):(ar=t,t=i),t}(),t===i&&(t=function(){let t,r,s,n;var o,a;return t=ar,r=ar,pr++,s=hi(),pr--,s===i?r=void 0:(ar=r,r=i),r!==i?(s=function(){let t,r,s,n;if(t=ar,r=Er(),r!==i&&(lr=t),t=r,t===i)if(t=ar,96===e.charCodeAt(ar)?(r=_e,ar++):(r=i,0===pr&&vr(Kt)),r!==i){if(s=[],n=e.charAt(ar),Ie.test(n)?ar++:(n=i,0===pr&&vr(er)),n!==i)for(;n!==i;)s.push(n),n=e.charAt(ar),Ie.test(n)?ar++:(n=i,0===pr&&vr(er));else s=i;s!==i?(96===e.charCodeAt(ar)?(n=_e,ar++):(n=i,0===pr&&vr(Kt)),n!==i?(lr=t,t=s.join("")):(ar=t,t=i)):(ar=t,t=i)}else ar=t,t=i;return t}(),s!==i?(Ii(),n=xr(),n!==i?(lr=t,o=s,a=n,t={type:"function",location:fr(),name:o,args:a}):(ar=t,t=i)):(ar=t,t=i)):(ar=t,t=i),t}(),t===i&&(t=function(){let e;return e=function(){let e,t,r,s,n,o,a;if(e=ar,t=Si(),t!==i)if(Ii(),r=Sr(),r!==i){for(Ii(),s=[],n=ar,o=Xr(),o!==i?(a=Ii(),n=o):(ar=n,n=i);n!==i;)s.push(n),n=ar,o=Xr(),o!==i?(a=Ii(),n=o):(ar=n,n=i);n=Ti(),n!==i?(lr=e,l=r,c=s,e={type:"case-expression",location:fr(),format:"simple",operand:l,clauses:c,else:null,elseLocation:null}):(ar=e,e=i)}else ar=e,e=i;else ar=e,e=i;var l,c;if(e===i)if(e=ar,t=Si(),t!==i)if(Ii(),r=Sr(),r!==i){for(Ii(),s=[],n=ar,o=Xr(),o!==i?(a=Ii(),n=o):(ar=n,n=i);n!==i;)s.push(n),n=ar,o=Xr(),o!==i?(a=Ii(),n=o):(ar=n,n=i);n=Jr(),n!==i?(o=Ii(),a=Ti(),a!==i?(lr=e,e=function(e,t,r){return{type:"case-expression",location:fr(),format:"simple",operand:e,clauses:t,else:r.value,elseLocation:r.location}}(r,s,n)):(ar=e,e=i)):(ar=e,e=i)}else ar=e,e=i;else ar=e,e=i;return e}(),e===i&&(e=function(){let e,t,r,s,n,o;if(e=ar,t=Si(),t!==i){for(Ii(),r=[],s=ar,n=Yr(),n!==i?(o=Ii(),s=n):(ar=s,s=i);s!==i;)r.push(s),s=ar,n=Yr(),n!==i?(o=Ii(),s=n):(ar=s,s=i);s=Ti(),s!==i?(lr=e,a=r,e={type:"case-expression",location:fr(),format:"searched",clauses:a,else:null,elseLocation:null}):(ar=e,e=i)}else ar=e,e=i;var a;if(e===i)if(e=ar,t=Si(),t!==i){for(Ii(),r=[],s=ar,n=Yr(),n!==i?(o=Ii(),s=n):(ar=s,s=i);s!==i;)r.push(s),s=ar,n=Yr(),n!==i?(o=Ii(),s=n):(ar=s,s=i);s=Jr(),s!==i?(n=Ii(),o=Ti(),o!==i?(lr=e,e=function(e,t){return{type:"case-expression",location:fr(),format:"searched",clauses:e,else:t.value,elseLocation:t.location}}(r,s)):(ar=e,e=i)):(ar=e,e=i)}else ar=e,e=i;return e}()),e}(),t===i&&(t=function(){let e,t;var r,s;return e=ar,t=function(){let e,t;return e=ar,t=function(){let e,t,r,s;if(e=ar,t=Lr(),t!==i){for(r=[],s=Ur();s!==i;)r.push(s),s=Ur();lr=e,e=t+r.join("")}else ar=e,e=i;return e}(),t!==i&&(lr=e),e=t,e}(),t!==i&&(lr=e,t=/^CURRENT_DATE$/i.test(r=t)?{type:"current-time",location:fr(),mode:"date"}:/^CURRENT_TIMESTAMP$/i.test(r)?{type:"current-time",location:fr(),mode:"timestamp"}:/^CURRENT_TIME$/i.test(r)?{type:"current-time",location:fr(),mode:"time"}:/^CURRENT_USER$/i.test(r)?{type:"current-user",location:fr()}:{type:"column-reference",location:fr(),table:"",column:r}),e=t,e===i&&(e=ar,t=function(){let e,t,r,s;return e=ar,t=Nr(),t!==i?(r=function(){let e,t,r;for(e=ar,t=[],r=Br();r!==i;)t.push(r),r=Br();return lr=e,t=t.join(""),e=t,e}(),s=Nr(),s!==i?(lr=e,e=r):(ar=e,e=i)):(ar=e,e=i),e}(),t!==i&&(lr=e,s=t,t={type:"column-reference",location:fr(),table:"",column:s,delimited:!0}),e=t),e}(),t===i&&(t=kr(),t===i&&(t=ar,r=Ri(),r!==i?(Ii(),s=Sr(),s!==i?(Ii(),n=Oi(),n!==i?(lr=t,(o=s).paren=!0,t=o):(ar=t,t=i)):(ar=t,t=i)):(ar=t,t=i))))))))))),t}function Er(){let e,t,r,s;if(e=ar,t=Lr(),t!==i){for(r=[],s=Vr();s!==i;)r.push(s),s=Vr();lr=e,e=t+r.join("")}else ar=e,e=i;return e}function Lr(){let t;return t=e.charAt(ar),xe.test(t)?ar++:(t=i,0===pr&&vr(je)),t}function Vr(){let t;return t=e.charAt(ar),Se.test(t)?ar++:(t=i,0===pr&&vr(Ge)),t}function Ur(){let t;return t=e.charAt(ar),Te.test(t)?ar++:(t=i,0===pr&&vr(qe)),t}function Br(){let t;return t=function(){let t;return t=e.charAt(ar),Te.test(t)?ar++:(t=i,0===pr&&vr(qe)),t}(),t===i&&(t=function(){let e,t,r;return e=ar,t=Nr(),t!==i?(r=Nr(),r!==i?(lr=e,e='"'):(ar=e,e=i)):(ar=e,e=i),e}()),t}function Nr(){let t;return t=e.charAt(ar),Ce.test(t)?ar++:(t=i,0===pr&&vr(He)),t}function kr(){let t,r,s,n;var o;return t=ar,r=ar,64===e.charCodeAt(ar)?(s=m,ar++):(s=i,0===pr&&vr(We)),s!==i?(n=Er(),n!==i?(s=[s,n],r=s):(ar=r,r=i)):(ar=r,r=i),r!==i&&(lr=t,o=r,r={type:"parameter",location:fr(),value:o[1]}),t=r,t}function zr(){let t,r,s,n,o;var a;return t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,7),r.toLowerCase()===H?ar+=7:(r=i,0===pr&&vr(Ct)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="INTEGER"):(ar=t,t=i)):(ar=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,3),r.toLowerCase()===W?ar+=3:(r=i,0===pr&&vr(Pt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="INT"):(ar=t,t=i)):(ar=t,t=i),t}()),r!==i&&(lr=t,r={type:"data-type",location:fr(),value:{type:"integer"}}),t=r,t===i&&(t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,8),r.toLowerCase()===$?ar+=8:(r=i,0===pr&&vr(Mt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="SMALLINT"):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i&&(lr=t,r={type:"data-type",location:fr(),value:{type:"smallint"}}),t=r,t===i&&(t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,5),r.toLowerCase()===Q?ar+=5:(r=i,0===pr&&vr(Rt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="FLOAT"):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i&&(lr=t,r={type:"data-type",location:fr(),value:{type:"float"}}),t=r,t===i&&(t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===Z?ar+=4:(r=i,0===pr&&vr(Ot)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="REAL"):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i&&(lr=t,r={type:"data-type",location:fr(),value:{type:"real"}}),t=r,t===i&&(t=ar,r=fi(),r!==i&&(lr=t,r={type:"data-type",location:fr(),value:{type:"date"}}),t=r,t===i&&(t=ar,r=pi(),r!==i&&(lr=t,r={type:"data-type",location:fr(),value:{type:"timestamp"}}),t=r,t===i&&(t=ar,r=mi(),r!==i&&(lr=t,r={type:"data-type",location:fr(),value:{type:"time"}}),t=r,t===i&&(t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,7),r.toLowerCase()===Y?ar+=7:(r=i,0===pr&&vr(It)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="VARCHAR"):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i?(Ii(),s=Ri(),s!==i?(Ii(),n=ri(),n!==i?(Ii(),o=Oi(),o!==i?(lr=t,a=n,t={type:"data-type",location:fr(),value:{type:"varchar",size:parseInt(a)}}):(ar=t,t=i)):(ar=t,t=i)):(ar=t,t=i)):(ar=t,t=i)))))))),t}function jr(){let t,r;var s;return t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,7),r.toLowerCase()===k?ar+=7:(r=i,0===pr&&vr(vt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="LEADING"):(ar=t,t=i)):(ar=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,8),r.toLowerCase()===z?ar+=8:(r=i,0===pr&&vr(wt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="TRAILING"):(ar=t,t=i)):(ar=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===j?ar+=4:(r=i,0===pr&&vr(xt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="BOTH"):(ar=t,t=i)):(ar=t,t=i),t}())),r===i&&(r=null),lr=t,s=r,r={type:"string",location:fr(),value:s??"BOTH"},t=r,t}function Gr(){let t,r;var s;return t=ar,r=yi(),r===i&&(r=_i(),r===i&&(r=bi(),r===i&&(r=vi(),r===i&&(r=wi(),r===i&&(r=xi(),r===i&&(r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,13),r.toLowerCase()===ee?ar+=13:(r=i,0===pr&&vr(Et)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="TIMEZONE_HOUR"):(ar=t,t=i)):(ar=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,15),r.toLowerCase()===te?ar+=15:(r=i,0===pr&&vr(Lt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="TIMEZONE_MINUTE"):(ar=t,t=i)):(ar=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,3),r.toLowerCase()===ae?ar+=3:(r=i,0===pr&&vr(zt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="DOW"):(ar=t,t=i)):(ar=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,3),r.toLowerCase()===le?ar+=3:(r=i,0===pr&&vr(jt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="DOY"):(ar=t,t=i)):(ar=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===ce?ar+=4:(r=i,0===pr&&vr(Gt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="WEEK"):(ar=t,t=i)):(ar=t,t=i),t}())))))))))),r!==i&&(lr=t,s=r,r={type:"string",location:fr(),value:s}),t=r,t}function qr(){let t,r,s,n;var o,a;return t=ar,r=function(){let e,t,r,s,n;var o,a;return e=ar,t=Hr(),t!==i?(Ii(),r=Ri(),r!==i?(Ii(),s=$r(),s!==i?(Ii(),n=Oi(),n!==i?(lr=e,o=t,a=s,e={type:"interval-period",location:fr(),period:o.value,precision:a,secondary:null}):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=Hr(),t!==i&&(lr=e,t=function(e){return{type:"interval-period",location:fr(),period:e.value,precision:null,secondary:null}}(t)),e=t),e}(),r!==i?(Ii(),s=function(){let t,r,s,n;return t=ar,r=e.substr(ar,2),r.toLowerCase()===X?ar+=2:(r=i,0===pr&&vr(Ft)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="TO"):(ar=t,t=i)):(ar=t,t=i),t}(),s!==i?(Ii(),n=function(){let e,t,r,s,n,o,a;var l,c,u;return e=ar,t=Hr(),t!==i&&(lr=e,l=t,t={type:"interval-period",location:fr(),period:l.value,precision:null,secondary:null}),e=t,e===i&&(e=ar,t=xi(),t!==i?(Ii(),r=Ri(),r!==i?(Ii(),s=$r(),s!==i?(Ii(),n=Mi(),n!==i?(Ii(),o=Wr(),o!==i?(Ii(),a=Oi(),a!==i?(lr=e,c=s,u=o,e={type:"interval-period",location:fr(),period:"second",precision:c,secondary:u}):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=xi(),t!==i?(Ii(),r=Ri(),r!==i?(Ii(),s=$r(),s!==i?(Ii(),n=Oi(),n!==i?(lr=e,e=function(e){return{type:"interval-period",location:fr(),period:"second",precision:e,secondary:null}}(s)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=xi(),t!==i&&(lr=e,t={type:"interval-period",location:fr(),period:"second",precision:null,secondary:null}),e=t))),e}(),n!==i?(lr=t,o=r,a=n,t={type:"interval-qualifier",location:fr(),start:o,end:a}):(ar=t,t=i)):(ar=t,t=i)):(ar=t,t=i),t===i&&(t=function(){let e,t,r,s,n,o,a;var l,c;return e=ar,t=Hr(),t!==i?(Ii(),r=Ri(),r!==i?(Ii(),s=Wr(),s!==i?(Ii(),n=Oi(),n!==i?(lr=e,l=t,c=s,e={type:"interval-period",location:fr(),period:l.value,precision:c,secondary:null}):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=Hr(),t!==i&&(lr=e,t=function(e){return{type:"interval-period",location:fr(),period:e.value,precision:null,secondary:null}}(t)),e=t,e===i&&(e=ar,t=xi(),t!==i?(Ii(),r=Ri(),r!==i?(Ii(),s=$r(),s!==i?(Ii(),n=Mi(),n!==i?(Ii(),o=Wr(),o!==i?(Ii(),a=Oi(),a!==i?(lr=e,e=function(e,t){return{type:"interval-period",location:fr(),period:"second",precision:e,secondary:t}}(s,o)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=xi(),t!==i?(Ii(),r=Ri(),r!==i?(Ii(),s=Wr(),s!==i?(Ii(),n=Oi(),n!==i?(lr=e,e=function(e){return{type:"interval-period",location:fr(),period:"second",precision:e,secondary:null}}(s)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i),e===i&&(e=ar,t=xi(),t!==i&&(lr=e,t={type:"interval-period",location:fr(),period:"second",precision:null,secondary:null}),e=t)))),e}()),t}function Hr(){let e,t;return e=ar,t=bi(),t!==i&&(lr=e,t={type:"string",location:fr(),value:"day"}),e=t,e===i&&(e=ar,t=vi(),t!==i&&(lr=e,t={type:"string",location:fr(),value:"hour"}),e=t,e===i&&(e=ar,t=wi(),t!==i&&(lr=e,t={type:"string",location:fr(),value:"minute"}),e=t,e===i&&(e=ar,t=_i(),t!==i&&(lr=e,t={type:"string",location:fr(),value:"month"}),e=t,e===i&&(e=ar,t=yi(),t!==i&&(lr=e,t={type:"string",location:fr(),value:"year"}),e=t)))),e}function Wr(){let e,t;return e=ar,t=ri(),t!==i&&(lr=e,t=parseFloat(t)),e=t,e}function $r(){let e,t;return e=ar,t=ri(),t!==i&&(lr=e,t=parseFloat(t)),e=t,e}function Qr(){let e;return e=Zr(),e===i&&(e=kr()),e}function Zr(){let t,r,s,n,o;if(t=ar,39===e.charCodeAt(ar)?(r=g,ar++):(r=i,0===pr&&vr($e)),r===i&&(e.substr(ar,2)===y?(r=y,ar+=2):(r=i,0===pr&&vr(Qe))),r!==i){for(s=[],n=ar,e.substr(ar,2)===_?(o=_,ar+=2):(o=i,0===pr&&vr(Ze)),o!==i&&(lr=n,o="'"),n=o,n===i&&(n=e.charAt(ar),Pe.test(n)?ar++:(n=i,0===pr&&vr(Ye)));n!==i;)s.push(n),n=ar,e.substr(ar,2)===_?(o=_,ar+=2):(o=i,0===pr&&vr(Ze)),o!==i&&(lr=n,o=or()),n=o,n===i&&(n=e.charAt(ar),Pe.test(n)?ar++:(n=i,0===pr&&vr(Ye)));39===e.charCodeAt(ar)?(n=g,ar++):(n=i,0===pr&&vr($e)),n!==i?(lr=t,a=s,t={type:"string",location:fr(),value:a.join("")}):(ar=t,t=i)}else ar=t,t=i;var a;return t}function Yr(){let e,t,r,s,n;var o,a;return e=ar,t=Ci(),t!==i?(Ii(),r=Sr(),r!==i?(Ii(),s=Pi(),s!==i?(Ii(),n=Sr(),n!==i?(lr=e,o=r,a=n,e={type:"when-clause",location:fr(),operand:o,value:a}):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i),e}function Xr(){let e,t,r,s,n;var o,a;return e=ar,t=Ci(),t!==i?(Ii(),r=Sr(),r!==i?(Ii(),s=Pi(),s!==i?(Ii(),n=Sr(),n!==i?(lr=e,o=r,a=n,e={type:"when-clause",location:fr(),operand:o,value:a}):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i)):(ar=e,e=i),e}function Jr(){let t,r,s;var n;return t=ar,r=function(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===fe?ar+=4:(r=i,0===pr&&vr(Qt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="ELSE"):(ar=t,t=i)):(ar=t,t=i),t}(),r!==i?(Ii(),s=Sr(),s!==i?(lr=t,n=s,t={type:"else-clause",location:fr(),value:n}):(ar=t,t=i)):(ar=t,t=i),t}function Kr(){let t,r,s;var n;return t=ri(),t===i&&(t=ar,r=e.charAt(ar),ve.test(r)?ar++:(r=i,0===pr&&vr(Ne)),r!==i?(s=ri(),s!==i?(lr=t,n=s,t=r[0]+n):(ar=t,t=i)):(ar=t,t=i)),t}function ei(){let t,r,s;var n;return t=ar,46===e.charCodeAt(ar)?(r=b,ar++):(r=i,0===pr&&vr(Xe)),r!==i?(s=ri(),s===i&&(s=null),lr=t,t="."+(null!=(n=s)?n:"")):(ar=t,t=i),t}function ti(){let t,r,s;return t=ar,r=function(){let t,r,s;var n;return t=ar,r=e.charAt(ar),Re.test(r)?ar++:(r=i,0===pr&&vr(Ke)),r!==i?(s=e.charAt(ar),ve.test(s)?ar++:(s=i,0===pr&&vr(Ne)),s===i&&(s=null),lr=t,t="e"+(null===(n=s)?"":n)):(ar=t,t=i),t}(),r!==i?(s=ri(),s!==i?(lr=t,t=r+s):(ar=t,t=i)):(ar=t,t=i),t}function ri(){let e,t,r;if(e=ar,t=[],r=ii(),r!==i)for(;r!==i;)t.push(r),r=ii();else t=i;return t!==i&&(lr=e,t=t.join("")),e=t,e}function ii(){let t;return t=e.charAt(ar),Me.test(t)?ar++:(t=i,0===pr&&vr(Je)),t}function si(){let t,r,s,n;return t=ar,r=e.substr(ar,2),r.toLowerCase()===S?ar+=2:(r=i,0===pr&&vr(it)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="IN"):(ar=t,t=i)):(ar=t,t=i),t}function ni(){let t,r,s,n;return t=ar,r=e.substr(ar,2),r.toLowerCase()===T?ar+=2:(r=i,0===pr&&vr(st)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="IS"):(ar=t,t=i)):(ar=t,t=i),t}function oi(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===C?ar+=4:(r=i,0===pr&&vr(nt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="LIKE"):(ar=t,t=i)):(ar=t,t=i),t}function ai(){let t,r,s,n;return t=ar,r=e.substr(ar,3),r.toLowerCase()===M?ar+=3:(r=i,0===pr&&vr(at)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="NOT"):(ar=t,t=i)):(ar=t,t=i),t}function li(){let t,r,s,n;return t=ar,r=e.substr(ar,3),r.toLowerCase()===R?ar+=3:(r=i,0===pr&&vr(lt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="AND"):(ar=t,t=i)):(ar=t,t=i),t}function ci(){let t,r,s,n;return t=ar,r=e.substr(ar,2),r.toLowerCase()===O?ar+=2:(r=i,0===pr&&vr(ct)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="OR"):(ar=t,t=i)):(ar=t,t=i),t}function ui(){let t,r,s,n;return t=ar,r=e.substr(ar,7),r.toLowerCase()===I?ar+=7:(r=i,0===pr&&vr(ut)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="BETWEEN"):(ar=t,t=i)):(ar=t,t=i),t}function di(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===F?ar+=4:(r=i,0===pr&&vr(dt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="FROM"):(ar=t,t=i)):(ar=t,t=i),t}function hi(){let t,r,s,n;return t=ar,r=e.substr(ar,7),r.toLowerCase()===E?ar+=7:(r=i,0===pr&&vr(ft)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="EXTRACT"):(ar=t,t=i)):(ar=t,t=i),t}function pi(){let t,r,s,n;return t=ar,r=e.substr(ar,9),r.toLowerCase()===U?ar+=9:(r=i,0===pr&&vr(yt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="TIMESTAMP"):(ar=t,t=i)):(ar=t,t=i),t}function fi(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===B?ar+=4:(r=i,0===pr&&vr(_t)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="DATE"):(ar=t,t=i)):(ar=t,t=i),t}function mi(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===N?ar+=4:(r=i,0===pr&&vr(bt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="TIME"):(ar=t,t=i)):(ar=t,t=i),t}function gi(){let t,r,s,n;return t=ar,r=e.substr(ar,8),r.toLowerCase()===J?ar+=8:(r=i,0===pr&&vr(At)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="INTERVAL"):(ar=t,t=i)):(ar=t,t=i),t}function yi(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===K?ar+=4:(r=i,0===pr&&vr(Dt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="YEAR"):(ar=t,t=i)):(ar=t,t=i),t}function _i(){let t,r,s,n;return t=ar,r=e.substr(ar,5),r.toLowerCase()===re?ar+=5:(r=i,0===pr&&vr(Vt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="MONTH"):(ar=t,t=i)):(ar=t,t=i),t}function bi(){let t,r,s,n;return t=ar,r=e.substr(ar,3),r.toLowerCase()===ie?ar+=3:(r=i,0===pr&&vr(Ut)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="DAY"):(ar=t,t=i)):(ar=t,t=i),t}function vi(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===se?ar+=4:(r=i,0===pr&&vr(Bt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="HOUR"):(ar=t,t=i)):(ar=t,t=i),t}function wi(){let t,r,s,n;return t=ar,r=e.substr(ar,6),r.toLowerCase()===ne?ar+=6:(r=i,0===pr&&vr(Nt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="MINUTE"):(ar=t,t=i)):(ar=t,t=i),t}function xi(){let t,r,s,n;return t=ar,r=e.substr(ar,6),r.toLowerCase()===oe?ar+=6:(r=i,0===pr&&vr(kt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="SECOND"):(ar=t,t=i)):(ar=t,t=i),t}function Si(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===ue?ar+=4:(r=i,0===pr&&vr(qt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="CASE"):(ar=t,t=i)):(ar=t,t=i),t}function Ti(){let t,r,s,n;return t=ar,r=e.substr(ar,3),r.toLowerCase()===de?ar+=3:(r=i,0===pr&&vr(Ht)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="END"):(ar=t,t=i)):(ar=t,t=i),t}function Ci(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===he?ar+=4:(r=i,0===pr&&vr(Wt)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="WHEN"):(ar=t,t=i)):(ar=t,t=i),t}function Pi(){let t,r,s,n;return t=ar,r=e.substr(ar,4),r.toLowerCase()===pe?ar+=4:(r=i,0===pr&&vr($t)),r!==i?(s=ar,pr++,n=Vr(),pr--,n===i?s=void 0:(ar=s,s=i),s!==i?(lr=t,t="THEN"):(ar=t,t=i)):(ar=t,t=i),t}function Mi(){let t;return 44===e.charCodeAt(ar)?(t=me,ar++):(t=i,0===pr&&vr(Zt)),t}function Ri(){let t;return 40===e.charCodeAt(ar)?(t=ge,ar++):(t=i,0===pr&&vr(Yt)),t}function Oi(){let t;return 41===e.charCodeAt(ar)?(t=ye,ar++):(t=i,0===pr&&vr(Xt)),t}function Ii(){let e,t;for(e=[],t=Fi();t!==i;)e.push(t),t=Fi();return e}function Fi(){let t;return t=e.charAt(ar),Oe.test(t)?ar++:(t=i,0===pr&&vr(Jt)),t}function Ai(e,t,r,i,s){const n={type:"binary-expression",location:s,operator:e,left:t,right:r};return void 0!==i&&(n.escape=i),n}function Di(e,...t){return{type:"expression-list",location:e,value:t}}function Ei(e,t){let r=e;for(const{op:e,expr:i,location:{end:s}}of t)r=Ai(e,r,i,void 0,{...r.location,end:s});return r}ur=o();const Li=ur!==i&&ar===e.length;function Vi(){throw ur!==i&&ar<e.length&&vr({type:"end"}),function(e,r,i){return new t(t.buildMessage(e,r),e,r,i)}(hr,dr<e.length?function(t=ar){const r=e.codePointAt(t);return void 0===r?"":String.fromCodePoint(r)}(dr):null,dr<e.length?br(dr,dr+1):br(dr,dr))}return r.peg$library?{peg$result:ur,peg$currPos:ar,peg$FAILED:i,peg$maxFailExpected:hr,peg$maxFailPos:dr,peg$success:Li,peg$throw:Li?void 0:Vi}:Li?ur:void Vi()}(e)}},e.visitAll=function e(t,r){if(null!=t)switch(r(t),t.type){case"when-clause":e(t.operand,r),e(t.value,r);break;case"case-expression":for(const i of t.clauses)e(i,r);"simple"===t.format&&e(t.operand,r),null!==t.else&&e(t.else,r);break;case"expression-list":for(const i of t.value)e(i,r);break;case"unary-expression":e(t.expr,r);break;case"binary-expression":e(t.left,r),e(t.right,r);break;case"function":e(t.args,r);break;case"interval":e(t.value,r),e(t.qualifier,r);break;case"interval-qualifier":e(t.start,r),e(t.end,r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/geometryUtils":function(){define(["exports","../featureConversionUtils","../OptimizedGeometry"],function(e,t,r){"use strict";const i=new r,s=new r,n=new r,o={esriGeometryPoint:t.convertToPoint,esriGeometryPolyline:t.convertToPolyline,esriGeometryPolygon:t.convertToPolygon,esriGeometryMultipoint:t.convertToMultipoint},a="_geVersion",l=(e,t)=>e===a?void 0:t;e.cleanFromGeometryEngine=function(e){return e&&a in e?JSON.parse(JSON.stringify(e,l)):e},e.getGeometry=function(e,r,a,l,c,u,d=r,h=a){const p=r&&d,f=a&&h,m=null!=l?"coords"in l?l:l.geometry:null;if(null==m)return null;if(c){let i=t.generalizeOptimizedGeometry(s,m,r,a,e,c,d,h);return u&&(i=t.quantizeOptimizedGeometry(n,i,p,f,e,u)),o[e]?.(i,p,f)??null}if(u){const i=t.quantizeOptimizedGeometry(n,m,r,a,e,u,d,h);return o[e]?.(i,p,f)??null}return t.removeZMValues(i,m,r,a,d,h),o[e]?.(i,p,f)??null},e.transformCentroid=function(e,r,i,s=e.hasZ,o=e.hasM){if(null==r)return null;const a=e.hasZ&&s,l=e.hasM&&o;if(i){const c=t.quantizeOptimizedGeometry(n,r,e.hasZ,e.hasM,"esriGeometryPoint",i,s,o);return t.convertToPoint(c,a,l)}return t.convertToPoint(r,a,l)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/projectionSupport":function(){define(["exports","../../../core/arrayUtils","../../../core/promiseUtils","../../../geometry/projectionUtils","../../../geometry/geometryAdapters/json","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils"],function(e,t,r,i,s,n,o){"use strict";const a=[0,0];function l(e,t){if(!t)return null;if("x"in t){const r={x:0,y:0};return[r.x,r.y]=e(t.x,t.y,a),null!=t.z&&(r.z=t.z),null!=t.m&&(r.m=t.m),r}if("xmin"in t){const r={xmin:0,ymin:0,xmax:0,ymax:0};return[r.xmin,r.ymin]=e(t.xmin,t.ymin,a),[r.xmax,r.ymax]=e(t.xmax,t.ymax,a),t.hasZ&&(r.zmin=t.zmin,r.zmax=t.zmax,r.hasZ=!0),t.hasM&&(r.mmin=t.mmin,r.mmax=t.mmax,r.hasM=!0),r}return"rings"in t?{rings:c(t.rings,e),hasM:t.hasM,hasZ:t.hasZ}:"paths"in t?{paths:c(t.paths,e),hasM:t.hasM,hasZ:t.hasZ}:"points"in t?{points:u(t.points,e),hasM:t.hasM,hasZ:t.hasZ}:null}function c(e,t){const r=[];for(const i of e)r.push(u(i,t));return r}function u(e,t){const r=[];for(const i of e){const e=t(i[0],i[1],[0,0]);r.push(e),i.length>2&&e.push(i[2]),i.length>3&&e.push(i[3])}return r}const d=l.bind(null,o.lngLatToXY),h=l.bind(null,o.xyToLngLat),p=new class{constructor(){this._jobs=[],this._timer=null,this._process=this._process.bind(this)}async push(e,t,i,s){if(!e?.length||!t||!i||n.equals(t,i))return e;const o={geometries:e,inSpatialReference:t,outSpatialReference:i,geographicTransformation:s,resolve:r.createResolver()};return this._jobs.push(o),this._timer??=setTimeout(this._process,10),o.resolve.promise}_process(){this._timer=null;const e=this._jobs.shift();if(!e)return;const{geometries:t,inSpatialReference:r,outSpatialReference:a,resolve:l,geographicTransformation:c}=e;o.canProject(r,a)?n.isWebMercator(a)?l(t.map(d)):l(t.map(h)):l(i.projectMany(s.jsonAdapter,t,r,a,c,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}};e.checkProjectionSupport=async function(e,r){if(!e||!r)return;const s=Array.isArray(e)?e.map(e=>null!=e.geometry?e.geometry.spatialReference:null).filter(t.isSome):[e];await i.initializeProjection(s.map(e=>({source:e,dest:r})))},e.project=function(e,t,r,a){if(!e)return null;if(r||(r=t,t=e.spatialReference),!n.isValid(t)||!n.isValid(r)||n.equals(t,r))return e;if(o.canProject(t,r)){const t=n.isWebMercator(r)?d(e):h(e);return t.spatialReference=r,t}return i.projectMany(s.jsonAdapter,[e],t,r,null,a)[0]},e.projectMany=function(e,t,r,i){return p.push(e,t,r,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/geometryAdapters/json":function(){define(["exports"],function(e){"use strict";const t={convertToGEGeometry:function(e,t){return null==t?null:e.convertJSONToGeometry(t)},exportPoint:function(e,t,i){const s=new r(e.getPointX(t),e.getPointY(t),i),n=e.hasZ(t),o=e.hasM(t);return n&&(s.z=e.getPointZ(t)),o&&(s.m=e.getPointM(t)),s},exportPolygon:function(e,t,r){return new i(e.exportPaths(t),r,e.hasZ(t),e.hasM(t))},exportPolyline:function(e,t,r){return new s(e.exportPaths(t),r,e.hasZ(t),e.hasM(t))},exportMultipoint:function(e,t,r){return new n(e.exportPoints(t),r,e.hasZ(t),e.hasM(t))},exportExtent:function(e,t,r){const i=e.hasZ(t),s=e.hasM(t),n=new o(e.getXMin(t),e.getYMin(t),e.getXMax(t),e.getYMax(t),r);if(i){const r=e.getZExtent(t);n.zmin=r.vmin,n.zmax=r.vmax}if(s){const r=e.getMExtent(t);n.mmin=r.vmin,n.mmax=r.vmax}return n}};class r{constructor(e,t,r){this.x=e,this.y=t,this.spatialReference=r,this.z=void 0,this.m=void 0}}class i{constructor(e,t,r,i){this.rings=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,r&&(this.hasZ=r),i&&(this.hasM=i)}}class s{constructor(e,t,r,i){this.paths=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,r&&(this.hasZ=r),i&&(this.hasM=i)}}class n{constructor(e,t,r,i){this.points=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,r&&(this.hasZ=r),i&&(this.hasM=i)}}class o{constructor(e,t,r,i,s){this.xmin=e,this.ymin=t,this.xmax=r,this.ymax=i,this.spatialReference=s,this.zmin=void 0,this.zmax=void 0,this.mmin=void 0,this.mmax=void 0}}e.jsonAdapter=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/QueryEngineCache":function(){define(["exports","../../../core/has"],function(e,t){"use strict";let r=0;class i{constructor(e){this.items=e,this.time=performance.now(),this.id=r++}}e.QueryEngineCache=class{constructor(){this._storage=new Map,this._purgeInterval=5,this._sweep=()=>{if(this._timer=void 0,!this._storage)return;const e=1e3*this._purgeInterval,t=performance.now()-e;for(const[r,i]of this._storage){if(!(i.time<t))return void(this._storage.size>0&&(this._timer=setTimeout(this._sweep,e)));this._storage.delete(r)}}}destroy(){this._storage?.clear(),this._storage=null,clearTimeout(this._timer)}put(e,t){this._storage?.set(e,new i(t)),this._scheduleSweep()}get(e){const t=this._storage?.get(e);if(t)return this._storage?.delete(e),t.time=performance.now(),this._storage?.set(e,t),t.items}clear(){this._storage?.clear()}_scheduleSweep(){this._storage&&(this._timer??=setTimeout(this._sweep,1e3*this._purgeInterval))}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/QueryEngineResult":function(){define(["require","exports","../../../core/lang","../../../geometry/support/centroid","../../../geometry/support/extentUtils","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","./AttributesBuilder","./geometryUtils","./projectionSupport","./queryUtils","./SnappingCandidate","../../support/fieldUtils","../../../rest/support/AutoIntervalBinParameters","../../../rest/support/DateBinParameters","../../../rest/support/DateBinUtils","../../../rest/support/FixedBoundariesBinParameters","../../../rest/support/FixedIntervalBinParameters","../../../statistics/utils","../../../time/constants","../../../chunks/datetime"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v){"use strict";const w="bin";function x(e,t,r,i){const s=i.x-r.x,n=i.y-r.y,o=t.x-r.x,a=t.y-r.y,l=s*s+n*n;if(0===l)return!1;const c=o*s+a*n,u=Math.min(1,Math.max(0,c/l));return e.x=r.x+s*u,e.y=r.y+n*u,!0}function S(e,t){return e?t?4:3:t?3:2}class T{constructor(e,t){this.coords=e,this.coordsIndex=t}get x(){return this.coords[this.coordsIndex]}get y(){return this.coords[this.coordsIndex+1]}get z(){return this.coords[this.coordsIndex+2]}}const C=[1];t.QueryEngineResult=class{constructor(e,t,r){this.items=e,this.query=t,this.geometryType=r.geometryType,this.hasM=r.hasM,this.hasZ=r.hasZ,this.fieldsIndex=r.fieldsIndex,this.objectIdField=r.objectIdField,this.spatialReference=r.spatialReference,this.featureAdapter=r.featureAdapter}get size(){return this.items.length}createQueryResponseForCount(){const e=new a(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return e.countDistinctValues(this.items);const{groupByFieldsForStatistics:t,having:r,outStatistics:i}=this.query,s=t?.length;if(!s)return 1;const n=new Map,o=new Map,l=new Set;for(const s of i){const{statisticType:i}=s,a="exceedslimit"!==i?s.onStatisticField:void 0;if(!o.has(a)){const r=[];for(const i of t){const t=this._getAttributeValues(e,i,this.items,n);r.push(t)}o.set(a,this._calculateUniqueValues(r,this.items,e.returnDistinctValues))}const c=o.get(a);for(const t in c){const{data:i,items:s}=c[t],n=i.join(",");r&&!e.validateItems(s,r)||l.add(n)}}return l.size}async createQueryResponse(){let e;if(e=this.query.outStatistics?this.query.outStatistics.some(e=>"exceedslimit"===e.statisticType)?this._createExceedsLimitQueryResponse():await this._createStatisticsQueryResponse(this.query,this.items):this._createFeatureQueryResponse(this.query),this.query.returnQueryGeometry){const t=this.query.geometry;o.isValid(this.query.outSR)&&!o.equals(t.spatialReference,this.query.outSR)?e.queryGeometry=l.cleanFromGeometryEngine({spatialReference:this.query.outSR,...c.project(t,t.spatialReference,this.query.outSR)}):e.queryGeometry=l.cleanFromGeometryEngine({spatialReference:this.query.outSR,...t})}return e}createSnappingResponse(e,t,r){const i=this.featureAdapter,s=S(this.hasZ,this.hasM),{point:n,mode:o}=e,a="number"==typeof e.distance?e.distance:e.distance.x,l="number"==typeof e.distance?e.distance:e.distance.y,c={candidates:[]},u="esriGeometryPolygon"===this.geometryType,h="esriGeometryPolyline"===this.geometryType||"esriGeometryPoint"===this.geometryType,p=this._getPointCreator(o,t,this.spatialReference,r),f=new T(null,0),m=new T(null,0),g={x:0,y:0,z:0};for(const t of this.items){const r=i.getGeometry(t);if(null==r)continue;const{coords:o}=r,y=r.isPoint?C:r.lengths;if(f.coords=o,m.coords=o,e.returnEdge){let e=0;for(let r=0;r<y.length;r++){const o=y[r],h=e;for(let r=0;r<o;r++,e+=s){if(!u&&r===o-1)continue;const y=f;y.coordsIndex=e;const _=m;_.coordsIndex=r===o-1?h:e+s;const b=g;if(!x(g,n,y,_))continue;const v=(n.x-b.x)/a,w=(n.y-b.y)/l,S=v*v+w*w;S<=1&&c.candidates.push(d.makeEdgeCandidate(i.getObjectId(t),p(b),Math.sqrt(S),p(y),p(_)))}}}if("all"===e.vertexMode){let e=0;for(let r=0;r<y.length;r++){const o=y[r],h=e,g=m;g.coordsIndex=h;for(let r=0;r<o;r++,e+=s){const s=f;if(s.coordsIndex=e,u&&r===o-1&&s.x===g.x&&s.y===g.y)continue;const h=(n.x-s.x)/a,m=(n.y-s.y)/l,y=h*h+m*m;y<=1&&c.candidates.push(d.makeVertexCandidate(i.getObjectId(t),p(s),Math.sqrt(y)))}}}else if(h&&"ends"===e.vertexMode){let e=0;const r=[];for(let t=0;t<y.length;t++){r.push(e);const i=y[t];e+=i*s,!u&&i>1&&r.push(e-s)}for(const e of r){const r=f;r.coordsIndex=e;const s=(n.x-r.x)/a,o=(n.y-r.y)/l,u=s*s+o*o;u<=1&&c.candidates.push(d.makeVertexCandidate(i.getObjectId(t),p(r),Math.sqrt(u)))}}}return c.candidates.sort((e,t)=>e.distance-t.distance),c}_getPointCreator(e,t,r,i){const s=null==i||o.equals(r,i)?e=>e:e=>c.project(e,r,i),{hasZ:n}=this;return"3d"===e?n&&t?({x:e,y:t,z:r})=>s({x:e,y:t,z:r}):({x:e,y:t})=>s({x:e,y:t,z:0}):({x:e,y:t})=>s({x:e,y:t})}async createSummaryStatisticsResponse(e){const{field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,minValue:o,maxValue:a,scale:l,timeZone:c,outStatisticTypes:u}=e,d=this.fieldsIndex.get(t),p=h.isDateField(d)||h.isDateOnlyField(d)||h.isTimestampOffsetField(d),f=await this._getDataValues({field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,scale:l,timeZone:c},this.items),m=_.isNullCountSupported({normalizationType:s,normalizationField:i,minValue:o,maxValue:a}),g={value:.5,fieldType:d?.type},y=h.isStringField(d)?_.calculateStringStatistics({values:f,supportsNullCount:m,percentileParams:g,outStatisticTypes:u}):_.calculateStatistics({values:f,minValue:o,maxValue:a,useSampleStdDev:!s,supportsNullCount:m,percentileParams:g,outStatisticTypes:u});return _.processSummaryStatisticsResult(y,u,p)}async createUniqueValuesResponse(e){const{field:t,valueExpression:r,domains:i,returnAllCodedValues:s,scale:n,timeZone:o}=e,a=await this._getDataValues({field:t,field2:e.field2,field3:e.field3,fieldDelimiter:e.fieldDelimiter,valueExpression:r,scale:n,timeZone:o},this.items,!1),l=_.calculateUniqueValuesCount(a);return _.createUVResult(l,i,s,e.fieldDelimiter)}async createClassBreaksResponse(e){const{field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,classificationMethod:o,standardDeviationInterval:a,minValue:l,maxValue:c,numClasses:u,scale:d,timeZone:h}=e,p=await this._getDataValues({field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,scale:d,timeZone:h},this.items),f=_.calculateClassBreaks(p,{field:t,normalizationField:i,normalizationType:s,normalizationTotal:n,classificationMethod:o,standardDeviationInterval:a,minValue:l,maxValue:c,numClasses:u});return _.resolveCBResult(f,o)}async createHistogramResponse(e){const{field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,classificationMethod:o,standardDeviationInterval:a,minValue:l,maxValue:c,numBins:u,scale:d,timeZone:h}=e,p=await this._getDataValues({field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,scale:d,timeZone:h},this.items);return _.calculateHistogram(p,{field:t,normalizationField:i,normalizationType:s,normalizationTotal:n,classificationMethod:o,standardDeviationInterval:a,minValue:l,maxValue:c,numBins:u})}_sortFeatures(e,t,r){if(e.length>1&&t?.length)for(const i of t.slice().reverse()){const t=i.split(" "),s=t[0],n=this.fieldsIndex.get(s),o=!!t[1]&&"desc"===t[1].toLowerCase(),a=_.getAttributeComparator(n?.type,o);e.sort((e,t)=>{const i=r(e,s,n),o=r(t,s,n);return a(i,o)})}}_createFeatureQueryResponse(e){const{items:t,geometryType:r,hasM:i,hasZ:s,objectIdField:o,spatialReference:a}=this,{outFields:c,outSR:u,quantizationParameters:d,resultRecordCount:h,resultOffset:p,returnZ:f,returnM:m}=e,g=null!=h&&t.length>(p||0)+h,y=c&&(c.includes("*")?[...this.fieldsIndex.fields]:c.map(e=>this.fieldsIndex.get(e)));return{exceededTransferLimit:g,features:this._createFeatures(e,t),fields:y,geometryType:r,hasM:i&&m,hasZ:s&&f,objectIdFieldName:o,spatialReference:l.cleanFromGeometryEngine(u||a),transform:d&&n.toQuantizationTransform(d)||null}}_createFeatures(e,t){const r=new a(e,this.featureAdapter,this.fieldsIndex),{hasM:i,hasZ:s}=this,{orderByFields:o,quantizationParameters:c,returnGeometry:u,returnCentroid:d,maxAllowableOffset:h,resultOffset:p,resultRecordCount:f,returnZ:m=!1,returnM:g=!1}=e,y=s&&m,_=i&&g;let b=[],v=0;const w=[...t];if(this._sortFeatures(w,o,(e,t,i)=>r.getFieldValue(e,t,i)),this.geometryType&&(u||d)){const e=n.toQuantizationTransform(c)??void 0,t="esriGeometryPolygon"===this.geometryType||"esriGeometryPolyline"===this.geometryType;if(u&&!d)for(const i of w){const s=this.featureAdapter.getGeometry(i),n={attributes:r.getAttributes(i),geometry:l.getGeometry(this.geometryType,this.hasZ,this.hasM,s,h,e,y,_),metadata:this.featureAdapter.getMetadata?.(i)};t&&s&&!n.geometry&&(n.centroid=l.transformCentroid(this,this.featureAdapter.getCentroid(i,this),e)),b[v++]=n}else if(!u&&d)for(const t of w)b[v++]={attributes:r.getAttributes(t),centroid:l.transformCentroid(this,this.featureAdapter.getCentroid(t,this),e)};else for(const t of w)b[v++]={attributes:r.getAttributes(t),centroid:l.transformCentroid(this,this.featureAdapter.getCentroid(t,this),e),geometry:l.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),h,e,y,_),metadata:this.featureAdapter.getMetadata?.(t)}}else for(const e of w){const t=r.getAttributes(e);t&&(b[v++]={attributes:t})}const x=p||0;if(null!=f){const e=x+f;b=b.slice(x,Math.min(b.length,e))}return b}_createExceedsLimitQueryResponse(){let e=!1,t=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY;for(const e of this.query.outStatistics??[])if("exceedslimit"===e.statisticType){t=null!=e.maxPointCount?e.maxPointCount:Number.POSITIVE_INFINITY,r=null!=e.maxRecordCount?e.maxRecordCount:Number.POSITIVE_INFINITY,i=null!=e.maxVertexCount?e.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)e=this.items.length>t;else if(this.items.length>r)e=!0;else{const t=S(this.hasZ,this.hasM),r=this.featureAdapter;e=this.items.reduce((e,t)=>{const i=r.getGeometry(t);return e+(null!=i&&i.coords.length||0)},0)/t>i}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(e)}}]}}async _createStatisticsQueryResponse(e,t,r={attributes:{}}){const i=[],s=new Map,n=new Map,o=new Map,l=new Map,c=new a(e,this.featureAdapter,this.fieldsIndex),u=e.outStatistics,{groupByFieldsForStatistics:d,having:p,orderByFields:f,resultRecordCount:m}=e,g=d?.length,y=!!g,_=y?d[0]:null,b=y&&!this.fieldsIndex.get(_);for(const e of u??[]){const{outStatisticFieldName:a,statisticType:u}=e,f=e,m="exceedslimit"!==u?e.onStatisticField:void 0,v="percentile_disc"===u||"percentile_cont"===u,w="EnvelopeAggregate"===u||"CentroidAggregate"===u||"ConvexHullAggregate"===u,x=y&&1===g&&(m===_||b)&&"count"===u;if(y){if(!o.has(m)){const e=[];for(const r of d){const i=this._getAttributeValues(c,r,t,s);e.push(i)}o.set(m,this._calculateUniqueValues(e,t,!w&&c.returnDistinctValues))}const e=o.get(m);if(!e)continue;const r=Object.keys(e);for(const i of r){const{count:r,data:n,items:o,itemPositions:u}=e[i],h=n.join(",");if(!p||c.validateItems(o,p)){const e=l.get(h)||{attributes:{}};if(w){e.aggregateGeometries||(e.aggregateGeometries={});const{aggregateGeometries:t,outStatisticFieldName:r}=await this._getAggregateGeometry(f,o);e.aggregateGeometries[r]=t}else{let i=null;if(x)i=r;else{const e=this._getAttributeValues(c,m,t,s),r=u.map(t=>e[t]);i=v&&"statisticParameters"in f?this._getPercentileValue(f,r):this._getStatisticValue(f,r,null,c.returnDistinctValues)}e.attributes[a]=i}let i=0;d.forEach((t,r)=>e.attributes[this.fieldsIndex.get(t)?t:"EXPR_"+ ++i]=n[r]),l.set(h,e)}}}else if(w){r.aggregateGeometries||(r.aggregateGeometries={});const{aggregateGeometries:e,outStatisticFieldName:i}=await this._getAggregateGeometry(f,t);r.aggregateGeometries[i]=e}else{const e=this._getAttributeValues(c,m,t,s);r.attributes[a]=v&&"statisticParameters"in f?this._getPercentileValue(f,e):this._getStatisticValue(f,e,n,c.returnDistinctValues)}const S="min"!==u&&"max"!==u||!h.isStringField(this.fieldsIndex.get(m))&&!this._isAnyDateField(m)?null:this.fieldsIndex.get(m)?.type;i.push({name:a,alias:a,type:S||"esriFieldTypeDouble"})}const v=y?Array.from(l.values()):[r];return this._sortFeatures(v,f,(e,t)=>e.attributes[t]),m&&(v.length=Math.min(m,v.length)),{fields:i,features:v}}_isAnyDateField(e){const t=this.fieldsIndex.get(e);return h.isDateField(t)||h.isDateOnlyField(t)||h.isTimestampOffsetField(t)||h.isTimeOnlyField(t)}async _getAggregateGeometry(t,r){const{convexHull:n,union:o}=await new Promise((t,r)=>e(["../../../geometry/geometryEngineJSON"],t,r)),{statisticType:a,outStatisticFieldName:c}=t,{featureAdapter:u,spatialReference:d,geometryType:h,hasZ:p,hasM:f}=this,m=r.map(e=>l.getGeometry(h,p,f,u.getGeometry(e))),g=n(d,m,!0)[0],y={aggregateGeometries:null,outStatisticFieldName:null};if("EnvelopeAggregate"===a){const e=g?s.getPolygonExtent(g):s.getGeometryExtent(o(d,m));y.aggregateGeometries={...e,spatialReference:d},y.outStatisticFieldName=c||"extent"}else if("CentroidAggregate"===a){const e=g?i.polygonCentroid(g):i.extentCentroid(s.getGeometryExtent(o(d,m)));y.aggregateGeometries={x:e[0],y:e[1],spatialReference:d},y.outStatisticFieldName=c||"centroid"}else"ConvexHullAggregate"===a&&(y.aggregateGeometries=g,y.outStatisticFieldName=c||"convexHull");return y}_getStatisticValue(e,t,r,i){const{onStatisticField:s,statisticType:n}=e;let o=null;return o=r?.has(s)?r.get(s):h.isStringField(this.fieldsIndex.get(s))||this._isAnyDateField(s)?_.calculateStringStatistics({values:t,returnDistinct:i}):_.calculateStatistics({values:i?[...new Set(t)]:t,minValue:null,maxValue:null,useSampleStdDev:!0}),r&&r.set(s,o),o["var"===n?"variance":n]}_getPercentileValue(e,t){const{onStatisticField:r,statisticParameters:i,statisticType:s}=e,{value:n,orderBy:o}=i,a=this.fieldsIndex.get(r),l={value:n,orderBy:o,fieldType:a?.type,isDiscrete:"percentile_disc"===s};return _.calculatePercentile(t,l)}_getAttributeValues(e,t,r,i){if(i.has(t))return i.get(t);const s=this.fieldsIndex.get(t),n=r.map(r=>e.getFieldValue(r,t,s));return i.set(t,n),n}_calculateUniqueValues(e,t,r){const i={},s=t.length;for(let n=0;n<s;n++){const s=t[n],o=[];for(const t of e)o.push(t[n]);const a=o.join(",");null==i[a]?i[a]={count:1,data:o,items:[s],itemPositions:[n]}:(r||i[a].count++,i[a].items.push(s),i[a].itemPositions.push(n))}return i}async _getDataValues(e,t,i=!0){const s=new a(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:n,scale:o,timeZone:l}=e;return n?s.getExpressionValues(t,n,{viewingMode:"map",scale:o,spatialReference:this.query.outSR||this.spatialReference},{geometryType:this.geometryType,hasZ:this.hasZ,hasM:this.hasM},l):s.getDataValues(t,r.clone(e),i)}_calculateHistogramBins(e,t,r){if(null==t.min&&null==t.max)return[];const i=t.intervals,s=t.min??0,n=t.max??0,o=i.map(([e,t])=>({minValue:e,maxValue:t,count:0,items:[]}));for(let t=0;t<e.length;t++){const a=e[t],l=r[t];if(null!=a&&a>=s&&a<=n){const e=_.binIndex(i,a);e>-1&&(o[e].count++,o[e].items.push(l))}}return o}async createQueryBinsResponse(e){const t=e.bin?.splitBy;if(!t)return this._createBinsResponse(e);const{value:r,outAlias:i,valueType:s}=t,n=[],o=[{name:i??r,alias:i??r,type:s??"esriFieldTypeString"},{name:w,alias:w,type:"esriFieldTypeInteger"}],l=new a(e,this.featureAdapter,this.fieldsIndex),c=new Map,u=[...this.items];this._sortFeatures(u,[r],(e,t,r)=>l.getFieldValue(e,t,r));const d=this._getAttributeValues(l,r,u,c),h=this._calculateUniqueValues([d],u,l.returnDistinctValues);for(const t in h){const{items:s}=h[t],a=await this._createBinsResponse(e,s);if(n.push(...a.features.map(e=>({...e,attributes:{...e.attributes,[i??r]:t}}))),a.fields)for(const e of a.fields)o.some(t=>t.name===e.name)||o.push(e)}return{fields:o,features:n}}async _createBinsResponse(e,t){const r=e.bin;switch(t=t??this.items,r.type){case"autoIntervalBin":return this._createAutoIntervalBinsResponse(p.fromJSON(r),e,t);case"dateBin":return this._createDateBinsResponse(f.fromJSON(r),e,t);case"fixedBoundariesBin":return this._createFixedBoundariesBinsResponse(g.fromJSON(r),e,t);case"fixedIntervalBin":return this._createFixedIntervalBinsResponse(y.fromJSON(r),e,t)}}async _createAutoIntervalBinsResponse(e,t,r){const{field:i,normalizationField:s,numBins:n,normalizationType:o,normalizationTotal:a,start:l,end:c}=e,d=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},r),h=_.getBinParams(d,{field:i,normalizationField:s,normalizationType:o,normalizationTotal:a,numBins:n,minValue:u.getDateInNumber(l,!1),maxValue:u.getDateInNumber(c,!1)}),p=this._calculateHistogramBins(d,h,r);return this._createFeaturesFromHistogramBins(p,t)}async _createDateBinsResponse(e,t,r){const{field:i,interval:s,start:n,end:o,snapToData:a,returnFullIntervalBin:l}=e,c=s.unit,d=await this._getDataValues({field:e.field,timeZone:t.outTimeReference?.ianaTimeZone},r),p=h.isTimeOnlyField(this.fieldsIndex.get(i)),f=m.unitsDict.toJSON(c),g=d.filter(Boolean).sort((e,t)=>e-t),y=null!=n?u.getDateInNumber(n,p):g[0],_=null!=o?u.getDateInNumber(o,p):g[g.length-1],w={zone:t.outTimeReference?.ianaTimeZone??b.utc},x=v.DateTime.fromMillis(y,w),S=v.DateTime.fromMillis(_,w),T=[];if("last"===a){let e=S;for(;e>x;){const t=e.minus({[f]:s.value});if(t<x){T.unshift([l?t.toMillis():x.toMillis(),e.toMillis()]);break}T.unshift([t.toMillis(),e.toMillis()]),e=t}}else{let e="first"===a?x:x.startOf(f);for(;e<=S;){const t=e.plus({[f]:s.value});if(t>S){T.push([e.toMillis(),l?t.toMillis():S.toMillis()]);break}T.push([e.toMillis(),t.toMillis()]),e=t}}const C=this._calculateHistogramBins(d,{intervals:T,min:y,max:_},r);return this._createFeaturesFromHistogramBins(C,t)}async _createFixedBoundariesBinsResponse(e,t,r){const{field:i}=e,s=await this._getDataValues({field:i,timeZone:t.outTimeReference?.ianaTimeZone},r),n=h.isTimeOnlyField(this.fieldsIndex.get(i)),o=e.boundaries.map(e=>u.getDateInNumber(e,n)).sort((e,t)=>e-t),a=[];for(let e=0;e<o.length-1;e++)a.push([o[e],o[e+1]]);const l={intervals:a,min:o.at(0),max:o.at(-1)},c=this._calculateHistogramBins(s,l,r);return this._createFeaturesFromHistogramBins(c,t)}async _createFixedIntervalBinsResponse(e,t,r){const{field:i,interval:s,start:n,end:o}=e,a=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},r),l=h.isTimeOnlyField(this.fieldsIndex.get(i)),c=_.getBinParams(a,{field:i,classificationMethod:"defined-interval",definedInterval:s,minValue:u.getDateInNumber(n,l),maxValue:u.getDateInNumber(o,l)},!0),d=this._calculateHistogramBins(a,c,r);return this._createFeaturesFromHistogramBins(d,t)}async _createFeaturesFromHistogramBins(e,t){const{upperBoundaryAlias:r,lowerBoundaryAlias:i}=t,s=i||"lowerBoundary",n=r||"upperBoundary",o=[],a=[{name:s,alias:s,type:"esriFieldTypeDouble"},{name:n,alias:n,type:"esriFieldTypeDouble"}],l=t.bin?.stackBy?.value,c=t.bin?.stackBy?.outAlias;l&&a.push({name:w,alias:w,type:"esriFieldTypeInteger"},{name:c??l,alias:c??l,type:"esriFieldTypeString"});let u=0;const d="dateBin"===t.bin.type,h=t.outTimeReference?.ianaTimeZone;for(const r of e){const{minValue:e,maxValue:i,items:p}=r,f={attributes:{}};let m;if(f.attributes[s]=d&&h&&null!=e?v.DateTime.fromMillis(e,{zone:h}).toISO():e,f.attributes[n]=d&&h&&null!=i?v.DateTime.fromMillis(i,{zone:h}).toISO():i,l?(m=await this._createStatisticsQueryResponse({...t,groupByFieldsForStatistics:[l],orderByFields:[l]},p),f.attributes[w]=++u,"flat"===t.bin.jsonStyle?o.push(...m.features.map(({attributes:{EXPR_1:e,...t},...r})=>({...r,attributes:c??e?{...t,[c??e]:e,...f.attributes}:{...t,...f.attributes}}))):(f.stackedAttributes=m.features.map(({attributes:{EXPR_1:e,...t}})=>c??e?{...t,[c??e]:e}:t),o.push(f))):(t.bin?.splitBy&&(f.attributes[w]=++u),m=await this._createStatisticsQueryResponse(t,p,f),o.push(f)),m.fields)for(const e of m.fields)a.some(t=>t.name===e.name)||a.push(e)}return"desc"===t.binOrder&&o.reverse(),{fields:a,features:o}}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/AttributesBuilder":function(){define(["./attributeSupport","./geometryUtils","../../support/fieldUtils","../../../smartMapping/statistics/support/utils","../../../statistics/utils","../../../support/loadArcade"],function(e,t,r,i,s,n){"use strict";return class{constructor(t,r,i){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=t.returnDistinctValues??!1,this.fieldsIndex=i,this.featureAdapter=r;const s=t.outFields;if(s&&!s.includes("*")){this.outFields=s;let t=0;for(const r of s){const s=e.getExpressionFromFieldName(r),n=this.fieldsIndex.get(s),o=n?null:e.getWhereClause(s,i),a=n?n.name:e.getAliasFromFieldName(r)||"FIELD_EXP_"+t++;this._fieldDataCache.set(r,{alias:a,clause:o})}}}countDistinctValues(e){return this.returnDistinctValues?(e.forEach(e=>this.getAttributes(e)),this._returnDistinctMap.size):e.length}getAttributes(e){const t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}getFieldValue(t,r,i){const s=i?i.name:r;let n=null;return this._fieldDataCache.has(s)?n=this._fieldDataCache.get(s)?.clause:i||(n=e.getWhereClause(r,this.fieldsIndex),this._fieldDataCache.set(s,{alias:s,clause:n})),i?this.featureAdapter.getAttribute(t,s):n?.calculateValue(t,this.featureAdapter)}getDataValues(e,t,n=!0){const o=t.normalizationType,a=t.normalizationTotal,l=this.fieldsIndex.get(t.field),c=r.isDateOnlyField(l)||r.isTimestampOffsetField(l),u=r.isTimeOnlyField(l);return e.map(e=>{let r=t.field&&this.getFieldValue(e,t.field,this.fieldsIndex.get(t.field));if(t.field2?(r=`${s.processNullValue(r)}${t.fieldDelimiter}${s.processNullValue(this.getFieldValue(e,t.field2,this.fieldsIndex.get(t.field2)))}`,t.field3&&(r=`${r}${t.fieldDelimiter}${s.processNullValue(this.getFieldValue(e,t.field3,this.fieldsIndex.get(t.field3)))}`)):"string"==typeof r&&n&&(c?r=r?new Date(r).getTime():null:u&&(r=r?i.timeOnlyToMilliseconds(r):null)),o&&Number.isFinite(r)){const i="field"===o&&t.normalizationField?this.getFieldValue(e,t.normalizationField,this.fieldsIndex.get(t.normalizationField)):null;r=s.getNormalizedValue(r,o,i,a)}return r})}async getExpressionValues(e,r,i,s,o){const{arcadeUtils:a}=await n.loadArcade(),l=a.hasGeometryOperations(r);l&&await a.enableGeometryOperations();const c=a.createFunction(r),u=a.getViewInfo(i),d={fields:this.fieldsIndex.fields};return e.map(e=>{const r={attributes:this.featureAdapter.getAttributes(e),layer:d,geometry:l?{...t.getGeometry(s.geometryType,s.hasZ,s.hasM,this.featureAdapter.getGeometry(e)),spatialReference:i?.spatialReference}:null},n=a.createExecContext(r,u,o);return a.executeFunction(c,n)})}validateItem(t,r){return this._fieldDataCache.has(r)||this._fieldDataCache.set(r,{alias:r,clause:e.getWhereClause(r,this.fieldsIndex)}),this._fieldDataCache.get(r)?.clause?.testFeature(t,this.featureAdapter)??!1}validateItems(t,r){return this._fieldDataCache.has(r)||this._fieldDataCache.set(r,{alias:r,clause:e.getWhereClause(r,this.fieldsIndex)}),this._fieldDataCache.get(r)?.clause?.testSet(t,this.featureAdapter)??!1}_processAttributesForOutFields(e){const t=this.outFields;if(!t?.length)return this.featureAdapter.getAttributes(e);const r={};for(const i of t){const{alias:t,clause:s}=this._fieldDataCache.get(i);r[t]=s?s.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,t)}return r}_processAttributesForDistinctValues(e){if(null==e||!this.returnDistinctValues)return e;const t=this.outFields,r=[];if(t)for(const i of t){const{alias:t}=this._fieldDataCache.get(i);r.push(e[t])}else for(const t in e)r.push(e[t]);const i=`${(t||["*"]).join(",")}=${r.join(",")}`;let s=this._returnDistinctMap.get(i)||0;return this._returnDistinctMap.set(i,++s),s>1?null:e}}})},"esri/smartMapping/statistics/support/utils":function(){define(["exports","../../../core/Error","../../../core/screenUtils","../../../core/timeUtils","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","../../../layers/support/fieldUtils","../../../renderers/support/heatmapUtils","../../support/utils","../../../statistics/utils","../../../support/loadArcade"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";let p=null;const f=/^(?<hh>([01][0-9])|(2[0-3])):(?<mm>[0-5][0-9])(:(?<ss>[0-5][0-9]))?(\.(?<ms>\d+))?$/;function m(e){const t=f.exec(e);if(!t)return null;const{hh:r,mm:s,ss:n,ms:o}=t.groups;return Number(r)*i.millisecondsPerTimeUnit.hours+Number(s)*i.millisecondsPerTimeUnit.minutes+Number(n)*i.millisecondsPerTimeUnit.seconds+Number(o||0)}function g(e,t){let r=null!=e?e:"";return null!=t&&t&&(r=r?"("+r+") AND ("+t+")":t),r}e.calculateHeatmapStats=function(e,t=18,i,s,n){const o=new Float64Array(s*n);t=Math.round(r.pt2px(t));let a=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY;const u=c.createValueFunction(i);for(const{geometry:r,attributes:i}of e){const{x:e,y:d}=r,h=Math.max(0,e-t),p=Math.max(0,d-t),f=Math.min(n,d+t),m=Math.min(s,e+t),g=+u(i);for(let r=p;r<f;r++)for(let i=h;i<m;i++){const n=r*s+i,u=c.evaluateDensityKernel(i-e,r-d,t)*g,h=o[n]+=u;a=Math.min(a,h),l=Math.max(l,h)}}return{min:a,max:l}},e.getDataValues=async function(e,t,r=!0){if(!t)return[];const{field:i,field2:s,field3:o,fieldDelimiter:a,fieldInfos:c,timeZone:f}=e,g=i&&c?.find(e=>e.name.toLowerCase()===i.toLowerCase()),y=!!g&&l.isTimeOnlyField(g),_=!!g&&u.isAnyDateField(g),b=e.valueExpression,v=e.normalizationType,w=e.normalizationField,x=e.normalizationTotal,S=[],T=e.viewInfoParams;let C=null,P=null;if(b){if(!p){const{arcadeUtils:e}=await h.loadArcade();p=e}p.hasGeometryOperations(b)&&await p.enableGeometryOperations(),C=p.createFunction(b),P=T?p.getViewInfo({viewingMode:T.viewingMode,scale:T.scale,spatialReference:new n(T.spatialReference)}):null}const M=e.fieldInfos,R=t[0]&&"declaredClass"in t[0]&&"esri.Graphic"===t[0].declaredClass||!M?null:{fields:M};return t.forEach(e=>{const t=e.attributes;let n;if(b){const t=R?Object.assign({},e,{layer:R}):e,r=p.createExecContext(t,P,f);n=p.executeFunction(C,r)}else t&&(n=t[i],s?(n=`${d.processNullValue(n)}${a}${d.processNullValue(t[s])}`,o&&(n=`${n}${a}${d.processNullValue(t[o])}`)):"string"==typeof n&&r&&(_?n=n?new Date(n).getTime():null:y&&(n=n?m(n):null)));if(v&&"number"==typeof n&&isFinite(n)){const e=t&&parseFloat(t[w]);n=d.getNormalizedValue(n,v,e,x)}S.push(n)}),S},e.getRangeExpr=function(e,t,r){const i=null!=t?e+" >= "+t:"",s=null!=r?e+" <= "+r:"";let n="";return n=i&&s?g(i,s):i||s,n?"("+n+")":""},e.getSQLFilterForNormalization=function(e){const t=e.field,r=e.normalizationType,i=e.normalizationField;let s;return"field"===r?s="(NOT "+i+" = 0)":"log"!==r&&"natural-log"!==r&&"square-root"!==r||(s=`(${t} > 0)`),s},e.getSumOfAttributesExpr=function(e,t,r){const i=[],s=[],n=[],o=[],a=[];e.forEach((e,t)=>{const l=e.field?"field":"expression",c=e.field||e.valueExpression;e.field?(a.push(c),s.push(`var ${l}${t} = Number($feature["${c}"]);`)):(i.push(`function getValueForExpr${t}() {\n  ${c} \n}`),s.push(`var ${l}${t} = Number(getValueForExpr${t}());`)),r||n.push(`${l}${t} = IIf(${l}${t} < 0, 0, ${l}${t});`),o.push(`${l}${t}`)});const l=i.length?null:a.reduce((e,t)=>`${e} + ${t}`);let c=null;return t||r?t?r||l&&(c=`(( ${l} ) >= 0)`):l&&(c=`(( ${l} ) <> 0)`):l&&(c=`(( ${l} ) > 0)`),{valueExpression:[i.length?i.join("\n"):"",s.join("\n"),n.join("\n"),`var total = ${o.join(" + ")};`,"return total;"].filter(Boolean).join("\n\n"),sqlExpression:l,sqlWhere:c}},e.mergeWhereClauses=g,e.quantizeFeatures=function(e,t,r,i){const n=a.isWrappable(r)?a.getInfo(r):null,l=n?Math.round((n.valid[1]-n.valid[0])/t.scale[0]):null;return e.map(e=>{const r=new s(e.geometry);return o.quantizePoint(t,r,r),e.geometry=n?function(e,t,r){return e.x<0?e.x+=t:e.x>r&&(e.x-=t),e}(r,l??0,i[0]):r,e})},e.timeOnlyToMilliseconds=m,e.verifyBasicFieldValidity=function(e,r,i){const s=function(e){const t=e.layer;return e.fields.filter(e=>!t.getField(e))}({layer:e,fields:r});if(s.length)return new t(i,"Unknown fields: "+s.join(", ")+". You can only use fields defined in the layer schema");const n=function(e){const t=e.layer;return e.fields.filter(e=>{const r=t.getFieldUsageInfo(e);return!r||!r.supportsStatistics})}({layer:e,fields:r});return n.length?new t(i,"Unsupported fields: "+n.join(", ")+". You can only use fields that can be fetched i.e. AdapterFieldUsageInfo.supportsStatistics must be true"):void 0},e.verifyFieldType=function(e,r,i,s){let n;return r?r.name!==e.objectIdField&&s.includes(r.type)||(n=new t(i,"'field' should be one of these types: "+s.join(","))):n=new t(i,"'field' is not defined in the layer schema"),n},e.verifyFilterValidity=function(e,r){if(e&&"intersects"!==e.spatialRelationship)return new t(r,"Only 'intersects' spatialRelationship is supported for featureFilter")},e.verifyNumericField=function(e,r,i){let s;return r?r.name!==e.objectIdField&&l.isNumericField(r)||(s=new t(i,"'field' should be one of these numeric types: "+l.numericTypes.join(","))):s=new t(i,"'field' is not defined in the layer schema"),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/smartMapping/support/utils":function(){define(["exports","../../intl/date","../../layers/support/fieldUtils","../../support/basemapUtils","../../support/loadArcade","../../time/constants","../../time/timeZoneUtils"],function(e,t,r,i,s,n,o){"use strict";const a={light:["streets","gray","topo","terrain","oceans","osm","gray-vector","streets-vector","topo-vector","streets-relief-vector","streets-navigation-vector","topo-3d","navigation-3d","streets-3d","osm-3d","gray-3d"],dark:["satellite","hybrid","dark-gray","dark-gray-vector","streets-night-vector","navigation-dark-3d","streets-dark-3d","dark-gray-3d"]},l={years:365,months:30,days:1,hours:1/24,minutes:1/1440,seconds:1/86400,milliseconds:1/864e5},c=new Set(["integer","small-integer"]);let u=null;function d(e){return String(e).padStart(2,"0")}function h(e,t,r){let i;return"date"===t||"number"===t?("number"===t&&(e=new Date(e)),i=`TIMESTAMP'${r?e.getFullYear():e.getUTCFullYear()}-${d((r?e.getMonth():e.getUTCMonth())+1)}-${d(r?e.getDate():e.getUTCDate())} ${d(r?e.getHours():e.getUTCHours())}:${d(r?e.getMinutes():e.getUTCMinutes())}:${d(r?e.getSeconds():e.getUTCSeconds())}'`):i=e,i}function p(e,t){if(t instanceof Date)return"date";if("number"==typeof t)return"number";if("string"==typeof t){const i=e.getField(t);if("<now>"===t.toLowerCase())return;if(r.isDateField(i))return"field"}}e.castIntegerFieldToFloat=function(e){return`cast(${e} as float)`},e.dateTypes=["date","date-only","timestamp-offset"],e.defaultBasemapGroups=a,e.defaultStatisticTypes={exclude:["median"]},e.fieldDelimiter=",",e.formatAnyDate=function(e,r){const{format:i,timeZoneOptions:s,fieldType:a}=r??{};let l,c;if(s&&({timeZone:l,timeZoneName:c}=o.getTimeZoneFormattingOptions(s.layerTimeZone,s.datesInUnknownTimezone,s.viewTimeZone,t.convertDateFormatToIntlOptions(i||"short-date-short-time"),a)),"string"==typeof e&&isNaN(Date.parse("time-only"===a?`1970-01-01T${e}Z`:e)))return e;switch(a){case"date-only":{const r=t.convertDateFormatToIntlOptions(i||"short-date");return"string"==typeof e?t.formatDateOnly(e,{...r}):t.formatDate(e,{...r,timeZone:n.utc})}case"time-only":{const r=t.convertDateFormatToIntlOptions(i||"short-time");return"string"==typeof e?t.formatTimeOnly(e,r):t.formatDate(e,{...r,timeZone:n.utc})}case"timestamp-offset":{if(!l&&"string"==typeof e&&new Date(e).toISOString()!==e)return e;const r=i||s?t.convertDateFormatToIntlOptions(i||"short-date-short-time"):void 0,n=r?{...r,timeZone:l,timeZoneName:c}:void 0;return"string"==typeof e?t.formatTimestamp(e,n):t.formatDate(e,n)}default:{const r=i||s?t.convertDateFormatToIntlOptions(i||"short-date-short-time"):void 0;return t.formatDate("string"==typeof e?new Date(e):e,r?{...r,timeZone:l,timeZoneName:c}:void 0)}}},e.getBasemapGroup=function(e,t=a){for(const r in t)if(t[r].includes(e))return r},e.getBasemapId=function(e,t,r=!0){let s=null;return e&&("string"==typeof e?t.includes(e)&&(s=e):s=i.getWellKnownBasemapId(e)),r?s||"gray":s},e.getDateDiffSQL=function(e,t,r,i){const{hasQueryEngine:s}=e,n=`(${h(r,p(e,r),s)} - ${h(t,p(e,t),s)})`;let o=l[i],a="/";return o<1&&(o=1/o,a="*"),{sqlExpression:1===o?n:`(${n} ${a} ${o})`,sqlWhere:null}},e.getDateType=p,e.getFieldsList=async function(e){const{field:t,field2:r,field3:i,normalizationField:n,valueExpression:o}=e;let a=[];if(o){if(!u){const{arcadeUtils:e}=await s.loadArcade();u=e}a=u.extractFieldNames(o)}return t&&a.push(t),r&&a.push(r),i&&a.push(i),n&&a.push(n),a},e.getNormalizationType=function(e){let t=e.normalizationType;return t||(e.normalizationField?t="field":null!=e.normalizationTotal&&(t="percent-of-total")),t??void 0},e.isAnyDateField=function(e){return r.isDateField(e)||r.isDateOnlyField(e)||r.isTimestampOffsetField(e)},e.isIntegerField=function(e,t){const r=t&&e.getField(t);return!!r&&c.has(r.type)},e.unitValueInDays=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/statistics/utils":function(){define(["exports","../rest/support/ClassBreaksDefinition","../rest/support/generateRendererUtils"],function(e,t,r){"use strict";const i=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,s=new Set(["esriFieldTypeDate","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeOID","esriFieldTypeBigInteger"]),n=new Set(["esriFieldTypeTimeOnly","esriFieldTypeDateOnly"]),o=["min","max","avg","stddev","count","sum","variance","nullcount","median"];function a(e){return null==e||"string"==typeof e&&!e?"<Null>":e}function l(e){const t=null!=e.normalizationField||null!=e.normalizationType,r=null!=e.minValue||null!=e.maxValue,i=!!e.sqlExpression&&e.supportsSQLExpression;return!t&&!r&&!i}function c(e){const{values:t,useSampleStdDev:r,supportsNullCount:i,outStatisticTypes:s}=e;let n=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,a=null,l=null,c=null,d=null,h=0;const p=null==e.minValue?-1/0:e.minValue,f=null==e.maxValue?1/0:e.maxValue;for(const e of t)Number.isFinite(e)?e>=p&&e<=f&&(a=null===a?e:a+e,n=Math.min(n,e),o=Math.max(o,e),h++):"string"==typeof e&&h++;if(h&&null!=a){l=a/h;let e=0;for(const r of t)Number.isFinite(r)&&r>=p&&r<=f&&(e+=(r-l)**2);d=r?h>1?e/(h-1):0:h>0?e/h:0,c=Math.sqrt(d)}else n=null,o=null;const m={avg:l,count:h,max:o,min:n,stddev:c,sum:a,variance:d};return i&&(m.nullcount=t.length-h),!e.percentileParams||s?.include?.length&&!s.include.includes("median")||s?.exclude?.length&&s.exclude.includes("median")||(m.median=u(t,e.percentileParams)),m}function u(e,t){const{fieldType:r,value:i,orderBy:s,isDiscrete:n}=t,o=d(r,"desc"===s);if(0===(e=[...e].filter(e=>null!=e).sort((e,t)=>o(e,t))).length)return null;if(i<=0)return e[0];if(i>=1)return e[e.length-1];const a=(e.length-1)*i,l=Math.floor(a),c=l+1,u=a%1,h=e[l],p=e[c];return c>=e.length||n||"string"==typeof h||"string"==typeof p?h:h*(1-u)+p*u}function d(e,t){if(e){if(s.has(e))return x(t);if(n.has(e))return b(t,!1);if("esriFieldTypeTimestampOffset"===e)return function(e){return e?g:m}(t);const r=b(t,!0);if("esriFieldTypeString"===e)return r;if("esriFieldTypeGUID"===e||"esriFieldTypeGlobalID"===e)return(e,t)=>r(S(e),S(t))}const r=t?1:-1,i=x(t),o=b(t,!0),a=f(t);return(e,t)=>"number"==typeof e&&"number"==typeof t?i(e,t):"string"==typeof e&&"string"==typeof t?o(e,t):a(e,t)??r}const h=(e,t)=>null==e?null==t?0:1:null==t?-1:null,p=(e,t)=>null==e?null==t?0:-1:null==t?1:null;function f(e){return e?h:p}const m=(e,t)=>p(e,t)??(e===t?0:new Date(e).getTime()-new Date(t).getTime()),g=(e,t)=>h(e,t)??(e===t?0:new Date(t).getTime()-new Date(e).getTime()),y=(e,t)=>p(e,t)??(e===t?0:e<t?-1:1),_=(e,t)=>h(e,t)??(e===t?0:e<t?1:-1);function b(e,t){if(!t)return e?_:y;const r=f(e);return e?(e,t)=>{const i=r(e,t);return null!=i?i:(e=e.toUpperCase())>(t=t.toUpperCase())?-1:e<t?1:0}:(e,t)=>{const i=r(e,t);return null!=i?i:(e=e.toUpperCase())<(t=t.toUpperCase())?-1:e>t?1:0}}const v=(e,t)=>h(e,t)??t-e,w=(e,t)=>p(e,t)??e-t;function x(e){return e?v:w}function S(e){return e.slice(24,36)+e.slice(19,23)+e.slice(16,18)+e.slice(14,16)+e.slice(11,13)+e.slice(9,11)+e.slice(6,8)+e.slice(4,6)+e.slice(2,4)+e.slice(0,2)}function T(e){return"coded-value"!==e?.type?[]:e.codedValues.map(e=>e.code)}function C(e,t,i){const s=P({field:t.field,normalizationType:t.normalizationType,normalizationField:t.normalizationField,classificationMethod:t.classificationMethod,standardDeviationInterval:t.standardDeviationInterval,definedInterval:t.definedInterval,breakCount:t.numClasses||5});return e=function(e,t,r){const i=t??-1/0,s=r??1/0;return e.filter(e=>Number.isFinite(e)&&e>=i&&e<=s)}(e,t.minValue,t.maxValue),r.createGenerateRendererClassBreaks({definition:s,values:e,normalizationTotal:t.normalizationTotal},i)}function P(e){const{breakCount:r,field:i,normalizationField:s,normalizationType:n}=e,o=e.classificationMethod||"equal-interval",a="standard-deviation"===o?e.standardDeviationInterval||1:void 0,l="defined-interval"===o?e.definedInterval:void 0;return new t({breakCount:r,classificationField:i,classificationMethod:o,normalizationField:"field"===n?s:void 0,normalizationType:n,standardDeviationInterval:a,definedInterval:l})}function M(e,t,r=!1){const{field:i,classificationMethod:s,standardDeviationInterval:n,definedInterval:o,normalizationType:a,normalizationField:u,normalizationTotal:d,minValue:h,maxValue:p}=t,f=t.numBins||10;let m=null,g=null,y=null;if(s&&"equal-interval"!==s||a){const{classBreaks:t}=C(e,{field:i,normalizationType:a,normalizationField:u,normalizationTotal:d,classificationMethod:s,standardDeviationInterval:n,definedInterval:o,minValue:h,maxValue:p,numClasses:f},null!=h&&null!=p?[h,p]:void 0);m=t[0]?.minValue,g=t[t.length-1]?.maxValue,y=t.map(e=>[e.minValue,e.maxValue])}else{if(null!=h&&null!=p)m=h,g=p;else{const t=c({values:e,minValue:h,maxValue:p,useSampleStdDev:!a,supportsNullCount:l({normalizationType:a,normalizationField:u,minValue:h,maxValue:p})});m=t.min??null,g=t.max??null}y=O(m??0,g??0,f)}if(r&&y.length){const e=y.at(-1)[1];y.push([e,e])}return{min:m,max:g,intervals:y}}function R(e,t){let r=-1;for(let i=e.length-1;i>=0;i--)if(t>=e[i][0]){r=i;break}return r}function O(e,t,r){const i=(t-e)/r,s=[];let n,o=e;for(let e=1;e<=r;e++)n=o+i,n=Number(n.toFixed(16)),s.push([o,e===r?t:n]),o=n;return s}e.binIndex=R,e.calculateClassBreaks=C,e.calculateHistogram=function(e,t){const r=M(e,t);if(null==r.min&&null==r.max)return{bins:[],minValue:r.min,maxValue:r.max,normalizationTotal:t.normalizationTotal};const i=r.intervals,s=r.min??0,n=r.max??0,o=i.map((e,t)=>({minValue:i[t][0],maxValue:i[t][1],count:0}));for(const t of e)if(null!=t&&t>=s&&t<=n){const e=R(i,t);e>-1&&o[e].count++}return{bins:o,minValue:s,maxValue:n,normalizationTotal:t.normalizationTotal}},e.calculatePercentile=u,e.calculateStatistics=c,e.calculateStringStatistics=function(e){const{outStatisticTypes:t}=e,r=e.returnDistinct?[...new Set(e.values)]:e.values,i=r.filter(e=>null!=e).sort(),s=i.length,n={count:s,min:i[0],max:i[s-1]};return e.supportsNullCount&&(n.nullcount=r.length-s),!e.percentileParams||t?.include?.length&&!t.include.includes("median")||t?.exclude?.length&&t.exclude.includes("median")||(n.median=u(r,e.percentileParams)),n},e.calculateUniqueValuesCount=function(e){const t={};for(let r of e)(null==r||"string"==typeof r&&""===r.trim())&&(r=null),null==t[r]?t[r]={count:1,data:r}:t[r].count++;return{count:t}},e.createClassBreaksDefinition=P,e.createUVResult=function(e,t,r,i){const s=e.count,n=[];if(r&&t){const e=[],r=T(t[0]);for(const s of r)if(t[1]){const r=T(t[1]);for(const n of r)if(t[2]){const r=T(t[2]);for(const t of r)e.push(`${a(s)}${i}${a(n)}${i}${a(t)}`)}else e.push(`${a(s)}${i}${a(n)}`)}else e.push(s);for(const t of e)s.hasOwnProperty(t)||(s[t]={data:t,count:0})}for(const e in s){const t=s[e];n.push({value:t.data,count:t.count,label:t.label})}return{uniqueValueInfos:n}},e.getAttributeComparator=d,e.getBinParams=M,e.getEqualIntervalBins=O,e.getNormalizedValue=function(e,t,r,i){let s=null;switch(t){case"log":0!==e&&(s=Math.log(e)*Math.LOG10E);break;case"percent-of-total":Number.isFinite(i)&&0!==i&&(s=e/i*100);break;case"field":Number.isFinite(r)&&0!==r&&(s=e/r);break;case"natural-log":e>0&&(s=Math.log(e));break;case"square-root":e>0&&(s=e**.5)}return s},e.isNullCountSupported=l,e.processNullValue=a,e.processSummaryStatisticsResult=function(e,t,r){let i;for(i in e)t?.include?.length&&!t.include.includes(i)||t?.exclude?.length&&t.exclude.includes(i)?delete e[i]:o.includes(i)&&(Number.isFinite(e[i])||(e[i]=null));return r?(["avg","stddev","variance"].forEach(t=>{null!=e[t]&&(e[t]=Math.ceil(e[t]??0))}),e):e},e.resolveCBResult=function(e,t){let r=e.classBreaks;const s=r.length,n=r[0]?.minValue,o=r[s-1]?.maxValue,a="standard-deviation"===t,l=i;return r=r.map(e=>{const t=e.label,r={minValue:e.minValue,maxValue:e.maxValue,label:t};if(a&&t){const e=t.match(l),i=e?.map(e=>+e.trim())??[];2===i.length?(r.minStdDev=i[0],r.maxStdDev=i[1],i[0]<0&&i[1]>0&&(r.hasAvg=!0)):1===i.length&&(t.includes("<")?(r.minStdDev=null,r.maxStdDev=i[0]):t.includes(">")&&(r.minStdDev=i[0],r.maxStdDev=null))}return r}),{minValue:n,maxValue:o,classBreakInfos:r,normalizationTotal:e.normalizationTotal}},e.statisticTypes=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/rest/support/ClassBreaksDefinition":function(){define(["exports","../../chunks/tslib.es6","../../core/jsonMap","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=new r.JSONMap({esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation",esriClassifyDefinedInterval:"defined-interval"}),d=new r.JSONMap({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"});return e.default=class extends i.JSONSupport{constructor(e){super(e),this.type="class-breaks-definition",this.breakCount=null,this.classificationField=null,this.classificationMethod=null,this.normalizationField=null,this.normalizationType=null}set standardDeviationInterval(e){"standard-deviation"===this.classificationMethod&&this._set("standardDeviationInterval",e)}set definedInterval(e){"defined-interval"===this.classificationMethod&&this._set("definedInterval",e)}},t.__decorate([l.enumeration({classBreaksDef:"class-breaks-definition"})],e.default.prototype,"type",void 0),t.__decorate([s.property({json:{write:!0}})],e.default.prototype,"breakCount",void 0),t.__decorate([s.property({json:{write:!0}})],e.default.prototype,"classificationField",void 0),t.__decorate([s.property({type:String,json:{read:u.read,write:u.write}})],e.default.prototype,"classificationMethod",void 0),t.__decorate([s.property({json:{write:!0}})],e.default.prototype,"normalizationField",void 0),t.__decorate([s.property({json:{read:d.read,write:d.write}})],e.default.prototype,"normalizationType",void 0),t.__decorate([s.property({value:null,json:{write:!0}})],e.default.prototype,"standardDeviationInterval",null),t.__decorate([s.property({value:null,json:{write:!0}})],e.default.prototype,"definedInterval",null),e.default=t.__decorate([c.subclass("esri.rest.support.ClassBreaksDefinition")],e.default),e.default})},"esri/rest/support/generateRendererUtils":function(){define(["exports","../../core/Logger"],function(e,t){"use strict";function r(e,t){return Number(e.toFixed(t))}function i(e,t,r){let i=null;return i=e===t?r&&"percent-of-total"===r?e+"%":e.toString():r&&"percent-of-total"===r?e+"% - "+t+"%":e+" - "+t,i}function s(e){const t=[],r=[];let i=Number.MIN_VALUE,s=1,n=-1;for(let o=0;o<e.length;o++){const a=e[o];a===i?(s++,r[n]=s):null!==a&&(t.push(a),i=a,s=1,r.push(s),n++)}return{uniqueValues:t,valueFrequency:r}}function n(e,t,r,i){let s=[],n=[],a=[],l=0;const c=[],u=[];for(let s=0;s<i;s++){const i=o(s,e,t,r);c.push(i.sbMean),u.push(i.sbSdcm),l+=u[s]}let d,h=l,p=!0;for(;p||l<h;){p=!1,s=[];for(let t=0;t<i;t++)s.push(e[t]);for(let r=0;r<i;r++)for(let s=e[r]+1;s<=e[r+1];s++)if(d=t[s],r>0&&s!==e[r+1]&&Math.abs(d-c[r])>Math.abs(d-c[r-1]))e[r]=s;else if(r<i-1&&e[r]!==s-1&&Math.abs(d-c[r])>Math.abs(d-c[r+1])){e[r+1]=s-1;break}h=l,l=0,n=[],a=[];for(let s=0;s<i;s++){n.push(c[s]),a.push(u[s]);const i=o(s,e,t,r);c[s]=i.sbMean,u[s]=i.sbSdcm,l+=u[s]}}if(l>h){for(let t=0;t<i;t++)e[t]=s[t],c[t]=n[t],u[t]=a[t];l=h}return{mean:c,sdcm:u}}function o(e,r,i,s){let n=0,o=0;for(let t=r[e]+1;t<=r[e+1];t++){const e=s[t];n+=i[t]*e,o+=e}o<=0&&t.getLogger("esri.rest.support.generateRendererUtils").warn("Exception in Natural Breaks calculation");const a=n/o;let l=0;for(let t=r[e]+1;t<=r[e+1];t++)l+=s[t]*(i[t]-a)**2;return{sbMean:a,sbSdcm:l}}e.createGenerateRendererClassBreaks=function(e,t){const{normalizationTotal:a}=e;return{classBreaks:function(e,t){const a=e.definition,{classificationMethod:l,normalizationType:c,definedInterval:u}=a,d=a.breakCount??1,h=[];let p=e.values;if(0===p.length)return[];p=p.sort((e,t)=>e-t);const[f,m]=t??[p.at(0),p.at(-1)];if("equal-interval"===l)if(p.length>=d){const e=(m-f)/d;let t=f;for(let s=1;s<d;s++){const n=r(f+s*e,6);h.push({minValue:t,maxValue:n,label:i(t,n,c)}),t=n}h.push({minValue:t,maxValue:m,label:i(t,m,c)})}else p.forEach(e=>{h.push({minValue:e,maxValue:e,label:i(e,e,c)})});else if("natural-breaks"===l){const t=s(p),a=e.valueFrequency||t.valueFrequency,l=function(e,t,r){const i=e.length,s=[];r>i&&(r=i);for(let e=0;e<r;e++)s.push(Math.round(e*i/r-1));s.push(i-1);let a=n(s,e,t,r);return function(e,t,r,i,s,n){let a=0,l=0,c=0,u=0,d=!0;for(let h=0;h<2&&d;h++){0===h&&(d=!1);for(let h=0;h<n-1;h++)for(;r[h+1]+1!==r[h+2];){r[h+1]=r[h+1]+1;const n=o(h,r,i,s);c=n.sbMean,a=n.sbSdcm;const p=o(h+1,r,i,s);if(u=p.sbMean,l=p.sbSdcm,!(a+l<t[h]+t[h+1])){r[h+1]=r[h+1]-1;break}t[h]=a,t[h+1]=l,e[h]=c,e[h+1]=u,d=!0}for(let h=n-1;h>0;h--)for(;r[h]!==r[h-1]+1;){r[h]=r[h]-1;const n=o(h-1,r,i,s);c=n.sbMean,a=n.sbSdcm;const p=o(h,r,i,s);if(u=p.sbMean,l=p.sbSdcm,!(a+l<t[h-1]+t[h])){r[h]=r[h]+1;break}t[h-1]=a,t[h]=l,e[h-1]=c,e[h]=u,d=!0}}return d}(a.mean,a.sdcm,s,e,t,r)&&(a=n(s,e,t,r)),s}(t.uniqueValues,a,d);let u=f;for(let e=1;e<d;e++)if(t.uniqueValues.length>e){const s=r(t.uniqueValues[l[e]],6);h.push({minValue:u,maxValue:s,label:i(u,s,c)}),u=s}h.push({minValue:u,maxValue:m,label:i(u,m,c)})}else if("quantile"===l)if(p.length>=d&&f!==m){let e=f,t=Math.ceil(p.length/d),r=0;for(let s=1;s<d;s++){let n=t+r-1;n>p.length&&(n=p.length-1),n<0&&(n=0),h.push({minValue:e,maxValue:p[n],label:i(e,p[n],c)}),e=p[n],r+=t,t=Math.ceil((p.length-r)/(d-s))}h.push({minValue:e,maxValue:m,label:i(e,m,c)})}else{let e=-1;for(let t=0;t<p.length;t++){const r=p[t];r!==e&&(e=r,h.push({minValue:e,maxValue:r,label:i(e,r,c)}),e=r)}}else if("standard-deviation"===l){const e=function(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r];return t/=e.length,t}(p),t=function(e,t){let r=0;for(let i=0;i<e.length;i++){const s=e[i];r+=(s-t)*(s-t)}return r/=e.length,Math.sqrt(r)}(p,e);if(0===t)h.push({minValue:p[0],maxValue:p[0],label:i(p[0],p[0],c)});else{const s=function(e,t,r,i,s){let n=Math.max(i-e,t-i)/s/r;return n=n>=1?1:n>=.5?.5:.25,n}(f,m,d,e,t),n=s*t;let o=0,a=f;for(let t=d;t>=1;t--){const s=r(e-(t-.5)*n,6);h.push({minValue:a,maxValue:s,label:i(a,s,c)}),a=s,o++}let l=r(e+.5*n,6);h.push({minValue:a,maxValue:l,label:i(a,l,c)}),a=l,o++;for(let t=1;t<=d;t++)l=o===2*d?m:r(e+(t+.5)*n,6),h.push({minValue:a,maxValue:l,label:i(a,l,c)}),a=l,o++}}else if("defined-interval"===l){if(!u)return h;const[e,s]=t??[p.at(0),p.at(-1)],n=Math.ceil((s-e)/u);let o=e;for(let t=1;t<n;t++){const s=r(e+t*u,6);h.push({minValue:o,maxValue:s,label:i(o,s,c)}),o=s}h.push({minValue:o,maxValue:s,label:i(o,s,c)})}return h}(e,t),normalizationTotal:a}},e.createGenerateRendererUniqueValues=function(e){const t=s(e),r=[],i=t.uniqueValues.length;for(let e=0;e<i;e++){const i=t.uniqueValues[e],s=t.valueFrequency[e],n=i.toString();r.push({value:i,count:s,label:n})}return{uniqueValues:r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/queryUtils":function(){define(["require","exports","../../../core/Error","../../../core/jsonMap","../../../core/unitUtils","../../../geometry/projectionUtils","../../../geometry/support/extentUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","./projectionSupport"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=new i.JSONMap({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),h=Object.freeze({});async function p(e,t,r){const{outFields:i,orderByFields:s,groupByFieldsForStatistics:n,outStatistics:o}=e;if(i)for(let e=0;e<i.length;e++)i[e]=i[e].trim();if(s)for(let e=0;e<s.length;e++)s[e]=s[e].trim();if(n)for(let e=0;e<n.length;e++)n[e]=n[e].trim();if(o)for(let e=0;e<o.length;e++)o[e].onStatisticField&&(o[e].onStatisticField=o[e].onStatisticField.trim());return e.geometry&&!e.outSR&&(e.outSR=e.geometry.spatialReference),f(e,t,r)}async function f(t,i,n){if(!t)return null;let{where:p}=t;if(t.where=p=p?.trim(),(!p||/^1 *= *1$/.test(p)||i&&i===p)&&(t.where=null),!t.geometry)return t;let f=await async function(t){const{distance:i,units:n}=t,o=t.geometry;if(null==i||"vertexAttributes"in o)return o;const l=o.spatialReference,h=n?d.fromJSON(n):s.getUnitString(l),p=l&&(c.isGeographic(l)||c.isWebMercator(l))?o:await u.checkProjectionSupport(l,c.wgs84).then(()=>u.project(o,c.wgs84)),f=await new Promise((t,r)=>e(["../../../geometry/operators/json/geodesicBufferOperator"],t,r));await f.load();const m=f.execute(p,i||1,{unit:h})??void 0;if(!m||!a.isPolygon(m)||0===m.rings.length)throw new r("unsupported-query:invalid-parameters","Invalid parameters for query by distance");return m}(t);if(t.distance=0,t.units=null,"esriSpatialRelEnvelopeIntersects"===t.spatialRel){const{spatialReference:e}=t.geometry;f=o.getGeometryExtent(f),f.spatialReference=e}if(f){await u.checkProjectionSupport(f.spatialReference,n),f=function(e,t){const r=e.spatialReference;return m(e,t)&&a.isExtent(e)?{spatialReference:r,rings:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]}:e}(f,n);const e=(await l.normalizeCentralMeridian(a.fromJSON(f)))[0];if(null==e)throw h;const r="quantizationParameters"in t&&t.quantizationParameters?.tolerance||"maxAllowableOffset"in t&&t.maxAllowableOffset||0,i=r&&m(f,n)?{densificationStep:8*r}:void 0,s=e.toJSON(),o=u.project(s,s.spatialReference,n,i);if(!o)throw h;o.spatialReference=n,t.geometry=o}return t}function m(e,t){if(!e)return!1;const r=e.spatialReference;return(a.isExtent(e)||a.isPolygon(e)||a.isPolyline(e))&&!c.equals(r,t)&&!n.canProjectWithoutEngine(r,t)}t.getDateInNumber=function(e,t){return null==e?null:"string"==typeof e?t?new Date(`1970-01-01T${e}Z`).getTime():new Date(e).getTime():e instanceof Date?e.getTime():e},t.normalizeAttributeBinsQuery=async function(e,t,r){const i=e.bin;return i.onField&&(i.onField=i.onField.trim()),i.onExpression?.value&&(i.onExpression.value=i.onExpression.value.trim()),i.splitBy&&(i.splitBy.value&&(i.splitBy.value=i.splitBy.value.trim()),i.splitBy.outAlias&&(i.splitBy.outAlias=i.splitBy.outAlias.trim())),i.stackBy&&(i.stackBy.value&&(i.stackBy.value=i.stackBy.value.trim()),i.stackBy.outAlias&&(i.stackBy.outAlias=i.stackBy.outAlias.trim())),"normalizationField"in i.parameters&&i.parameters.normalizationField&&(i.parameters.normalizationField=i.parameters.normalizationField.trim()),e.outStatistics?.length||(e.outStatistics=[{statisticType:"count",onStatisticField:"1",outStatisticFieldName:"frequency"}]),p(e,t,r)},t.normalizeQuery=p,t.normalizeQueryLike=f,t.queryEngineEmptyResult=h,t.unitsKebabDict=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/SnappingCandidate":function(){define(["exports"],function(e){"use strict";e.makeEdgeCandidate=function(e,t,r,i,s,n=!1){return{objectId:e,target:t,distance:r,type:"edge",start:i,end:s,draped:n}},e.makeVertexCandidate=function(e,t,r){return{objectId:e,target:t,distance:r,type:"vertex"}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/rest/support/AutoIntervalBinParameters":function(){define(["exports","../../chunks/tslib.es6","../../core/object","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./BinParametersBase","./NormalizationBinParametersMixin"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";function d(e,t,i){r.setDeepValue(i,e instanceof Date?e.getTime():e,t)}return e.default=class extends(u.NormalizationBinParametersMixin(c)){constructor(e){super(e),this.numBins=null,this.end=null,this.start=null,this.type="auto-interval"}},t.__decorate([i.property({type:Number,json:{name:"parameters.numberOfBins",write:!0}})],e.default.prototype,"numBins",void 0),t.__decorate([i.property({json:{name:"parameters.end",write:{writer:d}}})],e.default.prototype,"end",void 0),t.__decorate([i.property({json:{name:"parameters.start",write:{writer:d}}})],e.default.prototype,"start",void 0),t.__decorate([a.enumeration({autoIntervalBin:"auto-interval"},{readOnly:!0})],e.default.prototype,"type",void 0),e.default=t.__decorate([l.subclass("esri.rest.support.AutoIntervalBinParameters")],e.default),e.default.from=s.ensureType(e.default),e.default})},"esri/rest/support/BinParametersBase":function(){define(["exports","../../chunks/tslib.es6","../../core/Clonable","../../core/jsonMap","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./AttributeBinsGrouping"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h=new i.JSONMap({esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long",esriFieldTypeDate:"date",esriFieldTypeDateOnly:"date-only",esriFieldTypeTimeOnly:"time-only",esriFieldTypeTimestampOffset:"timestamp-offset"}),p=new i.JSONMap({naturalLog:"natural-log",squareRoot:"square-root"});return e.default=class extends(r.ClonableMixin(s.JSONSupport)){constructor(e){super(e),this.expression=null,this.expressionValueType=null,this.field=null,this.firstDayOfWeek=null,this.hideUpperBound=null,this.splitBy=null,this.stackBy=null,this.transformation=null}},t.__decorate([n.property({type:String,json:{name:"onExpression.value",write:!0}})],e.default.prototype,"expression",void 0),t.__decorate([c.enumeration(h,{name:"onExpression.valueType"})],e.default.prototype,"expressionValueType",void 0),t.__decorate([n.property({type:String,json:{name:"onField",write:!0}})],e.default.prototype,"field",void 0),t.__decorate([n.property({type:String,json:{write:!0}})],e.default.prototype,"firstDayOfWeek",void 0),t.__decorate([n.property({type:String,json:{write:!0}})],e.default.prototype,"hideUpperBound",void 0),t.__decorate([n.property({type:d,json:{write:{overridePolicy(){return{enabled:null!=this.splitBy?.value||null!=this.splitBy?.type}}}}})],e.default.prototype,"splitBy",void 0),t.__decorate([n.property({type:d,json:{write:{target:{stackBy:{type:d},jsonStyle:{type:String}},writer:(e,t)=>{e&&(t.stackBy=e.toJSON(),null!=e.responseType&&(t.jsonStyle=e.responseType))},overridePolicy(){return{enabled:null!=this.stackBy?.value||null!=this.stackBy?.type}}},read:{source:["stackBy","jsonStyle"],reader:(e,t)=>d.fromJSON({...t.stackBy,responseType:t.jsonStyle})}}})],e.default.prototype,"stackBy",void 0),t.__decorate([c.enumeration(p)],e.default.prototype,"transformation",void 0),e.default=t.__decorate([u.subclass("esri.rest.support.BinParametersBase")],e.default),e.default})},"esri/rest/support/AttributeBinsGrouping":function(){define(["../../chunks/tslib.es6","../../core/Clonable","../../core/jsonMap","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=new r.JSONMap({esriFieldTypeInteger:"integer",esriFieldTypeString:"string"});let d=class extends(t.ClonableMixin(i.JSONSupport)){constructor(e){super(e),this.alias=null,this.responseType=null,this.type=null,this.value=null,this.valueType=null}};e.__decorate([s.property({type:String,json:{name:"outAlias",write:!0}})],d.prototype,"alias",void 0),e.__decorate([s.property({type:String})],d.prototype,"responseType",void 0),e.__decorate([s.property({type:String,json:{write:!0}})],d.prototype,"type",void 0),e.__decorate([s.property({type:String,json:{write:!0}})],d.prototype,"value",void 0),e.__decorate([l.enumeration(u)],d.prototype,"valueType",void 0),d=e.__decorate([c.subclass("esri.rest.support.AttributeBinsGrouping")],d);const h=d;return d.from=n.ensureType(d),h})},"esri/rest/support/DateBinParameters":function(){define(["exports","../../chunks/tslib.es6","../../core/object","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./BinParametersBase","./DateBinTimeInterval"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";function d(e,t,i){r.setDeepValue(i,"string"==typeof e?e:e?.getTime(),t)}function h(e,t){const r=e.parameters[t];return r?"string"==typeof r?r:new Date(r):null}return e.default=class extends c{constructor(e){super(e),this.end=null,this.interval=null,this.offset=null,this.returnFullIntervalBin=!1,this.start=null,this.snapToData=null,this.type="date"}},t.__decorate([i.property({cast:e=>null!=e?"string"==typeof e?e:new Date(e):null,json:{name:"parameters.end",read:{reader:(e,t)=>h(t,"end")},write:{writer:d}}})],e.default.prototype,"end",void 0),t.__decorate([i.property({type:u,json:{name:"parameters",write:!0}})],e.default.prototype,"interval",void 0),t.__decorate([i.property({type:u,json:{name:"parameters.offset",write:!0}})],e.default.prototype,"offset",void 0),t.__decorate([i.property({type:Boolean,json:{name:"parameters.returnFullIntervalBin",write:!0}})],e.default.prototype,"returnFullIntervalBin",void 0),t.__decorate([i.property({cast:e=>null!=e?"string"==typeof e?e:new Date(e):null,json:{name:"parameters.start",read:{reader:(e,t)=>h(t,"start")},write:{writer:d}}})],e.default.prototype,"start",void 0),t.__decorate([i.property({type:String,json:{name:"parameters.snapToData",write:!0}})],e.default.prototype,"snapToData",void 0),t.__decorate([a.enumeration({dateBin:"date"},{readOnly:!0})],e.default.prototype,"type",void 0),e.default=t.__decorate([l.subclass("esri.rest.support.DateBinParameters")],e.default),e.default.from=s.ensureType(e.default),e.default})},"esri/rest/support/DateBinTimeInterval":function(){define(["../../chunks/tslib.es6","../../core/Clonable","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./DateBinUtils"],function(e,t,r,i,s,n,o,a,l,c){"use strict";let u=class extends(t.ClonableMixin(r.JSONSupport)){constructor(e){super(e),this.value=null,this.unit=null}};e.__decorate([i.property({type:Number,json:{name:"number",write:!0}})],u.prototype,"value",void 0),e.__decorate([a.enumeration(c.unitsDict)],u.prototype,"unit",void 0),u=e.__decorate([l.subclass("esri.rest.support.DateBinTimeInterval")],u);const d=u;return u.from=s.ensureType(u),d})},"esri/rest/support/DateBinUtils":function(){define(["exports","../../core/jsonMap"],function(e,t){"use strict";const r=t.strict()({year:"years",quarter:"quarters",month:"months",week:"weeks",day:"days",hour:"hours",minute:"minutes",second:"seconds"});e.unitsDict=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/rest/support/FixedBoundariesBinParameters":function(){define(["exports","../../chunks/tslib.es6","../../core/object","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./BinParametersBase"],function(e,t,r,i,s,n,o,a,l,c){"use strict";return e.default=class extends c{constructor(e){super(e),this.boundaries=[],this.type="fixed-boundaries"}},t.__decorate([i.property({json:{name:"parameters.boundaries",write:{writer:function(e,t,i){r.setDeepValue(i,e&&e[0]instanceof Date?e.map(e=>e.getTime()):e,t)}}}})],e.default.prototype,"boundaries",void 0),t.__decorate([a.enumeration({fixedBoundariesBin:"fixed-boundaries"},{readOnly:!0})],e.default.prototype,"type",void 0),e.default=t.__decorate([l.subclass("esri.rest.support.FixedBoundariesBinParameters")],e.default),e.default.from=s.ensureType(e.default),e.default})},"esri/rest/support/FixedIntervalBinParameters":function(){define(["exports","../../chunks/tslib.es6","../../core/object","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./BinParametersBase","./NormalizationBinParametersMixin"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";function d(e,t,i){r.setDeepValue(i,e instanceof Date?e.getTime():e,t)}return e.default=class extends(u.NormalizationBinParametersMixin(c)){constructor(e){super(e),this.end=null,this.interval=null,this.start=null,this.type="fixed-interval"}},t.__decorate([i.property({json:{name:"parameters.end",write:{writer:d}}})],e.default.prototype,"end",void 0),t.__decorate([i.property({type:Number,json:{name:"parameters.interval",write:!0}})],e.default.prototype,"interval",void 0),t.__decorate([i.property({json:{name:"parameters.start",write:{writer:d}}})],e.default.prototype,"start",void 0),t.__decorate([a.enumeration({fixedIntervalBin:"fixed-interval"},{readOnly:!0})],e.default.prototype,"type",void 0),e.default=t.__decorate([l.subclass("esri.rest.support.FixedIntervalBinParameters")],e.default),e.default.from=s.ensureType(e.default),e.default})},"esri/layers/graphics/data/queryValidationUtils":function(){define(["exports","../../../core/Error","./attributeSupport","./projectionSupport","./spatialQuerySupport","../../../support/loadArcade"],function(e,t,r,i,s,n){"use strict";const o="unsupported-query";async function a(e,{fieldsIndex:n,geometryType:a,spatialReference:u,availableFields:d}){if(null!=e.geometryPrecision||e.multipatchOption&&"xyFootprint"!==e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new t(o,"Unsupported query options",{query:e});return l(n,d,e),function(e,i,s){const{outStatistics:n,groupByFieldsForStatistics:a,having:l}=s,u=a?.length,d=n?.length;if(l){if(!u||!d)throw new t(o,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:s});r.validateHaving(e,i,l,n,s)}if(d){if(!function(e){return null!=e&&e.every(e=>"exceedslimit"!==e.statisticType)}(n))return;const l=n.map(e=>e.onStatisticField).filter(Boolean);r.validateFields(e,i,l,{expressionName:"onStatisticFields",query:s}),u&&r.validateFields(e,i,a,{expressionName:"groupByFieldsForStatistics",query:s});for(const a of n){const{onStatisticField:n,statisticType:l}=a;if("percentile_disc"!==l&&"percentile_cont"!==l||!("statisticParameters"in a))e.get(n)&&"count"!==l&&"min"!==l&&"max"!==l&&r.validateFields(e,i,[n],{expressionName:`outStatistics with '${l}' statistic type`,allowedFieldTypes:c,query:s});else{const{statisticParameters:e}=a;if(!e)throw new t(o,"statisticParameters should be set for percentile type",{definition:a,query:s})}}}}(n,d,e),Promise.all([s.checkSpatialQuerySupport(e,a,u),i.checkProjectionSupport(u,e.outSR)]).then(()=>e)}function l(e,i,s){const{returnDistinctValues:n,outStatistics:a}=s,l=a?a.map(e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase()).filter(Boolean):[];if("orderByFields"in s&&s.orderByFields&&s.orderByFields.length>0){const t=" asc",n=" desc",o=s.orderByFields.map(e=>{const r=e.toLowerCase();return r.includes(t)?r.split(t)[0]:r.includes(n)?r.split(n)[0]:e}).filter(e=>!l.includes(e));r.validateFields(e,i,o,{expressionName:"orderByFields",query:s})}if("outFields"in s)if(s.outFields?.length)r.validateFields(e,i,s.outFields,{expressionName:"outFields",query:s,allowedFieldTypes:"all"});else if(n)throw new t(o,"outFields should be specified for returnDistinctValues",{query:s});r.validateWhere(e,i,s.where,s)}const c=new Set([...r.numericFieldTypes,...r.allDateAndTimeFieldTypes]);async function u(e,i,s,a){let l=[];if(s.valueExpression){const{arcadeUtils:e}=await n.loadArcade();l=e.extractFieldNames(s.valueExpression)}if(s.field&&l.push(s.field),s.field2&&l.push(s.field2),s.field3&&l.push(s.field3),s.normalizationField&&l.push(s.normalizationField),!l.length&&!s.valueExpression)throw new t(o,"field or valueExpression is required",{params:s});r.validateFields(e,i,l,{expressionName:"statistics",query:a})}e.validateAttributeBinsQuery=async function(e,r){const i=e.bin;if(!i.onField&&!i.onExpression?.value||"autoIntervalBin"===i.type&&null==i.parameters.numberOfBins||"dateBin"===i.type&&(null==i.parameters.number||null==i.parameters.unit)||"fixedBoundariesBin"===i.type&&null==i.parameters.boundaries||"fixedIntervalBin"===i.type&&null==i.parameters.interval)throw new t(o,"Unsupported query options",{query:e});return a(e,r)},e.validateQuery=a,e.validateStatisticsQuery=async function(e,r,{fieldsIndex:n,geometryType:a,spatialReference:c,availableFields:d}){if(null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new t(o,"Unsupported query options",{query:e});return l(n,d,e),Promise.all([u(n,d,r,e),s.checkSpatialQuerySupport(e,a,c),i.checkProjectionSupport(c,e.outSR)]).then(()=>e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/spatialQuerySupport":function(){define(["require","exports","../../../core/Error","../../../geometry/support/contains","../../../geometry/support/intersects","../../../geometry/support/jsonUtils","../../../geometry/support/spatialReferenceUtils","../contains","../featureConversionUtils","../OptimizedGeometry","./geometryUtils","./projectionSupport"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h="unsupported-query",p={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},f={esriGeometryPoint:!0,esriGeometryMultiPatch:!1,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},m={esriGeometryPoint:!0,esriGeometryMultiPatch:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1},g={esriSpatialRelIntersects:()=>new Promise((t,r)=>e(["../../../geometry/operators/json/intersectsOperator"],t,r)),esriSpatialRelContains:()=>new Promise((t,r)=>e(["../../../geometry/operators/json/containsOperator"],t,r)),esriSpatialRelCrosses:()=>new Promise((t,r)=>e(["../../../geometry/operators/json/crossesOperator"],t,r)),esriSpatialRelDisjoint:()=>new Promise((t,r)=>e(["../../../geometry/operators/json/disjointOperator"],t,r)),esriSpatialRelEnvelopeIntersects:null,esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:()=>new Promise((t,r)=>e(["../../../geometry/operators/json/overlapsOperator"],t,r)),esriSpatialRelTouches:()=>new Promise((t,r)=>e(["../../../geometry/operators/json/touchesOperator"],t,r)),esriSpatialRelWithin:()=>new Promise((t,r)=>e(["../../../geometry/operators/json/withinOperator"],t,r)),esriSpatialRelRelation:null};t.canQueryWithRBush=function(e){if(n.isExtent(e))return!0;if(n.isPolygon(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1},t.checkSpatialQuerySupport=async function(e,t,i){const{spatialRel:s,geometry:a}=e;if(a){if(null==(l=s)||!0!==p[l])throw new r(h,"Unsupported query spatial relationship",{query:e});var l;if(o.isValid(a.spatialReference)&&o.isValid(i)){if(!function(e){return null!=e&&!0===f[n.getJsonType(e)]}(a))throw new r(h,"Unsupported query geometry type",{query:e});if(!function(e){return null!=e&&!0===m[e]}(t))throw new r(h,"Unsupported layer geometry type",{query:e});if(e.outSR)return d.checkProjectionSupport(e.geometry?.spatialReference,e.outSR)}}},t.getSpatialQueryOperator=async function(e,t,r,o,d){if(n.isPolygon(t)){if("esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=l.convertFromPolygon(new c,t,!1,!1);return t=>a.polygonContainsPoint(e,!1,!1,t)}if("esriGeometryMultipoint"===r){const r=l.convertFromPolygon(new c,t,!1,!1);if("esriSpatialRelContains"===e)return e=>a.polygonContainsMultipoint(r,!1,!1,e,o,d)}}if(n.isExtent(t)){if("esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return e=>i.extentContainsPoint(t,u.getGeometry(r,o,d,e));if("esriGeometryMultipoint"===r&&"esriSpatialRelContains"===e)return e=>i.extentContainsMultipoint(t,u.getGeometry(r,o,d,e));if("esriSpatialRelIntersects"===e){const e=s.getExtentIntersector(r);return i=>e(t,u.getGeometry(r,o,d,i))}}"esriSpatialRelEnvelopeIntersects"===e&&(e="esriSpatialRelIntersects");const h=await function(e){const t=g[e];if(null==t)throw new Error(`Cannot load unsupported spatial operator: ${e}`);return t()}(e);return e=>h.execute(t,u.getGeometry(r,o,d,e))},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/intersects":function(){define(["exports","./intersectsBase"],function(e,t){"use strict";e.extentIntersectsExtent=t.extentIntersectsExtent,e.extentIntersectsMultipoint=t.extentIntersectsMultipoint,e.extentIntersectsPoint=t.extentIntersectsPoint,e.extentIntersectsPolygon=t.extentIntersectsPolygon,e.extentIntersectsPolyline=t.extentIntersectsPolyline,e.getFeatureExtentIntersector=t.getFeatureExtentIntersector,e.isSelfIntersecting=t.isSelfIntersecting,e.segmentIntersects=t.segmentIntersects,e.getExtentIntersector=function(e){return"mesh"===e?t.extentIntersectsExtent:t.getFeatureExtentIntersector(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/contains":function(){define(["exports"],function(e){"use strict";function t(e,t){return e?t?4:3:t?3:2}function r(e,r,s,n,o){if(!e)return!1;const a=t(r,s),{coords:l,lengths:c}=e;let u=!1,d=0;for(const e of c)u=i(u,l,a,d,e,n,o),d+=e*a;return u}function i(e,t,r,i,s,n,o){let a=e,l=i;for(let e=i,c=i+s*r;e<c;e+=r){l=e+r,l===c&&(l=i);const s=t[e],u=t[e+1],d=t[l],h=t[l+1];(u<o&&h>=o||h<o&&u>=o)&&s+(o-u)/(h-u)*(d-s)<n&&(a=!a)}return a}e.polygonContainsCoords=r,e.polygonContainsMultipoint=function(e,i,s,n,o,a){const l=t(o,a),{coords:c,lengths:u}=n;if(!u)return!1;for(let t=0,n=0;t<u.length;t++,n+=l)if(!r(e,i,s,c[n],c[n+1]))return!1;return!0},e.polygonContainsPoint=function(e,t,i,s){return r(e,t,i,s.coords[0],s.coords[1])},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/timeSupport":function(){define(["exports","../../../core/compilerUtils"],function(e,t){"use strict";e.getTimeExtent=async function(e,r){if(!e)return null;const i=r.featureAdapter,{startTimeField:s,endTimeField:n}=e;let o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;if(s&&n)await r.forEach(e=>{const r=i.getAttribute(t.toConst(e),s),l=i.getAttribute(t.toConst(e),n);null==r||isNaN(r)||(o=Math.min(o,r)),null==l||isNaN(l)||(a=Math.max(a,l))});else{const e=s||n;await r.forEach(r=>{const s=i.getAttribute(t.toConst(r),e);null==s||isNaN(s)||(o=Math.min(o,s),a=Math.max(a,s))})}return{start:o,end:a}},e.getTimeOperator=function(e,t,r){if(!t||!e)return null;const{startTimeField:i,endTimeField:s}=e;if(!i&&!s)return null;const{start:n,end:o}=t;if(null===n&&null===o)return null;if(void 0===n&&void 0===o)return()=>!1;const a=r.getAttributeAsTimestamp?.bind(r)??r.getAttribute.bind(r);return i&&s?function(e,t,r,i,s){return null!=i&&null!=s?n=>{const o=e(n,t),a=e(n,r);return(null==o||o<=s)&&(null==a||a>=i)}:null!=i?t=>{const s=e(t,r);return null==s||s>=i}:null!=s?r=>{const i=e(r,t);return null==i||i<=s}:void 0}(a,i,s,n,o):function(e,t,r,i){return null!=r&&null!=i&&r===i?i=>e(i,t)===r:null!=r&&null!=i?s=>{const n=e(s,t);return null!=n&&n>=r&&n<=i}:null!=r?i=>{const s=e(i,t);return null!=s&&s>=r}:null!=i?r=>{const s=e(r,t);return null!=s&&s<=i}:void 0}(a,i||s,n,o)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/layers/features/layerAdapters/featureServiceUtils":function(){define(["exports","../../../../../core/has"],function(e,t){"use strict";function r(e,r){return!(!e&&!t("featurelayer-snapshot-non-hosted-exceedslimit-enabled"))&&r?.operations.supportsExceedsLimitStatistics}e.createFeatureIdInfo=function(e){const{objectIdField:t,uniqueIdFields:r}=e;return r?.length?r.length>=2?{type:"unique-id-composite",fieldNames:r}:{type:"unique-id-simple",fieldName:r[0]}:{type:"object-id",fieldName:t}},e.createSnapshotInfo=function(e,i,s,n,o,a){const l=function(e){switch(e){case"esriGeometryMultipoint":return{min:t("featurelayer-snapshot-multipoint-min-threshold"),max:t("featurelayer-snapshot-multipoint-max-threshold")};case"esriGeometryPoint":return{min:t("featurelayer-snapshot-point-min-threshold"),max:t("featurelayer-snapshot-point-max-threshold")};case"esriGeometryMultiPatch":case"esriGeometryPolygon":return{min:t("featurelayer-snapshot-polygon-min-threshold"),max:t("featurelayer-snapshot-polygon-max-threshold")};case"esriGeometryPolyline":return{min:t("featurelayer-snapshot-polyline-min-threshold"),max:t("featurelayer-snapshot-polyline-max-threshold")}}}(n);if(!t("featurelayer-snapshot-enabled")||!s?.query.supportsPagination||s?.operations.supportsEditing||i)return null;const c=function(e,r){const i=r?.clone().intersection(e),s=null!=i?i.width*i.height:0,n=r?r.width*r.height:0,o=0===n?0:s/n,a=t("featurelayer-snapshot-coverage");return!isNaN(o)&&o>=a}(o,a),{min:u,max:d}=l,h=c?d:u,p=function(e){switch(e){case"esriGeometryPoint":return null;case"esriGeometryPolyline":case"esriGeometryPolygon":case"esriGeometryMultiPatch":case"esriGeometryMultipoint":return t("featurelayer-snapshot-max-vertex-count")}}(n);let f=t("featurelayer-snapshot-initial-tolerance");return"esriGeometryPoint"!==n&&"esriGeometryMultipoint"!==n||(f=null),{supportsExceedsLimit:r(e,s),initialTolerance:f,maxFeatureCount:h,maxVertexCount:p}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/QueryEngineCache":function(){define(["exports","../../../../core/has","../../../../core/memoryEstimations"],function(e,t,r){"use strict";class i{constructor(e){this.items=e}get cachedMemory(){return this.items.reduce((e,t)=>e+t.usedMemory,r.baseArrayMemory+r.baseObjectMemory)}}e.QueryEngineCache=class{constructor(e){this._cache=e.newCache("QueryEngine",null,-1)}clear(){this._cache.clear()}destroy(){this._cache.destroy()}get(e){return this._cache.get(e)?.items}put(e,t){this._cache.put(e,new i(t))}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/QueryEngineContext":function(){define(["exports"],function(e){"use strict";e.QueryEngineContext=class{constructor(e,t,r,i,s,n){this.spatialReference=e,this.layer=t,this.resourceController=r,this._getFeatureStore=i,this.hasZ=s,this.hasM=n}get scheduler(){return this.resourceController.scheduler}get memoryController(){return this.resourceController.memoryController}get featureStore(){return this._getFeatureStore()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/graphics/queryForSymbologySnapping":function(){define(["exports","../../../../core/promiseUtils","../../../../support/loadArcade"],function(e,t,r){"use strict";const i={candidates:[],sourceCandidateIndices:[]};e.queryForSymbologySnapping=async function(e,s,n){if(null==e||0===s.candidates.length)return i;const o=e.graphics3DGraphicsByObjectID??e.graphics3DGraphics,a=[],l=[],{renderer:c}=e,u=null!=c&&"arcadeRequired"in c&&c.arcadeRequired?r.loadArcade():null,d=async(t,{graphic:r,graphics3DSymbol:i})=>{const s=await u,o=await e.getRenderingInfoAsync(r,c,s,{signal:n});return null==o?[]:i.queryForSnapping(t,p,o,n)},{candidates:h,spatialReference:p}=s;for(let e=0;e<h.length;++e){const t=h[e],{objectId:r}=t,i="number"==typeof r?o?.get(r):void 0;if(null==i)continue;const{graphics3DSymbol:s}=i;s.symbologySnappingSupported&&(a.push(d(t,i)),l.push(e))}if(0===a.length)return i;const f=await Promise.all(a);t.throwIfAborted(n);const m=[],g=[];for(let e=0;e<f.length;++e){const t=f[e],r=l[e];for(const e of t)m.push(e),g.push(r)}return{candidates:m,sourceCandidateIndices:g}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/HeatmapFeatureProcessor":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/arrayUtils","../../../../core/handleUtils","../../../../core/has","../../../../core/Logger","../../../../core/memoryEstimations","../../../../core/Promise","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/support/UpdatingHandles","../../../../geometry/projection/projectPointToVector","../../../../geometry/support/Indices","../../../../geometry/support/scaleUtils","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","../../../../layers/graphics/OptimizedFeature","../../../../layers/graphics/OptimizedGeometry","../../../../layers/graphics/data/FeatureStore","../../../../layers/support/fieldUtils","../../../../renderers/support/heatmapUtils","../graphics/DisplayFeatureLimit","../graphics/GraphicsCorePerformanceInfo","./FeatureVisibilityFilter","./highlightUtils","../../terrain/OverlayRenderer","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/DrapedHeatmapRenderer","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/HeatmapDensityMaterial","../../../support/layerViewUtils","../../../webgl/enums","../../../webgl/heatmapTextureUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V){"use strict";e.HeatmapFeatureProcessor=class extends a.EsriPromise{constructor(e){super(e),this.type="heatmap",this.preferredUpdatePolicy=0,this.dataExtent=null,this.drapeSourceType=1,this._renderGeometries=new Map,this._fieldTotal=0,this._drapeSourceRenderer=null,this._dataType=L.PixelType.HALF_FLOAT,this._pixelFormat=6408,this._updatingHandles=new p.UpdatingHandles}initialize(){let e;try{e=V.loadHeatmapTextureConfiguration(this._renderView.renderingContext,n.getLogger(this))}catch(t){this.addResolvingPromise(Promise.reject(t)),e=V.fallBackHeatmapConfiguration}const{dataType:t,samplingMode:r,pixelFormat:s,internalFormat:o}=e;this._featureStore=new w({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM}),this._dataType=t,this._pixelFormat=s;const a=t!==L.PixelType.FLOAT,c=this.view.basemapTerrain.overlayManager,u={...this._rendererParameters,stage:this.view.stage,dataType:t,samplingMode:r,pixelFormat:s,internalFormat:o,rendererContext:c.renderer,drapeSource:this};this._drapeSourceRenderer=new I.DrapedHeatmapRenderer(u),c.registerDrapeSource(this,this._drapeSourceRenderer),this._material=new D.HeatmapDensityMaterial({usesHalfFloats:a}),this._materialWithField=new D.HeatmapDensityMaterial({usesHalfFloats:a,isAttributeDriven:!0}),this._filterVisibility=new P.FeatureVisibilityFilter({context:{configuration:this.owner,featureStore:this.featureStore,getFeatureCount:()=>this._loadedPointGraphics.length,setAllFeaturesVisibility:e=>this._setAllFeaturesVisibility(e),clearFeaturesVisibility:()=>this._setAllFeaturesVisibility(!0),updateFeatureVisibilities:e=>this._updateFeatureVisibilities(e)}}),this._updatingHandles.addOnCollectionChange(()=>this._loadedPointGraphics,e=>this._onLoadedFeaturesChange(e),l.initial),this._updatingHandles.addWhen(()=>this._materialParameters,e=>this._forEachMaterial(t=>t.setParameters(e)),l.initial),this._updatingHandles.add(()=>this._rendererParameters,e=>this._drapeSourceRenderer.set(e)),this._updatingHandles.add(()=>this._heatmapRendererField,()=>{this._recreate()},l.sync),this._updatingHandles.add(()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric}),({fieldName:e,numeric:t})=>{if(null!=e&&t){let t=0;this._featureStore.forEach(r=>t+=r.attributes[e]??0),this._fieldTotal=t}else this._fieldTotal=this._featureStore.numFeatures},l.initial),this.addHandles([l.watch(()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField}),({fieldName:e,field:t})=>{e&&!t&&n.getLogger(this).warn(`Heatmap renderer field '${e}' for layer '${this.layer.title??this.layer.id}' not found`)}),l.watch(()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric}),({field:e,numeric:t})=>{null==e||t||n.getLogger(this).warn(`Heatmap renderer field '${e.name}' for layer '${this.layer.title??this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)}),i.makeHandle(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))])}destroy(){this._renderGeometries.clear(),this._material=null,this._materialWithField=null,this._featureStore.clear(),this._featureStore=null,this._updatingHandles.destroy()}get layer(){return this.owner.layer}get featureStore(){return this._featureStore}get updating(){return this._updatingHandles.updating||this.filterVisibility.updating}get updatingRemaining(){return 0}get suspendInfo(){return{}}get legendEnabled(){return!0}get filterVisibility(){return this._filterVisibility}get displayFeatureLimit(){const e=this.owner?.view?.quality??1,t=this.owner?.view?.qualitySettings,r=t?Math.ceil(t.heatmap.maxTotalNumberOfFeatures*e):0,i=6*r,s=r;return new T.DisplayFeatureLimit(i,s)}get hasZ(){return"hasZ"in this.layer&&!0===this.layer.hasZ}get hasM(){return"hasM"in this.layer&&this.layer.hasM}get view(){return this.owner.view}get fullOpacity(){return this.owner.fullOpacity}get updatePolicy(){return this.owner.updatePolicy}get scaleVisibilitySuspended(){if(!this._isScaleRangeActive)return!1;const{minScale:e,maxScale:t}=this.layer.effectiveScaleRange,{scale:r}=this.view;return!E.scaleBoundsPredicate(r,e??0,t??0)}get usedMemory(){const e=this.usedMemoryPerFeature*this._featureStore.numFeatures,t=6403===this._pixelFormat?1:4,r=this._dataType===L.PixelType.FLOAT?4:2,i=Math.ceil((this._overlayRenderer?.overlays[0]?.resolution??0)*this._densityMapPixelRatio)??0;return i*i*t*r+e}get usedMemoryPerFeature(){const e=this._loadedPointGraphics.find(()=>!0);if(null==e)return 0;const t=o.estimateAttributesMemory(e);return 6*o.estimateFixedArrayMemory([0,0,0],o.estimateNumberMemory)+6*o.estimateFixedArrayMemory([0,0],o.estimateNumberMemory)+(this._heatmapRendererFieldIsNumeric?6*o.estimateNumberMemory:0)+t}get loadedFeatures(){return this._featureStore.numFeatures}get unprocessedMemoryEstimate(){return 0}get performanceInfo(){return new C.GraphicsCorePerformanceInfo(this._renderGeometries.size,this._visibleFeatures,0,0)}get renderer(){return this._heatmapRenderer}get _overlayRenderer(){return this.view.basemapTerrain.overlayManager.renderer}get _overlaySpatialReference(){return this._overlayRenderer.spatialReference}get _rendererParameters(){return{...this._radiusParameter,...this._densityParameters,...this._colorRampParameter,...this._pixelRatioParameter}}get _materialParameters(){return{...this._radiusParameter,...this._resolutionForScaleParameter}}get _densityParameters(){const e=this._heatmapRenderer;if(null==e)return null;const{minDensity:t,maxDensity:r}=e;return{minDensity:t,maxDensity:r,fieldTotal:this._fieldTotal}}get _radiusParameter(){const e=this._heatmapRenderer;return e?{searchRadius:c.pt2px(this._clampSearchRadius(e.radius))}:null}get _resolutionForScaleParameter(){const e=this._heatmapRenderer;if(!e)return null;const{referenceScale:t}=e;return{resolutionForScale:0===t?0:g.getResolutionForScale(t,this.view.spatialReference)}}get _colorRampParameter(){const e=this._heatmapRenderer;return e?{colorRampData:S.generateGradient(e.colorStops)}:null}get _pixelRatioParameter(){return{pixelRatio:this._densityMapPixelRatio}}get _densityMapPixelRatio(){return this.owner?.view?.qualitySettings.heatmap.pixelRatio??1}get _renderView(){return this.view.stage.renderView}get _featuresArePoints(){return"point"===this.layer.geometryType}get _loadedPointGraphics(){return this.owner.loadedGraphics}get _heatmapRenderer(){const e=this.layer.renderer;return"heatmap"===e?.type?e:null}get _heatmapRendererFieldName(){return this._heatmapRenderer?.field}get _heatmapRendererField(){const e=this._heatmapRendererFieldName;return null!=e?this.layer.fieldsIndex.get(e):null}get _heatmapRendererFieldIsNumeric(){const e=this._heatmapRendererField;return null!=e&&x.isNumericField(e)}get _isScaleRangeActive(){const{layer:e}=this;if(!("effectiveScaleRange"in e))return!1;const{minScale:t,maxScale:r}=e.effectiveScaleRange;return E.isScaleRangeActive(t,r)}get _visibleFeatures(){return Array.from(this._renderGeometries.values()).reduce((e,{visible:t})=>e+(t?1:0),0)}async whenGraphicBounds(){return null}computeAttachmentOrigin(){return null}highlightByGraphics(){return M.emptyHighlightHandle}highlightByObjectIds(){return M.emptyHighlightHandle}maskOccludee(){return i.makeHandle()}setObjectIdVisibility(){}refreshFilter(){this.filterVisibility.reapply()}_onLoadedFeaturesChange(e){if(!this._featuresArePoints)return;const{objectIdField:t}=this.layer;this._featureStore.removeManyById(e.removed.map(e=>y.getObjectId(e,t))),this._featureStore.addMany(e.added.map(e=>{const{attributes:r,centroid:i,geometry:s}=e,n=new b.OptimizedFeature(_.convertFromPoint(new v,s),r,i?_.convertFromPoint(new v,i):null,y.getObjectId(e,t));return n.displayId=e.uid,n}));const i=e.added,s=e.removed;this._fieldTotal+=this._computeFieldTotalChange(i,s);const n=s.map(({uid:e})=>{const t=this._renderGeometries.get(e);return this._renderGeometries.delete(e),t}).filter(r.isSome),o=i.map(e=>{const t=this._pointGraphicToRenderGeometry(e);return this._renderGeometries.set(e.uid,t),t});n.length>0&&this._drapeSourceRenderer.removeGeometries(n,2),o.length>0&&this._drapeSourceRenderer.addGeometries(o,0),(o.length>0||n.length>0)&&(this.filterVisibility.reapply(),this._renderView.requestRender())}_recreate(){if(!this._loadedPointGraphics)return;const e=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:e,removed:e})}_pointGraphicToRenderGeometry(e){const t=this._heatmapRendererFieldName,r=null!=t?this._materialWithField:this._material,i=h.create();f.projectPointToVector(e.geometry,i,this._overlaySpatialReference),i[2]=R.drapedZ;const s=m.getContinuousIndexArray(1),n=[["position",new O.Attribute(i,s,i.length)]],o=this._heatmapRendererFieldIsNumeric;null!=t&&n.push(["featureAttribute",new O.Attribute([o?e.attributes[t]??0:0],s,1)]);const a=new A.RenderGeometry(new F.Geometry(r,n,null,1),{layerViewUid:this.owner.layerViewUid,graphicUid:e.uid});return a.visible=this.filterVisibility.defaultVisibility,a}_forEachMaterial(e){e(this._material),e(this._materialWithField)}_computeFieldTotalChange(e,t){if(null==this._heatmapRendererFieldName||!this._heatmapRendererFieldIsNumeric)return e.length-t.length;const r=this._heatmapRendererFieldName,i=(e,t)=>e+(t.attributes[r]??0);return e.reduce(i,0)-t.reduce(i,0)}_clampSearchRadius(e){return e>112&&n.getLogger(this).warnOnce("SceneView supports a maximum radius of 112 pt for HeatmapRenderer."),Math.min(e,112)}_updateFeatureVisibilities(e){const t=[];this._featureStore.forEach(({objectId:r,displayId:i})=>{const s=e(r),n=this._renderGeometries.get(i);n&&n.visible!==s&&(t.push(n),n.visible=s)}),this._drapeSourceRenderer.modifyGeometries(t,1)}_setAllFeaturesVisibility(e){const t=[];for(const r of this._renderGeometries.values())r.visible!==e&&(t.push(r),r.visible=e);this._drapeSourceRenderer.modifyGeometries(t,1)}get test(){}},t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"type",void 0),t.__decorate([u.property({constructOnly:!0})],e.HeatmapFeatureProcessor.prototype,"owner",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"layer",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"featureStore",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"updating",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"updatingRemaining",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"suspendInfo",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"legendEnabled",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"filterVisibility",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"displayFeatureLimit",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"preferredUpdatePolicy",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"hasZ",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"hasM",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"dataExtent",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"view",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"fullOpacity",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"updatePolicy",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"drapeSourceType",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"scaleVisibilitySuspended",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"renderer",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_featureStore",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_filterVisibility",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_overlayRenderer",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_overlaySpatialReference",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_rendererParameters",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_materialParameters",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_densityParameters",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_radiusParameter",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_resolutionForScaleParameter",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_colorRampParameter",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_pixelRatioParameter",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_densityMapPixelRatio",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_renderGeometries",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_material",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_materialWithField",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_renderView",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_featuresArePoints",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_loadedPointGraphics",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRenderer",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRendererFieldName",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRendererField",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRendererFieldIsNumeric",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_fieldTotal",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_drapeSourceRenderer",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_isScaleRangeActive",null),e.HeatmapFeatureProcessor=t.__decorate([d.subclass("esri.views.3d.layers.support.HeatmapFeatureProcessor")],e.HeatmapFeatureProcessor),e.maxRadiusPt=112,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/FeatureStore":function(){define(["../../../core/arrayUtils","../../../core/Error","../../../core/Evented","../../../core/Logger","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../featureConversionUtils","./BoundsStore","./geometryUtils","./optimizedFeatureQueryEngineAdapter"],function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=s.create();return class{constructor(e){this.geometryInfo=e,this._boundsStore=new a.BoundsStore,this._featuresById=new Map,this._usedMemory=0,this.events=new r.EventEmitter,this.featureAdapter=c.optimizedFeatureQueryEngineAdapter}get usedMemory(){return this._usedMemory}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach(t=>{null!=t.geometry&&t.geometry.coords&&(e+=t.geometry.coords.length)}),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(null==this.fullBounds)return null;const[t,r,i,s]=this.fullBounds;return{xmin:t,ymin:r,xmax:i,ymax:s,spatialReference:l.cleanFromGeometryEngine(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}upsertMany(t){const r=t.map(e=>this._upsert(e));return this._emitChanged(),r.filter(e.isSome)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged(),this._usedMemory=0}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t){for(const r of e){const e=this._boundsStore.get(r.objectId);e&&t(s.fromRect(u,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach(t=>e(t))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,e=>{t(this._featuresById.get(e))})}_emitChanged(){this.events.emit("changed",void 0)}_add(e){if(!e)return;const r=e.objectId;if(null==r)return void i.getLogger("esri.layers.graphics.data.FeatureStore").error(new t("featurestore:invalid-feature","feature id is missing",{feature:e}));const s=this._featuresById.get(r);let a;if(s?(e.displayId=s.displayId,a=this._boundsStore.get(r),this._boundsStore.delete(r),this._usedMemory-=this.estimateFeatureUsedMemory?.(s)??0):null!=this.onFeatureAdd&&this.onFeatureAdd(e),!e.geometry?.coords?.length)return this._boundsStore.set(r,null),void this._featuresById.set(r,e);a=o.getBoundsOptimizedGeometry(null!=a?a:n.create(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=a&&this._boundsStore.set(r,a),this._featuresById.set(r,e),this._usedMemory+=this.estimateFeatureUsedMemory?.(e)??0}_upsert(e){const r=e?.objectId;if(null==r)return i.getLogger("esri.layers.graphics.data.FeatureStore").error(new t("featurestore:invalid-feature","feature id is missing",{feature:e})),null;const s=this._featuresById.get(r);if(!s)return this._add(e),e;this._usedMemory-=this.estimateFeatureUsedMemory?.(s)??0;const{geometry:a,attributes:l}=e;for(const e in l)s.attributes[e]=l[e];return a&&(s.geometry=a,this._boundsStore.set(r,o.getBoundsOptimizedGeometry(n.create(),a,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null)),this._usedMemory+=this.estimateFeatureUsedMemory?.(s)??0,s}_remove(e){null!=this.onFeatureRemove&&this.onFeatureRemove(e);const t=e.objectId;return this._boundsStore.delete(t),this._featuresById.delete(t),this._usedMemory-=this.estimateFeatureUsedMemory?.(e)??0,e}}})},"esri/layers/graphics/data/BoundsStore":function(){define(["exports","../../../core/has","../../../core/libs/rbush/PooledRBush","../../../geometry/support/aaBoundingRect"],function(e,t,r,i){"use strict";const s={minX:0,minY:0,maxX:0,maxY:0};e.BoundsStore=class{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new r.PooledRBush(9,t("esri-csp-restrictions")?e=>({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const e=new Array(this._idByBounds.size);let t=0;this._idByBounds.forEach((r,i)=>{e[t++]=i}),this._indexInvalid=!1,this._index.clear(),this._index.load(e)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter(e=>this._idByBounds.has(e))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const e=i.empty();for(const t of this._boundsById.values())t&&(e[0]=Math.min(t[0],e[0]),e[1]=Math.min(t[1],e[1]),e[2]=Math.max(t[2],e[2]),e[3]=Math.max(t[3],e[3]));return e}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(e){const t=this._boundsById.get(e);this._boundsById.delete(e),t&&(this._idByBounds.delete(t),this._indexInvalid||this._index.remove(t))}forEachInBounds(e,t){this._loadIndex(),function(e,t,r){!function(e){s.minX=e[0],s.minY=e[1],s.maxX=e[2],s.maxY=e[3]}(t),e.search(s,r)}(this._index,e,e=>t(this._idByBounds.get(e)))}get(e){return this._boundsById.get(e)}has(e){return this._boundsById.has(e)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(e,t){if(!this._indexInvalid){const t=this._boundsById.get(e);t&&(this._index.remove(t),this._idByBounds.delete(t))}this._boundsById.set(e,t),t&&(this._idByBounds.set(t,e),this._indexInvalid||(this._boundsToLoad.push(t),this._boundsToLoad.length>5e4&&this._loadIndex()))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/lib/DrapedHeatmapRenderer":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./glUtil3D","./SortedRenderGeometryRenderer","../shaders/HeatmapTechnique","../shaders/HeatmapTechniqueConfiguration","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/TextureDescriptor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g){"use strict";e.DrapedHeatmapRenderer=class extends u.SortedRenderGeometryRenderer{constructor(e){super(e),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new d.HeatmapPassParameters,this._configuration=new h.HeatmapTechniqueConfiguration;const t=new g.TextureDescriptor;t.pixelFormat=e.pixelFormat,t.internalFormat=e.internalFormat,t.dataType=e.dataType,t.samplingMode=e.samplingMode,t.wrapMode=33071;const r=e.rendererContext.rctx;this._densityMap=new f.FramebufferObject(r,t),this._vao=c.createQuadVAO(r),this._configuration.usesHalfFloat=e.dataType!==p.PixelType.FLOAT,e.rendererContext.pluginContext.techniques.precompile(d.HeatmapTechnique,this._configuration)}initialize(){const e=this._colorRampData,t=new g.TextureDescriptor(e.length/4,1);t.wrapMode=33071,this._colorRamp=new m.Texture(this.rctx,t,e),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles(i.watch(()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius],()=>this.rendererContext.notifyContentChanged()))}destroy(){this._densityMap=r.disposeMaybe(this._densityMap),this._vao=r.disposeMaybe(this._vao),this._colorRamp=r.disposeMaybe(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(e){e!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=e,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(e){e!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=e,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(e){e!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=e,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(e){this._heatmapParameters.fieldTotal=e,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(e){const{colorRamp:t}=this._heatmapParameters;if(null!=t&&e!==this._colorRampData){const r=t.descriptor.width,i=e.length/4;i!==r&&t.resize(i,1),t.setData(e)}this._colorRampData=e}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(e){this._heatmapParameters.colorRamp=e}get hasHighlights(){return!1}get hasWater(){return!1}render(e){const t=this.sortedRenderers;if(0===t.length)return;const r=this.rctx.getBoundFramebufferObject(),i=this.rctx.getViewport(),{pixelRatio:s}=this,n=Math.ceil(i.width*s),o=Math.ceil(i.height*s);this._densityMap.resize(n,o),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,n,o),this.rctx.clear(16384);let a=!1;if(t.forAll(t=>{const r=t.acquireTechniques(e);r&&(t.render(e,r),a=!0)}),this.rctx.bindFramebuffer(r),this.rctx.setViewport(i.x,i.y,i.width,i.height),!a)return;this.rctx.bindVAO(this._vao);const l=this.rendererContext.pluginContext.techniques.get(d.HeatmapTechnique,this._configuration);this.rctx.bindTechnique(l,e.bind,this._heatmapParameters),this.rctx.drawArrays(l.primitiveType,0,this._vao.vertexCount("geometry"))}},t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"searchRadius",null),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"minDensity",null),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"maxDensity",null),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"fieldTotal",null),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"pixelRatio",void 0),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"colorRampData",null),t.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"dataType",void 0),t.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"samplingMode",void 0),t.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"pixelFormat",void 0),t.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"internalFormat",void 0),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"_colorRampData",void 0),e.DrapedHeatmapRenderer=t.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],e.DrapedHeatmapRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/HeatmapTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/DefaultVertexBufferLayouts","../../../../chunks/Heatmap.glsl","../../../webgl/enums","../../../webgl/NoParameters","../../../webgl/renderState"],function(e,t,r,i,s,n,o,a,l){"use strict";class c extends a.NoParameters{constructor(){super(...arguments),this.colorRamp=null,this.densityMap=null,this.searchRadius=1,this.fieldTotal=0,this.minDensity=0,this.maxDensity=100}}class u extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.Heatmap,()=>new Promise((t,r)=>e(["./Heatmap.glsl"],t,r))),s.Pos2Locations),this.primitiveType=o.PrimitiveType.TRIANGLE_STRIP}initializePipeline(){return l.makePipelineState({blending:l.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:l.defaultColorWrite,depthTest:null,depthWrite:null})}}t.HeatmapPassParameters=c,t.HeatmapTechnique=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/Heatmap.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n){"use strict";function o(e){const o=new n.ShaderBuilder;return o.include(t.ScreenSpacePass),o.fragment.uniforms.add(new s.Texture2DPassUniform("densityMap",e=>e.densityMap),new s.Texture2DPassUniform("tex",e=>e.colorRamp),new r.FloatPassUniform("densityNormalizer",e=>1/(e.maxDensity-e.minDensity)),new r.FloatPassUniform("minDensity",e=>e.minDensity),new r.FloatPassUniform("densityMultiplier",t=>3/(t.searchRadius*t.searchRadius*Math.PI)*(e.usesHalfFloat?4:1))).main.add(i.glsl`float density = texture(densityMap, uv).r * densityMultiplier;
float densityRatio = (density - minDensity) * densityNormalizer;
fragColor = texture(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));`),o}const a=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}));e.Heatmap=a,e.build=o})},"esri/views/3d/webgl-engine/shaders/HeatmapTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(){super(...arguments),this.usesHalfFloat=!1}}t.__decorate([r.parameter()],s.prototype,"usesHalfFloat",void 0),e.HeatmapTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/materials/HeatmapDensityMaterial":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../lib/GLMaterial","../lib/Material","./internal/bufferWriterUtils","../shaders/HeatmapDensityTechnique","../shaders/HeatmapDensityTechniqueConfiguration"],function(e,t,r,i,s,n,o,a){"use strict";class l extends o.HeatmapDensityPassParameters{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloats=!1}}class c extends s.Material{constructor(e){super(e,l),this.produces=new Map([[18,e=>0===e]]),this._configuration=new a.HeatmapDensityTechniqueConfiguration}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.isAttributeDriven=this.parameters.isAttributeDriven,this._configuration.usesHalfFloat=this.parameters.usesHalfFloats,this._configuration}get visible(){return!0}createGLMaterial(e){return new u(e)}intersect(){}intersectDraped(e,r,i,s,n){const o=e.attributes.get("position"),{parameters:a}=this,{searchRadius:l}=a,{screenToWorldRatio:c}=e,u=l*c+2*c,d=u*u,h=o.data.length/o.size;for(let e=0;e<h;e++){const r=e*o.size,a=t.set(p,o.data[r],o.data[r+1]);t.squaredDistance(a,i)<d&&s(n.distance,n.normal,-1)}}createBufferWriter(){return new d(this.parameters.isAttributeDriven?o.attributeDrivenLayout:o.layout)}}class u extends i{beginSlot(e){return this.getTechnique(o.HeatmapDensityTechnique,e)}}class d{constructor(e){this.layout=e}elementCount(e){return e.get("position").indices.length*h}write(e,t,r,i,s,o){n.writePosition(r.get("position"),e,s.position,o,h);const a=r.get("position").indices.length,l=s.uv0;let c=o;for(let e=0;e<a;++e)l.setValues(c++,-1,-1),l.setValues(c++,1,-1),l.setValues(c++,1,1),l.setValues(c++,1,1),l.setValues(c++,-1,1),l.setValues(c++,-1,-1);const u="featureAttribute"in s?s.featureAttribute:null;return u&&n.writeBufferFloat(r.get("featureAttribute"),u,o,h),null}}const h=6,p=r.create();e.HeatmapDensityMaterial=c,e.Parameters=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/HeatmapDensityTechnique":function(){define(["require","exports","../../support/buffer/InterleavedLayout","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/Material","../../../../chunks/HeatmapDensity.glsl","../../../webgl/renderState"],function(e,t,r,i,s,n,o,a){"use strict";class l extends n.MaterialParameters{constructor(){super(...arguments),this.searchRadius=128,this.resolutionForScale=0}}class c extends s.ShaderTechnique{constructor(t,r){super(t,r,new i.ReloadableShaderModule(o.HeatmapDensity,()=>new Promise((t,r)=>e(["./HeatmapDensity.glsl"],t,r))),(r.isAttributeDriven?d:u).locations)}initializePipeline(){return a.makePipelineState({blending:a.add,colorWrite:a.defaultColorWrite,depthTest:null,depthWrite:null})}destroy(){super.destroy()}}const u=r.newLayout().vec3f("position").vec2f16("uv0"),d=u.clone().f32("featureAttribute");t.HeatmapDensityPassParameters=l,t.HeatmapDensityTechnique=c,t.attributeDrivenLayout=d,t.layout=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/HeatmapDensity.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/webgl/ShaderBuilder"],function(e,t,r,i,s){"use strict";function n(e){const n=new s.ShaderBuilder,{vertex:o,fragment:a,attributes:l,varyings:c}=n;t.addProjViewLocalOrigin(o,e);const{isAttributeDriven:u,usesHalfFloat:d}=e;return l.add("position","vec3"),l.add("uv0","vec2"),u&&(l.add("featureAttribute","float"),c.add("attributeValue","float")),d&&a.constants.add("compressionFactor","float",.25),c.add("unitCirclePos","vec2"),o.uniforms.add(new r.FloatPassUniform("radius",({resolutionForScale:e,searchRadius:t},{camera:r,screenToWorldRatio:i,overlayStretch:s})=>2*t*(0===e?1:e/i)*r.pixelRatio/r.fullViewport[2]/s)),o.main.add(i.glsl`
    unitCirclePos = uv0;

    vec4 posProj = proj * (view * vec4(${"position"}, 1.0));
    vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

    ${u?i.glsl`attributeValue = ${"featureAttribute"};`:""}
    gl_Position = posProj + quadOffset;
  `),a.main.add(i.glsl`
    float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
    if (radiusRatioSquared > 1.0) {
      fragColor = vec4(0.0);
    }
    else {
      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${u?i.glsl` * attributeValue`:""} ${d?i.glsl` * compressionFactor`:""};
      fragColor = vec4(density);
    }
  `),n}const o=Object.freeze(Object.defineProperty({__proto__:null,build:n},Symbol.toStringTag,{value:"Module"}));e.HeatmapDensity=o,e.build=n})},"esri/views/3d/webgl-engine/shaders/HeatmapDensityTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloat=!1}}t.__decorate([r.parameter()],s.prototype,"isAttributeDriven",void 0),t.__decorate([r.parameter()],s.prototype,"usesHalfFloat",void 0),e.HeatmapDensityTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/webgl/heatmapTextureUtils":function(){define(["exports","../../core/Error","./enums"],function(e,t,r){"use strict";class i{constructor(e,t,r,i){this.dataType=e,this.samplingMode=t,this.pixelFormat=r,this.internalFormat=i}}const s=new i(r.PixelType.HALF_FLOAT,9728,6408,6408);e.HeatmapTextureConfiguration=i,e.fallBackHeatmapConfiguration=s,e.loadHeatmapTextureConfiguration=function(e,s){const{textureFloatLinear:n,colorBufferFloat:o}=e.capabilities,a=o?.textureFloat,l=o?.textureHalfFloat,c=o?.floatBlend,u=e.driverTest.floatBufferBlend.result;if(!a&&!l)throw new t("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(c&&u||l))throw new t("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(u?"":" This device claims support for EXT_float_blend, but does not actually support it."));const d=a&&c&&u,h=l,p=n,f=!!o?.R32F,m=!!o?.R16F;if(d&&p)return p||s.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new i(r.PixelType.FLOAT,p?9729:9728,f?6403:6408,f?r.SizedPixelFormat.R32F:6408);if(h)return new i(r.PixelType.HALF_FLOAT,9729,m?6403:6408,m?r.SizedPixelFormat.R16F:6408);throw new t("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/FeatureTileFetcher3DContext":function(){define(["exports","../../../../core/maybe","./featureTileQuery3D"],function(e,t,r){"use strict";function i(e){const t=e.capabilities.query;return{supportsMultipleResolutions:s(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function s(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}e.FeatureTileFetcher3DContext=class{constructor(e){this._memoryCache=null;const t=e.layerView.layer;this._layerView=e.layerView,this.objectIdField=t.objectIdField,this.globalIdField="globalIdField"in t?t.globalIdField:null,this._returnZ=e.returnZ,this._returnM=e.returnM;const i=this._layerView.view.resourceController;this.query=r.createFeatureTileQuery3D(this._layerView,i.normal),i&&this._memoryCacheEnabled&&(this._memoryCache=i.memoryController.newCache(`fl-${t.uid}`))}get _memoryCacheEnabled(){switch(this._layerView.layer.source.type){case"feature-layer":case"ogc-feature":case"oriented-imagery":return!0;case"csv":case"parquet":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=t.destroyMaybe(this._memoryCache),this.query.destroy()}createQuery(){const e=this._layerView.layer.createQuery();return e.outFields=this._layerView.availableFields,e.returnZ=this._returnZ,e.returnM=this._returnM,e.outSpatialReference=this.tilingScheme?.spatialReference??this._layerView.view.spatialReference,e}get memoryCache(){return this._memoryCache}get viewingMode(){return this._layerView.view.state.viewingMode}get tilingScheme(){return this._layerView.view.featureTiles?.tilingScheme}get scheduler(){return this._layerView.view.resourceController?.scheduler}get geometryType(){return this._layerView.layer.geometryType}get fullExtent(){return this._layerView.layer.fullExtent}get tileMaxRecordCount(){return this._layerView.layer.capabilities.query.tileMaxRecordCount}get standardMaxRecordCount(){return this._layerView.layer.capabilities.query.standardMaxRecordCount}get maxRecordCount(){return this._layerView.layer.capabilities.query.maxRecordCount}get isDraped(){return"on-the-ground"===this._layerView.layer.elevationInfo?.mode}get effectiveDisplayFilter(){return this._layerView.displayFilterEnabled?this._layerView.effectiveDisplayFilter:null}get highlightIds(){return this._layerView.displayFilterEnabled?this._layerView.highlightIds:null}get capabilities(){return this._capabilities??=i(this._layerView.layer),this._capabilities}logFetchError(e,t){e.error("#fetchTile()",this._layerView.layer,t?.message??t)}},e.contextCapabilitiesFromLayer=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/featureTileQuery3D":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/SetUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/dehydratedFeatures","../../../../rest/query/operations/query","../../support/PBFDecoder"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";let f=class extends r{constructor(e){super(e)}get implicitFields(){const e=this.layer.outFields?.includes("*");if(!e)return new Set;const t=new Set(this.layerView.requiredFields),r=new Set(this.layerView.availableFields);return n.difference(r,t)}get queryFeaturesDehydrated(){const{layer:e}=this,t=e.capabilities,r=t&&t.query,i=r&&r.supportsFormatPBF,n=e.parsedUrl;if(i){null==this._decoder&&(this._decoder=new p.PBFDecoder(this.controller));const t={sourceSpatialReference:e.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:y};return(e,r)=>h.runQuery(n,e,"pbf",this._createRequestOptions(r)).then(e=>(s.throwIfAborted(r),null!=this._decoder?this._decoder.invoke({buffer:e.data,options:t},r.signal):Promise.reject(s.createAbortError())))}return(t,r)=>h.executeQuery(n,t,e.spatialReference,this._createRequestOptions(r)).then(e=>d.fromFeatureSetJSON(e.data,{maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:y}))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}destroy(){this._decoder=i.destroyMaybe(this._decoder)}_createRequestOptions(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...e?.query}}}};t.__decorate([o.property({constructOnly:!0})],f.prototype,"layer",void 0),t.__decorate([o.property({constructOnly:!0})],f.prototype,"layerView",void 0),t.__decorate([o.property({constructOnly:!0})],f.prototype,"controller",void 0),t.__decorate([o.property({readOnly:!0})],f.prototype,"implicitFields",null),t.__decorate([o.property({readOnly:!0})],f.prototype,"queryFeaturesDehydrated",null),f=t.__decorate([u.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],f);let m=class extends r{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}};t.__decorate([o.property({constructOnly:!0})],m.prototype,"layer",void 0),m=t.__decorate([u.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileOGCServiceQuery3D")],m);let g=class extends r{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.source.queryFeaturesJSON(e,t).then(d.fromFeatureSetJSON,r=>{if(r&&"query-features-json:unsupported"===r.name)return this.layer.queryFeatures(e,t);throw r})}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};t.__decorate([o.property({constructOnly:!0})],g.prototype,"layer",void 0),t.__decorate([o.property({constructOnly:!0})],g.prototype,"source",void 0),g=t.__decorate([u.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],g);const y=1024;e.createFeatureTileQuery3D=function(e,t){const{layer:r}=e;return"feature"===r.type&&"feature-layer"===r.source.type||"catalog-footprint"===r.type?new f({layer:r,layerView:e,controller:t}):"feature"===r.type&&"memory"===r.source.type||"csv"===r.type||"geojson"===r.type||"oriented-imagery"===r.type||"wfs"===r.type?new g({layer:r,source:r.source}):"ogc-feature"===r.type?new m({layer:r}):null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/PBFDecoder":function(){define(["exports","../../../core/uid","../../../core/workers/WorkerHandle","../../../geometry/SpatialReference","../../../layers/support/Field"],function(e,t,r,i,s){"use strict";function n(e){switch(e.type){case"polyline":e.paths=e.hasZ&&e.hasM?e.paths.map(e=>e.map(e=>[e[0],e[1],e[2],e[3]])):e.hasZ||e.hasM?e.paths.map(e=>e.map(e=>[e[0],e[1],e[2]])):e.paths.map(e=>e.map(e=>[e[0],e[1]]));break;case"polygon":e.rings=e.hasZ&&e.hasM?e.rings.map(e=>e.map(e=>[e[0],e[1],e[2],e[3]])):e.hasZ||e.hasM?e.rings.map(e=>e.map(e=>[e[0],e[1],e[2]])):e.rings.map(e=>e.map(e=>[e[0],e[1]]))}}class o extends r.WorkerHandle{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:e=>[e.buffer]},e)}}e.PBFDecoder=class{constructor(e){this._controller=e,this._handle=new o(t=>e.schedule(t))}destroy(){this._handle.destroy()}invoke(e,r){return e.buffer&&0!==e.buffer.byteLength?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof i&&(e.options={...e.options,sourceSpatialReference:e.options.sourceSpatialReference.toJSON()}),this._handle.invoke(e,r).then(e=>{let r=0,o=0;const a=i.fromJSON(e.spatialReference);e.spatialReference=a;const l=async i=>{const c=e.fields;if(c)for(;r<c.length;)if(c[r]=s.fromJSON(c[r]),r++,i.madeProgress())return this._controller.reschedule(e=>l(e));const u=e.features;for(;o<u.length;){const e=u[o];++o,e.uid=t.generateUID();const r=e.geometry;if(null!=r&&(r.spatialReference=a,n(r),i.madeProgress()))return this._controller.reschedule(e=>l(e))}return e};return this._controller.schedule(e=>l(e))})):Promise.resolve(null)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/EventedSet":function(){define(["exports","../../../core/Evented","../../../core/signal"],function(e,t,r){"use strict";class i extends t.Evented{constructor(){super(...arguments),this._set=new Set,this._length=r.signal(0)}clear(){if(this._set.size>0){const e=this.toArray();this._set.clear(),this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:e})}}get length(){return this._length.value}addMany(e){if(0!==e.length){for(const t of e)this._set.add(t);this._length.value=this._set.size,this.emit("after-changes",{type:1}),this.emit("change",{added:e,removed:[]})}}remove(e){this._set.delete(e)&&(this._length.value=this._set.size,this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:[e]}))}removeMany(e){const t=[];for(const r of e)this._set.delete(r)&&t.push(r);t.length>0&&(this._length.value=this._set.size,this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:t}))}toArray(){return Array.from(this._set.values())}find(e){for(const t of this._set.values())if(e(t))return t}some(e){for(const t of this._set.values())if(e(t))return!0;return!1}forEach(e){this._set.forEach(t=>e(t))}}e.EventedSet=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/FeatureLayerView":function(){define(["exports","../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/promiseUtils","../../core/reactiveUtils","../../core/sql","../../core/accessorSupport/decorators/property","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../graphic/graphicOriginUtils","../../layers/graphics/data/FeatureIdInfo","../../layers/knowledgeGraph/constants","../../layers/support/displayFilterUtils","../../layers/support/FeatureEffect","../../layers/support/FeatureFilter","../../layers/support/featureLayerUtils","../../layers/support/featurePopupQueryUtils","../../layers/support/fieldUtils","../../layers/support/floorFilterUtils","../../networks/support/networkFieldUtils","../../rest/support/Query","../2d/layers/features/layerAdapters/featureServiceUtils","./support/popupUtils","./support/WhereClauseVisitor"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T){"use strict";e.FeatureLayerView=e=>{const r=e;let l=class extends r{constructor(...e){super(...e),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([n.watch(()=>{const e=this.layer,t=this.view;return[e&&"elevationInfo"in e?e.elevationInfo?.featureExpressionInfo:null,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,t?.requiredFieldsOptions?.featureTitleFields&&e&&"featureTitleFields"in e&&e.featureTitleFields,t?.requiredFieldsOptions?.utilityNetworkFields&&v.getUtilityNetworkFields(t,e),e.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,"knowledge-graph-sublayer"===e?.type&&"link-chart"===e.parentCompositeLayer.type&&e.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode,"parquet"===e?.type&&e.popupTemplate]},()=>this._handleChange(),n.syncAndInitial),n.on(()=>this.view?.floors,"change",()=>this._handleChange()),n.on(()=>this.layer.displayFilterInfo?.filters,"change",()=>this._handleChange()),n.on(()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null,"change",()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?_.fixFields(t,[..._.unpackFieldNames(t,e.outFields),...r]):_.fixFields(t,r)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){const e=this.layer;return this.displayFilterEnabled&&e.displayFilterInfo?p.getEffectiveDisplayFilter(e.displayFilterInfo,this.view):null}get effectiveDisplayFilterClause(){const e=this.effectiveDisplayFilter?.where??null;return e&&this.hasHighlight?o.sqlOr(e,o.sqlIn(this.layer.objectIdField,this.highlightIds)):e}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){i.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?g.getSignedInUser(this.layer.url):Promise.resolve(null)}highlight(e,t){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=null!=this.filter?this.filter.createQuery(e):new w(e);return"floorInfo"in this.layer&&this.layer.floorInfo&&(t.where=o.sqlAnd(t.where,b.getFloorFilterClause(this))),this.displayFilterEnabled&&(t.where=o.sqlAnd(t.where,this.effectiveDisplayFilter?.where)),null!=this.timeExtent&&(t.timeExtent=null!=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new w(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(e,t){const r=await this._createPopupQuery(e.map(e=>u.getGraphicOriginLayer(e.origin)??e.layer),t);return await y.fetchFeaturePopupFeatures(this.layer,e,r,{getPopupTemplate:e=>S.getFetchPopupTemplate(e,{...t,checkPopupEnabled:!0}),hasRequiredFields:(e,t)=>this._popupFeatureHasRequiredFields(e,t),...t})}_handleChange(){const e=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set("_updatingRequiredPromise",e),e.then(()=>{this._updatingRequiredPromise===e&&this._set("_updatingRequiredPromise",null)}),e}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;const{layer:e}=this,t=new T.WhereClauseVisitor(e.fieldsIndex);if(t.visitFilter(this.filter),"featureReduction"in e&&t.visitFeatureReduction(e.featureReduction),"labelingInfo"in e&&t.visitLabelingInfo(e.labelsVisible,e.labelingInfo),"trackInfo"in e&&t.visitTrackInfo(e.trackInfo),"2d"===this.view.type&&(t.visitFilter(this.featureEffect?.filter),t.visitDisplayFilter(this.displayFilterEnabled,e.displayFilterInfo),"featureReduction"in e&&t.visitFeatureReduction(e.featureReduction)),"subtype-group"===e.type)for(const r of e.sublayers)t.visitLabelingInfo(r.labelsVisible,r.labelingInfo);try{const e=await t.finish();this._set("requiresCurrentUser",e.requiresCurrentUser)}catch(e){i.getLogger(this).error(e)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:r}}=this,s="renderer"in t&&t.renderer,n="orderBy"in t&&t.orderBy,o="featureReduction"in t?t.featureReduction:null,a=new Set,l=[s?s.collectRequiredFields(a,r):null,_.collectLabelingFields(a,t),e&&"elevationInfo"in t?_.collectElevationFields(a,t):null,null!=this.filter?_.collectFilterFields(a,t,this.filter):null,e||null==this.featureEffect?null:_.collectFilterFields(a,t,this.featureEffect.filter),!e&&o?_.collectFeatureReductionFields(a,t,o):null,!e&&n?_.collectOrderByInfos(a,t,n):null];if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&_.collectFields(a,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"timeInfo"in t&&t.timeInfo&&"trackInfo"in t&&t.trackInfo){const{trackInfo:e}=t;_.collectFields(a,t.fieldsIndex,[t.timeInfo.trackIdField]),"feature"!==t.type&&"startTimeField"!==e.timeField||_.collectFields(a,t.fieldsIndex,[t.timeInfo.startField]),"endTimeField"===e.timeField&&_.collectFields(a,t.fieldsIndex,[t.timeInfo.endField]),await _.collectTrackInfoFields(a,t)}if("floorInfo"in t&&t.floorInfo&&_.collectFields(a,t.fieldsIndex,[t.floorInfo.floorField]),"featureTitleFields"in t&&this.view?.requiredFieldsOptions?.featureTitleFields&&t.featureTitleFields&&_.collectFields(a,t.fieldsIndex,t.featureTitleFields),"feature"===t.type&&t.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&_.collectFields(a,t.fieldsIndex,[t.globalIdField]),this.displayFilterEnabled&&l.push(_.collectDisplayFilterFields(a,t,t.displayFilterInfo)),"feature"===t.type&&e&&null!=t.infoFor3D&&(null==t.globalIdField&&i.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),_.collectFields(a,t.fieldsIndex,[t.globalIdField])),"subtype-group"===t.type){_.collectField(a,r,t.subtypeField);const e=t.sublayers.map(e=>Promise.all([e.renderer?.collectRequiredFields(a,r),_.collectLabelingFields(a,e)]));l.push(Promise.all(e))}if("catalog-footprint"===t.type&&t.parent){const e=t.parent;_.collectFields(a,r,[e.itemNameField,e.itemSourceField,e.itemTypeField,e.maxScaleField,e.minScaleField])}"knowledge-graph-sublayer"===t.type&&"link-chart"===t.parentCompositeLayer.type&&_.collectField(a,r,h.systemIsSpatialFieldName),"parquet"===t.type&&l.push(S.getRequiredFields(t,t.popupTemplate).then(e=>{for(const t of e)a.add(t)}));const c=await Promise.allSettled(l);if(e)_.collectField(a,r,t.objectIdField);else for(const e of d.getFeatureIdInfoFieldNames(x.createFeatureIdInfo(t)))_.collectField(a,r,e);e&&"displayField"in t&&t.displayField&&_.collectField(a,r,t.displayField);for(const e of c)"rejected"===e.status&&i.getLogger(this).error(e.reason);const u=Array.from(a).sort();this._set("requiredFields",u)}_popupFeatureHasRequiredFields(e,t){return _.featureHasFields(e,t)}async _createPopupQuery(e,t){const r=this.layer.createQuery(),i=new Set;let n=!1;const a=e??[this.layer];for(const e of a){const r=S.getFetchPopupTemplate(e,t);if(null==r)continue;const o=await y.loadFeaturePopupArcadeModules(r);s.throwIfAborted(t);const a=o&&o.arcadeUtils.hasGeometryOperations(r);n=!("point"!==this.layer.geometryType&&!a);const l=await S.getRequiredFields(this.layer,r);s.throwIfAborted(t);for(const e of l)i.add(e)}return r.returnGeometry=n,r.returnZ=n,r.returnM=n,r.outFields=Array.from(i),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(r.where=o.sqlAnd(r.where,b.getFloorFilterClause(this))),r}canResume(){return!(!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty)}getTest(){}get test(){}};return t.__decorate([a.property()],l.prototype,"_updatingRequiredPromise",void 0),t.__decorate([a.property({readOnly:!0})],l.prototype,"availableFields",null),t.__decorate([a.property({readOnly:!0})],l.prototype,"displayFilterEnabled",null),t.__decorate([a.property({readOnly:!0})],l.prototype,"effectiveDisplayFilter",null),t.__decorate([a.property({readOnly:!0})],l.prototype,"effectiveDisplayFilterClause",null),t.__decorate([a.property({type:f})],l.prototype,"featureEffect",null),t.__decorate([a.property({type:m})],l.prototype,"filter",void 0),t.__decorate([a.property()],l.prototype,"layer",void 0),t.__decorate([a.property({type:Number})],l.prototype,"maximumNumberOfFeatures",null),t.__decorate([a.property({readOnly:!0,type:Boolean})],l.prototype,"maximumNumberOfFeaturesExceeded",null),t.__decorate([a.property()],l.prototype,"requiresCurrentUser",void 0),t.__decorate([a.property({readOnly:!0})],l.prototype,"requiredFields",void 0),t.__decorate([a.property({readOnly:!0})],l.prototype,"signedInUser",null),t.__decorate([a.property()],l.prototype,"suspended",void 0),t.__decorate([a.property()],l.prototype,"view",void 0),l=t.__decorate([c.subclass("esri.views.layers.FeatureLayerView")],l),l},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/graphic/graphicOriginUtils":function(){define(["exports"],function(e){"use strict";e.getGraphicOriginLayer=function(e){return e&&"layer"in e?e.layer:void 0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/data/FeatureIdInfo":function(){define(["exports"],function(e){"use strict";e.getFeatureIdInfoFieldNames=function*(e){switch(e.type){case"object-id":case"unique-id-simple":return void(yield e.fieldName);case"unique-id-composite":return void(yield*e.fieldNames)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/knowledgeGraph/constants":function(){define(["exports"],function(e){"use strict";e.systemAggregationCountFieldName="ESRI__AggregationCount",e.systemDestinationIdFieldName="ESRI__DestID",e.systemIsSpatialFieldName="LC.ESRI__IsSpatial",e.systemLayoutGeometryFieldName="ESRI__LayoutGeometry",e.systemOidFieldName="ESRI__ID",e.systemOriginIdFieldName="ESRI__OriginID",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/networks/support/networkFieldUtils":function(){define(["exports"],function(e){"use strict";e.getAssociationsTableFields=function(e){const t=e?.fieldsIndex,r="fromnetworksourceid",i="fromglobalid",s="fromterminalid",n="tonetworksourceid",o="toglobalid",a="toterminalid",l="status",c="associationtype",u="iscontentvisible",d="percentalong",h="globalid";return{fromNetworkSourceId:t?.get(r)?.name??r,fromGlobalId:t?.get(i)?.name??i,fromTerminalId:t?.get(s)?.name??s,toNetworkSourceId:t?.get(n)?.name??n,toGlobalId:t?.get(o)?.name??o,toTerminalId:t?.get(a)?.name??a,status:t?.get(l)?.name??l,associationType:t?.get(c)?.name??c,isContentVisible:t?.get(u)?.name??u,percentAlong:t?.get(d)?.name??d,globalId:t?.get(e?.globalIdField??h)?.name??h}},e.getUtilityNetworkFields=function(e,t){if("feature"!==t.type&&"subtype-group"!==t.type)return[];if(!t.url)return[];const r="utilityNetworks"in e.map?e.map.utilityNetworks??[]:[];for(const e of r)if(e.isUtilityLayer(t)){const e=t.fieldsIndex.get("assetgroup"),r=t.fieldsIndex.get("assettype");return[e?.name,r?.name].filter(e=>null!=e)}return[]},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/support/WhereClauseVisitor":function(){define(["exports","../../../core/sql"],function(e,t){"use strict";e.WhereClauseVisitor=class{constructor(e){this._fieldsIndex=e,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some(e=>e.currentUserRequired)}}visitClientWhereClause(e){e&&this._clauses.push(t.parseWhereClause(e,this._fieldsIndex))}visitFeatureReduction(e){if(e)switch(e.type){case"binning":case"cluster":this.visitLabelingInfo(e.labelsVisible,e.labelingInfo)}}visitLabelingInfo(e,t){if(e&&null!=t)for(const e of t)this.visitClientWhereClause(e.where)}visitDisplayFilter(e,t){if(e)for(const e of t?.filters??[])this.visitClientWhereClause(e.where)}visitFilter(e){this.visitClientWhereClause(e?.where)}visitTrackInfo(e){null!=e&&(this.visitLabelingInfo(e?.latestObservations.labelsVisible,e?.latestObservations.labelingInfo),this.visitLabelingInfo(e?.previousObservations.labelsVisible,e?.previousObservations.labelingInfo),this.visitLabelingInfo(e?.trackLines.labelsVisible,e?.trackLines.labelingInfo))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/RefreshableLayerView":function(){define(["exports","../../chunks/tslib.es6","../../core/Logger","../../core/promiseUtils","../../core/reactiveUtils","../../core/has","../../core/RandomLCG","../../core/Error","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a,l){"use strict";e.RefreshableLayerView=e=>{const n=e;let o=class extends n{initialize(){this.addHandles(s.on(()=>this.layer,"refresh",e=>{this.doRefresh(e.dataChanged).catch(e=>{i.isAbortError(e)||r.getLogger(this).error(e)})}),"RefreshableLayerView")}};return o=t.__decorate([l.subclass("esri.views.layers.RefreshableLayerView")],o),o},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/PointCloudLayerView3D":function(){define(["../../../chunks/tslib.es6","../../../Graphic","../../../core/arrayUtils","../../../core/asyncUtils","../../../core/has","../../../core/Logger","../../../core/maybe","../../../core/memoryEstimations","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/screenUtils","../../../core/typedArrayUtil","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/Extent","../../../geometry/Point","../../../geometry/projection/projectBoundingSphere","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/plane","../../../chunks/sphere","../../../graphic/PointCloudGraphicOrigin","../../../layers/graphics/OptimizedGeometry","../../../layers/graphics/data/QueryEngine","../../../layers/support/CodedValue","../../../layers/support/CodedValueDomain","../../../layers/support/Domain","../../../layers/support/InheritedDomain","../../../layers/support/RangeDomain","../../../layers/support/fieldUtils","../../../layers/support/PromiseQueue","../../../rest/support/FeatureSet","../../../rest/support/Query","../../../support/elevationInfoUtils","./LayerView3D","./PointCloudLayerViewPerformanceInfo","./PointCloudWorkerHandle","./i3s/I3SQueryFeatureStore","./i3s/I3SUtil","./i3s/LoDUtil","./i3s/PagedNodeIndex","./i3s/PointCloudGraphic","./i3s/PointCloudRenderer","./i3s/PointCloudRendererNode","./i3s/PointCloudRendererUtil","./i3s/PointCloudWorkerUtil","./support/highlightUtils","./support/PopupSceneLayerView","../support/extentUtils","../support/hitTest","../support/orientedBoundingBox","../support/updatingProperties","../../layers/LayerView","../../layers/PointCloudLayerView","../../support/highlightOptionsUtils","../../support/layerViewUtils","../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V,U,B,N,k,z,j,G,q,H,W,$,Q,Z,Y,X,J,K,ee,te,re,ie,se,ne){"use strict";const oe=x.create();let ae=class extends(re.PointCloudLayerView(Y.PopupSceneLayerView(U.LayerView3D(te)))){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new D.PromiseQueue,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[],this.ignoresMemoryFactor=!1}get baseUrl(){return this.layer.parsedUrl?.path??""}get pointScale(){const e=$.getSplatSizeAlgorithm(this.layer?.renderer);return null!=e?.scaleFactor?e.scaleFactor:1}get useRealWorldSymbolSizes(){const e=$.getFixedSizeAlgorithm(this.layer?.renderer);return null!=e?.useRealWorldSymbolSizes&&e.useRealWorldSymbolSizes}get pointSize(){const e=$.getFixedSizeAlgorithm(this.layer?.renderer);return null!=e?.size?e.size:0}get inverseDensity(){return this.layer?.renderer?96/this.layer.renderer.pointsPerInch:5}get availableFields(){const e=$.getRendererInfo(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.modulationAttribute.name);const r=$.getFilterInfo(this.layer);if(r)for(const e of r)e.attributeInfo&&t.add(e.attributeInfo.name);if(this.layer.outFields)for(const e of A.unpackFieldNames(this.layer.fieldsIndex,this.layer.outFields))t.add(e);return Array.from(t)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const e=w.create(),t=this.view.renderSpatialReference;return X.projectToBoundingBox(this.view.clippingArea,e,t)?e:null}get _elevationOffset(){const e=this.layer&&this.layer.elevationInfo;return e&&"absolute-height"===e.mode?V.getElevationOffset(e,this.layer.spatialReference):0}get _graphicOrigin(){return new T(this.layer)}initialize(){const e=this.view.resourceController,t=function(e){return t=>e.immediate.schedule(t)}(e);this._worker=new N.PointCloudWorkerHandle(t),this.addResolvingPromise(this._worker.promise),z.checkPointCloudLayerValid(this.layer),z.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(2),this._dataRequester=e.createStreamDataRequester(3),this._initRenderer();const r=this._initNodePages(),i=this.view.resourceController.memoryController;this._memCache=i.newCache(`pcl-${this.layer.uid}`),this._queryFeaturesCache=i.newCache(`pcl-query-features-${this.layer.uid};`),this._updatingHandles.add(()=>this._clippingBox,()=>this._setUpdateViewNeeded(),c.initial),this._updatingHandles.add(()=>this._elevationOffset,()=>this._elevationOffsetChanged(),c.initial),this._updatingHandles.add(()=>this.layer.renderer,()=>this._rendererChanged(),c.initial),this._updatingHandles.add(()=>this.layer.filters,()=>this._reload(),c.initial),this._updatingHandles.add(()=>this.layer.outFields,()=>this._reload(),c.initial),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this._setUpdateViewNeeded()),this._updatingHandles.add(()=>this.view.state.contentCamera,()=>this._setUpdateViewNeeded()),this.addHandles([c.watch(()=>this.view.quality,()=>this._setUpdateViewNeeded(),c.sync)]),this.addResolvingPromise(r),this.when(()=>{this.addHandles([e.scheduler.registerTask(ne.TaskPriority.POINT_CLOUD_LAYER,this),e.scheduler.registerIdleStateCallbacks(()=>this._idleBegin(),()=>this._idleEnd()),this._updatingHandles.add(()=>this.suspended,e=>{e?this._clearNodeState():this._setUpdateViewNeeded()},c.initial)])},()=>{this._updatingHandles.removeAll(),this.removeAllHandles()})}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker=o.destroyMaybe(this._worker),this._destroyRenderer(),this._memCache=o.destroyMaybe(this._memCache),this._queryFeaturesCache=o.destroyMaybe(this._queryFeaturesCache),this._queryEngine=o.destroyMaybe(this._queryEngine),this._codedDomainPopulationAbortController=o.abortMaybe(this._codedDomainPopulationAbortController),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new H.PointCloudRenderer({createGraphic:(e,t,r)=>this._createGraphic(e,t,r)}),this._renderer.layerViewUid=this.uid,this._updatingHandles.add(()=>this._clippingBox,e=>this._renderer.clippingBox=e,c.initial),this._updatingHandles.add(()=>this.suspended,e=>this._setPointsVisible(!e),c.initial),this._updatingHandles.add(()=>this.pointScale,e=>this._renderer.scaleFactor=e,c.initial),this._renderer.minSizePx=Math.sqrt(2),this._updatingHandles.add(()=>this.useRealWorldSymbolSizes,e=>this._renderer.useRealWorldSymbolSizes=e,c.initial),this._updatingHandles.add(()=>this.pointSize,e=>{const t=u.pt2px(e);this._renderer.size=e,this._renderer.sizePx=t},c.initial),this._updatingHandles.add(()=>this.slicePlaneEnabled,e=>this._renderer.slicePlaneEnabled=e,c.initial),this._updatingHandles.add(()=>this.inverseDensity,()=>this._setUpdateViewNeeded(),c.initial),this._updatingHandles.add(()=>this.maximumPointCount,()=>this._setUpdateViewNeeded(),c.initial),this._updatingHandles.add(()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor,e=>{this._lodFactor=e,this._setUpdateViewNeeded()},c.initial)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(e,t,r,i){const s=null!=e.pointIdFilterMap?e.pointIdFilterMap[t]:t,n=r?"declaredClass"in r?r:J.computeMapPointFromVec3d(this.view,r):null;return i??=this._createGraphicAttributes(e,s),new q.PointCloudGraphic({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:s,epoch:this._nodeLoadEpoch},geometry:n,attributes:i,layer:this.layer,sourceLayer:this.layer,origin:this._graphicOrigin})}_createGraphicAttributes(e,t){const r={};for(const i of e.attributes)this._encodeGraphicAttribute(i.attributeInfo,i.values,t,r);return r}_getGraphicAttribute(e,t,r){const i=e.storageInfo?.attributeValues,s=i?.valuesPerElement??1;if(1===s)return t[r];if("UInt8"===i?.valueType&&s<=4){let e=0;const i=r*s;for(let r=i;r<i+s;r++)e=(e<<8)+t[r];return e}}_encodeGraphicAttribute(e,t,r,i){i[e.name]=this._getGraphicAttribute(e,t,r)}_setPointsVisible(e){e&&!this._rendererAdded?(this.view.stage.addRenderPlugin(this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view.stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=$.rendererUsesFixedSizes(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_displayNodes(e){this._workQueue=j.nodeDiff([...this._renderedNodes],e,this._index),j.sortFrontToBack(this._workQueue,this.view.state.contentCamera.viewForward,this._index),j.splitWorkEntries(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const e=new Array;this._loadingNodes.forEach(({abortController:t})=>e.push(t)),this._loadingNodes.clear();for(const t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const e=new Set;this._workQueue.forEach(t=>t.load.forEach(t=>e.add(t)));const t=new Array,r=new Map;this._loadingNodes.forEach((i,s)=>{e.has(s)?r.set(s,i):t.push(i)}),this._loadingNodes=r;for(const{abortController:e}of t)e.abort();this._workQueue=this._workQueue.filter(e=>{for(const t of e.load)if(this._loadingNodes.has(t))return this._recalcWork=!0,!1;return!0}),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach(({abortController:e})=>e.abort()),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach(e=>this._removeFromRenderer(e)),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get readyToRun(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.readyToRun}runTask(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run(()=>this._updateWorkQueues());this._indexQueue.length>0&&e.run(()=>this._processIndexQueue()););this._processWorkQueue(e),this._idleQueue.runTask(e)}}_processIndexQueue(){const e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then(t=>{this._index.addPage(e,t,this._elevationOffset),this._setUpdateViewNeeded()}).then(()=>{this._indexPagesLoading.delete(e)},()=>{this._indexPagesLoading.delete(e)}),!0}_processWorkQueue(e){for(;!e.done;){const t=this._scheduleWorkEntry();if(null==t)return void e.madeProgress();this._processWorkEntry(t),e.madeProgress()}}_scheduleWorkEntry(){let e=this._workQueue.length;for(;e--;){const e=this._workQueue.shift();if(!e.remove.find(e=>!this._renderedNodes.has(e)))return e;this._workQueue.push(e)}return null}_processWorkEntry(e){if(0!==e.load.length)Promise.all(e.load.map(e=>{const t=new AbortController,r=this._memCache.pop(e.toString());return null!=r?this._loadingNodes.set(e,{abortController:t,promise:Promise.resolve(r)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:t,promise:this._loadNode(e,t.signal)}),this._loadingNodes.get(e).promise})).then(t=>{for(let r=0;r<e.load.length;r++)if(t[r]){const i=this._setupRendererData(e.load[r],t[r]);this._addToRenderer(i)}for(const t of e.remove)this._removeFromRenderer(t)}).catch(()=>{}).then(()=>{for(const t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&!this._idleQueue.updating&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())}),this._updateLoading();else for(const t of e.remove)this._removeFromRenderer(t)}async _populateClassCodeCodedDomain(e,t){const r="CLASS_CODE",s=this.layer.fieldsIndex.get(r);if(!s||s.domain)return;if(!e.includes(s.name))return;const n=await i.result(this.layer.queryCachedStatistics(r,{signal:t}));if(!1===n.ok)return;const o=n.value?.stats?.labels?.labels;o&&Array.isArray(o)&&(s.domain=new R({name:"CLASS_CODE",codedValues:o.map(e=>new M.CodedValue({code:e.value,name:e.label}))}))}async prepareFetchPopupFeatures(e){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this._populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then(()=>{this._codedDomainPopulationAbortController=null})),this._codedDomainPopulationPromise}async whenGraphicAttributes(e,t){const s=this._splitGraphicsPerNode(e),n=this.layer.attributeStorageInfo,o=t.map(e=>$.getAttributeInfo(n,e)).filter(r.isSome),a=async(e,t)=>{const r=this._index.getNode(t);await i.forEach(o,async t=>{const i=t.useElevation?await this._loadElevationAttributeFromGeometry(r.resourceId):await this._loadAndParseAttribute(r,t);if(i)for(const r of e)if(this._isValidPointGraphic(r)){const e=r.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(t,i,e,r.attributes)}})},l=[];return s.forEach((e,t)=>{l.push(a(e,t))}),await Promise.allSettled(l),e}_isValidPointGraphic(e){return e instanceof q.PointCloudGraphic&&e.pointCloudMetadata?.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(e){const t=new Map;for(const r of e){if(!this._isValidPointGraphic(r))continue;const e=r.pointCloudMetadata,i=t.get(e.nodeId);i?i.push(r):t.set(e.nodeId,[r])}return t}async _loadAndParseAttribute(e,t){const r=await this._loadAttribute(e.resourceId,t,null);return r?Q.getAttributeValues({attributeInfo:t,buffer:r},null,e.vertexCount):null}async _loadElevationAttributeFromGeometry(e){const t=this.layer.store.defaultGeometrySchema,r=Q.readGeometry(t,await this._loadGeometry(e,null));return Q.elevationFromPositions(r,r.length/3)}highlight(e,r){const i=Z.normalizeHighlightTarget(e);if(0===i.length)return Z.emptyHighlightHandle;if(!(i[0]instanceof t))return Z.emptyHighlightHandle;const s=i;return this._renderer.highlight(s.map(e=>this._graphicToPointDefinition(e)),ie.getHighlightName(r))}_graphicToPointDefinition(e){if(!this._isValidPointGraphic(e))return null;const{nodeId:t,pointIndexInNode:r}=e.pointCloudMetadata;return null!=t&&null!=r?{nodeId:t,pointId:r}:null}_computeWork(){let e=0;for(const t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}get visibleAtCurrentScale(){return se.isInEffectiveScaleRange(this.layer.effectiveScaleRange,this.view.scale)}async queryFeatures(e,r){const i=await this._ensureQueryEngine().executeQuery(this._ensureQueryJSON(e),r?.signal),s=i.features;i.features=[];const n=E.fromJSON(i),o=this.view.spatialReference;return n.features=s.map(e=>{const{attributes:r,metadata:i}=e;if(!i){const r=t.fromJSON(e);return r.geometry&&(r.geometry.spatialReference=n.spatialReference??o),r}const s=_.fromJSON(e.geometry);return s.spatialReference=n.spatialReference??o,this._createGraphic(i.node,i.pointId,s,r)}),n}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference,returnZ:!0};return new L(e)}async queryFeatureCount(e,t){return await this._ensureQueryEngine().executeQueryForCount(this._ensureQueryJSON(e),t?.signal)}async queryExtent(e,t){const{count:r,extent:i}=await this._ensureQueryEngine().executeQueryForExtent(this._ensureQueryJSON(e),t?.signal);return{count:r,extent:y.fromJSON(i)}}_ensureQueryJSON(e){return null==e?new L({outSpatialReference:this.view.spatialReference}).toJSON():L.from(e).toJSON()}_ensureQueryEngine(){if(this._queryEngine)return this._queryEngine;const{spatialReference:e}=this.view;return this._queryEngine=new P.QueryEngine({fieldsIndex:this.layer.fieldsIndex.toJSON(),geometryType:"esriGeometryPoint",spatialReference:e,featureIdInfo:{type:"object-id",fieldName:"objectId"},hasZ:!0,featureStore:new k.I3SQueryFeatureStore({sourceSpatialReference:e,viewSpatialReference:e,forAllFeatures:(e,t)=>{let r=!1;this._renderer.forEachNode(i=>{if(r)return;if(t){const e=i.obb,s=S.fromValues(e.center[0],e.center[1],e.center[2],f.length(e.halfSize));b.projectBoundingSphere(s,this.view.renderSpatialReference,s,this.view.spatialReference);const n=t(s);if(2===n)return;if(r=0===n,r)return}let s=this._queryFeaturesCache.get(`${i.id}`);s||(s=this._createQueryPointFeatures(i),this._queryFeaturesCache.put(`${i.id}`,s)),s.features.forEach(e)})},getFeatureExtent:({point:e},t)=>w.fromMinMax(e,e,t),featureAdapter:{cloneWithGeometry:(e,t)=>new ce(e.node,e.pointId,t.coords),getAttribute:({node:e,attributePointId:t},r)=>{for(const i of e.attributes)if(i.attributeInfo.name===r)return this._getGraphicAttribute(i.attributeInfo,i.values,t)},getAttributes:({node:e,attributePointId:t})=>this._createGraphicAttributes(e,t),getCentroid:e=>e.getGeometry(),getGeometry:e=>e.getGeometry(),getObjectId:()=>{},getMetadata:e=>e}})}),this._queryEngine}_createQueryPointFeatures(e){const t=e.coordinates,r=new Array;for(let i=0;i<t.length/3;i++){const s=3*i,n=g.fromValues(t[s+0],t[s+1],t[s+2]);f.add(n,n,e.origin),v.projectVectorToVector(n,this.view.renderSpatialReference,n,this.view.spatialReference);const o=new ce(e,i,n);r.push(o)}return new ue(r)}_initNodePages(){const e=this.layer.store.index,t=e.nodesPerPage||e.nodePerIndexBlock;return this._index=new G.PagedNodeIndex(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=e.nodesPerPage?1:e.nodePerIndexBlock,this._loadNodePage(0).promise.then(e=>{this._index.addPage(0,e,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()})}_loadNodePage(e){const t=new AbortController,r=`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`;return{promise:this._requestNodePage(r,t.signal).then(t=>t.nodes.map((t,r)=>({resourceId:null!=t.resourceId?t.resourceId:e*this._index.pageSize+r,obb:K.Obb.fromJSON(t.obb),obbInRenderSR:new K.Obb,firstChild:t.firstChild,childCount:t.childCount,vertexCount:t.vertexCount??t.pointCount,lodThreshold:t.lodThreshold??t.effectiveArea}))),abortController:t}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;const e=this.view.quality;let t=this.inverseDensity/this._lodFactor*e;const r=this.maximumPointCount*this._lodFactor*e;let i=this._computeNodesForMinimumDensity(t),s=this._computePointCount(i),n=Math.sqrt(s/(.75*r));for(;s>r;)t*=n,i=this._computeNodesForMinimumDensity(t),s=this._computePointCount(i),n=Math.sqrt(2);return this._displayNodes(i),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(e){let t=0;for(let r=0;r<e.length;r++){const i=this._index.getNode(e[r]);i&&(t+=i.vertexCount)}return t}_isRootNodeVisible(){let e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(t,r,i)=>(e=i,!1),pageMiss:()=>{}}),e}_computeNodesForMinimumDensity(e){const t=this.view.state.contentCamera,r=t.frustum,i=this._clippingBox,s=t.viewForward,n=f.dot(s,t.eye),o=x.fromNormalAndOffset(s,-n,oe),a=t.perScreenPixelRatio/2,l=e*e,c=this._nodeIdArray;c.length=0;const u=e=>c.push(e);return this._traverseVisible({frustum:r,clippingBox:i},{predicate:(e,t,r)=>{if(!r)return!1;if(0===t.childCount)return u(e),!1;const i=this._index.getRenderObb(e);return!(this._computeAveragePixelArea(i,t.lodThreshold,t.vertexCount,o,a)<=l&&(u(e),1))},pageMiss:(e,t)=>{u(e),this._indexQueue.includes(t)||this._indexQueue.push(t)}}),c}_computeAveragePixelArea(e,t,r,i,s){const n=Math.max(1e-7,e.minimumDistancePlane(i));return t/(n*n)/(4*s*s)/r}_loadNode(e,t){try{return this._loadNodeAsync(e,t)}catch(e){throw l.isAbortError(e)||n.getLogger(this).error(e),e}}async _loadAdditionalUserAttributes(e,t,i){const s=this.layer.outFields;if(!s)return[];const n=A.unpackFieldNames(this.layer.fieldsIndex,s),o=new Set(e.map(e=>null!=e?e.name:null)),a=this.layer.attributeStorageInfo,c=[];for(const e of n){if(o.has(e))continue;const r=$.getAttributeInfo(a,e);r&&c.push(t(r))}const u=await l.allSettledValues(c);return l.throwIfAborted(i),u.filter(r.isSome)}async _loadNodeAsync(e,t){const r=this._index.getNode(e),i=$.getRendererInfo(this.layer),s=$.getFilterInfo(this.layer),n=r.resourceId,o=async e=>{if(!e)return null;if(e.useElevation)return{attributeInfo:e,buffer:null};const r=await this._loadAttribute(n,e,t);return null!=r?{attributeInfo:e,buffer:r}:null};return this._idleQueue.push(async()=>{const r=this._loadGeometry(n,t),{primaryAttribute:a,modulationAttribute:c}=i,u=o(a),d=o(c),h=s.map(e=>e.attributeInfo),p=h.map(e=>o(e)),f=this._loadAdditionalUserAttributes([a,c,...h],o,t),[m,g,y,_,b]=await Promise.all([r,u,d,Promise.all(p),f]);l.throwIfAborted(t);const v={geometryBuffer:m,primaryAttributeData:g,modulationAttributeData:y,filterAttributesData:_,userAttributesData:b,schema:this.layer.store.defaultGeometrySchema,rendererInfo:i,filterInfo:s,obbData:this._index.getRenderObb(e).data,elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(v,t)},t)}async _loadGeometry(e,t){return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`,t)}async _loadAttribute(e,t,r){if(!t?.storageInfo)return null;const i=t.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${i}`,r)}_requestNodePage(e,t){const r={f:"json",...this.layer.customParameters,token:this.layer.apiKey};return this._indexRequester.request(e,0,{query:r,signal:t})}_requestData(e,t){return this._dataRequester.request(e,1,{query:{...this.layer.customParameters,token:this.layer.apiKey},signal:t})}_removeFromRenderer(e){if(this._renderedNodes.has(e)){const t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._memCache.put(t.id.toString(),t)}}_addToRenderer(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))}_setupRendererData(e,t){const r=this._index.getNode(e),i=Math.sqrt(r.lodThreshold/r.vertexCount),s=this._index.getRenderObb(e);if(W.isPointRendererNode(t))return t.splatSize=i,t.obb=s,f.copy(t.origin,t.obb.center),t;const o=K.Obb.fromData(t.obbData),a=o.halfSize,l=s.halfSize,c=.01*Math.max(l[0],l[1],l[2]);if(a[0]>l[0]+c||a[1]>l[1]+c||a[2]>l[2]+c){if(this._maxLoggedBoxWarnings>0){const t=e=>`[${e.halfSize[0]}, ${e.halfSize[1]}, ${e.halfSize[2]}]`;n.getLogger(this).warn(`Node ${e} reported bounding box too small. got ${t(s)} but points cover ${t(o)}`),0===--this._maxLoggedBoxWarnings&&n.getLogger(this).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,o)}return new W.PointCloudRendererNode(e,i,m.clone(s.center),s,0===r.childCount,t.points,t.rgb,t.attributes,t.pointIdFilterMap)}get usedMemory(){let e=0;return this._renderer.forEachNode(t=>{e+=de,e+=a.estimateNumberArrayMemory(t.coordinates);for(const r of t.attributes){const t=r.values;d.isArrayBuffer(t.buffer)&&(e+=a.estimateNumberArrayMemory(t))}}),e}get unloadedMemory(){const e=this._renderedNodes.size;if(e<4)return 0;const t=[...this._renderedNodes].reduce((e,t)=>e+this._index.getNode(t).vertexCount);let r=this._loadingNodes.size;for(let e=0;e<this._workQueue.length;e++)r+=this._workQueue[e].load.length,r-=this._workQueue[e].remove.length;return r<0?0:r*t/e*((this.usedMemory-e*de)/t)+r*de}get performanceInfo(){return new B.PointCloudLayerViewPerformanceInfo(this.usedMemory,this._renderedNodes.size,[...this._renderedNodes].reduce((e,t)=>e+this._index.getNode(t).vertexCount,0),this.maximumPointCount,new B.QueuePerformanceInfo(this._loadingNodes.size,this._indexQueue.length,this._workQueue.length,this._idleQueue.length))}get test(){}};e.__decorate([h.property()],ae.prototype,"layer",void 0),e.__decorate([h.property()],ae.prototype,"baseUrl",null),e.__decorate([h.property()],ae.prototype,"pointScale",null),e.__decorate([h.property()],ae.prototype,"useRealWorldSymbolSizes",null),e.__decorate([h.property()],ae.prototype,"pointSize",null),e.__decorate([h.property()],ae.prototype,"inverseDensity",null),e.__decorate([h.property()],ae.prototype,"maximumPointCount",void 0),e.__decorate([h.property({readOnly:!0})],ae.prototype,"availableFields",null),e.__decorate([h.property({readOnly:!0})],ae.prototype,"_clippingBox",null),e.__decorate([h.property({readOnly:!0})],ae.prototype,"_elevationOffset",null),e.__decorate([h.property({type:Boolean})],ae.prototype,"slicePlaneEnabled",void 0),e.__decorate([h.property()],ae.prototype,"_graphicOrigin",null),e.__decorate([h.property()],ae.prototype,"updating",void 0),e.__decorate([h.property(ee.updatingProgress)],ae.prototype,"updatingProgress",void 0),e.__decorate([h.property({readOnly:!0})],ae.prototype,"updatingProgressValue",null),e.__decorate([h.property({readOnly:!0})],ae.prototype,"visibleAtCurrentScale",null),ae=e.__decorate([p.subclass("esri.views.3d.layers.PointCloudLayerView3D")],ae);const le=ae;class ce{constructor(e,t,r){this.node=e,this.pointId=t,this.point=r}getGeometry(){return new C([1],Array.from(this.point))}get attributePointId(){const{node:e,pointId:t}=this;return null!=e.pointIdFilterMap?e.pointIdFilterMap[t]:t}get usedMemory(){return a.baseObjectMemory+a.baseObjectMemory+a.estimateNumberMemory+a.estimateFixedArrayMemory(this.point,a.estimateNumberMemory)}}class ue{constructor(e){this.features=e}get cachedMemory(){return this.features.reduce((e,t)=>e+t.usedMemory,a.baseObjectMemory+a.baseArrayMemory)}}const de=160;return le})},"esri/geometry/projection/projectBoundingSphere":function(){define(["exports","../../core/mathUtils","../../core/libs/gl-matrix-2/factories/vec3f64","./projectors","../support/Ellipsoid"],function(e,t,r,i,s){"use strict";function n(e,t,r,i){const s=i+t;if(s<i/2||r>s)return Number.MAX_VALUE;const n=Math.abs(a*e)+Math.asin(r/s);return n>=Math.PI/2?Number.MAX_VALUE:r/Math.cos(n)}const o=r.create(),a=t.deg2rad(1);e.projectBoundingSphere=function(e,t,r,a){if(null==t||null==a)return!1;const l=i.getProjectorClassification(t,a);if(null==l?.projector)return!1;if(l.projector===i.copy3)return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],!0;const{source:c,dest:u,projector:d}=l;if(3===u.spatialReferenceId){const t=i.projectionTable[c.spatialReferenceId][2];return null!=t&&(t(e,0,o,0),i.wgs84ToWebMercator(o,0,r,0),r[3]=n(o[1],e[2],e[3],s.earth.radius),!0)}if(2!==c.spatialReferenceId&&5!==c.spatialReferenceId||11!==u.spatialReferenceId){d(e,0,r,0);const t=c.metersPerUnit??1,i=u.metersPerUnit??1;r[3]=e[3]*t/i}else{const t=i.projectionTable[c.spatialReferenceId][1],o=i.projectionTable[1][11];let a=e[3];null!=t&&null!=o&&(a=n(e[1],e[2],e[3],s.earth.radius)),d(e,0,r,0),r[3]=a}return!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/graphic/PointCloudGraphicOrigin":function(){define(["./GraphicOrigin","./isPointCloudGraphicOrigin"],function(e,t){"use strict";var r;class i extends e{static{r=t.isPointCloudGraphicOriginSymbol}constructor(e){super(),this[r]=!0,this.type="point-cloud",this.layer=e}}return i})},"esri/graphic/isPointCloudGraphicOrigin":function(){define(["exports"],function(e){"use strict";const t=Symbol("isPointCloudGraphicOrigin");e.isPointCloudGraphicOrigin=function(e){return!!e&&t in e},e.isPointCloudGraphicOriginSymbol=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/PointCloudLayerViewPerformanceInfo":function(){define(["exports","./support/LayerViewPerformanceInfo"],function(e,t){"use strict";class r extends t.LayerViewPerformanceInfo{constructor(e,t,r,i,s){super(e,t,-1,r,i),this.queue=s}}e.PointCloudLayerViewPerformanceInfo=r,e.QueuePerformanceInfo=class{constructor(e,t,r,i){this.loading=e,this.indexLoading=t,this.processing=r,this.idleProcessing=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/PointCloudWorkerHandle":function(){define(["exports","../../../core/workers/WorkerHandle"],function(e,t){"use strict";class r extends t.WorkerHandle{constructor(e){super("PointCloudWorker","transform",{transform:e=>function(e){const t=[e.geometryBuffer];if(null!=e.primaryAttributeData&&e.primaryAttributeData.buffer&&t.push(e.primaryAttributeData.buffer),null!=e.modulationAttributeData&&e.modulationAttributeData.buffer&&t.push(e.modulationAttributeData.buffer),null!=e.filterAttributesData)for(const r of e.filterAttributesData)null!=r&&r.buffer&&t.push(r.buffer);for(const r of e.userAttributesData)r.buffer&&t.push(r.buffer);return t}(e)},e)}}e.PointCloudWorkerHandle=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SQueryFeatureStore":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/compilerUtils","../../../../core/Evented","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../chunks/sphere"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";const p=u.create();e.I3SQueryFeatureStore=class extends r{constructor(e){super(e),this.events=new s.EventEmitter}forEach(e){this.forAllFeatures(t=>(e(t),1))}forEachBounds(e,t){for(const r of e)t(this.getFeatureExtent(r,p))}forEachInBounds(e,t){this.forAllFeatures(r=>{const s=this.getFeatureExtent(i.toConst(r),m);return d.intersects(e,u.toRect(s,g))&&t(i.toConst(r)),1},t=>{if(c.projectBoundingSphere(t,this.sourceSpatialReference,f,this.viewSpatialReference),f[0]>=e[0]&&f[2]<=e[2]&&f[1]>=e[1]&&f[3]<=e[3])return 1;const r=Math.max(e[0],Math.min(f[0],e[2])),i=Math.max(e[1],Math.min(f[1],e[3])),s=f[0]-r,n=f[1]-i;return s*s+n*n<=f[3]*f[3]?1:2})}},t.__decorate([n.property({constructOnly:!0})],e.I3SQueryFeatureStore.prototype,"featureAdapter",void 0),t.__decorate([n.property({constructOnly:!0})],e.I3SQueryFeatureStore.prototype,"forAllFeatures",void 0),t.__decorate([n.property({constructOnly:!0})],e.I3SQueryFeatureStore.prototype,"getFeatureExtent",void 0),t.__decorate([n.property({constructOnly:!0})],e.I3SQueryFeatureStore.prototype,"sourceSpatialReference",void 0),t.__decorate([n.property({constructOnly:!0})],e.I3SQueryFeatureStore.prototype,"viewSpatialReference",void 0),e.I3SQueryFeatureStore=t.__decorate([l.subclass("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],e.I3SQueryFeatureStore);const f=h.fromValues(0,0,0,0),m=u.create(),g=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/LoDUtil":function(){define(["exports","../../../../chunks/vec32"],function(e,t){"use strict";const r=[!1],i=[null],s=[!1],n=[null];function o(e,t,r){let i=e;for(;i>0;){const e=t.indexOf(i);if(e>=0)return e;i=r.getParentId(i)}return t.indexOf(i)}function a(e,t,r){const i=[t.remove[0]],s=[];for(;1===i.length;){const e=i.pop();s.length=0;for(let n=0;n<t.load.length;n++){let o=t.load[n],a=r.getParentId(o);for(;a!==e;)o=a,a=r.getParentId(o);let l=i.indexOf(o);l<0&&(l=i.length,i.push(o),s.push([])),s[l].push(t.load[n])}}t.load=i;for(let t=0;t<i.length;t++)s[t].length>1?e.push({remove:[i[t]],load:s[t]}):i[t]=s[t][0]}e.nodeDiff=function(e,t,a){for(let e=0;e<t.length;e++)s[e]=!1,n[e]=null;for(let t=0;t<e.length;t++)r[t]=!1,i[t]=null;for(let r=0;r<t.length;r++){const n=o(t[r],e,a);n>=0&&(s[r]=!0,null!=i[n]?i[n].push(t[r]):i[n]=[t[r]])}for(let i=0;i<e.length;i++){const s=o(e[i],t,a);s>=0&&(r[i]=!0,null!=n[s]?n[s].push(e[i]):n[s]=[e[i]])}const l=[];for(let t=0;t<e.length;t++)null!=i[t]||r[t]||l.push({load:[],remove:[e[t]]});for(let e=0;e<t.length;e++)null!=n[e]||s[e]||l.push({load:[t[e]],remove:[]});for(let e=0;e<t.length;e++)null!=n[e]&&(n[e].length>1||n[e][0]!==t[e])&&l.push({load:[t[e]],remove:n[e]});for(let t=0;t<e.length;t++)null!=i[t]&&(i[t].length>1||i[t][0]!==e[t])&&l.push({load:i[t],remove:[e[t]]});return l},e.sortFrontToBack=function(e,r,i){return e.sort((e,s)=>{if(0===e.load.length&&0===s.load.length)return 0;if(0===e.load.length)return-1;if(0===s.load.length)return 1;if(0===e.remove.length&&0===s.remove.length){const n=i.getRenderObb(e.load[0]).center,o=i.getRenderObb(s.load[0]).center;return t.dot(n,r)-t.dot(o,r)}if(0===e.remove.length)return-1;if(0===s.remove.length)return 1;if(1===e.load.length&&1===s.load.length){const n=i.getRenderObb(e.load[0]).center,o=i.getRenderObb(s.load[0]).center;return t.dot(n,r)-t.dot(o,r)}if(1===e.load.length)return-1;if(1===s.load.length)return 1;{const n=i.getRenderObb(e.remove[0]).center,o=i.getRenderObb(s.remove[0]).center;return t.dot(n,r)-t.dot(o,r)}})},e.splitWorkEntries=function(e,t,r){for(let i=0;i<e.length;++i){const s=e[i];s.load.length>t&&1===s.remove.length&&a(e,s,r)}},e.splitWorkEntry=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/PagedNodeIndex":function(){define(["exports","../../../../geometry/spatialReferenceEllipsoidUtils","../../../../geometry/support/aaBoundingBox"],function(e,t,r){"use strict";function i(e,t){return e/t|0}function s(e,t){return e%t}e.PagedNodeIndex=class{constructor(e,r,i){this._pages=[],this.pageSize=0,this._nodeSR=e,this._renderSR=r,this._renderSRSphericalPCPF=t.getSphericalPCPF(r),this.pageSize=i}addPage(e,t,r=0){for(;this._pages.length<e;)this._pages.push(null);!function(e,t,r,i,s){for(let n=0;n<e.length;n++){const o=e[n];o.obb.transform(o.obbInRenderSR,t,r,i,s)}}(t,this._nodeSR,this._renderSR,r,this._renderSRSphericalPCPF),this._pages[e]={nodes:t,parents:new Uint32Array(this.pageSize)},function(e,t){const r=[0];for(;r.length;){const n=r.pop(),o=e[i(n,t)].nodes[s(n,t)];for(let a=0;a<o.childCount;a++){const l=o.firstChild+a;null!=e[i(l,t)]&&(e[i(l,t)].parents[s(l,t)]=n,r.push(l))}}}(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const t=this.pageSize;return this._pages[i(e,t)].nodes[s(e,t)]}getRenderObb(e){const t=this.pageSize;return this._pages[i(e,t)].nodes[s(e,t)].obbInRenderSR}setRenderObb(e,t){const r=this.pageSize;this._pages[i(e,r)].nodes[s(e,r)].obbInRenderSR.copy(t)}getParentId(e){const t=this.pageSize;return this._pages[i(e,t)].parents[s(e,t)]}hasNodes(e,t){const r=i(e,this.pageSize),s=i(e+t-1,this.pageSize);for(let e=r;e<=s;e++)if(null==this._pages[e])return!1;return!0}forEachNodeId(e){for(let t=0;t<this._pages.length;t++){const r=this._pages[t];if(r)for(let i=0;i<r.nodes.length;i++)e(t*this.pageSize+i)}}createVisibilityTraverse(){const e={index:this,queue:[],masks:[],tempAabb:r.create()};return(t,s)=>function(e,t,s){const n=e.index;if(!n.hasNodes(0,1))return;const o=e.queue;o.length=0,o.push(0);const a=e.masks;for(a.length=0,a.push(0);o.length>0;){const l=o.pop();let c=a.pop();const u=n.getNode(l),d=n.getRenderObb(l);let h=!0;if(null!=t.clippingBox){const i=1<<t.frustum.length;0===(c&i)&&(d.toAaBoundingBox(e.tempAabb),r.contains(t.clippingBox,e.tempAabb)?c|=i:r.intersects(t.clippingBox,e.tempAabb)||(h=!1))}for(let e=0;e<t.frustum.length&&h;e++){const r=1<<e;if(0===(c&r)){const i=d.intersectPlane(t.frustum[e]);i>0?h=!1:i<0&&(c|=r)}}if(s.predicate(l,u,h)){const e=u.firstChild,t=u.childCount;let r=!1;const d=i(e,n.pageSize),h=i(e+t-1,n.pageSize);for(let e=d;e<=h;e++)if(!n.hasPage(e)){s.pageMiss(l,e),r=!0;break}if(!r)for(let r=0;r<t;r++)o.push(e+r),a.push(c)}}}(e,t,s)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/PointCloudGraphic":function(){define(["exports","../../../../chunks/tslib.es6","../../../../Graphic","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";e.PointCloudGraphic=class extends r{constructor(e){super(e),this.pointCloudMetadata=null}},t.__decorate([i.property({constructOnly:!0,clonable:"reference"})],e.PointCloudGraphic.prototype,"pointCloudMetadata",void 0),e.PointCloudGraphic=t.__decorate([a.subclass("esri.views.3d.layers.i3s.PointCloudGraphic")],e.PointCloudGraphic),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/PointCloudRenderer":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/PooledArray","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/plane","../../../../geometry/support/ray","./Intersector","./PointCloudHighlights","../../webgl-engine/core/shaderLibrary/ShaderOutput","../../webgl-engine/effects/RenderPlugin","../../webgl-engine/lib/IntersectorResult","../../webgl-engine/lib/VertexArrayObject","../../../../chunks/PointRenderer.glsl","../../webgl-engine/shaders/PointRendererTechnique","../../webgl-engine/shaders/PointRendererTechniqueConfiguration","../../../webgl/enums","../../../webgl/VertexBuffer"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C){"use strict";function P(e,t,r,i,s){if(r.drawScreenSpace)return r.fixedSize*t*i;const n=w.getMaxPointSizeScreenspace(s)*t*i;return r.useFixedSizes?Math.min(r.fixedSize/2,n):r.screenMinSize>0?Math.min(Math.max(r.screenMinSize*t*i,e/2),n):Math.min(e/2,n)}function M(e,t,r,i,s){return r.drawScreenSpace?0:P(e,t,r,i,s)}function R(e,t,r){return null==r&&(r=u.create()),r[0]=e.origin[0]+e.coordinates[3*t],r[1]=e.origin[1]+e.coordinates[3*t+1],r[2]=e.origin[2]+e.coordinates[3*t+2],r}e.PointCloudRenderer=class extends _.SyncRenderPlugin{constructor(e){super(e),this.type=5,this.isGround=!1,this._passParameters=new w.PointRendererPassParameters,this._highlights=new g.PointCloudHighlights({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,r)=>this._addHighlight(e,t,r),removeHighlight:(e,t)=>this._removeHighlight(e,t)}),this.produces=new Map([[2,e=>!(y.isDepth(e)||8===e&&this._highlights.empty)],[3,e=>y.isDepth(e)]]),this.layerViewUid="",this._slicePlaneEnabled=!1,this._configuration=new S.PointRendererTechniqueConfiguration,this._nodes=new i}destroy(){this._nodes.prune()}hasHighlight(e){return this._highlights.has(e)}initializeRenderContext(e){this._context=e,e.requestRender()}uninitializeRenderContext(){}intersect(e,t,r,i){const s=u.create(),n=u.create(),o=u.create(),a=u.create(),l=p.create(),g=e.camera.perScreenPixelRatio/2,y=e.camera.near;c.subtract(n,i,r);const _=1/c.length(n);c.scale(n,n,_),c.negate(o,n),d.set(l,n[0],n[1],n[2],-c.dot(n,r));const v=new O,w=new O,x=new Array,S=h.create(),T=h.create(this._passParameters.clipBox);h.offset(T,-r[0],-r[1],-r[2],T),this._nodes.forAll(u=>{const d=u.splatSize*this._passParameters.scaleFactor;let p=u.obb.minimumDistancePlane(l),f=u.obb.maximumDistancePlane(l);p-=M(d,p+y,this._passParameters,g,u.isLeaf),f-=M(d,f+y,this._passParameters,g,u.isLeaf);const m=f<0,b=null!=v.dist&&null!=w.dist&&v.dist<p*_&&w.dist>f*_;if(m||b)return;const C=P(d,f+y,this._passParameters,g,u.isLeaf);if(!u.obb.intersectRay(r,n,C))return;const I=C*C;u.obb.toAaBoundingBox(S),h.offset(S,-r[0],-r[1],-r[2],S);const F=!h.contains(T,S);c.subtract(a,u.origin,r);const A=u.coordinates.length/3;for(let l=0;l<A;l++){if(s[0]=a[0]+u.coordinates[3*l],s[1]=a[1]+u.coordinates[3*l+1],s[2]=a[2]+u.coordinates[3*l+2],F&&!h.containsPoint(T,s))continue;const p=c.dot(s,n),f=c.squaredLength(s)-p*p;if(f>I)continue;let m=p+y;const b=M(d,m,this._passParameters,g,u.isLeaf);if(p-b<0)continue;m-=b;const S=P(d,m,this._passParameters,g,u.isLeaf);if(f>S*S)continue;const C=(p-b)*_,A=e=>(e.point=R(u,l,e.point),e.dist=C,e.normal=o,e.node=u,e.pointId=l,e.layerViewUid=this.layerViewUid,e);if((null==v.dist||C<v.dist)&&(null==t||t(r,i,C))&&A(v),0!==e.options.store&&(null==w.dist||C>w.dist)&&(null==t||t(r,i,C))&&A(w),2===e.options.store&&(null==t||t(r,i,C))){const e=new O;x.push(A(e))}}});const C=e=>{const{layerViewUid:t,node:r,pointId:i}=e;return new m.PclTarget(e.point,t,i,()=>this.createGraphic(r,i,e.point))},F=(e,t)=>{const r=C(t);e.set(this.type,r,t.dist,t.normal)};if(I(v)){const t=e.results.min;(null==t.distance||v.dist<t.distance)&&F(t,v)}if(I(w)&&0!==e.options.store){const t=e.results.max;(null==t.distance||w.dist>t.distance)&&F(t,w)}if(2===e.options.store){const t=f.fromPoints(r,i);for(const r of x){const i=new b.IntersectorResult(t);F(i,r),e.results.all.push(i)}}}acquireTechniques(e){const t=8===e.output;return 0!==this._nodes.length&&(y.isColorOrColorEmission(e.output)||y.isDepth(e.output)&&3===e.bind.slot||t)?(this._nodes.forAll(t=>this._initNode(e,t)),this._configuration.drawScreenSize=this._passParameters.drawScreenSpace,this._configuration.useFixedSizes=this._passParameters.useFixedSizes,this._configuration.hasSlicePlane=this._slicePlaneEnabled,this._configuration.hasOccludees=e.bind.hasOccludees,this._configuration.clippingEnabled=this._clippingEnabled,this._configuration.hasHighlightMixTexture=t&&null!=e.bind.highlightMixTexture,this._configuration.output=e.output,this._context.techniques.get(x.PointRendererTechnique,this._configuration)):null}render(e,t){const{rctx:r,bind:i,output:s}=e,n=r.bindTechnique(t,i,this._passParameters),o=8===s,a=i.highlight?.name??null;o&&!a||this._nodes.forAll(t=>{0===t.coordinates.length||null==t.vao||o&&!t.highlightMap.has(a)||(n.assertCompatibleVertexAttributeLocations(t.vao),n.bindDraw(i,this._passParameters,t),r.bindVAO(t.vao),o?this._renderHighlightFragments(e,t):r.drawArrays(T.PrimitiveType.POINTS,0,t.coordinates.length/3))})}_renderHighlightFragments(e,t){const{highlightMap:r}=t,{rctx:i,bind:s}=e,{highlight:n}=s;if(!n)return;const o=n.name,a=r.get(o);if(!a||0===a.length)return;const{highlightOrderMap:l,highlightLevel:c}=s;if(null==c)return;for(const e of r.keys())if(e!==o){const t=l.get(e);if(void 0!==t&&t>c)return}let u=0,d=a[0].componentIndex,h=d+1;const p=()=>{for(;u<a.length&&a[u].id.highlightName!==o;)d=a[u].componentIndex,++u;h=d+1};p();const f=(e,t)=>{const r=t-e;r>0&&i.drawArrays(T.PrimitiveType.POINTS,e,r)};for(;u<a.length;){const e=a[u];if(e.id.highlightName!==o){f(d,h),++u,p();continue}const t=e.componentIndex;t!==h&&(f(d,h),d=t),h=t+1,++u}f(d,h)}set useFixedSizes(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}get size(){return this._passParameters.size}set sizePx(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(e){h.set(this._passParameters.clipBox,e||h.positiveInfinity)}get _clippingEnabled(){return!h.equals(this._passParameters.clipBox,h.positiveInfinity,(e,t)=>e===t)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let t=null;return this._nodes.filterInPlace(i=>i.id!==e||(t=i,i.vao=r.disposeMaybe(i.vao),this._highlights.nodeRemoved(i),!1)),this._requestRender(),t}forEachNode(e){this._nodes.forAll(e)}removeAll(){this._nodes.forAll(e=>e.vao=r.disposeMaybe(e.vao)),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(e,t){return this._highlights.add(e,t)}_addHighlight(e,t,r){e.addHighlight(t,r),this._requestRender()}_removeHighlight(e,t){e.removeHighlight(t),this._requestRender()}_initNode(e,t){t.vao??=new v.VertexArrayObject(e.rctx,new Map([["positions",new C.VertexBuffer(e.rctx,x.positionsLayout,t.coordinates)],["colors",new C.VertexBuffer(e.rctx,x.colorsLayout,t.rgb)]]))}_requestRender(){this._context&&this._context.requestRender()}},t.__decorate([s.property({constructOnly:!0})],e.PointCloudRenderer.prototype,"createGraphic",void 0),e.PointCloudRenderer=t.__decorate([l.subclass("esri.views.3d.layers.i3s.PointCloudRenderer")],e.PointCloudRenderer);class O{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerViewUid=""}}function I(e){return null!=e.dist&&null!=e.point&&null!=e.pointId&&null!=e.node}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/PointCloudHighlights":function(){define(["exports","../../../../core/handleUtils","../../webgl-engine/lib/Object3DStateID"],function(e,t,r){"use strict";class i{constructor(e,t){this.ids=new Map,this.enabled=!1;for(const t of e)null!=t&&this._add(t.nodeId,t.pointId);this.id=new r.Object3DHighlightStateID(t)}_add(e,t){const r=this.ids.get(e);r?r.add(t):this.ids.set(e,new Set([t]))}}e.PointCloudHighlights=class{constructor(e){this._context=e,this._highlights=new Map}get empty(){return 0===this._highlights.size}destroy(){this._highlights=null}add(e,r){const s=new i(e,r),n=this._highlights.get(r);return n?n.add(s):this._highlights.set(r,new Set([s])),this._enableSet(s),t.makeHandle(()=>this._removeSet(s))}_removeSet(e){this._disableSet(e);const{highlightName:t}=e.id,r=this._highlights.get(t);r&&(r.delete(e),0===r.size&&this._highlights.delete(t))}_enableSet(e){e.enabled||(e.enabled=!0,this._context.forEachNode(t=>this._enableSetForNode(e,t)))}_enableSetForNode(e,t){if(!e.enabled)return;const r=e.ids.get(t.id);r&&r.forEach(r=>this._context.addHighlight(t,r,e.id))}_disableSet(e){e.enabled&&(e.enabled=!1,this._context.forEachNode(t=>this._disableSetForNode(e,t)))}_disableSetForNode(e,t){e.enabled||this._context.removeHighlight(t,e.id)}nodeAdded(e){this._forEachSet(t=>this._enableSetForNode(t,e))}nodeRemoved(e){this._forEachSet(t=>this._disableSetForNode(t,e))}removeAll(){this._forEachSet(e=>this._disableSet(e))}_forEachSet(e){this._highlights.forEach(t=>t.forEach(e))}has(e){return this._highlights.has(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/chunks/PointRenderer.glsl":function(){define(["exports","../core/mathUtils","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","../core/libs/gl-matrix-2/math/vec2","../core/libs/gl-matrix-2/factories/vec2f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../geometry/support/aaBoundingBox","../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl","../views/3d/webgl-engine/core/shaderModules/Float2DrawUniform","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/Float3DrawUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4BindUniform","../views/3d/webgl-engine/core/shaderModules/Matrix4DrawUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v){"use strict";class w extends b.NoParameters{constructor(){super(...arguments),this.clipBox=l.create(l.positiveInfinity),this.useFixedSizes=!1,this.useRealWorldSymbolSizes=!1,this.scaleFactor=1,this.minSizePx=0,this.size=0,this.sizePx=0}get fixedSize(){return this.drawScreenSpace?this.sizePx:this.size}get screenMinSize(){return this.useFixedSizes?0:this.minSizePx}get drawScreenSpace(){return this.useFixedSizes&&!this.useRealWorldSymbolSizes}}class x extends u.SlicePlaneParameters{constructor(e,t,r){super(e),this.origin=e,this.isLeaf=t,this.splatSize=r}}function S(e){const i=new v.ShaderBuilder,n=c.isColorOrColorEmission(e.output),{vertex:a,fragment:l}=i;return i.vertex.include(u.RejectBySlice,e),i.attributes.add("position","vec3"),i.attributes.add("color","vec3"),a.uniforms.add(new _.Matrix4DrawUniform("modelView",(e,t)=>r.multiply(C,t.camera.viewMatrix,r.fromTranslation(C,e.origin))),new y.Matrix4BindUniform("proj",e=>e.camera.projectionMatrix),new p.Float2DrawUniform("screenMinMaxSize",(e,t,r)=>s.set(M,r.useFixedSizes?0:r.minSizePx*t.camera.pixelRatio,T(e.isLeaf)*t.camera.pixelRatio)),e.useFixedSizes?new f.Float2PassUniform("pointScale",(e,t)=>s.set(M,e.fixedSize*t.camera.pixelRatio,t.camera.fullHeight)):new p.Float2DrawUniform("pointScale",(e,t,r)=>s.set(M,e.splatSize*r.scaleFactor*t.camera.pixelRatio,t.camera.fullHeight/t.camera.pixelRatio))),e.clippingEnabled?a.uniforms.add(new m.Float3DrawUniform("clipMin",(e,t,r)=>o.set(P,r.clipBox[0]-e.origin[0],r.clipBox[1]-e.origin[1],r.clipBox[2]-e.origin[2])),new m.Float3DrawUniform("clipMax",(e,t,r)=>o.set(P,r.clipBox[3]-e.origin[0],r.clipBox[4]-e.origin[1],r.clipBox[5]-e.origin[2]))):(a.constants.add("clipMin","vec3",[-t.numberMaxFloat32,-t.numberMaxFloat32,-t.numberMaxFloat32]),a.constants.add("clipMax","vec3",[t.numberMaxFloat32,t.numberMaxFloat32,t.numberMaxFloat32])),n&&i.varyings.add("vColor","vec3"),a.main.add(g.glsl`
    // Move clipped points outside of clipspace
    if (position.x < clipMin.x || position.y < clipMin.y || position.z < clipMin.z ||
      position.x > clipMax.x || position.y > clipMax.y || position.z > clipMax.z) {
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      gl_PointSize = 0.0;
      return;
    }

    if (rejectBySlice(position)) {
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      gl_PointSize = 0.0;
      return;
    }

    // Position in camera space
    vec4 camera = modelView * vec4(position, 1.0);

    float pointSize = pointScale.x;
    vec4 position = proj * camera;
    ${e.drawScreenSize?g.glsl`float clampedScreenSize = pointSize;`:g.glsl`float pointRadius = 0.5 * pointSize;
           vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);
           vec4 positionOffset = proj * cameraOffset;
           float radius = abs(positionOffset.y - position.y);
           float viewHeight = pointScale.y;
           // screen diameter = (2 * r / w) * (h / 2)
           float screenPointSize = (radius / position.w) * viewHeight;
           float clampedScreenSize = clamp(screenPointSize, screenMinMaxSize.x, screenMinMaxSize.y);
           // Shift towards camera, to move rendered point out of terrain i.e. to
           // the camera-facing end of the virtual point when considering it as a
           // 3D sphere.
           camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;
           position = proj * camera;`}

    gl_PointSize = clampedScreenSize;
    gl_Position = position;
    ${n?g.glsl`vColor = color;`:""}`),l.include(h.RgbaFloatEncoding,e),i.include(d.OutputHighlight,e),l.main.add(g.glsl`
    vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);
    float r2 = dot(vOffset, vOffset);

    if (r2 > 0.25) {
      discard;
    }
    calculateOcclusionAndOutputHighlight();
    ${n?g.glsl`fragColor = vec4(vColor, 1.0);`:""}`),i}function T(e){return e?256:64}const C=i.create(),P=a.create(),M=n.create(),R=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:x,PointRendererPassParameters:w,build:S,getMaxPointSizeScreenspace:T},Symbol.toStringTag,{value:"Module"}));e.PointRenderer=R,e.PointRendererDrawParameters=x,e.PointRendererPassParameters=w,e.build=S,e.getMaxPointSizeScreenspace=T})},"esri/views/3d/webgl-engine/shaders/PointRendererTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/StencilUtils","../../../../chunks/PointRenderer.glsl","../../../webgl/enums","../../../webgl/renderState","../../../webgl/VertexAttributeLocations","../../../webgl/VertexElementDescriptor"],function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.PointRenderer,()=>new Promise((t,r)=>e(["./PointRenderer.glsl"],t,r))),l.fromLayout(p))}initializePipeline(e){return a.makePipelineState({depthTest:{func:513},depthWrite:a.defaultDepthWrite,colorWrite:a.defaultColorWrite,stencilWrite:e.hasOccludees?s.stencilWriteMaskOn:null,stencilTest:e.hasOccludees?s.stencilBaseAllZerosParams:null,drawBuffers:i.depthOnlyOutputBuffersOr(e.output)})}}const d=[new c.VertexElementDescriptor("position",3,o.DataType.FLOAT,0,12)],h=[new c.VertexElementDescriptor("color",3,o.DataType.UNSIGNED_BYTE,0,3,!0)],p=d.concat(h);t.PointRendererTechnique=u,t.colorsLayout=h,t.positionsLayout=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/shaders/PointRendererTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(){super(...arguments),this.drawScreenSize=!1,this.useFixedSizes=!1,this.hasOccludees=!1,this.clippingEnabled=!1,this.draped=!1}}t.__decorate([r.parameter()],s.prototype,"drawScreenSize",void 0),t.__decorate([r.parameter()],s.prototype,"useFixedSizes",void 0),t.__decorate([r.parameter()],s.prototype,"hasOccludees",void 0),t.__decorate([r.parameter()],s.prototype,"clippingEnabled",void 0),e.PointRendererTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/PointCloudRendererNode":function(){define(["exports","../../../../core/MapUtils","../../../../chunks/PointRenderer.glsl"],function(e,t,r){"use strict";class i extends r.PointRendererDrawParameters{constructor(e,t,r,i,s,n,o,a,l=null){super(r,s,t),this.id=e,this.obb=i,this.coordinates=n,this.rgb=o,this.attributes=a,this.pointIdFilterMap=l,this.highlightMap=new Map}addHighlight(e,r){const{highlightMap:i}=this,o=t.getOrCreateMapValue(i,r.highlightName,()=>new Array),a=new n(e,r);o.push(a);const l=s(a);for(let e=o.length-1;e>0&&l<s(o[e-1]);--e)[o[e-1],o[e]]=[o[e],o[e-1]]}removeHighlight(e){const{highlightMap:t}=this,{highlightName:r}=e,i=t.get(r);if(!i)return;const s=i.filter(t=>t.id!==e);0===s.length?t.delete(r):t.set(r,s)}get cachedMemory(){return 5*this.coordinates.length+128}}function s(e){return null!=e.componentIndex?e.componentIndex:-1}class n{constructor(e,t){this.componentIndex=e,this.id=t}}e.PointCloudRendererNode=i,e.isPointRendererNode=function(e){return e.hasOwnProperty("splatSize")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/PointCloudRendererUtil":function(){define(["exports"],function(e){"use strict";function t(e,t){for(const r of e??[])if(r.name===t&&null!=r.attributeValues&&"UInt8"===r.attributeValues.valueType&&3===r.attributeValues.valuesPerElement)return{name:t,storageInfo:r,useElevation:!1};return null}function r(e,t){for(const r of e??[])if(r.name===t){const e="embedded-elevation"===r.encoding;return e?{name:t,storageInfo:null,useElevation:e}:{name:t,storageInfo:r,useElevation:e}}return"elevation"===t?.toLowerCase()?{name:t,storageInfo:null,useElevation:!0}:null}e.getAttributeInfo=r,e.getFilterInfo=function(e){const t=e.filters;return t?t.map(t=>({filterJSON:t.toJSON(),attributeInfo:r(e.attributeStorageInfo,t.field)})):[]},e.getFixedSizeAlgorithm=function(e){const t=e?.pointSizeAlgorithm;return t&&"fixed-size"===t.type?t:null},e.getRendererInfo=function(e){const i=e.renderer,s=i?.type,n=i?.toJSON()??null;let o=null,a=!1;const l=e.attributeStorageInfo;"point-cloud-unique-value"===s||"point-cloud-stretch"===s||"point-cloud-class-breaks"===s?o=r(l,i.field):"point-cloud-rgb"===s?(o=t(l,i.field),a=null!=o):(o=t(l,"RGB"),a=null!=o);let c=null;return i?.colorModulation&&(c=r(l,i.colorModulation.field)),{rendererJSON:n,isRGBRenderer:a,primaryAttribute:o,modulationAttribute:c}},e.getSplatSizeAlgorithm=function(e){const t=e?.pointSizeAlgorithm;return t&&"splat"===t.type?t:null},e.rendererUsesFixedSizes=function(e){const t=e?.pointSizeAlgorithm;return!!t?.type&&"fixed-size"===t.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/PointCloudWorkerUtil":function(){define(["exports","../../../../core/has","../../../../renderers/PointCloudClassBreaksRenderer","../../../../renderers/PointCloudStretchRenderer","../../../../renderers/PointCloudUniqueValueRenderer","./I3SBinaryReader","./LEPCC"],function(e,t,r,i,s,n,o){"use strict";function a(e,t){const r=new Float64Array(t);for(let i=0;i<t;i++)r[i]=e[3*i+2];return r}function l(e){switch(e){default:case null:case"none":return e=>e;case"low-four-bit":return e=>15&e;case"high-four-bit":return e=>(240&e)>>4;case"absolute-value":return e=>Math.abs(e);case"modulo-ten":return e=>e%10}}function c(e){let t=0;for(const r of e||[])t|=1<<r;return t}e.elevationFromPositions=a,e.evaluateRenderer=function(e,t,n,o){const{rendererJSON:a,isRGBRenderer:c}=e;let u=null,d=null;if(t&&c)u=t;else if(t&&"pointCloudUniqueValueRenderer"===a?.type){d=s.fromJSON(a);const e=d.colorUniqueValueInfos;u=new Uint8Array(3*o);const r=l(d.fieldTransformType);for(let i=0;i<o;i++){const s=(r?r(t[i]):t[i])+"";for(let t=0;t<e.length;t++)if(e[t].values.includes(s)){u[3*i]=e[t].color.r,u[3*i+1]=e[t].color.g,u[3*i+2]=e[t].color.b;break}}}else if(t&&"pointCloudStretchRenderer"===a?.type){d=i.fromJSON(a);const e=d.stops;u=new Uint8Array(3*o);const r=l(d.fieldTransformType);for(let i=0;i<o;i++){const s=r?r(t[i]):t[i],n=e.length-1;if(s<e[0].value)u[3*i]=e[0].color.r,u[3*i+1]=e[0].color.g,u[3*i+2]=e[0].color.b;else if(s>=e[n].value)u[3*i]=e[n].color.r,u[3*i+1]=e[n].color.g,u[3*i+2]=e[n].color.b;else for(let t=1;t<e.length;t++)if(s<e[t].value){const r=(s-e[t-1].value)/(e[t].value-e[t-1].value);u[3*i]=e[t].color.r*r+e[t-1].color.r*(1-r),u[3*i+1]=e[t].color.g*r+e[t-1].color.g*(1-r),u[3*i+2]=e[t].color.b*r+e[t-1].color.b*(1-r);break}}}else if(t&&"pointCloudClassBreaksRenderer"===a?.type){d=r.fromJSON(a);const e=d.colorClassBreakInfos;u=new Uint8Array(3*o);const i=l(d.fieldTransformType);for(let r=0;r<o;r++){const s=i?i(t[r]):t[r];for(let t=0;t<e.length;t++)if(s>=e[t].minValue&&s<=e[t].maxValue){u[3*r]=e[t].color.r,u[3*r+1]=e[t].color.g,u[3*r+2]=e[t].color.b;break}}}else u=new Uint8Array(3*o).fill(255);if(n&&d?.colorModulation){const e=d.colorModulation.minValue,t=d.colorModulation.maxValue,r=.3;for(let i=0;i<o;i++){const s=n[i],o=s>=t?1:s<=e?r:r+(1-r)*(s-e)/(t-e);u[3*i]=o*u[3*i],u[3*i+1]=o*u[3*i+1],u[3*i+2]=o*u[3*i+2]}}return u},e.filterInPlace=function(e,t,r,i,s){const n=e.length/3;let o=0;for(let a=0;a<n;a++){let n=!0;for(let e=0;e<i.length&&n;e++){const{filterJSON:t}=i[e],r=s[e].values[a];switch(t.type){case"pointCloudValueFilter":{const e="exclude"===t.mode;t.values.includes(r)===e&&(n=!1);break}case"pointCloudBitfieldFilter":{const e=c(t.requiredSetBits),i=c(t.requiredClearBits);(r&e)===e&&0===(r&i)||(n=!1);break}case"pointCloudReturnFilter":{const e=15&r,i=r>>>4&15,s=i>1,o=1===e,a=e===i;let l=!1;for(const e of t.includedReturns)if("last"===e&&a||"firstOfMany"===e&&o&&s||"lastOfMany"===e&&a&&s||"single"===e&&!s){l=!0;break}l||(n=!1);break}}}n&&(r[o]=a,e[3*o]=e[3*a],e[3*o+1]=e[3*a+1],e[3*o+2]=e[3*a+2],t[3*o]=t[3*a],t[3*o+1]=t[3*a+1],t[3*o+2]=t[3*a+2],o++)}return o},e.getAttributeValues=function(e,t,r){return e?.attributeInfo.useElevation?t?a(t,r):null:e?.attributeInfo.storageInfo?n.readBinaryAttribute(e.attributeInfo.storageInfo,e.buffer,r,!0):null},e.readGeometry=function(e,t){if(null==e.encoding||""===e.encoding){const r=n.createGeometryIndexFromSchema(t,e);if(null==r.vertexAttributes.position)return;const i=n.createTypedView(t,r.vertexAttributes.position),s=r.header.fields,o=[s.offsetX,s.offsetY,s.offsetZ],a=[s.scaleX,s.scaleY,s.scaleZ],l=i.length/3,c=new Float64Array(3*l);for(let e=0;e<l;e++)c[3*e]=i[3*e]*a[0]+o[0],c[3*e+1]=i[3*e+1]*a[1]+o[1],c[3*e+2]=i[3*e+2]*a[2]+o[2];return c}if("lepcc-xyz"===e.encoding)return o.decodeXYZ(t).result},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/renderers/PointCloudClassBreaksRenderer":function(){define(["exports","../chunks/tslib.es6","../core/lang","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/subclass","./PointCloudRenderer","./support/RendererLegendOptions","./support/pointCloud/ColorClassBreakInfo","./support/pointCloud/fieldsMap"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";var h;return e.default=h=class extends l{constructor(e){super(e),this.type="point-cloud-class-breaks",this.field=null,this.legendOptions=null,this.fieldTransformType=null,this.colorClassBreakInfos=null}clone(){return new h({...this.cloneProperties(),field:this.field,fieldTransformType:this.fieldTransformType,colorClassBreakInfos:r.clone(this.colorClassBreakInfos),legendOptions:r.clone(this.legendOptions)})}},t.__decorate([o.enumeration({pointCloudClassBreaksRenderer:"point-cloud-class-breaks"})],e.default.prototype,"type",void 0),t.__decorate([i.property({json:{write:{isRequired:!0}},type:String})],e.default.prototype,"field",void 0),t.__decorate([i.property({type:c,json:{write:!0}})],e.default.prototype,"legendOptions",void 0),t.__decorate([i.property({type:d.fieldTransformTypeKebabDict.apiValues,json:{type:d.fieldTransformTypeKebabDict.jsonValues,read:d.fieldTransformTypeKebabDict.read,write:d.fieldTransformTypeKebabDict.write}})],e.default.prototype,"fieldTransformType",void 0),t.__decorate([i.property({type:[u],json:{write:{isRequired:!0}}})],e.default.prototype,"colorClassBreakInfos",void 0),e.default=h=t.__decorate([a.subclass("esri.renderers.PointCloudClassBreaksRenderer")],e.default),e.default})},"esri/renderers/PointCloudRenderer":function(){define(["exports","../chunks/tslib.es6","../core/jsonMap","../core/JSONSupport","../core/lang","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/accessorSupport/decorators/subclass","./support/pointCloud/ColorModulation","./support/pointCloud/pointSizeAlgorithmTypeUtils"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=r.strict()({pointCloudClassBreaksRenderer:"point-cloud-class-breaks",pointCloudRGBRenderer:"point-cloud-rgb",pointCloudStretchRenderer:"point-cloud-stretch",pointCloudUniqueValueRenderer:"point-cloud-unique-value"});return e.default=class extends i.JSONSupport{constructor(e){super(e),this.type=void 0,this.pointSizeAlgorithm=null,this.colorModulation=null,this.pointsPerInch=10}clone(){return console.warn(".clone() is not implemented for "+this.declaredClass),null}cloneProperties(){return{pointSizeAlgorithm:s.clone(this.pointSizeAlgorithm),colorModulation:s.clone(this.colorModulation),pointsPerInch:s.clone(this.pointsPerInch)}}},t.__decorate([n.property({type:d.apiValues,readOnly:!0,nonNullable:!0,json:{type:d.jsonValues,read:!1,write:{writer:d.write,isRequired:!0}}})],e.default.prototype,"type",void 0),t.__decorate([n.property({types:u.pointSizeAlgorithmTypes,json:{write:!0}})],e.default.prototype,"pointSizeAlgorithm",void 0),t.__decorate([n.property({type:c,json:{write:!0}})],e.default.prototype,"colorModulation",void 0),t.__decorate([n.property({json:{write:!0},nonNullable:!0,type:Number})],e.default.prototype,"pointsPerInch",void 0),e.default=t.__decorate([l.subclass("esri.renderers.PointCloudRenderer")],e.default),e.default})},"esri/renderers/support/pointCloud/ColorModulation":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o){"use strict";var a;let l=a=class extends t.JSONSupport{constructor(){super(...arguments),this.field=null,this.minValue=0,this.maxValue=255}clone(){return new a({field:this.field,minValue:this.minValue,maxValue:this.maxValue})}};return e.__decorate([r.property({type:String,json:{write:{isRequired:!0}}})],l.prototype,"field",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],l.prototype,"minValue",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],l.prototype,"maxValue",void 0),l=a=e.__decorate([o.subclass("esri.renderers.support.pointCloud.ColorModulation")],l),l})},"esri/renderers/support/pointCloud/pointSizeAlgorithmTypeUtils":function(){define(["exports","./PointSizeAlgorithm","./PointSizeFixedSizeAlgorithm","./PointSizeSplatAlgorithm"],function(e,t,r,i){"use strict";const s={key:"type",base:t,typeMap:{"fixed-size":r,splat:i}};e.pointSizeAlgorithmTypes=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/renderers/support/pointCloud/PointSizeAlgorithm":function(){define(["../../../chunks/tslib.es6","../../../core/jsonMap","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";const l=new t.JSONMap({pointCloudFixedSizeAlgorithm:"fixed-size",pointCloudSplatAlgorithm:"splat"});let c=class extends r.JSONSupport{};return e.__decorate([i.property({type:l.apiValues,readOnly:!0,nonNullable:!0,json:{type:l.jsonValues,read:!1,write:{writer:l.write,isRequired:!0}}})],c.prototype,"type",void 0),c=e.__decorate([a.subclass("esri.renderers.support.pointCloud.PointSizeAlgorithm")],c),c})},"esri/renderers/support/pointCloud/PointSizeFixedSizeAlgorithm":function(){define(["../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass","./PointSizeAlgorithm"],function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends a{constructor(){super(...arguments),this.type="fixed-size",this.size=0,this.useRealWorldSymbolSizes=null}clone(){return new l({size:this.size,useRealWorldSymbolSizes:this.useRealWorldSymbolSizes})}};return e.__decorate([n.enumeration({pointCloudFixedSizeAlgorithm:"fixed-size"})],c.prototype,"type",void 0),e.__decorate([t.property({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],c.prototype,"size",void 0),e.__decorate([t.property({type:Boolean,json:{write:!0}})],c.prototype,"useRealWorldSymbolSizes",void 0),c=l=e.__decorate([o.subclass("esri.renderers.support.pointCloud.PointSizeFixedSizeAlgorithm")],c),c})},"esri/renderers/support/pointCloud/PointSizeSplatAlgorithm":function(){define(["../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass","./PointSizeAlgorithm"],function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends a{constructor(){super(...arguments),this.type="splat",this.scaleFactor=1}clone(){return new l({scaleFactor:this.scaleFactor})}};return e.__decorate([n.enumeration({pointCloudSplatAlgorithm:"splat"})],c.prototype,"type",void 0),e.__decorate([t.property({type:Number,value:1,nonNullable:!0,json:{write:{isRequired:!0}}})],c.prototype,"scaleFactor",void 0),c=l=e.__decorate([o.subclass("esri.renderers.support.pointCloud.PointSizeSplatAlgorithm")],c),c})},"esri/renderers/support/pointCloud/ColorClassBreakInfo":function(){define(["../../../chunks/tslib.es6","../../../Color","../../../core/JSONSupport","../../../core/lang","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o){"use strict";var a;let l=a=class extends r.JSONSupport{constructor(){super(...arguments),this.description=null,this.label=null,this.minValue=0,this.maxValue=0,this.color=null}clone(){return new a({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,color:i.clone(this.color)})}};return e.__decorate([s.property({type:String,json:{write:!0}})],l.prototype,"description",void 0),e.__decorate([s.property({type:String,json:{write:!0}})],l.prototype,"label",void 0),e.__decorate([s.property({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue",isRequired:!0}}})],l.prototype,"minValue",void 0),e.__decorate([s.property({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue",isRequired:!0}}})],l.prototype,"maxValue",void 0),e.__decorate([s.property({type:t,json:{type:[n.Integer],write:{isRequired:!0}}})],l.prototype,"color",void 0),l=a=e.__decorate([o.subclass("esri.renderers.support.pointCloud.ColorClassBreakInfo")],l),l})},"esri/renderers/support/pointCloud/fieldsMap":function(){define(["exports","../../../core/jsonMap"],function(e,t){"use strict";const r=new t.JSONMap({none:"none",lowFourBit:"low-four-bit",highFourBit:"high-four-bit",absoluteValue:"absolute-value",moduloTen:"modulo-ten"});e.fieldTransformTypeKebabDict=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/renderers/PointCloudStretchRenderer":function(){define(["exports","../chunks/tslib.es6","../core/lang","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/subclass","./PointCloudRenderer","./support/RendererLegendOptions","./support/pointCloud/fieldsMap","./visualVariables/support/ColorStop"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";var h;return e.default=h=class extends l{constructor(e){super(e),this.type="point-cloud-stretch",this.field=null,this.legendOptions=null,this.fieldTransformType=null,this.stops=null}clone(){return new h({...this.cloneProperties(),field:r.clone(this.field),fieldTransformType:r.clone(this.fieldTransformType),stops:r.clone(this.stops),legendOptions:r.clone(this.legendOptions)})}},t.__decorate([o.enumeration({pointCloudStretchRenderer:"point-cloud-stretch"})],e.default.prototype,"type",void 0),t.__decorate([i.property({json:{write:{isRequired:!0}},type:String})],e.default.prototype,"field",void 0),t.__decorate([i.property({type:c,json:{write:!0}})],e.default.prototype,"legendOptions",void 0),t.__decorate([i.property({type:u.fieldTransformTypeKebabDict.apiValues,json:{type:u.fieldTransformTypeKebabDict.jsonValues,read:u.fieldTransformTypeKebabDict.read,write:u.fieldTransformTypeKebabDict.write}})],e.default.prototype,"fieldTransformType",void 0),t.__decorate([i.property({type:[d],json:{write:{isRequired:!0}}})],e.default.prototype,"stops",void 0),e.default=h=t.__decorate([a.subclass("esri.renderers.PointCloudStretchRenderer")],e.default),e.default})},"esri/renderers/PointCloudUniqueValueRenderer":function(){define(["exports","../chunks/tslib.es6","../core/lang","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/subclass","./PointCloudRenderer","./support/RendererLegendOptions","./support/pointCloud/ColorUniqueValueInfo","./support/pointCloud/fieldsMap"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";var h;return e.default=h=class extends l{constructor(e){super(e),this.type="point-cloud-unique-value",this.field=null,this.fieldTransformType=null,this.colorUniqueValueInfos=null,this.legendOptions=null}clone(){return new h({...this.cloneProperties(),field:r.clone(this.field),fieldTransformType:r.clone(this.fieldTransformType),colorUniqueValueInfos:r.clone(this.colorUniqueValueInfos),legendOptions:r.clone(this.legendOptions)})}},t.__decorate([o.enumeration({pointCloudUniqueValueRenderer:"point-cloud-unique-value"})],e.default.prototype,"type",void 0),t.__decorate([i.property({json:{write:{isRequired:!0}},type:String})],e.default.prototype,"field",void 0),t.__decorate([i.property({type:d.fieldTransformTypeKebabDict.apiValues,json:{type:d.fieldTransformTypeKebabDict.jsonValues,read:d.fieldTransformTypeKebabDict.read,write:d.fieldTransformTypeKebabDict.write}})],e.default.prototype,"fieldTransformType",void 0),t.__decorate([i.property({type:[u],json:{write:{isRequired:!0}}})],e.default.prototype,"colorUniqueValueInfos",void 0),t.__decorate([i.property({type:c,json:{write:!0}})],e.default.prototype,"legendOptions",void 0),e.default=h=t.__decorate([a.subclass("esri.renderers.PointCloudUniqueValueRenderer")],e.default),e.default})},"esri/renderers/support/pointCloud/ColorUniqueValueInfo":function(){define(["../../../chunks/tslib.es6","../../../Color","../../../core/JSONSupport","../../../core/lang","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o){"use strict";var a;let l=a=class extends r.JSONSupport{constructor(){super(...arguments),this.description=null,this.label=null,this.values=null,this.color=null}clone(){return new a({description:this.description,label:this.label,values:i.clone(this.values),color:i.clone(this.color)})}};return e.__decorate([s.property({type:String,json:{write:!0}})],l.prototype,"description",void 0),e.__decorate([s.property({type:String,json:{write:!0}})],l.prototype,"label",void 0),e.__decorate([s.property({type:[String],json:{write:{isRequired:!0}}})],l.prototype,"values",void 0),e.__decorate([s.property({type:t,json:{type:[n.Integer],write:{isRequired:!0}}})],l.prototype,"color",void 0),l=a=e.__decorate([o.subclass("esri.renderers.support.pointCloud.ColorUniqueValueInfo")],l),l})},"esri/views/3d/layers/support/PopupSceneLayerView":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Error","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/support/fieldUtils","../../../layers/support/popupUtils"],function(e,t,r,i,s,n,o,a,l){"use strict";e.PopupSceneLayerView=e=>{const i=e;let s=class extends i{_validateFetchPopupFeatures(e){const{layer:t}=this,{popupEnabled:i}=t;if(!i)throw new r("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t});if(!l.getFetchPopupTemplate(t,e))throw new r("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t})}async prepareFetchPopupFeatures(e){}async fetchPopupFeaturesFromGraphics(e,t){if(this._validateFetchPopupFeatures(t),0===e.length)return[];const r="scene"===this.layer.type&&null!=this.layer.associatedLayer?this.layer.associatedLayer:this.layer;let i=[];"fieldsIndex"in this.layer&&(i=a.unpackFieldNames(this.layer.fieldsIndex,await l.getRequiredFields(r,l.getFetchPopupTemplate(this.layer,t)))),await this.prepareFetchPopupFeatures(i);const s=new Set,n=[],o=[];for(const t of e)a.populateMissingFields(t,i,s)?o.push(t):n.push(t);if(0===o.length)return n;const c=new Map;for(let t=0;t<e.length;t++)c.set(e[t].getObjectId()??0,t);const u=await this.whenGraphicAttributes(o,[...s]).catch(()=>o).then(e=>n.concat(e));return u.sort((e,t)=>{const r=e.getObjectId()??0,i=c.get(r)??0,s=t.getObjectId()??0;return i-(c.get(s)??0)}),u}};return s=t.__decorate([o.subclass("esri.views.3d.layers.support.PopupSceneLayerView")],s),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/PointCloudLayerView":function(){define(["exports","../../chunks/tslib.es6","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o){"use strict";e.PointCloudLayerView=e=>{const i=e;let s=class extends i{constructor(...e){super(...e),this.layer=null}get availableFields(){return[]}highlight(e,t){throw new Error("Not implemented")}queryFeatures(){throw new Error("Not implemented")}queryFeatureCount(){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(){throw new Error("Not implemented")}};return t.__decorate([r.property()],s.prototype,"layer",void 0),t.__decorate([r.property()],s.prototype,"availableFields",null),s=t.__decorate([o.subclass("esri.views.layers.PointCloudLayerView")],s),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/SceneLayerView3D":function(){define(["../../../chunks/tslib.es6","../../../Graphic","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/ReactiveSet","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/sql/WhereClause","../../../graphic/SceneGraphicOrigin","../../../layers/support/FeatureFilter","../../../layers/support/floorFilterUtils","../../../rest/support/Query","../../../support/guards","./I3SMeshView3D","./LayerView3D","./i3s/featureEditing","./i3s/I3SGeometryUtil","./i3s/I3SMeshViewFilter","./i3s/I3SOverrides","./i3s/I3SQueryEngine","./i3s/I3SQueryFeatureAdapter","./i3s/I3SQueryFeatureStore","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","./support/fieldProperties","./support/PopupSceneLayerView","./support/SceneLayerViewRequiredFields","./support/TemporalSceneLayerView","../support/updatingProperties","../../layers/SceneLayerView","../../layers/support/popupUtils","../../support/layerViewUtils","../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V){"use strict";const U=R.defineFieldProperties();let B=class extends(y.I3SMeshView3D(F.TemporalSceneLayerView(M.DefinitionExpressionSceneLayerView(O.PopupSceneLayerView(_.LayerView3D(D)))))){constructor(){super(...arguments),this.type="scene-layer-3d",this.viewFilter=null,this._setVisibilityHiddenObjectIds=new n,this.progressiveLoadFactor=1,this._elevationContext="scene",this._supportsLabeling=!0,this._pendingEditsQueue=Promise.resolve(),this._interactiveEditingSessions=new Map,this._queryEngine=null}get i3slayer(){return this.layer}tryRecycleWith(e,t){return e.url===this.layer.url&&this.i3sOverrides.isEmpty?e.load(t).then(()=>{s.throwIfAborted(t),P.checkRecyclable(this.layer,e,this.i3sOverrides),this.layer=e,this.i3sOverrides.destroy();const r=this.view.resourceController?.memoryController;this.i3sOverrides=new x.I3SOverrides({view:this.view,layer:e,memoryController:r}),this.resetHighlights()}):null}get layerPopupEnabledAndHasTemplate(){return this.layer.popupEnabled&&E.hasPopupTemplate(this.layer,this.view.popup?.defaultPopupTemplateEnabled)}get filter(){return this._get("filter")}set filter(e){this._set("filter",w.I3SMeshViewFilter.checkSupport(e)?e:null)}get requiredFields(){return this._fieldsHelper?.requiredFields??[]}get _floorFilterClause(){const e=f.getFloorFilterClause(this);return null!=e?d.create(e,{fieldsIndex:this.layer.fieldsIndex}):null}get _excludeObjectIdsSorted(){const e=this.layer.excludeObjectIds.toArray();return e.length?e.sort((e,t)=>e-t):null}get _setVisibilityHiddenObjectIdsSorted(){return this._setVisibilityHiddenObjectIds.size?Array.from(this._setVisibilityHiddenObjectIds).sort((e,t)=>e-t):null}get lodFactor(){return this.view?.qualitySettings?.sceneService?.object?.lodFactor??1}get lodCrossfadeUncoveredDuration(){return this.view?.qualitySettings?.fadeDuration??0}get updatingProgressValue(){return this._controller?.updatingProgress??0}get visibleAtCurrentScale(){return L.isInEffectiveScaleRange(this.i3slayer.effectiveScaleRange,this.view.scale)}get _graphicOrigin(){return new h(this.layer)}initialize(){this._fieldsHelper=new I.SceneLayerViewRequiredFields({layerView:this}),this._updatingHandles.add(()=>this.layer.rangeInfos,e=>this._rangeInfosChanged(e),o.initial),this._updatingHandles.add(()=>this.layer.renderer,e=>this._updatingHandles.addPromise(this._rendererChange(e)),o.initial);const e=()=>this._filterChange();this._updatingHandles.add(()=>this.parsedDefinitionExpression,e),this._updatingHandles.add(()=>this.mergedFilter,e),this._updatingHandles.add(()=>this._floorFilterClause,e),this._updatingHandles.add(()=>this._excludeObjectIdsSorted,e),this._updatingHandles.add(()=>this._setVisibilityHiddenObjectIdsSorted,e),this._updatingHandles.add(()=>this.viewFilter?.sortedObjectIds,e),this._updatingHandles.add(()=>this.viewFilter?.parsedWhereClause,e),this._updatingHandles.add(()=>this.getTimeFilterDependencies(),e),this._updatingHandles.add(()=>[this.viewFilter?.parsedGeometry,this.mergedFilter?.spatialRelationship,this.layer.filter?.spatialRelationship],()=>this._geometryFilterChange()),this._updatingHandles.add(()=>({layerViewFilter:this.mergedFilter,layerFilter:this.layerFilter}),({layerViewFilter:e,layerFilter:t})=>{if(null==e&&null==t)return void this._set("viewFilter",null);const r=this.viewFilter;if(r)return r.viewFilter=e,r.layerFilter=t,void this._filterChange();this._set("viewFilter",new w.I3SMeshViewFilter({layerFilter:t,viewFilter:e,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),addSqlFilter:(e,t)=>this.addSqlFilter(e,t,this.logError),addTimeFilter:(e,t)=>this.addTimeFilter(e,t)}))},o.initial),this.i3sOverrides.is3DOFL&&this._updatingHandles.add(()=>this.i3sOverrides.sortedGeometryChangedObjectIds,e),this.addHandles(this.layer.on("apply-edits",e=>this._updatingHandles.addPromise(e.result))),this.addHandles(this.layer.on("edits",e=>{const t=this._pendingEditsQueue.then(()=>this._handleEdits(e)).then();this._pendingEditsQueue=t,this._updatingHandles.addPromise(t)}))}destroy(){this._fieldsHelper=i.destroyMaybe(this._fieldsHelper)}_rangeInfosChanged(e){null!=e&&e.length>0&&r.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}createQuery(){const e={outFields:["*"],returnGeometry:!0,returnZ:!0,outSpatialReference:this.view.spatialReference};return this.mergedFilter?.createQuery(e)??new m(e)}queryExtent(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),t?.signal)}queryFeatureCount(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),t?.signal)}queryFeatures(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),t?.signal).then(e=>{if(!e?.features)return e;const t=this.layer,r=this._graphicOrigin;for(const i of e.features)i.layer=t,i.sourceLayer=t,i.origin=r;return e})}async queryObjectIds(e,t){return(await this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),t?.signal)).filter(g.isNumber)}_ensureQueryEngine(){return this._queryEngine??=this._createQueryEngine(),this._queryEngine}_createQueryEngine(){const e=v.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new S.I3SQueryEngine({layerView:this,priority:V.TaskPriority.FEATURE_QUERY_ENGINE,spatialIndex:new C.I3SQueryFeatureStore({featureAdapter:new T.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo??[],getFeatureExtent:e}),forAllFeatures:(e,t)=>this._forAllFeatures((t,r,i)=>e(new T.I3SQueryFeature(t,r,i)),t,2),getFeatureExtent:e,sourceSpatialReference:P.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})}createInteractiveEditSession(e){return b.createInteractiveEditSession(this._attributeEditingContext,e)}_createLayerGraphic(e){return new t({attributes:e,layer:this.layer,sourceLayer:this.layer,origin:this._graphicOrigin})}getFilters(){const e=super.getFilters();this.i3sOverrides.is3DOFL&&this.i3sOverrides.sortedGeometryChangedObjectIds.length>0&&e.push((e,t)=>{t.node.index>=0&&P.objectIdFilter(this.i3sOverrides.sortedGeometryChangedObjectIds,!1,e)});const t=this._setVisibilityHiddenObjectIdsSorted;null!=t&&e.push(e=>P.objectIdFilter(t,!1,e));const r=this._excludeObjectIdsSorted;return null!=r&&e.push(e=>P.objectIdFilter(r,!1,e)),this._floorFilterClause&&this.addSqlFilter(e,this._floorFilterClause,this.logError),this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),null!=this.viewFilter&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}setVisibility(e,t){t?this._setVisibilityHiddenObjectIds.delete(e):this._setVisibilityHiddenObjectIds.add(e)}isUpdating(){return super.isUpdating()||this.layerFilterUpdating||null!=this.viewFilter&&this.viewFilter.updating||null!=this.i3sOverrides&&this.i3sOverrides.updating}_ensureQuery(e){return this._validateQuery(this._addDefinitionExpressionToQuery(null==e?this.createQuery():m.from(e)))}_validateQuery(e){return e.outSpatialReference&&!e.outSpatialReference.equals(this.view.spatialReference)&&(r.getLogger(this).warn("query: outSpatialReference different from the view's spatial reference is not supported"),e.outSpatialReference=this.view.spatialReference),e.returnGeometry&&(e.returnZ=!0),e.returnCentroid=!1,e}get _attributeEditingContext(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),globalIdField:this._getGlobalIdField(),forEachNode:e=>this._forAllNodes(t=>null!=t?e(t.node,t.featureIds):null),attributeStorageInfo:this.i3slayer.attributeStorageInfo??[],i3sOverrides:this.i3sOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(e,t)=>this.setAttributeData(e,t),clearMemCache:()=>this.clearMemCache()}}async _handleEdits(e){const t=this._attributeEditingContext,r=await b.normalizeEditResultsEvent(t,e);b.processGeometryEdits(t,r),b.processAttributeEdits(t,r)}get hasGeometryFilter(){return null!=this.viewFilter?.parsedGeometry}computeNodeFiltering(e){const t=this.viewFilter;return null==t||!this.view.spatialReference||t.isMBSGeometryVisible(e,this.view.spatialReference,this._controller.crsIndex)?0:1}};return e.__decorate([a.property()],B.prototype,"i3slayer",null),e.__decorate([a.property(A.updatingProgress)],B.prototype,"updatingProgress",void 0),e.__decorate([a.property({type:p})],B.prototype,"filter",null),e.__decorate([a.property({readOnly:!0})],B.prototype,"viewFilter",void 0),e.__decorate([a.property(U.requiredFields)],B.prototype,"requiredFields",null),e.__decorate([a.property(U.availableFields)],B.prototype,"availableFields",void 0),e.__decorate([a.property()],B.prototype,"_fieldsHelper",void 0),e.__decorate([a.property()],B.prototype,"_floorFilterClause",null),e.__decorate([a.property()],B.prototype,"_excludeObjectIdsSorted",null),e.__decorate([a.property()],B.prototype,"_setVisibilityHiddenObjectIds",void 0),e.__decorate([a.property()],B.prototype,"_setVisibilityHiddenObjectIdsSorted",null),e.__decorate([a.property()],B.prototype,"lodFactor",null),e.__decorate([a.property()],B.prototype,"updatingProgressValue",null),e.__decorate([a.property({readOnly:!0})],B.prototype,"visibleAtCurrentScale",null),e.__decorate([a.property()],B.prototype,"_graphicOrigin",null),B=e.__decorate([u.subclass("esri.views.3d.layers.SceneLayerView3D")],B),B})},"esri/graphic/SceneGraphicOrigin":function(){define(["./GraphicOrigin","./isSceneGraphicOrigin"],function(e,t){"use strict";var r;class i extends e{static{r=t.isSceneGraphicOriginSymbol}constructor(e){super(),this[r]=!0,this.type="scene",this.layer=e}}return i})},"esri/graphic/isSceneGraphicOrigin":function(){define(["exports"],function(e){"use strict";const t=Symbol("isSceneGraphicOrigin");e.isSceneGraphicOrigin=function(e){return!!e&&t in e},e.isSceneGraphicOriginSymbol=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/I3SMeshView3D":function(){define(["require","exports","../../../chunks/tslib.es6","../../../Color","../../../Graphic","../../../core/arrayUtils","../../../core/has","../../../core/Logger","../../../core/MapUtils","../../../core/maybe","../../../core/PooledArray","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/scheduling","../../../core/SetUtils","../../../core/typedArrayUtil","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/factories/quatf64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../core/support/UpdatingHandles","../../../geometry/spatialReferenceEllipsoidUtils","../../../geometry/projection/localLinearScaleFactors","../../../geometry/projection/projectBoundingSphere","../../../geometry/projection/projectBuffer","../../../geometry/projection/projectors","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/DoubleArray","../../../geometry/support/FloatArray","../../../geometry/support/Indices","../../../chunks/sphere","../../../geometry/support/UByteArray","../../../layers/LayerConstants","../../../layers/graphics/controllers/I3SOnDemandController","../../../layers/support/fieldUtils","../../../layers/support/SceneModification","../../../renderers/visualVariables/support/visualVariableUtils","../../../support/basemapUtils","../../../support/elevationInfoUtils","../../../support/loadArcade","../../../symbols/MeshSymbol3D","../../../symbols/SimpleFillSymbol","./ContentGeometryLayerView","./I3SMeshViewLabeler","./I3SMeshViewPerformanceInfo","./I3SMeshWorkerHandle","./SceneLayerWorker","./graphics/graphicUtils","./graphics/Labeler","./i3s/Highlights","./i3s/I3SAsyncElevationUpdater","./i3s/I3SBinaryReader","./i3s/I3SCrossfadeHelper","./i3s/I3SGeometryUtil","./i3s/I3SIntersectionHandler","./i3s/I3SMaterialUtil","./i3s/I3SOverrides","./i3s/I3SProjectionUtil","./i3s/I3SUtil","./i3s/IDBCache","./i3s/IDBMockCache","./i3s/LayerElevationProvider","./i3s/SymbologyInfo","./support/attributeUtils","./support/highlightUtils","./support/makeScheduleFunction","../support/debugFlags","../support/ElevationRange","../support/extentUtils","../support/orientedBoundingBox","../support/updatingProperties","../support/buffer/glUtil","../webgl-engine/collections/Component/ObjectParameters","../webgl-engine/collections/Component/SourceGeometry","../webgl-engine/collections/Component/Transform","../webgl-engine/core/shaderLibrary/output/Emissions.glsl","../webgl-engine/lib/BasisUtil","../../support/highlightOptionsUtils","../../support/TextureCompressionTracker","../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V,U,B,N,k,z,j,G,q,H,W,$,Q,Z,Y,X,J,K,ee,te,re,ie,se,ne,oe,ae,le,ce,ue,de,he,pe,fe,me,ge,ye,_e,be,ve,we,xe,Se,Te,Ce,Pe,Me,Re,Oe,Ie,Fe,Ae,De,Ee){"use strict";const Le=[1,1,1,1];class Ve extends ae.NodeCrossfadeMetaData{constructor(e,t,r,i,s,n,o,a,l){super(),this.node=e,this.featureIds=t,this.objectHandle=r,this.cachedRendererVersion=i,this.attributeInfo=s,this.material=n,this.textures=o,this.anchorIds=a,this.anchors=l,this.cachedElevationAnchors=null,this.cachedEdgeMaterials=new Array,this.edgeMemoryUsage=0,this.cachedSymbologyStride=5}get cachedMemory(){return this.node.memory}get featureExtents(){return this._featureExtents??=new Float64Array(6*this.featureIds.length).fill(Number.POSITIVE_INFINITY),this._featureExtents}}const Ue=E.create(),Be=L.create(),Ne=L.create(),ke=new Te.Obb,ze=new i([0,0,0,0]),je=N.fromValues(0,0,0,0);function Ge(e){if(null==e)return!1;const t=e.metallicRoughness;return t&&t.baseColorTextureId>=0||t&&t.metallicRoughnessTextureId>=0||e.normalTextureId>=0||e.emissiveTextureId>=0||e.occlusionTextureId>=0}function qe(e){return null!=e&&m.isArrayBuffer(e.data)}function He(e,t){let r=1024+e.interleavedVertexData.byteLength+(e.indices?e.indices.byteLength:0)+e.positionData.data.byteLength+e.positionData.indices.byteLength;if(null!=t)for(const e of t)null!=e&&m.isArrayBuffer(e.data)&&(r+=e.data.byteLength);return r}class We{constructor(e,t,r){this.attributeInfo=e,this.meta=t,this.promise=r,this.allowMemCache=!0}}function $e(e,t){e.forEach(e=>e.opacity=t)}class Qe{constructor(e,t){this.mode=e,this.offset=t}}const Ze=T.create(),Ye=E.create(),Xe="elevation-change",Je=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],Ke=new xe.ElevationRange;function et(e,t,r){let i=e.elevationRangeMin,s=e.elevationRangeMax;const n=r;if(n>0){t.getCorners(Je);for(const e of Je){const t=S.len(e)-n;i=Math.min(i,t),s=Math.max(s,t)}}else{t.getCorners(Je);for(const e of Je){const t=e[2];i=Math.min(i,t),s=Math.max(s,t)}}e.expandElevationRangeValues(i,s)}function tt(e,t,r){const i=N.getCenter(t),s=r>0?S.len(i)-r:i[2],n=N.getRadius(t);e.expandElevationRangeValues(s-n,s+n)}function rt(e,t,r){const i=new Array,s=e.filteredIds;if(null==s||t?.size||r?.size){if(null!=s){let n=0;e.featureIds.forEach((e,o)=>{if(s[n]===e)++n;else if(!t?.has(e))return;r?.has(e)||i.push(o)})}}else e.featureIds.forEach((e,t)=>{s[i.length]===e&&i.push(t)});return i}function it(e,t,r){if(e&&t)for(const i of t){const t=(e.get(i)??0)+r;t>0?e.set(i,t):e.delete(i)}}function st(e,t=0){const r=new Map;for(const i of e)it(r,0===t?i?.featureIds:1===t?i?.filteredIds:i?.weaklyRemovedIds,1);return r}t.I3SMeshView3D=t=>{const i=t;let m=class extends i{constructor(){super(...arguments),this._applySSAO=!0,this._shadeNormals=!0,this._updatingHandles=new M.UpdatingHandles,this._highlights=null,this._nodeId2Meta=new Map,this._nodeId2MetaReloading=new Map,this._i3sWasmLoaded=!1,this._snappingSourcesTrackers=[],this._compressionTracker=new De.TextureCompressionTracker,this._hasLoadedPBRTextures=!1,this._asyncModuleLoading=0,this._addTasks=new Map,this._currentRenderer=null,this._rendererVersion=0,this._colorVariable=null,this._opacityVariable=null,this._rendererFields=null,this._symbologyFields=null,this._symbologyOverride=null,this._symbologyOverrideFields=null,this._symbolInfos=new Map,this._visibleGeometryChangedSchedulerHandle=null,this._hasComponentData=!1,this._hasVertexColors=!1,this._nodeColorOverride=null,this.updating=!0,this.holeFilling="auto",this._hasColors=!1,this._hasTextures=!1,this._hasData=!1,this.slicePlaneEnabled=!1,this._modifications=new Array,this.ignoresMemoryFactor=!1,this._layerUrl="",this._cacheKeySuffix=null,this._planetRadiusInGlobalMode=0,this._elevationTask=null,this._needFilterResolve=!1,this._filters=[],this._arcade=null,this._tmpAttributeOnlyGraphic=new s,this._crossfadeHelper=new ae.I3SCrossfadeHelper(this)}get lodCrossfadeoutDuration(){return 0}get lodCrossfadeinDuration(){return 0}get lodCrossfadeUncoveredDuration(){return 0}get layerViewUid(){return this.uid}get layerId(){return this.i3slayer&&this.i3slayer.id}get sublayerId(){return null}get _isIntegratedMesh(){return"integrated-mesh"===this.i3slayer.type}get contentVisible(){return!this.suspended&&this._controller?.rootNodeVisible&&this.fullOpacity>Ee.alphaCutoff}get legendEnabled(){return this.contentVisible&&!0===this.i3slayer?.legendEnabled}get updatingProgressValue(){return this._controller?.updatingProgress??0}get hasTexturesOrVertexColors(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}get rendererTextureUsage(){return pe.rendererNeedsTextures(this._currentRenderer)?this._usePBR||this._hasLoadedPBRTextures?63:37:this._usePBR||this._hasLoadedPBRTextures?44:36}get elevationOffset(){const e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;return null!=e&&"absolute-height"===e.mode?$.getElevationOffset(e,this.i3slayer.spatialReference):0}get elevationInfo(){const e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null==e)return new Qe(0,0);const t=$.getElevationOffset(e,this.i3slayer.spatialReference);switch(e.mode){case"absolute-height":return new Qe(0,t);case"relative-to-ground":return new Qe(1,t);case"on-the-ground":return new Qe(2,0);default:return new Qe(0,0)}}get supportedTextureEncodings(){return ue.getSupportedEncodings(this.view.stage.renderView.capabilities)}get clientGeometry(){return this.i3sOverrides.geometryOverrides}get elevationRange(){const e=this._nodeId2Meta,t=new xe.ElevationRange;for(const r of e.values()){if(null==r)continue;const{node:{serviceMbsInIndexSR:e}}=r,[i,s,n,o]=e;t.expandElevationRangeValues(n-o,n+o)}return t.elevationRangeValid?t:null}get fullExtent(){return this.i3slayer.fullExtent}initialize(){const t=o("enable-feature:idb-mock-cache");this._idbCache=t?new me.IDBMockCache(this.view,t):new fe.IDBCache("esri-scenelayer-cache","geometries"),this._preLoadBasis(),this.addResolvingPromise(this.i3slayer.indexInfo);const r=this.view.resourceController,i=r.memoryController;this.i3sOverrides=new de.I3SOverrides({view:this.view,layer:this.i3slayer,memoryController:i}),this._workerHandle=new ee.I3SMeshWorkerHandle(ve.makeScheduleFunction(r)),this.addResolvingPromise(this._workerHandle.promise);const s=this.i3slayer.store;this.addResolvingPromise(this._workerHandle.setLegacySchema(this.uid,s.defaultGeometrySchema).catch(d.ignoreAbortErrors)),pe.checkSceneLayerValid(this.i3slayer),pe.checkSceneLayerCompatibleWithView(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new j({layerView:this,worker:this._workerHandle}),this._gpuMemoryEstimate=0,this._texMemoryEstimate=0,this._geoMemoryEstimate=0,this._stage=this.view.stage,this._collection=this._stage.renderView.componentObjectCollection;const n=s.defaultGeometrySchema;if(this._isIntegratedMesh||!n)this._hasComponentData=!1;else{const e=n.featureAttributes;this._hasComponentData=!!(e&&e.faceRange&&e.id)}this._hasVertexColors=null!=(n?.vertexAttributes.color??null)&&!this.i3slayer.cachedDrawingInfo?.color;const l=this.view.resourceController.memoryController.newCache(`sl-${this.uid}`,e=>this._deleteComponentObject(e));this._memCache=l;const u=this._controller,p=this._nodeId2Meta,f=this._nodeId2MetaReloading;this._intersectionHandler=new ce.I3SIntersectionHandler({layerViewUid:this.layerViewUid,sublayerId:this.sublayerId,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:e=>{const t=u.index;if(!t)return;const r=t.rootNode;r&&t.traverse(r,t=>{const r=t.index,i=p.get(r)||f.get(r);return e(t,i?.objectHandle??null)})}}),this._elevationProvider=new ge.LayerElevationProvider({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this._hasLoadedPBRTextures=this._usePBR,this._updatingHandles.add(()=>this.view.clippingArea,()=>this._clippingAreaChanged(),h.initial),this._updatingHandles.add(()=>this.fullOpacity,e=>this._opacityChange(e)),this._updatingHandles.add(()=>this.slicePlaneEnabled,e=>this._slicePlaneEnabledChange(e)),this._updatingHandles.add(()=>this.elevationOffset,(e,t)=>{this._reloadAll(t),this._controller.invalidateVisibilityObbs()}),this._updatingHandles.add(()=>this.elevationInfo,(e,t)=>this._elevationInfoChanged(e,t),h.initial),this._updatingHandles.add(()=>!this.suspended&&0!==this.elevationInfo.mode,(e,t)=>{e?this.addHandles(this.view.basemapTerrain.on("elevation-change",({extent:e})=>this._ensureElevationTask().addExtent(e)),Xe):t&&this.removeHandles(Xe)},h.initial),this._updatingHandles.add(()=>this._usePBR,e=>this._updatePBR(e)),this._updatingHandles.add(()=>this.rendererTextureUsage,()=>{this._reloadAll(),this.clearMemCache()}),this._updatingHandles.add(()=>this.contentVisible,e=>this._contentVisibleChanged(e),h.initial),this._updatingHandles.add(()=>this.i3slayer.labelsVisible,()=>this._labelingChanged(),h.initial),this._updatingHandles.add(()=>this.i3slayer.labelingInfo,()=>this._labelingChanged(),h.initial),this._updatingHandles.add(()=>this._modifications,()=>this._modificationsChanged(),h.initial),this.addHandles([h.watch(()=>we.debugFlags.I3S_TREE_SHOW_TILES,t=>{if(t&&!this._treeDebugger){const t=this._controller.crsIndex;new Promise((t,r)=>e(["./support/I3STreeDebugger"],t,r)).then(({I3STreeDebugger:e})=>{!this._treeDebugger&&we.debugFlags.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new e({lv:this,view:this.view,nodeSR:t}))})}else t||we.debugFlags.I3S_TREE_SHOW_TILES||(this._treeDebugger=c.destroyMaybe(this._treeDebugger))},h.initial),h.watch(()=>we.debugFlags.I3S_SHOW_MODIFICATIONS,()=>this._showModifications(),h.initial)]),this._cacheKeySuffix=this._getCacheKeySuffix(),this._idbCache.init().catch(e=>a.getLogger(this).warn(`Failed to initialize IndexedDB cache: ${e}`));const{view:m}=this,{viewingMode:g,renderCoordsHelper:y}=m;this._planetRadiusInGlobalMode="local"===g?0:y.referenceEllipsoid.radius}destroy(){this._clearAddTasks(),this._elevationTask=c.destroyMaybe(this._elevationTask),this.i3sOverrides=c.destroyMaybe(this.i3sOverrides),this._elevationProvider&&(this._elevationProvider.objectsChanged(this.getVisibleObbs()),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);const e=this._workerHandle;e&&(e.destroyContextAndSelf(this.uid),this._workerHandle=null),this._removeAllNodeDataFromStage(),this._memCache=c.destroyMaybe(this._memCache),this._collection=null,this._stage=null,this._edgeView=null,this._labeler=c.destroyMaybe(this._labeler),this._treeDebugger=c.destroyMaybe(this._treeDebugger),this._controller=c.destroyMaybe(this._controller),this._highlights=c.destroyMaybe(this._highlights),this._nodeId2Meta.clear(),this._nodeId2MetaReloading.clear(),this._crossfadeHelper=c.destroyMaybe(this._crossfadeHelper),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null),this._updatingHandles=c.destroyMaybe(this._updatingHandles)}_memEstimateTextureAdded(e){const t=e.usedMemory;return this._gpuMemoryEstimate+=t,this._texMemoryEstimate+=t,t}_memEstimateTextureRemoved(e){if(null!=e){const t=e.usedMemory;this._gpuMemoryEstimate-=t,this._texMemoryEstimate-=t}}_memEstimateGeometryAdded(e){const t=this._collection.getObjectGPUMemoryUsage(e);return this._gpuMemoryEstimate+=t,this._geoMemoryEstimate+=t,t}_memEstimateGeometryRemoved(e){const t=this._collection.getObjectGPUMemoryUsage(e);this._gpuMemoryEstimate-=t,this._geoMemoryEstimate-=t}isNodeLoaded(e){return this._nodeId2Meta.has(e)}isNodeReloading(e){return this._nodeId2MetaReloading.has(e)}get usedMemory(){let e=null!=this._labeler?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach(t=>e+=null!=t?t.node.memory:0),this._nodeId2MetaReloading.forEach(t=>e+=null!=t?t.node.memory:0),e}get unloadedMemory(){return(null!=this._controller?this._controller.unloadedMemoryEstimate:0)+(null!=this._labeler?this._labeler.unloadedMemoryEstimate:0)}_labelingChanged(){if(!ie.areLabelsVisible(this.i3slayer)||!this._supportsLabeling)return void(null!=this._labeler&&(this._labeler.destroy(),this._labeler=null));if(null!=this._labeler)return;const e=new J({view:this.view,layer:this.i3slayer,collection:this._collection,overrides:this.i3sOverrides,layerViewUid:this.uid});this._nodeId2Meta.forEach(t=>null!=t&&this._addMetaToLabeler(e,t)),this._labeler=e}_loadAsyncModule(e){return++this._asyncModuleLoading,e.then(e=>(--this._asyncModuleLoading,e),e=>{throw--this._asyncModuleLoading,e})}_modificationsChanged(){if(!this._i3sWasmLoaded&&this.hasModifications)return this._i3sWasmLoaded=te.initialize().then(()=>{this._i3sWasmLoaded=!0,this._modificationsChanged(),this.notifyUpdate()}),void this.notifyUpdate();if(!0!==this._i3sWasmLoaded)return;const e=e=>a.getLogger(this).error("set-modifications-error","Error when setting modifications:",e),t=this.uid,r=this.i3slayer.spatialReference,i=r.isGeographic,s=ee.toWasmModification(this._layerClippingArea,this._modifications,r);this._workerHandle.setModifications(t,s,i).catch(e);try{te.setModificationsSync({context:t,modifications:s,isGeodetic:i})}catch(t){e(t)}this._controller.modificationsChanged();const n=this.hasModifications?new u:null;this._nodeId2Meta.forEach((e,t)=>{null==e?(this._nodeId2Meta.delete(t),this._controller.updateLoadStatus(t,!1)):e.node.hasModifications?(this._updateFeatureIdCounts(e,-1),this._nodeId2Meta.delete(t),this._nodeId2MetaReloading.set(t,e)):null!=n&&n.push(e.node)}),this.notifyChange("elevationRange"),null!=n&&this._nodeId2MetaReloading.forEach(e=>n.push(e.node)),null!=n&&n.length>0&&(this.updateNodeModificationStatus(n),n.forAll(e=>{if(2!==e.imModificationImpact){const t=this._nodeId2Meta.get(e.index);this._controller.invalidateGeometryVisibility(e.index),null!=t?(this._updateFeatureIdCounts(t,-1),this._nodeId2Meta.delete(e.index),this._nodeId2MetaReloading.set(e.index,t),this.notifyChange("elevationRange")):this._nodeId2Meta.has(e.index)&&(this._nodeId2Meta.delete(e.index),this._controller.updateLoadStatus(e.index,!1))}})),this.clearMemCache(),this._controller.restartNodeLoading(),this._showModifications()}_showModifications(){if(null!=this._modificationGraphics&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),!we.debugFlags.I3S_SHOW_MODIFICATIONS||0===this._modifications.length)return;const e={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},t={outline:{color:[255,255,255],width:1}};this._modificationGraphics=[];for(const r of this._modifications){const i=r.geometry;i.spatialReference=this.i3slayer.spatialReference;const n=new Y({...t,color:e[r.type]});this._modificationGraphics.push(new s({geometry:i,symbol:n}))}this.view.graphics.addMany(this._modificationGraphics)}_addMetaToLabeler(e,t){e.addNodeMeta(t,(e,t)=>this._createAttributes(e,t))}_contentVisibleChanged(e){e?(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler)):(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler))}getLoadedAttributes(e){const t=this._nodeId2Meta.get(e);if(null!=t?.attributeInfo)return t.attributeInfo.loadedAttributes}getAttributeData(e){const t=this._nodeId2Meta.get(e);if(null!=t?.attributeInfo)return t.attributeInfo.attributeData}setAttributeData(e,t){const r=this._nodeId2Meta.get(e);null!=r?.attributeInfo&&(r.attributeInfo.attributeData=t,this._attributeValuesChanged(r))}async updateAttributes(e,t,r){const i=this._nodeId2Meta.get(e);null!=i&&(await this.i3sOverrides.applyAttributeOverrides(i.featureIds,t,r,this._controller.requiredAttributes),i.attributeInfo=t,this._controller.reschedule(()=>{this._nodeId2Meta.get(e)===i&&this._attributeValuesChanged(i)},r).catch(e=>{d.isAbortError(e)||a.getLogger(this).warn("Error while updating attribute values. Layer might not display correctly.",e)}))}_attributeValuesChanged(e){e.cachedRendererVersion=this._getInvalidRendererVersion(),e.appliedFilters=null,null!=this._labeler&&this._labeler.setNodeMetaAttributes(e,(e,t)=>this._createAttributes(e,t)),this._updateEngineObject(e)}clearMemCache(){null!=this._memCache&&this._memCache.clear(),this._addTasks.forEach(e=>e.allowMemCache=!1)}getVisibleNodes(){const e=new Array;return this._nodeId2Meta.forEach(t=>null!=t&&e.push(t.node)),e}getVisibleObbs(){const e=new Array;return this._nodeId2Meta.forEach(t=>t&&e.push(this._collection.getComponentObb(t.objectHandle))),e}getLoadedNodeIndices(e){this._nodeId2Meta.forEach((t,r)=>e.push(r)),this._nodeId2MetaReloading.forEach((t,r)=>e.push(r))}_preLoadBasis(){!o("disable-feature:i3s-basis")&&2&this.supportedTextureEncodings&&this.i3slayer.textureSetDefinitions?.some(e=>e.formats.some(e=>"basis"===e.format||"ktx2"===e.format))&&Fe.loadBasisTranscoder()}_getVertexBufferLayout(e,t){return Pe.glLayout(Re.createVertexBufferLayout(this._getGeometryParameters({hasTexture:Ge(e.params.material),hasNormals:t.normal,hasRegions:t.uvRegion})))}_getObjectIdField(){return this.i3slayer.objectIdField||z.fallbackObjectIDAttribute}_getGlobalIdField(){return this.i3slayer.globalIdField}_findGraphicNodeAndIndex(e){const t=_e.attributeLookup(this.i3slayer.fieldsIndex,e.attributes,this._getObjectIdField());for(const e of this._nodeId2Meta.values()){const r=e?.featureIds.indexOf(t);if(null!=r&&r>=0)return{node:e.node,index:r}}return null}_getGraphicIndices(e,t){const r=this._nodeId2Meta.get(e.index);if(null==r)return[];const i=[],s=this._getObjectIdField(),n=this.i3slayer.fieldsIndex;for(const e of t){const t=_e.attributeLookup(n,e.attributes,s),o=r.featureIds.indexOf(t);-1!==o&&i.push(o)}return i}whenGraphicBounds(e){const t=this._findGraphicNodeAndIndex(e);if(!t)return Promise.reject();const r=this.getAABB(t.node.index,t.index);return null==r?Promise.reject():Promise.resolve({boundingBox:r,screenSpaceObjects:[]})}getAABBFromIntersectorTarget(e){return null==e.nodeIndex||null==e.componentIndex?null:this.getAABB(e.nodeIndex,e.componentIndex)}getAABB(e,t){const r=this._nodeId2Meta.get(e);if(null==r?.featureIds||t>=r.featureIds.length)return null;const i=r.objectHandle,s=le.boundingBoxCornerPoints(t,this._collection,i,V.newDoubleArray(24),0),n=this.view.renderSpatialReference,o=this.view.spatialReference;return F.projectBuffer(s,n,0,s,o,0)?E.fromBuffer(s):null}whenGraphicAttributes(e,t){return pe.whenGraphicAttributes(this.i3slayer,e,this._getObjectIdField(),t,()=>[...this._nodeId2Meta.values()].filter(n.isSome))}getGraphicFromIntersectorTarget(t,r){if(null==t.nodeIndex||null==t.componentIndex)return null;const i=this._nodeId2Meta.get(t.nodeIndex);if(null==i?.featureIds||t.componentIndex>=i.featureIds.length)return null;const s=this._createLayerGraphic(this._createAttributes(t.componentIndex,i));return r.defer?(r.defer(async()=>(s.geometry=(await new Promise((t,r)=>e(["./i3s/meshUtils"],t,r))).createMesh({layerView:this,nodeIndex:t.nodeIndex,featureIndex:t.componentIndex}),s)),null):s}_getCacheKey(e){return`${this._layerUrl}/v26/${e}${this._cacheKeySuffix}`}_getCacheKeySuffix(){const e=this.view.renderSpatialReference;return null==e?"@null":e===R.getSphericalPCPF(e)?"@ECEF":this.i3slayer.spatialReference.equals(e)?"":null!=e.wkid?`@${e.wkid}`:null}_getMemCacheKey(e,t=this.elevationOffset){return e+"#"+t}get _idbCacheEnabled(){return!this._controller.disableIDBCache&&!this.hasModifications&&0===this.elevationOffset&&null!=this._cacheKeySuffix}loadCachedGPUData(e){return null!=this._memCache?this._memCache.pop(this._getMemCacheKey(e)):null}deleteCachedGPUData(e){null!=e&&this._deleteComponentObject(e)}_cacheGPUData(e,t=this.elevationOffset){if(null==this._memCache)return void this._deleteComponentObject(e);const r=this._controller.indexDepth-e.node.level;this._memCache.put(this._getMemCacheKey(e.node.index,t),e,r)}loadMissingTextures(e,t,r,i){const s=e?.filter((e,r)=>{if(0===(e.usage&this.rendererTextureUsage))return!1;if(null==t)return!0;const i=ue.selectEncoding(e.encodings,this.supportedTextureEncodings),s=t[r];return!!(null==s?.data||i&&s.encoding!==i.encoding)})??[];return 0===s.length?Promise.resolve(!1):r(s,i).then(r=>{let i=0;for(let s=0;s<e.length;s++)i<r.length&&r[i].id===e[s].id&&(t[s]=r[i],i++);return!0})}loadCachedNodeData(e,t,r){return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(e.id),t).then(i=>null==i?null:(i.globalTrafo=V.ensurePackedArray(i.globalTrafo),i.nodeVersion!==e.version?(this._idbCache.remove(this._getCacheKey(e.id)),null):(0===this.elevationInfo.mode&&(e.geometryObbInRenderSR=Te.Obb.fromData(i.geometryObbData)),this.loadMissingTextures(i.requiredTextures,i.textureData,r,t).then(r=>(r&&this._idbCache.initialized&&null!=i.textureData&&(i.byteSize=He(i.transformedGeometry,i.textureData),i.textureData.every(qe)&&this._indexedDbSizeCheck(e,i)&&this._idbCache.put(this._getCacheKey(e.id),i).catch(t=>a.getLogger(this).warn(`Failed to update node with textures in IndexedDB cache: ${e.id}: ${t}`))),d.throwIfAborted(t),i))))):Promise.resolve(null)}addNode(e,t,r){return function(e){return"geometryData"in e}(t)?null==t.geometryBuffer?(this._addNodeMeta(e.index,null),Promise.resolve()):this._addData(e,t.attributeDataInfo,()=>this._transformNode(e,t,r).then(i=>this._safeReschedule(()=>{if(null==i)return e.hasModifications=!1,this._addCachedNodeData(e,null,r);e.hasModifications=i.transformedGeometry.hasModifications;const{obb:s,componentOffsets:n,featureIds:o,anchorIds:l,anchors:c,transformedGeometry:u}=i,d=V.ensurePackedArray(i.globalTrafo),h=S.set(Ze,s.center.x,s.center.y,s.center.z);S.transformMat4(h,h,d);const p=new Te.Obb(h,[s.extents.x,s.extents.y,s.extents.z],x.fromValues(s.orientation.x,s.orientation.y,s.orientation.z,s.orientation.w));0===this.elevationInfo.mode&&(e.geometryObbInRenderSR=p),t.geometryData.componentOffsets=n,o&&(t.geometryData.featureIds=Array.from(o)),t.geometryData.anchorIds=l,t.geometryData.anchors=c;const f={nodeVersion:e.version,geometryData:t.geometryData,requiredTextures:t.requiredTextures,textureData:t.textureData,transformedGeometry:u,globalTrafo:d,geometryObbData:p.data,byteSize:He(u,t.textureData)};if(this._idbCacheEnabled&&this._idbCache.initialized&&this._indexedDbSizeCheck(e,f)){const t=null!=f.textureData?f.textureData.map(e=>qe(e)?e:null):null;this._idbCache.put(this._getCacheKey(e.id),{...f,textureData:t}).catch(t=>a.getLogger(this).warn(`Failed to store node in IndexedDB cache: ${e.id}: ${t}`))}return this._addCachedNodeData(e,f,r)},r))):Promise.reject()}getElevationRange(e){const t=new xe.ElevationRange,r=this._controller,{index:i}=r;if(!i)return t;const{rootNode:s}=i;if(!s)return t;const n=this._nodeId2Meta,o=e[3],a=r.viewportQueries,l=this._planetRadiusInGlobalMode,{view:c}=this,{renderCoordsHelper:u}=c,d=u.referenceEllipsoid.radius,h=this._collection;return i.traverse(s,r=>{const{childrenLoaded:i}=r;if(0===i)return!1;const s=a.getAndUpdateVisibilityObbInRenderSR(r);let c=null,p=-1;if(s){if(p=s.radius,!s.intersectSphereWithMBS(e,p))return!1}else c=a.getServiceMbsInRenderSR(r),c&&(p=c[3]);if(p>=0&&o>=1*p)return null!=s?et(t,s,l):null!=c&&c[3]>=0&&tt(t,c,l),!1;const f=Ke;if(f.elevationRangeMin=1/0,f.elevationRangeMax=-1/0,(null!=s||null!=c)&&(null!=s?et(f,s,l):null!=c&&tt(f,c,l),f.elevationRangeMin>=t.elevationRangeMin&&f.elevationRangeMax<=t.elevationRangeMax))return!1;const m=n.get(r.index);if(m){const{geometryObbInRenderSR:i}=r;if(!i||i.intersectSphereWithMBS(e)){if(i&&o>0*i.radius)return et(t,i,l),!1;const{objectHandle:e}=m,r=h.getObjectTransform(e),s=u.getAltitude(r.position);h.expandRangeWithComponentObjectElevationRange(e,s,d,t)}}return i-(m?1:0)>0}),t}computeVisibilityObb(e){return pe.computeVisibilityObb(e,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications,this.view.renderCoordsHelper.sphericalPCPF)}_transformNode(e,t,r){const i=t.geometryData.geometries??[],s=new Array(i.length);for(let e=0;e<i.length;++e)s[e]=this._getVertexBufferLayout(i[e],t.geometryDescriptor);const n=this.i3slayer.normalReferenceFrame,o=t.normalReferenceFrame??n??"none",a=e.serviceMbsInIndexSR,l=this.elevationOffset,c=this._controller.crsIndex,u=this._controller.crsVertex,d=this.view.renderSpatialReference,h=he.computeGlobalTransformation(a,l,o,c,d),p=A.getProjectorName(c,u),f=A.getProjectorName(u,d);if(null==p||null==f)return Promise.resolve(null);const m={context:this.uid,geometryBuffer:t.geometryBuffer,geometryData:t.geometryData,geometryDescriptor:t.geometryDescriptor,layouts:s,globalTrafo:h,mbs:a,obbData:e.serviceObbInIndexSR?.data,elevationOffset:l,needNormals:this._controller.isMeshPyramid,normalReferenceFrame:o,indexToVertexProjector:p,vertexToRenderProjector:f};return this._workerHandle.invoke(m,r)}get _supportsNodeCrossFading(){return!this.view?.stage?.renderer.shadowsEnabled}get nodeCrossfadingEnabled(){return this._supportsNodeCrossFading&&(this.lodCrossfadeinDuration>0||this.lodCrossfadeoutDuration>0||this.lodCrossfadeUncoveredDuration>0)}get nodeFadeoutEnabled(){return this._supportsNodeCrossFading&&this.lodCrossfadeoutDuration>0}_setNewNodeOpacity(e){const t=this.nodeCrossfadingEnabled?0:this.fullOpacity;this._setNodeOpacity(e,t)}addCachedGPUData(e,t,r){if(0===this.elevationInfo.mode&&(e.geometryObbInRenderSR=this._collection.getComponentObb(t.objectHandle).clone()),!this._controller.isGeometryVisible(e))return void this._cacheGPUData(t);null!=this._labeler&&this._addMetaToLabeler(this._labeler,t);const i=e.index;this._addNodeMeta(i,t),this.updateNodeState(i,r),this._collection.setObjectVisibility(t.objectHandle,!0),this._updateMaterial(t),this._setNewNodeOpacity(t),0!==this.elevationInfo.mode&&this._ensureElevationTask().schedule(i),this._updateEngineObject(t),this._highlights?.objectCreated(t),null!=this._treeDebugger&&this._treeDebugger.update()}addCachedNodeData(e,t,r,i){return this._addData(e,r,()=>this._addCachedNodeData(e,t,i))}async deleteCachedNodeData(e){if(this._idbCacheEnabled)return this._idbCache.remove(this._getCacheKey(e))}async _addCachedNodeData(e,t,r){if(!this.contentVisible||!this._controller.isGeometryVisible(e))return void this._removeNodeStageData(e.index,this.elevationOffset,this._nodeId2MetaReloading);if(null==t)return void this._addNodeMeta(e.index,null);const i=this._addTasks.get(e.index),{geometryData:s,transformedGeometry:n,globalTrafo:l}=t;await this.i3sOverrides.applyAttributeOverrides(s.featureIds,i.attributeInfo,r,this._controller.requiredAttributes);const c=null!=t.textureData?t.textureData.filter(e=>null!=e&&0!==(e.usage&this.rendererTextureUsage)):[];!o("disable-feature:i3s-basis")&&c.some(e=>null!=e&&(2===e.encoding||1===e.encoding))&&await Fe.loadBasisTranscoder(),e.memory=0;const{componentOffsets:u,geometries:d,featureIds:h,anchorIds:p,anchors:f}=s,m=this._collection,g=d[0],{layout:y,indices:x,interleavedVertexData:C,positionData:M,hasColors:R}=n,{material:I,geometryParameters:F}=this._materialParameters(g,y),A=u||new Uint32Array([0,x?x.length:C.byteLength/y[0].stride]),E={vertices:{data:C,count:C.byteLength/y[0].stride,layoutParameters:F},positionData:{positions:U.compactFloatArray(M.data),indices:B.compactIndices(M.indices)},indices:x,componentOffsets:A},L=g.transformation?w.clone(g.transformation):w.create();v.multiply(L,l,L);const V=v.getTranslation(T.create(),L),N=_.fromMat4(b.create(),L),k=this.view.renderSpatialReference,z=this.view.basemapTerrain.spatialReference,j=Te.Obb.fromData(t.geometryObbData).center,G=[1,1,1];O.localLinearScaleFactors(j,k,G,z)||a.getLogger(this).errorOnce("Unsupported coordinate system for IM overlay");const q=T.create();D.projectVectorToVector(j,k,q,z);const H=b.create();_.invert(H,N);const W=T.create();S.transformMat3(W,S.sub(W,j,V),H);const $=q[0]-W[0]*G[0],Q=q[1]-W[1]*G[1],Z=m.createObject(new Me.ObjectParameters(P.fromValues($,Q,G[0],G[1]),new Oe.Transform(V,N),Te.Obb.fromData(t.geometryObbData),E)),Y=2===F.textureCoordinateType,{textures:X,texturePromise:J}=this._initMaterialAndTextures(Z,I,c,Y,e);e.memory+=this._memEstimateGeometryAdded(Z),e.memory+=X.reduce((e,t)=>e+(null!=t?this._memEstimateTextureAdded(t):0),0);const K=!!I.hasParametersFromSource,ee="blend"!==I.alphaMode&&I.metallicRoughness.baseColorFactor[3]>=1,te=new Ve(e,h,Z,this._getInvalidRendererVersion(),i.attributeInfo,{hasParametersFromSource:K,isOpaque:ee},X,p,f);i.meta=te,this._hasTextures||=t.requiredTextures?.some(({usage:e})=>!!(19&e))||!!e.resources.texture,this._hasData=!0,this._hasColors||=R,this.notifyChange("hasTexturesOrVertexColors");const re=this.slicePlaneEnabled;return Promise.all([this._addOrUpdateEdgeRendering(te),J]).then(([t,i])=>(this._addTasks.has(e.index)&&t?.updateObjectVisibility(te.objectHandle,!1).catch(e=>this._logEdgeViewError(e,this.i3slayer.title)),this._safeReschedule(()=>{const r=this._addTasks.get(e.index);if(!r)return;if(this._addNodeMeta(e.index,te),r.meta=null,!this.contentVisible)return void this._removeNodeStageData(e.index,this.elevationOffset);m.setObjectVisibility(Z,!0),t?.updateObjectVisibility(te.objectHandle,!0).catch(e=>this._logEdgeViewError(e,this.i3slayer.title)),te.attributeInfo=r.attributeInfo;const i=te.cachedRendererVersion!==this._rendererVersion,s=re!==this.slicePlaneEnabled;this._updateElevationOffsets(te);const n=te.elevationOffsets;this._updateComponentData(te);const o=this._applyFiltersToNode(te);(i||null!=t&&(s||o||n))&&this._addOrUpdateEdgeRendering(te),null!=this._labeler&&this._addMetaToLabeler(this._labeler,te),this._visibleGeometryChanged(te,0),this._highlights?.objectCreated(te),this._updateMaterial(te),this._setNewNodeOpacity(te),null!=this._treeDebugger&&this._treeDebugger.update()},r))).catch(e=>{const{meta:t,allowMemCache:r}=i;throw i.meta=null,t&&r?this._cacheGPUData(t):t&&this._deleteComponentObject(t),e})}_addNodeMeta(e,t){if(this._removeNodeStageData(e,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(e)){a.getLogger(this).error("Removing duplicated node");const t=this._nodeId2Meta.get(e);t&&(this._deleteComponentObject(t),this._updateFeatureIdCounts(t,-1))}else this._controller.updateLoadStatus(e,!0);t&&(t.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&$e(t.cachedEdgeMaterials,0),this._updateFeatureIdCounts(t,1)),this._nodeId2Meta.set(e,t),this.notifyChange("elevationRange")}_updateElevationOffsets(e){const t=this.view.renderSpatialReference,r=this._controller.crsIndex,i=this.elevationInfo,s=this.view.basemapTerrain,n=s.spatialReference,o=i.mode;if(null==t||null==n||0===o)return void(e.elevationOffsets=null);const a=this._collection.getObjectTransform(e.objectHandle);e.elevationOffsets=e.elevationOffsets??[];const l=Ze,c=Ye,u=2===o,d=this.view.renderCoordsHelper,h=e.featureIds.length,p=(()=>{if(e.cachedElevationAnchors)return e.cachedElevationAnchors;const i=V.newDoubleArray(3*h);e.cachedElevationAnchors=i;for(let s=0;s<h;s++){const o=3*s,u=e.anchorIds?.indexOf(s)??-1;e.anchors&&u>=0?(S.set(l,e.anchors[3*u],e.anchors[3*u+1],e.anchors[3*u+2]),S.add(l,l,N.getCenter(e.node.serviceMbsInIndexSR)),D.projectVectorToVector(l,r,l,n),i[o]=l[0],i[o+1]=l[1],i[o+2]=d.getAltitude(l)):(this._collection.getComponentAabb(e.objectHandle,s,c,!0),S.set(l,(c[0]+c[3])/2,(c[1]+c[4])/2,c[2]),S.transformMat3(l,l,a.rotationScale),S.add(l,l,a.position),i[o+2]=d.getAltitude(l),D.projectVectorToVector(l,t,l,n),i[o]=l[0],i[o+1]=l[1])}return i})(),f=i.offset,m=e.elevationOffsets;s.getElevations(p,h,(e,t)=>{const r=u?p[3*e+2]:0;m[e]=f+(t??0)-r})}_ensureElevationTask(){return null!=this._elevationTask||(this._elevationTask=new ne.I3SAsyncElevationUpdater(this.view.resourceController.scheduler,e=>this._controller.updateElevationChanged(e,this.view.basemapTerrain.spatialReference)?.filterInPlace(e=>null!=this._nodeId2Meta.get(e)),e=>this._nodeElevationAlignmentChanged(this._nodeId2Meta.get(e)),()=>this.elevationInfo?.mode)),this._elevationTask}_elevationInfoChanged(e,t){const r=0!==e.mode,i=!!t&&t!==e&&0!==t.mode;this._intersectionHandler.updateElevationAlignState(r,this.view.state.viewingMode),r&&!i&&this._controller.removeAllGeometryObbs(),this._nodeId2Meta.forEach(e=>this._nodeElevationAlignmentChanged(e))}_nodeElevationAlignmentChanged(e){null!=e&&(this._updateElevationOffsets(e),this._updateComponentData(e),this._updateEdgeRendering(e),null!=this._labeler&&this._labeler.updateLabelPositions(e),this._updateSnappingSources(e,2),this._elevationProvider.objectChanged(this._collection.getComponentObb(e.objectHandle)))}_safeReschedule(e,t){return d.throwIfAborted(t),this._controller.reschedule(e,t)}_materialParameters(e,t){const r=null!=e.params.material?e.params.material:ue.defaultMaterial(),i=t.some(e=>"uvRegion"===e.name),s=t.some(e=>"normalCompressed"===e.name),n=Ge(r);return{geometryParameters:this._getGeometryParameters({hasTexture:n,hasNormals:s,hasRegions:i}),material:r}}_initMaterialAndTextures(e,t,r,i,s){const n=this._stage.renderView,o=e=>{this._gpuMemoryEstimate-=e,this._texMemoryEstimate-=e,s.memory-=e},a=r.map(e=>ue.createTexture(e,t,i,n,this._compressionTracker,o));this._stage.addTextures(a);let l=null;return this._collection.updateMaterial(e,e=>{l=ue.configureMaterial(e,t,a,r,this.view.stage.renderView.textures,{rendererTextureUsage:this.rendererTextureUsage,usePBR:this._usePBR,isIntegratedMesh:this._isIntegratedMesh,slicePlaneEnabled:this.slicePlaneEnabled,viewSpatialReference:this.view.spatialReference}),this._updateMaterialOverlay(e)}),{textures:a,texturePromise:l}}_getGeometryParameters(e){return new Re.GeometryParameters(this._hasVertexColors,e.hasTexture?e.hasRegions?2:1:0,e.hasNormals,this._shadeNormals,this._applySSAO)}_addData(e,t,r){let i=this._addTasks.get(e.index);if(i)i.attributeInfo=t;else{const s=d.createResolver();i=new We(t,null,s.promise),this._addTasks.set(e.index,i),r().then(s.resolve,s.reject).then(()=>this._addTasks.delete(e.index)).catch(t=>{throw this._addTasks.delete(e.index),t})}return i.promise}_clearAddTasks(){this._addTasks.forEach(e=>{null!=e.meta&&(this._cacheGPUData(e.meta),e.meta=null)}),this._addTasks.clear()}_clippingAreaChanged(){const e=this.view.renderSpatialReference,t=this.i3slayer.spatialReference,r=L.create();this._renderClippingArea=Se.toBoundingRect(this.view.clippingArea,r,e)?r:null;const i=L.create();this._layerClippingArea=Se.toBoundingRect(this.view.clippingArea,i,t)?i:null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea),this._isIntegratedMesh&&this._modificationsChanged()}get hasGeometryFilter(){return!1}_geometryFilterChange(){const e=this.hasGeometryFilter;this._controller.geometryFilterChanged(e),this._applyFilters(e),this._assertFeatureIdNodeCounts(e)}_assertFeatureIdNodeCounts(e){e&&!this._featureIdCounts?(this._featureIdCounts=st(this._nodeId2Meta.values()),this._filteredIdCounts=st(this._nodeId2Meta.values(),1),this._weaklyRemovedIdCounts=st(this._nodeId2Meta.values(),2),this.addHandles(h.watch(()=>this._controller.updating,e=>{!e&&this._needFilterResolve&&(this.multiGeometryFilterResolve(),this._needFilterResolve=!1,this.notifyUpdate())},{sync:!0}),"updateFinished")):!e&&this._featureIdCounts&&(this._featureIdCounts=null,this._filteredIdCounts=null,this._weaklyRemovedIdCounts=null,this._mismatchShow=null,this._mismatchHide=null,this.removeHandles("updateFinished"),this._needFilterResolve=!1,this.notifyUpdate())}_updateFeatureIdCounts(e,t){this._featureIdCounts&&(this._needFilterResolve=!0,it(this._featureIdCounts,e.featureIds,t),it(this._filteredIdCounts,e.filteredIds,t),it(this._weaklyRemovedIdCounts,e.weaklyRemovedIds,t))}_updateFilteredIdCounts(e,t,r){this._filteredIdCounts&&(this._needFilterResolve=!0,it(this._filteredIdCounts,t,-1),it(this._filteredIdCounts,e.filteredIds,1),it(this._weaklyRemovedIdCounts,r,-1),it(this._weaklyRemovedIdCounts,e.weaklyRemovedIds,1))}_checkFeatureIdNodeCountInvariant(){const e=null!=this._featureIdCounts;if(this.hasGeometryFilter!==e&&a.getLogger(this).error("checkFeatureIdNodeCountInvariant()","LayerView should have feature id node counts if and only if it has a geometry filter",{layerView:this,hasNodeCounts:e}),!this._featureIdCounts||!this._filteredIdCounts)return;const t=st(this._nodeId2Meta.values());l.equals(this._featureIdCounts,t)||a.getLogger(this).error("checkFeatureIdNodeCountInvariant()","Incorrect _featureIdCounts",{layerView:this,counts:this._featureIdCounts,expected:t});const r=st(this._nodeId2Meta.values(),1);l.equals(this._filteredIdCounts,r)||a.getLogger(this).error("checkFeatureIdNodeCountInvariant()","Incorrect _filteredIdCounts",{layerView:this,counts:this._filteredIdCounts,expected:r});const i=st(this._nodeId2Meta.values(),2);l.equals(this._weaklyRemovedIdCounts,i)||a.getLogger(this).error("checkFeatureIdNodeCountInvariant()","Incorrect _weaklyRemovedIdCounts",{layerView:this,counts:this._weaklyRemovedIdCounts,expected:r})}multiGeometryFilterResolve(){if(!this._featureIdCounts||!this._filteredIdCounts)return;let e=null,t=null;for(const[r,i]of this._filteredIdCounts){const s=this._featureIdCounts.get(r);s!==i&&(i+(this._weaklyRemovedIdCounts?.get(r)??0)===s?(e??=new Set,e.add(r)):(t??=new Set,t.add(r)))}f.equals(e,this._mismatchShow)&&f.equals(t,this._mismatchHide)||(this._mismatchShow=e,this._mismatchHide=t,this._nodeId2Meta.forEach(e=>{if(!e?.filteredIds)return;const t=rt(e,this._mismatchShow,this._mismatchHide);this._collection.setAllComponentVisibilities(e.objectHandle,t),this._visibleGeometryChanged(e,2)}))}_filterChange(){this._applyFilters(this.hasGeometryFilter)}_applyFilters(e){this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(e=>{e&&this._applyFiltersToNode(e)&&(this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e,2))})}getFilters(){const e=[],t=this._renderClippingArea;return null!=t&&e.push((e,r)=>this._boundingRectFilter(e,r,t)),e}addSqlFilter(e,t,r){if(null!=t){const i=t.fieldNames;e.push((e,s)=>this._sqlFilter(e,s,t,i,r))}}_sqlFilter(e,t,r,i,s){const n={},o=this._createLayerGraphic(n),a=this.i3slayer.objectIdField,l=t.featureIds,c=t.attributeInfo?.attributeData;i.every(e=>e===a||null!=c?.[e])&&pe.filterInPlace(e,l,e=>{n[a]=l[e];for(const t of i)t!==a&&(n[t]=c?oe.getCachedAttributeValue(c[t],e):null);try{return r.testFeature(o)}catch(e){return s(e),!1}})}_boundingRectNodeTest(e,t){return I.projectBoundingSphere(e.node.serviceMbsInIndexSR,this._controller.crsIndex,je,this.view.renderSpatialReference),pe.intersectBoundingRectWithMbs(t,je)}_boundingRectFeatureTest(e,t,r){return this._collection.getComponentAabb(e.objectHandle,t,Ue),E.toRect(Ue,Be),L.intersects(r,Be)}_boundingRectFilter(e,t,r){const i=this._collection,s=this._boundingRectNodeTest(t,r);if(3===s)return;if(0===s)return void(e.length=0);const n=i.getComponentCount(t.objectHandle);if(n.invisible+n.visible!==t.featureIds.length)return;const o=this._transformClippingArea(Ne,r,t.objectHandle);pe.filterInPlace(e,t.featureIds,e=>this._boundingRectFeatureTest(t,e,o))}_transformClippingArea(e,t,r){const i=this._collection.getObjectTransform(r),s=i.position,n=i.rotationScale;return e[0]=(t[0]-s[0])/n[0],e[1]=(t[1]-s[1])/n[4],e[2]=(t[2]-s[0])/n[0],e[3]=(t[3]-s[1])/n[4],e}async _addOrUpdateEdgeRendering(e,t=!0){const r=e.objectHandle,{hasEdges:i,perFeatureEdgeMaterials:s}=this._getFilteredEdgeMaterials(e);i&&!this._edgeView&&(this._edgeView=await this._stage.renderer.loadEdgeView());const n=this._edgeView;if(!n)return null;const o=n.hasObject(r);if(i){if(o)return this.nodeCrossfadingEnabled&&$e(s,this.getNodeOpacity(e)),n.updateAllComponentMaterials(r,s,this.slicePlaneEnabled,t).catch(e=>this._logEdgeViewError(e,this.i3slayer.title)),n.updateObjectVisibility(r,!0).catch(e=>this._logEdgeViewError(e,this.i3slayer.title)),n.updateAllVerticalOffsets(r,e.elevationOffsets).catch(e=>this._logEdgeViewError(e,this.i3slayer.title)),n;const i=await this._collection.addEdges(r,n,s,this.slicePlaneEnabled,e.elevationOffsets);return e.edgeMemoryUsage=i,e.node.memory+=i,n}return o&&(e.node.memory-=e.edgeMemoryUsage,e.edgeMemoryUsage=0,n.removeObject(r)),null}_applyFiltersToNode(e){const{filteredIds:t,weaklyRemovedIds:r}=e,i=this._applyFiltersToNodeComponents(e);return this._updateFilteredIdCounts(e,t,r),i&&this._labeler?.applyFilterChange(e),i}_applyFiltersToNodeComponents(e){const t=this._collection,r=t.getComponentCount(e.objectHandle),i=null!=e.filteredIds,s=0===r.invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!s;if(null!=e.filteredIds&&e.appliedFilters===this._filters||(e.weaklyRemovedIds=null,e.filteredIds=function(e,t){const r=e.featureIds.slice();for(const i of t)if(i(r,e),0===r.length)break;return r.length===e.featureIds.length?e.featureIds:r}(e,this._filters),e.appliedFilters=this._filters),i&&e.filteredIds===e.featureIds&&(!this._mismatchHide||e.filteredIds.every(e=>!this._mismatchHide?.has(e))))return!s;const n=rt(e,this._mismatchShow,this._mismatchHide);return t.setAllComponentVisibilities(e.objectHandle,n),!0}_removeAllNodeDataFromStage(e=this.elevationOffset){this._nodeId2Meta.forEach((t,r)=>this._removeNodeStageData(r,e)),this._nodeId2MetaReloading.forEach((t,r)=>this._removeNodeStageData(r,e,this._nodeId2MetaReloading)),this._elevationTask=c.destroyMaybe(this._elevationTask)}removeNode(e){const t=this.elevationOffset;this._removeNodeStageData(e,t),this._removeNodeStageData(e,t,this._nodeId2MetaReloading),null!=this._elevationTask&&this._elevationTask.remove(e)}_removeNodeStageData(e,t,r=this._nodeId2Meta){r.has(e)&&this._controller.updateLoadStatus(e,!1);const i=r.get(e);null!=i?(this._collection.setObjectVisibility(i.objectHandle,!1),null!=this._edgeView&&this._edgeView.hasObject(i.objectHandle)&&this._edgeView.updateObjectVisibility(i.objectHandle,!1).catch(e=>this._logEdgeViewError(e,this.i3slayer.title)),this._visibleGeometryChanged(i,1),null!=this._labeler&&this._labeler.removeNodeMeta(i),r.delete(e),this._highlights?.objectDeleted(i),r===this._nodeId2Meta?(this._updateFeatureIdCounts(i,-1),this._cacheGPUData(i,t),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(i)):this._deleteComponentObject(i),null!=this._treeDebugger&&this._treeDebugger.update()):r.delete(e)}_deleteComponentObject(e){if(null!=this._edgeView&&this._edgeView.removeObject(e.objectHandle),this._memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures)for(const t of e.textures)this._memEstimateTextureRemoved(t),this._stage.removeTexture(t)}updateNodeState(e,t){const r=this._nodeId2Meta.get(e);null!=r&&this._collection.updateMaterial(r.objectHandle,e=>e.polygonOffsetEnabled=0===t)}updateNodeIndex(e,t){if(this._nodeId2Meta.has(e)){const r=this._nodeId2Meta.get(e);this._nodeId2Meta.delete(e),this._nodeId2Meta.set(t,r),this.notifyChange("elevationRange")}const r=this._nodeId2MetaReloading.get(e);r&&(this._nodeId2MetaReloading.delete(e),this._nodeId2MetaReloading.set(t,r))}_invalidateAllSymbols(){this._rendererVersion=pe.addWraparound(this._rendererVersion,1),this._controller?.requestUpdate()}_getInvalidRendererVersion(){return pe.addWraparound(this._rendererVersion,-1)}async _rendererChange(e){if(this._currentRenderer=e,this.notifyChange("rendererTextureUsage"),this._rendererVersion=pe.addWraparound(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),e&&(this._rendererFields=await e.getRequiredFields(this.i3slayer.fieldsIndex)),this._updateSymbologyFields(),!this._arcade&&e&&"arcadeRequired"in e&&e.arcadeRequired&&(this._arcade=await Q.loadArcade()),e&&"visualVariables"in e&&e.visualVariables)for(const t of e.visualVariables)"color"===t.type?this._colorVariable=t:"opacity"===t.type?this._opacityVariable=t:a.getLogger(this).warn(`Unsupported visual variable type for 3D Object Scene Services: ${t.type}`);if(e)for(const t of e.symbols)"mesh-3d"!==t.type&&a.getLogger(this).error(`Symbols of type '${t.type}' are not supported for 3D Object Scene Services.`);this._controller&&this._controller.requestUpdate()}_getCachedEdgeMaterials(e){return this._hasComponentData&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials}_getComponentParameters(e){this._hasComponentData&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);const t=e.cachedSymbology;return(r,i)=>{const s=r*e.cachedSymbologyStride;C.set(i.externalColor,t[s]/255,t[s+1]/255,t[s+2]/255,t[s+3]/255);const n=this._stage.renderView.olidRenderHelper;if(n){const t=e.featureIds[r],s=this.sublayerId?`${this.layerViewUid}_${this.sublayerId}`:this.layerViewUid,o=W.isBasemapLayerView(this.view,this.uid);n.setUidToObjectAndLayerId(t,t,this.layerId,s,this.layerPopupEnabledAndHasTemplate&&!o,e.node.resources.attributes,r,this.sublayerId),i.olidColor=n.getObjectAndLayerIdColor({graphicUid:t,layerViewUid:s})}i.externalColorMixMode=15&t[s+4],i.castShadows=!!(16&t[s+4]),i.pickable=!!(32&t[s+4]),i.elevationOffset=e.elevationOffsets?.[r]??0,i.emissiveStrength=e.emissiveStrengths?.[r]??1,i.emissiveSource=e.emissiveSources?.[r]??0}}_getSymbolInfo(e,t){const r=e?.getSymbol(t,{arcade:this._arcade});if(!(r instanceof Z))return null;const i=r.id;if(this._symbolInfos.has(i))return this._symbolInfos.get(i);const s=pe.getSymbolInfo(r);return this._symbolInfos.set(i,s),s}_setSymbologyOverride(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())}_updateSymbologyFields(){this._symbologyFields=null!=this._symbologyOverrideFields&&this._symbologyOverrideFields.length>0?null!=this._rendererFields&&this._rendererFields.length>0?G.fixFields(this.i3slayer.fieldsIndex,[...this._rendererFields,...this._symbologyOverrideFields]):this._symbologyOverrideFields:this._rendererFields}_updateCachedRendererData(e){if(e.cachedRendererVersion=this._rendererVersion,!this._hasComponentData)return;const t=this._tmpAttributeOnlyGraphic,r={};t.attributes=r;const i=this._currentRenderer,s=e.attributeInfo?.attributeData,n=e.featureIds?this.i3slayer.objectIdField:null,o=null!=s&&null!=this._symbologyFields&&this._symbologyFields.length>0;let a=null,l=null;if(o&&null!=this._symbologyFields){a=[],l=[];for(const e of this._symbologyFields){const t=s[e];t&&(a.push(e),l.push(t))}}e.cachedSymbology||(e.cachedSymbology=k.newUByteArray(e.featureIds.length*e.cachedSymbologyStride));const c=new ye.SymbologyInfo,u=this.fullOpacity,d=this.nodeCrossfadingEnabled?this.getNodeOpacity(e):u;let h=null,p=1,f=pe.transparentEdgeMaterial,m=0;for(let s=0;s<e.featureIds.length;s++){if(null!=n&&(r[n]=e.featureIds[s]),o&&a)for(let e=0;e<a.length;e++)r[a[e]]=oe.getCachedAttributeValue(l[e],s);const u=i?this._getSymbolInfo(i,t):null;let g,y;if(c.pickable=!0,i&&"visualVariables"in i){if(this._colorVariable){const e=H.getColor(this._colorVariable,t,{color:ze,arcade:this._arcade});e&&(g=c.color,g[0]=e.r/255,g[1]=e.g/255,g[2]=e.b/255,g[3]=e.a??1,this._opacityVariable||null===e.a||(y=e.a))}this._opacityVariable&&(y=H.getOpacity(this._opacityVariable,t,{arcade:this._arcade}))}if(u?.material){const e=u.material;g=null==g||null==y?re.overrideColor(g,y,e.color,e.alpha,Le,c.color):re.overrideColor(g,y,null,null,Le,c.color)}g??=C.set(c.color,1,1,1,1);const _=u?.material;if(c.colorMixMode=_?.colorMixMode??1,c.edgeMaterial=u?.edgeMaterial,this._symbologyOverride?.(t,c),null!=this._nodeColorOverride&&(this._nodeColorOverride(e.node,g),c.colorMixMode=3),c.pickable&&=g[3]>=Ee.alphaCutoff,c.castShadows=u?u.castShadows:c.pickable,null!=c.edgeMaterial){const t=g[3]>=1&&(e.material.isOpaque||3===c.colorMixMode)?1:0;c.edgeMaterial===h&&t===p||(f={...c.edgeMaterial,opacity:d,objectTransparency:t},h=c.edgeMaterial,p=t),e.cachedEdgeMaterials[s]=f}else e.cachedEdgeMaterials[s]=pe.transparentEdgeMaterial;e.cachedSymbology[m++]=Math.round(255*g[0]),e.cachedSymbology[m++]=Math.round(255*g[1]),e.cachedSymbology[m++]=Math.round(255*g[2]),e.cachedSymbology[m++]=Math.round(255*g[3]),e.cachedSymbology[m++]=c.colorMixMode|+c.castShadows<<4|+c.pickable<<5;const b=_?.emissive?.strength||Ie.emissiveStrengthDefault;b===Ie.emissiveStrengthDefault||e.emissiveStrengths||(e.emissiveStrengths=new Array(e.featureIds.length).fill(Ie.emissiveStrengthDefault)),e.emissiveStrengths&&(e.emissiveStrengths[s]=b);const v=_?.emissive?.source||0;0===v||e.emissiveSources||(e.emissiveSources=new Array(e.featureIds.length).fill(0)),e.emissiveSources&&(e.emissiveSources[s]=v)}}_getFilteredEdgeMaterials(e){const t=this._getCachedEdgeMaterials(e);this.nodeCrossfadingEnabled||$e(t,this.fullOpacity);const r=e.filteredIds;if(null==r)return{hasEdges:t.some(e=>e!==pe.transparentEdgeMaterial),perFeatureEdgeMaterials:t};let i=0,s=!1;const n=t.map((t,n)=>e.featureIds[n]!==r[i]?pe.transparentEdgeMaterial:(s=s||t!==pe.transparentEdgeMaterial,i++,t));return{hasEdges:s,perFeatureEdgeMaterials:n}}_updateComponentData(e){if(!this._hasComponentData)return;const t=e.objectHandle,r=this._getComponentParameters(e);this._collection.setComponentData(t,r),this._stage.renderView.requestRender()}_reloadAll(e=this.elevationOffset){this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()}_opacityChange(e){this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach(t=>{null!=t&&(this._collection.updateMaterial(t.objectHandle,t=>t.objectOpacity=e),$e(t.cachedEdgeMaterials,e),this._updateEdgeRendering(t))})}_updateMaterial(e){this._collection.updateMaterial(e.objectHandle,e=>{e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.usePBR=this._usePBR,this._updateMaterialOverlay(e)})}_updateMaterialOverlay(e){}_updateEngineObject(e){this._updateComponentData(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e,2)}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),null!=this._labeler&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach(t=>{null!=t&&(this._collection.updateMaterial(t.objectHandle,t=>t.commonMaterialParameters.hasSlicePlane=e),this._updateEdgeRendering(t,!1))})}_updatePBR(e){this._nodeId2Meta.forEach(t=>{null!=t&&this._collection.updateMaterial(t.objectHandle,t=>t.usePBR=e)}),this._hasLoadedPBRTextures=!0}get _usePBR(){return this._shadeNormals&&this.view.qualitySettings.physicallyBasedRenderingEnabled}_updateEdgeRendering(e,t=!0){null!=this._edgeView&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)}_forAllNodes(e){this._nodeId2Meta.forEach(e)}_ignoreClientNodeOverriddenFeatures(e){return this.i3sOverrides.hasGeometryChanges?(t,r,i)=>i.node.index>=0&&this.i3sOverrides.featureHasGeometryChanges(t)?1:e(t,r,i):e}_forAllFeatures(e,t,r){for(const i of this._nodeId2Meta.values()){if(null==i)continue;if(null!=t)switch(t(i.node.serviceMbsInIndexSR)){case 0:return;case 2:continue}let s=1;switch(r){case 1:s=this._forAllFeaturesOfNode(i,e);break;case 0:s=this._forAllVisibleFeaturesOfNode(i,e);break;case 2:s=this._forAllQueryableFeaturesOfNode(i,e)}if(0===s)return}}_forAllFeaturesOfNode(e,t){let r=1;const i=e.featureIds;for(let s=0;s<i.length;s++)if(r=t(i[s],s,e),0===r)return r;return r}_forAllVisibleFeaturesOfNode(e,t){let r=1;const i=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,s=>(r=t(i[s],s,e),1===r)),r}_forAllQueryableFeaturesOfNode(e,t){const r=this._ignoreClientNodeOverriddenFeatures(t);if(null==this._renderClippingArea)return this._forAllFeaturesOfNode(e,r);const i=this._boundingRectNodeTest(e,this._renderClippingArea);if(0===i)return 1;if(3===i)return this._forAllFeaturesOfNode(e,r);const s=e.featureIds,n=e.objectHandle,o=pe.getClipRect(this._renderClippingArea,this._collection.getObjectTransform(n));for(let t=0;t<s.length;t++){if(!this._boundingRectFeatureTest(e,t,o))continue;const i=r(s[t],t,e);if(0===i)return i}return 1}_createAttributes(e,t){const r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);const i=t.attributeInfo?.attributeData;if(null!=i)for(const t of Object.keys(i))r[t]=oe.getCachedAttributeValue(i[t],e);return r}_createGraphic(e,t){return this._createLayerGraphic(this._createAttributes(e,t))}highlight(e,t){const r=be.normalizeHighlightTarget(e);if(0===r.length)return be.emptyHighlightHandle;const i=Ae.getHighlightName(t),n=r[0]instanceof s?this._featureIdsFromGraphics(r):"number"==typeof r[0]?r:null;if(!n)return be.emptyHighlightHandle;const o=this._ensureHighlights(),{set:a,handle:l}=o.acquireSet(i);return o.setFeatureIds(a,n),l}_featureIdsFromGraphics(e){const t=this.i3slayer.fieldsIndex,r=this._getObjectIdField();return e.map(e=>_e.attributeLookup(t,e.attributes,r))}_ensureHighlights(){let e=this._highlights;return e||(e=new se({collection:this._collection,forAllFeatures:e=>this._forAllFeatures(e,null,1),forAllFeaturesOfNode:(e,t)=>this._forAllFeaturesOfNode(e,t)}),this._highlights=e),e}resetHighlights(){this._highlights=c.destroyMaybe(this._highlights)}_visibleGeometryChanged(e,t){this._elevationProvider&&(null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=p.schedule(()=>{const{node:t}=e,r=t.visibilityObbInRenderSR??t.geometryObbInRenderSR??t.serviceObbInRenderSR;if(null!=r){const e=E.create();r.toAaBoundingBox(e),this.emit("visible-geometry-changed",new X.ContentGeometryUpdateEvent(e))}else this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle=null})),this._updateSnappingSources(e,t),this._elevationProvider.objectChanged(this._collection.getComponentObb(e.objectHandle)))}get performanceInfo(){return new K.I3SMeshViewPerformanceInfo(this.usedMemory,this._nodeId2Meta.size,Math.round(this._gpuMemoryEstimate/1048576),Math.round(this._geoMemoryEstimate/1048576),Math.round(this._texMemoryEstimate/1048576),Math.round(this.unloadedMemory/1048576),this._idbCacheEnabled?Math.round(100*this._idbCache.getHitRate()):0)}checkInvariants(){}get test(){}getNodeOpacityByIndex(e){const t=this._nodeId2Meta.get(e);return this.getNodeOpacity(t)}getNodeOpacity(e){return null!=e?this._collection.getMaterial(e.objectHandle).objectOpacity:0}isNodeFullyFadedIn(e){return this._crossfadeHelper.isNodeFullyFadedIn(e)}getNodeCrossfadeMetaData(e){return this._nodeId2Meta.get(e)}getNodeComponentHandle(e){return this._nodeId2Meta.get(e)?.objectHandle}markNodeToRemove(e){this._controller&&this._controller.markNodeToRemove(e)}removeMarkedNodes(){this._controller&&this._controller.removeMarkedNodes()}foreachCrossfadeNode(e){this._nodeId2Meta.forEach(e)}fadeNode(e,t,r){if(!this.nodeCrossfadingEnabled)return;const i=this._nodeId2Meta.get(e);null!=i&&this._crossfadeHelper.fadeNode(e,i,t,r)}setNodeOpacityByIndex(e,t){const r=this._nodeId2Meta.get(e);null!=r&&this._setNodeOpacity(r,t)}_setNodeOpacity(e,t){this._collection.updateMaterial(e.objectHandle,e=>e.objectOpacity=t),this._setNodeEdgeOpacity(e,t)}_setNodeEdgeOpacity(e,t){if(null==this._edgeView||!e.cachedEdgeMaterials)return;$e(e.cachedEdgeMaterials,t);const r=e.objectHandle;this._edgeView.hasObject(r)&&this._edgeView.updateAllComponentOpacities(r,t).catch(e=>this._logEdgeViewError(e,this.i3slayer.title))}get hasModifications(){return this._isIntegratedMesh&&null!=this._layerClippingArea||this._modifications&&this._modifications.length>0}updateNodeModificationStatus(e){const t=e.length;if(!this.hasModifications||t<=0||!0!==this._i3sWasmLoaded)return;const r=this.uid,i=function(e){if(0===e.length)return;const t=10*e.length,r=new Float64Array(t);let i=0;return e.forAll(e=>{let t=e.serviceObbInIndexSR;null==t&&(t=ke,t.center=N.getCenter(e.serviceMbsInIndexSR),t.halfSize=[e.serviceMbsInIndexSR[3],e.serviceMbsInIndexSR[3],e.serviceMbsInIndexSR[3]]);const s=t.data;r[i++]=s[0],r[i++]=s[1],r[i++]=s[2],r[i++]=s[3],r[i++]=s[4],r[i++]=s[5],r[i++]=s[6],r[i++]=s[7],r[i++]=s[8],r[i++]=s[9]}),r}(e);if(i){const t={context:r,buffer:i.buffer};te.filterObbsForModificationsSync(t);const s=new Float64Array(i.buffer);e.forAll((e,t)=>{const r=s[t],i=te.interpretObbModificationResults(r);e.imModificationImpact=i,0!==i&&this._controller.invalidateGeometryVisibility(e.index)})}}notifyUpdate(){this.notifyChange("updating")}notifyLODUpdate(){this._controller.notifyLODUpdate()}isUpdating(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||null!=this._labeler&&this._labeler.updating||this._crossfadeHelper?.updating||this._i3sWasmLoaded instanceof Promise||this._asyncModuleLoading>0||null!=this._elevationTask&&this._elevationTask.readyToRun||this._needFilterResolve||this._compressionTracker.compressing}trackSnappingSources(e){const t={events:e,fetchEdgeLocations:async(e,t,r)=>{const i=this._nodeId2Meta.get(e);if(null==i)throw new Error("invalid-node");const{origin:s,buffer:n}=await this._collection.extractEdgeInformation(i.objectHandle,t,r);return this._snappingLocationsApplyElevation(i,n,s),{type:"components",objectIds:i.featureIds,locations:n,origin:s}},remove:()=>n.removeUnordered(this._snappingSourcesTrackers,t)};return this._snappingSourcesTrackers.push(t),this._nodeId2Meta.forEach((t,r)=>{if(null==t)return;const i=this._controller.getRenderMbs(t.node);i&&e.add(r,i)}),t}_snappingLocationsApplyElevation(e,t,r){if(!e.elevationOffsets||0===this.elevationInfo.mode)return;const i=t.position0,s=t.position1,n=t.componentIndex,o=T.create(),a=T.create(),l=(e,t)=>{S.add(e,e,r),this.view.renderCoordsHelper.worldUpAtPosition(e,a),S.add(e,e,S.scale(a,a,t)),S.subtract(e,e,r)};for(let t=0;t<i.count;t++){const r=e.elevationOffsets[n.get(t)];i.getVec(t,o),l(o,r),i.setVec(t,o),s.getVec(t,o),l(o,r),s.setVec(t,o)}}_updateSnappingSources(e,t){const{index:r}=e.node,i=this._controller.getRenderMbs(e.node);if(null!=i)for(const e of this._snappingSourcesTrackers)1!==t&&2!==t||e.events.remove(r),0!==t&&2!==t||e.events.add(r,i)}_logEdgeViewError(e,t){d.isAbortError(e)||a.getLogger(this).warn("Error while processing edges. Edges on this layer might not display correctly",t,e)}_indexedDbSizeCheck(e,t){return t.byteSize>104857600?(a.getLogger(this).warn(`Node is too big to store in IndexedDB cache: ${e.id} (${t.byteSize} bytes)`),!1):t.byteSize>0}};return r.__decorate([g.property()],m.prototype,"_hasLoadedPBRTextures",void 0),r.__decorate([g.property()],m.prototype,"_asyncModuleLoading",void 0),r.__decorate([g.property()],m.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),r.__decorate([g.property()],m.prototype,"view",void 0),r.__decorate([g.property()],m.prototype,"i3slayer",void 0),r.__decorate([g.property()],m.prototype,"_controller",void 0),r.__decorate([g.property()],m.prototype,"_labeler",void 0),r.__decorate([g.property()],m.prototype,"updating",void 0),r.__decorate([g.property()],m.prototype,"suspended",void 0),r.__decorate([g.property()],m.prototype,"contentVisible",null),r.__decorate([g.property({readOnly:!0})],m.prototype,"legendEnabled",null),r.__decorate([g.property(Ce.updatingProgress)],m.prototype,"updatingProgress",void 0),r.__decorate([g.property()],m.prototype,"updatingProgressValue",null),r.__decorate([g.property()],m.prototype,"hasTexturesOrVertexColors",null),r.__decorate([g.property()],m.prototype,"rendererTextureUsage",null),r.__decorate([g.property()],m.prototype,"elevationOffset",null),r.__decorate([g.property()],m.prototype,"elevationInfo",null),r.__decorate([g.property({type:Boolean})],m.prototype,"slicePlaneEnabled",void 0),r.__decorate([g.property()],m.prototype,"supportedTextureEncodings",null),r.__decorate([g.property({type:[q]})],m.prototype,"_modifications",void 0),r.__decorate([g.property({readOnly:!0})],m.prototype,"clientGeometry",null),r.__decorate([g.property()],m.prototype,"elevationRange",null),r.__decorate([g.property()],m.prototype,"fullExtent",null),r.__decorate([g.property()],m.prototype,"_elevationTask",void 0),r.__decorate([g.property({readOnly:!0})],m.prototype,"_usePBR",null),m=r.__decorate([y.subclass("esri.views.3d.layers.I3SMeshView3D")],m),m},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/projection/localLinearScaleFactors":function(){define(["exports","../../chunks/vec32","./projectors","../support/Ellipsoid","../support/spatialReferenceUtils"],function(e,t,r,i,s){"use strict";e.localLinearScaleFactors=function(e,n,o,a){const l=r.getProjectorClassification(n,a);if(null==l)return!1;const c=l.source.spatialReferenceId,u=l.dest.spatialReferenceId;if(c===u&&0!==c||s.equals(n,a))return o[0]=1,o[1]=1,o[2]=1,!0;if(1===c){const s=t.length(e),n=s/Math.sqrt(e[0]*e[0]+e[1]*e[1]),a=s/i.earth.radius;if(3===u)return o[0]=n*a,o[1]=n*a,o[2]=1,!0;if(2===u||5===u){const e=r.invPlateCarreeScale;return o[0]=e*n*a,o[1]=e*a,o[2]=1,!0}}else if(11===c){if(2===u||5===u)return o[0]=r.invPlateCarreeScale,o[1]=r.invPlateCarreeScale,o[2]=1,!0;if(3===u){const t=e[1]/i.earth.radius;return o[0]=1,o[1]=1/Math.cos(t),o[2]=1,!0}}return!1},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/geometry/support/UByteArray":function(){define(["exports","../../core/typedArrayUtil"],function(e,t){"use strict";e.newUByteArray=function(e,r=!1){return e<=t.nativeArrayMaxSize?r?new Array(e).fill(0):new Array(e):new Uint8Array(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/graphics/controllers/I3SOnDemandController":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/Logger","../../../core/maybe","../../../core/PooledArray","../../../core/Promise","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/projection/projectBoundingRect","../../../geometry/support/aaBoundingRect","../../support/PromiseQueue","../../../views/ViewingMode","../../../views/3d/layers/i3s/I3SClientNodeLoader","../../../views/3d/layers/i3s/I3SFrameTask","../../../views/3d/layers/i3s/I3SIndex","../../../views/3d/layers/i3s/I3SLodHandling","../../../views/3d/layers/i3s/I3SNodeLoader","../../../views/3d/layers/i3s/I3SStreamDataController","../../../views/3d/layers/i3s/I3SUtil","../../../views/3d/layers/i3s/I3SViewportQueries","../../../views/3d/support/downloadSlots","../../../views/3d/support/extentUtils","../../../views/3d/support/MemoryController","../../../views/support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R){"use strict";const O=1e-4;e.default=class extends(a.EsriPromiseMixin(r)){get isMeshPyramid(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store?.lodType}get isGraphics3D(){return"points"===this.layer.profile}get useMaximumNumberOfFeatures(){return!this.isMeshPyramid&&(null==this.layer.priority||"High"===this.layer.priority)}get indexStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(2);return new x.I3SStreamDataController(e,this.layer.customParameters,this.layer.apiKey)}get dataStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(3);return new x.I3SStreamDataController(e,this.layer.customParameters,this.layer.apiKey)}get crsVertex(){return S.getVertexCrs(this.layer)}get crsIndex(){return S.getIndexCrs(this.layer)}get layer(){return this.layerView.i3slayer}get running(){return this.updating}get rootNodeVisible(){if(this._index){const e=this._index.rootNode;if(e)return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}get index(){return this._index}get requiredAttributes(){return this._requiredAttributes}constructor(e){super(e),this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.worker=null,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._idleStateCallbacks=null,this._newLoadingNodes=new o({deallocator:null}),this._modificationsNodeFilteringArray=new o,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._idleQueue=new m.PromiseQueue,this._elevationUpdateNodes=new o({deallocator:null}),this._errorCount=0}initialize(){const{layerView:e,layer:t}=this;this._disableMemCache=!e.loadCachedGPUData||!e.addCachedGPUData,this._lodHandling=new v(e),this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=!!i("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo),this.addResolvingPromise(Promise.all([t.indexInfo,t.when(),e.when()]).then(([r])=>{if(this.destroyed||!e||e.destroyed||!r)return;const{view:i,clientGeometry:n}=e,{resourceController:o}=i;if(this._setClippingArea(i.clippingArea),this.addHandles([c.watch(()=>i?.pointsOfInterest?.focus?.renderLocation,e=>this._pointOfInterestChanged(e),c.initial),c.watch(()=>i.quality,()=>this._setCameraDirty(),c.sync),c.watch(()=>e.contentVisible,e=>{const t=e?()=>this._updateIdleState(!0):()=>this._updateViewData(),r=e?()=>this._updateIdleState(!1):()=>{};e&&null!=this._index&&this._index.invalidateAllElevationRanges(),this._idleStateCallbacks?(e||this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=t,this._idleStateCallbacks.idleEnd=r):this._idleStateCallbacks=o.scheduler.registerIdleStateCallbacks(t,r)},c.initial),_.addCallback(e.view.resourceController.scheduler,this),c.watch(()=>[this.featureTarget,this.fixedFeatureTarget],()=>{this._setCameraDirty(),this._stableFeatureLOD=!1}),c.watch(()=>i.state?.contentCamera,()=>this._setCameraDirty()),c.watch(()=>t.elevationInfo,e=>this._elevationInfoChanged(e)),c.watch(()=>e.lodFactor,()=>this._setCameraDirty()),c.watch(()=>e.availableFields,()=>this._requiredFieldsChange()),c.watch(()=>e.holeFilling,e=>null!=this._index&&(this._index.holeFilling=e))]),this._viewportQueries=new T(this.crsIndex,i.renderCoordsHelper,i.state.contentCamera,!i.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?i.basemapTerrain:i.elevationProvider,g.viewingModeFromString(i.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this._lod,angleDependentLoD:this._lod<.5}),this._clientNodeLoader=new y.I3SClientNodeLoader(this.layer.uid,{indexSR:this.crsIndex,vertexSR:this.crsVertex,renderSR:i.renderCoordsHelper.spatialReference},i.resourceController.memoryController,this.worker),this._index=new b.I3SIndex(g.viewingModeFromString(i.viewingMode),t,r,this.indexStreamController,this._clientNodeLoader,this._viewportQueries,s.getLogger(this),e.holeFilling,t=>e.isNodeLoaded(t),t=>e.isNodeReloading(t),e=>this._shouldLoadNode(e),e=>this._enableFromGPUCache(e,1),e=>this._needsUpdate(e),()=>!this.indexStreamController.busy,t=>e.computeVisibilityObb?.(t)??null,e?.computeNodeFiltering?t=>e.computeNodeFiltering(t):void 0),this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid||this.isGraphics3D),this._index.imModificationsChanged(!!e.hasModifications),this._index.layerFilterChanged(!!e.hasGeometryFilter),null!=n){for(const e of n)this._addMesh(e.mesh,e.oid);this.addHandles(n.on("change",e=>{for(const t of e.removed)this._removeMesh(t.oid);for(const t of e.added)this._addMesh(t.mesh,t.oid)}))}this._startNodeLoading()}))}updateNodeModificationStatus(e){const t=this._index,r=this.layerView;null!=t&&r?.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll(e=>{const r=t.getNode(e);null!=r&&this._modificationsNodeFilteringArray.push(r)}),r.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._nodeLoader=null,I.prune(),this._newLoadingNodes.prune(),this._modificationsNodeFilteringArray.prune(),this._elevationUpdateNodes.prune(),this._index=null,this._lodHandling=n.destroyMaybe(this._lodHandling),this._nodeLoader=null,this._clientNodeLoader=null,this._viewportQueries=null,this._set("worker",null)}get viewportQueries(){return this._viewportQueries}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const e=this._attributeStorageInfo,t=this._fields,r=this.layer.objectIdField;return this.layerView.availableFields.map(r=>{const i=A(e,r),s=A(t,r);return i>=0&&s>=0?{index:i,name:t[s].name,field:t[s],attributeStorageInfo:e[i]}:null}).filter(e=>null!=e&&e.name!==r)}_requiredFieldsChange(){const e=this._getRequiredAttributes();F(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(e){const t=f.create();P.toBoundingRect(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}_pointOfInterestChanged(e){null!=this._viewportQueries&&(this._viewportQueries.setPointOfInterest(e),null!=this._index&&(this._index.progressiveLoadPenalty=D.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(e){this._setClippingArea(e),null!=this._viewportQueries&&null!=this._index&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}_addMesh(e,t){if(null==this._index)return;const r=this._clientNodeLoader.createMeshNodeInfo(e,t),i=this._index.addClientNodeToIndex(r.id,r.mbs);this._clientNodeLoader.addMeshNode(i,r),this._evaluateUpdating(),this.notifyChange("rootNodeVisible")}_removeMesh(e){const t=this._clientNodeLoader.getMeshNodeIndex(e);if(null!=t){if(null==this._index)throw new Error("delayed removal of client side i3s node geometry not supported yet.");{const e=(e,t)=>{this.layerView.removeNode(t),this._clientNodeLoader.removeNode(e),this.layerView.deleteCachedNodeData&&null!=e&&this.layerView.deleteCachedNodeData(e),this.layerView.deleteCachedGPUData?.(this.layerView.loadCachedGPUData?.(t))},r=(e,t,r)=>{this._clientNodeLoader.updateNodeIndex(e,t,r),this.layerView.updateNodeIndex&&this.layerView.updateNodeIndex(t,r)};this._index.removeClientNodeFromIndex(t,e,r),this.notifyChange("rootNodeVisible")}}}updateElevationChanged(e,t){const r=this._index;if(null==r?.rootNode||null==t)return null;this.crsIndex.equals(t)||(p.projectBoundingRect(e,t,E,this.crsIndex),e=E);const i=this._elevationUpdateNodes;return i.clear(),S.findIntersectingNodes(e,r.rootNode,r,e=>i.push(e.index)),i.length&&(i.forAll(e=>r.updateElevationChanged(e)),this._setCameraDirty()),i}removeAllGeometryObbs(){null!=this._index&&this._index.removeAllGeometryObbs()}getRenderMbs(e){return null!=this._viewportQueries?this._viewportQueries.getServiceMbsInRenderSR(e):null}_elevationInfoChanged(e){null!=this._index&&(this._index.updateElevationInfo(e,this.isMeshPyramid||this.isGraphics3D),this._setCameraDirty())}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(e,t){return this._idleQueue.push(e,t)}reschedule(e,t){return this._idleQueue.unshift(e,t)}get _isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get unloadedMemoryEstimate(){return null!=this._index&&this.layerView.contentVisible?this._index.unloadedMemoryEstimate*this._lodDropFactor:0}async _loadNodeData(e,t){return e.index<0?this._clientNodeLoader.loadNodeData(e.id,t):this._nodeLoader.loadNodeData(e,t)}async _loadAttributes(e,t,r){return(e.index<0?this._clientNodeLoader:this._nodeLoader).loadAttributes(e,t,r)}get indexDepth(){return null!=this._index?this._index.maxLevel:0}set disableMemCache(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData?this._disableMemCache=e:this._disableMemCache=!0}runTask(e,t){return this.layerView.contentVisible?this.layerView.visible&&null!=this._index?(this._processWithErrorLogging(e,t),this._index.maxPriority):-1/0:(this._updateViewData(),this._evaluateUpdating(),-1/0)}_processWithErrorLogging(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?s.getLogger(this).error(`Error during processing: ${e} at ${e.stack}`):50===this._errorCount&&s.getLogger(this).error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(e,t){this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&null!=this._index&&(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(e.enabled=!1),e.run(()=>this._processIndex(e)),this._updateFeatureLOD(),e.run(()=>this._processCache(e)),this._isIntegratedMesh&&(e.enabled=!0),e.run(()=>this._processNodes(e,t)),this._idleQueue.runTask(e),e.run(()=>this._prefetchIndex()),t.numIndexLoading+=this._index.indexLoading,t.numNodesLoading+=this._downloadingCount,e.run(()=>this._lodHandling.lodGlobalHandling(e)),this._evaluateUpdating())}_processIndex(e){if(null==this._index)return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),e,e=>this.updateNodeModificationStatus(e)),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const t=this._index.featureEstimate.leavesReached;this._index.isLoading||t===this._get("leavesReached")||this._set("leavesReached",t)}return this._index.load()}_prefetchIndex(){return!(null==this._index||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.useMaximumNumberOfFeatures||null==this._index||null==this._viewportQueries)return;const e=!this._index.isLoading,t=this.featureTarget*this._baseLOD,r=this._index.featureEstimate;if(r.estimate=r.estimate||t/2,this._index.indexMissing>500){if(this._featureLOD<=O)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&r.estimate<t){if(r.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const e=Math.min(10,Math.max(t/r.estimate,1.001));this._featureLOD*=e;const i=this._lod,s=this._index.checkFeatureTarget(t,i);s!==i&&(this._featureLOD=s/this._baseLOD,this._stableFeatureLOD=!0)}else{if(!(r.estimate>1.2*t||e&&r.estimate>t))return;if(this._featureLOD<=O)return;this._featureLOD/=1+.25*(r.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(O,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.requestUpdate()}_processCache(e){const t=this._index;if(null==t)return!1;for(;this._newLoadingNodes.length>0&&!e.done;){const r=this._newLoadingNodes.pop();for(let i=t.getParent(r);null!=i&&!this.layerView.isNodeLoaded(i.index);i=t.getParent(i.index))if(this._enableFromGPUCache(i,0)){e.madeProgress();break}}return e.hasProgressed}_processNodes(e,t){if(null==this._index)return!1;let r=(this._isIdle?100:2)-this._loadingNodes.size;const i=this._index.updates;for(i.cancel.forEach(this._cancelNode,this),i.cancel=[];i.remove.length>0&&!e.done;)this.layerView.removeNode(i.remove.pop()),e.madeProgress();for(;i.update.length>0&&!e.done;){const t=this._index.getNode(i.update.pop());null!=t&&(this._updateLoadedNode(t),e.madeProgress())}for(;i.add.length>0&&!e.done&&r>0;){--r;const s=this._index.getNode(i.add.back());if(null==s||2!==s.cacheState&&!this._hasNodeLoadToken(t))break;i.add.pop(),this._loadNode(s),e.madeProgress()}return e.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach(e=>e.abort()),this._loadingNodes.clear(),this._updatingNodes.forEach(e=>e.abort()),this._updatingNodes.clear()}_cancelNode(e){const t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}_hasNodeLoadToken(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<C.maxDownloadSlots&&!this.dataStreamController.busy}_evaluateUpdating(){let e=!1,t=0;if(this.layerView){if(this.layerView.contentVisible){const r=(this._index?.indexMissing??0)+3*(this._index?.updates.add.length??0)+2*this._loadingNodes.size;e=!!(r>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.updating||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||null!=this._index&&this._index.isPrefetching),0===r&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(r,this._progressMaxNumNodes),t=1-r/this._progressMaxNumNodes}else e=this._cameraDirty,t=e?0:1;this.updating=e,this.updatingProgress=t}}_updateViewData(){if(!this._cameraDirty||null==this._index||null==this._viewportQueries)return;const e=this.layerView.view,{contentCamera:t,fixedContentCamera:r}=e.state;this._viewportQueries.updateCamera(t,!r||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=D.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.quality<1?1:this.layerView.progressiveLoadFactor}get _lod(){return this._featureLOD*this._baseLOD}get _baseLOD(){const e=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*this.layerView.view.quality}get _lodDropFactor(){return this.fixedFeatureTarget?1:(Math.min(this.layerView.view.quality,.5)-M.minQuality)/(.5-M.minQuality)}isGeometryVisible(e){return!!this._index?.isGeometryVisible(e.index)}updateVisibility(e){this._index?.invalidateNodeVisibilityCache(e)}invalidateGeometryVisibility(e){this._index?.invalidateGeometryVisibility(e)}invalidateVisibilityObbs(){this._index?.invalidateVisibilityObbs()}modificationsChanged(){this._index?.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}_shouldLoadNode(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||null==this._index||!this._index.isGeometryVisible(e.index))}_shouldDropNode(e){if(null==this._viewportQueries)return!1;const t=this._lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}_startNodeLoading(){this._restartNodeLoading=!1;const e=this._index;if(this._updatesDisabled||null==e||null==this._viewportQueries)return;this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);const t={textureEncodings:this.layerView.supportedTextureEncodings,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new w(this.layer,this.dataStreamController,s.getLogger(this),this._defaultGeometrySchema,this._requiredAttributes,t),e.requestUpdate(),this._lodHandling.startNodeLoading((e,t)=>this._removeNodes(e,t,1),e,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(e){const t=this._index;if(null==t||null==this._viewportQueries)return!1;I.clear(),this.layerView.getLoadedNodeIndices(I);const r=0===this._viewportQueries.maxDistance,i=r?()=>!1:e=>this._shouldDropNode(e);return I.filterInPlace(e=>{const r=t.getNode(e);return null==r||!t.isGeometryVisible(e)||i(r)}),I.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(I,e,0),!(r&&this._lodDropFactor<1||0!==I.length&&(I.clear(),1))}markNodeToRemove(e){I.push(e)}removeMarkedNodes(){this._removeNodes(I,R.noBudget,0)}_removeNodes(e,t,r){if(0!==e.length&&!t.done)for(null!=this._index&&this._index.requestUpdate();e.length>0&&!t.done;){const i=e.pop(),s=this._index;1===r&&this.layerView.nodeFadeoutEnabled&&null!=s&&s.isGeometryVisible(i)?this.layerView.fadeNode(i,1,!0):this.layerView.removeNode(i),t.madeProgress()}}_needsUpdate(e){if(e.resources.isEmpty||this._updatingNodes.has(e.index))return!1;const t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}async _updateLoadedNode(e){const t=new AbortController;this._updatingNodes.set(e.index,t),this._evaluateUpdating();try{const r=F(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?this.layerView.getAttributeData(e.index):await this._loadAttributes(e,this._requiredAttributes,t.signal);await this.schedule(()=>this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:r},t.signal),t.signal)}catch(r){if(!l.isAbortError(r))return this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},t.signal)}this._updatingNodes.delete(e.index),this._evaluateUpdating()}_loadNode(e){if(this._loadingNodes.has(e.index))return void s.getLogger(this).error("already loading node "+e.index);const t=new AbortController;this._loadingNodes.set(e.index,t),this._evaluateUpdating(),this._loadAndAddNode(e,t.signal).then(r=>{r&&null!=this._index&&this._loadingNodes.get(e.index)===t&&(this._loadingNodes.delete(e.index),this._index.requestUpdate())}).catch(e=>{if(!l.isAbortError(e))throw e}).finally(()=>{this._loadingNodes.get(e.index)===t&&this._loadingNodes.delete(e.index),this._evaluateUpdating()})}_loadAndAddNode(e,t){return 1===e.cacheState?this._loadUncached(e,t).then(()=>!1):this._loadCached(e,t).then(t=>!t&&(e.cacheState=1,!0)).catch(t=>!l.isAbortError(t)&&(e.cacheState=1,!0))}_enableFromGPUCache(e,t){if(this._disableMemCache||null==this._index)return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;const r=this._loadCachedGPUData(e);return!!r&&(this.layerView.addCachedGPUData(e,r,t),this._nodeAdded(),!0)}_loadCachedGPUData(e){const t=this.layerView.loadCachedGPUData(e.index);return null!=t?.attributeInfo&&F(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}_nodeAdded(){null!=this._index&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateLoadStatus(e,t){const r=this._index;null!=r&&r.updateChildrenLoaded(e,t?1:-1)}async _loadCached(e,t){if(this._enableFromGPUCache(e,1))return!0;const r=this.layerView;if(this.disableIDBCache||!r.loadCachedNodeData||!r.addCachedNodeData)return!1;const i=e.index>=0?(t,r)=>this._nodeLoader.loadTextures(e,t,r):(t,r)=>this._clientNodeLoader.loadTextures(e,t,r),s=await this.schedule(()=>r.loadCachedNodeData(e,t,i),t);if(null==s)return!1;const n=this._requiredAttributes,o=await this.reschedule(()=>this._loadAttributes(e,n,t),t);return await this.reschedule(()=>r.addCachedNodeData(e,s,{loadedAttributes:n,attributeData:o},t),t),this._nodeAdded(),!0}_loadUncached(e,t){return this._downloadingCount++,this._loadNodeData(e,t).catch(e=>{throw this._downloadingCount--,e}).then(r=>(this._downloadingCount--,this.schedule(()=>this.layerView.addNode(e,r,t),t))).then(()=>{this._nodeAdded(),e.cacheState=2}).catch(t=>{if(!l.isAbortError(t))throw s.getLogger(this).error("#loadNodeData()",this.layer,`Failed to load node '${e.id}'`,t),e.failed=!0,null!=this._index&&this._index.requestUpdate(),t})}_updateIdleState(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&null!=this._index&&this._index.resetFailedNodes())}get test(){}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),null!=this._index&&this._index.requestUpdate()}geometryFilterChanged(e){const t=this._index;null!=t&&t.layerFilterChanged(e),this._setCameraDirty()}},t.__decorate([u.property({readOnly:!0})],e.default.prototype,"isMeshPyramid",null),t.__decorate([u.property({readOnly:!0})],e.default.prototype,"isGraphics3D",null),t.__decorate([u.property({readOnly:!0})],e.default.prototype,"useMaximumNumberOfFeatures",null),t.__decorate([u.property({readOnly:!0})],e.default.prototype,"indexStreamController",null),t.__decorate([u.property({readOnly:!0})],e.default.prototype,"dataStreamController",null),t.__decorate([u.property({readOnly:!0})],e.default.prototype,"crsVertex",null),t.__decorate([u.property({readOnly:!0})],e.default.prototype,"crsIndex",null),t.__decorate([u.property()],e.default.prototype,"featureTarget",void 0),t.__decorate([u.property()],e.default.prototype,"fixedFeatureTarget",void 0),t.__decorate([u.property()],e.default.prototype,"layerView",void 0),t.__decorate([u.property()],e.default.prototype,"layer",null),t.__decorate([u.property()],e.default.prototype,"updating",void 0),t.__decorate([u.property({readOnly:!0})],e.default.prototype,"running",null),t.__decorate([u.property()],e.default.prototype,"updatingProgress",void 0),t.__decorate([u.property({readOnly:!0})],e.default.prototype,"leavesReached",void 0),t.__decorate([u.property({constructOnly:!0})],e.default.prototype,"worker",void 0),t.__decorate([u.property({readOnly:!0,dependsOn:[]})],e.default.prototype,"rootNodeVisible",null),e.default=t.__decorate([h.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],e.default);const I=new o({deallocator:null});function F(e,t){return null!=e&&e.length===t.length&&e.every(e=>A(t,e.name)>=0)}function A(e,t){const r=t.toLowerCase();for(let t=0;t<e.length;t++)if(e[t].name.toLowerCase()===r)return t;return-1}const D={distancePenalty:10},E=f.create();return e.default})},"esri/views/3d/layers/i3s/I3SClientNodeLoader":function(){define(["exports","../../../../core/Error","../../../../core/maybe","../../../../core/MemCache","../../../../core/promiseUtils","../../../../core/uuid","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/support/DoubleArray","../../../../geometry/support/meshVertexSpaceUtils","../../../../chunks/sphere","./CachedMeshData","./I3SClientMaterialUtil"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";function g(e,t){const{spatialReference:r}=e,i=[1,-1],s=[.5*e.width,.5*e.height,e.hasZ?.5*(e.zmax-e.zmin):0],n=r.isGeographic?r.metersPerUnit:1,o=e.center;let a=0;if(e.hasZ)for(let e=0;e<2;++e)for(let r=0;r<2;++r)for(let l=0;l<2;++l){const c=(o.x+i[e]*s[0]-t.x)*n,u=(o.y+i[r]*s[1]-t.y)*n,d=o.z+i[l]*s[2]-t.z;a=Math.max(c*c+u*u+d*d,a)}else for(let e=0;e<2;++e)for(let r=0;r<2;++r){const l=(o.x+i[e]*s[0]-t.x)*n,c=(o.y+i[r]*s[1]-t.y)*n;a=Math.max(l*l+c*c,a)}return p.fromCenterAndRadius([t.x,t.y,t.z],Math.sqrt(a))}async function y(e,t,i,s){const{transform:n,vertexAttributes:u}=t.loadedMesh,d="source"===e.shading?u.normal:null;if(null==d||null==n||0===n.rotationAngle&&l.exactEquals(n.scale,c.ONES))return{transformed:d,original:u.normal};if(!t.normalsTransformPromise){r.assertIsSome(i,"SceneLayerWorker is needed to transform mesh normals");const e=a.create();o.normalFromMat4(e,n.localMatrix),t.normalsTransformPromise=i.transformNormals({normalMatrix:e,normals:d},s)}return t.normalsTransformPromise}function _(e,t,r){e[t]=255&r,e[t+1]=255&r>>8,e[t+2]=255&r>>16,e[t+3]=255&r>>24}e.I3SClientNodeLoader=class{constructor(e,t,r,i){this._uid=e,this._worker=i,this._id2Meta=new Map,this._oid2Meta=new Map,this._indexSR=t.indexSR,this._vertexSR=t.vertexSR,this._renderSR=t.renderSR,this._memCache=r.newCache(`sl-client-mesh-data-${this._uid}`)}get uid(){return this._uid}get worker(){return this._worker}get indexSR(){return this._indexSR}get renderSR(){return this._renderSR}createMeshNodeInfo(e,t){const r=`mesh${t}`,i=e.extent,s=i.spatialReference,o=this._indexSR,a=g(i,e.origin);u.projectBoundingSphere(a,s,a,o);const l=function(e){const t=e.metadata.displaySource?.source;if(null==t||!Array.isArray(t)||!t.length||t[0]instanceof File)return n.generateUUID();const r=t;let i="";for(const e of r)i+=e.makeHash();return i+JSON.stringify(e.transform?.toJSON()??"")+(h.isRelativeVertexSpace(e.vertexSpace)?JSON.stringify(e.vertexSpace.origin):"")+JSON.stringify(e.spatialReference)}(e);return{type:"mesh",id:r,version:l,oid:t,mbs:a,componentNodeIds:[],unloadedMesh:e,nodeIndex:null,loadMeshPromise:null}}addMeshNode(e,r){if(null!=this.getMeshNodeIndex(r.oid))throw new t("scenelayer",`I3SClientNodeLoader: client side mesh for feature oid=${r.oid} already exists`);r.nodeIndex=e,this._id2Meta.set(r.id,r),this._oid2Meta.set(r.oid,r)}getMeshNodeIndex(e){const t=this._oid2Meta.get(e);return null==t||"mesh"!==t.type?null:t.nodeIndex}getMeshNodeInfo(e){const t=this._oid2Meta.values();for(const r of t)if("mesh"===r.type&&r.id===e)return r;return null}removeNode(e){const t=this._id2Meta.get(e);null!=t&&(this._id2Meta.delete(e),"mesh"===t.type&&this._oid2Meta.delete(t.oid))}async loadNodeJSON(e){const r=this._id2Meta.get(e);if(null==r)throw new t("scenelayer",`I3SClientNodeLoader::loadNodeJSON unable to find node ${e}`);switch(r.type){case"mesh":return this._loadMeshNodeJSON(r);case"mesh-component":return async function(e){return{id:e.id,version:e.meshNodeInfo.version,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null,isEmpty:!1}}(r);default:throw new t("scenelayer",`I3SClientNodeLoader::loadNodeJSON unable to handle node ${e}`)}}async _loadMeshNodeJSON(e){const t=e.id,r=(await this._getMeshData(e)).loadedMesh;if(null==r.components||0===r.components.length)return{id:t,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null};const i=[],s=r.components;for(let r=0;r<s.length;++r){const s=`${t}-component${r}`,n={type:"mesh-component",id:s,mbs:e.mbs,componentIndex:r,meshNodeInfo:e,textureData:new Map};this._id2Meta.set(n.id,n),e.componentNodeIds.push(s),i.push({id:n.id,href:null,mbs:n.mbs,obb:null})}return{id:t,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:i}}updateNodeIndex(e,t,r){const i=this._id2Meta.get(e);i&&"mesh"===i.type&&(i.nodeIndex=r)}async loadNodeData(e,i){const n=this._id2Meta.get(e);if(null==n||"mesh-component"!==n.type)throw new t("scenelayer",`Failed to load client node data for node ${e} (unexpected node info)`);const o=n.meshNodeInfo,a=await this._getMeshData(o),l=a.loadedMesh,c=o.oid;if(null==l.components)throw new t("scenelayer",`Failed to load client node data for node ${e} (unexpected null reference)`);const u=l.components[n.componentIndex],{material:h,requiredTextures:p,textureData:f}=await m.convertMeshMaterialToPBRMaterial(u.material);if(null!=f)for(const e of f)null!=e&&n.textureData.set(e.id,e);const g={params:{material:h},type:"ArrayBufferView"},{vertexSpace:b,origin:v,transform:w}=l,x=[v.x,v.y,v.z??0];a.projectionPromise||(r.assertIsSome(this._worker,"SceneLayerWorker is needed to project mesh"),a.projectionPromise=this._worker.project({positions:l.vertexAttributes.position,localMatrix:w?.localMatrix,vertexSpace:b.toJSON(),origin:x,inSpatialReference:l.spatialReference.toJSON(),outSpatialReference:this._vertexSR.toJSON()},i));const{projected:S,original:T,projectedOrigin:C}=await a.projectionPromise,P=d.ensurePackedArray(C);l.vertexAttributes.position=T;const{transformed:M,original:R}=await y(u,a,this._worker,i);l.vertexAttributes.normal=R,s.throwIfAborted(i);const{geometryBuffer:O,geometryDescriptor:I}=function(e,t,r,i,s,n){const o=(t?.length??0)/3,a=3*o;let l=0,c=0,u=!1,d=0,h=!1,p=0,f=!1,m=0,g=0,y=0;l+=4,l+=4,c=l,l+=3*a*4,null!=r&&(u=!0,d=l,l+=3*a*4),null!=i&&(h=!0,p=l,l+=2*a*4),null!=s&&(f=!0,m=l,l+=4*a*1),g=l,l+=8,y=l,l+=8;const b=new ArrayBuffer(l),v=new Uint8Array(b);_(v,0,a),_(v,4,1);const w=new Float32Array(b,c),x=null!=r?new Float32Array(b,d):null,S=null!=i?new Float32Array(b,p):null,T=null!=s?new Uint8Array(b,m):null;for(let n=0;n<o;++n){const o=3*n;for(let a=0;a<3;++a){const l=t[o+a],c=3*l,u=9*n+3*a;if(w[u]=e[c],w[u+1]=e[c+1],w[u+2]=e[c+2],x&&(x[u]=r[c],x[u+1]=r[c+1],x[u+2]=r[c+2]),S){const e=2*l,t=6*n+2*a;S[t]=i[e],S[t+1]=i[e+1]}if(T){const e=4*l,t=12*n+4*a;T[t]=s[e],T[t+1]=s[e+1],T[t+2]=s[e+2],T[t+3]=s[e+3]}}}return _(v,g,n),_(v,g+4,n/2**32),_(v,y,0),_(v,y+4,o-1),{geometryBuffer:b,geometryDescriptor:{isDraco:!1,isLegacy:!0,color:f,normal:u,uv0:h,uvRegion:!1,featureIndex:!0}}}(S,u.faces,M,l.vertexAttributes.uv,l.vertexAttributes.color,c);return{geometryData:{featureDataPosition:P,featureIds:[],geometries:[g]},attributeDataInfo:{attributeData:{},loadedAttributes:[]},geometryBuffer:O,geometryDescriptor:I,requiredTextures:p,textureData:f,normalReferenceFrame:this._vertexSR.isGeographic?"east-north-up":"vertex-reference-frame"}}async loadAttributes(e,t,r){const i=e.numFeatures,s={};for(const{field:{name:e}}of t)s[e]=new Array(i);return s}async loadTextures(e,t,r){const i=e.id,s=this._id2Meta.get(i);if(null==s||"mesh-component"!==s.type)throw new Error(`Failed to load textures for node ${e.id} (unexpected node info)`);const n=[];for(const e of t)n.push(s.textureData.get(e.id)||null);return n}async _getMeshData(e){const t=e.version,r=this._memCache.get(t);if(null==r){if(null!=e.loadMeshPromise)return e.loadMeshPromise;const r=async(r,s)=>{const n=e.unloadedMesh.clone();try{await n.load()}catch(e){s(e)}const o=new f.CachedMeshData(n);this._memCache.put(t,o,i.MinPriority),e.loadMeshPromise=null,r(o)};return e.loadMeshPromise=new Promise((e,t)=>r(e,t)),e.loadMeshPromise}return r}},e.createSphereFromExtent=g,e.sizeOfFloat32=4,e.sizeOfInt32=4,e.sizeOfUInt64=8,e.sizeOfUInt8=1,e.transformNormals=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/CachedMeshData":function(){define(["exports"],function(e){"use strict";e.CachedMeshData=class{constructor(e){this.loadedMesh=e}get cachedMemory(){return this.loadedMesh.usedMemory}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SClientMaterialUtil":function(){define(["exports","../../../../Color","../../../../core/Error","../../../../support/requestUtils","../../glTF/internal/resourceUtils","../../webgl-engine/materials/pbrUtils","../../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o){"use strict";async function a(e,t,n,o){if(null==e)return-1;const a=n.length,l=e.data,c=e.url;if(null!=l){if(l instanceof HTMLImageElement||l instanceof HTMLCanvasElement)return n.push({id:a,usage:o,data:l,encoding:8}),t.push({id:a,usage:o,encodings:[{name:void 0,encoding:8}]}),a;if(l instanceof HTMLVideoElement)return-1;if(l instanceof ImageData)throw new r("scenelayer","ImageData textures not supported yet for client side I3S nodes");if(l instanceof s.EncodedMeshTexture)return n.push({id:a,usage:o,data:l.data,encoding:1}),t.push({id:a,usage:o,encodings:[{name:void 0,encoding:1}]}),a}else if(null!=c){const e=new Image;e.src=c;const r=await i.loadImageAsync(e,e.src,!1,void 0);return n.push({id:a,usage:o,data:r,encoding:8}),t.push({id:a,usage:o,encodings:[{name:void 0,encoding:8}]}),a}return-1}e.convertMeshMaterialToPBRMaterial=async function(e){const r=[],i=[];if(null==e)return{material:{alphaMode:"opaque",alphaCutoff:o.alphaCutoff,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[1,1,1,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6000000238418579},wrapTextures:!1,hasParametersFromSource:!0},requiredTextures:r,textureData:i};const s=function(e){return e.hasOwnProperty("metallicRoughnessTexture")}(e);"auto"===e.alphaMode&&console.warn('alphaMode "auto" not supported by I3S PBRMaterial - defaulting to "blend".');const l=n.useSchematicPBR({normalTexture:e.normalTexture,emissiveTexture:s?e.emissiveTexture:null,emissiveFactor:s?t.toUnitRGB(e.emissiveColor):null,occlusionTexture:s?e.occlusionTexture:null,metallicRoughnessTexture:s?e.metallicRoughnessTexture:null,metallicFactor:s?e.metallic:null,roughnessFactor:s?e.roughness:null}),c=l?n.schematicMRRFactors[0]:s?e.metallic:0,u=l?n.schematicMRRFactors[1]:s?e.roughness:0;return{material:{alphaMode:"auto"===e.alphaMode?"blend":e.alphaMode,alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,cullFace:e.doubleSided?0:2,normalTextureId:await a(e.normalTexture,r,i,4),emissiveTextureId:s?await a(e.emissiveTexture,r,i,16):-1,occlusionTextureId:s?await a(e.occlusionTexture,r,i,8):-1,emissiveFactor:s&&null!=e.emissiveColor?t.toUnitRGB(e.emissiveColor):[0,0,0],metallicRoughness:{baseColorFactor:null!=e.color?t.toUnitRGBA(e.color):[1,1,1,1],baseColorTextureId:await a(e.colorTexture,r,i,1),metallicRoughnessTextureId:s?await a(e.metallicRoughnessTexture,r,i,2):-1,metallicFactor:c,roughnessFactor:u},wrapTextures:!0,hasParametersFromSource:l},requiredTextures:r,textureData:i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/glTF/internal/resourceUtils":function(){define(["exports","../../../../core/has"],function(e,t){"use strict";class r{constructor(e){this.data=e,this.type="encoded-mesh-texture",this.encoding="image/ktx2"}}e.EncodedMeshTexture=r,e.imageFromBinaryData=async function(e,i){if("image/ktx2"===i)return new r(e);const s=new Blob([e],{type:i});let n=URL.createObjectURL(s);switch(i){case"image/jpeg":n+="#.jpg";break;case"image/png":n+="#.png"}const o=new Image;if(t("esri-iPhone"))return new Promise((e,t)=>{const r=()=>{s(),e(o)},i=e=>{s(),t(e)},s=()=>{URL.revokeObjectURL(n),o.removeEventListener("load",r),o.removeEventListener("error",i)};o.addEventListener("load",r),o.addEventListener("error",i),o.src=n});try{o.src=n,await o.decode()}catch(e){console.warn("Failed decoding HTMLImageElement")}return URL.revokeObjectURL(n),o},e.isEncodedMeshTexture=function(e){return"encoded-mesh-texture"===e?.type},e.jsonFromBinaryData=async function(e){const t=new Blob([e]),r=await t.text();return JSON.parse(r)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SFrameTask":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/handleUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c){"use strict";let u=class extends r{constructor(){super(),this.referenceCount=0,this.callbacks=new Array,this.runIndex=0}get readyToRun(){return this.callbacks.some(e=>e.running)}runTask(e){this._sort();const t=this.callbacks,r={numIndexLoading:0,numNodesLoading:0};for(let i=0;i<t.length&&!e.done;++i)t[i].priority=t[i].runTask(e,r),this.runIndex=i}_sort(){const e=this.callbacks;let t=e.length;for(let r=this.runIndex;r>0;r--){const i=e[r-1];let s=r;for(;s<e.length&&i.priority<=e[s].priority&&(s!==t||i.priority<e[s].priority);)e[s-1]=e[s],s++;e[s-1]=i,t=s-1}this.runIndex=0}add(e){this._sort(),e.priority=1/0,this.callbacks.unshift(e),this.notifyChange("readyToRun")}remove(e){i.removeUnordered(this.callbacks,e),this.runIndex=this.callbacks.length,this._sort(),this.notifyChange("readyToRun")}};t.__decorate([n.property({readOnly:!0})],u.prototype,"readyToRun",null),u=t.__decorate([l.subclass("esri.views.3d.layers.i3s.I3SFrameTask")],u);class d{constructor(e,t){this.task=e,this.handle=t}}const h=new Map;e.addCallback=function(e,t){let r=h.get(e);if(null==r){const t=new u,i=e.registerTask(c.TaskPriority.I3S_CONTROLLER,t);r=new d(t,i),h.set(e,r)}return r.task.add(t),s.makeHandle(()=>{null!=r&&(r.task.remove(t),r.task.callbacks.length>0||(h.delete(e),r.handle.remove(),r.task.destroy()),r=null)})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SIndex":function(){define(["exports","../../../../core/has","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../geometry/projection/projectBoundingSphere","../../../../chunks/sphere","./I3SNode","./I3SUtil","./ValidatedNode","../../support/ElevationRange","../../support/orientedBoundingBox"],function(e,t,r,i,s,n,o,a,l,c,u){"use strict";class d{constructor(e,t,r,i,s){this.childOffset=e,this.childCount=t,this.visibilityCache=r,this._ref=i,this.node=s,this.useAsHole=0,this.filterImpact=2,this.traversalState=null,this.parent=-1}get ref(){return this._ref}destroy(){this._ref=null,this.node=null,this.traversalState=null}invalidateBounds(){this.node?.invalidateServiceBVsInRenderSR(),this.ref?.invalidateServiceBVsInRenderSR()}}class h{constructor(e=new Array,t=new Array){this._nodeInternals=e,this._children=t,this.lastTraversed=0,this.numNodesWithLoadedChildren=0}destroy(){for(const e of this._nodeInternals)e.destroy();this._nodeInternals.length=0,this._children.length=0}get nodes(){return this._nodeInternals}addNode(e){return this._nodeInternals.push(e),this._nodeInternals.length-1}setNodes(e,t){this._nodeInternals=e,this._children=t}get children(){return this._children}}const p=new Map;class f{constructor(e){this.missing=e,this.update=new r({deallocator:null}),this.add=new r({deallocator:null}),this.remove=new r({deallocator:null}),this.cancel=[]}destroy(){this.update.prune(),this.add.prune(),this.remove.prune(),this.cancel.length=0}reset(e){this.add.clear(),this.update.clear(),this.cancel=e}}function m(e){return a.addWraparound(e,-2)}function g(e){return a.addWraparound(e,2)}function y(e,t){return t+(e?1:0)}function _(e,t){return(-2&e)===t}function b(e){return!(1&~e)}function v(e,t){return e<0?-1:t>0?e/t|0:0}function w(e,t){return e<0?-e-1:0===t?e:e%t}function x(e,t,r){return-1===t?-(e+1):0===r?e:t*r+e}const S=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];function T(e){if(e)for(let t=0;t<e.length;t++)for(const r of S)if(r[0]===e[t].metricType)return{lodMetric:r[1],maxError:e[t].maxError};return{lodMetric:0,maxError:0}}class C{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}class P{constructor(){this.numFeatures=0,this.knownNodes=0,this.missingNodes=0}}function M(e){return Math.sqrt(e*(4/Math.PI))}const R=n.create(),O=n.create(),I=n.create(),F=n.create(),A=t("esri-mobile")?100:300;e.I3SIndex=class{get _useNodePages(){return this._pageSize>0}constructor(e,t,i,s,n,o,a,l,c,u,d,h,p,m,y,_){this.viewingMode=e,this._layer=t,this._streamDataController=s,this._clientNodeLoader=n,this._viewportQueries=o,this._logger=a,this.holeFilling=l,this._isLoaded=c,this._isReloading=u,this._isSelected=d,this._enable=h,this._needsUpdate=p,this._canRequest=m,this._computeVisibilityObb=y,this._computeNodeFiltering=_,this._dirty=!0,this._nodePages=new Map,this._clientNodePage=null,this._pageSize=0,this._rootIndex=0,this._lodMetric=0,this._lodConversion=e=>e,this._isEditable=!1,this._urlPrefix="",this._loadingNodes=new Set,this._loadingPages=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._version=g(0),this._visibilityCacheVersion=g(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missingPagesAndNodes=new r({deallocator:null}),this._prefetchNodes=new r({deallocator:null}),this._updates=new f(this._missingPagesAndNodes),this._imModificationUncategorized=new r({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=new Array,this._newPages=new Array,this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._frameNumber=0,this._traverseDescendantsQueue=[0],this._traverseDescendantsNestingLevel=0,this._isEditable=null!=t.associatedLayer?.infoFor3D,t.serviceUpdateTimeStamp?.lastUpdate&&(this._lastUpdate=`${t.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(i)}_init(e){if("page"===e.type){const t=e.rootPage;switch(this._urlPrefix=e.urlPrefix,this._pageSize=e.pageSize,e.lodMetric){case"maxScreenThreshold":this._lodMetric=1;break;case"maxScreenThresholdSQ":this._lodMetric=1,this._lodConversion=M}if(this._isEditable){this._rootIndex=-1;const r=w(e.rootIndex,e.pageSize),i=t.nodes[r],s={nodes:[{index:this._rootIndex,children:[e.rootIndex],mesh:void 0,obb:i.obb,lodThreshold:i.lodThreshold}]};this._addPage(v(this._rootIndex,this._pageSize),s),this.getNode(-1).serviceObbInIndexSR=void 0}else this._rootIndex=e.rootIndex;this._addPage(v(e.rootIndex,this._pageSize),t),this._updateParentsAndLevel()}else if("node"===e.type){this._urlPrefix=e.urlPrefix;const t=new h;if(this._nodePages.set(0,t),this._isEditable){this._clientNodePage=new h;const t={id:"-1",version:null,mbs:e.rootNode.mbs,obb:e.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:e.rootNode.mbs,obb:e.rootNode.obb}]};this._rootIndex=this._makeClientRefNode(new o.NodeBase(t.id,null),-1);const r=this._validateNode(t.id,t);r&&this._addNode(r,this._rootIndex)}else this._rootIndex=this._makeRefNode(new o.NodeBase(e.rootNode.id,null),-1);const r=this._validateNode(e.rootNode.id,e.rootNode);r&&this._addNode(r,0)}}addClientNodeToIndex(e,t){const r=new o.NodeBase(e,t),i=this._makeClientRefNode(r,-1);return this._linkChildToParentNode(-1,i),this.requestUpdate(),i}removeClientNodeFromIndex(e,t,r){this._destroyClientRefNode(e,t,r),this.requestUpdate()}_loadPage(e){this._loadingPages.add(e);const t=this._urlPrefix+e;this._streamDataController.request(t,0).then(t=>{this._pageQueue.push({pageIndex:e,page:t})}).catch(t=>{this._loadingPages.delete(e),i.isAbortError(t)||(this._failedPages.add(e),this._logger.error("#loadPage()",this._layer,`Error when loading page ${e}`,t))})}_addQueuedPages(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:r}=this._pageQueue.shift();this._addPage(t,r),this._loadingPages.delete(t),e.madeProgress(),this.needNodeElevationRange&&this._newPages.push(t)}this._updateParentsAndLevel()}_invalidateElevationRangeForNewPages(e){if(this.needNodeElevationRange)for(;this._newPages.length>0&&!e.done;){const e=this._nodePages.get(this._newPages.shift());e?.nodes.forEach(e=>{let t=e.parent;for(;null!=t&&t!==this._rootIndex;){const e=this.getNode(t);e&&!Number.isNaN(e?.elevationRangeMin)&&(e.invalidateElevationRange(),this.invalidateBoundingVolumeCache(t)),t=this.getParentIndex(t)}})}}_addPage(e,t){const r=[],i=[],s=t.nodes.map((t,s)=>{const a=r.length,l=t.children?t.children.length:0;i.push(this._rootIndex);for(let e=0;e<l;e++)r.push(t.children[e]);const c=`${t.index}`,h=u.Obb.fromJSON(t.obb),p=n.fromCenterAndRadius(h.center,h.radius),f=t.mesh?.attribute,g=t.mesh?.geometry,y=t.mesh?.material,_={hasSharedResource:!1,isEmpty:null==g,attributes:null!=f?.resource?`${f.resource}`:void 0,geometry:null!=g?.resource?`${g.resource}`:void 0,texture:null!=y?.resource?`${y.resource}`:void 0,geometryDefinition:g?g.definition:-1,materialDefinition:y?y.definition:-1},b=new o.Node(c,x(s,e,this._pageSize),p,l,0,_,this._lastUpdate,this._lodMetric,this._lodConversion(t.lodThreshold),g?.featureCount??null);return b.serviceObbInIndexSR=h,b.visibilityObbInRenderSR=this._computeVisibilityObb(b),b.vertexCount=g?g.vertexCount:0,new d(a,l,m(this._visibilityCacheVersion),null,b)}),a=new h(s,r);-1===e?this._clientNodePage=a:this._nodePages.set(e,a)}_updateParentsAndLevel(){const e=new Array,t=(t,r,i)=>{const s=this._getPage(t);if(null!=s){const n=w(t,this._pageSize),o=s.nodes[n];o.parent=null!=r?r:-1;const a=o.node;null!=a&&(a.level=i,e.push(t))}};for(t(this._rootIndex,null,0);e.length;){const r=e.pop(),i=this.getNode(r);if(null!=i)for(let e=0;e<i.childCount;e++)t(this.getChildIndex(i.index,e),r,i.level+1),this._maxLevel=Math.max(this._maxLevel,i.level+1)}}_getPage(e){const t=v(e,this._pageSize);return this._getPageFromPageIndex(t)}_getPageFromPageIndex(e){return e<0?this._clientNodePage:this._nodePages.get(e)}_getNodeInternal(e){const t=this._getPage(e);return null==t?null:(t.lastTraversed=this._frameNumber,t.nodes[w(e,this._pageSize)])}_addNode(e,t){e.children&&this.populateChildren(t,e.children);const r=this.getParent(t),i=null!=r?r.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?i+1:i);const{lodMetric:s,maxError:n}=T(e.lodSelection),a=this._getNodeInternal(t),l=new o.Node(e.id,t,e.mbs,a.childCount,i,e.resources,e.version,s,n,e.numFeatures);a.node=l,e.obb&&(l.serviceObbInIndexSR=u.Obb.fromJSON(e.obb)),l.visibilityObbInRenderSR=this._computeVisibilityObb(l);const c=a.ref;return null!=c&&(null==c.serviceMbsInIndexSR&&(c.serviceMbsInIndexSR=e.mbs),l.shareServiceBVsInRenderSRWith(c),c.visibilityObbInRenderSR=l.visibilityObbInRenderSR),l}_makeRefNode(e,t){const r=this._nodePages.get(0);if(t<-1)return this._makeClientRefNode(e,t);if(null==r)return-1;const i=r.nodes.length,s=new d(0,0,m(this._visibilityCacheVersion),e,null);return r.addNode(s),s.parent=t,e.invalidateServiceBVsInRenderSR(),i}_makeClientRefNode(e,t){const r=this._clientNodePage;if(null==r)return-1;if(t>=0)throw new Error("I3SIndex::client side nodes can not be made children of service side nodes.");const i=-(r.nodes.length+1),s=new d(0,0,m(this._visibilityCacheVersion),e,null);return r.addNode(s),s.parent=t,e.invalidateServiceBVsInRenderSR(),i}_linkChildToParentNode(e,t){const r=this._clientNodePage;if(null==r||e>=0)return;const i=w(e,this._pageSize),s=w(t,this._pageSize),n=r.nodes[i],o=n.childOffset;r.children.splice(n.childOffset+n.childCount,0,t),n.childCount+=1,null!=n.node&&(n.node.childCount+=1);for(const e of r.nodes)e.childOffset>o&&(e.childOffset+=1);r.nodes[s].parent=e,this._updateParentBoundingInformation(e)}_destroyClientRefNode(e,t,r){const i=this._clientNodePage;if(null==i)return;const s=this.getParentIndex(e);if(null==s)return;const n=new Set,o=new Map,a=e=>{const r=w(e,this._pageSize),s=i.nodes[r];if(s.childCount>0)for(let e=s.childOffset;e<s.childOffset+s.childCount;++e)a(i.children[e]);const o=s.node?.id??s.ref?.id;if(null==o)throw new Error("Node has no id");t(o,e),n.add(s)};a(e);const l=i.nodes,c=i.children,u=i.nodes.map(()=>-1),d=[],h=[];for(let e=0;e<l.length;++e){const t=l[e];if(n.has(t))continue;const i=d.length,s=x(e,-1,this._pageSize),a=x(i,-1,this._pageSize);if(t.node&&(t.node.index=a),u[e]=a,d.push(t),s!==a){const e=t.node?.id??t.ref?.id;if(null==e)throw new Error("Node has no id");r(e,s,a),o.set(s,a)}}for(let e=0;e<d.length;++e){const t=x(e,-1,this._pageSize),r=d[e],i=h.length;for(let e=r.childOffset;e<r.childOffset+r.childCount;++e){const r=c[e];if(r>=0)h.push(r);else{const e=w(r,this._pageSize),i=l[e];if(n.has(i))continue;const s=u[e];h.push(s),i.parent=t}}r.childOffset=i,r.childCount=h.length-i,r.node&&(r.node.childCount=r.childCount)}i.setNodes(d,h),this._updateParentBoundingInformation(u[w(s,this._pageSize)])}_updateParentBoundingInformation(e){let t=e;do{let e=null;const r=this._clientNodeLoader.indexSR,i=this._clientNodeLoader.renderSR,o=this._getNodeInternal(t);if(null==o)return;for(let a=0;a<o.childCount;a++){const o=this.getChildIndex(t,a),l=this._getNodeInternal(o),c=null!=l?l.ref||l.node:null;if(null!=c&&c.serviceMbsInIndexSR[3]>0)if(null==e)e=n.copy(c.serviceMbsInIndexSR,R);else{const t=O,o=I,a=F;s.projectBoundingSphere(c.serviceMbsInIndexSR,r,t,i),s.projectBoundingSphere(e,r,o,i),n.union(t,o,a),s.projectBoundingSphere(a,i,e,r)}}const l=t=>{null!=t&&(t.serviceObbInIndexSR=null,null!=e?(t.serviceMbsInIndexSR??=n.create(),n.copy(e,t.serviceMbsInIndexSR)):a.invalidateMbs(t.serviceMbsInIndexSR),t.invalidateServiceBVsInRenderSR(),t.geometryObbInRenderSR=null)};l(o.ref),l(o.node),this.invalidateNodeVisibilityCacheInternal(o),t=this.getParentIndex(t)}while(null!=t)}populateChildren(e,t){const r=this._getNodeInternal(e),i=this._getPage(e);r.childOffset=i.children.length,r.childCount=t.length;for(let r=0;r<t.length;r++){const s=this._makeRefNode(t[r],e);i.children.push(s)}}getNode(e){const t=this._getNodeInternal(e);return null!=t?t.node:null}getIndexById(e){let t;return this._forAllNodes((r,i)=>{(null!=r.node&&r.node.id===e||null!=r.ref&&r.ref.id===e)&&(t=i)}),t}getNodeById(e){const t=this.getIndexById(e);return null!=t&&t>=0?this.getNode(t):null}getChildIndex(e,t){const r=this._getPage(e);if(null==r)return-1;const i=r.nodes[w(e,this._pageSize)];return r.children[i.childOffset+t]}getParentIndex(e){const t=this._getPage(e);return null!=t&&e!==this._rootIndex?t.nodes[w(e,this._pageSize)]?.parent:null}getParent(e){const t=this.getParentIndex(e);return null!=t?this.getNode(t):null}isLeaf(e){const t=this._getNodeInternal(e);return null!=t&&0===t.childCount}get rootNode(){return this.getNode(this._rootIndex)}get isEditable(){return this._isEditable}removeAllGeometryObbs(){this._forAllNodes(e=>{null!=e.node&&(e.node.geometryObbInRenderSR=null)})}invalidateVisibilityCache(){this._visibilityCacheVersion=g(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(e){const t=this._getNodeInternal(e);null!=t&&this.invalidateNodeVisibilityCacheInternal(t)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=m(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(e){const t=this._getNodeInternal(e);null!=t&&(t?.invalidateBounds(),this.invalidateNodeVisibilityCacheInternal(t))}updateElevationChanged(e){const t=this._getNodeInternal(e);if(null==t)return;if(!this.needNodeElevationRange)return void this.invalidateBoundingVolumeCache(e);const r=null!=t.node?t.node:t.ref;null!=r&&r.invalidateElevationRange()}invalidateGeometryVisibility(e){const t=this._getNodeInternal(e),r=t?.node;r&&(r.geometryObbInRenderSR=null,r.invalidateServiceBVsInRenderSR())}invalidateVisibilityObbs(){null!=this.rootNode&&this.traverse(this.rootNode,e=>(e.visibilityObbInRenderSR=this._computeVisibilityObb(e),e.geometryObbInRenderSR=null,!0))}_isElevationRangeUpToDate(e){if(!this.needNodeElevationRange)return!0;const t=e?.node??e?.ref;return!t||t.elevationRangeValid}updateElevationRange(e){this._updateElevationRangeInternal(e,null)}_updateElevationRangeInternal(e,t){const r=this._getNodeInternal(e);if(!r)return!1;const i=r?.node??r?.ref;if(!i)return!1;if(i.elevationRangeValid)return t?.expandElevationRange(i),!0;const s=new c.ElevationRange;let n=!1;for(let t=0;t<r.childCount;t++){const r=this.getChildIndex(e,t),i=this._updateElevationRangeInternal(r,s);n=n||!i}if(0===r.childCount||n){const e=!r.node?.resources.isEmpty;this._viewportQueries.expandElevationRange(i,e,s)}const o=i.elevationRangeMin,a=i.elevationRangeMax;return o===s.elevationRangeMin&&a===s.elevationRangeMax?(t?.expandElevationRange(i),!0):(r.node?.setElevationRange(s),r.ref?.setElevationRange(s),this.invalidateBoundingVolumeCache(e),t?.expandElevationRange(i),!0)}isNodeVisible(e){const t=this._getNodeInternal(e);if(null==t)return!0;const r=t.ref;if(null!=r&&!r.serviceMbsInIndexSR)return!0;if(this._isElevationRangeUpToDate(t)&&_(t.visibilityCache,this._visibilityCacheVersion))return b(t.visibilityCache);const i=t.node,s=this._viewportQueries;if(i){const e=s.ensureElevationAgnosticBoundingVolume(i),r=s.isElevationAgnosticBoundingVolumeVisible(e);let n=r;if(this.needNodeElevationRange&&r){const t=s.getNodeObbInRenderSRIndependentOfElevationOffset(i);null!=t&&(n=s.isObbVisibleIndependentOfElevation(e,t))}if(!n)return t.visibilityCache=y(!1,this._visibilityCacheVersion),!1}if(this._layerHasFilter&&this._computeNodeFiltering&&(null!=i||null!=r)&&2===t.filterImpact){const e=null!=i?i.serviceMbsInIndexSR:null!=r?r.serviceMbsInIndexSR:null;t.filterImpact=null!=e?this._computeNodeFiltering(e):0}const n=null!=i&&1===t.filterImpact;let o=!(null!=i&&2===i.imModificationImpact||n);if(o){const t=!i||r&&!i.visibilityObbInRenderSR?r??null:i;null!=t&&(this.needNodeElevationRange&&this.updateElevationRange(e),o=s.isNodeVisible(t))}return t.visibilityCache=y(o,this._visibilityCacheVersion),o}isGeometryVisible(e){if(!this.isNodeVisible(e))return!1;const t=this._getNodeInternal(e);return!!(null==t?.node?.geometryObbInRenderSR||this.layerHasModifications&&4===t.node.imModificationImpact)||this._viewportQueries.isGeometryVisible(t.node)}_traverseCoverage(e,t,r,i,s){const n=this._getPage(e);if(null==n||0===t.childCount)return;const o=t.childOffset+t.childCount,a=new Array;for(let e=t.childOffset;e<o;++e){const t=n.children[e],r=this._getNodeInternal(t);null!=r?.node&&this.isGeometryVisible(t)&&a.push(r)}i/=a.length;for(const e of a){const t=e.node.index;this._isLoaded(t)||this._isReloading(t)?(s.delta=Math.max(s.delta,r),s.coverage+=i):this._traverseCoverage(t,e,r+1,i,s)}}useNodeAsHole(e){if("off"===this.holeFilling)return!1;const t=this._getNodeInternal(e);if(null==t)return!1;if("always"===this.holeFilling)return!0;if(_(t.useAsHole,this._version))return b(t.useAsHole);const r={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,r);const i=r.delta*r.coverage<=.5;return t.useAsHole=y(i,this._version),i}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.destroy(),this._nodePages.clear(),this._clientNodePage=null,this._layer=null,this._missingPagesAndNodes.prune(),this._prefetchNodes.prune(),this._imModificationUncategorized.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=g(this._version)}imModificationsChanged(e){this.layerHasModifications=e,this._forAllNodes(({node:e})=>{null!=e&&(e.imModificationImpact=4,e.visibilityObbInRenderSR=this._computeVisibilityObb(e),e.hasModifications&&this.invalidateGeometryVisibility(e.index))}),this.invalidateVisibilityCache()}layerFilterChanged(e){this._layerHasFilter=e,this._forAllNodes(e=>{if(null!=e){e.filterImpact=2;const t=e.node;null!=t&&this.invalidateNodeVisibilityCache(t.index)}}),this.invalidateVisibilityCache()}update(e,t,r){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(t),this._invalidateElevationRangeForNewPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missingPagesAndNodes.clear(),this._prefetchNodes.clear(),this._updates.reset(e),p.clear();let i=!0;const s=new C,n=new P,o=this._imModificationUncategorized;o.clear();const a=new Set;let l=0;this.traverseVisible((a,c,u)=>{const d=v(a,this._pageSize);if(null==c){let e=this._entryPriority(a);return e===1/0&&(e=this._entryPriority(u)),p.set(d,Math.max(e,p.get(d)||0)),this._loadingPages.has(d)||this._failedPages.has(d)||(this._missingPagesAndNodes.push(d),++l),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const h=c.node;if(this._updateNodeFeatureEstimate(h,n),null==h){const e=this._entryPriority(a);return this._loadingNodes.has(a)||this._failedNodes.has(a)||(this._missingPagesAndNodes.push(a),p.set(a,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const f=this._getPage(a);if(0===this._missingPagesAndNodes.length&&!this._useNodePages)for(let e=0;e<c.childCount;e++){const t=f.children[c.childOffset+e],r=this._getNodeInternal(t);null!=r&&!r.node&&!this._loadingNodes.has(t)&&!this._failedNodes.has(t)&&t>=0&&(p.set(t,this._entryPriority(t)),this._prefetchNodes.push(t))}if(h.failed||h.resources.isEmpty)return void(i&&c.childCount>0&&this._isSelected(h)&&(i=!1));if(this._isLoaded(a)){if(s.known+=h.memory,++s.knownNodes,this._isSelected(h)?c.childCount>0&&(i=!1):(s.unremoved+=h.memory,i=!1),this._needsUpdate(h)){const e=this._entryPriority(a);p.set(a,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(a)}return}if(h.memory&&(s.known+=h.memory,++s.knownNodes),!this._isSelected(h))return void(this._isReloading(a)&&this._updates.remove.push(a));if(c.childCount>0&&(i=!1),h.memory?(s.missing+=h.memory,s.known+=h.memory,++s.knownNodes):++s.missingNodes,e.includes(h.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(a)),void(this._updates.cancel=this._updates.cancel.filter(e=>e!==h.index));if(!t.done&&this._enable(h))return void t.madeProgress();const m=this._entryPriority(a);p.set(a,m),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,m),this._updates.add.push(a),this.layerHasModifications&&r&&null!=h&&4===h.imModificationImpact&&o.push(a)},a),this._frameNumber++,this._missingPagesAndNodes.sort((e,t)=>e-t),this._missingPagesAndNodes.filterInPlace((e,t)=>t<1||this._missingPagesAndNodes.data[t-1]!==e),this._missingPagesAndNodes.sort((e,t)=>p.get(e)-p.get(t)),this._missingPagesAndNodes.length>0&&(this._maxUnloadedPrio=p.get(this._missingPagesAndNodes.back()),this._prefetchNodes.clear()),this._removeUnusedNodePages(a,l);const c=this._updates.add;c.length>0&&this.layerHasModifications&&(o.length>0&&r?.(o),c.filterInPlace(e=>{const t=this._getNodeInternal(e),r=null==t?.node||2!==t.node.imModificationImpact;return r||this.invalidateNodeVisibilityCache(e),r})),this._unloadedMemoryEstimate=s.missing-s.unremoved,s.knownNodes>3&&s.missingNodes>0&&(this._unloadedMemoryEstimate+=s.known/s.knownNodes*s.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(n),this._featureEstimate.leavesReached=i,this._updates.add.filterInPlace(e=>p.get(e)>=this._maxUnloadedPrio).sort((e,t)=>p.get(e)-p.get(t)),this._updates.update.sort((e,t)=>p.get(e)-p.get(t)),this._indexMissing=this._loadingPages.size+this._loadingNodes.size+this._missingPagesAndNodes.length,this._dirty=this._indexMissing>0,p.clear()}checkFeatureTarget(e,t){const r=this._viewportQueries.updateScreenSpaceErrorBias(t);let i=t,s=t,n=r,o=10;for(;o--;){const r=new P;if(this._updateFeatureEstimate(i,r),this._computeFeatureEstimate(r)<=e){if(i>=t||r.missingNodes>0||0===o)break;n=i,i=.5*(i+s)}else s=i,i=.5*(i+n)}return this._version=g(this._version),this._viewportQueries.updateScreenSpaceErrorBias(r),Math.min(t,i)}_removeUnusedNodePages(e,t){if(!this._useNodePages)return;const r=e.size,i=this._nodePages,s=i.size+this._loadingPages.size+t;if(s>A&&s>r){const t=new Array;for(const[r,s]of i)0!==s.numNodesWithLoadedChildren||e.has(r)||t.push([s.lastTraversed,r]);t.sort((e,t)=>e[0]-t[0]).some(e=>{const t=e[1];return this._deleteNodePage(t),i.size<=A})}}_updateFeatureEstimate(e,t){this._version=g(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((e,r)=>this._updateNodeFeatureEstimate(r?.node,t))}_updateNodeFeatureEstimate(e,t){null!=e&&!e.failed&&this._isSelected(e)&&(null!=e.numFeatures?(t.numFeatures+=e.numFeatures,++t.knownNodes):++t.missingNodes)}_computeFeatureEstimate(e){let t=e.numFeatures;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.numFeatures/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missingPagesAndNodes)}prefetch(){return this._prefetchNodes.sort((e,t)=>p.get(e)-p.get(t)),this._load(this._prefetchNodes)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();){const t=e.pop();this._useNodePages&&t>=0?this._loadPage(t):this._loadNode(t)}return!0}get isLoading(){return this._indexMissing>0}get isPrefetching(){return this._prefetchNodes.length>0}get indexLoading(){return this._loadingPages.size+this._loadingNodes.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}nodeTraversalState(e){if(null==e)return null;const t=e.index,r=this._getNodeInternal(t);if(!r)return null;let i=r?.traversalState;if(i&&_(i.version,this._version))return i;const s=this._viewportQueries.getLodLevel(e),n=this._viewportQueries.hasLOD(e);let a=!0;if(n){const e=this.getParentIndex(t);if(null!=e){const t=this._getNodeInternal(e),r=t?.traversalState;a=!!r&&s>r.lodLevel}else a=s>0}else a=0===e.childCount;return i?(i.lodLevel=s,i.isChosen=a,i.version=y(!0,this._version),i):(i=new o.NodeTraversalState(n,a,s,y(!0,this._version)),r.traversalState=i,i)}async _loadNode(e){this._loadingNodes.add(e);const t=this._getNodeInternal(e).ref;if(null==t)return void this._failedNodes.add(e);const r=t.id,s=this._urlPrefix+r,n=()=>{this._loadingNodes.delete(e),0===this._missingPagesAndNodes.length&&0===this._loadingNodes.size&&this.requestUpdate()};let o=null;try{o=e>=0?await this._streamDataController.request(s,0):await this._clientNodeLoader.loadNodeJSON(r)}catch(t){return n(),void(i.isAbortError(t)||(this._logger.error("#loadNode()",this._layer,"Error loading node: "+s),this._failedNodes.add(e)))}n();const a=this._validateNode(r,o);if(null==a)return;a.obb&&this.invalidateNodeVisibilityCache(e);const l=this._addNode(a,e);this.nodeTraversalState(l)}_validateNode(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._layer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._layer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,`Invalid shared resource href on node "${e}"`);const r=t.geometryData;null==r||Array.isArray(r)&&0===r.length||Array.isArray(r)&&1===r.length&&"./geometries/0"===r[0].href||this._logger.warn("#validateNode()",this._layer,`Invalid geometry data on node "${e}"`);const i=t.attributeData,s=this._layer.attributeStorageInfo;null==i||Array.isArray(i)&&!i.some((e,t)=>e.href!==`./attributes/${s?.[t]?.key??`f_${t}`}/0`)||this._logger.warn("#validateNode()",this._layer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._layer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const n=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:void 0,a=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:void 0,c=Array.isArray(t.children)?t.children.map(t=>{if(null==t)return null;const r=t=>this._logger.error("#validateNode()",this._layer,`Invalid node reference on node ${e}: ${t}`);if("number"==typeof t.id)r(`id ${t.id} is a number instead of a string.`);else if("string"!=typeof t.id||!Array.isArray(t.mbs))return r("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return r(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!=="../"+t.id&&this._logger.error("#validateNode()",this._layer,`Invalid node href on node "${e}"`);const i=new o.NodeBase(`${t.id}`,t.mbs);return i.serviceObbInIndexSR=!this.ignoreServiceObb&&t.hasOwnProperty("obb")&&t.obb?u.Obb.fromJSON(t.obb):null,i.visibilityObbInRenderSR=this._computeVisibilityObb(i),i}).filter(e=>null!=e):null,d=t.featureData?.length??!1,h=!0===t.isEmpty;return new l.ValidatedNode(e,t.mbs,n,"string"==typeof t.version?t.version:null,{isEmpty:!d&&h,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:void 0,texture:t.textureData&&t.textureData.length>0?e:void 0,geometry:null!=t.geometryData?e:void 0},c,Array.isArray(t.lodSelection)?t.lodSelection:null,a)}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes(e=>{null!=e.node&&(e.node.failed=!1)})}_entryPriority(e){const t=this._getNodeInternal(e),r=this.getParentIndex(e);if(null==t||null==r&&null==t.node)return null==r?1/0:this._entryPriority(r);let i=0;if(t.node&&null!=r){const e=this._getNodeInternal(r).traversalState;null!=e&&(i=e.lodLevel)}let s=this.progressiveLoadPenalty;for(let t=e;null!=t;t=this.getParentIndex(t))if(this._isLoaded(t)){s=0;break}const n=null!=t.ref?this._viewportQueries.distToPOI(t.ref):null!=t.node?this._viewportQueries.distToPOI(t.node):0;return-n-i*(n+this.progressiveLoadPenalty)+s}traverseVisible(e,t){const r=this._getNodeInternal(this._rootIndex);null!=r?this._traverseVisible(this._rootIndex,null,r,e,t):e(this._rootIndex,null,null)}_traverseVisible(e,t,r,i,s){const n=v(e,this._pageSize);if(s&&s.add(n),r.node&&0===r.childCount)return void(this.isGeometryVisible(e)&&i(e,r,t));if(!this.isNodeVisible(e))return;if(i(e,r,t),null==r.node)return;const o=this.nodeTraversalState(r.node);if(o?.nodeHasLOD&&o.lodLevel===this._maxLodLevel)return;const a=this._getPageFromPageIndex(n);for(let t=0;t<r.childCount;t++){const n=a.children[r.childOffset+t],o=this._getNodeInternal(n);if(o)this._traverseVisible(n,e,o,i,s);else{if(s){const e=v(n,this._pageSize);s.add(e)}i(n,null,e)}}}traverse(e,t){t(e)&&this.traverseDescendants(e,t)}traverseDescendants(e,t){++this._traverseDescendantsNestingLevel;const r=e.index,i=this._pageSize,s=v(r,i),n=this._getPageFromPageIndex(s);if(null==n)return;const o=this._frameNumber,a=this._nodePages,l=w(r,i),c=n.nodes[l],u=c.childCount;if(n.lastTraversed=o,0===u)return;const d=new Array,h=1===this._traverseDescendantsNestingLevel?this._traverseDescendantsQueue:[0];let p=0;{const{childOffset:e,childCount:t}=c,{children:r}=n;h.length=2**Math.ceil(Math.log2(p+t));for(let i=e;i<e+t;++i){const e=r[i];e>=0?(h[p]=e,++p):d.push(e)}}if(d.length>0){const e=this._clientNodePage;if(e){const r=e.children;let i=0;for(;i<d.length;){const s=d[i];++i;const n=-s-1,o=e.nodes[n],a=o.node;if(!a||!t(a))continue;const{childCount:l}=o;if(0===l)continue;const{childOffset:c}=o,u=c+l;for(let e=c;e<u;++e)d.push(r[e])}}}if(p>0){let e=0;if(i>0){let r=s*i,l=n,c=l.nodes;for(;e<p;){const s=h[e];let n;if(++e,r<=s&&s<r+i)n=l;else{const e=s/i|0,t=a.get(e);if(void 0===t)continue;n=t,n.lastTraversed=o,l=n,c=l.nodes,r=i*e}const u=c[s-r],d=u.node;if(null==d||!1===t(d))continue;const{childCount:f}=u;if(0===f)continue;const m=p+f;for(h.length<m&&(h.length=2**Math.ceil(Math.log2(p+f)));h.length<p+f;)h.length+=h.length;const g=n.children,{childOffset:y}=u,_=y+f;for(let e=y;e<_;++e)h[p]=g[e],++p}}else{const r=a.get(0);if(r)for(;e<p;){const i=h[e++],s=r.nodes[i],n=s.node;if(!n||!t(n))continue;const{childCount:o}=s;if(0===o)continue;h.length=Math.max(h.length,2**Math.ceil(Math.log2(p+o)));const a=r.children,{childOffset:l}=s,c=l+o;for(let e=l;e<c;++e)h[p]=a[e],++p}}}--this._traverseDescendantsNestingLevel}updateChildrenLoaded(e,t){let r=this.getNode(e);for(;null!=r;){const e=r.childrenLoaded,i=e+t;r.childrenLoaded=i;const s=0===e?1:0===i?-1:0,n=r.index;0!==s&&(this._getPage(n).numNodesWithLoadedChildren+=s),r=this.getParent(n)}}checkChildrenLoadedInvariant(){return!0}updateElevationInfo(e,t){this.needNodeElevationRange=t&&!!e&&("relative-to-ground"===e.mode||"relative-to-scene"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes(e=>{e?.invalidateBounds(),e.node?.invalidateElevationRange(),e.ref?.invalidateElevationRange()})}_forAllNodes(e){if(null!=this._clientNodePage){const t=this._clientNodePage;for(let r=0;r<t.nodes.length;r++)e(t.nodes[r],-(r+1))}for(const[t,r]of this._nodePages){const i=t*this._pageSize;for(let t=0;t<r.nodes.length;t++)e(r.nodes[t],i+t)}}clearCaches(){if(this._useNodePages){const e=this._nodePages,t=new Set;this.traverseVisible(e=>t.add(v(e,this._pageSize)));for(const[r,i]of e)if(0!==i.numNodesWithLoadedChildren||t.has(r))for(const e of i.nodes)e.traversalState=null;else this._deleteNodePage(r)}}_deleteNodePage(e){const t=this._nodePages.get(e);this._nodePages.delete(e),t?.destroy()}get test(){}},e.selectErrorMetric=T,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SNode":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../chunks/sphere","./I3SUtil","../../support/ElevationRange"],function(e,t,r,i,s){"use strict";class n extends s.ElevationRange{constructor(e,t){super(NaN,NaN),this.id=e,this.serviceMbsInIndexSR=t,this.serviceMbsInRenderSR=r.fromValues(0,0,0,-1)}invalidateServiceBVsInRenderSR(){i.invalidateMbs(this.serviceMbsInRenderSR),this.serviceObbInRenderSR?.invalidate()}shareServiceBVsInRenderSRWith(e){this.serviceObbInRenderSR=e.serviceObbInRenderSR,this.serviceMbsInRenderSR=e.serviceMbsInRenderSR}}e.Node=class extends n{constructor(e,r,i,s,n,o,a,l,c,u){super(e,i),this.index=r,this.childCount=s,this.level=n,this.resources=o,this.version=a,this.lodMetric=l,this.maxError=c,this.numFeatures=u,this.failed=!1,this.cacheState=0,this.vertexCount=0,this.memory=0,this.childrenLoaded=0,this.hasModifications=!1,this.imModificationImpact=4,this.elevationAgnosticBoundingVolume=t.fromValues(0,0,0,-1)}invalidateServiceBVsInRenderSR(){super.invalidateServiceBVsInRenderSR(),this.elevationAgnosticBoundingVolume[3]=-1}},e.NodeBase=n,e.NodeTraversalState=class{constructor(e,t,r,i){this.nodeHasLOD=e,this.isChosen=t,this.lodLevel=r,this.version=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/ValidatedNode":function(){define(["exports"],function(e){"use strict";e.ValidatedNode=class{constructor(e,t,r,i,s,n,o,a){this.id=e,this.mbs=t,this.obb=r,this.version=i,this.resources=s,this.children=n,this.lodSelection=o,this.numFeatures=a}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SNodeLoader":function(){define(["../../../../core/asyncUtils","../../../../core/has","../../../../core/lang","../../../../core/promiseUtils","../../../../core/urlUtils","./I3SBinaryReader","./I3SMaterialUtil"],function(e,t,r,i,s,n,o){"use strict";class a{constructor(e,t,r,i,s,n){if(this._streamDataController=t,this._logger=r,this._defaultGeometrySchema=i,this._requiredAttributes=s,this._options=n,this._logLayer=e,this._layerUrl=e.parsedUrl.path,this._geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const t=e.textureSetDefinitions;this._materialAndTextures=e.materialDefinitions.map(r=>o.getMaterialAndTextures(t,r,"integrated-mesh"===e.type))}}_load(e,t,r){return this._streamDataController.request(e,t,r)}_loadAttribute(e,t,r){const i=`${this._layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`;return this._load(i,1,r).then(e=>n.readBinaryAttribute(t,e))}async loadAttributes(e,t,r){const s=await Promise.allSettled(t.map(t=>this._loadAttribute(e,t.attributeStorageInfo,r))),n={};for(let r=0;r<t.length;++r){const o=s[r],a=t[r];if("fulfilled"===o.status){const e=o.value;n[a.name]=e}else{const t=o.reason;i.throwIfAbortError(t),this._logger.error("#loadAttributes",this._logLayer,`Failed to load attributeData for '${a.name}' on node '${e.id}'`,t)}}return n}async loadNodeData(i,s){const a=null!=this._requiredAttributes&&i.resources.attributes?e.result(this.loadAttributes(i,this._requiredAttributes,s)):null,{bufferDefinition:l,bufferIndex:c}=function(e,r){const i={bufferDefinition:null,bufferIndex:0},s=r.resources.geometryDefinition;if(null==e||null==s||s<0)return i;const n=s>=0?e[s].geometryBuffers:null;if(null==n)return i;for(let e=0;e<n.length;e++){const r=n[e];if(null==r.compressedAttributes)i.bufferIndex=e,i.bufferDefinition=n[e];else if("draco"===r.compressedAttributes.encoding&&!t("disable-feature:i3s-draco"))return i.bufferIndex=e,i.bufferDefinition=r,i}return i}(this._geometryDefinitions,i),u=!!i.resources.geometry,d=u?e.result(this._loadGeometry(i.resources.geometry,c,s)):null,h=i.resources.hasSharedResource?await this._loadShared(i,s):null,p=i.resources.materialDefinition,f=this._materialAndTextures&&null!=p&&p>=0?this._materialAndTextures[p]:null!=h?o.getMaterialAndTexturesFromShared(h):null,m=f?.material,g=f?.textures??[],y=`${i.id}`,_=!u&&this._options.loadFeatureData,b=_?await this._loadFeatureData(y,s):null,v=_?function(e){if(!e)return null;for(const t of e.featureData){const e=t.geometries;if(null!=e)for(const r of e)return{featureIds:[t.id],featureDataPosition:t.position,geometries:[r]}}return null}(b):function(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}(m),w=null==v?function(e){if(!e)return null;const t=new Array;for(const r of e.featureData)null!=r.position&&t.push({featureIds:[r.id],featureDataPosition:r.position,geometries:[]});return t}(b):null,x=g.length>0?e.result(this.loadTextures(i,g,s)):null;let S=null,T=null;if(d){S=e.assertResult(await d);const t=function(e,t){if(!e||!t?.materialDefinitions)return e;const i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=r.clone(e)).vertexAttributes.region,e}(this._defaultGeometrySchema,h);T=n.createGeometryDescriptor(l,t)}const C=x?e.assertResult(await x):null,P=a?e.assertResult(await a):{},M=P?{attributeData:P,loadedAttributes:this._requiredAttributes}:null;if(null!=v)return{geometryData:v,attributeDataInfo:M,geometryBuffer:S,geometryDescriptor:T,requiredTextures:g,textureData:C};if(null!=w)return{pointData:w,attributeDataInfo:M,geometryBuffer:S,geometryDescriptor:T,requiredTextures:g,textureData:C};throw new Error}static _addAbsoluteHrefTexture(e,t){const r=e.textureDefinitions;if(null!=r)for(const e of Object.keys(r))for(const i of r[e].images)Array.isArray(i.href)?i.hrefConcat=i.href.map(e=>s.makeAbsolute(e,t)):i.hrefConcat=s.makeAbsolute(i.href,t)}static _fixTextureEncodings(e){const t=e.textureDefinitions;if(null!=t)for(const e in t){const r=t[e];if(Array.isArray(r.encoding))for(let e=0;e<r.encoding.length;e++){const t=r.encoding[e];t.startsWith("data:")&&(r.encoding[e]=t.slice(5))}else{const e=r.encoding;e.startsWith("data:")&&(r.encoding=e.slice(5))}}}async _loadShared(e,t){if(null==e.resources.geometry)return{};const r=`${this._layerUrl}/nodes/${e.resources.geometry}/shared`,i=await this._load(r,0,t);return a._fixTextureEncodings(i),a._addAbsoluteHrefTexture(i,r),i}_loadTexture(e,t,r,i,s){return 4===i||1===i||2===i?this._load(e,1,s).then(e=>({id:t,usage:r,data:e,encoding:i})):this._load(e,2,s).then(e=>({id:t,usage:r,data:e,encoding:i}))}loadTextures(e,t,r){const i=this._options.textureUsageMask;return Promise.all(t.map(t=>{if(0===(t.usage&i))return null;const s=o.selectEncoding(t.encodings,this._options.textureEncodings);if(null==s)return this._logger.error("#loadTextures",this._logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject();const n=e.resources.texture||e.id,a=`${this._layerUrl}/nodes/${n}/textures/${s.name}`;return this._loadTexture(a,t.id,t.usage,s.encoding,r)}))}_loadFeatureData(e,t){const r=`${this._layerUrl}/nodes/${e}/features/0`;return this._load(r,0,t)}_loadGeometry(e,t,r){const i=`${this._layerUrl}/nodes/${e}/geometries/${t}`;return this._load(i,1,r)}}return a})},"esri/views/3d/layers/i3s/I3SMaterialUtil":function(){define(["exports","../../../../core/colorUtils","../../../../core/has","../../../../core/mathUtils","./enums","../../webgl-engine/core/material/RenderTexture","../../webgl-engine/core/shaderLibrary/util/EllipsoidMode","../../webgl-engine/lib/Texture","../../webgl-engine/materials/pbrUtils","../../../../webscene/support/AlphaCutoff"],function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(e){return e.sort((e,t)=>e.encoding-t.encoding)}const d={ktx2:1,basis:2,dds:4,png:8,jpg:16,"ktx-etc2":32},h={"image/ktx2":2,"image/x.basis":2,"image/vnd-ms.dds":4,"image/png":8,"image/jpg":16,"image/jpeg":16,"image/ktx":32},p=()=>({alphaMode:"opaque",alphaCutoff:c.alphaCutoff,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}),f={s:33071,t:33071},m={s:10497,t:10497};e.configureMaterial=function(e,r,i,s,a,u){const d=u.rendererTextureUsage,h=e=>function(e,t,r){if(null==e||0===r)return null;for(let i=0;i<e.length;i++){const s=e[i];if(null!=s&&0!==(s.usage&r)){const e=t[i];return null!=e?e.id:null}}return null}(s,i,e&d),p=t.validateColorAndOpacity(r.metallicRoughness.baseColorFactor);e.baseColor=[p[0],p[1],p[2],p[3]],e.hasParametersFromSource=!!r.hasParametersFromSource,e.usePBR=u.usePBR,e.mrrFactors=[r.metallicRoughness.metallicFactor,r.metallicRoughness.roughnessFactor,r.hasParametersFromSource?l.schematicMRRFactors[2]:l.advancedMRRFactors[2]],e.emissiveBaseColor=r.emissiveFactor,e.isIntegratedMesh=u.isIntegratedMesh,e.textureAlphaCutoff="mask"===r.alphaMode?r.alphaCutoff:c.alphaCutoff,e.alphaDiscardMode="opaque"===r.alphaMode?1:"mask"===r.alphaMode?2:3;const f=[],m=h(33);null!=m&&(e.baseColorTexture=new n.RenderTexture(a,m),f.push(e.baseColorTexture.loadPromise));const g=h(2);null!=g&&(e.metallicRoughnessTexture=new n.RenderTexture(a,g),f.push(e.metallicRoughnessTexture.loadPromise));const y=h(16);null!=y&&(e.emissionTexture=new n.RenderTexture(a,y),f.push(e.emissionTexture.loadPromise));const _=h(8);null!=_&&(e.occlusionTexture=new n.RenderTexture(a,_),f.push(e.occlusionTexture.loadPromise));const b=h(4);return null!=b&&(e.normalTexture=new n.RenderTexture(a,b),f.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.hasSlicePlane=u.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=r.doubleSided,e.commonMaterialParameters.cullFace=r.cullFace,e.ellipsoidMode=o.getEllipsoidMode(u.viewSpatialReference),Promise.all(f)},e.createTexture=function(e,t,i,n,o,l){if(null==e?.data)return null;const c=e.data,u=n.renderingContext.parameters.maxMaxAnisotropy,d=u>1,h=i||!t.wrapTextures?f:m,p=function(e){switch(e){case 1:return"image/ktx2";case 2:return"image/x.basis";case 4:return"image/vnd-ms.dds";case 8:return"image/png";case 16:return"image/jpeg";case 32:return"image/ktx";default:return""}}(e.encoding),g=1&e.usage?"opaque"===t.alphaMode?3:4:3,y=function(e,t){return!(!r("enable-feature:esri-compress-IM-textures")||0===(e&s.uncompressedFormats)||t&~s.compressibleUsages)}(e.encoding,e.usage)?{compressionTracker:o,compressionCallback:l}:void 0;return new a.Texture(c,{mipmap:d,maxAnisotropy:u,encoding:p,wrap:h,components:g,compressionOptions:y,noUnpackFlip:!0})},e.defaultMaterial=p,e.getMaterialAndTextures=function(e,i,s){const n=new Map,o=(e,t)=>{if(null==e)return-1;const r=n.get(e.id);if(r)return r.usage|=t,r.id;const i=n.size;return n.set(e.id,{id:i,usage:t}),i},a=i.pbrMetallicRoughness,c=a?.baseColorFactor?t.validateColorAndOpacity(a.baseColorFactor):null,h=i.emissiveFactor,p=r("disable-feature:diffuse-rendering-i3s")||s?l.useSchematicPBRI3S({normalTexture:i.normalTexture,emissiveTexture:i.emissiveTexture,emissiveFactor:i.emissiveFactor,occlusionTexture:i.occlusionTexture,metallicRoughnessTexture:a?.metallicRoughnessTexture,metallicFactor:a?.metallicFactor,roughnessFactor:a?.roughnessFactor}):l.useSchematicPBR({normalTexture:i.normalTexture,emissiveTexture:i.emissiveTexture,emissiveFactor:i.emissiveFactor,occlusionTexture:i.occlusionTexture,metallicRoughnessTexture:a?.metallicRoughnessTexture,metallicFactor:a?.metallicFactor,roughnessFactor:a?.roughnessFactor}),f=p?l.schematicMRRFactors[0]:a?.metallicFactor??l.advancedMRRFactors[0],m=p?l.schematicMRRFactors[1]:a?.roughnessFactor??l.advancedMRRFactors[1],g="mask"===i.alphaMode?33:1,y={baseColorFactor:c?[c[0],c[1],c[2],c[3]]:[1,1,1,1],baseColorTextureId:o(a?.baseColorTexture,g),metallicRoughnessTextureId:o(a?.metallicRoughnessTexture,2),metallicFactor:f,roughnessFactor:m},_={alphaMode:i.alphaMode,alphaCutoff:i.alphaCutoff,doubleSided:i.doubleSided,cullFace:"none"===i.cullFace?0:"back"===i.cullFace?2:"front"===i.cullFace?1:0,normalTextureId:o(i.normalTexture,4),emissiveTextureId:o(i.emissiveTexture,16),occlusionTextureId:o(i.occlusionTexture,8),emissiveFactor:h?[h[0],h[1],h[2]]:[0,0,0],metallicRoughness:y,wrapTextures:!1,hasParametersFromSource:p},b=[];return n.forEach(({usage:t},r)=>{const i=null!=e&&e[r]&&e[r].formats,s=i?u(i.map(({name:e,format:t})=>({name:e,encoding:d[t]}))):[];b.push({id:r,usage:t,encodings:s})}),{material:_,textures:b}},e.getMaterialAndTexturesFromShared=function(e){const r=e?.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,s=e?.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,n=r?e.materialDefinitions?.[r]:null,o=s?e.textureDefinitions?.[s]:null,a=p();if(null!=n){const e=n.params;e.diffuse&&(t.validateColor(e.diffuse),a.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(a.doubleSided=e.doubleSided,a.cullFace=e.doubleSided?0:2),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(a.cullFace="none"===e.cullFace?0:"back"===e.cullFace?2:1),e.transparency&&(a.metallicRoughness.baseColorFactor[3]=i.clamp(1-e.transparency,0,1)),(e.useVertexColorAlpha||a.metallicRoughness.baseColorFactor[3]<1)&&(a.alphaMode="blend")}const l=[];if(null!=o){const e=0;!o.wrap||"repeat"!==o.wrap[0]&&"repeat"!==o.wrap[1]||(a.wrapTextures=!0);let t=1;"rgba"===o.channels&&(a.alphaMode="blend",t|=32);const r=o.images.length-1,i=o.images[r],s=e=>e?.split("/").pop(),n=Array.isArray(o.encoding)?u(o.encoding.map((e,t)=>({name:s(i.href[t]),encoding:h[e]||0}))):[{name:s(i.href),encoding:h[o.encoding]||0}];l.push({id:e,usage:t,encodings:n}),a.metallicRoughness.baseColorTextureId=e}return{material:a,textures:l}},e.getSupportedEncodings=function(e){const t=!!e.compressedTextureS3TC,i=!!e.compressedTextureETC,s=r("disable-feature:i3s-basis")?0:3;return 24|(t?4|s:0)|(i?s:0)},e.selectEncoding=function(e,t){if(null!=t)return e.find(e=>0!==(e.encoding&t))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/enums":function(){define(["exports"],function(e){"use strict";e.compressibleUsages=3,e.uncompressedFormats=24,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/material/RenderTexture":function(){define(["exports","../../../../../core/maybe","../../../../../core/promiseUtils"],function(e,t,r){"use strict";e.RenderTexture=class{constructor(e,i){this._textures=e,this.loadPromise=null,this._disposed=!1;const s=this._textures.acquire(i);r.isPromiseLike(s)?(s.then(e=>{this._disposed?t.releaseMaybe(e):this._textureRef=e}),this.loadPromise=s):this._textureRef=s}dispose(){this._textureRef=t.releaseMaybe(this._textureRef),this._disposed=!0}get glTexture(){return this._textureRef?.glTexture}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/core/shaderLibrary/util/EllipsoidMode":function(){define(["exports","../../../../../../geometry/support/spatialReferenceUtils"],function(e,t){"use strict";e.getEllipsoidMode=function(e){return e&&t.isMars(e)?2:e&&t.isMoon(e)?3:1},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SStreamDataController":function(){define(["exports","../../../../core/promiseUtils"],function(e,t){"use strict";e.I3SStreamDataController=class{constructor(e,t,r){this._requester=e,this._customParameters=t,this._apiKey=r,this._activeRequests=new Set}get busy(){return this._requester.busy}request(e,r,i){const s=new AbortController,n=t.onAbortOrThrow(i,()=>s.abort()),o={signal:s.signal,query:{...this._customParameters,token:this._apiKey}},a=this._requester.request(e,r,o),l={response:a,abortController:s,abortHandle:n};return this._activeRequests.add(l),t.always(a,()=>{l.abortController=null,l.abortHandle?.remove(),l.abortHandle=null,this._activeRequests.delete(l)}),a}cancelAll(){this._activeRequests.forEach(e=>{e.abortController?.abort(),e.abortController=null,e.abortHandle?.remove()}),this._activeRequests.clear()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SViewportQueries":function(){define(["../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/ellipsoidUtils","../../../../geometry/spatialReferenceEllipsoidUtils","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/projection/projectors","../../../../geometry/support/frustum","../../../../geometry/support/plane","../../../../geometry/support/spatialReferenceUtils","../../../../chunks/sphere","../../../../layers/graphics/dehydratedPoint","../graphics/elevationAlignmentUtils","../graphics/ElevationContext","../graphics/featureExpressionInfoUtils","./I3SUtil","../../support/orientedBoundingBox"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y){"use strict";const _=1e5,b=t.create(),v=l.createPoints(),w=t.create(),x=t.create(),S=t.create(),T=t.create(),C=t.create(),P=new y.Obb,M=t.create(),R=[t.create(),t.create(),t.create(),t.create(),t.create(),t.create(),t.create(),t.create()],O=t.create(),I=t.create(),F=t.create(),A=t.create();return class{get _frustumMbsCenter(){return this._frustumMbs}get _frustumMbsRadius(){return this._frustumMbs[3]}get _frustumPlanes(){return this._frustum}constructor(e,r,o,c,d,p,f,m,g={}){this._indexSR=e,this._renderCoordsHelper=r,this._clippingArea=d,this._elevationProvider=p,this._viewingMode=f,this._options=g,this._frustum=l.create(),this._frustumMbs=i.create(),this._useFrustumCulling=!1,this._poi=t.create(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=new y.Obb,this._tmp1=t.create(),this._tmp2=t.create(),this._tmp3=t.create(),this._tmp0=t.create(),this._screenspaceErrorBias=g.screenspaceErrorBias||1,this._progressiveLoadFactor=g.progressiveLoadFactor||1,this.updateCamera(o,c);const _=this._renderCoordsHelper.spatialReference;this._renderSR=_,this._renderSRSphericalPCPF=n.getSphericalPCPF(_),this._isGlobalMode=_===this._renderSRSphericalPCPF,this.updateElevationInfo(m),this._tmpPoint=h.makeDehydratedPoint(0,0,0,e),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(_.isWebMercator||u.isPlateCarree(_)),this._indexSREllipsoidRadius=s.getReferenceEllipsoid(this._indexSR).radius,this._indexSRSphericalPCPF=n.getSphericalPCPF(e),this._projectorIndexSRToIndexSRSphericalPCPF=a.getProjector(this._indexSR,this._indexSRSphericalPCPF)}updateElevationInfo(e){null!=e?(this._elevationContext=f.ElevationContext.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(m.createContextWithoutExpressionSupport(m.extractExpressionInfo(e,!1)))):this._elevationContext=null}updateCamera(t,r){if(this._useFrustumCulling=r,r){l.fromMatrix(t.viewMatrix,t.projectionMatrix,this._frustum,v);{const r=t.eye,i=b;e.normalize(i,t.viewForward);const s=v,n=w;e.sub(n,s[4],r);const o=.5*e.dot(n,n)/e.dot(i,n),a=this._frustumMbs,l=a;e.scaleAndAdd(l,r,i,o);const c=1+o;a[3]=c}}this._screenSizeFactor=1/(t.perScreenPixelRatio/2),this._camPos=t.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(e){this._poi=e}updateScreenSpaceErrorBias(e){const t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}updateClippingArea(e){this._clippingArea=e}expandElevationRange(e,t,r){if(null==this._elevationContext)return;const i=e.serviceMbsInIndexSR;if(!i)return;const s="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds){const e=this._elevationProvider.getSphereElevationBounds(i,this._indexSR,s);return void(e&&r.expandElevationRange(e))}const n=i[0],o=i[1],a=i[2],l=this._elevationProvider.getElevation(n,o,a,this._indexSR,s);l&&r.expandElevationRangeValues(l,l);const c=t?null:this._elevationProvider.getRootElevationBounds?.();c&&r.expandElevationRange(c)}getServiceMbsInRenderSR(e){const t=e.serviceMbsInRenderSR;if(g.isValidMbs(t))return t;e.serviceMbsInIndexSR&&r.copy(t,e.serviceMbsInIndexSR);const i=e.elevationRangeMin;if(this._elevationContext&&Number.isFinite(i)){let r=0,s=0;const n=e.elevationRangeMax;switch(this._elevationContext.mode){case"relative-to-ground":case"relative-to-scene":r=this._elevationContext.geometryZWithOffset(t[2],this._renderCoordsHelper)+i-t[2],s=n-i;break;case"on-the-ground":r=i-t[2],s=n-i}t[2]+=r+.5*s,t[3]+=.5*s}else this._elevationContext&&t[3]<_&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=p.evaluateElevationAlignmentAtPoint(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper));return o.projectBoundingSphere(t,this._indexSR,t,this._renderSR),t}getAndUpdateVisibilityObbInRenderSR(e){{const t=e.visibilityObbInRenderSR;if(t)return t}const t=.01*this._indexSREllipsoidRadius,{serviceMbsInIndexSR:r,serviceObbInIndexSR:i}=e;if(null==i||!r||!i.isValid||this._isECEFOBBInLocalMode&&(i.halfSizeX>t||i.halfSizeY>t||i.halfSizeZ>t))return null;{let t=e.serviceObbInRenderSR;if(null==t)t=new y.Obb,e.serviceObbInRenderSR=t;else if(t.isValid)return t;const s=r[3];let n=0,o=0;const a=i.centerZ,l=this._renderCoordsHelper,c=this._elevationContext;if(c&&e.elevationRangeValid){const t=e.elevationRangeMin,r=e.elevationRangeMax;switch(c.mode){case"relative-to-ground":case"relative-to-scene":n=c.geometryZWithOffset(a,l)+t-a,o=r-t;break;case"on-the-ground":n=t-a,o=r-t}}else if(c&&s<_){const e=this._tmpPoint;e.x=i.centerX,e.y=i.centerY,e.z=a,n=p.evaluateElevationAlignmentAtPoint(e,this._elevationProvider,c,l)-a}const u=o>0,d=u?this._tmpObb:t;return i.transform(d,this._indexSR,this._renderSR,n,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),u&&y.computeOffsetObb(d,0,o,this._viewingMode,t),t}}getNodeObbInRenderSRIndependentOfElevationOffset(e){{const t=e.visibilityObbInRenderSR??e.serviceObbInRenderSR??null;if(t?.isValid)return t}const t=e.serviceObbInIndexSR;return t?(t.transform(P,this._indexSR,this._renderSR,void 0,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),P):null}ensureElevationAgnosticBoundingVolume(e){return-1===e.elevationAgnosticBoundingVolume[3]&&e.level>0&&(1===this._viewingMode?this._updateElevationAgnosticBoundingVolumeGlobal(e):this._updateElevationAgnosticBoundingVolumeLocal(e)),e.elevationAgnosticBoundingVolume}_updateElevationAgnosticBoundingVolumeGlobal(t){const i=this.getNodeObbInRenderSRIndependentOfElevationOffset(t),s=t.elevationAgnosticBoundingVolume;let n,o=-1;if(i){const t=M;i.getCenter(t),e.normalize(t,t),n=t,i.getCorners(R);for(const r of R){e.normalize(r,r);const i=e.dot(r,t);if(i<=0)return void(s[3]=-1);const n=Math.sqrt(1-i*i);o=Math.max(o,n)}}else{const r=t.serviceMbsInRenderSR;if(!g.isValidMbs(r))return void(s[3]=-1);{const t=e.copy(M,d.getCenter(r)),i=r[3],a=e.len(t);if(a<i)return void(s[3]=-1);o=i/a,e.normalize(t,t),n=t}}r.copyVec3(s,n),s[3]=o+.001}_updateElevationAgnosticBoundingVolumeLocal(t){const i=t.elevationAgnosticBoundingVolume,s=this.getNodeObbInRenderSRIndependentOfElevationOffset(t);if(s){const t=s.getCenter(M);t[2]=0,r.copyVec3(i,t);let n=0;const o=O;s.getCorners(R);for(const t of R){t[2]=0;const r=e.sqrDist(o,t);n=Math.max(n,r)}i[3]=Math.sqrt(n)}else{const s=t.serviceMbsInRenderSR;if(g.isValidMbs(s)){const t=e.copy(M,d.getCenter(s));t[2]=0,r.copyVec3(i,t),i[3]=s[3]}}}isNodeVisible(e){const t=this.getServiceMbsInRenderSR(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;const r=this.getAndUpdateVisibilityObbInRenderSR(e);return r?r.doesIntersectFrustumConservativeApproximation(this._frustum):l.intersectsSphere(this._frustum,d.wrap(t))}isElevationAgnosticBoundingVolumeVisible(e){return!this._useFrustumCulling||-1===e[3]||(1===this._viewingMode?this._isConeVisibleInFrustum(e):this._isCylinderVisibleInFrustum(e))}_isConeVisibleInFrustum(t){if(!this._isConeVisibleInFrustumMbs(t))return!1;const r=t[3];if(-1===r||r>.9)return!0;const i=this._frustumPlanes,s=this._frustumMbsCenter,n=t,o=e.dot(n,s),a=this._frustumMbsRadius,l=o-a,u=o+a;if(l<=0)return!0;const d=e.scale(S,n,l),h=e.scale(T,n,u),p=r/Math.sqrt(1-r*r);for(const t of i){const r=c.getNormal(t),i=e.normalize(C,r),s=e.dot(i,n);if(Math.abs(1-s)<.01)continue;const o=I;e.scale(o,n,s),e.sub(o,o,i),e.normalize(o,o);const a=F;if(e.scaleAndAdd(a,d,o,l*p),!(c.signedDistance(t,a)<=0||(e.scaleAndAdd(a,h,o,u*p),c.signedDistance(t,a)<=0)))return!1}return!0}_isConeVisibleInFrustumMbs(t){const r=t[3];if(r>.9)return!0;const i=this._frustumMbsRadius,s=this._frustumMbsCenter,n=e.len(s);if(n<=i)return!0;const o=t,a=e.dot(o,s);{const t=e.scale(x,o,a);if(e.dist(t,s)<i)return!0}const l=a/n;if(a<=0)return-l<i;const c=Math.sqrt(1-l*l);if(c<r)return!0;const u=i/n;return c*Math.sqrt(1-u*u)-u*l<r}isObbVisibleIndependentOfElevation(t,r){if(!this._useFrustumCulling)return!0;if(-1===t[3])return!0;const i=this._frustumMbsRadius,s=this._frustumMbsCenter,n=this._frustumPlanes,o=R;if(r.getCorners(o),1===this._viewingMode){const r=t,a=e.dot(r,s),l=a-i,u=a+i;if(l<=0)return!0;for(const t of n){let i=!0;for(const s of o){const n=e.dot(s,r),o=A;if(e.scale(o,s,l/n),c.signedDistance(t,o)<=0){i=!1;break}const a=A;if(e.scale(a,s,u/n),c.signedDistance(t,a)<=0){i=!1;break}}if(i)return!1}}else{const e=s[2]-i,t=s[2]+i;for(const r of n){let i=!0;const s=c.getNormal(r),n=s[0],a=s[1],l=s[2],u=r[3];for(const r of o){const s=n*r[0]+a*r[1]+u;if(s+l*e<=0||s+l*t<=0){i=!1;break}}if(i)return!1}}return!0}_isCylinderVisibleInFrustum(t){const r=this._frustumMbsCenter,i=this._frustumMbsRadius,s=e.copy(x,r);s[2]=0;const n=t[3],o=t;return e.dist(s,o)<=n+i}isGeometryVisible(e){if(!this._useFrustumCulling)return!0;const t=e.geometryObbInRenderSR;return t?.doesIntersectFrustumConservativeApproximation(this._frustum)??this.isNodeVisible(e)}_isMBSinClippingArea(e){return null==this._clippingArea||0!==g.intersectBoundingRectWithMbs(this._clippingArea,e)}_screenSpaceDiameterMbs(t,r){const i=this.getServiceMbsInRenderSR(t),s=Math.sqrt(e.squaredDistance(d.getCenter(i),this._camPos)),n=s-i[3];return this._updateMinMaxDistance(s),n<0?.5*Number.MAX_VALUE:r/n*this._screenSizeFactor}calcCameraDistance(e){return this.calcCameraDistanceToCenter(e)-this.getServiceMbsInRenderSR(e)[3]}calcCameraDistanceToCenter(t){const r=this.getServiceMbsInRenderSR(t),i=e.distance(d.getCenter(r),this._camPos);return this._updateMinMaxDistance(i),i}calcAngleDependentLoD(t){const r=this.getServiceMbsInRenderSR(t),i=r[3],s=(Math.abs(r[0]*(r[0]-this._camPos[0])+r[1]*(r[1]-this._camPos[1])+r[2]*(r[2]-this._camPos[2]))/e.length(d.getCenter(r))+i)/e.distance(d.getCenter(r),this._camPos);return Math.min(1,s)}hasLOD(e){return 0!==e.lodMetric}_getDistanceGlobeMode(t,r){const i=e.length(d.getCenter(r)),s=e.length(t)-i;e.scale(this._tmp0,t,e.dot(t,d.getCenter(r))/e.squaredLength(t));const n=e.squaredDistance(d.getCenter(r),this._tmp0),o=r[3];if(n<=o*o)return Math.abs(s);{const n=e.scale(this._tmp0,d.getCenter(r),1/i),a=i,l=o*o/2/a,c=e.scale(this._tmp1,n,a-l),u=t,h=e.subtract(this._tmp2,u,c),p=e.subtract(this._tmp2,h,e.scale(this._tmp3,n,e.dot(n,h))),f=e.add(this._tmp2,c,e.scale(this._tmp2,p,o/e.length(p)));let m=e.distance(u,f);if(s>=2e5){const t=e.subtract(this._tmp1,u,f);let r=e.dot(t,n)/e.length(t);r<.08&&(r=1e-4),m/=r}return m}}_getDistance(e,t){return this._isGlobalMode?this._getDistanceGlobeMode(e,t):function(e,t){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2],n=r*r+i*i,o=t[3];if(n<=o*o)return Math.abs(s);const a=Math.sqrt(n)-o;return Math.sqrt(s*s+a*a)}(e,t)}_updateMinMaxDistance(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}getLodLevel(e){if(0===e.lodMetric)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const t=this._progressiveLoadFactor*this._screenspaceErrorBias,r=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,r)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(e,t){switch(e.lodMetric){case 2:{const r=this.getServiceMbsInRenderSR(e),i=this._getDistance(this._camPos,r),s=2*i/this._screenSizeFactor,n=i+r[3];return this._updateMinMaxDistance(n),e.maxError*t<=s}case 1:{let r=this._screenSpaceDiameterMbs(e,e.serviceMbsInIndexSR[3]*t);return this._options.angleDependentLoD&&(r*=this.calcAngleDependentLoD(e)),r<e.maxError}case 3:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1}distToPOI(t){const r=this.getServiceMbsInRenderSR(t);return e.distance(d.getCenter(r),this._poi)-r[3]}distCameraToPOI(){return e.distance(this._camPos,this._poi)}}})},"esri/layers/support/SceneModification":function(){define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/lang","../../core/Warning","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../core/accessorSupport/decorators/persistable","../../geometry/Polygon","../../geometry/projectionUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";var p;return e.default=p=class extends r.JSONSupport{constructor(e){super(e),this.geometry=null,this.type="clip"}writeGeometry(e,t,r,i){if(i.layer?.spatialReference&&!i.layer.spatialReference.equals(this.geometry.spatialReference)){if(!h.canProjectWithoutEngine(e.spatialReference,i.layer.spatialReference))return void(i?.messages&&i.messages.push(new s("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:i.layer.spatialReference,context:i})));const n=new d;h.projectPolygon(e,n,i.layer.spatialReference),t[r]=n.toJSON(i)}else t[r]=e.toJSON(i)}clone(){return new p({geometry:i.clone(this.geometry),type:this.type})}},t.__decorate([n.property({type:d}),u.persistable()],e.default.prototype,"geometry",void 0),t.__decorate([c.writer(["web-scene","portal-item"],"geometry")],e.default.prototype,"writeGeometry",null),t.__decorate([n.property({type:["clip","mask","replace"],nonNullable:!0}),u.persistable()],e.default.prototype,"type",void 0),e.default=p=t.__decorate([l.subclass("esri.layers.support.SceneModification")],e.default),e.default})},"esri/views/3d/layers/ContentGeometryLayerView":function(){define(["exports"],function(e){"use strict";e.ContentGeometryUpdateEvent=class{constructor(e){this.renderBounds=e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/I3SMeshViewLabeler":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/arrayUtils","../../../core/has","../../../core/lang","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/uid","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/diffUtils","../../../geometry/projection/projectBuffer","../../../geometry/support/aaBoundingBox","../../../geometry/support/DoubleArray","../../../layers/graphics/dehydratedPoint","../../../renderers/support/RenderingInfo","../../../symbols/PointSymbol3D","./graphics/Graphics3DCore","./graphics/Graphics3DScaleVisibility","./i3s/I3SGeometryUtil","../support/LimitGraphicsMap","../../support/layerViewUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T){"use strict";class C{constructor(e,t){this.meta=e,this.index=t}}class P{constructor(e,t){this.graphic=e,this.geometry=t,this.components=[],this.overridesDirty=!1}}e.default=class extends r{get updating(){return this._graphicsCore?.updating??!1}constructor(e){super(e),this.loadedGraphics=new S.LimitGraphicsMap(5e4),this.slicePlaneEnabled=!1,this._renderingInfo=new _.RenderingInfo(null,new b),this._featuresMap=new Map}initialize(){const e=this.view.basemapTerrain;this._graphicsCore=new v.Graphics3DCore({owner:this,layer:this.layer,preferredUpdatePolicy:0,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:e=>this.view.deconflictor.addGraphicsOwner(e),labeler:(e,t)=>this.view.labeler.addGraphicsOwner(e,t,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),scaleVisibility:T.hasLayerBasedScaleVisibility()?null:(t,r)=>new w.Graphics3DScaleVisibility({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:r,graphicsCore:t,basemapTerrain:e,layerScaleEnabled:!1})}}),this._graphicsCore.initializePromise.then(()=>this._graphicsCore.startCreateGraphics()).catch(()=>{}),this.addHandles(l.watch(()=>this.layer.labelingInfo,(e,t)=>{p.diff(e,t)&&this._graphicsCore.updateLabelingInfo()}))}destroy(){this._graphicsCore=a.destroyMaybe(this._graphicsCore),this.loadedGraphics=a.destroyMaybe(this.loadedGraphics),this.view=null}addNodeMeta(e,t){let r=0;const i=e.filteredIds,s=this.view.spatialReference,n=[];for(let o=0;o<e.featureIds.length;o++){const a=e.featureIds[o];let l=null==i;if(i&&r<i.length&&a===i[r]&&(l=!0,r++),!this._enabledForFeatureInNode(e,o))continue;const u=this._featuresMap.get(a);if(u){u.components.push(new C(e,o)),this._updateLabelPosition(a);continue}const d=t(o,e),h=y.makeDehydratedPoint(0,0,0,s),p={objectId:a,uid:c.generateUID(),attributes:d,visible:l,geometry:h},f=new P(p,h);f.components.push(new C(e,o)),this._featuresMap.set(a,f),this._updateLabelGeometry(a),n.push(p)}this.loadedGraphics.addMany(n)}updateLabelPositions(e){const t=this.view.renderCoordsHelper;this._forEachGraphic(e,(r,i,s)=>{const n=this._graphicsCore.getGraphics3DGraphicById(i.uid);null!=n&&this._updateLabelGeometry(e.featureIds[r])&&n.alignWithAbsoluteElevation(s.z??0,t,!1)})}setNodeMetaAttributes(e,t){const r=new Array;this._forEachGraphic(e,(i,s)=>{const o=t(i,e);n.equalsShallow(s.attributes,o)||(s.attributes=o,r.push(s.uid))}),this._graphicsCore.updateLabelingInfo(r)}applyFilterChange(e){this._forEachFeature(e,(t,r,i)=>{if(!this._enabledForFeatureInNode(e,t)){const i=e.featureIds[t];switch(this._removeFeature(r,e,t)){case 2:this.loadedGraphics.removeManyByObjectId([i]);break;case 1:this._updateLabelPosition(i)}return}const s=r.graphic,n=s.visible;n!==i&&(s.visible=i,M.graphic=s,M.property="visible",M.oldValue=n,M.newValue=i,this._graphicsCore.graphicUpdateHandler(M),M.graphic=null)})}removeNodeMeta(e){const t=[];this._forEachGraphic(e,r=>{const i=e.featureIds[r],s=this._featuresMap.get(i);if(s)switch(this._removeFeature(s,e,r)){case 1:this._updateLabelPosition(i);break;case 2:t.push(i)}}),this.loadedGraphics.removeManyByObjectId(t)}_removeFeature(e,t,r){const s=e.components.length;return i.filterInPlace(e.components,e=>!(e.meta===t&&e.index===r)),0===e.components.length?(this._featuresMap.delete(t.featureIds[r]),2):s!==e.components.length?1:0}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}_updateLabelPosition(e){const t=this._featuresMap.get(e);t&&this._updateLabelGeometry(e)&&(this.loadedGraphics.removeManyByObjectId([e]),this.loadedGraphics.addMany([t.graphic]))}_updateLabelGeometry(e){const t=this._featuresMap.get(e);if(!t)return!1;const r=t.geometry,i=this.view.spatialReference,s=this.view.renderCoordsHelper,n=r.x,a=r.y,l=r.z??0,c=t.components.length,u=g.newDoubleArray(c*x.boundingBoxCornersPointsStride);let d=0;for(const{meta:e,index:r}of t.components)x.boundingBoxCornerPoints(r,this.collection,e.objectHandle,u,d),d+=x.boundingBoxCornersPointsStride;return f.projectBuffer(u,s.spatialReference,0,u,i,0),m.fromBuffer(u,R),r.x=(R[0]+R[3])/2,r.y=(R[1]+R[4])/2,r.z=R[5],!o.floatEqualUlp(r.x,n)||!o.floatEqualUlp(r.y,a)||!o.floatEqualUlp(r.z,l)}_forEachGraphic(e,t){this._forEachFeature(e,(r,{graphic:i,geometry:s},n)=>{this._enabledForFeatureInNode(e,r)&&t(r,i,s,n)})}_forEachFeature(e,t){let r=0;for(let i=0;i<e.featureIds.length;i++){const s=this._featuresMap.get(e.featureIds[i]);let n=null==e.filteredIds;e.filteredIds&&e.filteredIds[r]===e.featureIds[i]&&(n=!0,r++),s&&t(i,s,n)}}_enabledForFeatureInNode(e,t){return e.node.index<0||!this.overrides?.featureHasGeometryChanges(e.featureIds[t])}get updatePolicy(){return this._graphicsCore.effectiveUpdatePolicy}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){}},t.__decorate([u.property()],e.default.prototype,"view",void 0),t.__decorate([u.property()],e.default.prototype,"layer",void 0),t.__decorate([u.property()],e.default.prototype,"collection",void 0),t.__decorate([u.property()],e.default.prototype,"loadedGraphics",void 0),t.__decorate([u.property()],e.default.prototype,"overrides",void 0),t.__decorate([u.property()],e.default.prototype,"layerViewUid",void 0),t.__decorate([u.property()],e.default.prototype,"updating",null),t.__decorate([u.property()],e.default.prototype,"slicePlaneEnabled",void 0),t.__decorate([u.property()],e.default.prototype,"_graphicsCore",void 0),e.default=t.__decorate([h.subclass("esri.views.3d.layers.I3SMeshViewLabeler")],e.default);const M={graphic:null,property:null,oldValue:null,newValue:null},R=m.create();return e.default})},"esri/views/3d/layers/i3s/I3SGeometryUtil":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectBuffer","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/DoubleArray"],function(e,t,r,i,s,n){"use strict";function o(e,r,i,s,n){const o=r.getComponentAabb(i,e,a),c=r.getObjectTransform(i);for(let e=0;e<8;++e)l[0]=1&e?o[0]:o[3],l[1]=2&e?o[1]:o[4],l[2]=4&e?o[2]:o[5],t.transformMat3(l,l,c.rotationScale),t.add(l,l,c.position),s[n++]=l[0],s[n++]=l[1],s[n++]=l[2];return s}const a=s.create(),l=r.create();e.boundingBoxCornerPoints=o,e.boundingBoxCornersPointsStride=24,e.createGetFeatureExtent=function(e,t,r){const a=n.newDoubleArray(24);return n=>{const l=n.meta.featureExtents,c=new Float64Array(l.buffer,6*n.index*Float64Array.BYTES_PER_ELEMENT,6);return c[0]===Number.POSITIVE_INFINITY&&(o(n.index,r,n.meta.objectHandle,a,0),i.projectBuffer(a,t,0,a,e,0)?s.fromBuffer(a,c):s.set(c,s.zero)),c}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/LimitGraphicsMap":function(){define(["exports","../../../core/Evented","../../../core/MapUtils","./GraphicsMap"],function(e,t,r,i){"use strict";class s extends t.Evented{constructor(e){super(),this._limit=e,this._all=new i.GraphicsMap,this._active=new o(this),this._pending=new Map,this._handle=this._all.on("change",e=>this._handleChanges(e))}destroy(){super.destroy(),this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(e){return this._active.find(e)}some(e){return this._active.some(e)}forEach(e){this._active.forEach(e)}addMany(e){this._all.addMany(e)}removeManyByObjectId(e){this._all.removeManyByObjectId(e)}_handleChanges(e){let t=e.removed;if(this._pending.size>0){t=new Array;for(const r of e.removed)this._pending.delete(r.objectId)||t.push(r)}let r=this._limit-this._active.length+t.length;r<e.added.length&&(this._active.removeMany(t),t=[],n.reset(1-this._limit/(this._active.length+e.added.length)),this._active.forEach(e=>{n.sample()&&(t.push(e),this._pending.set(e.objectId,e))}),r=this._limit-this._active.length+t.length);let i=e.added;if(r<e.added.length){i=new Array,n.reset(r/e.added.length);for(const t of e.added)n.sample()?i.push(t):this._pending.set(t.objectId,t)}const s=r-i.length;s>0&&this._pending.size>0&&(n.reset(s/this._pending.size),this._pending.forEach(e=>{n.sample()&&(i.push(e),this._pending.delete(e.objectId))})),this._active.addAndRemove(i,t)}}const n=new class{constructor(){this._percentage=1,this._last=-1,this._index=0}reset(e){this._percentage=e,this._last=-1}sample(){const e=Math.floor(this._index*this._percentage);return++this._index,e!==this._last&&(this._last=e,!0)}};class o{constructor(e){this._parent=e,this._map=new Map}get length(){return this._map.size}forEach(e){this._map.forEach(t=>e(t))}find(e){return r.findInMap(this._map,e)}some(e){return r.someMap(this._map,e)}toArray(){return Array.from(this._map.values())}addAndRemove(e,t){for(const t of e)this._map.set(t.objectId,t);for(const e of t)this._map.delete(e.objectId);(e.length>0||t.length>0)&&this._parent.emit("change",{added:e,removed:t})}removeMany(e){for(const t of e)this._map.delete(t.objectId);e.length>0&&this._parent.emit("change",{added:[],removed:e})}}e.LimitGraphicsMap=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/support/GraphicsMap":function(){define(["exports","../../../core/Evented","../../../core/MapUtils"],function(e,t,r){"use strict";class i extends t.Evented{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}get length(){return this._map.size}get(e){return this._map.get(e)}addMany(e){if(0===e.length)return;const t=new Set;for(let r=0;r<e.length;r++){const i=e[r],s=i.objectId,n=this._map.get(s);n?(t.add(s),i!==n&&(e[r]=n),n.refCount||(n.refCount=0),++n.refCount):(i.refCount=1,this._map.set(s,i))}const r=t.size>0?e.filter(e=>!t.has(e.objectId)):e;r.length>0&&this.emit("change",{added:r,removed:[]})}removeMany(e){const t=[];for(const r of e){const e=r.objectId,i=this._map.get(e);null!=i&&(!i.refCount||--i.refCount<=0)&&(this._map.delete(e),t.push(r))}t.length>0&&this.emit("change",{added:[],removed:t})}removeManyByObjectId(e){const t=[];for(const r of e){const e=this._map.get(r);null!=e&&(!e.refCount||--e.refCount<=0)&&(this._map.delete(r),t.push(e))}t.length>0&&this.emit("change",{added:[],removed:t})}toArray(){return[...this._map.values()]}find(e){return r.findInMap(this._map,e)}some(e){return r.someMap(this._map,e)}forEach(e){this._map.forEach(t=>e(t))}}e.GraphicsMap=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/I3SMeshViewPerformanceInfo":function(){define(["exports","./support/LayerViewPerformanceInfo"],function(e,t){"use strict";class r extends t.LayerViewPerformanceInfo{constructor(e,t,r,i,s,n,o){super(e,0,0,0,t),this.gpuMB=r,this.geometryMB=i,this.textureMB=s,this.unloadedMB=n,this.idbHitRate=o}}e.I3SMeshViewPerformanceInfo=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/I3SMeshWorkerHandle":function(){define(["exports","../../../core/Logger","../../../core/PooledArray","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/workers/WorkerHandle","../../../geometry/projectionUtils","../../../geometry/projection/projectVectorToVector"],function(e,t,r,i,s,n,o){"use strict";class a extends s.WorkerHandle{constructor(e){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},e,{hasInitialize:!0})}setModifications(e,t,r){const i={context:e,modifications:t,isGeodetic:r};return this.broadcast(i,"setModifications")}setLegacySchema(e,t){const r=JSON.stringify(t);return this.broadcast({context:e,jsonSchema:r},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}async destroyContextAndSelf(e){await this.destroyContext(e),this.destroy()}project(e,t){return this.invokeMethod("project",e,t)}transformNormals(e,t){return this.invokeMethod("transformNormals",e,t)}}const l=new r({deallocator:null}),c=i.create();e.I3SMeshWorkerHandle=a,e.TransformedData=class{constructor(e,t,r,i,s,n,o){this.componentOffsets=e,this.featureIds=t,this.anchorIds=r,this.anchors=i,this.transformedGeometry=s,this.globalTrafo=n,this.obb=o}},e.TransformedGeometry=class{constructor(e,t,r,i,s,n){this.layout=e,this.interleavedVertexData=t,this.indices=r,this.hasColors=i,this.hasModifications=s,this.positionData=n}},e.toWasmModification=function(e,r,i){l.clear();let s=1/0,a=1/0,u=-1/0,d=-1/0,h=!1;for(const e of r){const r="clip"===e.type?2:"mask"===e.type?1:0,p=e.geometry;let f=e=>e;if(p.spatialReference){if(!n.canProjectWithoutEngine(p.spatialReference,i)){t.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-projection-failed","Can't project modification polygon into layer spatial reference, ignoring modification",{polygon:p});continue}f=e=>(o.projectVectorToVector(e,p.spatialReference,c,i),c)}else p.hasZ||(c[2]=0,f=e=>(c[0]=e[0],c[1]=e[1],c));h=h||1===r;const m=p.rings.length,g=p.rings.some(e=>e.length<3);if(0===m||g)t.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-invalid-polygon","Ignoring invalid modification polygon (no rings or rings with less than 3 vertices).",{polygon:p});else{l.push(r),l.push(m);for(const e of p.rings){l.push(e.length);for(const t of e){const e=f(t);l.push(e[0]),l.push(e[1]),l.push(e[2]),s=Math.min(s,e[0]),a=Math.min(a,e[1]),u=Math.max(u,e[0]),d=Math.max(d,e[1])}}}}if(null!=e)if(h){const t=1e-4;l.push(2),l.push(2),l.push(4),l.push(s-t),l.push(a-t),l.push(0),l.push(u+t),l.push(a-t),l.push(0),l.push(u+t),l.push(d+t),l.push(0),l.push(s-t),l.push(d+t),l.push(0),l.push(4),l.push(e[0]),l.push(e[1]),l.push(0),l.push(e[2]),l.push(e[1]),l.push(0),l.push(e[2]),l.push(e[3]),l.push(0),l.push(e[0]),l.push(e[3]),l.push(0)}else l.push(1),l.push(1),l.push(4),l.push(e[0]),l.push(e[1]),l.push(0),l.push(e[2]),l.push(e[1]),l.push(0),l.push(e[2]),l.push(e[3]),l.push(0),l.push(e[0]),l.push(e[3]),l.push(0);l.push(3);const p=new Float64Array(l.length);for(let e=0;e<l.length;++e)p[e]=l.at(e);return p},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/SceneLayerWorker":function(){define(["require","exports","../../../core/mathUtils","../../../geometry/SpatialReference","../../../geometry/support/DoubleArray","../../../geometry/support/MeshGeoreferencedVertexSpace","../../../geometry/support/MeshLocalVertexSpace","../../../chunks/vec3","../../../libs/i3s/I3SModule","./I3SMeshWorkerHandle"],function(e,t,r,i,s,n,o,a,l,c){"use strict";let u,d;function h(e){if(!d)return;const t=e.modifications,r=d._malloc(8*t.length),i=new Float64Array(d.HEAPU8.buffer,r,t.length);for(let e=0;e<t.length;++e)i[e]=t[e];d.setModifications(e.context,r,t.length,e.isGeodetic),d._free(r)}function p(e,t,r){const{context:i,globalTrafo:s,mbs:n,obbData:o,elevationOffset:a,geometryBuffer:l,geometryDescriptor:u,indexToVertexProjector:d,vertexToRenderProjector:h}=t,p=e._malloc(l.byteLength),f=e._malloc(33*Float64Array.BYTES_PER_ELEMENT),m=new Uint8Array(e.HEAPU8.buffer,p,l.byteLength);m.set(new Uint8Array(l));const y=new Float64Array(e.HEAPU8.buffer,f,33);g(y,[NaN,NaN,NaN]);let _=y.byteOffset+3*y.BYTES_PER_ELEMENT,b=new Float64Array(y.buffer,_);g(b,s),_+=16*y.BYTES_PER_ELEMENT,b=new Float64Array(y.buffer,_),g(b,n),_+=4*y.BYTES_PER_ELEMENT,o&&(b=new Float64Array(y.buffer,_),g(b,o));const v=u,w={isDraco:!1,isLegacy:!1,color:t.layouts.some(e=>e.some(e=>"color"===e.name)),normal:t.needNormals&&t.layouts.some(e=>e.some(e=>"normalCompressed"===e.name)),uv0:t.layouts.some(e=>e.some(e=>"uv0"===e.name)),uvRegion:t.layouts.some(e=>e.some(e=>"uvRegion"===e.name)),featureIndex:v.featureIndex},x=e.process(i,!!t.obbData,p,m.byteLength,v,w,f,a,d,h,t.normalReferenceFrame);if(e._free(f),e._free(p),x.error.length>0)throw new Error(`i3s.wasm: ${x.error}`);if(x.discarded)return null;const S=x.componentOffsets.length>0?x.componentOffsets.slice():null,T=x.featureIds.length>0?x.featureIds.slice():null,C=x.anchorIds.length>0?Array.from(x.anchorIds):null,P=x.anchors.length>0?Array.from(x.anchors):null,M=x.interleavedVertedData.slice().buffer,R=1===x.indicesType?new Uint16Array(x.indices.buffer,x.indices.byteOffset,x.indices.byteLength/2).slice():new Uint32Array(x.indices.buffer,x.indices.byteOffset,x.indices.byteLength/4).slice(),O=x.positions.slice(),{buffer:I,byteOffset:F,byteLength:A}=x.positionIndices,D=1===x.positionIndicesType?new Uint16Array(I,F,A/2).slice():new Uint32Array(I,F,A/4).slice(),E=new c.TransformedGeometry(t.layouts[0],M,R,x.hasColors,x.hasModifications,{data:O,indices:D});return T&&r.push(T.buffer),S&&r.push(S.buffer),r.push(M),r.push(R.buffer),r.push(O.buffer),r.push(D.buffer),new c.TransformedData(S,T,C,P,E,s,x.obb)}function f(e){if(!d)return;const{context:t,buffer:r}=e,i=d._malloc(r.byteLength),s=r.byteLength/Float64Array.BYTES_PER_ELEMENT,n=new Float64Array(d.HEAPU8.buffer,i,s),o=new Float64Array(r);n.set(o),d.filterOBBs(t,i,s),o.set(n),d._free(i)}function m(e){d&&0===d.destroy(e)&&(d=null,u=null,l.cleanup())}function g(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}async function y(){return d||(d=await(u??=l.get())),d}const _={transform:(e,t)=>d&&p(d,e,t),destroy:m};t.destroyContext=function(e){m(e)},t.dracoDecompressPointCloudData=async function(e){d=await y();const t=[e.geometryBuffer],{geometryBuffer:r}=e,i=r.byteLength,s=d._malloc(i),n=new Uint8Array(d.HEAPU8.buffer,s,i);n.set(new Uint8Array(r));const o=d.dracoDecompressPointCloudData(s,n.byteLength);if(d._free(s),o.error.length>0)throw new Error(`i3s.wasm: ${o.error}`);const a=o.featureIds?.length>0?o.featureIds.slice():null,l=o.positions.slice();return a&&t.push(a.buffer),t.push(l.buffer),{result:{positions:l,featureIds:a},transferList:t}},t.filterObbsForModifications=async function(e){await y(),f(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}},t.filterObbsForModificationsSync=f,t.initialize=async function(){d||await y()},t.interpretObbModificationResults=function(e){return 0===e?0:1===e?1:2===e?2:3},t.process=async function(e){d=await y();const t=[e.geometryBuffer];return{result:p(d,e,t),transferList:t}},t.project=async function(t){const{localMatrix:r,origin:a,positions:l,vertexSpace:c}=t,u=i.fromJSON(t.inSpatialReference),d=i.fromJSON(t.outSpatialReference),h=r?s.ensurePackedArray(r):void 0,p=s.ensurePackedArray(a);let f;const[{projectBuffer:m},{initializeProjection:g}]=await Promise.all([new Promise((t,r)=>e(["../../../geometry/projection/projectBuffer"],t,r)),new Promise((t,r)=>e(["../../../geometry/projectionUtils"],t,r))]);await g(u,d);const y=[0,0,0];if(!m(p,u,0,y,d,0))throw new Error("Failed to project");if("georeferenced"===c.type&&null==c.origin){if(f=new Float64Array(l.length),!m(l,u,0,f,d,0,f.length/3))throw new Error("Failed to project")}else{const t="georeferenced"===c.type?n.fromJSON(c):o.fromJSON(c),{projectMeshVertexPositions:r}=await new Promise((t,r)=>e(["../../../geometry/support/meshUtils/projectMeshVertexPositions"],t,r)),i=r({vertexAttributes:{position:l},transform:h?{localMatrix:h}:void 0,vertexSpace:t,spatialReference:u},d);if(!i)throw new Error("Failed to project");f=i}const _=f.length,[b,v,w]=y;for(let e=0;e<_;e+=3)f[e]-=b,f[e+1]-=v,f[e+2]-=w;return{result:{projected:f,original:l,projectedOrigin:y},transferList:[f.buffer,l.buffer]}},t.setLegacySchema=async function(e){d=await y(),d.setLegacySchema(e.context,e.jsonSchema)},t.setModifications=async function(e){await y(),h(e)},t.setModificationsSync=h,t.test=_,t.transformNormals=async function({normalMatrix:e,normals:t}){const i=new Float32Array(t.length);return a.transformMat3(i,t,e),r.hasScaling(e)&&a.normalize(i,i),{result:{transformed:i,original:t},transferList:[i.buffer,t.buffer]}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/libs/i3s/I3SModule":function(){define(["require","exports","../../assets"],function(e,t,r){"use strict";let i;t.cleanup=function(){i=null},t.get=function(){return i??=(async()=>{const t=await new Promise((t,r)=>e(["../../chunks/i3s"],t,r));return await t.default({locateFile:e=>r.getAssetUrl(`esri/libs/i3s/${e}`)})})(),i},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/Highlights":function(){define(["../../../../core/arrayUtils","../../../../core/handleUtils","../../../../core/MapUtils"],function(e,t,r){"use strict";class i{constructor(e){this.highlightName=e,this.ids=new Set}}return class{constructor({collection:e,forAllFeatures:t,forAllFeaturesOfNode:r}){this._highlights=new Map,this._collection=e,this._forAllFeatures=t,this._forAllFeaturesOfNode=r}destroy(){this._highlights.forEach(e=>e.forEach(e=>this._releaseSet(e))),this._highlights=null}acquireSet(s){const n=new i(s);r.getOrCreateMapValue(this._highlights,s,()=>[]).push(n);const o=t.makeHandle(()=>{const t=this._highlights?.get(s);t&&(this._releaseSet(n),e.removeUnordered(t,n))});return{set:n,handle:o}}setFeatureIds(e,t){t.forEach(t=>e.ids.add(t)),this._initializeSet(e)}_initializeSet(e){this._forAllFeatures((t,r,i)=>(e.ids.has(t)&&this._collection.addComponentHighlight(i.objectHandle,r,e.highlightName),1))}_releaseSet(e){this._forAllFeatures((t,r,i)=>(e.ids.has(t)&&this._collection.removeComponentHighlight(i.objectHandle,r,e.highlightName),1))}objectCreated(e){this._highlights.forEach((t,r)=>{t.forEach(t=>{this._forAllFeaturesOfNode(e,(i,s)=>(t.ids.has(i)&&this._collection.addComponentHighlight(e.objectHandle,s,r),1))})})}objectDeleted(e){this._collection.clearHighlights(e.objectHandle)}}})},"esri/views/3d/layers/i3s/I3SAsyncElevationUpdater":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../graphics/ExtentSet","../../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c){"use strict";e.I3SAsyncElevationUpdater=class extends r{constructor(e,t,r,i){super({}),this._updateExtent=t,this._updateNode=r,this._getElevationMode=i,this.readyToRun=!1,this._extentSet=new l.ExtentSet,this._nodeSet=new Set;const s=this._taskPriority,n=e.registerTask(this._taskPriority,this);this.addHandles(n),this._task=n,this._lastTaskPriority=s}destroy(){this._extentSet.destroy()}get _taskPriority(){const e=this._getElevationMode();return e&&1===e?c.TaskPriority.ELEVATION_ALIGNMENT_SCENE:c.TaskPriority.ELEVATION_ALIGNMENT}_updateTaskPriority(){const e=this._taskPriority;e!==this._lastTaskPriority&&(this._task.priority=e,this._lastTaskPriority=e)}addExtent(e){this._extentSet.add(e),this._updateTaskPriority(),this.readyToRun=!0}schedule(e){this._nodeSet.add(e),this._updateTaskPriority(),this.readyToRun=!0}remove(e){this._nodeSet.delete(e),this._updateRunning()}runTask(e){const t=this._extentSet;for(e.run(()=>t.merge(e));!t.empty&&!e.done;){const r=this._updateExtent(t.pop());null!=r&&r.forAll(e=>this.schedule(e)),e.madeProgress()}if(e.done)return;const r=this._nodeSet;for(const t of r)if(r.delete(t),this._updateNode(t),e.madeProgress(),e.done)break;this._updateRunning()}_updateRunning(){this.readyToRun=this._nodeSet.size>0||this._extentSet.size>0}},t.__decorate([i.property()],e.I3SAsyncElevationUpdater.prototype,"readyToRun",void 0),e.I3SAsyncElevationUpdater=t.__decorate([a.subclass("esri.views.3d.layers.i3s.I3SAsyncElevationUpdater")],e.I3SAsyncElevationUpdater),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SCrossfadeHelper":function(){define(["exports","../../../../core/maybe","../../../../core/scheduling"],function(e,t,r){"use strict";e.I3SCrossfadeHelper=class{constructor(e){this._view=e,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}destroy(){this._preRenderFrameTaskHandle?.remove(),this._preRenderFrameTaskHandle=null,this._view=null}get updating(){return this._numFadingNodes>0}stopNodeFading(e){null!=e.lodCrossfadeProgress&&(this._numFadingNodes--,e.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=t.removeMaybe(this._preRenderFrameTaskHandle)),this._view.notifyLODUpdate(),this._view.notifyUpdate()))}_startNodeFading(e,t,i){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=r.addFrameTask({preRender:e=>this._updateAllNodeFading(e)}),this._view.notifyLODUpdate()),null==e.lodCrossfadeProgress&&(this._numFadingNodes++,this._view.notifyUpdate()),e.lodCrossfadeSignedDuration=i,e.lodCrossfadeProgress=t}_updateAllNodeFading(e){const t=this._view.nodeCrossfadingEnabled;this._view.foreachCrossfadeNode((r,i)=>{if(null!=r?.lodCrossfadeProgress){const s=r.lodCrossfadeSignedDuration,n=s>0?this._view.fullOpacity:0,o=e.deltaTime/s,a=r.lodCrossfadeProgress+Math.abs(o),l=!t||a>=1||0===s,c=n-(l?0:s>0?1:-1)*(1-a);l?(this.stopNodeFading(r),s<0&&this._view.markNodeToRemove(i)):r.lodCrossfadeProgress=a,this._view.setNodeOpacityByIndex(i,c)}}),this._view.removeMarkedNodes()}stopAllNodeFading(){this._view.foreachCrossfadeNode((e,t)=>{if(null!=e?.lodCrossfadeProgress){this.stopNodeFading(e);const r=e.lodCrossfadeSignedDuration;r<0&&this._view.markNodeToRemove(t);const i=r>0?this._view.fullOpacity:0;this._view.setNodeOpacityByIndex(t,i)}}),this._view.removeMarkedNodes()}fadeNode(e,t,r,i){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const s=this._view,n=s.nodeCrossfadingEnabled,o=0===r?s.fullOpacity:0,a=n?i?0===r?s.lodCrossfadeinDuration:s.lodCrossfadeoutDuration:s.lodCrossfadeUncoveredDuration:0,l=this._view.getNodeOpacityByIndex(e);if(n&&l!==o&&a>0){const e=1-Math.abs(o-l);this._startNodeFading(t,e,function(e){return 0===e?1:-1}(r)*a)}else this.stopNodeFading(t),this._view.setNodeOpacityByIndex(e,o),1===r&&this._view.removeNode(e)}isNodeFullyFadedIn(e){const t=this._view.getNodeCrossfadeMetaData(e);return null==t||null==t.lodCrossfadeProgress&&this._view.getNodeOpacityByIndex(e)===this._view.fullOpacity}},e.NodeCrossfadeMetaData=class{constructor(){this.lodCrossfadeSignedDuration=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SIntersectionHandler":function(){define(["exports","./I3SUtil","./Intersector","../../webgl-engine/lib/IntersectorResult","../../webgl-engine/lib/RayIntersections","../../webgl-engine/lib/verticalOffsetUtils"],function(e,t,r,i,s,n){"use strict";e.I3SIntersectionHandler=class{constructor(e){this.type=4,this._needVerticalOffset=!1,this.layerViewUid=e.layerViewUid,this.sublayerId=e.sublayerId,this._collection=e.collection,this._traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}updateElevationAlignState(e,t){this._needVerticalOffset=e&&1===t}intersect(e,o,a,l,c,u){const d=e.results,h=2===e.options.store,p=e.ray.direction,f=e.tolerance;let m=e=>e,g=e=>e;const y=n.getVerticalOffsetI3S(e.verticalOffset??(this._needVerticalOffset?0:null));null!=e.verticalOffset&&null!=y&&(m=e=>y.applyToMbs(e),g=e=>y.applyToObb(e));const _=new s.MeshIntersectionOptions(u,e.options.normalRequired);this._traverseNodeHierarchy((s,n)=>{if(0===s.childrenLoaded)return!1;const c=s.serviceObbInRenderSR?.isValid?s.serviceObbInRenderSR:null;return!(c&&!g(c).intersectRay(a,p,f)||(!n||!c&&t.isValidMbs(s.serviceMbsInRenderSR)&&!function(e,t,r,i=0){const s=e[3]+i,n=t[0]-e[0],o=t[1]-e[1],a=t[2]-e[2],l=r[0],c=r[1],u=r[2],d=l*n+c*o+u*a;return d*d-(l*l+c*c+u*u)*(n*n+o*o+a*a-s*s)>=0}(m(s.serviceMbsInRenderSR),a,p,f)||null!=s.geometryObbInRenderSR&&!g(s.geometryObbInRenderSR).intersectRay(a,p,f)||this._collection.intersect(n,a,l,f,y,_,(t,n,c,u)=>{if(n<0||null!=o&&!o(a,l,n))return;const p=e=>{const i=new r.I3sTarget(this.layerViewUid,this.sublayerId,s.index,t,u);e.set(this.type,i,n,c)};if(this.isGround&&(null==d.ground.distance||n<d.ground.distance)&&p(d.ground),!e.options.isFiltered&&((null==d.min.distance||n<d.min.distance)&&p(d.min),(null==d.max.distance||n>d.max.distance)&&p(d.max),h)){const t=new i.IntersectorResult(e.ray);p(t),e.results.all.push(t)}}),0))})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SOverrides":function(){define(["require","exports","../../../../chunks/tslib.es6","../../../../request","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/Collection","../../../../core/handleUtils","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/memoryEstimations","../../../../core/promiseUtils","../../../../core/ReactiveSet","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/spatialReferenceUtils","../../../../intl/number","../../../../layers/support/featureQueryAll","../../../../support/requestUtils"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w){"use strict";t.I3SOverrides=class extends s{constructor(e){super(e),this._warnMaximumChangedObjectsExceeded=!1,this._maximumNumberOfEditOVerrides=P,this._definitionExpressionDirty=!0,this._interactiveEditingSessions=new a,this.geometryOverrides=new a,this._clientGeometryCache=new Map,this._attributeChangedObjectIds=new f,this._geometryChangedObjectIds=new f,this._pendingFetchChangedObjectIds=null,this._pendingFetchAbortController=new AbortController,this._applyGeometryOverridesTask=null,this._featureIdLocks=new Map}initialize(){this._memCache=new S(this.memoryController.newCache(`i3s-attribute-overrides-${this.layer.uid}`)),this.addHandles(m.watch(()=>this.layer.definitionExpression,async()=>{this._definitionExpressionDirty=!0,this._pendingFetchChangedObjectIds||(this._applyGeometryOverridesTask=d.abortMaybe(this._applyGeometryOverridesTask),this._applyGeometryOverridesTask=o.createTask(e=>this._queryAndAddGeometryOverrides(e)),await this._applyGeometryOverridesTask.promise)},m.sync)),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this._pendingFetchAbortController?.signal),this._pendingFetchChangedObjectIds.finally(()=>{this._pendingFetchAbortController=null,this._pendingFetchChangedObjectIds=null})}destroy(){this._set("layer",null),this._memCache=d.destroyMaybe(this._memCache),this._pendingFetchAbortController=d.abortMaybe(this._pendingFetchAbortController),this._pendingFetchChangedObjectIds=null,this._featureIdLocks.clear()}get is3DOFL(){return null!=this._associatedLayer?.infoFor3D}get sortedGeometryChangedObjectIds(){return this.is3DOFL?[...this._geometryChangedObjectIds].sort((e,t)=>e-t):[]}get _associatedLayer(){return null==this.layer?null:this.layer.associatedLayer}get hasGeometryChanges(){return this._geometryChangedObjectIds.size>0}get updating(){return!!this.is3DOFL&&!!(this._pendingFetchChangedObjectIds||this._applyGeometryOverridesTask&&!this._applyGeometryOverridesTask.finished)}get isEmpty(){return null==this._pendingFetchChangedObjectIds&&0===this._attributeChangedObjectIds.size&&0===this._geometryChangedObjectIds.size}featureHasGeometryChanges(e){return this._geometryChangedObjectIds.has(e)}featureHasAttributeChanges(e){return this._attributeChangedObjectIds.has(e)}createInteractiveEditSession(e){this._attributeChangedObjectIds.add(e);const t=this._interactiveEditingSessions,r=new x(e,()=>{t.remove(r)});return t.unshift(r),r}async applyAttributeOverrides(e,t,r,i=[]){if(this._pendingFetchChangedObjectIds&&await p.whenOrAbort(this._pendingFetchChangedObjectIds,r),null==t)return;const{attributeData:s,loadedAttributes:n}=t;if(null==n||null==s||0===this._attributeChangedObjectIds.size)return;const o=new Set;for(const e of n)o.add(e.index);for(const t of i)o.has(t.index)||(n.push(t),s[t.name]=new Array(e.length));const a=await this._lockFeatureIds(e);try{const t={attributeData:s,loadedAttributes:n},i=this._getOverridesFromCache(e,t,this._attributeChangedObjectIds),{objectIds:o,fieldNames:a}=i;if(0===o.length||0===a.length)return;const l=await this._queryAttributeOverridesFromAssociatedLayer(o,a,r);if(null==l)return;this._processOverridesFromAssociatedLayer(e,l,a,t)}finally{a.remove()}}updateGeometry(e,t){this._geometryChangedObjectIds.add(e);const r=this._clientGeometryCache.get(e);if(null!=r&&(this.geometryOverrides.remove(r),this._clientGeometryCache.delete(e)),null!=t){const r={oid:e,mesh:t};this.geometryOverrides.add(r),this._clientGeometryCache.set(e,r)}}updateAttributeValue(e,t,r){this._attributeChangedObjectIds.add(e),this._cacheAttributeValue(e,t,r)}featureAdded(e){this.is3DOFL&&this._geometryChangedObjectIds.add(e),this._attributeChangedObjectIds.add(e)}_cacheAttributeValue(e,t,r){this._memCache.put(e,t,r)}_getOverridesFromCache(e,{loadedAttributes:t,attributeData:r},i){const s=new Array;for(const e of t)s[e.index]=r[e.name];const n=new Set,o=new Set;for(let r=0;r<e.length;r++){const a=e[r];if(i.has(a))for(const e of t){const t=this._attributeFromCache(a,e.index);void 0===t?(n.add(a),o.add(e.name)):s[e.index][r]=t}}return{objectIds:Array.from(n),fieldNames:Array.from(o)}}_attributeFromCache(e,t){const r=this._fromInteractiveEditingSession(e,t);return void 0!==r?r:this._memCache.get(e,t)}_fromInteractiveEditingSession(e,t){if(null!=this._interactiveEditingSessions)for(const r of this._interactiveEditingSessions){if(r.objectId!==e)continue;const i=r.getAttribute(t);if(void 0!==i)return i}}async _queryAttributeOverridesFromAssociatedLayer(e,t,r){if(0===e.length)return null;this._logWarningIfMaximumObjectsExceeded();const{associatedLayer:i}=this.layer;if(null==i)return null;const s=i.createQuery(),{objectIdField:n}=i,o=[n,...t];s.where=this.layer.definitionExpression||"1=1",s.returnGeometry=!1,s.outFields=o,s.cacheHint=!0;const a=await this._executeBatchQuery(i,e,s,r),l=[];for(const e of a)if(e.ok)for(const t of e.value.features)l.push(t);return l}async _queryGeometryOverridesFromAssociatedLayer(t,r){if(0===t.length||!this.is3DOFL)return null;const i=this.layer.associatedLayer,s=i.infoFor3D,{spatialReference:n}=i,{state:{viewingMode:o},spatialReference:a}=this.view,l=1===o,c=n.isGeographic;if(l&&!c)return u.getLogger(this).warn("unsupported-pcs-edits-in-global-view",this.layer.title,M(n,a,this.view.viewingMode,0)),null;if(!l&&c)return u.getLogger(this).warn("unsupported-gcs-edits-in-local-view",this.layer.title,M(n,a,this.view.viewingMode,0)),null;if(!(_.equals(n,a)||l&&a.isWebMercator&&n.isWGS84))return u.getLogger(this).warn("unsupported-mismatched-spatial-reference-edits",this.layer.title,M(n,a,this.view.viewingMode,1)),null;this._logWarningIfMaximumObjectsExceeded();const{objectIdField:d,globalIdField:h}=i,p=[d,...null!=h?[h]:[]],f=i.createQuery();f.where=this.layer.definitionExpression||"1=1",f.returnGeometry=!0,f.outFields=p,f.cacheHint=!0,f.returnZ=i.hasZ,f.returnM=i.hasM;const{assetMapFromAssetMapsJSON:m,extractMesh:g}=await new Promise((t,r)=>e(["../../../../rest/support/meshFeatureSet"],t,r)),y=await this._executeBatchQuery(i,t,f,r),b=[];for(const e of y){if(!e.ok)continue;const t=e.value,{assetMaps:r,features:i,globalIdFieldName:o}=t;if(null==r)continue;const a=m(s,r);for(const e of i){const t=g(e,o,n,s,a),r=e;null!=t?(r.geometry=t,b.push(r)):r.geometry=null}}return b}_logWarningIfMaximumObjectsExceeded(){if(!this._warnMaximumChangedObjectsExceeded)return;this._warnMaximumChangedObjectsExceeded=!1;let e=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${b.formatNumber(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const t=this.layer.portalItem;e+=t?.loaded?` (${t.portal.url}/home/item.html?id=${t.id}#settings)`:` (${this.layer.parsedUrl.path})`,u.getLogger(this).warn("#queryOverrides()",this.layer.title,`${e}.`)}async _executeBatchQuery(e,t,r,i){if(0===t.length)return[];const s=v.getMaximumQuerySize(e);t=[...t].sort((e,t)=>e-t);const a=n.splitIntoChunks(t,s).map(t=>{const s=r.clone();return s.objectIds=t,o.resultOrAbort(v.queryAllJSON(e,s,{signal:i}))});return Promise.all(a)}_processOverridesFromAssociatedLayer(e,t,r,{loadedAttributes:i,attributeData:s}){const n=this._associatedLayer;if(null==n)return;const o=n.objectIdField,a=r.map(t=>(t in s||(s[t]=new Array(e.length)),s[t])),l=new Map(i.map(e=>[e.name,e.index])),c=r.map(e=>l.get(e)),u=new Map(Array.from(e,(e,t)=>[e,t]));for(const e of t){const t=e.attributes[o];for(let i=0;i<r.length;i++){const s=c[i],n=u.get(t),o=e.attributes[r[i]];a[i][n]=o,this._cacheAttributeValue(t,s,o)}}}async _fetchChangedObjectIds(e){const t=this.layer;await t.load({signal:e}),this._geometryChangedObjectIds.clear(),this._attributeChangedObjectIds.clear();const{associatedLayer:r}=t;if(null==r||!r.capabilities?.operations?.supportsChangeTracking)return;const s=this._getFetchChangedObjectIdsServerGen();if(null==s)return;const n=r.layerId,a=this.is3DOFL,l={...r.customParameters,f:"json",returnIdsOnly:!0,layers:`[${n}]`,returnUpdates:!0,returnDeletes:a,returnInserts:a,layerServerGens:JSON.stringify([{id:n,serverGen:s}])};if(null!=r.apiKey&&(l.token=r.apiKey),a){const e=r.infoFor3D;l.fieldsToCompare=JSON.stringify({fields:[...Object.values(e.transformFieldRoles),e.sourceHashField]})}const c=await o.result(i(`${r.url}/extractChanges`,{method:"post",query:l,timeout:C,signal:e}));if(!c.ok&&w.isTimeoutError(c.error)){const e=this.layer.title;u.getLogger(this).warn("extractChanges:timeout",e,`${e} could not obtain edited features that are not cached in the scene service. Display of features may not be up to date with the latest edits. Consider re-caching the scene service.`)}if(c.ok&&1===c.value.data?.edits?.length){const t=c.value.data.edits[0],r=t?.objectIds,i=t?.fieldUpdates,s=r?.adds??[],n=r?.updates??[],o=r?.deletes??[],l=[...s,...n,...o],u=a?[...s,...i??n,...o]:[],d=Math.min(this._maximumNumberOfEditOVerrides,l.length);d<l.length&&(this._warnMaximumChangedObjectsExceeded=!0);const h=l.sort((e,t)=>e-t);for(let e=0;e<d;++e){const t=h[e];this._attributeChangedObjectIds.add(t)}for(const e of u)this._geometryChangedObjectIds.add(e);for(;this._definitionExpressionDirty;)await this._queryAndAddGeometryOverrides(e)}}async _queryAndAddGeometryOverrides(e){this._definitionExpressionDirty=!1;const t=this.layer,{associatedLayer:r}=t;if(null!=r&&r.capabilities?.operations?.supportsChangeTracking&&this.is3DOFL&&this._geometryChangedObjectIds.size>0){const t=await this._queryGeometryOverridesFromAssociatedLayer(Array.from(this._geometryChangedObjectIds),e);if(null!=t)for(const e of t)null!=e.geometry&&this.updateGeometry(e.attributes[r.objectIdField],e.geometry)}}_getFetchChangedObjectIdsServerGen(){const e=this.layer;if(null!=e.serviceUpdateTimeStamp?.lastUpdate)return e.serviceUpdateTimeStamp.lastUpdate;const t=e.associatedLayer;return null!=t?.serverGens?.minServerGen?t.serverGens.minServerGen:null}async _lockFeatureIds(e){const t=this._featureIdLocks;let r=!0;for(;r;){const i=new Array;for(const r of e){const e=t.get(r);e&&i.push(e)}0===i.length?r=!1:await Promise.all(i)}const i=p.createResolver(),s=i.promise;for(const r of e)t.set(r,s);return l.makeHandle(()=>{for(const r of e)t.delete(r);i.resolve()})}get test(){}},r.__decorate([g.property({constructOnly:!0})],t.I3SOverrides.prototype,"view",void 0),r.__decorate([g.property({constructOnly:!0})],t.I3SOverrides.prototype,"layer",void 0),r.__decorate([g.property({readOnly:!0})],t.I3SOverrides.prototype,"is3DOFL",null),r.__decorate([g.property()],t.I3SOverrides.prototype,"_interactiveEditingSessions",void 0),r.__decorate([g.property({readOnly:!0})],t.I3SOverrides.prototype,"sortedGeometryChangedObjectIds",null),r.__decorate([g.property({readOnly:!0})],t.I3SOverrides.prototype,"geometryOverrides",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_clientGeometryCache",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_associatedLayer",null),r.__decorate([g.property({constructOnly:!0})],t.I3SOverrides.prototype,"memoryController",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_attributeChangedObjectIds",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_geometryChangedObjectIds",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"hasGeometryChanges",null),r.__decorate([g.property()],t.I3SOverrides.prototype,"_pendingFetchChangedObjectIds",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_pendingFetchAbortController",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_applyGeometryOverridesTask",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"updating",null),r.__decorate([g.property()],t.I3SOverrides.prototype,"isEmpty",null),t.I3SOverrides=r.__decorate([y.subclass("esri.views.3d.layers.i3s.I3SOverrides")],t.I3SOverrides);class x{constructor(e,t){this.objectId=e,this._remove=t,this._updates=new Map,this._isActive=!0}getAttribute(e){return this._updates.get(e)}setAttribute(e,t){this.isActive&&this._updates.set(e,t)}remove(){this.isActive&&(this._isActive=!1,this._remove())}get isActive(){return this._isActive}}class S{constructor(e){this._cache=e}destroy(){this._cache.destroy()}put(e,t,r){this._cache.put(this._getKey(e,t),new T(r))}get(e,t){return this._cache.get(this._getKey(e,t))?.value}_getKey(e,t){return`${e}-${t}`}}class T{constructor(e){this.value=e,this.cachedMemory="string"==typeof e?h.estimateStringMemory(e):h.estimateNumberMemory}}const C=1e4,P=5e4;function M(e,t,r,i){return`Displaying the edits of a SceneLayer with a${0===i?e.isGeographic?" geographic ":" projected ":" "}spatial reference (wkid:${e.wkid}) in ${r} viewing mode${1===i?` with spatial reference (wkid:${t.wkid}) `:" "}is not supported. No geometry edits will be displayed for this layer.\nPlease consider re-caching the scene service or changing the ${0===i?"viewing mode":"view spatial reference"} to display edits.`}Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/IDBCache":function(){define(["exports","../../../../core/Error","../../../../core/promiseUtils"],function(e,t,r){"use strict";function i(e){return new Promise((t,r)=>{e.oncomplete=()=>t(),e.onerror=()=>r(e.error),e.onabort=()=>r(e.error)})}function s(e){return new Promise((t,r)=>{"done"===e.readyState?null!=e.error?r(e.error):t(e.result):(e.onsuccess=()=>t(e.result),e.onerror=()=>r(e.error))})}e.IDBCache=class{constructor(e,t,r=14){this._version=r,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=e,this._storeName=t}init(){return Promise.resolve().then(()=>{const e=indexedDB.open(this._dbName,this._version);return e.onupgradeneeded=t=>{const r=e.result,i=e.transaction,s=r.objectStoreNames.contains(this._storeName)?i.objectStore(this._storeName):r.createObjectStore(this._storeName),n=r.objectStoreNames.contains("last_access")?i.objectStore("last_access"):r.createObjectStore("last_access");n.indexNames.contains("date")||n.createIndex("date","date",{unique:!1}),n.indexNames.contains("byteSize")||n.createIndex("byteSize","byteSize",{unique:!1}),t.oldVersion<this._version&&(s.clear(),n.clear())},s(e)}).then(e=>{this._destroyed?e.close():this._db=e})}destroy(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}get initialized(){return null!=this._db}getHitRate(){return this._hit/(this._hit+this._miss)}put(e,r){return null==this._db?Promise.reject(new t("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then(()=>this._put(e,r)).catch(t=>{if(t&&"QuotaExceededError"===t.name)return null==this._quotaReductionPromise&&(this._quotaReductionPromise=this._getCacheSize().then(e=>this._removeLeastRecentlyAccessed(r.byteSize+Math.ceil(e*this.quotaReductionFactor))),this._quotaReductionPromise.then(()=>this._quotaReductionPromise=null,()=>this._quotaReductionPromise=null)),this._quotaReductionPromise.then(()=>this._put(e,r));throw t}).then(()=>{this._gcCounter--,this._gcCounter<0&&null!=this._db&&(this._gcCounter=this.gcFrequency,this._getCacheSize().then(e=>this._removeLeastRecentlyAccessed(e-this.maxByteSize)))})}get(e,t){const i=this._db;if(null==i)return Promise.resolve(void 0);let n=null;return Promise.resolve().then(()=>{const o=i.transaction(this._storeName,"readonly");return n=r.onAbort(t,()=>{o.abort()}),s(o.objectStore(this._storeName).get(e))}).then(t=>(null==t?++this._miss:this._db&&(++this._hit,this._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:t.byteSize},e)),null!=n&&n.remove(),t)).catch(()=>{++this._miss,r.throwIfAborted(t),null!=n&&n.remove()})}remove(e){const t=this._db;return null==t?Promise.resolve():Promise.resolve().then(async()=>{const r=t.transaction([this._storeName,"last_access"],"readwrite"),n=r.objectStore(this._storeName),o=r.objectStore("last_access"),a=n.delete(e),l=o.delete(e);await Promise.all([s(a),s(l),i(r)])})}_put(e,t){const r=this._db;if(null==r)return Promise.resolve();const n=r.transaction([this._storeName,"last_access"],"readwrite"),o=n.objectStore(this._storeName),a=n.objectStore("last_access"),l=o.put(t,e),c=a.put({date:Date.now(),byteSize:t.byteSize},e);return Promise.all([s(l),s(c),i(n)])}_removeLeastRecentlyAccessed(e){if(e<=0||!this._db)return Promise.resolve();const t=this._db.transaction([this._storeName,"last_access"],"readwrite"),r=t.objectStore(this._storeName),s=t.objectStore("last_access");let n=0;const o=s.index("date").openCursor(null,"next");return o.onsuccess=()=>{const t=o.result;null!=t&&(null!=t.value.byteSize&&(n+=t.value.byteSize),r.delete(t.primaryKey),s.delete(t.primaryKey),n<e&&t.continue())},i(t)}_getCacheSize(){const e=this._db;if(null==e)return Promise.resolve(0);const t=e.transaction("last_access"),r=t.objectStore("last_access");let s=0;const n=r.index("byteSize").openKeyCursor();return n.onsuccess=()=>{const e=n.result;if(!e)return;const t=e.key;null!=t&&(s+=t),e.continue()},i(t).then(()=>s)}},e.whenRequest=s,e.whenTransaction=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/IDBMockCache":function(){define(["exports"],function(e){"use strict";const t=new WeakMap;e.IDBMockCache=class{constructor(e,r){switch(this._miss=0,this._hit=0,this.initialized=!0,r){case"layer":this._data=new Map;break;case"view":{const r=t.get(e);if(r){this._data=r;break}const i=new Map;this._data=i,t.set(e,i)}}}init(){return Promise.resolve()}async get(e,t){if(this._data.has(e))return this._hit++,this._data.get(e)??void 0;this._miss++}destroy(){}put(e,t){return this._data.set(e,t),Promise.resolve()}remove(e){return this._data.delete(e),Promise.resolve()}getHitRate(){return this._hit/(this._hit+this._miss)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/LayerElevationProvider":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Evented","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/support/aaBoundingRect","../../../../chunks/sphere","../../support/ElevationRange","../../support/ElevationUpdateEvent","../../webgl-engine/lib/Intersector"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y){"use strict";e.LayerElevationProvider=class extends r.EventedAccessor{constructor(e){super(e),this._tmpEvent=new g.ElevationUpdateEvent,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=new y.Intersector(this.view.state.viewingMode),this._intersector.options.store=0,this._intersector.options.normalRequired=!1,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,t,r,s){const n=this._renderCoordsHelper,o=u.set(v,e,t,r);if(!n.toRenderCoords(o,s,o))return i.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:a,_intersector:l,intersectionHandler:c}=this,d=a.fullExtent,h=null!=d&&Number.isFinite(d.xmin)&&Number.isFinite(d.xmax)&&Number.isFinite(d.ymin)&&Number.isFinite(d.ymax)&&Number.isFinite(d.zmin)&&Number.isFinite(d.zmax)?new m.ElevationRange(d.zmin,d.zmax):a.elevationRange;if(null==h)return null;const p=a.elevationOffset,f=h.elevationRangeMin+p,g=h.elevationRangeMax+p,y=n.setAltitude(w,g,o),_=n.setAltitude(x,f,o);return l.reset(y,_,this.view.state.camera),c.intersect(l,null,y,_,null,!0),l.results.min.getIntersectionPoint(o)?n.getAltitude(o):null}getSphereElevationBounds(e,t){return h.projectBoundingSphere(e,t,b,this._renderSR),this._layerElevationSource.getElevationRange(b)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new m.ElevationRange(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){p.empty(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){p.empty(t);for(const r of e)this._expandExtent(r,t)}_expandExtent(e,t){const r=this.spatialReference;if(null==r)return;if(null==e)return;l.fromQuat(_,e.quaternion),_[12]=e.center[0],_[13]=e.center[1],_[14]=e.center[2];const i=e.halfSize;for(let e=0;e<8;++e)v[0]=1&e?i[0]:-i[0],v[1]=2&e?i[1]:-i[1],v[2]=4&e?i[2]:-i[2],u.transformMat4(v,v,_),this._renderCoordsHelper.fromRenderCoords(v,v,r),p.expand(t,v,t)}},t.__decorate([s.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"layerElevationSource",void 0),t.__decorate([s.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"intersectionHandler",void 0),t.__decorate([s.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"view",void 0),t.__decorate([s.property()],e.LayerElevationProvider.prototype,"spatialReference",null),e.LayerElevationProvider=t.__decorate([a.subclass("esri.views.3d.layers.i3s.LayerElevationProvider")],e.LayerElevationProvider);const _=c.create(),b=f.fromValues(0,0,0,0),v=d.create(),w=d.create(),x=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/SymbologyInfo":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec4f64"],function(e,t){"use strict";e.SymbologyInfo=class{constructor(){this.color=t.create(),this.castShadows=!0,this.pickable=!0,this.colorMixMode=1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/ObjectParameters":function(){define(["exports"],function(e){"use strict";e.ObjectParameters=class{constructor(e,t,r,i){this.toMapSpace=e,this.transform=t,this.obb=r,this.geometry=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/webgl-engine/collections/Component/Transform":function(){define(["exports"],function(e){"use strict";e.Transform=class{constructor(e,t){this.position=e,this.rotationScale=t,this.origin=void 0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/featureEditing":function(){define(["exports","../../../../core/asyncUtils","../../../../core/lang","../../../../core/uuid","../../../../layers/support/featureQueryAll"],function(e,t,r,i,s){"use strict";const n={setAttribute(){},rollback(){},commit(){}};function o(e,t,r){const{gidToFeatureInfo:i,oidToFeatureInfo:s,fieldsIndex:n,objectIdField:o,globalIdField:a,featureOrIdentifierList:l}=r;if(!r.featuresResolved&&null!=l){for(const e of l){const t={feature:null,oid:-1,gid:null};if("attributes"in e){t.feature=e;const r=e.attributes;if(null!=r)for(const e in r){if(-1!==t.oid&&null!=t.gid)break;const i=n.normalizeFieldName(e);i===o&&(t.oid=r[e]??-1),i===a&&(t.gid=r[e])}}else t.oid=e.objectId??-1,t.gid=e.globalId;null!=t.gid&&i.set(t.gid,t),-1!==t.oid&&s.set(t.oid,t)}r.featuresResolved=!0}return(-1!==e?s.get(e):null)??(null!=t?i.get(t):null)}function a(e,t,r,s,n=null,a=!0){const l=[],c={gidToFeatureInfo:new Map,oidToFeatureInfo:new Map,featuresResolved:null==r,fieldsIndex:e.fieldsIndex,objectIdField:e.objectIdField,globalIdField:e.globalIdField,featureOrIdentifierList:r};for(const e of t){if(null!=e.error)continue;const t=e.objectId??-1,r=e.globalId,u=(-1===t||a?o(t,r,c):null)??{feature:null,oid:t,gid:r},d={oid:-1===t?u.oid:t,gid:r??u.gid,feature:u.feature,result:e};l.push(d);const h=d.gid?i.normalizeGlobalID(d.gid):null;if(-1===d.oid&&null!=h&&null!=n&&(d.oid=n.get(h)??-1),-1===d.oid&&null!=h){let e=s.get(h);null==e&&(e={gid:d.gid,edits:[]},s.set(h,e)),e.edits.push(d)}}return l}function l(e,t,r){const i=function(e,t){const r=e.get(t);if(r)return r;const i=new c;return e.set(t,i),i}(e,t),s=null!=r&&i.get(r);if(s)return s;const n=new Array;return i.set(r,n),n}const c=Map,u=Map;e.createInteractiveEditSession=function(e,t){const i=t.attributes[e.objectIdField];if(null==i)return n;const s=e.sessions.get(i);if(s)return s;const o=r.clone(t.attributes),a=new Set,l=e.i3sOverrides.createInteractiveEditSession(i),c=new Map;let u=0;const d={setAttribute(r,s){if(0!==u)return;const n=e.fieldsIndex.get(r);if(!n)return;const d=e.attributeStorageInfo.findIndex(e=>e.name===n.name);if(d<0)return;if(!(r in o))throw new Error(`Attribute "${r}" is not an attribute of the edited feature.`);l.setAttribute(d,s);const h=e.attributeStorageInfo[d];let p=!1;a.add(r),e.forEachNode((r,n)=>{const o=((e,t)=>{const r=c.get(e);if(null==r){const r=t.indexOf(i);return c.set(e,r),r}return r})(r,n);if(-1===o)return;const a=e.getAttributeData(r.index);if(a){const i=a[h.name];i&&(i[o]=s,e.setAttributeData(r.index,a,t),p=!0)}}),p&&e.clearMemCache()},rollback(){if(0===u){for(const e of a)this.setAttribute(e,o[e]);l.remove(),u=1,e.sessions.delete(i)}},commit(){0===u&&(l.remove(),u=2,e.sessions.delete(i))}};return e.sessions.set(i,d),d},e.normalizeEditResultsEvent=async function(e,r){const n=new Map,o=a(e,r.addedFeatures,r.edits?.addFeatures,n),l=a(e,r.updatedFeatures,r.edits?.updateFeatures,n),c=a(e,r.deletedFeatures,r.edits?.deleteFeatures,n,r.globalIdToObjectId,!1);return n.size>0&&await async function(e,r){const n=e.i3sOverrides.layer.associatedLayer;if(null==n?.globalIdField)return;const o=n.createQuery(),{objectIdField:a,globalIdField:l}=n;o.where=Array.from(r.values()).map(({gid:e})=>`${l}='${e}'`).join(" OR "),o.returnGeometry=!1,o.outFields=[a,l],o.cacheHint=!1;const c=await t.resultOrAbort(s.queryAllJSON(n,o));if(!c.ok)return;const u=c.value.features;for(const e of u){const t=e.attributes[l],s=e.attributes[a];if(null==t||null==s||-1===s)continue;const n=r.get(i.normalizeGlobalID(t));if(null!=n)for(const e of n.edits)e.oid=s}}(e,n),{adds:o.filter(e=>-1!==e.oid),updates:l.filter(e=>-1!==e.oid),deletes:c.filter(e=>-1!==e.oid)}},e.processAttributeEdits=function(e,t){const r=function(e,t){const r=t.updates;if(!r||0===r.length)return new u;const i=new u,s=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)s.set(e.attributeStorageInfo[t].name,t);return e.forEachNode((t,s)=>{for(const n of r){if(null==n.feature)continue;const r=n.feature,o=n.oid,a=s.indexOf(o);for(const s in r.attributes){const n=e.fieldsIndex.normalizeFieldName(s),c=l(i,t.index,n),u=r.attributes[s];c.push({featureIndex:a,featureId:o,value:u})}}}),i}(e,t),i=function(e,t){const r=new Map,i=t.adds;if(!i||0===i.length||null==e.globalIdField)return r;for(const e of i){const t=e.oid,i=e.feature;"mesh"===i?.geometry?.type&&r.set(t,i)}return r}(e,t);if(0===r.size&&0===i.size)return;const s=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)s.set(e.attributeStorageInfo[t].name,t);let n=!1;r.forEach((t,r)=>{const i=e.getAttributeData(r);let o=!1;t.forEach((t,r)=>{const a=null!=i?i[r]:null,l=s.get(r);for(const{featureIndex:r,value:i,featureId:s}of t)a&&(a[r]=i,o=!0,n=!0),e.i3sOverrides.updateAttributeValue(s,l,i)}),o&&e.setAttributeData(r,i,null)}),n&&e.clearMemCache();const{fieldsIndex:o,i3sOverrides:a,objectIdField:c,globalIdField:d}=e,h=a.layer.associatedLayer?.infoFor3D,p=new Set(h?[...Object.values(h.assetMapFieldRoles),...Object.values(h.transformFieldRoles)]:[]);for(const[e,t]of i){a.featureAdded(e);const{attributes:r}=t;for(const t in r){if(t!==c&&t!==d&&p.has(t))continue;const i=o.normalizeFieldName(t),n=null!=i?s.get(i):null;if(null==n)continue;const l=r[t];a.updateAttributeValue(e,n,l)}}},e.processGeometryEdits=function(e,t){const r=new Map,i=e=>{for(const{oid:t,feature:i}of e){const e=i?.geometry;"mesh"===e?.type&&r.set(t,e)}};i(t.adds),i(t.updates);for(const e of t.deletes)r.set(e.oid,null);for(const[t,i]of r)e.i3sOverrides.updateGeometry(t,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SMeshViewFilter":function(){define(["require","exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybeUpdating","../../../../core/reactiveUtils","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/sql/WhereClause","../../../../geometry/ellipsoidUtils","../../../../geometry/projectionUtils","../../../../geometry/SpatialReference","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/projection/projectVectorToVector","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/DoubleArray","../../../../geometry/support/Ellipsoid","../../../../geometry/support/spatialReferenceUtils","../../../../chunks/sphere","../../../../geometry/support/webMercatorUtils","../../../../layers/support/FeatureFilter","./I3SUtil"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O){"use strict";t.I3SMeshViewFilter=class extends i{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){l.whenOnce(()=>this.viewFilter?.geometry||null!=this.layerFilter).then(()=>this.loadAsyncModule(new Promise((t,r)=>e(["../../../../geometry/geometryEngine"],t,r)).then(e=>{this.destroyed||(this._geometryEngine=e)})))}get sortedObjectIds(){if(null==this.viewFilter?.objectIds)return null;const e=S.doubleArrayFrom(this.viewFilter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=this.viewFilter?.where;if(null==e||!e)return null;try{return m.create(e,{fieldsIndex:this.layerFieldsIndex})}catch(e){n.getLogger(this).error(`Failed to parse filter where clause: ${e}`)}return null}addFilters(e,t,r,i){const s=this.sortedObjectIds;null!=s&&e.push(e=>O.objectIdFilter(s,!0,e)),this.addSqlFilter(e,this.parsedWhereClause),this.addTimeFilter(e,this.viewFilter?.timeExtent);const o=a.unwrapUpdating(this._layerMaskGeometries),l=this._geometryEngine,c=()=>n.getLogger(this);if(null!=o&&null!=this.layerFilter&&null!=l){const s=this.layerFilter.spatialRelationship;e.push((e,n)=>D(c,l,e,n,i,t,r,o,s))}const u=a.unwrapUpdating(this._viewMaskGeometries);if(null!=u&&null!=this.viewFilter&&null!=l){const s=this.viewFilter.spatialRelationship;e.push((e,n)=>D(c,l,e,n,i,t,r,u,s))}}isMBSGeometryVisible(e,t,r){const i=a.unwrapUpdating(this._layerMaskGeometries),s=this._geometryEngine;if(null!=i&&null!=this.layerFilter&&null!=s){const o=this.layerFilter.spatialRelationship,a=i[0].spatialReference||t;return b.projectBoundingSphere(e,r,E,a)?A(s,E,i,a,o):(n.getLogger(this).warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}const o=a.unwrapUpdating(this._viewMaskGeometries);if(null!=o&&null!=this.viewFilter&&null!=s){const i=this.viewFilter.spatialRelationship,a=o[0].spatialReference||t;return b.projectBoundingSphere(e,r,E,a)?A(s,E,o,a,i):(n.getLogger(this).warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}get parsedGeometry(){const e=a.unwrapUpdating(this._viewMaskGeometries),t=a.unwrapUpdating(this._layerMaskGeometries);return null==e||null==t?e||t:t.concat(e)}get _layerMaskGeometries(){const e=this.layerFilter;return null==e?null:null==this._geometryEngine?a.updating:"disjoint"===e.spatialRelationship?e.geometries.map(e=>({type:"polygon",rings:e.rings,spatialReference:e.spatialReference,cache:{}})):[e.geometries.reduce((e,t)=>(e.rings=[...e.rings,...t.rings],e),{type:"polygon",rings:[],spatialReference:e.geometries[0].spatialReference,cache:{}})]}get _viewMaskGeometries(){if(null==this.viewFilter)return null;const{geometry:e}=this.viewFilter;if(null==e)return null;if(null==this.viewFilter||null==this._geometryEngine)return a.updating;const{distance:t,units:r}=this.viewFilter,i=this.viewFilter.spatialRelationship,s="mesh"===e.type?e.extent:e;if(null==t||0===t)return F(this._geometryEngine,s,i);const o=r||c.getUnitString(s.spatialReference);if(s.spatialReference.isWGS84){const e=this._geometryEngine.geodesicBuffer(s,t,o);return F(this._geometryEngine,e,i)}const l=M.project(s,_.WGS84);if(null!=l){const e=M.project(this._geometryEngine.geodesicBuffer(l,t,o),s.spatialReference);return F(this._geometryEngine,e,i)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(y.load().then(()=>this._projectionEngineLoaded=!0)),!this._projectionEngineLoaded))return null;let u=null;try{u=y.project(s,_.WGS84)}catch(e){}if(u)try{u=y.project(this._geometryEngine.geodesicBuffer(u,t,o),s.spatialReference)}catch(e){u=null}return u||n.getLogger(this).error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${s.spatialReference.wkid}) to WGS84.`),F(this._geometryEngine,u,i)}get updating(){return a.isUpdating(this._layerMaskGeometries)||a.isUpdating(this._viewMaskGeometries)}static checkSupport(e){return!(null==e||(null==(t=e.spatialRelationship)||!I.includes(t))&&(n.getLogger(this.prototype).warn(`Filters with spatialRelationship other than ${I.join(", ")} are not supported for mesh scene layers`),1));var t}},r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"layerFilter",void 0),r.__decorate([u.property({type:R})],t.I3SMeshViewFilter.prototype,"viewFilter",void 0),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"addSqlFilter",void 0),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"addTimeFilter",void 0),r.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"sortedObjectIds",null),r.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedWhereClause",null),r.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedGeometry",null),r.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_layerMaskGeometries",null),r.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_viewMaskGeometries",null),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"updating",null),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"_geometryEngine",void 0),t.I3SMeshViewFilter=r.__decorate([h.subclass("esri.views.3d.layers.i3s.I3SMeshViewFilter")],t.I3SMeshViewFilter);const I=["contains","intersects","disjoint"];function F(e,t,r){if(null==t)return null;if("disjoint"===r&&"polygon"===t.type){const r=t.rings.length,i=t.spatialReference,n=new Array(r);for(let e=0;e<r;++e){const r=x.fromValues(1/0,1/0,-1/0,-1/0);x.expandWithNestedArray(r,t.rings[e]),n[e]={type:"polygon",rings:[t.rings[e]],spatialReference:i,cache:{},aabr:r}}n.sort((e,t)=>e.aabr[0]-t.aabr[0]);const o=new Set,a=new s.PositionHint;for(let t=0;t<n.length;++t){const r=n[t],i=r.aabr[0];o.forEach(t=>{if(i>=t.aabr[2])return void o.delete(t);if(r.aabr[1]>t.aabr[3]||r.aabr[3]<t.aabr[1]||!e.intersects(r,t))return;r.rings=r.rings.concat(t.rings),x.expand(r.aabr,t.aabr,r.aabr),r.cache={},o.delete(t);const l=s.indexOf(n,t,n.length,a);n.splice(l,1)}),o.add(r)}for(const e of n)e.aabr=void 0;return n}return[t]}function A(e,t,r,i,s){if(t[3]>=.5*(t[2]+g.getReferenceEllipsoid(i).radius))return!0;const n=L(e,t,i);return r.every(t=>1!==V(e,t,n,s))}function D(e,t,r,i,s,n,o,a,l){const c=a[0].spatialReference||n.spatialReference;if(!b.projectBoundingSphere(i.node.serviceMbsInIndexSR,o,E,c))return void e().warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const u=L(t,E,c),d=function(e,t,r,i,s){const n=t.renderSpatialReference,o=new Map,a={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],spatialReference:r};let l,c;switch(a.rings[0][3]=a.rings[0][0],e){case"intersects":l=(e,t,r)=>e.intersects(t,r)?0:2,c=U;break;case"contains":l=(e,t,r)=>e.contains(t,r)?2:1,c=U;break;default:l=(e,t,r)=>e.disjoint(t,r)?2:1,c=B}return{collection:i,object:s,type:e,maskSR:r,renderSR:n,aabbCache:o,triangle:a,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:l,geometryTest:c}}(l,n,c,s,i.objectHandle),h="intersects"===l;let p=null;for(const e of a){if(0===r.length)return;switch(V(t,e,u,l)){case 1:return h&&(i.weaklyRemovedIds=i.weaklyRemovedIds?.concat(r)??r.slice()),void(r.length=0);case 0:continue}O.filterInPlace(r,i.featureIds,r=>!!N(t,e,r,d)||(h&&(p||=[],p.push(i.featureIds[r])),!1))}p&&(i.weaklyRemovedIds=i.weaklyRemovedIds?.concat(p)??p)}const E=P.fromValues(0,0,0,0);function L(e,t,r){const i={type:"point",x:t[0],y:t[1],hasZ:!1,hasM:!1,spatialReference:r},s=!C.isWGS84(r)&&!C.isWebMercator(r),n=Number.isNaN(t[3])?0:o.clamp(t[3],0,2*T.earth.radius),a=s?e.buffer(i,n,1):e.geodesicBuffer(i,n,1);return a.type="polygon",a}function V(e,t,r,i){switch(i){case"intersects":case"contains":return U(e,t,r);case"disjoint":return B(e,t,r)}}function U(e,t,r){return e.intersects(t,r)?e.contains(t,r)?0:2:1}function B(e,t,r){return e.intersects(t,r)?e.contains(t,r)?1:2:0}function N(e,t,r,i){const{collection:s,object:n,renderSR:o,maskSR:a,geometryTest:l,aabbCache:c}=i;let u=c.get(r);if(!u){const e=s.getObjectTransform(n);s.getComponentAabb(n,r,k);const t=[f.fromValues(k[0],k[1],0),f.fromValues(k[0],k[4],0),f.fromValues(k[3],k[4],0),f.fromValues(k[3],k[1],0)];for(let r=0;r<4;++r)p.transformMat3(t[r],t[r],e.rotationScale),p.add(t[r],t[r],e.position),v.projectVectorToVector(t[r],o,t[r],a);u={type:"polygon",rings:[t],spatialReference:a,cache:{}},u.rings[0][4]=u.rings[0][0],c.set(r,u)}switch(l(e,t,u)){case 1:return!1;case 0:return!0}const{triangle:d,triangleTest:h,positions:m}=i,g=d.rings[0][0],y=d.rings[0][1],_=d.rings[0][2],b=s.getObjectTransform(n);s.getComponentPositions(n,r,m);const{indices:w,data:x,stride:S,startIndex:T,endIndex:C}=m;for(let r=T;r<C;r+=3){const i=S*w[r],s=S*w[r+1],n=S*w[r+2];switch(p.set(g,x[i],x[i+1],x[i+2]),p.set(y,x[s],x[s+1],x[s+2]),p.set(_,x[n],x[n+1],x[n+2]),p.transformMat3(g,g,b.rotationScale),p.transformMat3(y,y,b.rotationScale),p.transformMat3(_,_,b.rotationScale),p.add(g,g,b.position),p.add(y,y,b.position),p.add(_,_,b.position),v.projectVectorToVector(g,o,g,a),v.projectVectorToVector(y,o,y,a),v.projectVectorToVector(_,o,_,a),h(e,t,d)){case 1:return!1;case 0:return!0}}return"intersects"!==i.type}const k=w.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/core/maybeUpdating":function(){define(["exports"],function(e){"use strict";e.isUpdating=function(e){return"updating"===e},e.unwrapUpdating=function(e){return"updating"===e?null:e},e.updating="updating",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SQueryEngine":function(){define(["require","exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../layers/LayerConstants","../../../../layers/graphics/data/QueryEngine","../../../../layers/support/FieldsIndex","../../../../rest/support/FeatureSet","../../../../rest/support/Query"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m){"use strict";const g=h.QueryEngine;t.I3SQueryEngine=class extends i{constructor(e){super(e)}initialize(){this.addHandles(this.layerView.on("visible-geometry-changed",()=>this.spatialIndex.events.emit("changed")))}destroy(){this._dataQueryEngineInstance=s.destroyMaybe(this._dataQueryEngineInstance),this._set("layerView",null)}get spatialReference(){return this.layerView.view.spatialReference}get layer(){return this.layerView.i3slayer}get defaultQueryJSON(){return new m({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:r,extent:i}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:u.fromJSON(i)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQuery(t,r){const i=this._ensureQueryJSON(t),s=await this._dataQueryEngine.executeQuery(i,r);if(t?.returnGeometry){const{processQueryGeometries:t}=await new Promise((t,r)=>e(["./I3SQueryResultGeometry"],t,r));return t(this.layerView,s)}return f.fromJSON(s)}_ensureQueryJSON(e){return null==e?this.defaultQueryJSON:e.toJSON()}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||d.fallbackObjectIDAttribute,t=this.layer.fieldsIndex?.toJSON()||new p([]),r=this.layerView.view.resourceController.scheduler,i=this.spatialReference.toJSON(),s=this.priority,n=this.spatialIndex;return this._dataQueryEngineInstance=new g({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fieldsIndex:t,timeInfo:null,spatialReference:i,featureIdInfo:{type:"object-id",fieldName:e},featureStore:n,scheduler:r,priority:s}),this._dataQueryEngineInstance}},r.__decorate([n.property({constructOnly:!0})],t.I3SQueryEngine.prototype,"layerView",void 0),r.__decorate([n.property({constructOnly:!0})],t.I3SQueryEngine.prototype,"priority",void 0),r.__decorate([n.property({constructOnly:!0})],t.I3SQueryEngine.prototype,"spatialIndex",void 0),r.__decorate([n.property()],t.I3SQueryEngine.prototype,"spatialReference",null),r.__decorate([n.property()],t.I3SQueryEngine.prototype,"layer",null),r.__decorate([n.property()],t.I3SQueryEngine.prototype,"defaultQueryJSON",null),t.I3SQueryEngine=r.__decorate([c.subclass("esri.views.3d.layers.i3s.I3SQueryEngine")],t.I3SQueryEngine),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SQueryFeatureAdapter":function(){define(["exports","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/centroid","../../../../layers/graphics/OptimizedGeometry","./I3SBinaryReader"],function(e,t,r,i,s){"use strict";class n{constructor(e,t,r,i){this.id=e,this.index=t,this.meta=r,this.geometry=i}get usedMemory(){return 32+(this.geometry?.usedMemory??0)}}const o=t.create();e.I3SQueryFeature=n,e.I3SQueryFeatureAdapter=class{constructor(e){this._objectIdField=e.objectIdField,this._getFeatureExtent=e.getFeatureExtent}getObjectId(e){return e.id}getAttributes(e){const{meta:t,index:r}=e,i={};this._objectIdField&&(i[this._objectIdField]=e.id);const n=t.attributeInfo?.attributeData;if(null!=n)for(const e of Object.keys(n))i[e]=s.getCachedAttributeValue(n[e],r);return i}getAttribute(e,t){if(t===this._objectIdField)return e.id;const{meta:r,index:i}=e,n=r.attributeInfo?.attributeData;return null!=n?s.getCachedAttributeValue(n[t],i):null}getGeometry(e){if(e.geometry)return e.geometry;const[t,r,s,n,a,l]=this._getFeatureExtent(e,o);return new i([5,5],[t,r,s,n,r,s,n,a,s,t,a,s,t,r,s,t,r,l,n,r,l,n,a,l,t,a,l,t,r,l])}getCentroid(e,t){if(e.geometry)return r.getCentroidOptimizedGeometry(new i,e.geometry,t.hasZ,t.hasM);const[s,n,a,l,c,u]=this._getFeatureExtent(e,o);return new i([0],[(s+l)/2,(n+c)/2,(a+u)/2])}cloneWithGeometry(e,t){const{id:r,index:i,meta:s}=e;return new n(r,i,s,t)}getMetadata(e){return e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/DefinitionExpressionSceneLayerView":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/sql/WhereClause","../i3s/I3SUtil"],function(e,t,r,i,s,n,o,a,l){"use strict";e.DefinitionExpressionSceneLayerView=e=>{const s=e;let n=class extends s{constructor(){super(...arguments),this._definitionExpressionErrors=0,this._maxDefinitionExpressionErrors=20,this.logError=e=>{this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&r.getLogger(this).error("Error while evaluating definitionExpression: "+e),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&r.getLogger(this).error("Further errors are ignored")}}get parsedDefinitionExpression(){if(!this.i3slayer?.definitionExpression)return null;try{const e=a.create(this.i3slayer.definitionExpression,{fieldsIndex:this.i3slayer.fieldsIndex});if(!e.isStandardized)return r.getLogger(this).error("definitionExpression is using non standard function"),null;const t=[],i=e.fieldNames;return l.findFieldsCaseInsensitive(i,this.i3slayer.fieldsIndex,{missingFields:t}),t.length>0?(r.getLogger(this).error(`definitionExpression references unknown fields: ${t.join(", ")}`),null):(this._definitionExpressionErrors=0,e)}catch(e){return r.getLogger(this).error("Failed to parse definitionExpression: "+e),null}}get definitionExpressionFields(){return this.parsedDefinitionExpression?this.parsedDefinitionExpression.fieldNames:[]}_evaluateClause(e,t){if(null==e)return!0;try{return e.testFeature(t)}catch(e){return this.logError(e),!1}}_addDefinitionExpressionToQuery(e){if(!this.parsedDefinitionExpression)return e;const t=this.i3slayer.definitionExpression,r=e.clone();return r.where?r.where=`(${t}) AND (${r.where})`:r.where=t,r}};return t.__decorate([i.property({readOnly:!0})],n.prototype,"parsedDefinitionExpression",null),t.__decorate([i.property({readOnly:!0})],n.prototype,"definitionExpressionFields",null),n=t.__decorate([o.subclass("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView")],n),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/fieldProperties":function(){define(["exports","../../../../layers/support/fieldUtils"],function(e,t){"use strict";e.defineFieldProperties=function(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:r},requiredFields:i}=this;return e.outFields?t.fixFields(r,[...t.unpackFieldNames(r,e.outFields),...i]):t.fixFields(r,i)}}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/SceneLayerViewRequiredFields":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/AsyncUpdate","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/support/fieldUtils"],function(e,t,r,i,s,n,o,a,l,c){"use strict";e.SceneLayerViewRequiredFields=class extends(i.AsyncUpdateMixin(r)){get layer(){return this.layerView.layer}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:t},rendererFields:r,labelingFields:i,viewFilterFields:s}=this;return c.fixFields(e,[...t??[],...r??[],...i??[],...s??[]])}constructor(e){super(e)}initialize(){this.addHandles([this.autoUpdateAsync("rendererFields",async()=>{const{fieldsIndex:e,renderer:t}=this.layer;return t?this._getFieldsAsync(r=>t.collectRequiredFields(r,e)):null}),this.autoUpdateAsync("labelingFields",async()=>{const{layer:e}=this;return e.labelsVisible?this._getFieldsAsync(t=>c.collectLabelingFields(t,e)):null}),this.autoUpdateAsync("viewFilterFields",()=>{const{layer:e,mergedFilter:t}=this.layerView;return this._getFieldsAsync(r=>c.collectFilterFields(r,e,t))})])}async _getFieldsAsync(e){const t=new Set;try{return await e(t),Array.from(t).sort()}catch(e){return s.getLogger(this).error(e),null}}},t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"layerView",void 0),t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"layer",null),t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"requiredFields",null),t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"rendererFields",void 0),t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"labelingFields",void 0),t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"viewFilterFields",void 0),e.SceneLayerViewRequiredFields=t.__decorate([l.subclass("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],e.SceneLayerViewRequiredFields),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/core/AsyncUpdate":function(){define(["exports","../chunks/tslib.es6","./Accessor","./Logger","./promiseUtils","./reactiveUtils","./accessorSupport/decorators/property","./accessorSupport/decorators/subclass"],function(e,t,r,i,s,n,o,a){"use strict";const l=e=>{const r=e;let l=class extends r{constructor(){super(...arguments),this._numUpdating=0}get updating(){return this._numUpdating>0}autoUpdateAsync(e,t){const r=s.debounce(async t=>{++this._numUpdating;try{const r=await t;this.destroyed||this._set(e,r)}catch(t){i.getLogger(this).warn(`Async update of "${String(e)}" failed. Async update functions should not throw exceptions.`)}--this._numUpdating});return n.watch(t,r,n.initial)}};return t.__decorate([o.property({readOnly:!0})],l.prototype,"updating",null),t.__decorate([o.property()],l.prototype,"_numUpdating",void 0),l=t.__decorate([a.subclass("esri.core.AsyncUpdate")],l),l},c=l(r);e.AsyncUpdate=c,e.AsyncUpdateMixin=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/support/TemporalSceneLayerView":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/data/timeSupport","../../../../layers/support/FeatureFilter","../../../../layers/support/timeSupport","../i3s/I3SBinaryReader","../i3s/I3SUtil"],function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h{constructor(e){this.attributeData=e}getAttribute(e,t){return u.getCachedAttributeValue(this.attributeData[t],e)}getAttributeAsTimestamp(e,t){const r=this.getAttribute(e,t);return"string"==typeof r?new Date(r).getTime():"number"==typeof r||null==r?r:null}}e.TemporalSceneLayerView=e=>{const i=e;let s=class extends i{get timeExtent(){return c.combineTimeExtent(this.i3slayer,this.view?.timeExtent,this._get("timeExtent"))}get mergedFilter(){const{filter:e,timeExtent:t}=this;if(null==t)return e;const r=e?.clone()??new l;return null!=t&&(r.timeExtent=r.timeExtent?.intersection(t)??t),r}getTimeFilterDependencies(){const{timeInfo:e}=this.i3slayer;if(null==e)return[];const{startField:t,endField:r}=e;return[t,r]}addTimeFilter(e,t){if(null==t)return;const{timeInfo:r}=this.i3slayer;if(null==r)return;const{startField:i,endField:s,useTime:n}=r;if(!n||null==i&&null==s)return;const o=r.toJSON(),l=t.toJSON();e.push((e,t)=>function(e,t,r,i){const s=t.attributeInfo?.attributeData;if(null==s)return;const{startTimeField:n,endTimeField:o}=r;if(null!=n&&null==s[n]||null!=o&&null==s[o])return;const l=a.getTimeOperator(r,i,new h(s));if(null==l)return;const{featureIds:c}=t;d.filterInPlace(e,c,l)}(e,t,o,l))}};return t.__decorate([r.property({readOnly:!0})],s.prototype,"timeExtent",null),t.__decorate([r.property()],s.prototype,"mergedFilter",null),s=t.__decorate([o.subclass("esri.views.3d.layers.support.TemporalSceneLayerView")],s),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/SceneLayerView":function(){define(["require","exports","../../chunks/tslib.es6","../../core/arrayUtils","../../core/Logger","../../core/maybe","../../core/maybeUpdating","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/projectionUtils","./LayerView"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";return t.default=class extends p{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryEngine=null,this._projectionEngineLoaded=!1,this._abortController=new AbortController}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return o.unwrapUpdating(this._layerFilter)}get _layerFilter(){const e=this.layer?.filter;if(null==e||e.geometries.length<1)return null;const t=this._geometryEngine;if(null==t||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return o.updating;const r=e.geometries.at(0).spatialReference,n=e.geometries.toArray().map(e=>{try{e=t.simplify(e)}catch(e){return s.getLogger(this).warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(null==e)return null;if(e.spatialReference.equals(r))return e;try{return h.project(e,r)}catch(e){return s.getLogger(this).warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}}).filter(i.isSome).sort((e,t)=>e.extent.xmin-t.extent.xmin),a=new Set,l=new Array,c=new Array;for(let e of n){const r=e.extent.xmin;if(l.length=0,a.forEach(i=>{if(r>=i.extent.xmax)return c.push(i),void a.delete(i);e.extent.ymin<=i.extent.ymax&&e.extent.ymax>=i.extent.ymin&&t.intersects(e,i)&&l.push(i)}),l.length>0){l.push(e);try{e=t.union(l)}catch(e){s.getLogger(this).warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}l.pop(),l.forEach(e=>a.delete(e))}a.add(e)}return a.forEach(e=>c.push(e)),c.length>0?{spatialRelationship:e.spatialRelationship,geometries:c}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(null==e||e.geometries.length<=1)return!1;const t=e.geometries.at(0).spatialReference;return e.geometries.some(({spatialReference:e})=>!e.equals(t)&&!h.canProjectWithoutEngine(e,t))}get layerFilterUpdating(){return o.isUpdating(this._layerFilter)}initialize(){const{signal:t}=this._abortController;l.whenOnce(()=>this.destroyed||!this._geometryEngine&&this.layer?.filter?.geometries?.length,t).then(async()=>{a.throwIfAbortError(t),this._geometryEngine=await new Promise((t,r)=>e(["../../geometry/geometryEngine"],t,r))}).catch(a.throwIfNotAbortError),this._projectionEngineLoaded=h.isLoaded(),l.whenOnce(()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine,t).then(async()=>{a.throwIfAbortError(t),await h.load(),this._projectionEngineLoaded=!0}).catch(a.throwIfNotAbortError)}destroy(){this._abortController=n.abortMaybe(this._abortController)}highlight(e,t){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}},r.__decorate([c.property()],t.default.prototype,"layer",void 0),r.__decorate([c.property()],t.default.prototype,"availableFields",null),r.__decorate([c.property()],t.default.prototype,"maximumNumberOfFeatures",null),r.__decorate([c.property({readOnly:!0})],t.default.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([c.property()],t.default.prototype,"filter",void 0),r.__decorate([c.property({readOnly:!0})],t.default.prototype,"layerFilter",null),r.__decorate([c.property({readOnly:!0})],t.default.prototype,"_layerFilter",null),r.__decorate([c.property()],t.default.prototype,"_geometryEngine",void 0),r.__decorate([c.property()],t.default.prototype,"_projectionEngineLoaded",void 0),r.__decorate([c.property()],t.default.prototype,"_filterNeedsProjectionEngine",null),r.__decorate([c.property()],t.default.prototype,"layerFilterUpdating",null),t.default=r.__decorate([d.subclass("esri.views.layers.SceneLayerView")],t.default),t.default})},"esri/views/3d/layers/SceneLayerGraphicsView3D":function(){define(["require","../../../chunks/tslib.es6","../../../core/has","../../../core/Logger","../../../core/maybe","../../../core/memoryEstimations","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/uid","../../../core/accessorSupport/decorators/property","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/projection/projectBuffer","../../../geometry/projection/projectVectorToVector","../../../geometry/support/contains","../../../geometry/support/DoubleArray","../../../geometry/support/zscale","../../../graphic/SceneGraphicOrigin","../../../layers/LayerConstants","../../../layers/graphics/dehydratedFeatures","../../../layers/graphics/dehydratedPoint","../../../layers/graphics/hydratedFeatures","../../../layers/graphics/controllers/I3SOnDemandController","../../../layers/support/FeatureFilter","../../../rest/support/Query","../../../support/basemapUtils","../../../support/guards","./I3SPointsWorkerHandle","./LayerView3D","./graphics/Graphics3DFeatureProcessor","./graphics/QueryEngine","./graphics/QueryEngineContext","./i3s/featureEditing","./i3s/I3SBinaryReader","./i3s/I3SGraphicsMap","./i3s/I3SOverrides","./i3s/I3SUtil","./support/attributeUtils","./support/DefinitionExpressionSceneLayerView","./support/fieldProperties","./support/highlightUtils","./support/LayerViewPerformanceInfo","./support/PopupSceneLayerView","./support/SceneLayerViewRequiredFields","./support/TemporalSceneLayerView","../support/debugFlags","../support/orientedBoundingBox","../support/updatingProperties","../webgl-engine/lib/Attribute","../../layers/SceneLayerView","../../layers/support/popupUtils","../../support/highlightOptionsUtils","../../support/layerViewUtils","../../support/Scheduler"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V,U,B,N,k,z,j,G,q,H,W,$,Q,Z,Y,X,J,K,ee,te){"use strict";const re=z.defineFieldProperties();class ie{constructor(e,t,r,i){this.graphics=e,this.featureIds=t,this.attributeInfo=r,this.node=i}get cachedMemory(){return this.graphics.reduce((e,t)=>w.estimateSize(t)+e,n.estimateNumberArrayMemory(this.featureIds)+1024)}}let se=class extends(W.TemporalSceneLayerView(k.DefinitionExpressionSceneLayerView(q.PopupSceneLayerView(I.LayerView3D(X))))){constructor(){super(...arguments),this.type="scene-layer-graphics-3d",this._queryEngine=null,this._memCache=null,this._interactiveEditingSessions=new Map,this._pendingEditsQueue=Promise.resolve(),this.loadedGraphics=new V.I3SGraphicsMap((e,t,r)=>function(e,t,r){const i=t.attributeInfo;if(null==i?.loadedAttributes||null==i.attributeData)return!1;let s=!1;for(const{name:t}of i.loadedAttributes)if(i.attributeData[t]){const n=L.getCachedAttributeValue(i.attributeData[t],r);n!==e.attributes[t]&&(e.attributes[t]=n,s=!0)}return s}(e,t,r),e=>this.processor.graphicsCore.recreateGraphics(e)),this.holeFilling="always",this.progressiveLoadFactor=1,this.supportsHeightUnitConversion=!0,this._coordinatesOutsideExtentErrors=0,this._maxCoordinatesOutsideExtentErrors=20}tryRecycleWith(e,t){return e.url===this.layer.url&&this._i3sOverrides.isEmpty?e.load(t).then(()=>{o.throwIfAborted(t),B.checkRecyclable(this.layer,e,this._i3sOverrides),this.layer=e,this._i3sOverrides.destroy();const r=this.view.resourceController?.memoryController;this._i3sOverrides=new U.I3SOverrides({view:this.view,layer:e,memoryController:r}),s.destroyMaybe(this._queryEngine),this._setupQueryEngine(),this.processor.resetObjectStates()}):null}initialize(){this.addResolvingPromise(this.layer.indexInfo);const t=this.view.resourceController?.memoryController;this._i3sOverrides=new U.I3SOverrides({view:this.view,layer:this.layer,memoryController:t}),B.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode),this._fieldsHelper=new H.SceneLayerViewRequiredFields({layerView:this}),this._updatingHandles.add(()=>this.layer.rangeInfos,e=>this._rangeInfosChanged(e),a.initial),this._updatingHandles.add(()=>this.layer.renderer,(e,t)=>this._rendererChange(e,t)),this._updatingHandles.add(()=>[this.parsedDefinitionExpression,this.layer.excludeObjectIds],()=>this._filterChange()),this._set("processor",new F.Graphics3DFeatureProcessor({owner:this,preferredUpdatePolicy:0,scaleVisibilityEnabled:!ee.hasLayerBasedScaleVisibility(),filterVisibilityEnabled:!0,timeExtentEnabled:!1,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,setUidToIdOnAdd:!1,dataExtent:this.layer.fullExtent,updateClippingExtent:e=>this._updateClippingExtent(e)})),this.processor.elevationAlignment?.events.on("invalidate-elevation",({extent:e,spatialReference:t})=>this._controller.updateElevationChanged(e,t)),this.supportsHeightUnitConversion&&(this._verticalScale=_.getGeometryZScaler("point",this.layer.spatialReference,this.view.spatialReference)),this.addResolvingPromise(this.processor.when()),this._memCache=this.view.resourceController.memoryController.newCache(`psl-${this.uid}`),this._controller=new T({layerView:this}),B.containsDraco(this.layer.geometryDefinitions)&&(this._workerHandle=new O.I3SPointsWorkerHandle(e=>this.view.resourceController.immediate.schedule(e))),this.addHandles(this.layer.on("apply-edits",e=>this._updatingHandles.addPromise(e.result))),this.addHandles([this.layer.on("edits",e=>{const t=this._pendingEditsQueue.then(()=>this._handleEdits(e)).then();this._pendingEditsQueue=t,this._updatingHandles.addPromise(t)}),a.watch(()=>$.debugFlags.I3S_TREE_SHOW_TILES,t=>{if(t&&!this._treeDebugger){const t=this._controller.crsIndex;new Promise((t,r)=>e(["./support/I3STreeDebugger"],t,r)).then(({I3STreeDebugger:e})=>{!this._treeDebugger&&$.debugFlags.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new e({lv:this,view:this.view,nodeSR:t}))})}else t||!this._treeDebugger||$.debugFlags.I3S_TREE_SHOW_TILES||(this._treeDebugger.destroy(),this._treeDebugger=null)},a.initial)]),this.when(()=>{this._setupQueryEngine(),this._updatingHandles.add(()=>this.maximumNumberOfFeatures,e=>this._controller.featureTarget=e,a.initial),this._updatingHandles.add(()=>this.suspended,e=>{e&&this._removeAllNodeData()})})}destroy(){this._treeDebugger=s.destroyMaybe(this._treeDebugger),this._i3sOverrides=s.destroyMaybe(this._i3sOverrides),this._set("processor",s.destroyMaybe(this.processor)),this._controller=s.destroyMaybe(this._controller),this._queryEngine=s.destroyMaybe(this._queryEngine),this._workerHandle=s.destroyMaybe(this._workerHandle),this._memCache=s.destroyMaybe(this._memCache),this.loadedGraphics.clear(),this._fieldsHelper=s.destroyMaybe(this._fieldsHelper)}get i3slayer(){return this.layer}get layerViewUid(){return this.uid}get updatingProgressValue(){return this._controller?.updatingProgress??1}get visibleAtCurrentScale(){return ee.hasLayerBasedScaleVisibility()?ee.isInEffectiveScaleRange(this.layer.effectiveScaleRange,this.view.scale):!this.processor?.scaleVisibilitySuspended}get requiredFields(){return this._fieldsHelper?.requiredFields??[]}get maximumNumberOfFeatures(){const e=this.processor?.graphicsCore?.displayFeatureLimit;return e?.maximumNumberOfFeatures??0}set maximumNumberOfFeatures(e){null!=e?(this._override("maximumNumberOfFeatures",e),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)}get maximumNumberOfFeaturesExceeded(){return!this.suspended&&!!this._controller?.useMaximumNumberOfFeatures&&!this._controller.leavesReached}get _excludeObjectIds(){return new Set(this.layer.excludeObjectIds)}get lodFactor(){return"Labels"===this.layer.semantic?1:this.view.qualitySettings.sceneService.point.lodFactor}get hasM(){return!1}get hasZ(){return!0}get contentVisible(){return!this.suspended&&!!this._controller?.rootNodeVisible}get legendEnabled(){return this.contentVisible&&!0===this.i3slayer?.legendEnabled}get _graphicOrigin(){return new b(this.layer)}async whenGraphicAttributes(e,t){return B.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,()=>[...this.loadedGraphics.nodes()])}getHit(e){if(!this.loadedGraphics)return null;const t=S.hydrateGraphic(this.loadedGraphics.find(t=>t.uid===e),this.layer),r=this._getObjectIdField();return t?.attributes?.[r]?(t.layer=this.layer,t.sourceLayer=this.layer,t.origin=this._graphicOrigin,{type:"graphic",graphic:t,layer:t.layer}):null}whenGraphicBounds(e,t){return this.processor.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.processor.computeAttachmentOrigin(e,t)}isUpdating(){return!!(this._controller?.updating||this.processor?.updating||this._fieldsHelper?.updating||this.layerFilterUpdating)}highlight(e,t){const r=K.getHighlightName(t),i=this.layer.objectIdField,s=j.normalizeHighlightTarget(e);if(0===s.length)return j.emptyHighlightHandle;if(R.isGraphic(s[0])){const e=s;if(null!=N.attributeLookup(this.layer.fieldsIndex,e[0].attributes,i)){const t=e.map(e=>N.attributeLookup(this.layer.fieldsIndex,e.attributes,i));return this.processor.highlightByObjectIds(t,i,r)}return this.processor.highlightByGraphics(e,r)}return j.isObjectId(s[0])?this.processor.highlightByObjectIds(s,i,r):j.emptyHighlightHandle}get updatePolicy(){return this.processor.graphicsCore.effectiveUpdatePolicy}createInteractiveEditSession(e){return E.createInteractiveEditSession(this._attributeEditingContext,e)}async _decompressBinaryPointData(e,t){const r={geometryBuffer:e.geometryBuffer};null==this._workerHandle&&(this._workerHandle=new O.I3SPointsWorkerHandle(e=>this.view.resourceController.immediate.schedule(e)));const i=await this._workerHandle.invoke(r,t);if(null==i)throw new Error("Failed to decompress Draco point data");return{positionData:i.positions,featureIds:i.featureIds}}async addNode(e,t,r){if(!oe(t)&&!function(e){return"pointData"in e}(t))throw new Error;if(this.loadedGraphics.hasNode(e.index))return void i.getLogger(this).error("I3S node "+e.id+" already added");const s=null!=this.layer.fullExtent?(c=.5,(l=this.layer.fullExtent.clone()).xmin-=c,l.ymin-=c,l.xmax+=c,l.ymax+=c,null!=l.zmin&&null!=l.zmax&&(l.zmin-=c,l.zmax+=c),null!=l.mmin&&null!=l.mmax&&(l.mmin-=c,l.mmax+=c),l):null,{featureIds:n,pointPositions:o}=oe(t)?await this._extractBinaryPointPositions(e,t,r):this._extractLegacyPointPositions(t),a=new Array;var l,c;this._validatePositions(e,n,o,s,a);const u=this._controller.crsVertex,d=this.view.spatialReference;f.projectBuffer(o,u,0,o,d,0,n.length);const h=oe(t)?e.level:0,p=this._createGraphics(n,o,e.index,h),m=new ie(p,n,t.attributeDataInfo,e);if(await this._i3sOverrides.applyAttributeOverrides(m.featureIds,t.attributeDataInfo,r),e.numFeatures=m.graphics.length,this._updateNodeMemory(e),ae(m),a.length>0&&(this._computeObb(e,a,u),this._controller.updateVisibility(e.index)),!this._controller.isGeometryVisible(e))return void this._cacheNodeData(m);if(null!=this._verticalScale)for(const e of m.graphics)this._verticalScale(e.geometry);const g=this.view.stage.renderView.olidRenderHelper;if(g){const e=M.isBasemapLayerView(this.view,this.uid);for(let t=0;t<m.featureIds.length;t++){const r=m.featureIds[t];g.setUidToObjectAndLayerId(r,m.graphics[t].uid,this.layer.id,this.uid,this.layer.popupEnabled&&!e&&J.hasPopupTemplate(this.layer,this.view.popup?.defaultPopupTemplateEnabled),m.node.resources.attributes,t)}}this.loadedGraphics.addNode(e.index,m),this._controller.updateLoadStatus(e.index,!0),this._filterNode(m),this._treeDebugger&&this._treeDebugger.update()}_computeObb(e,t,r){const i=this._controller.crsIndex,s=i.isGeographic?this.view.renderSpatialReference:i;f.projectBuffer(t,r,0,t,s,0),e.serviceObbInIndexSR=Q.compute(new Y.Vertices(t,3)),i.isGeographic&&(m.projectVectorToVector(e.serviceObbInIndexSR.center,s,ce,i),e.serviceObbInIndexSR.center=ce)}isNodeLoaded(e){return this.loadedGraphics.hasNode(e)}isNodeReloading(){return!1}updateNodeState(){}getNodeComponentHandle(){}async _extractBinaryPointPositions(e,t,r){const i=await this._decompressBinaryPointData(t,r),s=i.positionData,n=s.length/3,o=y.newDoubleArray(3*n),a=null!=e.serviceObbInIndexSR?e.serviceObbInIndexSR.center:p.ZEROS,l=Math.abs(a[2])*2**-20;for(let e=0;e<n;e++){const t=3*e;o[t]=s[t]+a[0],o[t+1]=s[t+1]+a[1],o[t+2]=s[t+2]+a[2],Math.abs(o[t+2])<l&&(o[t+2]=0)}return{featureIds:i.featureIds?y.doubleArrayFrom(i.featureIds):[],pointPositions:o}}_extractLegacyPointPositions(e){const t=e.pointData.length,r=y.newDoubleArray(3*t),i=new Array;for(let s=0;s<t;s++){const t=e.pointData[s],n=t.featureDataPosition,o=n.length,a=t.geometries?.[0]??le[o],l=t.featureIds[0];if("Embedded"!==a.type||"points"!==a.params.type||o<2||o>3)continue;const c=a.params.vertexAttributes?.position??[0,0,0],u=3*i.length;r[u]=n[0]+c[0],r[u+1]=n[1]+c[1],r[u+2]=3===o?n[2]+c[2]:NaN,i.push(l)}return{featureIds:i,pointPositions:r}}_validatePositions(e,t,r,s,n){if(null==s&&e.serviceObbInIndexSR)return;const o=t.length;for(let t=0;t<o;t++){const o=3*t;h.set(ce,r[o],r[o+1],r[o+2]);const a=!Number.isNaN(r[2]);null==s||(a?g.extentContainsCoords3D(s,ce):g.extentContainsCoords2D(s,ce))||(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&i.getLogger(this).error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&i.getLogger(this).error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++),e.serviceObbInIndexSR||n.push(ce[0],ce[1],ce[2])}}_createGraphics(e,t,r,i){const s=e.length,n=this._getObjectIdField(),o=this.processor.graphicsCore,a=new Array,c=this.view.spatialReference;for(let u=0;u<s;u++){const s=e[u],d={};null!=s&&(d[n]=s);const h=s??l.generateUID(),p=3*u,f=isNaN(t[p+2])?void 0:t[p+2],m=new x.ImmutableDehydratedPoint(c,t[p],t[p+1],f),g=this.loadedGraphics.get(h);if(null!=g)(null==g.level||g.level<i)&&(ue.property="geometry",ue.graphic=g,ue.oldValue=g.geometry,ue.newValue=m,g.geometry=m,g.level=i,o.graphicUpdateHandler(ue),de()),a.push(g);else{const e=l.generateUID();a.push({objectId:h,uid:e,geometry:m,attributes:d,visible:!0,nodeIndex:r,level:i})}}return a}_updateNodeMemory(e){e.memory=4096+(e.numFeatures??0)*this.processor.graphicsCore.usedMemoryPerGraphic}_cacheNodeData(e){this._memCache.put(this._getMemCacheKey(e.node),e)}_getMemCacheKey(e){return`${e.index}`}_removeAllNodeData(){this.loadedGraphics.forEachNode((e,t)=>{if(e){const t=e.node;this._updateNodeMemory(t),this._cacheNodeData(e)}this._controller.updateLoadStatus(t,!1)}),this._treeDebugger&&this._treeDebugger.update(),this.loadedGraphics.clear()}removeNode(e){const t=this._removeNodeStageData(e);t&&(this._updateNodeMemory(t.node),this._cacheNodeData(t))}_removeNodeStageData(e){const t=this.loadedGraphics.getNode(e);return null==t?null:(this._controller.updateLoadStatus(e,!1),this.loadedGraphics.removeNode(e),this._treeDebugger&&this._treeDebugger.update(),t)}async loadCachedNodeData(e){return this._memCache?.pop(this._getMemCacheKey(e))}async addCachedNodeData(e,t,r,s){this.loadedGraphics.hasNode(e.index)?i.getLogger(this).error("I3S node "+e.id+" already added"):(await this._i3sOverrides.applyAttributeOverrides(t.featureIds,r,s),t.attributeInfo=r,this.loadedGraphics.addNode(e.index,t),this._controller.updateLoadStatus(e.index,!0),this._updateNodeMemory(e),ae(t),this._filterNode(t),this._treeDebugger&&this._treeDebugger.update())}getLoadedNodeIds(){const e=[];return this.loadedGraphics.forEachNode(t=>e.push(t.node.id)),e.sort()}getVisibleNodes(){const e=new Array;return this.loadedGraphics.forEachNode(t=>e.push(t.node)),e}getLoadedNodeIndices(e){this.loadedGraphics.forEachNode((t,r)=>e.push(r))}getLoadedAttributes(e){const t=this.loadedGraphics.getNode(e);if(null!=t?.attributeInfo)return t.attributeInfo.loadedAttributes}getAttributeData(e){const t=this.loadedGraphics.getNode(e);if(null!=t?.attributeInfo)return t.attributeInfo.attributeData}_setAttributeData(e,t){const r=this.loadedGraphics.getNode(e);null!=r?.attributeInfo&&(r.attributeInfo.attributeData=t,this._attributeValuesChanged(r))}async updateAttributes(e,t,r){const i=this.loadedGraphics.getNode(e);null!=i&&(await this._i3sOverrides.applyAttributeOverrides(i.featureIds,t,r),i.attributeInfo=t,this._attributeValuesChanged(i))}_attributeValuesChanged(e){ae(e),this._filterNode(e);const{processor:t}=this,{graphicsCore:r}=t;if(r.labelsEnabled){const t=e.node.index,i=new Array;e.graphics.forEach(e=>e.nodeIndex===t&&i.push(e.uid)),r.updateLabelingInfo(i)}t.refreshFilter()}_updateClippingExtent(e){return this._controller&&this._controller.updateClippingArea(e),!1}_getObjectIdField(){return this.layer.objectIdField||v.fallbackObjectIDAttribute}_getGlobalIdField(){return this.layer.globalIdField}async _rendererChange(e,t){const{layer:{fieldsIndex:r}}=this,i=new Set;let s,n;e?(await e.collectRequiredFields(i,r),s=Array.from(i).sort()):s=[],i.clear(),t?(await t.collectRequiredFields(i,r),n=Array.from(i).sort()):n=[],s.length===n.length&&s.every((e,t)=>s[t]===n[t])||this._reloadAllNodes()}_rangeInfosChanged(e){null!=e&&e.length>0&&i.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}_filterChange(){this.loadedGraphics.forEachNode(e=>this._filterNode(e))}_reloadAllNodes(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()}_filterNode(e){const t=this.parsedDefinitionExpression,r=this._excludeObjectIds,i=this._getObjectIdField();for(const s of e.graphics){const e=s.visible,n=this._evaluateClause(t,s),o=!r.has(s.attributes[i]);s.visible=n&&o,e!==s.visible&&(ue.graphic=s,ue.property="visible",ue.oldValue=e,ue.newValue=s.visible,this.processor.graphicsCore.graphicUpdateHandler(ue),de())}}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return this.filter?.createQuery(e)??new P(e)}queryFeatures(e,t){return this._queryEngine.executeQuery(this._ensureQuery(e),t?.signal)}queryObjectIds(e,t){return this._queryEngine.executeQueryForIds(this._ensureQuery(e),t?.signal)}queryFeatureCount(e,t){return this._queryEngine.executeQueryForCount(this._ensureQuery(e),t?.signal)}queryExtent(e,t){return this._queryEngine.executeQueryForExtent(this._ensureQuery(e),t?.signal)}_ensureQuery(e){return this._addDefinitionExpressionToQuery(null==e?this.createQuery():P.from(e))}_setupQueryEngine(){const{layer:e,view:t,hasM:r,hasZ:i}=this,{spatialReference:s,resourceController:n}=t,o=new D.QueryEngineContext(s,e,n,()=>this.processor.featureStore,i,r);this._queryEngine=new A.QueryEngine({context:o,priority:te.TaskPriority.FEATURE_QUERY_ENGINE})}get usedMemory(){return this.processor?.graphicsCore?.usedMemory??0}get unloadedMemory(){return.8*((this._controller?.unloadedMemoryEstimate??0)+(this.processor?.graphicsCore?.unprocessedMemoryEstimate??0))}get ignoresMemoryFactor(){return this._controller&&this._controller.fixedFeatureTarget}async _handleEdits(e){const t=this._attributeEditingContext,r=await E.normalizeEditResultsEvent(t,e);E.processAttributeEdits(t,r)}get _attributeEditingContext(){const e=this._getObjectIdField(),t=this._getGlobalIdField();return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:e,globalIdField:t,forEachNode:e=>this.loadedGraphics.forEachNode(t=>e(t.node,t.featureIds)),attributeStorageInfo:this.i3slayer.attributeStorageInfo??[],i3sOverrides:this._i3sOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(t,r,i)=>{this._setAttributeData(t,r);const s=this.loadedGraphics.getNode(t);if(null!=i){const t=this.loadedGraphics.get(i.attributes[e]);null!=t&&this.processor.graphicsCore.recreateGraphics([t])}else null!=s&&this.processor.graphicsCore.recreateGraphics(s.graphics)},clearMemCache:()=>{}}}get performanceInfo(){return new G.LayerViewPerformanceInfo(this.usedMemory,this.loadedGraphics.length,-1,this.maximumNumberOfFeatures,this.loadedGraphics.nodeCount,this.processor.graphicsCore.performanceInfo)}get test(){}};t.__decorate([c.property()],se.prototype,"processor",void 0),t.__decorate([c.property({type:C})],se.prototype,"filter",void 0),t.__decorate([c.property()],se.prototype,"loadedGraphics",void 0),t.__decorate([c.property()],se.prototype,"i3slayer",null),t.__decorate([c.property()],se.prototype,"layerViewUid",null),t.__decorate([c.property()],se.prototype,"_controller",void 0),t.__decorate([c.property()],se.prototype,"updating",void 0),t.__decorate([c.property()],se.prototype,"suspended",void 0),t.__decorate([c.property(Z.updatingProgress)],se.prototype,"updatingProgress",void 0),t.__decorate([c.property()],se.prototype,"updatingProgressValue",null),t.__decorate([c.property({readOnly:!0})],se.prototype,"visibleAtCurrentScale",null),t.__decorate([c.property(re.requiredFields)],se.prototype,"requiredFields",null),t.__decorate([c.property(re.availableFields)],se.prototype,"availableFields",void 0),t.__decorate([c.property()],se.prototype,"_fieldsHelper",void 0),t.__decorate([c.property({type:Number})],se.prototype,"maximumNumberOfFeatures",null),t.__decorate([c.property({readOnly:!0})],se.prototype,"maximumNumberOfFeaturesExceeded",null),t.__decorate([c.property()],se.prototype,"_excludeObjectIds",null),t.__decorate([c.property({readOnly:!0})],se.prototype,"lodFactor",null),t.__decorate([c.property({readOnly:!0})],se.prototype,"hasM",null),t.__decorate([c.property({readOnly:!0})],se.prototype,"hasZ",null),t.__decorate([c.property()],se.prototype,"contentVisible",null),t.__decorate([c.property({readOnly:!0})],se.prototype,"legendEnabled",null),t.__decorate([c.property()],se.prototype,"_graphicOrigin",null),se=t.__decorate([d.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],se);const ne=se;function oe(e){return"geometryBuffer"in e&&null!==e.geometryBuffer}function ae(e){const t=e.attributeInfo;if(null==t?.loadedAttributes||null==t.attributeData)return;const r=e.node.index;for(let i=0;i<e.graphics.length;i++){const s=e.graphics[i];if(s.nodeIndex===r){s.attributes||(s.attributes={});for(const{name:e}of t.loadedAttributes)t.attributeData[e]&&(s.attributes[e]=L.getCachedAttributeValue(t.attributeData[e],i))}}}const le={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},ce=p.create(),ue={graphic:null,property:null,oldValue:null,newValue:null};function de(){ue.graphic=null,ue.property=null,ue.oldValue=null,ue.newValue=null}return ne})},"esri/views/3d/layers/I3SPointsWorkerHandle":function(){define(["exports","../../../core/workers/WorkerHandle"],function(e,t){"use strict";class r extends t.WorkerHandle{constructor(e){super("SceneLayerWorker","dracoDecompressPointCloudData",{dracoDecompressPointCloudData:e=>[e.geometryBuffer]},e,{hasInitialize:!0})}}e.I3SPointsWorkerHandle=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/3d/layers/i3s/I3SGraphicsMap":function(){define(["exports","../../../../core/Evented","../../../../core/has","../../../../core/MapUtils"],function(e,t,r,i){"use strict";class s extends t.Evented{constructor(e,t){super(),this._updateAndCompare=e,this._notifyUpdated=t,this._nodes=new Map,this._graphics=new Map,this._duplicates=new Map}clear(){if(this._graphics.size>0){const e=this.toArray();this._graphics.clear(),this.emit("change",{added:[],removed:e})}this._nodes.clear()}get length(){return this._graphics.size}get(e){return this._graphics.get(e)}getNode(e){return this._nodes.get(e)}hasNode(e){return this._nodes.has(e)}nodes(){return this._nodes.values()}addNode(e,t){this._nodes.set(e,t);const r=t.graphics;if(0===r.length)return;const i=new Set;for(let t=0;t<r.length;t++){const s=r[t],n=s.objectId,o=this._graphics.get(n);if(o){i.add(n),s!==o&&(r[t]=o);const a=this._duplicates.get(n);a?a.push(e):this._duplicates.set(n,[o.nodeIndex,e])}else s.nodeIndex=e,this._graphics.set(n,s)}i.size&&this._updateForeignGraphics(t);const s=i.size>0?r.filter(e=>!i.has(e.objectId)):r;s.length>0&&this.emit("change",{added:s,removed:[]})}removeNode(e){const t=this._nodes.get(e);if(!t)return;this._nodes.delete(e);const r=new Set,i=[];for(const s of t.graphics){const t=s.objectId,n=this._graphics.get(t);if(!n)continue;const o=this._duplicates.get(t);if(o){const i=o.indexOf(e);if(-1===i)continue;if(o.splice(i,1),n.nodeIndex===e){let e=this.getNode(o[0]);for(let t=1;t<o.length;t++){const r=this.getNode(o[t]);(null==e||null!=r&&r.node.level>e.node.level)&&(e=r)}null!=e&&r.add(e)}1===o.length&&this._duplicates.delete(t)}else this._graphics.delete(t),i.push(s)}i.length>0&&this.emit("change",{added:[],removed:i}),r.forEach(e=>this._updateForeignGraphics(e))}_updateForeignGraphics(e){const t=[],r=e.node.index,i=e.node.level;let s=0;for(;s<e.graphics.length;){const n=e.graphics[s].nodeIndex;if(n===r){s++;continue}let o=1;for(;s+o<e.graphics.length&&e.graphics[s+o].nodeIndex===n;)o++;const a=this.getNode(n);if(null!=a&&a.node.level>i)s+=o;else{for(let i=s;i<s+o;i++){const s=e.graphics[i];s.nodeIndex=r,this._updateAndCompare(s,e,i)&&t.push(s)}s+=o}}t.length>0&&this._notifyUpdated(t)}toArray(){return Array.from(this._graphics.values())}find(e){return i.findInMap(this._graphics,e)}some(e){return i.someMap(this._graphics,e)}forEach(e){this._graphics.forEach(t=>e(t))}forEachNode(e){this._nodes.forEach((t,r)=>e(t,r))}get nodeCount(){return this._nodes.size}_checkInvariants(){const e=new Map;this._nodes.forEach((t,r)=>{t.graphics.forEach(t=>{e.set(t.objectId,1+(e.get(t.objectId)??0)),this._duplicates.get(t.objectId)})}),e.forEach((e,t)=>{const r=this._graphics.get(t);if(!r)return;if(!this._nodes.get(r.nodeIndex))return;const i=this._duplicates.get(t);i&&i.forEach(e=>{this._nodes.get(e)})})}}e.I3SGraphicsMap=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"*noref":1}}),define(["require","../chunks/tslib.es6","../Camera","../Viewpoint","../core/Collection","../core/domUtils","../core/Error","../core/events","../core/handleUtils","../core/has","../core/Logger","../core/maybe","../core/promiseUtils","../core/ReactiveSet","../core/reactiveUtils","../core/scheduling","../core/screenUtils","../core/sql","../core/unitUtils","../core/workers/workers","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/RandomLCG","../core/accessorSupport/decorators/subclass","../core/accessorSupport/ensureType","../core/accessorSupport/overrideDefaultsFrom","../core/accessorSupport/trackingUtils","../core/libs/gl-matrix-2/factories/vec3f64","../core/libs/rbush/PooledRBush","../core/support/OwningCollection","../geometry/Extent","../geometry/HeightModelInfo","../geometry/Point","../geometry/projectionUtils","../geometry/SpatialReference","../geometry/spatialReferenceEllipsoidUtils","../geometry/projection/projectBoundingRect","../geometry/projection/projectPointToVector","../geometry/support/aaBoundingRect","../geometry/support/coordinateSystem","../geometry/support/scaleUtils","../layers/support/layerUtils","../layers/support/TilemapCache","../portal/portalDefault","../support/AnalysesCollection","../support/tagSymbols","./BreakpointsOwner","./DOMContainer","./GroundView","./PopupView","./View","./ViewAnimation","./ViewingMode","./3d/layerViewModuleImportUtils","./3d/analysis/AnalysisViewManager3D","./3d/camera/intersectionUtils","./3d/constraints/Constraints","./3d/environment/EnvironmentManager","./3d/environment/SceneViewEnvironment","./3d/input/SceneInputManager","./3d/layers/graphics/GraphicsDeconflictor","./3d/layers/graphics/Labeler","./3d/layers/i3s/I3SLodHandling","./3d/layers/support/StageLayerElevationProvider","./3d/state/ViewState","./3d/state/ViewStateManager","./3d/state/controllers/PointToPointAnimationController","./3d/state/helpers/SceneIntersectionHelper","./3d/state/utils/navigationUtils","./3d/support/CombinedElevationProvider","./3d/support/debugFlags","./3d/support/DisplayQualityProfile","./3d/support/ElevationProvider","./3d/support/hitTest","./3d/support/popupHitTest","./3d/support/QualitySettings","./3d/support/RenderCoordsHelper","./3d/support/ResourceController","./3d/support/SceneViewPerformanceInfo","./3d/support/SharedSymbolResources","./3d/support/ViewSlice","./3d/support/pointsOfInterest/PointsOfInterest","./3d/terrain/TerrainSurface","./3d/terrain/terrainUtils","./3d/terrain/TilePerLayerInfo","./3d/terrain/TileRenderer","./3d/webgl-engine/Stage","./3d/webgl-engine/effects/geometry/olidUtils","./3d/webgl-engine/effects/geometry/RenderOccludedRenderNode","./3d/webgl-engine/lib/Intersector","./3d/webgl-engine/lib/ShadowMap","./3d/webgl-engine/lib/verticalOffsetUtils","./3d/webgl-engine/lib/edgeRendering/edgePreprocessing","./support/drapedUtils","./support/HighlightDefaults","./support/HighlightOptions","./support/layerViewUtils","./support/screenUtils","./support/spatialReferenceSupport","./support/TextureCompressionHelper","./support/WebGLRequirements","./ui/DefaultUI","./ui/3d/DefaultUI3D","../webscene/Environment","../widgets/support/vnodeCache"],function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,f,m,g,y,_,b,v,w,x,S,T,C,P,M,R,O,I,F,A,D,E,L,V,U,B,N,k,z,j,G,q,H,W,$,Q,Z,Y,X,J,K,ee,te,re,ie,se,ne,oe,ae,le,ce,ue,de,he,pe,fe,me,ge,ye,_e,be,ve,we,xe,Se,Te,Ce,Pe,Me,Re,Oe,Ie,Fe,Ae,De,Ee,Le,Ve,Ue,Be,Ne,ke,ze,je,Ge,qe,He,We,$e,Qe,Ze,Ye){"use strict";const Xe=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),Je=Symbol(),Ke=Symbol();let et=class extends(W.BreakpointsOwner(Z.PopupView($.DOMContainer(Y)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._resolveWhenReady=[],this._resourceController=Se.newResourceController(this),this.deconflictor=new oe.GraphicsDeconflictor({view:this}),this.labeler=new ae.Labeler({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new q.AnalysesCollection,this.basemapTerrain=null,this.elevationProvider=null,this._canvas=null,this.constraints=new re.Constraints,this.environment=new se,this.environmentManager=new ie.EnvironmentManager,this.floors=new s,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new ee({view:this}),this.groundView=null,this.map=null,this._featureTileTreeClients=new p,this._featureTiles=null,this._featureTreeDebugger=null,this.screenSizePerspectiveEnabled=!0,this.state=new ue({view:this}),this.slice=new Pe.ViewSlice,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new Qe,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this._importControllers=new Map,b.initialize();const t=(e=null)=>{null!=e&&4===e.type||(this._updatingChanged(),this.map?.allLayers.forEach(async e=>{try{await e.when()}catch(e){}this._updatingChanged()}))};this.addHandles([f.on(()=>this.map?.allLayers,"after-changes",e=>t(e),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",e=>this._updateUpdatingMonitors(e)),f.watch(()=>this.scene,e=>e?.load().catch(()=>{}))]),this.inputManager=new ne({view:this}),this.stateManager=new de.ViewStateManager({view:this})}initialize(){if(c("enable-feature:esri-compress-textures")&&c("wasm-simd")){const e=He.initializeTextureCompressionWorker(this,this.resourceController);this.addResolvingPromise(e.promise)}this.groundView=new Q({view:this}),this._updateUpdatingMonitors(),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},f.initial),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},f.initial),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>m.setFrameDuration(e>0?1e3/Math.ceil(e):0),f.initial),this.addHandles([f.watch(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),f.sync),f.watch(()=>({plane:this.slice.plane,isDecoration:this.slice.isDecoration}),()=>this._updateSlice(),f.sync)])}destroy(){this.destroyed||(He.destroyTextureCompressionWorker(this),this.updatingHandles.removeAll(),this.basemapTerrain?.clearHandles(),this.ui.removeAllHandles(),this.layerViewManager.clearHandles(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._set("analysisViewManager",d.destroyMaybe(this.analysisViewManager)),this._exitSurface(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this.sharedSymbolResources=d.destroyMaybe(this.sharedSymbolResources),this._set("labeler",d.destroyMaybe(this.labeler)),this._set("deconflictor",d.destroyMaybe(this.deconflictor)),this._resourceController=d.destroyMaybe(this._resourceController),this._set("stateManager",d.destroyMaybe(this.stateManager)),this._set("inputManager",d.destroyMaybe(this.inputManager)),this.state.destroy(),this.highlights.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",d.destroyMaybe(this.environmentManager)),this._set("environment",d.destroyMaybe(this.environment)),this.groundView=d.destroyMaybe(this.groundView),this.slice.destroy(),this._updatingObjectsWithProgress.length=0,this._updatingObjects.length=0,this.ui?.destroy(),this._set("ui",null),this._set("renderCanvas",null),this._set("canvas",null),this._canvas=null)}get stage(){return this._stage}get renderSpatialReference(){return this.renderCoordsHelper?.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get canvas(){return this._canvas}get center(){return this.stateManager?.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if("global"===this.viewingMode)return null;const e=this.map;let t=this._userClippingArea||d.maybeProperty(e,"clippingArea");return!this._userClippingArea&&!d.maybeProperty(e,"clippingEnabled")||null==t?(this._clippingArea=null,null):t instanceof I?this.spatialReference&&(t=tt(t,this.spatialReference),null==t)?(u.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),null==t.intersection(this._groundAndLayersExtent)&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(u.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&null!=e?u.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(1===this.state.viewingMode)return null;const e=this.renderSpatialReference,t=this.dataExtent;return null==t||null==e||t.spatialReference.equals(e)?t:tt(t,e)}get tileInfo(){return this.basemapTerrain?.tilingScheme?.toTileInfo()}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||E.WGS84,r=tt(this.clippingArea,t);null!=r&&(e=null!=e?e.intersection(r):r);const i=this._get("dataExtent");return null!=e&&e.equals(i)?i:e}get _groundAndLayersExtent(){const e=this.spatialReference||E.WGS84;let t;const r=r=>{const i=tt(r,e);null!=i&&(null!=t?t.union(i):t=i.clone())},{basemapTerrain:i}=this;if(i?.spatialReference){const e=i.groundExtent;r(new I({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:i.spatialReference}))}if(this.map?.allLayers.forEach(e=>(e=>{null==e.fullExtent||"graphics"===e.type&&e.internal||r(e.fullExtent)})(e)),null==t)return null;t.hasZ?(t.zmin=Math.min(0,t.zmin??0),t.zmax=Math.max(0,t.zmax??0)):(t.zmin=0,t.zmax=0);const s=this._get("_groundAndLayersExtent");return t.equals(s)?s:t}castEnvironment(e){return e?e instanceof se?e:e instanceof Ze?this.environment?.cloneWithWebsceneEnvironment(e)??se.fromWebsceneEnvironment(e):T.ensureType(se,e):new se}get extent(){return this.stateManager?.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state?.stationary??!0)}get navigating(){return this.state?.navigating??!1}get scene(){return this.map&&H.WebSceneTag in this.map?this.map:null}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}get featureTiles(){return this._featureTiles}set qualityProfile(e){ye.isValidProfile(e)&&(ye.apply(e,this.qualitySettings),this.stage?.renderView.updateQualitySettings(this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||ye.getDefaultProfile()}_updateSlice(){null!=this.stage&&(this.stage.renderer.slice=this.slice)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&!!this.stateManager?.preinit(this.spatialReference)}get resolution(){return null!=this.spatialReference?k.getResolutionForScale(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?F.deriveUnitFromSR(e,this.spatialReference):null}get updating(){if(this.destroying||this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,r=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(i=>{if(i.isFulfilled()){if(i.updating){if(t=!0,i.suspended||Oe.isSurfaceLayerView(i))return;++r,e+=i.updatingProgress}}else++r});for(const t of this._updatingObjects)if(null!=t&&t.updating){const t=.1;r+=t,e+=.5*t}for(const t of this._updatingObjectsWithProgress)null!=t&&t.updating&&(++r,e+=t.updatingProgress);const i=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(t=!!(t||r>0||this.updatingHandles.updating||!this.ready||!this.stationary||i||this._importControllers.size>0||this.inputManager?.updating||this.map?.allLayers?.some(e=>!e.isFulfilled())),t?(this._numUpdating=Math.max(r,this._numUpdating),e+=this._numUpdating-r):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const r=performance.now();if(e<1){const t=Math.min((r-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-t)+e*t}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?r:0}return t}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this.stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){const e=this._predeterminedViewingMode;if(null!=e)return J.stringFromViewingMode(e);const t=this.spatialReference;return t?null!=this.defaultsFromMap?.viewingMode&&t.equals(this.defaultsFromMap.spatialReference)?J.stringFromViewingMode(this.defaultsFromMap.viewingMode):qe.isSpatialReferenceSupported(t,1)?"global":"local":"global"}set viewingMode(e){this.ready?u.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get visibleArea(){return this.stateManager?.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get highlightOptions(){return this.highlights.find(({name:e})=>e===ke.defaultHighlightName)??new ze}set highlightOptions(e){for(let t=0;t<this.highlights.length;++t)if(this.highlights.at(t).name===ke.defaultHighlightName)return void this.highlights.items[t].assignFrom(e)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new Te(this)}on(e,t,r,i){return this.viewEvents.on(e,t,r,i)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return u.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const r=Ge.isSupportedScreenPointEvent(e)?Ge.createScreenPointFromSupportedEvent(this,e):e;return be.toMap(this,r,t,this._defaultToMapOptions)}toScreen(e){if(!this.ready)return u.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=(null==e.z?_e.getElevationAtPoint(this.elevationProvider,e):null)??0;return U.projectPointToVector(e,rt,this.renderSpatialReference,t),this.state.camera.projectToScreen(rt,it),g.createScreenPoint(it[0],it[1])}pixelSizeAt(e,t){if(!this.ready)return u.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!e)return 0;const r=this.renderSpatialReference;U.projectPointToVector(e,rt,r);const i=this.state.camera.computeScreenPixelSizeAt(rt);return t&&r!==t?i*_.getMetersPerUnitForSR(r)/_.getMetersPerUnitForSR(t):i}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e,()=>this.pixelSizeAt(e)):1}hitTest(e,t){if(!this.ready)return u.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const r=Ge.isSupportedScreenPointEvent(e)?Ge.createScreenPointFromSupportedEvent(this,e):e;return be.hitTest(this,r,t,this._defaultHitTestOptions)}async popupHitTest(e){return ve.popupHitTest(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(null==e.parent)throw new o("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(t){const r=await this._completeSettings(t);await this.whenReady();const i=(await this.stage.renderView.takeScreenshot(r))[0];return(await new Promise((t,r)=>e(["./support/screenshotUtils"],t,r))).encode(i,r,this._pixelFormat())}async _takeScreenshot(t){const r=await this._completeSettings(t);await this.whenReady();const i=(await this.stage.renderView.takeScreenshot(r))[0];return(await new Promise((t,r)=>e(["./support/screenshotUtils"],t,r))).encodeData(i,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(t){const r=await this._completeSettings(t);r.olidColor=!0,await this.whenReady();const i=await this.stage.renderView.takeScreenshot(r),{encodeData:s}=await new Promise((t,r)=>e(["./support/screenshotUtils"],t,r));return[s(i[0],this._pixelFormat()),s(i[1],this._pixelFormat())]}async _completeSettings(t){const{toRenderSettings:r,screenshotSuperSampleSettings:i}=await new Promise((t,r)=>e(["./support/screenshotUtils"],t,r)),s=r(t,this);return s.pixelRatio/=this.state.pixelRatio,i(s,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this.stage?.renderView.getAlpha()??!1}}get test(){}async takeScreenshotWithObjectAndLayerId(t){if(!De.olidEnabled())throw new o("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");const{encode:r}=await new Promise((t,r)=>e(["./support/screenshotUtils"],t,r)),i=await this._completeSettings(t);i.olidColor=!0,await this.whenReady();const s=await this.stage.renderView.takeScreenshot(i),n=r(s[0],i,this._pixelFormat()),a=await this._completeSettings(t);return a.format="png",[n,r(s[1],a,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){const e=this.stage.renderView.olidRenderHelper;if(e)return e.getColorToObjectAndLayerIdMapping();throw new o("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return K.layerView3DImporter.importLayerView(e)}hasLayerViewModule(e){return K.layerView3DImporter.hasLayerViewModule(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.scene?.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let e=We.check(this.type);const t=c("safari");if(t&&t<9&&(e=new o("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),null!=e)throw u.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){const e=this._isOverridden("viewingMode")?this._get("viewingMode"):this.scene?.initialViewProperties?.viewingMode;return null!=e?J.viewingModeFromString(e):null}getSpatialReferenceSupport(e,t){const r=this._predeterminedViewingMode;if(null!=r)return this._validateSpatialReferenceForViewingMode(e,t,r)?{constraints:this._makeSpatialReferenceConstraints(e,t,r)}:null;const i=this._validateSpatialReferenceForViewingMode(e,t,2),s=this._validateSpatialReferenceForViewingMode(e,t,1);return i||s?i&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:i?{constraints:this._makeSpatialReferenceConstraints(e,t,2)}:{constraints:this._makeSpatialReferenceConstraints(e,t,1)}:null}_validateSpatialReferenceForViewingMode(e,t,r){return!(!qe.isSpatialReferenceSupported(e,r)||null!=t&&!z.isImageryTileLayer(t)&&(z.isTiledLayer(t)&&null==Oe.getTiledLayerInfo(t,e,r)||z.isVoxelLayer(t)&&1===r))}_makeSpatialReferenceConstraints(e,t,r){if(null==t)return[{spatialReference:e,viewingMode:r}];const{isWebMercator:i,isWGS84:s}=e;return z.isImageryTileLayer(t)&&(i||s)?s&&2!==r&&null!==Oe.checkIfTileInfoSupportedForView(t.tileInfo,t.fullExtent,e,1)?[{spatialReference:i?E.WGS84:E.WebMercator,viewingMode:r}]:[{spatialReference:e,viewingMode:r},{spatialReference:E.WebMercator,viewingMode:r}]:z.isTiledLayer(t)||z.isVoxelLayer(t)||!i&&!s?z.isTiledLayer(t)&&i&&1!==r?[{spatialReference:e,viewingMode:r},{spatialReference:E.WGS84,viewingMode:2}]:[{spatialReference:e,viewingMode:r}]:[{spatialReference:e,viewingMode:r},{spatialReference:i?E.WGS84:E.WebMercator,viewingMode:r}]}_validateSpatialReference(e){const t=null!=this.getSpatialReferenceSupport(e),r=this._predeterminedViewingMode;return t||(null!=r?u.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${J.stringFromViewingMode(r)} viewing mode.`):e.isGeographic&&u.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise(e=>{this.ready?e(this):this._resolveWhenReady.push(e)})}trackGraphicState(e){if(!e.graphic)return u.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let r=null,i=!1;const s=t=>{!i&&null!=t&&"processor"in t&&"graphics-3d"===t.processor?.type&&t.processor.graphicsCore&&(r=t.processor.graphicsCore.trackGraphicState(e))};return null!=t?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then(e=>s(e),()=>{}).catch(()=>{}),l.makeHandle(()=>{i=!0,null!=r&&(r.remove(),r=null)})}maskOccludee(e){if(!e)return u.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let r=null,i=!1;const s=t=>{!i&&null!=t&&je.occludeesSupported(t)&&(r=t.maskOccludee(e))};return null!=t?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then(e=>s(e),()=>{}).catch(()=>{}),l.makeHandle(()=>{i=!0,null!=r&&(r.remove(),r=null)})}getViewForGraphic(e){return e.layer===this?this.graphicsView:e.layer?this.allLayerViews.filter(e=>"media-3d"!==e.type).find(t=>t.layer===e.layer):null}graphicChanged(e){null!=this.graphicsView&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){return e.layer===this?(await f.whenOnce(()=>this.graphicsView),this.graphicsView):e.layer&&this.map?t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise((t,r)=>{const i=this.map.allLayers.on("change",s=>{s.added.includes(e.layer)&&(i.remove(),this.whenLayerView(e.layer).then(t,r))})}):this.whenLayerView(e.layer):null}enableFeatureTiles(){const e=Symbol();return this._featureTileTreeClients.add(e),l.makeHandle(()=>this._featureTileTreeClients.delete(e))}async _importModule(e,t){const r=new AbortController;this._importControllers.set(e,r),this._updatingChanged();try{const i=await nt[e]();if(t&&(h.throwIfDestroyed(this),h.throwIfAborted(r.signal),await t(r.signal)),this.destroyed)throw h.createAbortError();return h.throwIfAborted(r.signal),i}catch{return null}finally{this._importControllers.delete(e),this._updatingChanged()}}_abortImport(e){this._importControllers.get(e)?.abort(),this._importControllers.delete(e),this._updatingChanged()}_initBasemapTerrain(){this._set("basemapTerrain",new Re({view:this})),this._set("elevationProvider",new me.CombinedElevationProvider({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){const{basemapTerrain:e,elevationProvider:t}=this;e&&(this._set("basemapTerrain",null),this._set("elevationProvider",null),t.unregister(e),t.destroy(),e.destroy())}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Me.PointsOfInterest({view:this})),this.addHandles([this.updatingHandles.add(()=>ge.debugFlags.FEATURE_TILE_TREE_SHOW_TILES,t=>{t&&!this._featureTreeDebugger?this.updatingHandles.addPromise(new Promise((t,r)=>e(["./3d/layers/support/FeatureTileTree3DDebugger"],t,r))).then(({FeatureTileTree3DDebugger:e})=>{!this._featureTreeDebugger&&ge.debugFlags.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new e({view:this}))}):t||(this._featureTreeDebugger=d.destroyMaybe(this._featureTreeDebugger))},f.syncAndInitial),this.updatingHandles.add(()=>({basemapExtent:this.basemapTerrain?.extent,basemapSpatialReference:this.basemapTerrain?.spatialReference,clippingArea:this.clippingArea,featureTiles:this._featureTiles}),({basemapExtent:e,basemapSpatialReference:t,clippingArea:r,featureTiles:i})=>{if(!i)return;const s=!!e;if(r||s)if(s&&t){const s=e&&t?D.project(B.toExtent(e,t),this.spatialReference):null;i.filterExtent=r?r.intersection(s):s}else i.filterExtent=r;else i.filterExtent=null},f.syncAndInitial),this.updatingHandles.add(()=>this._featureTileTreeClients.size>0,e=>{e?this._ensureFeatureTileTree():this._featureTiles=d.destroyMaybe(this._featureTiles)},f.sync)],Je),this.stateManager.init()}async _ensureFeatureTileTree(){if(this._featureTiles||this._importControllers.has("FeatureTileTree3D"))return;const e=(await this.updatingHandles.addPromise(this._importModule("FeatureTileTree3D")))?.FeatureTileTree3D;e&&(this._featureTiles=new e({renderCoordsHelper:this.renderCoordsHelper,pointsOfInterest:this.pointsOfInterest,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}),this._updatingChanged())}_exitTerrain(){this.stateManager.exit(),this.removeHandles(Ke),this.removeHandles(Je),this._featureTiles=d.destroyMaybe(this.featureTiles),this._set("pointsOfInterest",d.destroyMaybe(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem()}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference,t=this.state.isGlobal,r=N.renderSRFromViewSR(t,e);r!==this.renderSpatialReference&&(this._set("renderCoordsHelper",xe.RenderCoordsHelper.create(this.state.viewingMode,r)),t||this.addHandles(f.watch(()=>this.basemapTerrain?.extent,e=>{const t=this.renderCoordsHelper.spatialReference;null==e||0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!V.projectBoundingRect(e,this.basemapTerrain.spatialReference,st,t)||(this.renderCoordsHelper.extent=st)},f.sync),Ke),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Le.defaultTolerance/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles(Ke),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){null!=e&&4===e.type||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.addHandles(f.watch(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),f.sync),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,r){if(!this.overlay||!this.overlay.hasVisibleItems)return r;const i=e.getContext("2d",{willReadFrequently:!0});return i.putImageData(r,0,0),this.overlay.renderCanvas(e,{disableDecorations:t}),i.getImageData(0,0,r.width,r.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(e,t,r)=>this._renderScreenshotOverlay(e,t,r)}},t=new pe.SceneIntersectionHelper(this.state.viewingMode,e=>this.stage.layers.forEach(e),this);this._set("sceneIntersectionHelper",t);const r=n.byId(this.surface);this._stage=new Ae.Stage({view:this,options:e,container:r}),this.notifyChange("stage"),this._updateSlice(),this.addHandles([this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,e=>this.stage.renderer.setParameters({highQualityTransparency:e}),f.initial),this.on("pointer-move",()=>this.stage?.renderer.resetAnimation()),a.on(this.stage.renderView.canvas,"webglcontextlost",e=>{this.fatalError=new o("webgl-context-lost",e.statusMessage)})],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Le.defaultTolerance/this.renderCoordsHelper.unitInMeters),this._set("canvas",this.stage.renderView.canvas)}_exitStage(){this.sceneIntersectionHelper?.destroy(),this._set("sceneIntersectionHelper",null),this._stage=d.destroyMaybe(this.stage),this._set("stage",null),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new Ce.SharedSymbolResources({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitTerrain(),this._exitStage())}async _ensureGraphicsView(){if(this.graphicsView||this._importControllers.has("GraphicsView3D")||0===this.graphics.length)return;this.removeHandles("GraphicsView3D");const e=(await this.updatingHandles.addPromise(this._importModule("GraphicsView3D",e=>f.whenOnce(()=>this.basemapTerrain?.ready,e))))?.default;e&&this._set("graphicsView",new e({view:this,getGraphics:()=>this.graphics})),this._updatingChanged()}_disposeGraphicsView(){this._abortImport("GraphicsView3D"),this.removeHandles("GraphicsView3D"),this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_disposeFocusAreasView(){this._abortImport("FocusAreasView"),this.removeHandles("FocusAreasView"),this.focusAreasView=d.destroyMaybe(this.focusAreasView)}async _ensureFocusAreasView(e){if(this.focusAreasView||this._importControllers.has("FocusAreasView")||0===e)return;this.removeHandles("FocusAreasView");const t=(await this.updatingHandles.addPromise(this._importModule("FocusAreasView")))?.FocusAreasView;t&&(this.focusAreasView=new t({view:this})),this._updatingChanged()}_startup(){const e=J.viewingModeFromString(this.viewingMode);1===e&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.addHandles(f.on(()=>this.graphics,"after-changes",()=>this._ensureGraphicsView()),"GraphicsView3D"),this._ensureGraphicsView(),this.addHandles(f.watch(()=>this.map?.focusAreas?.areas.length??0,e=>this._ensureFocusAreasView(e),{initial:!0}),"FocusAreasView");const t=this.scene?.initialViewProperties??null,r=t?.environment;r&&(this._overrideDefaultEnvironmentOnly?C.overrideDefaultsFrom(this.environment,r):this.environment=this.environment.cloneWithWebsceneEnvironment(r)),this.timeExtent=t?.timeExtent,t?.analyses.applyTo(this),this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const i=this._resolveWhenReady;this._resolveWhenReady=[],i.forEach(e=>e(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this._exitSurface(),this._set("ready",!1)}get _defaultToMapOptions(){const e={include:new Set};if(!this.map)return e;this.map.ground&&e.include.add(Ue.terrainId);for(const t of this.allLayerViews)z.isIntegratedMeshLayer(t.layer.type)&&e.include.add(t.uid);return e}get _defaultHitTestOptions(){const e={exclude:new Set};if(!this.map)return e;this.map.ground&&this.map.ground.opacity<1&&e.exclude.add(Ue.terrainId);for(const t of this.allLayerViews)z.isIntegratedMeshLayer(t.layer.type)&&t.layer.opacity<1&&e.exclude.add(t.uid);return e}static{this.type="3d"}static clearStatics(){Ye.clearVNodeCache(),P.drainNotificationQueue(),y.cleanupWhereClauseCache(),Be.cleanupEdgeProcessing(),de.cleanupViewStateManager(),te.cleanupIntersectionUtils(),ce.cleanupStageLayerElevationProvider(),L.cleanupSpatialReferenceEllipsoidUtils(),Ne.cleanupDrapedUtils(),G.clearDefaultPortalInstance(),Fe.cleanupTileRenderer(),Ve.cleanupShadowmap(),he.cleanupPointToPointAnimationController(),fe.cleanupNavigationUtils(),R.cleanupPooledRBush(),m.cleanupScheduling(),Ee.cleanupRenderOccluded(),Ie.clearTilePerLayerInfo(),le.cleanupI3SLodHandling(),j.TilemapCache.cleanupTilemapCache(),ue.cleanupViewstate(),Re.cleanupTerrainSurface()}};function tt(e,t){return null!=e&&D.canProjectWithoutEngine(e.spatialReference,t)?D.project(e,t):null}t.__decorate([v.property()],et.prototype,"_userClippingArea",void 0),t.__decorate([v.property()],et.prototype,"_resourceController",void 0),t.__decorate([v.property()],et.prototype,"stage",null),t.__decorate([v.property({readOnly:!0})],et.prototype,"deconflictor",void 0),t.__decorate([v.property({readOnly:!0})],et.prototype,"labeler",void 0),t.__decorate([v.property(O.owningCollectionProperty(q.AnalysesCollection,"analyses"))],et.prototype,"analyses",void 0),t.__decorate([v.property({type:X,readOnly:!0})],et.prototype,"animation",null),t.__decorate([v.property({readOnly:!0})],et.prototype,"basemapTerrain",void 0),t.__decorate([v.property({readOnly:!0})],et.prototype,"elevationProvider",void 0),t.__decorate([v.property()],et.prototype,"camera",null),t.__decorate([v.property({type:r})],et.prototype,"contentCamera",null),t.__decorate([v.property({readOnly:!0})],et.prototype,"canvas",null),t.__decorate([v.property({type:A})],et.prototype,"center",null),t.__decorate([v.property({type:I})],et.prototype,"clippingArea",null),t.__decorate([v.property({type:re.Constraints})],et.prototype,"constraints",void 0),t.__decorate([v.property({type:I,readOnly:!0})],et.prototype,"renderDataExtent",null),t.__decorate([v.property({readOnly:!0})],et.prototype,"tileInfo",null),t.__decorate([v.property({type:I,readOnly:!0})],et.prototype,"dataExtent",null),t.__decorate([v.property({type:I,readOnly:!0})],et.prototype,"_groundAndLayersExtent",null),t.__decorate([v.property({type:se})],et.prototype,"environment",void 0),t.__decorate([w.cast("environment")],et.prototype,"castEnvironment",null),t.__decorate([v.property({readOnly:!0})],et.prototype,"environmentManager",void 0),t.__decorate([v.property({type:I})],et.prototype,"extent",null),t.__decorate([v.property({type:s})],et.prototype,"floors",void 0),t.__decorate([v.property()],et.prototype,"screenCenter",null),t.__decorate([v.property()],et.prototype,"frustum",null),t.__decorate([v.property({type:Number,readOnly:!0})],et.prototype,"fullOpacity",void 0),t.__decorate([v.property({readOnly:!0})],et.prototype,"graphicsView",void 0),t.__decorate([v.property({})],et.prototype,"analysisViewManager",void 0),t.__decorate([v.property()],et.prototype,"groundView",void 0),t.__decorate([v.property({type:Boolean})],et.prototype,"initialExtentRequired",null),t.__decorate([v.property()],et.prototype,"defaultsFromMapSettings",null),t.__decorate([v.property()],et.prototype,"interacting",null),t.__decorate([v.property()],et.prototype,"stationary",null),t.__decorate([v.property()],et.prototype,"navigating",null),t.__decorate([v.property()],et.prototype,"map",void 0),t.__decorate([v.property()],et.prototype,"padding",null),t.__decorate([v.property({type:Me.PointsOfInterest,readOnly:!0})],et.prototype,"pointsOfInterest",void 0),t.__decorate([v.property()],et.prototype,"_featureTiles",void 0),t.__decorate([v.property()],et.prototype,"featureTiles",null),t.__decorate([v.property()],et.prototype,"_featureTreeDebugger",void 0),t.__decorate([v.property({type:Boolean})],et.prototype,"screenSizePerspectiveEnabled",void 0),t.__decorate([v.property({constructOnly:!0})],et.prototype,"deactivatedWebGLExtensions",void 0),t.__decorate([v.property({constructOnly:!0})],et.prototype,"debugWebGLExtensions",void 0),t.__decorate([v.property({constructOnly:!0})],et.prototype,"renderCanvas",void 0),t.__decorate([v.property({constructOnly:!0})],et.prototype,"state",void 0),t.__decorate([v.property({readOnly:!0})],et.prototype,"inputManager",void 0),t.__decorate([v.property({readOnly:!0})],et.prototype,"stateManager",void 0),t.__decorate([v.property({type:["low","medium","high"]})],et.prototype,"qualityProfile",null),t.__decorate([v.property({type:we,get(){let e=this._get("qualitySettings");return e||(e=new we,ye.apply(this.qualityProfile,e)),e}})],et.prototype,"qualitySettings",void 0),t.__decorate([v.property()],et.prototype,"slice",void 0),t.__decorate([v.property({readOnly:!0})],et.prototype,"typeSpecificPreconditionsReady",null),t.__decorate([v.property({readOnly:!0})],et.prototype,"renderCoordsHelper",void 0),t.__decorate([v.property({readOnly:!0})],et.prototype,"sceneIntersectionHelper",void 0),t.__decorate([v.property({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],et.prototype,"resolution",null),t.__decorate([v.property({type:Number})],et.prototype,"scale",null),t.__decorate([v.property()],et.prototype,"heightModelInfo",null),t.__decorate([v.property()],et.prototype,"spatialReference",void 0),t.__decorate([v.property({type:Boolean,constructOnly:!0})],et.prototype,"alphaCompositingEnabled",void 0),t.__decorate([v.property({constructOnly:!0})],et.prototype,"preserveDrawingBufferEnabled",void 0),t.__decorate([v.property({type:Boolean})],et.prototype,"supersampleScreenshotsEnabled",void 0),t.__decorate([v.property({readOnly:!0})],et.prototype,"type",void 0),t.__decorate([v.property(),w.cast(e=>e instanceof $e?e:T.ensureClass(Qe,e))],et.prototype,"ui",void 0),t.__decorate([v.property({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],et.prototype,"updating",null),t.__decorate([v.property()],et.prototype,"_updatingObjects",null),t.__decorate([v.property()],et.prototype,"_updatingObjectsWithProgress",null),t.__decorate([v.property({type:Number,readOnly:!0,dependsOn:["updating"]})],et.prototype,"updatingProgress",void 0),t.__decorate([v.property({type:["global","local"]})],et.prototype,"viewingMode",null),t.__decorate([v.property({type:i})],et.prototype,"viewpoint",null),t.__decorate([v.property({readOnly:!0})],et.prototype,"visibleArea",null),t.__decorate([v.property({type:Number})],et.prototype,"zoom",null),t.__decorate([v.property({type:ze})],et.prototype,"highlightOptions",null),t.__decorate([v.property({readOnly:!0})],et.prototype,"quality",null),t.__decorate([v.property({readOnly:!0})],et.prototype,"resolutionScale",null),t.__decorate([v.property()],et.prototype,"focusAreasView",void 0),t.__decorate([v.property()],et.prototype,"_defaultToMapOptions",null),t.__decorate([v.property()],et.prototype,"_defaultHitTestOptions",null),et=t.__decorate([S.subclass("esri.views.SceneView")],et);const rt=M.create(),it=g.createScreenPointArray(),st=B.create(),nt={GraphicsView3D:()=>new Promise((t,r)=>e(["./3d/layers/GraphicsView3D"],e=>t(Xe(e)),r)),FocusAreasView:()=>new Promise((t,r)=>e(["./3d/FocusAreasView"],t,r)),FeatureTileTree3D:()=>new Promise((t,r)=>e(["./3d/layers/support/FeatureTileTree3D"],t,r))};return et});