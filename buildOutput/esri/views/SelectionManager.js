// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../chunks/tslib.es6","../core/arrayUtils","../core/Collection","../core/collectionUtils","../core/Evented","../core/Logger","../core/MapUtils","../core/maybe","../core/ReactiveMap","../core/reactiveUtils","../core/SetUtils","../core/accessorSupport/decorators/property","../core/has","../core/accessorSupport/decorators/subclass","../layers/support/layerUtils","../rest/support/Query","./support/selectionUtils"],function(e,t,s,i,o,n,r,l,c,a,h,u,d,p,y,f,g){"use strict";let _=class extends o.EventedAccessor{constructor(e){super(e),this._selectionMap=new c,this._sources=new s,this._trashCan=[],this._layerEditHandles=new s,this._vizTaskId=0,this.view=null,this.showHighlight=!0,this.highlightName="default"}initialize(){this.addHandles([a.watch(()=>[this.view,this.showHighlight],()=>this._refreshVisualization()),a.watch(()=>this.view,e=>{e?.when().then(()=>this.syncSources())},a.initial),a.on(()=>this.sources,"change",e=>{const t=this._selectionMap,s=[];for(const i of e.removed){const e=t.get(i);e&&(t.delete(i),e.highlightHandle?.remove(),s.push({layer:i,selection:[],added:[],removed:[...e.selection]}))}this._refreshListeners(),s.length&&this._onSelectionChange(s)},{onListenerAdd:()=>this._refreshListeners()})])}destroy(){this.clear(),this._layerEditHandles.drain(l.removeMaybe)}get selections(){return Array.from(this._selectionMap.entries()).map(e=>{const[t,s]=e;return{layer:t,selection:[...s.selection]}})}get count(){let e=0;for(const t of this._selectionMap.values())e+=t.selection.length;return e}get hasSelection(){return this.count>0}get sources(){return this._sources}set sources(e){i.referenceSetter(e,this._sources)}syncSources(){const e=new Set,t=this.view?.map;if(!t)return;const s=t=>{y.isKnowledgeGraphLayer(t)?(t.layers?.forEach(s),t.tables?.forEach(s)):y.isMapImageLayer(t)?(t.sublayers?.forEach(s),t.subtables?.forEach(s)):y.isSubtypeGroupLayer(t)?t.sublayers?.forEach(s):g.isSelectableLayer(t)&&e.add(t)};t.allLayers.forEach(s),t.allTables.forEach(s),this.sources=[...e]}async getSelectedFeatures(e,s={},i="layerView"){const{view:o,selections:r}=this;if(!o&&"layerView"===i)return n.getLogger(this).warn("Cannot query layer views without a view."),[];const l=(e?.length?r.filter(t=>e.includes(t.layer)):r).map(async e=>{const{layer:t,selection:n}=e;if(!n.length)return;const r=y.isSubtypeSublayer(t)?t.parent:t;if(null!=r){if(o&&"layerView"===i&&!S(r)&&v(r)){const e=await o.whenLayerView(r).catch(()=>null);if(e)return w(e,n,s)}return w(r,n,s)}}).filter(t.isSome);return(await Promise.all(l)).filter(t.isSome)}updateSelection(e){const s=new Map;for(const[e,t]of this._selectionMap)s.set(e,[...t.selection]);let i=!1;const o=e.current.concat(e.added);for(const e of o){const t=e.sourceLayer,o=e.getObjectId();if(this.sources.includes(t)&&(g.isSelectableLayer(t)||y.isSubtypeSublayer(t))&&null!==o){const e=r.getOrCreateMapValue(s,t,()=>[]);e.includes(o)||(e.push(o),i=!0)}}for(const t of e.removed){const e=t.sourceLayer,o=t.getObjectId();if(this.sources.includes(e)&&(g.isSelectableLayer(e)||y.isSubtypeSublayer(e))&&null!==o){const t=s.get(e),n=t?.indexOf(o);void 0!==n&&n>=0&&(t?.splice(n,1),i=!0)}}if(i){const{_selectionMap:e,_trashCan:i}=this,o=[];for(const[n,r]of s){const s=e.get(n);void 0!==s&&i.push(s),e.set(n,{selection:r}),o.push({layer:n,selection:r,...t.difference(void 0!==s?s.selection:[],r)})}this._onSelectionChange(o)}}setSelection(e,t){this._setSelection(e,t)}getSelection(e){const t=this._selectionMap.get(e);return t?.selection}appendToSelection(e,t){const s=this._selectionMap.get(e),i=void 0!==s?[...s.selection]:[];for(const e of t)i.includes(e)||i.push(e);this._setSelection(e,i)}removeFromSelection(e,t){const s=this._selectionMap.get(e);if(!s)return;const i=[];for(const e of s.selection)t.includes(e)||i.push(e);this._setSelection(e,i)}toggleInSelection(e,t){const s=this._selectionMap.get(e);if(!s||0===s.selection.length)return void this._setSelection(e,t);const i=new Set(s.selection),o=new Set(t),n=h.symmetricDifference(i,o);this._setSelection(e,Array.from(n))}clear(){const e=this._selectionMap.values();this._trashCan.push(...e);const t=[];for(const[e,s]of this._selectionMap.entries())t.push({layer:e,added:[],removed:[...s.selection],selection:[]});this._selectionMap.clear(),this._onSelectionChange(t)}_onSelectionChange(e){this._refreshVisualization(),this.emit("selection-change",{view:this.view,changes:e})}_refreshVisualization(){for(this._vizTaskId++;this._trashCan.length>0;){const e=this._trashCan.pop();e?.highlightHandle?.remove()}if(null==this.view)return;const{sources:e,view:t,_selectionMap:s,showHighlight:i}=this,o=this._vizTaskId;for(const n of e){const e=s.get(n),r=y.isSubtypeSublayer(n)?n.parent:n;if(null!=r&&v(r)){if(S(r))continue;t.whenLayerView(r).then(t=>{e?.highlightHandle?.remove(),null!=e&&i&&o===this._vizTaskId&&"highlight"in t&&"function"==typeof t.highlight&&e.selection.length>0&&(e.highlightHandle=t.highlight(e.selection,this.highlightName))}).catch(()=>{e?.highlightHandle?.remove()})}}}_refreshListeners(){this._layerEditHandles.drain(l.removeMaybe);const e=new Set(this.sources.map(e=>y.isSubtypeSublayer(e)?e.parent:e));for(const t of e)g.isSelectableLayer(t)&&"on"in t&&t.on&&this._layerEditHandles.push(t.on("edits",e=>this._onLayerEdit(e,t)))}_onLayerEdit(e,t){if(y.isSubtypeGroupLayer(t))this._onParentLayerEdit(e,t);else if(e.deletedFeatures.length&&this._selectionMap.has(t)){const s=[];e.deletedFeatures.forEach(({error:e,objectId:t})=>{null!=t&&null==e&&s.push(t)}),this.removeFromSelection(t,s)}}_onParentLayerEdit(e,t){const{deletedFeatures:s,edits:i,updatedFeatures:o}=e;if(i?.updateFeatures?.forEach(e=>{const s=e.getObjectId()??e.attributes[t.objectIdField];if(null==s)return;if(o.find(e=>e.objectId===s)?.error)return;const i=t.findSublayerForFeature(e);if(!g.isSelectableLayer(i))return;const n=t.sublayers.find(e=>!(!g.isSelectableLayer(e)||!this.getSelection(e)?.includes(s)));g.isSelectableLayer(n)&&n!==i&&(this.removeFromSelection(n,[s]),this.appendToSelection(i,[s]))}),s.length){const e=[];s.forEach(({error:t,objectId:s})=>{null!=s&&null==t&&e.push(s)}),t.sublayers.forEach(t=>{g.isSelectableLayer(t)&&this._selectionMap.has(t)&&this.removeFromSelection(t,e)})}}_setSelection(e,s){if(!this.sources.includes(e))throw new Error(`Cannot set selection on layer ${e.title} because it is not in 'sources'`);const i=this._selectionMap.get(e);if(void 0===i||!b(i,{selection:s})){void 0!==i&&this._trashCan.push(i),this._selectionMap.set(e,{selection:[...s]});const o={layer:e,selection:[...s],...t.difference(void 0!==i?i.selection:[],s)};this._onSelectionChange([o])}}};e.__decorate([u.property()],_.prototype,"_selectionMap",void 0),e.__decorate([u.property()],_.prototype,"_sources",void 0),e.__decorate([u.property({readOnly:!0,nonNullable:!0})],_.prototype,"selections",null),e.__decorate([u.property({readOnly:!0,nonNullable:!0})],_.prototype,"count",null),e.__decorate([u.property()],_.prototype,"view",void 0),e.__decorate([u.property({readOnly:!0,nonNullable:!0})],_.prototype,"hasSelection",null),e.__decorate([u.property()],_.prototype,"showHighlight",void 0),e.__decorate([u.property()],_.prototype,"sources",null),e.__decorate([u.property()],_.prototype,"highlightName",void 0),_=e.__decorate([p.subclass("esri.views.SelectionManager")],_);const S=e=>y.isSubtypeSublayer(e)?!0===e.parent?.isTable:e.isTable,v=e=>void 0!==e?.when,b=(e,t)=>{if(null==e&&null==t)return!0;if(null!=e&&null==t||null==e&&null!=t)return!1;if(null!=e&&null!=t&&null!=e.selection&&null!=t.selection){const s=[...e.selection],i=[...t.selection];if(s.length!==i.length)return!1;s.sort(),i.sort();for(let e=0;e<s.length;e++)if(s[e]!==i[e])return!1}return!0},w=async(e,t,s={})=>{let i;if(void 0===e.layer){const o=e;i=void 0===o?null:await o.queryFeatures(new f({...s,objectIds:t})).then(e=>({data:e,layer:o}))}else{const o=e;i=void 0===o?null:await o.queryFeatures(new f({...s,objectIds:t})).then(t=>({data:t,layer:e.layer}))}return i};return _});