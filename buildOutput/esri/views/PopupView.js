// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../chunks/tslib.es6","../core/asyncUtils","../core/Error","../core/has","../core/Logger","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./input/InputManager"],function(e,t,p,o,i,s,r,a,u,n,c,l,h){"use strict";const d=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function w(e){return null!=e&&"open"in e&&"declaredClass"in e}function y(e){return null!=e&&"declaredClass"in e&&"dockOptions"in e}class f{constructor(e){this.layerView=e,this._resolver=a.createResolver(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(e){const{layerView:t,graphics:p,_resolver:o}=this;if(!t)return o.resolve(p),o.promise;let i;return t.fetchPopupFeaturesFromGraphics(p,e).catch(e=>(i=e,null)).then(e=>{e?o.resolve(e):o.reject(i)}),o.promise}}t.PopupView=t=>{const c=t;let P=class extends c{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([u.watch(()=>[this.ui,this.popup],([e,t],p)=>{const o="popup";if(p){const[e,i]=p;e&&w(i)&&(i.view=null,y(i)&&(e.remove(i,o),i!==t&&t&&i.destroy()))}e&&w(t)&&(t.view=this,y(t)&&e.add(t,{key:o,position:"manual",internal:!0}))},u.syncAndInitial),this.on("click",e=>{this.popup&&this.popupEnabled&&("mouse"!==e.pointerType||0===e.button)&&(w(this.popup)?this.popup.viewModel.handleViewClick(e):e.defer(async()=>{await this.setupPopup(),w(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(e)}))},h.ViewEventPriorities.WIDGET)]),u.whenOnce(()=>this.ready&&this.popupEnabled&&!this.updating).then(()=>new Promise((t,p)=>e(["../widgets/Popup"],e=>t(d(e)),p)))}destroy(){this.destroyed||this.closePopup()}async openPopup(e){if(w(this.popup))return this.popup.open(e);try{if(await this.setupPopup(),!this.popup)return void r.getLogger(this).error(new i("view:null-popup","Popup is null and can't be opened"));this.popup.open(e)}catch{}}closePopup(){this._popupSetupTask?.abort(),w(this.popup)&&this.popup.close()}async fetchPopupFeatures(e,t){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(e,t),t)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!w(this.popup))return this._popupSetupTask=o.createTask(async t=>{const{default:p}=await new Promise((t,p)=>e(["../widgets/Popup"],e=>t(d(e)),p));if(a.throwIfAborted(t),!this.popup||w(this.popup))return;const o=this.popup;delete o.open,delete o.close,this.popup=new p(o)}),this._popupSetupTask.promise}async _popupHitsToFeatures({location:e,hits:t},p){const o=[],i=[];let r=!1;const u=a.wrapAbortWithTimeout(p,s("popup-view-fetch-timeout")??5e3),n=e=>{const t=i.at(-1);return t&&t.layerView===e&&!r?t:(e=>{const t=new f(e);return i.push(t),o.push(t.promise),t})(e)};for(const e of t)"graphic"in e?(n(e.layerView).graphics.push(e.graphic),r=!1):(o.push(e.layerView.fetchPopupFeaturesAtLocation(e.mapPoint,u)),r=!0);i.forEach(e=>e.resolve(u));const c=a.allSettledValues(o).then(e=>e.filter(e=>!!e).flat());return{pendingFeatures:o,allGraphicsPromise:c,location:e}}async _getPopupHits(e,t){const{hits:p,location:o}=await this.popupHitTest(e);a.throwIfAborted(t);const i=[];for(const e of p)if("graphic"in e){if(this._isValidPopupGraphic(e.graphic,t)){const t=this._isValidPopupGraphicsLayerView(e.layerView)?e.layerView:void 0;i.push({graphic:e.graphic,layerView:t})}}else this._isValidPopupLocationLayerView(e.layerView)&&i.push({mapPoint:e.mapPoint,layerView:e.layerView});return{hits:i,location:o}}_isValidPopupGraphic(e,t){return e&&!!e.getEffectivePopupTemplate(t?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(e){return!e||(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesFromGraphics"in e}_isValidPopupLocationLayerView(e){return(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesAtLocation"in e}};return p.__decorate([n.property()],P.prototype,"popup",void 0),p.__decorate([n.property()],P.prototype,"popupEnabled",void 0),P=p.__decorate([l.subclass("esri.views.PopupView")],P),P},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});