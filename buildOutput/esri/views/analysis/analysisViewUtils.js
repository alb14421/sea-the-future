// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/asyncUtils","../../core/handleUtils","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils"],function(t,o,e,n,a,i){"use strict";function r(t,e){t.interactive=!0;const{tool:r,view:l}=t;l.activeTool=r;let s=a.onAbort(e,()=>{l.activeTool===r&&(l.activeTool=null)});return o.createTask(async o=>{await i.whenOnce(()=>!t.tool?.active,o),s=n.removeMaybe(s)},e)}function l(t){const{view:o,tool:e}=t;null!=e&&(o.tools.remove(e),t.tool=null)}function s(t,n){const l=t.userOperation,s=o.createTask(async o=>{if(l){const t=l.promise.catch(()=>{});l?.abort(),await t,a.throwIfAborted(o)}const s=r(t,{signal:o}),c=n?.shouldRejectOnCancel??(()=>!0),u=e.handlesGroup([i.on(()=>t.tool,"cancel",()=>{c()&&s.abort()})]),{tool:v}=t;try{v&&(v.resetCreated(),n?.onToolActivated?.(v)),await s.promise,a.throwIfAborted(o)}catch(t){if(o.aborted||!a.isAbortError(t)||c())throw t}finally{u?.remove()}},{signal:n?.abortOptions?.signal});return t.userOperation=s,s.promise.finally(()=>{t.userOperation===s&&(t.userOperation=null)})}t.activateAnalysisViewTool=r,t.connectAnalysisViewToTool=function(t,o){return i.watch(()=>t.interactive,()=>function(t,o){t.interactive?function(t,o){l(t);const{view:e,analysis:n}=t,a=new o({view:e,analysis:n,analysisViewData:t});t.tool=a,e.tools.add(a)}(t,o):l(t)}(t,o),i.syncAndInitial)},t.removeAnalysisViewTool=l,t.startExclusiveInteractiveOperation=s,t.startPlaceOperation=async function(t,o){const e=t.analysis.clone();return await s(t,{abortOptions:o?.placementOptions,onToolActivated:o?.onToolActivated,shouldRejectOnCancel:()=>{const{analysis:o}=t;return!o.valid||o.equals(e)}}),{}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});