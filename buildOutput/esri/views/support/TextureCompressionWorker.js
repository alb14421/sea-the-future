// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../libs/basisu/BasisUEncoder","../../libs/dxtEncoder/DXTEncoder","../webgl/enums"],function(e,t,n,r){"use strict";let a,s,l=null,i=null;class o{constructor(e,t){this.internalFormat=e,this.compressedTexture=t}}async function u(){l||(l=await(a??=t.getBasisEncoder()),a=null)}async function c(){i||(i=await(s??=n.getDXTEncoder()),s=null)}function d(e,t,n,r,a=255,s=0,i=!1,o=!1){if(!l)return null;const u=new l.BasisEncoder;u.setPerceptual(!o),u.setCheckForAlpha(!0),u.setForceAlpha(!1),u.setRenormalize(o),u.setMipGen(r),u.setMipSRGB(!o),u.setCreateKTX2File(!0),u.setKTX2SRGBTransferFunc(!o),u.setQualityLevel(a),u.setCompressionLevel(s);const c=new Uint8Array(e.byteLength);u.setSliceSourceImage(0,new Uint8Array(e),t,n,i);const d=u.encode(c),p=new Uint8Array(c.buffer,0,d),h=new l.KTX2File(new Uint8Array(p));return h.isValid()?(u.delete(),p):(h.close(),h.delete(),u.delete(),null)}function p(e){if(!l)return new o(null,null);const t=new l.KTX2File(new Uint8Array(e));t.startTranscoding();const[n,a]=t.getHasAlpha()?[1,r.CompressedTextureFormat.COMPRESSED_RGBA8_ETC2_EAC]:[0,r.CompressedTextureFormat.COMPRESSED_RGB8_ETC2],s=t.getLevels(),i=[];for(let e=0;e<s;e++)i.push(new Uint8Array(t.getImageTranscodedSizeInBytes(e,0,0,n))),t.transcodeImage(i[e],e,0,0,n,0,-1,-1);return t.close(),t.delete(),{internalFormat:a,compressedTexture:{type:"compressed",levels:i}}}function h(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const m=h("DXT1"),f=h("DXT3"),T=h("DXT5");e.TextureCompressionWorkerOutput=o,e.compress=async function(e){let t;if(t=e.data instanceof ImageBitmap?function(e){const t=new OffscreenCanvas(e.width,e.height),n=t.getContext("2d");return n.drawImage(e,0,0),n.getImageData(0,0,t.width,t.height).data}(e.data):function(e,t,n,r,a){const s=new Uint8ClampedArray(e).subarray(0,t*n*r);if(!a)return s;const l=new Uint8ClampedArray(s.length),i=t*r;for(let e=0;e<n;e++){const t=e*i,r=(n-e-1)*i;l.set(s.subarray(t,t+i),r)}return l}(e.data,e.width,e.height,e.components,e.needsFlip),e.hasS3TC){i||await c();const n=new Uint8Array(t.length);if(i?.encode(t,e.width,e.height,e.preMultiplyAlpha,n)){const e=function(e){const t=new Int32Array(e.buffer,e.byteOffset,31);let n,a;switch(t[21]){case m:n=8,a=r.CompressedTextureFormat.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case f:n=16,a=r.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case T:n=16,a=r.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return null}let s=1,l=t[4],i=t[3];(3&l||3&i)&&(l=l+3&-4,i=i+3&-4);const o=l,u=i;131072&t[2]&&(s=Math.max(1,t[7]));let c,d,p=e.byteOffset+t[1]+4;const h=[];for(let t=0;t<s;++t)d=(l+3>>2)*(i+3>>2)*n,c=new Uint8Array(e.buffer,p,d),h.push(c),p+=d,l=Math.max(1,l>>1),i=Math.max(1,i>>1);return{textureData:{type:"compressed",levels:h},internalFormat:a,width:o,height:u}}(n),t=[n.buffer];return{result:new o(e?.internalFormat??null,e?.textureData??null),transferList:t}}return{result:new o(null,null)}}if(e.hasETC){if(l||await u(),e.preMultiplyAlpha&&!i&&await c(),e.preMultiplyAlpha){const n=new Uint8ClampedArray(t.length);i?.premultiply(new Uint8Array(t),e.width,e.height,n),t=n}const n=d(t,e.width,e.height,e.hasMipmap),r=n?p(n):null,a=r?.compressedTexture?.levels.map(e=>e.buffer)||[];return{result:new o(r?.internalFormat??null,r?.compressedTexture??null),transferList:a}}return{result:new o(null,null)}},e.compressRGBADataToKTX2=d,e.createTextureDataKTX2=p,e.destroy=function(){l=null,a=null,i=null,s=null,t.destroyBasisEncoder(),n.destroyDXTEncoder()},e.initializeBasisEncoder=u,e.initializeDXTEncoder=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});