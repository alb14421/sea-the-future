// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../Camera","../../../core/Cyclical","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/Point","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectVectorToPoint","../webgl","./earthUtils","./ElevationProvider","./viewingModeUtils","../../support/spatialReferenceSupport"],function(e,t,n,r,i,o,a,c,l,s,u,f,d,p,m,h,g,y,v){"use strict";const w=()=>r.getLogger("esri.views.3d.support.cameraUtils"),T=96*39.37,R=c.create(),M=new n.Cyclical(-20037508.342788905,20037508.342788905),x=new n.Cyclical(-180,180);function S(e){return e.spatialReference??f.WGS84}function A(e,t){const{camera:n}=e.state,{unitInMeters:r}=e.renderCoordsHelper;return t/=r,n.width/2/n.pixelRatio/(T/t)/Math.tan(n.fovX/2)}function b(e,t){const{camera:n}=e.state,{unitInMeters:r}=e.renderCoordsHelper,i=t*Math.tan(n.fovX/2),o=n.width/2/n.pixelRatio;return T/(o/i)*r}function C(e,t,n,r){const i=r.levelAtScale(t),o=z(y.directionToHeadingTilt(e,n.eye,n.viewForward,n.up).tilt),a=Math.max(i-o,0);return r.scaleAtLevel(a)}function P(e,t,n){const r=n.levelAtScale(e),i=z(t);return n.scaleAtLevel(r+i)}function z(e){return 2*((e>90?180-e:e)/90)**2}function j(e,t,n=0){const r=m.toRenderCamera(e,t);return r?function(e,t,n=0){const r=e.basemapTerrain?.tilingScheme;if(!r)return 0;const i=l.getReferenceEllipsoid(e.spatialReference).radius,o=2===e.state.viewingMode?t.eye[2]:a.length(t.eye)-i;return C(e,b(e,Math.abs(o-n)),t,r)}(e,r,n):0}async function D(e,t,n,r,i,a){const c=await E(e,r.heading,r.tilt,t,n,i,a);return o.throwIfAborted(a),N(e,c,r.fov,a)}function I(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,R,e.spatialReference)&&e.elevationProvider&&(g.getElevationAtPoint(e.elevationProvider,R)??0)>R[2]-1)}function U(e,t,n,r,i,o){const l=r instanceof s?r:null,u=function(e,t){const n=c.create();if(null==t)return a.copy(n,e.state.camera.center);if(t instanceof s){if(!d.projectPointToVector(t,n,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:i}=e;if(null==t.z&&null!=r&&null!=i){const r=g.getElevationAtPoint(i,t);null!=r&&e.renderCoordsHelper.setAltitude(n,r)}return n}return a.copy(n,t)}(e,r);return L(e,t,n,l,u,i,o)}async function E(e,t,n,r,i,l,u){const f=r instanceof s?r:null,p=await async function(e,t,n){const r=c.create();if(null==t)return a.copy(r,e.state.camera.center);if(t instanceof s){const{renderSpatialReference:i,basemapTerrain:a,elevationProvider:c}=e,l=t.spatialReference;if(await d.projectPointToVectorAsync(t,r,i,0,{signal:n}),o.throwIfAborted(n),null==t.z&&null!=a&&null!=c){const i=await c.queryElevation(t.x,t.y,t.z??0,l,"ground",n);o.throwIfAborted(n),null!=i&&e.renderCoordsHelper.setAltitude(r,i)}return r}return a.copy(r,t)}(e,r,u);return o.throwIfAborted(u),V(e,t,n,f,p,i,l,u)}function L(e,t,n,r,i,o,a){if(null==i)return null;if(!r&&(r=new s({spatialReference:S(e)}),!p.projectVectorToPoint(i,e.renderSpatialReference,r)))return null;const c=H(e,t,n,i,o,a);if(F(e,n,a)&&I(e,c.eye)){const{tilt:a,mode:c}=O(e,n,i,o);return L(e,t,a,r,i,o,c)}return q(c,i)}async function V(e,t,n,r,i,a,c,l){r||(r=new s({spatialReference:S(e)}),await p.projectVectorToPointAsync(i,e.renderSpatialReference,r,{signal:l})||(r=null)),o.throwIfAborted(l);const u=H(e,t,n,i,a,c);if(F(e,n,c)&&await async function(e,t,n){if(I(e,t))return!0;const{elevationProvider:r,spatialReference:i,renderCoordsHelper:a}=e;if(null==r||!a.fromRenderCoords(t,R,i))return!1;const[c,l,s]=R,u=await r.queryElevation(c,l,s,i,"ground",n)??0;return o.throwIfAborted(n),u>s-1}(e,u.eye,l)){o.throwIfAborted(l);const{tilt:c,mode:s}=O(e,n,i,a);return V(e,t,c,r,i,a,s,l)}return q(u,i)}function H(e,t,n,r,i,o){const c=function(e,t,n,r,i,o){let c=0;return 1===o&&function(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>8)return!0;const i=t,o=e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return a.distance(i,o)/(Math.tan(.5*e.state.camera.fov)*r)>5}(e,r,i)?(t=0,c=function(e,t,n,r){const i=Z(e,r,t,n);if(!e.state.constraints.tilt)return i;const o=e.state.constraints.tilt(t);o.max=Math.min(o.max,.5*Math.PI);const a=o.min*(1-k)+o.max*k;return Math.min(i,a)}(e,i,n,r)):c=Z(e,r,i,n),c=e.state.constraints.clampTilt(i,c),{heading:t,tilt:n=W(e,r,i,c)}}(e,t,n,r,i=Math.max(i,e.state.constraints.minimumPoiDistance),o);return(0,y.viewModeDependentUtil(e).eyeForCenterWithHeadingTilt)(r,i,c.heading,c.tilt)}function F(e,t,n){const r=e.map.ground.navigationConstraint;return 1===n&&e.state.isGlobal&&t>0&&(null==r||"stay-above"===r.type)}function O(e,t,n,r){const i=W(e,n,r,function(e,t,n,r){let i=Z(e,r,t,n);if(!e.state.constraints.tilt)return i;const o=e.state.constraints.tilt(t);return i=Math.min(i,.5*Math.PI),o.min*(1-k)+i*k}(e,r,t,n));return{tilt:i,mode:t-i<1?0:1}}function q(e,t){return{...e,center:c.clone(t)}}function G(e,t){const{state:n,spatialReference:r}=e,i=t.spatialReference;return n.isGlobal&&v.isSpatialReferenceSupported(i,1)||n.isLocal&&r.equals(i)}function X(e,t){let n,r,i;if(e.state.isGlobal){const e=new s(t.xmin,t.ymin,t.spatialReference),o=new s(t.xmax,t.ymax,t.spatialReference),a=t.spatialReference.isGeographic?x:M;n=new s({x:a.center(e.x,o.x),y:(o.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const c=l.getReferenceEllipsoid(t.spatialReference),u=h.getGreatCircleSpanAt(n,e,o);r=u.lon,i=u.lat,a.diff(e.x,o.x)>a.range/2&&(r+=c.halfCircumference),r=Math.min(r,c.halfCircumference),i=Math.min(i,c.halfCircumference)}else{const o=e.renderSpatialReference??t.spatialReference;o.equals(t.spatialReference)||(t=u.project(t,o)),r=t.xmax-t.xmin,i=t.ymax-t.ymin;const a=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;n=new s({x:t.xmin+.5*r,y:t.ymin+.5*i,z:a,spatialReference:o})}const o=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,a=e.state.camera,c=1/Math.tan(a.fovX/2),f=1/Math.tan(a.fovY/2),d=1/Math.tan(a.fov/2);return{center:n,distance:Math.max(.5*r*c,.5*i*f,.5*o*d)/1}}const k=.7;function W(e,t,n,r){return y.viewModeDependentUtil(e).lookAtTiltToEyeTilt(r,t,n)}function Z(e,t,n,r){return y.viewModeDependentUtil(e).eyeTiltToLookAtTilt(r,t,n)}function Y(e,n,r,i){if(null==n)return null;const o=e.renderSpatialReference,a=new s({spatialReference:S(e)});return p.projectVectorToPoint(n.eye,o,a)?(i??=new t,i.position=a,i.heading=n.heading,i.tilt=n.tilt,i.fov=r,i):null}async function N(e,n,r,i){const a=e.renderSpatialReference,c=new s({spatialReference:S(e)});return await p.projectVectorToPointAsync(n.eye,a,c,{signal:i}),o.throwIfAborted(i),new t(c,n.heading,n.tilt,r)}e.applyTiltAdjustToScale=C,e.distanceToScale=b,e.fromCenterDistanceAsync=D,e.fromCenterDistanceSync=function(e,t,n,r,i,o){return Y(e,U(e,r.heading,r.tilt,t,n,i),r.fov,o)},e.fromCenterScale=async function(e,t,n,r,i,o){return D(e,t,A(e,n),r,i,o)},e.fromExtentAsync=async function(e,t,n,r,i,a){const c=G(e,t)?t:await u.projectWithZConversion(t,e.spatialReference,{signal:a});o.throwIfAborted(a);const{center:l,distance:s}=X(e,c),f=await E(e,n,r,l,s,i,a);return o.throwIfAborted(a),N(e,f,e.camera.fov,a)},e.fromExtentSync=function(e,t,n,r,i,o){let a;try{a=G(e,t)?t:u.project(t,e.spatialReference)}catch(e){return null}const{center:c,distance:l}=X(e,a),s=U(e,n,r,c,l,i);return null==s?null:Y(e,s,e.camera.fov,o)},e.getObserverForPointAtDistanceAsync=E,e.getObserverForPointAtDistanceSync=U,e.getViewSR=S,e.headingTiltToDirectionUp=function(e,t,n,r,i){return y.viewModeDependentUtil(e).headingTiltToDirectionUp(t,n,r,i)},e.removeTiltAdjustFromScale=P,e.scaleErrorThreshold=1,e.scaleToDistance=A,e.scaleToZoom=function(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.levelAtScale(t);w().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")},e.toArea=function(e,t){return y.viewModeDependentUtil(e).toArea(e,t)},e.toExtent=function(e,t,n){const r=e.renderSpatialReference,i=new s({spatialReference:S(e)});if(!p.projectVectorToPoint(n,r,i))return null;const o=Math.tan(t.fovX/2),c=Math.tan(t.fovY/2),l=a.dist(t.eye,n),u=2*l*o*1,f=2*l*c*1;return y.viewModeDependentUtil(e).toExtent(e,i,u,f)},e.viewScaleToCameraDistance=function(e,t,n,r,o){if(0===t)return 0;const c=a.distance(n.eye,r),s=e.basemapTerrain?.tilingScheme;if(!s)return w().error("#scaleToTargetDistance()","Cannot compute distance from scale without a tiling scheme"),c;let u=c;const f=y.directionToHeadingTilt(e,n.eye,n.viewForward,n.up),d=f.tilt>90;if(e.state.isLocal){const r=(A(e,P(t,f.tilt,s))-Math.abs(n.eye[2]-o[2]))/Math.cos(i.deg2rad(f.tilt));return u=d?u-r:u+r,u}let p=1/0,m=0,h=U(e,f.heading,f.tilt,r,c,1);if(!h)return u;const g=a.length(o);for(;p>1&&m<100;){const o=a.length(h.eye),c=d?180-h.tilt:h.tilt,y=i.deg2rad(c),v=Math.sin(y)*o,w=Math.cos(y)*o,T=A(e,P(t,h.tilt,s)),R=d?g-T:g+T,M=i.asinClamped(v/R),x=Math.cos(M)*R-w,S=a.distance(h.eye,r);u=d?S-x:S+x,h=U(e,f.heading,f.tilt,r,u,1);const b=Y(e,h,i.rad2deg(n.fov));if(!h||!b)return u;const C=j(e,b,g-l.getReferenceEllipsoid(e.spatialReference).radius);p=Math.abs(t-C),++m}return u},e.zoomToScale=function(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.scaleAtLevel(t);w().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});