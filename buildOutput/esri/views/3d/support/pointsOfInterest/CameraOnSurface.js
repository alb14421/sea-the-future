// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../cameraUtils","./PointOfInterest","../../../support/PropertiesPool","../../../support/Yield"],function(e,t,r,o,i,n,a,s,c,d,l,p,u,h,_,y,g){"use strict";const m=Array;e.CameraOnSurface=class extends _.PointOfInterest{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new y.PropertiesPool({location:u,renderLocation:m},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=p.create(),this._tmpPoint=new u}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles(i.on(()=>this.map?.ground?.layers,"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=r.destroyMaybe(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=l.distance(e.eye,this.renderLocation),r={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return h.distanceToScale(r,t)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get readyToRun(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),g.Yield;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>C&&1===this.renderCoordsHelper.viewingMode&&(e.isWGS84||e.isWebMercator);let r=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:r.signal,cache:this.cache,minDemResolution:t?S:0}).then(e=>this._updateSurfaceAltitude(e.geometry.z??0)).catch(e=>{o.isAbortError(e)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===r&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),r=null}),this._pendingElevationQueryController=r,g.Yield}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(f,this._estimatedSurfaceAltitude,this._camera.eye),l.exactEquals(this._get("renderLocation"),f)||(this._set("renderLocation",l.copy(this._propertiesPool.get("renderLocation"),f)),this.notifyChange("renderLocation"))}},t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"scheduler",void 0),t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"cache",void 0),t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"task",void 0),t.__decorate([n.property()],e.CameraOnSurface.prototype,"location",null),t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"map",void 0),t.__decorate([n.property()],e.CameraOnSurface.prototype,"renderLocation",void 0),t.__decorate([n.property()],e.CameraOnSurface.prototype,"scale",null),t.__decorate([n.property()],e.CameraOnSurface.prototype,"updating",null),e.CameraOnSurface=t.__decorate([d.subclass("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],e.CameraOnSurface);const f=p.create(),C=1e5,S=1e6;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});