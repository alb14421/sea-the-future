// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../Graphic","../../../core/iteratorUtils","../../../core/screenUtils","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/projection/projectVectorToVector","../../../layers/LayerConstants","../../../layers/support/layerUtils","./debugFlags","./ElevationProvider","../webgl-engine/lib/Intersector","../webgl-engine/lib/IntersectorResult","../webgl-engine/lib/intersectorUtilsConversions","../webgl-engine/lib/verticalOffsetUtils"],function(e,t,n,i,r,s,l,c,a,o,u,d,p,f,g,y){"use strict";function m(e,t,n){return t.getIntersectionPoint(T)?(n=I(e,T,n),2===t.intersector&&e.basemapTerrain&&(n.z=d.getElevationAtPoint(e.basemapTerrain,n)??0),n):null}function h(e){const t=e.sourceLayer,n=e.layer,i=t&&"objectIdField"in t?t:n&&"objectIdField"in n?n:t;if(i){const t=i.objectIdField??a.fallbackObjectIDAttribute,n=e.attributes?.[t];if(n)return`o-${i.id}-${n}`}return`u-${e.uid}`}function w(e,t){return b(e,h(t))}function b(e,t){return null==e||(null==e.include||e.include.has(t))&&(null==e.exclude||!e.exclude.has(t))}function I(e,t,n){let i=e.spatialReference||l.WGS84;return c.projectVectorToVector(t,e.renderSpatialReference,T,i)?t=T:(i=l.WGS84,c.projectVectorToVector(t,e.renderSpatialReference,T,i)&&(t=T)),n?(n.x=t[0],n.y=t[1],n.z=t[2],n.spatialReference=i):n=new s(t,i),n}function V(e,t){const n=S(e,t.include,0),i=S(e,t.exclude,1);return{include:n.layerViewUids,exclude:i.layerViewUids,graphics:{include:n.graphicUids,exclude:i.graphicUids},mediaElements:{include:n.mediaElements,exclude:i.mediaElements}}}function S(e,i,r,s=new U){if(!i)return s;if(i instanceof t)!function(e,t){e.graphicUids??=new Set,e.graphicUids.add(t)}(s,h(i)),0===r&&(null!=e.graphicsView&&i.layer===e?x(s,e.graphicsView.uid):i.layer&&E(s,e,i.layer.uid));else if("layer"in i&&"element"in i)!function(e,t){e.mediaElements??=new Set,e.mediaElements.add(t)}(s,i.element),0===r&&E(s,e,i.layer.uid);else if(n.isIterable(i))for(const t of i)t===e.graphics&&null!=e.graphicsView?x(s,e.graphicsView.uid):t===e.map.ground?x(s,y.terrainId):S(e,t,r,s);else"layer"in i&&function(e,t,n){const i=t.allLayerViews.find(e=>e.layer.uid===n.layer.uid);if(!i)return;e.layerViewUids??=new Map;const r=e.layerViewUids.get(i.uid);!0!==r&&(r?r.add(n.id):e.layerViewUids.set(i.uid,new Set([n.id])))}(s,e,i),"uid"in i&&E(s,e,i.uid);return s}class U{constructor(){this.layerViewUids=null,this.graphicUids=null,this.mediaElements=null}}function E(e,t,n){const i=t.allLayerViews.find(e=>e.layer.uid===n);i&&x(e,i.uid)}function x(e,t){e.layerViewUids??=new Map,e.layerViewUids.set(t,!0)}const T=r.create();e.computeMapPointFromVec3d=I,e.externalToInternalIntersectOptions=V,e.getGraphicFilterUid=h,e.hitTest=async function(e,t,n,r){const s=n?V(e,n):r,l=i.createScreenPointArray(t.x,t.y);s.requiresGroundFeedback=!0,s.enableDraped=!0;const c=new p.Intersector(e.state.viewingMode);c.options.selectionMode=!0,c.options.store=2,e.sceneIntersectionHelper.intersectIntersectorScreen(l,c,s);const a=await async function(e,t,n){const i=new Array;let r,s=null;const l={defer(e){r=e()}};for(let c=0;c<t.length;c++){const a=t[c],u=g.toOwner(a,e);if(null!=u&&(u===e.map.ground||"type"in u&&o.isIntegratedMeshLayer(u.type)))break;const d=g.toHit(a,e,l)??await r;if(r=null,null==d)continue;if("graphic"===d.type){if(null==s&&c!==t.length-1&&(s=new Set),null!=s){const e=h(d.graphic);if(s.has(e))continue;s.add(e)}if(!w(n,d.graphic))continue}const p=m(e,a),f=a.distanceInRenderSpace;if("media"===d.type){const e=d.element.toSource(p);i.push({...d,mapPoint:p,distance:f,sourcePoint:e})}else i.push({...d,mapPoint:p,distance:f})}return i}(e,c.results.all,s.graphics),d=c.results.ground,y=g.toOwner(d,e),b=null!=y&&"type"in y&&o.isIntegratedMeshLayer(y.type)?y:null,I={screenPoint:t,results:a,ground:{mapPoint:m(e,d),distance:f.isValidIntersectorResult(d)?d.distanceInRenderSpace:0,layer:b}};return u.debugFlags.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(I.intersector=c),I},e.intersectResultToMapPoint=m,e.toMap=function(e,t,n,r){const s=n?V(e,n):r,l=!(!s.graphics?.include&&!s.graphics?.exclude),c=!(!s.mediaElements?.include&&!s.mediaElements?.exclude),a=i.screenPointObjectToArray(t);s.enableDraped=s.include&&!s.include.has(y.terrainId)||s.exclude?.has(y.terrainId);const o=e.sceneIntersectionHelper,u=new p.Intersector(e.state.viewingMode);if(u.options.selectionMode=!0,u.options.store=l||c?2:0,u.options.excludeLabels=n?.excludeLabels??!1,o.intersectIntersectorScreen(a,u,s),l||c){for(const t of u.results.all){const n=g.toHit(t,e);if(null==n)return m(e,t);if(l&&("graphic"!==n.type||w(s.graphics,n.graphic)))return m(e,t);if(c&&("media"!==n.type||b(s.mediaElements,n.element)))return m(e,t)}return null}return m(e,u.results.min)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});