// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../layers/support/layerUtils","../../support/hitTestSelectUtils"],function(e,t,a){"use strict";const r={layerUids:new Set,layerViews:[]};e.popupHitTest=async function(e,n){const{results:s,ground:i}=await a.hitTestSelectSimilarDistance(e,n),l=(!i.layer||!t.isIntegratedMeshLayer(i.layer.type))&&i.mapPoint,o=[],c=function(e){const t=new Map;for(const a of e.allLayerViews){const e=a.layer.uid;t.set(e,a)}return t}(e),y=l?function(e,t){const a=new Set,r=new Set;for(let t=e.basemapTerrain.numLayers(1)-1;t>=0;t--){const n=e.basemapTerrain.layerViewByIndex(t,1);a.add(n.layer.uid),r.add(n)}const n=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:e}of n){const n=t.get(e);n&&(a.add(e),r.add(n))}return{layerUids:a,layerViews:Array.from(r).reverse()}}(e,c):r;let p=0,d=0;const u=()=>{const e=y.layerViews[d];l&&e&&"fetchPopupFeaturesAtLocation"in e&&o.push({mapPoint:i.mapPoint,layerView:e}),++d};let f=null;for(;p<s.length||d<y.layerViews.length;){const t=s[p];if(t&&"graphic"!==t.type)++p;else if("scene"!==t?.layer?.type||t?.layer?.parent!==e?.map?.basemap)if(t){const e=t.layer?.uid,a=y.layerUids.has(e)&&t.distance===i.distance,r=c.get(t.layer?.uid);if(f??=t.mapPoint,d<y.layerViews.length&&(a||(t.distance??0)>i.distance)&&y.layerViews[d]!==r){u();continue}o.push({graphic:t.graphic,layerView:r}),++p}else u();else++p}return f??=i.mapPoint,{hits:o,location:f}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});