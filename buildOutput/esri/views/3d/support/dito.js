// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/quatf64","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../webgl-engine/lib/Attribute"],function(t,e,r,n,i,a,o){"use strict";const c=1e-6,s=a.create(),f=a.create(),u=a.create(),h=a.create(),m=a.create(),l=a.create(),P=a.create(),b=a.create(),j=a.create(),x=a.create(),I=[0,0,0],V=n.create(),N=a.create(),y=a.create(),d=a.create(),w=a.create(),A=a.create(),g=a.create();function T(t,e,r,n,i,a){if($(e)<c)return;X(N,r,e),X(y,n,e),X(d,i,e),M(t,e,V),A[1]=V[0],w[1]=V[1],g[1]=w[1]-A[1];const o=[r,n,i],s=[N,y,d];for(let r=0;r<3;++r){M(t,o[r],V),A[0]=V[0],w[0]=V[1],M(t,s[r],V),A[2]=V[0],w[2]=V[1],g[0]=w[0]-A[0],g[2]=w[2]-A[2];const n=L(g);n<a.quality&&(W(a.b0,o[r]),W(a.b1,e),W(a.b2,s[r]),a.quality=n)}}const q=a.create();function M(t,e,r){const{data:n,size:i}=t;r[0]=Number.POSITIVE_INFINITY,r[1]=Number.NEGATIVE_INFINITY;for(let t=0;t<n.length;t+=i){const i=n[t]*e[0]+n[t+1]*e[1]+n[t+2]*e[2];r[0]=Math.min(r[0],i),r[1]=Math.max(r[1],i)}}function v(t,e,n){n.center=t,n.halfSize=i.scale(e,e,.5),n.quaternion=r.IDENTITY}const F=a.create(),E=a.create(),z=a.create(),S=a.create(),Y=a.create(),_=a.create();function O(t,e,r){W(F,e),Math.abs(e[0])>Math.abs(e[1])&&Math.abs(e[0])>Math.abs(e[2])?F[0]=0:Math.abs(e[1])>Math.abs(e[2])?F[1]=0:F[2]=0,$(F)<c&&(F[0]=F[1]=F[2]=1),X(E,e,F),Z(E,E),X(z,e,E),Z(z,z),p(t,e,E,z,S,Y),R(_,Y,S),H(e,E,z,S,Y,_,r)}function p(t,e,r,n,i,a){M(t,e,V),i[0]=V[0],a[0]=V[1],M(t,r,V),i[1]=V[0],a[1]=V[1],M(t,n,V),i[2]=V[0],a[2]=V[1]}const B=a.create(),G=a.create(),k=a.create(),D=e.fromValues(1,0,0,0,1,0,0,0,1),C=r.create();function H(t,e,r,n,a,o,c){D[0]=t[0],D[1]=t[1],D[2]=t[2],D[3]=e[0],D[4]=e[1],D[5]=e[2],D[6]=r[0],D[7]=r[1],D[8]=r[2],c.quaternion=function(t,e){const r=e[0]+e[4]+e[8];if(r>0){let n=Math.sqrt(r+1);t[3]=.5*n,n=.5/n,t[0]=(e[5]-e[7])*n,t[1]=(e[6]-e[2])*n,t[2]=(e[1]-e[3])*n}else{let r=0;e[4]>e[0]&&(r=1),e[8]>e[3*r+r]&&(r=2);const n=(r+1)%3,i=(r+2)%3;let a=Math.sqrt(e[3*r+r]-e[3*n+n]-e[3*i+i]+1);t[r]=.5*a,a=.5/a,t[3]=(e[3*n+i]-e[3*i+n])*a,t[n]=(e[3*n+r]+e[3*r+n])*a,t[i]=(e[3*i+r]+e[3*r+i])*a}return t}(C,D),Q(B,n,a),U(B,B,.5),U(G,t,B[0]),U(k,e,B[1]),Q(G,G,k),U(k,r,B[2]),c.center=i.add(G,G,k),c.halfSize=i.scale(B,o,.5)}class J{constructor(t){this.minVert=new Array(7),this.maxVert=new Array(7),this.buffer=new ArrayBuffer(448);let e=0;this.minProj=new Float64Array(this.buffer,e,7),e+=56,this.maxProj=new Float64Array(this.buffer,e,7),e+=56;for(let t=0;t<7;++t)this.minVert[t]=new Float64Array(this.buffer,e,3),e+=24;for(let t=0;t<7;++t)this.maxVert[t]=new Float64Array(this.buffer,e,3),e+=24;for(let t=0;t<7;++t)this.minProj[t]=Number.POSITIVE_INFINITY,this.maxProj[t]=Number.NEGATIVE_INFINITY;const r=new Array(7),n=new Array(7),{data:i,size:a}=t;for(let t=0;t<i.length;t+=a){let e=i[t];e<this.minProj[0]&&(this.minProj[0]=e,r[0]=t),e>this.maxProj[0]&&(this.maxProj[0]=e,n[0]=t),e=i[t+1],e<this.minProj[1]&&(this.minProj[1]=e,r[1]=t),e>this.maxProj[1]&&(this.maxProj[1]=e,n[1]=t),e=i[t+2],e<this.minProj[2]&&(this.minProj[2]=e,r[2]=t),e>this.maxProj[2]&&(this.maxProj[2]=e,n[2]=t),e=i[t]+i[t+1]+i[t+2],e<this.minProj[3]&&(this.minProj[3]=e,r[3]=t),e>this.maxProj[3]&&(this.maxProj[3]=e,n[3]=t),e=i[t]+i[t+1]-i[t+2],e<this.minProj[4]&&(this.minProj[4]=e,r[4]=t),e>this.maxProj[4]&&(this.maxProj[4]=e,n[4]=t),e=i[t]-i[t+1]+i[t+2],e<this.minProj[5]&&(this.minProj[5]=e,r[5]=t),e>this.maxProj[5]&&(this.maxProj[5]=e,n[5]=t),e=i[t]-i[t+1]-i[t+2],e<this.minProj[6]&&(this.minProj[6]=e,r[6]=t),e>this.maxProj[6]&&(this.maxProj[6]=e,n[6]=t)}for(let t=0;t<7;++t){let e=r[t];W(this.minVert[t],i,e),e=n[t],W(this.maxVert[t],i,e)}}}class K{constructor(){this.b0=a.fromValues(1,0,0),this.b1=a.fromValues(0,1,0),this.b2=a.fromValues(0,0,1),this.quality=0}}function L(t){return t[0]*t[1]+t[0]*t[2]+t[1]*t[2]}function Q(t,e,r){t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2]}function R(t,e,r){t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2]}function U(t,e,r){t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r}function W(t,e,r=0){t[0]=e[r],t[1]=e[r+1],t[2]=e[r+2]}function X(t,e,r){const n=e[0],i=e[1],a=e[2],o=r[0],c=r[1],s=r[2];t[0]=i*s-a*c,t[1]=a*o-n*s,t[2]=n*c-i*o}function Z(t,e){const r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){const n=1/Math.sqrt(r);t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}}function $(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}function tt(t,e){const r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return r*r+n*n+i*i}function et(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}t.computeOBB=function(t,e){const{data:r,size:n}=t,i=r.length/n;if(i<=0)return;const N=new J(t);Q(s,N.minProj,N.maxProj),U(s,s,.5),R(f,N.maxProj,N.minProj);const y=L(f),d=new K;d.quality=y,i<14&&(t=new o.Vertices(new Float64Array(N.buffer,112,42),3));const w=a.create(),A=a.create(),g=a.create(),M=a.create(),F=a.create(),E=a.create(),z=a.create();switch(function(t,e,r,n,i,a,o,s,f,u){if(function(t,e,r){let n=tt(t.maxVert[0],t.minVert[0]),i=0;for(let e=1;e<7;++e){const r=tt(t.maxVert[e],t.minVert[e]);r>n&&(n=r,i=e)}W(e,t.minVert[i]),W(r,t.maxVert[i])}(t,n,i),tt(n,i)<c)return 1;R(o,n,i),Z(o,o);const h=function(t,e,r,n){const{data:i,size:a}=t;let o=Number.NEGATIVE_INFINITY,c=0;for(let t=0;t<i.length;t+=a){I[0]=i[t]-e[0],I[1]=i[t+1]-e[1],I[2]=i[t+2]-e[2];const n=r[0]*I[0]+r[1]*I[1]+r[2]*I[2],a=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],s=I[0]*I[0]+I[1]*I[1]+I[2]*I[2]-n*n/a;s>o&&(o=s,c=t)}return W(n,i,c),o}(e,n,o,a);return h<c?2:(R(s,i,a),Z(s,s),R(f,a,n),Z(f,f),X(r,s,o),Z(r,r),T(e,r,o,s,f,u),0)}(N,t,z,w,A,g,M,F,E,d)){case 1:return void v(s,f,e);case 2:return void O(t,M,e)}!function(t,e,r,n,i,a,o,s,f){(function(t,e,r,n,i){!function(t,e,r,n,i){const{data:a,size:o}=t;W(n,a),W(i,n),r[0]=et(q,e),r[1]=r[0];for(let t=o;t<a.length;t+=o){const o=a[t]*e[0]+a[t+1]*e[1]+a[t+2]*e[2];o<r[0]&&(r[0]=o,W(n,a,t)),o>r[1]&&(r[1]=o,W(i,a,t))}}(t,e,V,i,n);const a=et(r,e);V[1]-c<=a&&(n[0]=void 0),V[0]+c>=a&&(i[0]=void 0)})(t,e,r,u,h),void 0!==u[0]&&(R(m,u,r),Z(m,m),R(l,u,n),Z(l,l),R(P,u,i),Z(P,P),X(b,l,a),Z(b,b),X(j,P,o),Z(j,j),X(x,m,s),Z(x,x),T(t,b,a,l,m,f),T(t,j,o,P,l,f),T(t,x,s,m,P,f)),void 0!==h[0]&&(R(m,h,r),Z(m,m),R(l,h,n),Z(l,l),R(P,h,i),Z(P,P),X(b,l,a),Z(b,b),X(j,P,o),Z(j,j),X(x,m,s),Z(x,x),T(t,b,a,l,m,f),T(t,j,o,P,l,f),T(t,x,s,m,P,f))}(t,z,w,A,g,M,F,E,d),p(t,d.b0,d.b1,d.b2,S,Y);const _=a.create();R(_,Y,S),d.quality=L(_),d.quality<y?H(d.b0,d.b1,d.b2,S,Y,_,e):v(s,f,e)},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});