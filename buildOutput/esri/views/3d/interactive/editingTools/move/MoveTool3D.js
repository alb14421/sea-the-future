// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/arrayUtils","../../../../../core/Collection","../../../../../core/Evented","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/quantityUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/ensureType","../../../../../core/has","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/support/UpdatingHandles","../../../../../geometry/Point","../../../../../layers/graphics/dehydratedPoint","../../../../../support/elevationInfoUtils","../../SnappingVisualizer3D","../geometryUtils","../manipulatedObjectUtils","../manipulatorUtils","../meshFastUpdateUtils","../tooltipUtils3D","../visualElementUtils","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","../manipulations/MoveXYObjectManipulation","./isSupportedObject","../../visualElements/OutlineVisualElement","../../../../interactive/dragEventPipeline","../../../../interactive/InteractiveToolBase","../../../../interactive/editGeometry/EditGeometryOperations","../../../../interactive/sketch/SketchOptions","../../../../interactive/snapping/SnappingContext","../../../../interactive/snapping/SnappingDragPipelineStep","../../../../interactive/tooltip/tooltipCommonUtils","../../../../interactive/tooltip/infos/MovePointTooltipInfo","../../../../interactive/tooltip/infos/TranslateTooltipInfo","../../../../interactive/tooltip/infos/TranslateXYTooltipInfo","../../../../interactive/tooltip/infos/TranslateZTooltipInfo","../../../../support/euclideanLengthMeasurementUtils"],function(t,e,o,i,n,s,a,l,p,r,c,h,u,d,v,m,f,M,_,g,y,b,T,w,j,I,S,O,E,D,x,P,U,k,H,z,R,A,X,Y,C,V){"use strict";class Z{constructor(t){this.objects=t,this.type="move-start"}}class G{constructor(t,e,o){this.dx=t,this.dy=e,this.objects=o,this.type="move"}}class F{constructor(t){this.objects=t,this.type="move-stop"}}const B=Symbol("manipulators"),L=Symbol("tooltips");t.MoveTool3D=class extends P.InteractiveToolBase{constructor(t){super(t),this._infos=new Map,this.events=new n.EventEmitter,this.objects=new i,this.enableZ=!0,this.sketchOptions=new k,this.type="move-3d",this._latestTooltipInfo=null,this._translateTooltipInfo=null,this._translateXYTooltipInfo=null,this._translateZTooltipInfo=null,this._updatingHandles=new d.UpdatingHandles,this._moveManipulation=null}initialize(){const{view:t}=this;this.tooltip=R.makeTooltip(()=>({view:t,options:this.sketchOptions.tooltips})),this.addHandles([this.objects.on("change",t=>{t.removed.forEach(t=>this.removeHandles(t)),this._updateObjectInfos(t),this._setupFastTransformUpdates(t.added),this._refreshManipulators()}),this.objects.on("change",()=>this._connectTooltips())]);const e=this.objects.toArray();this._updateObjectInfos({added:e,removed:[]}),this._setupFastTransformUpdates(e),this._refreshManipulators(),this._connectTooltips(),this.finishToolCreation()}destroy(){this.tooltip=a.destroyMaybe(this.tooltip),this._moveManipulation=a.destroyMaybe(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}onInputEvent(t){if(!this.destroyed&&!R.enterInputModeIfAvailable(t,this.tooltip))return super.onInputEvent(t)}get updating(){return this._updatingHandles.updating}get _shouldShowMovePointTooltip(){const{objects:t}=this;if(1!==t.length)return!1;const e=g.manipulatedObjectGeometry(t.at(0))?.type;return"point"===e||"mesh"===e}get activeTooltipInfo(){return this._shouldShowMovePointTooltip?this._movePointTooltipInfo:this._latestTooltipInfo}reset(){}_updateObjectInfos({added:t,removed:e}){for(const e of t){if(0!==E.isSupportedObject(e))continue;const t=new q(e);this._infos.set(e,t)}for(const t of e)this._infos.delete(t)}_setupFastTransformUpdates(t){for(const e of t){const t=this._infos.get(e);this.addHandles(b.meshTransformFastUpdateHandles(t.object),e)}}_refreshManipulators(){if(this.removeHandles(B),this._moveManipulation=a.destroyMaybe(this._moveManipulation),this.manipulators.removeAll(),0===this._infos.size)return;const t=Array.from(this._infos.values());this._createManipulators(t),this._createVisualElements(t),this._updateMoveManipulation(t)}_createManipulators(t){for(const e of t){const o=e.object;e.manipulationXY=new O.MoveXYObjectManipulation({tool:this,view:this.view,object:o}),e.manipulationXY.forEachManipulator(t=>{this.addHandles([t.events.on("immediate-click",t=>{this.events.emit("immediate-click",{...t,object:o}),t.stopPropagation()}),t.events.on("grab-changed",({action:t})=>{"start"===t?this._showTooltip(0):this._hideTooltip()})],B)}),this.addHandles(e.manipulationXY.createDragPipeline((e,o,i,n)=>this._buildDragEventPipeline(t,0,e,o,i,n)),B)}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new I.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?I.MoveManipulation.radiusForSymbol(t[0].object.graphic?.symbol):j.discRadius});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator(t=>{this.addHandles(t.events.on("immediate-click",o=>{const i=this.objects.at(0);!e.zManipulation.hasManipulator(t)&&1===this.objects.length&&i&&this.events.emit("immediate-click",{...o,object:i}),o.stopPropagation()}),B)});const o=t=>e=>{this.addHandles([e.events.on("focus-changed",({action:e})=>{"focus"===e?this._showTooltip(t):this._hideTooltip()}),e.events.on("grab-changed",()=>{this._latestTooltipInfo&&(this._latestTooltipInfo.distance=l.zeroMeters)})],B)};this._moveManipulation.xyManipulation.forEachManipulator(o(0)),this._moveManipulation.xyAxisManipulation.forEachManipulator(o(1)),this._moveManipulation.zManipulation.forEachManipulator(o(2));const i=()=>this._updateMoveManipulation(t);for(const e of t)this.addHandles([e.object.on("committed",i),p.watch(()=>e.object.visible,i)],B);const n=t[t.length-1];this.addHandles(n.object.on("committed",()=>this._updateMoveManipulationAngle(n)),B);const{object:s}=n,{operations:a}=s;if(a){const o=s.graphic;this.addHandles(e.createDragPipeline((e,o,i,n,s)=>this._buildDragEventPipeline(t,e,o,i,n,s),s.elevationInfo,a.data.spatialReference,o),B)}this._updateMoveManipulationAngle(n)}_createVisualElements(t){for(const e of t){const o=e.object,i=w.createVisualElements({view:this.view,object:o,forEachManipulator:t=>{e.manipulationXY?.forEachManipulator(t),this._moveManipulation?.forEachManipulator(t)},onManipulatorsChanged:()=>s.makeHandle()});null!=i&&(e.geometryRepresentation=i.visualElement,e.geometryRepresentation instanceof D.OutlineVisualElement&&this.addHandles([e.geometryRepresentation.events.on("attachment-origin-changed",()=>{e.object.isDraped||this._updateMoveManipulation(t)}),p.watch(()=>e.object.isDraped,()=>this._updateMoveManipulation(t))],B),this.addHandles(i,B))}}_updateMoveManipulationAngle(t){this._moveManipulation&&(this._moveManipulation.angle=_.orientation(g.manipulatedObjectGeometry(t.object)))}_updateMoveManipulation(t){const e=m.makeDehydratedPoint(0,0,0,this.view.spatialReference);let o=0,i=!1;const n=this._moveManipulation;if(n){for(const n of t){if(!n.object.visible)continue;this.enableZ&&y.canMoveZOperations(n.object.operations,n.object.elevationInfo)&&(i=!0);const t=n.geometryRepresentation instanceof D.OutlineVisualElement&&!n.object.isDraped?n.geometryRepresentation.attachmentOrigin:n.object.origin;if(null!=t){const{x:i,y:n,z:s}=t;e.x+=i,e.y+=n,s&&(e.z??=0,e.z+=s),o++}}o>0?(e.x/=o,e.y/=o,e.z??=0,e.z/=o,n.location=e,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=i):n.available=!1}}_buildDragEventPipeline(t,e,o,i,n,s){const a=[],l=[];let p=null,r=null;const c=()=>{for(const t of a)t.dragging=!1;a.length=0,l.length=0,p=null,r=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===t.length&&0===e){const e=t[0].object;({steps:i,cancel:n}=this._buildSnappingPipelineSteps(e,e.elevationInfo,i,n,s))}return n=n.next(t=>r?.(t)).next(()=>(l.length&&this.events.emit("move-stop",new F(l)),this.destroyed||c(),null)),{steps:i=i.next(e=>{if("start"===e.action){a.length=0,l.length=0;for(const e of t)e.dragging||!e.manipulationXY?.hasManipulator(o)&&e.manipulationXY?.grabbing||(a.push(e),l.push(e.object),e.dragging=!0);if(0!==l.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),p=x.dragManipulatedObjectMany(l),r=x.resetManipulatedObjectMany(l),this._emitRecordUndo(),this.events.emit("move-start",new Z(l)),this.destroyed))return null}return 0!==l.length?e:null}).next(t=>p?.(t)).next(t=>(this._updateMoveTooltip(e,t),t)).next(t=>{switch(t.action){case"start":case"update":if(t.translationX||t.translationY||t.translationZ){const e=this.view.toScreen(t.mapStart),o=this.view.toScreen(t.mapEnd);if(!e||!o)return null;const i=o.x-e.x,n=o.y-e.y;if(this.events.emit("move",new G(i,n,l)),this.destroyed)return null}break;case"end":if(this.events.emit("move-stop",new F(l)),this.destroyed)return null;c()}return null}),cancel:n}}_connectTooltips(){let t;if(this.removeHandles(L),this._shouldShowMovePointTooltip){const e=this.objects.at(0),{events:o}=this;this._movePointTooltipInfo??=new A.MovePointTooltipInfo({viewType:this.view.type,sketchOptions:this.sketchOptions});const i={onBeforeUpdate:()=>this.endDrag(),onMoveStart:()=>{this._emitRecordUndo(),o.emit("move-start",new Z([e]))},onMove:()=>o.emit("move",new G(0,0,[e])),onMoveStop:()=>o.emit("move-stop",new F([e])),onRotateStart:()=>{},onRotate:()=>{},onRotateStop:()=>{},onScaleStart:()=>{},onScale:()=>{},onScaleStop:()=>{}};t=T.connectTooltipToManipulatedObject(this.tooltip,e,()=>({sketchOptions:this.sketchOptions,activeTooltipInfo:this._movePointTooltipInfo,callbacks:i}))}else t=p.watch(()=>this.sketchOptions.tooltips.effectiveEnabled?this._latestTooltipInfo:null,t=>{this.tooltip.info=t},p.syncAndInitial);this.addHandles(t,L)}_showTooltip(t){this._shouldShowMovePointTooltip||this._updateMoveTooltip(t)}_hideTooltip(){this._shouldShowMovePointTooltip||(this.tooltip?.clear(),this._latestTooltipInfo=null)}_updateMoveTooltip(t,e){if(this._shouldShowMovePointTooltip)return;const{sketchOptions:o,autoLengthMeasurementUtils:i}=this;switch(t){case 0:this._latestTooltipInfo=this._translateTooltipInfo??=new X.TranslateTooltipInfo({sketchOptions:o}),J(this._latestTooltipInfo,e,(t,e)=>i.autoDistanceBetweenPoints2D(N(t),N(e)));break;case 1:this._latestTooltipInfo=this._translateXYTooltipInfo??=new Y.TranslateXYTooltipInfo({sketchOptions:o}),J(this._latestTooltipInfo,e,(t,o)=>l.scale(i.autoDistanceBetweenPoints2D(N(t),N(o)),S.axisConstrainedDragSign(e)));break;case 2:this._latestTooltipInfo=this._translateZTooltipInfo??=new C.TranslateZTooltipInfo({sketchOptions:o}),J(this._latestTooltipInfo,e,V.verticalSignedDistanceBetweenPoints)}this._latestTooltipInfo.sketchOptions=o}_emitRecordUndo(){const t=this.objects.toArray().map(t=>t.createUndoRecord?.()).filter(o.isSome);t.length>0&&this.events.emit("record-undo",{updates:t})}_buildSnappingPipelineSteps(t,e,o,i,n){const s=g.manipulatedObjectGeometry(t);if(null==s||"point"!==s.type&&"mesh"!==s.type)return{steps:o,cancel:i};const a=("point"===s.type?s:s.origin).clone(),l=new H.SnappingContext({elevationInfo:e,pointer:n,editGeometryOperations:U.EditGeometryOperations.fromGeometry(a,this.view.state.viewingMode),visualizer:new M.SnappingVisualizer3D,excludeFeature:t.graphic}),p=this.snappingManager,{snappingStep:r,cancelSnapping:c}=z.createSnapDragEventPipelineStep({snappingContext:l,snappingManager:p,updatingHandles:this._updatingHandles});return i=i.next(c),{steps:o=o.next(e=>(a.z=f.getConvertedElevation(this.view,a,t.elevationInfo,{mode:"absolute-height",offset:0}),{...e,snapOrigin:l.coordinateHelper.pointToVector(a)})).next(...r),cancel:i}}},e.__decorate([r.property({constructOnly:!0,nonNullable:!0})],t.MoveTool3D.prototype,"view",void 0),e.__decorate([r.property({constructOnly:!0})],t.MoveTool3D.prototype,"autoLengthMeasurementUtils",void 0),e.__decorate([r.property()],t.MoveTool3D.prototype,"objects",void 0),e.__decorate([r.property({constructOnly:!0,nonNullable:!0})],t.MoveTool3D.prototype,"enableZ",void 0),e.__decorate([r.property({constructOnly:!0,type:k})],t.MoveTool3D.prototype,"sketchOptions",void 0),e.__decorate([r.property({constructOnly:!0})],t.MoveTool3D.prototype,"snappingManager",void 0),e.__decorate([r.property()],t.MoveTool3D.prototype,"type",void 0),e.__decorate([r.property()],t.MoveTool3D.prototype,"updating",null),e.__decorate([r.property()],t.MoveTool3D.prototype,"_latestTooltipInfo",void 0),e.__decorate([r.property()],t.MoveTool3D.prototype,"_shouldShowMovePointTooltip",null),e.__decorate([r.property()],t.MoveTool3D.prototype,"activeTooltipInfo",null),t.MoveTool3D=e.__decorate([u.subclass("esri.views.3d.interactive.editingTools.move.MoveTool3D")],t.MoveTool3D);const N=c.ensureType(v);class q{constructor(t){this.object=t,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1}}function J(t,e,o){if(null==e||"end"===e.action)return void(t.distance=l.zeroMeters);const{mapStart:i,mapEnd:n}=e,s=o(i,n);t.distance=null!=s?s:l.zeroMeters}t.MoveEvent=G,t.MoveStartEvent=Z,t.MoveStopEvent=F,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});