// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/reactiveUtils","../../../../core/signal","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectPointToVector","../../../../geometry/projection/projectVectorToVector","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../support/elevationInfoUtils","./manipulatedObjectUtils","./ManipulatorState","./settings","../visualElements/ExtendedLineVisualElement","../visualElements/LaserlineVisualElement","../visualElements/PointVisualElement","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext"],function(e,t,n,i,o,a,l,s,r,c,u,p,d,h,v,m,f,g,y,E){"use strict";function b(e){return null==e?null:"point"===e.type?e:"mesh"===e.type?e.origin.clone():null}const w=l.create(),j=c.create();e.createVisualElements=function(e){const l=[],V=function(e,n){const{view:o,object:a}=e,l=new g.PointVisualElement({view:o,geometry:b(d.manipulatedObjectGeometry(a)),elevationInfo:a.elevationInfo,isDecoration:!0});return function(e,n,o){const{view:a,object:l}=e,r=new v.Settings({getTheme:()=>a.effectiveTheme});(function(e,n,i){const{view:o,object:a}=e;let l=null;const r=()=>{const e=b(d.manipulatedObjectGeometry(a));null!=e&&p.featureExpressionInfoIsZero(a.elevationInfo)&&(e.z=0),(e=>{null!=l&&(l.remove(),l=null),a.isDraped&&null!=e&&(l=function(t,i){const o=t.elevationProvider.spatialReference;s.projectPointToVector(i,w,o);const a=w[0],l=w[1];return t.elevationProvider.on("elevation-change",t=>{u.containsXY(t.extent,a,l)&&(n.geometry=e)})}(o,e))})(e),n.geometry=e};i.push(a.on("committed",r),t.refHandle(()=>l)),r()})(e,n,o),r.visualElements.pointObjects.outline.apply(n),o.push(i.watch(()=>l.visible,()=>{n.attached=l.visible},i.initial))}(e,l,n),n.push(t.destroyHandle(l)),l}(e,l);return function(e,l,s){const{view:u,object:g}=e,V=new v.Settings({getTheme:()=>u.effectiveTheme}),x=new m.ExtendedLineVisualElement({view:u,extensionType:V.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0});l.push(i.watch(()=>V.visualElements.zVerticalLine,e=>e.apply(x),i.initial));const P=new f.LaserlineVisualElement({view:u,intersectsLineInfinite:!0,attached:!1,isDecoration:!0}),T=n.deg2rad(V.visualElements.heightPlaneAngleCutoff),I=new f.LaserlineVisualElement({view:u,attached:!1,angleCutoff:T,isDecoration:!0}),S=g.elevationInfo,L=E.ElevationContext.fromElevationInfo(S),D="on-the-ground"===S.mode||!S.offset&&"absolute-height"!==S.mode,H=new h.ManipulatorState,M=o.signal(1);l.push(i.watch(()=>({heightPlane:V.visualElements.heightPlane,alpha:M.value}),({heightPlane:e,alpha:t})=>e.apply(I,t),i.initial));const A=o.signal(1);l.push(i.watch(()=>({shadowStyle:V.visualElements.pointObjects.shadowStyle,alpha:A.value}),({shadowStyle:e,alpha:t})=>e.apply(P,t),i.initial));const O=()=>{H.update(e);let t=b(d.manipulatedObjectGeometry(g));const n=D&&(g.isDraped||null==t||!t.hasZ);let i=!0;if(n||null==t)i=!1;else{p.featureExpressionInfoIsZero(g.elevationInfo)&&(t=t.clone(),t.z=0);const e=y.evaluateElevationAlignmentAtPoint(t,u.elevationProvider,L,u.renderCoordsHelper);a.set(w,t.x,t.y,e),r.projectVectorToVector(w,t.spatialReference,w,u.renderCoordsHelper.spatialReference),x.setStartEndFromWorldDownAtLocation(w),P.intersectsWorldUpAtLocation=w}const o=2&H.grabbingState?V.visualElements.laserlineAlphaMultiplier:1;M.value=o;const l=c.empty(j);!n&&g.visible&&s.calculateMapBounds(l)&&r.projectVectorToVector(c.getMin(l,w),u.spatialReference,w,u.renderCoordsHelper.spatialReference)?(I.heightManifoldTarget=w,I.attached=!0):I.attached=!1;const h=4&H.grabbingState?V.visualElements.laserlineAlphaMultiplier:1;A.value=h;const v=i&&g.visible&&!n;P.attached=v,x.attached=v};l.push(i.watch(()=>[g.visible,g.isDraped],O),g.on("committed",O)),e.forEachManipulator(e=>{l.push(e.events.on("grab-changed",O))}),l.push(t.destroyHandle(P)),l.push(t.destroyHandle(x)),l.push(t.destroyHandle(I)),O()}(e,l,V),{visualElement:V,remove:()=>t.removeHandles(l)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});