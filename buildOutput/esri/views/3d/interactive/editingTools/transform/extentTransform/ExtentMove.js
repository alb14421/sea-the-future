// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/handleUtils","../../../../../../core/quantityUtils","../../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../geometry/support/vectorStacks","../../../../analysis/Slice/ShiftManipulator","../../../../analysis/Slice/sliceToolUtils","../../dragEventPipeline3D","../../manipulations/MoveXYObjectManipulation","../../../../../interactive/dragEventPipeline","../../../../../interactive/tooltip/infos/TranslateTooltipInfo","../../../../../interactive/tooltip/infos/TranslateZTooltipInfo","../../../../../support/euclideanLengthMeasurementUtils"],function(t,e,o,n,i,a,s,r,l,c,p,u,d,h,m){"use strict";t.ExtentMove=class{get _object(){return this._tool.object}get _operations(){return this._object.operations}constructor(t,e,o){this._tool=t,this._bounds=e,this._automaticLengthMeasurementUtils=o,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;const n=this._tool,i=n.view;this.moveXYObjectManipulation=new p.MoveXYObjectManipulation({view:i,tool:n,object:this._object}),n.addHandles(this._createMoveXYObjectDragPipeline()),this.moveZManipulator=new r.ShiftManipulator(i,0),this.moveZManipulator.state|=l.IsShiftEdgeOnScreenFlag,n.manipulators.add(this.moveZManipulator),n.addHandles(this._createMoveZDragPipeline()),n.addHandles(n.events.on("translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null}))}destroy(){this.moveXYObjectManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(t){this.moveXYObjectManipulation.forEachManipulator(t),t(this.moveZManipulator,0)}updateManipulators(t,e){const o=this.moveZManipulator,a=n.rotateZ(s.sm4d.get(),t,Math.PI);a[12]=0,a[13]=0,a[14]=0,o.modelTransform=a,o.renderLocation=i.subtract(s.sv3d.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.moveXYObjectManipulation.grabbing||this.moveXYObjectManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){const t=this._tool,e=this._moveXYTooltipInfo??=new d.TranslateTooltipInfo({sketchOptions:t.sketchOptions});if(this.moveXYObjectManipulation.dragging){const o=this._bounds,n=o.mapBoundsStart.origin,i=o.mapBounds.origin,{renderSpatialReference:a}=t.view;if(!a)return null;const s=this._automaticLengthMeasurementUtils.autoDistance2D(n,i,a);if(null==s)return null;e.distance=s}else e.distance=o.zeroMeters;return e}_computeMoveZTooltipInfo(){const t=this._tool,e=this._moveZTooltipInfo??=new h.TranslateZTooltipInfo({sketchOptions:t.sketchOptions});if(this.moveZManipulator.dragging){const o=this._bounds,n=o.mapBoundsStart.origin,i=o.mapBounds.origin,{renderSpatialReference:a}=t.view;if(!a)return null;const s=m.verticalSignedDistance(n,i,a);if(null==s)return null;e.distance=s}else e.distance=o.zeroMeters;return e}_createMoveXYObjectDragPipeline(){return this.moveXYObjectManipulation.createDragPipeline((t,e,o)=>this._buildMoveDragPipeline(e,o))}_createMoveZDragPipeline(){if(!this._operations)return e.makeHandle();const t=this._operations.data.spatialReference;return u.createManipulatorDragEventPipeline(this.moveZManipulator,(e,o,n)=>{const i=a.clone(e.renderLocation),s=o.next(c.screenToZConstrained(this._tool.view,i,t)).next(u.addScreenDelta());this._buildMoveDragPipeline(s,n)})}_buildMoveDragPipeline(t,e){const{_tool:o,_object:n}=this;t.next(t=>("start"===t.action&&(o.inputState={type:"move"},this._bounds.backupMapBounds(),o.events.emit("translate-start",{object:n,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY})),t)).next(u.addMapDelta()).next(this._updateGeometry()).next(t=>{const e={object:n,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY};switch(t.action){case"start":case"update":(t.mapEnd.x-t.mapStart.x||t.mapEnd.y-t.mapStart.y||(t.mapEnd.z??0)-(t.mapStart.z??0))&&o.events.emit("translate",e);break;case"end":o.inputState=null,o.events.emit("translate-stop",e)}return t}),e.next(()=>{null!=o.inputState&&o.events.emit("translate-stop",{object:n,dxScreen:0,dyScreen:0}),o.cancelDrag()})}_updateGeometry(){const t=this._tool;return e=>{if(null==t.inputState||"move"!==t.inputState.type)return e;const o="start"===e.action?0:1;if(this._operations){const t=this._operations.move(e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,o);this._bounds.updateMapBoundsFromOperation(t)}return e}}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});