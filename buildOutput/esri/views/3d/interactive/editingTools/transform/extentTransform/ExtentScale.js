// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../chunks/boundedPlane","../../../../../../geometry/support/plane","../../../../../../geometry/support/vectorStacks","../../../../analysis/Slice/ResizeManipulator","../../../../analysis/Slice/sliceToolUtils","../../dragEventPipeline3D","./extentUtils","../../../../support/geometryUtils/ray","../../../../../interactive/dragEventPipeline","../../../../../interactive/tooltip/infos/ExtentScaleTooltipInfo"],function(t,e,a,s,i,n,o,r,c,l,d,p,u,h,_){"use strict";const S=1e-6;t.ExtentScale=class{get _object(){return this._tool.object}get _operations(){return this._object.operations}get zMax(){if(!this._zMaxDirty||!this._operations)return this._zMax;const t=this._operations.data;if(t.geometry.hasZ){const e=t.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(const a of t.parts)for(const t of a.vertices){const a=e.getZ(t.pos)??0;this._zMax=Math.max(a,this._zMax)}}else this._zMax=0;return this._zMaxDirty=!1,this._zMax}constructor(t,e,a){this._tool=t,this._bounds=e,this._preserveAspectRatioStep=a,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._displayBoundsStart=n.create(),this._displayBoundsMarginStart=0,this._zMax=0,this._zMaxDirty=!0;const s=this._tool,i=s.view;this.resizeManipulators=this._resizeHandles.map(t=>{const e=new c.ResizeManipulator(i,t);return s.addHandles([e.events.on("grab-changed",t=>this._onGrabChanged(t)),this._createResizeDragPipeline(e,t)]),e}),s.manipulators.addMany(this.resizeManipulators),this._operations&&s.addHandles(this._operations.data.on("change",()=>{"resize"!==s.inputState?.type&&(this._zMaxDirty=!0)}))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){this.resizeManipulators.forEach(e=>t(e,2))}updateManipulators(t,e){this.resizeManipulators.forEach((a,s)=>{l.updateResizeHandle(a,this._resizeHandles[s],t,e)})}getUpdatedTooltipInfo(){if(!this.resizeManipulators.some(t=>t.focused))return null;const t=this._tooltipInfo??=new _.ExtentScaleTooltipInfo({sketchOptions:this._tool.sketchOptions}),e=p.mapPlaneAutoSize2D(this._bounds.mapBounds,this.zMax,this._bounds.spatialReference,this._tool.automaticLengthMeasurementUtils);return e&&(t.xSize=e.xSize,t.ySize=e.ySize),this.resizeManipulators.some(t=>t.dragging)||(t.xScale=1,t.yScale=1),t}_onGrabChanged({action:t,screenPoint:e}){const a=this._tool,s=this._bounds;if("start"!==t||!e)return;const i=u.fromScreenNormalized(a.view.state.camera,e);o.intersectRay(s.displayBounds.plane,i,r.sv3d.get())&&(s.backupMapBounds(),n.copy(s.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=s.displayBoundsMargin,a.inputState={type:"resize"})}_createResizeDragPipeline(t,e){const{_tool:a,_object:s}=this;return h.createManipulatorDragEventPipeline(t,(t,i,n)=>{null!=a.inputState&&(i.next(t=>("start"===t.action&&a.events.emit("scale-start",{object:s,xScale:1,yScale:1}),{...t,handle:e})).next(d.screenToRenderPlane(a.view,this._displayBoundsStart.plane)).next(this._renderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._updateGeometry()).next(t=>{const e=this._tooltipInfo;e&&(e.xScale=t.factor1,e.yScale=t.factor2);const i={object:s,xScale:t.factor1,yScale:t.factor2};switch(t.action){case"start":case"update":a.events.emit("scale",i);break;case"end":a.inputState=null,a.events.emit("scale-stop",i)}return t}),n.next(()=>{null!=a.inputState&&a.events.emit("scale-stop",{object:s,xScale:1,yScale:1}),a.cancelDrag()}))})}_renderPlaneToFactors(){const t=this._bounds;return e=>{const a=this._displayBoundsStart,i=e.handle.direction,n=t.displayBoundsMargin,o=this._displayBoundsMarginStart,c=s.copy(r.sv3d.get(),a.origin);s.scaleAndAdd(c,c,a.basis1,-i[0]),s.scaleAndAdd(c,c,a.basis2,-i[1]);const d=s.subtract(r.sv3d.get(),e.renderEnd,c),p=s.subtract(r.sv3d.get(),e.renderStart,c),u=l.isDiagonalResizeHandle(e.handle),h=l.calculateDiagonalResizeHandleScale(a),_=l.calculateDiagonalResizeHandleScale(t.displayBounds)/h,g=(t,e)=>{if(0===t)return 1;let a=s.length(e),i=.5*t*s.dot(e,d)/a;const r=i<0?-1:1;u&&(i+=(a-.5*t*s.dot(e,p)/a)*r*_);const c=a<1.5*o?1:S;return a=Math.max(a-o,S),r>0&&(i-=n),r*Math.max(r*(i/a),c)};return{...e,factor1:g(i[0],a.basis1),factor2:g(i[1],a.basis2)}}}_updateGeometry(){const t=this._bounds;return o=>{const r=s.copy(i.create(),t.mapBoundsStart.origin);s.scaleAndAdd(r,r,t.mapBoundsStart.basis1,-o.handle.direction[0]),s.scaleAndAdd(r,r,t.mapBoundsStart.basis2,-o.handle.direction[1]);const c=e.set(a.create(),t.mapBoundsStart.basis1[0],t.mapBoundsStart.basis1[1]);e.normalize(c,c);const l="start"===o.action?0:1;if(this._operations){const e=this._operations.scale(r,c,o.factor1,o.factor2,l,1);n.copy(t.mapBoundsStart,t.mapBounds),t.updateMapBoundsFromOperation(e)}return o}}},t.scaleEpsilon=S,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});