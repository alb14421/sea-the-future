// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/colorUtils","../../../../../core/Cyclical","../../../../../core/Evented","../../../../../core/has","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/scheduling","../../../../../core/screenUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/plane","../../../../../geometry/support/ray","../../../../../geometry/support/vectorStacks","../../Manipulator3D","../../manipulatorUtils","../../RenderObject","../dragEventPipeline3D","../manipulations/config","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/materials/ColorMaterial","../../../../interactive/dragEventPipeline"],function(t,e,a,r,i,n,o,s,c,l,d,h,u,g,p,m,_,f,v,b,M,D,S,R,y,T,w,A,I,P,j){"use strict";function k(t,e,a){return e.projectToScreen(t,E),v.set(a,E[0],E[1],0)}function O(t,e){let a=null,r=1;const i=()=>r;return{start:()=>{r=t.getScale(),a=t.getScale,t.getScale=i,e()},update:t=>(r+=((r+1)/2-r)*Math.min(t*A.ringResetAnimationSpeedFactor,1),e(),Math.abs(r-1)<.01?1:0),destroy:()=>{a&&(t.getScale=a),e()}}}t.ScaleRotateTransform=class extends a{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}get updating(){return!!this._activeAnimation}constructor(t){super(t),this.mode=null,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=A.ringIndicatorDelayMs,this.events=new n.EventEmitter,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>"scale"===this._scaleRotateDragData?.mode?this.adapter.scale:1}initialize(){this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this.addHandles([l.watch(()=>{const{adapter:t}=this;return[t.angle,t.scale]},()=>this._updateManipulatorTransform())])}destroy(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=null,this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null}startAnimation(t){this.cancelActiveAnimation(),t.start();const e=d.addFrameTask({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=c.destroyMaybe(this._activeAnimation)}forEachManipulator(t){t(this._ringManipulator,4)}_createManipulator(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const e=this.tool.object,a=j.createManipulatorDragEventPipeline(t,(t,a,r)=>{this._scaleRotateDragData=null;const n=this.adapter.startInteraction(),o={mode:"none",origin:b.clone(t.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=o,this._updateDragState();const c=S.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(t.renderLocation,c),a.next(w.screenToRenderPlane(this.tool.view,M.fromPositionAndNormal(t.renderLocation,c,M.create()))).next(t=>{const a=M.getNormal(t.plane),r=y.calculateInputRotationTransform(t.renderStart,t.renderEnd,o.origin,a),c=i.cyclicalPI.shortestSignedDiff(o.angle,r);o.angleDir=s.clamp(o.angleDir+c,-.3,A.rotateIndicatorDirectionBuffer),o.angle=r;const l=function(t,e){const a=v.subtract(S.sv3d.get(),e.renderStart,t.origin),r=v.subtract(S.sv3d.get(),e.renderEnd,t.origin),i=v.length(a),n=v.length(r);return 0===i?0:n/i}(o,t),d=l-this.adapter.scale;if(o.scaleDir=s.clamp(o.scaleDir+d,-.2,A.scaleIndicatorDirectionBuffer),this._onScaleChanged(),"none"===o.mode){const a=this.mode||function(t,e,a,r){const{renderStart:i,renderEnd:n}=t,o=k(i,r,S.sv3d.get()),s=k(n,r,S.sv3d.get());if(v.squaredDistance(o,s)<A.dragThresholdPx*A.dragThresholdPx)return null;const c=v.subtract(S.sv3d.get(),i,a),l=v.cross(S.sv3d.get(),c,M.getNormal(e)),d=i,h=v.add(S.sv3d.get(),d,l),u=k(a,r,S.sv3d.get()),g=o,p=k(h,r,S.sv3d.get()),m=v.subtract(S.sv3d.get(),p,g),_=v.subtract(S.sv3d.get(),o,u),f=D.wrap(g,m),b=D.wrap(u,_);return D.distance2(f,s)<D.distance2(b,s)?"rotate":"scale"}(t,t.plane,o.origin,this.tool.view.state.camera);if(null!=a){switch(a){case"rotate":this.tool.events.emit("rotate-start",{object:e,angle:0}),this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]});break;case"scale":this.tool.events.emit("scale-start",{object:e,xScale:1,yScale:1}),this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]})}o.mode=a}}switch(o.mode){case"rotate":n.state.angle=o.initialAngle+r;break;case"scale":n.state.scale=l,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),t.action){case"start":case"update":switch(o.mode){case"rotate":this.tool.events.emit("rotate",{object:e,angle:s.rad2deg(o.angle)});break;case"scale":this.tool.events.emit("scale",{object:e,xScale:l,yScale:l})}break;case"end":switch(o.mode){case"rotate":this.tool.events.emit("rotate-stop",{object:e,angle:s.rad2deg(o.angle)});break;case"scale":this.tool.events.emit("scale-stop",{object:e,xScale:l,yScale:l})}}return"end"===t.action&&(this.startAnimation(O(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),n.done()),t}),r.next(()=>{if(n.cancel(),null!=this._scaleRotateDragData){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.events.emit("rotate-stop",{object:e,angle:0});break;case"scale":this.tool.events.emit("scale-stop",{object:e,xScale:1,yScale:1})}this.startAnimation(O(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}})});this.addHandles([a,t.events.on("focus-changed",t=>{"focus"===t.action?this.startAnimation(function(t,e,a){let r=0,i=null;const n=()=>!1;return{start:()=>{i=t.getFocused,t.getFocused=n,r=0,e()},update:t=>(r+=t,!i?.()||r>=a.delayMs?1:0),destroy:()=>{i&&(t.getFocused=i),e()}}}(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),t.events.on("immediate-click",t=>{t.stopPropagation()}),l.watch(()=>this.tool.object.visible,t=>this._ringManipulator.available=t,l.initial)])}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(2048,this.getFocused())}_updateDragState(){if(this._ringManipulator.updateStateEnabled(1024,!(null!=this._scaleRotateDragData&&"none"!==this._scaleRotateDragData?.mode)),null!=this._scaleRotateDragData)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(96,!1),this._ringManipulator.updateStateEnabled(128,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(256,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(384,!1),this._ringManipulator.updateStateEnabled(32,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(64,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(480,!1)}_updateManipulatorTransform(){const t=_.fromRotation(S.sm4d.get(),this.adapter.angle,b.fromValues(0,0,1));if(null==t)return;const e=this.getScale(),a=_.fromScaling(S.sm4d.get(),v.set(S.sv3d.get(),e,e,e));this._ringManipulator.modelTransform=_.multiply(S.sm4d.get(),a,t)}_createRingManipulator(){const t=(t,e,a)=>{const r=[],i=Math.ceil(A.geometrySegments*(e-t)/(2*Math.PI));for(let n=0;n<i+1;n++){const o=t+n*(e-t)/i;r.push(b.fromValues(a*Math.cos(o),a*Math.sin(o),0))}return r},e=e=>t(0,2*Math.PI,e),a=this._createMaterial(1),r=(t,e,r=a)=>I.createPathExtrusionGeometry(r,(t=>[[-t/2,0],[t/2,0],[t/2,A.ringHeight/2],[-t/2,A.ringHeight/2]])(e),t,[],[],!1),i=e(A.ringRadius),n=r(i,A.ringThickness),o={left:new Array,right:new Array},s=[];for(let e=0;e<2;e++){const i=e*Math.PI-Math.PI/4,n=Math.PI/2-A.rotateIndicatorArcLength,c=i+n,l=i+Math.PI/2-n,d=t(c,l,A.innerIndicatorRadius),h=r(d,A.indicatorThickness);s.push(d),s.push(t(c,l,A.outerIndicatorRadius-A.ringThickness/2)),o.left.push(h),o.right.push(h.instantiate());for(let t=0;t<2;t++){const e=0===t,r=f.create();if(e){_.scale(r,r,[1,-1,1]),_.rotate(r,r,-c,[0,0,1]);const t=Math.round(A.rotateIndicatorArrowPlacementPercentage*(d.length-1));r[12]=d[t][0],r[13]=d[t][1],r[14]=d[t][2]}else{_.rotate(r,r,l,[0,0,1]);const t=Math.round((1-A.rotateIndicatorArrowPlacementPercentage)*(d.length-1));r[12]=d[t][0],r[13]=d[t][1],r[14]=d[t][2]}const i=I.createExtrudedTriangle(a,A.rotateIndicatorArrowTipLength,0,A.rotateIndicatorArrowTipRadius,A.ringHeight);I.transformInPlace(i,r),(e?o.left:o.right).push(i)}}const c=[];for(let e=0;e<2;e++){const a=e*Math.PI-Math.PI/4,i=Math.PI/2-A.scaleIndicatorArcLength,n=a+i,o=a+Math.PI/2-i,s=t(n,o,A.outerIndicatorRadius);c.push(r(s,A.indicatorThickness))}const l=this._createMaterial(.66),d=this._createMaterial(.5),h=this._createMaterial(.33),u=e(A.ringRadius+A.scaleIndicatorOffset1),g=e(A.ringRadius+A.scaleIndicatorOffset2),p=r(u,A.indicatorThickness,l),m=r(g,A.indicatorThickness,h),v=e(A.ringRadius-A.scaleIndicatorOffset1),M=e(A.ringRadius-A.scaleIndicatorOffset2),D=r(v,A.indicatorThickness,l),S=r(M,A.indicatorThickness,h);let y=[new T.RenderObject(n,2048),new T.RenderObject(n.instantiate({material:d}),0)];this.mode&&"scale"!==this.mode||(y=y.concat([...c.map(t=>new T.RenderObject(t,3072)),new T.RenderObject(p,2080),new T.RenderObject(m,2080),new T.RenderObject(D,2112),new T.RenderObject(S,2112)])),this.mode&&"rotate"!==this.mode||(y=y.concat([...o.right.map(t=>new T.RenderObject(t.instantiate(),3072)),...o.left.map(t=>new T.RenderObject(t,2176)),...o.right.map(t=>new T.RenderObject(t,2304))]));const w=[i,...s];return new R.Manipulator3D({view:this.tool.view,renderObjects:y,autoScaleRenderObjects:!1,worldOriented:!0,radius:A.ringThickness,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:this.tool.object.elevationInfo,collisionType:{type:"ribbon",paths:w,direction:b.fromValues(0,0,1)}})}_createMaterial(t){const e=new P.ColorMaterial({cullFace:2,renderOccluded:2,isDecoration:!0});return this.addHandles(l.watch(()=>r.multiplyOpacityToUnitRGBA(this.tool.view.effectiveTheme.accentColor,t),t=>e.setParameters({color:t}),l.initial)),e}get test(){}},e.__decorate([u.property({constructOnly:!0})],t.ScaleRotateTransform.prototype,"tool",void 0),e.__decorate([u.property({constructOnly:!0})],t.ScaleRotateTransform.prototype,"adapter",void 0),e.__decorate([u.property({constructOnly:!0})],t.ScaleRotateTransform.prototype,"sketchOptions",void 0),e.__decorate([u.property()],t.ScaleRotateTransform.prototype,"mode",void 0),e.__decorate([u.property()],t.ScaleRotateTransform.prototype,"_activeAnimation",void 0),e.__decorate([u.property()],t.ScaleRotateTransform.prototype,"updating",null),t.ScaleRotateTransform=e.__decorate([m.subclass("esri.views.3d.interactive.editingTools.transform.ScaleRotateTransform")],t.ScaleRotateTransform);const E=h.createScreenPointArray();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});