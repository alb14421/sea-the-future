// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/reactiveUtils","../../../../core/signal","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../Manipulator3D","./manipulatedObjectUtils","./ManipulatorState","./settings","../visualElements/ExtendedLineVisualElement","../visualElements/LaserlineVisualElement","../visualElements/OutlineVisualElement"],function(e,t,a,n,l,i,o,s,r,c,d,u,h,p){"use strict";function m(e){return null!=e&&("polygon"===e.type||"polyline"===e.type)}const v=o.create();e.createVisualElements=function(e){const{object:o}=e,g=function(e){const{view:a,object:l}=e,i=r.manipulatedObjectGeometry(l),o=new p.OutlineVisualElement({view:a,geometry:m(i)?i:null,elevationInfo:l.elevationInfo,attached:!1,isDecoration:!0}),s=new d.Settings({getTheme:()=>a.effectiveTheme}),c=()=>{o.attached=l.visible},u=t.handlesGroup([n.watch(()=>s.visualElements.lineObjects.outline,e=>e.apply(o),n.initial),n.watch(()=>s.visualElements.lineObjects.shadowStyle,e=>e.apply(o),n.initial),n.watch(()=>l.visible,c),n.watch(()=>l.isDraped,e=>{o.isDraped=e},n.initial),l.on("committed",()=>{const e=r.manipulatedObjectGeometry(l);o.geometry=m(e)?e:null}),t.destroyHandle(o)]);return c(),{visualElement:o,remove:()=>u.remove()}}(e),f=function(e,o){const{object:p,view:g}=e,f=[],b=p.elevationInfo,E="on-the-ground"===b.mode||!b.offset&&"absolute-height"!==b.mode,w=new c.ManipulatorState,y=new d.Settings({getTheme:()=>g.effectiveTheme}),S=y.visualElements,O=new u.ExtendedLineVisualElement({view:g,extensionType:S.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0}),M=a.deg2rad(S.heightPlaneAngleCutoff),j=new h.LaserlineVisualElement({view:g,attached:!1,angleCutoff:M,isDecoration:!0}),D=l.signal(1);f.push(n.watch(()=>({lineShadowStyle:y.visualElements.lineObjects.shadowStyle,pointShadowStyle:y.visualElements.pointObjects.shadowStyle,alpha:D.value}),({lineShadowStyle:e,pointShadowStyle:t,alpha:a})=>{e.apply(o,a),t.apply(O,a)},n.initial));const L=l.signal(1);f.push(n.watch(()=>({heightPlane:y.visualElements.heightPlane,alpha:L.value}),({heightPlane:e,alpha:t})=>e.apply(j,t),n.initial));const T=()=>{w.update(e);const t=r.manipulatedObjectGeometry(p);if(!p.visible||E&&(p.isDraped||!m(t)||!t.hasZ))return o.laserlineEnabled=!1,O.attached=!1,void(j.attached=!1);o.laserlineEnabled=!0;const a=4&w.grabbingState?S.laserlineAlphaMultiplier:1;D.value=a;const n=2&w.grabbingState?S.laserlineAlphaMultiplier:1;L.value=n,function(e,t){const a=1===t.numSelected?t.firstSelected:t.numSelected>1&&null!=t.firstGrabbedXY?t.firstGrabbedXY:null;null!=a?(e.setStartEndFromWorldDownAtLocation(a.renderLocation),e.attached=!0):e.attached=!1}(O,w),function(e,t,a,n){if(n.numSelected>0){i.set(v,0,0,0);let t=0;e.forEachManipulator((e,a)=>{1===a&&e.selected&&e instanceof s.Manipulator3D&&(i.add(v,v,e.renderLocation),t++)}),t>0?(a.heightManifoldTarget=i.scale(v,v,1/t),a.attached=!0):a.attached=!1}else{const n=t.attachmentOrigin;null!=n&&e.view.renderCoordsHelper.toRenderCoords(n,v)?(a.heightManifoldTarget=v,a.attached=!0):a.attached=!1}}(e,o,j,w)};f.push(n.watch(()=>y.visualElements.zVerticalLine,e=>e.apply(O),n.initial)),f.push(p.on("committed",T),n.watch(()=>p.visible,T),o.events.on("attachment-origin-changed",T),t.destroyHandle(O),t.destroyHandle(j));const V=[],G=()=>{t.removeHandles(V),V.length=0,e.forEachManipulator(e=>V.push(e.events.on("grab-changed",T))),e.forEachManipulator(e=>V.push(e.events.on("select-changed",T))),T()};return G(),f.push(e.onManipulatorsChanged(G),t.refHandle(()=>t.handlesGroup(V))),t.handlesGroup(f)}(e,g.visualElement),b=[g,f];return o.maskOccludee&&b.push(o.maskOccludee()),{visualElement:g.visualElement,remove:()=>t.removeHandles(b)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});