// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../Color","../../../../../core/colorUtils","../../../../../core/Evented","../../../../../core/handleUtils","../../../../../core/has","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../Manipulator3D","../../manipulatorUtils","../../RenderObject","../dragEventPipeline3D","../settings","./config","./Manipulation","./moveUtils","../../../webgl-engine/lib/GeometryUtil","../../../../interactive/dragEventPipeline"],function(e,t,a,i,r,n,s,o,l,c,d,u,m,p,h,M,_,f,v,b,g,w,O){"use strict";class y extends b.Manipulation{constructor(e){super(),this._radius=v.discRadius,this.events=new i.EventEmitter,this._tool=e.tool,this._view=e.view;const t=new f.Settings({getTheme:()=>this._view.effectiveTheme});this._settings=t,null!=e.radius&&(this._radius=e.radius);const a=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:h.createManipulatorMaterial(R(a,1,.25),1),materialFocused:h.createManipulatorMaterial(R(a,1,0),1),materialOccludedUnfocused:h.createManipulatorMaterial(R(a,.7,0),t.zManipulator.renderOccluded),materialOccludedFocused:h.createManipulatorMaterial(R(a,.85,0),t.zManipulator.renderOccluded)},this._themeHandle=l.watch(()=>this._view.effectiveTheme.accentColor,e=>{const t=R(e,1,.25),a=R(e,1,0),i=R(e,.7,0),r=R(e,.85,0),{materialUnfocused:n,materialFocused:s,materialOccludedUnfocused:o,materialOccludedFocused:l}=this._materials;n.setParameters({color:t}),s.setParameters({color:a}),o.setParameters({color:i}),l.setParameters({color:r})}),this._createManipulator(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._themeHandle=o.removeMaybe(this._themeHandle),this._manipulator.applyObjectTransform=z,this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){e(this._manipulator,0)}createManipulatedObjectDragPipeline(e,t,a){if(!t.operations)return r.makeHandle();const i=t.operations.data.spatialReference;return g.createManipulatedMoveDragPipeline(t,a,t=>this.createDragPipeline((a,i,r,n,s)=>(({steps:i,cancel:r}=e(a,i,r,n,s)),t(a,i,r)),i))}createDragPipeline(e,t){const a=this._view;return O.createManipulatorDragEventPipeline(this._manipulator,(i,r,n,s,o)=>{const l=r.next(e=>({...e,manipulatorType:0})).next(_.screenToZConstrained(a,i.renderLocation,t)).next(O.addScreenDelta());e(i,l,n,s,o)})}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._settings,t=this._radius/v.discRadius,a=e.zManipulator.height*t,i=e.zManipulator.coneHeight*t,r=e.zManipulator.coneWidth*t,n=e.zManipulator.width*t,s=[m.fromValues(0,0,0),m.fromValues(0,0,a)],o=[m.fromValues(0,0,0),m.fromValues(0,0,a+i)],l=(()=>{const e=d.create();return c.translate(e,e,[0,0,a]),c.rotateX(e,e,Math.PI/2),e})(),{materialUnfocused:u,materialFocused:p,materialOccludedUnfocused:h,materialOccludedFocused:_}=this._materials,f=w.createTubeGeometry(u,s,n/2,16,!1),b=w.createConeGeometry(u,i,r/2,16,!1);b.transformation=l,this._manipulator.renderObjects=[new M.RenderObject(b,1),new M.RenderObject(f,1),new M.RenderObject(b.instantiate({material:p}),2),new M.RenderObject(f.instantiate({material:p}),2),new M.RenderObject(b.instantiate({material:h}),1),new M.RenderObject(f.instantiate({material:h}),1),new M.RenderObject(b.instantiate({material:_}),2),new M.RenderObject(f.instantiate({material:_}),2)],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[o]}}_createManipulator(){const e=this._view,t=new p.Manipulator3D({view:e,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=t=>{const a=e.state.camera,i=P;e.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const r=u.dist(a.eye,i),n=a.computeRenderPixelSizeAtDist(r),o=u.subtract(j,i,a.eye);u.normalize(o,o);const l=U;e.renderCoordsHelper.worldUpAtPosition(P,l);const c=Math.abs(u.dot(o,l)),d=u.cross(j,o,l),m=u.cross(j,d,l),p=s.clamp(c,.01,1),h=1-Math.sqrt(1-p*p)/p/a.fullWidth,M=this._settings,_=this._radius/v.discRadius,f=M.zManipulator.width*_;u.scale(m,u.normalize(m,m),(1/h-1)*r+n*f),t[12]-=j[0],t[13]-=j[1],t[14]-=j[2]},this._manipulator=t,this._updateManipulator()}get test(){}}function R(e,i,r){const n=a.darken(e,r);return n.a*=i,t.toUnitRGBA(n)}const P=m.create(),j=m.create(),U=m.create(),z=()=>{};e.MoveZManipulation=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});