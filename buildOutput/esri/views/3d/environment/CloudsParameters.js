// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/compilerUtils","../../../core/mathUtils","../../../core/signal","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/axisAngleDegrees","../../../geometry/support/Ellipsoid","./Clouds","./weather"],function(t,a,e,s,i,r,h,o,n,c,l,d){"use strict";class u{constructor(){this.anchorPoint=o.create(),this.radiusCurvatureCorrection=0,this.transform=r.create()}}const _=o.fromValues(0,0,1),p=n.create(),f=o.create();t.CloudsParameters=class{constructor(){this.startTime=0,this._data=s.signal(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new u,this.parallaxNew=new u,this._anchorPoint=o.create(),this._fadeState=s.signal(0),this._fadeFactor=s.signal(1)}get data(){return this._data.value}set data(t){this._data.value=t}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(t,a,s){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=s?e.clamp((a-this.startTime)/(1.25*s),0,1):1,1===this.fadeFactor&&this._endFade()),this._evaluateState(t,a),this._updateParallax(t)}_evaluateState(t,a){const e=t.relativeElevation,s=this._updateAnchorPoint(t);(e>1.7*d.heightLimit||e<-d.heightLimit||s>2e5)&&this.opacity>0?this._startFade(0,a):this.isFading||(e>d.heightLimit||e<-.35*d.heightLimit||s>1e5?this.opacity>0&&this._startFade(4,a):l.ensureClouds(this.data)&&(0===this.opacity?this._startFade(1,a):2===this.data.state&&(2===this.fadeState?this._startFade(3,a):this._startFade(2,a))))}_updateParallax(t){const a=h.squaredLength(t.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(a-c.earth.radius*c.earth.radius,0))/Math.sqrt(a),n.fromPoints(_,this.parallax.anchorPoint,p),i.rotate(this.parallax.transform,r.IDENTITY,p[3],n.axis(p)),n.fromPoints(_,this.parallaxNew.anchorPoint,p),i.rotate(this.parallaxNew.transform,r.IDENTITY,p[3],n.axis(p))}_updateAnchorPoint(t){return h.normalize(this._anchorPoint,t.eye),h.scale(this._anchorPoint,this._anchorPoint,c.earth.radius),0===this.fadeState&&2===this.data?.state?(h.copy(this.parallax.anchorPoint,this._anchorPoint),0):h.length(h.subtract(f,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(t,a){switch(this._fadeState.value=t,this.startTime=a,t){case 3:this.requestFade(),this._switchReadChannels(),h.copy(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),h.copy(this.parallax.anchorPoint,this._anchorPoint),h.copy(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),h.copy(this.parallax.anchorPoint,this._anchorPoint),h.copy(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&2!==this.data.state&&(this.data.state=0),this.fadeState){case 3:h.copy(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:a.neverReached(this.fadeState)}}_switchReadChannels(){2===this.data?.state&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return 4===this.fadeState||1===this.fadeState||3===this.fadeState}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});