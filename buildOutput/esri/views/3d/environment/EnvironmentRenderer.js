// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/signal","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../geometry/ellipsoidUtils","./CloudsPresets","./CloudsRenderer","./Precipitation","./weather","../webgl-engine/effects/RenderPlugin"],function(e,t,i,n,r,s,o,a,c,u,d,h,l,p,_,y,v){"use strict";e.EnvironmentRenderer=class extends v.SyncRenderPlugin{constructor(e){super(e),this.produces=new Map([]),this._clouds=s.signal(null),this._incarnation=0,this._precipitation=null}initialize(){this.view.stage?.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?.stage?.removeRenderPlugin(this),this._set("view",null)}get updating(){return!!this._clouds.value?.readyToRun}get weatherAvailable(){return d.length(this.view.state.camera.eye)-h.getReferenceEllipsoid(this.view.spatialReference).radius<=y.heightLimit}get usedMemory(){return this._clouds.value?.usedMemory??0}_fadeOutPrecipitation(){this._precipitation&&(this._precipitationOutgoing?.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut(()=>{this._precipitationOutgoing=n.destroyMaybe(this._precipitationOutgoing)}),this._precipitation=null,++this._incarnation)}get weather(){return this.view?.environmentManager?.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;const t=this.view,i=()=>this._requestRender();this.addHandles([r.watch(()=>this._precipitation,i,r.sync),r.watch(()=>this._clouds.value?.state,i,r.sync),r.watch(()=>t.state.mode,i,r.sync),r.watch(()=>this._updateClouds(),i,r.sync),r.watch(()=>this._updatePrecipitation(),i,r.sync),r.watch(()=>this.weather,e=>this._initWeather(e))])}uninitializeRenderContext(){this._context=null,this._clouds.value=n.destroyMaybe(this._clouds.value),this._precipitation=n.destroyMaybe(this._precipitation),this._precipitationOutgoing=n.destroyMaybe(this._precipitationOutgoing)}prepareRender(e){const{bind:t,time:i}=e;if("local"!==this.view.viewingMode&&t.clouds.data){t.clouds.fade(t.camera,i,this.view.qualitySettings.fadeDuration);const e=this._clouds.value;e&&0===e.state&&0===e.coverage&&!e.readyToRun&&e.destroyCubeMap()}}acquireTechniques(){return[]}render(){}_requestRender(){this._context?.requestRender()}_initWeather(e){const t=this._context;if(!e||!t)return void(this._clouds.value=n.destroyMaybe(this._clouds.value));if(this._clouds.value)return;const i=this.view;this._clouds.value=new p.CloudsRenderer({context:t,view:i,requestRender:()=>this._requestRender()})}_updateClouds(){const e=this.view.environment.weather;return null==e||null==this._clouds.value||this._clouds.value.applyPreset(l.cloudPresets[e.type],function(e){switch(e.type){case"rainy":case"snowy":case"cloudy":case"sunny":return e.cloudCover;case"foggy":return e.fogStrength}}(e)),++this._incarnation}_updatePrecipitation(){const e=this.view.environment.weather;if(e.type===this._precipitation?.type)return this._incarnation;this._fadeOutPrecipitation();const t="rainy"===e.type||"snowy"===e.type,i=this._context;return t&&i&&(this._precipitation=new _.Precipitation({view:this.view,type:e.type}),++this._incarnation),this._incarnation}get test(){}hasHighlight(){return!1}},t.__decorate([o.property({constructOnly:!0})],e.EnvironmentRenderer.prototype,"view",void 0),t.__decorate([o.property({type:Boolean,readOnly:!0})],e.EnvironmentRenderer.prototype,"updating",null),t.__decorate([o.property()],e.EnvironmentRenderer.prototype,"weatherAvailable",null),t.__decorate([o.property()],e.EnvironmentRenderer.prototype,"_context",void 0),e.EnvironmentRenderer=t.__decorate([u.subclass("esri.views.3d.environment.EnvironmentRenderer")],e.EnvironmentRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});