// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/ellipsoidUtils","../../../geometry/support/Indices","../webgl","./PrecipitationTechnique","./PrecipitationTechniqueConfiguration","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/effects/TransparentEnvironment","../webgl-engine/lib/VertexArrayObject","../../webgl/enums","../../webgl/Util","../../webgl/VertexAttributeLocations","../../webgl/VertexBuffer"],function(e,t,i,s,r,n,a,o,c,d,u,p,h,l,f,y,m,_,b,g,P,w,v,I){"use strict";e.Precipitation=class extends b.TransparentEnvironment{constructor(e){super(e),this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new f.PrecipitationPassParameters,this._configuration=new y.PrecipitationTechniqueConfiguration;const{view:t,type:i}=e;this._configuration.type="rainy"===i?0:1,t.stage.renderView.techniques.precompile(f.PrecipitationTechnique,this._configuration),this._passParameters.time=0,this._passParameters.radius=p.getReferenceEllipsoid(t.spatialReference).radius,this.addHandles([r.watch(()=>t.environment.weather,e=>{e.type===i&&this.addHandles(r.watch(()=>e.precipitation,e=>this._adjustParticles(e),r.syncAndInitial))},r.syncAndInitial)]),this.addHandles(r.watch(()=>t.stage?.renderer.renderContext.bind.clouds.fadeFactor??1,e=>{this._passParameters.opacity=e,1===e&&(this.removeHandles("opacity"),this.addHandles(r.watch(()=>t.stage?.renderer.renderContext.bind.clouds.opacity??1,e=>this._passParameters.opacity=e,r.syncAndInitial),"opacity"))},r.sync),"opacity")}initialize(){this.addHandles([r.watch(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),r.syncAndInitial)])}_adjustParticles(e){const t=e<.5?i.lerp(0,.35,2*e):i.lerp(.35,1,2*(e-.5));this._numParticles=A*t}destroy(){this._numParticles=0,this._vao=s.disposeMaybe(this._vao),this._instanceIdBuffer=s.disposeMaybe(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles(r.watch(()=>this.renderContext?.bind.clouds.fadeFactor??1,t=>{this._passParameters.opacity=1-t,1===t&&(this.removeAllHandles(),e())}),"opacity")}updateAnimation(e){const t=("rainy"===this.type?this._rainSpeed:this._snowSpeed)*n.secondsFromMilliseconds(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext,i=Math.round(this._numParticles*this._passParameters.opacity),s=e.find(({name:e})=>e===l.InternalRenderCategory.TRANSPARENT_ENVIRONMENT);if(i<1)return s;const r=this.techniques.get(f.PrecipitationTechnique,this._configuration);if(!r.compiled)return this.requestRender(1),s;const n=t.bindTechnique(r,this.bindParameters,this._passParameters);return this._vao??=function(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new g.VertexArrayObject(e,new I.VertexBuffer(e,m.glLayout(x),t))}(t),t.bindVAO(this._vao),this._bindInstanceIdBuffer(n.locations),n.assertCompatibleVertexAttributeLocations(this._vao,v.fromLayout(B)),t.drawArraysInstanced(P.PrimitiveType.TRIANGLES,0,3,i),t.unbindBuffer(34962),s}_bindInstanceIdBuffer(e){const t=this.renderingContext;if(this._instanceIdBuffer)return void t.bindBuffer(this._instanceIdBuffer);const i=h.getContinuousIndexArray(A);this._instanceIdBuffer=new I.VertexBuffer(t,B,new Float32Array(i)),w.bindVertexBufferLayout(t,e,this._instanceIdBuffer,0)}},t.__decorate([a.property({constructOnly:!0})],e.Precipitation.prototype,"type",void 0),e.Precipitation=t.__decorate([u.subclass("esri.views.3d.environment.Precipitation")],e.Precipitation);const A=25e4,x=_.newLayout().vec3f("position").freeze(),B=m.glLayout(_.newLayout().f32("instanceFeatureAttribute"),1);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});