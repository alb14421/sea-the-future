// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../analysis/featureReferenceUtils","../../../core/Accessor","../../../core/has","../../../core/Logger","../../../core/mapCollectionUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/projectionUtils","../../../geometry/projection/projectBoundingRect","../../../geometry/support/aaBoundingRect","./AnalysisView3D","./support/projectionUtils","./Viewshed/ViewshedAnalysisVisualization","./Viewshed/ViewshedComputedData","./Viewshed/ViewshedTool","../webgl-engine/lib/Intersector","../webgl-engine/lib/Viewshed","../../analysis/analysisViewUtils"],function(e,t,s,i,r,o,a,n,d,l,c,h,p,u,w,v,y,_,V,m,g,b,f,R){"use strict";let D=class extends(y.AnalysisView3D(s)){constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderNode=null,this._intersector=null}get visible(){return super.visible}set visible(e){super.visible=e}get interactive(){return super.interactive}set interactive(e){super.interactive=e}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(e){this._unselectOtherViewsheds(e),this._selectedViewshed=e}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const e=this.view;this._viewshedRenderNode=new f.Viewshed({view:e,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed,isDecoration:this._isDecoration}),this._intersector=new b.Intersector(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0,this.viewshedComputedDataHandles=o.mapCollection(()=>this.analysis.viewsheds,t=>{const s=new m.ViewshedComputedData({renderCoordsHelper:e.renderCoordsHelper,viewshed:t}),i=Symbol();return this.addHandles([n.watch(()=>({valid:s.valid,canProject:u.canProjectWithoutEngine(s.observer?.spatialReference,this.view.spatialReference)||u.isLoaded()}),({valid:e,canProject:t},i)=>{this.visible&&(e&&t?this._addViewshedsToRenderer(s):i?.valid&&i?.canProject&&this._removeViewshedsFromRenderer(s),t||_.logFailedGeometryProjectionError(this.analysis,s.observer.spatialReference,r.getLogger(this)))},n.initial),...this._createFeatureReferenceHandles(s)],i),{viewshedComputedData:s,remove:()=>{this.removeHandles(i),this._removeViewshedsFromRenderer(s),s.destroy()}}}),this._analysisVisualization=new V.ViewshedAnalysisVisualization({view:e,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([n.watch(()=>this.visible,e=>{const t=this.viewshedComputedDataHandles;if(null==t)return;e||(this.selectedViewshed=null);const s=t.map(e=>e.viewshedComputedData).filter(e=>e.valid).toArray();e?this._addViewshedsToRenderer(s):this._removeViewshedsFromRenderer(s)}),n.watch(()=>e.renderCoordsHelper,e=>{this.viewshedComputedDataHandles?.forEach(({viewshedComputedData:t})=>t.renderCoordsHelper=e)}),R.connectAnalysisViewToTool(this,g),n.when(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},n.syncAndInitial)])}destroy(){this.userOperation=a.abortMaybe(this.userOperation),R.removeAnalysisViewTool(this),this._analysisVisualization=a.destroyMaybe(this._analysisVisualization);const e=this.viewshedComputedDataHandles;null!=e&&this._removeViewshedsFromRenderer(e.map(e=>e.viewshedComputedData).toArray())}_createFeatureReferenceHandles(e){const{view:t}=this;return[n.watch(()=>[t.state.camera,t.slice.plane,e.viewshed.observer,e.targetRenderSpace,e.verticalFieldOfView,e.horizontalFieldOfView,e.feature],()=>{this._updateObserverFromFeature(t,e)},n.initial),this._createElevationUpdateHandle(e),n.when(()=>e.needUpdateByFeature,()=>{this._updateObserverFromFeature(t,e),e.needUpdateByFeature=!1})]}_createElevationUpdateHandle(e){const t=(s,i)=>{const{view:r}=this,{observer:o}=e;if(null==o)return;const a=u.projectOrLoad(o,r.spatialReference);if(null!=a.pending)return void a.pending.finally(()=>t(s,i));const n=a.geometry;null!=n&&(w.projectBoundingRect(s,i,C,r.spatialReference),v.containsPoint(C,[n.x,n.y])&&(e.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",({extent:e,spatialReference:s})=>t(e,s))}async createViewsheds(e){await R.startPlaceOperation(this,{placementOptions:e,onToolActivated:e=>e.place("multiple")})}place(e){return R.startPlaceOperation(this,{placementOptions:e,onToolActivated:e=>e.place("single")})}_addViewshedsToRenderer(e){this._viewshedRenderNode.updateViewsheds({adds:e})}_removeViewshedsFromRenderer(e){this._viewshedRenderNode.updateViewsheds({removes:e})}_updateObserverFromFeature(e,s){const i=s.observerRenderSpace,r=s.targetRenderSpace,o=h.copy(p.create(),i),a={observer:i,observerSurfaceNormal:null,observerAdjusted:o,observerFeatureId:t.getFeatureId(s.feature),target:r,targetSurfaceNormal:null,targetAdjusted:h.copy(p.create(),r),targetFeatureId:null};t.updatePointsFromFeatureReference(e,this._intersector,a,e=>Math.min(e,.05*s.farDistanceRenderSpace)),s.observerRenderSpaceOverride=h.exactEquals(o,i)?null:o}_unselectOtherViewsheds(e){if(null!=e)for(const e of this.view.tools.items)e!==this.tool&&e instanceof g&&(e.analysisViewData.selectedViewshed=null)}get test(){}};e.__decorate([d.property({readOnly:!0})],D.prototype,"type",void 0),e.__decorate([d.property({constructOnly:!0,nonNullable:!0})],D.prototype,"analysis",void 0),e.__decorate([d.property()],D.prototype,"tool",void 0),e.__decorate([d.property()],D.prototype,"_selectedViewshed",void 0),e.__decorate([d.property()],D.prototype,"selectedViewshed",null),e.__decorate([d.property()],D.prototype,"selectedViewshedComputedData",null),e.__decorate([d.property()],D.prototype,"viewshedComputedDataHandles",void 0),e.__decorate([d.property()],D.prototype,"userOperation",void 0),e.__decorate([d.property()],D.prototype,"_analysisVisualization",void 0),e.__decorate([d.property()],D.prototype,"_viewshedRenderNode",void 0),D=e.__decorate([c.subclass("esri.views.3d.analysis.ViewshedAnalysisView3D")],D);const F=D,C=v.empty();return F});