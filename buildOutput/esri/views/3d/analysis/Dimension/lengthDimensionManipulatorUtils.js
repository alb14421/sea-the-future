// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../Color","../../../../analysis/dimensionUtils","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/Point","../../../../geometry/support/plane","../../../../geometry/support/vectorStacks","../../../../layers/graphics/hydratedFeatures","./lengthDimensionUtils","./settings","../../interactive/Manipulator3D","../../interactive/manipulatorUtils","../../interactive/RenderObject","../../interactive/editingTools/dragEventPipeline3D","../../interactive/visualElements/support/Segment","../../support/engineContent/marker","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/materials/RibbonLineMaterial","../../../interactive/dragEventPipeline"],function(e,t,n,r,i,a,o,s,c,l,d,u,p,m,f,g,h,y,M,v,S,P,T,b,w,x,R,D,O){"use strict";class H extends M.Manipulator3D{constructor(e,n){const r=v.createManipulatorMaterial(t.toUnitRGBA(y.getTransparentAccentColor(e.effectiveTheme))),i=[new S.RenderObject(R.createSphereGeometry(r,1,32,32),Z)];super({view:e,renderObjects:i,metadata:n.metadata,available:!1,grabCursor:"crosshair",radius:y.pointRadius,collisionPriority:1}),this._themeHandle=a.watch(()=>({color:t.toUnitRGBA(y.getTransparentAccentColor(e.effectiveTheme))}),e=>r.setParameters(e))}destroy(){this._themeHandle.remove(),super.destroy()}}class C extends M.Manipulator3D{constructor(e,{lineSizePt:n,material:r,metadata:i}){super({view:e,autoScaleRenderObjects:!1,collisionPriority:1,metadata:i}),this._options={calloutColor:u.create(),lineSizePt:n,material:r},this._themeHandle=a.watch(()=>t.toUnitRGBA(y.getTransparentAccentColor(e.effectiveTheme)),e=>{this._options.calloutColor=e,N(this,E({...this._options,metadata:this.metadata}))},a.initial)}update({lineSizePt:e,material:t}){this._options.lineSizePt=e,this._options.material=t,N(this,E({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function E({calloutColor:e,lineSizePt:t,material:n,metadata:r}){return{calloutLength:.25*b.markerSizePerLineWidth*y.markerLineSizeFraction*o.pt2px(t)+y.orientationCalloutOffsetPx,calloutColor:e,calloutWidth:y.orientationCalloutWidth,customStateMask:Z,discScale:y.orientationDiscScale,focusMultiplier:y.orientationFocusMultiplier,material:n,metadata:r}}function F(e){const{cancel:t,computation:n,settingHeading:r,steps:a,view:o}=e;if(!h.isValidComputation(n))return;const{renderCoordsHelper:s}=o,{dimension:c,geometry:u}=n,p=d.create(),g=W(d.create(),u,u.directSegment,s),y=_(f.sv3d.get(),{forHeading:r,geometry:u,renderCoordsHelper:s}),M=m.fromPositionAndNormal(g,y,m.create()),S=r?c.orientation??h.headingFromGeometry(u,o.renderCoordsHelper):c.orientation??0;a.next(P.screenToRenderPlane(o,M)).next(e=>{"start"===e.action&&l.copy(p,e.renderStart);const t=m.getNormal(M),n=v.calculateInputRotationTransform(p,e.renderEnd,g,t);let a=S-i.rad2deg(n);r||(a=A(a)),c.orientation=a}),t.next(O.resetProperties(c,["orientation"]))}function A(e){const t=r.cyclicalDegrees.normalize(e)%90;return t<y.orientationSnapThresholdDegrees?e-t:90-t<y.orientationSnapThresholdDegrees?e+(90-t):e}function G(e,t,n,r){const i=l.subtract(f.sv3d.get(),n.endRenderSpace,n.startRenderSpace);l.cross(i,i,r);const a=m.fromPositionAndNormal(n.startRenderSpace,i,m.create()),o=m.fromPositionAndNormal(n.startRenderSpace,r,m.create()),s=t.offset;let c,d=0;const u=new O.EventPipeline;return u.next(P.screenToRenderPlane(e,a)).next(n=>{"start"===n.action&&(d=m.signedDistance(o,n.renderStart));const r=(m.signedDistance(o,n.renderEnd)-d)*e.renderCoordsHelper.unitInMeters;t.offset=s+r,c=n}),e=>(u.execute(e),c)}function j(e,t){const{directSegment:n}=e,{renderCoordsHelper:r}=t,i=h.directUp(f.sv3d.get(),e,r),a=h.directStartToEnd(f.sv3d.get(),e),o=l.cross(f.sv3d.get(),a,i),{viewForward:s}=t.state.camera;l.dot(o,s)>0&&l.scale(o,o,-1);const c=n.eval(.5,f.sv3d.get());return r.headingAtPosition(c,o)}function L(e,t,n,{forHeading:r}){const{dimension:i,geometry:a}=t,{primaryOffsetAxis:o}=a,s=l.scale(z,o,i.offset>=0?1:-1),c=_(U,{forHeading:r,geometry:a,renderCoordsHelper:n});l.cross(c,c,s);const u=v.calculateTranslateRotateFromBases(s,c,d.ZEROS,J);e.modelTransform=u,e.renderLocation=W(I,a,a.dimensionSegment,n)}const z=d.create(),U=d.create();function W(e,t,n,r){const{startRenderSpace:i,endRenderSpace:a}=n,o=function(e,t){const n=h.directStartToEnd(k,e),r=h.directUp(V,e,t);return l.dot(n,r)>0}(t,r)?i:a;return l.copy(e,o)}function _(e,{forHeading:t,geometry:n,renderCoordsHelper:r}){return t?h.directUp(e,n,r):h.dimensionStartToEnd(e,n,{invert:!0})}const k=d.create(),V=d.create();function B(e){return o.pt2px(e)+y.focusedLinePaddingPx}function N(e,t){const n=t.material,r=t.focusMultiplier??v.rotateManipulatorDefaults.focusMultiplier,i=t.calloutLength??v.rotateManipulatorDefaults.calloutLength,a=v.rotateManipulatorDefaults.discRadius*(t.discScale??1),o=a*r,s=(e,t)=>{const n=[0,1,2,2,3,0];return new x.Geometry(t,[["position",new w.Attribute([i-e,-e,0,i+e,-e,0,i+e,e,0,i-e,e,0],n,3,!0)],["uv0",new w.Attribute([0,0,1,0,1,1,0,1],n,2,!0)]])},c=t.calloutWidth??v.rotateManipulatorDefaults.calloutWidth,l=new D.RibbonLineMaterial({width:c,color:t.calloutColor,renderOccluded:4,isDecoration:!0}),d=R.createPolylineGeometry(l,[[0,0,0],[i-a,0,0]]),u=R.createPolylineGeometry(l,[[0,0,0],[i-o,0,0]]),p=t.customStateMask??0;e.collisionType={type:"disc",direction:[0,0,1],offset:[i,0,0]},e.focusMultiplier=r,e.metadata=t.metadata,e.radius=a,e.renderObjects=[new S.RenderObject(s(a,n),1|p),new S.RenderObject(d,1|p),new S.RenderObject(s(o,n),2|p),new S.RenderObject(u,2|p)]}const Z=16,I=d.create(),q=d.create(),J=c.create(),K=new T.EuclideanSegment;e.DidPointerMoveRecentlyFlag=Z,e.LengthDimensionManipulators=class{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(t=>this.hasOwnProperty(t)&&e===this[t])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const t of n.lengthDimensionMeasureType)e(this.manipulatorForMeasureType(t),t)}manipulatorForMeasureType(e){switch(e){case"direct":return this.direct;case"horizontal":return this.horizontal;case"vertical":return this.vertical}}},e.LengthDimensionPointManipulator=H,e.LineOfSightOrientationManipulator=C,e.automaticHeadingFromCamera=j,e.createMeasureTypeManipulator=function(e,t){const n=[d.fromValues(-.5,0,0),d.fromValues(.5,0,0)],r=R.createPolylineGeometry(t.thinOffsetManipulatorMaterial,n),i=R.createPolylineGeometry(t.unfocusedMaterial,n.map(e=>l.scale(d.create(),e,y.lengthFraction))),a=i.instantiate({material:t.focusedMaterial});return new M.Manipulator3D({view:e,renderObjects:[new S.RenderObject(i,1|Z),new S.RenderObject(a,2|Z),new S.RenderObject(r,Z)],collisionType:{type:"line",paths:[n]},radius:B(t.lineSizePt)/2,available:!1,metadata:t.metadata,...v.worldScaledManipulatorSettings})},e.createOffsetManipulator=function(e,t){const n=[d.fromValues(-.5,0,0),d.fromValues(.5,0,0)],r=R.createPolylineGeometry(t.unfocusedMaterial,n.map(e=>l.scale(d.create(),e,y.lengthFraction))),i=r.instantiate({material:t.focusedMaterial});return new M.Manipulator3D({view:e,renderObjects:[new S.RenderObject(r,9|Z),new S.RenderObject(i,2|Z)],collisionType:{type:"line",paths:[n]},radius:B(t.lineSizePt)/2,metadata:t.metadata,available:!1,...v.worldScaledManipulatorSettings})},e.focusedOffsetWidth=B,e.headingManipulatorHandles=function(e,{computation:t,view:n}){return[O.createManipulatorDragEventPipeline(e,(e,r,i)=>{F({cancel:i,computation:t,settingHeading:!0,steps:r,view:n})})]},e.measureTypeManipulatorHandles=function(e,{computation:t,manipulatorMeasureType:n,view:r}){let i="direct",a=0,o=0;return[e.events.on("grab-changed",s=>{if("start"!==s.action||!h.isValidComputation(t))return;const{dimension:c,geometry:d}=t;i=c.measureType,a=c.offset,o=c.orientation;const u=l.copy(f.sv3d.get(),e.renderLocation);c.measureType=n,c.offset=h.computeOffsetForPoint(u,n,d,r.renderCoordsHelper),c.orientation=0}),O.createManipulatorDragEventPipeline(e,(e,s,c)=>{if(!h.isValidComputation(t))return;const{geometry:l,dimension:d}=t,{renderCoordsHelper:u}=r,p=h.computeSegmentForMeasureType(K,n,t,u),m=h.computeOffsetAxis(f.sv3d.get(),{measureType:n,directSegment:l.directSegment,renderCoordsHelper:u}),g=P.hideManipulatorWhileDragging(e);s.next(g).next(G(r,d,p,m)),c.next(g).next(e=>(d.measureType=i,d.offset=a,d.orientation=o,e))})]},e.offsetManipulatorHandles=function(e,{computation:t,view:n}){return[O.createManipulatorDragEventPipeline(e,(e,r,i)=>{if(!h.isValidComputation(t)||!e.selected)return;const{geometry:a,dimension:o}=t,s=P.hideManipulatorWhileDragging(e);r.next(s).next(G(n,o,a.dimensionSegment,a.primaryOffsetAxis)),i.next(s).next(O.resetProperties(o,["offset"]))})]},e.pointManipulatorHandles=function(e,{isStart:t,createSnappingPipelineStep:n,dimension:r,onUpdate:i,view:a}){const o=t?"startPoint":"endPoint";return[O.createManipulatorDragEventPipeline(e,(e,t,s,c)=>{const l=P.hideManipulatorWhileDragging(e),{snappingStep:d,cancelSnapping:u}=n(c);s=s.next(l).next(O.resetProperties(r,[o,"measureType","orientation"])).next(u),t.next(l).next(P.screenToMap3D(a)).next(...d).next(e=>{const t=g.clonePoint(e.mapEnd,new p);i("startPoint"===o?{startPoint:t}:{endPoint:t})})})]},e.rotationManipulatorHandles=function(e,{computation:t,view:n}){return[O.createManipulatorDragEventPipeline(e,(e,r,i)=>{F({cancel:i,computation:t,settingHeading:!1,steps:r,view:n})}),e.events.on("immediate-click",e=>{!function(e,t,n){const{dimension:i,geometry:a}=t;if(90===i.orientation||270===i.orientation)return i.orientation=0,void e.stopPropagation();if(null==a)return;const{renderCoordsHelper:o}=n,s=h.computeGeometryFromDimension({...h.computationToGeometryDependencies(t),orientation:90},o),c=h.computeGeometryFromDimension({...h.computationToGeometryDependencies(t),orientation:270},o);if(null==s||null==c)return;const l=h.headingFromGeometry(s,o),d=h.headingFromGeometry(c,o),u=j(a,n),p=r.cyclicalDegrees.shortestSignedDiff(u,l),m=r.cyclicalDegrees.shortestSignedDiff(u,d);i.orientation=Math.abs(p)<Math.abs(m)?90:270,e.stopPropagation()}(e,t,n)})]},e.snapOrientationToNearestRightAngle=A,e.unfocusedOffsetWidth=function(e){return o.pt2px(e)+y.linePaddingPx},e.updateHeadingManipulatorTransform=function(e,t,n){L(e,t,n,{forHeading:!0})},e.updateMeasureTypeManipulatorTransform=function(e,t,n,r){const{geometry:i}=t,a=h.computeSegmentForMeasureType(K,n,t,r),o=h.computeOffsetAxis(I,{measureType:n,directSegment:i.directSegment,renderCoordsHelper:r}),c=l.sub(q,a.endRenderSpace,a.startRenderSpace),u=v.calculateTranslateRotateFromBases(c,o,d.ZEROS,J),p=l.length(c);s.scale(u,u,l.set(q,p,p,p)),e.modelTransform=u,e.renderLocation=a.eval(.5,q)},e.updateOffsetManipulatorTransform=function(e,t,n){const{dimensionSegment:r,primaryOffsetAxis:i}=t,a=h.dimensionStartToEnd(I,t),o=l.exactEquals(a,d.ZEROS)?s.identity(J):v.calculateTranslateRotateFromBases(a,i,d.ZEROS,J),c=Math.max(l.length(a),y.minLengthMeters/n.unitInMeters);s.scale(o,o,l.set(I,c,c,c)),e.modelTransform=o,e.renderLocation=r.eval(.5,I)},e.updateRotationManipulatorTransform=function(e,t,n){L(e,t,n,{forHeading:!1})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});