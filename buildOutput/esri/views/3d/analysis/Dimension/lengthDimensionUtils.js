// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/mathUtils","../../../../core/quantityUtils","../../../../core/unitUtils","../../../../core/accessorSupport/ensureType","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../../../../geometry/support/vectorStacks","../../../../layers/graphics/dehydratedPoint","../../../../layers/graphics/hydratedFeatures","../../interactive/visualElements/support/Segment","../../../support/euclideanLengthMeasurementUtils","../../../support/geodesicMeasurementUtils"],function(e,t,n,r,i,o,a,d,s,c,l,u,p,g,S,m){"use strict";class v{constructor(e,t,n,r,i,o){this.elevationAlignedStartPoint=e,this.elevationAlignedEndPoint=t,this.directSegment=n,this.dimensionSegment=r,this.primaryOffsetAxis=i,this.spatialReference=o}}const f=i.ensureType(c);function R(e,t,n){return n.toRenderCoords(t.elevationAlignedStartPoint,e.startRenderSpace),n.toRenderCoords(t.elevationAlignedEndPoint,e.endRenderSpace),e}const A=u.makeDehydratedPoint(0,0,0,null),y=new g.EuclideanSegment;function P(e,n){const{measureType:r,elevationAlignedStartPoint:i,elevationAlignedEndPoint:a,directSegment:{startRenderSpace:c,endRenderSpace:u},directSegment:p,renderCoordsHelper:g}=n,S=p.eval(.5,l.sv3d.get()),m=g.worldUpAtPosition(S,l.sv3d.get()),v=g.worldBasisAtPosition(S,1,l.sv3d.get());switch(r){case"horizontal":d.copy(e,m);break;case"vertical":d.dot(c,m)<d.dot(u,m)?d.sub(e,u,c):d.sub(e,c,u),d.cross(e,e,m),d.cross(e,e,m);break;case"direct":{const r=n.orientation??0;if(E({elevationAlignedStartPoint:i,elevationAlignedEndPoint:a}))o.fromRotation(h,-t.deg2rad(r),m),d.transformMat4(e,v,h);else{const n=d.sub(l.sv3d.get(),u,c),i=d.cross(l.sv3d.get(),n,m);d.cross(i,i,n),o.fromRotation(h,t.deg2rad(r),n),d.transformMat4(e,i,h)}break}}return d.equals(e,s.ZEROS)?d.copy(e,v):d.normalize(e,e)}const h=a.create();function E({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}){return null!=e&&null!=t&&e.x===t.x&&e.y===t.y}function b(e,t,n,r,i){const{startRenderSpace:o,endRenderSpace:a}=r,s=n/i.unitInMeters,[c,l]=function(e,t,n,r=0){const i=d.dot(t,n),o=d.dot(e,n),a=Math.abs(i-o)+r;return i>o?[a,r]:[r,a]}(o,a,t,s);return d.scaleAndAdd(e.startRenderSpace,r.startRenderSpace,t,c),d.scaleAndAdd(e.endRenderSpace,r.endRenderSpace,t,l),e}function T(e,t,n={invert:!1}){const{startRenderSpace:r,endRenderSpace:i}=t.dimensionSegment;return n.invert?d.sub(e,r,i):d.sub(e,i,r)}const D=s.create();e.LengthDimensionGeometry=v,e.arePointsVerticallyAligned=E,e.computationToGeometryDependencies=function(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:n,dimension:{offset:r,measureType:i,orientation:o}}=e;return{elevationAlignedStartPoint:t,elevationAlignedEndPoint:n,offset:r,measureType:i,orientation:o}},e.computeGeometryFromDimension=function({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:n,measureType:r,orientation:i},o,a=null){if(null==e||null==t)return null;const c=R(a?.directSegment??new g.EuclideanSegment,{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t},o),l=a?.primaryOffsetAxis??s.create();P(l,{measureType:r,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:c,orientation:i,renderCoordsHelper:o});const u=a?.dimensionSegment??new g.EuclideanSegment;return E({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t})&&"vertical"===r?(d.copy(u.startRenderSpace,c.startRenderSpace),d.copy(u.endRenderSpace,c.endRenderSpace)):b(u,l,n,c,o),new v(e,t,c,u,l,o.spatialReference)},e.computeLength=function(e,t,i,o){if(null==e)return null;let a;if("horizontal"===t)a=o.autoDistanceBetweenPoints2D(f(e.elevationAlignedStartPoint),f(e.elevationAlignedEndPoint));else{const{startRenderSpace:t,endRenderSpace:n}=e.dimensionSegment;a=S.euclideanDirectDistance(t,n,e.spatialReference)}if(null==a)return null;const d="vertical"===t?r.adaptiveVerticalLengthUnit(a.value,a.unit,i):r.adaptiveLengthUnit(a.value,a.unit,i);return n.toUnit(a,d)},e.computeOffsetAxis=P,e.computeOffsetForPoint=function(e,t,n,r){const{directSegment:i}=n,o=P(l.sv3d.get(),{measureType:t,directSegment:i,renderCoordsHelper:r}),a=b(y,o,0,i,r).eval(.5,l.sv3d.get()),s=d.sub(l.sv3d.get(),e,a);return d.dot(s,o)*r.unitInMeters},e.computeSegmentForMeasureType=function(e,t,n,r){switch(t){case"direct":return R(e,n,r);case"horizontal":case"vertical":{const{elevationAlignedStartPoint:i,elevationAlignedEndPoint:o,dimension:a,geometry:c}=n;let u;if("direct"===a.measureType){const e=function(e,t){const n=e.directSegment.eval(.5,l.sv3d.get()),r=t.worldUpAtPosition(n,l.sv3d.get()),i=e.dimensionSegment.eval(.5,l.sv3d.get()),o=d.sub(l.sv3d.get(),i,n);return!d.equals(o,s.ZEROS)&&d.dot(o,r)>0}(c,r);u=e===i.z>o.z,"horizontal"===t&&(u=!u)}else u=!function(e){const{startRenderSpace:t,endRenderSpace:n}=e.dimensionSegment,{startRenderSpace:r,endRenderSpace:i}=e.directSegment;return d.sqrDist(r,t)<d.sqrDist(i,n)}(c);const[g,S]=u?[i,o]:[o,i],m=p.clonePoint(S,A);return"horizontal"===t?m.z=g.z:(m.x=g.x,m.y=g.y),r.toRenderCoords(g,e.startRenderSpace),r.toRenderCoords(m,e.endRenderSpace),e}}},e.computeSpanningSegment=function(e,t,n,r){return 0===t?(d.copy(e.startRenderSpace,n.startRenderSpace),d.copy(e.endRenderSpace,r.startRenderSpace)):(d.copy(e.startRenderSpace,n.endRenderSpace),d.copy(e.endRenderSpace,r.endRenderSpace)),e},e.dimensionStartToEnd=T,e.directStartToEnd=function(e,t){const{startRenderSpace:n,endRenderSpace:r}=t.directSegment;return d.sub(e,r,n)},e.directUp=function(e,t,n){const r=t.directSegment.eval(.5,l.sv3d.get());return n.worldUpAtPosition(r,e)},e.headingFromGeometry=function(e,t){const n=e.directSegment.eval(.5,l.sv3d.get());return t.headingAtPosition(n,e.primaryOffsetAxis)},e.isGeodesicDimension=function(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:r}=e;if(null==t||null==r)return!1;const i=S.euclideanDirectDistanceBetweenPoints(t,r);return null!=i&&n.toUnit(i,"meters").value>m.geodesicDistanceThreshold},e.isValidComputation=function(e){return null!=e.geometry},e.maxScreenLengthSquaredFromGeometry=function(e,t){return d.squaredLength(T(D,e))/t**2},e.offsetSegment=function(e,t,n,r){d.scaleAndAdd(e.startRenderSpace,t.startRenderSpace,n,r),d.scaleAndAdd(e.endRenderSpace,t.endRenderSpace,n,r)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});