// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Handles","../../../../core/has","../../../../core/lang","../../../../core/maybe","../../../../core/quantityFormatUtils","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","./lengthDimensionUtils","./settings","../../interactive/visualElements/LabelVisualElement","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/MarkerVisualElement","../../interactive/visualElements/support/Segment"],function(e,t,s,n,i,l,a,o,m,r,f,c,d,u,h){"use strict";const S=new h.EuclideanSegment,g=new h.EuclideanSegment,p=m.create();class v{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}e.LengthDimensionVisualElements=v,e.LengthDimensionVisualization=class{set visible(e){for(const t of this._visualElements.values())t.attached=e}constructor(e){this.destroyed=!1,this._handles=new t,this._messages=null,this._labelSegment=new h.EuclideanSegment;const{analysis:s,computation:i,view:l,messages:m,isDecoration:r}=e;this.analysis=s,this.computation=i,this.view=l,this._messages=m;const f=e.visible,S={view:l,attached:f,isDecoration:r},{fontSize:g,textColor:p,textBackgroundColor:b}=s.style;this._visualElements=new v({marker:new u.MarkerVisualElement(S,e.markerMaterial),dimension:new d.LineVisualElement(S,e.dimensionLineMaterial),startOffset:new d.LineVisualElement(S,e.offsetLineMaterial),endOffset:new d.LineVisualElement(S,e.offsetLineMaterial),dimensionSmall:new d.LineVisualElement(S,e.smallDimensionLineMaterial),startOffsetSmall:new d.LineVisualElement(S,e.smallOffsetLineMaterial),endOffsetSmall:new d.LineVisualElement(S,e.smallOffsetLineMaterial),label:new c.LabelVisualElement({view:l,attached:f,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:o.pt2px(g),textColor:p.clone(),backgroundColor:b.clone(),isDecoration:r})}),this._handles.add([a.watch(()=>i.geometry,e=>{this.updateCameraDependentElements(l.state.camera,e,s.style),null!=i.geometry&&this._updateLines(i.geometry)},{...a.initial,equals:n.equals}),a.watch(()=>i.length,e=>this._updateLabelContent(e),a.initial)])}destroy(){this.destroyed=!0,this._handles=i.destroyMaybe(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){}_updateLines(e){const t=r.computeSpanningSegment(S,0,e.directSegment,e.dimensionSegment),s=r.computeSpanningSegment(g,1,e.directSegment,e.dimensionSegment),n=this._visualElements;n.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),n.dimension.setGeometryFromSegment(e.dimensionSegment),n.startOffset.setGeometryFromSegment(t),n.endOffset.setGeometryFromSegment(s),n.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),n.startOffsetSmall.setGeometryFromSegment(t),n.endOffsetSmall.setGeometryFromSegment(s)}updateCameraDependentElements(e,t,s){const n=this._visualElements;if(null==t){for(const e of n.values())e.visible=!1;return}const i=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,p)),l=r.maxScreenLengthSquaredFromGeometry(t,i),a=l<(o.pt2px(s.lineSize)*f.smallScreenLengthLineSizeFactor)**2,m=!a;n.marker.visible=m,n.dimension.visible=m,n.startOffset.visible=m,n.endOffset.visible=m,n.dimensionSmall.visible=a,n.startOffsetSmall.visible=a,n.endOffsetSmall.visible=a;const c=o.pt2px(s.fontSize)*f.minScreenLengthFontSizeFactor,{label:d}=n;if(d.visible=l>=c**2,!d.visible)return;const{dimensionSegment:u,primaryOffsetAxis:h}=t,{offset:S}=this.computation.dimension,g=(Math.sign(S)>=0?1:-1)*function(e){return 1.5*o.pt2px(e.fontSize)+f.labelMarginPx+o.pt2px(e.lineSize/2)}(s)*i;r.offsetSegment(this._labelSegment,u,h,g),d.updateLabelPosition()}updateLabelStyle(e){const{label:t}=this._visualElements;t.fontSize=o.pt2px(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)}_updateLabelContent(e){const{label:t}=this._visualElements;null!=e&&null!=this._messages?t.text=l.formatDecimal(this._messages,e,e.unit):t.text=""}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});