// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../Color","../../../../core/Accessor","../../../../core/has","../../../../core/lang","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","./ViewshedConfiguration","./ViewshedTool","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/PointVisualElement","../../interactive/visualElements/ViewshedShapeVisualElement","../../webgl-engine/materials/lineStippleUtils"],function(e,t,i,s,a,r,o,l,n,c,h,d,u,m,p,_,V,f,v,w,E,b){"use strict";function g(e,t,i,s,a,r,o=V.arcAnglePerSegment){const l=_.create();p.sub(l,i,t);const n=p.len(l),c=_.create();p.sub(c,s,t),p.normalize(c,c),p.scale(c,c,n);let h=p.angle(l,c);const d=_.clone(r);"backward"===a&&(p.negate(d,d),h=-(2*Math.PI-h));const f=[],v=Math.ceil(Math.abs(h)/o),w=m.create(),E=h/v;u.fromRotation(w,E,d);const b=_.create();p.copy(b,l);const g=_.create();p.copy(g,i);for(let e=0;e<v;e++){const e=_.create();p.copy(e,g),p.transformMat4(b,b,w),p.add(g,t,b);const i=_.create();p.copy(i,g),f.push([e,i])}e.geometry=f}return e.default=class extends s{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:_.create(),topRight:_.create(),bottomLeft:_.create(),bottomRight:_.create()},this._arcCenterPoints={top:_.create(),bottom:_.create(),left:_.create(),right:_.create()},this._parallelCenters={top:_.create(),bottom:_.create()}}initialize(){const e={view:this.view,isDecoration:!0},t={...e,color:this._color,renderOccluded:4},i={...t,stipplePattern:b.createStipplePatternSimple(2)};this._observerVisualElement=new w.PointVisualElement({...e,...V.viewshedVisualizationConfiguration.observerPointConfiguration}),this._shapeVisualElement=new E.ViewshedShapeVisualElement({...e,isDecoration:this.isDecoration}),this._frameLinesVisualElement=new v.LineVisualElement(t),this._leftArcVisualElement=new v.LineVisualElement(t),this._rightArcVisualElement=new v.LineVisualElement(t),this._topArcVisualElement=new v.LineVisualElement(t),this._bottomArcVisualElement=new v.LineVisualElement(t),this._centralLongitude=new v.LineVisualElement(i),this._centralLatitude=new v.LineVisualElement(i),this.addHandles([n.watch(()=>{const e=this.viewshedComputedData;if(!e?.valid)return null;const t=this._viewshedCorners,i=this._arcCenterPoints,s=this._parallelCenters;return e.cornerPoints(t),e.arcCentersPoints(i),e.parallelCenterPoints(s),{viewshedComputedData:e,corners:t,arcCenters:i,parallelCenters:s,interactive:this.analysisViewData.interactive,selected:this._selected}},e=>{const t=null!=e;this._forEachVisualElement(e=>e.attached=t),t&&this._updateVisualElements(e)},{initial:!0,equals:r.equals}),n.watch(()=>{const{viewshedComputedData:e}=this,{horizontalFieldOfView:t,verticalFieldOfView:i}=e??{};return{viewshedComputedData:e,horizontalFieldOfView:t,verticalFieldOfView:i}},({viewshedComputedData:e})=>{const{_shapeVisualElement:t}=this;e!==t.viewshedComputedData&&(t.viewshedComputedData=e),this._shapeVisualElement.recreateGeometry()},n.initial),n.watch(()=>{const{interactive:e}=this.analysisViewData;return{visible:this.visible,selected:e&&this._selected,staged:e&&this._staged,horFovNot360:360!==this.viewshedComputedData?.horizontalFieldOfView}},({visible:e,selected:t,staged:i,horFovNot360:s})=>{const a=t||i;this._shapeVisualElement.visible=e,this._topArcVisualElement.visible=e,this._bottomArcVisualElement.visible=e,this._frameLinesVisualElement.visible=e&&s;const r=e&&(t||s);this._leftArcVisualElement.visible=r,this._rightArcVisualElement.visible=r,this._forEachLineVisualElement(e=>{e.width=a?V.viewshedVisualizationConfiguration.frameWidthSelected:V.viewshedVisualizationConfiguration.frameWidthNotSelected,e.renderOccluded=t?4:1}),[this._centralLatitude,this._centralLongitude].forEach(i=>{i.width=2*(a?V.viewshedVisualizationConfiguration.frameWidthSelected:V.viewshedVisualizationConfiguration.frameWidthNotSelected),i.visible=e&&t})},n.initial),n.watch(()=>{const{analysisViewData:{interactive:e,tool:t},_selected:i,visible:s}=this,a=this.view.activeTool,r=!t?.active&&a instanceof f&&a.creating;return{observerVisible:s&&!i&&(!e||(t?.creating??!1)||r),color:this._color}},({observerVisible:e,color:t})=>{this._observerVisualElement.visible=e,this._forEachLineVisualElement(e=>e.color=t)},n.initial)])}get _color(){const{viewshedComputedData:e,_selected:t,analysisViewData:s}=this;if(null==e)return i.toUnitRGBA(V.viewshedVisualizationConfiguration.frameColor);const a=s.tool?.active||s.interactive,r=e.viewshed===s.tool?.stagedViewshed,o=a&&(t||r)?this.view.effectiveTheme.accentColor:V.viewshedVisualizationConfiguration.frameColor;return i.toUnitRGBA(o)}get _selected(){const{viewshedComputedData:e,analysisViewData:{selectedViewshedComputedData:t}}=this;return null!=e&&e===t}get _staged(){const{analysisViewData:{tool:e},viewshedComputedData:t}=this;return null!=e&&e.creating&&e.stagedViewshed===t?.viewshed}destroy(){this._observerVisualElement=l.destroyMaybe(this._observerVisualElement),this._shapeVisualElement=l.destroyMaybe(this._shapeVisualElement),this._frameLinesVisualElement=l.destroyMaybe(this._frameLinesVisualElement),this._leftArcVisualElement=l.destroyMaybe(this._leftArcVisualElement),this._rightArcVisualElement=l.destroyMaybe(this._rightArcVisualElement),this._topArcVisualElement=l.destroyMaybe(this._topArcVisualElement),this._bottomArcVisualElement=l.destroyMaybe(this._bottomArcVisualElement),this._centralLongitude=l.destroyMaybe(this._centralLongitude),this._centralLatitude=l.destroyMaybe(this._centralLatitude)}_forEachLineVisualElement(e){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_forEachVisualElement(e){this._forEachLineVisualElement(e),e(this._observerVisualElement),e(this._shapeVisualElement)}_updateVisualElements(e){const{viewshedComputedData:t,corners:i,arcCenters:s,parallelCenters:a}=e,r=_.clone(t.observerRenderSpace);this._observerVisualElement.geometry=t.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(r,i),this._updateFrameArcs(t,i,a),this._updateCentralHelperArcs(t,s)}_updateFrameLines(e,t){this._frameLinesVisualElement.geometry=[[e,t.topLeft],[e,t.topRight],[e,t.bottomLeft],[e,t.bottomRight]]}_updateFrameArcs(e,t,i){const{observerRenderSpace:s,rightVector:a,horizontalFieldOfView:r,tiltedUpVector:l}=e,n=o.deg2rad(r),c=_.create(),h=m.create();u.fromRotation(h,n/2,l),p.transformMat4(c,a,h),g(this._leftArcVisualElement,s,t.bottomLeft,t.topLeft,"forward",c),u.fromRotation(h,-n/2,l),p.set(c,0,0,0),p.transformMat4(c,a,h),g(this._rightArcVisualElement,s,t.bottomRight,t.topRight,"forward",c);const d=r>180?"backward":"forward";g(this._topArcVisualElement,i.top,t.topRight,t.topLeft,d,l),g(this._bottomArcVisualElement,i.bottom,t.bottomRight,t.bottomLeft,d,l)}_updateCentralHelperArcs(e,t){const i=e.observerRenderSpace,s=e.horizontalFieldOfView>=180?"backward":"forward";g(this._centralLatitude,i,t.right,t.left,s,e.tiltedUpVector),g(this._centralLongitude,i,t.top,t.bottom,"forward",e.leftVector)}get test(){}},t.__decorate([c.property()],e.default.prototype,"view",void 0),t.__decorate([c.property({constructOnly:!0})],e.default.prototype,"isDecoration",void 0),t.__decorate([c.property()],e.default.prototype,"analysisViewData",void 0),t.__decorate([c.property()],e.default.prototype,"viewshedComputedData",void 0),t.__decorate([c.property()],e.default.prototype,"visible",void 0),t.__decorate([c.property()],e.default.prototype,"_color",null),t.__decorate([c.property()],e.default.prototype,"_selected",null),t.__decorate([c.property()],e.default.prototype,"_staged",null),e.default=t.__decorate([d.subclass("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],e.default),e.default});