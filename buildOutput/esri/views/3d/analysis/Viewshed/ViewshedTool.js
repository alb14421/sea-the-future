// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../analysis/Viewshed","../../../../core/handleUtils","../../../../core/has","../../../../core/mapCollectionUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../../../../geometry/support/plane","./ViewshedConfiguration","./ViewshedSubTool","../../interactive/Manipulator3D","../../interactive/editingTools/settings","../../interactive/visualElements/ExtendedLineVisualElement","../../interactive/visualElements/LaserlineVisualElement","../../webgl-engine/lib/intersectorUtilsConversions","../../../interactive/AnalysisToolBase","../../../interactive/keybindings","../../../interactive/ToolIntersector","../../../support/screenUtils"],function(e,t,i,s,a,n,o,l,r,d,c,h,u,p,_,g,w,v,y,m,V,f,b,S,T,C,D,M,I){"use strict";const P=Symbol("interactionVisuals");e.default=class extends C.AnalysisToolBase{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=R,this._creationState=!1,this._interactionVisualElements=null,this._settings=new f.Settings({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=M.newToolIntersector(this.view.state.viewingMode),this._createInteractionVisuals();const e=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=n.mapCollection(()=>e,({viewshedComputedData:e})=>{const t=new m.ViewshedSubTool({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:t,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),t.destroy()}}}),this.addHandles([r.when(()=>this._valid,()=>this.finishToolCreation(),r.syncAndInitial),r.watch(()=>this._stagedViewshed,e=>{const t=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=null!=e&&null!=t?this._findSubTool(e)?.viewshedComputedData:null},r.syncAndInitial),this.analysis.viewsheds.on("after-remove",e=>{const t=this._stagedViewshed;null!=t&&e.item===t&&this.analysis.viewsheds.add(t)}),r.watch(()=>this.firstGrabbedManipulator,e=>{if(null!=e){const t=this._findSubTool(e)?.viewshed;this.selectedViewshed=t,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()},r.sync),r.watch(()=>this.view.activeTool,e=>{e!==this&&null!=e&&(this.selectedViewshed=null)}),r.when(()=>{const e=this.selectedViewshedComputedData;return null==e?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}},e=>{const{subTool:t,observer:i,target:s}=e;t?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(i,!0):t?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(s,!1)},r.initial),r.watch(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),r.watch(()=>this.selectedViewshed,e=>{const t=this._selectedManipulator,i=this._selectedSubTool;null==e?this._selectManipulator(null):null!=t&&i.hasManipulator(t)||this._selectManipulator(i.discManipulator)},r.initial)])}destroy(){this.subToolHandles=l.destroyMaybe(this.subToolHandles),this.removeHandles(P)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){return this.analysisViewData.viewshedComputedDataHandles?.some(e=>e.viewshedComputedData.valid)??!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(e){const t=this._selectedManipulator;t!==e&&(this._selectedManipulator=e,null!=t&&(t.selected=!1),null!=e&&(e.selected=!0),this._findSubTool(t)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(e){this.analysisViewData.selectedViewshed=e}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:e})=>e.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return"placing-target"===this._creationState}place(e){this.selectedViewshed=null,this._placementMode=e,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach(e=>e.subTool.onManipulatorSelectionChanged())}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":D.sketchKeys.cancel===e.key?this._cancelKeyHandler(e):D.sketchKeys.delete.includes(e.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickPlacementHandler(e)}onActivate(){this._placementMode=R}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(e,O);if(null!=t){if("placing-observer"===this._creationState){t.mapPoint.z=(t.mapPoint.z??0)+y.creationVerticalOffset;const e=new i({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if("placing-target"===this._creationState){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._stagedViewshed=null,"multiple"===this._placementMode?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=e}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating)return;const t=this._intersectScreen(e,O);null!=t&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(e){this.creating?this._onCancelWhileCreating(e):this.grabbing||(this.selectedViewshed=null,e.stopPropagation())}_onCancelWhileCreating(e){const t=this.removeStaged();this._finishToolCreationIfValid(),t?(this._creationState="placing-observer",this.selectedViewshed=null,"multiple"===this._placementMode&&e.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(null==t||null==i)return;const{heading:s,tilt:a,farDistance:n}=function(e,t,i){const s=t.observerRenderSpace,a=_.sub(H,i,s),n=_.len(a)*t.metersPerUnit,l=e.renderCoordsHelper.basisMatrixAtPosition(s,A),r=_.set(E,l[8],l[9],l[10]),d=v.fromPositionAndNormal(s,r,x),c=v.projectPoint(d,i,k),h=_.sub(c,c,s),u=(_.len(h)<1e-4?90:o.rad2deg(_.angle(a,h)))*(_.dot(r,a)<0?-1:1)+90,p=_.set(L,l[4],l[5],l[6]),g=o.rad2deg(_.angle(p,h)),w=_.set(L,l[0],l[1],l[2]);return{heading:_.dot(h,w)<0?360-g:g,tilt:u,farDistance:n}}(this.view,i,e);t.farDistance=n,t.tilt=a,t.heading=s}removeStaged(){const e=this._stagedViewshed;return null!=e&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(e),!0)}_intersectScreen(e,t){const i=I.createScreenPointArrayFromEvent(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,a=t.scenePoint;if(!s.getIntersectionPoint(a))return null;const n=t.mapPoint;return n.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,n),null==n?null:(t.feature=T.toGraphic(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(P);const e=this._settings.visualElements,t=new S.LaserlineVisualElement({view:this.view,attached:!1,style:{glowWidth:e.heightPlane.glowWidth,innerWidth:e.heightPlane.innerWidth},isDecoration:!0}),i=new b.ExtendedLineVisualElement({view:this.view,extensionType:e.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:i},this.addHandles([r.watch(()=>e.zVerticalLine,e=>e.apply(i),r.syncAndInitial),r.watch(()=>e.heightPlane,e=>e.apply(t),r.syncAndInitial),s.makeHandle(()=>{t.destroy(),i.destroy(),this._interactionVisualElements=null})],P)}updateInteractionVisualsVisibility(e=!1){const t=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,a=this.selectedViewshedComputedData,n=(e,t)=>{const i=this._interactionVisualElements;null!=i&&(i.verticalLine.attached=t,i.laserline.attached=e)};if(t)return void n(i,!1);if(null==s||null==a)return void n(!1,!1);const o=s.moveInteractionState,l=e?o.grabbing:o.dragging,r=s.scaleOrientInteractionState,d=e?r.grabbing:r.dragging,c=i&&(l||d);if(n(c,l),c){const e=l?a.observerRenderSpace:a.targetRenderSpace;this._updateInteractionVisualsLocation(e,l)}}_updateInteractionVisualsLocation(e,t){const i=this._interactionVisualElements;if(null==i)return;const{laserline:s,verticalLine:a}=i;s.heightManifoldTarget=e,s.intersectsWorldUpAtLocation=t?e:null,null!=e&&a.setStartEndFromWorldDownAtLocation(e)}_findSubTool(e){if(null==e)return null;const t=e instanceof V.Manipulator3D?t=>t.subTool.hasManipulator(e):t=>t.subTool.viewshed===e;return this.subToolHandles?.find(t)?.subTool}get test(){}},t.__decorate([d.property({constructOnly:!0})],e.default.prototype,"view",void 0),t.__decorate([d.property()],e.default.prototype,"analysisViewData",void 0),t.__decorate([d.property()],e.default.prototype,"removeIncompleteOnCancel",void 0),t.__decorate([d.property()],e.default.prototype,"automaticManipulatorSelection",void 0),t.__decorate([d.property({constructOnly:!0})],e.default.prototype,"analysis",void 0),t.__decorate([d.property()],e.default.prototype,"subToolHandles",void 0),t.__decorate([d.property()],e.default.prototype,"_stagedViewshed",void 0),t.__decorate([d.property()],e.default.prototype,"_stagedViewshedComputedData",void 0),t.__decorate([d.property()],e.default.prototype,"_placementMode",void 0),t.__decorate([d.property()],e.default.prototype,"_creationState",void 0),t.__decorate([d.property()],e.default.prototype,"_valid",null),t.__decorate([d.property({readOnly:!0})],e.default.prototype,"cursor",null),t.__decorate([d.property()],e.default.prototype,"_selectedManipulator",void 0),t.__decorate([d.property()],e.default.prototype,"_selectedSubTool",null),t.__decorate([d.property()],e.default.prototype,"selectedViewshed",null),t.__decorate([d.property()],e.default.prototype,"selectedViewshedComputedData",null),t.__decorate([d.property()],e.default.prototype,"stagedViewshed",null),t.__decorate([d.property()],e.default.prototype,"grabbing",null),t.__decorate([d.property()],e.default.prototype,"creating",null),t.__decorate([d.property()],e.default.prototype,"isPlacingTarget",null),e.default=t.__decorate([u.subclass("esri.views.3d.analysis.Viewshed.ViewshedTool")],e.default);const H=g.create(),E=g.create(),k=g.create(),L=g.create(),A=p.create(),x=v.create(),O={mapPoint:new w,scenePoint:g.create(),feature:null},R="multiple";return e.default});