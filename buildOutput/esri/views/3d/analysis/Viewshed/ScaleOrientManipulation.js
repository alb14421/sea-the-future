// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Handles","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/boundedPlane","../../../../geometry/support/ray","../Slice/sliceToolConfig","./ArrowManipulator","./ViewshedConfiguration","./viewshedToolUtils","../../interactive/editingTools/dragEventPipeline3D","../../interactive/editingTools/manipulations/config","../../interactive/editingTools/manipulations/InteractiveManipulation","../../../interactive/dragEventPipeline"],function(e,t,i,a,n,r,o,l,s,c,u,p,d,m,h,g,_){"use strict";class v extends g.InteractiveManipulation{constructor(e){super(),this._handles=new t,this._tool=e.tool,this._view=e.view;const i=p.viewshedToolManipulatorConfiguration.scaleOrientHandleRadius;this._manipulatorHeading=new u.ArrowManipulator(this._view,i),this._manipulatorTilt=new u.ArrowManipulator(this._view,i),this._manipulatorDistance=new u.ArrowManipulator(this._view,i),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return _.createManipulatorDragEventPipeline(this._manipulatorHeading,(a,n,o,s,c)=>{const u=this._view,{tiltParallelToSurface:p,farDistanceRenderSpace:m,upVector:h,observerRenderSpace:g,targetRenderSpace:_,rightVector:v}=t,f=Math.sin(i.deg2rad(p))*m,T=r.add(w,g,r.scale(M,h,f)),R=r.sub(M,_,T),S=r.scale(D,v,r.len(R)),y=l.fromValues(T,R,S),P=d.screenToCircleAngle(n,u,y,t).next(e=>({...e,manipulatorType:3}));e(a,P,o)})}createTiltDragPipeline(e,t){return _.createManipulatorDragEventPipeline(this._manipulatorTilt,(i,a,n,o,s)=>{const{observerRenderSpace:c,farDistanceRenderSpace:u,upVector:p,targetDirection:m}=t,h=r.dot(m,p),g=r.scaleAndAdd(w,m,p,-h);r.scale(g,r.normalize(g,g),u);const _=r.scale(M,p,u),v=l.fromValues(c,g,_),f=d.screenToCircleAngle(a,this._view,v,t).next(e=>({...e,manipulatorType:3}));e(i,f,n)})}createDistanceDragPipeline(e,t){return _.createManipulatorDragEventPipeline(this._manipulatorDistance,(i,a,n,r,o)=>{const l=s.fromValues(t.observerRenderSpace,t.targetDirection),c=a.next(_.dragAtLocation(this._view,i.location)).next(m.screenToRenderRay(this._view,l)).next(e=>({...e,manipulatorType:2}));e(i,c,n)})}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const i=n.create(),o=e=>{a.multiply(i,e,i)},l=p.viewshedToolManipulatorConfiguration.scaleOrientSize*(h.discRadiusSmall/h.discRadius);o(a.fromScaling(f,r.set(w,l,l,l))),o(d.getViewshedRotationMatrix(e,f));const s=p.viewshedToolManipulatorConfiguration.scaleOrientHandleRadius*c.displayFocusMultiplier*l,u=r.scale(w,e.targetDirection,s);o(a.fromTranslation(f,u));const m=a.fromZRotation(f,-R);a.mul(m,m,a.fromYRotation(T,-R)),this._manipulatorHeading.modelTransform=a.mul(n.create(),i,m);const g=a.fromYRotation(f,R);a.mul(g,g,a.fromZRotation(T,Math.PI)),this._manipulatorTilt.modelTransform=a.multiply(n.create(),i,g),this._manipulatorDistance.modelTransform=i}forEachManipulator(e){e(this._manipulatorHeading,3),e(this._manipulatorTilt,3),e(this._manipulatorDistance,2)}}const f=n.create(),T=n.create(),w=o.create(),M=o.create(),D=o.create(),R=Math.PI/2;e.ScaleOrientManipulation=v,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});