// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/plane","./ViewshedConfiguration","../../interactive/manipulatorUtils","../../interactive/editingTools/dragEventPipeline3D","../../support/cameraUtils","../../support/cameraUtilsInternal"],function(e,t,r,n,a,o,i,c,s,l,d,u){"use strict";const p=o.create(),g=o.create(),m=o.create(),f=o.create(),h=n.create();e.getViewshedRotationMatrix=function({tiltedUpVector:e,rightVector:t,observerRenderSpace:r},n){const a=s.calculateTranslateRotateFromBases(e,t,r,n);return a[12]=0,a[13]=0,a[14]=0,a},e.rotateBy=function(e,t,n,o){return r.fromRotation(h,n,o),a.transformMat4(e,t,h)},e.screenToCircleAngle=function(e,r,n,h){const b=o.create(),R=i.getNormal(n.plane),T=function(e,r){const n=p;e.renderCoordsHelper.toRenderCoords(e.camera.position,n);const o=d.headingTiltToDirectionUp(e,n,e.camera.heading,e.camera.tilt,u.createDirectionUp()).direction;return t.rad2deg(a.angle(o,r))-90}(r,R);let v;if(Math.abs(T)>c.viewshedToolManipulatorConfiguration.viewAngleThreshold)v=e.next(l.screenToRenderPlane(r,n.plane));else{const c=i.fromPositionAndNormal(h.targetRenderSpace,n.basis1,i.create()),s=a.normalize(p,n.basis1),d=a.normalize(g,n.basis2);v=e.next(l.screenToRenderPlane(r,c)).next(e=>{const r=e=>{const r=a.dot(a.sub(m,e,n.origin),d),i=Math.acos(t.clamp(r/h.farDistanceRenderSpace,-1,1)),c=Math.sin(i)*h.farDistanceRenderSpace;return a.add(o.create(),n.origin,a.add(o.create(),a.scale(m,s,c),a.scale(f,d,r)))},i=r(e.renderStart),c=r(e.renderEnd);return{...e,renderStart:i,renderEnd:c}})}return v.next(e=>{"start"===e.action&&a.copy(b,e.renderStart);const r=t.rad2deg(s.calculateInputRotationTransform(b,e.renderEnd,n.origin,R));return{...e,deltaAngle:r}})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});