// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../Color","../../../../core/Accessor","../../../../core/Handles","../../../../core/handleUtils","../../../../core/has","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/support/UpdatingHandles","./LineOfSightConfiguration","./LineOfSightVisualElement","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/PointVisualElement"],function(i,e,t,n,o,a,s,r,l,c,u,d,h,g,p,m,f,v,y,b,_){"use strict";i.LineOfSightVisualization=class extends n{constructor(i){super(i),this._lineOfSightVisualElements=new Array,this._computationHandles=new o,this._updatingHandles=new f.UpdatingHandles}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=r.destroyMaybe(this._updatingHandles),this._computationHandles=r.destroyMaybe(this._computationHandles),this._observerVisualElement=r.destroyMaybe(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){}_createLineOfSightVisualization(){const i=v.lineOfSightConfiguration,e=this.view,n=this.isDecoration,o={view:e,attached:!0,width:i.outerWidth,innerWidth:i.innerWidth,isDecoration:n},a=t.toUnitRGBA(i.visibleOuterColor),s=t.toUnitRGBA(i.visibleInnerColor),r=t.toUnitRGBA(i.occludedOuterColor),l=t.toUnitRGBA(i.occludedInnerColor),c=t.toUnitRGBA(i.undefinedOuterColor),u=t.toUnitRGBA(i.undefinedInnerColor),d=new b.LineVisualElement({...o,color:a,innerColor:s}),h=new b.LineVisualElement({...o,color:r,innerColor:l}),g=new b.LineVisualElement({...o,color:c,innerColor:u}),p=new _.PointVisualElement({view:e,attached:!0,...O,size:8,isDecoration:n}),m=new y.LineOfSightVisualElement(d,h,g,p);return this._lineOfSightVisualElements.push(m),m}_destroyLineOfSightVisualization(i){i.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(i),1)}_updateLineOfSightVisualization(i,e,n){const o=v.lineOfSightConfiguration,{computationResult:a,inputPoints:s}=i,{start:r,end:l,intersection:c,isValid:u,isTargetVisible:d}=a,{observer:h}=s,g=L;g[12]=h[0],g[13]=h[1],g[14]=h[2];const f=p.subtract(V,r,h),y=p.subtract(C,l,h),b=p.subtract(S,c,h),{visibleLineVisualElement:_,occludedLineVisualElement:O,undefinedLineVisualElement:A,targetVisualElement:E}=e,z=null==this.analysisViewData.elevationAlignedObserver||null==i.elevationAlignedTargetLocation,w=this.visible&&!z;_.visible=w,O.visible=w,A.visible=w,E.visible=w,E.attached=!n.interactiveAndEditable,w&&(_.geometry=null,O.geometry=null,A.geometry=null,E.geometry=i.elevationAlignedTargetLocation,u?d?(_.geometry=[[m.fromArray(f),m.fromArray(y)]],_.transform=g,_.color=t.toUnitRGBA(o.visibleOuterColor),E.color=t.toUnitRGBA(o.visibleInnerColor)):(_.geometry=[[m.fromArray(f),m.fromArray(b)]],_.transform=g,_.color=t.toUnitRGBA(o.occludedOuterColor),O.geometry=[[m.fromArray(b),m.fromArray(y)]],O.transform=g,E.color=t.toUnitRGBA(o.occludedInnerColor)):(A.geometry=[[m.fromArray(f),m.fromArray(y)]],A.transform=g,E.color=t.toUnitRGBA(o.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(i){const{computationResult:e}=i,{occludedOuterColor:t,visibleOuterColor:n}=v.lineOfSightConfiguration;return{computationResult:e,occludedOuterColor:t,visibleOuterColor:n,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(i){const e=this._computationHandles;if(e.has(i))return;const t=this._createLineOfSightVisualization();e.add([this._updatingHandles.add(()=>this._getLineOfSightVisualizationDependencies(i),e=>this._updateLineOfSightVisualization(i,t,e),{initial:!0,equals:()=>!1}),a.makeHandle(()=>this._destroyLineOfSightVisualization(t))],i)}_disconnectComputation(i){this._computationHandles.remove(i)}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,i=>this._onComputationsCollectionChange(i),{initial:!0,final:!0})}_onComputationsCollectionChange({added:i,removed:e}){for(const i of e)this._disconnectComputation(i);for(const e of i)this._connectComputation(e)}_createObserverVisualization(){const i=t.toUnitRGBA(v.lineOfSightConfiguration.visibleInnerColor),e=new _.PointVisualElement({view:this.view,color:i,...O,isDecoration:this.isDecoration});this._observerVisualElement=e,this.addHandles(this._updatingHandles.add(()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible}),({observer:i,interactiveAndEditable:t,visible:n})=>{null!=i&&!t&&n?(e.geometry=i,this._observerVisualElement.attached=!0):e.attached=!1},l.initial))}},e.__decorate([c.property({constructOnly:!0})],i.LineOfSightVisualization.prototype,"analysis",void 0),e.__decorate([c.property({constructOnly:!0})],i.LineOfSightVisualization.prototype,"analysisViewData",void 0),e.__decorate([c.property({constructOnly:!0})],i.LineOfSightVisualization.prototype,"view",void 0),e.__decorate([c.property({readOnly:!0})],i.LineOfSightVisualization.prototype,"visible",null),e.__decorate([c.property({constructOnly:!0})],i.LineOfSightVisualization.prototype,"isDecoration",void 0),e.__decorate([c.property()],i.LineOfSightVisualization.prototype,"updating",null),e.__decorate([c.property()],i.LineOfSightVisualization.prototype,"interactiveAndEditable",null),e.__decorate([c.property()],i.LineOfSightVisualization.prototype,"test",null),i.LineOfSightVisualization=e.__decorate([h.subclass("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],i.LineOfSightVisualization);const O={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},V=m.create(),C=m.create(),S=m.create(),L=g.create();Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})});