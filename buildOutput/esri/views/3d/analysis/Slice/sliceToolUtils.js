// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../analysis/SlicePlane","../../../../core/has","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Extent","../../../../geometry/Point","../../../../geometry/projectionUtils","../../../../chunks/boundedPlane","../../../../geometry/support/plane","../../../../geometry/support/ray","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","./settings","./sliceToolConfig","../support/projectionUtils","../../interactive/manipulatorUtils","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/SlicePlaneVisualElement","../../support/RenderCoordsHelper","../../support/geometryUtils/ray"],function(e,t,n,i,s,o,r,a,l,c,d,u,g,p,b,f,m,h,v,P,y,R,w,S,A){"use strict";function M(e,t,n,i,s,o){const r=a.dot(e,t),l=m.sv3d.get(),c=m.sv3d.get();switch(0===i?Math.abs(r)>v.verticalDotThreshold?1:2:i){case 2:{const i=Math.abs(r)<=v.smallAngleDotThreshold?e:n.viewUp;a.cross(l,i,t),a.copy(c,t);break}case 1:a.cross(l,n.viewUp,t),a.cross(c,t,l);break;case 3:{const i=Math.abs(r)<=v.smallAngleDotThreshold?t:n.viewUp;a.cross(l,i,e),a.cross(c,e,l);break}}const d=a.cross(m.sv3d.get(),l,c);a.dot(d,n.viewForward)>0&&a.scale(c,c,-1),a.normalize(s,l),a.normalize(o,c)}function T(e,t,n){const i=t.worldUpAtPosition(e.origin,m.sv3d.get()),s=e.basis1,o=E(e,i),r=Math.round(o/O)*O;return g.rotate(e,r-o,s,n)}function H(e,t){switch(t){case 0:return{basis:e.basis1,direction:1,position:a.add(m.sv3d.get(),e.origin,e.basis1),edge:t};case 1:return{basis:e.basis2,direction:1,position:a.add(m.sv3d.get(),e.origin,e.basis2),edge:t};case 2:return{basis:e.basis1,direction:-1,position:a.subtract(m.sv3d.get(),e.origin,e.basis1),edge:t};case 3:return{basis:e.basis2,direction:-1,position:a.subtract(m.sv3d.get(),e.origin,e.basis2),edge:t}}}function z(e,t,n){const i=n.projectToRenderScreen(a.add(m.sv3d.get(),e,t),o.castRenderScreenPointArray3(m.sv3d.get())),s=n.projectToRenderScreen(a.subtract(m.sv3d.get(),e,t),o.castRenderScreenPointArray3(m.sv3d.get()));return a.squaredLength(a.subtract(i,i,s))}function U(e){const t=a.length(e.basis1),n=a.length(e.basis2);return v.resizeHandleEdgePaddingFrac*Math.min(t,n)}function x(e){return U(e)}function C(e){return 0!==e.direction[0]&&0!==e.direction[1]}function E(e,t){return f.angleAroundAxis(t,e.basis2,e.basis1)+O}function j(e,t){if(null==e?.position)return null;const n=P.applyProjectionAndElevationAlignment(e.position,t.spatialReference,t.elevationProvider);if(null==n)return null;const i=S.RenderCoordsHelper.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),s=e.width*i,o=e.height*i;return{position:n,heading:e.heading,tilt:e.tilt,renderWidth:s,renderHeight:o}}function L(e,t,n,o=g.create()){if(null==e)return null;const r=function(e,t,n,o,r,l,c=g.create()){return l.toRenderCoords(e,c.origin)?(l.worldBasisAtPosition(c.origin,0,c.basis1),l.worldBasisAtPosition(c.origin,1,c.basis2),p.fromVectorsAndPoint(c.basis2,c.basis1,c.origin,c.plane),g.rotate(c,-s.deg2rad(t),g.normal(c),c),g.rotate(c,s.deg2rad(n),c.basis1,c),a.scale(c.basis1,c.basis1,o/2),a.scale(c.basis2,c.basis2,r/2),g.updateUnboundedPlane(c),c):(i.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,o);return n.tiltEnabled||null==r||T(r,t.renderCoordsHelper,r),r}const V=b.create(),O=Math.PI/2;e.DidPointerMoveRecentlyFlag=16,e.IsShiftEdgeOnScreenFlag=32,e.calculateBoundedPlaneTranslateRotate=function(e,t){return y.calculateTranslateRotateFromBases(e.basis1,e.basis2,e.origin,t)},e.calculateDiagonalResizeHandleScale=x,e.calculatePlaneHalfSize=function(e,t){return v.initialPlaneHalfSizeViewProportion*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)},e.createGridVisualElement=function(e){return new w.SlicePlaneVisualElement({view:e,attached:!1,backgroundColor:h.planeColor,gridColor:h.getGridColor(e.effectiveTheme),gridWidth:4,renderOccluded:4,isDecoration:!0})},e.createOutlineVisualElement=function(e){return new R.LineVisualElement({view:e,attached:!1,color:h.getOutlineColor(e.effectiveTheme),width:v.planeOutlineWidth,renderOccluded:4,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]],isDecoration:!0})},e.createPlane=function(e,t,n,i,s,o,r,l){return M(t,r.worldUpAtPosition(e,m.sv3d.get()),s,o,l.basis1,l.basis2),a.scale(l.basis1,l.basis1,n),a.scale(l.basis2,l.basis2,i),a.copy(l.origin,e),p.fromVectorsAndPoint(l.basis2,l.basis1,l.origin,l.plane),l},e.createRotatePlane=function(e,t,n,i){const s=t.worldUpAtPosition(e.origin,m.sv3d.get()),o=m.sv3d.get();switch(n){case 1:a.copy(o,s);break;case 2:a.copy(o,e.basis1)}return p.fromPositionAndNormal(e.origin,o,i)},e.createShiftPlane=function(e,t,n,i){const s=a.cross(m.sv3d.get(),t,n);return a.cross(s,s,t),p.fromPositionAndNormal(e,s,i)},e.forceHorizontalOrVertical=T,e.isBuildingSceneLayerView3D=function(e){return null!=("building-scene-3d"===e.type?e:null)},e.isDiagonalResizeHandle=C,e.normalToBases=M,e.planeToExtent=function(e,t,n){if(null==e)return null;const i=e.origin,s=m.sv3d.get(),o=m.sv3d.get(),r=m.sv3d.get(),l=m.sv3d.get();let d,u,g,p,b,f;a.add(s,i,e.basis1),a.add(s,s,e.basis2),a.add(o,i,e.basis1),a.sub(o,o,e.basis2),a.sub(r,i,e.basis1),a.sub(r,r,e.basis2),a.sub(l,i,e.basis1),a.add(l,l,e.basis2);for(const e of[s,o,r,l]){const i=t.fromRenderCoords(e,e,n);if(null==i)return null;d=null==d?i[0]:Math.min(d,i[0]),u=null==u?i[0]:Math.max(u,i[0]),g=null==g?i[1]:Math.min(g,i[1]),p=null==p?i[1]:Math.max(p,i[1]),b=null==b?i[2]:Math.min(b,i[2]),f=null==f?i[2]:Math.max(f,i[2])}return new c({xmin:d,xmax:u,ymin:g,ymax:p,zmin:b,zmax:f,spatialReference:n})},e.planeToShape=function(e,n,i,o=new t){if(null==e)return null;const{renderCoordsHelper:r}=n,l=r.fromRenderCoords(e.origin,new d({spatialReference:n.spatialReference}));if(null==l)return null;const c=u.tryProjectWithZConversion(l,i);if(null==c)return null;o.position=c;const g=2*a.length(e.basis1),p=2*a.length(e.basis2),b=S.RenderCoordsHelper.renderUnitScaleFactor(n.spatialReference,i);o.width=g*b,o.height=p*b;const f=r.worldUpAtPosition(e.origin,m.sv3d.get());return o.tilt=s.rad2deg(E(e,f)),o.heading=r.headingAtPosition(e.origin,e.basis1)-90,o},e.projectAndElevationAlignShape=j,e.projectedShapeToPlane=L,e.resizeNormal=16,e.resizeOutlineOnly=32,e.resizePlane=function(e,t,n,i,s,o){const r=a.copy(m.sv3d.get(),s.origin);a.add(r,r,a.scale(m.sv3d.get(),s.basis1,e.direction[0]<0?1:-1)),a.add(r,r,a.scale(m.sv3d.get(),s.basis2,e.direction[1]<0?1:-1));const l=a.length(s.basis1),c=a.length(s.basis2),d=a.subtract(m.sv3d.get(),n,r),u=a.subtract(m.sv3d.get(),t,r);let p=0,b=0;if(C(e)){const t=x(s),n=x(o);p=l-.5*e.direction[0]*a.dot(s.basis1,u)/l,b=c-.5*e.direction[1]*a.dot(s.basis2,u)/c;const i=n/t;p*=i,b*=i}const f=p+.5*e.direction[0]*a.dot(s.basis1,d)/l,h=b+.5*e.direction[1]*a.dot(s.basis2,d)/c,P=a.scale(m.sv3d.get(),s.basis1,f/l),y=a.scale(m.sv3d.get(),s.basis2,h/c);(f<=0||z(o.origin,P,i)<=v.planeMinBasisScreenLen2)&&a.copy(P,o.basis1),(h<=0||z(o.origin,y,i)<=v.planeMinBasisScreenLen2)&&a.copy(y,o.basis2);const R=a.copy(m.sv3d.get(),r);return a.add(R,R,a.scale(m.sv3d.get(),P,e.direction[0]<0?-1:1)),a.add(R,R,a.scale(m.sv3d.get(),y,e.direction[1]<0?-1:1)),g.fromValues(R,P,y,o)},e.shapeToPlane=function(e,t,n,i=g.create()){const s=j(e,t);return null==s?null:L(s,t,n,i)},e.updateResizeHandle=function(e,t,n,i){const s=a.length(i.basis1),o=a.length(i.basis2),l=U(i),c=x(i),d=a.set(m.sv3d.get(),0,0,0);a.add(d,a.scale(m.sv3d.get(),i.basis1,t.direction[0]),a.scale(m.sv3d.get(),i.basis2,t.direction[1])),a.add(d,i.origin,d);let u=0,g=1;if(C(t))1===t.direction[0]&&-1===t.direction[1]?u=O:1===t.direction[0]&&1===t.direction[1]?u=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(u=3*Math.PI/2),g=c;else{const e=0!==t.direction[0]?1:2;u=1===e?O:0,g=(1===e?o:s)-l}const p=r.fromZRotation(m.sm4d.get(),u);r.scale(p,p,a.set(m.sv3d.get(),g,g,g)),r.multiply(p,n,p),p[12]=0,p[13]=0,p[14]=0,e.modelTransform=p,e.renderLocation=d},e.updateRotateHeadingHandle=function(e,t,n,i){const s=i.worldUpAtPosition(n.origin,m.sv3d.get()),o=H(n,0),a=r.fromZRotation(m.sm4d.get(),o.edge*Math.PI/2);r.rotateX(a,a,-E(n,s)),r.multiply(a,t,a),a[12]=0,a[13]=0,a[14]=0,e.modelTransform=a,e.renderLocation=o.position},e.updateRotateTiltHandle=function(e,t,n){const i=H(n,1),s=r.fromZRotation(m.sm4d.get(),i.edge*Math.PI/2);r.rotateX(s,s,O),r.multiply(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=i.position},e.updateShiftRestartHandle=function(e,t,n,i){const s=H(n,2),c=m.sm4d.get();r.rotateZ(c,t,s.edge*Math.PI/2);const d=a.normalize(m.sv3d.get(),s.basis);let u=a.scale(m.sv3d.get(),d,s.direction*i.computeScreenPixelSizeAt(s.position)*v.shiftRestartOffsetDistance);a.add(u,u,s.position);const p=i.projectToRenderScreen(u,o.castRenderScreenPointArray3(m.sv3d.get())),b=function(e,t){const[n,i,s,o]=e.viewport,r=Math.min(s,o)/16;let a=!0;return t[0]<n+r?(t[0]=n+r,a=!1):t[0]>n+s-r&&(t[0]=n+s-r,a=!1),t[1]<i+r?(t[1]=i+r,a=!1):t[1]>i+o-r&&(t[1]=i+o-r,a=!1),a}(i,p);A.fromRender(i,p,V),a.normalize(V.direction,V.direction);const f=m.sv3d.get();!b&&g.intersectRay(n,V,f)&&(u=f),c[12]=0,c[13]=0,c[14]=0,e.modelTransform=c,e.renderLocation=l.clone(u),b?e.state|=32:e.state&=-33},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});