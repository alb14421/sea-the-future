// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Collection","../../../core/Error","../../../core/handleUtils","../../../core/Logger","../../../core/MapUtils","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/buildingSublayers/BuildingGroupSublayer","../../../support/guards","./BuildingComponentSublayerView3D","./BuildingSublayerView3D","./LayerView3D","./i3s/BuildingFilterUtil","./i3s/I3SUtil","./support/highlightUtils","./support/LayerViewPerformanceInfo","../support/updatingProperties","../../layers/BuildingSceneLayerView","../../support/layerViewUtils"],function(e,r,t,i,s,n,o,l,a,u,c,h,p,y,d,g,w,f,b,V,_,m,S,v,C,M){"use strict";const B=f.BuildingSublayerView3DMixin(r);let I=class extends(b.LayerView3D(C)){constructor(e){super(e),this.type="building-scene-3d",this.sublayerViews=new t,this._rejectedSublayerViews=new Map,this._abortController=new AbortController,this._loadingComponents=0,this._pendingWhenSublayerViews=new Map,this.ignoresMemoryFactor=!1}get filterExpression(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find(r=>r.id===e):null,t=null!=r?r.filterBlocks?.find(e=>"solid"===e.filterMode.type):null;return t?t.filterExpression:null}get filterExpressions(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find(r=>r.id===e):null;return r?.filterBlocks?r.filterBlocks.toArray().map(e=>[e.filterExpression??"",V.parseFilterMode(e)]):[]}get updatingProgressValue(){const e=this.sublayerViews,r=this._loadingComponents+(e?e.length:0);return e.reduce((e,r)=>e+r.updatingProgress,0)/r}get visibleAtCurrentScale(){return M.isInEffectiveScaleRange(this.layer.effectiveScaleRange,this.view.scale)}isUpdating(){return this._loadingComponents>0||this.sublayerViews&&this.sublayerViews.some(e=>e.updating)}initialize(){_.checkSpatialReference(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this._initializeSublayerViews(this.layer.sublayers,this)}destroy(){this.sublayerViews&&(this.sublayerViews.forEach(e=>e.destroy()),this.sublayerViews=null),this._rejectedSublayerViews=null,this._abortController=l.abortMaybe(this._abortController)}_initializeSublayerViews(e,r){const t=this,s=this.view;e.forEach(e=>{if(!e.isEmpty)if("building-group"===e.type){const t=new B({sublayer:e,view:s,parent:r});this._initializeSublayerViews(e.sublayers,t)}else"mesh"===e.geometryType?(this._loadingComponents++,e.load({signal:this._abortController.signal}).then(()=>{const i=new w({sublayer:e,layerView:t,view:s,parent:r});this.sublayerViews.push(i);const n=this._pendingWhenSublayerViews.get(e);if(n){for(const e of n)e.resolve(i);this._pendingWhenSublayerViews.delete(e)}this.addHandles([u.watch(()=>i.updating,()=>this.notifyChange("updating"),u.syncAndInitial),u.watch(()=>i.updatingProgress,()=>this.notifyChange("updatingProgressValue"),u.syncAndInitial)])}).catch(r=>{a.isAbortError(r)||n.getLogger(this).error(`Error while creating view for sublayer ${e.id}\nLayer: ${this.layer.url}\n`,r),this._rejectWhenSublayerView(e,r)}).then(()=>{this._loadingComponents--,this.notifyChange("updating"),this.notifyChange("updatingProgressValue")})):this._rejectWhenSublayerView(e,new i("view:no-layerview-for-sublayer",`No layerview created for sublayer ${e.id}`))})}getGraphicFromIntersectorTarget(e,r){for(const t of this.sublayerViews.items)if(t.sublayer.id===e.sublayerId)return t.getGraphicFromIntersectorTarget(e,r);return null}async fetchPopupFeaturesFromGraphics(e,r){if(0===e.length)return[];const t=function(e,r){const t=new Map,i=e.length;for(let s=0;s<i;s++){const i=e[s],n=r(i),o=t.get(n);o?o.push(i):t.set(n,[i])}return t}(e,e=>e.sourceLayer),i=[];for(const[e,s]of t){const t=this._findComponent(e);null!=t&&i.push(t.fetchPopupFeaturesFromGraphics(s,r))}const s=await a.allSettledValues(i);return a.throwIfAborted(r),s.flat()}whenGraphicBounds(e){const r=this._findComponent(e.sourceLayer);return null==r?Promise.reject():r.whenGraphicBounds(e)}getAABBFromIntersectorTarget(e){for(const r of this.sublayerViews.items)if(r.sublayer.id===e.sublayerId)return r.getAABBFromIntersectorTarget(e);return null}async whenSublayerView(e){const r=this._findComponent(e);if(null!=r)return r;const t=this._rejectedSublayerViews.get(e);if(null!=t)throw t;const i=this._pendingWhenSublayerViews.get(e),s=a.createResolver();return i?i.push(s):this._pendingWhenSublayerViews.set(e,[s]),s.promise}_rejectWhenSublayerView(e,r){this._rejectedSublayerViews.set(e,r);const t=this._pendingWhenSublayerViews.get(e);if(t){for(const e of t)e.reject(r);this._pendingWhenSublayerViews.delete(e)}}_findComponent(e){return this.sublayerViews.find(r=>e===r.sublayer)}highlight(e,r){const t=m.normalizeHighlightTarget(e);if(0===t.length)return m.emptyHighlightHandle;if(g.isGraphic(t[0])){const e=t,i=new Map;for(const r of e)o.getOrCreateMapValue(i,r.sourceLayer,()=>[]).push(r);const n=[];return this.sublayerViews.forEach(e=>{const t=i.get(e.sublayer);t&&n.push(e.highlight(t,r))}),s.handlesGroup(n)}return m.emptyHighlightHandle}get usedMemory(){return this.sublayerViews.reduce((e,r)=>e+r.usedMemory,0)}get unloadedMemory(){return this.sublayerViews.reduce((e,r)=>e+r.unloadedMemory,0)}get performanceInfo(){return new S.LayerViewPerformanceInfo(this.usedMemory)}};return e.__decorate([c.property()],I.prototype,"sublayerViews",void 0),e.__decorate([c.property()],I.prototype,"_rejectedSublayerViews",void 0),e.__decorate([c.property({readOnly:!0})],I.prototype,"filterExpression",null),e.__decorate([c.property({readOnly:!0})],I.prototype,"filterExpressions",null),e.__decorate([c.property(v.updatingProgress)],I.prototype,"updatingProgress",void 0),e.__decorate([c.property({readOnly:!0,dependsOn:[]})],I.prototype,"updatingProgressValue",null),e.__decorate([c.property({readOnly:!0})],I.prototype,"visibleAtCurrentScale",null),I=e.__decorate([y.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],I),I});