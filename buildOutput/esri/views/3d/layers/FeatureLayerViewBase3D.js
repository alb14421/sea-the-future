// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../chunks/tslib.es6","../../../core/Error","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/graphics/dehydratedFeatures","./FeatureLikeLayerView3D","./LayerView3D","./graphics/FeatureGraphics3DGraphicsPipeline","../support/updatingProperties","../../layers/FeatureLayerView","../../layers/LayerView","../../layers/RefreshableLayerView"],function(e,r,t,i,a,s,u,o,n,p,l,c,d,y,h,f,g,m,F){"use strict";return r.default=class extends(F.RefreshableLayerView(d.FeatureLikeLayerView3D(g.FeatureLayerView(y.LayerView3D(m))))){constructor(e){super(e)}initialize(){this.addHandles(u.watch(()=>this._updatingRequiredPromise,e=>this._updatingHandles.addPromise(e),u.syncAndInitial))}destroy(){this._updatingHandles.removeAll(),this._fetcherContext=s.destroyMaybe(this._fetcherContext)}get maximumNumberOfFeatures(){return this.graphicsPipeline.maximumNumberOfFeatures}set maximumNumberOfFeatures(e){this.graphicsPipeline.maximumNumberOfFeatures=e}get maximumNumberOfFeaturesExceeded(){return null!=this.graphicsPipeline&&!this.suspended&&this.graphicsPipeline.maximumNumberOfFeaturesExceeded}get updatingProgressValue(){return this.graphicsPipeline?.updatingProgressValue??0}get updatePolicy(){return this.graphicsPipeline?.updatePolicy??0}get hasZ(){const e=this.layer,r=e.capabilities&&e.capabilities.data;return!(!r||!r.supportsZ)&&("returnZ"in e&&null!=e.returnZ?e.returnZ:r.supportsZ)}get hasM(){const e=this.layer,r=e.capabilities&&e.capabilities.data;return!(!r||!r.supportsM)&&"returnM"in e&&null!=e.returnM&&e.returnM}setVisibility(e,r){this.graphicsPipeline?.setVisibility(e,r)}createQuery(){return super.createQuery()}queryFeatures(e,r){const t=()=>super.queryFeatures(e,r);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(e),t):t()}async createGraphicsPipeline(){if(a("feature-pipeline-3d-test")){const{Feature3DPipeline:r}=await new Promise((r,t)=>e(["./graphics/pipeline/Feature3DPipeline"],r,t));return new r({layerView:this})}return new h.FeatureGraphics3DGraphicsPipeline({layerView:this})}async doRefresh(e){return await this.graphicsPipeline.doRefresh(e)}_popupFeatureHasRequiredFields(e,r){if(!super._popupFeatureHasRequiredFields(e,r))return!1;const t=c.getObjectId(e,this.layer.objectIdField);if(null==t)return!0;const i=this.graphicsPipeline.getMissingAttributesForFeature(t);if(null==i)return!0;for(const e of r)if(i.has(e))return!1;return!0}get usedMemory(){return this.graphicsPipeline?.usedMemory??0}get unloadedMemory(){return this.graphicsPipeline?.unloadedMemory??0}get ignoresMemoryFactor(){return this.graphicsPipeline?.ignoresMemoryFactor??!1}async _queryFeaturesMesh(e,r){this._validateQueryFeaturesMesh(e);const t=await r(),i=this.graphicsPipeline;if(e?.outStatistics||null==i)return t;const a=this.layer.objectIdField,s=[];for(const e of t.features)if(e.geometry){const r=i.getHydratedGeometry(e.attributes[a]);r&&(e.geometry=r,s.push(e))}else s.push(e);return t.features=s,t}_validateQueryFeaturesMesh(e){if(!e)return;const r=e=>{throw new i("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${e}'`)},t=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const i of t)null!=e[i]&&r(i);"returnM"in e&&e.returnM&&r("returnM"),"returnCentroid"in e&&e.returnCentroid&&r("returnCentroid"),null==e.outSpatialReference||e.outSpatialReference.equals(this.view.spatialReference)||r("outSpatialReference")}get test(){}},t.__decorate([o.property()],r.default.prototype,"layer",void 0),t.__decorate([o.property()],r.default.prototype,"graphicsPipeline",void 0),t.__decorate([o.property()],r.default.prototype,"maximumNumberOfFeatures",null),t.__decorate([o.property()],r.default.prototype,"maximumNumberOfFeaturesExceeded",null),t.__decorate([o.property(f.updatingProgress)],r.default.prototype,"updatingProgress",void 0),t.__decorate([o.property({readOnly:!0})],r.default.prototype,"updatingProgressValue",null),t.__decorate([o.property({readOnly:!0})],r.default.prototype,"updatePolicy",null),t.__decorate([o.property({readOnly:!0})],r.default.prototype,"hasZ",null),t.__decorate([o.property({readOnly:!0})],r.default.prototype,"hasM",null),r.default=t.__decorate([l.subclass("esri.views.3d.layers.FeatureLayerViewBase3D")],r.default),r.default});