// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/promiseUtils","../../../geometry/Extent","../../../geometry/support/aaBoundingRect"],function(e,t,o,n,r){"use strict";let i,a;t.ElevationLayerView3DModification=class{constructor(e,t){this.type=e,this.polygon=t}apply(e,t){if("replace"!==this.type)return;const{polygon:o}=this,[i,s,c]=a,{extent:l,spatialReference:f}=t,y=r.toExtent(l,f);if(s.accelerateGeometry(o),!s.execute(o,y))return;i.accelerateGeometry(o),c.accelerateGeometry(o);const{width:p,height:m,values:u}=e,h=o.hasZ?o.rings.reduce((e,t)=>t.reduce((e,t)=>Math.min(e,t[2]??1/0),e),1/0):1/0,d=h===1/0?0:h;if(i.execute(o,y))u.fill(d);else{const e=function(e,t,o){const[r,i,s,c]=e.extent,{spatialReference:l}=e,[f,y]=o,p=(s-r)/(f-1),m=(c-i)/(y-1),u=new n({xmin:r-2*p,ymin:i-2*m,xmax:s+2*p,ymax:c+2*m,spatialReference:l}),h=a[2].execute(t,u);return"polygon"===h?.type?h:null}(t,o,[p,m]);if(!e)return;if(e.rings.every(e=>0===e.length))return;const r=function(e,t,o,n){const r=new OffscreenCanvas(o+2,n+2).getContext("2d",{willReadFrequently:!0});if(!r)throw new Error("failed to create canvas");const[i,a,s,c]=e.extent,l=s-i,f=c-a;r.fillStyle="black",r.clearRect(0,0,o,n);const y=new Path2D;for(const e of t.rings)if(e.length>0){const t=new Path2D;let r=!0;for(const[a,s]of e){const e=(a-i)/l*(o-1)+1+.5,y=(c-s)/f*(n-1)+1+.5;r?(r=!1,t.moveTo(e,y)):t.lineTo(e,y)}t.closePath(),y.addPath(t)}r.fillStyle="white",r.fill(y,"evenodd");const p=r.getImageData(0,0,o+2,n+2),m=(o+2)*(n+2),u=new Uint8Array(m);for(let e=0;e<m;++e)u[e]=p.data[4*e+0]>0?1:0;return u}(t,e,p,m);for(let e=m-1;e>=0;--e)for(let t=0;t<p;++t){const o=(e+1)*(p+2)+(t+1);let n=0;for(let e=-1;e<=1;++e){const t=o+e*(p+2);for(let e=-1;e<=1;++e)n=Math.max(n,r[t+e])}const i=e*p+t;u[i]=0===n?u[i]:d}}}},t.ElevationLayerView3DModifications=class{constructor(){this.modifications=[]}async apply(t,n,r){if(0!==this.modifications.length&&(i??=Promise.all([new Promise((t,o)=>e(["../../../geometry/operators/containsOperator"],t,o)),new Promise((t,o)=>e(["../../../geometry/operators/intersectsOperator"],t,o)),new Promise((t,o)=>e(["../../../geometry/operators/intersectionOperator"],t,o))]),a=await i,!o.isAborted(r)))for(const e of this.modifications)e.apply(t,n)}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});