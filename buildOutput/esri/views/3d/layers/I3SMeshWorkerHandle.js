// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Logger","../../../core/PooledArray","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/workers/WorkerHandle","../../../geometry/projectionUtils","../../../geometry/projection/projectVectorToVector"],function(e,s,t,o,r,i,n){"use strict";class a extends r.WorkerHandle{constructor(e){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},e,{hasInitialize:!0})}setModifications(e,s,t){const o={context:e,modifications:s,isGeodetic:t};return this.broadcast(o,"setModifications")}setLegacySchema(e,s){const t=JSON.stringify(s);return this.broadcast({context:e,jsonSchema:t},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}async destroyContextAndSelf(e){await this.destroyContext(e),this.destroy()}project(e,s){return this.invokeMethod("project",e,s)}transformNormals(e,s){return this.invokeMethod("transformNormals",e,s)}}const h=new t({deallocator:null}),c=o.create();e.I3SMeshWorkerHandle=a,e.TransformedData=class{constructor(e,s,t,o,r,i,n){this.componentOffsets=e,this.featureIds=s,this.anchorIds=t,this.anchors=o,this.transformedGeometry=r,this.globalTrafo=i,this.obb=n}},e.TransformedGeometry=class{constructor(e,s,t,o,r,i){this.layout=e,this.interleavedVertexData=s,this.indices=t,this.hasColors=o,this.hasModifications=r,this.positionData=i}},e.toWasmModification=function(e,t,o){h.clear();let r=1/0,a=1/0,p=-1/0,u=-1/0,l=!1;for(const e of t){const t="clip"===e.type?2:"mask"===e.type?1:0,f=e.geometry;let d=e=>e;if(f.spatialReference){if(!i.canProjectWithoutEngine(f.spatialReference,o)){s.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-projection-failed","Can't project modification polygon into layer spatial reference, ignoring modification",{polygon:f});continue}d=e=>(n.projectVectorToVector(e,f.spatialReference,c,o),c)}else f.hasZ||(c[2]=0,d=e=>(c[0]=e[0],c[1]=e[1],c));l=l||1===t;const g=f.rings.length,m=f.rings.some(e=>e.length<3);if(0===g||m)s.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-invalid-polygon","Ignoring invalid modification polygon (no rings or rings with less than 3 vertices).",{polygon:f});else{h.push(t),h.push(g);for(const e of f.rings){h.push(e.length);for(const s of e){const e=d(s);h.push(e[0]),h.push(e[1]),h.push(e[2]),r=Math.min(r,e[0]),a=Math.min(a,e[1]),p=Math.max(p,e[0]),u=Math.max(u,e[1])}}}}if(null!=e)if(l){const s=1e-4;h.push(2),h.push(2),h.push(4),h.push(r-s),h.push(a-s),h.push(0),h.push(p+s),h.push(a-s),h.push(0),h.push(p+s),h.push(u+s),h.push(0),h.push(r-s),h.push(u+s),h.push(0),h.push(4),h.push(e[0]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[3]),h.push(0),h.push(e[0]),h.push(e[3]),h.push(0)}else h.push(1),h.push(1),h.push(4),h.push(e[0]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[1]),h.push(0),h.push(e[2]),h.push(e[3]),h.push(0),h.push(e[0]),h.push(e[3]),h.push(0);h.push(3);const f=new Float64Array(h.length);for(let e=0;e<h.length;++e)f[e]=h.at(e);return f},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});