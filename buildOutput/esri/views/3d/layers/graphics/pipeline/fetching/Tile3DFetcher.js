// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/promiseUtils","../../../../../../geometry/support/aaBoundingRect","../../../../../../rest/query/operations/query","../Tile","../featureSet/PBFPointFeatureSetView"],function(e,t,r,o,i,s){"use strict";e.Tile3DFetcher=class{constructor(e,t,r,o,i){this.spatialReference=e,this.url=r,this.objectIdField=o,this.capabilities=i;const{supportsMaxRecordCountFactor:s,maxRecordCount:a}=this.capabilities.query,n=s?4:1,c=(a??8e3)*n;this._pageSize=Math.min(8e3,c);const u=t.clone();u.cacheHint=!0,u.resultType="tile",u.outSpatialReference=e,u.returnGeometry=!0,u.returnZ=!0,u.maxRecordCountFactor=n,u.num=this._pageSize,u.outFields=[o],this._baseQuery=u}async fetch(e,o){const{spatialReference:s,_pageSize:a}=this,n=r.toExtent(e.extent,s),c=this._baseQuery.clone();c.geometry=n;const u=new Array;let l=0,h=!1,f=1;for(;!h;){const e=[];for(let t=0;t<f;++t)e.push(this._fetchPage(c,l++,o));const r=await Promise.all(e);t.throwIfAborted(o);for(const e of r){const t=0!==e.featureCount;h||=!e.exceededTransferLimit||!t,t&&u.push(e)}f=Math.min(f+1,4)}return new i.Tile(e,u,a)}async _fetchPage(e,r,i){const a=e.clone();a.start=r*this._pageSize;const n=(await o.executeQueryPBFBuffer(this.url,a,{signal:i})).data;return t.throwIfAborted(i),new s.PBFPointFeatureSetView(n)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});