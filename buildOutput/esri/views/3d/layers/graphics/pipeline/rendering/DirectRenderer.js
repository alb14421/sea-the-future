// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../chunks/tslib.es6","../../../../../../core/uid","../../../../../../core/accessorSupport/decorators/property","../../../../../../core/has","../../../../../../core/Logger","../../../../../../core/RandomLCG","../../../../../../core/accessorSupport/decorators/subclass","../../../../support/buffer/glUtil","../../../../webgl-engine/effects/RenderPlugin","../../../../webgl-engine/lib/GLMaterials","../../../../webgl-engine/lib/Object3D","../../../../webgl-engine/materials/DrawParameters","../../../../webgl-engine/materials/HUDMaterial"],function(e,t,r,i,s,n,a,o,l,u,c,d,h,m){"use strict";e.DirectRenderer=class extends u.SyncRenderPlugin{constructor(e){super(e),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new h.DrawParameters,this._bufferWriter=null,this.slicePlaneEnabled=!1,this.isGround=!1,this.type=e.material instanceof m.HUDMaterial?1:0,this.layerViewUid=e.layerViewUid}get produces(){return this._produces}get numFeatures(){let e=0;return this._renderGeometries.forEach(t=>e+=t.numElements/6),e}get usedMemory(){let e=0;return this._renderGeometries.forEach(t=>{e+=t.vao.usedMemory}),e}intersect(e,t,i,s){const{material:n,_bufferWriter:a,layerViewUid:o,_renderGeometries:l}=this;null!=a.intersect&&l.forEach(({buffer:t,localOrigin:l,items:u})=>a.intersect(t.data,n.parameters,l,e,i,s,(t,i,s,a)=>{if(!u.visibilities[s])return;const l=u.objectIds[s];e.handleObjectIntersection({object:{id:r.nullUid,graphicUid:l,layerViewUid:o,boundingVolumeWorldSpace:new d.BoundingVolume,geometries:[{material:n}]},geometryId:0,primitiveIndex:s},t,i,null,a)}))}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach((e,t)=>{this._produces.set(t,t=>8!==t&&5!==t&&e(t))})}destroy(){this._glMaterials.dispose();const e=this._renderGeometries.keys();for(const t of e)this.removeRenderGeometryBuffer(t)}acquireTechniques(e){const t=this.material;if(!t.shouldRender(e))return null;const{output:r,bind:i}=e,s=t.produces.get(i.slot);if(!s?.(r))return null;if(8===r||5===r)return null;const n=this._glMaterials.load(e.rctx,i.slot,r);return n?.beginSlot(i)}render(e,t){const r=this._renderGeometries;if(0===r.size)return;const{bind:i}=e,s=10===i.slot||11===i.slot?i.slot:null,n=e.rctx;n.runAppleAmdDriverHelper(),n.bindTechnique(t,i,this.material.parameters);const a=t.program;for(const[e,o]of r){const{vao:e,localOrigin:r,drawCalls:l}=o;this._drawParameters.origin=r,a.bindDraw(i,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(e),n.bindVAO(e),n.setPipelineState(t.getPipeline(!1,s));for(const e of l)n.drawArrays(t.primitiveType,e.start,e.count)}}initializeRenderContext(e){this._glMaterials=new c.GLMaterials(this.material,e.materials),this._vaoCache=e.renderContext.rctx.getVaoCache(l.glLayout(this._bufferWriter.layout))}uninitializeRenderContext(){}addRenderGeometryBuffer(e,t,r,i){this.removeRenderGeometryBuffer(e);const{data:s,elementCount:n}=t,a=this._vaoCache.newVao(s.byteLength);a.buffer()?.setSubData(new Uint8Array(s),0,0,s.byteLength);const o={localOrigin:i,numElements:n,buffer:t,items:r,vao:a,drawCalls:this._produceDrawCalls(r)};this._renderGeometries.set(e,o)}updateRenderGeometryBuffer(e,t,r,i){const{data:s,elementCount:n}=t,a=this._renderGeometries.get(e);if(null==a)return;this._vaoCache.deleteVao(a.vao);const o=this._vaoCache.newVao(s.byteLength);o.buffer()?.setSubData(new Uint8Array(s),0,0,s.byteLength),a.localOrigin=i,a.numElements=n,a.buffer=t,a.items=r,a.vao=o,a.drawCalls=this._produceDrawCalls(r)}removeRenderGeometryBuffer(e){const t=this._renderGeometries.get(e);null!=t&&(this._vaoCache.deleteVao(t.vao),this._renderGeometries.delete(e))}updateVisibility(e,t){const r=this._renderGeometries.get(e);if(null==r)return;const{items:i}=r;if(i.visibilities.length!==t.length)throw new Error("Unexpected mismatch between old and new visibility flag buffer length.");i.visibilities=t,r.drawCalls=this._produceDrawCalls(i)}hasHighlight(){return!1}_produceDrawCalls(e){const{visibilities:t,ranges:r}=e,i=[];if(function(e){return"numItems"in e}(r)){if(0===r.numItems)return[];const e=r.numVertices;let s=null;for(let n=0;n<r.numItems;++n)t[n]?null==s?(s={start:n*e,count:e},i.push(s)):s.count+=e:s=null}else{const e=r.counts,s=e.length;if(0===s)return[];let n=null,a=0;for(let r=0;r<s;++r){const s=t[r],o=e[r];s?null==n?(n={start:a,count:o},i.push(n)):n.count+=o:n=null,a+=o}}return i}},t.__decorate([i.property({constructOnly:!0})],e.DirectRenderer.prototype,"material",void 0),e.DirectRenderer=t.__decorate([o.subclass("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],e.DirectRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});