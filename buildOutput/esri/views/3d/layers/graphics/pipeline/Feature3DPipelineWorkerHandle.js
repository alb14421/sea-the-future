// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Promise","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/workers/WorkerHandle","../../../../../geometry/Extent","../../../../../geometry/support/aaBoundingRect","../../../../../graphic/FeatureGraphicOrigin","../../../../../rest/support/FeatureSet","../ElevationContext","./utils"],function(e,r,t,o,n,a,i,s,d,l,c,p,u,y,h){"use strict";e.Feature3DPipelineWorkerHandle=class extends t.EsriPromise{constructor(e){super(e),this.schedule=null,this._workerUpdating=!0}get updating(){return this._workerUpdating}get _graphicOrigin(){return new p(this.layer)}initialize(){const{layer:e,layerView:r,viewSpatialReference:t,renderSpatialReference:o}=this,n=e.elevationInfo;this._elevationContext=y.ElevationContext.fromElevationInfo(n),this._workerHandle=new v(this.schedule,{createTexture:async({data:e,parameters:r})=>({result:await this.renderer.createTexture(e,r),transferList:[]}),releaseTexture:async({uid:e})=>(await this.renderer.releaseTexture(e),w),createMaterial:async({materialJSON:e})=>(await this.renderer.createMaterial(e),w),destroyMaterial:async({materialId:e})=>(await this.renderer.destroyMaterial(e),w),createDirectRenderer:async({materialId:e})=>(await this.renderer.createDirectRenderer(e),w),destroyDirectRenderer:async({materialId:e})=>(await this.renderer.destroyDirectRenderer(e),w),createLoDRenderer:async({rendererId:e,lodRenderGeometry:r},t)=>(await this.renderer.createLoDRenderer(e,r,t?.signal??void 0),w),destroyLoDRenderer:async({rendererId:e},r)=>(await this.renderer.destroyLoDRenderer(e,r?.signal??void 0),w),dispatchRenderCommands:async({commands:e})=>(await this.renderer.executeRenderCommands(e),w),applyElevationAlignment:async({mapPoints:e})=>{const{viewSpatialReference:r,elevationProvider:t,renderCoordsHelper:o}=this,n=h.applyElevationAlignment(e,r,this._elevationContext,t,o);return{result:n,transferList:[n.buffer]}}}),this.addResolvingPromise((async()=>{await e.load();const a={url:e.parsedUrl?.path??"",baseQuery:e.createQuery().toJSON(),objectIdField:e.objectIdField,capabilities:e.capabilities,fieldIndex:e.fieldsIndex.toJSON(),timeInfo:e.timeInfo?.toJSON(),elevationInfo:n?.toJSON(),fullExtent:e.fullExtent?.toJSON(),renderer:e.renderer?.toJSON()},i={fullOpacity:r.fullOpacity};await this._workerHandle.invokeMethod("setup",{viewSpatialReference:t.toJSON(),renderSpatialReference:o.toJSON(),viewingMode:this.viewingMode,layerInfo:a,layerViewInfo:i})})()),this.addHandles(this._workerHandle.on("notify-updating",({updating:e})=>{this._workerUpdating=e}))}onTileTreeChange(e){this._workerHandle.invokeMethod("onTileTreeChange",{tiles:e.items.map(_)})}onElevationChange(e){this._workerHandle.invokeMethod("onElevationChange",{context:e.context,spatialReference:e.spatialReference?.toJSON(),extent:c.clone(e.extent)})}onLayerViewOpacityChange(e){this._workerHandle.invokeMethod("onLayerViewOpacityChange",e)}onRendererChange(e){const r=e?.toJSON();this._workerHandle.invokeMethod("onRendererChange",r)}async executeQuery(e,r){const t=await this._workerHandle.invokeMethod("executeQuery",e?.toJSON(),r),o=u.fromJSON(t);return this._ensureLayerOnFeatures(o),o}async executeQueryForIds(e,r){return await this._workerHandle.invokeMethod("executeQueryForIds",e?.toJSON(),r)}async executeQueryForCount(e,r){return await this._workerHandle.invokeMethod("executeQueryForCount",e?.toJSON(),r)}async executeQueryForExtent(e,r){const{count:t,extent:o}=await this._workerHandle.invokeMethod("executeQueryForExtent",e?.toJSON(),r);return{count:t,extent:l.fromJSON(o)}}async executeQueryForLatestObservations(e,r){const t=await this._workerHandle.invokeMethod("executeQueryForLatestObservations",e?.toJSON(),r),o=u.fromJSON(t);return this._ensureLayerOnFeatures(o),o}_ensureLayerOnFeatures(e){const{layer:r,_graphicOrigin:t}=this;for(const o of e.features)o.layer=r,o.sourceLayer=r,o.origin=t}},r.__decorate([o.property()],e.Feature3DPipelineWorkerHandle.prototype,"updating",null),r.__decorate([o.property({constructOnly:!0})],e.Feature3DPipelineWorkerHandle.prototype,"schedule",void 0),r.__decorate([o.property({constructOnly:!0})],e.Feature3DPipelineWorkerHandle.prototype,"layer",void 0),r.__decorate([o.property({constructOnly:!0})],e.Feature3DPipelineWorkerHandle.prototype,"layerView",void 0),r.__decorate([o.property({constructOnly:!0})],e.Feature3DPipelineWorkerHandle.prototype,"viewSpatialReference",void 0),r.__decorate([o.property({constructOnly:!0})],e.Feature3DPipelineWorkerHandle.prototype,"renderSpatialReference",void 0),r.__decorate([o.property({constructOnly:!0})],e.Feature3DPipelineWorkerHandle.prototype,"viewingMode",void 0),r.__decorate([o.property({constructOnly:!0})],e.Feature3DPipelineWorkerHandle.prototype,"renderer",void 0),r.__decorate([o.property({constructOnly:!0})],e.Feature3DPipelineWorkerHandle.prototype,"elevationProvider",void 0),r.__decorate([o.property({constructOnly:!0})],e.Feature3DPipelineWorkerHandle.prototype,"renderCoordsHelper",void 0),r.__decorate([o.property()],e.Feature3DPipelineWorkerHandle.prototype,"_workerUpdating",void 0),r.__decorate([o.property()],e.Feature3DPipelineWorkerHandle.prototype,"_graphicOrigin",null),e.Feature3DPipelineWorkerHandle=r.__decorate([s.subclass("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorkerHandle")],e.Feature3DPipelineWorkerHandle);class v extends d.WorkerHandle{constructor(e,r){super("Feature3DPipelineWorker","setup",{},e,{strategy:"dedicated",client:r})}}function _({id:e,lij:r,extent:t}){return{id:e,lij:r,extent:t}}const w={result:void 0};Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});