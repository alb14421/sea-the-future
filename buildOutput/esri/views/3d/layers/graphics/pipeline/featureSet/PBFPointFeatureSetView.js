// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/Error","../../../../../../core/pbf","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../core/libs/rbush/PooledRBush","../../../../../../geometry/support/aaBoundingBox","../../../../../../geometry/support/quantizationUtils","../../../../../../layers/graphics/OptimizedGeometry","../../../../../../layers/support/FieldsIndex","../../../../../../rest/query/operations/pbfFeatureServiceParser"],function(e,t,r,s,n,i,o,a,d,c){"use strict";function u(e){for(;e.next();){if(1===e.tag())return g(e.getMessage());e.skip()}l()}function g(e){let t,r,s=!1,n=!1,i=0;const a=new Array,u=new Array,g=new Array;for(;e.next();)switch(e.tag()){case 1:r=e.getString();break;case 7:0!==e.getEnum()&&l();break;case 9:s=e.getBool()??!1;break;case 12:t=o.normalizeTransform(e.processMessage(c.parseTransform));break;case 13:{const t=e.processMessage(c.parseField);t.index=i++,a.push(t);break}case 15:{u.push(e.pos());const t=e.getUInt32(),r=e.pos()+t;for(;e.pos()<r&&e.next();)1===e.tag()?(g.push(e.pos()),e.skip()):e.skip();break}case 10:n=e.getBool()??!1;break;default:e.skip()}const f=new d(a);return null!=t&&n&&null!=r&&f.has(r)||l(),{transform:t,exceededTransferLimit:s,fieldsIndex:f,objectIdFieldName:r,featureIndices:u,attributeIndices:g}}function l(){const e=new t("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(e),e}function f(e){const t=e.getLength(),r=e.pos()+t;for(;e.pos()<r&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}const h=s.create();e.PBFPointFeatureSetView=class{constructor(e){this._reader=new r(new Uint8Array(e),new DataView(e)),this._index=function(e){for(;e.next();){if(2===e.tag())return u(e.getMessage());e.skip()}l()}(this._reader)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}get usedMemory(){return this._reader.usedMemory}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){const{_index:{fieldsIndex:r,attributeIndices:s}}=this,n=r.get(t)?.index;if(null==n)return;const i=s[e*r.fields.length+n],o=this._reader;return o.move(i),f(o)}getAttributeAsTimestamp(e,t){const r=this.getAttribute(e,t);return"string"==typeof r?new Date(r).getTime():"number"==typeof r||null==r?r:null}getAttributes(e){const{_index:{fieldsIndex:t,attributeIndices:r}}=this,s=e*t.fields.length,n=this._reader,i={};for(const e of t.fields){const t=r[s+e.index];n.move(t),i[e.name]=f(n)}return i}getCoordinates(e,t,r=0){const s=this._reader,{transform:n,featureIndices:i}=this._index,{scale:o,translate:a}=n;s.move(i[e]),this._readCoordinates(o,a,t,r)}getOptimizedGeometry(e){const t=s.create();return this.getCoordinates(e,t),new a([],t)}getCentroid(e,{hasZ:t,hasM:r}){this.getCoordinates(e,h);const[s,n,i]=h,o=[s,n];return t&&(o[3]=i),r&&(o[t?4:3]=0),new a([],o)}getBounds(e){this.getCoordinates(e,h);const[t,r]=h,s=new n.BBox;return s.minX=t,s.minY=r,s.maxX=t,s.maxY=r,s}getBoundingBox(e){this.getCoordinates(e,h);const[t,r,s]=h;return i.fromValues(t,r,s,t,r,s)}getObjectIdsArray(e,t=this._allFeatureIndices(),r=0){const s=this._reader,{objectIdFieldName:n,attributeIndices:i,fieldsIndex:o}=this._index,a=o.get(n).index,d=o.fields.length;for(const n of t){const t=i[n*d+a];s.move(t),e[r++]=f(s)}return r}getCoordinatesArray(e,t=this._allFeatureIndices(),r=0){const s=this._reader,{transform:n,featureIndices:i}=this._index,{scale:o,translate:a}=n;for(const n of t){const t=i[n];s.move(t),r=this._readCoordinates(o,a,e,r)}return r}*objectIds(e=this._allFeatureIndices()){const t=this._reader,{objectIdFieldName:r,attributeIndices:s,fieldsIndex:n}=this._index,i=n.get(r).index,o=n.fields.length;for(const r of e){const e=s[r*o+i];t.move(e),yield f(t)}}*_allFeatureIndices(){const{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_readCoordinates([e,t,r],[s,n,i],o,a){const d=this._reader,c=d.getLength(),u=d.pos()+c;for(;d.pos()<u&&d.next();)switch(d.tag()){case 2:{const c=d.getLength(),u=d.pos()+c;for(;d.pos()<u&&d.next();)3===d.tag()?(d.getUInt32(),o[a++]=s+e*d.getSInt64(),o[a++]=n+t*d.getSInt64(),o[a++]=i+r*d.getSInt64()):d.skip();break}default:d.skip()}return a}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});