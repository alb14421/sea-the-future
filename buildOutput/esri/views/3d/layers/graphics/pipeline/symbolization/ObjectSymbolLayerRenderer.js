// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../../../geometry/support/aaBoundingBox","../../../../../../symbols/support/ObjectSymbol3DLayerResource","../../../../../../symbols/support/symbolLayerUtils3D","../../graphicUtils","../../primitiveObjectSymbolUtils","../PipelineCommand","../featureData/processingUtils","./primitiveObjectUtils","../../../../webgl-engine/materials/DefaultMaterial","../../../../webgl-engine/materials/pbrUtils"],function(e,t,i,r,a,n,o,s,l,c,d,m,p,u,y,h){"use strict";function _(e){return e?0:2}const f=r.create(),b=i.create(),C=i.create();e.ObjectSymbolLayerRenderer=class{constructor(e,t){this._loaded=!1,this._loadingPromise=null,this._primitiveMaterialId=null,this._lodRendererId=null,this._context=null,this._symbolLayer=null,this._primitive=null,this._context=t,this._symbolLayer=e}_destroy(){this._lodRendererId=null,this._primitiveMaterialId=null}get loaded(){return this._loaded}get _isPrimitive(){return null!=this._primitive}load(){return null==this._loadingPromise&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext,t=this._getLayerOpacity();let i={usePBR:!0,isSchematic:!0,mrrFactors:h.schematicMRRFactors,ambient:r.ONES,diffuse:r.ONES,hasSlicePlane:!1,castShadows:!0,layerOpacity:t,offsetTransparentBackfaces:!1,screenSizePerspective:{}};if(i.externalColor=a.ONES,i.instanced=!0,this._isPrimitive){const e=new y.DefaultMaterialParameters;e.layerOpacity=t,i={...i,cullFace:_(y.isTransparent(e))}}const n=await e.createMaterial({type:"default",parameters:i}),o=this._symbolLayer.resource;this._primitive=o&&d.isValidPrimitive(o?.primitive)?o.primitive:s.defaultPrimitive;const l=u.createPrimitiveGeometry(this._primitive,n);this._lodRendererId=await e.createLodRenderer(l),this._primitiveMaterialId=n,this._loaded=!0}async createDestroyCommand(){const{_lodRendererId:e,_primitiveMaterialId:t,_context:i}=this,r=i.renderCommandContext,a=[];return null!=e&&a.push(r.destroyLodRenderer(e)),null!=t&&a.push(r.destroyMaterial(t)),new m.PipelineCommand(r,r.mergeRenderCommandBuffers(a),[()=>this._destroy()])}async createAddCommand(e){const t=this._context,{renderCommandContext:i,mainThreadDelegate:a}=t;if(null==this._lodRendererId)throw new Error("expected lod renderer id to not be null");const{featureCount:n}=e;if(0===n)return t.createPipelineCommand();const c=this._isPrimitive,d=this._primitive||s.defaultPrimitive,m=o.create(l.objectSymbolLayerPrimitiveBoundingBox(d)),u=r.fromArray(o.size(m)),y={isPrimitive:c,width:100,depth:null,height:null},h=r.fromArray(l.objectSymbolLayerSizeWithResourceSize(u,y)),_=new Float64Array(16*n),f=new Float64Array(16*n),g=p.readMapCoordinates(e),v=await a.applyElevationAlignmentTo(g);for(let e=0;e<n;++e){const t=e,i=v[3*e+0],r=v[3*e+1],a=v[3*e+2],n=this._computeGlobalTransform(i,r,a,this._context.viewSpatialReference,C),o=this._computeLocalTransform(h,u,b);this._writeMatrixToTypedBuffer(_,t,o),this._writeMatrixToTypedBuffer(f,t,n)}const x=p.readObjectIds(e),P=new Uint8Array(n);e.getVisibilityArray(P);const w={featureIds:new Uint32Array(x),visibility:P,localTransforms:_,globalTransforms:f};return t.createPipelineCommand(i.addLodInstances(this._lodRendererId,e.id,w))}async createRemoveCommand(e){const{_context:t,_lodRendererId:i}=this,r=t.renderCommandContext;return null==i?t.createPipelineCommand():t.createPipelineCommand(r.removeLodInstances(i,e))}async createUpdateVisibilityCommand(e){const{_lodRendererId:t,_context:i}=this,r=i.renderCommandContext;if(null==t)return i.createPipelineCommand();const a=new Uint8Array(e.featureCount);return e.getVisibilityArray(a),i.createPipelineCommand(r.updateVisibility(t,e.id,a))}async createUpdateLayerViewOpacityCommand(e){const{_context:t}=this,i=t.renderCommandContext,r=this._primitiveMaterialId;if(null==r)return t.createPipelineCommand();const a=this._getLayerOpacity();let n={layerOpacity:a};if(this._isPrimitive){const e=new y.DefaultMaterialParameters;e.layerOpacity=a,n={...n,cullFace:_(y.isTransparent(e))}}return t.createPipelineCommand(i.updateMaterial({type:"default",materialId:r,parameters:n}))}async createUpdateElevationCommand(e){const{_context:t,_lodRendererId:i}=this,{renderCommandContext:r,mainThreadDelegate:a}=t,{featureCount:n,id:o}=e;if(null==i||0===n)return t.createPipelineCommand();const s=new Float64Array(16*n),l=p.readMapCoordinates(e),c=await a.applyElevationAlignmentTo(l);for(let e=0;e<n;++e){const t=e,i=c[3*e+0],r=c[3*e+1],a=c[3*e+2],n=this._computeGlobalTransform(i,r,a,this._context.viewSpatialReference,C);this._writeMatrixToTypedBuffer(s,t,n)}return t.createPipelineCommand(r.updateLodInstancesData(i,o,s))}_writeMatrixToTypedBuffer(e,t,i){let r=16*t;for(let t=0;t<16;t++)e[r++]=i[t]}_computeGlobalTransform(e,t,i,r,a){return f[0]=e,f[1]=t,f[2]=i,n.computeTranslationToOriginAndRotation(r,f,a,this._context.renderSpatialReference),a}_computeLocalTransform(e,i,r){return t.identity(r),this._applyObjectScale(e,i,r),r}_applyObjectScale(e,i,r){const a=e,n=c.computeObjectScale(a,e,i,this._context.renderCoordsHelper.unitInMeters);1===n[0]&&1===n[1]&&1===n[2]||t.scale(r,r,n)}_getLayerOpacity(){return this._context.layerViewInfo.fullOpacity}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});