// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/has","../../../../core/Error","../../../../core/lang","../../../../core/unitUtils","../../../../chunks/earcut","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/DoubleArray","../../../../geometry/support/Indices","../../../../chunks/vec3","../../../../layers/graphics/data/SnappingCandidate","../../../../renderers/support/renderingInfoUtils","./elevationAlignmentUtils","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./polygonUtils","../support/edgeUtils","../support/symbolColorUtils","../../support/debugFlags","../../support/ElevationProvider","../../support/renderInfoUtils/polygon","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryWithMapPositions","../../webgl-engine/lib/Normals","../../webgl-engine/lib/Object3D","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,n,a,s,i,o,l,c,h,p,d,u,g,m,y,b,f,_,x,S,v,w,P,E,C,D,A,M,I,O,z,U,L){"use strict";const G=["polygon","extent"];class T extends S.Graphics3DSymbolLayer{constructor(e,t,r,n){super(e,t,r,n,function(e){return 1===(e.material?.color?.a??0)}(t)),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=v.validateSymbolLayerSize(this._getSymbolSize());if(e)throw new r("graphics3dextrudesymbollayer:invalid-size",e)}const e=this.symbolLayer,t=e?.material,n=this.symbolLayer.material?.color?.a,a=this.needsDrivenTransparentPass||null!=n&&1!==n,s=t?.emissive,i=!this._hasDrivenColorOrOpacity&&(null==n||0===n),o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:p.ONES,diffuse:p.ONES,opacity:i?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:a,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:e.castShadows,emissiveStrength:s?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},l=new L.DefaultMaterial(o,this._context),c=new L.DefaultMaterial({...o,cullFace:2},this._context);this._materials[0]=l,this._materials[1]=c,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,G,this.symbolLayer.type))return null;const r=this._getDrivenUInt8ColorWithNaNSupport(e.renderingInfo,this._materialColor,!1);E.encodeNaNUInt8(r,r);const n=this.setGraphicElevationContext(t);return this._createAs3DShape(t,e.renderingInfo,r,n,t.uid)}layerOpacityChanged(e,t){const r=this._getLayerOpacity();this._materials[0]?.setParameters({layerOpacity:r}),this._materials[1]?.setParameters({layerOpacity:r}),this._updateTransparentDepedentMaterialParameters(),e?.forEach(e=>t(e)?.layerOpacityChanged(r,this._context.isAsync))}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,_.needsElevationUpdates3D)}slicePlaneEnabledChanged(e,t){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e?.forEach(e=>{const r=t(e);null!=r&&r.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[0]?.setParameters(e),this._materials[1]?.setParameters(e),!0}_getExtrusionSize(e){let t;return t=e.size&&this._drivenProperties.size?f.getDriverAxisSizeValue(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?0:1}async queryForSnapping(e,t,r,s){const i=this._getExtrusionSize(r)*this._context.renderCoordsHelper.unitInMeters/a.getMetersPerVerticalUnitForSR(t),{objectId:o,target:l}=e,c=n.clone(l);switch(c.z=(c.z??0)+i,e.type){case"edge":{const{start:t,end:r}=e,a=n.clone(t),s=n.clone(r);return a.z=(a.z??0)+i,s.z=(s.z??0)+i,[b.makeEdgeCandidate(o,c,1/0,a,s)]}case"vertex":return[b.makeVertexCandidate(o,c,1/0),b.makeEdgeCandidate(o,l,1/0,l,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,t,r,n,a){const b=w.geometryAsPolygon(e.geometry);if(null==b)return null;if(0===b.rings.length||!b.rings.some(e=>e.length>0))return this._logGeometryValidationWarnings(b.rings,"rings","ExtrudeSymbol3DLayer"),null;const f=A.geometryToRenderInfo(b,this._context.elevationProvider,this._context.renderCoordsHelper,n);this._logGeometryCreationWarnings(f,b.rings,"rings","ExtrudeSymbol3DLayer");const S=v.computeCentroid(b);if(null==S)return null;const E=new Array,M=new Array,I=u.create(),L=c.create(),G=p.create(),T=1===this._context.renderCoordsHelper.viewingMode;T||this._context.renderCoordsHelper.worldUpAtPosition(null,G),d.computeTranslationToOriginAndRotation(b.spatialReference,[S.x,S.y,0],L,this._context.renderCoordsHelper.spatialReference);const B=c.create();l.invert(B,L);const F=o.create();i.normalFromMat4(F,B);const{polygons:j,mapPositions:N,position:k}=f,H=new Map,W=this._materials[0];for(const e of j){const n=e.count;if(this._context.clippingExtent&&(u.fromBuffer(e.mapPositions,I),!u.intersectsClippingArea(I,this._context.clippingExtent)))continue;const i=s.earcut(e.mapPositions,e.holeIndices,3);if(0===i.length)continue;const o=i.length,l=6*n,c=l+o,h=m.newIndexArray(c),p=m.newIndexArray(o),d=g.newDoubleArray(3*l),b=g.newDoubleArray(3*l),f=g.newDoubleArray(3*l),_=g.newDoubleArray(l);R(k,N,i,e,d,f,b,_,h,p,this._getExtrusionSize(t),G,T),y.transformMat4(d,d,B);const x=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerViewUid:this._context.layerViewUid}),S=new ie(d,f,z.compressNormals(b),_),v=V(W,h,h.length-p.length,S,r,x),w=n,P=n,C=2*e.count,D=new oe(w,P,C,o/3);K(v,D,L),H.set(v,D),E.push(v,V(this._materials[1],p,0,S,r,x)),M.push(S.heights)}if(0===E.length)return null;const q=new U.Object3D({geometries:E,layerViewUid:this._context.layerViewUid,graphicUid:a,isElevationSource:!0});q.transformation=L;const Z=P.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()}),X=Z?new x.Object3DEdgeState(this._materials[0],Z,this._context.slicePlaneEnabled):null,$=new x.Graphics3DObject3DGraphicLayer(this,q,null,(e,t,r,n,a)=>function(e,t,r,n,a,s,i){const o=e.stageObject,p=o.geometries,d=p.length,u="absolute-height"!==t.mode;let g=0;const m=o.transformation,y=l.invertOrIdentity(c.create(),m);for(let e=0;e<d;e+=2){const t=p[e];if(!O.isGeometryWithMapPositions(t))continue;const l=t.getMutableAttribute("position").data,c=s[e/2],d=new D.SamplePosition(t.mapPositions),b=l.length/3;let f=!1,_=0;{let e=0;for(let t=0;t<b;t++){J[0]=l[e],J[1]=l[e+1],J[2]=l[e+2],n(d,Y),u&&(_+=Y.sampledElevation),C.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(h.set(Q,d.array[d.offset],d.array[d.offset+1],Y.z+c[e/3]),null!=r&&a.toRenderCoords(Q,r,Q),h.transformMat4(Q,Q,y)):(h.set(Q,l[e],l[e+1],l[e+2]),h.transformMat4(Q,Q,m),a.setAltitude(Q,Y.z+c[e/3]),h.transformMat4(Q,Q,y)),l[e]=Q[0],l[e+1]=Q[1],l[e+2]=Q[2];const t=te/a.unitInMeters;(Math.abs(J[0]-l[e])>=t||Math.abs(J[1]-l[e+1])>=t||Math.abs(J[2]-l[e+2])>=t)&&(f=!0),d.offset+=3,e+=3}}if(f){const r=i.get(t);r&&K(t,r,m),o.geometryVertexAttributeUpdated(p[e],"normalCompressed"),t.invalidateBoundingInfo(),o.geometryVertexAttributeUpdated(p[e],"position"),p[e+1].invalidateBoundingInfo(),o.geometryVertexAttributeUpdated(p[e+1],"position")}g+=_/b}return g/d}(e,t,r,n,a,M,H),n,X);return $.alignedSampledElevation=f.sampledElevation,$.needsElevationUpdates=_.needsElevationUpdates3D(n.mode),$}get _materialColor(){return this.symbolLayer.material?.color}_updateTransparentDepedentMaterialParameters(){const e=this._materials[0];e&&e.setParameters({cullFace:e.transparent?0:2})}}function V(e,t,r,n,a,s){const i=m.getZeroIndexArray(t.length),o=[["position",new M.Attribute(n.positions,t,3,!0)],["normalCompressed",new M.Attribute(n.normals,t,2,!0)],["symbolColor",new M.Attribute(a,i,4,!0)]];return new I.Geometry(e,o,n.elevation,0,s,r)}function R(e,t,r,n,a,s,i,o,l,c,p,d,u){const g=r.length/3;let m=2*n.count;!function(e,t,r,n,a,s,i,o,l,c,p,d,u,g,m,y,b){h.copy(X,y),l??=[],c??=[],p??=[];const f=m>0?1:-1;let _=3*r,x=0,S=3*x,v=n,w=3*v;for(let r=0;r<n;++r){const r=e[_],n=e[_+1],a=e[_+2];b&&(X[0]=r,X[1]=n,X[2]=a,h.normalize(X,X)),o[S+0]=r,o[S+1]=n,o[S+2]=a;const s=t[_+0],i=t[_+1],d=t[_+2];l[S+0]=s,l[S+1]=i,l[S+2]=d,c[S+0]=-f*X[0],c[S+1]=-f*X[1],c[S+2]=-f*X[2],p[x]=0,o[w+0]=r+m*X[0],o[w+1]=n+m*X[1],o[w+2]=a+m*X[2],l[w+0]=s,l[w+1]=i,l[w+2]=d,p[v]=m,S+=3,w+=3,_+=3,x+=1,v+=1}_=0,S=0,w=3*g;const P=m<0?ee:$,E=m<0?$:ee;for(let e=0;e<i;++e)u[S]=a[_+P[0]],u[S+1]=a[_+P[1]],u[S+2]=a[_+P[2]],d[w]=a[_+E[0]]+n,d[w+1]=a[_+E[1]]+n,d[w+2]=a[_+E[2]]+n,S+=3,w+=3,_+=3}(e,t,n.index,n.count,r,0,g,a,s,i,o,l,c,m,p,d,u);let y=0,b=2*n.count;m=0;const f=n.pathLengths[0];j(a,s,o,i,y,f,n.count,b,l,m,p),b+=4*f,m+=2*f,y+=f;for(let e=1;e<n.pathLengths.length;++e){const t=n.pathLengths[e];j(a,s,o,i,y,t,n.count,b,l,m,p),b+=4*t,m+=2*t,y+=t}}function B(e,t,r,n,a,s,i){n[s]=n[i],i*=3,e[s*=3]=e[i],e[s+1]=e[i+1],e[s+2]=e[i+2],t[s]=t[i],t[s+1]=t[i+1],t[s+2]=t[i+2],r[s]=a[0],r[s+1]=a[1],r[s+2]=a[2]}const F=p.create();function j(e,t,r,n,a,s,i,o,l,c,h){t??=[],r??=[],n??=[];let p=a,d=a+1,u=a+i,g=a+i+1,m=o,y=o+1,b=o+2*s,f=o+2*s+1;h<0&&(p=a+i+1,g=a);let _=3*c;for(let o=0;o<s;++o)o===s-1&&(d=a,h>0?g=a+i:p=a+i),Z(e,p,d,u,F),B(e,t,n,r,F,m,p),B(e,t,n,r,F,y,d),B(e,t,n,r,F,b,u),B(e,t,n,r,F,f,g),l[_]=m,l[_+1]=b,l[_+2]=f,l[_+3]=m,l[_+4]=f,l[_+5]=y,_+=6,p++,d++,u++,g++,m+=2,y+=2,b+=2,f+=2}const N=p.create(),k=p.create(),H=p.create(),W=p.create(),q=p.create();function Z(e,t,r,n,a){t*=3,r*=3,n*=3,h.set(N,e[t++],e[t++],e[t++]),h.set(k,e[r++],e[r++],e[r++]),h.set(H,e[n++],e[n++],e[n++]),h.subtract(W,k,N),h.subtract(q,H,N),h.cross(a,q,W),h.normalize(a,a)}const J=p.create();function K(e,t,r){const n=e.getMutableAttribute("position"),a=e.getMutableAttribute("normalCompressed").data,{topVertexStart:s,topVertexCount:i,topFaceStart:o,topFaceCount:l}=t,c=n.data,p=i,d=e.attributes.get("position").indices,u=o+l,m=s+i,y=g.newDoubleArray(3*p);for(let e=0;e<p;++e){const t=3*e;y[t+0]=0,y[t+1]=0,y[t+2]=0}const b=re,f=ne,_=ae,x=se,S=X;for(let e=o;e<u;++e){const t=3*e;for(let e=0;e<3;++e){const n=d[t+e];x[e]=n;const a=3*n;h.set(Q,c[a+0],c[a+1],c[a+2]),h.transformMat4(b[e],Q,r)}h.sub(f,b[1],b[0]),h.sub(_,b[2],b[0]),h.cross(S,f,_),h.normalize(S,S);for(let e=0;e<3;++e){const t=3*(x[e]-s);y[t+0]+=S[0],y[t+1]+=S[1],y[t+2]+=S[2]}}for(let e=s;e<m;++e){const t=3*(e-s),r=y[t+0],n=y[t+1],i=y[t+2],o=Math.sqrt(r*r+n*n+i*i);z.compressNormal(a,e,r/o,n/o,i/o)}}const Q=p.create(),X=p.create(),Y=new _.SampleElevationInfo,$=[0,2,1],ee=[0,1,2],te=.01,re=[p.create(),p.create(),p.create()],ne=p.create(),ae=p.create(),se=[0,0,0];class ie{constructor(e,t,r,n){this.positions=e,this.elevation=t,this.normals=r,this.heights=n}}class oe{constructor(e,t,r,n){this.topVertexStart=e,this.topVertexCount=t,this.topFaceStart=r,this.topFaceCount=n}}e.Graphics3DExtrudeSymbolLayer=T,e.extrudePolygon=R,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});