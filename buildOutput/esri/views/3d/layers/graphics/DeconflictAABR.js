// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/heapSort","../../../../core/PooledArray","../../../../geometry/support/aaBoundingRect","./deconflictorDebug"],function(i,s,t,c,e){"use strict";i.DeconflictAABR=class{constructor(i,s,t){this._setVisibility=i,this._canConflict=s,this._compare=t,this.done=!1,this._items=new Array,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null}destroy(){this._generator=null,this._accBins=null,this._items.length=0}reset(i,s){this._initBins(i,s),this._items.length=0,this.done=!1,this._generator=null}add(i){this._items.push(i)}run(i){this._generator??=this._run(i),this.done=!!this._generator.next(i).done}*_run(i){yield*this._sort(i),yield*this._deconflict(i),e.drawAccelerationStruct(()=>({bins:this._accBins,numX:this._accBinsNumX,numY:this._accBinsNumY,sizeX:this._accBinsSizeX,sizeY:this._accBinsSizeY,numTests:0,numVisible:this._items.length}))}*_sort(i){for(const t of s.iterableSort(this._items,0,this._items.length,this._compare))i.madeProgress(),i.done&&(i=yield)}_isConflicted(i){let s=!0;return this._forEachBin(i.aabr,t=>(s=!1,t.some(s=>this._canConflict(s,i)&&c.intersects(s.aabr,i.aabr))))||s}*_deconflict(i){for(const s of this._items){i.done&&(i=yield);const t=!this._isConflicted(s);this._setVisibility(s,t),e.drawPoly(s.aabr,t),t&&this._addToBins(s),i.madeProgress()}}_initBins(i,s){if(null==this._accBins){this._accBins=[];for(let i=0;i<this._accBinsNumX;i++){this._accBins.push([]);const i=this._accBins[this._accBins.length-1];for(let s=0;s<this._accBinsNumY;s++)i.push(new t)}}else for(let i=0;i<this._accBinsNumX;i++)for(let s=0;s<this._accBinsNumY;s++)this._accBins[i][s].clear();this._accBinsSizeX=i/this._accBinsNumX,this._accBinsSizeY=s/this._accBinsNumY}_addToBins(i){this._forEachBin(i.aabr,s=>s.push(i))}_forEachBin(i,s){if(!this._accBins)return!1;const t=Math.max(Math.floor(i[0]/this._accBinsSizeX),0),c=Math.max(Math.floor(i[1]/this._accBinsSizeY),0),e=Math.min(Math.floor(i[2]/this._accBinsSizeX),this._accBinsNumX-1),n=Math.min(Math.floor(i[3]/this._accBinsSizeY),this._accBinsNumY-1);for(let i=t;i<=e;i++)for(let t=c;t<=n;t++)if(s(this._accBins[i][t]))return!0;return!1}},Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})});