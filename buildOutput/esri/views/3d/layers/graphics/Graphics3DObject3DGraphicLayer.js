// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../chunks/sphere","./elevationAlignmentUtils","./featureExpressionInfoUtils","./graphicUtils"],function(e,t,i,a,s,n,r,o){"use strict";function l(e){return e.transparent?0:1}const c=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],g=i.create(),d=i.create(),h=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];e.Graphics3DObject3DGraphicLayer=class{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,i,a,s,n=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._sharedResource=i,this.elevationAligner=a,this.elevationContext=s,this._edgeState=n,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e}destroy(){if(!this._stageLayer)return;const e=this._stageLayer.stage;this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),e.renderer.edgeView?.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource?.release(),this._visible=!1,this._stageLayer=null}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}layerOpacityChanged(e,t){const{stageObject:i,_edgeState:a,_stageLayer:s}=this;if(null==a)return;const n=l(a.baseMaterial);a.edgeMaterial.objectTransparency!==n&&(a.edgeMaterial.objectTransparency=n,this.resetEdgeObject(t)),s.stage.renderer.withEdgeView(t=>t.updateAllComponentOpacities(i,[e]))}updateHighlights(e){}slicePlaneEnabledChanged(e,t){const{stageObject:i,_edgeState:a,_stageLayer:s}=this;null!=a&&s.stage.renderer.withEdgeView(s=>{s.updateAllComponentMaterials(i,a.edgeMaterial,e,!t),a.hasSlicePlane=e})}setVisibility(e){const{_edgeState:t,stageObject:i,_stageLayer:a}=this;null!=a&&this.visible!==e&&(this._visible=e,i.visible=e,e&&!this._addedToStage&&(a.add(i),this._addedToStage=!0),null!=t&&a.stage.renderer.withEdgeView(a=>{a.hasObject(i)?a.updateObjectVisibility(i,e):e&&this._addOrUpdateEdgeObject(t,a,!1)}))}get visible(){return this._visible}alignWithElevation(e,t,i,a){null!=this.elevationAligner&&(null!=i&&r.setContextFeature(this.elevationContext.featureExpressionInfoContext,i),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,(i,a)=>n.evaluateElevationInfoAtPoint(i,e,this.elevationContext,t,a),t),this.resetEdgeObject(a))}alignWithAbsoluteElevation(e,t,i){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,(t,i)=>{i.sampledElevation=e,i.verticalDistanceToGround=0,i.z=e},t),this.resetEdgeObject(i)}getCenterObjectSpace(e=i.create()){return t.copy(e,s.getCenter(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=a.create()){const t=this.stageObject.boundingVolumeObjectSpace;return a.setMin(e,t.min),a.setMax(e,t.max),e}computeAttachmentOrigin(e){const i=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=i[12],e.render.origin[1]+=i[13],e.render.origin[2]+=i[14],e.render.num++;else for(const a of this.stageObject.geometries)a.computeAttachmentOrigin(d)&&(t.transformMat4(d,d,i),t.add(e.render.origin,e.render.origin,d),e.render.num++)}async getProjectedBoundingBox(e,i,s,n,r){const l=this.getBoundingBoxObjectSpace(r),u=h,b=a.isPoint(l)?1:u.length;for(let e=0;e<b;e++){const i=u[e];g[0]=l[i[0]],g[1]=l[i[1]],g[2]=l[i[2]],t.transformMat4(g,g,this.stageObject.transformation),c[3*e]=g[0],c[3*e+1]=g[1],c[3*e+2]=g[2]}if(!e(c,0,b))return null;a.empty(l);let O=null;this.calculateRelativeScreenBounds&&(O=this.calculateRelativeScreenBounds());for(let e=0;e<3*b;e+=3){for(let t=0;t<3;t++)l[t]=Math.min(l[t],c[e+t]),l[t+3]=Math.max(l[t+3],c[e+t]);O&&s.push({location:c.slice(e,e+3),screenSpaceBoundingRect:O})}if(i?.service&&"absolute-height"!==this.elevationContext.mode){a.center(l,d);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let t=0;if(i.useViewElevation)t=i.service.getElevation(d[0],d[1],e)??0;else try{const a=o.demResolutionForBoundingBox(l,i.service.spatialReference,i);t=await i.service.queryElevation(d[0],d[1],n,a,e)??0}catch(e){}a.offset(l,0,0,-this.alignedSampledElevation+t)}return l}addObjectState(e){0===e.stateType&&e.addObject(this.stageObject,this.stageObject.highlight(e.highlightName)),1===e.stateType&&e.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeByObject(this.stageObject)}resetEdgeObject(e){const{_edgeState:t,stageObject:i,_stageLayer:a,_visible:s}=this;null!=t&&a.stage.renderer.withEdgeView(a=>{s?this._addOrUpdateEdgeObject(t,a,e):a.removeObject(i)})}_addOrUpdateEdgeObject(e,t,i){const a=l(e.baseMaterial);e.edgeMaterial.objectTransparency=a,t.addOrUpdateObject3D(this.stageObject,e.edgeMaterial,e.hasSlicePlane,!i).then(()=>this._stageLayer?.sync())}},e.Object3DEdgeState=class{constructor(e,t,i){this.baseMaterial=e,this.edgeMaterial=t,this.hasSlicePlane=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});