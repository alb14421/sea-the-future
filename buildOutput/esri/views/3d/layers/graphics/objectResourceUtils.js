// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../colorUtils","../../../../core/devEnvironmentUtils","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/FloatArray","../../../../geometry/support/buffer/BufferView","../../../../chunks/vec3","../../../../chunks/vec4","../../../../chunks/vec2","../../glTF/DefaultLoadingContext","../../glTF/internal/indexUtils","../../glTF/internal/resourceUtils","../../glTF/internal/TextureTransformUtils","./ProcessedObjectResource","./wosrLoader","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/pbrUtils"],function(e,t,r,o,n,s,i,a,l,u,c,m,f,d,g,x,T,p,h,b,w,y,M,R,B,v,S,F,A){"use strict";function V(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}const E=i.create();t.fetch=async function(t,i){const P=V(o.adjustStaticAGOUrl(t));if("wosr"===P.fileType){const e=await(i.cache?i.cache.loadWOSR(P.url,i):R.load(P.url,i)),{engineResources:t,referenceBoundingBox:r}=R.processLoadResult(e,i);return{lods:t,referenceBoundingBox:r,isEsriSymbolResource:!1,isWosr:!0}}let C;if(i.cache)C=await i.cache.loadGLTF(P.url,i,!!i.usePBR);else{const{loadGLTF:t}=await new Promise((t,r)=>e(["../../glTF/loader"],t,r));C=await t(new h.DefaultLoadingContext(i.streamDataRequester),P.url,i,i.usePBR)}const I=C.model.meta?.ESRI_proxyEllipsoid,L=C.meta.isEsriSymbolResource&&null!=I&&"EsriRealisticTreesStyle"===C.meta.ESRI_webstyle;L&&!C.customMeta.esriTreeRendering&&(C.customMeta.esriTreeRendering=!0,function(e,t){for(let o=0;o<e.model.lods.length;++o){const n=e.model.lods[o];for(const s of n.parts){const n=s.attributes.normal;if(null==n)return;const i=s.attributes.position,u=i.count,f=m.create(),d=m.create(),x=m.create(),T=new Float32Array(4*u),p=new Float32Array(3*u),h=a.invert(l.create(),s.transform);let b=0,w=0;for(let a=0;a<u;a++){i.getVec(a,d),n.getVec(a,f),c.transformMat4(d,d,s.transform),c.subtract(x,d,t.center),c.divide(x,x,t.radius);const l=x[2],u=c.length(x),m=Math.min(.45+.55*u*u,1)**r.colorGamma;c.divide(x,x,t.radius),null!==h&&c.transformMat4(x,x,h),c.normalize(x,x),o+1!==e.model.lods.length&&e.model.lods.length>1&&(l>-1?c.lerp(x,x,f,.2):c.lerp(x,x,f,Math.min(-4*l-3.8,1))),p[b]=x[0],p[b+1]=x[1],p[b+2]=x[2],b+=3,T[w]=m,T[w+1]=m,T[w+2]=m,T[w+3]=1,w+=4}s.attributes.normal=new g.BufferViewVec3f(p),s.attributes.color=new g.BufferViewVec4f(T)}}}(C,I));const O=!!i.usePBR,U=C.meta.isEsriSymbolResource?{usePBR:O,isSchematic:!1,treeRendering:L,mrrFactors:A.esriSymbologyMRRFactors}:{usePBR:O,isSchematic:!1,treeRendering:!1,mrrFactors:A.advancedMRRFactors},G={...i.materialParameters,treeRendering:L},{engineResources:D,referenceBoundingBox:k}=function(e,t,o,i,a,l){const c=e.model,m=new Array,h=new Map,R=new Map,V=c.lods.length,P=f.empty();return c.lods.forEach((e,C)=>{const I=!0===i.skipHighLods&&(V>1&&0===C||V>3&&1===C)||!1===i.skipHighLods&&null!=a&&C!==a;if(I&&0!==C)return;const L=new M.ProcessedObjectResource(e.name,e.lodThreshold,[0,0,0]);e.parts.forEach(e=>{const a=I?new F.DefaultMaterial({},i):function(e,t,o,n,s,i,a,l,c){const m=e.materials.get(t.material);if(null==m)return null;const{normal:f,color:d,texCoord0:g,tangent:x}=t.attributes,T=t.material+(f?"_normal":"")+(d?"_color":"")+(g?"_texCoord0":"")+(x?"_tangent":""),p=null!=t.attributes.texCoord0,h=null!=t.attributes.normal,b=function(e){switch(e){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":case null:case void 0:return 1}}(m.alphaMode);if(!i.has(T)){if(p){const t=(t,r=!1,o=!1)=>{if(null!=t&&!a.has(t)){const n=e.textures.get(t);if(n){const e=n.data,s=r&&!w.isEncodedMeshTexture(e)?l.compressionOptions:void 0;a.set(t,new S.Texture(w.isEncodedMeshTexture(e)?e.data:e,{...n.parameters,preMultiplyAlpha:!w.isEncodedMeshTexture(e)&&o,encoding:w.isEncodedMeshTexture(e)?e.encoding:void 0,compressionOptions:s}))}}},r=1!==b&&!c;t(m.colorTexture,r,1!==b),t(m.normalTexture),t(m.occlusionTexture,!0),t(m.emissiveTexture),t(m.metallicRoughnessTexture,!0)}const o=1/r.colorGamma,f=m.color[0]**o,d=m.color[1]**o,g=m.color[2]**o,x=m.emissiveFactor[0]**o,M=m.emissiveFactor[1]**o,R=m.emissiveFactor[2]**o,B=null!=m.colorTexture&&p?a.get(m.colorTexture):null,v=A.useSchematicPBR(m),V=null!=m.normalTextureTransform?.scale?m.normalTextureTransform?.scale:u.ONES;i.set(T,new F.DefaultMaterial({...n,customDepthTest:1,textureAlphaMode:b,textureAlphaCutoff:m.alphaCutoff,diffuse:[f,d,g],ambient:[f,d,g],opacity:"OPAQUE"===m.alphaMode?1:m.opacity,doubleSided:m.doubleSided,doubleSidedType:"winding-order",cullFace:m.doubleSided?0:2,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:h?0:2,castShadows:!0,receiveShadows:m.receiveShadows,receiveAmbientOcclusion:m.receiveAmbientOcclusion,textureId:null!=B?B.id:void 0,colorMixMode:m.colorMixMode,normalTextureId:null!=m.normalTexture&&p?a.get(m.normalTexture).id:void 0,textureAlphaPremultiplied:null!=B&&!!B.parameters.preMultiplyAlpha,occlusionTextureId:null!=m.occlusionTexture&&p?a.get(m.occlusionTexture).id:void 0,emissiveTextureId:null!=m.emissiveTexture&&p?a.get(m.emissiveTexture).id:void 0,metallicRoughnessTextureId:null!=m.metallicRoughnessTexture&&p?a.get(m.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[x,M,R],mrrFactors:v?A.schematicMRRFactors:[m.metallicFactor,m.roughnessFactor,n.mrrFactors[2]],isSchematic:v,colorTextureTransformMatrix:y.getTransformMatrix(m.colorTextureTransform),normalTextureTransformMatrix:y.getTransformMatrix(m.normalTextureTransform),scale:[V[0],V[1]],occlusionTextureTransformMatrix:y.getTransformMatrix(m.occlusionTextureTransform),emissiveTextureTransformMatrix:y.getTransformMatrix(m.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:y.getTransformMatrix(m.metallicRoughnessTextureTransform),...s},l))}const M=i.get(T);if(o.stageResources.materials.push(M),p){const e=e=>{null!=e&&o.stageResources.textures.push(a.get(e))};e(m.colorTexture),e(m.normalTexture),e(m.occlusionTexture),e(m.emissiveTexture),e(m.metallicRoughnessTexture)}return M}(c,e,L,t,o,h,R,i,l),{geometry:m,vertexCount:M}=function(e,t){const r=e.attributes.position.count,o=b.convertPrimitiveToTriangles(e.indices||r,e.primitiveType),i=d.newFloatArray(3*r),{typedBuffer:a,typedBufferStride:l}=e.attributes.position;x.transformMat4(i,a,e.transform,3,l);const u=[["position",new B.Attribute(i,o,3,!0)]];if(null!=e.attributes.normal){const t=d.newFloatArray(3*r),{typedBuffer:i,typedBufferStride:a}=e.attributes.normal;s.normalFromMat4(E,e.transform),x.transformMat3(t,i,E,3,a),n.hasScaling(E)&&x.normalize(t,t),u.push(["normal",new B.Attribute(t,o,3,!0)])}if(null!=e.attributes.tangent){const t=d.newFloatArray(4*r),{typedBuffer:i,typedBufferStride:a}=e.attributes.tangent;s.fromMat4(E,e.transform),T.transformMat3(t,i,E,4,a),n.hasScaling(E)&&x.normalize(t,t,4),u.push(["tangent",new B.Attribute(t,o,4,!0)])}if(null!=e.attributes.texCoord0){const t=d.newFloatArray(2*r),{typedBuffer:n,typedBufferStride:s}=e.attributes.texCoord0;p.normalizeIntegerBuffer(t,n,2,s),u.push(["uv0",new B.Attribute(t,o,2,!0)])}const c=e.attributes.color;if(null!=c){const t=new Uint8Array(4*r);4===c.elementCount?c instanceof g.BufferViewVec4f?T.linearToSRGB(t,c,1,255):(c instanceof g.BufferViewVec4u8||c instanceof g.BufferViewVec4u16)&&T.linearToSRGB(t,c,1/255,255):(t.fill(255),c instanceof g.BufferViewVec3f?x.linearToSRGB(t,c.typedBuffer,1,255,4,c.typedBufferStride):(e.attributes.color instanceof g.BufferViewVec3u8||e.attributes.color instanceof g.BufferViewVec3u16)&&x.linearToSRGB(t,c.typedBuffer,1/255,255,4,e.attributes.color.typedBufferStride)),u.push(["color",new B.Attribute(t,o,4,!0)])}return{geometry:new v.Geometry(t,u),vertexCount:r}}(e,a??new F.DefaultMaterial({},i)),V=m.boundingInfo;null!=V&&0===C&&(f.expandWithVec3(P,V.bbMin),f.expandWithVec3(P,V.bbMax)),null!=a&&(L.stageResources.geometries.push(m),L.numberOfVertices+=M)}),I||m.push(L)}),{engineResources:m,referenceBoundingBox:P}}(C,U,G,i,P.specifiedLodIndex,L);return{lods:D,referenceBoundingBox:k,isEsriSymbolResource:C.meta.isEsriSymbolResource,isWosr:!1}},t.parseUrl=V,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});