// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","./ElevationAligners","./elevationAlignmentUtils","./featureExpressionInfoUtils","./Graphics3DObject3DGraphicLayer","./meshAutoFastUpdateConstants"],function(t,e,a,s,r,i,o,n,l,m){"use strict";class d extends l.Graphics3DObject3DGraphicLayer{constructor(){super(...arguments),this.fastTransformUpdatesAllowed=!1,this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1,this._autoDisableFastUpdatesTimeoutId=0}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}destroy(){super.destroy(),this._cancelAutoDisableFastUpdates()}enableFastTransformUpdates(t,a){if(!this.fastTransformUpdatesAllowed||this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!0;const{stageObject:s}=this,r=s.geometries.slice();s.removeAllGeometries();const i=e.getTranslation(f,s.transformation),o=a.getOrigin(i);for(const e of r){const a=t(e.material),r=e.instantiate({material:a});r.localOrigin=o,s.addGeometry(r)}this._originalGeometries=r}autoDisableFastTransformUpdates(t){this._cancelAutoDisableFastUpdates(),this._autoDisableFastUpdatesTimeoutId=setTimeout(()=>{this._autoDisableFastUpdatesTimeoutId=0,t()},m.meshAutoFastUpdateConstants.disableDelayMs)}updateAutoDisableFastTransformUpdates(t){this._autoDisableFastUpdatesTimeoutId&&this.autoDisableFastTransformUpdates(t)}_cancelAutoDisableFastUpdates(){clearTimeout(this._autoDisableFastUpdatesTimeoutId),this._autoDisableFastUpdatesTimeoutId=0}disableFastTransformUpdates(t){if(!this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!1;const{stageObject:e}=this,a=e.geometries.map(e=>t(e.material));e.removeAllGeometries();for(let t=0;t<this._originalGeometries.length;t++){const s=this._originalGeometries[t],r=a[t];r.setParameters({modelTransformation:null}),r===s.material?e.addGeometry(s):e.addGeometry(s.instantiate({material:r}))}this._originalGeometries.length=0}updateFastLocalOrigin(t,s,r){if(!this._fastTransformUpdatesEnabled)return;const{stageObject:i}=this;if(0===i.geometries.length)return;const o=i.geometries[0].localOrigin,n=e.getTranslation(f,t),l=r.getOrigin(n);if(l===o)return;const m=s?.localMatrix??a.IDENTITY;i.shaderTransformation=null,i.transformation=t,i.geometries.forEach(t=>{t.transformation=m,t.localOrigin=l})}updateTransform(t,s,r){const{stageObject:i}=this,o=s?.localMatrix??a.IDENTITY;if(!this._fastTransformUpdatesEnabled)return i.shaderTransformation=null,i.transformation=t,i.geometries.forEach(t=>t.transformation=o),void this._updateEdgeTransform(r);const n=i.transformation,l=i.geometries[0].transformation,m=t,d=o,f=e.multiply(c,n,l),u=e.multiply(h,m,d),g=e.multiply(p,u,e.invert(p,l));i.shaderTransformation=g,this._setFastMaterialTransformation({matA:f,matB:u}),this._updateEdgeTransform(r)}alignWithElevation(t,a,s,r){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(t,a,s,r);null!=s&&n.setContextFeature(this.elevationContext.featureExpressionInfoContext,s);const{stageObject:l}=this;if(!l.geometries[0].material.parameters.modelTransformation)return;const m=l.transformation,d=l.geometries[0].transformation,f=e.multiply(c,m,d),p=l.effectiveTransformation,g=e.copy(u,p);this.alignedSampledElevation=i.perObjectElevationAligner(this,this.elevationContext,t.spatialReference,(e,s)=>o.evaluateElevationInfoAtPoint(e,t,this.elevationContext,a,s),a,g),l.shaderTransformation=g;const T=l.geometries[0].transformation,b=e.multiply(h,g,T);this._setFastMaterialTransformation({matA:f,matB:b}),this._updateEdgeTransform(r)}_setFastMaterialTransformation({matA:t,matB:a}){const{stageObject:r}=this;if(0===r.geometries.length)return;const i=r.geometries[0].localOrigin,o=e.fromTranslation(b,s.scale(f,i.vec3,-1)),n=e.multiply(g,o,t),l=e.multiply(T,o,a),m=e.invert(g,n),d=e.multiply(T,l,m);for(const t of r.geometries)t.material.setParameters({modelTransformation:d})}_updateEdgeTransform(t){const{stageObject:e,_stageLayer:a}=this;a.stage.renderer.withEdgeView(a=>{a.fastUpdateObject3DEdgesTransform(e)||this.resetEdgeObject(t)})}}const f=r.create(),c=a.create(),h=a.create(),u=a.create(),p=a.create(),g=a.create(),T=a.create(),b=a.create();t.Graphics3DMeshObject3DGraphicLayer=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});