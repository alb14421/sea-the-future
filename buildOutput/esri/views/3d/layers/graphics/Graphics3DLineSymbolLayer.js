// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../Color","../../../../core/Error","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/Extent","../../../../geometry/Polygon","../../../../geometry/support/aaBoundingBox","../../../../renderers/support/renderingInfoUtils","./ElevationAligners","./elevationAlignmentUtils","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./lineUtils","../support/FastSymbolUpdates","../../support/debugFlags","../../support/engineContent/line","../../support/renderInfoUtils/line","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/LineMarkerMaterial","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/RibbonLineMaterial"],function(e,t,r,a,i,s,l,n,o,p,c,h,m,y,d,u,g,_,f,b,C,M,v,k,L,P){"use strict";const S=["polyline","polygon","extent"];class w extends u.Graphics3DSymbolLayer{static{this.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,r,a){super(e,t,r,a,function(e){const t=e.material?.color,r=e.marker?.color??t;return 1===(t?.a??0)&&1===(r?.a??0)}(t))}async doLoad(){if(this._fastUpdates=_.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastMarkerUpdates=_.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(!0)),!this._drivenProperties.size&&(null!=this.symbolLayer.size?this.symbolLayer.size:a.px2pt(1))<0)throw new r("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values")}_getMaterialParameters(e,t){const r={...this._getMaterialColorParameters(t),width:this._computeMaterialWidth(this.symbolLayer?.size),hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:g.parseCapType(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:L.getStipplePatternForLinePattern(this.symbolLayer.pattern),emissiveStrength:this._emissiveStrength??0};return 4===t&&this._fastMarkerUpdates?.visualVariables?{...r,...this._fastMarkerUpdates.materialParameters}:this._fastUpdates?.visualVariables?{...r,...this._fastUpdates.materialParameters}:r}_getMaterialColorParameters(e){const t=4===e,r=this._getCombinedOpacityAndColor(t&&this._markerColor||this._materialColor);return this._patternHidesLine&&!t&&(r[3]=0),{color:r}}get _materialColor(){return this.symbolLayer.material?.color}get _emissiveStrength(){return this.symbolLayer.material?.emissive?.strength}get _markerColor(){return this.symbolLayer.marker?.color}get _lineMaterial(){return null==this._materials[0]&&(this._materials[0]=new P.RibbonLineMaterial(this._getMaterialParameters(!1,0))),this._materials[0]}get _ringMaterial(){return null==this._materials[1]&&(this._materials[1]=new P.RibbonLineMaterial(this._getMaterialParameters(!0,1))),this._materials[1]}get _wireframeLineMaterial(){return null==this._materials[2]&&(this._materials[2]=new P.RibbonLineMaterial({...this._getMaterialParameters(!1,2),wireframe:!0})),this._materials[2]}get _wireframeRingMaterial(){return null==this._materials[3]&&(this._materials[3]=new P.RibbonLineMaterial({...this._getMaterialParameters(!0,3),wireframe:!0})),this._materials[3]}get _markerMaterial(){return null==this._materials[4]&&null!=this.symbolLayer.marker&&(this._materials[4]=new k.LineMarkerMaterial({...this._getMaterialParameters(!1,4),placement:this.symbolLayer.marker.placement,markerPrimitive:g.parseLineMarkerStyle(this.symbolLayer.marker.style)})),this._materials[4]}_getDrivenSize(e){if(this._drivenProperties.size){const t=e.size;return null!=t?a.pt2px(c.getDriverAxisSizeValueAny(t)):this._getFallbackSize()}return 1}_getDrivenColor({color:e,opacity:t}){const r=l.ones();return this._drivenProperties.color&&(s.copy(r,e??this._getFallbackOpacityAndColor(l.ZEROS)),null==t)||this._drivenProperties.opacity&&(e||this._materialColor)&&(r[3]=t??this._getFallbackOpacity()),r}_getDrivenMarkerColor({color:e,opacity:t}){const r=l.ones();return this._drivenProperties.color&&(s.copy(r,e??this._getFallbackMarkerOpacityAndColor(l.ZEROS)),null==t)||this._drivenProperties.opacity&&(e||this._markerColor||this._materialColor)&&(r[3]=t??this._getFallbackMarkerOpacity()),r}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,S,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.draped?this._createAsOverlay(e):this._createAs3DShape(e,r,t.uid)}applyRendererDiff(e,t){for(const r in e.diff){if("visualVariables"!==r)return 0;{const e=this._fastUpdates;if(!_.updateFastSymbolUpdatesState(e,t,this._fastVisualVariableConvertOptions()))return 0;for(const t of this._materials)t instanceof P.RibbonLineMaterial&&t.setParameters(e.materialParameters);const r=this._fastMarkerUpdates,a=!0;if(!_.updateFastSymbolUpdatesState(r,t,this._fastVisualVariableConvertOptions(a)))return 0;for(const e of this._materials)e instanceof k.LineMarkerMaterial&&e.setParameters(r.materialParameters)}}return 2}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff,r={};"complete"===t.size?.type&&(r.width=this._computeMaterialWidth(t.size.newValue),delete t.size),"complete"===t.cap?.type&&(r.cap=g.parseCapType(t.cap.newValue??"butt"),delete t.cap);const a=this._prepareMarkerPatch(e,t);this._prepareMaterialPatch(e,t,a),e.symbolLayerStatePatches.push(()=>{for(const e of this._materials)e?.setParameters(r)})}layerOpacityChanged(){for(let e=0;e<5;e++){const t=this._materials[e];t&&t.setParameters(this._getMaterialColorParameters(e))}}layerElevationInfoChanged(e,t,r){const a=this._elevationContext.mode,i=m.elevationModeChangeUpdateType(w.elevationModeChangeTypes,r,a);if(1!==i)return i;const s=m.needsElevationUpdates2D(a);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>s)}slicePlaneEnabledChanged(){const e={hasSlicePlane:this._context.slicePlaneEnabled};for(const t of this._materials)t?.setParameters(e);return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,r){const a=x(e.graphic.geometry),i="polygon"===a.type?a.rings:a.paths,s=new Array,l=p.create(),n=C.geometryToRenderInfo(a,this._context.elevationProvider,this._context.renderCoordsHelper,t),o="polygon"===a.type?"rings":"paths";this._logGeometryCreationWarnings(n,i,o,"LineSymbol3DLayer");for(let t=0;t<n.lines.length;t++){const i=n.lines[t],o=i.position,c=i.mapPositions;if(null!=this._context.clippingExtent&&(p.fromBuffer(c,l),!p.intersectsClippingArea(l,this._context.clippingExtent)))continue;const h=this._createGeometry("polygon"===a.type?this._ringMaterial:this._lineMaterial,e,o,c,a.type,1,r);if(s.push(h),f.debugFlags.LINE_WIREFRAMES&&s.push(h.instantiate({material:"polygon"===a.type?this._wireframeRingMaterial:this._wireframeLineMaterial})),null!=this._markerMaterial){const t=h.instantiate({material:this._markerMaterial});t.attributes.has("color")&&t.setAttributeData("color",this._getDrivenMarkerColor(e.renderingInfo)),s.push(t)}}if(0===s.length)return null;const c=this._context.layerViewUid,y=new M.Object3D({geometries:s,castShadow:!1,layerViewUid:c,graphicUid:r}),u=new d.Graphics3DObject3DGraphicLayer(this,y,null,h.sharedGeometryElevationAligner,t);return u.alignedSampledElevation=n.sampledElevation,u.needsElevationUpdates=m.needsElevationUpdates2D(t.mode),u}_createGeometry(e,t,r,a,i,s,l){const n=0===s?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,o="polygon"===i,p=this._fastUpdates?.visualVariables.color,c=this._fastUpdates?.visualVariables.size,h=this._fastUpdates?.visualVariables.opacity,m=this._context.layerViewUid,y=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:l,layerViewUid:m}),d={position:r,size:c?null:this._getDrivenSize(t.renderingInfo),color:p?null:this._getDrivenColor(t.renderingInfo),sizeFeature:c?_.getAttributeValue(c.field,t.graphic):null,colorFeature:p?_.getAttributeValue(p.field,t.graphic):null,opacityFeature:h?_.getAttributeValue(h.field,t.graphic):null};return b.createGeometry(e,{overlayInfo:n,removeDuplicateStartEnd:o,mapPositions:a,attributeData:d},y)}_createAsOverlay(e){const t=e.graphic,r=x(t.geometry),a="polygon"===r.type?r.rings:r.paths,i="polygon"===r.type?this._ringMaterial:this._lineMaterial;i.renderPriority=this._renderPriority;const s=f.debugFlags.LINE_WIREFRAMES?"polygon"===r.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,l=this._markerMaterial;null!=s&&(s.renderPriority=this._renderPriority-.001),null!=l&&(l.renderPriority=this._renderPriority-.002);const n=new Array,o=p.create(),c=p.empty(),h=C.geometryToRenderInfoDraped(r,this._context.overlaySR),m="polygon"===r.type?"rings":"paths";this._logGeometryCreationWarnings(h,a,m,"LineSymbol3DLayer");for(const a of h.lines){if(p.fromBuffer(a.position,o),!p.intersectsClippingArea(o,this._context.clippingExtent))continue;p.expandWithAABB(c,o);const h=this._createGeometry(i,e,a.position,void 0,r.type,0,t.uid),m=e=>{const r=this._context.layerViewUid,a=new v.RenderGeometry(e,{layerViewUid:r,graphicUid:t.uid});n.push(a)};if(null!=l){const t=h.instantiate({material:l});t.attributes.has("color")&&t.setAttributeData("color",this._getDrivenMarkerColor(e.renderingInfo)),m(t);const r=this.symbolLayer.marker.placement;"begin"!==r&&"begin-end"!==r||p.expandWithBuffer(o,a.position,0,1),"end"!==r&&"begin-end"!==r||p.expandWithBuffer(o,a.position,a.position.length-3,1)}m(h),f.debugFlags.LINE_WIREFRAMES&&m(h.instantiate({material:s}))}return new y.Graphics3DDrapedGraphicLayer(this,n,c,this._context.drapeSourceRenderer)}get _patternHidesLine(){const e=this.symbolLayer.pattern;return null!=e&&"style"===e.type&&"none"===e.style}_computeMaterialWidth(e){return e=e??a.px2pt(1),this._drivenProperties.size?this._fastUpdates?.visualVariables.size?a.pt2px(1):1:a.pt2px(e)}_prepareMaterialPatch(e,t,r){const a=t.material;if(null==a)return void(r.changed&&r.useMaterialColor&&U(this._getCombinedOpacityAndColor(this._materialColor),this._materials[4],e));if("collection"===a.type)return;const i="complete"===a.type?a.newValue?.color:"complete"===a.diff.color?.type?a.diff.color.newValue:null,s=this._getCombinedOpacityAndColor(i);r.useMaterialColor&&U(l.clone(s),this._materials[4],e),this._patternHidesLine&&(s[3]=0),U(s,this._materials[0],e),delete t.material}_prepareMarkerPatch(e,t){const r=t.marker,a=this._markerMaterial;if(null==r||"partial"!==r.type||null==r.diff||null!=r.diff.placement||null!=r.diff.style&&"complete"!==r.diff.style.type||null!=r.diff.color&&"complete"!==r.diff.color.type||null==a)return{changed:!1,useMaterialColor:null==this._markerColor};const i=r.diff.color,s=null!=i,l=s?i.newValue:null,n=null==l&&null==this._markerColor;l&&U(this._getCombinedOpacityAndColor(l),a,e);const o=r.diff.style?.newValue;return o&&e.symbolLayerStatePatches.push(()=>a.setParameters({markerPrimitive:g.parseLineMarkerStyle(o)})),delete t.marker,{changed:s,useMaterialColor:n}}_fastVisualVariableConvertOptions(e=!1){const t=this._getFallbackSize();return new _.ConvertOptions({supports:{size:!0,color:!0,rotation:!1,opacity:!0},fallbackColor:e?this._getFallbackMarkerOpacityAndColor(u.nanFallbackColor):this._getFallbackOpacityAndColor(u.nanFallbackColor),fallbackSize:i.fromValues(t,t,t)})}_getFallbackOpacityAndColor(e){return t.toUnitRGBA(this._materialColor)??e}_getFallbackOpacity(){return this._materialColor?.a??0}_getFallbackMarkerOpacityAndColor(e){const r=this.symbolLayer?.marker?.color;return t.toUnitRGBA(r)??this._getFallbackOpacityAndColor(e)}_getFallbackMarkerOpacity(){return this.symbolLayer?.marker?.color?.a??this._getFallbackOpacity()}_getFallbackSize(){const e=this.symbolLayer?.size;return null!=e?a.pt2px(e):1}}function x(e){switch(e.type){case"extent":if(e instanceof n)return o.fromExtent(e);break;case"polygon":case"polyline":return e}return null}function U(e,t,r){null!=t&&r.symbolLayerStatePatches.push(()=>t.setParameters({color:e}))}e.Graphics3DLineSymbolLayer=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});