// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../Color","../../../../core/has","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../renderers/support/RenderingInfo","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DGraphicCreationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DObjectMetadata","./Graphics3DSymbolLayer","./graphicUtils","./pointUtils","./SymbolComplexity","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/Geometry","../../webgl-engine/materials/LineCalloutMaterial"],function(e,t,n,r,a,i,s,o,l,c,h,d,p,u,f,m,y,g,b,v,x){"use strict";class C extends f.Graphics3DSymbolLayer{static{this.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:1,onTheGroundChanged:2}}constructor(e,t){super(e,null,t,G),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new x.LineCalloutMaterial(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const e=new x.Parameters,a=this.symbol,s=a.callout;if(s.color){const n=t.toUnitRGBA(s.color);n[3]*=this._getLayerOpacity(),e.color=n}else e.color=i.ZEROS;if(e.size=r.pt2px(s.size||0),a.verticalOffset){const{screenLength:t,minWorldLength:n,maxWorldLength:i}=a.verticalOffset;e.verticalOffset={screenLength:r.pt2px(t),minWorldLength:n||0,maxWorldLength:null!=i?i:1/0}}e.borderColor=null!=s.border?.color?t.toUnitRGBA(s.border.color):null;const o="object"===a.symbolLayers.at(0).type,l="label-3d"===a.type;return e.occlusionTest=!o&&!!n("disable-feature:non-occluded-hud"),o&&(e.shaderPolygonOffset=0),e.hudDepthAlignStart=l,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return _}createGraphics3DGraphic(e,t){const n=e.renderingInfo,r=e.graphic,a=this.setGraphicElevationContext(r,new h.ElevationContext,n.elevationOffset||0),i=n.symbol,s="on-the-ground"===this._elevationContext.mode&&("cim"===i.type||!i.symbolLayers.some(e=>"object"===e.type||"text"===e.type));if("label-3d"!==i.type&&s)return null;if("point-3d"===i.type&&i.symbolLayers.every(e=>"text"===e.type&&!o.textSymbolLayerSupportsVerticalOffset(e)))return null;const l=m.computeCentroid(r.geometry);return null==l?null:this._createAs3DShape(l,a,n,r.uid,t)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,n){const r=this._elevationContext.mode,a=c.elevationModeChangeUpdateType(C.elevationModeChangeTypes,n,r);return 1!==a||e?.forEach(e=>{const n=t(e);null!=n&&this.updateGraphicElevationContext(e.graphic,n)}),a}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t,n=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(n),t}updateGraphicElevationContext(e,t){const{elevationContext:n,metadata:r}=t;this.setGraphicElevationContext(e,n,r?.elevationOffset??0),t.needsElevationUpdates=c.needsElevationUpdates2D(n.mode)}computeComplexity(){return new g.SymbolComplexity({verticesPerFeature:6})}_getOrCreateMaterial(e,t){const n=this._perInstanceMaterialParameters(e),r=x.uniqueMaterialIdentifier(n);if(r===this._materials[0]?.uniqueMaterialIdentifier)return this._materials[0];if(t){let e=t.get(r);return null==e&&(e=new x.LineCalloutMaterial(n,this._context.spherical),t.set(r,e)),e}return new x.LineCalloutMaterial(n,this._context.spherical)}_createAs3DShape(e,t,n,r,a){const i=this._context.layerViewUid,s=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerViewUid:i}),o=this._getOrCreateMaterial(n,a),h=new v.Geometry(o,function(e){const{translation:t,centerOffset:n}=e,r=t?new b.Attribute([t[0],t[1],t[2]],O,3,!0):new b.Attribute([0,0,0],O,3,!0),a=n?new b.Attribute([n[0],n[1],n[2],n[3]],O,4,!0):new b.Attribute([0,0,0,1],O,4,!0);return[["position",r],["normal",new b.Attribute([0,0,1],O,3,!0)],["centerOffsetAndDistance",a]]}(n),null,1,s),d=y.createStageObject(this._context,e,h,t,r);if(null==d)return null;const f=new p.Graphics3DObject3DGraphicLayer(this,d.object,null,l.perObjectElevationAligner,t);return f.metadata=new u.Graphics3DObjectMetadata(n.elevationOffset),f.alignedSampledElevation=d.sampledElevation,f.needsElevationUpdates=c.needsElevationUpdates2D(t.mode),y.extendPointGraphicElevationContext(f,e,this._context.elevationProvider),f}}const O=[0],_={mode:"relative-to-ground",offset:0},G={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class S extends s.RenderingInfo{constructor(e,t,n=a.create(),r=i.create(),s=0,o="world",l=0){super(e,t),this.translation=n,this.centerOffset=r,this.horizontalScreenOffset=s,this.centerOffsetUnits=o,this.elevationOffset=l}}class L extends d.Graphics3DGraphicCreationContext{}e.Graphics3DLineCalloutSymbolLayer=C,e.LineCalloutCreationContext=L,e.LineCalloutSymbolLayerRenderingInfo=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});