// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../Graphic","../../../../core/Accessor","../../../../core/handleUtils","../../../../core/maybe","../../../../core/Promise","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/typeUtils","../../../../graphic/StreamGraphicOrigin","../../../../layers/graphics/data/StreamFeatureManager","../../../../layers/graphics/sources/connections/createConnection","../../support/EventedSet","../../../support/Scheduler","../../../support/Yield"],function(e,t,r,s,o,a,i,n,c,d,l,h,p,u,y,m,_,g,f,S){"use strict";e.StreamGraphic=class extends r{constructor(e){super(e)}getObjectId(){return this.objectId}},t.__decorate([c.property({type:Number,json:{read:!0}})],e.StreamGraphic.prototype,"objectId",void 0),e.StreamGraphic=t.__decorate([p.subclass("esri.views.3d.layers.graphics.StreamController.StreamGraphic")],e.StreamGraphic);class v{constructor(e){this.onUpdate=e,this._idToGraphic=new Map}destroy(){this._idToGraphic.clear()}add(e){this._idToGraphic.set(e.objectId,e)}get(e){return this._idToGraphic.get(e)}forEach(e){this._idToGraphic.forEach(e)}removeById(e){const t=this._idToGraphic.get(e);return t?(t.sourceLayer=t.layer=t.origin=null,this._idToGraphic.delete(e),t):null}update(e,t){this.onUpdate(e,t)}get size(){return this._idToGraphic.size}}const b=Symbol("startup-watches"),w=Symbol("update-interval");e.StreamController=class extends(i.EsriPromiseMixin(s)){constructor(){super(...arguments),this.isPaused=!1,this.graphics=new g.EventedSet,this._updateInfo={websocket:0,client:0},this._updateRequested=!1,this._lastUpdateRateTime=0,this._outSpatialReference=null}initialize(){this.addResolvingPromise(this.layer.when(()=>this._startup()))}destroy(){this.clear()}clear(){this._shutdown(),this.graphics.clear()}get updating(){return!this.connection||this.readyToRun}get readyToRun(){return!this.isPaused&&null!=this.connection&&this._updateRequested}get _graphicOrigin(){return new y(this.layer)}runTask(){if(this._updateRequested=!1,this._emitUpdateRate(),!this.featuresManager.checkForUpdates())return S.Yield}_emitUpdateRate(){const e=performance.now(),t=e-this._lastUpdateRateTime;if(t<2500)return;this._lastUpdateRateTime=e;const r=Math.round(this._updateInfo.client/(t/1e3)),s=Math.round(this._updateInfo.websocket/(t/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.layerView.emit("update-rate",{client:r,websocket:s})}_shutdown(){this.connection=a.destroyMaybe(this.connection),this.store=a.destroyMaybe(this.store),this.removeAllHandles()}_startup(){const{layer:e,layerView:t}=this,{spatialReference:r,definitionExpression:s,geometryDefinition:a,timeInfo:i,purgeOptions:c,maxReconnectionAttempts:d,maxReconnectionInterval:l,customParameters:h}=e,p=e.geometryType?u.featureGeometryTypeKebabDictionary.toJSON(e.geometryType):null,y=r,g=t.view.spatialReference,S={type:"object-id",fieldName:e.objectIdField};this.clear(),this._set("connection",_.createConnection(e.parsedUrl,y,g,p,s,a,d,l,h??void 0)),this._outSpatialReference=g.toJSON(),this.store=new v(this._onUpdate.bind(this)),this.featuresManager=new m.StreamFeatureManager(this.store,S,i.toJSON(),c),this.removeHandles(b),this.removeHandles(w),this.addHandles([e.on("send-message-to-socket",e=>this.connection.sendMessageToSocket(e)),e.on("send-message-to-client",e=>this.connection.sendMessageToClient(e)),this.connection.on("data-received",e=>this._onFeature(e)),this.connection.on("message-received",e=>this._onWebSocketMessage(e)),n.watch(()=>[e.definitionExpression,e.geometryDefinition,e.purgeOptions],()=>this._startup()),n.watch(()=>this.isPaused?null:this.layer.updateInterval,e=>{if(this.removeHandles(w),null==e)return;const t=setInterval(()=>{this._updateRequested=!0},e);this.addHandles(o.makeHandle(()=>clearInterval(t)),w)},n.initial),this.layerView.view.resourceController.scheduler.registerTask(f.TaskPriority.STREAM_CONTROLLER,this)],b),this._updateRequested=!0}_onWebSocketMessage(e){if(this.layerView.emit("message-received",e),"type"in e)switch(e.type){case"delete":if(e.objectIds)for(const t of e.objectIds)this.featuresManager.removeById(t);if(e.trackIds)for(const t of e.trackIds)this.featuresManager.removeByTrackId(t);break;case"clear":this.store.forEach(e=>this.featuresManager.removeById(e.objectId))}}_onFeature(t){this._updateInfo.websocket++,this.layerView.hasEventListener("data-received")&&this.layerView.emit("data-received",{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry});try{null==t.geometry||t.geometry.spatialReference||(t.geometry.spatialReference=this._outSpatialReference);const r=e.StreamGraphic.fromJSON(t);r.sourceLayer=r.layer=this.layer,r.origin=this._graphicOrigin,this.featuresManager.add(r)}catch{}}_onUpdate(e,t){null!=t&&this.graphics.removeMany(t),null!=e&&(this._updateInfo.client+=e.length,this.graphics.addMany(e))}pauseStream(){this.isPaused=!0}resumeStream(){this.isPaused=!1}disconnect(){this._shutdown()}connect(){null==this.connection&&this._startup()}clearGraphics(){this.graphics.clear()}},t.__decorate([c.property()],e.StreamController.prototype,"isPaused",void 0),t.__decorate([c.property({constructOnly:!0})],e.StreamController.prototype,"layer",void 0),t.__decorate([c.property({constructOnly:!0})],e.StreamController.prototype,"layerView",void 0),t.__decorate([c.property()],e.StreamController.prototype,"connection",void 0),t.__decorate([c.property({readOnly:!0})],e.StreamController.prototype,"updating",null),t.__decorate([c.property()],e.StreamController.prototype,"readyToRun",null),t.__decorate([c.property()],e.StreamController.prototype,"_updateRequested",void 0),t.__decorate([c.property()],e.StreamController.prototype,"_graphicOrigin",null),e.StreamController=t.__decorate([p.subclass("esri.views.3d.layers.graphics.StreamController")],e.StreamController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});