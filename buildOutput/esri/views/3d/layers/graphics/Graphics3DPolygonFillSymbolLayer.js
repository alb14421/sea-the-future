// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../Color","../../../../core/screenUtils","../../../../chunks/earcut","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/DoubleArray","../../../../geometry/support/FloatArray","./elevationAlignmentUtils","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./lineUtils","./polygonUtils","../support/FastSymbolUpdates","../support/patternUtils","../support/uvUtils","../../support/engineContent/line","../../support/renderInfoUtils/polygon","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/PatternMaterial","../../webgl-engine/materials/RibbonLineMaterial"],function(e,t,r,i,a,n,o,s,l,c,p,h,d,u,y,m,g,_,f,v,b,C,D,x,S){"use strict";const A=["polyline","polygon","extent"];class O extends h.Graphics3DSymbolLayer{static{this.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,r,i){super(e,t,r,i,function(e){return 1===(e.material?.color?.a??0)}(t)),this._needsUV=!1,this._materials=[]}async doLoad(){this._fastUpdates=m.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions)}get _materialColor(){return this.symbolLayer.material?.color}_createMaterials(){if(this._materials.length>0)return;const e=this._materialColor,t=this._getCombinedOpacityAndColor(e);this._materials[0]=g.createMaterial(this.symbolLayer,{color:t,forceTransparentMode:this.needsDrivenTransparentPass,discardInvisibleFragments:!0,polygonOffset:!1,hasVertexColors:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled,...this._fastUpdates?.materialParameters}),this._needsUV=this._materials[0]instanceof x.PatternMaterial;const i=this.symbolLayer.outline;if(function(e){return null!=e?.size&&e.size>0&&null!=e.color&&(null==e.pattern||"style"!==e.pattern.type||"none"!==e.pattern.style)}(i)){const e=D.getStipplePatternForLinePattern(i.pattern);this._materials[1]=new S.RibbonLineMaterial({width:r.pt2px(i.size),color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:e,cap:u.parseCapType(i.patternCap||"butt")})}}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,A,this.symbolLayer.type))return null;const r=this._getDrivenUInt8Color(e.renderingInfo,this._materialColor,!1),i=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===i.mode),this._createMaterials(),this.draped?this._createAsOverlay(t,r):this._createAs3DShape(t,r,i)}applyRendererDiff(e,t){for(const r in e.diff){if("visualVariables"!==r)return 0;if(!m.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return 0;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return 2}layerOpacityChanged(){if(null!=this._materials[0]){const e=this._materials[0].parameters.color,t=this._materialColor,r=this._getCombinedOpacity(t);this._materials[0].setParameters({color:[e[0],e[1],e[2],r],forceTransparentMode:this.needsDrivenTransparentPass})}if(null!=this._materials[1]){const e=this._materials[1].parameters.color;this._materials[1].setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(e,t,r){const i=this._elevationContext.mode,a=l.elevationModeChangeUpdateType(O.elevationModeChangeTypes,r,i);if(1!==a)return a;const n=l.needsElevationUpdates2D(i);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>n)}slicePlaneEnabledChanged(){if(this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._materials[1].setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,r){const i=y.geometryAsPolygon(e.geometry);if(!i)return null;const a=v.geometryToRenderInfo(i,this._context.elevationProvider,this._context.renderCoordsHelper,r),n=new U(a,t,this._context.layerViewUid,e.uid),c=n.renderData.position.length/3;if(this._needsUV&&(n.uvMapSpace=s.newFloatArray(4*c,!0),n.boundingRect=o.newDoubleArray(9*c,!0),_.createMapSpaceUVCoords(n.uvMapSpace,n.boundingRect,n.renderData.position,this._context.renderCoordsHelper)),n.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(n),this._createAs3DShapeFill(e,n),this._materials[1]&&this._createAs3DShapeOutline(n),this._logGeometryCreationWarnings(n.renderData,i.rings,"rings","FillSymbol3DLayer"),0===n.outGeometries.length)return null;const h=new b.Object3D({geometries:n.outGeometries,castShadow:!1,layerViewUid:this._context.layerViewUid,graphicUid:e.uid}),d=new p.Graphics3DObject3DGraphicLayer(this,h,null,g.uvElevationAligner,r);return d.alignedSampledElevation=n.renderData.sampledElevation,d.needsElevationUpdates=l.needsElevationUpdates2D(r.mode),d}_createAs3DShapeFill(e,t){const r=t.renderData.polygons;for(const{position:i,mapPositions:a,holeIndices:l,index:c,count:p}of r){if(null!=this._context.clippingExtent&&(n.fromBuffer(a,P),!n.intersectsClippingArea(P,this._context.clippingExtent)))continue;const r=y.createIndices3D(a,l,this._context.elevationProvider.spatialReference);if(0===r.length)continue;const h=this._fastUpdates?.visualVariables.color,d=y.createColorGeometry({material:this._materials[0],indices:r,mapPositions:a,attributeData:{position:i,color:h?null:t.color,colorFeature:h?m.getAttributeValue(h.field,e):null,uvMapSpace:this._needsUV?s.floatSubArray(t.uvMapSpace,4*c,4*p):null,boundingRect:this._needsUV?o.doubleSubArray(t.boundingRect,9*c,9*p):null,olidColor:t.olidColor}});t.outGeometries.push(d)}}_createAs3DShapeOutline(e){if(null==this._materials[1])return;const t=e.renderData.outlines;for(const{mapPositions:r,position:i}of t){if(null!=this._context.clippingExtent&&(n.fromBuffer(r,P),!n.intersectsClippingArea(P,this._context.clippingExtent)))continue;const t=f.createGeometry(this._materials[1],{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:r,attributeData:{position:i}},e.olidColor);e.outGeometries.push(t)}}_createAsOverlay(e,t){const r=y.geometryAsPolygon(e.geometry);if(null==r)return null;this._materials[0].renderPriority=this._renderPriority+this._renderPriorityStep/2,null!=this._materials[1]&&(this._materials[1].renderPriority=this._renderPriority);const i=v.geometryToRenderInfoDraped(r,this._context.overlaySR),a=new G(i,t,this._context.layerViewUid,e.uid),o=a.renderData.position.length/3;return this._needsUV&&(a.uvMapSpace=s.newFloatArray(4*o,!0),_.createMapSpaceUVCoordsDraped(a.uvMapSpace,a.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),a.outBoundingBox=n.empty(),a.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(a),this._createAsOverlayFill(e,a),this._materials[1]&&this._createAsOverlayOutline(a),this._logGeometryCreationWarnings(a.renderData,r.rings,"rings","FillSymbol3DLayer"),0===a.outGeometries.length?null:new c.Graphics3DDrapedGraphicLayer(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e,t){const r=t.renderData.polygons;for(const{position:a,holeIndices:o,index:l,count:c}of r){const r=n.fromBuffer(a,P);if(!n.intersectsClippingArea(r,this._context.clippingExtent))continue;const p=i.earcut(a,o,3);if(0===p.length)continue;n.expandWithAABB(t.outBoundingBox,r);const h=this._fastUpdates?.visualVariables.color,d=y.createColorGeometry({material:this._materials[0],indices:p,attributeData:{position:a,color:h?null:t.color,colorFeature:h?m.getAttributeValue(h.field,e):null,uvMapSpace:this._needsUV?s.floatSubArray(t.uvMapSpace,4*l,4*c):null,olidColor:t.olidColor}});t.outGeometries.push(new C.RenderGeometry(d,t))}}_createAsOverlayOutline(e){if(null==this._materials[1])return;const t=e.renderData.outlines;for(let r=0;r<t.length;++r){const{position:i}=t[r];if(n.fromBuffer(i,P),!n.intersectsClippingArea(P,this._context.clippingExtent))continue;n.expandWithAABB(e.outBoundingBox,P);const a=f.createGeometry(this._materials[1],{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:i}},e.olidColor);e.outGeometries.push(new C.RenderGeometry(a,e))}}_getOutlineOpacity(){const e=this.symbolLayer?.outline?.color;return(this.draped?1:this._getLayerOpacity())*(null!=e?e.a:0)}_getOutlineColor(){const e=this.symbolLayer?.outline?.color,r=this._getOutlineOpacity();return d.mixinColorAndOpacity(null!=e?t.toUnitRGB(e):null,r)}test(){return{...super.test(),createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,r)=>this._createAs3DShape(e,t,r)}}get _vvConvertOptions(){return new m.ConvertOptions({supports:{size:!1,color:!0,rotation:!1,opacity:!1},fallbackColor:t.toUnitRGBA(this._materialColor)??a.ZEROS})}}const P=n.create();class U extends y.PolygonCreationDataBase{constructor(e,t,r,i){super(e,r,i),this.color=t}}class G extends y.PolygonCreationDataBase{constructor(e,t,r,i){super(e,r,i),this.color=t}}e.Graphics3DPolygonFillSymbolLayer=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});