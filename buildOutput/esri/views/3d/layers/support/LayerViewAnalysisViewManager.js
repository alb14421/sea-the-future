// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Error","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass"],function(e,s,a,i,t,r,n,l,o,y,w,c,h){"use strict";e.LayerViewAnalysisViewManager=class extends a{get updating(){return null!=this._createAnalysisViewTask||null!=this.analysisView&&this.analysisView.updating}constructor(e){super(e),this._analysisModule=null,this._emitOnView=(e,s)=>this.parent.view.emit(e,s)}initialize(){this.addHandles(l.watch(()=>this.getAnalysis(),e=>this._createAnalysisView(e),l.syncAndInitial))}destroy(){this._destroyAnalysisView()}async whenAnalysisView(){if(null!=this.analysisView)return this.analysisView;if(null!=this._createAnalysisViewTask)return this._createAnalysisViewTask.promise;throw new t("layerview:no-analysisview-for-analysis","The analysis has not been set on the layer of this layer view")}_createAnalysisView(e){const s=this._createAnalysisViewTask?.promise;if(this._destroyAnalysisView(),!e)return;const a=i.createTask(async i=>{try{await Promise.allSettled([s]);const a=await this._createAnalysisViewPromise(e,i);return n.throwIfAborted(i),this.analysisView=a,this._emitOnView("analysis-view-create",{analysis:e,analysisView:a}),a}catch(s){throw this._emitOnView("analysis-view-create-error",{analysis:e,error:s}),s}finally{this._createAnalysisViewTask===a&&(this._createAnalysisViewTask=null)}});this._createAnalysisViewTask=a}_destroyAnalysisView(){const e=this.getAnalysis();this._createAnalysisViewTask=r.abortMaybe(this._createAnalysisViewTask);const{analysisView:s}=this;s&&(this.analysisView=r.destroyMaybe(s),this._emitOnView("analysis-view-destroy",{analysis:e,analysisView:s}))}async _createAnalysisViewPromise(e,s){let a,i=this._analysisModule;const r=s=>{if(!n.isAborted(s))return;a?.destroy();const i=this.getAnalysis();throw new t("layerview:no-analysisview-for-analysis",null!=i&&e!==i?"The analysis changed before the analysis view could be created":"The analysis has not been added to the layer of this layer view",{analysis:e})};return i||(i=await this.loadAnalysisViewModule(),r(s),this._analysisModule=i),a=new i.default({analysis:e,parent:this.parent,view:this.parent.view}),await a.when(),r(s),a}},s.__decorate([o.property({constructOnly:!0})],e.LayerViewAnalysisViewManager.prototype,"getAnalysis",void 0),s.__decorate([o.property({constructOnly:!0})],e.LayerViewAnalysisViewManager.prototype,"loadAnalysisViewModule",void 0),s.__decorate([o.property({constructOnly:!0})],e.LayerViewAnalysisViewManager.prototype,"parent",void 0),s.__decorate([o.property()],e.LayerViewAnalysisViewManager.prototype,"analysisView",void 0),s.__decorate([o.property()],e.LayerViewAnalysisViewManager.prototype,"_createAnalysisViewTask",void 0),s.__decorate([o.property()],e.LayerViewAnalysisViewManager.prototype,"updating",null),s.__decorate([o.property()],e.LayerViewAnalysisViewManager.prototype,"_analysisModule",void 0),e.LayerViewAnalysisViewManager=s.__decorate([h.subclass("esri.views.3d.layers.support.LayerViewAnalysisViewManager")],e.LayerViewAnalysisViewManager),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});