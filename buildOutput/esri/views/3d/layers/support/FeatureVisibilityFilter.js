// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/sql","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/UpdatingHandles","../../../../layers/support/FeatureFilter","../../../../layers/support/floorFilterUtils","../graphics/QueryEngine","../graphics/QueryEngineContext","../../../support/Scheduler"],function(e,t,i,r,o,l,s,n,a,u,c,p,_,y,d,h,F,g){"use strict";e.FeatureVisibilityFilter=class extends i{constructor(e){super(e),this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new _.UpdatingHandles,this._abortController=new AbortController}initialize(){const e=g.TaskPriority.FILTER_VISIBILITY,{layer:t,view:i}=this._configuration,{featureStore:r}=this.context,{spatialReference:o,resourceController:n}=i,a=this._configuration.hasZ??!1,u=this._configuration.hasM??!1,c=new F.QueryEngineContext(o,t,n,()=>r,a,u);this._queryEngine=new h.QueryEngine({context:c,priority:e}),this._frameTask=i.resourceController.scheduler.registerTask(e),this._updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this.reapply(),s.initial),this._updatingHandles.addWhen(()=>!this._frameTask.updating&&this._updateRequested,()=>{this._frameTask.scheduleGenerator(()=>this._updateVisibility(),this._abortController.signal).catch(l.throwIfNotAbortError)},s.initial)}destroy(){this._abortController.abort(),this._updatingHandles.destroy(),this.clear(),this._frameTask=o.removeMaybe(this._frameTask),this._queryEngine=o.destroyMaybe(this._queryEngine),this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _effectiveDisplayFilterClause(){return"effectiveDisplayFilterClause"in this._configuration?this._configuration.effectiveDisplayFilterClause:null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:null}get _floorFilter(){return d.getFloorFilterClause(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:e,_effectiveDisplayFilterClause:t,_timeExtent:i,_floorFilter:r}=this;let o=e?.clone();if(null!=t&&(o??=new y,o.where=n.sqlAnd(o.where,t)),null!=i&&(o??=new y,o.timeExtent=o.timeExtent?.intersection(i)??i),null!=r){o??=new y;const e=null==o.where||""===o.where;o.where=e?r:n.sqlAnd(o.where,r)}return o}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}async*_updateVisibility(){this._updateRequested=!1;const{context:e,_sceneFilter:t,_compositedFeatureFilter:i,_abortController:{signal:o}}=this;if(l.throwIfAborted(o),null==i&&null==t||0===e.getFeatureCount())return this.clear();try{const r=await this._queryEngine.executeQueryForIdSet(i,t,o);l.throwIfAborted(o),yield,l.throwIfAborted(o),e.updateFeatureVisibilities(e=>r.has(e))}catch(t){l.throwIfAbortError(t),r.getLogger(this).warn(`FeatureFilter query failed: ${t}`,{error:t}),e.setAllFeaturesVisibility(!0)}}},t.__decorate([a.property({constructOnly:!0})],e.FeatureVisibilityFilter.prototype,"context",void 0),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"updating",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"defaultVisibility",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_featureFilter",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_effectiveDisplayFilterClause",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_sceneFilter",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_floorFilter",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_timeExtent",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_compositedFeatureFilter",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_configuration",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_updateRequested",void 0),e.FeatureVisibilityFilter=t.__decorate([p.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],e.FeatureVisibilityFilter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});