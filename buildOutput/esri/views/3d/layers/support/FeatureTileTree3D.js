// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Collection","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/PooledArray","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/accessorSupport/decorators/property","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/aaBoundingRect","./FeatureTileDescriptor","./FeatureTileMeasurements3D","./FeatureTileVisibility3D","../../support/extentUtils","../../../support/Scheduler"],function(e,t,r,s,i,l,n,o,a,u,d,c,h,p,_,T,m,g,y){"use strict";function f(e,t){return e.lodLevelDelta-t.lodLevelDelta||e.measures.splitPriority-t.measures.splitPriority||t.measures.distance-e.measures.distance}e.FeatureTileTree3D=class extends r{constructor(e){super(e),this.tiles=new s,this.tileSize=512,this._idToTile=new Map,this._dirty=u.signal(!1),this._pendingTiles=u.signal(null),this._newTiles=new o,this._tests=!1,this._measurements=new T.FeatureTileMeasurements3D(e.renderCoordsHelper,e.terrain.tilingScheme,this._opaqueGround)}initialize(){this.addHandles([a.watch(()=>this.tileSize,()=>this._reset(),a.syncAndInitial),a.watch(()=>[this.pointsOfInterest.cameraOnSurface?.location,this.viewState?.contentCamera,this.pointsOfInterest.focus?.location,this.terrain?.baseOpacity??1],()=>this._setDirty(),a.syncAndInitial),a.watch(()=>this.tilingScheme,e=>{this._reset(),this._measurements=new T.FeatureTileMeasurements3D(this.renderCoordsHelper,e,this._opaqueGround)},a.sync),a.watch(()=>this._opaqueGround,e=>this._measurements.opaqueGround=e,a.sync)]),this._frameWorker=this.scheduler?.registerTask(y.TaskPriority.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=n.removeMaybe(this._frameWorker),this._measurements=null,this._newTiles.prune()}get tilingScheme(){return this.terrain.tilingScheme?.clone()}set filterExtent(e){if(null!=e&&!e.spatialReference.equals(this.viewState.spatialReference))return void l.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const r=null!=e?e.clone():null;this._set("filterExtent",r),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const e=p.create();return g.toBoundingRect(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}get _opaqueGround(){return 1===(this.terrain?.baseOpacity??1)}_setDirty(){this.suspended||(this._frameWorker?this._dirty.value=!0:this.runTask(y.noBudget))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(!1),this._dirty.value=!1}get readyToRun(){return this.updating}_reset(e=!0){this._newTiles.clear(),this._pendingTiles.value=null,e&&this._setDirty()}_getRootTiles(){const e=this.tilingScheme;return this._rootTileIds.map(t=>new _.FeatureTileDescriptor(t[0],t[1],t[2],e))}runTask(e){e=this._tests?y.noBudget:e,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(e),null!=this._frameWorker&&(this._frameWorker.priority=y.TaskPriority.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(e),this._pendingTiles.value||null==this._frameWorker||(this._frameWorker.priority=y.TaskPriority.FEATURE_TILE_TREE)}_startUpdate(e){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:t,_filterExtentRect:r,_newTiles:s}=this;t.setup(this.viewState.contentCamera,this.pointsOfInterest.focus.location,this.pointsOfInterest.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter(e=>{if(t.update(e),e.measures.visible&&(!r||!e.extent||p.intersects(e.extent,r))){if(e.measures.splitPriority>0)return!0;s.push(e)}return!1}).sort(f),this._newTiles.clear(),e.madeProgress()}_splitPendingTiles(e){const t=this._pendingTiles.value;if(!t)return;const{tilingScheme:r,_filterExtentRect:s,_newTiles:i,_measurements:l}=this;for(;t.length>0&&this._tileBudgetRatio<=2;){const n=t.pop();if(e.madeProgress(),n.measures.splitPriority>0){r.ensureMaxLod(n.level+1);const e=n.createChildren();for(const r of e)l.update(r),!r.measures.visible||s&&r.extent&&!p.intersects(r.extent,s)||(r.measures.splitPriority>0?t.push(r):i.push(r));t.sort(f),this._mergeNewTiles(2),this._mergeNewTiles(2,!0)}else i.push(n);if(e.done)return}i.pushArray(t),this._pendingTiles.value=null,this._updateTiles(),i.clear(),l.done()}get _tileBudgetRatio(){return(this._newTiles.length+(this._pendingTiles.value?.length??0))/60}_mergeNewTiles(e,t=!1){if(this._tileBudgetRatio<=e)return;const{_newTiles:r,_measurements:s}=this;r.sort((e,t)=>t.measures.distance-e.measures.distance);const i=new Map(r.map(e=>[e.id,e])),l=r.length;for(const l of i.values()){const{lij:n,measures:o}=l;if(!o.mergeable||n[1]%2!=0||n[2]%2!=0||n[0]<=1||l.lodLevelDelta>=m.maxLODLevelDelta)continue;const a=o.lodLevel;let u=a,d=!0;const c=i.get(_.getFeatureTileId(n[0],n[1]+1,n[2]));let h=Math.abs((c?.measures.lodLevel??0)-a),p=0===h||t&&c?.measures.mergeable&&h<=1;if(!c||!p)continue;u+=c.measures.lodLevel,d&&=0===h;const T=i.get(_.getFeatureTileId(n[0],n[1],n[2]+1));if(h=Math.abs((T?.measures.lodLevel??0)-a),p=0===h||t&&T?.measures.mergeable&&h<=1,!T||!p)continue;u+=T.measures.lodLevel,d&&=0===h;const g=i.get(_.getFeatureTileId(n[0],n[1]+1,n[2]+1));if(h=Math.abs((g?.measures.lodLevel??0)-a),p=0===h||t&&g?.measures.mergeable&&h<=1,!g||!p)continue;u+=g.measures.lodLevel,d&&=0===h,r.removeUnordered(l),r.removeUnordered(c),r.removeUnordered(T),r.removeUnordered(g),i.delete(l.id),i.delete(c.id),i.delete(T.id),i.delete(g.id);const y=new _.FeatureTileDescriptor(n[0]-1,n[1]/2,n[2]/2,this.tilingScheme);if(s.update(y),y.measures.visible=!0,y.measures.lodLevel=u/4,y.measures.mergeable=d,r.push(y),i.set(y.id,y),this._tileBudgetRatio<=e)return}r.length<l&&this._mergeNewTiles(e,t)}_updateTiles(){this._mergeNewTiles(1),this._mergeNewTiles(1,!0);for(const e of this.tiles.items)e.used=!1;let e=!1;const t=this._newTiles.filter(t=>{const r=this._idToTile.get(t.id);return r?(e||=r.measures.lodLevel!==t.measures.lodLevel,r.measures={...t.measures},r.used=!0):this._idToTile.set(t.id,t),!r}),r=this.tiles.items.filter(e=>!e.used&&(this._idToTile.delete(e.id),!0));this.tiles.removeMany(r),this.tiles.addMany(t),this._sortTiles(),!e||r.length||t.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}},t.__decorate([d.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"scheduler",void 0),t.__decorate([d.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"renderCoordsHelper",void 0),t.__decorate([d.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"pointsOfInterest",void 0),t.__decorate([d.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"viewState",void 0),t.__decorate([d.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"terrain",void 0),t.__decorate([d.property()],e.FeatureTileTree3D.prototype,"tiles",void 0),t.__decorate([d.property()],e.FeatureTileTree3D.prototype,"tileSize",void 0),t.__decorate([d.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"tilingScheme",null),t.__decorate([d.property()],e.FeatureTileTree3D.prototype,"filterExtent",null),t.__decorate([d.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"_filterExtentRect",null),t.__decorate([d.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"_rootTileIds",null),t.__decorate([d.property({value:!1})],e.FeatureTileTree3D.prototype,"suspended",null),t.__decorate([d.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"updating",null),e.FeatureTileTree3D=t.__decorate([h.subclass("esri.views.3d.layers.support.FeatureTileTree3D")],e.FeatureTileTree3D),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});