// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Error","../../../../core/has","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingBox","../../../../core/mathUtils","../../../../geometry/Extent","../../../../geometry/Geometry","../../../../geometry/Multipoint","../../../../geometry/Point","../../../../geometry/Polygon","../../../../geometry/Polyline","../../../../geometry/support/typeUtils","../../../../layers/support/Field","../../../../layers/graphics/dehydratedFeatureComparison"],function(e,t,r,s,n,o,i,u,l,h,f,a,c,g,d){"use strict";class V{constructor(e,t){this.feature=e,this.resolution=t,this.refCount=1}}const _={oldVersion:null,newVersion:null},y={oldVersion:null,newVersion:null};e.FeatureVersion=V,e.MultiFeatureReference=class{get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}constructor(e,t){this._highestResolutionVersion=null,this.versions=[],this.ref(e,t)}ref(e,t){const r=this.feature;y.oldVersion=r,r&&Object.defineProperty(e,"uid",{value:r.uid,configurable:!0});const s=this._highestResolutionVersion;for(const n of this.versions)if(n.resolution===t){n.refCount++;const t=s===n&&!d.equals(e,n.feature);return(t||s!==n)&&(n.feature=e),y.newVersion=t?e:r,y}const n=new V(e,t);return this.versions.push(n),!s||t<s.resolution?(y.newVersion=e,this._highestResolutionVersion=n):y.newVersion=r,y}unref(e){const{versions:r}=this;for(let t=0;t<r.length;t++){const s=r[t];if(s.resolution===e)return s.refCount--,_.oldVersion=this.feature,0===s.refCount&&(r[t]=r[r.length-1],--r.length,this._highestResolutionVersion===s&&(this._recalculateHighestResolutionVersion(),_.oldVersion=s.feature)),_.newVersion=this.feature,_}const s=`Unref feature with no references: ${this.feature?.uid}`;throw new t(s,s,(new Error).stack?.slice(6))}get feature(){return this._highestResolutionVersion?.feature??null}_recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this._highestResolutionVersion=null);let e=this.versions[0];for(let t=1;t<this.versions.length;t++){const r=this.versions[t];r.resolution<e.resolution&&(e=r)}this._highestResolutionVersion=e}},e.SingleFeatureReference=class{get isReferenced(){return 0!==this._refCount}get isSingle(){return 1===this._refCount}constructor(e){this._feature=e,this._refCount=1}ref(e){++this._refCount;const t=this._feature;return y.oldVersion=t,t&&Object.defineProperty(e,"uid",{value:t.uid,configurable:!0}),d.equals(t,e)||(this._feature=e),y.newVersion=this._feature,y}unref(){_.oldVersion=this._feature;const e=this._refCount;if(!(e>0)){const e=`Unref feature with no references: ${this.feature?.uid}`;throw new t(e,e,(new Error).stack?.slice(6))}return this._refCount=e-1,1===e?(_.newVersion=null,_):(_.newVersion=this._feature,_)}get feature(){return this._feature}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});