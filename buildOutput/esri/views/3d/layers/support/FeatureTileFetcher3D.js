// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/has","../../../../core/Logger","../../../../core/MapUtils","../../../../core/promiseUtils","../../../../core/ReactiveMap","../../../../core/reactiveUtils","../../../../core/scheduling","../../../../core/signal","../../../../core/sql","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/common","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../../../../rest/support/QuantizationParameters","../../../../rest/support/Query","./featureReference","./FeatureTile","./FeatureTileDescriptor","../../terrain/tileUtils","../../../support/Scheduler"],function(e,t,i,s,r,a,n,o,l,u,h,c,d,p,_,f,F,g,m,y,T,x,v,R,b){"use strict";function D(e){return e.id===v.virtualSnapshotTileId}function E(e){return e.id===v.virtualDisplayFilterHighlightTileId}function C(e){return D(e)||E(e)}function w(e){return null==e?new Set:new Set(e.map(e=>e.name))}function M(e,t){if(null==e||null==t)return w(t);const i=new Set;for(const{name:s}of t)e.has(s)&&i.add(s);return i}function I(e,t){if(!t?.length)return e;e??=new Map;const i=()=>new Set;for(const{objectId:s,attribute:r}of t)n.getOrCreateMapValue(e,s,i).add(r);return e}e.FeatureTileFetcher3D=class extends i{set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set("lodFactor",e),this._supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&null!=this.context.query.queryFeatureCount}set useTileCount(e){this._useTileCount=e,this.notifyChange("useTileCount")}get updating(){return this._dirty||!!this._pendingEdits||this._isFetching||(this.tileDescriptors?.updating??!1)}get readyToRun(){return this._dirty}get memoryForUnusedFeatures(){let e=0;return this._featureTiles.forEach(t=>e+=t.estimatedUnusedSize),e}get totalVertices(){let e=0;return this._featureTiles.forEach(t=>e+=t.numVertices),e}get totalFeatures(){let e=0;return this._featureTiles.forEach(t=>e+=t.numFeatures),e}get showsAllFeatures(){if(this._paused||this.dataUpdating)return!1;for(const e of this._featureTiles.values())if(!this.hasFullGeometries&&0!==e.emptyFeatureRatio||!e.showsAllFeatures)return!1;return!0}get hasFullGeometries(){if(!this._supportsResolution)return!0;const e=this.tileDescriptors?.some(D);return e||!this.context.capabilities.supportsQuantization&&"polyline"!==this.context.geometryType}set filterExtent(e){if(null!=e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void a.getLogger(this).error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("filterExtent",i),this._reclip(i,t)}_updateTileZQuantization(e){if(1===this.context.viewingMode){const t=e.computeZQuantizationFactor();this._zQuantizationFactor.value<t&&(this._zQuantizationFactor.value=t)}}get _tileZQuantization(){return this.context.isDraped?1:this._zQuantizationFactor.value}constructor(e){super(e),this._useTileCount=!1,this.dataUpdating=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this._fullRatio=1,this._farRatio=1,this._zQuantizationFactor=c.signal(1),this._changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this._featureTiles=new l,this._displayingFeatureReferences=new Map,this._numDisplayingFeatureReferences=0,this._dirty=!1,this._suspended=!0,this._pendingEdits=null,this._applyEditsTilesUpdated=!1,this._isFetching=!1;const t=e.context;this._frameTask=t.scheduler?.registerTask(b.TaskPriority.FEATURE_TILE_FETCHER,this)??b.ImmediateTask,this.FeatureReferenceClass=t.capabilities.supportsMultipleResolutions?T.MultiFeatureReference:T.SingleFeatureReference,this._objectIdField=t.objectIdField}initialize(){this.addHandles([u.on(()=>this.tileDescriptors,"change",()=>this._setDirty(),{onListenerAdd:()=>this._setDirty(),onListenerRemove:()=>this._setDirty()}),u.watch(()=>this._tileZQuantization,()=>this.refetch())]),this._setDirty()}destroy(){this._frameTask.remove(),this._featureTiles.forEach(e=>{this._cancelFetchTile(e),this._removeTile(e)}),this._featureTiles.clear(),this._displayingFeatureReferences.clear(),this._pendingEdits?.controller.abort(),this._pendingEdits=null}get _paused(){return this._suspended||!!this._pendingEdits}restart(){this._featureTiles.forEach(e=>{this._cancelFetchTile(e),this._clearTile(e),this._resetFetchTile(e)}),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this._featureTiles.forEach(e=>{this._cancelFetchTile(e),this._resetFetchTile(e)}),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}refetchDisplayFilterHighlightTile(){const e=this._featureTiles.get(v.virtualDisplayFilterHighlightTileId);e&&(this._cancelFetchTile(e),this._resetFetchTile(e),this._setDirty())}suspend(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())}resume(){this._suspended&&(this._suspended=!1,this._unpause())}getMissingAttributesForFeature(e){for(const t of this._featureTiles.values()){const i=t.missingAttributes?.get(e);if(null!=i)return i}}_pause(){this._paused&&(this._featureTiles.forEach(e=>this._cancelFetchTile(e)),this._updated())}_unpause(){this._paused||this._setDirty()}get availableFields(){let e=null;return this._featureTiles.forEach(t=>{null!=t.displayingFeatures&&0!==t.displayingFeatures.length&&(null==e?e=new Set(t.availableFields):e.forEach(i=>{t.availableFields?.has(i)||e.delete(i)}))}),null!=e?e:new Set}applyEdits(e){this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const t=this._pendingEdits;t.count++;const i=t.edits.then(()=>e.result.catch(e=>{if(o.isAbortError(e))throw e;return null}).then(e=>e?(this._applyEditsDeleteFeatures(e.deletedFeatures),this._applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,t.controller.signal).then(()=>e)):e).then(e=>(0===--t.count&&(this._pendingEdits===t&&(this._pendingEdits=null),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._applyEditsTilesUpdated=!1,this._unpause()),e)));return t.edits=i,this._updated(),i}_applyEditsDeleteFeatures(e){if(0===e.length)return;const t=this.context.globalIdField,i=t&&this.availableFields.has(t),s=new Set,r=this._objectIdField;e.forEach(({objectId:e,globalId:n})=>{(!e||e<0)&&t&&n&&(i||a.getLogger(this).errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`),e=this._objectIdFromGlobalId(n,r,t)),null!=e&&e>=0&&s.add(e)}),this._featureTiles.forEach(e=>{if(!e.features)return;const t=e.features.filter(e=>!s.has(g.getObjectId(e,this._objectIdField)));t.length!==e.features.length&&(this._applyEditsTileUpdated(),e.setFeatures(t,0,e.availableFields,e.missingAttributes),this._updateTileZQuantization(e),this._invalidateCounts())})}_objectIdFromGlobalId(e,t,i){if(null==e)return null;const s=this.features.find(t=>t.attributes?.[i]===e);return s?g.getObjectId(s,t):null}async _applyEditsAddUpdateFeatures(e,t,i){const{objectIdField:s,globalIdField:r}=this.context,n=r&&this.availableFields.has(r),o=new Set,l=new Set;for(const t of e){const e=t.objectId;null!=e&&o.add(e)}for(const{objectId:e,globalId:i}of t){let t=e;(null==t||t<0)&&r&&(n||a.getLogger(this).errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${r} to be included the layer's outFields for updates to be reflected in the view`),t=this._objectIdFromGlobalId(i,s,r)),null!=t&&t>=0&&(o.add(t),l.add(t))}if(0===o.size)return;const u=[];this._featureTiles.forEach(e=>{const t=this._applyEditsAddUpdateTile(e,o,l,i);u.push(t)}),this._updated(),await Promise.allSettled(u)}async _applyEditsAddUpdateTile(e,t,i,s){if(!e.features)return;e.fetchingResolution=e.descriptor.resolution;const r=this._createQuery(e);r.resultType=void 0,r.cacheHint=!1,r.objectIds=Array.from(t);const a=await this._queryFeatures(r,s);let n=null;if(i.size>0){const t=e.features.filter(e=>!i.has(g.getObjectId(e,this._objectIdField)));t.length!==e.features.length&&(n=t)}if(a.features.length>0){n||(n=e.features.slice());for(const e of a.features)n.push(e)}n&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,n.length)),this._applyEditsTileUpdated(),e.setFeatures(n,0,M(e.availableFields,a.fields),I(e.missingAttributes,a.missingAttributes)),this._updateTileZQuantization(e),this._invalidateCounts())}_applyEditsTileUpdated(){this._applyEditsTilesUpdated||(this._applyEditsTilesUpdated=!0,this._updated())}_queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:j})}_setDirty(){this._dirty=!0,this._updated()}runTask(e){const t=this._frameTask.processQueue(e);if(!this._dirty||!this.initialized)return t;this._dirty=!1;const i=this._featureTilesArray;if(this._markTilesNotAlive(i),!e.run(()=>this._addTiles(i,e))||!e.run(()=>this._filterExtentTiles(i,e))||!e.run(()=>this._removeTiles(i,e))||e.done)return void this._setDirty();const s=this._sortTiles(i);e.run(()=>this._showTiles(s,e))&&e.run(()=>this._fetchTiles(s,e))&&e.run(()=>this._updateMemoryEstimates(s,e))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(e){for(const t of e)t.alive=!1}_addTiles(e,t){return!(this._suspended||!this.tileDescriptors)&&(this.tileDescriptors.forEach(i=>{const s=this._featureTiles.get(i.id);s?s.alive=!0:t.done||(e.push(this._addTile(i)),t.madeProgress())}),t.hasProgressed)}_filterExtentTiles(e,t){for(const i of e){if(t.done)break;i.alive&&(i.filtered=!i.intersects(this.filterExtent),i.filtered&&(this._clearTile(i),t.madeProgress()))}return t.hasProgressed}_removeTiles(e,t){for(let i=e.length-1;i>=0&&!t.done;i--){const s=e[i];s.alive||(this._removeTile(s),i!==e.length-1&&(e[i]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}_sortTiles(e){return e.sort((e,t)=>e.descriptor.loadPriority-t.descriptor.loadPriority),e}_showTiles(e,t){const i=this._updateRatio(e),s=e=>{const t=this._fullRatio<1?i(e)*this._farRatio:1;e.reduceFeatures(t,this.memoryFactor,this._objectIdField,this._reduceMode)&&this._setDirty();const{numFeatures:s,fetchingResolution:r,descriptor:a,isFetched:n}=e;return this._supportsResolution&&s>0&&r!==a.resolution&&n&&(e.requestRefetch(),this._setDirty()),this._showTile(e)};for(const i of e)if(!t.run(()=>s(i))){this._setDirty();break}return t.hasProgressed}_fetchTiles(e,t){if(this._paused)return!1;let i=!1;for(const s of e){if(!s.needsFetch)continue;const e=null!=this.context.memoryCache?this.context.memoryCache.pop(s.id):null;if(e?.resolution!==s.displayingResolution){if(this._needsNumFeatures(s)){const e=new AbortController,r=this._fetchTileCount(s,e.signal);this._handleRequest(s,r,e,()=>s.resetFetching(),()=>s.numFeatures=x.failedFeatureCount),i=!0,t.madeProgress()}if(t.done)return!0}else s.cache=e,s.numFeatures&&this._notifyDataUpdating(),this._setDirty(),this._scheduleUpdated(),t.madeProgress()}if(i)return t.hasProgressed;for(const i of e){if(!i.needsFetch)continue;const e=new AbortController,s=this._fetchTile(i,e.signal);if(this._handleRequest(i,s,e,e=>i.fetchDone(e),e=>{i.fetchFailed=!0,this.context.logFetchError(a.getLogger(this),e)}),t.madeProgress(),t.done)return!0}return t.hasProgressed}_updateMemoryEstimates(e,t){return e.some(e=>!t.run(()=>e.updateMemoryEstimates())&&(this._setDirty(),!0)),t.hasProgressed}_reclip(e,t){if(!this.initialized)return;const i=new Array;this._featureTiles.forEach(s=>{null!=s.displayingFeatures&&0!==s.displayingFeatures.length&&(s.intersectionIncludingBorrowed(t,U),s.intersectionIncludingBorrowed(e,O),F.equals(U,O)||i.push(s))}),this._refreshDisplayingFeatures(i),this._updated()}_refreshDisplayingFeatures(e){const t=new Set,i=this._changes.updates;for(const s of e)if(null!=s.displayingFeatures)for(const e of s.displayingFeatures){const s=g.getObjectId(e,this._objectIdField);if(t.has(s))continue;t.add(s);const r=this._displayingFeatureReferences.get(s).feature;i.removes.push(r),i.adds.push(r)}this._applyChanges()}_updated(){let e=0;if(this._paused||this._featureTiles.forEach(t=>t.isFetching?++e:0),this._isFetching=e>0,e>0||this._applyEditsTilesUpdated?this._notifyDataUpdating():this._dirty||this._set("dataUpdating",!1),this.updating){let t=0,i=0,s=0,r=0,a=0;const n=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach(e=>{if(++i,e.isFetching&&e.hasPreciseFeatureCount){const t=this._maximumFeaturesForTile(e)*(1-e.emptyFeatureRatio),i=null!=e.displayingFeatures?e.displayingFeatures.length*n:0;a+=t-i}e.needsFetch?++r:e.numFeatures>0&&(++s,t+=e.numFeatures)}),r+=e;let o=0,l=0;t?(l=t,o=Math.min(r*t/s,t)):(l=i,o=r),a=Math.min(this.maximumNumberOfFeatures-this.features.length,a),this._set("updatingTotal",l),this._set("updatingRemaining",o),this._set("expectedFeatureDiff",a)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger?.update()}_updateMaximumNumberOfFeaturesExceeded(){for(const{perTileMaximumNumberOfFeaturesExceeded:e}of this._featureTiles.values())if(e)return void this._set("maximumNumberOfFeaturesExceeded",!0);this._set("maximumNumberOfFeaturesExceeded",!1)}_updateRatio(e){const t=function(e){let t=0;for(const i of e)i.features&&i.features.length>0&&i.alive&&(t=Math.max(t,i.descriptor.lij[0]));return t}(e),i=e=>1/(1<<Math.max(0,t-e.descriptor.lij[0]));let s=0,r=0;for(const t of e){const e=t.numFeatures;s+=e,r+=e*i(t)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/s),this._farRatio=this.maximumNumberOfFeatures/r,this._scheduleUpdated(),i}_maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this._featureTiles.forEach(e=>{if(!e.featuresMissing)return;const t=this._maximumFeaturesForTile(e);e.isFullyFetched(t)||(this._cancelFetchTile(e),this._resetFetchTile(e))}),this._setDirty())}_addTile(e){const t=new x.FeatureTile(e);return this._featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}_referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.displayingResolution;this._featureTiles.forEach(i=>{if(null!=i.displayingFeatures&&e!==i&&R.tilesAreRelated(e.descriptor.lij,i.descriptor.lij)){null==e.displayingFeatures&&(e.displayingFeatures=[]),e.descriptor.extent&&i.descriptor.extent&&(e.extentIncludingBorrowedFeatures??=F.clone(e.descriptor.extent),F.expand(e.extentIncludingBorrowedFeatures,i.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const s of i.displayingFeatures){e.displayingFeatures.push(s);const i=this._displayingFeatureReferences.get(g.getObjectId(s,this._objectIdField));i.ref(i.feature,t),this._numDisplayingFeatureReferences++}}})}_removeTile(e){this._clearTile(e),this._featureTiles.delete(e.id)}_resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetch&&e.fetchDone(4):e.requestFetch()}_cancelFetchTile(e){const t=e.requestController;null!=t&&(e.requestController=null,e.resetFetching(),t.abort())}async _fetchTileCount(e,t){e.numFeatures=await this._fetchCount(e,t),this._updateRatio(this._featureTilesArray)}async _fetchTile(e,t){e.fetchFailed=!1;const i=this._maximumFeaturesForTile(e);if(i<=0)return e.hasPreciseFeatureCount&&0===e.numFeatures||(e.fetchFailed=!0),function(e){e.setFeatures([],0,null,void 0)}(e),e.fetchInformation.value="Empty tile",4;const s=this._getMaxRecordCount(e),r=Math.ceil(i/s);if(e.fetchingResolution=e.descriptor.resolution,C(e)||!this.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=i&&r>y.MAX_MAX_RECORD_COUNT_FACTOR)return this._fetchPagedTile(e,t);const a=this._createQuery(e);if(a.maxRecordCountFactor=r,e.isRefetching&&e.features&&e.features.length>0){const t=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/s);a.maxRecordCountFactor=Math.max(t+1,a.maxRecordCountFactor)}e.fetchInformation.value=`Single fetch\n${i} features`;const{features:n,exceededTransferLimit:l,fields:u,missingAttributes:h}=await this._queryFeatures(a,t),c=l||a.maxRecordCountFactor>=y.MAX_MAX_RECORD_COUNT_FACTOR||i===this._totalFeaturesForTile(e)?5:4,d=await this._frameTask.schedule(()=>{e.exceededTransferLimit.value=!!l;const t=this._removeEmptyFeatures(n,this._getEffectiveTileResolution(e));return e.fetchInformation.value=`Single fetch\n${n.length}/${i} features`,e.setFeatures(n,t,w(u),I(void 0,h)),this._updateTileZQuantization(e),this._maximumFeaturesForTile(e)>i?1:c},t);return o.throwIfAborted(t),this._invalidateCounts(),d}async _fetchCount(e,t){return this.context.query.queryFeatureCount(this._createFeatureCountQuery(e),{signal:t})}async _fetchPagedTile(e,t){let i,s=0,r=0,a=0,n=this._maximumFeaturesForTile(e)-a;const l=this._getMaxRecordCount(e);let u,h=null;for(;;){const c=this._createQuery(e),d=this._setPagingParameters(c,s,n,l);e.fetchInformation.value=`Paged fetch\n${e.features?.length}/${n} features`;const{features:p,exceededTransferLimit:_,fields:f,missingAttributes:F}=await this._queryFeatures(c,t);if(await this._frameTask.schedule(()=>{d&&(s+=c.num),a+=p.length,r+=this._removeEmptyFeatures(p,this._getEffectiveTileResolution(e)),e.exceededTransferLimit.value=!!_,i=i?.concat(p)??p,h=M(h,f),u=I(u,F),e.setFeatures(i,r,h,u),this._updateTileZQuantization(e),this._invalidateCounts(),this._setDirty()},t),o.throwIfAborted(t),n=this._maximumFeaturesForTile(e)-(i?.length??0),!d||!_||n<=0)return _?4:5}}_createFeatureCountQuery(e){const t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}_createQuery(e){const t=this.context.createQuery();return t.resultType=this._resultType(e),!C(e)&&e.descriptor.extent&&this.context.tilingScheme&&(t.geometry=F.toExtent(e.descriptor.extent,this.context.tilingScheme.spatialReference)),this._setResolutionParams(t,e),"tile"!==t.resultType&&this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),E(e)&&this.context.highlightIds?.length?t.objectIds=this.context.highlightIds:!D(e)&&this.context.effectiveDisplayFilter&&(t.where=d.sqlAnd(t.where,this.context.effectiveDisplayFilter.where)),t}_setPagingParameters(e,t,i,s){return!!this.context.capabilities.supportsPagination&&(e.start=t,i>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(i/s),e.num=Math.min(e.maxRecordCountFactor*s,i)):e.num=Math.min(s),!0)}_getEffectiveTileResolution(e){if(C(e)||!this._supportsResolution)return null;const t=1===this.context.viewingMode&&this.context.tilingScheme?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.fetchingResolution,t)/this.lodFactor/this._tileZQuantization}get _supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}_setResolutionParams(e,t){const i=this._getEffectiveTileResolution(t);null!=i&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new m({mode:"view",originPosition:"upper-left",tolerance:i,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=i))}_removeEmptyFeatures(e,t){const i=e.length;if(t&&this._supportsResolution){const i=t*(1+f.getEpsilon());s.filterInPlace(e,({geometry:e})=>!(!e||!g.hasVertices(e))&&(g.computeAABR(e,P),F.width(P)>i||F.height(P)>i))}else s.filterInPlace(e,({geometry:e})=>g.hasVertices(e));return i-e.length}_needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!D(e)}_getMaxRecordCount(e){switch(this._resultType(e)){case"tile":if(this.context.tileMaxRecordCount)return this.context.tileMaxRecordCount;break;case"standard":if(this.context.standardMaxRecordCount)return this.context.standardMaxRecordCount}return this.context.maxRecordCount||A}_resultType(e){if(this.context.capabilities.supportsResultType)return D(e)?"standard":"tile"}get _reduceMode(){const e=this.context.geometryType;return"polygon"===e||"polyline"===e?0:1}_handleRequest(e,t,i,s,r){e.startFetch(),e.requestController=i;let a=!1;t.then(t=>{e.requestController=null,s(t)}).catch(t=>{e.requestController===i&&(e.requestController=null,e.fetchDone(4)),o.isAbortError(t)?a=!0:r(t)}).then(()=>{a||this._setDirty(),this._scheduleUpdated()})}_scheduleUpdated(){this.hasHandles("scheduleUpdated")||this.addHandles(h.schedule(()=>{this.removeHandles("scheduleUpdated"),this._updated()}),"scheduleUpdated")}_showTile(e){if(e.displayingFeatures&&!e.needsDisplayUpdate)return!1;const t=e.features;if(0===e.featureLimit||!t){const t=null!=e.displayingFeatures&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],t}const i=e.fetchingResolution,{adds:s,updates:r}=this._changes,a=Math.min(e.featureLimit,t.length);for(let e=0;e<a;++e){const a=t[e],n=g.getObjectId(a,this._objectIdField),o=this._displayingFeatureReferences.get(n);if(o){const{oldVersion:e,newVersion:t}=o.ref(a,i);e!==t&&(e&&r.removes.push(e),t&&r.adds.push(t))}else this._displayingFeatureReferences.set(n,new this.FeatureReferenceClass(a,i)),s.push(a);this._numDisplayingFeatureReferences++}return this._hideTileFeatures(e),e.displayingResolution=e.fetchingResolution,this._applyChanges(),e.displayingFeatures=t.slice(0,a),!0}_hideTile(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}_hideTileFeatures(e){if(null==e.displayingFeatures)return;const{updates:t,removes:i}=this._changes;for(const s of e.displayingFeatures){const r=g.getObjectId(s,this._objectIdField),a=this._displayingFeatureReferences.get(r);if(!a)continue;const{oldVersion:n,newVersion:o}=a.unref(e.displayingResolution);this._numDisplayingFeatureReferences--,n!==o&&(null==o?(this._displayingFeatureReferences.delete(r),n&&i.push(n)):(t.adds.push(o),n&&t.removes.push(n)))}this._applyChanges(),e.displayingFeatures=null}_notifyDataUpdating(){this._get("dataUpdating")||this._set("dataUpdating",!0)}_applyChanges(){const e=this._changes.updates;e.removes.length>0&&(this._notifyDataUpdating(),this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this._notifyDataUpdating(),this.features.addMany(e.adds),e.adds.length=0);const t=this._changes.adds,i=this._changes.removes,s=Math.min(t.length,i.length);let r=0;for(;r<s;){const e=Math.min(r+q,s);this._notifyDataUpdating(),this.features.addMany(t.slice(r,e)),this.features.removeMany(i.slice(r,e)),r=e}t.length>s&&(this._notifyDataUpdating(),this.features.addMany(0===r?t:t.slice(r))),i.length>s&&(this._notifyDataUpdating(),this.features.removeMany(0===r?i:i.slice(r))),t.length=0,i.length=0}_clearTile(e){this._hideTile(e),e.features&&null!=this.context.memoryCache&&this.context.memoryCache.put(e.id,e.cache),e.setFeatures(null,0,null,void 0),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}get _featureTilesArray(){return Array.from(this._featureTiles.values())}get featureTiles(){return this._featureTiles}get storedFeatures(){return this._featureTilesArray.reduce((e,t)=>e+(t.features?t.features.length:0),0)}get missingTiles(){return Array.from(this._featureTiles.values()).reduce((e,t)=>e+(t.needsFetch||t.isFetching?1:0),0)}_totalFeaturesForTile(e){return e.hasPreciseFeatureCount?e.numFeatures:this.maximumNumberOfFeatures}_maximumFeaturesForTile(e){const t=this._totalFeaturesForTile(e),i=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(t*i/(1-e.emptyFeatureRatio)),t)}get test(){}},t.__decorate([p.property({constructOnly:!0})],e.FeatureTileFetcher3D.prototype,"features",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"tileDescriptors",void 0),t.__decorate([p.property({value:1/0})],e.FeatureTileFetcher3D.prototype,"maximumNumberOfFeatures",null),t.__decorate([p.property({value:1})],e.FeatureTileFetcher3D.prototype,"memoryFactor",null),t.__decorate([p.property({value:1})],e.FeatureTileFetcher3D.prototype,"lodFactor",null),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"useTileCount",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"updating",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"dataUpdating",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"updatingTotal",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"updatingRemaining",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"expectedFeatureDiff",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"memoryForUnusedFeatures",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"maximumNumberOfFeaturesExceeded",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"totalVertices",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"totalFeatures",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"showsAllFeatures",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"hasFullGeometries",null),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"filterExtent",null),t.__decorate([p.property({constructOnly:!0})],e.FeatureTileFetcher3D.prototype,"context",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_dirty",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_suspended",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_pendingEdits",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_applyEditsTilesUpdated",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_paused",null),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_isFetching",void 0),e.FeatureTileFetcher3D=t.__decorate([_.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],e.FeatureTileFetcher3D);const A=2e3,U=F.create(),O=F.create(),P=F.create(),j=6e5,q=200;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});