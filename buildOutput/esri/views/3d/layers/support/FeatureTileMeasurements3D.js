// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/frustum","../../../../geometry/support/ray","./FeatureTileVisibility3D","../../webgl/RenderCamera"],function(e,t,i,s,o,r,a,n){"use strict";const l=[i.create(),i.create(),i.create(),i.create()],c=i.create(),d=i.create(),h=i.create(),u=i.freeze(0,0,1),m=r.fromValues(i.ZEROS,u);e.FeatureTileMeasurements3D=class{constructor(e,t,i){this._renderCoordsHelper=e,this._tilingScheme=t,this._camera=new n,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new a.FeatureTileVisibility3D(e,i)}set opaqueGround(e){this._visibility.opaqueGround=e}setup(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(e){const{measures:t,extent:i,level:o}=e;i&&(t.visible=this._visibility.compute(e),t.distance=s.distance(i,this._focusOnMap),t.mergeable=!0,t.lodLevel=a.minTileLOD,t.splitPriority=Math.max(0,a.minTileLOD-o),t.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(e):this._updateSplitAndLodLocal(e)))}_updateSplitAndLodGlobal(e){const i=e.level,s=this._renderCoordsHelper,{eye:o,fov:r}=this._camera,n=s.referenceEllipsoid.radius,d=t.len(o)-n;if(2*Math.atan(n/d)<r&&d>0)return void(e.measures.lodLevel=Math.max(i,a.minTileLOD));const u=l,{extent:p}=e;if(!p)return;const{_surfaceElevation:_}=this;t.set(u[0],p[0],p[1],_),t.set(u[1],p[2],p[1],_),t.set(u[2],p[2],p[3],_),t.set(u[3],p[0],p[3],_);const f=t.set(c,.5*(p[0]+p[2]),.5*(p[1]+p[3]),_),v=this._tilingScheme.spatialReference;for(let e=0;e<4;++e)s.toRenderCoords(u[e],v,u[e]);s.toRenderCoords(f,v,f);const M=t.normalize(m.direction,f),y=t.dot(o,M),b=t.scale(h,M,y);this._updateSplitAndLod(e,u,f,b)}_updateSplitAndLodLocal(e){const i=l,{extent:s}=e;if(!s)return;const{_surfaceElevation:o}=this;t.set(i[0],s[0],s[1],o),t.set(i[1],s[2],s[1],o),t.set(i[2],s[2],s[3],o),t.set(i[3],s[0],s[3],o);const r=this._tilingScheme.spatialReference;for(let e=0;e<4;++e)this._renderCoordsHelper.toRenderCoords(i[e],r,i[e]);const a=t.set(c,.5*(i[0][0]+i[2][0]),.5*(i[0][1]+i[2][1]),.25*(i[0][2]+i[1][2]+i[2][2]+i[3][2])),n=t.set(d,a[0],a[1],0),{eye:p,far:_}=this._camera,f=t.set(h,n[0],n[1],p[2]);t.set(m.origin,n[0],n[1],p[2]-2*_),t.copy(m.direction,u),this._updateSplitAndLod(e,i,a,f)}_updateSplitAndLod(e,i,s,r){const a=Math.max(t.dist(i[0],i[2]),t.dist(i[1],i[3]),t.dist(i[0],s)+t.dist(s,i[2]),t.dist(i[1],s)+t.dist(s,i[3])),{eye:n,near:l,fov:c,viewForward:d,width:h,height:u,pixelRatio:m,frustum:p}=this._camera,_=t.dot(n,d),f=t.dot(s,d)-_,v=t.dist(s,n);let M=f,y=f,b=v,L=v;const g=(e,t)=>t<l?1:Math.sqrt(e*e-t*t)/t;let x=g(v,f);for(const e of i){const i=t.dot(e,d)-_;M=Math.min(M,i),y=Math.max(y,i);const s=t.dist(e,n);L=Math.max(L,s),b=Math.min(b,s);const o=g(s,i);x=Math.min(x,o)}if(y<l)return void(e.measures.lodLevel=0);const S=Math.cos(.5*c),O=t.dist(n,r);x>S&&O>.5*a&&(y=2*L,M=2*b);const P=.5*Math.sqrt(h*h+u*u)/m,R=2*Math.tan(.5*c),C=e=>312*Math.max(l,e)/P*R,w=e.level,A=a*2**w*Math.max(1,R),T=C(M),D=Math.ceil(Math.log2(Math.max(1,A/T)));if(e.measures.lodLevel=Math.max(D,e.measures.lodLevel),e.measures.splitPriority+=e.measures.lodLevel-w,w<D){const t=+o.intersectsPoint(p,i[0])+ +o.intersectsPoint(p,i[1])+ +o.intersectsPoint(p,i[2])+ +o.intersectsPoint(p,i[3]);e.measures.splitPriority+=t}const E=C(y)/T;E>2.5&&(e.measures.splitPriority+=E)}get _isGlobal(){return 1===this._renderCoordsHelper.viewingMode}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});