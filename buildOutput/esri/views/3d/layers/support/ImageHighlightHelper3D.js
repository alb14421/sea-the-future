// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../chunks/tslib.es6","../../../../Color","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/handleUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/projectionUtils","../../../../support/GraphicsCollection","../../../../symbols/SimpleFillSymbol","../../../../symbols/SimpleLineSymbol","../../../../symbols/SimpleMarkerSymbol","../../../layers/support/highlightUtils"],function(e,t,i,r,s,o,h,a,l,p,g,c,n,d,u,y,m,_){"use strict";const H=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));t.ImageHighlightHelper3D=class extends s{get updating(){return this.graphicsView?.updating??!1}constructor(e){super(e),this._highlightCounts=new Map,this._graphicsViewLoader=null,this.graphics=new d.GraphicsCollection,this.graphicsView=null,this.suspended=!1;const t=new r([255,255,255,1/255]);this._symbols=new Map([["point",new m({size:"2px",style:"square",color:t})],["polyline",new y({width:"2px",color:t})],["polygon",new u({outline:null,color:t})]])}highlight(e,t){const i=_.getHighlightGraphics(e);if(0===i.length)return h.makeHandle();let r,s=!1;return this.updatingHandles.addPromise(Promise.all([this._createHighlightGraphics(i),this._ensureGraphicsView3D()]).then(([e,i])=>{!s&&i&&(r=this._addHighlightGraphics(i,e,t))})),h.makeHandle(()=>{s=!0,r?.remove()})}preload(){this._ensureGraphicsView3D()}_addHighlightGraphics(e,t,i){for(const e of t)this._highlightCounts.set(e,(this._highlightCounts.get(e)??0)+1);this.graphics.addMany(t);const r=e.highlight(t,i);return h.makeHandle(()=>{this._removeHighlightGraphics(t),r.remove()})}_removeHighlightGraphics(e){this.graphics.removeMany(e.filter(e=>{const t=Math.max(0,(this._highlightCounts.get(e)??0)-1);return 0===t?(this._highlightCounts.delete(e),!0):(this._highlightCounts.set(e,t),!1)}))}async _ensureGraphicsView3D(){if(this.graphicsView)return this.graphicsView;this._graphicsViewLoader||(this._graphicsViewLoader=new Promise((t,i)=>e(["../GraphicsView3D"],e=>t(H(e)),i)));const{default:t}=await this._graphicsViewLoader;if(this.destroyed)return null;const i=new t({view:this.view,layer:this.layer,getGraphics:()=>this.graphics,drapeSourcePriorityOffset:.5});return this._set("graphicsView",i),this.addHandles([h.destroyHandle(this.graphicsView),a.watch(()=>this.suspended,e=>{i.suspended=e},a.syncAndInitial)]),i}async _createHighlightGraphics(e){const t=e.map(({geometry:e})=>e?.spatialReference).filter(o.isSome).reduce((e,t)=>(0!==e.length&&e.at(-1)?.equals(t)||e.push(t),e),[]),i=this.view.spatialReference,r=t.map(e=>({source:e,dest:i}));try{await n.initializeProjection(r)}catch{return[]}return e.map(e=>{const{geometry:t}=e;try{const r=t?n.project(t,i):null,s=e.cloneShallow();return s.geometry=r,s.symbol=this._symbols.get(r?.type),s}catch{return e}})}},i.__decorate([l.property()],t.ImageHighlightHelper3D.prototype,"graphics",void 0),i.__decorate([l.property()],t.ImageHighlightHelper3D.prototype,"graphicsView",void 0),i.__decorate([l.property()],t.ImageHighlightHelper3D.prototype,"view",void 0),i.__decorate([l.property()],t.ImageHighlightHelper3D.prototype,"layer",void 0),i.__decorate([l.property()],t.ImageHighlightHelper3D.prototype,"updatingHandles",void 0),i.__decorate([l.property()],t.ImageHighlightHelper3D.prototype,"suspended",void 0),i.__decorate([l.property()],t.ImageHighlightHelper3D.prototype,"updating",null),t.ImageHighlightHelper3D=i.__decorate([c.subclass("esri.views.3d.layers.support.ImageHighlightHelper3D")],t.ImageHighlightHelper3D),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});