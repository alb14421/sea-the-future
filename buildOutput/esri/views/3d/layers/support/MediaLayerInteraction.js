// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat2d","../../../../core/libs/gl-matrix-2/factories/mat2df64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../core/support/UpdatingHandles","../../interactive/editingTools/media/ControlPointOperations","../../../input/InputManager","../../../interactive/keybindings","../../../interactive/snapping/SnappingManagerPool","../../../support/automaticAreaMeasurementUtils","../../../support/automaticLengthMeasurementUtils"],function(e,t,o,i,a,s,r,n,d,l,c,p,h,m,_,y,u,g,v,b,T,f,M,w,P,E){"use strict";const I=Symbol(),S=Symbol();t.MediaLayerInteraction=class extends i{get editSourcePoints(){return!!this.options?.reshapeOptions.editSourcePoints!==this._isEditSourcePointsToggled}get updating(){return this._updatingHandles.updating}get _preferredInteractionTool(){return this.options?.tool??"transform"}get _toolType(){switch(this._preferredInteractionTool){case"transform":return"transform-3d";case"reshape":return"reshape-3d"}}get _validatedSelectedElement(){const e=this.selectedElement;if(!e)return null;const{layer:{source:t}}=this;return t?"hasElement"in t?t.hasElement(e)?e:null:t===e?e:null:null}constructor(e){super(e),this.enabled=!1,this._isEditSourcePointsToggled=!1,this._updatingHandles=new b.UpdatingHandles,this._isOpacityToggled=!1,this._factor=1,this._tool=null,this._object=null,this._createToolAbortController=null,this._onPointerMove=n.debounce(async e=>{const t=await this._updatingHandles.addPromise(this._findElementAtScreenPoint(e));this.destroyed||(this.removeHandles(S),t&&t!==this.selectedElement&&this.addHandles(this.view.acquireCursor("pointer","high"),S))}),this._tmpMat2=u.create(),this._tmpVec2=v.create()}destroy(){this._createToolAbortController=r.abortMaybe(this._createToolAbortController)}initialize(){this.addHandles([a.destroyHandle(this._updatingHandles),this._updatingHandles.add(()=>this.enabled,e=>this._enableDisable(e),d.initial),this._updatingHandles.add(()=>this._preferredInteractionTool,e=>this._preferredInteractionToolChanged(e))])}_enableDisable(e){if(!e)return void this.removeHandles(I);this._dynamicImports();const{view:t}=this,o=new M.KeyBindings;o.add(M.mediaKeys.undo,()=>{this._object?.operations?.undo(),this._object?.emit("modified-externally")}),o.add(M.mediaKeys.redo,()=>{this._object?.operations?.redo(),this._object?.emit("modified-externally")}),o.addToggle(M.mediaKeys.preserveAspectRatio,e=>{"transform-3d"===this._tool?.type&&(this._tool.preserveAspectRatio="key-down"===e.type)}),o.addToggle(M.mediaKeys.editSourcePoints,e=>{"reshape-3d"===this._tool?.type&&(this._isEditSourcePointsToggled="key-down"===e.type)}),o.addToggle(M.mediaKeys.rotateIncrements,e=>{"transform-3d"===this._tool?.type&&(this._tool.snapRotation="key-down"===e.type)}),o.add(M.mediaKeys.toggleOpacity,()=>{const e=this._object?.element;e&&(e.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled)}),o.add(M.mediaKeys.moveUp,()=>this._move(0,this._factor)),o.add(M.mediaKeys.moveDown,()=>this._move(0,-this._factor)),o.add(M.mediaKeys.moveRight,()=>this._move(this._factor,0)),o.add(M.mediaKeys.moveLeft,()=>this._move(-this._factor,0)),o.addToggle(M.mediaKeys.factorModifier,e=>this._factor="key-down"===e.type?10:1),this._isOpacityToggled=!1,this.addHandles([o.register(t,f.ViewEventPriorities.TOOL),a.makeHandle(()=>{this._isOpacityToggled&&this.selectedElement&&(this.selectedElement.opacity*=2,this._isOpacityToggled=!1)}),t.on("immediate-click",e=>this._onClick(e),f.ViewEventPriorities.TOOL),t.on("pointer-move",e=>this._onPointerMove(e).catch(()=>{}),f.ViewEventPriorities.TOOL),this._updatingHandles.add(()=>this._validatedSelectedElement,(e,t)=>{t&&e!==t&&this._isOpacityToggled&&(t.opacity*=2,this._isOpacityToggled=!1),this._selectedElementChanged(e)},d.initial),a.makeHandle(()=>{this.removeHandles(S),this._removeTool()})],I)}async _onClick(e){await this._updatingHandles.addPromise(e.defer(async()=>{const t=await this._findElementAtScreenPoint(e);this.destroyed||(t&&e.stopPropagation(),this.selectedElement=t,this.selectedElement&&this.removeHandles(S))}))}async _selectedElementChanged(e){e?.georeference?this._object?.element!==e&&await this._updatingHandles.addPromise(this._recreateTool()):this._removeTool()}async _recreateTool(){this._createToolAbortController=r.abortMaybe(this._createToolAbortController),this._removeTool();const e=this._validatedSelectedElement;if(!e)return;const t=new AbortController;this._createToolAbortController=t;const{ManipulatedObject3DMediaElement:o,ExtentTransformTool:i,ReshapeTool3D:s,automaticAreaMeasurementUtils:n,automaticLengthMeasurementUtils:l}=await this._dynamicImports();if(t.signal.aborted)return;const{view:c,layer:p,_toolType:h}=this;switch(this._object=new o({view:c,layer:p,element:e,tool:this._preferredInteractionTool}),h){case"transform-3d":{this._tool=new i({view:c,object:this._object,automaticLengthMeasurementUtils:l});const e=c.inputManager;e.isModifierKeyDown(M.mediaKeys.rotateIncrements.key)&&(this._tool.snapRotation=!0),e.isModifierKeyDown(M.mediaKeys.preserveAspectRatio.key)&&(this._tool.preserveAspectRatio=!0)}break;case"reshape-3d":{const e=w.acquire(c),{snappingManager:t}=e;this._tool=new s({view:c,object:this._object,enableMidpoints:!1,enableZShape:!1,snappingManager:t,enableMoveObject:!1,autoHideManipulators:!0,enableDeleteVertices:!1,sketchOptions:{tooltips:{enabled:!0,inputEnabled:!0,visibleElements:{area:!1}}},automaticAreaMeasurementUtils:n,automaticLengthMeasurementUtils:l}),this.addHandles([e,d.watch(()=>({editSourcePoints:this.editSourcePoints,operations:this._object?.operations}),e=>{e.operations instanceof T.ControlPointOperations&&(e.operations.editSourcePoints=e.editSourcePoints)},d.syncAndInitial)],this._tool)}}this.addHandles([a.makeHandle(()=>{this._object=r.destroyMaybe(this._object),this._tool&&(c.tools.remove(this._tool),this._tool=null)})],this._tool),c.addAndActivateTool(this._tool)}_preferredInteractionToolChanged(e){const{_tool:t}=this;if(!t)return;if(this._toolType!==t.type)return void this._updatingHandles.addPromise(this._recreateTool());const{_object:o}=this;o&&(o.tool=e)}async _dynamicImports(){const[{ManipulatedObject3DMediaElement:t},{ExtentTransformTool:o,ReshapeTool3D:i},a,s]=await Promise.all([new Promise((t,o)=>e(["../../interactive/editingTools/ManipulatedObject3DMediaElement"],t,o)),new Promise((t,o)=>e(["../../interactive/editingTools"],t,o)),await P.loadAutomaticAreaMeasurementUtils(),await E.loadAutomaticLengthMeasurementUtils()]);return{ManipulatedObject3DMediaElement:t,ExtentTransformTool:o,ReshapeTool3D:i,automaticAreaMeasurementUtils:a,automaticLengthMeasurementUtils:s}}async _findElementAtScreenPoint(e){const t=(await this.view.hitTest(e,{include:[this.layer]})).results[0];return"media"===t?.type?t.element:null}_removeTool(){this._tool&&this.removeHandles(this._tool)}_move(e,t){const{view:o,_object:i}=this,a=i?.operations;if(!a)return;const r=o.overlayPixelSizeInMapUnits(o.pointsOfInterest.focus.location)*l.getMetersPerUnitForSR(o.spatialReference)/l.getMetersPerUnitForSR(a.data.spatialReference),{_tmpMat2:n,_tmpVec2:d}=this,c=y.fromRotation(n,s.deg2rad(360-this.view.camera.heading)),p=g.set(d,r*e,r*t);g.transformMat2d(p,p,c),a.move(p[0],p[1],0),i.emit("modified-externally")}},o.__decorate([c.property({constructOnly:!0})],t.MediaLayerInteraction.prototype,"view",void 0),o.__decorate([c.property({constructOnly:!0})],t.MediaLayerInteraction.prototype,"layer",void 0),o.__decorate([c.property()],t.MediaLayerInteraction.prototype,"selectedElement",void 0),o.__decorate([c.property()],t.MediaLayerInteraction.prototype,"enabled",void 0),o.__decorate([c.property()],t.MediaLayerInteraction.prototype,"options",void 0),o.__decorate([c.property()],t.MediaLayerInteraction.prototype,"editSourcePoints",null),o.__decorate([c.property()],t.MediaLayerInteraction.prototype,"_isEditSourcePointsToggled",void 0),o.__decorate([c.property()],t.MediaLayerInteraction.prototype,"updating",null),o.__decorate([c.property()],t.MediaLayerInteraction.prototype,"_preferredInteractionTool",null),o.__decorate([c.property()],t.MediaLayerInteraction.prototype,"_validatedSelectedElement",null),t.MediaLayerInteraction=o.__decorate([_.subclass("esri.views.3d.layers.support.MediaLayerInteraction")],t.MediaLayerInteraction),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});