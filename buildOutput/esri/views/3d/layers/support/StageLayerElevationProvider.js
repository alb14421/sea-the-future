// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Evented","../../../../core/Logger","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../symbols/support/unitConversionUtils","../../support/ElevationUpdateEvent","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/VertexAttribute"],function(e,t,r,o,n,i,s,a,l,c,d,p,h,u,v){"use strict";const g=Symbol("layerHandles");e.StageLayerElevationProvider=class extends r.EventedAccessor{get spatialReference(){return this.view?.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=new u.Intersector(this.view.state.viewingMode),this._intersector.options.store=0;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this.addHandles([t.on(["layerObjectAdded","layerObjectRemoved","transformationChanged","shaderTransformationChanged"],e=>this._objectChanged(e)),t.on(["geometryAdded","geometryRemoved"],({object:e})=>this._objectChanged(e)),t.on("attributesChanged",({attribute:e,object:t})=>v.affectsGeometry(e)&&this._objectChanged(t))],g)}dispose(){this.removeHandles(g)}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=n.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=p.getMetersPerUnit(e.unit??"meters");this._elevationOffset=(e.offset??0)*r/t}else this._elevationOffset=0}getElevation(e,t,r,n){if(_[0]=e,_[1]=t,_[2]=r,!this._renderCoordsHelper.toRenderCoords(_,n,_))return o.getLogger(this).error("could not project point for elevation alignment"),null;const i=this._elevationOffset,s=this._zmin+i,a=this._zmax+i;return this._renderCoordsHelper.setAltitude(f,a,_),this._renderCoordsHelper.setAltitude(b,s,_),this._intersector.reset(f,b,null),this._intersector.intersect(this._intersectLayers,null,1,null,e=>!!e.lastValidElevationBB),this._intersector.results.min.getIntersectionPoint(_)?this._renderCoordsHelper.getAltitude(_):null}_objectChanged(e){const t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;d.empty(y);const r=e.lastValidElevationBB;r.isEmpty()||this._expandExtent(t,r.min,r.max,y);const{min:o,max:n}=e.boundingVolumeWorldSpace;this._expandExtent(t,o,n,y),d.toRect(y,m.extent),this._zmin=Math.min(this._zmin,y[2]),this._zmax=Math.max(this._zmax,y[5]),m.spatialReference=t,this.emit("elevation-change",m),m.spatialReference=null,r.assignMinMax(o,n)}_computeLayerExtent(e,t){return d.empty(y),null!=e&&t.objects.forEach(t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,y)),y}_expandExtent(e,t,r,o){for(let n=0;n<8;++n)_[0]=1&n?t[0]:r[0],_[1]=2&n?t[1]:r[1],_[2]=4&n?t[2]:r[2],this._renderCoordsHelper.fromRenderCoords(_,_,e),d.expandWithVec3(o,_);return o}},t.__decorate([i.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"layer",void 0),t.__decorate([i.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"stageLayer",void 0),t.__decorate([i.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"view",void 0),t.__decorate([i.property()],e.StageLayerElevationProvider.prototype,"spatialReference",null),e.StageLayerElevationProvider=t.__decorate([l.subclass("esri.views.3d.layers.support.StageLayerElevationProvider")],e.StageLayerElevationProvider);const y=d.empty(),m=new h.ElevationUpdateEvent,_=c.create(),f=c.create(),b=c.create();e.cleanupStageLayerElevationProvider=function(){m.spatialReference=null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});