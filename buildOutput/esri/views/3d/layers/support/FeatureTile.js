// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/arrayUtils","../../../../core/memoryEstimations","../../../../core/signal","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../graphics/graphicUtils"],function(e,t,s,i,r,a,u,h){"use strict";class n{constructor(e,t,i,r){this.features=t,this.numFeatures=i,this.emptyFeatureRatio=r,this.cachedMemory=s.baseObjectMemory+e.estimatedSize,this.resolution=e.displayingResolution,this.availableFields=e.availableFields,this.fetchStatus=e.fetchStatus,this.exceededTransferLimit=e.exceededTransferLimit.value,this.fetchInformation=e.fetchInformation.value}}const l=a.create(),f=r.create();e.FeatureTile=class{constructor(e){this.descriptor=e,this._numVertices=0,this.exceededTransferLimit=i.signal(!1),this._fetchFailed=i.signal(!1),this._sorted=!1,this._numFeatures=i.signal(-1),this._emptyFeatureRatio=i.signal(0),this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._displayingFeatures=null,this.alive=!0,this.filtered=!1,this._features=null,this._featuresLength=i.signal(0),this._featureLimit=i.signal(0),this._fetchStatus=0,this.fetchInformation=i.signal(""),this.fetchingResolution=this.displayingResolution=e.resolution}get featuresMissing(){return this.fetchFailed||(this.hasPreciseFeatureCount?this._featuresLength.value<this.numFeatures:this.exceededTransferLimit.value)}get showsAllFeatures(){return!this.fetchFailed&&null!=this.displayingFeatures&&(this.hasPreciseFeatureCount?this.displayingFeatures.length===this.numFeatures:!this.exceededTransferLimit.value)}get missingAttributes(){return this._missingAttributes}get fetchFailed(){return this._fetchFailed.value}set fetchFailed(e){this._fetchFailed.value=e}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(e){this._displayingFeatures=e,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){const e=this.isFetched&&this.featuresMissing;return!this.filtered&&(e||this.hasFeatureLimit)}get features(){return this._features}get featureLimit(){return this._featureLimit.value}set featureLimit(e){this._featureLimit.value!==e&&(this._featureLimit.value=e,this._estimatedUnusedSizeDirty=!0)}get hasFeatureLimit(){return this.featureLimit!==this._featuresLength.value}get availableFields(){return this._availableFields}setFeatures(e,t,s,i){this._availableFields=s,this._features=e,this._featuresLength.value=e?.length??0,this._sorted=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,this._missingAttributes=i,e&&e.length>0?(this._emptyFeatureRatio.value=t/(e.length+t),this._numVertices=e.reduce((e,t)=>e+u.numVertices(t.geometry),0)):(this._emptyFeatureRatio.value=0,this._numVertices=0)}computeZQuantizationFactor(){if(this._features&&this._features.length>0){const e=this._features.reduce((e,{geometry:t})=>Math.max(e,h.computeMaxZ(t)??0),0);return Math.floor(e/this.descriptor.planetRadius)+1}return 1}get emptyFeatureRatio(){return this._emptyFeatureRatio.value}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures.value:this._features?this._featuresLength.value:0}set numFeatures(e){this._numFeatures.value=e}get hasPreciseFeatureCount(){return this._numFeatures.value>-1}get needsFeatureCount(){return-1===this._numFeatures.value}get numVertices(){return this._numVertices}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let e=0;e<this._features.length;++e){const t=u.estimateSize(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let e=this.featureLimit;e<this._features.length;++e)this._estimatedUnusedSize+=u.estimateSize(this._features[e]);return!0}return!1}get fetchStatus(){return this._fetchStatus}requestFetch(){this._fetchStatus=0}requestRefetch(){this._fetchStatus=1}startFetch(){this._fetchStatus=this.needsRefetch?3:2}fetchDone(e){this._fetchStatus=e}get isFetching(){return 2===this._fetchStatus||3===this._fetchStatus}get isRefetching(){return 3===this._fetchStatus}get needsFetch(){return 0===this._fetchStatus||1===this._fetchStatus}get needsRefetch(){return 1===this._fetchStatus}get isFetched(){return 4===this._fetchStatus||5===this._fetchStatus}isFullyFetched(e){return!!this.features&&(this.features.length>=e||5===this.fetchStatus)}resetFetching(){this._fetchStatus=this.isRefetching?1:0}get needsDisplayUpdate(){return!!this._features&&!function(e,t,s){if(null==t||null==e||s!==t.length||s>e.length)return!1;for(let i=0;i<s;++i)if(e[i]!==t[i])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(e){return null==e||!this.descriptor.extent||(a.fromExtent(e,l),a.intersects(this.descriptor.extent,l))}intersectionIncludingBorrowed(e,t){const s=null!=this.extentIncludingBorrowedFeatures?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return e||s?(null!=e?(a.fromExtent(e,t),a.intersection(t,s,t)):a.copy(t,s),t):(a.copy(t,a.positiveInfinity),t)}_shuffle(e){this._features?.sort((t,s)=>u.getObjectId(t,e)-u.getObjectId(s,e)),t.shuffle(this._features,16438)}_sortBySize(e){this._features?.sort((t,s)=>r.diameter(u.computeAABB(s.geometry,f))-r.diameter(u.computeAABB(t.geometry,f))||u.getObjectId(t,e)-u.getObjectId(s,e))}reduceFeatures(e,t,s,i){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let r=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&4===this._fetchStatus&&this._features.length>0&&(this._fetchStatus=1,r=!0),!this._sorted&&e<1&&(1===i?this._shuffle(s):this._sortBySize(s),this._sorted=!0,this._estimatedUnusedSizeDirty=!0);const a=Math.max(this.featureLimit,Math.ceil(t*this.numFeatures));return this._features.length>a&&(this._features.length=this._featuresLength.value=a,this.exceededTransferLimit.value=!1,5===this._fetchStatus&&(this._fetchStatus=4)),r}get cache(){return new n(this,this._features,this._numFeatures.value,this._emptyFeatureRatio.value)}set cache(e){this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._featuresLength.value=e.features?.length??0,this._numFeatures.value=e.numFeatures,this._emptyFeatureRatio.value=e.emptyFeatureRatio,this._fetchStatus=e.fetchStatus,this.exceededTransferLimit.value=e.exceededTransferLimit,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,this.fetchInformation.value=e.fetchInformation}},e.FeatureTileCacheItem=n,e.failedFeatureCount=-2,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});