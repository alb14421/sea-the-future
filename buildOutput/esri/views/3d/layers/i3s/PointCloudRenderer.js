// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/PooledArray","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/plane","../../../../geometry/support/ray","./Intersector","./PointCloudHighlights","../../webgl-engine/core/shaderLibrary/ShaderOutput","../../webgl-engine/effects/RenderPlugin","../../webgl-engine/lib/IntersectorResult","../../webgl-engine/lib/VertexArrayObject","../../../../chunks/PointRenderer.glsl","../../webgl-engine/shaders/PointRendererTechnique","../../webgl-engine/shaders/PointRendererTechniqueConfiguration","../../../webgl/enums","../../../webgl/VertexBuffer"],function(e,t,s,i,r,n,o,a,l,h,c,d,u,g,p,_,m,P,f,b,x,S,y,R,z,w){"use strict";function v(e,t,s,i,r){if(s.drawScreenSpace)return s.fixedSize*t*i;const n=S.getMaxPointSizeScreenspace(r)*t*i;return s.useFixedSizes?Math.min(s.fixedSize/2,n):s.screenMinSize>0?Math.min(Math.max(s.screenMinSize*t*i,e/2),n):Math.min(e/2,n)}function q(e,t,s,i,r){return s.drawScreenSpace?0:v(e,t,s,i,r)}function A(e,t,s){return null==s&&(s=c.create()),s[0]=e.origin[0]+e.coordinates[3*t],s[1]=e.origin[1]+e.coordinates[3*t+1],s[2]=e.origin[2]+e.coordinates[3*t+2],s}e.PointCloudRenderer=class extends f.SyncRenderPlugin{constructor(e){super(e),this.type=5,this.isGround=!1,this._passParameters=new S.PointRendererPassParameters,this._highlights=new m.PointCloudHighlights({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,s)=>this._addHighlight(e,t,s),removeHighlight:(e,t)=>this._removeHighlight(e,t)}),this.produces=new Map([[2,e=>!(P.isDepth(e)||8===e&&this._highlights.empty)],[3,e=>P.isDepth(e)]]),this.layerViewUid="",this._slicePlaneEnabled=!1,this._configuration=new R.PointRendererTechniqueConfiguration,this._nodes=new i}destroy(){this._nodes.prune()}hasHighlight(e){return this._highlights.has(e)}initializeRenderContext(e){this._context=e,e.requestRender()}uninitializeRenderContext(){}intersect(e,t,s,i){const r=c.create(),n=c.create(),o=c.create(),a=c.create(),l=g.create(),m=e.camera.perScreenPixelRatio/2,P=e.camera.near;h.subtract(n,i,s);const f=1/h.length(n);h.scale(n,n,f),h.negate(o,n),d.set(l,n[0],n[1],n[2],-h.dot(n,s));const x=new M,S=new M,y=new Array,R=u.create(),z=u.create(this._passParameters.clipBox);u.offset(z,-s[0],-s[1],-s[2],z),this._nodes.forAll(c=>{const d=c.splatSize*this._passParameters.scaleFactor;let g=c.obb.minimumDistancePlane(l),p=c.obb.maximumDistancePlane(l);g-=q(d,g+P,this._passParameters,m,c.isLeaf),p-=q(d,p+P,this._passParameters,m,c.isLeaf);const _=p<0,b=null!=x.dist&&null!=S.dist&&x.dist<g*f&&S.dist>p*f;if(_||b)return;const w=v(d,p+P,this._passParameters,m,c.isLeaf);if(!c.obb.intersectRay(s,n,w))return;const F=w*w;c.obb.toAaBoundingBox(R),u.offset(R,-s[0],-s[1],-s[2],R);const C=!u.contains(z,R);h.subtract(a,c.origin,s);const I=c.coordinates.length/3;for(let l=0;l<I;l++){if(r[0]=a[0]+c.coordinates[3*l],r[1]=a[1]+c.coordinates[3*l+1],r[2]=a[2]+c.coordinates[3*l+2],C&&!u.containsPoint(z,r))continue;const g=h.dot(r,n),p=h.squaredLength(r)-g*g;if(p>F)continue;let _=g+P;const b=q(d,_,this._passParameters,m,c.isLeaf);if(g-b<0)continue;_-=b;const R=v(d,_,this._passParameters,m,c.isLeaf);if(p>R*R)continue;const w=(g-b)*f,I=e=>(e.point=A(c,l,e.point),e.dist=w,e.normal=o,e.node=c,e.pointId=l,e.layerViewUid=this.layerViewUid,e);if((null==x.dist||w<x.dist)&&(null==t||t(s,i,w))&&I(x),0!==e.options.store&&(null==S.dist||w>S.dist)&&(null==t||t(s,i,w))&&I(S),2===e.options.store&&(null==t||t(s,i,w))){const e=new M;y.push(I(e))}}});const w=e=>{const{layerViewUid:t,node:s,pointId:i}=e;return new _.PclTarget(e.point,t,i,()=>this.createGraphic(s,i,e.point))},C=(e,t)=>{const s=w(t);e.set(this.type,s,t.dist,t.normal)};if(F(x)){const t=e.results.min;(null==t.distance||x.dist<t.distance)&&C(t,x)}if(F(S)&&0!==e.options.store){const t=e.results.max;(null==t.distance||S.dist>t.distance)&&C(t,S)}if(2===e.options.store){const t=p.fromPoints(s,i);for(const s of y){const i=new b.IntersectorResult(t);C(i,s),e.results.all.push(i)}}}acquireTechniques(e){const t=8===e.output;return 0!==this._nodes.length&&(P.isColorOrColorEmission(e.output)||P.isDepth(e.output)&&3===e.bind.slot||t)?(this._nodes.forAll(t=>this._initNode(e,t)),this._configuration.drawScreenSize=this._passParameters.drawScreenSpace,this._configuration.useFixedSizes=this._passParameters.useFixedSizes,this._configuration.hasSlicePlane=this._slicePlaneEnabled,this._configuration.hasOccludees=e.bind.hasOccludees,this._configuration.clippingEnabled=this._clippingEnabled,this._configuration.hasHighlightMixTexture=t&&null!=e.bind.highlightMixTexture,this._configuration.output=e.output,this._context.techniques.get(y.PointRendererTechnique,this._configuration)):null}render(e,t){const{rctx:s,bind:i,output:r}=e,n=s.bindTechnique(t,i,this._passParameters),o=8===r,a=i.highlight?.name??null;o&&!a||this._nodes.forAll(t=>{0===t.coordinates.length||null==t.vao||o&&!t.highlightMap.has(a)||(n.assertCompatibleVertexAttributeLocations(t.vao),n.bindDraw(i,this._passParameters,t),s.bindVAO(t.vao),o?this._renderHighlightFragments(e,t):s.drawArrays(z.PrimitiveType.POINTS,0,t.coordinates.length/3))})}_renderHighlightFragments(e,t){const{highlightMap:s}=t,{rctx:i,bind:r}=e,{highlight:n}=r;if(!n)return;const o=n.name,a=s.get(o);if(!a||0===a.length)return;const{highlightOrderMap:l,highlightLevel:h}=r;if(null==h)return;for(const e of s.keys())if(e!==o){const t=l.get(e);if(void 0!==t&&t>h)return}let c=0,d=a[0].componentIndex,u=d+1;const g=()=>{for(;c<a.length&&a[c].id.highlightName!==o;)d=a[c].componentIndex,++c;u=d+1};g();const p=(e,t)=>{const s=t-e;s>0&&i.drawArrays(z.PrimitiveType.POINTS,e,s)};for(;c<a.length;){const e=a[c];if(e.id.highlightName!==o){p(d,u),++c,g();continue}const t=e.componentIndex;t!==u&&(p(d,u),d=t),u=t+1,++c}p(d,u)}set useFixedSizes(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}get size(){return this._passParameters.size}set sizePx(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(e){u.set(this._passParameters.clipBox,e||u.positiveInfinity)}get _clippingEnabled(){return!u.equals(this._passParameters.clipBox,u.positiveInfinity,(e,t)=>e===t)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let t=null;return this._nodes.filterInPlace(i=>i.id!==e||(t=i,i.vao=s.disposeMaybe(i.vao),this._highlights.nodeRemoved(i),!1)),this._requestRender(),t}forEachNode(e){this._nodes.forAll(e)}removeAll(){this._nodes.forAll(e=>e.vao=s.disposeMaybe(e.vao)),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(e,t){return this._highlights.add(e,t)}_addHighlight(e,t,s){e.addHighlight(t,s),this._requestRender()}_removeHighlight(e,t){e.removeHighlight(t),this._requestRender()}_initNode(e,t){t.vao??=new x.VertexArrayObject(e.rctx,new Map([["positions",new w.VertexBuffer(e.rctx,y.positionsLayout,t.coordinates)],["colors",new w.VertexBuffer(e.rctx,y.colorsLayout,t.rgb)]]))}_requestRender(){this._context&&this._context.requestRender()}},t.__decorate([r.property({constructOnly:!0})],e.PointCloudRenderer.prototype,"createGraphic",void 0),e.PointCloudRenderer=t.__decorate([l.subclass("esri.views.3d.layers.i3s.PointCloudRenderer")],e.PointCloudRenderer);class M{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerViewUid=""}}function F(e){return null!=e.dist&&null!=e.point&&null!=e.pointId&&null!=e.node}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});