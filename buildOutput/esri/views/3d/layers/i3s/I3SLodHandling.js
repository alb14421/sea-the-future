// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../core/PooledArray"],function(e){"use strict";const i=new e({deallocator:null});return class{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}destroy(){this._index=null,this._lodGlobalHandling=null,this._removeNodes=null}startNodeLoading(e,i,s){this._maxLodLevel=s.maxLodLevel,this._index=i,this._removeNodes=e}shouldLoadNode(e){if(null==e)return!1;const i=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(i)||!!i.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const s=this._layerView.view.resourceController.memoryController.usedMemory,n=Math.max(0,Math.floor(10*(s-1)));i.clear(),this._lodGlobalHandling(this._index.rootNode,n,!1,!!this._layerView.nodeCrossfadingEnabled);const t=i.length;this._removeNodes(i,e);const d=i.length<t;return 0!==i.length&&(this._lodGlobalDirty=!0),i.clear(),d}_lodGlobalHandling(e,s,n,t){if(null==e)return!1;const d=e.index,l=this._index,o=this._layerView,r=l.nodeTraversalState(e),a=this._isChosenMaxLOD(r),h=e.resources.isEmpty;if(a&&h)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const u=o.isNodeLoaded(d);if(t&&u&&a){const i=!n&&this.hasNoVisibleChildren(e);o.fadeNode(d,0,!i)}const _=u&&(!o.isNodeFullyFadedIn||o.isNodeFullyFadedIn(d));if(u&&(o.updateNodeState(d,a?1:0),a))return _&&this._removeChildrenRecursive(e),_;const c=e.childCount>0;let x=c;if(c)for(let i=0;i<e.childCount;i++){const e=l.getChildIndex(d,i),o=l.getNode(e);null!=o?!l.isGeometryVisible(e)||this._lodGlobalHandling(o,s,n||_,t)||(x=!1):l.isNodeVisible(e)&&(x=!1)}const L=u&&!a&&(x||i.length<s);L&&i.push(d),!t||L||!u||n||x||o.fadeNode(d,0,!1);const y=e.resources.isEmpty;return x||_&&!L||y}_removeChildrenRecursive(e){this._index.traverseDescendants(e,e=>((this._layerView.isNodeLoaded(e.index)||this._layerView.isNodeReloading(e.index))&&i.push(e.index),e.childrenLoaded>0))}hasNoVisibleChildren(e){let i=!0;return this._index.traverseDescendants(e,e=>!(!i||!this._index.isNodeVisible(e.index))&&(this._layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0)),i}_childrenRequireLoading(e){let i=!1,s=!0;return this._index.traverseDescendants(e,e=>{if(!s||!this._index.isNodeVisible(e.index))return!1;const n=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(n)&&this._index.isGeometryVisible(e.index)&&(i=!0),this._layerView.isNodeLoaded(e.index)?(s=!1,!1):e.childrenLoaded>0}),s&&i}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}static cleanupI3SLodHandling(){i.prune()}}});