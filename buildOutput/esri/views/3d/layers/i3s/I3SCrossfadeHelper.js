// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/maybe","../../../../core/scheduling"],function(e,s,d){"use strict";e.I3SCrossfadeHelper=class{constructor(e){this._view=e,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}destroy(){this._preRenderFrameTaskHandle?.remove(),this._preRenderFrameTaskHandle=null,this._view=null}get updating(){return this._numFadingNodes>0}stopNodeFading(e){null!=e.lodCrossfadeProgress&&(this._numFadingNodes--,e.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=s.removeMaybe(this._preRenderFrameTaskHandle)),this._view.notifyLODUpdate(),this._view.notifyUpdate()))}_startNodeFading(e,s,o){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=d.addFrameTask({preRender:e=>this._updateAllNodeFading(e)}),this._view.notifyLODUpdate()),null==e.lodCrossfadeProgress&&(this._numFadingNodes++,this._view.notifyUpdate()),e.lodCrossfadeSignedDuration=o,e.lodCrossfadeProgress=s}_updateAllNodeFading(e){const s=this._view.nodeCrossfadingEnabled;this._view.foreachCrossfadeNode((d,o)=>{if(null!=d?.lodCrossfadeProgress){const t=d.lodCrossfadeSignedDuration,i=t>0?this._view.fullOpacity:0,a=e.deltaTime/t,r=d.lodCrossfadeProgress+Math.abs(a),n=!s||r>=1||0===t,l=i-(n?0:t>0?1:-1)*(1-r);n?(this.stopNodeFading(d),t<0&&this._view.markNodeToRemove(o)):d.lodCrossfadeProgress=r,this._view.setNodeOpacityByIndex(o,l)}}),this._view.removeMarkedNodes()}stopAllNodeFading(){this._view.foreachCrossfadeNode((e,s)=>{if(null!=e?.lodCrossfadeProgress){this.stopNodeFading(e);const d=e.lodCrossfadeSignedDuration;d<0&&this._view.markNodeToRemove(s);const o=d>0?this._view.fullOpacity:0;this._view.setNodeOpacityByIndex(s,o)}}),this._view.removeMarkedNodes()}fadeNode(e,s,d,o){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const t=this._view,i=t.nodeCrossfadingEnabled,a=0===d?t.fullOpacity:0,r=i?o?0===d?t.lodCrossfadeinDuration:t.lodCrossfadeoutDuration:t.lodCrossfadeUncoveredDuration:0,n=this._view.getNodeOpacityByIndex(e);if(i&&n!==a&&r>0){const e=1-Math.abs(a-n);this._startNodeFading(s,e,function(e){return 0===e?1:-1}(d)*r)}else this.stopNodeFading(s),this._view.setNodeOpacityByIndex(e,a),1===d&&this._view.removeNode(e)}isNodeFullyFadedIn(e){const s=this._view.getNodeCrossfadeMetaData(e);return null==s||null==s.lodCrossfadeProgress&&this._view.getNodeOpacityByIndex(e)===this._view.fullOpacity}},e.NodeCrossfadeMetaData=class{constructor(){this.lodCrossfadeSignedDuration=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});