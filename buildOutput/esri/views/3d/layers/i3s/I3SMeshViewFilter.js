// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybeUpdating","../../../../core/reactiveUtils","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/sql/WhereClause","../../../../geometry/ellipsoidUtils","../../../../geometry/projectionUtils","../../../../geometry/SpatialReference","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/projection/projectVectorToVector","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/DoubleArray","../../../../geometry/support/Ellipsoid","../../../../geometry/support/spatialReferenceUtils","../../../../chunks/sphere","../../../../geometry/support/webMercatorUtils","../../../../layers/support/FeatureFilter","./I3SUtil"],function(e,t,r,i,n,s,o,a,l,c,p,u,d,g,h,y,f,m,w,_,S,F,b,M,v,R,I,j,V,k){"use strict";t.I3SMeshViewFilter=class extends i{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){l.whenOnce(()=>this.viewFilter?.geometry||null!=this.layerFilter).then(()=>this.loadAsyncModule(new Promise((t,r)=>e(["../../../../geometry/geometryEngine"],t,r)).then(e=>{this.destroyed||(this._geometryEngine=e)})))}get sortedObjectIds(){if(null==this.viewFilter?.objectIds)return null;const e=M.doubleArrayFrom(this.viewFilter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=this.viewFilter?.where;if(null==e||!e)return null;try{return y.create(e,{fieldsIndex:this.layerFieldsIndex})}catch(e){s.getLogger(this).error(`Failed to parse filter where clause: ${e}`)}return null}addFilters(e,t,r,i){const n=this.sortedObjectIds;null!=n&&e.push(e=>k.objectIdFilter(n,!0,e)),this.addSqlFilter(e,this.parsedWhereClause),this.addTimeFilter(e,this.viewFilter?.timeExtent);const o=a.unwrapUpdating(this._layerMaskGeometries),l=this._geometryEngine,c=()=>s.getLogger(this);if(null!=o&&null!=this.layerFilter&&null!=l){const n=this.layerFilter.spatialRelationship;e.push((e,s)=>x(c,l,e,s,i,t,r,o,n))}const p=a.unwrapUpdating(this._viewMaskGeometries);if(null!=p&&null!=this.viewFilter&&null!=l){const n=this.viewFilter.spatialRelationship;e.push((e,s)=>x(c,l,e,s,i,t,r,p,n))}}isMBSGeometryVisible(e,t,r){const i=a.unwrapUpdating(this._layerMaskGeometries),n=this._geometryEngine;if(null!=i&&null!=this.layerFilter&&null!=n){const o=this.layerFilter.spatialRelationship,a=i[0].spatialReference||t;return _.projectBoundingSphere(e,r,O,a)?U(n,O,i,a,o):(s.getLogger(this).warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}const o=a.unwrapUpdating(this._viewMaskGeometries);if(null!=o&&null!=this.viewFilter&&null!=n){const i=this.viewFilter.spatialRelationship,a=o[0].spatialReference||t;return _.projectBoundingSphere(e,r,O,a)?U(n,O,o,a,i):(s.getLogger(this).warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}get parsedGeometry(){const e=a.unwrapUpdating(this._viewMaskGeometries),t=a.unwrapUpdating(this._layerMaskGeometries);return null==e||null==t?e||t:t.concat(e)}get _layerMaskGeometries(){const e=this.layerFilter;return null==e?null:null==this._geometryEngine?a.updating:"disjoint"===e.spatialRelationship?e.geometries.map(e=>({type:"polygon",rings:e.rings,spatialReference:e.spatialReference,cache:{}})):[e.geometries.reduce((e,t)=>(e.rings=[...e.rings,...t.rings],e),{type:"polygon",rings:[],spatialReference:e.geometries[0].spatialReference,cache:{}})]}get _viewMaskGeometries(){if(null==this.viewFilter)return null;const{geometry:e}=this.viewFilter;if(null==e)return null;if(null==this.viewFilter||null==this._geometryEngine)return a.updating;const{distance:t,units:r}=this.viewFilter,i=this.viewFilter.spatialRelationship,n="mesh"===e.type?e.extent:e;if(null==t||0===t)return G(this._geometryEngine,n,i);const o=r||c.getUnitString(n.spatialReference);if(n.spatialReference.isWGS84){const e=this._geometryEngine.geodesicBuffer(n,t,o);return G(this._geometryEngine,e,i)}const l=j.project(n,w.WGS84);if(null!=l){const e=j.project(this._geometryEngine.geodesicBuffer(l,t,o),n.spatialReference);return G(this._geometryEngine,e,i)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(m.load().then(()=>this._projectionEngineLoaded=!0)),!this._projectionEngineLoaded))return null;let p=null;try{p=m.project(n,w.WGS84)}catch(e){}if(p)try{p=m.project(this._geometryEngine.geodesicBuffer(p,t,o),n.spatialReference)}catch(e){p=null}return p||s.getLogger(this).error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${n.spatialReference.wkid}) to WGS84.`),G(this._geometryEngine,p,i)}get updating(){return a.isUpdating(this._layerMaskGeometries)||a.isUpdating(this._viewMaskGeometries)}static checkSupport(e){return!(null==e||(null==(t=e.spatialRelationship)||!E.includes(t))&&(s.getLogger(this.prototype).warn(`Filters with spatialRelationship other than ${E.join(", ")} are not supported for mesh scene layers`),1));var t}},r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"layerFilter",void 0),r.__decorate([p.property({type:V})],t.I3SMeshViewFilter.prototype,"viewFilter",void 0),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"addSqlFilter",void 0),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"addTimeFilter",void 0),r.__decorate([p.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"sortedObjectIds",null),r.__decorate([p.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedWhereClause",null),r.__decorate([p.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedGeometry",null),r.__decorate([p.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_layerMaskGeometries",null),r.__decorate([p.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_viewMaskGeometries",null),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"updating",null),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"_geometryEngine",void 0),t.I3SMeshViewFilter=r.__decorate([d.subclass("esri.views.3d.layers.i3s.I3SMeshViewFilter")],t.I3SMeshViewFilter);const E=["contains","intersects","disjoint"];function G(e,t,r){if(null==t)return null;if("disjoint"===r&&"polygon"===t.type){const r=t.rings.length,i=t.spatialReference,s=new Array(r);for(let e=0;e<r;++e){const r=b.fromValues(1/0,1/0,-1/0,-1/0);b.expandWithNestedArray(r,t.rings[e]),s[e]={type:"polygon",rings:[t.rings[e]],spatialReference:i,cache:{},aabr:r}}s.sort((e,t)=>e.aabr[0]-t.aabr[0]);const o=new Set,a=new n.PositionHint;for(let t=0;t<s.length;++t){const r=s[t],i=r.aabr[0];o.forEach(t=>{if(i>=t.aabr[2])return void o.delete(t);if(r.aabr[1]>t.aabr[3]||r.aabr[3]<t.aabr[1]||!e.intersects(r,t))return;r.rings=r.rings.concat(t.rings),b.expand(r.aabr,t.aabr,r.aabr),r.cache={},o.delete(t);const l=n.indexOf(s,t,s.length,a);s.splice(l,1)}),o.add(r)}for(const e of s)e.aabr=void 0;return s}return[t]}function U(e,t,r,i,n){if(t[3]>=.5*(t[2]+f.getReferenceEllipsoid(i).radius))return!0;const s=L(e,t,i);return r.every(t=>1!==B(e,t,s,n))}function x(e,t,r,i,n,s,o,a,l){const c=a[0].spatialReference||s.spatialReference;if(!_.projectBoundingSphere(i.node.serviceMbsInIndexSR,o,O,c))return void e().warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const p=L(t,O,c),u=function(e,t,r,i,n){const s=t.renderSpatialReference,o=new Map,a={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],spatialReference:r};let l,c;switch(a.rings[0][3]=a.rings[0][0],e){case"intersects":l=(e,t,r)=>e.intersects(t,r)?0:2,c=T;break;case"contains":l=(e,t,r)=>e.contains(t,r)?2:1,c=T;break;default:l=(e,t,r)=>e.disjoint(t,r)?2:1,c=W}return{collection:i,object:n,type:e,maskSR:r,renderSR:s,aabbCache:o,triangle:a,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:l,geometryTest:c}}(l,s,c,n,i.objectHandle),d="intersects"===l;let g=null;for(const e of a){if(0===r.length)return;switch(B(t,e,p,l)){case 1:return d&&(i.weaklyRemovedIds=i.weaklyRemovedIds?.concat(r)??r.slice()),void(r.length=0);case 0:continue}k.filterInPlace(r,i.featureIds,r=>!!A(t,e,r,u)||(d&&(g||=[],g.push(i.featureIds[r])),!1))}g&&(i.weaklyRemovedIds=i.weaklyRemovedIds?.concat(g)??g)}const O=I.fromValues(0,0,0,0);function L(e,t,r){const i={type:"point",x:t[0],y:t[1],hasZ:!1,hasM:!1,spatialReference:r},n=!R.isWGS84(r)&&!R.isWebMercator(r),s=Number.isNaN(t[3])?0:o.clamp(t[3],0,2*v.earth.radius),a=n?e.buffer(i,s,1):e.geodesicBuffer(i,s,1);return a.type="polygon",a}function B(e,t,r,i){switch(i){case"intersects":case"contains":return T(e,t,r);case"disjoint":return W(e,t,r)}}function T(e,t,r){return e.intersects(t,r)?e.contains(t,r)?0:2:1}function W(e,t,r){return e.intersects(t,r)?e.contains(t,r)?1:2:0}function A(e,t,r,i){const{collection:n,object:s,renderSR:o,maskSR:a,geometryTest:l,aabbCache:c}=i;let p=c.get(r);if(!p){const e=n.getObjectTransform(s);n.getComponentAabb(s,r,C);const t=[h.fromValues(C[0],C[1],0),h.fromValues(C[0],C[4],0),h.fromValues(C[3],C[4],0),h.fromValues(C[3],C[1],0)];for(let r=0;r<4;++r)g.transformMat3(t[r],t[r],e.rotationScale),g.add(t[r],t[r],e.position),S.projectVectorToVector(t[r],o,t[r],a);p={type:"polygon",rings:[t],spatialReference:a,cache:{}},p.rings[0][4]=p.rings[0][0],c.set(r,p)}switch(l(e,t,p)){case 1:return!1;case 0:return!0}const{triangle:u,triangleTest:d,positions:y}=i,f=u.rings[0][0],m=u.rings[0][1],w=u.rings[0][2],_=n.getObjectTransform(s);n.getComponentPositions(s,r,y);const{indices:F,data:b,stride:M,startIndex:v,endIndex:R}=y;for(let r=v;r<R;r+=3){const i=M*F[r],n=M*F[r+1],s=M*F[r+2];switch(g.set(f,b[i],b[i+1],b[i+2]),g.set(m,b[n],b[n+1],b[n+2]),g.set(w,b[s],b[s+1],b[s+2]),g.transformMat3(f,f,_.rotationScale),g.transformMat3(m,m,_.rotationScale),g.transformMat3(w,w,_.rotationScale),g.add(f,f,_.position),g.add(m,m,_.position),g.add(w,w,_.position),S.projectVectorToVector(f,o,f,a),S.projectVectorToVector(m,o,m,a),S.projectVectorToVector(w,o,w,a),d(e,t,u)){case 1:return!1;case 0:return!0}}return"intersects"!==i.type}const C=F.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});