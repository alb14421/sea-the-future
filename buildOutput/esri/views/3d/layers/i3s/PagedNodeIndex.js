// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../geometry/spatialReferenceEllipsoidUtils","../../../../geometry/support/aaBoundingBox"],function(e,t,s){"use strict";function n(e,t){return e/t|0}function i(e,t){return e%t}e.PagedNodeIndex=class{constructor(e,s,n){this._pages=[],this.pageSize=0,this._nodeSR=e,this._renderSR=s,this._renderSRSphericalPCPF=t.getSphericalPCPF(s),this.pageSize=n}addPage(e,t,s=0){for(;this._pages.length<e;)this._pages.push(null);!function(e,t,s,n,i){for(let o=0;o<e.length;o++){const r=e[o];r.obb.transform(r.obbInRenderSR,t,s,n,i)}}(t,this._nodeSR,this._renderSR,s,this._renderSRSphericalPCPF),this._pages[e]={nodes:t,parents:new Uint32Array(this.pageSize)},function(e,t){const s=[0];for(;s.length;){const o=s.pop(),r=e[n(o,t)].nodes[i(o,t)];for(let a=0;a<r.childCount;a++){const p=r.firstChild+a;null!=e[n(p,t)]&&(e[n(p,t)].parents[i(p,t)]=o,s.push(p))}}}(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const t=this.pageSize;return this._pages[n(e,t)].nodes[i(e,t)]}getRenderObb(e){const t=this.pageSize;return this._pages[n(e,t)].nodes[i(e,t)].obbInRenderSR}setRenderObb(e,t){const s=this.pageSize;this._pages[n(e,s)].nodes[i(e,s)].obbInRenderSR.copy(t)}getParentId(e){const t=this.pageSize;return this._pages[n(e,t)].parents[i(e,t)]}hasNodes(e,t){const s=n(e,this.pageSize),i=n(e+t-1,this.pageSize);for(let e=s;e<=i;e++)if(null==this._pages[e])return!1;return!0}forEachNodeId(e){for(let t=0;t<this._pages.length;t++){const s=this._pages[t];if(s)for(let n=0;n<s.nodes.length;n++)e(t*this.pageSize+n)}}createVisibilityTraverse(){const e={index:this,queue:[],masks:[],tempAabb:s.create()};return(t,i)=>function(e,t,i){const o=e.index;if(!o.hasNodes(0,1))return;const r=e.queue;r.length=0,r.push(0);const a=e.masks;for(a.length=0,a.push(0);r.length>0;){const p=r.pop();let h=a.pop();const g=o.getNode(p),c=o.getRenderObb(p);let l=!0;if(null!=t.clippingBox){const n=1<<t.frustum.length;0===(h&n)&&(c.toAaBoundingBox(e.tempAabb),s.contains(t.clippingBox,e.tempAabb)?h|=n:s.intersects(t.clippingBox,e.tempAabb)||(l=!1))}for(let e=0;e<t.frustum.length&&l;e++){const s=1<<e;if(0===(h&s)){const n=c.intersectPlane(t.frustum[e]);n>0?l=!1:n<0&&(h|=s)}}if(i.predicate(p,g,l)){const e=g.firstChild,t=g.childCount;let s=!1;const c=n(e,o.pageSize),l=n(e+t-1,o.pageSize);for(let e=c;e<=l;e++)if(!o.hasPage(e)){i.pageMiss(p,e),s=!0;break}if(!s)for(let s=0;s<t;s++)r.push(e+s),a.push(h)}}}(e,t,i)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});