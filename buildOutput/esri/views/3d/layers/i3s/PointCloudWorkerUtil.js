// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/has","../../../../renderers/PointCloudClassBreaksRenderer","../../../../renderers/PointCloudStretchRenderer","../../../../renderers/PointCloudUniqueValueRenderer","./I3SBinaryReader","./LEPCC"],function(e,r,o,t,n,l,i){"use strict";function s(e,r){const o=new Float64Array(r);for(let t=0;t<r;t++)o[t]=e[3*t+2];return o}function a(e){switch(e){default:case null:case"none":return e=>e;case"low-four-bit":return e=>15&e;case"high-four-bit":return e=>(240&e)>>4;case"absolute-value":return e=>Math.abs(e);case"modulo-ten":return e=>e%10}}function u(e){let r=0;for(const o of e||[])r|=1<<o;return r}e.elevationFromPositions=s,e.evaluateRenderer=function(e,r,l,i){const{rendererJSON:s,isRGBRenderer:u}=e;let c=null,f=null;if(r&&u)c=r;else if(r&&"pointCloudUniqueValueRenderer"===s?.type){f=n.fromJSON(s);const e=f.colorUniqueValueInfos;c=new Uint8Array(3*i);const o=a(f.fieldTransformType);for(let t=0;t<i;t++){const n=(o?o(r[t]):r[t])+"";for(let r=0;r<e.length;r++)if(e[r].values.includes(n)){c[3*t]=e[r].color.r,c[3*t+1]=e[r].color.g,c[3*t+2]=e[r].color.b;break}}}else if(r&&"pointCloudStretchRenderer"===s?.type){f=t.fromJSON(s);const e=f.stops;c=new Uint8Array(3*i);const o=a(f.fieldTransformType);for(let t=0;t<i;t++){const n=o?o(r[t]):r[t],l=e.length-1;if(n<e[0].value)c[3*t]=e[0].color.r,c[3*t+1]=e[0].color.g,c[3*t+2]=e[0].color.b;else if(n>=e[l].value)c[3*t]=e[l].color.r,c[3*t+1]=e[l].color.g,c[3*t+2]=e[l].color.b;else for(let r=1;r<e.length;r++)if(n<e[r].value){const o=(n-e[r-1].value)/(e[r].value-e[r-1].value);c[3*t]=e[r].color.r*o+e[r-1].color.r*(1-o),c[3*t+1]=e[r].color.g*o+e[r-1].color.g*(1-o),c[3*t+2]=e[r].color.b*o+e[r-1].color.b*(1-o);break}}}else if(r&&"pointCloudClassBreaksRenderer"===s?.type){f=o.fromJSON(s);const e=f.colorClassBreakInfos;c=new Uint8Array(3*i);const t=a(f.fieldTransformType);for(let o=0;o<i;o++){const n=t?t(r[o]):r[o];for(let r=0;r<e.length;r++)if(n>=e[r].minValue&&n<=e[r].maxValue){c[3*o]=e[r].color.r,c[3*o+1]=e[r].color.g,c[3*o+2]=e[r].color.b;break}}}else c=new Uint8Array(3*i).fill(255);if(l&&f?.colorModulation){const e=f.colorModulation.minValue,r=f.colorModulation.maxValue,o=.3;for(let t=0;t<i;t++){const n=l[t],i=n>=r?1:n<=e?o:o+(1-o)*(n-e)/(r-e);c[3*t]=i*c[3*t],c[3*t+1]=i*c[3*t+1],c[3*t+2]=i*c[3*t+2]}}return c},e.filterInPlace=function(e,r,o,t,n){const l=e.length/3;let i=0;for(let s=0;s<l;s++){let l=!0;for(let e=0;e<t.length&&l;e++){const{filterJSON:r}=t[e],o=n[e].values[s];switch(r.type){case"pointCloudValueFilter":{const e="exclude"===r.mode;r.values.includes(o)===e&&(l=!1);break}case"pointCloudBitfieldFilter":{const e=u(r.requiredSetBits),t=u(r.requiredClearBits);(o&e)===e&&0===(o&t)||(l=!1);break}case"pointCloudReturnFilter":{const e=15&o,t=o>>>4&15,n=t>1,i=1===e,s=e===t;let a=!1;for(const e of r.includedReturns)if("last"===e&&s||"firstOfMany"===e&&i&&n||"lastOfMany"===e&&s&&n||"single"===e&&!n){a=!0;break}a||(l=!1);break}}}l&&(o[i]=s,e[3*i]=e[3*s],e[3*i+1]=e[3*s+1],e[3*i+2]=e[3*s+2],r[3*i]=r[3*s],r[3*i+1]=r[3*s+1],r[3*i+2]=r[3*s+2],i++)}return i},e.getAttributeValues=function(e,r,o){return e?.attributeInfo.useElevation?r?s(r,o):null:e?.attributeInfo.storageInfo?l.readBinaryAttribute(e.attributeInfo.storageInfo,e.buffer,o,!0):null},e.readGeometry=function(e,r){if(null==e.encoding||""===e.encoding){const o=l.createGeometryIndexFromSchema(r,e);if(null==o.vertexAttributes.position)return;const t=l.createTypedView(r,o.vertexAttributes.position),n=o.header.fields,i=[n.offsetX,n.offsetY,n.offsetZ],s=[n.scaleX,n.scaleY,n.scaleZ],a=t.length/3,u=new Float64Array(3*a);for(let e=0;e<a;e++)u[3*e]=t[3*e]*s[0]+i[0],u[3*e+1]=t[3*e+1]*s[1]+i[1],u[3*e+2]=t[3*e+2]*s[2]+i[2];return u}if("lepcc-xyz"===e.encoding)return i.decodeXYZ(r).result},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});