// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../layers/LayerConstants","../../../../layers/graphics/data/QueryEngine","../../../../layers/support/FieldsIndex","../../../../rest/support/FeatureSet","../../../../rest/support/Query"],function(e,r,t,n,s,a,i,u,o,y,c,l,d,p,Q,g){"use strict";const h=d.QueryEngine;r.I3SQueryEngine=class extends n{constructor(e){super(e)}initialize(){this.addHandles(this.layerView.on("visible-geometry-changed",()=>this.spatialIndex.events.emit("changed")))}destroy(){this._dataQueryEngineInstance=s.destroyMaybe(this._dataQueryEngineInstance),this._set("layerView",null)}get spatialReference(){return this.layerView.view.spatialReference}get layer(){return this.layerView.i3slayer}get defaultQueryJSON(){return new g({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}async executeQueryForCount(e,r){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),r)}async executeQueryForExtent(e,r){const{count:t,extent:n}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),r);return{count:t,extent:c.fromJSON(n)}}async executeQueryForIds(e,r){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),r)}async executeQuery(r,t){const n=this._ensureQueryJSON(r),s=await this._dataQueryEngine.executeQuery(n,t);if(r?.returnGeometry){const{processQueryGeometries:r}=await new Promise((r,t)=>e(["./I3SQueryResultGeometry"],r,t));return r(this.layerView,s)}return Q.fromJSON(s)}_ensureQueryJSON(e){return null==e?this.defaultQueryJSON:e.toJSON()}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||l.fallbackObjectIDAttribute,r=this.layer.fieldsIndex?.toJSON()||new p([]),t=this.layerView.view.resourceController.scheduler,n=this.spatialReference.toJSON(),s=this.priority,a=this.spatialIndex;return this._dataQueryEngineInstance=new h({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fieldsIndex:r,timeInfo:null,spatialReference:n,featureIdInfo:{type:"object-id",fieldName:e},featureStore:a,scheduler:t,priority:s}),this._dataQueryEngineInstance}},t.__decorate([a.property({constructOnly:!0})],r.I3SQueryEngine.prototype,"layerView",void 0),t.__decorate([a.property({constructOnly:!0})],r.I3SQueryEngine.prototype,"priority",void 0),t.__decorate([a.property({constructOnly:!0})],r.I3SQueryEngine.prototype,"spatialIndex",void 0),t.__decorate([a.property()],r.I3SQueryEngine.prototype,"spatialReference",null),t.__decorate([a.property()],r.I3SQueryEngine.prototype,"layer",null),t.__decorate([a.property()],r.I3SQueryEngine.prototype,"defaultQueryJSON",null),r.I3SQueryEngine=t.__decorate([y.subclass("esri.views.3d.layers.i3s.I3SQueryEngine")],r.I3SQueryEngine),Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});