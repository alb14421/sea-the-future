// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Evented","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/support/aaBoundingRect","../../../../chunks/sphere","../../support/ElevationRange","../../support/ElevationUpdateEvent","../../webgl-engine/lib/Intersector"],function(e,t,r,n,o,i,s,a,l,c,p,u,d,v,h,m,E,g){"use strict";e.LayerElevationProvider=class extends r.EventedAccessor{constructor(e){super(e),this._tmpEvent=new E.ElevationUpdateEvent,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=new g.Intersector(this.view.state.viewingMode),this._intersector.options.store=0,this._intersector.options.normalRequired=!1,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,t,r,o){const i=this._renderCoordsHelper,s=p.set(f,e,t,r);if(!i.toRenderCoords(s,o,s))return n.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:a,_intersector:l,intersectionHandler:c}=this,u=a.fullExtent,d=null!=u&&Number.isFinite(u.xmin)&&Number.isFinite(u.xmax)&&Number.isFinite(u.ymin)&&Number.isFinite(u.ymax)&&Number.isFinite(u.zmin)&&Number.isFinite(u.zmax)?new m.ElevationRange(u.zmin,u.zmax):a.elevationRange;if(null==d)return null;const v=a.elevationOffset,h=d.elevationRangeMin+v,E=d.elevationRangeMax+v,g=i.setAltitude(x,E,s),y=i.setAltitude(R,h,s);return l.reset(g,y,this.view.state.camera),c.intersect(l,null,g,y,null,!0),l.results.min.getIntersectionPoint(s)?i.getAltitude(s):null}getSphereElevationBounds(e,t){return d.projectBoundingSphere(e,t,_,this._renderSR),this._layerElevationSource.getElevationRange(_)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new m.ElevationRange(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){v.empty(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){v.empty(t);for(const r of e)this._expandExtent(r,t)}_expandExtent(e,t){const r=this.spatialReference;if(null==r)return;if(null==e)return;l.fromQuat(y,e.quaternion),y[12]=e.center[0],y[13]=e.center[1],y[14]=e.center[2];const n=e.halfSize;for(let e=0;e<8;++e)f[0]=1&e?n[0]:-n[0],f[1]=2&e?n[1]:-n[1],f[2]=4&e?n[2]:-n[2],p.transformMat4(f,f,y),this._renderCoordsHelper.fromRenderCoords(f,f,r),v.expand(t,f,t)}},t.__decorate([o.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"layerElevationSource",void 0),t.__decorate([o.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"intersectionHandler",void 0),t.__decorate([o.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"view",void 0),t.__decorate([o.property()],e.LayerElevationProvider.prototype,"spatialReference",null),e.LayerElevationProvider=t.__decorate([a.subclass("esri.views.3d.layers.i3s.LayerElevationProvider")],e.LayerElevationProvider);const y=c.create(),_=h.fromValues(0,0,0,0),f=u.create(),x=u.create(),R=u.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});