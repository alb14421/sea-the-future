// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","./I3SUtil","./Intersector","../../webgl-engine/lib/IntersectorResult","../../webgl-engine/lib/RayIntersections","../../webgl-engine/lib/verticalOffsetUtils"],function(e,t,n,i,s,r){"use strict";e.I3SIntersectionHandler=class{constructor(e){this.type=4,this._needVerticalOffset=!1,this.layerViewUid=e.layerViewUid,this.sublayerId=e.sublayerId,this._collection=e.collection,this._traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}updateElevationAlignState(e,t){this._needVerticalOffset=e&&1===t}intersect(e,l,c,o,a,d){const u=e.results,b=2===e.options.store,h=e.ray.direction,y=e.tolerance;let f=e=>e,I=e=>e;const R=r.getVerticalOffsetI3S(e.verticalOffset??(this._needVerticalOffset?0:null));null!=e.verticalOffset&&null!=R&&(f=e=>R.applyToMbs(e),I=e=>R.applyToObb(e));const g=new s.MeshIntersectionOptions(d,e.options.normalRequired);this._traverseNodeHierarchy((s,r)=>{if(0===s.childrenLoaded)return!1;const a=s.serviceObbInRenderSR?.isValid?s.serviceObbInRenderSR:null;return!(a&&!I(a).intersectRay(c,h,y)||(!r||!a&&t.isValidMbs(s.serviceMbsInRenderSR)&&!function(e,t,n,i=0){const s=e[3]+i,r=t[0]-e[0],l=t[1]-e[1],c=t[2]-e[2],o=n[0],a=n[1],d=n[2],u=o*r+a*l+d*c;return u*u-(o*o+a*a+d*d)*(r*r+l*l+c*c-s*s)>=0}(f(s.serviceMbsInRenderSR),c,h,y)||null!=s.geometryObbInRenderSR&&!I(s.geometryObbInRenderSR).intersectRay(c,h,y)||this._collection.intersect(r,c,o,y,R,g,(t,r,a,d)=>{if(r<0||null!=l&&!l(c,o,r))return;const h=e=>{const i=new n.I3sTarget(this.layerViewUid,this.sublayerId,s.index,t,d);e.set(this.type,i,r,a)};if(this.isGround&&(null==u.ground.distance||r<u.ground.distance)&&h(u.ground),!e.options.isFiltered&&((null==u.min.distance||r<u.min.distance)&&h(u.min),(null==u.max.distance||r>u.max.distance)&&h(u.max),b)){const t=new i.IntersectorResult(e.ray);h(t),e.results.all.push(t)}}),0))})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});