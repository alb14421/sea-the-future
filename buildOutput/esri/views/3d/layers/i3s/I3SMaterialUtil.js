// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/colorUtils","../../../../core/has","../../../../core/mathUtils","./enums","../../webgl-engine/core/material/RenderTexture","../../webgl-engine/core/shaderLibrary/util/EllipsoidMode","../../webgl-engine/lib/Texture","../../webgl-engine/materials/pbrUtils","../../../../webscene/support/AlphaCutoff"],function(e,a,r,t,o,s,n,l,i,u){"use strict";function c(e){return e.sort((e,a)=>e.encoding-a.encoding)}const d={ktx2:1,basis:2,dds:4,png:8,jpg:16,"ktx-etc2":32},m={"image/ktx2":2,"image/x.basis":2,"image/vnd-ms.dds":4,"image/png":8,"image/jpg":16,"image/jpeg":16,"image/ktx":32},g=()=>({alphaMode:"opaque",alphaCutoff:u.alphaCutoff,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}),p={s:33071,t:33071},x={s:10497,t:10497};e.configureMaterial=function(e,r,t,o,l,c){const d=c.rendererTextureUsage,m=e=>function(e,a,r){if(null==e||0===r)return null;for(let t=0;t<e.length;t++){const o=e[t];if(null!=o&&0!==(o.usage&r)){const e=a[t];return null!=e?e.id:null}}return null}(o,t,e&d),g=a.validateColorAndOpacity(r.metallicRoughness.baseColorFactor);e.baseColor=[g[0],g[1],g[2],g[3]],e.hasParametersFromSource=!!r.hasParametersFromSource,e.usePBR=c.usePBR,e.mrrFactors=[r.metallicRoughness.metallicFactor,r.metallicRoughness.roughnessFactor,r.hasParametersFromSource?i.schematicMRRFactors[2]:i.advancedMRRFactors[2]],e.emissiveBaseColor=r.emissiveFactor,e.isIntegratedMesh=c.isIntegratedMesh,e.textureAlphaCutoff="mask"===r.alphaMode?r.alphaCutoff:u.alphaCutoff,e.alphaDiscardMode="opaque"===r.alphaMode?1:"mask"===r.alphaMode?2:3;const p=[],x=m(33);null!=x&&(e.baseColorTexture=new s.RenderTexture(l,x),p.push(e.baseColorTexture.loadPromise));const h=m(2);null!=h&&(e.metallicRoughnessTexture=new s.RenderTexture(l,h),p.push(e.metallicRoughnessTexture.loadPromise));const f=m(16);null!=f&&(e.emissionTexture=new s.RenderTexture(l,f),p.push(e.emissionTexture.loadPromise));const T=m(8);null!=T&&(e.occlusionTexture=new s.RenderTexture(l,T),p.push(e.occlusionTexture.loadPromise));const F=m(4);return null!=F&&(e.normalTexture=new s.RenderTexture(l,F),p.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.hasSlicePlane=c.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=r.doubleSided,e.commonMaterialParameters.cullFace=r.cullFace,e.ellipsoidMode=n.getEllipsoidMode(c.viewSpatialReference),Promise.all(p)},e.createTexture=function(e,a,t,s,n,i){if(null==e?.data)return null;const u=e.data,c=s.renderingContext.parameters.maxMaxAnisotropy,d=c>1,m=t||!a.wrapTextures?p:x,g=function(e){switch(e){case 1:return"image/ktx2";case 2:return"image/x.basis";case 4:return"image/vnd-ms.dds";case 8:return"image/png";case 16:return"image/jpeg";case 32:return"image/ktx";default:return""}}(e.encoding),h=1&e.usage?"opaque"===a.alphaMode?3:4:3,f=function(e,a){return!(!r("enable-feature:esri-compress-IM-textures")||0===(e&o.uncompressedFormats)||a&~o.compressibleUsages)}(e.encoding,e.usage)?{compressionTracker:n,compressionCallback:i}:void 0;return new l.Texture(u,{mipmap:d,maxAnisotropy:c,encoding:g,wrap:m,components:h,compressionOptions:f,noUnpackFlip:!0})},e.defaultMaterial=g,e.getMaterialAndTextures=function(e,t,o){const s=new Map,n=(e,a)=>{if(null==e)return-1;const r=s.get(e.id);if(r)return r.usage|=a,r.id;const t=s.size;return s.set(e.id,{id:t,usage:a}),t},l=t.pbrMetallicRoughness,u=l?.baseColorFactor?a.validateColorAndOpacity(l.baseColorFactor):null,m=t.emissiveFactor,g=r("disable-feature:diffuse-rendering-i3s")||o?i.useSchematicPBRI3S({normalTexture:t.normalTexture,emissiveTexture:t.emissiveTexture,emissiveFactor:t.emissiveFactor,occlusionTexture:t.occlusionTexture,metallicRoughnessTexture:l?.metallicRoughnessTexture,metallicFactor:l?.metallicFactor,roughnessFactor:l?.roughnessFactor}):i.useSchematicPBR({normalTexture:t.normalTexture,emissiveTexture:t.emissiveTexture,emissiveFactor:t.emissiveFactor,occlusionTexture:t.occlusionTexture,metallicRoughnessTexture:l?.metallicRoughnessTexture,metallicFactor:l?.metallicFactor,roughnessFactor:l?.roughnessFactor}),p=g?i.schematicMRRFactors[0]:l?.metallicFactor??i.advancedMRRFactors[0],x=g?i.schematicMRRFactors[1]:l?.roughnessFactor??i.advancedMRRFactors[1],h="mask"===t.alphaMode?33:1,f={baseColorFactor:u?[u[0],u[1],u[2],u[3]]:[1,1,1,1],baseColorTextureId:n(l?.baseColorTexture,h),metallicRoughnessTextureId:n(l?.metallicRoughnessTexture,2),metallicFactor:p,roughnessFactor:x},T={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?0:"back"===t.cullFace?2:"front"===t.cullFace?1:0,normalTextureId:n(t.normalTexture,4),emissiveTextureId:n(t.emissiveTexture,16),occlusionTextureId:n(t.occlusionTexture,8),emissiveFactor:m?[m[0],m[1],m[2]]:[0,0,0],metallicRoughness:f,wrapTextures:!1,hasParametersFromSource:g},F=[];return s.forEach(({usage:a},r)=>{const t=null!=e&&e[r]&&e[r].formats,o=t?c(t.map(({name:e,format:a})=>({name:e,encoding:d[a]}))):[];F.push({id:r,usage:a,encodings:o})}),{material:T,textures:F}},e.getMaterialAndTexturesFromShared=function(e){const r=e?.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,o=e?.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,s=r?e.materialDefinitions?.[r]:null,n=o?e.textureDefinitions?.[o]:null,l=g();if(null!=s){const e=s.params;e.diffuse&&(a.validateColor(e.diffuse),l.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(l.doubleSided=e.doubleSided,l.cullFace=e.doubleSided?0:2),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(l.cullFace="none"===e.cullFace?0:"back"===e.cullFace?2:1),e.transparency&&(l.metallicRoughness.baseColorFactor[3]=t.clamp(1-e.transparency,0,1)),(e.useVertexColorAlpha||l.metallicRoughness.baseColorFactor[3]<1)&&(l.alphaMode="blend")}const i=[];if(null!=n){const e=0;!n.wrap||"repeat"!==n.wrap[0]&&"repeat"!==n.wrap[1]||(l.wrapTextures=!0);let a=1;"rgba"===n.channels&&(l.alphaMode="blend",a|=32);const r=n.images.length-1,t=n.images[r],o=e=>e?.split("/").pop(),s=Array.isArray(n.encoding)?c(n.encoding.map((e,a)=>({name:o(t.href[a]),encoding:m[e]||0}))):[{name:o(t.href),encoding:m[n.encoding]||0}];i.push({id:e,usage:a,encodings:s}),l.metallicRoughness.baseColorTextureId=e}return{material:l,textures:i}},e.getSupportedEncodings=function(e){const a=!!e.compressedTextureS3TC,t=!!e.compressedTextureETC,o=r("disable-feature:i3s-basis")?0:3;return 24|(a?4|o:0)|(t?o:0)},e.selectEncoding=function(e,a){if(null!=a)return e.find(e=>0!==(e.encoding&a))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});