// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Error","../../../../geometry/Mesh","../../../../geometry/projection/projectBuffer","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/MeshGeoreferencedVertexSpace","../../../../geometry/support/MeshVertexAttributes","../../../../chunks/vec3","../../../../geometry/support/meshUtils/Metadata"],function(e,t,n,r,o,a,s,i,c){"use strict";function l({layerView:e,nodeIndex:t,featureIndex:n},a){const s=e.getAABB(t,n);if(!s)return null;const i=e.view.spatialReference;return i.equals(a)||r.projectBuffer(s,i,0,s,a,0),o.toExtent(s,a)}e.createMesh=function(e){const o=new c.Metadata,d=e.spatialReference??e.layerView.view.spatialReference;return o.externalSources.add({extent:e.extent??l(e,d),source:{type:"loadable",load:n=>async function(e,{layerView:n,nodeIndex:o,featureIndex:a}){const c=n.getNodeComponentHandle(o);if(!c?.intersectionGeometry)throw new t("i3s-layer-view-geometry-missing","Cannot load mesh because scene layer view data is no longer available.");const l={indices:null,data:null,stride:0,startIndex:0,endIndex:0};c.intersectionGeometry.getComponentPositions(a,l);const{indices:d,data:u,stride:p,startIndex:f,endIndex:x}=l,y=new Float64Array(3*(x-f));let m=0;for(let e=f;e<x;e+=3){const t=p*d[e],n=p*d[e+1],r=p*d[e+2];y[m++]=u[t],y[m++]=u[t+1],y[m++]=u[t+2],y[m++]=u[n],y[m++]=u[n+1],y[m++]=u[n+2],y[m++]=u[r],y[m++]=u[r+1],y[m++]=u[r+2]}const g=c.transform;i.transformMat3(y,y,g.rotationScale),i.translate(y,y,g.position),r.projectBuffer(y,n.view.renderSpatialReference,0,y,e.spatialReference,0),e.vertexAttributes=new s.MeshVertexAttributes({position:y})}(n,e)}}),new n({metadata:o,vertexSpace:new a,spatialReference:d})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});