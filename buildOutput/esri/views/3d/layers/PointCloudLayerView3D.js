// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../Graphic","../../../core/arrayUtils","../../../core/asyncUtils","../../../core/has","../../../core/Logger","../../../core/maybe","../../../core/memoryEstimations","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/screenUtils","../../../core/typedArrayUtil","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/Extent","../../../geometry/Point","../../../geometry/projection/projectBoundingSphere","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/plane","../../../chunks/sphere","../../../graphic/PointCloudGraphicOrigin","../../../layers/graphics/OptimizedGeometry","../../../layers/graphics/data/QueryEngine","../../../layers/support/CodedValue","../../../layers/support/CodedValueDomain","../../../layers/support/Domain","../../../layers/support/InheritedDomain","../../../layers/support/RangeDomain","../../../layers/support/fieldUtils","../../../layers/support/PromiseQueue","../../../rest/support/FeatureSet","../../../rest/support/Query","../../../support/elevationInfoUtils","./LayerView3D","./PointCloudLayerViewPerformanceInfo","./PointCloudWorkerHandle","./i3s/I3SQueryFeatureStore","./i3s/I3SUtil","./i3s/LoDUtil","./i3s/PagedNodeIndex","./i3s/PointCloudGraphic","./i3s/PointCloudRenderer","./i3s/PointCloudRendererNode","./i3s/PointCloudRendererUtil","./i3s/PointCloudWorkerUtil","./support/highlightUtils","./support/PopupSceneLayerView","../support/extentUtils","../support/hitTest","../support/orientedBoundingBox","../support/updatingProperties","../../layers/LayerView","../../layers/PointCloudLayerView","../../support/highlightOptionsUtils","../../support/layerViewUtils","../../support/Scheduler"],function(e,t,i,r,o,s,n,a,d,l,u,h,c,p,_,g,y,m,f,b,w,P,N,x,C,v,S,I,A,R,V,k,Q,F,L,M,E,O,D,U,G,W,q,z,H,B,T,$,j,J,K,Z,Y,X,ee,te,ie,re,oe,se){"use strict";const ne=N.create();let ae=class extends(ie.PointCloudLayerView(K.PopupSceneLayerView(O.LayerView3D(te)))){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new F.PromiseQueue,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[],this.ignoresMemoryFactor=!1}get baseUrl(){return this.layer.parsedUrl?.path??""}get pointScale(){const e=$.getSplatSizeAlgorithm(this.layer?.renderer);return null!=e?.scaleFactor?e.scaleFactor:1}get useRealWorldSymbolSizes(){const e=$.getFixedSizeAlgorithm(this.layer?.renderer);return null!=e?.useRealWorldSymbolSizes&&e.useRealWorldSymbolSizes}get pointSize(){const e=$.getFixedSizeAlgorithm(this.layer?.renderer);return null!=e?.size?e.size:0}get inverseDensity(){return this.layer?.renderer?96/this.layer.renderer.pointsPerInch:5}get availableFields(){const e=$.getRendererInfo(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.modulationAttribute.name);const i=$.getFilterInfo(this.layer);if(i)for(const e of i)e.attributeInfo&&t.add(e.attributeInfo.name);if(this.layer.outFields)for(const e of Q.unpackFieldNames(this.layer.fieldsIndex,this.layer.outFields))t.add(e);return Array.from(t)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const e=P.create(),t=this.view.renderSpatialReference;return Z.projectToBoundingBox(this.view.clippingArea,e,t)?e:null}get _elevationOffset(){const e=this.layer&&this.layer.elevationInfo;return e&&"absolute-height"===e.mode?E.getElevationOffset(e,this.layer.spatialReference):0}get _graphicOrigin(){return new C(this.layer)}initialize(){const e=this.view.resourceController,t=function(e){return t=>e.immediate.schedule(t)}(e);this._worker=new U.PointCloudWorkerHandle(t),this.addResolvingPromise(this._worker.promise),W.checkPointCloudLayerValid(this.layer),W.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(2),this._dataRequester=e.createStreamDataRequester(3),this._initRenderer();const i=this._initNodePages(),r=this.view.resourceController.memoryController;this._memCache=r.newCache(`pcl-${this.layer.uid}`),this._queryFeaturesCache=r.newCache(`pcl-query-features-${this.layer.uid};`),this._updatingHandles.add(()=>this._clippingBox,()=>this._setUpdateViewNeeded(),l.initial),this._updatingHandles.add(()=>this._elevationOffset,()=>this._elevationOffsetChanged(),l.initial),this._updatingHandles.add(()=>this.layer.renderer,()=>this._rendererChanged(),l.initial),this._updatingHandles.add(()=>this.layer.filters,()=>this._reload(),l.initial),this._updatingHandles.add(()=>this.layer.outFields,()=>this._reload(),l.initial),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this._setUpdateViewNeeded()),this._updatingHandles.add(()=>this.view.state.contentCamera,()=>this._setUpdateViewNeeded()),this.addHandles([l.watch(()=>this.view.quality,()=>this._setUpdateViewNeeded(),l.sync)]),this.addResolvingPromise(i),this.when(()=>{this.addHandles([e.scheduler.registerTask(se.TaskPriority.POINT_CLOUD_LAYER,this),e.scheduler.registerIdleStateCallbacks(()=>this._idleBegin(),()=>this._idleEnd()),this._updatingHandles.add(()=>this.suspended,e=>{e?this._clearNodeState():this._setUpdateViewNeeded()},l.initial)])},()=>{this._updatingHandles.removeAll(),this.removeAllHandles()})}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker=n.destroyMaybe(this._worker),this._destroyRenderer(),this._memCache=n.destroyMaybe(this._memCache),this._queryFeaturesCache=n.destroyMaybe(this._queryFeaturesCache),this._queryEngine=n.destroyMaybe(this._queryEngine),this._codedDomainPopulationAbortController=n.abortMaybe(this._codedDomainPopulationAbortController),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new B.PointCloudRenderer({createGraphic:(e,t,i)=>this._createGraphic(e,t,i)}),this._renderer.layerViewUid=this.uid,this._updatingHandles.add(()=>this._clippingBox,e=>this._renderer.clippingBox=e,l.initial),this._updatingHandles.add(()=>this.suspended,e=>this._setPointsVisible(!e),l.initial),this._updatingHandles.add(()=>this.pointScale,e=>this._renderer.scaleFactor=e,l.initial),this._renderer.minSizePx=Math.sqrt(2),this._updatingHandles.add(()=>this.useRealWorldSymbolSizes,e=>this._renderer.useRealWorldSymbolSizes=e,l.initial),this._updatingHandles.add(()=>this.pointSize,e=>{const t=u.pt2px(e);this._renderer.size=e,this._renderer.sizePx=t},l.initial),this._updatingHandles.add(()=>this.slicePlaneEnabled,e=>this._renderer.slicePlaneEnabled=e,l.initial),this._updatingHandles.add(()=>this.inverseDensity,()=>this._setUpdateViewNeeded(),l.initial),this._updatingHandles.add(()=>this.maximumPointCount,()=>this._setUpdateViewNeeded(),l.initial),this._updatingHandles.add(()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor,e=>{this._lodFactor=e,this._setUpdateViewNeeded()},l.initial)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(e,t,i,r){const o=null!=e.pointIdFilterMap?e.pointIdFilterMap[t]:t,s=i?"declaredClass"in i?i:Y.computeMapPointFromVec3d(this.view,i):null;return r??=this._createGraphicAttributes(e,o),new H.PointCloudGraphic({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:o,epoch:this._nodeLoadEpoch},geometry:s,attributes:r,layer:this.layer,sourceLayer:this.layer,origin:this._graphicOrigin})}_createGraphicAttributes(e,t){const i={};for(const r of e.attributes)this._encodeGraphicAttribute(r.attributeInfo,r.values,t,i);return i}_getGraphicAttribute(e,t,i){const r=e.storageInfo?.attributeValues,o=r?.valuesPerElement??1;if(1===o)return t[i];if("UInt8"===r?.valueType&&o<=4){let e=0;const r=i*o;for(let i=r;i<r+o;i++)e=(e<<8)+t[i];return e}}_encodeGraphicAttribute(e,t,i,r){r[e.name]=this._getGraphicAttribute(e,t,i)}_setPointsVisible(e){e&&!this._rendererAdded?(this.view.stage.addRenderPlugin(this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view.stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=$.rendererUsesFixedSizes(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_displayNodes(e){this._workQueue=q.nodeDiff([...this._renderedNodes],e,this._index),q.sortFrontToBack(this._workQueue,this.view.state.contentCamera.viewForward,this._index),q.splitWorkEntries(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const e=new Array;this._loadingNodes.forEach(({abortController:t})=>e.push(t)),this._loadingNodes.clear();for(const t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const e=new Set;this._workQueue.forEach(t=>t.load.forEach(t=>e.add(t)));const t=new Array,i=new Map;this._loadingNodes.forEach((r,o)=>{e.has(o)?i.set(o,r):t.push(r)}),this._loadingNodes=i;for(const{abortController:e}of t)e.abort();this._workQueue=this._workQueue.filter(e=>{for(const t of e.load)if(this._loadingNodes.has(t))return this._recalcWork=!0,!1;return!0}),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach(({abortController:e})=>e.abort()),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach(e=>this._removeFromRenderer(e)),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get readyToRun(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.readyToRun}runTask(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run(()=>this._updateWorkQueues());this._indexQueue.length>0&&e.run(()=>this._processIndexQueue()););this._processWorkQueue(e),this._idleQueue.runTask(e)}}_processIndexQueue(){const e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then(t=>{this._index.addPage(e,t,this._elevationOffset),this._setUpdateViewNeeded()}).then(()=>{this._indexPagesLoading.delete(e)},()=>{this._indexPagesLoading.delete(e)}),!0}_processWorkQueue(e){for(;!e.done;){const t=this._scheduleWorkEntry();if(null==t)return void e.madeProgress();this._processWorkEntry(t),e.madeProgress()}}_scheduleWorkEntry(){let e=this._workQueue.length;for(;e--;){const e=this._workQueue.shift();if(!e.remove.find(e=>!this._renderedNodes.has(e)))return e;this._workQueue.push(e)}return null}_processWorkEntry(e){if(0!==e.load.length)Promise.all(e.load.map(e=>{const t=new AbortController,i=this._memCache.pop(e.toString());return null!=i?this._loadingNodes.set(e,{abortController:t,promise:Promise.resolve(i)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:t,promise:this._loadNode(e,t.signal)}),this._loadingNodes.get(e).promise})).then(t=>{for(let i=0;i<e.load.length;i++)if(t[i]){const r=this._setupRendererData(e.load[i],t[i]);this._addToRenderer(r)}for(const t of e.remove)this._removeFromRenderer(t)}).catch(()=>{}).then(()=>{for(const t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&!this._idleQueue.updating&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())}),this._updateLoading();else for(const t of e.remove)this._removeFromRenderer(t)}async _populateClassCodeCodedDomain(e,t){const i="CLASS_CODE",o=this.layer.fieldsIndex.get(i);if(!o||o.domain)return;if(!e.includes(o.name))return;const s=await r.result(this.layer.queryCachedStatistics(i,{signal:t}));if(!1===s.ok)return;const n=s.value?.stats?.labels?.labels;n&&Array.isArray(n)&&(o.domain=new A({name:"CLASS_CODE",codedValues:n.map(e=>new I.CodedValue({code:e.value,name:e.label}))}))}async prepareFetchPopupFeatures(e){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this._populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then(()=>{this._codedDomainPopulationAbortController=null})),this._codedDomainPopulationPromise}async whenGraphicAttributes(e,t){const o=this._splitGraphicsPerNode(e),s=this.layer.attributeStorageInfo,n=t.map(e=>$.getAttributeInfo(s,e)).filter(i.isSome),a=async(e,t)=>{const i=this._index.getNode(t);await r.forEach(n,async t=>{const r=t.useElevation?await this._loadElevationAttributeFromGeometry(i.resourceId):await this._loadAndParseAttribute(i,t);if(r)for(const i of e)if(this._isValidPointGraphic(i)){const e=i.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(t,r,e,i.attributes)}})},d=[];return o.forEach((e,t)=>{d.push(a(e,t))}),await Promise.allSettled(d),e}_isValidPointGraphic(e){return e instanceof H.PointCloudGraphic&&e.pointCloudMetadata?.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(e){const t=new Map;for(const i of e){if(!this._isValidPointGraphic(i))continue;const e=i.pointCloudMetadata,r=t.get(e.nodeId);r?r.push(i):t.set(e.nodeId,[i])}return t}async _loadAndParseAttribute(e,t){const i=await this._loadAttribute(e.resourceId,t,null);return i?j.getAttributeValues({attributeInfo:t,buffer:i},null,e.vertexCount):null}async _loadElevationAttributeFromGeometry(e){const t=this.layer.store.defaultGeometrySchema,i=j.readGeometry(t,await this._loadGeometry(e,null));return j.elevationFromPositions(i,i.length/3)}highlight(e,i){const r=J.normalizeHighlightTarget(e);if(0===r.length)return J.emptyHighlightHandle;if(!(r[0]instanceof t))return J.emptyHighlightHandle;const o=r;return this._renderer.highlight(o.map(e=>this._graphicToPointDefinition(e)),re.getHighlightName(i))}_graphicToPointDefinition(e){if(!this._isValidPointGraphic(e))return null;const{nodeId:t,pointIndexInNode:i}=e.pointCloudMetadata;return null!=t&&null!=i?{nodeId:t,pointId:i}:null}_computeWork(){let e=0;for(const t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}get visibleAtCurrentScale(){return oe.isInEffectiveScaleRange(this.layer.effectiveScaleRange,this.view.scale)}async queryFeatures(e,i){const r=await this._ensureQueryEngine().executeQuery(this._ensureQueryJSON(e),i?.signal),o=r.features;r.features=[];const s=L.fromJSON(r),n=this.view.spatialReference;return s.features=o.map(e=>{const{attributes:i,metadata:r}=e;if(!r){const i=t.fromJSON(e);return i.geometry&&(i.geometry.spatialReference=s.spatialReference??n),i}const o=f.fromJSON(e.geometry);return o.spatialReference=s.spatialReference??n,this._createGraphic(r.node,r.pointId,o,i)}),s}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference,returnZ:!0};return new M(e)}async queryFeatureCount(e,t){return await this._ensureQueryEngine().executeQueryForCount(this._ensureQueryJSON(e),t?.signal)}async queryExtent(e,t){const{count:i,extent:r}=await this._ensureQueryEngine().executeQueryForExtent(this._ensureQueryJSON(e),t?.signal);return{count:i,extent:m.fromJSON(r)}}_ensureQueryJSON(e){return null==e?new M({outSpatialReference:this.view.spatialReference}).toJSON():M.from(e).toJSON()}_ensureQueryEngine(){if(this._queryEngine)return this._queryEngine;const{spatialReference:e}=this.view;return this._queryEngine=new S.QueryEngine({fieldsIndex:this.layer.fieldsIndex.toJSON(),geometryType:"esriGeometryPoint",spatialReference:e,featureIdInfo:{type:"object-id",fieldName:"objectId"},hasZ:!0,featureStore:new G.I3SQueryFeatureStore({sourceSpatialReference:e,viewSpatialReference:e,forAllFeatures:(e,t)=>{let i=!1;this._renderer.forEachNode(r=>{if(i)return;if(t){const e=r.obb,o=x.fromValues(e.center[0],e.center[1],e.center[2],_.length(e.halfSize));b.projectBoundingSphere(o,this.view.renderSpatialReference,o,this.view.spatialReference);const s=t(o);if(2===s)return;if(i=0===s,i)return}let o=this._queryFeaturesCache.get(`${r.id}`);o||(o=this._createQueryPointFeatures(r),this._queryFeaturesCache.put(`${r.id}`,o)),o.features.forEach(e)})},getFeatureExtent:({point:e},t)=>P.fromMinMax(e,e,t),featureAdapter:{cloneWithGeometry:(e,t)=>new le(e.node,e.pointId,t.coords),getAttribute:({node:e,attributePointId:t},i)=>{for(const r of e.attributes)if(r.attributeInfo.name===i)return this._getGraphicAttribute(r.attributeInfo,r.values,t)},getAttributes:({node:e,attributePointId:t})=>this._createGraphicAttributes(e,t),getCentroid:e=>e.getGeometry(),getGeometry:e=>e.getGeometry(),getObjectId:()=>{},getMetadata:e=>e}})}),this._queryEngine}_createQueryPointFeatures(e){const t=e.coordinates,i=new Array;for(let r=0;r<t.length/3;r++){const o=3*r,s=y.fromValues(t[o+0],t[o+1],t[o+2]);_.add(s,s,e.origin),w.projectVectorToVector(s,this.view.renderSpatialReference,s,this.view.spatialReference);const n=new le(e,r,s);i.push(n)}return new ue(i)}_initNodePages(){const e=this.layer.store.index,t=e.nodesPerPage||e.nodePerIndexBlock;return this._index=new z.PagedNodeIndex(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=e.nodesPerPage?1:e.nodePerIndexBlock,this._loadNodePage(0).promise.then(e=>{this._index.addPage(0,e,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()})}_loadNodePage(e){const t=new AbortController,i=`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`;return{promise:this._requestNodePage(i,t.signal).then(t=>t.nodes.map((t,i)=>({resourceId:null!=t.resourceId?t.resourceId:e*this._index.pageSize+i,obb:X.Obb.fromJSON(t.obb),obbInRenderSR:new X.Obb,firstChild:t.firstChild,childCount:t.childCount,vertexCount:t.vertexCount??t.pointCount,lodThreshold:t.lodThreshold??t.effectiveArea}))),abortController:t}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;const e=this.view.quality;let t=this.inverseDensity/this._lodFactor*e;const i=this.maximumPointCount*this._lodFactor*e;let r=this._computeNodesForMinimumDensity(t),o=this._computePointCount(r),s=Math.sqrt(o/(.75*i));for(;o>i;)t*=s,r=this._computeNodesForMinimumDensity(t),o=this._computePointCount(r),s=Math.sqrt(2);return this._displayNodes(r),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(e){let t=0;for(let i=0;i<e.length;i++){const r=this._index.getNode(e[i]);r&&(t+=r.vertexCount)}return t}_isRootNodeVisible(){let e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(t,i,r)=>(e=r,!1),pageMiss:()=>{}}),e}_computeNodesForMinimumDensity(e){const t=this.view.state.contentCamera,i=t.frustum,r=this._clippingBox,o=t.viewForward,s=_.dot(o,t.eye),n=N.fromNormalAndOffset(o,-s,ne),a=t.perScreenPixelRatio/2,d=e*e,l=this._nodeIdArray;l.length=0;const u=e=>l.push(e);return this._traverseVisible({frustum:i,clippingBox:r},{predicate:(e,t,i)=>{if(!i)return!1;if(0===t.childCount)return u(e),!1;const r=this._index.getRenderObb(e);return!(this._computeAveragePixelArea(r,t.lodThreshold,t.vertexCount,n,a)<=d&&(u(e),1))},pageMiss:(e,t)=>{u(e),this._indexQueue.includes(t)||this._indexQueue.push(t)}}),l}_computeAveragePixelArea(e,t,i,r,o){const s=Math.max(1e-7,e.minimumDistancePlane(r));return t/(s*s)/(4*o*o)/i}_loadNode(e,t){try{return this._loadNodeAsync(e,t)}catch(e){throw d.isAbortError(e)||s.getLogger(this).error(e),e}}async _loadAdditionalUserAttributes(e,t,r){const o=this.layer.outFields;if(!o)return[];const s=Q.unpackFieldNames(this.layer.fieldsIndex,o),n=new Set(e.map(e=>null!=e?e.name:null)),a=this.layer.attributeStorageInfo,l=[];for(const e of s){if(n.has(e))continue;const i=$.getAttributeInfo(a,e);i&&l.push(t(i))}const u=await d.allSettledValues(l);return d.throwIfAborted(r),u.filter(i.isSome)}async _loadNodeAsync(e,t){const i=this._index.getNode(e),r=$.getRendererInfo(this.layer),o=$.getFilterInfo(this.layer),s=i.resourceId,n=async e=>{if(!e)return null;if(e.useElevation)return{attributeInfo:e,buffer:null};const i=await this._loadAttribute(s,e,t);return null!=i?{attributeInfo:e,buffer:i}:null};return this._idleQueue.push(async()=>{const i=this._loadGeometry(s,t),{primaryAttribute:a,modulationAttribute:l}=r,u=n(a),h=n(l),c=o.map(e=>e.attributeInfo),p=c.map(e=>n(e)),_=this._loadAdditionalUserAttributes([a,l,...c],n,t),[g,y,m,f,b]=await Promise.all([i,u,h,Promise.all(p),_]);d.throwIfAborted(t);const w={geometryBuffer:g,primaryAttributeData:y,modulationAttributeData:m,filterAttributesData:f,userAttributesData:b,schema:this.layer.store.defaultGeometrySchema,rendererInfo:r,filterInfo:o,obbData:this._index.getRenderObb(e).data,elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(w,t)},t)}async _loadGeometry(e,t){return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`,t)}async _loadAttribute(e,t,i){if(!t?.storageInfo)return null;const r=t.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${r}`,i)}_requestNodePage(e,t){const i={f:"json",...this.layer.customParameters,token:this.layer.apiKey};return this._indexRequester.request(e,0,{query:i,signal:t})}_requestData(e,t){return this._dataRequester.request(e,1,{query:{...this.layer.customParameters,token:this.layer.apiKey},signal:t})}_removeFromRenderer(e){if(this._renderedNodes.has(e)){const t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._memCache.put(t.id.toString(),t)}}_addToRenderer(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))}_setupRendererData(e,t){const i=this._index.getNode(e),r=Math.sqrt(i.lodThreshold/i.vertexCount),o=this._index.getRenderObb(e);if(T.isPointRendererNode(t))return t.splatSize=r,t.obb=o,_.copy(t.origin,t.obb.center),t;const n=X.Obb.fromData(t.obbData),a=n.halfSize,d=o.halfSize,l=.01*Math.max(d[0],d[1],d[2]);if(a[0]>d[0]+l||a[1]>d[1]+l||a[2]>d[2]+l){if(this._maxLoggedBoxWarnings>0){const t=e=>`[${e.halfSize[0]}, ${e.halfSize[1]}, ${e.halfSize[2]}]`;s.getLogger(this).warn(`Node ${e} reported bounding box too small. got ${t(o)} but points cover ${t(n)}`),0===--this._maxLoggedBoxWarnings&&s.getLogger(this).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,n)}return new T.PointCloudRendererNode(e,r,g.clone(o.center),o,0===i.childCount,t.points,t.rgb,t.attributes,t.pointIdFilterMap)}get usedMemory(){let e=0;return this._renderer.forEachNode(t=>{e+=he,e+=a.estimateNumberArrayMemory(t.coordinates);for(const i of t.attributes){const t=i.values;h.isArrayBuffer(t.buffer)&&(e+=a.estimateNumberArrayMemory(t))}}),e}get unloadedMemory(){const e=this._renderedNodes.size;if(e<4)return 0;const t=[...this._renderedNodes].reduce((e,t)=>e+this._index.getNode(t).vertexCount);let i=this._loadingNodes.size;for(let e=0;e<this._workQueue.length;e++)i+=this._workQueue[e].load.length,i-=this._workQueue[e].remove.length;return i<0?0:i*t/e*((this.usedMemory-e*he)/t)+i*he}get performanceInfo(){return new D.PointCloudLayerViewPerformanceInfo(this.usedMemory,this._renderedNodes.size,[...this._renderedNodes].reduce((e,t)=>e+this._index.getNode(t).vertexCount,0),this.maximumPointCount,new D.QueuePerformanceInfo(this._loadingNodes.size,this._indexQueue.length,this._workQueue.length,this._idleQueue.length))}get test(){}};e.__decorate([c.property()],ae.prototype,"layer",void 0),e.__decorate([c.property()],ae.prototype,"baseUrl",null),e.__decorate([c.property()],ae.prototype,"pointScale",null),e.__decorate([c.property()],ae.prototype,"useRealWorldSymbolSizes",null),e.__decorate([c.property()],ae.prototype,"pointSize",null),e.__decorate([c.property()],ae.prototype,"inverseDensity",null),e.__decorate([c.property()],ae.prototype,"maximumPointCount",void 0),e.__decorate([c.property({readOnly:!0})],ae.prototype,"availableFields",null),e.__decorate([c.property({readOnly:!0})],ae.prototype,"_clippingBox",null),e.__decorate([c.property({readOnly:!0})],ae.prototype,"_elevationOffset",null),e.__decorate([c.property({type:Boolean})],ae.prototype,"slicePlaneEnabled",void 0),e.__decorate([c.property()],ae.prototype,"_graphicOrigin",null),e.__decorate([c.property()],ae.prototype,"updating",void 0),e.__decorate([c.property(ee.updatingProgress)],ae.prototype,"updatingProgress",void 0),e.__decorate([c.property({readOnly:!0})],ae.prototype,"updatingProgressValue",null),e.__decorate([c.property({readOnly:!0})],ae.prototype,"visibleAtCurrentScale",null),ae=e.__decorate([p.subclass("esri.views.3d.layers.PointCloudLayerView3D")],ae);const de=ae;class le{constructor(e,t,i){this.node=e,this.pointId=t,this.point=i}getGeometry(){return new v([1],Array.from(this.point))}get attributePointId(){const{node:e,pointId:t}=this;return null!=e.pointIdFilterMap?e.pointIdFilterMap[t]:t}get usedMemory(){return a.baseObjectMemory+a.baseObjectMemory+a.estimateNumberMemory+a.estimateFixedArrayMemory(this.point,a.estimateNumberMemory)}}class ue{constructor(e){this.features=e}get cachedMemory(){return this.features.reduce((e,t)=>e+t.usedMemory,a.baseObjectMemory+a.baseArrayMemory)}}const he=160;return de});