// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/has","./TerrainConst","./tileUtils"],function(e,t,s,i){"use strict";class l{get updating(){return!!this._tileRequested}init(e,t,s,i){this.tile=e,this._layerIdx=t,this._layerClass=s,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,s),this._tileRequested=null;const l=this._findAncestorWithData();this._setUpsampleTile(l)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,0,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,l=this.tile.surface.layerViewByIndex(e,t),{minLevel:a,maxLevel:n}=l.dataLevelRange,r=this._desiredMinLevelDelta,h=this._progressiveLevelModulo+r,d=this._scaleRangeEnabled?i.fallsWithinLayerView:()=>!0;let u=this.tile;const o=u.level;let _;const p=this._tileLayerInfo.upsampleInfo,y=p?.tile?.level??-1,f=null!=p&&y-o>=r,c=i.getTileMapCache(l),v="vector-tile-3d"===l.type?l.schemaHelper:null;for(;u&&d(u,l)&&u.level>=a;){const i=u.level,l=o-i,d=u.layerInfo[t][e];if(d.data&&l>=r){(!f||i>y)&&this._setUpsampleTile(u),d.dataInvalidated&&(_=u);break}const p=v?.getLevelRowColumn(u.lij)??u.lij;if("unavailable"!==c?.getAvailability(p[0],p[1],p[2])&&i<=n&&!d.data&&!d.dataMissing&&((!_||u.level===a||i%s.progressiveLoadingModulo===0||o-_.level<r)&&(_=u),l>=h))break;u=u.parent}if(null!=_&&o-_.level<r)if(p)_=null;else{const s=this._findAncestorWithData();null!=s&&(this._setUpsampleTile(s),_=s.layerInfo[t][e].dataInvalidated?s:null)}return _}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let s;for(let i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(e-i.level>=t)return i;s=i}return s}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,0,t)}get test(){}}const a=new Error("Abstract method called on TileAgent"),n=new class extends l{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw a}get _progressiveLevelModulo(){throw a}dispose(){}};e.TileAgent=l,e.tileAgentDone=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});