// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../Color","../../../core/has","../../../core/maybe","../../../core/MemCachePool","../../../core/ObjectPool","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/buffer/BufferView","./OverlayRenderer","./PatchRenderData","./TerrainAttributesCache","./terrainUtils","./TileRenderer","./tileUtils","../webgl-engine/collections/Component/ComponentIntersectionData","../webgl-engine/core/shaderLibrary/terrain/Overlay.glsl","../webgl-engine/effects/RenderPlugin","../webgl-engine/lib/Attribute","../webgl-engine/lib/IntersectorResult","../webgl-engine/lib/RayIntersections","../webgl-engine/lib/screenSizePerspectiveUtils","../webgl-engine/lib/verticalOffsetUtils","../webgl-engine/materials/DrawParameters","../../../chunks/Terrain.glsl","../webgl-engine/shaders/TerrainTechnique","../webgl-engine/shaders/TerrainTechniqueConfiguration","../../webgl/enums"],function(e,t,r,i,s,n,a,l,o,c,d,h,u,_,g,p,f,y,b,T,m,R,v,x,P,O,w,S,D,C,B,E,F,q,M,A){"use strict";const k=p.create();e.TerrainRenderer=class extends O.SyncRenderPlugin{get visibleTiles(){return Array.from(this._visiblePatchesByOrigin.values()).flat()}get _isGlobal(){return 1===this._stage.viewingMode}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,r,i,s,l){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=r,this._ellipsoidRadius=i,this._compressionTracker=s,this.type=2,this.isGround=!0,this._passParameters=new F.TerrainPassParameters,this._drawParameters=new E.DrawParameters,this._renderDataPool=new a(b.PatchRenderData),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new v.IteratorPreorder,this._castShadows=!1,this._inViewshed=!1,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=1,this.produces=new Map([[1,()=>this._produces()&&0===this.transparency],[6,()=>this._produces()&&(1===this.transparency||2===this.transparency)],[9,()=>this._produces()&&this.renderOccludedFlags===y.overlayRenderOccludedFlag]]),this._tileSize=256,this._configuration=new M.TerrainTechniqueConfiguration(1===t.viewingMode),this._tileTextureCache=new n.MemCachePool((e,t)=>l.newCache(e,t),"TileTexture"),this.tileGeometryCache=new T.TerrainAttributesCache(l)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(l.watch(()=>this._overlayRenderer.renderOccludedFlags,e=>{this.renderOccludedFlags=e,this.setNeedsRender()},l.sync))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy(),this._allTiles.prune(),this._tileRenderer=null}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?O.ConsumesDepth:O.ConsumesNone}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){this._tileRenderer?.updateHeading(e)}set transparency(e){this._configuration.transparencyMode!==e&&(this._configuration.transparencyMode=e,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(e){this._configuration.tileBorders!==e&&(this._configuration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(e){this._configuration.visualizeNormals!==e&&(this._configuration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(e){this._configuration.backfaceCullingEnabled!==e&&(this._configuration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}get layerViewUid(){return B.terrainId}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(e){this._configuration.hasSlicePlane!==e&&(this._configuration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._configuration.textureFadingEnabled!==e&&(this._configuration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._configuration.pbrMode!==e&&(this._configuration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._configuration.screenSizePerspective!==e&&(this._configuration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}set tileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._ensureRenderData(e),this.updateTileGeometryState(e),this.reuseTextureFromParent(e)||this.updateTileTexture(e,32)}reuseTextureFromParent(e){const t=e.parent;if(!t)return!1;const r=g.fromValues(1&e.lij[2]?.5:0,1&e.lij[1]?0:.5,.5,.5);return t.renderData?.reuseTexture(e.renderData,r)??!1}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,32===t?0:2),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const t of e.layerInfo[0])t.pendingUpdates&=-9;e.resetPendingUpdate(8);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.loaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return _.ZEROS;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=1){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=1){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=1){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new R.TileRenderer(this._rctx,this._tileSize,this._techniques,this._tileTextureCache,this._compressionTracker),this.updateTileBackground()}uninitializeRenderContext(){this._tileRenderer=s.disposeMaybe(this._tileRenderer)}intersect(e,t,r,i){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&0!==this.transparency)return;const s=N,n=I;u.subtract(s,i,r),u.set(n,1/s[0],1/s[1],1/s[2]);const a=e.results.min,l=e.results.max,o=e.results.ground,c=0===e.options.store,d=!!e.results.ground.target,h=B.getVerticalOffsetTerrain(e.verticalOffset),_=e.tolerance;let g,y=c&&null!=a.distance?a.distance:1/0;const b=e.options,T=b.normalRequired||!b.backfacesTerrain,m=new D.MeshIntersectionOptions(!1,T),R=d=>{const R=d.renderData;if(!R?.vao)return;const v=R.geometry;p.set(k,v.boundingBox);const P=R.localOrigin;null!=h&&(h.localOrigin=P,h.applyToAabb(k));const O=k;if(z[0]=r[0]-P[0],z[1]=r[1]-P[1],z[2]=r[2]-P[2],!D.intersectAabbInvDirBefore(O,z,n,_,y))return;const C=(e,t,r)=>{e.set(this.type,d,t,r),y=c&&null!=a.distance?a.distance:1/0},B=(n,c,d)=>{if((!T||null!=d)&&n>=0&&(b.backfacesTerrain||u.dot(d,s)<0)&&(b.invisibleTerrain||!b.selectionMode||null==t||t(r,i,n))){if((null==o.distance||n<o.distance)&&C(o,n,d),b.isFiltered)return;2===b.store&&(null==g?(g=new S.IntersectorResult(e.ray),C(g,n,d),e.results.all.push(g)):n<g.distance&&C(g,n,d)),(null==a.distance||n<a.distance)&&C(a,n,d),0!==b.store&&(null==l.distance||n>l.distance)&&C(l,n,d)}},E=G;u.subtract(E,i,P);const{indices:F,indexCount:q}=v,M=v.vertexAttributes,A=M.getField("position",f.BufferViewVec3f),N=new w.Vertices(A.typedBuffer,3,M.stride/4),I=q/3;if(!h&&I>x.componentMinimalSizeForIntersectionData){const e=d.renderData;null==e.intersectionData&&(e.intersectionData=new x.ComponentIntersectionData(F,0,I,N)),e.intersectionData.intersectRay(z,E,m,B)}else D.intersectTriangles(z,E,0,I,F,N,h,m,B)},v=this._rootTiles;null!=v&&(()=>{const t=this._tileIterator;t.reset(v);const i=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||i&&e.intersectsClippingArea)||null==h&&!e.intersectsRay(r,s,_,y)||d&&this._useStencilForTile(e)?t.skipSubtree():R(e)})()}processScaleRangeQueries(e,t){if(!t.done&&e)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const r of t)null!=r.renderData?.textureReference&&e.queriesForTile(r);e.process(),t.madeProgress()}}acquireTechniques(e){const t=!!i("enable-feature:terrain-shadows")&&e.bind.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);const r=e.bind.viewshedEnabled;if(this._inViewshed!==r&&(this._inViewshed=r,this._patchesByOriginDirty=!0),9===e.bind.slot){if(0===(e.renderOccludedMask&y.overlayRenderOccludedFlag))return null}else{const t=0===this.transparency?1:6;if(e.bind.slot!==t)return null}if(3===this.transparency)return null;const s=this._configuration;switch(s.screenSpaceReflections=s.cloudReflections=s.receiveShadows=s.receiveAmbientOcclusion=s.renderOccluded=s.hasHighlightMixTexture=!1,s.overlayMode=this._overlayRenderer.mode,e.output){case 0:case 1:{s.screenSpaceReflections=null!=e.bind.ssr.lastFrameColor,s.cloudReflections=null!=e.bind.clouds.data;const t=9===e.bind.slot;return s.receiveShadows=e.bind.shadowMap.ready&&!t,s.renderOccluded=t,s.receiveAmbientOcclusion=!t&&null!=e.bind.ssao,this._acquireTechnique(e.output)}case 4:case 6:return this._castShadows?this._acquireTechnique(4):null;case 7:return this._inViewshed?this._acquireTechnique(7):null;case 2:case 3:return this._acquireTechnique(e.output);case 9:return this._acquireTechnique(9);case 8:return s.hasHighlightMixTexture=null!=e.bind.highlightMixTexture,this._overlayRenderer.hasHighlights?this._acquireTechnique(8):null}return null}render(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,this._passParameters.overlayContent=P.getOverlayContentForOutputTerrain(e.output,e.bind),e.output){case 0:case 1:this._renderMaterialPass(e,t);break;case 2:case 3:case 9:this._renderAuxiliaryPass(e,t,this._visiblePatchesByOrigin);break;case 8:{const r=e.bind.highlight?.name;r&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(2)&&this._overlayRenderer.hasHighlight(r)&&this._renderAuxiliaryPass(e,t,this._visiblePatchesByOrigin);break}case 4:case 6:case 7:this._renderAuxiliaryPass(e,t,this._allPatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=r.toUnitRGBA(e);i=_.fromValues(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll(e=>t.updateTileTexture(e,0)),this._configuration.tileBlendInput=t.backgroundIsGrid?2:null!=t.backgroundColor?1:0,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const r of e)v.sortTiles(r,t);e.sort((e,t)=>v.compareTiles(e[0],t[0])),this._visiblePatchesByOrigin=new Map(e.map(e=>[e[0].renderData.localOrigin,e])),this.notifyChange("visibleTiles"),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),r=e.renderData;if(!r){this._numTilesCulled++;continue}const i=r.localOrigin;if(this._castShadows||this._inViewshed){let t=this._allPatchesByOrigin.get(i);t||(t=[],this._allPatchesByOrigin.set(i,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let s=this._visiblePatchesByOrigin.get(i);s||(s=[],this._visiblePatchesByOrigin.set(i,s)),s.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,r){const{rctx:i,bind:s}=e;i.bindTechnique(t,s,this._passParameters);const n=this._stencilEnabledLayerExtents.length>0;r.forEach(e=>{this._drawParameters.origin=e[0].renderData.localOrigin,t.program.bindDraw(s,this._passParameters,this._drawParameters);for(let r=0;r<e.length;r++)this._renderPatch(i,t,e[r],A.PrimitiveType.TRIANGLES,n,null===this._passParameters.overlayContent)}),i.bindVAO(null)}_renderMaterialPass(e,t){const{rctx:r,bind:i}=e;r.bindTechnique(t,i,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const s=i.camera,n=t.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){const e=C.getSettings(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:s.fovY})}const a=this._stencilEnabledLayerExtents.length>0,l=9===i.slot;l&&(n.bindTexture("tex",r.emptyTexture),n.setUniform3fv("textureOpacities",_.ZEROS),n.setUniform4fv("texOffsetAndScale",g.ZEROS));const o=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:_.ZEROS;1===this._configuration.tileBlendInput&&n.setUniform3fv("backgroundColor",o);const c=this.wireframe?A.PrimitiveType.LINES:A.PrimitiveType.TRIANGLES;this._configuration.textureFadingEnabled&&n.bindTexture("texNext",r.emptyTexture);const d=this._visiblePatchesByOrigin;for(const e of d.values()){const s=e[0].renderData.localOrigin;this._drawParameters.origin=s,t.program.bindDraw(i,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const i of e){const e=i.renderData,s=e.textureReference;if(null!=s){if(!l){n.setUniform4fv("texOffsetAndScale",s.offsetAndScale),n.bindTexture("tex",s.texture.texture);const t=e.textureFadeFactor,r=t<1?e.nextTextureReference:null;this._configuration.textureFadingEnabled&&r&&t<1?(n.setUniform1f("fadeFactor",t),n.setUniform4fv("nextTexOffsetAndScale",r.offsetAndScale),n.setUniform3fv("nextTexOpacities",r.opacities),n.bindTexture("texNext",r.texture.texture)):n.setUniform1f("fadeFactor",1),e.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",s.opacities)}this._renderPatch(r,t,i,c,a),i.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}r.bindVAO(null)}_renderPatch(e,t,r,i,s,n=!1){const a=r.renderData,l=a.vao,o=l?.indexBuffer;if(!l||null==o)return void(m.enableTerrainInternalChecks&&console.error("Rendered tile with no indices: ",r.lij," : ",a));const c=t.program;n||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(c,a.overlay),s&&(t.useStencil=this._useStencilForTile(r),e.setPipelineState(t.getPipeline()));const d=a.geometry.indexCount;e.bindVAO(l),c.assertCompatibleVertexAttributeLocations(l),e.drawElements(i,d,o.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_acquireTechnique(e){return this._configuration.output=e,this._techniques.get(q.TerrainTechnique,this._configuration)}get test(){}hasHighlight(e){return this._overlayRenderer.hasHighlight(e)}},t.__decorate([o.property({readOnly:!0})],e.TerrainRenderer.prototype,"visibleTiles",null),t.__decorate([o.property({readOnly:!0})],e.TerrainRenderer.prototype,"_isGlobal",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"renderOccludedFlags",void 0),t.__decorate([o.property({value:!1})],e.TerrainRenderer.prototype,"renderingDisabled",null),t.__decorate([o.property({value:!0})],e.TerrainRenderer.prototype,"visible",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"renderPatchBorders",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"visualizeNormals",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"cullBackFaces",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"wireframe",null),e.TerrainRenderer=t.__decorate([h.subclass("esri.views.3d.terrain.TerrainRenderer")],e.TerrainRenderer);const N=_.create(),I=_.create(),z=_.create(),G=_.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});