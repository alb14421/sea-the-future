// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/has","../../../core/maybe","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../layers/support/layerUtils","../support/flowUtils","./BlendLayersTechnique","./TerrainData","./terrainUtils","./TextureReference","./TileCompositor","./TileRenderInfo","./TileTexture","./tileUtils","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/lib/glUtil3D","../../support/TextureCompressionWorkerHandle","../../webgl/Texture","../../webgl/TextureDescriptor"],function(e,t,r,s,i,a,o,n,c,u,l,p,d,h,f,y,T,_,m,x,b){"use strict";class g{constructor(e,t,r,s,i,a){this.start=e,this.end=t,this.blendMode=r,this.opacity=s,this.output=i,this.baseOpacity=a}}function w(e,t,r){O.layerIndex=t,O.vtlNeighborInfos.clear();const i=e.layerInfo[1][t];if(s.set(O.offset,0,0),O.tile=e,O.scale=1,O.sourceLod=e.lij,O.sourceLayerInfo=i,O.isVTLBackground=r,i.data)return r&&e.forEachLoadedNeighbor((r,s)=>{if(r.level!==e.level)return;const a=r.layerInfo[1][t];if(!l.isVectorTilePerLayerInfo(a)||i.data===a.data)return;const o=O.vtlNeighborInfos.pushNew();o.offset=C[s],o.sourceLod=r.lij,o.sourceLayerInfo=a}),O;const a=i.upsampleInfo,o=a?.tile?.layerInfo[1][t];return o&&a.tile?(O.tile=a.tile,s.copy(O.offset,a.offset),O.scale=a.scale,O.sourceLod=a.tile.lij,O.sourceLayerInfo=o,O):r?O:null}function L(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}function k(e){let t="normal"!==e.blendMode;return o.isGroupLayer(e.parent)&&(t=k(e.parent)||t),t}function I(e,t){o.isGroupLayer(e.parent)&&I(e.parent,t);const r=e.uid;if(null!=r&&""!==r){const s=R.get(r);s?s.start=t:R.set(r,new g(t,t,e.blendMode,e.opacity,1,1))}}const R=new Map,P=new Array,O=new h.TileRenderInfo,B=a.fromValues(0,0,1,1),C=new Array;C[0]=[0,-1],C[1]=[-1,-1],C[2]=[-1,0],C[3]=[-1,1],C[4]=[0,1],C[5]=[1,1],C[6]=[1,0],C[7]=[1,-1],e.GroupInfo=g,e.TileRenderer=class{constructor(e,t,r,s,i){this._rctx=e,this.tileSize=t,this._techniques=r,this._cache=s,this._compressionTracker=i,this._passParameters=new c.BlendLayersPassParameters,this._backgroundColor=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new d.TileCompositor(this._rctx,this._techniques)}dispose(){this._compositor=r.disposeMaybe(this._compositor),this._backgroundTexture=r.releaseMaybe(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const r=e.surface,s=r.baseOpacity;let i=0,a=0,c=this.tileSize,u=!1,p=!1;const d=r.view.state.contentPixelRatio;let h=!1;R.clear(),P.length=0;const f=e.layerInfo[1];let T=0,_=null;for(;T<f.length;T++){const t=r.layerViewByIndex(T,1),m=t.layer,x=!y.fallsWithinLayerView(e,t),b=m.opacity,g=t.fullOpacity;if(p=p||o.isBaseLayer(m),n.isLayerViewWithFlowRenderer(t))continue;if(l.isBlendableLayerView(t)){let e="normal"!==t.layer.blendMode;if(o.isGroupLayer(m.parent)){const t=m.parent.uid;null!=t&&""!==t&&(e=k(m.parent)||e)}e&&(h=e,u=!1)}if((x||0===b)&&!h){f[T].pendingUpdates&=-1;continue}++a;const L=l.isVectorTileLayerView(t),R=w(e,T,L);if(R){if(f[T].pendingUpdates&=-1,o.isGroupLayer(m.parent)){const e=m.parent.uid;null!=e&&""!==e&&I(m.parent,T)}L?c=Math.max(c,this.tileSize*d):1===s&&1===g&&(t.isOpaque||this._dataToTexture(R,o.isReferenceLayer(m))&&R.sourceLayerInfo.data.descriptor.isOpaque)&&(u=!0),++i,null===_&&(_=T)}}const m=c/this.tileSize;0!==i&&null!==_?1===i&&!h&&this._useLayerTexture(e,_)||this._composeLayers(e,t,T-1,p,c,m,!u||h,R,h):this._useBackgroundTexture(e,a,0!==t)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundTexture&&this._drawBackgroundTexture(this._backgroundTexture))}_ensureBackgroundTexture(){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(this.tileSize,!1),this._drawBackgroundTexture(this._backgroundTexture)),this._backgroundTexture}_drawBackgroundTexture(e){this._compositor.bind(this.tileSize),this._passParameters.offset=i.ZEROS,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(e),this._compositor.unbind()}_useBackgroundTexture(e,t,r){const s=e.renderData,i=!r&&null!=s.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?5e3:0,a=this._ensureBackgroundTexture();s.setTextureReference(new p.TextureReference(a,0,B,e.surface.baseOpacity,0,1),i)}_useLayerTexture(e,t){const r=e.surface.layerViewByIndex(t,1),s=o.isBaseLayer(r.layer),i=s?e.surface.baseOpacity:1,n=s?1:e.surface.baseOpacity,c=r.fullOpacity,u=w(e,t,!1);return!!this._dataToTexture(u,o.isReferenceLayer(r.layer))&&(e.renderData.setTextureReference(new p.TextureReference(u.sourceLayerInfo.data,0,a.fromValues(u.offset[0],u.offset[1],u.scale,u.scale),i,n,c)),!0)}_composeLayers(e,t,r,s,a,c,u,d,h){this._compositor.ensureBuffer(a);const f=e.surface.baseOpacity;let _=!1,m=9987,x=!1,b=0;for(let t=r;t>=0;t--){const r=e.surface.layerViewByIndex(t,1),p=r.layer,g=l.isVectorTileLayerView(r),k=w(e,t,g),I=p.opacity,R=!y.fallsWithinLayerView(e,r);if(!k||(0===I||R)&&!h)continue;if(n.isLayerViewWithFlowRenderer(r))continue;const O=!o.isBaseLayer(p)&&!_;O&&(_=!0);let B=!1;d.forEach(e=>{e.start===t&&(e.output=s?1:u&&O?this.backgroundIsGrid?3:2:1,e.baseOpacity=O?f:1,P.push(e),this._compositor.openGroup(a),B=!0)});const C=B?4:u&&0===b?this.backgroundIsGrid?3:2:1,M=T.blendModeFromString[l.isBlendableLayerView(r)?r.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=O&&!B&&f<1?f:1,this._passParameters.opacity=I,l.isVectorTileRenderInfo(k)?x=this._compositor.drawVectorData(this._passParameters,C,a,M,k,c,this.tileSize,x):l.isImageryTileRenderInfo(k)?(this._compositor.drawRasterData(this._passParameters,C,a,M,k),L(k)&&(m=9728)):this._dataToTexture(k,o.isReferenceLayer(p))&&(this._passParameters.texture=k.sourceLayerInfo.data.texture,this._passParameters.offset=k.offset,this._passParameters.scale=k.scale,this._compositor.drawImageData(this._passParameters,C,a,M));P.length>0&&P[P.length-1].end===t;){const e=P.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=i.ZEROS,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,e.output,a,T.blendModeFromString[e.blendMode])}b++}const g=e.renderData,k=h||_&&f<1,I=g.ensureTexture(a,k,t,()=>this._buildTexture(a,k,m));this._compositor.copyFBOToTexture(I),this._compositor.unbind(),g.setTextureReference(new p.TextureReference(I,t,B,_?1:f,0,1))}_dataToTexture(e,t){if(l.isImageSourceRenderInfo(e)){const r=e.sourceLayerInfo,s=1===e.scale&&!t;r.data=this._buildTexture(r.data,!0,s,e.tile.onCompressionFinished),e.tile.setMemoryDirty()}return l.isTextureTileRenderInfo(e)}_buildTexture(e,t,r=9987,s=()=>{}){if(null==e)return null;const i=new b.TextureDescriptor;i.wrapMode=33071,i.samplingMode="boolean"==typeof r?9987:r,i.maxAnisotropy=this._maxAnisotropy,i.preMultiplyAlpha=!0,i.flipped=!0,i.hasMipmap=!0,t||(i.pixelFormat=6407);const a=this._rctx,o="boolean"==typeof r&&r;let n;if("number"==typeof e)i.width=i.height=e,n=this._buildTileTexture(i);else if(u.isImageWithType(e))i.isOpaque=e.isOpaque,i.isOpaque&&(i.pixelFormat=6407),i.width=e.element.width,i.height=e.element.height,n=this._buildTileTexture(i,o,s,e.element);else try{i.width=e.width,i.height=e.height,n=this._buildTileTexture(i,o,s,e)}catch(e){n=new f.TileTexture(_.createEmptyTexture(a)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const c=a.bindTexture(n.texture,x.Texture.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),a.bindTexture(c,x.Texture.TEXTURE_UNIT_FOR_UPDATES),n}_buildTileTexture(e,t=!1,r=()=>{},s){const i=this._cache.pop(f.getCacheKey(e,!1))??this._cache.pop(f.getCacheKey(e,!0));if(t&&=m.isCompressible(s,e),i)return i.retain(),t?i.texture.enableCompression({compressionTracker:this._compressionTracker,compressionCallback:r}):i.texture.disableCompression(),i.texture.setData(s),i;e.compress=t?{compressionTracker:this._compressionTracker,compressionCallback:r}:void 0;const a=new x.Texture(this._rctx,e,s);return new f.TileTexture(a,this._cache)}get test(){}},e.cleanupTileRenderer=function(){O.sourceLayerInfo=null,O.tile=null,O.vtlNeighborInfos.prune()},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});