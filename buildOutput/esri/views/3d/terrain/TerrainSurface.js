// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../../../chunks/tslib.es6","../../../Color","../../../core/arrayUtils","../../../core/CollectionFlattener","../../../core/compilerUtils","../../../core/Evented","../../../core/has","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/MemCachePool","../../../core/ObjectPool","../../../core/PooledArray","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/unitUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/support/UpdatingHandles","../../../geometry/ellipsoidUtils","../../../geometry/SpatialReference","../../../geometry/projection/projectors","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingRect","../../../geometry/support/frustum","../../../geometry/support/spatialReferenceUtils","../../../chunks/sphere","../../../layers/support/ElevationQueryTileCache","../../../layers/support/layerUtils","../support/debugFlags","../support/ElevationRange","../support/ElevationUpdateEvent","../support/extentUtils","../support/updatingProperties","./ElevationBounds","./ElevationData","./ExtentHelper","./LayerClass","./OverlayManager","./PlanarPatch","./ScaleRangeQueries","./SphericalPatch","./SplitLimits","./TerrainConst","./TerrainRenderer","./TerrainSurfacePerformanceInfo","./terrainUtils","./Tile","./TilePerLayerInfo","./tileUtils","./TilingSchemeLogic","./UpsampleInfo","../webgl-engine/core/shaderLibrary/output/BlendOptions","../../support/layerViewUtils","../../support/Scheduler","../../support/TextureCompressionTracker","../../support/Yield"],function(e,t,i,r,s,a,n,l,o,h,d,p,c,u,_,g,y,m,T,f,v,w,b,S,C,L,x,E,P,D,M,U,R,A,k,I,V,B,j,N,q,G,O,F,W,H,$,Q,z,Y,X,K,J,Z,ee,te,ie,re,se,ae,ne){"use strict";var le;let oe=class extends n.EventedAccessor{static{le=this}get allTiles(){return a.toConst(this._allTiles)}get demResolution(){const{_allTiles:e,tilingScheme:t}=this;if(0===e.length)return{min:1,max:1};const i=y.getMetersPerUnitForSR(t.spatialReference);let r=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(const a of e){const e=t.resolutionAtLevel(a.level)*i;r=Math.min(r,e),s=Math.max(s,e)}return{min:r,max:s}}constructor(e){super(e),this.terrainTextureCompressionTracker=new ae.TextureCompressionTracker,this._iteratorPool=new c(Z.IteratorPreorder,e=>e.remove=()=>this._iteratorPool.release(e)),this._postorderIterator=new Z.IteratorPostorder,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new Y,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=v.create(),this._eyePosSurfaceSR=v.create(),this._splitLimits=new $.SplitLimits,this._frustum=P.create(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new w.UpdatingHandles,this._frameTask=se.ImmediateTask,this._allTiles=new u,this._upsampleInfoPool=new c(te.UpsampleInfo),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=E.create(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=S.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new j.ElevationBounds(1/0,-1/0),this.rootTileElevationBounds=new j.ElevationBounds(1/0,-1/0),this._projectorCache=new Map,this._radiusModifier=Math.cos(Math.PI/16/16),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this._enabled=!0;const t=e.view;this.overlayManager=new O.OverlayManager({...e,surface:this}),this._isGlobal=!t.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?H.SphericalPatch:F.PlanarPatch,this._ellipsoid=b.getReferenceEllipsoid(t.spatialReference),this._renderer=new z.TerrainRenderer(this.overlayManager.renderer,t.stage,this._allTiles,this._ellipsoid.radius,this.terrainTextureCompressionTracker,t.resourceController.memoryController),re.hasLayerBasedScaleVisibility()||(this._scaleRangeQueries=new W.ScaleRangeQueries)}initialize(){const t=this.view,i=t.resourceController,r=i.memoryController;this._tileCache=new p.MemCachePool((e,t)=>r.newCache(e,t),"terrain-tile"),this._upsampleMapCache=r.newCache("terrain-upsample",e=>e.unloadMapData()),this._elevationQueryCache=new U.ElevationQueryTileCache(r.newCache("elevation-query"));const a=this.overlayManager;this.addHandles([g.watch(()=>a.renderer.isEmpty,()=>this._evaluateTransparency()),g.watch(()=>this.renderer.visible,e=>this.suspended=!e),g.watch(()=>this.heading,e=>{this._renderer.updateHeading(e),this._updateTileTextures(0)}),g.watch(()=>({heading:t.camera?.heading,state:t.state?.mode}),({heading:e,state:t})=>{if(null==e)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(e/90)%360);const i=Math.round(e)%360,r=Math.abs(i-this.heading);(2===t||Math.min(r,360-r)>=30)&&(this.heading=i)})],"overlayManager"),this.addHandles([g.watch(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?1:2)},g.syncAndInitial),g.watch(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?1:2),g.syncAndInitial),g.watch(()=>this.backgroundColor,(e,t)=>{e?.equals(t)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(e))},g.sync),g.watch(()=>this.snapLevel,()=>this._viewChanged=!0,g.sync),g.watch(()=>this.view.pointsOfInterest,e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add(()=>e.focus?.renderLocation,()=>this._allTilesSorted=!1)}),g.watch(()=>A.debugFlags.TERRAIN_TILE_TREE_SHOW_TILES,i=>{i&&!this._treeDebugger?new Promise((t,i)=>e(["../layers/support/TerrainTileTree3DDebugger"],t,i)).then(({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&A.debugFlags.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:t}))}):i||(this._treeDebugger=d.destroyMaybe(this._treeDebugger))},g.initial)]);const{spatialReference:n}=t;this._extentHelper=q.create(this.viewingMode,{layers:t.map.allLayers,layerViews:t.allLayerViews,viewSpatialReference:n});const l=new s({getCollections:()=>t.defaultsFromMap?.mapCollections?.map(({layers:e})=>e),getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),o=new ee.TilingSchemeLogic({layers:l,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:n});this._set("tilingSchemeLogic",o),this._updateTilingScheme(),this._elevationDataRequester=i.createStreamDataRequester(0),this._mapDataRequester=i.createStreamDataRequester(1);const h=i.scheduler;this._frameTask=h.registerTask(se.TaskPriority.TERRAIN_SURFACE,this),this.addHandles([g.watch(()=>this._extentHelper.stencilEnabledExtents,e=>this._renderer.setStencilEnabledLayerExtents(e),g.initial),g.watch(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),g.sync),g.watch(()=>this.extent,()=>this._updateRootTiles(),g.initial),t.on("resize",()=>this._viewChangeUpdate()),g.watch(()=>{const e=t.state;return[this._lodBias,this.lodSnappingEnabled,t.quality,e.camera,e.contentCamera,e.fixedContentCamera]},()=>this._viewChangeUpdate(),g.syncAndInitial),g.watch(()=>t.qualitySettings?.fadeDuration,e=>this._renderer.textureFadingEnabled=e>0,g.initial),g.watch(()=>t.qualitySettings?.physicallyBasedRenderingEnabled,e=>this._renderer.pbrMode=e?5:0,g.initial),g.watch(()=>t.qualitySettings?.tiledSurface.elevationLevelDelta,()=>this._updateAllTileGeometries()),g.watch(()=>this._userClippingExtent,()=>this._updateClippingExtent(),g.sync)]),this.addHandles(t.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}clearHandles(){this._watchUpdatingTracking?.removeAll(),this.removeAllHandles(),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._basemapLayerViewHandles.clear()}destroy(){this._frameTask.remove(),this._frameTask=se.ImmediateTask,this._watchUpdatingTracking?.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",d.destroyMaybe(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._basemapLayerViewHandles.clear(),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",d.destroyMaybe(this.overlayManager)),this._tileCache=d.destroyMaybe(this._tileCache),this._allTiles.prune(),K.Tile.prune(),this._treeDebugger=d.destroyMaybe(this._treeDebugger),this._renderer.destroyed||this._renderer.destroy(),this._renderer=null,this._iteratorPool=d.destroyMaybe(this._iteratorPool),this._upsampleMapCache=d.destroyMaybe(this._upsampleMapCache),this._elevationQueryCache=d.destroyMaybe(this._elevationQueryCache),this._set("view",null),this._extentHelper=d.destroyMaybe(this._extentHelper),this._upsampleInfoPool=d.destroyMaybe(this._upsampleInfoPool),J.printAllocations(),this._layerViews.forEach(e=>e.length=0),this._performanceInfo=null}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnappingEnabled){const{view:e,tilingScheme:t}=this,i=e.scale;if(t&&i){const r=t.levelAtScale(i)+e.qualitySettings.tiledSurface.lodBias,s=t.getMaxLod();return r<=0?null:Math.min(r,s||1/0)}}return null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){const{spatialReference:e}=this,t=this.view?.clippingArea;if(null==t||null==e)return null;const i=E.create(),r=V.toBoundingRect(t,i,e)?i:null,s=this._get("extent");return E.equals(r,s)?s:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=E.intersection(this.groundExtent,this._userClippingExtent,E.create()),t=this._get("extent");return E.equals(e,t)?t:e}get groundExtent(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.readyToRun||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating||this.terrainTextureCompressionTracker.compressing)}get readyToRun(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries?.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return null!=this._rootTiles}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return 0===this._renderer.transparency}get invisible(){return 3===this._renderer.transparency}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevationLevelDelta(e){return e<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(e,t,i,r){const s=this._rootTiles;if(!s?.length||!this._enabled)return null;if(0===s[0].layerInfo[0].length)return null;let a=this._elevationProjectorCache.get(r);if(void 0===a&&(a=C.getProjector(r,this._spatialReference)??null,this._elevationProjectorCache.set(r,a)),null==a)return o.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const n=f.set(de,e,t,i);return a(n,0,n,0),ye(s,n[0],n[1])}getElevations(e,t,i){const r=this._rootTiles,s=r?r[0].layerInfo[0].length:0;if(r?.length&&0!==s&&this._enabled)for(let s=0;s<t;++s){const t=3*s;i(s,ye(r,e[t],e[t+1]))}else for(let e=0;e<t;++e)i(e,null)}getLayerIndexByUID(e,t){return this._layerIndexByUid[e].get(t)}getScale(e){if(!this.tilingScheme)return null;if(!L.projectPointToVector(e,de,this.spatialReference))return o.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(null!=t)for(const e of t)if(e?.containsPoint(de)){let t=e;for(;t.children[0]&&!t.rendered;){const e=t.children[0].extent;let i=0;de[0]>e[2]&&(i+=1),de[1]<e[1]&&(i+=2),t=t.children[i]}return this._getLodBiasCorrectedScale(t.level)}return 1/0}_ensureProjector(e){const t=this._projectorCache.get(e);if(t)return t;const i=C.getProjector(e,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(e,i),i}getSphereElevationBounds(e,t){const i=this._ensureProjector(t);if(null==i)return o.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;M.copy(e,pe);const r=M.getCenter(pe);i(r,0,r,0);const s=new k.ElevationRange,a=this._rootTiles;if(null!=a){const e=[];for(const t of a)e.push(t);let t=0;for(;t<e.length;){const i=e[t];if(++t,!E.intersectsSphere(i.extent,pe))continue;const r=i.children;if(null==r[0]||i.rendered)s.expandElevationRangeValues(i.elevationBoundsMin,i.elevationBoundsMax);else for(const t of r)e.push(t)}}return s}getRootElevationBounds(){return new k.ElevationRange(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getLowerBoundRadius(){const e=(this._ellipsoid.radius+this.visibleElevationBounds.min)*this._radiusModifier;return Math.min(e,this._ellipsoid.radius)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!L.projectPointToVector(e,M.getCenter(pe),this.spatialReference))return o.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;pe[3]=t;let i=null;const r=e=>{if(e&&E.intersectsSphere(e.extent,pe)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)r(e);else{const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}}},s=this._rootTiles;if(null!=s)for(const e of s)r(e);return i}queryVisibleScaleRange(e,t,i,r){if(!this._scaleRangeQueries)return;const s=t?this.tilingScheme.levelAtScale(t):0,a=i?this.tilingScheme.levelAtScale(i):1/0,n=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,s+n,a+n,r)}_evaluateTransparency(){const e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,r=this._isFullyTransparent?t?3:2:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?0:1;return this._renderer.transparency=r,i!==r}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;X.weakAssert(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const t=e?.spatialReference??S.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&D.isPlateCarree(this.view?.renderSpatialReference),this._isGeographic=t?.isGeographic??!1,this._set("tilingScheme",e),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.tileSize=e.pixelSize,this.overlayManager.spatialReference=e.spatialReference,this._updateRootTiles())}static{this._tileMemcacheKey="TerrainTileMemcache"}_acquireTile(e,t,i,r){const s=this._tileCache.pop(le._tileMemcacheKey);return s?(s.init(e,t,i,r,this),s):new this._tileConstructor(e,t,i,r,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=ce;let s=t.rootTilesInExtent(e,i,5*Q.maxRootTiles);if(null!=this._rootTiles){if(s.length>Q.maxRootTiles)return void o.getLogger(this).warn(Q.tooManyRootTilesAfterChangeError);const e=this._rootTiles.map(e=>e.lij),t=r.difference(e,s,K.lijEquals);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter(e=>!(t.removed.findIndex(t=>K.lijEquals(t,e.lij))>-1&&(this._purgeTile(e),1)));t.added.forEach(t=>e.push(this._newRootTile(t))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,s.length>Q.maxRootTiles&&(o.getLogger(this).warn(Q.tooManyRootTilesForLayerError),s=t.rootTilesInExtent(e,i,Q.maxRootTiles)),this._setRootTiles(s.map(e=>this._newRootTile(e)));E.equals(i,this._rootTilesExtent)||(this._rootTilesExtent=E.create(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter(e=>e.loaded&&e.intersectsClippingArea);e.sort(Z.compareTilesByLij),e.forEach(e=>this._renderer.updateTileGeometryState(e)),e.forEach(e=>e.renderData.updateNeighborData()),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(0===e.length)return;e.sort(Z.compareTilesByLij);const t=this.renderer;e.forEach(e=>t.updateGeometryIfNeeded(e)),e.forEach(e=>this._pendingTilesForElevationUpdateEvent.add(e))}_shouldSplit(e){return 1===e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(1),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles})}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(8)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(null==e)return;const t=Z.hasLoadableSiblings(e),i=this.visibleElevationBounds;let r=t?i.min:1/0,s=t?i.max:-1/0;const a=this.extent,n=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();const l=this._iteratorPool.acquire();for(l.reset(e);!l.done;){const e=l.next();e.updateClippingStatus(a)&&e.resetPendingUpdate(8)&&this._updateTileGeometryState(e),e.computeVisibility(),e.updateScreenDepth(n),e.renderData&&(r=Math.min(e.elevationBoundsMin,r),s=Math.max(e.elevationBoundsMax,s))}l.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(r)&&isFinite(s)&&(i.min!==r||i.max!==s)&&(this.visibleElevationBounds=new j.ElevationBounds(r,s))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;const i=this._rootTiles;null!=i&&i.forEach(({elevationBoundsMin:i,elevationBoundsMax:r})=>{e=Math.min(e,i),t=Math.max(t,r)});const r=this.rootTileElevationBounds;r.min===e&&r.max===t||(this.rootTileElevationBounds=new j.ElevationBounds(e,t))}_updateViewDependentParameters(){const{camera:e,contentCamera:t}=this.view.state,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,a=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=P.copy(this._splitLimits.frustum??P.create(),t.frustum):this._splitLimits.frustum=null,P.copy(this._frustum,e.frustum),f.copy(this._eyePosRenderSR,t.eye),x.projectVectorToVector(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor(e=>{this._layerViews[1].some(X.isVectorTileLayerView)&&e.setPendingUpdate(32),this._pendingTilesToUpdate.add(e)})}_updateTileTexture(e,t){const i=e.resetPendingUpdate(32)?32:!!e.resetPendingUpdate(16)&&16;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const e=_e.extent;E.empty(e),this._pendingTilesForElevationUpdateEvent.forEach(t=>E.expand(e,t.extent,e)),this._pendingTilesForElevationUpdateEvent.clear(),_e.spatialReference=this.spatialReference,this.emit("elevation-change",_e),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),X.enableTerrainInternalChecks&&this._checkTileInvariant(),!e.hasProgressed)return ne.Yield}_checkTileInvariant(){const e=new Map;this._allTiles.forAll(t=>e.set(t,new Set)),this._allTiles.forAll(t=>{if(X.weakAssert(t.rendered===t.leaf,` rendered ${t.rendered} != ${t.leaf} leaf`),!t.leaf){const e=e=>0===e.unmergableChildCount&&0===e.maxLevelDeltaNeighborCount,i=t.children.reduce((t,i)=>t+(e(i)?0:1),0);if(X.weakAssert(t.unmergableChildCount===i,` Tile[${t.lij.toString()}] unmergeable child count mismatch: actual ${t.unmergableChildCount} vs ${i}`),t.hasPendingUpdate(4)){X.weakAssert(!t.hasPendingUpdate(1),"Tile can be both split and merge at the same time");for(const e of t.children)X.weakAssert(e.leaf||e.hasPendingUpdate(4),"Child of tile to merge must also merge")}}for(let i=0;i<4;++i){if(t.rendered){const e=t.renderData?.geometryState.edgePeerNeighbors[i];if(null!=e){{const r=t.level-e.level<=Q.maxTileNeighborLevelDelta;r||(console.log(`tile level delta [${t.lij.toString()}] vs [${e.lij.toString()}] > ${Q.maxTileNeighborLevelDelta}  (edge[${i}])`),X.weakAssert(r,`tile level delta [${t.level}] vs [${e.level}] > ${Q.maxTileNeighborLevelDelta}`))}X.weakAssert(t.level-e.level<=Q.maxTileNeighborLevelDelta,`Max tile lod delta exceeded: [${t.lij.toString()}] vs [${e.lij.toString()}]`)}}const r=t.level-Q.maxTileNeighborLevelDelta,s=e=>e.leaf||e.level===t.level,a=t.findNeighborTile(X.neighborEdgeIndices[i],s);if(null!=a){if(t.leaf&&t.level>=Q.maxTileNeighborLevelDelta){let i=a;for(;t.level-i.level<Q.maxTileNeighborLevelDelta;)i=i.parent;const s=[r,t.lij[1]>>Q.maxTileNeighborLevelDelta,t.lij[2]>>Q.maxTileNeighborLevelDelta];if(!K.lijEquals(s,i.lij)){const r=e.get(i);X.weakAssert(!r.has(t),"Cannot already have neighbor"),r.add(t)}}X.weakAssert(a.rendered||a.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),X.weakAssert(t.level-a.level<=Q.maxTileNeighborLevelDelta,`Tile level delta [${t.level}] vs [${a.level}] > ${Q.maxTileNeighborLevelDelta}`)}}}),this._allTiles.forAll(t=>{const i=t.maxLevelDeltaNeighborCount,r=e.get(t);X.weakAssert(i===r.size,`Tile[${t.lij.toString()}] merge-blocker mismatch: actual ${i} vs ${r.size}`)})}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=new me(this._allTiles.length);t.pushAll(this._rootTiles);const i=this.snapLevel,r=this._splitLimits,s=this._eyePosRenderSR;this._allTiles.forAll(e=>{e.maxLevelDeltaNeighborCount=0,e.unmergableChildCount=0});const a=this.view.state.contentCamera.viewProjectionMatrix;for(;!t.empty;){const e=t.pop(),n=e.parent,l=null!=n&&n.hasPendingUpdate(4),o=l?4:e.shouldSplit(r,s,i),h=1===o;e.leaf?Te(e,h):t.pushAll(e.children),l?(e.resetPendingUpdate(1),e.leaf||e.setPendingUpdate(4),this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(a)):h?(e.resetPendingUpdate(4),e.leaf&&e.setPendingUpdate(1)):(e.resetPendingUpdate(1)&&e.updateAgentSuspension(),2===o&&e.updateAgents(0),e.leaf||(e.setPendingUpdate(4),e.resetPendingUpdate(1)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||!this.view.pointsOfInterest?.focus||(Z.sortTilesByPOI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){X.internalAssert(e.loaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){const e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter(e=>e.loaded&&e.intersectsClippingArea);if(0===t.length)return void e.clear();const i=(i,r)=>{!r?.loaded||!r.intersectsClippingArea||r.level<i.level||e.has(r)||(e.add(r),t.push(r),r.renderData.updateNeighborData())};t.sort(Z.compareTilesByLij);const r=t.length;for(let s=0;s<r;++s){const r=t[s];X.internalAssert(r.loaded),X.internalAssert(r.intersectsClippingArea);const a=r.renderData;a.updateNeighborData();const n=a.dirtyEdgeResolutions,l=a.geometryState,o=e=>{const t=X.neighborCornerIndices[e];i(r,l.cornerPeerNeighbors[e]?.findCorner(X.oppositeCorner(t),e=>e.loaded))};for(let t=0;t<4;++t)if(n&1<<t){const s=a.geometryState.edgePeerNeighbors[t];s&&s?.level>=r.level&&s.forAllSubtreeOnSide(X.oppositeEdge(X.neighborEdgeIndices[t]),t=>!(!t.loaded||!t.intersectsClippingArea||(X.internalAssert(e.has(t)||Z.compareTilesByLij(r,t)<0),i(r,t),0))),o((t+1)%4),o(t)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,X.enableTerrainInternalChecks&&X.enableWaterproofTests&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const r=this.view.state.fixedContentCamera;let s=!1;for(;!e.done;){s=!0;let a=!1;const n=!this._allTiles.some(s=>{if(!i&&!r&&!s.visible)return e.done;let n=s;if(s.hasPendingUpdate(4)){if(!t||s.unmergableChildCount>0)return e.done;for(s.resetPendingUpdate(4);null!=n.parent&&0===n.parent.unmergableChildCount&&n.parent.resetPendingUpdate(4);)n=n.parent;this._mergeTile(n),a=!0,e.madeProgress()}else if(s.resetPendingUpdate(1)){let t=!0;const i=s.level;if(i>=Q.maxTileNeighborLevelDelta){const e=e=>e.leaf||i-e.level<Q.maxTileNeighborLevelDelta;for(let r=0;r<4;++r){const a=s.findNeighborTile(X.neighborEdgeIndices[r],e);null!=a&&i-a.level===Q.maxTileNeighborLevelDelta&&(t=!1,X.enableTerrainInternalChecks&&(X.internalAssert(a.leaf),X.internalAssert(a.hasPendingUpdate(1))))}}t?(this._splitTile(s),e.madeProgress(),a=!0):s.setPendingUpdate(1)}return e.done});if(a&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),n){if(!i){i=!0;continue}if(!a)break}else this._allTilesDirty=!0}s?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some(t=>(t.resetPendingUpdate(8)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done)),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some(t=>(this._updateTileTexture(t,e),e.done))}_updateClippingExtent(){this.spatialReference&&(this.overlayManager?.updateOverlayParameters(1),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*Q.maxMemoryLodBias}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=h.clamp(e-this._lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){null!=this._rootTiles&&(this._rootTiles.forEach(e=>this._purgeTile(e)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles}),this.renderer.visible=!1}_purgeSubtree(e){const t=e.children;t[0]&&(this._purgeTile(t[0]),this._purgeTile(t[1]),this._purgeTile(t[2]),this._purgeTile(t[3]),e.clearChildren())}_purgeTile(e){e.leaf?ve(e):this._purgeSubtree(e),this._allTiles.removeUnordered(e),this._unloadTile(e),e.dispose(),this._tileCache.put(le._tileMemcacheKey,e),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles})}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload()}_splitTile(e){X.weakAssert(e.leaf,"Tile that is already split should not be split again!"),X.weakAssert(e.rendered,"Tile marked to split is not rendered"),ve(e);const t=e.createChildren();this._allTiles.pushArray(t),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles}),e.updateAgentSuspension(),X.weakAssert(e.rendered,"parent should be rendered"),t.forEach(e=>this._loadTile(e)),t.forEach(e=>this._pendingTilesToUpdate.add(e)),this._unloadTile(e),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),t.forEach(e=>Te(e,e.hasPendingUpdate(1))),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){ge.spatialReference=this.spatialReference,ge.extent=e.extent,ge.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",ge)}createTile(e,t,i,r){X.weakAssert(!!r,"createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(1),s}get _shortBatches(){return 2!==this.view.state.mode}_mergeTile(e){X.weakAssert(!e.hasPendingUpdate(1),"_mergeTile sanity check"),X.weakAssert(!e.leaf,"Cannot merge a leaf"),e.leaf||(this._purgeSubtree(e),X.weakAssert(!e.renderData,"Merging tile with existing render data?"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),Te(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager?.hasOverlays&&this.overlayManager.updateTileOverlayParameters(e)}_handleLayerViewChanges(e=se.noBudget){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(let e=this.view.allLayerViews.length-1;e>=0;e--){const s=this.view.allLayerViews.items[e];if(i.add(s.uid),X.isSurfaceLayerView(s)||X.isGroupLayerView(s))if(this._basemapLayerViewHandles.has(s.uid)&&!X.isGroupLayerView(s)){const e=this._layerClassFromLayerView(s),i=this.getLayerIndexByUID(e,s.uid);null!=i&&((i<r||null==r)&&(t=!0),r=i)}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)}),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}get _isFullyTransparent(){if(this.view.map?.ground?.opacity>0)return!1;for(const e of this.view.allLayerViews.items)if(X.isMapTileLayerView(e)&&!R.isBaseLayer(e.layer)&&0!==e.fullOpacity)return!1;return!0}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if((X.isBlendableLayerView(e)||X.isGroupLayerView(e))&&ie.isCompositeBlendMode(ie.blendModeFromString[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return X.isElevationLayerView(e)?0:1}_registerTiledLayerView(e){const t=[];if((X.isBlendableLayerView(e)||X.isGroupLayerView(e))&&t.push(g.watch(()=>e.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(2)})),!X.isGroupLayerView(e)){const i=this._layerClassFromLayerView(e);t.push(g.watch(()=>!e.destroyed&&e.suspended,()=>this._updateTiledLayers())),t.push(g.watch(()=>!e.destroyed&&e.fullOpacity,()=>this._updateTileTextures(2)));const{layer:r}=e;"effectiveScaleRange"in r&&t.push(g.watch(()=>!e.destroyed&&r.effectiveScaleRange,()=>this._restartAllAgents(i))),t.push(e.on("data-changed",()=>{const t=this.getLayerIndexByUID(i,e.uid);null!=t&&this._invalidateLayerData(t,i)}))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach(e=>{if(!e.layer||e.suspended||!X.isSurfaceLayerView(e)||!e.fullExtent)return;const r=this._layerClassFromLayerView(e);if(1===r){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===i||t>i)&&(i=t)}t[r].push(e)});for(const e of G.LayerClasses){const i=this._layerViews[e],r=t[e];r.reverse();const s=r.length;let a=i.length!==s;const n=new Array(s),l=new Array(i.length);this._layerIndexByUid[e].clear();for(let t=0;t<s;t++){const s=r[t].uid;this._layerIndexByUid[e].set(s,t);const o=i.indexOf(r[t]);n[t]=o,t!==o&&(a=!0),o>-1&&(l[o]=t)}if(a){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;)t.next().modifyLayers(l,n,e);this._layerViews[e]=r,this._restartAllAgents(e),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const i=t.next();i.restartAgents(e),0===e&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(t=>{t.updateAgents(1),1===e?this.renderer.updateTileTexture(t,16):t.updateRenderData(1,e)}),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll(i=>i.removeLayerAgent(e,t)),this._allTiles.forAll(i=>i.invalidateLayerData(e,t))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=1){this.renderer.setNeedsRender(e)}requestUpdate(){1===++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),a=s.layer;return!a.tilemapCache||X.isVectorTileLayerView(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(e.level,e.lij[1],e.lij[2],{...r,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(t=>{throw--this._asyncWorkItems,_.throwIfAborted(r),_.isAbortError(t)||this._dataMissing(e,i,s),t}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,i,s,r),r.signal)))}_requestTileData(e,t,i,r){if(this.destroying)return Promise.resolve();const s=0===t;return r.requester??=s?this._elevationDataRequester:this._mapDataRequester,s?X.isElevationLayerView(i)?this._requestElevationTileData(e,i,r):Promise.reject():X.isMapTileLayerView(i)?this._requestMapTileData(e,i,r):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const r=r=>{!_.isAborted(i)&&r&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(e,t,r))};return t.fetchElevationTile(e,i).then(e=>this._frameTask.schedule(()=>r(e)),i=>{_.isAbortError(i)||(o.getLogger(this).error(`Tile ${e.lij.toString()} layer 0/${t.uid} error ${i}`),this._dataMissing(e,0,t),this.requestUpdate())}).finally(()=>--this._asyncWorkItems)}_elevationDataArrived(e,t,i){const r=this._layerIndexByUid[0].get(t.uid);if(null==r)return void o.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString());const s=new N.ElevationData(e.lij,e.extent,i);e.dataArrived(r,0,s),this.emit("tile-data-changed",{tile:e,layerIndex:r,layerClass:0});const a=[e],n=e.level,l=this._iteratorPool.acquire();for(l.reset(a);!l.done;){const e=l.next();e.findElevationBoundsForLayer(r,n),e.computeElevationBounds()}0===n&&this._updateRootTileElevationBounds(),l.remove(),this._updateTilesVisibility(a)}_requestMapTileData(e,t,i){++this._asyncWorkItems;const r=(r,s)=>{X.releaseTerrainData(s),_.isAborted(i)||(console.error(`Tile ${e.lij.toString()} layer 1/${t.uid} error ${r}`),this._dataMissing(e,1,t),this.requestUpdate())},s=e=>t=>r(t,e);return t.fetchTile(e.lij,i).then(r=>this._frameTask.schedule(()=>{this.requestUpdate(),_.isAborted(i)?X.releaseTerrainData(r):this._mapTileDataArrived(e,t,r)},i.signal,s(r)).catch(s(r)),(e,t=null)=>this._frameTask.schedule(()=>r(e,t))).finally(()=>--this._asyncWorkItems)}_mapTileDataArrived(e,t,i){const r=this.getLayerIndexByUID(1,t.uid);if(null==r)return X.releaseTerrainData(i),void o.getLogger(this).warn("TerrainSurface: received data from unknown layer");e.dataArrived(r,1,i),this.emit("tile-data-changed",{tile:e,layerIndex:r,layerClass:1})}_dataMissing(e,t,i){const r=this.getLayerIndexByUID(t,i.uid);null!=r?(e.dataMissing(r,t),this.emit("tile-data-changed",{tile:e,layerIndex:r,layerClass:t})):o.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(t=>{t.leaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce((e,t)=>e+t.usedMemory,0)):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),r=this.getLayerIndexByUID(i,e.uid);return null!=r&&this._allTiles.forAll(e=>t+=e.getUsedMemoryForLayer(i,r)),t}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){}checkAllTilesWaterproofness(){if(!X.enableWaterproofTests)return;const e=this._rootTiles;if(null==e)return;const t=e=>e?.renderData?.geometry?.indices?.length>0,i=(e,i)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",i.lij,"] has geom")},r=e=>{if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometry&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!e.renderData?.geometry||(e.renderData.geometry.indices?.length??0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometry),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)i(t,e)}else if(e.leaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)r(t)},s=e=>{const t=e.parent?.visible??!0,i=e.visible;e.computeVisibility();const r=e.visible;if(i!==r&&t&&console.error(" Tile[",e.lij,"] has out of date visibility: ",i," instead of ",r),!e.leaf)for(const t of e.children)s(t)};for(const t of e)r(t),s(t)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&0===e[2]}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this._isGlobal)return null;const r=(i+(i<0?t:0))%t;return[e[0],e[1],r]}enableInternalChecks(e){X.enableInternalTerrainChecks(e)}enableWaterproofnessChecks(e){X.enableTerrainWaterproofChecks(e)}static cleanupTerrainSurface(){ue.prune()}enable(e){e!==this._enabled&&(e?(this._updateRootTiles(),this.suspended=!1):(this.suspended=!0,this._removeAllTiles(),this._setRootTiles(null)),this._enabled=e)}};t.__decorate([m.property()],oe.prototype,"_renderer",void 0),t.__decorate([m.property({constructOnly:!0})],oe.prototype,"_scaleRangeQueries",void 0),t.__decorate([m.property({constructOnly:!0})],oe.prototype,"view",void 0),t.__decorate([m.property({constructOnly:!0})],oe.prototype,"overlayManager",void 0),t.__decorate([m.property({constructOnly:!0})],oe.prototype,"terrainTextureCompressionTracker",void 0),t.__decorate([m.property()],oe.prototype,"_hasPendingUpdates",void 0),t.__decorate([m.property()],oe.prototype,"_asyncWorkItems",void 0),t.__decorate([m.property()],oe.prototype,"_allTilesDirty",void 0),t.__decorate([m.property()],oe.prototype,"_allTilesSorted",void 0),t.__decorate([m.property()],oe.prototype,"_viewChanged",void 0),t.__decorate([m.property({type:Number})],oe.prototype,"heading",void 0),t.__decorate([m.property()],oe.prototype,"_splitLimits",void 0),t.__decorate([m.property({readOnly:!0})],oe.prototype,"_watchUpdatingTracking",void 0),t.__decorate([m.property()],oe.prototype,"_frameTask",void 0),t.__decorate([m.property()],oe.prototype,"demResolution",null),t.__decorate([m.property({readOnly:!0})],oe.prototype,"snapLevel",null),t.__decorate([m.property({readOnly:!0})],oe.prototype,"lodSnappingEnabled",null),t.__decorate([m.property()],oe.prototype,"_userClippingExtent",null),t.__decorate([m.property()],oe.prototype,"_rootTilesExtent",void 0),t.__decorate([m.property({readOnly:!0})],oe.prototype,"extent",null),t.__decorate([m.property({readOnly:!0})],oe.prototype,"groundExtent",null),t.__decorate([m.property({readOnly:!0})],oe.prototype,"_tilingSchemeExtent",null),t.__decorate([m.property({readOnly:!0})],oe.prototype,"updating",null),t.__decorate([m.property({readOnly:!0})],oe.prototype,"readyToRun",null),t.__decorate([m.property(B.updatingProgress)],oe.prototype,"updatingProgress",void 0),t.__decorate([m.property({readOnly:!0})],oe.prototype,"updatingProgressValue",null),t.__decorate([m.property()],oe.prototype,"_maxNumUpdating",void 0),t.__decorate([m.property()],oe.prototype,"baseOpacity",null),t.__decorate([m.property()],oe.prototype,"hasCompositeBlendMode",void 0),t.__decorate([m.property({readOnly:!0})],oe.prototype,"viewingMode",null),t.__decorate([m.property()],oe.prototype,"maxTextureScale",void 0),t.__decorate([m.property({readOnly:!0})],oe.prototype,"ready",null),t.__decorate([m.property({readOnly:!0})],oe.prototype,"rootTiles",null),t.__decorate([m.property()],oe.prototype,"_rootTiles",void 0),t.__decorate([m.property({readOnly:!0})],oe.prototype,"spatialReference",null),t.__decorate([m.property({type:i})],oe.prototype,"backgroundColor",null),t.__decorate([m.property({value:!1})],oe.prototype,"slicePlaneEnabled",null),t.__decorate([m.property({readOnly:!0})],oe.prototype,"tilingScheme",void 0),t.__decorate([m.property({readOnly:!0})],oe.prototype,"tilingSchemeLocked",null),t.__decorate([m.property({readOnly:!0})],oe.prototype,"tilingSchemeLogic",void 0),t.__decorate([m.property()],oe.prototype,"wireframe",null),t.__decorate([m.property({value:!1})],oe.prototype,"suspended",null),t.__decorate([m.property()],oe.prototype,"fadeDuration",null),t.__decorate([m.property()],oe.prototype,"visibleElevationBounds",void 0),t.__decorate([m.property()],oe.prototype,"rootTileElevationBounds",void 0),t.__decorate([m.property()],oe.prototype,"_layerViewsDirty",void 0),t.__decorate([m.property()],oe.prototype,"renderPatchBorders",null),t.__decorate([m.property()],oe.prototype,"visualizeNormals",null),t.__decorate([m.property()],oe.prototype,"renderingDisabled",null),oe=le=t.__decorate([T.subclass("esri.views.3d.terrain.TerrainSurface")],oe);const he=oe,de=v.create(),pe=M.create(),ce=E.create(),ue=new u,_e=new I.ElevationUpdateEvent("ground"),ge={spatialReference:null,extent:null,scale:0};function ye(e,t,i){for(const r of e){if(!r.containsPointXY(t,i))continue;let e=r;for(;e&&!e.renderData;){const r=(t>e.extentMidX?1:0)+(i<e.extentMidY?2:0);e=e.children[r]}const s=e?.renderData?.geometryState.samplerData??null;return N.sampleElevation(t,i,s)}return null}class me{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(0===t)return;const i=this._tail;if(!(i+t<=this.capacity))throw new Error("Queue full");for(let r=0;r<t;++r)this._data[i+r]=e[r];this._tail=i+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function Te(e,t){!e.leaf||e.level<Q.maxTileNeighborLevelDelta||be(e,e=>{t&&fe(e);const i=we(e);if(e.maxLevelDeltaNeighborCount++,i){let t=e.parent;for(;t;){const e=we(t);if(t.unmergableChildCount++,!e)break;t=t.parent}}})}function fe(e){if(e.hasPendingUpdate(1))return;let t=e.parent;for(;t?.resetPendingUpdate(4);)t=t.parent;e.resetPendingUpdate(4),e.leaf&&e.setPendingUpdate(1),e.level<Q.maxTileNeighborLevelDelta||be(e,e=>{fe(e)})}function ve(e){e.level<Q.maxTileNeighborLevelDelta||be(e,e=>{if(e.maxLevelDeltaNeighborCount--,0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount){let t=e.parent;for(;t&&(t.unmergableChildCount--,we(t));)t=t.parent}})}function we(e){return 0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount}function be(e,t){if(e.level<Q.maxTileNeighborLevelDelta)return;const i=e.level-Q.maxTileNeighborLevelDelta,r=e.lij[1]>>Q.maxTileNeighborLevelDelta,s=e.lij[2]>>Q.maxTileNeighborLevelDelta,a=e=>e.leaf||e.level===i;for(let n=0;n<4;++n){const l=e.findNeighborTile(X.neighborEdgeIndices[n],a);if(!l||l.level!==i)continue;const o=l.lij;o[1]===r&&o[2]===s||t(l)}}return he});