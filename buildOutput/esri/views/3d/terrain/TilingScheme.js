// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Error","../../../core/has","../../../core/mathUtils","../../../core/unitUtils","../../../geometry/Extent","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/aaBoundingRect","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils","../../../layers/support/LOD","../../../layers/support/TileInfo"],function(e,t,i,s,l,n,r,o,a,h,c,u,g){"use strict";class p{constructor(e){const t=p.checkUnsupported(e);if(null!=t)throw t;const i=e;this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=h.isGeographic(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;const s=i.lods.reduce((e,t)=>(t.level<e.minLod.level&&(e.minLod=t),e.max=Math.max(e.max,t.level),e),{minLod:i.lods[0],max:-1/0}),l=s.minLod,n=2**l.level;let r=l.resolution*n,o=l.scale*n;this.levels=new Array(s.max+1);for(let e=0;e<this.levels.length;e++)this.levels[e]={resolution:r,scale:o,tileSize:[r*i.size[0],r*i.size[1]]},r/=2,o/=2}clone(){return new p(this.toTileInfo())}toTileInfo(){return new g({dpi:this.dpi,origin:new r({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((e,t)=>new u({level:t,scale:e.scale,resolution:e.resolution}))})}getExtent(e,t,i,s){const l=this.levels[e],n=l.tileSize[0],r=l.tileSize[1];s[0]=this.origin[0]+i*n,s[2]=this.origin[0]+(i+1)*n,s[3]=this.origin[1]-t*r,s[1]=this.origin[1]-(t+1)*r}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=c.x2lon(e[0]),t[1]=c.y2lat(e[1]),t[2]=c.x2lon(e[2]),t[3]=c.y2lat(e[3])):this._isGCS&&(t[0]=s.deg2rad(e[0]),t[1]=s.deg2rad(e[1]),t[2]=s.deg2rad(e[2]),t[3]=s.deg2rad(e[3]))}getExtentGeometry(e,t,i,s=new n){return this.getExtent(e,t,i,f),s.spatialReference=this.spatialReference,s.xmin=f[0],s.ymin=f[1],s.xmax=f[2],s.ymax=f[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const{resolution:e,scale:i}=this.levels[this.levels.length-1],s=e/2*this.pixelSize;this.levels.push({resolution:e/2,scale:i/2,tileSize:[s,s]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e,t=1/0){if(p.checkUnsupported(e))return!1;const i=new p(e);if(!i.spatialReference.equals(this.spatialReference))return!1;if(i.pixelSize!==this.pixelSize)return!1;const l=Math.min(this.levels.length-1,i.levels.length-1,t),n=this.levels[l].resolution;let r=.5*n;return!(!s.floatEqualAbsolute(i.origin[0],this.origin[0],r)||!s.floatEqualAbsolute(i.origin[1],this.origin[1],r))&&(r=.5*n/2**l/this.pixelSize*12,s.floatEqualAbsolute(n,i.levels[l].resolution,r))}rootTilesInExtent(e,t=null,i=1/0){const s=new Array,l=this.levels[0].tileSize;if(null==e||0===l[0]||0===l[1])return s;p.computeRowColExtent(e,l,this.origin,f);let n=f[1],r=f[3],o=f[0],a=f[2];const h=a-o,c=r-n;if(h*c>i){const e=Math.floor(Math.sqrt(i));c>e&&(n=n+Math.floor(.5*c)-Math.floor(.5*e),r=n+e),h>e&&(o=o+Math.floor(.5*h)-Math.floor(.5*e),a=o+e)}for(let e=n;e<r;e++)for(let t=o;t<a;t++)s.push([0,e,t]);return null!=t&&(t[0]=this.origin[0]+o*l[0],t[1]=this.origin[1]-r*l[1],t[2]=this.origin[0]+a*l[0],t[3]=this.origin[1]-n*l[1]),s}static computeRowColExtent(e,t,i,s){const l=.001*(e[2]-e[0]+(e[3]-e[1]));s[0]=Math.max(0,Math.floor((e[0]+l-i[0])/t[0])),s[2]=Math.max(0,Math.ceil((e[2]-l-i[0])/t[0])),s[1]=Math.max(0,Math.floor((i[1]-e[3]+l)/t[1])),s[3]=Math.max(0,Math.ceil((i[1]-e[1]-l)/t[1]))}static isPowerOfTwo(e){const t=e.lods,i=t[0].resolution*2**t[0].level;return!t.some(e=>!s.floatEqualRelative(e.resolution,i/2**e.level))}static hasGapInLevels(e){const t=e.lods.map(e=>e.level);t.sort((e,t)=>e-t);for(let e=1;e<t.length;e++)if(t[e]!==t[0]+e)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&!(t&t-1)&&t>=128&&t<=512}static hasOriginPerLODs(e){const t=e.origin;return e.lods.some(e=>null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y))}static getMissingTileInfoError(){return new t("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return null==e?m():e.lods.length<1?new t("tilingscheme:generic","Tiling scheme must have at least one level"):p.isPowerOfTwo(e)?p.hasGapInLevels(e)?new t("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):p.tileSizeSupported(e)?p.hasOriginPerLODs(e)?new t("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new t("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new t("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,t){const i=e[2]-e[0],s=e[3]-e[1],n=l.getMetersPerUnitForSR(t),o=1.2*Math.max(i,s),a=o/256,h=a*n*(96/.0254),c=new p(new g({size:[256,256],origin:new r({x:e[0]-.5*(o-i),y:e[3]+.5*(o-s)}),lods:[new u({level:0,resolution:a,scale:h})],spatialReference:t}));return c.ensureMaxLod(20),c}static makeWebMercatorAuxiliarySphere(e){const t=new p(p.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,i=16){const s=256/t,l=new p(new g({size:[t,t],origin:new r({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new u({level:0,resolution:.703125*s,scale:295497598.570834*s})]}));return l.ensureMaxLod(i),l}static{this.WebMercatorAuxiliarySphereTileInfo=new g({size:[256,256],origin:new r({x:-20037508.342787,y:20037508.342787,spatialReference:o.WebMercator}),spatialReference:o.WebMercator,lods:[new u({level:0,resolution:156543.03392800014,scale:591657527.591555})]})}static{this.WebMercatorAuxiliarySphere=p.makeWebMercatorAuxiliarySphere(19)}get test(){}}function m(){return new t("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}const f=a.create();e.TilingScheme=p,e.getMissingTileInfoError=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});