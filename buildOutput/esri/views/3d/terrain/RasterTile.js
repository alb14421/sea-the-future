// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/maybe","../../../chunks/RasterColorizer.glsl","../../webgl/rasterUtils"],function(e,t,r,s){"use strict";const i={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};e.RasterTile=class{constructor(e,t,r=null,s=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=t,this.width=r||t.width,this.height=s||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=t.disposeMaybe(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...i,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||i}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){null!=e&&e.length>0?this._bandIds&&e.every((e,t)=>!!this._bandIds?.[t]&&e===this._bandIds[t])||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,null!=this._rasterTexture){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode("bilinear"===t?9729:9728)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=t.disposeMaybe(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((null==this._rasterTexture||this._dirty)&&this._updateRasterTexture(e,this.bandIds),null!=this._rasterTexture&&(this._updateColormapTexture(e),this.transformGrid&&null==this._transformGridTexture&&(this._transformGridTexture=s.createTransformTexture(e,this.transformGrid))),!0)}getUniforms(e){const{symbolizerParameters:t,transformGrid:i,width:o,height:a,opacity:l}=this,n=s.getCommonUniforms(i,[o,a],[this.source.width,this.source.height],l),h=s.getColormapUniforms(t.colormap,t.colormapOffset),u="stretch"===this.symbolizerParameters.type?s.getStretchUniforms(this.symbolizerParameters):null,m="hillshade"===this.symbolizerParameters.type?s.getShadedReliefUniforms(this.symbolizerParameters):null,d=e.emptyTexture;return new r.ColorizerUniforms(n,h,u||m,this._rasterTexture??d,this._transformGridTexture??d,this._colormapTexture??d)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return"bilinear"===this.interpolation&&null!=e.colormap&&"stretch"===e.type}get memoryUsage(){if(null==this._memoryUsed){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(e=>null!=e?e.descriptor.width*e.descriptor.height*4:0).reduce((e,t)=>e+t,0)}return this._memoryUsed}release(){return this._rasterTexture=t.disposeMaybe(this._rasterTexture),this._transformGridTexture=t.disposeMaybe(this._transformGridTexture),this._colormapTexture=t.disposeMaybe(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,r){const i=this.source?this.source.extractBands(r):null;if(!(i?.pixels&&i.pixels.length>0))return void(this._rasterTexture=t.disposeMaybe(this._rasterTexture));const o=null==r&&null==this.bandIds||null!=r&&null!=this.bandIds&&r.join("")===this.bandIds.join("");if(null!=this._rasterTexture&&o)return;this._rasterTexture=t.disposeMaybe(this._rasterTexture);const a=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=s.createRasterTexture(e,i,a,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType}_getRasterTextureInterpolation(e){return"lut"===this.symbolizerParameters.type||"nearest"===e||"majority"===e||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const r=this._colormap,i=this.symbolizerParameters.colormap;return i?r?i.length!==r.length||i.some((e,t)=>e!==r[t])?(this._colormapTexture=t.disposeMaybe(this._colormapTexture),this._colormapTexture=s.createColormapTexture(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=s.createColormapTexture(e,i),void(this._colormap=i)):(this._colormapTexture=t.disposeMaybe(this._colormapTexture),void(this._colormap=null))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});