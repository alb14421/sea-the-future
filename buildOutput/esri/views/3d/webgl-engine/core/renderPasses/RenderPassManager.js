// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Logger","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./AllRenderPasses","../util/TwoVectorPosition","../../effects/RenderPlugin","../../lib/DepthRange"],function(s,e,t,a,r,i,n,o,h,c,u,l,m,d,P,p){"use strict";s.RenderPassManager=class extends P.SyncRenderPlugin{constructor(){super({}),this.produces=new Map([[2,s=>this._produces(s,2)],[4,s=>this._produces(s,4)],[0,s=>this._produces(s,0)],[7,s=>this._produces(s,7)],[9,s=>this._produces(s,9)]]),this._materialPassParameters=new m.MaterialPassParameters,this._shadowPassParameters=new m.ShadowMapPassParameters,this._highlightPassParameters=new m.HighlightPassParameters,this._viewshedPassParameters=new m.ViewshedShadowMapPassParameters,this._systems=new Set}initializeRenderContext(s){this._context=s,this._passes=new m.AllRenderPasses(s)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear(),this._passes=null}register(s){this._systems.add(s)}_produces(s,e){return!!this._invoke(s,e,s=>s.count>0)}prepareRender(s){const{_systems:e,_passes:t}=this;if(0!==e.size&&null!=t){for(const s of Object.values(t))s.prepareSubmit();e.forEach(e=>e.submit(t,s.bind));for(const s of Object.values(t))s.finishSubmit()}}acquireTechniques(s){if(0===this._systems.size)return null;const e=4===s.output||5===s.output||6===s.output?this._shadowPassParameters:7===s.output?this._viewshedPassParameters:8===s.output?this._highlightPassParameters:this._materialPassParameters,t=s.bind;return this._updateParameters(t.camera,e,t.slot),this._materialPassParameters.output=s.output,this._invoke(s.output,s.bind.slot,(e,t)=>e.acquire(t,s.bind))}render(s,e){this._invoke(s.output,s.bind.slot,(t,a)=>t.dispatch(a,s.bind,e))}_invoke(s,e,t){if(null==this._passes)return null;switch(e){case 2:switch(s){case 0:case 1:case 2:case 3:case 9:return t(this._passes.opaque,this._materialPassParameters);case 8:return t(this._passes.highlight,this._highlightPassParameters);case 4:return t(this._passes.shadowMap,this._shadowPassParameters);case 5:return t(this._passes.highlightShadowMap,this._shadowPassParameters);case 6:return t(this._passes.defaultShadowMap,this._shadowPassParameters);case 7:return t(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case 4:switch(s){case 0:case 1:case 2:case 3:case 9:return t(this._passes.transparent,this._materialPassParameters)}break;case 0:switch(s){case 0:case 1:case 2:case 3:case 9:return t(this._passes.integratedMesh,this._materialPassParameters);case 8:return t(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}break;case 7:switch(s){case 0:case 1:return t(this._passes.transparentIntegratedMesh,this._materialPassParameters)}break;case 9:switch(s){case 0:case 1:case 2:case 3:case 9:return t(this._passes.occludedGround,this._materialPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(s){const e=new p.DepthRange;return this._systems.forEach(t=>e.union(t.queryDepthRange(s))),e}get hasEmissions(){let s=!1;return this._systems.forEach(e=>s=e.hasEmissions||s),s}_updateParameters(s,e,t){const a=s.viewInverseTransposeMatrix,r=4===t,i=9===t;u.set(_,a[3],a[7],a[11]),w.set(_),u.copy(e.transformWorldFromViewTH,w.high),u.copy(e.transformWorldFromViewTL,w.low),u.copy(e.slicePlaneLocalOrigin,_),o.fromMat4(e.transformViewFromCameraRelativeRS,s.viewMatrix),c.copy(e.transformProjFromView,s.projectionMatrix),0===e.identifier&&(this._materialPassParameters.transparent=r,this._materialPassParameters.occludedGround=i,o.transpose(g,e.transformViewFromCameraRelativeRS),o.invert(e.transformNormalViewFromGlobal,g))}hasHighlight(s){for(const e of this._systems)if(e.hasHighlight(s))return!0;return!1}},s.RenderPassManager=e.__decorate([n.subclass("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],s.RenderPassManager);const _=l.create(),g=h.create(),w=new d.TwoVectorPosition;Object.defineProperty(s,Symbol.toStringTag,{value:"Module"})});