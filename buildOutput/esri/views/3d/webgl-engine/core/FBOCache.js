// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Error","../../webgl/ManagedColorAttachment","../../webgl/ManagedDepthTexture","../../webgl/ManagedFBO","./FBOCacheFormats","./FBOPool","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture"],function(e,t,a,r,c,h,n,o,i,s){"use strict";function l(e,t=0){return`${e}.color${t}`}function u(e){return`${e}.depth`}const d=new c("default","default",null,()=>d,()=>d,()=>{});function m(e,t,a){return`${t}x${a}:${e}`}d.release=()=>!1,e.FBOCache=class{constructor(e){this.rctx=e,this._interactive=!1,this._acquired=new Set,this._cache=new n.FBOPool(e.newCache,"FBOCache"),this._depthCache=new n.FBOPool(e.newCache,"DepthAttachmentCache"),this._colorCache=new n.FBOPool(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.()}frameEnd(){const{debugCallback:e}=this;e&&this._acquired.forEach(t=>e(t.name,t.fbo))}get usedMemory(){return Array.from(this._acquired.values()).reduce((e,t)=>e+t.cachedMemory,this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e,this._interactive=e}get interactive(){return this._interactive}acquire(e,a,r,n=5){const s=m(n,e,a);let d=this._cache.pop(s);const{rctx:C}=this;if(d){d.retain(),d.setName(r);const e=d.getAttachment(o.DepthStencilAttachment);e&&(e.name=u(r));const a=d.getAttachment(o.ColorAttachment0);a&&(a.name=l(r,0));const{fbo:c}=d;if(!c)throw new t("renderer","attempt to use a none existing framebuffer");C.temporaryBindFramebufferObject(c,()=>{C.setDrawBuffers([o.ColorAttachment0]),C.unbindTexture(c.colorTexture)})}else{const t=new i.FramebufferObject(C),m=(t,r,c)=>{r??=5;const h=this._acquireColor(r,e,a,c??l(d.name,t-o.ColorAttachment0));return this.rctx.unbindTexture(h.attachment),d.attachColor(h,t),h.release(),d},f=t=>{t??=11;const r=this.acquireDepth(t,e,a,u(d.name));return d.attachDepth(r),r.release(),d},p=()=>{if(!d)return;this.debugCallback?.(d.name,d.fbo),this._acquired.delete(d);const e=h.isDepthFormat(n);e&&null!=d.getAttachment(o.DepthStencilAttachment)||!e&&null!=d.getAttachment(o.ColorAttachment0)?(e?(d.fbo?.invalidateAttachments([o.DepthStencilAttachment]),d.detachAllColors()):(d.fbo?.invalidateAttachments([o.ColorAttachment0]),d.detachAllButColor0()),this._cache.put(d)):d.dispose()};d=new c(s,r,t,m,f,p),h.isDepthFormat(n)?d.acquireDepth(n):d.acquireColor(o.ColorAttachment0,n,r)}return this._trackHandle(d)}acquireDepth(e,t,a,c){const n=m(e,t,a);let o=this._depthCache.pop(n);if(o)o.retain(),o.attachment.setShadowFiltering(!1);else{const c=new s.Texture(this.rctx,{...h.DepthTextureFormats[e],width:t,height:a});o=new r.ManagedDepthTexture(n,c,()=>this._depthCache.put(o))}return o.name=c,o}_acquireColor(e,t,r,c){const n=m(e,t,r);let o=this._colorCache.pop(n);if(o)o.retain();else{const c=new s.Texture(this.rctx,{...h.ColorFormats[e],width:t,height:r});o=new a.ManagedColorAttachment(n,c,()=>this._colorCache.put(o))}return o.name=c,o}_trackHandle(e){return this._acquired.add(e),e}},e.defaultWebGLFBO=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});