// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../core/shaderLibrary/ShaderOutput","../lib/GLTextureMaterial","../lib/Material","../lib/OrderIndependentTransparency","../lib/RayIntersections","../lib/verticalOffsetUtils","./DefaultBufferWriter","./internal/MaterialUtil","../shaders/DefaultMaterialTechnique","../shaders/DefaultMaterialTechniqueConfiguration","../shaders/RealisticTreeTechnique","../../../../webscene/support/AlphaCutoff"],function(e,t,r,s,a,i,n,o,l,u,c,h,m,p,d){"use strict";class T extends i.Material{constructor(e,t){super(e,x),this.materialType="default",this.supportsEdges=!0,this.intersectDraped=void 0,this.produces=new Map([[2,e=>(s.is3DGeometryOutputMRT(e)||s.isShadowRelatedOutput(e))&&!this.transparent],[4,e=>(s.is3DGeometryOutputMRT(e)||s.isShadowRelatedOutput(e))&&this.transparent&&this.parameters.writeDepth],[8,e=>(s.is3DGeometryOutputMRT(e)||s.isShadowRelatedOutput(e))&&this.transparent&&!this.parameters.writeDepth]]),this._layout=h.getLayout(this.parameters),this._configuration=new m.DefaultMaterialTechniqueConfiguration(t.spherical)}isVisibleForOutput(e){return 4!==e&&6!==e&&5!==e||this.parameters.castShadows}get visible(){const{layerOpacity:e,colorMixMode:t,opacity:r,externalColor:s}=this.parameters;return e*("replace"===t?1:r)*("ignore"===t||isNaN(s[3])?1:s[3])>=d.alphaCutoff}get _hasEmissiveBase(){return!!this.parameters.emissiveTextureId||!t.exactEquals(this.parameters.emissiveBaseColor,r.ZEROS)}get hasEmissions(){return this.parameters.emissiveStrength>0&&(0===this.parameters.emissiveSource&&this._hasEmissiveBase||1===this.parameters.emissiveSource)}getConfiguration(e,t){const{parameters:r,_configuration:a}=this,{treeRendering:i,doubleSided:o,doubleSidedType:l}=r;return super.getConfiguration(e,t,this._configuration),a.hasNormalTexture=r.hasNormalTexture,a.hasColorTexture=r.hasColorTexture,a.hasMetallicRoughnessTexture=r.hasMetallicRoughnessTexture,a.hasOcclusionTexture=r.hasOcclusionTexture,a.hasVertexTangents=!i&&r.hasVertexTangents,a.instanced=r.instanced,a.instancedDoublePrecision=r.instancedDoublePrecision,a.hasVVColor=!!r.vvColor,a.hasVVSize=!!r.vvSize,a.hasVerticalOffset=null!=r.verticalOffset,a.hasScreenSizePerspective=null!=r.screenSizePerspective,a.hasSlicePlane=r.hasSlicePlane,a.alphaDiscardMode=r.textureAlphaMode,a.normalType=i?0:r.normalType,a.transparent=this.transparent,a.writeDepth=r.writeDepth,a.customDepthTest=r.customDepthTest??0,a.hasOccludees=t.hasOccludees,a.cullFace=r.hasSlicePlane?0:r.cullFace,a.cullAboveTerrain=t.cullAboveTerrain,a.hasModelTransformation=!i&&null!=r.modelTransformation,a.hasVertexColors=r.hasVertexColors,a.hasSymbolColors=r.hasSymbolColors,a.doubleSidedMode=i?2:o&&"normal"===l?1:o&&"winding-order"===l?2:0,a.instancedFeatureAttribute=r.instancedFeatureAttribute,a.instancedColor=r.instancedColor,s.isColorOrColorEmission(e)?(a.terrainDepthTest=t.terrainDepthTest,a.receiveShadows=r.receiveShadows,a.receiveAmbientOcclusion=r.receiveAmbientOcclusion&&null!=t.ssao):(a.terrainDepthTest=!1,a.receiveShadows=a.receiveAmbientOcclusion=!1),a.textureAlphaPremultiplied=!!r.textureAlphaPremultiplied,a.pbrMode=r.usePBR?r.isSchematic?2:1:0,a.emissionSource=r.emissionSource,a.offsetBackfaces=!(!this.transparent||!r.offsetTransparentBackfaces),a.oitPass=t.oitPass,a.enableOffset=t.camera.relativeElevation<n.OITPolygonOffsetLimit,a.snowCover=t.snowCover,a.hasBloom=s.isColorEmission(e),a.hasColorTextureTransform=!!r.colorTextureTransformMatrix,a.hasNormalTextureTransform=!!r.normalTextureTransformMatrix,a.hasEmissionTextureTransform=!!r.emissiveTextureTransformMatrix,a.hasOcclusionTextureTransform=!!r.occlusionTextureTransformMatrix,a.hasMetallicRoughnessTextureTransform=!!r.metallicRoughnessTextureTransformMatrix,a}intersect(e,r,s,a,i,n){if(null!=this.parameters.verticalOffset){const e=s.camera;t.set(y,r[12],r[13],r[14]);let n=null;switch(s.viewingMode){case 1:n=t.normalize(O,y);break;case 2:n=t.copy(O,S)}let o=0;const l=t.subtract(D,y,e.eye),u=t.length(l),h=t.scale(l,l,1/u);let m=null;this.parameters.screenSizePerspective&&(m=t.dot(n,h)),o+=c.verticalOffsetAtDistance(e,u,this.parameters.verticalOffset,m??0,this.parameters.screenSizePerspective),t.scale(n,n,o),t.transformMat3(b,n,s.transform.inverseRotation),a=t.subtract(v,a,b),i=t.subtract(M,i,b)}o.intersectTriangleGeometry(e,s,a,i,l.getVerticalOffsetObject3D(s.verticalOffset),n)}createGLMaterial(e){return new f(e)}createBufferWriter(){return new u.DefaultBufferWriter(this._layout)}get transparent(){return g(this.parameters)}}class f extends a.GLTextureMaterial{constructor(e){super({...e,...e.material.parameters})}beginSlot(e){this._material.setParameters({receiveShadows:e.shadowMap.enabled});const r=this._material.parameters;this.updateTexture(r.textureId);const s=e.camera.viewInverseTransposeMatrix;return t.set(r.origin,s[3],s[7],s[11]),this._material.setParameters(this.textureBindParameters),this.getTechnique(r.treeRendering?p.RealisticTreeTechnique:h.DefaultMaterialTechnique,e)}}class x extends h.DefaultMaterialPassParameters{constructor(){super(...arguments),this.treeRendering=!1,this.hasVertexTangents=!1}get hasNormalTexture(){return!this.treeRendering&&!!this.normalTextureId}get hasColorTexture(){return!!this.textureId}get hasMetallicRoughnessTexture(){return!this.treeRendering&&!!this.metallicRoughnessTextureId}get hasOcclusionTexture(){return!this.treeRendering&&!!this.occlusionTextureId}get emissionSource(){return this.treeRendering?0:null!=this.emissiveTextureId&&0===this.emissiveSource?3:this.usePBR?0===this.emissiveSource?2:1:0}get hasTextures(){return this.hasColorTexture||this.hasNormalTexture||this.hasMetallicRoughnessTexture||3===this.emissionSource||this.hasOcclusionTexture}}function g(e){const{drivenOpacity:t,opacity:r,externalColor:s,layerOpacity:a,texture:i,textureId:n,textureAlphaMode:o,colorMixMode:l}=e,u=s[3];return t||r<1&&"replace"!==l||u<1&&"ignore"!==l||a<1||(null!=i||null!=n)&&1!==o&&2!==o&&"replace"!==l}const v=r.create(),M=r.create(),S=r.fromValues(0,0,1),O=r.create(),b=r.create(),y=r.create(),D=r.create();e.DefaultGLMaterial=f,e.DefaultMaterial=T,e.DefaultMaterialParameters=x,e.isTransparent=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});