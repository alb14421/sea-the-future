// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/time","../../../../core/libs/gl-matrix-2/math/vec2","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/float16","../../../../geometry/support/lineSegment","../../../../geometry/support/plane","../core/shaderLibrary/ShaderOutput","../effects/geometry/olidUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./VisualVariablePassParameters","./internal/bufferWriterUtils","../../../../chunks/RibbonLine.glsl","../shaders/RibbonLineTechnique","../shaders/RibbonLineTechniqueConfiguration","../../../../webscene/support/AlphaCutoff"],function(e,t,i,r,s,a,n,o,l,c,h,p,u,m,d,f,g,b,S,_,P,y,v){"use strict";class E extends f.Material{constructor(e){super(e,w),this._configuration=new y.RibbonLineTechniqueConfiguration,this.produces=new Map([[2,e=>u.isHighlightOrOID(e)||u.isColorOrColorEmission(e)&&8===this.parameters.renderOccluded],[3,e=>u.isDepth(e)],[10,e=>u.isColorEmissionHighlightOIDOrDepth(e)&&8===this.parameters.renderOccluded],[11,e=>u.isColorEmissionHighlightOIDOrDepth(e)&&8===this.parameters.renderOccluded],[4,e=>u.isColorOrColorEmission(e)&&this.parameters.writeDepth&&8!==this.parameters.renderOccluded],[8,e=>u.isColorOrColorEmission(e)&&!this.parameters.writeDepth&&8!==this.parameters.renderOccluded],[18,e=>u.is2DGeometryOutput(e)]])}getConfiguration(e,t){super.getConfiguration(e,t,this._configuration),this._configuration.oitPass=t.oitPass,this._configuration.draped=18===t.slot;const i=null!=this.parameters.stipplePattern&&8!==e;var r;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&null!=this.parameters.stippleOffColor,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=null!=this.parameters.markerParameters&&1===(r=this.parameters.markerParameters).anchor&&r.hideOnShortSegments&&"begin-end"===r.placement&&r.worldSpace,this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&null!=this.parameters.innerColor,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.hasOccludees=t.hasOccludees,this._configuration.occluder=8===this.parameters.renderOccluded,this._configuration.terrainDepthTest=t.terrainDepthTest&&u.isColorOrColorEmission(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.wireframe=this.parameters.wireframe,this._configuration.animation=this.parameters.animation,this._configuration.emissionSource=this.hasEmissions?1:0,this._configuration}get visible(){return this.parameters.color[3]>=v.alphaCutoff||null!=this.parameters.stipplePattern&&(this.parameters.stippleOffColor?.[3]??0)>v.alphaCutoff}setParameters(e,t){e.animation=this.parameters.animation,super.setParameters(e,t)}intersectDraped({attributes:e,screenToWorldRatio:t},r,s,a,n){if(!r.options.selectionMode)return;const o=e.get("size");let l=this.parameters.width;if(this.parameters.vvSize){const t=e.get("sizeFeatureAttribute").data[0];Number.isNaN(t)?l*=this.parameters.vvSize.fallback[0]:l*=i.clamp(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o&&(l*=o.data[0]);const c=s[0],h=s[1],p=(l/2+4)*t;let u=Number.MAX_VALUE,m=0;const d=e.get("position").data,f=M(this.parameters,e)?d.length-2:d.length-5;for(let e=0;e<f;e+=3){const t=d[e],r=d[e+1],s=(e+3)%d.length,a=c-t,n=h-r,o=d[s]-t,l=d[s+1]-r,p=o*a+l*n,f=o*o+l*l,g=i.clamp(p/f,0,1),b=o*g-a,S=l*g-n,_=b*b+S*S;_<u&&(u=_,m=e/3)}u<p*p&&a(n.distance,n.normal,m)}intersect(e,r,s,o,l,c){const{options:u,camera:m,rayBegin:d,rayEnd:f}=s;if(!u.selectionMode||!e.visible||!m)return;if(!g.isTranslationMatrix(r))return void t.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const b=e.attributes,S=b.get("position").data;let _=this.parameters.width;if(this.parameters.vvSize){const e=b.get("sizeFeatureAttribute").data[0];Number.isNaN(e)||(_*=i.clamp(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0]))}else b.has("size")&&(_*=b.get("size").data[0]);const P=L;a.copy(P,s.point);const y=_*m.pixelRatio/2+4*m.pixelRatio;n.set(q[0],P[0]-y,P[1]+y,0),n.set(q[1],P[0]+y,P[1]+y,0),n.set(q[2],P[0]+y,P[1]-y,0),n.set(q[3],P[0]-y,P[1]-y,0);for(let e=0;e<4;e++)if(!m.unprojectFromRenderScreen(q[e],Y[e]))return;p.fromPoints(m.eye,Y[0],Y[1],G),p.fromPoints(m.eye,Y[1],Y[2],H),p.fromPoints(m.eye,Y[2],Y[3],I),p.fromPoints(m.eye,Y[3],Y[0],X);let v=Number.MAX_VALUE,E=0;const C=M(this.parameters,b)?S.length-2:S.length-5;for(let e=0;e<C;e+=3){T[0]=S[e]+r[12],T[1]=S[e+1]+r[13],T[2]=S[e+2]+r[14];const t=(e+3)%S.length;if(D[0]=S[t]+r[12],D[1]=S[t+1]+r[13],D[2]=S[t+2]+r[14],p.signedDistance(G,T)<0&&p.signedDistance(G,D)<0||p.signedDistance(H,T)<0&&p.signedDistance(H,D)<0||p.signedDistance(I,T)<0&&p.signedDistance(I,D)<0||p.signedDistance(X,T)<0&&p.signedDistance(X,D)<0)continue;if(m.projectToRenderScreen(T,V),m.projectToRenderScreen(D,F),V[2]<0&&F[2]>0){n.subtract(R,T,D);const e=m.frustum,t=-p.signedDistance(e[4],T)/n.dot(R,p.getNormal(e[4]));n.scale(R,R,t),n.add(T,T,R),m.projectToRenderScreen(T,V)}else if(V[2]>0&&F[2]<0){n.subtract(R,D,T);const e=m.frustum,t=-p.signedDistance(e[4],D)/n.dot(R,p.getNormal(e[4]));n.scale(R,R,t),n.add(D,D,R),m.projectToRenderScreen(D,F)}else if(V[2]<0&&F[2]<0)continue;V[2]=0,F[2]=0;const i=h.distance2(h.fromPoints(V,F,k),P);i<v&&(v=i,n.copy(x,T),n.copy(N,D),E=e/3)}if(v<y*y){let e=Number.MAX_VALUE;if(h.closestLineSegmentPoint(h.fromPoints(x,N,k),h.fromPoints(d,f,j),z)){n.subtract(z,z,d);const t=n.length(z);n.scale(z,z,1/t),e=t/n.distance(d,f)}c(e,z,E)}}get hasEmissions(){return this.parameters.emissiveStrength>0}createBufferWriter(){return new A(P.getLayout(this.parameters),this.parameters)}createGLMaterial(e){return new C(e)}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),null!=e.markerParameters&&(e.markerScale=e.markerParameters.width/e.width)}update(e){const{hasAnimation:t,animationSpeed:i}=this.parameters;return!!t&&(this.setParameters({timeElapsed:s.secondsFromMilliseconds(e.time)*i},!1),0!==e.dt)}}class C extends d{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures?.release(this._stipplePattern),this._stipplePattern=null}beginSlot(e){const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.getTechnique(P.RibbonLineTechnique,e)}}class w extends b.VisualVariablePassParameters{constructor(){super(...arguments),this.width=0,this.color=l.ONES,this.join="miter",this.cap=0,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.wireframe=!1,this.timeElapsed=0,this.animation=0,this.animationSpeed=1,this.trailLength=1,this.emissiveStrength=0}get transparent(){return this.color[3]<1||this.hasAnimation||null!=this.stipplePattern&&(this.stippleOffColor?.[3]??0)<1}get hasAnimation(){return 0!==this.animation}}class A{constructor(e,t){this.layout=e,this._parameters=t;const i=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=_.ribbonlineNumRoundJoinSubdivisions+i}}_isClosed(e){return M(this._parameters,e)}allocate(e){return this.layout.createBuffer(e)}elementCount(e){const t=e.get("position").indices.length/2+1,i=this._isClosed(e);let r=i?2:4;return r+=((i?t:t-1)-(i?0:1))*(2*this.numJoinSubdivisions+4),r+=2,this._parameters.wireframe&&(r=2+4*(r-2)),r}write(e,t,i,r,s,a){const o=i.get("position"),l=o.indices,h=o.data.length/3,p=i.get("distanceToStart")?.data;l&&l.length!==2*(h-1)&&console.warn("RibbonLineMaterial does not support indices");const u=(this.layout.fields.has("sizeFeatureAttribute")?i.get("sizeFeatureAttribute")?.data[0]:i.get("size")?.data[0])??1;let d=[1,1,1,1],f=0;const g=this.layout.fields.has("colorFeatureAttribute");g?f=i.get("colorFeatureAttribute").data[0]:i.has("color")&&(d=i.get("color").data);const b=i.get("timeStamps")?.data,_=b&&this.layout.fields.has("timeStamps"),P=this.layout.fields.has("opacityFeatureAttribute"),y=P?i.get("opacityFeatureAttribute").data[0]:0,v=new Float32Array(s.buffer),E=c.makeFloat16Array(s.buffer),C=new Uint8Array(s.buffer),w=this.layout.stride/4;let A=a*w;const M=A;let T=0;const D=p?(e,t,i)=>T=p[i]:(e,t,i)=>T+=n.distance(e,t),R=v.BYTES_PER_ELEMENT/E.BYTES_PER_ELEMENT,z=4/R,L=(e,t,i,s,a,n,o,l)=>{v[A++]=t[0],v[A++]=t[1],v[A++]=t[2],S.writeDeltaF16Vector(e,t,E,A*R),A+=z,S.writeDeltaF16Vector(i,t,E,A*R),A+=z,v[A++]=l;let c=A*R;if(E[c++]=a,E[c++]=n,A=Math.ceil(c/R),g)v[A]=f;else{const e=Math.min(4*o,d.length-4),t=4*A;C[t]=255*d[e],C[t+1]=255*d[e+1],C[t+2]=255*d[e+2],C[t+3]=255*d[e+3]}if(A++,v[A++]=u,P&&(v[A++]=y),m.olidEnabled()){let e=4*A;r?(C[e++]=r[0],C[e++]=r[1],C[e++]=r[2],C[e++]=r[3]):(C[e++]=0,C[e++]=0,C[e++]=0,C[e++]=0),A=Math.ceil(.25*e)}_&&(c=A*R,E[c++]=s[0],E[c++]=s[1],E[c++]=s[2],A=Math.ceil(c/R))};A+=w,n.set(B,o.data[0],o.data[1],o.data[2]),_&&n.set(J,b[0],b[1],b[2]),e&&n.transformMat4(B,B,e);const V=this._isClosed(i);if(V){const t=o.data.length-3;n.set(U,o.data[t],o.data[t+1],o.data[t+2]),e&&n.transformMat4(U,U,e)}else n.set(W,o.data[3],o.data[4],o.data[5]),e&&n.transformMat4(W,W,e),L(B,B,W,J,1,-4,0,0),L(B,B,W,J,1,4,0,0),n.copy(U,B),n.copy(B,W),_&&n.set(J,b[3],b[4],b[5]);const F=V?0:1,x=V?h:h-1;for(let t=F;t<x;t++){const i=(t+1)%h*3;n.set(W,o.data[i],o.data[i+1],o.data[i+2]),e&&n.transformMat4(W,W,e),D(U,B,t),L(U,B,W,J,0,-1,t,T),L(U,B,W,J,0,1,t,T);const r=this.numJoinSubdivisions;for(let e=0;e<r;++e){const i=(e+1)/(r+1);L(U,B,W,J,i,-1,t,T),L(U,B,W,J,i,1,t,T)}L(U,B,W,J,1,-2,t,T),L(U,B,W,J,1,2,t,T),n.copy(U,B),n.copy(B,W),_&&n.set(J,b[i],b[i+1],b[i+2])}return V?(n.set(W,o.data[3],o.data[4],o.data[5]),e&&n.transformMat4(W,W,e),T=D(U,B,x),L(U,B,W,J,0,-1,F,T),L(U,B,W,J,0,1,F,T)):(T=D(U,B,x),L(U,B,B,J,0,-5,x,T),L(U,B,B,J,0,5,x,T)),O(v,M+w,v,M,w),A=O(v,A-w,v,A,w),this._parameters.wireframe&&this._addWireframeVertices(s,M,A,w),null}_addWireframeVertices(e,t,i,r){const s=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,i-t);let n=0;const o=e=>n=O(a,e,s,n,r);for(let e=0;e<a.length-1;e+=2*r)o(e),o(e+2*r),o(e+1*r),o(e+2*r),o(e+1*r),o(e+3*r)}}function O(e,t,i,r,s){for(let a=0;a<s;a++)i[r++]=e[t++];return r}function M(e,t){return!!e.isClosed&&t.get("position").indices.length>2}const T=o.create(),D=o.create(),R=o.create(),z=o.create(),L=o.create(),V=r.createRenderScreenPointArray3(),F=r.createRenderScreenPointArray3(),x=o.create(),N=o.create(),k=h.create(),j=h.create(),U=o.create(),B=o.create(),W=o.create(),J=o.create(),q=[r.createRenderScreenPointArray3(),r.createRenderScreenPointArray3(),r.createRenderScreenPointArray3(),r.createRenderScreenPointArray3()],Y=[o.create(),o.create(),o.create(),o.create()],G=p.create(),H=p.create(),I=p.create(),X=p.create();e.Parameters=w,e.RibbonLineMaterial=E,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});