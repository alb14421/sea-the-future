// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../core/shaderLibrary/ShaderOutput","../lib/GLMaterial","../lib/Material","../lib/PathGeometry","../lib/RayIntersections","./DefaultBufferWriter","./PathTechnique","./PathTechniqueConfiguration","../../../../webscene/support/AlphaCutoff"],function(e,t,i,s,r,a,o,n,h,u,c,p,l,d){"use strict";class f extends n.Material{constructor(e,t){super(e,g),this.supportsEdges=!0,this._pp0=s.fromValues(0,0,1),this._pp1=s.fromValues(0,0,0),this.produces=new Map([[2,e=>(this.parameters.castShadows&&a.isShadowRelatedOutput(e)||a.is3DGeometryOutputMRT(e))&&!this.transparent],[4,e=>(this.parameters.castShadows&&a.isShadowRelatedOutput(e)||a.is3DGeometryOutputMRT(e))&&this.transparent]]),this._configuration=new l.PathTechniqueConfiguration(t.spherical)}get hasEmissions(){return this.parameters.emissiveStrength>0}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.transparent,this._configuration.hasOccludees=t.hasOccludees,a.isColorOrColorEmission(e)?(this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?1:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?2:0,this._configuration.receiveShadows=t.shadowMap.enabled,this._configuration.receiveAmbientOcclusion=null!=t.ssao):this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.pbrMode=this.parameters.usePBR?2:0,this._configuration.emissionSource=this.parameters.usePBR?1:0,this._configuration.hasBloom=a.isColorEmission(e),this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.snowCover=t.snowCover,this._configuration}isVisibleForOutput(e){return 4!==e&&6!==e&&5!==e||this.parameters.castShadows}get visible(){return this.parameters.opacity>=d.alphaCutoff}intersect(e,t,i,s,r,a){this._intersect(e,i,s,r,a)}intersectDraped(e,t,i,s){return this._pp0[0]=this._pp1[0]=i[0],this._pp0[1]=this._pp1[1]=i[1],this._intersect(e,t,this._pp0,this._pp1,s)}_intersect(e,s,a,o,n){const c=e;if(!h.isPathGeometry(c))return;const p=c.path,l=i.clone(this.parameters.size);if(this.parameters.vvSize){const{offset:e,factor:i,minSize:s,maxSize:r,fallback:a}=this.parameters.vvSize,o=p.sizeAttributeValue;Number.isNaN(o)?(l[0]*=a[0],l[1]*=a[2]):(l[0]*=t.clamp(e[0]+o*i[0],s[0],r[0]),l[1]*=t.clamp(e[2]+o*i[2],s[2],r[2]))}const d=new u.MeshIntersectionOptions(!1,s.options.normalRequired),f=Math.max(l[0],l[1]),m=e.boundingInfo;if(null==m)return void b(p,l,a,o,d,n);const g=r.fromValues(m.bbMin[0]-f,m.bbMin[1]-f,m.bbMin[2]-f,m.bbMax[0]+f,m.bbMax[1]+f,m.bbMax[2]+f),_=[o[0]-a[0],o[1]-a[1],o[2]-a[2]],S=Math.sqrt(_[0]*_[0]+_[1]*_[1]+_[2]*_[2]),v=[S/_[0],S/_[1],S/_[2]];u.intersectAabbInvDir(g,a,v,s.tolerance)&&b(p,l,a,o,d,n)}createBufferWriter(){return new c.DefaultBufferWriter(p.getLayout(this.parameters))}createGLMaterial(e){return new m(e)}get transparent(){const{parameters:e}=this;return e.drivenOpacity||e.opacity<1}}class m extends o{beginSlot(e){return this.getTechnique(p.PathTechnique,e)}}function b(e,t,i,s,r,a){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,s,r,a)}class g extends p.PathPassParameters{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.castShadows=!0,this.hasSlicePlane=!1,this.drivenOpacity=!1,this.usePBR=!1}}e.Parameters=g,e.PathMaterial=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});