// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../geometry/support/buffer/BufferView","../../lib/Util"],function(e,t,r,f,i,o){"use strict";function s(e,t,r){const{data:f,indices:i}=e,o=t.typedBuffer,s=t.typedBufferStride,n=i.length;r*=s;for(let e=0;e<n;++e){const t=2*i[e];o[r]=f[t],o[r+1]=f[t+1],r+=s}}function n(e,t,r,f=1){const{data:i,indices:o}=e,s=t.typedBuffer,n=t.typedBufferStride,c=o.length;if(r*=n,1===f)for(let e=0;e<c;++e){const t=3*o[e];s[r]=i[t],s[r+1]=i[t+1],s[r+2]=i[t+2],r+=n}else for(let e=0;e<c;++e){const t=3*o[e];for(let e=0;e<f;++e)s[r]=i[t],s[r+1]=i[t+1],s[r+2]=i[t+2],r+=n}}function c(e,t,r,f=1){const{data:i,indices:o}=e,s=t.typedBuffer,n=t.typedBufferStride,c=o.length;if(r*=n,1===f)for(let e=0;e<c;++e){const t=4*o[e];s[r]=i[t],s[r+1]=i[t+1],s[r+2]=i[t+2],s[r+3]=i[t+3],r+=n}else for(let e=0;e<c;++e){const t=4*o[e];for(let e=0;e<f;++e)s[r]=i[t],s[r+1]=i[t+1],s[r+2]=i[t+2],s[r+3]=i[t+3],r+=n}}function l(e,t,r,i,o=1){if(!t)return void n(e,r,i,o);const{data:s,indices:c}=e,l=r.typedBuffer,a=r.typedBufferStride,u=c.length,d=t[0],B=t[1],w=t[2],p=t[4],g=t[5],V=t[6],y=t[8],b=t[9],h=t[10],m=t[12],F=t[13],v=t[14];i*=a;let S=0,N=0,z=0;const k=f.hasIdentityRotation(t)?e=>{S=s[e]+m,N=s[e+1]+F,z=s[e+2]+v}:e=>{const t=s[e],r=s[e+1],f=s[e+2];S=d*t+p*r+y*f+m,N=B*t+g*r+b*f+F,z=w*t+V*r+h*f+v};if(1===o)for(let e=0;e<u;++e)k(3*c[e]),l[i]=S,l[i+1]=N,l[i+2]=z,i+=a;else for(let e=0;e<u;++e){k(3*c[e]);for(let e=0;e<o;++e)l[i]=S,l[i+1]=N,l[i+2]=z,i+=a}}function a(e,t,r,i,o=1){if(!t)return void n(e,r,i,o);const{data:s,indices:c}=e,l=t,a=r.typedBuffer,u=r.typedBufferStride,d=c.length,B=l[0],w=l[1],p=l[2],g=l[4],V=l[5],y=l[6],b=l[8],h=l[9],m=l[10],F=!f.isOrthoNormal(l),v=1e-6,S=.999999;i*=u;let N=0,z=0,k=0;const $=f.hasIdentityRotation(l)?e=>{N=s[e],z=s[e+1],k=s[e+2]}:e=>{const t=s[e],r=s[e+1],f=s[e+2];N=B*t+g*r+b*f,z=w*t+V*r+h*f,k=p*t+y*r+m*f};if(1===o)if(F)for(let e=0;e<d;++e){$(3*c[e]);const t=N*N+z*z+k*k;if(t<S&&t>v){const e=1/Math.sqrt(t);a[i]=N*e,a[i+1]=z*e,a[i+2]=k*e}else a[i]=N,a[i+1]=z,a[i+2]=k;i+=u}else for(let e=0;e<d;++e)$(3*c[e]),a[i]=N,a[i+1]=z,a[i+2]=k,i+=u;else for(let e=0;e<d;++e){if($(3*c[e]),F){const e=N*N+z*z+k*k;if(e<S&&e>v){const t=1/Math.sqrt(e);N*=t,z*=t,k*=t}}for(let e=0;e<o;++e)a[i]=N,a[i+1]=z,a[i+2]=k,i+=u}}function u(e,t,r,i,o=1){if(!t)return void c(e,r,i,o);const{data:s,indices:n}=e,l=t,a=r.typedBuffer,u=r.typedBufferStride,d=n.length,B=l[0],w=l[1],p=l[2],g=l[4],V=l[5],y=l[6],b=l[8],h=l[9],m=l[10],F=!f.isOrthoNormal(l),v=1e-6,S=.999999;if(i*=u,1===o)for(let e=0;e<d;++e){const t=4*n[e],r=s[t],f=s[t+1],o=s[t+2],c=s[t+3];let l=B*r+g*f+b*o,d=w*r+V*f+h*o,N=p*r+y*f+m*o;if(F){const e=l*l+d*d+N*N;if(e<S&&e>v){const t=1/Math.sqrt(e);l*=t,d*=t,N*=t}}a[i]=l,a[i+1]=d,a[i+2]=N,a[i+3]=c,i+=u}else for(let e=0;e<d;++e){const t=4*n[e],r=s[t],f=s[t+1],c=s[t+2],l=s[t+3];let d=B*r+g*f+b*c,N=w*r+V*f+h*c,z=p*r+y*f+m*c;if(F){const e=d*d+N*N+z*z;if(e<S&&e>v){const t=1/Math.sqrt(e);d*=t,N*=t,z*=t}}for(let e=0;e<o;++e)a[i]=d,a[i+1]=N,a[i+2]=z,a[i+3]=l,i+=u}}function d(e,t,r,f,i=1){const{data:o,indices:s}=e,n=r.typedBuffer,c=r.typedBufferStride,l=s.length;if(f*=c,t===o.length&&4===t){n[f]=o[0],n[f+1]=o[1],n[f+2]=o[2],n[f+3]=o[3];const e=new Uint32Array(r.typedBuffer.buffer,r.start),t=c/4,s=e[f/=4];f+=t;const a=l*i;for(let r=1;r<a;++r)e[f]=s,f+=t;return}if(1!==i)if(4!==t)for(let e=0;e<l;++e){const t=3*s[e];for(let e=0;e<i;++e)n[f]=o[t],n[f+1]=o[t+1],n[f+2]=o[t+2],n[f+3]=255,f+=c}else for(let e=0;e<l;++e){const t=4*s[e];for(let e=0;e<i;++e)n[f]=o[t],n[f+1]=o[t+1],n[f+2]=o[t+2],n[f+3]=o[t+3],f+=c}else{if(4===t){for(let e=0;e<l;++e){const t=4*s[e];n[f]=o[t],n[f+1]=o[t+1],n[f+2]=o[t+2],n[f+3]=o[t+3],f+=c}return}for(let e=0;e<l;++e){const t=3*s[e];n[f]=o[t],n[f+1]=o[t+1],n[f+2]=o[t+2],n[f+3]=255,f+=c}}}function B(e,t,r){const{data:f,indices:i}=e,o=t.typedBuffer,s=t.typedBufferStride,n=i.length,c=f[0];r*=s;for(let e=0;e<n;++e)o[r]=c,r+=s}const w=r.create();function p(e,t,r,f,i=1){const o=t.typedBuffer,s=t.typedBufferStride;if(f*=s,1===i)for(let t=0;t<r;++t)o[f]=e[0],o[f+1]=e[1],o[f+2]=e[2],o[f+3]=e[3],f+=s;else for(let t=0;t<r;++t)for(let t=0;t<i;++t)o[f]=e[0],o[f+1]=e[1],o[f+2]=e[2],o[f+3]=e[3],f+=s}function g(e,t,r,f,w,p){switch(e){case"position":{o.assert(3===t.size);const f=w.getField(e,i.BufferViewVec3f);o.assert(!!f,`No buffer view for ${e}`),l(t,r,f,p);break}case"normal":{o.assert(3===t.size);const r=w.getField(e,i.BufferViewVec3f);o.assert(!!r,`No buffer view for ${e}`),a(t,f,r,p);break}case"normalCompressed":case"profileRight":case"profileUp":{o.assert(2===t.size);const r=w.getField(e,i.BufferViewVec2i16);o.assert(!!r,`No buffer view for ${e}`),s(t,r,p);break}case"uv0":{o.assert(2===t.size);const r=w.getField(e,i.BufferViewVec2f16)??w.getField(e,i.BufferViewVec2f);o.assert(!!r,`No buffer view for ${e}`),s(t,r,p);break}case"uvi":{o.assert(2===t.size);const r=w.getField(e,i.BufferViewVec2i16);o.assert(!!r,`No buffer view for ${e}`),s(t,r,p);break}case"color":case"symbolColor":{const r=w.getField(e,i.BufferViewVec4u8);o.assert(!!r,`No buffer view for ${e}`),o.assert(3===t.size||4===t.size),d(t,t.size,r,p);break}case"colorFeatureAttribute":case"opacityFeatureAttribute":case"sizeFeatureAttribute":{const r=w.getField(e,i.BufferViewFloat)??w.getField(e,i.BufferViewFloat);o.assert(!!r,`No buffer view for ${e}`),o.assert(1===t.size),B(t,r,p);break}case"tangent":{o.assert(4===t.size);const f=w.getField(e,i.BufferViewVec4f);o.assert(!!f,`No buffer view for ${e}`),u(t,r,f,p);break}case"profileVertexAndNormal":{o.assert(4===t.size);const r=w.getField(e,i.BufferViewVec4f16)??w.getField(e,i.BufferViewVec4f);o.assert(!!r,`No buffer view for ${e}`),c(t,r,p);break}case"profileAuxData":{o.assert(3===t.size);const r=w.getField(e,i.BufferViewVec3f16)??w.getField(e,i.BufferViewVec3f);o.assert(!!r,`No buffer view for ${e}`),n(t,r,p);break}}}e.writeAttribute=g,e.writeAttributes=function(e,t,r,f,o,s,n){let c={numItems:0,numVerticesPerItem:0};for(const l of r.fields.keys()){const r=e.get(l),a=r?.indices;if(r&&a)"position"===l&&(c={numItems:1,numVerticesPerItem:a.length}),g(l,r,f,o,s,n);else if("olidColor"===l&&null!=t){const r=e.get("position")?.indices;if(r){const e=r.length;p(t,s.getField(l,i.BufferViewVec4u8),e,n)}}}return c},e.writeBufferFloat=function(e,t,r,f=1){const{data:i,indices:o}=e,s=t.typedBuffer,n=t.typedBufferStride,c=o.length;if(r*=n,1===f)for(let e=0;e<c;++e)s[r]=i[o[e]],r+=n;else for(let e=0;e<c;++e){const t=i[o[e]];for(let e=0;e<f;e++)s[r]=t,r+=n}},e.writeBufferMat3f=function(e,t,r){const{data:f,indices:i}=e,o=t.typedBuffer,s=t.typedBufferStride,n=i.length;r*=s;for(let e=0;e<n;++e){const t=9*i[e];for(let e=0;e<9;++e)o[r+e]=f[t+e];r+=s}},e.writeBufferMat4f=function(e,t,r){const{data:f,indices:i}=e,o=t.typedBuffer,s=t.typedBufferStride,n=i.length;r*=s;for(let e=0;e<n;++e){const t=16*i[e];for(let e=0;e<16;++e)o[r+e]=f[t+e];r+=s}},e.writeBufferVec2=s,e.writeBufferVec3=n,e.writeBufferVec4=c,e.writeBufferVec4Zeros=function(e,t,r){const f=e.typedBuffer,i=e.typedBufferStride;t*=i;for(let e=0;e<r;++e)f[t]=0,f[t+1]=0,f[t+2]=0,f[t+3]=0,t+=i},e.writeColor=d,e.writeDeltaF16Vector=function(e,r,f,i){t.subtract(w,e,r);const o=Math.max(Math.sqrt(t.length(w)),1e-4);t.scale(w,w,1/o),f[i++]=w[0],f[i++]=w[1],f[i++]=w[2],f[i++]=o},e.writeNormal=a,e.writeOlidColor=p,e.writePosition=l,e.writeTangent=u,e.writeVVFeatureAttribute=B,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});