// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/has","../../../../../core/maybe","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../lib/GLMaterials","../DrawParameters","../../../../support/HighlightDefaults"],function(e,t,i,s,r,a,o,n,h,l,d,g){"use strict";e.VaoRenderer=class extends i{constructor(e){super(e),this._glMaterials=null,this._drawParameters=new d.DrawParameters,this._highlightNames=new Set,this._produces=new Map}initialize(){this._updateProduces()}destroy(){this.uninitializeRenderContext()}get _hasHighlights(){return this._highlightNames.size>0}hasHighlight(e){return this._highlightNames.has(e)}get produces(){return this._produces}_updateProduces(){this.material.produces.forEach((e,t)=>{this._produces.set(t,t=>!(0===this.dataByOrigin.size||!(8!==t&&5!==t||this._hasHighlights))&&e(t))})}initializeRenderContext(e){this._glMaterials=new l.GLMaterials(this.material,e.materials)}uninitializeRenderContext(){this._glMaterials=r.disposeMaybe(this._glMaterials)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:i}=e,s=this.material.produces.get(i.slot);if(!s?.(t))return null;const{highlight:r,slot:a}=i,o=5===t,n=8===t,h=n||o,l=r?.name;if(h&&(0===this._highlightNames.size||n&&l&&!this._highlightNames.has(l)))return null;const d=e=>n&&!!l&&!e.has(l),u=6===t,c=!(h||u);for(const{buffers:s}of this.dataByOrigin.values())for(const r of s){if(d(r.highlightNames))continue;const s=o?r.drawCommandsHighlights.get(g.defaultHighlightName):h?l?r.drawCommandsHighlights.get(l):r.drawCommandsHighlights.size>0:((u&&r.needsMultipleCommands?r.drawCommandsShadowHighlightRest:r.drawCommandsDefault)||null)?.length??!1,n=c&&r.drawCommandsOccludees||null;if(s||n?.length){const s=this._glMaterials.load(e.rctx,a,t),r=s?.beginSlot(i);if(r)return r}}return null}render(e,t){const{output:i,bind:s}=e,{slot:r,highlight:a}=s,o=8===i,n=a?.name??"";if(o&&!a)return;const h=5===i,l=o||h,d=6===i,u=!(l||d),c=10===r||11===r?r:null,{rctx:m}=e;m.runAppleAmdDriverHelper();const f=m.bindTechnique(t,s,this.material.parameters);for(const e of this.dataByOrigin.values())for(const i of e.buffers){if(o&&(!i.hasHighlights||!i.drawCommandsHighlights.has(n)))continue;if(h&&(!i.hasHighlights||!i.drawCommandsHighlights.has(g.defaultHighlightName)))continue;const r=l&&!h?i.drawCommandsHighlights.get(n)??null:null,a=h?i.drawCommandsHighlights.get(g.defaultHighlightName):l?r:d&&i.needsMultipleCommands?i.drawCommandsShadowHighlightRest:i.drawCommandsDefault,p=null!=a,w=u&&i.drawCommandsOccludees||null;if(p||w?.length){if(this._drawParameters.origin=e.origin,f.bindDraw(s,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(i.vao),m.bindVAO(i.vao),p)for(const e of a)m.setPipelineState(t.getPipeline(!1,c)),m.drawArrays(t.primitiveType,e.first,e.count);if(w?.length){m.setPipelineState(t.getPipeline(!0,c));for(const e of w)m.drawArrays(t.primitiveType,e.first,e.count)}}}}updateHighlights(){const{_highlightNames:e}=this;e.clear();for(const t of this.dataByOrigin.values())for(const i of t.buffers)for(const t of i.highlightNames)e.add(t);this._updateProduces()}get test(){}},t.__decorate([a.property({constructOnly:!0})],e.VaoRenderer.prototype,"material",void 0),t.__decorate([a.property({constructOnly:!0})],e.VaoRenderer.prototype,"dataByOrigin",void 0),e.VaoRenderer=t.__decorate([h.subclass("esri.views.3d.webgl-engine.materials.renderers.VaoRenderer")],e.VaoRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});