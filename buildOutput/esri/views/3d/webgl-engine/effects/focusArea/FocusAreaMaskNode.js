// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../webgl","../../../webgl/RenderNode","./FocusAreaMaskTechnique","../../lib/DefaultVertexBufferLayouts","../../lib/VertexArrayObject","../../../../../chunks/FocusAreaMask.glsl","../../../../webgl/enums","../../../../webgl/NoParameters","../../../../webgl/VertexBuffer"],function(e,s,t,r,o,i,a,n,c,h,u,l,d,p,g,A){"use strict";e.FocusAreaMaskNode=class extends c{constructor(e){super({...e,view:e.focusAreasView.view}),this.consumes={required:[n.RenderCategory.TRANSPARENT]},this.produces=n.InternalRenderCategory.FOCUSAREA,this._vaos=new Array,this._counts=new Array,this._origins=new Array,this._maskParameters=new d.FocusAreaMaskDrawParameters}initialize(){this.updateGeometries()}destroy(){this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0}precompile(){this.techniques.precompile(h.FocusAreaMaskTechnique)}render(e){const s=this.techniques.get(h.FocusAreaMaskTechnique),t=this.bindParameters,r=t.camera,o=r.fullViewport[2],i=r.fullViewport[3];if(!s.compiled||!this._vaos)return void this.requestRender();const a=e.find(({name:e})=>e===n.RenderCategory.TRANSPARENT),c=this.renderingContext,u=this.fboCache.acquire(o,i,n.InternalRenderCategory.FOCUSAREA,2);this.view.stage.renderer.occludedRequiresStencil?(u.acquireDepth(11),c.blitFramebuffer(a.fbo,u.fbo,256)):u.attachDepth(a.getAttachment(p.DepthStencilAttachment)),c.bindFramebuffer(u.fbo),c.setClearColor(0,0,0,1),c.clear(17408),c.setViewport(0,0,o,i);const l=c.bindTechnique(s,t);c.setFaceCullingEnabled(!1),c.setStencilTestEnabled(!0),c.setStencilOpSeparate(1028,7680,34055,7680),c.setStencilOpSeparate(1029,7680,34056,7680),c.setDepthWriteEnabled(!1);for(let e=0;e<this._vaos.length;e++){const s=this._vaos[e],r=this._counts[e];this._maskParameters.origin=this._origins[e],l.bindDraw(t,g.noParameters,this._maskParameters),c.bindVAO(s),c.setDepthTestEnabled(!0),c.setStencilWriteMask(255),c.setStencilFunction(519,0,255),c.setColorMask(!1,!1,!1,!1),c.drawArrays(p.PrimitiveType.TRIANGLES,0,r),c.setDepthTestEnabled(!1),c.setStencilWriteMask(0),c.setStencilFunction(517,0,255),c.setColorMask(!0,!0,!0,!0),c.drawArrays(p.PrimitiveType.TRIANGLES,0,r)}return u}updateGeometries(){this.view.stage&&(this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0,this.focusAreasView.volumes.forEach(e=>{const s=new Array;let t=0,r=0;e.geometryVolumes.forEach(e=>{const o=e.indicesBottom;t+=o.length;for(let t=0;t<o.length;t++)s.push(e.positions[3*(o[t]-1)]),s.push(e.positions[3*(o[t]-1)+1]),s.push(e.positions[3*(o[t]-1)+2]);const i=e.indicesExtruded;r+=i.length;for(let t=0;t<i.length;t++)s.push(e.positions[3*i[t]]),s.push(e.positions[3*i[t]+1]),s.push(e.positions[3*i[t]+2])});const o=new l.VertexArrayObject(this.renderingContext,new A.VertexBuffer(this.renderingContext,u.Pos3,new Float32Array(s)));this._vaos.push(o),this._counts.push(t+r),this._origins.push(e.origin)}),this.requestRender())}},s.__decorate([t.property()],e.FocusAreaMaskNode.prototype,"consumes",void 0),s.__decorate([t.property()],e.FocusAreaMaskNode.prototype,"produces",void 0),s.__decorate([t.property({constructOnly:!0})],e.FocusAreaMaskNode.prototype,"focusAreasView",void 0),e.FocusAreaMaskNode=s.__decorate([a.subclass("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaMaskNode")],e.FocusAreaMaskNode),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});