// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../webgl","../TransparentEnvironment","../../../../../chunks/BloomBlur.glsl","./BloomBlurTechnique","./BloomBlurTechniqueConfiguration","../../../../../chunks/BloomComposition.glsl","./BloomCompositionTechnique","./BloomPresets.glsl","../../../../webgl/enums"],function(e,t,r,o,s,i,a,n,l,u,c,m,h,d,p,b,_,g){"use strict";e.BloomRenderNode=class extends c.TransparentEnvironment{constructor(e){super(e),this.consumes={required:[u.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,"emissive"]},this._blurHorizontalConfiguration=new d.BloomBlurTechniqueConfiguration,this._blurVerticalConfiguration=new d.BloomBlurTechniqueConfiguration,this._compositionParameters=new p.BloomCompositionPassParameters,this._blurParameters=new m.BloomBlurPassParameters,this._blurScale=3.06,this._bloomResults=new Array}initialize(){this.addHandles([o.watch(()=>this._updateFogParameters(),()=>{},o.syncAndInitial),o.watch(()=>this.view.qualitySettings.bloom,e=>{e?(this._enable(),this.precompile()):this._disable()},o.syncAndInitial)])}_updateFogParameters(){const e=this.view.environment.weather;if("sunny"===e.type||"cloudy"===e.type)this._blurParameters.blurRadius=_.blurRadiusPresets[e.type];else{const t="foggy"===e.type?e.fogStrength:e.precipitation;this._blurParameters.blurRadius=r.lerp(_.blurRadiusPresets.cloudy,_.blurRadiusPresets[e.type],t)}this._compositionParameters.lodFactors=_.lodFactorsPresets[e.type].far,this._compositionParameters.lodFactorsFront=_.lodFactorsPresets[e.type].near,this.requestRender(1)}precompile(){this.techniques.precompile(h.BloomBlurTechnique,this._blurHorizontalConfiguration),this._blurVerticalConfiguration.bloomStage=1,this.techniques.precompile(h.BloomBlurTechnique,this._blurVerticalConfiguration),this.techniques.precompile(b.BloomCompositionTechnique)}render(e){const t=e.find(({name:e})=>e===u.InternalRenderCategory.TRANSPARENT_ENVIRONMENT),r=t.getAttachment(g.ColorAttachment1)?.attachment;if(!r)return t;const o=this.techniques.get(h.BloomBlurTechnique,this._blurHorizontalConfiguration),s=this.techniques.get(h.BloomBlurTechnique,this._blurVerticalConfiguration),i=this.techniques.get(b.BloomCompositionTechnique);if(!o.compiled||!s.compiled||!i.compiled)return this.requestRender(1),t;const a=t.getTexture(),n=this.fboCache,{fullWidth:l,fullHeight:c}=this.bindParameters.camera,m=this.renderingContext;let d=r,p=Math.ceil(l/2),_=Math.ceil(c/2);const P=this._blurParameters.blurRadius;for(let e=0;e<5;e++){const t=n.acquire(p,_,"bloomHorizontal",8);this._blurParameters.color=d,this._prepareFBO(t,p,_),m.bindTechnique(o,this.bindParameters,this._blurParameters),m.screen.draw();const r=n.acquire(p,_,"bloomVertical",8);this._blurParameters.color=t.getTexture(),this._prepareFBO(r,p,_),m.bindTechnique(s,this.bindParameters,this._blurParameters),m.screen.draw(),t.release(),this._bloomResults[e]=r,p=Math.ceil(p/2),_=Math.ceil(_/2),d=this._bloomResults[e].getTexture(),this._blurParameters.blurRadius*=this._blurScale}this._blurParameters.blurRadius=P,this._compositionParameters.color=a,this._compositionParameters.emission=r,this._compositionParameters.bloomTexture0=this._bloomResults[0].getTexture(),this._compositionParameters.bloomTexture1=this._bloomResults[1].getTexture(),this._compositionParameters.bloomTexture2=this._bloomResults[2].getTexture(),this._compositionParameters.bloomTexture3=this._bloomResults[3].getTexture(),this._compositionParameters.bloomTexture4=this._bloomResults[4].getTexture();const T=n.acquire(a.descriptor.width,a.descriptor.height,this.produces);return this._prepareFBO(T,l,c),m.bindTechnique(i,this.bindParameters,this._compositionParameters),m.screen.draw(),this._bloomResults.forEach(e=>e.release()),T.attachDepth(t.getAttachment(g.DepthStencilAttachment)),T.attachColor(t.getAttachment(g.ColorAttachment1),g.ColorAttachment1),T}_prepareFBO(e,t,r){const o=this.renderingContext;o.bindFramebuffer(e.fbo),o.setViewport(0,0,t,r),o.setClearColor(0,0,0,0),o.clear(16384)}get test(){return{compositionParameters:this._compositionParameters,blurParameters:this._blurParameters,setLodFactors:e=>{this._compositionParameters.lodFactors=_.normalizePreset(e)}}}},t.__decorate([s.property()],e.BloomRenderNode.prototype,"consumes",void 0),e.BloomRenderNode=t.__decorate([l.subclass("esri.views.3d.webgl-engine.effects.bloom.BloomRenderNode")],e.BloomRenderNode),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});