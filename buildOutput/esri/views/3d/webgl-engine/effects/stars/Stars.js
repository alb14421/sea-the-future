// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../assets","../../../../../core/asyncUtils","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/reactiveUtils","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../webgl","../../../support/buffer/glUtil","../OpaqueEnvironment","./StarsTechnique","../../lib/VertexArrayObject","../../../../webgl/enums","../../../../webgl/VertexBuffer"],function(e,t,s,a,r,i,n,o,f,c,u,l,h,d,b,m,_,g,p,y,w){"use strict";function v(e){return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)]}function P(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}e.Stars=class extends _.OpaqueEnvironment{constructor(){super(...arguments),this._numPoints=0,this._passParameters=new g.StarPassParameters}initialize(){this.addHandles([f.watch(()=>this.view.environment.starsEnabled,e=>e?this._enable():this._disable(),f.initial),f.watch(()=>"virtual"===this.view.environment.lighting.type?null:this.view.environment.lighting.date,e=>this._update(e),f.syncAndInitial)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=n.abortMaybe(this._loadDataTask),this._numPoints=0,this._vao=n.disposeMaybe(this._vao),this._starData=null}precompile(){this.techniques.precompile(g.StarsTechnique)}render(e){const t=e.find(({name:e})=>e===b.InternalRenderCategory.OPAQUE_ENVIRONMENT),s=this.renderingContext;if(this.loading)return this.requestRender(1),t;if(!this._starData)return t;this._vao??=this._ensureResources(this._starData,s);const a=this.techniques.get(g.StarsTechnique);return a.compiled?(s.bindTechnique(a,this.bindParameters,this._passParameters),s.bindVAO(this._vao),s.drawArrays(y.PrimitiveType.POINTS,0,this._numPoints),t):(this.requestRender(1),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/S,function(e,t,s,a){const r=g.layout.createBuffer(a),i=r.position,n=r.color,o=r.size;for(let e=0;e<a;e++){const a=t[2*e],r=t[2*e+1];i.set(e,0,-Math.cos(a)*Math.sin(r)),i.set(e,1,-Math.sin(a)*Math.sin(r)),i.set(e,2,-Math.cos(r));const f=P(s[e]),c=v(T[f[1]]);n.set(e,0,255*c[0]),n.set(e,1,255*c[1]),n.set(e,2,255*c[2]),n.set(e,3,255),o.set(e,f[0])}return new p.VertexArrayObject(e,new w.VertexBuffer(e,m.glLayout(g.layout),r.buffer))}(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,s=2*function(e){const t=e,s=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+s)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+s)}(e),a=h.copy(this._passParameters.modelMatrix,M);h.rotateZ(a,a,-s*Math.PI),h.multiply(a,D,a),h.rotateZ(a,a,-t*Math.PI),this.requestRender(1)}_createLoadDataTask(){if(this._starData)return null;const e=a.createTask(async e=>{const{data:t}=await s.fetchAsset("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});!function(e){if(!e)throw new r("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/S;if(t%1!=0||t>5e4||t<5e3)throw new r("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}(t),this._starData=t});return e.promise.catch(e=>{o.isAbortError(e)||i.getLogger(this).error(e)}).then(()=>{this.destroyed||this.requestRender(1)}),e}},e.Stars=t.__decorate([l.subclass("esri.views.3d.webgl-engine.effects.stars.Stars")],e.Stars);const T=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],D=d.fromValues(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),M=d.fromValues(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),S=9;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});