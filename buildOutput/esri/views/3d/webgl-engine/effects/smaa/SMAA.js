// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../../chunks/tslib.es6","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../support/requestImageUtils","../../../webgl","../../../webgl/RenderNode","./SMAABlendWeightsTechnique","./SMAABlurTechnique","./SMAAEdgeDetectTechnique","./SMAAPassParameters","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],function(e,t,r,s,a,i,o,n,c,u,h,l,d,p,A,m,b,T,_,g){"use strict";function x(e,t,r,s){const a=new g.TextureDescriptor(s.width,s.height);return a.pixelFormat=r,a.wrapMode=33071,a.samplingMode=t,new _.Texture(e,a,s)}t.SMAA=class extends p{constructor(e){super(e),this.produces="disabled",this.consumes={required:[d.InternalRenderCategory.ANTIALIASING],optional:[d.RenderCategory.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new T.SMAAPassParameters}initialize(){this.addHandles([i.watch(()=>this.isEnabled(),e=>e?this.enable():this.disable(),i.syncAndInitial)])}async enable(){if(this.produces=d.InternalRenderCategory.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const t=this._abortController.signal;try{const r=await new Promise((t,r)=>e(["./SMAAData"],t,r));await this._loadTextures(r,t),this.requestRender(1)}catch{}this._abortController=null}async _loadTextures(e,t){a.throwIfAborted(t);const[r,s]=await Promise.allSettled([l.requestImage(e.areaTexture,{signal:t}),l.requestImage(e.searchTexure,{signal:t})]);if(a.throwIfAborted(t),"fulfilled"!==r.status||"fulfilled"!==s.status)return;const i=this.renderingContext;this._areaTexture=x(i,9729,6407,r.value),this._searchTexture=x(i,9728,6409,s.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=s.disposeMaybe(this._searchTexture),this._areaTexture=s.disposeMaybe(this._areaTexture)}precompile(){this.techniques.precompile(b.SMAAEdgeDetectTechnique),this.techniques.precompile(A.SMAABlendWeightsTechnique),this.techniques.precompile(m.SMAABlurTechnique)}render(e){const t=e.find(({name:e})=>e===d.InternalRenderCategory.ANTIALIASING);if(!this._areaTexture||!this._searchTexture)return this.requestRender(1),t;const r=this.techniques.get(b.SMAAEdgeDetectTechnique),s=this.techniques.get(A.SMAABlendWeightsTechnique),a=this.techniques.get(m.SMAABlurTechnique);if(!r.compiled||!s.compiled||!a.compiled)return this.requestRender(1),t;const i=e.find(({name:e})=>e===d.RenderCategory.COMPOSITE);if(!i)return t;const o=i.fbo.width,n=i.fbo.height,c=this.renderingContext;c.setViewport(0,0,o,n);const u=this.fboCache.acquire(o,n,"smaa edges",2);c.bindFramebuffer(u.fbo),c.setClearColor(0,0,0,1),c.clear(16384),this._smaaParameters.color=i.getTexture();const h=this.bindParameters;c.bindTechnique(r,h,this._smaaParameters),c.screen.draw();const l=this.fboCache.acquire(o,n,"smaa blend");return c.bindFramebuffer(l.fbo),c.setClearColor(0,0,1,1),c.clear(16384),this._smaaParameters.inputTexture=u.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,c.bindTechnique(s,h,this._smaaParameters),c.screen.draw(),u.release(),c.bindFramebuffer(t.fbo),c.setClearColor(0,1,0,1),c.clear(16384),this._smaaParameters.inputTexture=l.getTexture(),c.bindTechnique(a,h,this._smaaParameters),c.screen.draw(),l.release(),t}},r.__decorate([o.property()],t.SMAA.prototype,"produces",void 0),r.__decorate([o.property()],t.SMAA.prototype,"consumes",void 0),r.__decorate([o.property({constructOnly:!0})],t.SMAA.prototype,"isEnabled",void 0),r.__decorate([o.property()],t.SMAA.prototype,"_abortController",void 0),t.SMAA=r.__decorate([h.subclass("esri.views.3d.webgl-engine.effects.smaa.SMAA")],t.SMAA),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});