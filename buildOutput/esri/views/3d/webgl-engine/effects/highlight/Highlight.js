// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../webgl","../../../webgl/RenderNode","./HighlightApplyTechnique","./HighlightBlurTechnique","./HighlightDownsampleTechnique","./HighlightPassParameters","./HighlightToSingleTechnique","../../lib/DefaultVertexBufferLayouts","../../lib/VertexArrayObject","../../../../../chunks/HighlightBlur.glsl","../../../../../chunks/HighlightDownsample.glsl","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor","../../../../webgl/VertexBuffer"],function(e,t,i,r,h,s,l,n,o,a,g,c,u,d,p,m,f,b,T,w,x,C,_,H,v,P){"use strict";e.Highlight=class extends c{constructor(){super(...arguments),this.produces=g.InternalRenderCategory.HIGHLIGHTS,this.consumes={required:[g.InternalRenderCategory.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new x.HighlightDownsampleDrawParameters,this._passParameters=new m.HighlightPassParameters,this._highlightBlurDrawParameters=new w.HighlightBlurDrawParameters,this._grid=new q}initialize(){this.addHandles([h.watch(()=>this._updateOptionsTexture(),()=>{},h.initial)])}destroy(){this._grid.coverage=r.releaseMaybe(this._grid.coverage),this._grid.vao=r.disposeMaybe(this._grid.vao),this._passParameters.highlightOptionsTexture=r.releaseMaybe(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(null==this._passParameters.highlightOptionsTexture){const e=new v.TextureDescriptor(16,2);e.internalFormat=6408,e.samplingMode=9728,this._passParameters.highlightOptionsTexture=new H.Texture(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(function(e){const t=new Uint8Array(128);let i=0;for(const r of e){const e=4*i,h=4*i+64;++i;const{color:s}=r,l=r.haloColor??s;t[e+0]=s.r,t[e+1]=s.g,t[e+2]=s.b,t[e+3]=r.fillOpacity*s.a*255,t[h+0]=l.r,t[h+1]=l.g,t[h+2]=l.b,t[h+3]=r.haloOpacity*l.a*255}return t}(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(p.HighlightDownsampleTechnique),this.techniques.precompile(f.HighlightToSingleTechnique),this.techniques.precompile(d.HighlightBlurTechnique),this.techniques.precompile(u.HighlightApplyTechnique)}render(e){const t=e.find(({name:e})=>e===g.InternalRenderCategory.HIGHLIGHTS),{techniques:i,bindParameters:r}=this;if(!r.decorations)return t;if(!i.get(p.HighlightDownsampleTechnique).compiled)return this.requestRender(1),t;const h=e.find(({name:e})=>"highlights"===e).getTexture();return this._renderHighlightPostprocess(h,t),t}_prepareAndDownSample(e){this._gridUpdateResources(e);const t=this.techniques.get(p.HighlightDownsampleTechnique),i=this._gridComputeCoverage(t,e),{horizontalCellCount:r,verticalCellCount:h}=i,s=this._passParameters;return s.horizontalCellCount=r,s.verticalCellCount=h,s.coverageTexture=i.coverage?.getTexture(),i}_renderGrid(e){const t=e.verticalCellCount*e.horizontalCellCount;this.renderingContext.bindVAO(e.vao),this.renderingContext.drawElementsInstanced(_.PrimitiveType.TRIANGLES,6,_.DataType.UNSIGNED_BYTE,0,t)}_renderHighlightPostprocess(e,t){const{fboCache:i,techniques:r,bindParameters:h,_passParameters:s,renderingContext:l}=this,n=r.get(f.HighlightToSingleTechnique),o=r.get(d.HighlightBlurTechnique),g=r.get(u.HighlightApplyTechnique);if(!g.compiled||!o.compiled||!n.compiled)return void this.requestRender(1);s.highlightTexture=e;const c=this._prepareAndDownSample(e),{width:p,height:m}=e.descriptor;s.highlightTexture=e;const{camera:b}=h,{fullWidth:T,fullHeight:w,pixelRatio:x,fullViewport:C}=b,_=Math.ceil(T/x),H=Math.ceil(w/x),{_highlightBlurDrawParameters:v}=this,P=this.view.stage.renderView.renderer,{highlights:q}=h;for(let e=0;e<q.length;++e){const{name:r}=q[e];if(!P.hasHighlight(r))continue;s.highlightLevel=e,l.setClearColor(0,0,0,0);const u=i.acquire(p,m,"single highlight",2);l.bindFramebuffer(u.fbo),l.setViewport(0,0,p,m),l.clear(16384),l.bindTechnique(n,h,s),this._renderGrid(c),v.blurInput=u.getTexture(),a.set(v.blurSize,1/_,0);const d=i.acquire(_,H,"single highlight blur h",2);l.unbindTexture(d.fbo?.colorTexture),l.bindFramebuffer(d.fbo),l.setViewport(0,0,_,H),l.clear(16384),l.bindTechnique(o,h,s,v),this._renderGrid(c),u.release(),a.set(v.blurSize,0,1/H),s.highlightBlurTexture=d.getTexture(),l.bindFramebuffer(t.fbo),l.setViewport4fv(C),l.bindTechnique(g,h,s,v),this._renderGrid(c),d.release()}s.coverageTexture=s.highlightTexture=null}_gridUpdateResources(e){const t=this._grid,{width:i,height:r}=e.descriptor;if(t.horizontalCellCount=Math.ceil(i/x.gridCellPixelSize),t.verticalCellCount=Math.ceil(r/x.gridCellPixelSize),t.vao)return;const h=this.renderingContext,s=C.BufferObject.createIndex(h,35044,D);t.vao=new T.VertexArrayObject(h,new P.VertexBuffer(h,b.NoVertex),s)}_gridComputeCoverage(e,t){const i=this.renderingContext,r=this._grid,h=t.descriptor,s=Math.ceil(h.width/x.gridCellPixelSize),l=Math.ceil(h.height/x.gridCellPixelSize);this._downsampleDrawParameters.input=t;const{highlights:n}=this.bindParameters;r.coverage?.release();const o=this.fboCache.acquire(s,l,"highlight coverage",n.length>O?3:1);return r.coverage=o,i.bindFramebuffer(o.fbo),i.bindTechnique(e,this.bindParameters,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,s,l),i.screen.draw(),r}get test(){}},t.__decorate([s.property()],e.Highlight.prototype,"produces",void 0),t.__decorate([s.property()],e.Highlight.prototype,"consumes",void 0),e.Highlight=t.__decorate([o.subclass("esri.views.3d.webgl-engine.effects.highlight.Highlight")],e.Highlight);class q{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}}let y=0;const D=new Uint8Array([0,1,2,2,1,3]),O=4;e.maxHighlightsPerChannel=O,e.renderHighlightBuffer=function(e,t,i,r,h,s=0){const{highlights:l}=r,n=l.length>1?t.acquire(i.width,i.height,"highlight mix",l.length>O?3:1):null,{gl:o}=e;if(n){const t=e.getBoundFramebufferObject();e.bindFramebuffer(n.fbo),o.clearBufferuiv(o.COLOR,0,[0,0,0,0]),e.bindFramebuffer(t)}const g=n?.getTexture();r.highlightMixTexture=g,a.set(r.highlightMixOrigin,s,0),l.forEach((t,l)=>{if(l>0){const t=H.Texture.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(g,t),e.setActiveTexture(t),o.copyTexSubImage2D(3553,0,0,0,s,0,i.width,i.height),e.bindTexture(null,t)}e.clear(256),r.highlightLevel=l,h()}),r.highlightLevel=null,r.highlightMixTexture=null,n?.release()},e.trackHighlightOptions=function(e){let t=0;for(const i of e){const{name:e}=i;t+=e.length;const{color:r,fillOpacity:h,haloColor:s,haloOpacity:l}=i;t+=r.r+r.g+r.b+r.a+h,t+=s?s.r+s.g+s.b+s.a+l:0}const i=e.at(0);if(i){const{shadowOpacity:e,shadowDifference:r,shadowColor:h}=i;t+=e+r+h.r+h.g+h.b+h.a}return y+++(t>=0?0:1)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});