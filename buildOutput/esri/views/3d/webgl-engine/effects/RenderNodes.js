// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Logger","../../../../core/PooledArray","../../webgl/utils","../core/FBOCache"],function(e,t,r,o,n){"use strict";e.RenderNodes=class{constructor(e){this._context=e,this._nodes=new r}destroy(){this._nodes.forEach(e=>e.destroy()),this._nodes.prune()}add(e){this._nodes.push(e)}remove(e){this._nodes.remove(e)}produces(e){return this._nodes.some(({produces:t})=>t===e)}require(e,...t){const r=this._nodes,o=t=>r.reduce((r,{consumes:o,produces:n})=>r+(!o.required.includes(e)||null!=t&&n!==t?0:1),0);return 0===t.length?o():t.reduce((e,t)=>e+o(t),0)}optional(e,...t){const r=this._nodes,o=t=>r.reduce((r,{consumes:o,produces:n})=>r+(!o.optional?.includes(e)||null!=t&&n!==t?0:1),0);return 0===t.length?o():t.reduce((e,t)=>e+o(t),0)}updateAnimation(e){return this._nodes.reduce((t,r)=>r.updateAnimation(e)||t,!1)}precompile(...e){++this._context.techniques.precompiling;for(const t of e)this._nodes.forEach(e=>{e.produces===t&&e.precompile()});--this._context.techniques.precompiling}render(e,t,r=()=>{}){return this._render(e,t,r)??(o.isManagedFBO(e)?e:n.defaultWebGLFBO)}produce(e,t,r=()=>{}){return this._render(e,t,r)}_render(e,r,o=()=>{}){const n="string"==typeof e?e:e.name,s=this._nodes.filter(({produces:e})=>e===n);if(0===s.length)return;let i="string"==typeof e?null:e;return s.some(e=>{const s=i?[i]:[],c=null==i;for(const t of e.consumes.required){if(t===n){if(c)return!1;continue}const e=r.get(t);if(e)s.push(e);else if("emissive"!==t||!r.get(n)?.hasAttachment(t))return o?.(s),!1}if(e.consumes.optional)for(const t of e.consumes.optional){if(t===n)continue;const e=r.get(t);e&&s.push(e)}try{const o=e.doRender(s);o&&o!==i&&(n!==o.name&&(t.getLogger(e).errorOnce(`RenderNode produced ${o.name}, expected ${n}`),o.setName(n)),i?.release(),i=o,r.set(n,i))}catch(r){t.getLogger(e).errorOnce(r)}return o?.(s),c&&null!=i}),this._context.rctx.enforceState(),i}requireGeometryDepth(){return this._nodes.some(e=>"disabled"!==e.produces&&e.requireGeometryDepth)}get test(){return{nodes:this._nodes}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});