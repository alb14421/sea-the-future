// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../webgl","../../../webgl/RenderNode","../../core/shaderModules/glsl","../../lib/DefaultVertexBufferLayouts","../../../../webgl/checkWebGLError","../../../../webgl/enums","../../../../../webscene/support/AlphaCutoff"],function(e,r,t,o,i,n,a,l,c,s,u,d,h,p,f){"use strict";function m(e){switch(e){case"float":return"sampler2D";case"uint":return"usampler2D";case"int":return"isampler2D"}}function g(e){if(!e)return"float";const{internalFormat:r}=e.descriptor;switch(r){case p.SizedPixelFormat.R8I:case p.SizedPixelFormat.R16I:case p.SizedPixelFormat.R32I:case p.SizedPixelFormat.RG8I:case p.SizedPixelFormat.RG16I:case p.SizedPixelFormat.RG32I:case p.SizedPixelFormat.RGB8I:case p.SizedPixelFormat.RGB16I:case p.SizedPixelFormat.RGB32I:case p.SizedPixelFormat.RGBA8I:case p.SizedPixelFormat.RGBA16I:case p.SizedPixelFormat.RGBA32I:return"int";case p.SizedPixelFormat.R8UI:case p.SizedPixelFormat.R16UI:case p.SizedPixelFormat.R32UI:case p.SizedPixelFormat.RG8UI:case p.SizedPixelFormat.RG16UI:case p.SizedPixelFormat.RG32UI:case p.SizedPixelFormat.RGB8UI:case p.SizedPixelFormat.RGB16UI:case p.SizedPixelFormat.RGB32UI:case p.SizedPixelFormat.RGBA8UI:case p.SizedPixelFormat.RGBA16UI:case p.SizedPixelFormat.RGBA32UI:return"uint";default:return"float"}}e.RenderNodeVisualizerNode=class extends s{constructor(e){super(e),this.destroyedCB=null,this.produces=c.RenderCategory.FINAL,this.consumes={required:[c.RenderCategory.FINAL]},this.clearColor=l.ZEROS,this._focusedFBOType=0,this._program=new Map}destroy(){this._program.forEach(e=>e.dispose()),this._program.clear(),this.destroyedCB()}render(e){const r=e.find(({name:e})=>e===c.RenderCategory.FINAL);if(!this._focusedFBO)return r;const t=this.renderingContext;t.bindFramebuffer(r.fbo),t.setClearColor(0,0,0,0),t.clear(16384);const o=this._focusedFBO.getTexture(),i=[g(o)],n=this._ensureProgram(t,!1,i);return t.useProgram(n),t.bindTexture(o,0),n.setUniform1i("colorTex0",0),n.setUniform1i("inputType",this._focusedFBOType),3===this._focusedFBOType&&n.setUniform2fv("nearFar",this.camera.nearFar),t.screen.draw(),r}getDownscaledFBO(e,r,t,o,i){0===r&&(o=e.width,i=e.height);const n=e.colorAttachments.length,a=[],l=new Array(n);for(let r=0;r<n;++r){const t=e.getColorTexture(p.ColorAttachment0+r);if(t){const e=g(t);a.push(e);const{descriptor:o}=t;"float"!==e||o.hasMipmap||o.isImmutable||(t.generateMipmap(),l[r]=!0)}}const c=this.renderingContext,{depthStencilTexture:s}=e,d=this._ensureProgram(c,null!=s,a),f=this.fboCache.acquire(o,i,"fbo visualizer");c.useProgram(d),c.bindFramebuffer(f.fbo);const m=[];for(let r=0;r<n;++r){const t=p.ColorAttachment0+r,o=`colorTex${u.glsl.int(r)}`;c.bindTexture(e.getColorTexture(t),r),d.setUniform1i(o,r),r>0&&f.acquireColor(t,5),m.push(t)}const x=s?.descriptor.linearFilterDepth??!1;if(s){const e=n;s.setShadowFiltering(!1),c.bindTexture(s,e),d.setUniform1i("depthTex",e);const r=p.ColorAttachment0+e;r>p.ColorAttachment0&&f.acquireColor(r,5,"depth to color"),m.push(r)}c.gl.drawBuffers(m),h.checkWebGLError(c.gl);const v=c.getViewport();c.setViewport(0,0,o,i),c.setClearColor(0,0,0,0),c.clear(16384),c.setBlendingEnabled(!0),c.setBlendFunction(1,771);const F="linear-depth"===t||t.includes("shadow"),T="overlay highlight"===t||"highlights"===t||"highlight mix"===t,b="highlight coverage"===t,R=e.colorTexture?.descriptor,C=R?.internalFormat,S=F?3:T?5:b?6:C===p.SizedPixelFormat.R16F||C===p.SizedPixelFormat.R32F||C===p.SizedPixelFormat.R8?1:C===p.SizedPixelFormat.RG8?2:C===p.SizedPixelFormat.RGBA16F?4:C===p.SizedPixelFormat.RG8UI?7:0;d.setUniform1i("inputType",S),d.setUniform2fv("nearFar",this.camera.nearFar),c.screen.draw(),h.checkWebGLError(c.gl),c.bindFramebuffer(null),c.setViewport(v.x,v.y,v.width,v.height),0===r&&(this._focusedFBO=f,this._focusedFBOType=S);for(let r=0;r<n;++r)if(l[r]){const t=e.getColorTexture(p.ColorAttachment0+r);t?.clearMipmap()}return s&&s.setShadowFiltering(x),f}clearFocusedFBO(){this._focusedFBO=null}getPreviewContent(e,r,t,o){if(!t)return null;const i=this.renderingContext,n=this.fboCache.acquire(e,r,"fbo visualizer");i.bindFramebuffer(n?.fbo),i.setClearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),i.clear(16384),i.setBlendingEnabled(!0),i.setBlendFunction(1,771);const a=t.getColorTexture(o);i.setViewport(0,0,e,r);const l=this._ensureProgram(i,!1,[g(a)]);i.useProgram(l),i.bindTexture(a,0),l.setUniform1i("colorTex0",0),l.setUniform1i("inputType",0),i.screen.draw();const c=new ImageData(new Uint8ClampedArray(e*r*4),e,r);return i.gl.readPixels(0,0,e,r,6408,p.DataType.UNSIGNED_BYTE,new Uint8Array(c.data.buffer)),h.checkWebGLError(i.gl),i.bindFramebuffer(null),n?.release(),c}_ensureProgram(e,r,t){const o=function(e){const{hasDepthAttachment:r,colorAttachmentTypes:t}=e;return`${r?"Depth":""}${t.reduceRight((e,r)=>e+`|C${r}`,"")}`}({hasDepthAttachment:r,colorAttachmentTypes:t}),i=this._program.get(o);if(i)return i;const n=t.length,a=`#version 300 es\n      precision highp float;\n      precision highp usampler2D;\n\n      in vec2 uv;\n      ${(e=>{let r="";for(let t=0;t<e.length;++t){const o=e[t];r+=`layout(location = ${u.glsl.int(t)}) out vec4 fragColor${u.glsl.int(t)};\n                uniform ${m(o)} colorTex${u.glsl.int(t)};`}return r})(t)}\n      ${u.If(r,`layout(location = ${u.glsl.int(n)}) out vec4 fragDepth;\n         uniform sampler2D depthTex;`)}\n\n      uniform int inputType;\n      uniform vec2 nearFar;\n\n      // Factors to convert rgba back to float\n      const vec4 RGBA_2_FLOAT_FACTORS = vec4(\n        255.0 / (256.0),\n        255.0 / (256.0 * 256.0),\n        255.0 / (256.0 * 256.0 * 256.0),\n        255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n      );\n\n\n      float rgbaTofloat(vec4 rgba) {\n        // Convert components from 0->1 back to 0->255 and then add the components together with their corresponding\n        // fixed point factors, i.e. (256^1, 256^2, 256^3, 256^4)\n        return dot(rgba, RGBA_2_FLOAT_FACTORS);\n      }\n\n      float linearDepthFromFloat(float depth) {\n        depth = pow(depth, 0.2);\n        return -(depth * (nearFar[1] - nearFar[0]) + nearFar[0]);\n      }\n\n      float linearDepthFromRGBA(vec4 depth) {\n        return linearDepthFromFloat(rgbaTofloat(depth));\n      }\n\n      ${"float"===t[0]?"float linearDepthFromTexture(sampler2D depthTex, vec2 uv) {\n          ivec2 iuv = ivec2(uv * vec2(textureSize(depthTex, 0)));\n          return linearDepthFromRGBA(texelFetch(depthTex, iuv, 0));\n        }":"float linearDepthFromTexture(usampler2D depthTex, vec2 uv) {\n        ivec2 iuv = ivec2(uv * vec2(textureSize(depthTex, 0)));\n        return linearDepthFromRGBA(vec4(texelFetch(depthTex, iuv, 0)) * 255.0);\n      }"}\n\n      void main() {\n        ${u.If(t.length>0,u.glsl`
        vec4 color;
        if (inputType == 1) {
          color = vec4(vec3(texture(colorTex0, uv).r), 1.0);
        } else if (inputType == 2) {
          color = vec4(texture(colorTex0, uv).rg, 0.0, 1.0);
        } else if (inputType == 3) {
          float depth = 1.0 - ((-linearDepthFromTexture(colorTex0, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]));
          color = vec4(vec3(depth), depth >= 0.999 ? 0.0 : 1.0);
        } else if (inputType == 4) {
          color = vec4(texture(colorTex0, uv));
          color = vec4(color.rgb / color.a, color.a);
        } else if (inputType == 5) {
          color = vec4(texture(colorTex0, uv)) * 255.0;
          color = vec4(color.rgb / color.a, color.a);
        } else if(inputType == 6) {
          vec2 texDim =  vec2(textureSize(colorTex0, 0));
          ivec2 iuv = ivec2(uv*texDim);
          uvec2 hh = uvec2(texelFetch(colorTex0,iuv,0).rg);
          color = vec4(
             ((hh & uvec2(0x55u)) != uvec2(0u)) ? 1.0 : 0.0,
             ((hh & uvec2(0xaau)) != uvec2(0u)) ? 1.0 : 0.0,
             0.0,
             1.0);
        } else {
          color = vec4(texture(colorTex0, uv));
        }


        if(color.a < ${u.glsl.float(f.alphaCutoff)})
          discard;
        fragColor0 = color;
        ${u.If(t.length>1,(e=>{let r="";for(let t=1;t<e.length;++t){const o=e[t],i=`texture(colorTex${u.glsl.int(t)}, uv)`,n="float"===o?i:`vec4( vec2(${i}), 0.0, 1.0)`;r+=`fragColor${u.glsl.int(t)} = ${n};`}return r})(t))}
        `)}\n\n        ${u.If(r,"float depth = 1.0 - pow(texture(depthTex, uv).r, 10.0);\n            fragDepth = vec4(vec3(depth), depth < 0.000001 ? 0.0 : 1.0);")}\n      }`,l=e.programCache.acquire("#version 300 es\n      in vec2 position;\n      out vec2 uv;\n\n      void main() {\n        gl_Position = vec4(position, 0.0, 1.0);\n        uv = position * 0.5 + vec2(0.5);\n      }",a,d.Pos2Locations);return this._program.set(o,l),l}},r.__decorate([t.property()],e.RenderNodeVisualizerNode.prototype,"destroyedCB",void 0),r.__decorate([t.property()],e.RenderNodeVisualizerNode.prototype,"produces",void 0),r.__decorate([t.property()],e.RenderNodeVisualizerNode.prototype,"consumes",void 0),r.__decorate([t.property()],e.RenderNodeVisualizerNode.prototype,"clearColor",void 0),e.RenderNodeVisualizerNode=r.__decorate([a.subclass("esri.views.3d.webgl-engine.effects.debug.RenderNodeVisualizerNode")],e.RenderNodeVisualizerNode),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});