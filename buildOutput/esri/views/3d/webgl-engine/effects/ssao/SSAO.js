// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/time","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../webgl","../../../webgl/RenderNode","../../core/shaderLibrary/shading/ScreenSpaceConstants","./SSAOBlurTechnique","./SSAONoiseData","./SSAOParameters","./SSAOTechnique","../../../../../chunks/SSAO.glsl","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],function(e,r,t,s,a,i,o,n,c,d,l,u,h,p,m,S,b,w,_,T,f,P,g){"use strict";e.SSAO=class extends p{constructor(e){super(e),this.consumes={required:["normals"]},this.produces=h.InternalRenderCategory.SSAO,this.isEnabled=()=>!1,this._enableTime=i.Milliseconds(0),this._passParameters=new w.SSAOPassParameters,this._drawParameters=new w.BlurDrawParameters}initialize(){const e=Uint8Array.from(atob(b.noiseData),e=>e.charCodeAt(0)),r=new g.TextureDescriptor(32);r.wrapMode=33071,r.pixelFormat=6407,r.wrapMode=10497,r.hasMipmap=!0,this._passParameters.noiseTexture=new P.Texture(this.renderingContext,r,e),this.techniques.precompile(_.SSAOTechnique),this.techniques.precompile(S.SSAOBlurTechnique),this.addHandles(a.watch(()=>this.isEnabled(),()=>this._enableTime=i.Milliseconds(0)))}destroy(){this._passParameters.noiseTexture=s.disposeMaybe(this._passParameters.noiseTexture)}render(e){const r=e.find(({name:e})=>"normals"===e),s=r?.getTexture(),a=r?.getTexture(f.DepthStencilAttachment);if(!s||!a)return;const o=this.techniques.get(_.SSAOTechnique),n=this.techniques.get(S.SSAOBlurTechnique);if(!o.compiled||!n.compiled)return this._enableTime=i.Milliseconds(performance.now()),void this.requestRender(1);0===this._enableTime&&(this._enableTime=i.Milliseconds(performance.now()));const c=this.renderingContext,d=this.view.qualitySettings.fadeDuration,l=this.bindParameters,p=l.camera,b=p.relativeElevation,w=t.clamp((m.distanceFadeEnd-b)/(m.distanceFadeEnd-m.distanceFadeStart),0,1),P=d>0?Math.min(d,performance.now()-this._enableTime)/d:1,g=P*w;this._passParameters.normalTexture=s,this._passParameters.depthTexture=a,this._passParameters.projScale=1/p.computeScreenPixelSizeAtDist(1),this._passParameters.intensity=4*x/T.getRadius(p)**6*g;const A=p.fullViewport[2],O=p.fullViewport[3],q=this.fboCache.acquire(A,O,"ssao input",2);c.bindFramebuffer(q.fbo),c.setViewport(0,0,A,O),c.bindTechnique(o,l,this._passParameters,this._drawParameters),c.screen.draw();const y=Math.round(A/2),v=Math.round(O/2),C=this.fboCache.acquire(y,v,"ssao blur",0);c.bindFramebuffer(C.fbo),this._drawParameters.colorTexture=q.getTexture(),u.set(this._drawParameters.blurSize,0,2/O),c.bindTechnique(n,l,this._passParameters,this._drawParameters),c.setViewport(0,0,y,v),c.screen.draw(),q.release();const M=this.fboCache.acquire(y,v,h.InternalRenderCategory.SSAO,0);return c.bindFramebuffer(M.fbo),c.setViewport(0,0,A,O),c.setClearColor(1,1,1,0),c.clear(16384),this._drawParameters.colorTexture=C.getTexture(),u.set(this._drawParameters.blurSize,2/A,0),c.bindTechnique(n,l,this._passParameters,this._drawParameters),c.setViewport(0,0,y,v),c.screen.draw(),c.setViewport4fv(p.fullViewport),C.release(),P<1&&this.requestRender(1),M}},r.__decorate([o.property()],e.SSAO.prototype,"consumes",void 0),r.__decorate([o.property()],e.SSAO.prototype,"produces",void 0),r.__decorate([o.property({constructOnly:!0})],e.SSAO.prototype,"isEnabled",void 0),e.SSAO=r.__decorate([l.subclass("esri.views.3d.webgl-engine.effects.ssao.SSAO")],e.SSAO);const x=.5;e.blurSizePixels=2,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});