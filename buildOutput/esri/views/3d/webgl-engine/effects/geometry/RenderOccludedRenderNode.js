// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/PooledArray","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../webgl","../../../webgl/RenderNode","../blit/Blit","../../../../webgl/enums"],function(e,r,t,n,c,d,s,o,i,l,a,u,h){"use strict";e.RenderOccludedRenderNode=class extends a{constructor(e){super(e),this.consumes={required:[l.InternalRenderCategory.OCCLUDED]},this.produces=l.InternalRenderCategory.OCCLUDED,this._blit=new u.Blit(e.view.stage.renderView.techniques,2)}precompile(){const e=this.view.stage.renderer;e.plugins.plugins.forEach(r=>{e.precompileSlots(r,9,11),r.material&&e.precompileOccludedSlots(r,g)})}render(e){const r=e.find(({name:e})=>e===this.produces);return this._renderOccludedAndTransparentStencil(r),this._renderOccludedComposite(r),r}_renderOccludedAndTransparentStencil(e){const r=this.view.stage.renderer,t=p;t.clear();for(const e of r.plugins.plugins)8&e.renderOccludedFlags&&t.push(e);0!==t.length&&(r.renderSlots(t,10),this._renderAndComposite(e,e.getAttachment(h.DepthStencilAttachment),.5,()=>r.renderSlots(t,11),!1,!1),t.clear())}_renderOccludedComposite(e){const r=this.view.stage.renderer,t=p;t.clear();let n=0;for(const e of r.plugins.plugins){const r=e.renderOccludedFlags&f;n|=r,r&&t.push(e)}if(!n)return void t.clear();const c=this._getDepthStencilAttachment(e);let d=c.clearStencil;for(const s of g)n&s&&(this._renderAndComposite(e,c.depth,16===s?1:.5,()=>r.renderOccludedSlots(t,s),!0,d),d=!1);c.release(),t.clear()}_renderAndComposite(e,r,t,n,c,d){const s=this.renderingContext,{width:o,height:l}=e.fbo,a=this.fboCache.acquire(o,l,"tmp color");a.attachDepth(r),s.bindFramebuffer(a.fbo),s.clearFramebuffer(i.ZEROS,c,d),n(),a.detachDepth(),this._blit.blend(s,a,e,this.bindParameters,t),a.release()}_getDepthStencilAttachment(e){const{width:r,height:t}=e.fbo;if(!this.view.stage.renderer.occludedRequiresIntegratedMeshStencil){const e=this.fboCache.acquireDepth(11,r,t,"retained stencil");return{depth:e,release:()=>e.release(),clearStencil:!0}}const n=this.fboCache.acquire(r,t,"retained stencil",11);return this.renderingContext.blitFramebuffer(e.fbo,n.fbo,1024),{depth:n.getAttachment(h.DepthStencilAttachment),release:()=>n.release(),clearStencil:!1}}},r.__decorate([n.property()],e.RenderOccludedRenderNode.prototype,"consumes",void 0),r.__decorate([n.property()],e.RenderOccludedRenderNode.prototype,"produces",void 0),e.RenderOccludedRenderNode=r.__decorate([o.subclass("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],e.RenderOccludedRenderNode);const p=new t,g=[4,2,16],f=g.reduce((e,r)=>e|r,0);e.cleanupRenderOccluded=function(){p.prune()},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});