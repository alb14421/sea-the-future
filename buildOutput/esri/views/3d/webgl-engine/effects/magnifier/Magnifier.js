// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/asyncUtils","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/screenUtils","../../../../../core/urlUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../support/requestImageUtils","../../../webgl","../../../webgl/RenderNode","./MagnifierTechnique","../../lib/glUtil3D","../../../../../chunks/Magnifier.glsl","../../../../magnifier/resources","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],function(e,s,r,i,t,a,o,n,c,l,h,u,m,p,g,_,d,f,y,T,v,P,M){"use strict";e.Magnifier=class extends _{constructor(){super(...arguments),this.produces=g.InternalRenderCategory.MAGNIFIER,this.consumes={required:[g.InternalRenderCategory.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new y.MagnifierPassParameters,this._magnifier=null,this._tmpScreenPoint=o.createScreenPointArray(),this._tmpRenderPoint=o.createRenderScreenPointArray()}initialize(){this.addHandles([a.watch(()=>this.view.magnifier,e=>this._update(e),a.syncAndInitial)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const s=()=>{const e=this._validMagnifier;e?(this._loadResources(e),this.produces=g.InternalRenderCategory.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles(a.watch(()=>this._magnifier?.version,s)),s()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=t.disposeMaybe(this._vao)}_disposeTextures(){this._passParameters.mask=t.disposeMaybe(this._passParameters.mask),this._passParameters.overlay=t.disposeMaybe(this._passParameters.overlay),this._passParameters.input=t.disposeMaybe(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(d.MagnifierTechnique)}render(e){const s=this._validMagnifier,r=e.find(({name:e})=>e===g.InternalRenderCategory.MAGNIFIER);if(null==s)return r;if(null==this._imageSources)return this.requestRender(1),r;const t=this.renderingContext,a=this.camera.pixelRatio,n=Math.ceil(a*s.size);this._vao??=f.createQuadVAO(t,0,0,1);const c=this.techniques.get(d.MagnifierTechnique);if(this._ensureTextureResources(t,n),!c.compiled||!this._passParameters.input)return this.requestRender(1),r;const l=Math.ceil(1/this._factor*n),h=this._passParameters.input;h.resize(l,l),o.screenPointObjectToArray(s.position,this._tmpScreenPoint);const u=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),m=this.camera.fullWidth,p=this.camera.fullHeight,_=.5*l,y=.5*l;u[0]=i.clamp(u[0],_,m-_-1),u[1]=i.clamp(u[1],y,p-y-1);const T=Math.floor(u[0]-_),P=Math.floor(u[1]-y);return t.bindFramebuffer(r.fbo),c.program.bindTexture("textureInput",h),t.gl.copyTexImage2D(h.descriptor.target,0,h.descriptor.pixelFormat,T,P,l,l,0),this._passParameters.magnifier=s,t.bindTechnique(c,this.bindParameters,this._passParameters),t.bindVAO(this._vao),t.drawArrays(v.PrimitiveType.TRIANGLE_STRIP,0,4),r}_loadResources(e){const{maskUrl:s,overlayUrl:i}=e;this._imageLoadTask?.maskUrl===s&&this._imageLoadTask?.overlayUrl===i||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:s,overlayUrl:i,task:r.createTask(async e=>{const r=null==s||null==i?T.loadMagnifierResources(e):null,t=null!=s?p.requestImage(s,{signal:e}):r.then(e=>e.mask),a=null!=i?p.requestImage(i,{signal:e}):r.then(e=>e.overlay);this._imageSources={mask:await t,overlay:await a}})})}_ensureTextureResources(e,s){null==this._imageSources||this._passParameters.size===s&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay||(this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=s,this._imageSources.overlay.height=this._imageSources.mask.height=s,this._passParameters.overlay=new P.Texture(e,this._createTextureDescriptor(s,6408,this._imageSources.overlay),this._imageSources.overlay),this._passParameters.mask=new P.Texture(e,this._createTextureDescriptor(s,6406,this._imageSources.mask),this._imageSources.mask),this._passParameters.input=new P.Texture(e,this._createTextureDescriptor(s,6408,null)))}_createTextureDescriptor(e,s,r){const i=this.renderingContext,t=new M.TextureDescriptor(e);return t.pixelFormat=t.internalFormat=s,t.wrapMode=33071,t.flipped=!!r,t.preMultiplyAlpha=!(6408!==s||!r||n.isSVG(r.src)&&i.driverTest.svgPremultipliesAlpha.result),t}},s.__decorate([c.property()],e.Magnifier.prototype,"produces",void 0),s.__decorate([c.property()],e.Magnifier.prototype,"consumes",void 0),s.__decorate([c.property()],e.Magnifier.prototype,"_imageSources",void 0),s.__decorate([c.property()],e.Magnifier.prototype,"_imageLoadTask",void 0),e.Magnifier=s.__decorate([m.subclass("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],e.Magnifier),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});