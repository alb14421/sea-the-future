// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/FloatArray","../../../../../geometry/support/Indices","./ComponentObjectElevationAgnosticComponentBVH"],function(t,e,n,s,i,o,a,r,h){"use strict";const c=i.create(),m=i.create(),p=n.create(),b=i.create(),l=n.create();t.IntersectionGeometry=class{constructor(t,e,n){this.viewingMode=t,this.positionData=e,this._components=n,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=i.create(),this._componentBvh=null,this._aabb=o.create(),this._indices=e.indices?r.compactIndices(e.indices):r.getContinuousIndexArray(e.positions.length/3),this._positions=e.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(t,e){const n=this._ensureComponentAabbs(),s=6*t;return e[0]=n[s],e[1]=n[s+1],e[2]=n[s+2],e[3]=n[s+3],e[4]=n[s+4],e[5]=n[s+5],e}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(t,e){e.indices=this._indices,e.data=this._positions,e.stride=3,e.startIndex=this._components.offsets[t],e.endIndex=this._components.offsets[t+1]}intersect(t,n,i,o,a,r,h,_){this.verticalOffset=o,this.componentVerticalOffsets=a;const{position:u}=r,g=s.sub(c,t,u),d=s.sub(m,n,u),f=e.invert(p,r.rotationScale);s.transformMat3(g,g,f),s.transformMat3(d,d,f);const C=e.transpose(l,f);if(1===this.viewingMode){const t=this._planetCenter;s.negate(t,u),s.transformMat3(t,t,f)}this._intersectComponents(g,d,a,o,(t,e,n,i)=>{_(n,t,i?s.transformMat3(b,i,C):null,e)},i,h)}_computePerComponentAabbs(){const t=this._aabb,e=.5*(t[0]+t[3]),n=.5*(t[1]+t[4]),s=.5*(t[2]+t[5]),i=this._components.count,o=a.newFloatArray(6*i),r=this._indices,h=this._positions,c=this._components.offsets;let m=0,p=1/0,b=1/0,l=1/0,_=-1/0,u=-1/0,g=-1/0;for(let t=0;t<i;t++){const i=c[t],a=c[t+1];let d=1/0,f=1/0,C=1/0,M=-1/0,A=-1/0,v=-1/0;if(i<a)for(let t=i;t<a;t++){const e=3*r[t],n=h[e],s=h[e+1],i=h[e+2];d=Math.min(d,n),f=Math.min(f,s),C=Math.min(C,i),M=Math.max(M,n),A=Math.max(A,s),v=Math.max(v,i)}else d=e,f=n,C=s,M=e,A=n,v=s;o[m++]=d,o[m++]=f,o[m++]=C,o[m++]=M,o[m++]=A,o[m++]=v,p=Math.min(p,d),b=Math.min(b,f),l=Math.min(l,C),_=Math.max(_,M),u=Math.max(u,A),g=Math.max(g,v)}return this._aabb[0]=p,this._aabb[1]=b,this._aabb[2]=l,this._aabb[3]=_,this._aabb[4]=u,this._aabb[5]=g,o}_intersectComponents(t,e,n,s,i,o,a){let r=this._componentBvh;null==r&&(r=new h.ComponentObjectElevationAgnosticComponentBVH(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=r),r.intersectRay(t,e,n,s,i,o,a)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return 2===this.viewingMode}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});