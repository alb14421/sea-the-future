// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/mathUtils","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingRect","../../lib/triangleIntersectionUtils"],function(t,e,n,i,s){"use strict";function a(t,e,n,i){const s=4*t,a=i[s+0+e];return i[s+2+e]<n?-1:a>n?1:0}class h{constructor(t,e,n,i,s,a,h){this.minIndexIndex=t,this.minMidIndexIndex=e,this.maxMidIndexIndex=n,this.maxIndexIndex=i,this.dim=s,this.d=a,this.aabb2D=h,this.child0=-1,this.child1=-1}}t.ElevationAgnosticBVH=class{constructor(t,e){this.elementCount=t,this.model=e,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=e.localMode,this.planetCenterZ=e.planetCenterZ,this.geometryMinZ=e.geometryMinZ,this.planetCenter=n.fromValues(0,0,this.planetCenterZ),this.maxBspNodeDepth=e.maxBspNodeDepth??8,this.minElementCountForBVH=e.minElementCountForBVH??15,this.minBspNodeElementCount=e.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||0===this._bspNodes.length&&this._generateBsp()}intersectRay(t,e,n){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(n):this._intersectRayWithBVH(t,e,n))}_intersectRayWithoutBVH(t){this._intersectRange(0,this.elementCount)}_intersectRange(t,e){this.model.intersectRange(t,e)}_intersectRayWithBVH(t,e,n){this._ensureBVH(),n?this._intersectGeometryWithBVHVerticalRay(t):this._intersectGeometryWithBVHGeneralRay(t,e)}_intersectGeometryWithBVHVerticalRay(t){let e=t[0],n=t[1];if(!this.localMode){const{geometryMinZ:i,planetCenterZ:s}=this,a=(i-s)/(t[2]-s);e=t[0]*a,n=t[1]*a}const{_bspNodes:i}=this;let s=0;for(;s>=0;){const t=i[s],{d:a,dim:h,minIndexIndex:o,minMidIndexIndex:r,maxMidIndexIndex:c,maxIndexIndex:l,aabb2D:d}=t;if(e<d[0]||e>d[2]||n<d[1]||n>d[3])break;if(-1===h||-1===t.child0&&-1===t.child1){this._intersectRange(o,l);break}{this._intersectRange(r,c);const i=(0===h?e:n)-a;if(i<0){if(-1===t.child0){this._intersectRange(o,r);break}s=t.child0}else{if(!(i>0))break;if(-1===t.child1){this._intersectRange(c,l);break}s=t.child1}}}}_intersectGeometryWithBVHGeneralRay(t,n){let i=t[0],s=t[1],a=n[0],h=n[1];const{geometryMinZ:o}=this;if(!this.localMode){let e=0,r=1;const c=Math.min(.5*this.planetCenterZ,o),l=t[2],d=n[2];if(l<c&&d<c)return;if(l<c&&(e=(c-l)/(d-l)),d<c&&(r=(c-l)/(d-l)),e>r)return;const m=(1-e)*t[0]+e*n[0],u=(1-e)*t[1]+e*n[1],M=(1-e)*t[2]+e*n[2],x=(1-r)*t[0]+r*n[0],p=(1-r)*t[1]+r*n[1],f=(1-r)*t[2]+r*n[2],{planetCenterZ:g}=this,_=o-g,B=_/(M-g);i=m*B,s=u*B;const I=_/(f-g);a=x*I,h=p*I}const r=a-i,c=h-s,l=this._bspNodes;let d=1;{const{aabb2D:t}=l[0],e=(t,e,n,i)=>{if(Math.abs(e)<1e-5*Math.max(i-n,1))return!1;const s=e>0,a=s?i:n,h=t+d*e;return(s?h<a:h>a)&&(d=Math.max((a-t)/e,d),!0)},n=()=>e(i,r,t[0],t[2]),a=()=>e(s,c,t[1],t[3]);Math.abs(r)>=Math.abs(c)?n()||a():a()||n()}const m=[0,0,d];let u=0;for(;u<m.length;){const t=m[u];let n=m[u+1],a=m[u+2];if(u+=3,n>a)continue;const h=l[t],{minIndexIndex:o,maxIndexIndex:M}=h,{child0:x,child1:p,minMidIndexIndex:f,maxMidIndexIndex:g,aabb2D:_,d:B,dim:I}=h;{const t=i+n*r,e=i+a*r,s=Math.min(t,e),h=Math.max(t,e),o=_[0],c=_[2];if(h<o||c<s)continue;if(s<o){const t=(o-i)/r;r>0?n=Math.max(n,t):a=Math.min(a,t)}if(c<h){const t=(c-i)/r;r>0?a=Math.min(a,t):n=Math.max(n,t)}}{const t=s+n*c,e=s+a*c,i=Math.min(t,e),h=Math.max(t,e),o=_[1],r=_[3];if(h<o||r<i)continue;if(i<o){const t=(o-s)/c;c>0?n=Math.max(n,t):a=Math.min(a,t)}if(r<h){const t=(r-s)/c;c>0?a=Math.min(a,t):n=Math.max(n,t)}}if(-1===x&&-1===p)this._intersectRange(o,M);else{const t=0===I?i:s,h=0===I?r:c,l=t+n*h,u=t+a*h,_=Math.min(l,u),b=Math.max(l,u),V=e.clamp((B-t)/h,0,d);o<f&&_<=B&&(-1!==x?(m.push(x),m.push(h>=0?n:Math.max(n,V)),m.push(h>=0?Math.min(a,V):a)):this._intersectRange(o,f)),this._intersectRange(f,g),g<M&&B<=b&&(-1!==p?(m.push(p),m.push(h>=0?Math.max(n,V):n),m.push(h>=0?a:Math.min(a,V))):this._intersectRange(g,M))}}}_generateBsp(){const{elementCount:t}=this;if(t<1)return;const e=s.createUintArray(t,t);this._elementIndexMap=e;for(let n=0;n<t;++n)e[n]=n;const n=this.model.getAabbs2D();let o=0;const r=this._bspNodes;r.length=0;const{localMode:c}=this;let l=!1;if(!c){const{planetCenterZ:t,geometryMinZ:e}=this;l=t>=0||e<.5*t}const d=[],m=(t,e,n,i,s)=>{d.push(t),d.push(e),d.push(n),d.push(i<0?-1:(s?0:1)+2*i)},{maxBspNodeDepth:u,minBspNodeElementCount:M}=this,x=(t,s,o,d,x)=>{const p=r.length;if(p>0&&(l||o>=u||s-t<M))return;const f=i.create();!function(t,e,n,i,s){let a=1/0,h=1/0,o=-1/0,r=-1/0;for(let t=e;t<n;++t){const e=4*i[t];a=Math.min(a,s[e+0]),h=Math.min(h,s[e+1]),o=Math.max(o,s[e+2]),r=Math.max(r,s[e+3])}t[0]=a,t[1]=h,t[2]=o,t[3]=r}(f,t,s,e,n);const{d:g,dim:_}=c?function(t){const e=t[0],n=t[1],i=t[2],s=t[3];let a,h;return i-e>=s-n?(h=.5*(e+i),a=0):(h=.5*(n+s),a=1),{d:h,dim:a}}(f):function(t){const e=t[0],n=t[1],i=t[2],s=t[3];let a,h;return i-e>=s-n?(a=0,h=.5*(e+i)):(a=1,h=.5*(n+s)),{dim:a,d:h}}(f),{rangeMidStart:B,rangeMidEnd:I}=function(t,e,n,i,s,h){let o=t;{let t=e;for(;o<t;){const e=s[o];a(e,n,i,h)<0?++o:(--t,s[o]=s[t],s[t]=e)}}const r=o;let c=o,l=e;for(;c<l;){const t=s[l-1];a(t,n,i,h)>0?--l:(s[l-1]=s[c],s[c]=t,++c)}return{rangeMidStart:r,rangeMidEnd:l}}(t,s,_,g,e,n),b=o===u-1,V=!b&&B>=t+M,y=!b&&s>=I+M;if(V||y||0===p){const e=new h(t,B,I,s,_,g,f);if(V&&m(t,B,o+1,p,!0),y&&m(I,s,o+1,p,!1),r.push(e),-1!==d){const t=r[d];x?t.child0=p:t.child1=p}}};for(m(0,t,0,-1,!1);o<d.length;){const t=d[o],e=d[o+1],n=d[o+2],i=d[o+3];o+=4;const s=i>>1;x(t,e,n,s,i-(s<<1)==0)}this._generatedBVH=!0}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});