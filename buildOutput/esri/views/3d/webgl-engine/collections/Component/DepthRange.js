// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/PooledArray","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../core/libs/gl-matrix-2/math/quat","../../../../../core/libs/gl-matrix-2/factories/quatf64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/plane","../../lib/DepthRange"],function(t,e,n,r,o,a,c,s,l,i){"use strict";const u=new e({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),f=new i.DepthRange,h=s.create(),b=s.create(),g=new e({deallocator:null}),d=new e({deallocator:null});function p(t,e,n){n.length=0;const r=e.length-3;m(h,e,r);const o=l.signedDistance(t,h);o<=0&&(n.push(h[0]),n.push(h[1]),n.push(h[2]));let a=0,s=o;for(;a<r;a+=3){m(b,e,a);const r=l.signedDistance(t,b);if(s*r<0){const t=r/(r-s);c.lerp(h,b,h,t),w(n,h)}r<=0&&w(n,b),s=r,c.copy(h,b)}if(s*o<0){m(b,e,r);const t=o/(o-s);c.lerp(h,b,h,t),w(n,h)}}function m(t,e,n){return c.set(t,e.data[n],e.data[n+1],e.data[n+2])}function w(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2])}function j(t,e,r,a){o.conjugate(D,t.quaternion),c.sub(v,e,t.center),c.transformQuat(v,v,D);const s=t.halfSize,l=8*((v[0]<-s[0]?-1:v[0]>s[0]?1:0)+3*(v[1]<-s[1]?-1:v[1]>s[1]?1:0)+9*(v[2]<-s[2]?-1:v[2]>s[2]?1:0)+13),i=y[l];if(0===i)return i;n.fromQuat(x,t.quaternion),n.scale(x,x,t.halfSize);const u=(e,n)=>{const r=y[l+n+1];return c.set(e,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),c.transformMat3(e,e,x),c.add(e,t.center,e)};return r.length=0,w(r,u(O,0)),w(r,u(R,1)),w(r,u(v,2)),w(r,u(k,3)),a(r),1===i||(r.length=0,w(r,O),w(r,k),w(r,u(v,4)),w(r,u(q,5)),a(r),2===i||(r.length=0,w(r,O),w(r,q),w(r,u(v,6)),w(r,R),a(r))),i}const y=(()=>{const t=new Array(216);let e=0;const n=n=>{for(let r=0;r<n.length;r++)t[e+r]=n[r];e+=8};return n([3,0,6,2,3,1,5,4]),n([2,0,2,3,1,5,4,0]),n([3,1,0,2,3,7,5,4]),n([2,0,1,3,2,6,4,0]),n([1,0,1,3,2,0,0,0]),n([2,1,5,7,3,2,0,0]),n([3,2,0,1,3,7,6,4]),n([2,2,0,1,3,7,6,0]),n([3,3,0,1,5,7,6,2]),n([2,0,1,5,4,6,2,0]),n([1,0,1,5,4,0,0,0]),n([2,1,3,7,5,4,0,0]),n([1,0,2,6,4,0,0,0]),n([0,0,0,0,0,0,0,0]),n([1,1,3,7,5,0,0,0]),n([2,2,3,7,6,4,0,0]),n([1,2,3,7,6,0,0,0]),n([2,3,1,5,7,6,2,0]),n([3,4,0,1,5,7,6,2]),n([2,5,7,6,4,0,1,0]),n([3,5,0,1,3,7,6,4]),n([2,4,5,7,6,2,0,0]),n([1,4,5,7,6,0,0,0]),n([2,5,1,3,7,6,4,0]),n([3,6,0,2,3,7,5,4]),n([2,6,2,3,7,5,4,0]),n([3,7,6,2,3,1,5,4]),t})(),x=r.create(),D=a.create(),v=s.create(),O=s.create(),R=s.create(),k=s.create(),q=s.create();t.computeDepthRange=function(t,e){const n=new i.DepthRange,{eye:r,frustum:o,viewForward:a}=t;e.forAll(t=>{const e=null!=t.offsetObb?t.offsetObb:t.obb,s=c.dot(c.sub(v,e.center,r),a),l=e.projectedRadius(a);if(n.within(s-l)&&n.within(s+l))return;const i=function(t,e){let n=0;for(let r=0;r<4;r++){const o=t.intersectPlane(e[r]);if(o>0)return-1;0===o&&(n|=1<<r)}return n}(e,o);if(-1===i)return;if(0===i)return f.far=s+l,f.near=s-l,void n.union(f);const h=u.pushNew();h.near=s-l,h.far=s+l,h.mask=i,h.object=t});for(let t=0;t<u.length;t++){const e=u.data[t];if(n.within(e.near)&&n.within(e.far))continue;f.far=e.far,f.near=1/0;const s=j(null!=e.object.offsetObb?e.object.offsetObb:e.object.obb,r,g,t=>{let n=d;for(let r=0;r<4&&t.length>0;r++){if(!(e.mask&1<<r))continue;p(o[r],t,n);const a=t;t=n,n=a}for(let e=0;e<t.length;e+=3){c.set(h,t.data[e],t.data[e+1],t.data[e+2]);const n=c.dot(c.sub(h,h,r),a);f.near=Math.min(f.near,n)}});0===s&&(f.near=0),n.union(f)}return u.length=0,n},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});