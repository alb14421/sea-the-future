// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/DoubleArray","./ComponentObjectElevationAgnosticComponentGeometryBVH","./ElevationAgnosticBVH","../../lib/ComponentUtils","../../lib/RayIntersections"],function(t,e,n,o,i,s,a,r,c){"use strict";const l=o.create(),h=n.create(),p=n.create(),m=n.create(),b=n.create(),_=()=>{},u=new c.MeshIntersectionOptions;t.ComponentObjectElevationAgnosticComponentBVH=class{constructor(t,e,o,i,s,r,c,l){this.vertexData=t,this.vertexStride=e,this.indexData=o,this._components=i,this._componentAabbs3D=s,this.geometryMinZ=r,this.planetCenterZ=c,this.localMode=l,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=m,this._ray1=b,this._invDir=n.create(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=u,this._callback=_,this.rayDirectionC=n.create(),this._componentIndexMap=null,this._bvh=new a.ElevationAgnosticBVH(i.count,this),this.componentIntersectionData=new Array(i.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:t,planetCenterZ:e,minZGlobal:n}=this,o=i.newDoubleArray(4*t),s=this._componentAabbs3D;for(let i=0;i<t;++i){const t=6*i,a=s[t+0],r=s[t+1],c=s[t+2],l=s[t+3],h=s[t+4],p=n/(c-e),m=n/(s[t+5]-e),b=Math.min(a*p,a*m),_=Math.min(r*p,r*m),u=Math.max(l*p,l*m),y=Math.max(h*p,h*m),f=4*i;o[f+0]=b,o[f+1]=_,o[f+2]=u,o[f+3]=y}return o}getAabbs2DLocal(){const{numComponents:t}=this,e=i.newDoubleArray(4*t),n=this._componentAabbs3D;for(let o=0;o<t;++o){const t=6*o,i=n[t+0],s=n[t+1],a=n[t+3],r=n[t+4],c=4*o;e[c+0]=i,e[c+1]=s,e[c+2]=a,e[c+3]=r}return e}intersectRay(t,e,n,o,i,s,a){const{isVerticalRay:r}=a;this._ray0=t,this._ray1=e,this._componentVerticalOffsets=n,this._verticalOffset=o,this._tolerance=s,this._intersectionOptions=a,this._componentIndexMap=this._bvh.elementIndexMap,c.computeInvDir(t,e,this._invDir),this._callback=i,this._bvh.intersectRay(t,e,r),this._callback=_}intersectRange(t,e){const n=this._componentIndexMap,{pickability:o,visibility:i}=this._components;for(let s=t;s<e;++s){const t=n?n[s]:s;r.getVisibility(o,t)&&i.isVisible(t)&&this._intersectComponent(t)}}getComponentTriangleCount(t){const e=this._components.offsets,n=e[t]/3;return e[t+1]/3-n}getComponentAabb3D(t,e){const n=this._componentAabbs3D,o=6*t;return e[0]=n[o],e[1]=n[o+1],e[2]=n[o+2],e[3]=n[o+3],e[4]=n[o+4],e[5]=n[o+5],e}_intersectComponent(t){const n=this.getComponentAabb3D(t,l);let o=!1;const{localMode:i,_componentVerticalOffsets:a,_verticalOffset:r,_ray0:m,_ray1:b,_invDir:_,planetCenterZ:u,_tolerance:y,rayDirectionC:f,componentIntersectionData:g}=this,{isVerticalRay:D}=this._intersectionOptions,C=this._components.offsets,v=e.copy(h,m),A=e.copy(p,b),d=a?.[t]??0,x=d+(r?.offset??0);if(0!==x&&(i?(v[2]=m[2]-x,A[2]=b[2]-x,o=!0):null!=r&&(r.componentOffset=d)),null==r||o||0===x||r.applyToAabb(n),!c.intersectAabbInvDir(n,v,_,y))return;e.sub(f,A,v);const M=C[t]/3,O=C[t+1]/3,V=O-M,B=(e,n,o)=>{this._callback(e,n,t,o)},{vertexData:I,vertexStride:R,indexData:Z,_intersectionOptions:E}=this,{normalRequired:k}=E;if(V>40){let e=g[t];null==e&&(e=new s.ComponentObjectElevationAgnosticComponentGeometryBVH(t,I,R,Z,M,O,this.geometryMinZ,u,i),g[t]=e),e.intersectRay(v,A,D,o?0:x,B,k)}else{const t=o?0:x;s.intersectTriangleRangeForComponent(v,f,M,O,Z,I,R,t,u,k,B)}}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});