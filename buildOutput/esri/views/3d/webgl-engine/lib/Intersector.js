// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/ray","../../webgl/RenderCamera","./HUDIntersectorResult","./IntersectorInterfaces","./IntersectorResult","./verticalOffsetUtils"],function(t,e,r,s,i,n,a,o,c){"use strict";const h=1e-5;function l(t,e){return(e??-Number.MAX_VALUE)-(t??-Number.MAX_VALUE)}class f{constructor(){this.min=new o.IntersectorResult(s.create()),this.max=new o.IntersectorResult(s.create()),this.hud={min:new n.HUDIntersectorResult(s.create()),max:new n.HUDIntersectorResult(s.create()),all:new Array},this.ground=new o.IntersectorResult(s.create()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}t.Intersector=class{constructor(t){this.options=new a.IntersectorOptions,this._results=new f,this.transform=new c.IntersectorTransform,this.camera=new i,this.tolerance=h,this.verticalOffset=null,this._ray=s.create(),this._rayEnd=r.create(),this._rayBeginTransformed=r.create(),this._rayEndTransformed=r.create(),this.viewingMode=t??1}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,e,r){this.resetWithRay(s.fromPoints(t,e,this._ray),r)}resetWithRay(t,r){this.camera=r,t!==this._ray&&s.copy(t,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,e.add(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,e,r,s,i){this.point=e,this.filterPredicate=s,this.tolerance=r??h;const n=c.getVerticalOffsetObject3D(this.verticalOffset);if(t&&t.length>0){const e=i?t=>{i(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const r of t){const t=r.getSpatialQueryAccelerator?.();null!=t?(null!=n?t.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,e,n):t.forEachAlongRay(this._ray.origin,this._ray.direction,e),this.options.selectionMode&&this.options.hud&&t.forEachDegenerateObject(e)):r.objects.forEach(t=>e(t))}}this.sortResults()}intersectObject(t){const r=t.geometries;if(!r)return;const s=t.effectiveTransformation,i=c.getVerticalOffsetObject3D(this.verticalOffset);for(const n of r){if(!n.visible)continue;const{material:r,id:a}=n;if(!r.visible)continue;this.transform.setAndInvalidateLazyTransforms(s,n.transformation),e.transformMat4(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),e.transformMat4(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const o=this.transform.transform;null!=i&&(i.objectTransform=this.transform),r.intersect(n,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(e,r,s,i)=>this.handleObjectIntersection({object:t,geometryId:a,primitiveIndex:s},e,r,o,i))}}handleObjectIntersection(t,e,r,s,i){if(e<0||null!=this.filterPredicate&&!this.filterPredicate(this._ray.origin,this._rayEnd,e))return;const a=i?this._results.hud:this._results;t=i?new n.HUDTarget(t,i):t;const c=i?s=>s.set(1,t,e,r):i=>i.set(0,t,e,r,s);if((null==a.min.distance||e<a.min.distance)&&c(a.min),0!==this.options.store&&(null==a.max.distance||e>a.max.distance)&&c(a.max),2===this.options.store)if(i){const t=new n.HUDIntersectorResult(this._ray);c(t),this._results.hud.all.push(t)}else{const t=new o.IntersectorResult(this._ray);c(t),this._results.all.push(t)}}sortResults(t=this._results.all){t.sort((t,e)=>t.distance!==e.distance?(t.distance??0)-(e.distance??0):t.drapedLayerOrder!==e.drapedLayerOrder?l(t.drapedLayerOrder,e.drapedLayerOrder):l(t.renderPriority,e.renderPriority))}},t.defaultTolerance=h,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});