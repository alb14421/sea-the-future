// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/arrayUtils","../../../../../core/Error","../../../../../core/MapUtils","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../support/debugFlags","../../../support/buffer/glUtil","../../../webgl/RenderCamera","../../effects/RenderPlugin","../DepthRange","../Util","./InstanceData","./InstanceOctree","./LevelSelector","./LodLevel","./RenderInstanceData","../../materials/internal/MaterialUtil","../../materials/renderers/utils","../../shaders/DefaultMaterialTechnique","../../../../support/HighlightDefaults","../../../../support/Scheduler","../../../../webgl/Util","../../../../webgl/VertexAttributeLocations"],function(e,t,a,r,n,s,i,o,l,c,d,h,u,_,g,f,p,m,y,v,b,R,I,D,C,L,E,x,S,w,M,O,T){"use strict";function A(e,t,a){const r=e.allocateHead();var n,s,i,o;n=t,s=a,i=e.view,o=r,x.encodeDoubleVec3(n.modelOrigin,s,i.modelOriginHi,i.modelOriginLo,o),i.model.copyFrom(o,n.model,s),i.modelNormal.copyFrom(o,n.modelNormal,s),n.color&&i.color&&i.color.copyFrom(o,n.color,s),n.olidColor&&i.olidColor&&i.olidColor.copyFrom(o,n.olidColor,s),n.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(o,n.featureAttribute,s)}e.LodRenderer=class extends y.AsyncRenderPlugin{constructor(e,t){super(e),this.type=6,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new m,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,e=>this._produces(e)],[4,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new R.InstanceData({shaderTransformation:e.shaderTransformation},e.symbol.materialParameters),this.addHandles(t.registerTask(M.TaskPriority.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=L.getRenderInstanceDataLayout(this.symbol.materialParameters),this._glInstanceBufferLayout=p.glLayout(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on("instance-visibility-changed",({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDatas)t[0]!==w.defaultHighlightName&&e.push(t[1]);return e}hasHighlight(e){return this._highlightRenderInstanceDatas.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some(e=>e.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((e,t)=>t.reduce((e,t)=>e+t.usedMemory,e),this._levels.reduce((e,t)=>e+t.components.reduce((e,t)=>e+t.usedMemory,0),0))}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach((e,a)=>{const r=this._allRenderInstanceData[0][a].size+this._allRenderInstanceData[1][a].size,n=e.triangleCount;t.push({renderedInstances:r,renderedTriangles:r*n,trianglesPerInstance:n})}),{totalInstances:e,renderedInstances:t.reduce((e,t)=>e+t.renderedInstances,0),renderedTriangles:t.reduce((e,t)=>e+t.renderedTriangles,0),levels:t}}_createRenderInstanceDataArray(){const{rctx:e}=this._context.renderContext;return this.symbol.levels.map(t=>new L.RenderInstanceData(e,this._instanceBufferLayout))}async initializeRenderContext(e,t){this._context=e,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();const r=await Promise.allSettled(this.symbol.levels.map(a=>C.LodLevel.create(e,a,t))),n=r.map(e=>"fulfilled"===e.status?e.value:null).filter(a.isSome);if(i.isAborted(t)||n.length!==r.length){n.forEach(e=>e.destroy()),i.throwIfAborted(t);for(const e of r)if("rejected"===e.status)throw e.reason}this._levels=n,this._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,a=e.levels.map(e=>e.minScreenSpaceRadius);return new D.LevelSelector(t,a)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceDatas.forEach(e=>e.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(e=>e.components.some(e=>{const t=e.material.produces.get(4);return t?.(0)}))}hasHighlights(){return n.someMap(this._highlightRenderInstanceDatas,e=>e.some(e=>e.size>0))}_produces(e){return(8!==e||this.hasHighlights())&&(5!==e||this.hasHighlight(w.defaultHighlightName))}prepareRender(e){if(!f.debugFlags.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(M.noBudget),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e);if(!t)return null;const a=new Array,r=this.levels;return t.forEach(t=>r.forEach(({components:r},n)=>r.forEach(r=>a.push(this._beginComponent(e,t[n],r))))),a}render(e,t){const a=this._getInstanceDatas(e);if(!a||null==t)return;let r=0;const n=this.levels;a.forEach(a=>n.forEach(({components:n},s)=>n.forEach(n=>this._renderComponent(e,t[r++],a[s],n,s)))),e.rctx.unbindBuffer(34962),e.rctx.bindVAO(null)}_getInstanceDatas(e){const{output:t,bind:a}=e,r=8===t,n=5===t,s=6!==t;if(!r&&!n)return s?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDatas:i}=this;if(s){if(r){const e=a.highlight?.name;if(!e)return null;const t=i.get(e);return t?[t]:null}const e=i.get(w.defaultHighlightName);return n?e?[e]:null:Array.from(i.values())}return null}intersect(e,t,a,r){if(!this.baseMaterial.visible||null==this._octree)return;const n=_.create();u.subtract(n,r,a);const s=n=>{this._instanceData.getCombinedModelTransform(n,P),e.transform.set(P),u.transformMat4(B,a,e.transform.inverse),u.transformMat4(F,r,e.transform.inverse);const s=this._instanceData.getState(n),i=this._instanceData.getLodLevel(n),o=this._levels.length;b.assert(!!(18&s),"invalid instance state"),b.assert(i>=0&&i<o,"invaid lod level"),this._levels[i].intersect(e,t,B,F,n,this.metadata,o)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(s):this._octree.forEachAlongRay(a,n,s)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){const e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new I.InstanceOctree(e,this.baseBoundingSphere);for(let a=0;a<e.capacity;++a)18&t.get(a)&&this._octreeCached.addInstance(a)}return this._octreeCached}_invalidateOctree(){this._octreeCached=s.destroyMaybe(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return new v.DepthRange;const t=e.viewForward,a=this._octree.findClosest(t,1,e.frustum),r=this._octree.findClosest(t,-1,e.frustum);if(null==a||null==r)return new v.DepthRange;const n=e.eye,s=this._instanceData.view;s.boundingSphere.getVec(a,H),u.subtract(H,H,n);const i=u.dot(H,t)-H[3];s.boundingSphere.getVec(r,H),u.subtract(H,H,n);const o=u.dot(H,t)+H[3];return new v.DepthRange(i,o)}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:a,_levelSelector:s}=this;this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.beginUpdate()));const i=this._instanceData,o=i.view;let l=i.size;const c=i.capacity;let d=this._instanceIndex;const h=Math.ceil(c/500),{_highlightRenderInstanceDatas:u}=this;for(let _=0;_<l&&!e.done;++_){d===this._cycleStartIndex&&this._startUpdateCycle();const _=o.state.get(d);let g=0;if(!(1&_)){d=d+1===c?0:d+1,l++;continue}const f=o.lodLevel.get(d);if(2&_&&this._defaultRenderInstanceData[f].freeTail(),16&_){const e=i.geHighlightOptionsPrev(d);if(e){const t=u.get(e);if(!t)throw new r("internal:lod-renderer","Internal error in lodRenderer");t[f].freeTail(),t.every(e=>e.isEmpty)&&(t.forEach(e=>e.destroy()),u.delete(e))}}if(32&_)i.freeInstance(d);else if(4&_){let e=0;if(t&&(o.modelOrigin.getVec(d,U),e=s.selectLevel(U,i.getCombinedMedianScaleFactor(d),a)),g=-83&_,e>=0)if(8&_){const t=i.getHighlightName(d);if(t){const a=()=>{const e=this._createRenderInstanceDataArray();return e.forEach(e=>e.beginUpdate()),e},s=n.getOrCreateMapValue(u,t,a);if(e>=s.length)throw new r("internal:lod-renderer",`LodRenderer internal error - missing lodLevel ${e}`);A(s[e],o,d)}g|=16}else A(this._defaultRenderInstanceData[e],o,d),g|=2;o.state.set(d,g),o.lodLevel.set(d,e)}else g=-83&_,o.state.set(d,g);if(null!=this._octreeCached){const e=!!(18&_),t=!!(18&g);!e&&t?this._octreeCached.addInstance(d):e&&!t?this._octreeCached.removeInstance(d):e&&t&&64&_&&(this._octreeCached.removeInstance(d),this._octreeCached.addInstance(d))}d=d+1===c?0:d+1,d%h===0&&e.madeProgress()}this._instanceIndex=d,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.endUpdate())),this._context.requestRender()}_beginComponent(e,t,a){if(0===t.size)return null;const r=a.glMaterials.load(e.rctx,e.bind.slot,e.output);return r?.beginSlot(e.bind)}_renderComponent(e,t,a,r,n){if(!t)return;const{bind:s,rctx:i}=e;i.runAppleAmdDriverHelper();const o=i.bindTechnique(t,s,r.material.parameters,q),l=this._glInstanceBufferLayout;o.assertCompatibleVertexAttributeLocations(r.vao,T.fromLayout(l)),i.bindVAO(r.vao),f.debugFlags.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.output&&(o.setUniform4fv("externalColor",V[Math.min(n,V.length-1)]),o.setUniform1i("symbolColorMixMode",E.colorMixModes.replace));const c=a.capacity,d=a.headIndex,h=a.tailIndex,u=a.firstIndex,_=(e,n)=>{O.bindVertexBufferLayout(i,o.locations,a.buffer,e),i.drawArraysInstanced(t.primitiveType,0,r.numVertices,n-e)};r.material.transparent&&null!=u?d>h?(b.assert(u>=h&&u<=d,"invalid firstIndex"),_(u,d),_(h,u)):d<h&&(u<=d?(b.assert(u>=0&&u<=d,"invalid firstIndex"),_(u,d),_(h,c),_(0,u)):(b.assert(u>=h&&u<=c,"invalid firstIndex"),_(u,c),_(0,d),_(h,u))):d>h?_(h,d):d<h&&(_(0,d),_(h,c))}},t.__decorate([o.property({constructOnly:!0})],e.LodRenderer.prototype,"symbol",void 0),t.__decorate([o.property({constructOnly:!0})],e.LodRenderer.prototype,"metadata",void 0),t.__decorate([o.property({constructOnly:!0})],e.LodRenderer.prototype,"shaderTransformation",void 0),t.__decorate([o.property()],e.LodRenderer.prototype,"_instanceData",void 0),t.__decorate([o.property()],e.LodRenderer.prototype,"_cycleStartIndex",void 0),t.__decorate([o.property({readOnly:!0})],e.LodRenderer.prototype,"_enableLevelSelection",null),t.__decorate([o.property()],e.LodRenderer.prototype,"_updateCyclesWithStaticCamera",void 0),t.__decorate([o.property({readOnly:!0})],e.LodRenderer.prototype,"readyToRun",null),e.LodRenderer=t.__decorate([d.subclass("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],e.LodRenderer);const U=_.create(),H=g.create(),P=h.create(),B=_.create(),F=_.create(),V=[g.freeze(1,0,1,1),g.freeze(0,0,1,1),g.freeze(0,1,0,1),g.freeze(1,1,0,1),g.freeze(1,0,0,1)],q=new S.DefaultMaterialDrawParameters;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});