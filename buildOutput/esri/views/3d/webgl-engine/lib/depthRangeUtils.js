// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/PooledArray","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/frustum","../../../../chunks/sphere","../../support/mathUtils","./DepthRange","./Util"],function(e,t,n,r,a,i,s,o,h,f,c,l){"use strict";function u(e,t,r){if(!r.visible)return;if(!o.intersectsSphere(t.frustum,r.boundingVolumeWorldSpace.bounds))return;const a=r.transformation,i=w;r.geometries.forEach(r=>{n.multiply(i,a,r.transformation);const s=f.maxScale(i);d(e,t,r.boundingInfo,i,s)})}function d(e,t,n,r,i){if(null==n)return;a.transformMat4(h.getCenter(M),n.center,r);const{eye:s,viewForward:f}=t,c=f[0]*(M[0]-s[0])+f[1]*(M[1]-s[1])+f[2]*(M[2]-s[2]);if(M[3]=n.radius*i,!(c-M[3]>e.near&&c+M[3]<e.far)&&o.intersectsSphere(t.frustum,M))if(n.radius>100&&n.getChildren())for(const a of n.getChildren())d(e,t,a,r,i);else S.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,n.bbMin,n.bbMax)}function g(e,t,n){const r=t.eye,a=t.viewForward,i=(n[0]-r[0])*a[0]+(n[1]-r[1])*a[1]+(n[2]-r[2])*a[2];e.near=Math.min(e.near,i-n[3]),e.far=Math.max(e.far,i+n[3])}class _{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new c.DepthRange(0,0)}compute(e,t,n){this._reset();const{viewMatrix:r}=e;t.forEach(e=>{e.forEachGeometry(e=>{if(!e.visible||0===n&&!e.castShadow)return;const t=e.boundingSphere,a=r[2]*t[0]+r[6]*t[1]+r[10]*t[2]+r[14],i=a-t[3],s=a+t[3];this._geometries.push(e),this._near.push(-s),this._far.push(-i)})});const a=new c.DepthRange;if(0===this._geometries.length)return a;for(let e=0;e<this._geometries.length;++e)this._near[e]>a.far&&(a.far=this._near[e]),this._near[e]>2&&this._far[e]<a.near&&(a.near=this._far[e]);const i=this._looseRange;i.near=Math.max(.5*a.near,2),i.far=2*a.far;let s=0,o=0;for(let e=0;e<this._geometries.length;++e)this._near[e]<a.near&&(this._near[e]>=i.near?a.near=this._near[e]:this._nearCandidates[s++]=e),this._far[e]>a.far&&(this._far[e]<=i.far?a.far=this._far[e]:this._farCandidates[o++]=e);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return a;this._nearCandidates.sort((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0),this._farCandidates.sort((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0);for(let t=0;t<this._nearCandidates.length;++t){const n=this._nearCandidates[t];if(this._near[n]<a.near){const t=this._geometries[n],{boundingInfo:r,shaderTransformation:i}=t;this._includeNearBoundingInfoRec(e,r,i,a)}}for(let t=0;t<this._farCandidates.length;++t){const n=this._farCandidates[t];if(this._far[n]>a.far){const t=this._geometries[n],{boundingInfo:r,shaderTransformation:i}=t;this._includeFarBoundingInfoRec(e,r,i,a)}}return this._reset(),a}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(e,t){const n=h.getCenter(e),r=h.getRadius(e);return t[0][0]*n[0]+t[0][1]*n[1]+t[0][2]*n[2]+t[0][3]>r||t[1][0]*n[0]+t[1][1]*n[1]+t[1][2]*n[2]+t[1][3]>r||t[2][0]*n[0]+t[2][1]*n[1]+t[2][2]*n[2]+t[2][3]>r||t[3][0]*n[0]+t[3][1]*n[1]+t[3][2]*n[2]+t[3][3]>r}_includeNearBoundingInfoRec(e,t,n,r){if(null==t)return;const i=t.center;a.transformMat4(h.getCenter(M),i,n),M[3]=t.radius*f.maxScale(n);const{frustum:s}=e;if(this._isOutsideSidePlanes(M,s))return;const o=M[0],c=M[1],l=M[2],u=M[3],{viewMatrix:d}=e,g=d[2]*o+d[6]*c+d[10]*l+d[14],_=g+u;if(!(-(g-u)<2||-_>=r.near))if(-_>this._looseRange.near)r.near=-_;else{if(u>100){const a=t.getChildren();if(void 0!==a){for(const t of a)this._includeNearBoundingInfoRec(e,t,n,r);return}}S.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,n,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(e,t,n,r){if(null==t)return;const i=t.center;a.transformMat4(h.getCenter(M),i,n),M[3]=t.radius*f.maxScale(n);const{frustum:s}=e;if(this._isOutsideSidePlanes(M,s))return;const[o,c,l,u]=M,{viewMatrix:d}=e,g=d[2]*o+d[6]*c+d[10]*l+d[14]-u;if(!(-g<=r.far))if(-g<this._looseRange.far)r.far=-g;else{if(u>100){const a=t.getChildren();if(void 0!==a){for(const t of a)this._includeFarBoundingInfoRec(e,t,n,r);return}}S.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,n,t.bbMin,t.bbMax)}}}function m(e,t,n){let r=[e,t,n];for(let e=0;e<4;++e){const t=r;r=[];for(let n=0;n<t.length;++n){const a=t[n],i=t[(n+1)%t.length];p(i,e)?(p(a,e)||r.push(b(a,i,e)),r.push(i)):p(a,e)&&r.push(b(a,i,e))}}return r}function p(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void l.assert(!1)}function b(e,t,n){let r=0;return 0===n?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===n?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===n?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===n&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),i.lerp(s.create(),e,t,r)}const R=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],M=h.create(),w=r.create(),C=new c.DepthRange,x=new class{constructor(){this._items=new t({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,n=e.viewForward;this._items.forAll(e=>{const r=e.object.boundingVolumeWorldSpace.bounds,a=(r[0]-t[0])*n[0]+(r[1]-t[1])*n[1]+(r[2]-t[2])*n[2];e.distance=a,e.near=a-r[3],e.far=a+r[3]}),this._items.sort((e,t)=>e.distance-t.distance)}forEachInDepthRange(e,t,n){if(1===t)for(let t=0;t<this._items.length;++t){const r=this._items.data[t];r.far<e.near||r.near>e.far||n(r.object,r.near,r.far)}else for(let t=this._items.length-1;t>=0;--t){const r=this._items.data[t];r.far<e.near||r.near>e.far||n(r.object,r.near,r.far)}}},v=new _,S=new class{constructor(){this._modelViewProj=r.create(),this._clipPosition=[s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create()]}unionDepthRangeWithAABB(e,t,r,a,i){const s=this._modelViewProj;n.multiply(s,t,r);let o=!1;for(let e=0;e<8;++e){const t=this._clipPosition[e],n=0===e||3===e||4===e||7===e?a[0]:i[0],r=0===e||1===e||4===e||5===e?a[1]:i[1],o=e<4?a[2]:i[2];t[0]=s[0]*n+s[4]*r+s[8]*o+s[12],t[1]=s[1]*n+s[5]*r+s[9]*o+s[13],t[2]=s[2]*n+s[6]*r+s[10]*o+s[14],t[3]=s[3]*n+s[7]*r+s[11]*o+s[15]}for(let t=0;t<12;++t){const n=m(this._clipPosition[R[t][0]],this._clipPosition[R[t][1]],this._clipPosition[R[t][2]]);let r=!0;for(let e=0;e<n.length;++e)if(n[e][3]>=2){r=!1;break}if(!r){o=!0;for(let t=0;t<n.length;++t){const r=n[t][3];Number.isFinite(r)&&(e.near=Math.min(r,e.near),e.far=Math.max(r,e.far))}}}return o}};e.DepthRangeFromRenderGeometries=_,e.depthRangeFromScene=function(e,t,n,r){let a=0;if(!t.some(e=>!!e.material&&(a+=e.numGeometries,a>=1e4)))return v.compute(e,t,r);const i=new c.DepthRange;return n.forEach(t=>i.union(function(e,t){if(!t.visible)return;const n=new c.DepthRange,r=t.getSpatialQueryAccelerator();return r?function(e,t,n){const{eye:r,viewForward:a,frustum:i}=t,s=e=>e.visible,o=n.objectCount;if(o<500)C.set(t.near,Math.min(e.near,t.far)),n.forEachInDepthRange(r,a,1,C,(n,r)=>{u(e,t,n),C.far=e.near,r.setRange(C)},i,s),C.set(Math.max(e.far,t.near),t.far),n.forEachInDepthRange(r,a,-1,C,(n,r)=>{u(e,t,n),C.near=e.far,r.setRange(C)},i,s);else{const r=Math.max(Math.min(o,500),Math.ceil(.1*o)),h=n.findClosest(a,1,i,s,r),f=n.findClosest(a,-1,i,s,r);h&&f&&(g(e,t,h.boundingVolumeWorldSpace.bounds),g(e,t,f.boundingVolumeWorldSpace.bounds))}}(n,e,r):function(e,t,n){x.clear(),n.forEach(e=>{e.visible&&0!==e.geometries.length&&x.add(e)}),x.empty||(x.sort(t),C.set(t.near,Math.min(e.near,t.far)),x.forEachInDepthRange(C,1,(n,r)=>{r<e.near&&u(e,t,n)}),C.set(Math.max(e.far,t.near),t.far),x.forEachInDepthRange(C,-1,(t,n,r)=>{e.far=Math.max(e.far,r)}))}(n,e,t.objects),n}(e,t))),i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});