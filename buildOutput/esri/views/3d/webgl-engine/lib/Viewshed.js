// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Collection","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/sphere","../../webgl","../../webgl/RenderNode","./ViewshedShadowMap","../../../../chunks/Viewshed.glsl","../shaders/ViewshedTechnique"],function(e,s,t,r,i,a,o,n,d,h,c,p,w,l,u,f,_,v,m,V,g){"use strict";function y(e,s,t){const r=u.fromValues(.5,.5,.5);return p.fromTranslation(t,r),p.scale(t,t,r),p.mul(t,t,e),p.mul(t,t,s),t}function b(e,s,t){if(null==e)return 0;const{observerRenderSpace:r,targetRenderSpace:i}=e,a=l.distance(t,r)>l.distance(t,i)?e.observer:e.target;return s.pixelSizeAt(a)}e.Viewshed=class extends v{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(e=>function(e,s){const t=f.fromCenterAndRadius(s.observerRenderSpace,s.farDistanceRenderSpace);return!!e.ready&&e.frustum.intersectsSphere(t)}(this.view,e))}constructor(e){super(e),this.isDecoration=!1,this._passParameters=new V.ViewshedPassParameters,this._viewsheds=new t,this._shadowMap=null,this.consumes={required:[_.InternalRenderCategory.VIEWSHED,"normals"]},this.produces=_.InternalRenderCategory.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new m.ViewshedShadowMap(this.fboCache),this.addHandles([a.watch(()=>this.view.resolutionScale,e=>{const s=this._shadowMap;s&&(s.settings.textureSizeQuality=e)},a.initial),a.when(()=>!this.hasViewsheds,()=>this._shadowMap?.dispose()),a.watch(()=>this._viewshedsInView.map(e=>[e.observerRenderSpace,e.heading,e.tilt,e.farDistance,e.horizontalFieldOfView,e.verticalFieldOfView]),()=>this.requestRender(1),a.sync)])}destroy(){this._shadowMap=i.disposeMaybe(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(g.ViewshedTechnique);for(const e of this._viewshedsInView)if(this._shadowMap?.isActive(e))return void this.view.stage.renderer.precompileViewshedShadowMap()}}render(e){const s=this.bindParameters,t=this.renderingContext,r=e.find(({name:e})=>e===_.InternalRenderCategory.VIEWSHED);if(!this.hasViewsheds||!s.depth||this.isDecoration&&!s.decorations)return r;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=e.find(({name:e})=>"normals"===e)?.getTexture();const i=this.techniques.get(g.ViewshedTechnique);if(!i?.compiled)return this.requestRender(1),r;const a=this.view.stage.renderer.isFeatureEnabled(7);for(const e of this._viewshedsInView){if(!this._renderShadowCubeMap(s,e,a)||!this._shadowMap?.ready)continue;const o=this._setupViewshedParameters(e,s.camera);t.bindTechnique(i,s,o),t.bindFramebuffer(r.fbo),t.screen.draw()}return this.shadowMap?.dispose(),r}updateViewsheds(e){const s=this._viewsheds,{removes:t,adds:r}=e;if(t&&(Array.isArray(t)?s.removeMany(t):s.remove(t)),r)if(Array.isArray(r)){const e=r.filter(e=>!s.includes(e));s.addMany(e)}else s.includes(r)||s.add(r)}_renderShadowCubeMap(e,s,t){const r=this._shadowMap;if(!r)return!1;const i=this.view.basemapTerrain.hasStencilEnabledExtents,a=r.start(e.camera,s,t,this._contentPixelRatio,i);return a&&r.faces.forEach(e=>this.view.stage.renderer.renderViewshedShadowMap(e)),r.finish(),a}_setupViewshedParameters(e,s){const t=this._shadowMap;if(!t)return this._passParameters;const i=this._passParameters,a=e.effectiveObserverRenderSpace;i.localOrigin=a,i.observerOffset=l.sub(M,e.observerRenderSpace,e.effectiveObserverRenderSpace),i.fovs=[r.deg2rad(e.horizontalFieldOfView),r.deg2rad(e.verticalFieldOfView)],i.headingAndTilt=[r.deg2rad(e.heading),r.deg2rad(e.tiltParallelToSurface)],i.upVector=e.tiltedUpVector;const o=function(e,s){const t=u.create();return l.sub(t,e,s)}(e.targetRenderSpace,a);i.targetVector=o;const n=new Array,d=new Array;for(let e=0;e<t.numActiveFaces;e++)p.translate(S,t.viewshedViewMatrices[e],a),n.push(...S),y(t.viewshedProjectionMatrices[e],S,R),d.push(...R);return i.viewMatrices=n,i.projectionMatrices=d,i.volumeOffset=this.selectedViewshed?.()===e.viewshed?b(e,this.view,s.eye):0,i}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}},s.__decorate([o.property()],e.Viewshed.prototype,"selectedViewshed",void 0),s.__decorate([o.property()],e.Viewshed.prototype,"isDecoration",void 0),s.__decorate([o.property()],e.Viewshed.prototype,"shadowMap",null),s.__decorate([o.property()],e.Viewshed.prototype,"hasViewsheds",null),s.__decorate([o.property()],e.Viewshed.prototype,"_contentPixelRatio",null),s.__decorate([o.property()],e.Viewshed.prototype,"_viewshedsInView",null),s.__decorate([o.property()],e.Viewshed.prototype,"consumes",void 0),s.__decorate([o.property()],e.Viewshed.prototype,"produces",void 0),e.Viewshed=s.__decorate([c.subclass("esri.views.3d.webgl-engine.lib.Viewshed")],e.Viewshed);const M=u.create(),S=w.create(),R=w.create();e.computeOffsetScale=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});