// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/Logger","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../core/support/UpdatingHandles","../../../../../chunks/sphere","../../../../../chunks/vec33","../../collections/Component/Material/shader/ComponentData.glsl","../../core/util/TwoVectorPosition","../Attribute","../GridLocalOriginFactory","../localOriginHelper","../LocalOriginManager","../Object3D","../VertexArrayObject","./bufferLayouts","./EdgeRenderer","./EdgeShaderParameters","./EdgeWorkerHandle","./strokes","./util","../TextureBackedBuffer/BufferManager","../../../../webgl/VertexBuffer"],function(e,t,r,n,s,i,o,a,c,d,l,u,h,g,p,f,m,y,_,b,w,E,O,x,M,v,j,T,R,C,V,L,P,A,D){"use strict";function B(e){e?.vao&&(e.vao.buffer("instances")?.dispose(),e.vao.disposeVAOOnly(),e.vao=null)}e.EdgeView=class extends r{constructor(e){super(e),this._updatingHandles=new m.UpdatingHandles,this._objectEntries=new Map,this._pendingDeletions=new Map,this._renderers=new Map,this._gpuMemoryUsage=0,this._workerAbort=new AbortController,this._tmpModelPosition=f.create(),this._localOrigins=new M.LocalOriginManager(new O.GridLocalOriginFactory(e.renderSR));const t=T.VertexLayout.createBuffer(4);for(let e=0;e<4;e++)t.sideness.set(e,0,0===e||3===e?0:1),t.sideness.set(e,1,0===e||1===e?0:1);this._vertexBuffer=new D.VertexBuffer(e.rctx,T.glVertexLayout,t.buffer)}initialize(){this._workerHandle=new V.EdgeWorkerHandle(this.schedule),this._componentColorManager=new A.BufferManager(this.rctx,3)}destroy(){this.destroyed||(this._objectEntries.forEach(e=>this._discardObjectEntry(e)),this._objectEntries.clear(),this._pendingDeletions.forEach(e=>this._discardObjectEntry(e)),this._pendingDeletions.clear(),this._strokesTexture=a.disposeMaybe(this._strokesTexture),this._componentColorManager=a.destroyMaybe(this._componentColorManager),this._workerAbort.abort(),this._workerHandle.destroy(),this._vertexBuffer.dispose(),this._renderers.clear(),this._updatingHandles.destroy(),this._set("schedule",W))}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return this._renderers.size>0}async addComponentObject(e,t,r,n,s,i,o){if(this.hasObject(e))return this._getObjectMemoryUsage(e);let a;const c=new k(null,new Promise(e=>a=e),e.obb.center,e.obb.radius);this._objectEntries.set(e,c);const d=await this._updatingHandles.addPromise(this._addComponentGeometry(e.transform,c,t,r,n,s,i,o));return this.setNeedsRender(),a(),d}async addOrUpdateObject3D(e,t,r,s){if(this.destroyed)return void i.getLogger(this).warn("Attempt to add an object to a destroyed instance");const o=new AbortController;let a;const d=e.boundingVolumeWorldSpace.bounds,l=new k(o,new Promise(e=>a=e),y.getCenter(d),y.getRadius(d)),u=this._objectEntries.get(e);u&&(this._pendingDeletions.has(e)?this._discardObjectEntry(u):this._pendingDeletions.set(e,u)),this._objectEntries.set(e,l);try{const i=new Array;if(e.geometries.length>1&&function(e){let t=null,r=null;for(const s of e.geometries)if(s.material.supportsEdges){if(t){if(!n.equals(t,s.transformation))return!1}else t=s.transformation;if(r||null==s.localOrigin){if(null!=r?.localOrigin&&null!=s.localOrigin&&r.localOrigin.id!==s.localOrigin.id)return!1}else r=s}return!0}(e))i.push(this._addObjectMergedGeometries(e,l,t,r,s));else for(const n of e.geometries)n.material.supportsEdges&&i.push(this._addGeometry(e,l,n,t,r,s));await this._updatingHandles.addPromise(Promise.all(i)),this._removePendingDeletion(e)}catch(t){c.isAbortError(t)?this._discardObjectEntry(l):this._removePendingDeletion(e)}finally{this.setNeedsRender(),a()}}removeObject(e){const t=this._objectEntries.get(e);this._objectEntries.delete(e),this._discardObjectEntry(t),this._removePendingDeletion(e)}_removePendingDeletion(e){const t=this._pendingDeletions.get(e);this._pendingDeletions.delete(e),this._discardObjectEntry(t)}async _getObjectEntry(e){const t=this._objectEntries.get(e);if(!t)throw new Error("no object");return await t.loaded,null==t.loaded?null:t}fastUpdateObject3DEdgesTransform(e){if(this.destroyed)return!1;const t=this._objectEntries.get(e);if(!t)return!1;const{geometries:r}=e,{renderables:n}=t;if(0===r.length||0===n.length)return!0;if(n.length>1)return!1;const[s]=n,i=s.transform;if(!(i instanceof I))return!1;const[o]=r;if(o.localOrigin!==i.origin.origin)return!1;const a=g.create(),c=this._computeModelTransformWithLocalOrigin(e,o,a);return s.transform=new I(a,c),this.setNeedsRender(),!0}_discardObjectEntry(e){e&&(e.abort?.abort(),e.renderables.length&&(e.renderables.forEach(e=>this._removeRenderable(e)),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this._objectEntries.has(e)}async updateAllComponentOpacities(e,t){const r=await this._updatingHandles.addPromise(this._getObjectEntry(e));if(null==r)return;const n=Array.isArray(t)?e=>t[e]:()=>t;r.renderables.forEach(e=>{const t=e.components.meta.length;for(let r=0;r<t;r++){const t=n(r),s=e.components.meta[r],i=s.index;s.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(i,1,3,255*t)}this._updateTransparency(e)}),this.setNeedsRender()}async _getObjectMemoryUsage(e){const t=await this._getObjectEntry(e);return t?t.renderables.reduce((e,t)=>e+t.statistics.gpuMemoryUsage,0):0}async updateAllComponentMaterials(e,t,r,n){const s=e instanceof v.Object3D,i=P.determineRendererType(t),o=R.EdgeRenderer.getKey(i,r,s),a=await this._updatingHandles.addPromise(this._getObjectEntry(e));null!=a&&(a.renderables.forEach(e=>{if(o!==e.rendererKey){const t=this._renderers.get(e.rendererKey),n=this._acquireRenderer(i,r,s);t.removeRenderable(e),--t.refCount,e.rendererKey=o,n.addRenderable(e)}if(Array.isArray(t))for(let r=0;r<t.length;r++)e.components.meta[r].material=t[r];else e.components.meta[0].material=t;n&&q(e.components),this._updateTransparency(e)}),this.setNeedsRender())}async updateAllVerticalOffsets(e,t){const r=await this._updatingHandles.addPromise(this._getObjectEntry(e));null!=r&&this._updateAllVerticalOffsets(r,t)}_updateAllVerticalOffsets(e,t){e.renderables.forEach(e=>{const r=e.components.meta;for(let n=0;n<r.length;n++)e.components.meta[n].verticalOffset=t?.[n]??0;q(e.components)}),this.setNeedsRender()}async updateObjectVisibility(e,t){const r=await this._updatingHandles.addPromise(this._getObjectEntry(e));r&&(r.renderables.forEach(e=>e.visible=t),this.setNeedsRender())}render(e,t){if(null==this._componentColorManager)return;this._localOrigins.updateViewMatrices(e.camera.viewMatrix);const r=e.camera.viewInverseTransposeMatrix,n=f.create(),s=new w.TwoVectorPosition;let i=0,o=0;if(this._renderers.forEach(r=>{0!==r.refCount?(++this.techniques.precompiling,r.forEachRenderable(t=>{t.visible&&(i+=t.statistics.averageEdgeLength,o++,t.regular&&r.acquireTechnique(e,!1),t.silhouette&&r.acquireTechnique(e,!0))},t),--this.techniques.precompiling):this._renderers.delete(r.key)}),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),0===o)return;const a=40*i/o,c=new C.EdgePassParameters(a,t);p.set(n,r[3],r[7],r[11]),s.set(n),p.copy(c.transformWorldFromViewTH,s.high),p.copy(c.transformWorldFromViewTL,s.low),u.fromMat4(c.transformViewFromCameraRelativeRS,e.camera.viewMatrix),u.transpose(N,c.transformViewFromCameraRelativeRS),u.invert(c.transformNormalViewFromGlobal,N),c.transformProjFromView=e.camera.projectionMatrix,this._updateObjectCameraDistances(e),this._renderers.forEach(t=>{!function(e,t,r){let n,s;const i=r.transparency,o=t.camera.perScreenPixelRatio;e.forEachRenderable(i=>{if(!function(e){return null!=e.regular}(i)||!i.visible)return;n??=e.acquireTechnique(t,!1),s??=e.rctx.bindTechnique(n,t,r);const a=F(i.regular.lod.lengths,i.distanceToCamera,o);e.renderRegularEdges(s,i,r,t,a)},i)}(t,e,c),function(e,t,r){let n,s;const i=r.transparency,o=t.camera.perScreenPixelRatio;e.forEachRenderable(i=>{if(!function(e){return null!=e.silhouette}(i)||!i.visible)return;n??=e.acquireTechnique(t,!0),s??=e.rctx.bindTechnique(n,t,r);const a=F(i.silhouette.lod.lengths,i.distanceToCamera,o);e.renderSilhouetteEdges(s,i,r,t,a)},i)}(t,e,c)})}_updateTransparency(e){const t=P.determineEdgeTransparency(e.components.meta),r=P.determineObjectTransparency(e.components.meta);t===e.edgeTransparency&&r===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=r,this._renderers.get(e.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(e,t,r){e.getCombinedShaderTransformation(t,r);const n=null!=t.localOrigin?this._localOrigins.register(t.localOrigin):this._localOrigins.acquire(p.set(this._tmpModelPosition,r[12],r[13],r[14]));return t.localOrigin=n.origin,x.applyToModelMatrix(n.origin.vec3,r),n}_createComponentBuffers(e){if(null==this._componentColorManager)return null;const t=new Array,r=this._componentColorManager.getBuffer(e.length);for(let n=0;n<e.length;n++){const s=e[n],i=r.acquireIndex();t.push({index:i,verticalOffset:0,material:s})}const n=new U(r,t);return q(n),n}_extractEdges(e,t,r,n,s,i,o=i.length){return o<128&&(s=!0),this._workerHandle.process({data:r,indices:i,indicesLength:o,writerSettings:t,skipDeduplicate:n},e,s)}_createRenderable(e,t,r,n,s){const i=t=>new H(new j.VertexArrayObject(this.rctx,new Map([["vertices",this._vertexBuffer],["instances",0===t?new D.VertexBuffer(this.rctx,T.RegularEdgeInstancesGLLayout,e.regular.instancesData.buffer):new D.VertexBuffer(this.rctx,T.SilhouetteEdgeInstancesGLLayout,e.silhouette.instancesData.buffer)]])),0===t?e.regular.lodInfo:e.silhouette.lodInfo),o=e.regular.lodInfo.lengths.length>0?i(0):null,a=e.silhouette.lodInfo.lengths.length>0?i(1):null,c=(o?.vao.cachedMemory??0)+(a?.vao.cachedMemory??0);return new S(o,a,{gpuMemoryUsage:c,externalMemoryUsage:s,averageEdgeLength:e.averageEdgeLength},r,P.determineEdgeTransparency(t.meta),P.determineObjectTransparency(t.meta),t,n)}async _addGeometry(e,t,r,n,s,i){if(r.edgeIndicesLength<=0)return;const o=r.attributes.get("position"),a=g.create(),c=this._computeModelTransformWithLocalOrigin(e,r,a),d=new G(o,a,c);return this._addPositionData(t,d,r.edgeIndicesLength,n,s,i)}async _addPositionData(e,t,r,n,s,i=!1){if(null==e.loaded)return;const o=this._createComponentBuffers([n]);if(null==o)return;const a=this._acquireRenderer(n.type,s,!0),{modelTransform:c,origin:d}=t,l=t.position.indices,u=t.position,h=u.data.length/u.size,g=T.EdgeInputBufferLayout.createBuffer(h);for(let e=0;e<h;e++)g.position.set(e,0,u.data[e*u.size]),g.position.set(e,1,u.data[e*u.size+1]),g.position.set(e,2,u.data[e*u.size+2]);P.fillComponentBufferIndices(o.meta,[0,g.componentIndex.count],g.componentIndex);const p=await this._updatingHandles.addPromise(this._extractEdges(e.abort?.signal||this._workerAbort.signal,a.writerSettings,g,!1,i,l,r));if(null==e.loaded)return;const f=this._createRenderable(p,o,new I(c,d),a.key,!1);e.renderables.push(f),a.addRenderable(f),this._gpuMemoryUsage+=f.statistics.gpuMemoryUsage}async _addComponentGeometry(e,t,r,n,s,i,o,a){if(null==t.loaded)return 0;const c=this._createComponentBuffers(i);if(null==c)return 0;const d=P.determineRendererType(i),l=this._acquireRenderer(d,o||!1,!1),u=T.EdgeInputBufferLayout.createBuffer(r.length/3);_.copy(u.position.typedBuffer,r,u.position.typedBufferStride,3),P.fillComponentBufferIndices(c.meta,s,u.componentIndex,n);const h=l.writerSettings,g=await this._updatingHandles.addPromise(this._extractEdges(this._workerAbort.signal,h,u,!0,!1,n));if(null==t.loaded)return 0;const p=this._createRenderable(g,c,e,l.key,!0);return t.renderables.push(p),l.addRenderable(p),this._updateAllVerticalOffsets(t,a),p.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(e,t,r,n,s){const i=new Map;let o=0,a=0,c=null;const d=e.geometries.filter(e=>{if(e.edgeIndicesLength<=0||!e.material.supportsEdges)return!1;!c&&e.localOrigin&&(c=e);const t=e.attributes.get("position");return a+=t.data.length/t.size,o+=e.edgeIndicesLength,!0});if(0===d.length)return;const l=a>=65536?Uint32Array:Uint16Array,u=o?new l(o):null,h=[];let p=0;d.forEach(e=>{const t=e.attributes.get("position"),r=t.indices;let n=i.get(t.data);if(null==n){n=h.length/3;for(let e=0;e<t.data.length;e+=t.size)h.push(t.data[e]),h.push(t.data[e+1]),h.push(t.data[e+2]);i.set(t.data,n)}for(let t=0;t<e.edgeIndicesLength;t++)u[p++]=n+r[t]});const f=c||e.geometries[0],m=g.create(),y=this._computeModelTransformWithLocalOrigin(e,f,m);for(let t=0;t<e.geometries.length;t++)e.geometries[t].localOrigin=y.origin;const _=new G(new E.Attribute(h,u,3),m,y);await this._updatingHandles.addPromise(this._addPositionData(t,_,u.length,r,n,s))}_acquireRenderer(e,t,r){const n=R.EdgeRenderer.getKey(e,t,r);let s=this._renderers.get(n);return null==this._strokesTexture&&(this._strokesTexture=L.generateStrokesTexture(this.rctx)),s||(s=new R.EdgeRenderer(this.rctx,this.techniques,{type:e,hasSlicePlane:t,strokesTexture:this._strokesTexture,legacy:r,spherical:1===this.viewingMode}),this._renderers.set(n,s)),++s.refCount,s}_removeRenderable(e){B(e.regular),B(e.silhouette);const t=this._renderers.get(e.rendererKey);if(t){t.removeRenderable(e),--t.refCount,this._localOrigins.release(e.transform.origin),this._gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}_updateObjectCameraDistances(e){const t=e.camera.eye,r=e.camera.viewForward,n=f.create(),s=e=>{p.sub(n,e.center,t);const s=p.dot(n,r),i=e.radius,o=s<-i?1/0:s<i?0:s-i;e.renderables.forEach(e=>e.distanceToCamera=o)};this._objectEntries.forEach(s),this._pendingDeletions.forEach(s)}get test(){}},t.__decorate([d.property({constructOnly:!0})],e.EdgeView.prototype,"rctx",void 0),t.__decorate([d.property({constructOnly:!0})],e.EdgeView.prototype,"renderSR",void 0),t.__decorate([d.property({constructOnly:!0})],e.EdgeView.prototype,"viewingMode",void 0),t.__decorate([d.property({constructOnly:!0})],e.EdgeView.prototype,"techniques",void 0),t.__decorate([d.property({constructOnly:!0})],e.EdgeView.prototype,"setNeedsRender",void 0),t.__decorate([d.property({constructOnly:!0})],e.EdgeView.prototype,"schedule",void 0),t.__decorate([d.property({readOnly:!0})],e.EdgeView.prototype,"_updatingHandles",void 0),t.__decorate([d.property({readOnly:!0})],e.EdgeView.prototype,"updating",null),e.EdgeView=t.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],e.EdgeView);class k{constructor(e,t,r,n){this.abort=e,this.radius=n,this.renderables=new Array;const s=e?c.onAbortOrThrow(e.signal,()=>e.abort()):null;this.loaded=t,this.loaded.then(()=>{null!=this.loaded&&(this.loaded=!0),this.abort=null,s?.remove()}),this.center=f.clone(r)}}class U{constructor(e,t){this.buffer=e,this.meta=t}}class H{constructor(e,t){this.vao=e,this.lod=t}}class I{constructor(e,t){this.modelMatrix=e,this.origin=t}}class S{constructor(e,t,r,n,s,i,o,a){this.regular=e,this.silhouette=t,this.statistics=r,this.transform=n,this.edgeTransparency=s,this.objectTransparency=i,this.components=o,this.rendererKey=a,this.distanceToCamera=0,this.visible=!0}}function q(e){const{meta:t,buffer:r}=e,n=new Uint8Array(4);for(let e=0;e<t.length;e++){const s=t[e].material,i=t[e].index,a=o.clamp(Math.round(s.size*R.lineWidthFractionFactor),0,255),c=o.clamp(s.extensionLength,-R.extensionLengthOffset,255-R.extensionLengthOffset)+R.extensionLengthOffset,d=255*s.opacity,l=s.color,u=255*l[0],h=255*l[1],g=255*l[2],p=255*l[3];r.textureBuffer.setData(i,0,u,h,g,p),r.textureBuffer.setData(i,1,a,c,s.type,d),b.encodeElevationOffset(t[e].verticalOffset,n),r.textureBuffer.setData(i,2,n[0],n[1],n[2],n[3])}}function F(e,t,r){const s=t*r,i=n.binaryIndexOf(e,s,!0);return-1===i?s<e[0]?e.length:0:e.length-i}class G{constructor(e,t,r){this.position=e,this.modelTransform=t,this.origin=r}}const N=h.create(),W=()=>Promise.reject();e.LegacyTransform=I,e.RegularRenderable=class extends S{},e.Renderable=S,e.SilhouetteRenderable=class extends S{},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});