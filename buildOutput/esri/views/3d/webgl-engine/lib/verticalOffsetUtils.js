// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/sphere","../../support/orientedBoundingBox"],function(t,e,s,r,a,n,i,o,h){"use strict";class f{constructor(t,e,s){this._original=t,this._update=e,this._dirty=!0,this._transform=s()}invalidate(){this._dirty=!0}get value(){return this._dirty&&(this._update(this._transform,this._original.value),this._dirty=!1),this._transform}}class l{constructor(t=0){this.offset=t,this.tmpVertex=i.create()}applyToVertex(t,e,s){const r=n.set(u,t,e,s),a=n.add(d,r,this.localOrigin),i=this.offset/n.length(a);return n.scaleAndAdd(this.tmpVertex,r,a,i),this.tmpVertex}applyToAabb(t){const e=b,s=M,r=O;for(let a=0;a<3;++a)e[a]=t[0+a]+this.localOrigin[a],s[a]=t[3+a]+this.localOrigin[a],r[a]=e[a];const a=this.applyToVertex(e[0],e[1],e[2]);for(let e=0;e<3;++e)t[e]=a[e],t[e+3]=a[e];const n=e=>{const s=this.applyToVertex(e[0],e[1],e[2]);for(let e=0;e<3;++e)t[e]=Math.min(t[e],s[e]),t[e+3]=Math.max(t[e+3],s[e])};for(let t=1;t<8;++t){for(let a=0;a<3;++a)r[a]=t&1<<a?s[a]:e[a];n(r)}let i=0;for(let t=0;t<3;++t)e[t]*s[t]<0&&(i|=1<<t);if(0!==i&&7!==i)for(let t=0;t<8;++t)if(0===(i&t)){for(let a=0;a<3;++a)r[a]=i&1<<a?0:t&1<<a?e[a]:s[a];n(r)}for(let e=0;e<3;++e)t[e]-=this.localOrigin[e],t[e+3]-=this.localOrigin[e];return t}}class c{constructor(t=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=i.create(),this._tmpMbs=o.create(),this._tmpObb=new h.Obb,this._resetOffset(t)}_resetOffset(t){this._offset=t,this._totalOffset=t}set offset(t){this._resetOffset(t)}get offset(){return this._offset}set componentOffset(t){this._totalOffset=this._offset+t}set localOrigin(t){this.componentLocalOriginLength=n.length(t)}applyToVertex(t,e,s){const r=n.set(u,t,e,s),a=n.set(d,t,e,s+this.componentLocalOriginLength),i=this._totalOffset/n.length(a);return n.scaleAndAdd(this._tmpVertex,r,a,i),this._tmpVertex}applyToAabb(t){const e=this.componentLocalOriginLength,s=t[0],r=t[1],a=t[2]+e,n=t[3],i=t[4],o=t[5]+e,h=Math.abs(s),f=Math.abs(r),l=Math.abs(a),c=Math.abs(n),m=Math.abs(i),p=Math.abs(o),g=.5*(1+Math.sign(s*n))*Math.min(h,c),_=.5*(1+Math.sign(r*i))*Math.min(f,m),u=.5*(1+Math.sign(a*o))*Math.min(l,p),d=Math.max(h,c),b=Math.max(f,m),M=Math.max(l,p),O=Math.sqrt(g*g+_*_+u*u),v=Math.sign(h+s),T=Math.sign(f+r),x=Math.sign(l+a),y=Math.sign(c+n),V=Math.sign(m+i),A=Math.sign(p+o),I=this._totalOffset;if(O<I)return t[0]-=(1-v)*I,t[1]-=(1-T)*I,t[2]-=(1-x)*I,t[3]+=y*I,t[4]+=V*I,t[5]+=A*I,t;const L=I/Math.sqrt(d*d+b*b+M*M),w=I/O,C=w-L,j=-C;return t[0]+=s*(v*j+w),t[1]+=r*(T*j+w),t[2]+=a*(x*j+w),t[3]+=n*(y*C+L),t[4]+=i*(V*C+L),t[5]+=o*(A*C+L),t}applyToMbs(t){const e=n.length(o.getCenter(t)),s=this._totalOffset/e;return n.scaleAndAdd(o.getCenter(this._tmpMbs),o.getCenter(t),o.getCenter(t),s),this._tmpMbs[3]=t[3]+t[3]*this._totalOffset/e,this._tmpMbs}applyToObb(t){return h.computeOffsetObb(t,this._totalOffset,this._totalOffset,1,this._tmpObb),this._tmpObb}}class m{constructor(t=0){this.offset=t,this.sphere=o.create(),this.tmpVertex=i.create()}applyToVertex(t,e,s){const r=this.objectTransform.transform,a=n.set(u,t,e,s),i=n.transformMat4(a,a,r),o=this.offset/n.length(i);n.scaleAndAdd(i,i,i,o);const h=this.objectTransform.inverse;return n.transformMat4(this.tmpVertex,i,h),this.tmpVertex}applyToMinMax(t,e){const s=this.offset/n.length(t);n.scaleAndAdd(t,t,t,s);const r=this.offset/n.length(e);n.scaleAndAdd(e,e,e,r)}applyToAabb(t){const e=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*e,t[1]+=t[1]*e,t[2]+=t[2]*e;const s=this.offset/Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]);return t[3]+=t[3]*s,t[4]+=t[4]*s,t[5]+=t[5]*s,t}applyToBoundingSphere(t){const e=n.length(o.getCenter(t)),s=this.offset/e;return n.scaleAndAdd(o.getCenter(this.sphere),o.getCenter(t),o.getCenter(t),s),this.sphere[3]=t[3]+t[3]*this.offset/e,this.sphere}}const p=new m,g=new c,_=new l,u=i.create(),d=i.create(),b=i.create(),M=i.create(),O=i.create();t.I3SVerticalOffsetGlobalViewingMode=c,t.IntersectorTransform=class{constructor(){this._transform=a.create(),this._transformInverse=new f({value:this._transform},r.invert,a.create),this._transformInverseTranspose=new f(this._transformInverse,r.transpose,a.create),this._transformTranspose=new f({value:this._transform},r.transpose,a.create),this._transformInverseRotation=new f({value:this._transform},e.normalFromMat4Legacy,s.create)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(t){r.copy(this._transform,t)}multiplyTransform(t){r.multiply(this._transform,this._transform,t)}set(t){r.copy(this._transform,t),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(t,e){this.setTransformMatrix(t),this.multiplyTransform(e),this._invalidateLazyTransforms()}},t.Object3DVerticalOffsetGlobalViewingMode=m,t.TerrainVerticalOffsetGlobalViewingMode=l,t.getVerticalOffsetI3S=function(t){return null!=t?(g.offset=t,g):null},t.getVerticalOffsetObject3D=function(t){return null!=t?(p.offset=t,p):null},t.getVerticalOffsetTerrain=function(t){return null!=t?(_.offset=t,_):null},t.terrainId="terrain",Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});