// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","./CascadeCamera","./textureUtils","./Util","../../../webgl/enums"],function(t,e,s,a,i,r,c,h,n,o,l,d,u,_,m,f,g){"use strict";class p{constructor(){this.camera=new _.CascadeCamera,this.lightMat=c.create()}}class x{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}const b=c.create(),y=u.create(),M=[];for(let t=0;t<8;++t)M.push(u.create());const w=n.create(),C=n.create(),v=n.create(),D=n.create(),S=n.create(),T=l.create(),H=[],O=c.create(),j=c.IDENTITY.concat(c.IDENTITY,c.IDENTITY,c.IDENTITY,c.IDENTITY),I=n.create(),N=n.create(),F=[n.create(),n.create(),n.create(),n.create()],R=n.create(),B=n.create(),Q=n.create(),L=n.create(),V=n.create(),q=n.create(),z=n.create();function A(t,e){return 3*e+t}const W=n.create();function E(t,e){return h.set(W,t[e],t[e+3]),W}const Y=n.create(),k=i.create();t.ShadowMap=class{constructor(t,s){this._fbos=t,this._viewingMode=s,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new x,this._projectionView=c.create(),this._projectionViewInverse=c.create(),this._modelViewLight=c.create(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=u.create(),this._cascades=[new p,new p,new p,new p],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(e("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(g.DepthStencilAttachment)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return d.set(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=a.releaseMaybe(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(t){this.settings.maxNumCascadesHighQuality=s.clamp(Math.floor(t),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(t){this._enabled=t,t||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let t=0;t<this._numCascades;++t)H[t]=this._cascades[t];return H.length=this._numCascades,H}start(t,e,s,a,i){f.assert(this.enabled);const{near:r,far:c}=function(t){let{near:e,far:s}=t;return e<2&&(e=2),s<2&&(s=2),e>=s&&(e=2,s=4),{near:e,far:s}}(s);this._computeCascadeDistances(r,c,a),this._textureHeight=this._computeTextureHeight(t,i,a),this._setupMatrices(t,e);const{viewMatrix:h,projectionMatrix:n}=t;for(let t=0;t<this._numCascades;++t)this._constructCascade(t,n,h,e);this._lastOrigin=null,this.clear()}finish(){f.assert(this.enabled)}getShadowMapMatrices(t){if(!this._lastOrigin||!o.exactEquals(t,this._lastOrigin)){this._lastOrigin=this._lastOrigin||l.create(),o.copy(this._lastOrigin,t);for(let e=0;e<this._numCascades;++e){r.translate(O,this._cascades[e].lightMat,t);for(let t=0;t<16;++t)j[16*e+t]=O[t]}}return j}moveSnapshot(t){f.assert(this.enabled),this._snapshots[t]?.release(),this._snapshots[t]=this._handle,this._handle?.setName(0===t?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(t){if(!this.enabled)return;const e=this._handle?.getTexture(g.DepthStencilAttachment)?.descriptor;if(!e)return;this._snapshots[t]?.release();const s=0===t?"shadow map highlight":"shadow map excluding highlight",a=this._acquireFBO(s);this._snapshots[t]=a;const i=this._handle?.fbo;if(!i||!a?.fbo)return void console.error("No FBO");const{rctx:r}=this._fbos;r.blitFramebuffer(i,a.fbo,256)}getSnapshot(t){return this.enabled?this._snapshots[t]?.getTexture(g.DepthStencilAttachment):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:t,fullWidth:e,fullHeight:s},a,i){const r=Math.min(window.devicePixelRatio,a)/t,c=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return m.applyTextureResizeModulo(Math.max(e,s)*r*c,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(t){const e=this._fbos.acquire(this._textureWidth,this._textureHeight,t,10);return e.getTexture(g.DepthStencilAttachment)?.setShadowFiltering(!0),e}_discardSnapshot(t){this._snapshots[t]=a.releaseMaybe(this._snapshots[t])}_discardSnapshots(){for(let t=0;t<this._snapshots.length;++t)this._discardSnapshot(t);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(t,e,a,i){const c=this._cascades[t],n=-this._cascadeDistances[t],l=-this._cascadeDistances[t+1],u=(e[10]*n+e[14])/Math.abs(e[11]*n+e[15]),_=(e[10]*l+e[14])/Math.abs(e[11]*l+e[15]);f.assert(u<_);for(let t=0;t<8;++t){d.set(y,t%4==0||t%4==3?-1:1,t%4==0||t%4==1?-1:1,t<4?u:_,1);const e=M[t];d.transformMat4(e,y,this._projectionViewInverse),e[0]/=e[3],e[1]/=e[3],e[2]/=e[3]}o.negate(T,M[0]),c.camera.viewMatrix=r.translate(b,this._modelViewLight,T);for(let t=0;t<8;++t)o.transformMat4(M[t],M[t],c.camera.viewMatrix);let m=M[0][2],g=M[0][2];for(let t=1;t<8;++t)m=Math.min(m,M[t][2]),g=Math.max(g,M[t][2]);m-=200,g+=200,c.camera.near=-g,c.camera.far=-m,function(t,e,a,i,r){const c=1/M[0][3],n=1/M[4][3];f.assert(c<n);let o=c+Math.sqrt(c*n);const l=Math.sin(s.acosClamped(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));o/=l,function(t,e,s,a,i,r,c,n){h.set(I,0,0);for(let e=0;e<4;++e)h.add(I,I,t[e]);h.scale(I,I,.25),h.set(N,0,0);for(let e=4;e<8;++e)h.add(N,N,t[e]);h.scale(N,N,.25),h.lerp(F[0],t[4],t[5],.5),h.lerp(F[1],t[5],t[6],.5),h.lerp(F[2],t[6],t[7],.5),h.lerp(F[3],t[7],t[4],.5);let o=0,l=h.squaredDistance(F[0],I);for(let t=1;t<4;++t){const e=h.squaredDistance(F[t],I);e<l&&(l=e,o=t)}h.subtract(R,F[o],t[o+4]);const d=R[0];let u,_;R[0]=-R[1],R[1]=d,h.subtract(B,N,I),h.dot(B,R)<0&&h.negate(R,R),h.lerp(R,R,B,s),h.normalize(R,R),u=_=h.dot(h.subtract(Q,t[0],I),R);for(let e=1;e<8;++e){const s=h.dot(h.subtract(Q,t[e],I),R);s<u?u=s:s>_&&(_=s)}h.copy(a,I),h.scale(Q,R,u-e),h.add(a,a,Q);let m=-1,g=1,p=0,x=0;for(let e=0;e<8;++e){h.subtract(L,t[e],a),h.normalize(L,L);const s=R[0]*L[1]-R[1]*L[0];s>0?s>m&&(m=s,p=e):s<g&&(g=s,x=e)}f.verify(m>0,"leftArea"),f.verify(g<0,"rightArea"),h.scale(V,R,u),h.add(V,V,I),h.scale(q,R,_),h.add(q,q,I),z[0]=-R[1],z[1]=R[0];const b=f.rayRay2D(a,t[x],q,h.add(Q,q,z),1,i),y=f.rayRay2D(a,t[p],q,Q,1,r),M=f.rayRay2D(a,t[p],V,h.add(Q,V,z),1,c),w=f.rayRay2D(a,t[x],V,Q,1,n);f.verify(b,"rayRay"),f.verify(y,"rayRay"),f.verify(M,"rayRay"),f.verify(w,"rayRay")}(M,o,l,w,C,v,D,S),function(t,e,s,a,i){h.subtract(Y,s,a),h.scale(Y,Y,.5),k[0]=Y[0],k[1]=Y[1],k[2]=0,k[3]=Y[1],k[4]=-Y[0],k[5]=0,k[6]=Y[0]*Y[0]+Y[1]*Y[1],k[7]=Y[0]*Y[1]-Y[1]*Y[0],k[8]=1,k[A(0,2)]=-h.dot(E(k,0),t),k[A(1,2)]=-h.dot(E(k,1),t);let r=h.dot(E(k,0),s)+k[A(0,2)],c=h.dot(E(k,1),s)+k[A(1,2)],n=h.dot(E(k,0),a)+k[A(0,2)],o=h.dot(E(k,1),a)+k[A(1,2)];r=-(r+n)/(c+o),k[A(0,0)]+=k[A(1,0)]*r,k[A(0,1)]+=k[A(1,1)]*r,k[A(0,2)]+=k[A(1,2)]*r,r=1/(h.dot(E(k,0),s)+k[A(0,2)]),c=1/(h.dot(E(k,1),s)+k[A(1,2)]),k[A(0,0)]*=r,k[A(0,1)]*=r,k[A(0,2)]*=r,k[A(1,0)]*=c,k[A(1,1)]*=c,k[A(1,2)]*=c,k[A(2,0)]=k[A(1,0)],k[A(2,1)]=k[A(1,1)],k[A(2,2)]=k[A(1,2)],k[A(1,2)]+=1,r=h.dot(E(k,1),e)+k[A(1,2)],c=h.dot(E(k,2),e)+k[A(2,2)],n=h.dot(E(k,1),s)+k[A(1,2)],o=h.dot(E(k,2),s)+k[A(2,2)],r=-.5*(r/c+n/o),k[A(1,0)]+=k[A(2,0)]*r,k[A(1,1)]+=k[A(2,1)]*r,k[A(1,2)]+=k[A(2,2)]*r,r=h.dot(E(k,1),e)+k[A(1,2)],c=h.dot(E(k,2),e)+k[A(2,2)],n=-c/r,k[A(1,0)]*=n,k[A(1,1)]*=n,k[A(1,2)]*=n,i[0]=k[0],i[1]=k[1],i[2]=0,i[3]=k[2],i[4]=k[3],i[5]=k[4],i[6]=0,i[7]=k[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=k[6],i[13]=k[7],i[14]=0,i[15]=k[8]}(w,C,D,S,r.projectionMatrix),r.projectionMatrix[10]=2/(a-i),r.projectionMatrix[14]=-(a+i)/(a-i)}(a,i,m,g,c.camera),r.multiply(c.lightMat,c.camera.projectionMatrix,c.camera.viewMatrix);const p=this._textureHeight;c.camera.viewport=[t*p,0,p,p]}_setupMatrices(t,e){r.multiply(this._projectionView,t.projectionMatrix,t.viewMatrix),r.invert(this._projectionViewInverse,this._projectionView);const s=1===this._viewingMode?t.eye:o.set(T,0,0,1);r.lookAt(this._modelViewLight,[0,0,0],[-e[0],-e[1],-e[2]],s)}_computeCascadeDistances(t,e,a){const i=a?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(f.logWithBase(e/t,4)),i);const r=(e-t)/this._numCascades,c=(e/t)**(1/this._numCascades);let h=t,n=t;for(let t=0;t<this._numCascades+1;++t)this._cascadeDistances[t]=s.lerp(h,n,this.settings.splitSchemeLambda),h*=c,n+=r}get test(){}},t.cleanupShadowmap=function(){H.length=0},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});