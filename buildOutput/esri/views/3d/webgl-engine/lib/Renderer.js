// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../chunks/tslib.es6","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/colorUtils","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/time","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f32","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/Indices","../../webgl","../../environment/atmosphereUtils","../../state/NearFarHeuristic","../../support/debugFlags","../core/FBOCache","../core/renderPasses/RenderPassManager","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/shading/ScreenSpaceConstants","../effects/RenderNodes","../effects/RenderPluginManager","../effects/blit/Blit","../effects/highlight/Highlight","../effects/transparency/OITBlend","./AnimationTimer","./AnimationTimeStep","./BoundingInfo","./DepthRange","./depthRangeUtils","./hudFragmentOpacityParameters","./MainFramebuffer","./RenderContext","./RendererBase","./RenderFeature","./RenderPluginInput","./ShadowAccumulator","./ShadowMap","./SliceHelper","../materials/renderers/MergedRenderer","../parts/renderUtils","../statistics/RendererPerformanceInfo","../../../webgl/enums"],function(e,t,r,i,s,a,n,h,o,d,l,u,_,c,p,m,g,f,b,C,y,P,R,w,T,S,I,E,A,x,D,O,M,v,F,H,N,q,G,V,L,U,B,k,z,Q,W,j,Y,Z,J,K,X){"use strict";t.Renderer=class extends k.RendererBase{constructor(e,t,r,i,s,h){super({stage:e}),this._techniques=r,this._rctx=i,this._compositingHelper=s,this._requestRender=h,this._pluginsHas={hudElements:!1,water:!1},this.renderPassManager=new E.RenderPassManager,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=y.fromValues(0,0,0,1),this._sliceHelper=new Y,this._blit=null,this._oitblend=null,this.sceneDepthRange=u.signal(G.DepthRange.infinite),this._state=u.signal(2),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new N.AnimationTimeStep,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=u.signal(0),this._lastFrameTime=_.Milliseconds(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new Q.RenderPluginInput,this._releaseNormals=e=>{e.some(({name:e})=>"normals"===e)&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this._fboCache=new I.FBOCache(i),this._renderStateFeatures=u.signal(z.setupFeatureDefaults(!n("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new U.MainFramebuffer(this.fboCache),this._performanceInfo=new K.RendererPerformanceInfo(this._rctx),this._shadowMap=new j.ShadowMap(this.fboCache,e.viewingMode),this._shadowAccumulator=new W.ShadowAccumulator(this.fboCache,r,e,e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=t},(t,r,i)=>{const s=e.view.qualitySettings.maximumPixelRatio;t.shadowMap.start(t.camera,r,i,!0,s),this._renderShadowCascades(4,t.shadowMap),t.shadowMap.finish(),t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.contentCamera)},h),this._renderContext=new B.RenderContext(this._rctx,this._shadowMap,r),this._nodes=new D.RenderNodes(this._renderContext),this._plugins=new O.RenderPluginManager({renderContext:this._renderContext,techniques:r,materials:t,requestRender:h,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this._plugins.add(this.renderPassManager),this.addHandles([l.watch(()=>e.view.state.camera,()=>h(),l.syncAndInitial),l.watch(()=>S.debugFlags.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(0):()=>{},h()},l.initial),l.watch(()=>e.view.environment.background?.color,e=>{const t=e?a.unitRGBAFromColor(e):y.ZEROS;b.set(this._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),h()},l.syncAndInitial),l.watch(()=>e.view.state.camera.relativeElevation,e=>this._inGlobeView=(e??1/0)>=x.distanceFadeEnd,l.syncAndInitial),l.watch(()=>this._bindParameters.clouds.fadeFactor,()=>this._bindParameters.fadeLighting(),l.sync),l.watch(()=>this._bindParameters.clouds.data?.state,()=>h(),l.sync),l.watch(()=>e.view.state.highlights,e=>{this._bindParameters.highlights=e,h()},l.initial)])}destroy(){this._gpuTimerHandle=o.removeMaybe(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._shadowAccumulator=null,this._loadEdgeViewTask=o.abortMaybe(this._loadEdgeViewTask),this._edgeView=o.destroyMaybe(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this._fboCache.destroy(),this._fboCache=null,this._plugins.destroy(),this._plugins=null,this._pluginInput=null,this._blit=null,this._oitblend=null,this._compositingHelper=null,this._nodes=null,this._framebuffer=null,this._shadowMap=null,this._renderContext=null,this._performanceInfo=null,q.BoundingInfo.prune(),Z.MergedRenderer.prune(),P.pruneIndexArrays()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}get performanceInfo(){return this._performanceInfo}updateRenderFeatures(e=null,t=!n("disable-feature:high-quality-idle")){this._renderStateFeatures.value=z.setupFeatureDefaults(t,e),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,r){this._renderStateFeatures.mutate(i=>i.set(t,e,r)),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(1)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(5))}get _hasHighlights(){return this._plugins.produces(8,2,4,18,13,14)}hasHighlight(e){return this._plugins.hasHighlight(e)}get _hasHUDHighlights(){return this._plugins.produces(8,13,14)}get hasSSAO(){return(this.stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(4))&&!this._inGlobeView}get hasSMAA(){return this.stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(0)}get fullResolutionAtmosphere(){return this.stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(3)}get fboCache(){return this._fboCache}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=o.releaseMaybe(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=o.releaseMaybe(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=o.releaseMaybe(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=o.releaseMaybe(this._bindParameters.depth),this._bindParameters.hudVisibility=o.releaseMaybe(this._bindParameters.hudVisibility)}get updating(){return this._loadEdgeViewTask&&!this._loadEdgeViewTask.finished||this._edgeView?.updating||this._shadowAccumulator.readyToRun||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=s.createTask(async t=>{const{EdgeView:r}=await new Promise((t,r)=>e(["./edgeRendering/EdgeView"],t,r));d.throwIfAborted(t);const i=this._edgeView=new r({rctx:this._rctx,renderSR:this.stage.view.renderSpatialReference,viewingMode:this.stage.view.stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:(s=this.stage.view.resourceController,e=>s.immediate.schedule(e))});var s;return this.addHandles(l.watch(()=>i.updating,()=>this._requestRender(),l.sync)),this._requestRender(),this._edgeViewCallbacks.forEach(e=>e(i)),this._edgeViewCallbacks.length=0,i})),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),null==this._edgeView?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&g.equals(this._bindParameters.ssr.reprojectionMatrix,f.IDENTITY)}set _reprojectionMatrix(e){i.update(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:t,_bindParameters:r}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){if(null!=e.environment.weather){const t=e.environment.weather;this._bindParameters.weather=t,this._bindParameters.snowCover=!!e.weatherVisible&&null!=t&&"snowy"===t.type&&"enabled"===t.snowCover}const t="virtual"!==e.environment.lighting.type;r.enableFillLights!==t&&(r.enableFillLights=t,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.shadowCast&&this._shadowAccumulator.setOptions(e.shadowCast)}set slice(e){this._sliceHelper.update(e)&&this._requestRender()}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}commit(e,t){return this._isRendering&&console.warn("Renderer.modify called while rendering"),!!super.commit(e,t,this._plugins.context)&&(this.updateHasFlags(),!0)}rendererAdded(e){this._plugins.add(e)}rendererRemoved(e){this._plugins.remove(e)}get occludedRequiresStencil(){return this.occludedRequiresOccludeeStencil||this.occludedRequiresIntegratedMeshStencil}get occludedRequiresOccludeeStencil(){return this._bindParameters.hasOccludees&&!!(8&this.plugins.renderOccludedFlags)}get occludedRequiresIntegratedMeshStencil(){return this._plugins.produces(0,0)&&this._plugins.produces(0,9)}updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(0,...se),e.water=this._plugins.produces(3,19),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,t){this._animationTimer??=new H.AnimationTimer(e.camera,t),this._animationTimer.advance(e.camera,t,this._animationTimeDilation);const r=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?o.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,r,i=!1){try{return this._isRendering=!0,this._render(e,t,r,i)}catch(e){console.error(`Exception during rendering: ${e}`)}finally{this._isRendering=!1}return new J.RenderSceneResult(this._pluginInput.get(R.RenderCategory.FINAL),null)}_updateHUDOccludedFragmentOpacity(e,t){const{idleOpacity:r,navigatingOpacity:i,maxDelta:s,tiltFadeStart:a,tiltFadeEnd:n,altitudeStart:o,altitudeEnd:d}=L.hudFragmentOpacityParameters,l=this.stage.view,u=l.stateManager.camera,_=l.qualitySettings.fadeDuration,c=2===e?r:i,p=h.clamp((u.tilt-a)/(n-a),0,1),m=h.clamp(((u.position.z??0)-o)/(d-o),0,1),g=h.lerp(h.lerp(1,c,p),1,m),f=this._bindParameters.hudOccludedFragmentOpacity;if(_<=0||f===g||0===this._lastFrameTime||this._lastFrameTime>t)return this._bindParameters.hudOccludedFragmentOpacity=g,void(this._lastFrameTime=t);const b=t-this._lastFrameTime;this._lastFrameTime=t;const C=Math.max(1-r,Math.abs(r-i)),y=Math.min(C*b/_,s);y>=Math.abs(g-f)?this._bindParameters.hudOccludedFragmentOpacity=g:(this._bindParameters.hudOccludedFragmentOpacity=f+Math.sign(g-f)*y,this._requestRender())}_render(e,t,r,i){const s=0===r;this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=s,this._disposeBindBuffers();const{camera:a,contentCamera:n,mode:h,alignPixelEnabled:o}=e;this._state.value=h;const d=this._nodes.produces("magnifier-color"),l=this._nodes.produces(R.RenderCategory.FINAL),u=this._nodes.require("emissive",R.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,R.RenderCategory.COMPOSITE,R.RenderCategory.FINAL)>0&&this._plugins.hasEmissions,_=u?1:0;this._renderContext.time=t,this._renderContext.output=_,this._bindParameters.oitPass=0,this._bindParameters.alignPixelEnabled=o,this._bindParameters.decorations=!i,this._bindParameters.mainDepth=null;const c=!i||!this._sliceHelper.isDecoration;this._bindParameters.slicePlane=c?this._sliceHelper.plane:null,this._bindParameters.viewshedEnabled=this._nodes.produces(R.InternalRenderCategory.VIEWSHED),this._renderOverlay(),a.setGLViewport(this._rctx);const p=this._framebuffer,m=p.initialize(a.fullWidth,a.fullHeight,this._backgroundColor,u);this.hasReflections?(m?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=m):m?.release(),this._ensureBindParametersCamera(a,n),this._updateHUDOccludedFragmentOpacity(h,t),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!i;const g=this._highQualityTransparency&&this._hasTransparentTerrain,f=this._plugins.produces(0,...re);this._precompilePrepasses(),this.performanceInfo.advance(K.PerformanceCategory.PREPARE);const b=this._computeShadowDepthRange(a);this._renderShadowMap(a,this._bindParameters.lighting.mainLight.direction,b),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(b,a,n,!s),this._ensureBindParametersSSR(t),this._precompileShaders(g,f,_),this._renderContext.output=_,p.bind(),this._bindParameters.mainDepth=p.depth.attachment,this._renderOpaque(g),this._renderTransparent(f,g,_),this._shadowMap.disposeMainBuffer(),this._pluginInput.set(R.InternalRenderCategory.FOCUSAREA,this._renderFocusAreaGeometry()),p.update(e=>this._renderNodes(R.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,e)),p.update(e=>this._renderNodes(R.InternalRenderCategory.VIEWSHED,e)),p.update(e=>this._renderNodes(R.InternalRenderCategory.LASERLINES,e)),p.update(e=>this._renderNodes(R.InternalRenderCategory.FOCUSAREA_COLOR,e)),this._pluginInput.release(R.InternalRenderCategory.FOCUSAREA),p.update(e=>this._renderNodes(R.InternalRenderCategory.OCCLUDED,e)),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._renderHighlightShadowMap(a,this._bindParameters.lighting.mainLight.direction,b);const C=2===r?this._renderObjectAndLayerIdColor():null;p.update(e=>this._renderNodes(R.RenderCategory.COMPOSITE,e)),this._shadowMap.disposeOffscreenBuffers();const y=s&&!l&&!(d&&!i),P=this._pluginInput.get(R.RenderCategory.COMPOSITE),w=y?I.defaultWebGLFBO:this.fboCache.acquire(P.fbo.width,P.fbo.height,R.InternalRenderCategory.ANTIALIASING),T=this._nodes.produces(R.InternalRenderCategory.ANTIALIASING)?this._renderNodes(R.InternalRenderCategory.ANTIALIASING,w):this._blitFBO(P,w,!1);let S;this._pluginInput.set(R.InternalRenderCategory.ANTIALIASING,T),this._hasHUDHighlights?(this._renderHUD(1,T,_),S=this._renderNodes(R.InternalRenderCategory.HIGHLIGHTS,T)):(S=this._renderNodes(R.InternalRenderCategory.HIGHLIGHTS,T),this._renderHUD(1,S,_));const E=this._renderNodes(R.InternalRenderCategory.MAGNIFIER,S);return s&&d&&!i&&!l&&this._blitFBO(E),l?(E.attachDepth(p.depth),this._blitFBO(this._renderNodes(R.RenderCategory.FINAL,E)),E.detachDepth()):this._pluginInput.set(R.RenderCategory.FINAL,E),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),p.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),s||(this._releaseFBOs(),this._disposeOffscreenBuffers()),new J.RenderSceneResult(this._pluginInput.get(R.RenderCategory.FINAL),C)}_precompileShaders(e,t,r){++this._plugins.context.techniques.precompiling,this._renderContext.output=r,this._precompileOpaqueGeometry(),this._nodes.precompile(R.InternalRenderCategory.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,this._renderContext.output=2,this._plugins.precompile(6),this._plugins.precompile(7),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=r,this._plugins.precompile(6),this._plugins.precompile(7),t&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=e)),this._nodes.precompile(R.InternalRenderCategory.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(12),this._plugins.precompile(15),this._precompileHUD(0),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(R.InternalRenderCategory.VIEWSHED,R.InternalRenderCategory.LASERLINES,R.InternalRenderCategory.FOCUSAREA_COLOR,R.InternalRenderCategory.OCCLUDED,R.InternalRenderCategory.ANTIALIASING,R.InternalRenderCategory.HIGHLIGHTS);const i=this._bindParameters;i.highlightMixTexture=i.highlights.length>1?this._rctx.emptyTexture:null,this._precompileHUD(1),this._hasHighlights&&(i.highlights.forEach((e,t)=>{i.highlightLevel=t,this._precompileAllGeometry(8)}),i.highlightLevel=null),i.highlightMixTexture=null,this._nodes.precompile(R.RenderCategory.COMPOSITE,R.InternalRenderCategory.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(8),--this._plugins.context.techniques.precompiling}_renderFocusAreaGeometry(){const e=this._nodes.produce(R.InternalRenderCategory.FOCUSAREA,this._pluginInput);return e&&this.performanceInfo.advance(K.PerformanceCategory.FOCUS_AREA_MASK),e}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;const e=this._renderContext.output;++this._techniques.precompiling;const t=this._framebufferSize;let r=this.fboCache.acquire(t.width,t.height,"olid");return r.acquireDepth(11),r=this._nodes.render(r,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(K.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=e,r}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,r=0===e;if(r||t){const e=r?this.performanceInfo.elapsedTime:0;let i=0;t?i=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const s=Math.max(e,i);this._animationTimestep.frame(s,r)}}readMainDepth(e,t){const{mainDepth:r,camera:i}=this._bindParameters;if(!r)return;const s=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(s.fbo),i.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(y.ZEROS),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,r),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),s.fbo?.readPixels(e[0],e[1],e[2],e[3],6408,X.PixelType.UNSIGNED_BYTE,t),s.release()}readHUDVisibility(e,t,r,i,s){this._bindParameters.hudVisibility?.fbo?.readPixels(e,t,r,i,6408,X.PixelType.UNSIGNED_BYTE,s)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_renderEdges(e){const t=this._edgeView;if(!t?.shouldRender())return;const r=this._framebufferSize,i=this.fboCache.acquire(r.width,r.height,"edges"),s=this._bindParameters.geometryDepth;this.renderToTargets(()=>t.render(this._bindParameters,e),i,s??this._framebuffer.depth,y.ZEROS),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,i.getTexture()),i.release(),this.performanceInfo.advance(1===e?K.PerformanceCategory.OPAQUE_EDGES:K.PerformanceCategory.TRANSPARENT_EDGES)}_renderOverlay(){this._bindParameters.overlay=this.overlay?.render(),this._bindParameters.overlay&&this.performanceInfo.advance(K.PerformanceCategory.OVERLAY)}_renderShadowMap(e,t,r){if(!this.shadowsEnabled)return;const{contentCamera:i}=this._bindParameters,s=this._shadowMap;s.start(e,t,r,this.isFeatureEnabled(6),this.stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(6,this._shadowMap),s.copySnapshot(1),this._renderShadowCascades(5,this._shadowMap)):this._renderShadowCascades(4),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,i),this.performanceInfo.advance(K.PerformanceCategory.SHADOW_MAP)}_renderHighlightShadowMap(e,t,r){if(!this.shadowsEnabled||!this._needsShadowHighlight)return;const{contentCamera:i}=this._bindParameters,s=this._shadowMap;s.start(e,t,r,this.isFeatureEnabled(6),this.stage.view.qualitySettings.maximumPixelRatio),this._renderShadowCascades(5,this._shadowMap),s.moveSnapshot(0),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,i),this.performanceInfo.advance(K.PerformanceCategory.SHADOW_MAP)}_precompileShadowCascades(e){for(const t of this._shadowMap.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e,t=this._shadowMap){t.bindFbo();for(const r of t.cascades)r.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(r.camera,r.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(2)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._shadowAccumulator.active||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const e=this._pluginInput.get("normals");e?(this._pluginInput.set(R.InternalRenderCategory.SSAO,this._renderSSAO()),this._needsDepth?(this._rctx.bindFramebuffer(e.fbo),this._rctx.clear(1024),this._renderGeometryWithoutNormals(2),o.releaseMaybe(this._bindParameters.depth),this._bindParameters.depth=e.obtainDepthTexture(),this.performanceInfo.advance(K.PerformanceCategory.DEPTH)):(e.detachDepth(),this._bindParameters.depth=o.releaseMaybe(this._bindParameters.depth)),this.hasSSAO&&this._pluginInput.release("normals")):this._renderAllGeometryDepth()}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=o.releaseMaybe(this._bindParameters.depth));const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"depth",11);this._rctx.bindFramebuffer(t.fbo),this._rctx.clear(1280),this.renderAllGeometry(2),o.releaseMaybe(this._bindParameters.depth),this._bindParameters.depth=t.obtainDepthTexture(),t.release(),this.performanceInfo.advance(K.PerformanceCategory.DEPTH)}_renderTerrainDepth(e){if(this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,!e)return void(this._bindParameters.terrainDepth=o.releaseMaybe(this._bindParameters.terrainDepth));const t=this._renderContext.output;this._renderContext.output=2;const r=this._framebufferSize,i=this.fboCache.acquire(r.width,r.height,"terrain depth",11);this._rctx.bindFramebuffer(i.fbo),this._rctx.clear(1280),this._renderTransparentTerrain(),o.releaseMaybe(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=i.obtainDepthTexture(),this._renderContext.output=t,i.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=o.releaseMaybe(this._bindParameters.geometryDepth));const t=this._renderContext.output,{width:r,height:i}=this._framebufferSize,s=this.fboCache.acquire(r,i,"geometry depth",11);this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(1280),this._renderOpaqueAndTransparentGeometry(2),this._renderContext.output=t,o.releaseMaybe(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=s.obtainDepthTexture(),s.release()}get _needsShadowDepthRange(){return this._shadowMap.enabled||this._shadowAccumulator.active}_computeShadowDepthRange(e){if(!this._needsShadowDepthRange)return G.DepthRange.zero;const t=V.depthRangeFromScene(e,this._plugins.plugins,this.stage.layers,0);return t.union(this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}updateSceneDepthRange(e){if(!this.stage.view.state.isGlobal)return void(this.sceneDepthRange.value=G.DepthRange.infinite);if((this.stage.view.renderCoordsHelper?.getAltitude(e.eye)??0)<w.innerAtmosphereFadeStart)return void(this.sceneDepthRange.value=G.DepthRange.infinite);const t=e.clone();t.near=T.minNearDistanceInMeters,t.far=1e10;const r=V.depthRangeFromScene(t,this._plugins.plugins,this.stage.layers,1);r.union(this._plugins.queryDepthRange(t)),this.sceneDepthRange.value.far===r.far&&this.sceneDepthRange.value.near===r.near||(this.sceneDepthRange.value=r)}get _normalsRequired(){const e=this._nodes.require("normals",R.RenderCategory.FINAL,R.RenderCategory.COMPOSITE,R.RenderCategory.OPAQUE,R.RenderCategory.TRANSPARENT,R.InternalRenderCategory.VIEWSHED,R.InternalRenderCategory.LASERLINES);return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(3),this._needsDepth&&this._precompileAllGeometry(2),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(5),this._precompileShadowCascades(6),this._precompileShadowCascades(5)):this._precompileShadowCascades(4)),this._shadowAccumulator.active&&this._precompileAllGeometry(4)}_renderNormals(){const e=this._normalsRequired;if(0===e)return;const t=this._framebufferSize,r=this.fboCache.acquire(t.width,t.height,"normals",5);r.acquireDepth(11),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer(y.ZEROS,!0,!0),this._renderGeometryWithNormals(3);const i=this._nodes.optional("normals",R.RenderCategory.FINAL,R.RenderCategory.COMPOSITE,R.RenderCategory.OPAQUE,R.RenderCategory.TRANSPARENT,R.InternalRenderCategory.VIEWSHED);return r.retain(e+i-1),this.performanceInfo.advance(K.PerformanceCategory.NORMALS),r}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return;const t=this._nodes.produce(R.InternalRenderCategory.SSAO,this._pluginInput);return this._bindParameters.ssao=t,t&&this.performanceInfo.advance(K.PerformanceCategory.SSAO),t}_precompileAllGeometry(e){const t=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(6),this._plugins.precompile(7),this._renderContext.output=t}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e,...t){for(const r of t)this._bindParameters.slot=r,e.precompile(this._renderContext)}precompileOccludedSlots(e,t){for(const r of t)this._renderContext.renderOccludedMask=r,this.precompileSlots(e,...ie);this._renderContext.renderOccludedMask=B.defaultRenderOccludedMask}renderSlots(e,...t){for(const r of t)this._bindParameters.slot=r,e.forAll(e=>{const t=e.acquireTechniques(this._renderContext);t&&e.render(this._renderContext,t)})}renderOccludedSlots(e,t){this._renderContext.renderOccludedMask=t,this.plugins.renderOccludedFlags>1&&this._plugins.render(9),this.renderSlots(e,...ie),this._renderContext.renderOccludedMask=B.defaultRenderOccludedMask}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(13)}precompileViewshedShadowMap(){this._precompileAllGeometry(7)}renderViewshedShadowMap(e){const{camera:t,contentCamera:r}=this._bindParameters,i=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(7),this._ensureBindParametersCamera(t,r),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=i}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(...$),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(...ee)}_precompileOpaqueGeometry(){this._plugins.precompile(...te)}_renderOpaqueGeometry(){this._plugins.render(...te)}_renderTransparentGeometry(){this._plugins.render(...re)}get _hasTransparentTerrain(){return this._plugins.produces(0,6)}get _hasTransparentIntegratedMesh(){return this._plugins.produces(this._renderContext.output,7)}_renderTransparentTerrain(){const e=()=>this._plugins.render(6);if(!A.isColorOrColorEmission(this._renderContext.output))return void e();const t=this._framebufferSize,r=this.fboCache.acquire(t.width,t.height,"transparent terrain");return this.renderToTargets(e,r,this._framebuffer.depth,y.ZEROS),r}_renderTransparentIntegratedMesh(){const e=()=>this._plugins.render(7);if(!A.isColorOrColorEmission(this._renderContext.output))return void e();const t=this._framebufferSize,r=this.fboCache.acquire(t.width,t.height,"transparent integrated mesh");return this.renderToTargets(e,r,this._framebuffer.depth,y.ZEROS),r}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,12)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=o.releaseMaybe(this._bindParameters.hudVisibility));const{width:e,height:t}=this._framebufferSize;let r=this._bindParameters.hudVisibility;r?.fbo?.width===e&&r?.fbo?.height===t||(r?.release(),r=this.fboCache.acquire(e,t,"hud visibility",4),this._bindParameters.hudVisibility=r);const i=this._bindParameters.geometryDepth;r.attachDepth(i||this._framebuffer.depth),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(12),r.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(K.PerformanceCategory.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,0===e){const e=()=>this._plugins.render(15),t=this._framebufferSize,r=this.fboCache.acquireDepth(10,t.width,t.height,"line callouts");this.renderToTargets(e,this._framebuffer.color,r,void 0,!0,!0),r.release()}else this._plugins.render(15)}_precompileHUD(e){if(this._precompileHUDOutput(e),this._hasHighlights){const t=this._renderContext.output;this._renderContext.output=8,this._precompileHUDOutput(e),this._renderContext.output=t}}_precompileHUDOutput(e){const t=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=e,this._oitEnabled&&A.isColorOrColorEmission(this._renderContext.output)?(this._bindParameters.oitPass=1,this._plugins.precompile(...se),this._bindParameters.oitPass=2,this._plugins.precompile(...se),this._bindParameters.oitPass=0):this._plugins.precompile(...se),this._bindParameters.hudRenderStyle=t}_renderHUD(e,t,r){if(this._pluginsHas.hudElements){if(this._oitEnabled){const i=this._renderOIT(1,r,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,i.getTexture()),i.release()}else if(this._renderContext.output=r,0===e){const t=()=>this._renderHUDElements(e),r=this._framebufferSize,i=this.fboCache.acquireDepth(10,r.width,r.height,"hud");this.renderToTargets(t,this._framebuffer.color,i,void 0,!0,!0),i.release()}else t.acquireDepth(10),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(0===e?K.PerformanceCategory.HUD_OCCLUDED:K.PerformanceCategory.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(...se)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(5,2)}_renderHighlightPrepass(){if(!this._hasHighlights)return;const{fboCache:e,_rctx:t,_bindParameters:r}=this,i=this._framebufferSize,{highlights:s}=r,a=e.acquire(i.width,i.height,"highlights",s.length>v.maxHighlightsPerChannel?3:1);a.acquireDepth(11),t.bindFramebuffer(a.fbo);const{gl:n}=t;return n.clearBufferuiv(n.COLOR,0,[0,0,0,0]),this._renderContext.output=8,t.bindFramebuffer(a.fbo),v.renderHighlightBuffer(t,e,i,r,()=>this._renderHighlightGeometries()),this.performanceInfo.advance(K.PerformanceCategory.HIGHLIGHTS),a}_renderHighlightGeometries(){this._plugins.render(...ae),this._rctx.clear(256),this._renderHUDElements(2)}_renderShadowAccumulation(e,t,r,i){this._shadowAccumulator.updateDepthRange(e),this._shadowAccumulator.accumulating&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,t,r,i)&&this.performanceInfo.advance(K.PerformanceCategory.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&A.isColorOrColorEmission(this._renderContext.output)?(this._bindParameters.oitPass=1,this._plugins.precompile(...re),this._bindParameters.oitPass=2,this._plugins.precompile(...re),this._bindParameters.oitPass=0):this._plugins.precompile(...re)}_renderOIT(e,t,r=2){const i=1===e,s=this._framebufferSize,a=i?this.fboCache.acquire(s.width,s.height,"oit hud composite"):null,n=i?()=>this._renderHUDElements(r):()=>this._renderTransparentGeometry(),h=this._bindParameters,o=this._renderContext.output;this._renderContext.output=t,h.oitPass=1;const d=a?"oit hud color+alpha":"oit color+alpha",l=this.fboCache.acquire(s.width,s.height,d,8),u=1===t;u&&l.acquireColor(X.ColorAttachment1,8,"oit emissive"),l.acquireColor(u?X.ColorAttachment2:X.ColorAttachment1,7),a||l.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(l.fbo),this._rctx.clearFramebuffer([0,0,0,1]),u&&this._rctx.clearBuffer(1,C.ZEROS),n(),l.detachDepth(),h.oitPass=2;const _=this.fboCache.acquire(s.width,s.height,a?"oit hud front":"oit front");return u&&_.acquireColor(X.ColorAttachment1,8,"oit emissive front"),a?_.acquireDepth(10):_.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(_.fbo),this._rctx.clearFramebuffer(y.ZEROS,!!a),n(),_.detachDepth(),h.oitPass=0,a?(this._rctx.bindFramebuffer(a.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(16384)):this._framebuffer.bind(),this._oitblend??=new F.OITBlend(this._techniques),this._oitblend.blend(this._rctx,l,_,h,u),a?.detachDepth(),_.release(),l.release(),this._renderContext.output=o,a}_renderOpaque(e){const t=this.plugins.produces(0,...te);if(t){this._plugins.render(0,1);const e=this._framebuffer;e.update(e=>this._renderNodes(R.InternalRenderCategory.OPAQUE_TERRAIN,e)),e.bind(),this._plugins.render(2,3)}const r=this._framebuffer;r.update(e=>this._renderNodes(R.RenderCategory.OPAQUE,e,t)),this.fboCache.debugCallback?.(R.RenderCategory.OPAQUE,r.color.fbo),r.update(e=>this._renderNodes(R.InternalRenderCategory.OPAQUE_ENVIRONMENT,e)),this.fboCache.debugCallback?.(R.InternalRenderCategory.OPAQUE_ENVIRONMENT,r.color.fbo),this._renderTerrainDepth(e),this._renderEdges(1)}_renderTransparent(e,t,r){const i=this._framebuffer;i.bind(),this._renderPlugins(20,K.PerformanceCategory.VOXEL),this._renderHiddenTransparentEdges(),e&&(this._oitEnabled?this._renderOIT(0,r):this._renderTransparentGeometry()),i.update(t=>this._renderNodes(R.RenderCategory.TRANSPARENT,t,e)),this.fboCache.debugCallback?.(R.RenderCategory.TRANSPARENT,i.color.fbo),this._renderGeometryDepth(t),this._renderHUDVisibility(),t||this._plugins.render(15),this._renderEdges(0);const s=this._hasTransparentTerrain?this._renderTransparentTerrain():null;s&&(this.performanceInfo.advance(K.PerformanceCategory.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(t?this._renderLineCallouts(0):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,s.getTexture())),this._renderHUD(0,i.color,r))),this._bindParameters.cullAboveTerrain=!1,s&&(i.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,s.getTexture()),s.release(),t&&(this._renderEdges(1),e&&(this._oitEnabled?this._renderOIT(0,r):this._renderTransparentGeometry(),this.performanceInfo.advance(K.PerformanceCategory.TRANSPARENT)),this._renderEdges(0)));const a=this._hasTransparentIntegratedMesh?this._renderTransparentIntegratedMesh():null;a&&(i.bind(),this._compositingHelper.composite(this._bindParameters,a.getTexture()),a.release()),this._bindParameters.ssao=o.releaseMaybe(this._bindParameters.ssao),t&&this._renderLineCallouts(1),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment()}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(K.PerformanceCategory.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(8),this.performanceInfo.advance(K.PerformanceCategory.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(e),this.performanceInfo.advance(t))}_renderNodes(e,t,r=!1){if(t.setName(e),this._pluginInput.set(e,t),!this._nodes.produces(e))return r&&this.performanceInfo.advance(e),t;const i=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),i}_blitFBO(e,t=I.defaultWebGLFBO,r=!0){return this._blit??=new M.Blit(this._techniques),this._blit.blit(this._rctx,e,t,this._bindParameters),this._pluginInput.set(e.name,t),r&&e.release(),t}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=f.IDENTITY:(g.invert(he,this._bindParameters.camera.viewMatrix),g.invert(ne,this._bindParameters.camera.projectionMatrix),g.multiply(oe,he,ne),g.multiply(oe,this._renderContext.lastFrameCamera.viewMatrix,oe),g.multiply(oe,this._renderContext.lastFrameCamera.projectionMatrix,oe),this._reprojectionMatrix=oe);const t=this.stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=f.IDENTITY,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,t,r,i){this._bindParameters.updateLighting(e,t,r,i),this._requestRender(1)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(e,t,r,i,s=!1,a=!1){t.attachDepth(r),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(i,s,a),e(),t.detachDepth()}get test(){}},r.__decorate([c.property({readOnly:!0})],t.Renderer.prototype,"fullResolutionAtmosphere",null),r.__decorate([c.property()],t.Renderer.prototype,"_edgeView",void 0),r.__decorate([c.property()],t.Renderer.prototype,"updating",null),t.Renderer=r.__decorate([m.subclass("esri.views.3d.webgl-engine.lib.Renderer")],t.Renderer);const $=[0,1,2,4],ee=[3,5],te=[0,1,2,3],re=[4,5],ie=[2,4,8],se=[16,13,14],ae=[4,5,2,3,6,0,1],ne=f.create(),he=f.create(),oe=f.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});