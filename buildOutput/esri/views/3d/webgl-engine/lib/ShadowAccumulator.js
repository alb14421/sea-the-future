// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../core/shaderLibrary/shading/ReadShadowMap.glsl","./BindParameters","./DepthRange","./glUtil3D","./ShadowCastRenderer","./ShadowMap","../../../../chunks/ShadowCastAccumulate.glsl","../shaders/ShadowCastAccumulateTechnique","../shaders/ShadowCastAccumulateTechniqueConfiguration","../shaders/ShadowCastClearTechnique","../../../support/Scheduler","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/TextureDescriptor"],function(e,t,r,i,a,s,o,n,c,h,u,l,_,d,m,p,g,f,b,S,w,y,v,A,C,F,x,R){"use strict";e.ShadowAccumulator=class extends r{updateDepthRange(e){this._depthRange.equals(e)||(this._depthRange=e)}constructor(e,t,r,i,a,s){super({}),this.fbos=e,this._techniques=t,this._stage=r,this._prepareForShadowMapPass=i,this._renderToShadowMap=a,this._requestRender=s,this._primarySet=new q(new v.ShadowCastAccumulateTechniqueConfiguration(0),()=>this._requestRenderIfEnabled()),this._contextSet=new q(new v.ShadowCastAccumulateTechniqueConfiguration(1),()=>this._requestRenderIfEnabled()),this._passParameters=new m.ReadShadowMapPassParameters,this._depthRange=g.DepthRange.zero,this._previewing=!1,this._shadowAccumulatorKey=Symbol("shadowAccumulator"),this._rctx=e.rctx,this._bindParameters=new p.BindParameters(new S.ShadowMap(e,r.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=f.createQuadVAO(this._rctx),this._accumulationRenderer=new b.ShadowCastRenderer(t,this._rctx,this,s);const o=this._stage.view.resourceController.scheduler;this.addHandles([o.registerTask(C.TaskPriority.SHADOW_ACCUMULATOR,this),n.watch(()=>this._previewing,()=>this._requestRenderIfEnabled(),n.sync),n.watch(()=>2===this._numActive,()=>this._numActiveChanged(),n.sync),n.watch(()=>this._depthRange,()=>this._invalidateAccumulationSets(),n.sync)],this._shadowAccumulatorKey);for(const e of this._accumulationSets())e.precompile(t)}*_accumulationSets(){yield this._primarySet,yield this._contextSet}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=o.disposeMaybe(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=o.disposeMaybe(this._fbo),this._vao=o.disposeMaybe(this._vao);for(const e of this._accumulationSets())e.destroy();this._contextSet=null,this._primarySet=null,this._bindParameters.destroy()}get computedSamples(){return[this._primarySet.progress,this._contextSet.progress]}get shadowCastTexture(){return this._fbo?.colorTexture}get accumulating(){return this.active&&this._previewing||this._refining}get _refining(){return this.active&&!this._doneAccumulating&&!this._previewing}get active(){return null!=this._fbo&&[...this._accumulationSets()].some(e=>e.active)}get canAccumulate(){return null!=this._bindParameters.depth&&this._depthRange!==g.DepthRange.zero&&this._opacityFromElevation>b.shadowCastDisabledElevationThreshold}get _doneAccumulating(){return[...this._accumulationSets()].every(e=>e.doneAccumulating)}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get _numActive(){return[...this._accumulationSets()].reduce((e,t)=>e+(t.active?1:0),0)}get _pixelFormat(){return 2===this._numActive?{pixelFormat:33319,internalFormat:F.SizedPixelFormat.RG8}:{pixelFormat:6403,internalFormat:F.SizedPixelFormat.R8}}get readyToRun(){return this._refining&&this.canAccumulate&&[...this._accumulationSets()].some(e=>e.running)}runTask(e){this._clearBuffersOnAccumulationStart(),this._prepareForShadowMapPass(this._bindParameters);let t=!1;for(const r of this._accumulationSets())this._runTaskForSet(r,e)&&(t=!0);t&&this._requestRender()}_runTaskForSet(e,t){let r=!1;for(;!t.done&&!e.doneAccumulating;)this._accumulateShadow(e),t.madeProgress(),r=!0;return r}renderAccumulation(e,t,r,i){return this._updateCamera(t),this._bindParameters.contentCamera=r,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!(!this.accumulating||!this.canAccumulate)&&(this._previewing||i?(this._clearFramebuffer(),this._reset()):this._clearBuffersOnAccumulationStart(),this._accumulateSetsForRenderFrame(i))}_clearBuffersOnAccumulationStart(){if([...this._accumulationSets()].every(e=>0===e.progress))this._clearFramebuffer();else for(const e of this._accumulationSets())0===e.progress&&this._clearFramebufferForSet(this._fbo,e)}_accumulateSetsForRenderFrame(e){let t=!1;for(const r of this._accumulationSets())this._accumulateSetForRenderFrame(r,e)&&(t=!0);return t&&this._requestRender(),t}_accumulateSetForRenderFrame(e,t){let r=t?e.sampleCount:Math.min(T,e.sampleCount);r-=e.progress;for(let t=0;t<r;++t)this._accumulateShadow(e);return r>0}precompile(){this._accumulationRenderer.precompile()}render(e){this._accumulationRenderer.render(e)}setOptions(e){void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._primarySet.lightDirections=e.lightDirections),void 0!==e.lightDirectionsContext&&(this._contextSet.lightDirections=e.lightDirectionsContext),!0===e.enabled?this._enable():!1===e.enabled&&this._disable(),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){const r=this._primarySet.progress;return!this.active||!this._fbo||r<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,6408,F.PixelType.UNSIGNED_BYTE,P),P[0]/r)}_numActiveChanged(){if(!this._fbo)return;const e=2===this._numActive,t=this._createFBO();t.resize(this._fbo.width,this._fbo.height),e&&(this._clearFramebuffer(t),this._contextSet.reset()),this._fbo.width&&this._fbo.height&&this._rctx.blitFramebuffer(this._fbo,t),this._fbo.dispose(),this._fbo=t,this._requestRender()}_enable(){this._fbo||(this._fbo=this._createFBO(),this._invalidateAccumulationSets())}_createFBO(){const{pixelFormat:e,internalFormat:t}=this._pixelFormat,r=new R.TextureDescriptor;return r.pixelFormat=e,r.internalFormat=t,r.wrapMode=33071,new x.FramebufferObject(this._rctx,r)}_invalidateAccumulationSets(){for(const e of this._accumulationSets())e.reset();this._requestRenderIfEnabled()}_disable(){this._fbo&&(this._fbo=o.disposeMaybe(this._fbo),this._requestRender())}_reset(){for(const e of this._accumulationSets())e.reset()}_clearFramebuffer(e=this._fbo){e&&e.width&&e.height&&(this._rctx.bindFramebuffer(e),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(16384))}_clearFramebufferForSet(e,t){if(!e)return;const r=this._techniques.get(A.ShadowCastClearTechnique,t.configuration);this._rctx.bindFramebuffer(e),this._rctx.bindTechnique(r,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(r.primitiveType,0,this._vao.vertexCount("geometry"))}_accumulateShadow(e){this._renderToShadowMap(this._bindParameters,e.lightDirections[e.progress++],this._depthRange);const t=this._techniques.get(y.ShadowCastAccumulateTechnique,e.configuration);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(t,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,this._vao.vertexCount("geometry"))}_updateCamera(e){const t=this._fbo;if(null==t)return;const r=this._bindParameters.camera;e.equals(r)||r.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-s.smoothstep(b.shadowCastDisableElevationMin,b.shadowCastDisableElevationMax,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}},t.__decorate([h.property()],e.ShadowAccumulator.prototype,"_fbo",void 0),t.__decorate([h.property()],e.ShadowAccumulator.prototype,"_depthRange",void 0),t.__decorate([h.property()],e.ShadowAccumulator.prototype,"_previewing",void 0),t.__decorate([h.property()],e.ShadowAccumulator.prototype,"_accumulationRenderer",void 0),t.__decorate([h.property()],e.ShadowAccumulator.prototype,"_refining",null),t.__decorate([h.property()],e.ShadowAccumulator.prototype,"active",null),t.__decorate([h.property()],e.ShadowAccumulator.prototype,"canAccumulate",null),t.__decorate([h.property()],e.ShadowAccumulator.prototype,"_doneAccumulating",null),t.__decorate([h.property()],e.ShadowAccumulator.prototype,"_opacityFromElevation",null),t.__decorate([h.property()],e.ShadowAccumulator.prototype,"_numActive",null),t.__decorate([h.property()],e.ShadowAccumulator.prototype,"_pixelFormat",null),t.__decorate([h.property()],e.ShadowAccumulator.prototype,"readyToRun",null),e.ShadowAccumulator=t.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],e.ShadowAccumulator);const T=6,P=new Uint8Array(4);class q{constructor(e,t){this.configuration=e,this._notifyChange=t,this._cachedLightDirections=[],this._progress=c.signal(0),this._sampleCount=c.signal(0)}get progress(){return this._progress.value}set progress(e){this._progress.value=e}get sampleCount(){return this._sampleCount.value}get doneAccumulating(){return this.progress>=this.sampleCount}get running(){return this.progress>0}get active(){return this.sampleCount>0}get lightDirections(){return this._cachedLightDirections}set lightDirections(e){const t=this._cachedLightDirections,r=Math.min(w.ShadowCastMaxSamples,e.length);if(!i.sliceEquals(t,0,t.length,e,0,r,_.equals)){t.length=r,this._sampleCount.value=r;for(let i=0;i<r;++i)t[i]=_.copy(t[i]??d.create(),e[i]);this.reset(),this._notifyChange()}}destroy(){this._cachedLightDirections.length=0,this._sampleCount.value=0}reset(){this.progress=0}precompile(e){e.precompile(y.ShadowCastAccumulateTechnique,this.configuration),e.precompile(A.ShadowCastClearTechnique,this.configuration)}}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});