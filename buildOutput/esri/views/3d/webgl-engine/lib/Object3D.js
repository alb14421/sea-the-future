// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/has","../../../../core/uid","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/sphere","../../support/mathUtils","./Object3DStateID","./Util","./VertexAttribute","../materials/renderers/utils"],function(t,e,i,s,a,r,o,h,n,m,d,c,l){"use strict";class g{constructor(){this._data=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE]}get min(){return o.fromValues(this._data[0],this._data[1],this._data[2])}get max(){return o.fromValues(this._data[3],this._data[4],this._data[5])}minWith(t){const{_data:e}=this;e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2])}maxWith(t){const{_data:e}=this;e[3]=Math.max(e[3],t[0]),e[4]=Math.max(e[4],t[1]),e[5]=Math.max(e[5],t[2])}assignMinMax(t,e){for(let i=0;i<3;++i)this._data[0+i]=t[i],this._data[3+i]=e[i]}isEmpty(){return this._data[3]<this._data[0]&&this._data[4]<this._data[1]&&this._data[5]<this._data[2]}}class u extends g{constructor(){super(...arguments),this.bounds=h.create()}}function _(t,e,i){const a=t.bbMin,o=t.bbMax;if(s.hasIdentityRotation(i)){const t=r.set(f,i[12],i[13],i[14]);return r.add(b,a,t),r.add(v,o,t),e.minWith(b),void e.maxWith(v)}if(r.transformMat4(b,a,i),r.exactEquals(a,o))return e.minWith(b),void e.maxWith(b);r.transformMat4(v,o,i),e.minWith(b),e.minWith(v),e.maxWith(b),e.maxWith(v);for(let t=0;t<3;++t)r.copy(b,a),r.copy(v,o),b[t]=o[t],v[t]=a[t],r.transformMat4(b,b,i),r.transformMat4(v,v,i),e.minWith(b),e.minWith(v),e.maxWith(b),e.maxWith(v)}const f=o.create(),b=o.create(),v=o.create(),y=o.create();t.BoundingVolume=u,t.Object3D=class{constructor(t={}){this.id=i.generateUID(),this._highlightIds=new Set,this._shaderTransformation=null,this._visible=!0,this.castShadow=t.castShadow??!0,this.usesVerticalDistanceToGround=t.usesVerticalDistanceToGround??!1,this.graphicUid=t.graphicUid,this.layerViewUid=t.layerViewUid,t.isElevationSource&&(this.lastValidElevationBB=new g),this._geometries=t.geometries?Array.from(t.geometries):new Array}dispose(){this._geometries.length=0}get layer(){return this._layer}set layer(t){d.assert(null==this._layer||null==t,"Object3D can only be added to a single Layer"),this._layer=t}addGeometry(t){t.visible=this._visible,this._geometries.push(t);for(const e of this._highlightIds)t.addHighlight(e);this._emit("geometryAdded",{object:this,geometry:t}),this._highlightIds.size&&this._emit("highlightChanged",this),this._invalidateBoundingVolume()}removeGeometry(t){const e=this._geometries.splice(t,1)[0];if(e){for(const t of this._highlightIds)e.removeHighlight(t);this._emit("geometryRemoved",{object:this,geometry:e}),this._highlightIds.size&&this._emit("highlightChanged",this),this._invalidateBoundingVolume()}}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(t,e,i=!1){this._emit("attributesChanged",{object:this,geometry:t,attribute:e,sync:i}),c.affectsGeometry(e)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(t){if(this._visible!==t){this._visible=t;for(const t of this._geometries)t.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const t=new m.Object3DOccludeeStateID;for(const e of this._geometries)e.occludees=l.addObject3DStateID(e.occludees,t);return this._emit("occlusionChanged",this),t}removeOcclude(t){for(const e of this._geometries)e.occludees=l.removeObject3DStateID(e.occludees,t);this._emit("occlusionChanged",this)}highlight(t){const e=new m.Object3DHighlightStateID(t);for(const t of this._geometries)t.addHighlight(e);return this._emit("highlightChanged",this),this._highlightIds.add(e),e}removeHighlight(t){this._highlightIds.delete(t);for(const e of this._geometries)e.removeHighlight(t);this._emit("highlightChanged",this)}removeStateID(t){0===t.channel?this.removeHighlight(t):this.removeOcclude(t)}getCombinedStaticTransformation(t,e){return s.multiply(e,this.transformation,t.transformation)}getCombinedShaderTransformation(t,e=a.create()){return s.multiply(e,this.effectiveTransformation,t.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new u,this._validateBoundingVolume(this._bvWorldSpace,0)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new u,this._validateBoundingVolume(this._bvObjectSpace,1)),this._bvObjectSpace}_validateBoundingVolume(t,e){const i=1===e;for(const e of this._geometries){const s=e.boundingInfo;s&&_(s,t,i?e.transformation:this.getCombinedShaderTransformation(e))}r.lerp(h.getCenter(t.bounds),t.min,t.max,.5);for(const e of this._geometries){const s=e.boundingInfo;if(null==s)continue;const a=i?e.transformation:this.getCombinedShaderTransformation(e),o=n.maxScale(a);r.transformMat4(y,s.center,a);const m=r.distance(y,h.getCenter(t.bounds)),d=s.radius*o;t.bounds[3]=Math.max(t.bounds[3],m+d)}}_invalidateBoundingVolume(){const t=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this.layer&&t&&this.layer.notifyObjectBBChanged(this,t)}_emit(t,e){this.layer?.events.emit(t,e)}get geometries(){return this._geometries}get transformation(){return this._transformation??a.IDENTITY}set transformation(t){this._transformation=s.copy(this._transformation??a.create(),t),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(t){this._shaderTransformation=t?s.copy(this._shaderTransformation??a.create(),t):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}get test(){}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});