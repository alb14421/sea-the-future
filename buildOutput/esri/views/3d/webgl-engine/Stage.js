// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/arrayUtils","../../../core/compilerUtils","../../../core/has","../../../core/maybe","../../../core/promiseUtils","../../../core/signal","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../state/helpers/SceneIntersectionHelper","../support/TextureCollection","./lib/ChangeSet","./parts/Model","./parts/RenderView","../../support/Scheduler","../../support/Yield"],function(e,t,r,s,i,n,d,o,a,h,c,l,y,u,_,m,p,g,S){"use strict";e.Stage=class extends r{constructor(e){super(e),this._model=new m.Model,this._canCompact=a.signal(!1),this._layers=new Array,this._asyncChangeSet=new _.ChangeSet,this._syncChangeSet=new _.ChangeSet,this._layerSyncSet=new Set,this._textures=new u.TextureCollection(this,e.view.resourceController.scheduler),this._frameTask=e.view.resourceController.scheduler.registerTask(g.TaskPriority.STAGE,this),this.addHandles(this._frameTask)}initialize(){this._renderView=new p.RenderView({stage:this})}destroy(){this.removeAllHandles(),this._textures.destroy(),this._set("textures",null),this._renderView=d.destroyMaybe(this._renderView),this._set("renderView",null),this._layers.length=0,this._model=null,this._set("renderer",null),this.options.canvas=null,this._set("options",null)}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.readyToRun||this.renderView.updating||this._frameTask.updating||this.textures.updating}get renderView(){return this._renderView}get renderer(){return this.renderView?.renderer}get textures(){return this._textures}addTexture(e){this._model.addTexture(e),this.renderView.requestRender()}removeTexture(e){null!=e&&!this.destroyed&&this._model.hasTexture(e)&&(this._model.removeTexture(e),this.renderView.requestRender())}addTextures(e){null!=e&&(this._model.addTextures(e),this.renderView.requestRender())}removeTextures(e){null!=e&&(this._model?.removeTextures(e),this.renderView.requestRender())}forEachTexture(e){this._model.forEachTexture(e)}getTexture(e){return this._model.getTexture(e)}addLayer(e){this._layers.includes(e)||(this._model.addLayer(e),this._layers.push(e),this._model.dirtySet.layerAdded(e),this.renderView.requestRender())}removeLayer(e){null!=e&&!this.destroyed&&this._model.hasLayer(i.toConst(e))&&(this._model.dirtySet.layerRemoved(e),this._commitLayer(e),s.removeUnordered(this._layers,e),this._model.dirtySet.assertLayerClean(e.id),this._model.removeLayer(e),this.renderView.requestRender())}getLayer(e){return this._model.getLayer(e)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get readyToRun(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty||this._canCompact.value}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),this.renderer.compact(e),this._canCompact.value=this.renderer.canCompact,!e.hasProgressed)return S.Yield}compact(e){return this._canCompact.value=!1,this.renderer.compact(e)}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forEach(r=>{if(e.done)return;const s=this._layerSyncSet.has(r.id)||1===r.updatePolicy,i=s?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(r.id,i),this._layerSyncSet.delete(r.id),i.empty||(this.renderer.commit(i,s?g.noBudget:e),this.renderView.requestRender(),e.madeProgress())}),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,g.noBudget),this.renderView.requestRender(),e.madeProgress()),this._layers.forEach(r=>{e.done||this._layerSyncSet.has(r.id)||0!==r.updatePolicy||(t.commitLayer(r.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("readyToRun")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forEach(t=>{this._layerSyncSet.has(t.id)||1===t.updatePolicy?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)});for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,g.noBudget),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,g.noBudget),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}get layers(){return this._layers}addRenderPlugin(e,t){const r=this.renderer.plugins.add(e,t),s=()=>{y.isIntersectionHandler(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if(o.isPromiseLike(r))return r.then(s);s()}removeRenderPlugin(e){this.destroyed||(y.isIntersectionHandler(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get test(){}},t.__decorate([h.property({constructOnly:!0})],e.Stage.prototype,"view",void 0),t.__decorate([h.property({constructOnly:!0})],e.Stage.prototype,"options",void 0),t.__decorate([h.property({readOnly:!0})],e.Stage.prototype,"viewingMode",null),t.__decorate([h.property({constructOnly:!0})],e.Stage.prototype,"container",void 0),t.__decorate([h.property({readOnly:!0})],e.Stage.prototype,"updating",null),t.__decorate([h.property({readOnly:!0})],e.Stage.prototype,"renderView",null),t.__decorate([h.property({readOnly:!0})],e.Stage.prototype,"renderer",null),t.__decorate([h.property({readOnly:!0})],e.Stage.prototype,"textures",null),t.__decorate([h.property({readOnly:!0})],e.Stage.prototype,"readyToRun",null),e.Stage=t.__decorate([l.subclass("esri.views.3d.webgl-engine.Stage")],e.Stage),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});