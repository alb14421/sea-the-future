// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../support/screenshotUtils","../../../webgl/enums","../../../webgl/FramebufferObject","../../../../core/imageUtils"],function(e,t,r,s,a,i,n){"use strict";e.ScreenshotContext=class{constructor(e,t){this.parameters=e,this.fbos=t}},e.ScreenshotManager=class{constructor(e,t,r){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=r,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(0);const r=t.createResolver();return this._screenshotQueue.push({settings:e,resolver:r}),r.promise}update(e,t){for(const r of this._screenshotQueue){if(null==this._rctx){r.resolver.reject();continue}const s={...r.settings,pixelRatio:r.settings.pixelRatio*e.parameters.camera.pixelRatio},a=this._renderScreenshot(e,s,t);r.resolver(a)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,r){e.width=t.width,e.height=t.height;const s=e.getContext("2d",{willReadFrequently:!0}),a=r.pixelRatio;return s.save(),s.translate(0,t.height),s.scale(1,-1),r.region&&s.translate(-r.region.x,-r.region.y),s.scale(a,a),t=this._renderFunctions.renderOverlay(e,r.disableDecorations,t),s.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:r,framebufferHeight:i,region:o,resample:c}=e,h=this._ensureScreenshotEncodeCanvas();let l=n.createEmptyImageData(r,i,h);this._rctx.gl.readPixels(0,0,r,i,6408,a.DataType.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),t(),l=this._renderScreenshotOverlay(h,l,{...e,region:void 0});const d=n.createEmptyImageData(o.width,o.height,h);return s.resampleHermite(l,d,!0,c.region.x,i-(c.region.y+c.region.height),c.region.width,c.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:r,region:s}=e,i=this._ensureScreenshotEncodeCanvas(),o=n.createEmptyImageData(s.width,s.height,i);return this._rctx.gl.readPixels(s.x,r-(s.y+s.height),s.width,s.height,6408,a.DataType.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),t(),this._renderScreenshotOverlay(i,o,e)}_renderScreenshot(e,t,s){const a=e.parameters.camera,{framebufferWidth:n,framebufferHeight:o,ignorePadding:c,pixelRatio:h,disableDecorations:l,olidColor:d}=t,u={width:n,height:o};i.ensureAttachmentMaxSize(u,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let f=!1;const m=u.width!==a.fullWidth||u.height!==a.fullHeight,g=c&&a.pixelRatio!==h,_=m||l||g||d;let p=null,b=null;if(_){const e=a.clone();if(c){const t=r.clone(e.padding);for(let r=0;r<4;r++)t[r]=Math.round(t[r]/e.pixelRatio*h);e.padding=t}e.fullWidth=u.width,e.fullHeight=u.height,e.pixelRatio=h;const t=a.fovX-e.fovX,i=a.fovY-e.fovY;t<0&&t<i?e.fovX=a.fovX:i<0&&i<t&&(e.fovY=a.fovY);const n={camera:e,contentCamera:e,mode:2,alignPixelEnabled:!0,contentPixelRatio:e.pixelRatio};this._forceCameraHook(n),f=!0;const o=this._renderFunctions.renderScene(n,s,d?2:1,l);b=o.screen,p=o.olid}this._rctx.bindFramebuffer(b?.fbo);const x=this._readbackScreenshot(t,()=>{this._rctx.bindFramebuffer(null),b?.release()});let v=null;if(d){const e=()=>{this._rctx.bindFramebuffer(null),p?.release()};this._rctx.bindFramebuffer(p?.fbo),v=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null)}if(_&&!this._rctx.contextAttributes.alpha)for(let e=3;e<x.data.length;e+=4)x.data[e]=255;if(v&&!this._rctx.contextAttributes.alpha)for(let e=3;e<v.data.length;e+=4)v.data[e]=255;return f&&this._forceCameraHook(e.parameters),[x,v]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??=document.createElement("canvas"),this._screenshotEncodeCanvas}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});