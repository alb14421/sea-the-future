// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../layers/VoxelWasm","../Constraints","./InteractiveController","../utils/navigationUtils"],function(t,i,e,r,s,o,a,n,c,h,l,p,m,_,v,d,u,P,C,w,g){"use strict";t.RotateController=class extends w.InteractiveController{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(t){super(t),this.pivot=0,this._rotScale=0,this._lastPoint=m.create(),this._tmpWorldUp=v.create(),this._tmpViewDir=v.create(),this._tmpRotCurPoint=m.create(),this._tmpTransf=l.create(),this._tmpAxis=v.create(),this._tmpPivotPoint=v.create(),this._pivotPos=v.create(),this._constraintOptions=new u.ConstraintOptions(15,2,0,this.startCamera)}initialize(){this._rotScale=0===this.pivot?3:1.5}begin(t){if(this.running){switch(this.pivot){case 1:_.copy(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=3,this._constraintOptions.tiltMode=1,this._constraintOptions.selection=0;break;case 0:{const i=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.basemapTerrain.invisible?g.excludeTerrain:{});i||_.copy(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(t,i),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=2,this._constraintOptions.tiltMode=0,this._constraintOptions.selection=11;break}}g.normalizeCoordinate(this.startCamera,t,this._lastPoint)}}_constrainPivotPoint(t,i){const e=this.startCamera,s=v.create();_.subtract(s,this._pivotPos,e.eye);const o=_.length(s),a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(e.eye,y);let n=Math.max(g.getTiltScaleFactor(y,e.viewForward,g.maxRotatePivotDistanceModifier)*a,g.minRotatePivotDistance);i&&(n=Math.min(o,n));const c=r.createScreenPointArray(e.width/e.pixelRatio*.5,e.height/e.pixelRatio*.5),h=g.navigationMode(this.startCamera,c,this.view.renderCoordsHelper,this.view.viewingMode);let l=this.view.stage.renderView.getMinimalDepthForArea(P.getVoxelWasm(this.view),e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,2.5*g.rotatePivotSearchAreaSize,g.rotatePivotSearchAreaSize),p=this.view.stage.renderView.getMinimalDepthForArea(P.getVoxelWasm(this.view),t[0],t[1],e,g.rotatePivotSearchAreaSize);null==l&&null==p||(l=l??p??0,p=null==p||1===h?l:p,n=l>p?p:l,n=i?Math.min(n,o):n),_.normalize(s,s),_.copy(this._pivotPos,_.add(this._tmpPivotPoint,e.eye,_.scale(this._tmpPivotPoint,s,n)))}update(t){if(this.running){switch(this.pivot){case 1:this.currentCamera.center=this._applyRotation(this.currentCamera,t,this.currentCamera.center,this._pivotPos);break;case 0:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,t,this.currentCamera.eye,this._pivotPos)}d.applyAll(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(t,i,r,s){this.view.renderCoordsHelper.worldUpAtPosition(s,this._tmpWorldUp),g.normalizeCoordinate(t,i,this._tmpRotCurPoint);let o=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;_.subtract(this._tmpViewDir,r,s);const n=_.length(this._tmpViewDir),c=e.acosClamped(_.dot(this._tmpViewDir,this._tmpWorldUp)/n);if(1===this.pivot){o*=-.5;const t=.5*Math.PI-c,i=.5*Math.PI*.99;o=t-Math.max(-i,Math.min(i,t+o))}return o=e.clamp(o+c,C.TiltRange.min,C.TiltRange.max)-c,_.cross(this._tmpAxis,t.up,this._tmpViewDir),0===this.pivot&&(a=-a),h.fromRotation(this._tmpTransf,a,this._tmpWorldUp),h.rotate(this._tmpTransf,this._tmpTransf,o,this._tmpAxis),_.transformMat4(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),t.up=_.transformMat4(f,t.up,this._tmpTransf),_.add(f,s,this._tmpViewDir),p.copy(this._lastPoint,this._tmpRotCurPoint),f}},i.__decorate([s.property()],t.RotateController.prototype,"pivot",void 0),t.RotateController=i.__decorate([c.subclass("esri.views.3d.state.controllers.RotateController")],t.RotateController);const f=v.create(),y=v.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});