// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/time","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/ray","../../../../chunks/sphere","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/surfaceCollision","./PointToPointAnimationController","../utils/navigationUtils","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl/RenderCamera","../../webgl-engine/lib/Intersector","../../../animation/easing"],function(t,e,i,r,s,a,n,o,c,h,m,p,l,_,d,g,y,u,C,w,D,b,v){"use strict";t.ZoomStepControllerGlobal=class extends y.PointToPointAnimationController{constructor(){super(...arguments),this._zoomLocation=m.create(),this._tmpCamera=new D,this._tmpViewDir=m.create(),this._tmpRayDir=p.create(),this._targetOnSphere=m.create(),this._tmpCenter=m.create(),this._beginCamera=new D,this._constraintOptions=new d.ConstraintOptions(7,1,null,this._beginCamera),this._sphere=l.create()}initialize(){this._intersector=new b.Intersector(this.view.state.viewingMode)}step(t,e){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,s=!1;this._intersectionHelper.intersectScreen(e,this._zoomLocation,0===this.view.map.ground.opacity?u.excludeTerrain:{})&&(r=t>0,s=!0),this._tmpCamera.copyFrom(i.camera),r?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:h.copy(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,t,e,s),this.begin(this._tmpCamera)}animationSettings(){return{duration:r.Milliseconds(600),easing:v.outExpo}}_updateCamera(t,e,r,s){const a=u.navigationMode(t,r,this.view.renderCoordsHelper,this.view.viewingMode),n=Math.abs(this.view.camera.position.z),o=this._zoomLocation;h.normalize(R,t.eye),h.scale(R,R,-1),C.fromScreenAtEye(t,r,this._tmpRayDir),h.normalize(this._tmpRayDir.direction,this._tmpRayDir.direction);const c=i.clamp(u.getTiltScaleFactor(R,this._tmpRayDir.direction,u.maxZoomStepDistanceModifier)*n,u.zoomStepDistanceClamp[0],u.zoomStepDistanceClamp[1]);if(1===a){let i=.6**e;this._sphere[3]=h.length(o),h.subtract(this._tmpViewDir,t.center,t.eye);const s=Math.min(h.length(this._tmpViewDir),c);let a=s*i;if(i<=1&&a<4&&(a=4,i=a/s),Math.abs(s-a)<1e-6)return;const n=h.length(t.center);if(this._sphere[3]!==n){const e=this._sphere[3]+i*(n-this._sphere[3]);t.center=h.scale(S,t.center,e/n)}h.scale(this._tmpViewDir,this._tmpViewDir,-i),t.eye=h.add(S,t.center,this._tmpViewDir),_.applyAll(this.view,t,this._constraintOptions),h.squaredDistance(o,t.center)>1e-12&&w.intersectScreen(this._sphere,t,r,this._targetOnSphere)&&u.panToPosition(this._sphere,t,o,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let i=.6**Math.abs(e);const a=e>0?1:-1;h.subtract(this._tmpViewDir,o,t.eye);const n=h.length(this._tmpViewDir),m=this.view.stage.renderView.getMinimalDepthForArea(null,r[0],r[1],this.view.state.camera,60);let p=null!=m?m:c;s&&e>0&&(p=Math.min(p,n)),h.scale(this._tmpRayDir.direction,this._tmpRayDir.direction,p),h.add(o,this._tmpRayDir.origin,this._tmpRayDir.direction);let l=p*i;const _=Math.max(4,1.01*t.nearFar[0]);if(e>0&&l<_&&(l=_,i=l/p),Math.abs(p-l)<1e-6)return;h.scale(this._tmpRayDir.direction,this._tmpRayDir.direction,a*(1-i)),t.eye=h.add(S,t.eye,this._tmpRayDir.direction),t.center=h.add(S,t.center,this._tmpRayDir.direction)}g.applySurfaceCollisionConstraint(this.view,t)}},t.ZoomStepControllerGlobal=e.__decorate([c.subclass("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],t.ZoomStepControllerGlobal);const S=m.create(),R=m.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});