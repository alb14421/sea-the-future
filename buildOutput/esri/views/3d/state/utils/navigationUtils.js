// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vectorStacks","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl/RenderCamera","../../webgl-engine/lib/verticalOffsetUtils"],function(e,t,n,a,r,o,i,c,s,l,m,d,u,p,h,g,f,y,M){"use strict";const P={exclude:new Set([M.terrainId])};function b(e,t,n){const a=r.fromRotation(h.sm4d.get(),n[3],m.axis(n));null==a||r.exactEquals(a,o.IDENTITY)||(s.subtract(ne,e.eye,t),s.transformMat4(ne,ne,a),e.eye=s.add(ne,ne,t),s.subtract(ne,e.center,t),s.transformMat4(ne,ne,a),e.center=s.add(ne,ne,t),e.up=s.transformMat4(ne,e.up,a))}const v=a.createScreenPointArray();function x(e,t,n,a){return Math.sin(e/s.length(t))*(n+a.radius)}const A={Elevation:3e4,Angle:n.deg2rad(16)},S=n.deg2rad(80),z=l.create();function T(e,t,n,a){const r=g.fromScreenAtEye(t,n,ce);return!(null==r||(p.closestPointOnSilhouette(e,r,R),p.intersectRay(e,r,a)?s.squaredDistance(R,r.origin)<s.squaredDistance(a,r.origin)&&(s.copy(a,R),1):(s.subtract(I,t.eye,t.center),s.normalize(I,I),u.fromNormalAndOffset(I,-s.dot(s.normalize(I,I),R),C),u.intersectRay(C,r,a),1)))}const R=l.create(),I=l.create(),C=u.create();function D(e,a,r,o,i,c){let m=0;if(s.cross(oe,e,a),s.subtract(ae,e,a),s.length(e)<=i||!o.aboveGround){s.cross(r,ae,o.eye);const d=s.dot(e,a)/(s.length(e)*s.length(a));if(d<.9999)m=n.acosClamped(d);else{const t=s.length(s.cross(l.create(),e,a))/(s.length(e)*s.length(a));m=n.asinClamped(t)}const u=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(c)),0,S));m=-m-Math.max(0,s.length(a)-i)/(u*i)}else s.subtract(w,o.eye,o.center),s.cross(r,ae,w),m=-s.length(ae)/i;return s.normalize(r,r),s.scale(r,r,s.length(oe)),m}const w=l.create();function E(e,a,r,o){let i,c;const s=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(o)),0,S));return i=a>r?-(a-r)/(s*r):a<-r?Math.PI-(a+r)/(s*r):n.acosClamped(a/r),c=e>r?-(e-r)/(s*r):e<-r?Math.PI-(e+r)/(s*r):n.acosClamped(e/r),(c-i)*r}function F(e,t,n,a,r,o,c,l,m,d){const u=E(e[2],t[2],o[3],l),p=m?E(e[0],t[0],o[3],180):t[0]-e[0],h=Math.sin(c)*p-Math.cos(c)*u,g=Math.cos(c)*p+Math.sin(c)*u;s.normalize(ne,r);const f=m?h/Math.sqrt(Math.abs(o[3]**2-s.dot(n,ne)**2)):h/o[3],y=g/Math.sqrt(Math.abs(o[3]**2-s.dot(n,a)**2));i.set(d,f,y)}function H(e,t,n,a,r,o,i,c,l,m){s.cross(oe,e,t),d.coordinateSystemFromOneAxisAndNormalVector(o.up,o.eye,Y,B,J),d.coordinateSystemFromOneAxisAndNormalVector([0,0,1],o.eye,Z,W,j),s.copy(n,W),s.copy(a,Z),s.normalize(n,n),s.scale(n,n,s.length(oe)),d.vectorCoordinates(e,s.normalize(B,B),s.normalize(J,J),s.normalize(Y,Y),K),d.vectorCoordinates(t,B,J,Y,L),F(K,L,e,Z,W,i,c,l,m,r)}function q(e,t,n,a,o,i,c){r.fromRotation($,o,a),r.fromRotation(_,c,i),r.multiply(ee,$,_),s.subtract(t,e,n),s.transformMat4(t,t,ee),s.add(t,t,n)}function O(e,t,n,a,o,i){r.fromRotation($,a,n),r.fromRotation(_,i,o),r.multiply(ee,$,_),s.subtract(ne,e.eye,t),s.transformMat4(ne,ne,ee),e.eye=s.add(ne,ne,t),s.subtract(ne,e.center,t),s.transformMat4(ne,ne,ee),e.center=s.add(ne,ne,t),s.subtract(ne,e.up,t),s.transformMat4(ne,ne,ee),e.up=s.add(ne,ne,t)}const k={Pole:.95,Angle:n.deg2rad(18),Tilt:45,TiltHysteresisMargin:1e-7};let G=!1;function U(e,t,n,a,r,o){const i=Math.abs(a)>Math.PI-k.Angle||Math.abs(a)<k.Angle,c=(Math.abs(e[2])<n*k.Pole||Math.abs(t)>n)&&o;return i&&c?!G&&r<k.Tilt-k.TiltHysteresisMargin?G=!0:G&&r>k.Tilt+k.TiltHysteresisMargin&&(G=!1):G=!1,G}function N(e,t,n,a,r,o){if(o)m.fromPoints(n,a,X),b(t,p.getCenter(e),X);else{const o=D(n,a,ie,t,e[3],r);b(t,p.getCenter(e),m.wrapAxisAngle(ie,o))}}function V(e,t,n,a,r,o,i){const c=i?20:1;let l,m;s.copy(te,a),re.copyFrom(t);for(let a=0;a<c&&s.squaredDistance(n,te)>1e-12&&(l=s.squaredDistance(n,te),H(n,te,W,Z,Q,re,e,r,o,i),O(re,p.getCenter(e),Z,Q[1],W,Q[0]),q(te,te,p.getCenter(e),Z,Q[1],W,Q[0]),m=s.squaredDistance(n,te),m<l||0===a);a++)t.copyFrom(re)}const Z=l.create(),W=l.create(),j=l.create(),Y=l.create(),B=l.create(),J=l.create(),K=l.create(),L=l.create(),Q=c.create(),X=m.create(),$=o.create(),_=o.create(),ee=o.create(),te=l.create(),ne=l.create(),ae=l.create();let re=new y;const oe=l.create(),ie=l.create(),ce={origin:l.create(),direction:l.create()},se={origin:l.create(),direction:l.create()};e.TiltThresholdPanningSpeed=S,e.VerticalPanTresholds=A,e.applyPanPlanar=function(e,t,n){s.subtract(z,n,t),e.eye=s.subtract(ne,e.eye,z),e.center=s.subtract(ne,e.center,z)},e.applyPanSphericalDirectRotation=N,e.applyPanSphericalPreserveHeading=V,e.applyRotation=b,e.applyRotationWithTwoAxes=O,e.applyZoomOnSphere=function(e,t,n){t.getScreenCenter(v),f.intersectScreen(e,t,v,ne)&&(t.center=ne);const a=t.distance,r=a*n;if(Math.abs(a-r)<1e-6)return;const o=s.scale(h.sv3d.get(),t.viewForward,r);t.eye=s.subtract(ne,t.center,o)},e.applyZoomToPoint=function(e,t,n,a){const r=h.sv3d.get();let o=1-n;s.subtract(r,t,e.eye);const i=s.length(r);let c=i*(1-o);o>=0&&c<a&&(c=a,o=-(c-i)/i),Math.abs(i-c)<1e-6||(s.scale(r,r,o),e.eye=s.add(ne,e.eye,r),e.center=s.lerp(ne,e.center,t,o))},e.centroid=function(e,t){s.set(t,0,0,0);for(const n of e)s.add(t,t,n);s.scale(t,t,1/e.length)},e.cleanupNavigationUtils=function(){re=new y},e.excludeTerrain=P,e.getTiltScaleFactor=function(e,t,n=1/0){const a=Math.abs(s.dot(e,t));return Math.min(n,1/a)},e.intersectPlaneFromScreenPoint=function(e,t,n,a){return u.intersectRay(e,g.fromScreen(t,n,ce),a)},e.intersectPlaneFromScreenPointAtEye=function(e,t,n,a){return u.intersectRay(e,g.fromScreenAtEye(t,n,ce),a)},e.lengthFromPoints=E,e.maxPanDistanceModifier=5,e.maxRotatePivotDistanceModifier=5,e.maxZoomPivotDistanceModifier=30,e.maxZoomStepDistanceModifier=8,e.minPinchAndPanCameraHeight=50,e.minRotatePivotDistance=10,e.navigationMode=function(e,t,n,a){const r=e.relativeElevation;if(r>A.Elevation&&"global"===a)return 1;g.fromScreenAtEye(e,t,se);const o=Math.sign(r),i=n.worldUpAtPosition(e.eye,ne);return-o*s.dot(i,se.direction)<Math.sin(A.Angle)*s.length(se.direction)?0:1},e.normalizeCoordinate=function(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n},e.normalizeRotationDelta=function(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e},e.offSurfaceTiltToEyeTiltGlobal=function(e,t,n,a){return x(Math.PI/2,t,n,a)+(e-Math.PI/2)},e.onSurfaceTiltToEyeTiltGlobal=x,e.panMotionToRotationMatrix=function(e,a,o,i,c,l,m,u,p){U(e.center,s.dot(e.up,e.center),s.length(e.center),-t.cyclicalPI.normalize(n.deg2rad(l)),m,a.aboveGround)?function(e,t,n,a,o,i){const{eye:c}=e;d.coordinateSystemFromOneAxisAndNormalVector([0,0,1],c,Z,W,j);const l=t.translation[0]*n.pan,m="zoom"===o.mode?0:t.translation[1]*n.pan,u=Math.max(Math.sqrt(Math.abs(1-s.dot(e.center,Z)**2/s.length(e.center)**2)),.5),p=(Math.sin(i)*m+Math.cos(i)*l)/u,h=-Math.cos(i)*m+Math.sin(i)*l;switch(r.rotate(a.pan.matrix,a.pan.matrix,p,Z),a.pan.enabled=!0,o.mode){case"pan":r.rotate(a.pan.matrix,a.pan.matrix,h,W),a.pan.enabled=!0;break;case"zoom":a.zoom=-t.translation[1]*n.zoom}}(a,o,i,u,p,-t.cyclicalPI.normalize(n.deg2rad(c))):function(e,t,n,a,o){const{eye:i,viewRight:c}=e,l=s.cross(h.sv3d.get(),c,i),m=t.translation[0]*n.pan;switch(0!==m&&(r.rotate(a.pan.matrix,a.pan.matrix,-m,l),a.pan.enabled=!0),o.mode){case"pan":{const e=t.translation[1]*n.pan;0!==e&&(r.rotate(a.pan.matrix,a.pan.matrix,e,c),a.pan.enabled=!0);break}case"zoom":a.zoom=-t.translation[1]*n.zoom}}(a,o,i,u,p)},e.panToPosition=function(e,a,r,o,i,c,l){U(r,s.dot(a.up,r),e[3],-t.cyclicalPI.normalize(n.deg2rad(i)),c,a.aboveGround)?V(e,a,r,o,-t.cyclicalPI.normalize(n.deg2rad(i)),c,l):N(e,a,r,o,c,l)},e.pickPointAndInitSphere=function(e,t,n,a,r,o){const i=l.create(),c=p.create();let m=!0,d=!0;return e.intersectScreen(n,i,o)?c[3]=s.length(i):(d=!1,t.aboveGround&&0!==r?c[3]=Math.max(s.length(t.center),.9*a):c[3]=s.length(t.eye)-t.relativeElevation,1===r?T(c,t,n,i):m=f.intersectScreen(c,t,n,i)),{sphere:c,scenePickPoint:m?i:null,hasGeometryIntersection:d}},e.pivotSearchAreaSize=80,e.preservingHeadingThresholds=k,e.rotatePivotSearchAreaSize=90,e.rotatePointAroundTwoAxes=q,e.rotationAngleAndAxisDirectRotation=D,e.rotationAnglesAndAxesHeadingPreserving=H,e.rotationAnglesHeadingPreserving=F,e.shouldPreserveHeading=U,e.sphereOrPlanePointFromScreenPoint=T,e.zoomPivotDistanceClamp=[1,3e8],e.zoomStepDistanceClamp=[200,1508e5],Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});