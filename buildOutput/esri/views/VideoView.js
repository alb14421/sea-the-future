// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","../chunks/tslib.es6","../Color","../Viewpoint","../core/Accessor","../core/Evented","../core/maybe","../core/Promise","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/subclass","../core/accessorSupport/ensureType","../geometry/Extent","../geometry/Point","../geometry/SpatialReference","../geometry/operators/projectOperator","../layers/support/ExtentAndRotationGeoreference","../layers/support/MediaElementView","../layers/support/TileInfo","../layers/support/VideoElement","./DOMContainer","./Viewport2DBaseMixin","./Viewport2DMixin","./2d/AnimationManager","./2d/MapViewConstraints","../core/Error","../core/scheduling","../core/Logger","../core/mathUtils","../config","../core/floatRGBA","../geometry/Geometry","../geometry/Multipoint","../geometry/Polygon","../geometry/Polyline","../symbols/Font","../core/ObjectPool","../geometry/support/spatialReferenceUtils","../symbols/cim/effects/EffectAddControlPoints","../symbols/cim/effects/EffectArrow","../symbols/cim/effects/EffectBuffer","../symbols/cim/effects/EffectControlMeasureLine","../symbols/cim/effects/EffectCut","../symbols/cim/effects/EffectDashes","../symbols/cim/effects/EffectDonut","../symbols/cim/effects/EffectEnclosingPolygon","../symbols/cim/effects/EffectJog","../symbols/cim/effects/EffectMove","../symbols/cim/effects/EffectOffset","../symbols/cim/effects/EffectRadial","../symbols/cim/effects/EffectReverse","../symbols/cim/effects/EffectRotate","../symbols/cim/effects/EffectScale","../symbols/cim/effects/EffectSuppress","../symbols/cim/effects/EffectTaperedPolygon","../symbols/cim/effects/EffectWave","../symbols/cim/placements/PlacementAlongLineSameSize","../symbols/cim/placements/PlacementAtExtremities","../symbols/cim/placements/PlacementAtRatioPositions","../symbols/cim/placements/PlacementInsidePolygon","../symbols/cim/placements/PlacementOnLine","../symbols/cim/placements/PlacementOnVertices","../symbols/cim/placements/PlacementPolygonCenter","../symbols/cim/constants","../core/libs/gl-matrix-2/factories/vec2f32","../symbols/support/defaults","../symbols/cim/OverrideHelper","./2d/engine/Container","../core/libs/gl-matrix-2/factories/vec4f32","./webgl/enums","./2d/engine/webgl/shaders/BackgroundPrograms","./webgl/Program","./webgl/checkWebGLError","./webgl/VertexAttributeLayouts","./webgl/BufferObject","./2d/engine/webgl/AFeatureTile","./2d/engine/webgl/DisplayEntity","./2d/engine/webgl/shaderGraph/techniques/featureTechniqueUtils","./2d/engine/webgl/cpuMapped/MappedMesh","./2d/engine/webgl/number","./2d/engine/webgl/shaders/TileInfoPrograms","./webgl/Texture","./2d/engine/webgl/shaders/BitBlitPrograms","../request","../core/urlUtils","../core/pbf","./2d/engine/webgl/shaders/StencilPrograms","./2d/engine/webgl/shaderGraph/techniques/shaders/BlendShader","./2d/engine/webgl/shaderGraph/techniques/shaders/OpacityShader","./2d/engine/webgl/shaders/HighlightPrograms","./webgl/FramebufferObject","./2d/engine/webgl/meshing/SimpleMesh","./webgl/Renderbuffer","./2d/engine/webgl/PooledUint32Array","./2d/engine/webgl/Profiler","./2d/engine/webgl/shaderGraph/techniques/TechniqueRegistry","./2d/engine/webgl/shaderGraph/techniques/animated/attributes","./2d/engine/webgl/mesh/templates/templateUtils","./2d/engine/webgl/shaderGraph/techniques/line/LineMeshWriter","./2d/engine/webgl/shaderGraph/techniques/dotDensity/DotDensityMeshWriter","./2d/engine/webgl/shaderGraph/techniques/fill/ComplexFillMeshWriter","./2d/engine/webgl/shaderGraph/techniques/fill/ComplexOutlineFillMeshWriter","./2d/engine/webgl/shaderGraph/techniques/fill/FillMeshWriter","./2d/engine/webgl/shaderGraph/techniques/fill/GradientFillMeshWriter","./2d/engine/webgl/shaderGraph/techniques/fill/OutlineFillMeshWriter","./2d/engine/webgl/shaderGraph/techniques/fill/PatternFillMeshWriter","./2d/engine/webgl/shaderGraph/techniques/fill/PatternOutlineFillMeshWriter","./2d/engine/webgl/shaderGraph/techniques/heatmap/HeatmapMeshWriter","../geometry/support/aaBoundingBox","./2d/engine/webgl/shaderGraph/techniques/text/TextMeshWriter","./2d/engine/webgl/shaderGraph/techniques/line/GradientStrokeMeshWriter","./2d/engine/webgl/shaderGraph/techniques/line/TexturedLineMeshWriter","./2d/engine/webgl/shaderGraph/techniques/markers/MarkerMeshWriter","../core/sql/UnknownTimeZone","../intl/locale","../layers/support/fieldUtils","../time/constants","./2d/engine/webgl/animations/instructions","./2d/engine/webgl/shaderGraph/techniques/pieChart/PieChartMeshWriter","./webgl/renderState","./3d/webgl-engine/core/shaderModules/glsl","./webgl/testSVGPremultipliedAlpha","./2d/engine/ManagedCanvas","./2d/engine/transitions/FadeTransition","./2d/engine/webgl/meshing/definitions","./2d/engine/webgl/shaderGraph/techniques/shaders/VideoScreenShader","./2d/LabelManager","./2d/layers/graphics/GraphicsView2D","../chunks/earcut","../core/libs/gl-matrix-2/factories/vec3f32","../geometry/support/normalizeUtilsCommon","../geometry/support/Ellipsoid","../kernel","./2d/layers/support/util","./2d/navigation/MapViewNavigation","../core/asyncUtils","../core/support/UpdatingHandles","./2d/engine/webgl/shaderGraph/techniques/shaders/MagnifierShader","../core/unitUtils","../geometry/ellipsoidUtils","../chunks/pe","../geometry/projection/projectors","./2d/engine/webgl/shaderGraph/techniques/shaders/GridShader","../geometry/support/geodesicConstants","./2d/ViewStateManager","./2d/engine/webgl/Overlay","./2d/engine/webgl/OverlayContainer","./navigation/Navigation","./ui/DefaultUI","./ui/video/DefaultUIVideo"],function(e,t,i,s,a,n,r,o,l,c,h,d,p,g,m,y,f,u,w,b,_,v,M,S,V,C,x,P,E,D,G,R,O,q,z,A,T,W,k,U,I,B,F,H,L,j,Z,N,J,K,Q,X,Y,$,ee,te,ie,se,ae,ne,re,oe,le,ce,he,de,pe,ge,me,ye,fe,ue,we,be,_e,ve,Me,Se,Ve,Ce,xe,Pe,Ee,De,Ge,Re,Oe,qe,ze,Ae,Te,We,ke,Ue,Ie,Be,Fe,He,Le,je,Ze,Ne,Je,Ke,Qe,Xe,Ye,$e,et,tt,it,st,at,nt,rt,ot,lt,ct,ht,dt,pt,gt,mt,yt,ft,ut,wt,bt,_t,vt,Mt,St,Vt,Ct,xt,Pt,Et,Dt,Gt,Rt,Ot,qt,zt,At,Tt,Wt,kt,Ut,It,Bt,Ft,Ht,Lt){"use strict";const jt=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),Zt=new i("#000");let Nt;const Jt=.01,Kt=["feature","geojson","csv","stream","ogc-feature","catalog","wfs","parquet","graphics","group"];let Qt=class extends a{};Qt=t.__decorate([g.subclass("esri.views.VideoView.Base")],Qt);let Xt=class extends(C.Viewport2DMixin(V.Viewport2DBaseMixin(S.DOMContainer(n.EventedMixin(o.EsriPromiseMixin(Qt)))))){constructor(e){super(e),this._isValid=!1,this._prevZoomEnabled=!1,this._prevRotationEnabled=!1,this.stage=null,this.childStage=null,this._operationalDataView=null,this.operationalDataVisible=!1,this.layer=null,this.map=null,this.navigation=new Ft,this.ready=!1,this.spatialReference=new u({wkid:0}),this.stateManager=new Ut.ViewStateManager({constraints:new P({view:this,minScale:1,maxScale:Jt})}),this.type="2d",this.ui=new Lt,this.view2dType="video",this.addHandles([l.watch(()=>this.preconditionsReady,e=>e?this._startup():this._teardown()),l.watch(()=>this.layer,()=>this.addResolvingPromise(l.whenOnce(()=>this.ready)),l.initial),l.watch(()=>this.videoSize,([e,t])=>{this._extent&&e&&t&&(this._extent.xmax=e,this._extent.ymax=t)}),l.watch(()=>this.size,e=>{this._operationalDataView&&this._operationalDataView.stateManager.resize(e[0],e[1])}),l.watch(()=>[this.layer?.frameEffect,this._effectsContainer],()=>{this._effectsContainer&&(this._effectsContainer.effect=this.layer?.frameEffect??null)},l.syncAndInitial)])}initialize(){this._prevZoomEnabled="zoom"===this.navigation.actionMap.mouseWheel&&this.ui.components.includes("zoom"),this._prevRotationEnabled="rotate"===this.navigation.actionMap.dragSecondary&&this.ui.components.includes("compass"),this.addHandles([l.watch(()=>[this.operationalDataVisible,this.childStage],()=>{this.childStage&&(this.childStage.videoScreenRenderer.visible=this.operationalDataVisible),this.operationalDataVisible&&(this.scale=1,this.rotation=0),this.navigation&&(this._prevZoomEnabled&&(this.navigation.actionMap.mouseWheel=this.operationalDataVisible?"none":"zoom",this.navigation.actionMap.dragPrimary=this.operationalDataVisible?"none":"pan",this.ui.components&&(this.ui.components=this.operationalDataVisible?this.ui.components.filter(e=>"zoom"!==e):[...new Set([...this.ui.components,"zoom"])])),this._prevRotationEnabled&&(this.navigation.actionMap.dragSecondary=this.operationalDataVisible?"none":"rotate",this.ui.components&&(this.ui.components=this.operationalDataVisible?this.ui.components.filter(e=>"compass"!==e):[...new Set([...this.ui.components,"compass"])])))},l.syncAndInitial)]),this.addResolvingPromise(async function(){const[,{ParentStage:t}]=await Promise.all([new Promise((t,i)=>e(["./2d/webglDeps"],t,i)),new Promise((t,i)=>e(["./2d/mapViewDeps"],t,i))]);Nt=t}().then(()=>(this._isValid=!0,l.whenOnce(()=>this.ready))))}destroy(){this._teardown(),this.removeAllHandles(),this._set("preconditionsReady",!1),this.frameTask=r.destroyMaybe(this.frameTask),this.goToManager.destroy(),this.inputManager.destroy(),this._set("inputManager",null)}get constraintsInfo(){return{lods:null,spatialReference:this.spatialReference}}get preconditionsReady(){return!(!this._isValid||0===this.width||0===this.height||0===this.videoSize[0]||0===this.videoSize[1])}get rendering(){return this.stage?.renderRequested??!1}get scale(){return this.stateManager?.scale??0}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get videoSize(){if(!this.layer?.videoWidth||!this.layer?.videoHeight)return[0,0];const[e,t]=this.size,i=(this.layer?.videoWidth||0)/(this.layer?.videoHeight||0),s=t*i,a=e/i;return e/t>=1?i>=1?s<=e?[s,t]:[e,a]:a<=t?[e,a]:[s,t]:i>=1?a<=t?[e,a]:[s,t]:s<=e?[s,t]:[e,a]}async hitTest(e,t){return this._operationalDataView&&this._operationalDataView.ready?this._operationalDataView.hitTest(e,t):{screenPoint:e,results:[]}}_startup(){if(!this.layer)return;const e=this._getViewpoint();this.stateManager.startup(e,this.size,e.targetGeometry.spatialReference);const t={renderingOptions:this.renderingOptions,backgroundColor:Zt,groundControlPoints:()=>this.layer?.groundControlPoints,getSize:()=>this.videoSize},i=new Nt(this.surface,t,new ut.ManagedCanvas(this.surface));this.stage=i,this._prepareStage(this.stage),this.childStage=i.childStage,this._prepareChildStage(this.childStage);const s=new x({view:this});this._set("animationManager",s);const a=new Dt({view:this,animationManager:s});this._set("mapViewNavigation",a),this._updateConstraints(),this.frameTask.start(),this._set("ready",!0)}_teardown(){this.stage.destroy(),this.stage=null,this._videoElementView=null,this._overlayContainer.removeAllChildren(),this._overlayContainer=null,this.removeHandles("video-view"),this._set("ready",!1),this.stateManager.teardown(),this.frameTask.stop(),this.stationaryManager.clear()}_getViewpoint(){return new s({targetGeometry:new f({x:this.videoSize[0]/2,y:this.videoSize[1]/2,spatialReference:this.spatialReference}),scale:1})}_prepareStage(e){this.addHandles([l.watch(()=>this.stationary,t=>e.stationary=t,l.syncAndInitial),l.watch(()=>this.state.id,()=>e.state=this.state,l.syncAndInitial),l.watch(()=>this.renderingOptions,t=>e.renderingOptions=t,l.syncAndInitial)],"video-view"),this._extent=new y({xmin:0,ymin:0,xmax:this.videoSize[0],ymax:this.videoSize[1],spatialReference:{wkid:0}}),this._videoElementView=new _.MediaElementView({element:new M({video:this.layer?.videoElement,georeference:new b({extent:this._extent}),autoplay:!1}),spatialReference:this.spatialReference});const t=new It(this._videoElementView);this._overlayContainer=new Bt,this._overlayContainer.addChild(t),this._effectsContainer=new fe.Container,this._effectsContainer.addChild(this._overlayContainer),this.stage.addChild(this._effectsContainer);const i=document.createElement("div");i.classList.add("esri-video-poster"),this.container?.classList.add("esri-video-view"),this.container?.appendChild(i)}_prepareChildStage(t){this.addHandles([l.watch(()=>this.map,async i=>{if(!i)return;const{default:s}=await new Promise((t,i)=>e(["./video/VideoOperationalDataView"],e=>t(jt(e)),i));this._operationalDataView=new s({stage:t,layerViewFilter:e=>new Set(Kt).has(e.type),width:this.size[0],height:this.size[1],map:i}),l.whenOnce(()=>this._operationalDataView?.ready).then(()=>{t.videoScreenRenderer.visible=this.operationalDataVisible})},l.syncAndInitial),l.watch(()=>this.layer?.groundControlPoints,async()=>{if(!this.layer?.groundControlPoints||!t.state)return;const e=this.layer.groundControlPoints,i=e?.length;if(!i)return;await w.load();const s=new Array(i),a=t.state.spatialReference;for(let t=0;t<i;t++){const{lat:i,lon:n}=e[t];s[t]=w.execute(new f(n,i),a)}let n=1/0,r=1/0,o=-1/0,l=-1/0;for(const e of s)n=Math.min(n,e.x),r=Math.min(r,e.y),o=Math.max(o,e.x),l=Math.max(l,e.y);const c=y.fromJSON({xmin:n,ymin:r,xmax:o,ymax:l,spatialReference:a});await(this._operationalDataView?.goTo(c,{animate:!1}).catch(()=>{}))},l.syncAndInitial)])}_updateConstraints(){this._updateZoomConstraints(),this._updatePanConstraints()}_updateZoomConstraints(){const e=this.videoSize,t=Math.max(e[0]/this.size[0],e[1]/this.size[1]),i=[];for(let e=t;e>Jt;e/=2)i.push(e);i.push(Jt);const{lods:s}=v.create({scales:i});this.constraints.set({lods:s,minScale:t})}_updatePanConstraints(){const e=e=>{if(!e.targetGeometry)return e;const[t,i]=this.videoSize,s=t*e.scale/2,a=i*e.scale/2,n=e.targetGeometry.clone();return n.x=Math.max(s,Math.min(t-s,n.x)),n.y=Math.max(a,Math.min(i-a,n.y)),e.targetGeometry=n,e};this.constraints.customConstraints.add({constrain:e,applyPanConstraint:e})}};return t.__decorate([c.property()],Xt.prototype,"_overlayContainer",void 0),t.__decorate([c.property()],Xt.prototype,"_isValid",void 0),t.__decorate([c.property()],Xt.prototype,"_effectsContainer",void 0),t.__decorate([c.property()],Xt.prototype,"constraintsInfo",null),t.__decorate([c.property()],Xt.prototype,"operationalDataVisible",void 0),t.__decorate([c.property()],Xt.prototype,"layer",void 0),t.__decorate([c.property()],Xt.prototype,"map",void 0),t.__decorate([c.property({type:Ft,nonNullable:!0})],Xt.prototype,"navigation",void 0),t.__decorate([c.property({readOnly:!0})],Xt.prototype,"preconditionsReady",null),t.__decorate([c.property({readOnly:!0})],Xt.prototype,"ready",void 0),t.__decorate([c.property({readOnly:!0})],Xt.prototype,"rendering",null),t.__decorate([c.property()],Xt.prototype,"scale",null),t.__decorate([c.property()],Xt.prototype,"spatialReference",void 0),t.__decorate([c.property()],Xt.prototype,"stateManager",void 0),t.__decorate([c.property()],Xt.prototype,"type",void 0),t.__decorate([c.property(),h.cast(e=>e instanceof Ht?e:m.ensureClass(Lt,e))],Xt.prototype,"ui",void 0),t.__decorate([c.property({readOnly:!0})],Xt.prototype,"videoSize",null),t.__decorate([c.property({readOnly:!0})],Xt.prototype,"view2dType",void 0),Xt=t.__decorate([g.subclass("esri.views.VideoView")],Xt),Xt});