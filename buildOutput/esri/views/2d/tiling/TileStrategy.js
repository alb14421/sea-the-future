// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../geometry/support/aaBoundingRect","./TileCache","./TileCoverage","./TileKey"],function(e,i,t,s){"use strict";const l=new s(0,0,0,0),a=new Map,o=[],h=[];return class{constructor(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,null!=e.resampling&&(this.resampling=e.resampling),e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),null!=e.buffer&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new i(e.cacheSize,this.tileInfoView,e=>{this.releaseTile(e)}))}destroy(){this.tileIndex.clear()}update(e){const{resampling:i,tileIndex:s}=this,{scale:c,center:n,resolution:r}=e.state,{minScale:f,maxScale:d}=this.tileInfoView,u=!e.stationary&&c>this._previousScale;if(this._previousScale=c,!i&&(c>f||c<d))return this.tiles.length=0,void this.clear();const y=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.resampling,this.coveragePolicy);if(!y)return this.tiles.length=0,void this.clear();const{spans:g,lodInfo:p}=y,{level:I}=p;this.tiles.length=0,s.forEach(e=>e.visible=!0);let v=0,T=0;if(g.length>0)for(const{row:e,colFrom:i,colTo:t}of g)for(let o=i;o<=t;o++){v++;const i=l.set(I,e,p.normalizeCol(o),p.getWorldForColumn(o)).id;let t=s.get(i);if(t)t.isReady?(a.set(i,t),T++):u||this._addParentTile(i,a);else{if(this._tileCache?.has(i)){if(t=this._tileCache.pop(i),this.tileIndex.set(i,t),t.isReady){a.set(i,t),T++;continue}}else t=this.acquireTile(l),this.tileIndex.set(i,t);u||this._addParentTile(i,a)}}const _=T===v;for(const[e,i]of s){if(a.has(e))continue;l.set(e);const t=this.tileInfoView.intersects(y,l),s="purge"===this.cachePolicy?l.level!==I:l.level>I;!t||!u&&_?!s&&t||o.push(i):i.isReady?s&&"purge"===this.cachePolicy&&this._hasReadyAncestor(l,I)?o.push(i):h.push(i):s&&o.push(i)}for(const e of h)e.isReady&&a.set(e.key.id,e);for(const e of o)this._tileCache?this._tileCache.add(e):this.releaseTile(e),s.delete(e.key.id);for(const e of a.values())this.tiles.push(e);for(const e of s.values())a.has(e.key.id)||(e.visible=!1);this._tileCache?.prune(I,n,r),t.pool.release(y),h.length=0,o.length=0,a.clear()}clear(){const{tileIndex:e}=this;for(const i of e.values())this.releaseTile(i);e.clear()}refresh(e){for(const i of this.tileIndex.values())e(i);this._tileCache?.clear()}updateCacheSize(e){this._tileCache&&(this._tileCache.maxSize=e)}_addParentTile(e,i){let t=e,s=null;for(;t=this.tileInfoView.getTileParentId(t),t;)if(this.tileIndex.has(t)){if(s=this.tileIndex.get(t),s?.isReady){i.has(s.key.id)||i.set(s.key.id,s);break}}else if(this._tileCache?.has(t)&&(s=this._tileCache.pop(t),this.tileIndex.set(t,s),s?.isReady)){i.has(s.key.id)||i.set(s.key.id,s);break}}_hasReadyAncestor(i,t){const s=e.create();this.tileInfoView.getTileBounds(s,i,!0);for(const l of this.tileIndex.values())if(l.isReady&&l.key.level>=t&&l.key.level<i.level){const i=e.create();if(this.tileInfoView.getTileBounds(i,l.key,!0),e.contains(i,s))return!0}return!1}}});