// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../engine/BitmapContainer","./LayerView2D","./support/ExportStrategy","../../layers/LayerView","../../layers/RefreshableLayerView","../../layers/WMSLayerView"],function(e,t,r,i,a,s,n,o,h,c,p,d,u,y,m,g){"use strict";let l=class extends(g.WMSLayerView(m.RefreshableLayerView(d.LayerView2DMixin(y)))){constructor(){super(...arguments),this.bitmapContainer=new p.BitmapContainer}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}update(e){this.strategy.update(e).catch(e=>{i.isAbortError(e)||t.getLogger(this).error(e)})}attach(){const{layer:e}=this,{imageMaxHeight:t,imageMaxWidth:r}=e;this.bitmapContainer=new p.BitmapContainer,this.container.addChild(this.bitmapContainer),this.strategy=new u({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:t,imageMaxWidth:r,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.addAttachHandles(a.watch(()=>this.exportImageVersion,()=>this.requestUpdate()))}detach(){this.strategy=r.destroyMaybe(this.strategy),this.container.removeAllChildren()}viewChange(){}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQuery(e){const{view:t,bitmapContainer:r}=this,{x:i,y:a}=e,{spatialReference:s}=t;let n,o=0,h=0;if(r.children.some(e=>{const{width:t,height:r,resolution:p,x:d,y:u}=e,y=d+p*t,m=u-p*r;return i>=d&&i<=y&&a<=u&&a>=m&&(n=new c({xmin:d,ymin:m,xmax:y,ymax:u,spatialReference:s}),o=t,h=r,!0)}),!n)return null;const p=n.width/o,d=Math.round((i-n.xmin)/p),u=Math.round((n.ymax-a)/p);return{extent:n,width:o,height:h,x:d,y:u}}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,r,i){return this.layer.fetchImageBitmap(e,t,r,{timeExtent:this.timeExtent,...i})}};return e.__decorate([s.property()],l.prototype,"strategy",void 0),l=e.__decorate([h.subclass("esri.views.2d.layers.WMSLayerView2D")],l),l});