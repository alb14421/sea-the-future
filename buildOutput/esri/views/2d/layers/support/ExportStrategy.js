// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/support/TileInfo","../../viewStateUtils","../../engine/Bitmap","../../tiling/TileInfoView","../../tiling/TileKey"],function(e,t,o,i,r,a,s,n,p,d,c,l,h,u,m,f){"use strict";const g=d.create(),y=[0,0],_=new f(0,0,0,0);return e.default=class extends o{constructor(e){super(e),this._imagePromise=null,this.bitmaps=[],this.hidpi=!1,this.imageMaxWidth=2048,this.imageMaxHeight=2048,this.imageRotationSupported=!1,this.imageNormalizationSupported=!1,this.update=r.debounce(async(e,t)=>{if(r.throwIfAborted(t),!e.stationary||this.destroyed)return;const o=e.state,i=c.getInfo(o.spatialReference),a=this.hidpi?e.pixelRatio:1,s=o.worldScreenWidth>0,n=s&&this.imageNormalizationSupported&&o.worldScreenWidth<o.size[0],p=Math.round((this.imageMaxWidth??0)/a),d=Math.round((this.imageMaxHeight??0)/a);n?(y[0]=o.worldScreenWidth,y[1]=o.size[1]):this.imageRotationSupported?(y[0]=o.size[0],y[1]=o.size[1]):h.getOuterSize(y,o);const l=Math.floor(y[0])>p||Math.floor(y[1])>d,u=i&&(o.extent.xmin<i.valid[0]||o.extent.xmax>i.valid[1]),m=!this.imageNormalizationSupported&&u,f=!l&&!m,g=this.imageRotationSupported?o.rotation:0,_=this.container.children.slice();if(f){const e=n?o.paddedViewState.center:o.center;this._imagePromise=this._singleExport(o,y,e,o.resolution,g,a,t)}else{let e=Math.min(p,d);s&&(e=Math.min(o.worldScreenWidth,e),e=Math.round(o.worldScreenWidth/Math.ceil(o.worldScreenWidth/e))),this._imagePromise=this._tiledExport(o,e,a,t)}try{const e=await this._imagePromise??[];r.throwIfAborted(t);const o=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=e;for(const t of _)e.includes(t)||o.push(t.fadeOut().then(()=>{t.remove(),t.destroy()}));for(const t of e)o.push(t.fadeIn());await Promise.all(o)}catch(e){this._imagePromise=null,r.throwIfAbortError(e)}},5e3),this.updateExports=r.debounce(async e=>{const t=[];for(const o of this.container.children){if(!o.visible||!o.stage)return;t.push(e(o).then(()=>{o.invalidateTexture(),o.requestRender()}))}this._imagePromise=r.eachAlways(t).then(()=>this._imagePromise=null),await this._imagePromise})}destroy(){this.bitmaps.forEach(e=>e.destroy()),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(e,t,o,i,a,s){const n=await this.fetchSource(e,Math.floor(t*a),Math.floor(o*a),{rotation:i,pixelRatio:a,signal:s});r.throwIfAborted(s);const p=new u.Bitmap(null,!0);return p.x=e.xmin,p.y=e.ymax,p.resolution=e.width/t,p.rotation=i,p.pixelRatio=a,p.opacity=0,this.container.addChild(p),await p.setSourceAsync(n,s),r.throwIfAborted(s),p}async _singleExport(e,t,o,i,r,a,s){h.getBBox(g,o,i,t);const n=d.toExtent(g,e.spatialReference);return[await this._export(n,t[0],t[1],r,a,s)]}_tiledExport(e,t,o,i){const r=l.create({size:t,spatialReference:e.spatialReference,scales:[e.scale]}),a=new m(r),s=a.getTileCoverage(e);if(!s)return null;const n=[];return s.forEach((r,s,p,c)=>{_.set(r,s,p,0),a.getTileBounds(g,_);const l=d.toExtent(g,e.spatialReference);n.push(this._export(l,t,t,0,o,i).then(e=>(0!==c&&(_.set(r,s,p,c),a.getTileBounds(g,_),e.x=g[0],e.y=g[3]),e)))}),Promise.all(n)}},t.__decorate([a.property()],e.default.prototype,"_imagePromise",void 0),t.__decorate([a.property()],e.default.prototype,"bitmaps",void 0),t.__decorate([a.property()],e.default.prototype,"container",void 0),t.__decorate([a.property()],e.default.prototype,"fetchSource",void 0),t.__decorate([a.property()],e.default.prototype,"hidpi",void 0),t.__decorate([a.property()],e.default.prototype,"imageMaxWidth",void 0),t.__decorate([a.property()],e.default.prototype,"imageMaxHeight",void 0),t.__decorate([a.property()],e.default.prototype,"imageRotationSupported",void 0),t.__decorate([a.property()],e.default.prototype,"imageNormalizationSupported",void 0),t.__decorate([a.property()],e.default.prototype,"requestUpdate",void 0),t.__decorate([a.property()],e.default.prototype,"updating",null),e.default=t.__decorate([p.subclass("esri.views.2d.layers.support.ExportStrategy")],e.default),e.default});