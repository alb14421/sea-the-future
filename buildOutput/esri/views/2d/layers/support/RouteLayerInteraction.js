// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/handleUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/UpdatingHandles","../../../../layers/GraphicsLayer","../../../../rest/support/PointBarrier","../../../../rest/support/PolygonBarrier","../../../../rest/support/PolylineBarrier","../../../../rest/support/Stop","../../../../widgets/Sketch/SketchViewModel"],function(e,r,t,a,o,i,s,l,n,c,p,y,h,d,u,g,b,_){"use strict";function m(e,r){e.networkFeature=r}function w(e){return e.networkFeature}function k(e){return"point"===e?.type||"polyline"===e?.type||"polygon"===e?.type}e.RouteLayerInteraction=class extends t{constructor(e){super(e),this._createMode=null,this._graphicsLayer=new h({internal:!0,listMode:"hide",title:"RouteLayerInteraction layer"}),this._updatingHandles=new y.UpdatingHandles,this.enabled=!0,this._handleSketchViewModelEvents=async e=>{switch(e.type){case"update":switch(e.state){case"active":case"complete":for(const r of e.graphics)w(r).geometry=k(r.geometry)?r.geometry.clone():null}break;case"undo":case"redo":break;case"delete":for(const r of e.graphics){const e=w(r);this._removeNetworkFeature(e)}break;case"create":if(e.graphic&&"complete"===e.state&&this._createMode){const r=e.graphic.geometry?.clone(),t=e.graphic.symbol?.clone();if(!r)break;switch(this._createMode){case"stop":{if("point"!==r.type)break;const{stops:t}=this.layer;if(t.length>0&&t.every(({geometry:e})=>!e)){t.at(0).geometry=r;break}if(t.length>1&&t.filter((e,r)=>0!==r).every(({geometry:e})=>!e)){t.at(1).geometry=r;break}const a=new b({geometry:r});t.add(a),m(e.graphic,a);break}case"point-barrier":{if("point"!==r.type)break;const a=new d({geometry:r,symbol:t});this.layer.pointBarriers.add(a),m(e.graphic,a);break}case"polyline-barrier":{if("polyline"!==r.type)break;const a=new g({geometry:r,symbol:t});this.layer.polylineBarriers.add(a),m(e.graphic,a);break}case"polygon-barrier":{if("polygon"!==r.type)break;const a=new u({geometry:r,symbol:t});this.layer.polygonBarriers.add(a),m(e.graphic,a);break}}}}(await this.view.whenLayerView(this.layer)).emit(e.type,"create"===e.type?function(e){const r=w(e.graphic);return{...e,networkFeature:r}}(e):function(e){const r=e.graphics.map(e=>w(e));return{...e,networkFeatures:r}}(e))}}initialize(){this._sketchViewModel=new _({layer:this._graphicsLayer,view:this.view}),this.addHandles([i.watch(()=>this.enabled,e=>{e?this._activate():this._deactivate()},i.initial),i.watch(()=>{const{stops:e,pointBarriers:r,polylineBarriers:t,polygonBarriers:a}=this.layer;return{stops:e,pointBarriers:r,polylineBarriers:t,polygonBarriers:a}},()=>{this.enabled&&this._loadClonedGraphics()}),this._sketchViewModel.on(["create","delete","redo","undo","update"],this._handleSketchViewModelEvents),a.destroyHandle(this._updatingHandles)])}destroy(){this.view.map.remove(this._graphicsLayer),this._graphicsLayer.removeAll(),this._graphicsLayer=o.destroyMaybe(this._graphicsLayer),this._sketchViewModel=o.destroyMaybe(this._sketchViewModel)}get selectedNetworkFeatures(){return this._sketchViewModel.updateGraphics.map(e=>w(e))}get updating(){return this._updatingHandles.updating}create(e){switch(this._createMode=e,e){case"stop":this.layer.defaultSymbols.stops?.unlocated&&(this._sketchViewModel.pointSymbol=this.layer.defaultSymbols.stops.unlocated.clone());break;case"point-barrier":this.layer.defaultSymbols.pointBarriers&&(this._sketchViewModel.pointSymbol=this.layer.defaultSymbols.pointBarriers.clone());break;case"polyline-barrier":this.layer.defaultSymbols.polylineBarriers&&(this._sketchViewModel.polylineSymbol=this.layer.defaultSymbols.polylineBarriers.clone());break;case"polygon-barrier":this.layer.defaultSymbols.polygonBarriers&&(this._sketchViewModel.polygonSymbol=this.layer.defaultSymbols.polygonBarriers.clone())}switch(e){case"stop":case"point-barrier":return this._sketchViewModel.create("point");case"polyline-barrier":return this._sketchViewModel.create("polyline");case"polygon-barrier":return this._sketchViewModel.create("polygon")}}remove(e){const r=this._graphicsLayer.graphics.find(r=>w(r)===e);r&&this._graphicsLayer.remove(r),this._removeNetworkFeature(e)}_activate(){this._loadClonedGraphics(),this.view.map.add(this._graphicsLayer)}_deactivate(){this._sketchViewModel.cancel(),this.view.map?.remove(this._graphicsLayer),this._graphicsLayer.removeAll()}_loadClonedGraphics(){const e=[this.layer.stops,this.layer.pointBarriers,this.layer.polylineBarriers,this.layer.polygonBarriers].flatMap(e=>e.toArray().map(e=>{const r=e.toGraphic();return r.networkFeature=e,r}));this._graphicsLayer.removeAll().addMany(e)}_removeNetworkFeature(e){switch(e.type){case"stop":this.layer.stops.remove(e);break;case"point-barrier":this.layer.pointBarriers.remove(e);break;case"polyline-barrier":this.layer.polylineBarriers.remove(e);break;case"polygon-barrier":this.layer.polygonBarriers.remove(e)}}},r.__decorate([s.property()],e.RouteLayerInteraction.prototype,"enabled",void 0),r.__decorate([s.property({constructOnly:!0})],e.RouteLayerInteraction.prototype,"layer",void 0),r.__decorate([s.property({readOnly:!0})],e.RouteLayerInteraction.prototype,"selectedNetworkFeatures",null),r.__decorate([s.property()],e.RouteLayerInteraction.prototype,"updating",null),r.__decorate([s.property({constructOnly:!0})],e.RouteLayerInteraction.prototype,"view",void 0),e.RouteLayerInteraction=r.__decorate([p.subclass("esri.views.2d.layers.support.RouteLayerInteraction")],e.RouteLayerInteraction),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});