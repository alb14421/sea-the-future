// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
require({cache:{"esri/views/2d/engine/flow/FlowView2D":function(){define(["exports","../../../../chunks/tslib.es6","../../../../Graphic","../../../../core/Accessor","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./createFlowStyle","./dataUtils","./FlowContainer","./FlowStrategy"],function(e,t,i,r,s,n,o,a,l,c,h,u,p,d){"use strict";return e.default=class extends r{constructor(){super(...arguments),this._loadImagery=(e,t,i,r,s)=>u.loadImagery(this.layer,e,t,i,r,s),this._createFlowMesh=(e,t,i,r)=>this.layer.createFlowMesh({meshType:e,flowData:i,simulationSettings:t},{signal:r}),this.attached=!1,this.type="flow",this.timeExtent=null,this.redrawOrRefetch=async()=>{this._updateVisualization()}}get updating(){return!this.attached||this._strategy.updating}attach(){const{layer:e}=this,t=()=>{this._loadImagery=(t,i,r,s,n)=>u.loadImagery(e,t,i,r,s,n),this._updateVisualization()};"multidimensionalDefinition"in e?this.addHandles(s.watch(()=>e.multidimensionalDefinition,t)):this.addHandles([s.watch(()=>e.mosaicRule,t),s.watch(()=>e.rasterFunction,t),s.watch(()=>e.definitionExpression,t)]),this.container=new p,this._strategy=new d({flowContainer:this.container}),this._updateVisualization()}detach(){this._strategy.destroy(),this.container?.removeAllChildren(),this.container=null,this.removeHandles()}update(e){e.stationary?this._strategy.update(e):this.layerView.requestUpdate()}hitTest(e){return new i({attributes:{},geometry:e.clone(),layer:this.layer})}moveEnd(){}async doRefresh(){}_updateVisualization(){const e=this.layer.renderer;if(null==e||"flow"!==e.type)return;const t=h(e,{loadImagery:this._loadImagery,createFlowMesh:this._createFlowMesh,timeExtent:this.timeExtent});this.container.flowStyle=t,this.layerView.requestUpdate()}},t.__decorate([n.property()],e.default.prototype,"_strategy",void 0),t.__decorate([n.property()],e.default.prototype,"attached",void 0),t.__decorate([n.property()],e.default.prototype,"container",void 0),t.__decorate([n.property()],e.default.prototype,"layer",void 0),t.__decorate([n.property()],e.default.prototype,"layerView",void 0),t.__decorate([n.property()],e.default.prototype,"type",void 0),t.__decorate([n.property()],e.default.prototype,"updating",null),t.__decorate([n.property()],e.default.prototype,"timeExtent",void 0),e.default=t.__decorate([c.subclass("esri.views.2d.engine.flow.FlowView2D")],e.default),e.default})},"esri/views/2d/engine/flow/createFlowStyle":function(){define(["./utils","./styles/Imagery","./styles/Particles","./styles/Stack","./styles/Streamlines"],function(e,t,i,r,s){"use strict";return function(n,o){const{flowSpeed:a,trailLength:l}=n,c=e.getFlowSimulationSettings(n);let h=null;const u={opacity:e.getOpacity(n),size:e.getSize(n)};let p=e.getColor(n);if("none"===n.background)u.color=p;else{"constant"===p.kind&&(p={kind:"ramp",stops:[0,1],values:[0,0,0,1,p.value[0],p.value[1],p.value[2],p.value[3]],count:2});const i={loadImagery:o.loadImagery,timeExtent:o.timeExtent,color:p,opacity:{kind:"constant",value:[1]}};h=new t.Imagery(i),u.color=e.getForegroundColor()}const d={loadImagery:o.loadImagery,createFlowMesh:o.createFlowMesh,simulationSettings:c,timeExtent:o.timeExtent,trailLength:l,flowSpeed:a,featheringSize:1,featheringOffset:.5,introFade:!0,fadeToZero:!0,decayRate:2.3,color:u.color,opacity:u.opacity,size:u.size},f="butt"===n.trailCap||e.getMax(e.getSize(n))<=4?new s(d):new i.Particles(d);return null!=h?new r.Stack([h,f]):f}})},"esri/views/2d/engine/flow/utils":function(){define(["exports","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f32"],function(e,t,i,r){"use strict";function s(e){return"constant"===e.kind?e.value[0]:e.values[e.values.length-1]}function n(e){const t=e.toRgba();return[t[0]/255,t[1]/255,t[2]/255,t[3]]}function o(e){if(!e.hasVisualVariables("size"))return{kind:"constant",value:[t.pt2px(e.trailWidth)]};const i=e.getVisualVariablesForType("size")[0],r=[],s=[];let n;if(i.stops){for(const e of i.stops)r.push(e.value),s.push(t.pt2px(e.size));n=i.stops.length}else r.push(i.minDataValue,i.maxDataValue),s.push(t.pt2px(i.minSize),t.pt2px(i.maxSize)),n=2;return{kind:"ramp",stops:r,values:s,count:n}}function a(e,t,i,r){switch(t){case"int":e.setUniform1iv(i,r);break;case"float":e.setUniform1fv(i,r);break;case"vec2":e.setUniform2fv(i,r);break;case"vec3":e.setUniform3fv(i,r);break;case"vec4":e.setUniform4fv(i,r)}}function l(e,t){let i=!0;return i=i&&e.collisions===t.collisions,i=i&&e.density===t.density,i=i&&e.interpolate===t.interpolate,i=i&&e.lineCollisionWidth===t.lineCollisionWidth,i=i&&e.lineSpacing===t.lineSpacing,i=i&&e.maxTurnAngle===t.maxTurnAngle,i=i&&e.minSpeedThreshold===t.minSpeedThreshold,i=i&&e.segmentLength===t.segmentLength,i=i&&e.smoothing===t.smoothing,i=i&&e.velocityScale===t.velocityScale,i=i&&e.verticesPerLine===t.verticesPerLine,i}function c(e,t){return e===t||null!=e&&null!=t&&e.equals(t)}e.areStreamlinesCompatible=function(e,t){if(!l(e.simulationSettings,t.simulationSettings))return!1;if(!c(e.timeExtent,t.timeExtent))return!1;let i=!0;return i=i&&e.loadImagery===t.loadImagery,i=i&&e.createFlowMesh===t.createFlowMesh,i=i&&e.color.kind===t.color.kind,i=i&&e.opacity.kind===t.opacity.kind,i=i&&e.size.kind===t.size.kind,i},e.getColor=function(e){if(!e.hasVisualVariables("color"))return{kind:"constant",value:n(e.color)};const t=e.getVisualVariablesForType("color")[0],i=[],r=[];for(const e of t.stops)i.push(e.value),Array.prototype.push.apply(r,n(e.color));return{kind:"ramp",stops:i,values:r,count:t.stops.length}},e.getFlowSimulationSettings=function(e){const i=s(o(e)),r=i,n=Math.max(i/2,5),a=Math.round(t.pt2px(e.maxPathLength)/n)+1,{density:l}=e;return{smoothing:t.pt2px(e.smoothing),interpolate:!0,velocityScale:"flow-from"===e.flowRepresentation?1:-1,verticesPerLine:a,minSpeedThreshold:.001,segmentLength:n,maxTurnAngle:1,collisions:!0,lineCollisionWidth:r,lineSpacing:10,density:l,geometries:e.geometries}},e.getForegroundColor=function(e){return{kind:"constant",value:[.1,.1,.1,1]}},e.getMax=s,e.getOpacity=function(e){if(!e.hasVisualVariables("opacity"))return{kind:"constant",value:[1]};const t=e.getVisualVariablesForType("opacity")[0],i=[],r=[];for(const e of t.stops)i.push(e.value),r.push(e.opacity);return{kind:"ramp",stops:i,values:r,count:t.stops.length}},e.getSingleTileVisualState=function(e,t,s){const n=r.create();return i.identity(n),i.translate(n,n,[-1,1]),i.scale(n,n,[2/t,-2/s,1]),{time:e,dvsMat3:n,displayViewMat3:n}},e.getSize=o,e.setUniform=a,e.setUniforms=function(e,t,i,r){"constant"===r.kind?a(e,i,`u_${t}`,r.value):(a(e,"float",`u_${t}_stops`,r.stops),a(e,i,`u_${t}_values`,r.values),e.setUniform1i(`u_${t}_count`,r.count))},e.simulationSettingsEqual=l,e.timeExtentsEqual=c,e.toRgba=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/flow/styles/Imagery":function(){define(["exports","../../../../../core/promiseUtils","../utils","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor","../../../../webgl/VertexArrayObject","../../../../webgl/VertexAttributeLocations","../../../../webgl/VertexBuffer","../../../../webgl/VertexElementDescriptor"],function(e,t,i,r,s,n,o,a,l,c){"use strict";class h{constructor(e){this._params=e,this.animated=!1}isCompatible(e){if(!(e instanceof h))return!1;if(!i.timeExtentsEqual(this._params.timeExtent,e._params.timeExtent))return!1;let t=!0;return t=t&&this._params.loadImagery===e._params.loadImagery,t=t&&this._params.color.kind===e._params.color.kind,t=t&&this._params.opacity.kind===e._params.opacity.kind,t}async load(e,i){const{extent:r,size:s}=e;t.throwIfAborted(i);const n=await this._params.loadImagery(r,s[0],s[1],this._params.timeExtent,i);return new d(n,{color:this._params.color,opacity:this._params.opacity})}render(e,t,s){const{context:n}=e,{program:o}=s;n.setFaceCullingEnabled(!1),n.setBlendingEnabled(!0),n.setBlendFunction(1,771),n.useProgram(o),o.setUniformMatrix3fv("u_dvsMat3",t.dvsMat3),n.bindTexture(s.texture,0),o.setUniform1i("u_texture",0),o.setUniform1f("u_Min",s.min),o.setUniform1f("u_Max",s.max),i.setUniforms(o,"color","vec4",this._params.color),i.setUniforms(o,"opacity","float",this._params.opacity),n.bindVAO(s.vertexArray),n.drawArrays(r.PrimitiveType.TRIANGLE_STRIP,0,4)}}const u=[new c.VertexElementDescriptor("a_position",2,r.DataType.UNSIGNED_SHORT,0,8),new c.VertexElementDescriptor("a_texcoord",2,r.DataType.UNSIGNED_SHORT,4,8)],p={vsPath:"raster/flow/imagery",fsPath:"raster/flow/imagery",locations:a.fromLayout(u)};class d{constructor(e,t){this._flowData=e,this._values=t}attach(e){const{context:t}=e,{width:i,height:r}=this._flowData,a=new l.VertexBuffer(t,u,new Uint16Array([0,0,0,1,i,0,1,1,0,r,0,0,i,r,1,0])),c=new o.VertexArrayObject(t,a),h=[];"ramp"===this._values.color.kind&&h.push("vvColor"),"ramp"===this._values.opacity.kind&&h.push("vvOpacity");const d=e.getProgram(p,h);let f=1e6,m=-1e6;for(let e=0;e<r;e++)for(let t=0;t<i;t++)if(0!==this._flowData.mask[e*i+t]){const r=this._flowData.data[2*(e*i+t)],s=this._flowData.data[2*(e*i+t)+1],n=Math.sqrt(r*r+s*s);f=Math.min(f,n),m=Math.max(m,n)}const g=new Uint8Array(4*i*r);for(let e=0;e<r;e++)for(let t=0;t<i;t++)if(0!==this._flowData.mask[e*i+t]){const r=this._flowData.data[2*(e*i+t)],s=this._flowData.data[2*(e*i+t)+1],n=(Math.sqrt(r*r+s*s)-f)/(m-f);g[4*(e*i+t)]=255*n,g[4*(e*i+t)+1]=0,g[4*(e*i+t)+2]=0,g[4*(e*i+t)+3]=255}else g[4*(e*i+t)]=0,g[4*(e*i+t)+1]=0,g[4*(e*i+t)+2]=0,g[4*(e*i+t)+3]=0;const y=new n.TextureDescriptor(i,r);y.internalFormat=6408,y.wrapMode=33071,y.flipped=!0;const x=new s.Texture(t,y,g);this.vertexArray=c,this.program=d,this.texture=x,this.min=f,this.max=m,this._flowData=null}detach(){this.vertexArray.dispose(),this.texture.dispose()}get ready(){return this.program.compiled}}e.Imagery=h,e.ImageryResources=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/flow/styles/Particles":function(){define(["exports","../../../../../core/promiseUtils","../utils","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject","../../../../webgl/VertexAttributeLocations","../../../../webgl/VertexBuffer","../../../../webgl/VertexElementDescriptor"],function(e,t,i,r,s,n,o,a,l){"use strict";class c{constructor(e){this._params=e}get animated(){return this._params.flowSpeed>0}isCompatible(e){return e instanceof c&&i.areStreamlinesCompatible(this._params,e._params)}async load(e,i){const{extent:r,size:s}=e;t.throwIfAborted(i);const n=await this._params.loadImagery(r,s[0],s[1],this._params.timeExtent,i),{vertexData:o,indexData:a}=await this._params.createFlowMesh("Particles",this._params.simulationSettings,n,i);return new p(o,a,{color:this._params.color,opacity:this._params.opacity,size:this._params.size})}render(e,t,r){const{context:n}=e,{program:o}=r;n.setFaceCullingEnabled(!1),n.setBlendingEnabled(!0),n.setBlendFunction(1,771),n.useProgram(o),o.setUniform1f("u_time",t.time),o.setUniform1f("u_trailLength",this._params.trailLength),o.setUniform1f("u_flowSpeed",this._params.flowSpeed),o.setUniform1f("u_featheringSize",this._params.featheringSize),o.setUniform1f("u_featheringOffset",this._params.featheringOffset),o.setUniform1f("u_introFade",this._params.introFade?1:0),o.setUniform1f("u_fadeToZero",this._params.fadeToZero?1:0),o.setUniform1f("u_decayRate",this._params.decayRate),o.setUniformMatrix3fv("u_dvsMat3",t.dvsMat3),o.setUniformMatrix3fv("u_displayViewMat3",t.displayViewMat3),i.setUniforms(o,"color","vec4",this._params.color),i.setUniforms(o,"opacity","float",this._params.opacity),i.setUniforms(o,"size","float",this._params.size),n.bindVAO(r.vertexArray),n.drawElements(s.PrimitiveType.TRIANGLES,r.indexCount,s.DataType.UNSIGNED_INT,0)}}const h=[new l.VertexElementDescriptor("a_xyts0",4,s.DataType.FLOAT,0,64),new l.VertexElementDescriptor("a_xyts1",4,s.DataType.FLOAT,16,64),new l.VertexElementDescriptor("a_typeIdDurationSeed",4,s.DataType.FLOAT,32,64),new l.VertexElementDescriptor("a_extrudeInfo",4,s.DataType.FLOAT,48,64)],u={vsPath:"raster/flow/particles",fsPath:"raster/flow/particles",locations:o.fromLayout(h)};class p{constructor(e,t,i){this._vertexData=e,this._indexData=t,this._values=i}attach(e){const{context:t}=e,i=new a.VertexBuffer(t,h,this._vertexData),s=r.BufferObject.createIndex(t,35044,this._indexData),o=new n.VertexArrayObject(t,i,s),l=[];"ramp"===this._values.color.kind&&l.push("vvColor"),"ramp"===this._values.opacity.kind&&l.push("vvOpacity"),"ramp"===this._values.size.kind&&l.push("vvSize");const c=e.getProgram(u,l);this.vertexArray=o,this.program=c,this.indexCount=this._indexData.length,this._vertexData=null,this._indexData=null}detach(){this.vertexArray.dispose()}get ready(){return this.program.compiled}}e.Particles=c,e.ParticlesResources=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/flow/styles/Stack":function(){define(["exports"],function(e){"use strict";class t{constructor(e){this._styles=e}get animated(){return this._styles.reduce((e,t)=>e||t.animated,!1)}isCompatible(e){if(!(e instanceof t))return!1;if(this._styles.length!==e._styles.length)return!1;const i=this._styles.length;for(let t=0;t<i;t++)if(!this._styles[t].isCompatible(e._styles[t]))return!1;return!0}async load(e,t){const r=await Promise.all(this._styles.map(i=>i.load(e,t)));return new i(r)}render(e,t,i){for(let r=0;r<this._styles.length;r++)this._styles[r].render(e,t,i.resources[r])}}class i{constructor(e){this.resources=e}attach(e){for(const t of this.resources)t.attach(e)}detach(){for(const e of this.resources)e.detach()}get ready(){return this.resources.reduce((e,t)=>e&&t.ready,!0)}}e.Stack=t,e.StackResources=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/flow/styles/Streamlines":function(){define(["../../../../../core/promiseUtils","../utils","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject","../../../../webgl/VertexAttributeLocations","../../../../webgl/VertexBuffer","../../../../webgl/VertexElementDescriptor"],function(e,t,i,r,s,n,o,a){"use strict";class l{constructor(e){this._params=e}get animated(){return this._params.flowSpeed>0}isCompatible(e){return e instanceof l&&t.areStreamlinesCompatible(this._params,e._params)}async load(t,i){const{extent:r,size:s}=t;e.throwIfAborted(i);const n=await this._params.loadImagery(r,s[0],s[1],this._params.timeExtent,i),{vertexData:o,indexData:a}=await this._params.createFlowMesh("Streamlines",this._params.simulationSettings,n,i);return new u(o,a,{color:this._params.color,opacity:this._params.opacity,size:this._params.size})}render(e,i,s){const{context:n}=e,{program:o}=s;n.setFaceCullingEnabled(!1),n.setBlendingEnabled(!0),n.setBlendFunction(1,771),n.useProgram(o),o.setUniform1f("u_time",i.time),o.setUniform1f("u_trailLength",this._params.trailLength),o.setUniform1f("u_flowSpeed",this._params.flowSpeed),o.setUniform1f("u_featheringSize",this._params.featheringSize),o.setUniform1f("u_featheringOffset",this._params.featheringOffset),o.setUniform1f("u_introFade",this._params.introFade?1:0),o.setUniform1f("u_fadeToZero",this._params.fadeToZero?1:0),o.setUniform1f("u_decayRate",this._params.decayRate),o.setUniformMatrix3fv("u_dvsMat3",i.dvsMat3),o.setUniformMatrix3fv("u_displayViewMat3",i.displayViewMat3),t.setUniforms(o,"color","vec4",this._params.color),t.setUniforms(o,"opacity","float",this._params.opacity),t.setUniforms(o,"size","float",this._params.size),n.bindVAO(s.vertexArray),n.drawElements(r.PrimitiveType.TRIANGLES,s.indexCount,r.DataType.UNSIGNED_INT,0)}}const c=[new a.VertexElementDescriptor("a_positionAndSide",3,r.DataType.FLOAT,0,40),new a.VertexElementDescriptor("a_timeInfo",3,r.DataType.FLOAT,12,40),new a.VertexElementDescriptor("a_extrude",2,r.DataType.FLOAT,24,40),new a.VertexElementDescriptor("a_speed",1,r.DataType.FLOAT,32,40),new a.VertexElementDescriptor("a_colorTime",1,r.DataType.FLOAT,36,40)],h={vsPath:"raster/flow/streamlines",fsPath:"raster/flow/streamlines",locations:n.fromLayout(c)};class u{constructor(e,t,i){this._vertexData=e,this._indexData=t,this._values=i}attach(e){const{context:t}=e,r=new o.VertexBuffer(t,c,this._vertexData),n=i.BufferObject.createIndex(t,35044,this._indexData),a=new s.VertexArrayObject(t,r,n),l=[];"ramp"===this._values.color.kind&&l.push("vvColor"),"ramp"===this._values.opacity.kind&&l.push("vvOpacity"),"ramp"===this._values.size.kind&&l.push("vvSize");const u=e.getProgram(h,l);this.vertexArray=a,this.program=u,this.indexCount=this._indexData.length,this._vertexData=null,this._indexData=null}detach(){this.vertexArray.dispose()}get ready(){return this.program.compiled}}return l})},"esri/views/2d/engine/flow/dataUtils":function(){define(["exports","../../../../core/has","../../../../core/Logger","../../../../core/mathUtils","../../../../core/promiseUtils","../../../../core/RandomLCG","../../../../geometry/Extent","../../../../geometry/support/spatialReferenceUtils"],function(e,t,i,r,s,n,o,a){"use strict";const l=()=>i.getLogger("esri.views.2d.engine.flow.dataUtils");function c(e,t){const i=function(e,t,i,r){if(0===r)return e;const s=Math.round(3*r),n=new Array(2*s+1);let o=0;for(let e=-s;e<=s;e++){const t=Math.exp(-e*e/(r*r));n[e+s]=t,o+=t}for(let e=-s;e<=s;e++)n[e+s]/=o;const a=new Float32Array(e.length);for(let r=0;r<i;r++)for(let i=0;i<t;i++){let o=0,l=0;for(let a=-s;a<=s;a++){if(i+a<0||i+a>=t)continue;const c=n[a+s];o+=c*e[2*(r*t+(i+a))],l+=c*e[2*(r*t+(i+a))+1]}a[2*(r*t+i)]=o,a[2*(r*t+i)+1]=l}const l=new Float32Array(e.length);for(let e=0;e<t;e++)for(let r=0;r<i;r++){let o=0,c=0;for(let l=-s;l<=s;l++){if(r+l<0||r+l>=i)continue;const h=n[l+s];o+=h*a[2*((r+l)*t+e)],c+=h*a[2*((r+l)*t+e)+1]}l[2*(r*t+e)]=o,l[2*(r*t+e)+1]=c}return l}(t.data,t.width,t.height,e.smoothing);return e.interpolate?(e,r)=>{const s=Math.floor(e),n=Math.floor(r);if(s<0||s>=t.width)return[0,0];if(n<0||n>=t.height)return[0,0];const o=e-s,a=r-n,l=s,c=n,h=s<t.width-1?s+1:s,u=n<t.height-1?n+1:n,p=i[2*(c*t.width+l)],d=i[2*(c*t.width+h)],f=i[2*(u*t.width+l)],m=i[2*(u*t.width+h)],g=i[2*(c*t.width+l)+1],y=i[2*(c*t.width+h)+1];return[(p*(1-a)+f*a)*(1-o)+(d*(1-a)+m*a)*o,(g*(1-a)+i[2*(u*t.width+l)+1]*a)*(1-o)+(y*(1-a)+i[2*(u*t.width+h)+1]*a)*o]}:(e,r)=>{const s=Math.round(e),n=Math.round(r);return s<0||s>=t.width||n<0||n>=t.height?[0,0]:[i[2*(n*t.width+s)],i[2*(n*t.width+s)+1]]}}function h(e,t,i){let r=1/0,s=1;for(let n=0;n+1<i.length;n++){const o=[i[n+1][0]-i[n][0],i[n+1][1]-i[n][1]],a=[e-i[n][0],t-i[n][1]],l=Math.min(Math.max((a[0]*o[0]+a[1]*o[1])/(o[0]*o[0]+o[1]*o[1]),0),1),c=[a[0]-o[0]*l,a[1]-o[1]*l];r=Math.min(r,c[0]*c[0]+c[1]*c[1]),(t>=i[n][1]&&t<i[n+1][1]&&o[0]*a[1]>o[1]*a[0]||t<i[n][1]&&t>=i[n+1][1]&&o[0]*a[1]<=o[1]*a[0])&&(s=-s)}return s*Math.sqrt(r)}function u(e,t,i){const{geometries:r}=e;let s=1/0;for(const[e,n]of r)s=Math.min(s,h(t,i,n));return s}function p(e,t,i){const r=u(e,t,i),s=Math.max(.001,r);return Math.min(1,10/s)}function d(e,t,i,r,s,n,o,a,l,c=null){const h=[];let u=i,d=r,f=0,[m,g]=t(u,d);m*=e.velocityScale,g*=e.velocityScale;const y=Math.sqrt(m*m+g*g);let x,w;h.push({x:u,y:d,t:f,speed:y,colorTime:c??p(e,u,d)});for(let i=0;i<e.verticesPerLine;i++){let[i,r]=t(u,d);i*=e.velocityScale,r*=e.velocityScale;const m=Math.sqrt(i*i+r*r);if(m<e.minSpeedThreshold)return h;const g=i/m,y=r/m;if(u+=g*e.segmentLength,d+=y*e.segmentLength,f+=e.segmentLength/m,Math.acos(g*x+y*w)>e.maxTurnAngle)return h;if(e.collisions){const e=Math.round(u*l),t=Math.round(d*l);if(e<0||e>o-1||t<0||t>a-1)return h;const i=n[t*o+e];if(-1!==i&&i!==s)return h;n[t*o+e]=s}const _=c??Math.max(h[h.length-1].colorTime,p(e,u,d));h.push({x:u,y:d,t:f,speed:m,colorTime:_}),x=g,w=y}return h}function f(e,t,i,r){const s=[],o=new n,a=1/Math.max(e.lineCollisionWidth,1),l=Math.round(i*a),c=Math.round(r*a),h=new Int32Array(l*c);for(let e=0;e<h.length;e++)h[e]=-1;const p=[];for(let t=0;t<r;t+=e.lineSpacing)for(let r=0;r<i;r+=e.lineSpacing)p.push({x:r,y:t,sort:o.getFloat()});p.sort((e,t)=>e.sort-t.sort);const{verticesPerLine:f}=e;for(let{x:i,y:r}of p)if(o.getFloat()<e.density&&u(e,i,r)<10){let n=null;for(let u=0;u<20;u++){const u=d(e,t,i,r,s.length,h,l,c,a,n);if(i=u[u.length-1].x,r=u[u.length-1].y,n=u[u.length-1].colorTime,!(u.length<2||(s.push(u),u.length<7)))for(let u=0;u<20;u++){const u=o.getFloat(),p=d(e,t,i+5*e.lineSpacing*Math.cos(2*Math.PI*u),r+5*e.lineSpacing*Math.sin(2*Math.PI*u),s.length,h,l,c,a,n);p.length>=2&&s.push(p)}}}e.verticesPerLine=f;for(const{x:i,y:r}of p)if(o.getFloat()<e.density){const n=d(e,t,i,r,s.length,h,l,c,a);if(n.length<2)continue;s.push(n)}return s}function m(e,t){const i=new n,r=e.reduce((e,t)=>e+t.length,0),s=new Float32Array(5*r),o=new Array(e.length);let a=0,l=0;for(const r of e){const e=a;for(const e of r)s[5*a]=e.x,s[5*a+1]=e.y,s[5*a+2]=e.t,s[5*a+3]=e.speed,s[5*a+4]=e.colorTime,a++;o[l++]={startVertex:e,numberOfVertices:r.length,totalTime:r[r.length-1].t,timeSeed:t?i.getFloat():0}}return{lineVertices:s,lineDescriptors:o}}function g(e,t){const{lineVertices:i,lineDescriptors:r}=e;let s=0,n=0;for(const e of r)s+=2*e.numberOfVertices,n+=6*(e.numberOfVertices-1);const o=new Float32Array(10*s),a=new Uint32Array(n);let l=0,c=0;function h(){a[c++]=l-2,a[c++]=l,a[c++]=l-1,a[c++]=l,a[c++]=l+1,a[c++]=l-1}function u(e,t,i,r,s,n,a,c,h){const u=10*l;let p=0;o[u+p++]=e,o[u+p++]=t,o[u+p++]=1,o[u+p++]=i,o[u+p++]=n,o[u+p++]=a,o[u+p++]=r/2,o[u+p++]=s/2,o[u+p++]=c,o[u+p++]=h,l++,o[u+p++]=e,o[u+p++]=t,o[u+p++]=-1,o[u+p++]=i,o[u+p++]=n,o[u+p++]=a,o[u+p++]=-r/2,o[u+p++]=-s/2,o[u+p++]=c,o[u+p++]=h,l++}for(const e of r){const{totalTime:r,timeSeed:s}=e;let n=null,o=null,a=null,l=null,c=null,p=null,d=null;for(let f=0;f<e.numberOfVertices;f++){const m=i[5*(e.startVertex+f)],g=i[5*(e.startVertex+f)+1],y=i[5*(e.startVertex+f)+2],x=i[5*(e.startVertex+f)+3],w=i[5*(e.startVertex+f)+4];let _=null,b=null,v=null,S=null;if(f>0){_=m-n,b=g-o;const e=Math.sqrt(_*_+b*b);if(_/=e,b/=e,f>1){let e=_+p,i=b+d;const r=Math.sqrt(e*e+i*i);e/=r,i/=r;const s=Math.min(1/(e*_+i*b),t);e*=s,i*=s,v=-i,S=e}else v=-b,S=_;null!==v&&null!==S&&(u(n,o,a,v,S,r,s,x,w),h())}n=m,o=g,a=y,p=_,d=b,l=x,c=w}u(n,o,a,-d,p,r,s,l,c)}return{vertexData:o,indexData:a}}function y(e){const{lineVertices:t,lineDescriptors:i}=e;let r=0,s=0;for(const e of i){const t=e.numberOfVertices-1;r+=4*t*2,s+=6*t*2}const n=new Float32Array(16*r),o=new Uint32Array(s);let a,l,c,h,u,p,d,f,m,g,y,x,w,_,b=0,v=0;function S(e,t){let i=m+y,r=g+x;const s=Math.sqrt(i*i+r*r);i/=s,r/=s;const S=m*i+g*r;i/=S,r/=S;let M=y+w,P=x+_;const k=Math.sqrt(M*M+P*P);M/=k,P/=k;const T=y*M+x*P;M/=T,P/=T,function(e,t,i,r,s,o,a,l,c,h,u,p,d,f){const m=16*b;let g=0;for(const y of[1,2])for(const x of[1,2,3,4])n[m+g++]=e,n[m+g++]=t,n[m+g++]=i,n[m+g++]=r,n[m+g++]=a,n[m+g++]=l,n[m+g++]=c,n[m+g++]=h,n[m+g++]=y,n[m+g++]=x,n[m+g++]=d,n[m+g++]=f,n[m+g++]=s/2,n[m+g++]=o/2,n[m+g++]=u/2,n[m+g++]=p/2,b++}(a,l,c,h,-r,i,u,p,d,f,-P,M,e,t),o[v++]=b-8,o[v++]=b-7,o[v++]=b-6,o[v++]=b-7,o[v++]=b-5,o[v++]=b-6,o[v++]=b-4,o[v++]=b-3,o[v++]=b-2,o[v++]=b-3,o[v++]=b-1,o[v++]=b-2}function M(e,t,i,r,s,n){if(m=y,g=x,y=w,x=_,null==m&&null==g&&(m=y,g=x),null!=u&&null!=p){w=e-u,_=t-p;const i=Math.sqrt(w*w+_*_);w/=i,_/=i}null!=m&&null!=g&&S(s,n),a=u,l=p,c=d,h=f,u=e,p=t,d=i,f=r}function P(e,t){m=y,g=x,y=w,x=_,null==m&&null==g&&(m=y,g=x),null!=m&&null!=g&&S(e,t)}for(const e of i){a=null,l=null,c=null,h=null,u=null,p=null,d=null,f=null,m=null,g=null,y=null,x=null,w=null,_=null;const{totalTime:i,timeSeed:r}=e;for(let s=0;s<e.numberOfVertices;s++)M(t[4*(e.startVertex+s)],t[4*(e.startVertex+s)+1],t[4*(e.startVertex+s)+2],t[4*(e.startVertex+s)+3],i,r);P(i,r)}return{vertexData:n,indexData:o}}function x(e,t){const i=t.pixels,{width:s,height:n}=t,o=new Float32Array(s*n*2),a=t.mask||new Uint8Array(s*n*2);if(t.mask||a.fill(255),"vector-uv"===e)for(let e=0;e<s*n;e++)o[2*e]=i[0][e],o[2*e+1]=-i[1][e];else if("vector-magdir"===e)for(let e=0;e<s*n;e++){const t=i[0][e],s=r.deg2rad(i[1][e]),n=Math.cos(s-Math.PI/2),a=Math.sin(s-Math.PI/2);o[2*e]=n*t,o[2*e+1]=a*t}return{data:o,mask:a,width:s,height:n}}async function w(e,t,i,r,s,n){const o={requestProjectedLocalDirections:!0,signal:n};if(null!=s&&(o.timeExtent=s),"imagery"===e.type){await e.load({signal:n});const s=await e.internalFetchImage(t,i,r,o);return null==s?.pixelData?.pixelBlock?{data:new Float32Array(i*r*2),mask:new Uint8Array(i*r),width:i,height:r}:x(e.rasterInfo.dataType,s.pixelData.pixelBlock)}await e.load({signal:n});const a=await e.fetchPixels(t,i,r,o);return null==a?.pixelBlock?{data:new Float32Array(i*r*2),mask:new Uint8Array(i*r),width:i,height:r}:x(e.serviceRasterInfo.dataType,a.pixelBlock)}e.createAnimatedLinesData=m,e.createFlowFieldFromData=c,e.createFlowMesh=async function(e,i,r,n){const o=performance.now(),a=c(i,r),h=performance.now(),u=f(i,a,r.width,r.height),p=performance.now(),d=m(u,!0),x=performance.now(),w="Streamlines"===e?g(d,10):y(d),_=performance.now();return t("esri-2d-profiler")&&(l().info("I.1","_createFlowFieldFromData (ms)",Math.round(h-o)),l().info("I.2","_getStreamlines (ms)",Math.round(p-h)),l().info("I.3","createAnimatedLinesData (ms)",Math.round(x-p)),l().info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(_-x)),l().info("I.5","createFlowMesh (ms)",Math.round(_-o)),l().info("I.6","Mesh size (bytes)",w.vertexData.buffer.byteLength+w.indexData.buffer.byteLength)),await Promise.resolve(),s.throwIfAborted(n),w},e.createParticlesMesh=y,e.createStreamlinesMesh=g,e.getStreamlines=f,e.loadImagery=async function(e,i,r,s,n,c){const h=performance.now(),u=a.getInfo(i.spatialReference);if(!u){const o=await w(e,i,r,s,n,c);return t("esri-2d-profiler")&&l().info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-h)),t("esri-2d-profiler")&&l().info("I.9","Number of parts",1),o}const[p,d]=u.valid,f=d-p,m=Math.ceil(i.width/f),g=i.width/m,y=Math.round(r/m);let x=i.xmin;const _=[],b=performance.now();for(let t=0;t<m;t++){const t=new o({xmin:x,xmax:x+g,ymin:i.ymin,ymax:i.ymax,spatialReference:i.spatialReference});_.push(w(e,t,y,s,n,c)),x+=g}const v=await Promise.all(_);t("esri-2d-profiler")&&l().info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-b)),t("esri-2d-profiler")&&l().info("I.9","Number of parts",v.length);const S={data:new Float32Array(r*s*2),mask:new Uint8Array(r*s),width:r,height:s};let M=0;for(const e of v){for(let t=0;t<e.height;t++)for(let i=0;i<e.width;i++)M+i>=r||(S.data[2*(t*r+M+i)]=e.data[2*(t*e.width+i)],S.data[2*(t*r+M+i)+1]=e.data[2*(t*e.width+i)+1],S.mask[t*r+M+i]=e.mask[t*e.width+i]);M+=e.width}return t("esri-2d-profiler")&&l().info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-h)),S},e.toFlowData=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/flow/FlowContainer":function(){define(["./BrushFlow","../webgl/WGLContainer"],function(e,t){"use strict";return class extends t{constructor(){super(...arguments),this.flowStyle=null}doRender(e){super.doRender(e)}prepareRenderPasses(t){const i=t.registerRenderPass({name:"flow",brushes:[e],target:()=>this.children,drawPhase:1});return[...super.prepareRenderPasses(t),i]}}})},"esri/views/2d/engine/flow/BrushFlow":function(){define(["../../../../core/libs/gl-matrix-2/factories/mat3f32","../webgl/brushes/WGLBrush"],function(e,t){"use strict";return class extends t{constructor(){super(...arguments),this._visualState={time:0,dvsMat3:e.create(),displayViewMat3:e.create()}}dispose(){}prepareState(e){const{context:t}=e;t.setColorMask(!0,!0,!0,!0),t.setStencilFunction(514,0,255)}draw(e,t){const{requestRender:i,allowDelayedRender:r}=e,{displayData:s}=t;if(null==s)return;if("loaded"===s.state.name&&s.attach({context:e.context,getProgram:(t,i)=>e.painter.materialManager.getProgram(t,i)}),"attached"!==s.state.name)return;const n=s.state.resources;!r||n.ready||null==i?(this._visualState.time=e.time/1e3,this._visualState.dvsMat3=t.transforms.displayViewScreenMat3,this._visualState.displayViewMat3=e.state.displayViewMat3,s.flowStyle.render({context:e.context,getProgram:(t,i)=>e.painter.materialManager.getProgram(t,i)},this._visualState,n),s.flowStyle.animated&&null!=i&&i()):i()}}})},"esri/views/2d/engine/flow/FlowStrategy":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Logger","../../../../core/mathUtils","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../geometry/Point","./FlowDisplayData","./FlowDisplayObject"],function(e,t,i,r,s,n,o,a,l,c,h,u,p,d){"use strict";return e.default=class extends i{constructor(e){super(e),this._flowDisplayObject=new d.FlowDisplayObject,this._loading=null}initialize(){this.flowContainer.addChild(this._flowDisplayObject)}destroy(){this._clear(),this.flowContainer.removeAllChildren()}get updating(){return null!=this._loading}update(e){const{flowStyle:t}=this.flowContainer;if(null==t)return void this._clear();const{extent:i,rotation:o,resolution:a,pixelRatio:l}=e.state,c=function(e,t){const i=new u({x:(e.xmax+e.xmin)/2,y:(e.ymax+e.ymin)/2,spatialReference:e.spatialReference}),r=e.xmax-e.xmin,n=e.ymax-e.ymin,o=Math.abs(Math.cos(s.deg2rad(t))),a=Math.abs(Math.sin(s.deg2rad(t))),l=o*r+a*n,c=a*r+o*n,p=new h({xmin:i.x-l/2,ymin:i.y-c/2,xmax:i.x+l/2,ymax:i.y+c/2,spatialReference:e.spatialReference});return p.centerAt(i),p}(i,o);c.expand(1);const d=[Math.round((c.xmax-c.xmin)/a),Math.round((c.ymax-c.ymin)/a)],f=new p(t,c,d,l);if(null!=this._loading){if(this._loading.update(f))return;this._loading.detach(),this._loading=null}null!=this._flowDisplayObject.displayData&&this._flowDisplayObject.displayData.update(f)||(f.load().then(()=>{this._flowDisplayObject.clear(),this._flowDisplayObject.displayData=this._loading,this._loading=null},e=>{n.isAbortError(e)||(r.getLogger(this).error("A resource failed to load.",e),this._loading=null)}),this._loading=f)}_clear(){this._flowDisplayObject.clear(),null!=this._loading&&(this._loading.detach(),this._loading=null)}},t.__decorate([o.property()],e.default.prototype,"_loading",void 0),t.__decorate([o.property()],e.default.prototype,"flowContainer",void 0),t.__decorate([o.property()],e.default.prototype,"updating",null),e.default=t.__decorate([c.subclass("esri.views.2d.engine.flow.FlowStrategy")],e.default),e.default})},"esri/views/2d/engine/flow/FlowDisplayData":function(){define(["../../../../core/Logger"],function(e){"use strict";return class{constructor(e,t,i,r){this.state={name:"created"},this.flowStyle=e,this.extent=t,this.size=i,this.pixelRatio=r}async load(){const e=new AbortController;this.state={name:"loading",abortController:e};const t={extent:this.extent,size:this.size,pixelRatio:this.pixelRatio},i=await this.flowStyle.load(t,e.signal);this.state={name:"loaded",resources:i}}attach(t){if("loaded"!==this.state.name)return void e.getLogger("esri.views.2d.engine.flow.FlowDisplayData").error("Only loaded resources can be attached.");const i=this.state.resources;i.attach(t),this.state={name:"attached",resources:i}}detach(){if("loading"===this.state.name)return this.state.abortController.abort(),void(this.state={name:"detached"});"attached"===this.state.name&&(this.state.resources.detach(),this.state={name:"detached"})}update(e){return!1}}})},"esri/views/2d/engine/flow/FlowDisplayObject":function(){define(["exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f32","../DisplayObject"],function(e,t,i,r,s){"use strict";class n extends s.DisplayObject{constructor(){super(...arguments),this._displayData=null}get displayData(){return this._displayData}set displayData(e){this._displayData=e,this.requestRender()}clear(){null!=this._displayData&&(this._displayData.detach(),this._displayData=null,this.requestRender())}setTransform(e){const{displayData:r}=this;if(null==r)return;const s=r.extent.xmin,n=r.extent.ymax,o=[0,0];e.toScreen(o,[s,n]);const a=(r.extent.xmax-r.extent.xmin)/r.size[0]/e.resolution,l=t.deg2rad(e.rotation),{displayViewScreenMat3:c}=this.transforms;i.fromTranslation(c,[-1,1,0]),i.scale(c,c,[2/(e.size[0]*e.pixelRatio),-2/(e.size[1]*e.pixelRatio),1]),i.translate(c,c,[o[0],o[1],0]),i.rotate(c,c,l),i.scale(c,c,[a*e.pixelRatio,a*e.pixelRatio,1])}_createTransforms(){return{displayViewScreenMat3:r.create()}}}e.FlowDisplayObject=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/layers/LayerView2D":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Collection","../../../core/collectionUtils","../../../core/Error","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../linkChart/utils","../engine/Container","./support/HighlightCounter","./support/util","../support/highlightOptionsUtils","../../layers/support/ClipRect","../../layers/support/Geometry","../../layers/support/Path","../../support/HighlightOptions","../../support/layerViewUtils"],function(e,t,i,r,s,n,o,a,l,c,h,u,p,d,f,m,g,y,x,w,_){"use strict";const b=i.ofType({key:"type",base:null,typeMap:{rect:g,path:x,geometry:y}}),v=new(i.ofType(w));e.LayerView2DMixin=e=>{const a=e;let l=class extends a{constructor(){super(...arguments),this._highlightCounter=new d.HighlightCounter,this.attached=!1,this.clips=new b,this.highlights=null,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this._visibleAtCurrentScale=!0}initialize(){const e=this.view?.spatialReferenceLocked??!0,t=this.view?.spatialReference;t&&e&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new s("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new p.Container),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([n.watch(()=>this.suspended,e=>{this.container&&(this.container.visible=!e)},n.syncAndInitial),n.watch(()=>this.updateSuspended,e=>{this.view&&!e&&this.updateRequested&&this.view.requestUpdate()},n.syncAndInitial),n.watch(()=>this.layer?.opacity??1,e=>{this.container&&(this.container.opacity=e)},n.syncAndInitial),n.watch(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",e=>{this.container&&(this.container.blendMode=e)},n.syncAndInitial),n.watch(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,e=>{this.container&&(this.container.effect=e)},n.syncAndInitial),n.watch(()=>this._mergedHighlights.items.map(e=>({name:e.name,options:{fillColor:e.color,haloColor:e.haloColor,fillOpacity:e.fillOpacity,haloOpacity:e.haloOpacity,haloWidth:e.haloWidth,haloBlur:e.haloBlur}})),()=>{this.container.highlightGradient=f.createOrReuseHighlightGradient(this.container.highlightGradient,this._mergedHighlights.items)},n.syncAndInitial),n.watch(()=>this._mergedHighlights.items.map(e=>e.name),()=>{this._processHighlight()}),n.on(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},n.syncAndInitial),n.watch(()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}),({scale:e,scaleRange:t})=>{const i=_.isInEffectiveScaleRange(t,e);i!==this._visibleAtCurrentScale&&(this._visibleAtCurrentScale=i)},n.syncAndInitial)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(e=>{e===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get highlightOptions(){return m.getDefaultHighlightOptions(this)}set highlightOptions(e){m.setDefaultHighlightOptions(this,e)}get hasHighlight(){return this._highlightCounter.size>0}get _mergedHighlights(){if(!this.view)return v;if(!this.highlights)return this.view.highlights;const e=this.view.highlights.clone();for(const t of this.highlights){const i=e.find(e=>e.name===t.name);i&&i.assignFrom(t)}return e}get highlightIds(){return Array.from(this._highlightCounter.objectIds)}get scheduler(){return this.view.scheduler}get spatialReferenceSupported(){const e=this.view?.spatialReference;return null==e||this.supportsSpatialReference(e)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this._updatingHandles?.updating||this.container.transitioning)}get visibleAtCurrentScale(){return this._visibleAtCurrentScale}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(e){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",e),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(e))):this.updateRequested=!1}hitTest(e,t){return Promise.resolve(null)}supportsSpatialReference(e){return!0}canResume(){if(!this.spatialReferenceSupported)return!1;switch(this.layer?.type){case"link-chart":case"knowledge-graph-sublayer":case"graphics":break;default:if(u.isLinkChartView(this.view)&&!this.view.inGeographicLayout)return!1}return!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const e=super.getSuspendInfo(),t=!this.spatialReferenceSupported;return t&&(e.spatialReferenceNotSupported=t),e}addAttachHandles(e){this.addHandles(e,"attach")}_addHighlights(e,t){this._highlightCounter.add(e,t)&&this._processHighlight()}_removeHighlights(e,t){this._highlightCounter.delete(e,t)&&this._processHighlight()}_processHighlight(){}_getHighlights(){const e=[];for(const[t,i]of this._highlightCounter.highlightNamesByObjectId){const r=this._getHighlightBits(i);e.push({objectId:t,highlightFlags:r})}return e}_getHighlightBits(e){const t=new Set(e);let i=1,r=0;if(!this.view)return 0;const s=this._mergedHighlights;for(const{name:e}of s)t.delete(e)&&(r=i),i<<=1;return r}};return t.__decorate([o.property()],l.prototype,"attached",void 0),t.__decorate([o.property({type:b,set(e){const t=r.referenceSetter(e,this._get("clips"),b);this._set("clips",t)}})],l.prototype,"clips",void 0),t.__decorate([o.property()],l.prototype,"container",void 0),t.__decorate([o.property({type:w})],l.prototype,"highlightOptions",null),t.__decorate([o.property({type:i.ofType(w)})],l.prototype,"highlights",void 0),t.__decorate([o.property()],l.prototype,"_mergedHighlights",null),t.__decorate([o.property()],l.prototype,"moving",void 0),t.__decorate([o.property({readOnly:!0})],l.prototype,"spatialReferenceSupported",null),t.__decorate([o.property({readOnly:!0})],l.prototype,"updateParameters",void 0),t.__decorate([o.property()],l.prototype,"updateRequested",void 0),t.__decorate([o.property()],l.prototype,"updating",null),t.__decorate([o.property()],l.prototype,"view",void 0),t.__decorate([o.property()],l.prototype,"_visibleAtCurrentScale",void 0),t.__decorate([o.property({readOnly:!0})],l.prototype,"visibleAtCurrentScale",null),l=t.__decorate([h.subclass("esri.views.2d.layers.LayerView2D")],l),l},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/linkChart/utils":function(){define(["exports"],function(e){"use strict";e.isLinkChartView=function(e){return null!=e&&"object"==typeof e&&"2d"===e.type&&"linkchart"===e.view2dType},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/layers/support/HighlightCounter":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/MapUtils","../../../../core/ReactiveMap","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass"],function(e,t,i,r,s,n,o,a,l,c){"use strict";e.HighlightCounter=class extends i{constructor(){super(...arguments),this._idToCounters=new s}get size(){return this._idToCounters.size}get objectIds(){return this._idToCounters.keys()}get highlightNamesByObjectId(){return function*(e){for(const[t,i]of e)yield[t,i.keys()]}(this._idToCounters)}add(e,t){let i=!1;for(const s of e){const e=r.getOrCreateMapValue(this._idToCounters,s,()=>(i=!0,new Map)),n=e.get(t)??0;n||(i=!0),e.set(t,n+1)}return i}delete(e,t){let i=!1;for(const r of e){const e=this._idToCounters.get(r);if(!e)continue;let s=e.get(t);null!=s&&(s--,s>0?e.set(t,s):(e.delete(t),i=!0),0===e.size&&(this._idToCounters.delete(r),i=!0))}return i}},e.HighlightCounter=t.__decorate([c.subclass("esri.views.2d.layers.support.HighlightCounter")],e.HighlightCounter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/support/ClipRect":function(){define(["exports","../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./ClipArea"],function(e,t,i,r,s,n,o,a){"use strict";var l;return e.default=l=class extends a{constructor(e){super(e),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new l({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}},t.__decorate([i.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"left",void 0),t.__decorate([i.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"right",void 0),t.__decorate([i.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"top",void 0),t.__decorate([i.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"bottom",void 0),e.default=l=t.__decorate([o.subclass("esri.views.layers.support.ClipRect")],e.default),e.default})},"esri/views/layers/support/ClipArea":function(){define(["exports","../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],function(e,t,i,r,s,n,o,a){"use strict";return e.default=class extends i.JSONSupport{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}},t.__decorate([r.property({readOnly:!0})],e.default.prototype,"version",null),e.default=t.__decorate([a.subclass("esri.views.layers.support.ClipArea")],e.default),e.default})},"esri/views/layers/support/Geometry":function(){define(["exports","../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../../../geometry/Geometry","../../../geometry/Polygon","../../../geometry/support/jsonUtils","./ClipArea"],function(e,t,i,r,s,n,o,a,l,c,h,u){"use strict";var p;const d={base:l,key:"type",typeMap:{extent:a,polygon:c}};return e.default=p=class extends u{constructor(e){super(e),this.type="geometry",this.geometry=null}clone(){return new p({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}},t.__decorate([i.property({types:d,json:{read:h.fromJSON,write:!0}})],e.default.prototype,"geometry",void 0),e.default=p=t.__decorate([o.subclass("esri.views.layers.support.Geometry")],e.default),e.default})},"esri/views/layers/support/Path":function(){define(["exports","../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./ClipArea"],function(e,t,i,r,s,n,o,a){"use strict";return e.default=class extends a{constructor(e){super(e),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}},t.__decorate([i.property({type:[[[Number]]],json:{write:!0}})],e.default.prototype,"path",void 0),e.default=t.__decorate([o.subclass("esri.views.layers.support.Path")],e.default),e.default})},"esri/views/2d/layers/graphics/HighlightGraphicContainer":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","./AGraphicContainer","../support/util"],function(e,t,i,r,s,n,o,a,l){"use strict";return e.default=class extends a.AGraphicContainer{get hasHighlight(){return this.children.some(e=>e.hasData)}renderChildren(e){this.attributeView.update(),16===e.drawPhase&&this.children.some(e=>e.hasData)&&(super.renderChildren(e),e.context.setColorMask(!0,!0,!0,!0),l.renderHighlight(e,!1,e=>{this._renderChildren(e,1)}))}},e.default=t.__decorate([o.subclass("esri.views.2d.layers.graphics.HighlightGraphicContainer")],e.default),e.default})},"esri/views/2d/layers/imagery/ImageryView2D":function(){define(["exports","../../../../chunks/tslib.es6","../../../../Graphic","../../../../core/Accessor","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/support/rasterFunctions/pixelUtils","../../engine/BitmapContainer","../../engine/Container","../../engine/ImageryBitmapSource","../support/ExportStrategy"],function(e,t,i,r,s,n,o,a,l,c,h,u,p,d,f){"use strict";return e.default=class extends r{constructor(){super(...arguments),this.attached=!1,this.container=new p.Container,this.updateRequested=!1,this.type="imagery",this._bitmapView=new u.BitmapContainer}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(e){this.strategy.update(e).catch(e=>{n.isAbortError(e)||s.getLogger(this).error(e)})}hitTest(e){return new i({attributes:{},geometry:e.clone(),layer:this.layer})}attach(){this.container.addChild(this._bitmapView);const e=this.layer.version>=10,t=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,i=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this.strategy=new f({container:this._bitmapView,imageNormalizationSupported:e,imageMaxHeight:t,imageMaxWidth:i,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()})}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren(),this.updateRequested=!1}redraw(){this.strategy.updateExports(async e=>{const{source:t}=e;if(!t||t instanceof ImageBitmap)return;const i=t.originalPixelBlock??t.pixelBlock,r=await this.layer.applyRenderer({extent:t.extent,pixelBlock:i,isRawData:!!this.pixelHighlightOptions}),s=r.pixelBlock;this.pixelHighlightOptions&&i&&s&&await this.layer.highlightPixels({pixelBlock:i,renderedPixelBlock:s,highlightOptions:this.pixelHighlightOptions}),t.filter=e=>this.layer.pixelFilter?this.layer.applyFilter(e):{...r,extent:t.extent}}).catch(e=>{n.isAbortError(e)||s.getLogger(this).error(e)})}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;const e=this.strategy.bitmaps;if(1===e.length&&e[0].source)return{extent:e[0].source.extent,pixelBlock:e[0].source.originalPixelBlock};if(e.length>1){const t=this.view.extent,i=e.map(e=>e.source).filter(e=>e.extent&&e.extent.intersects(t)).map(e=>({extent:e.extent,pixelBlock:e.originalPixelBlock})),r=h.mosaicPixelData(i,t);return null!=r?{extent:r.extent,pixelBlock:r.pixelBlock}:null}return null}async _fetchImage(e,t,i,r){(r=r||{}).timeExtent=this.timeExtent,r.requestAsImageElement=!this.pixelHighlightOptions,r.returnImageBitmap=!this.pixelHighlightOptions,r.requestRawData=!!this.pixelHighlightOptions;const s=await this.layer.internalFetchImage(e,t,i,r);if(s.imageBitmap)return s.imageBitmap;const n=await this.layer.applyRenderer({...s.pixelData,isRawData:!!this.pixelHighlightOptions},{signal:r.signal}),o=s.pixelData.pixelBlock,a=n.pixelBlock;this.pixelHighlightOptions&&o&&a&&await this.layer.highlightPixels({pixelBlock:o,renderedPixelBlock:a,highlightOptions:this.pixelHighlightOptions});const l=new d(a,n.extent?.clone(),o);return l.filter=e=>this.layer.applyFilter(e),l}},t.__decorate([o.property()],e.default.prototype,"attached",void 0),t.__decorate([o.property()],e.default.prototype,"container",void 0),t.__decorate([o.property()],e.default.prototype,"layer",void 0),t.__decorate([o.property()],e.default.prototype,"strategy",void 0),t.__decorate([o.property()],e.default.prototype,"timeExtent",void 0),t.__decorate([o.property()],e.default.prototype,"view",void 0),t.__decorate([o.property()],e.default.prototype,"updateRequested",void 0),t.__decorate([o.property()],e.default.prototype,"updating",null),t.__decorate([o.property()],e.default.prototype,"pixelHighlightOptions",void 0),t.__decorate([o.property()],e.default.prototype,"type",void 0),e.default=t.__decorate([c.subclass("esri.views.2d.layers.imagery.ImageryView2D")],e.default),e.default})},"esri/layers/support/rasterFunctions/pixelUtils":function(){define(["exports","../../../core/mathUtils","../PixelBlock","../rasterFormats/pixelRangeUtils"],function(e,t,i,r){"use strict";function s(e){return null!=e&&e.pixels?.length>0}function n(e,t,r,s,n){const o=e.length,a=i.createEmptyBand(n,o);if(t)for(let i=0;i<o;i++)t[i]&&(a[i]=r[e[i]-s]);else for(let t=0;t<o;t++)a[t]=r[e[t]-s];return a}function o(e,t,i,r){const s=null!=i&&i.length>=2?new Set(i):null,n=1===i?.length?i[0]:null,o=!!t?.length;for(let i=0;i<e.length;i++)if(r[i]){const a=e[i];if(o){let e=!1;for(let i=0;i<t.length;i+=2)if(a>=t[i]&&a<=t[i+1]){e=!0;break}e||(r[i]=0)}r[i]&&(a===n||s?.has(a))&&(r[i]=0)}}function a(e,t){const i=e[0].length;for(let r=0;r<i;r++)if(t[r]){let i=!1;for(let t=0;t<e.length;t++)if(e[t][r]){i=!0;break}i||(t[r]=0)}}function l(e,t){const i=e[0].length;for(let r=0;r<i;r++)if(t[r]){let i=!1;for(let t=0;t<e.length;t++)if(0===e[t][r]){i=!0;break}i&&(t[r]=0)}}function c(e,t,i,r,s,n,o,a){return{xmin:s<=i*e?0:s<i*e+e?s-i*e:e,ymin:n<=r*t?0:n<r*t+t?n-r*t:t,xmax:s+o<=i*e?0:s+o<i*e+e?s+o-i*e:e,ymax:n+a<=r*t?0:n+a<r*t+t?n+a-r*t:t}}function h(e,t,i,r,s,n){const{width:o,height:a}=i.block,{x:l,y:h}=i.offset,{width:u,height:p}=i.mosaic,d=c(o,a,r,s,l,h,u,p);let f=0,m=0;if(n){const e=n.hasGCSSShiftTransform?360:n.halfWorldWidth??0,t=o*n.resolutionX,i=n.startX+r*t;i<e&&i+t>e?m=n.rightPadding:i>=e&&(f=n.leftMargin-n.rightPadding,m=0)}if(d.xmax-=m,"number"!=typeof t)for(let i=d.ymin;i<d.ymax;i++){const n=(s*a+i-h)*u+(r*o-l)+f,c=i*o;for(let i=d.xmin;i<d.xmax;i++)e[n+i]=t[c+i]}else for(let i=d.ymin;i<d.ymax;i++){const n=(s*a+i-h)*u+(r*o-l)+f;for(let i=d.xmin;i<d.xmax;i++)e[n+i]=t}}function u(e,t,r={}){const{clipOffset:n,clipSize:o,alignmentInfo:a,blockWidths:l}=r;if(l)return function(e,t,r){const n=e.find(e=>null!=e);if(null==n)return null;const o=e.some(e=>null==e||!!e.mask),{width:a,height:l}=t,c=o?new Uint8Array(a*l):null,{blockWidths:h}=r,u=[],p=n.getPlaneCount(),d=i.getPixelArrayConstructor(n.pixelType);if(o)for(let t=0,i=0;t<e.length;i+=h[t],t++){const r=e[t];if(!s(r))continue;const n=r.mask;for(let e=0;e<l;e++)for(let s=0;s<h[t];s++)c[e*a+s+i]=null==n?255:n[e*r.width+s]}const f=e.some(e=>e?.bandMasks&&e.bandMasks.length>1),m=f?[]:void 0,g=a*l;for(let t=0;t<p;t++){const i=new d(g),r=f?new Uint8Array(g):void 0;for(let n=0,o=0;n<e.length;o+=h[n],n++){const c=e[n];if(!s(c))continue;const u=c.pixels[t];if(null!=u){for(let e=0;e<l;e++)for(let t=0;t<h[n];t++)i[e*a+t+o]=u[e*c.width+t];if(r){const e=c.bandMasks?.[t]??c.mask;for(let t=0;t<l;t++)for(let i=0;i<h[n];i++)r[t*a+i+o]=e?e[t*c.width+i]:255}}}u.push(i),m&&r&&m.push(r)}const y=new i({width:a,height:l,mask:c,bandMasks:m,pixels:u,pixelType:n.pixelType});return y.updateStatistics(),y}(e,t,{blockWidths:l});const c=e.find(e=>s(e));if(null==c)return null;const u=o?o.width:t.width,p=o?o.height:t.height,d=c.width,f=c.height,m=t.width/d,g=t.height/f,y={offset:n||{x:0,y:0},mosaic:o||t,block:{width:d,height:f}},x=c.pixelType,w=i.getPixelArrayConstructor(x),_=c.pixels.length,b=[];let v,S;for(let t=0;t<_;t++){S=new w(u*p);for(let i=0;i<g;i++)for(let r=0;r<m;r++){const n=e[i*m+r];s(n)&&(v=n.pixels[t],h(S,v,y,r,i,a))}b.push(S)}const M=e.some(e=>null==e||null!=e.mask&&e.mask.length>0),P=e.some(e=>e?.bandMasks&&e.bandMasks.length>1),k=M?new Uint8Array(u*p):void 0,T=P?[]:void 0;if(k){for(let t=0;t<g;t++)for(let i=0;i<m;i++){const r=e[t*m+i],s=null!=r?r.mask:null;h(k,null!=s?s:r?255:0,y,i,t,a)}if(T)for(let t=0;t<_;t++){const i=new Uint8Array(u*p);for(let r=0;r<g;r++)for(let s=0;s<m;s++){const n=e[r*m+s],o=n?.bandMasks?.[t]??n?.mask;h(i,null!=o?o:n?255:0,y,s,r,a)}T.push(i)}}const R=new i({width:u,height:p,pixels:b,pixelType:x,bandMasks:T,mask:k});return R.updateStatistics(),R}function p(e){if(!s(e))return null;const t=e.clone(),{width:i,height:r,pixels:n}=e,o=n[0],a=t.pixels[0],l=e.mask;for(let e=2;e<r-1;e++){const t=new Map;for(let r=e-2;r<e+2;r++)for(let e=0;e<4;e++){const s=r*i+e;m(t,o[s],l?l[s]:1)}a[e*i]=d(t),a[e*i+1]=a[e*i+2]=a[e*i];let r=3;for(;r<i-1;r++){let s=(e-2)*i+r+1;m(t,o[s],l?l[s]:1),s=(e-1)*i+r+1,m(t,o[s],l?l[s]:1),s=e*i+r+1,m(t,o[s],l?l[s]:1),s=(e+1)*i+r+1,m(t,o[s],l?l[s]:1),s=(e-2)*i+r-3,f(t,o[s],l?l[s]:1),s=(e-1)*i+r-3,f(t,o[s],l?l[s]:1),s=e*i+r-3,f(t,o[s],l?l[s]:1),s=(e+1)*i+r-3,f(t,o[s],l?l[s]:1),a[e*i+r]=d(t)}a[e*i+r+1]=a[e*i+r]}for(let e=0;e<i;e++)a[e]=a[i+e]=a[2*i+e],a[(r-1)*i+e]=a[(r-2)*i+e];return t.updateStatistics(),t}function d(e){if(0===e.size)return 0;let t=0,i=-1,r=0;const s=e.keys();let n=s.next();for(;!n.done;)r=e.get(n.value),r>t&&(i=n.value,t=r),n=s.next();return i}function f(e,t,i){if(0===i)return;const r=e.get(t);1===r?e.delete(t):e.set(t,r-1)}function m(e,t,i){0!==i&&e.set(t,e.has(t)?e.get(t)+1:1)}function g(e,t,r){let{x:n,y:o}=t;const{width:a,height:l}=r;if(0===n&&0===o&&l===e.height&&a===e.width)return e;const{width:c,height:h}=e,u=Math.max(0,o),p=Math.max(0,n),d=Math.min(n+a,c),f=Math.min(o+l,h);if(d<0||f<0||!s(e))return null;n=Math.max(0,-n),o=Math.max(0,-o);const{pixels:m}=e,g=a*l,y=m.length,x=[];for(let t=0;t<y;t++){const r=m[t],s=i.createEmptyBand(e.pixelType,g);for(let e=u;e<f;e++){const t=e*c;let i=(e+o-u)*a+n;for(let e=p;e<d;e++)s[i++]=r[t+e]}x.push(s)}const w=new Uint8Array(g),_=e.mask;for(let e=u;e<f;e++){const t=e*c;let i=(e+o-u)*a+n;for(let e=p;e<d;e++)w[i++]=_?_[t+e]:1}const b=new i({width:r.width,height:r.height,pixelType:e.pixelType,pixels:x,mask:w});return b.updateStatistics(),b}function y(e,t=!0){if(!s(e))return null;const{pixels:r,width:n,height:o,mask:a,pixelType:l}=e,c=[],h=Math.round(n/2),u=Math.round(o/2),p=o-1,d=n-1;for(let e=0;e<r.length;e++){const s=r[e],a=i.createEmptyBand(l,h*u);let f=0;for(let e=0;e<o;e+=2)for(let i=0;i<n;i+=2){const r=s[e*n+i];if(t){const t=i===d?r:s[e*n+i+1],o=e===p?r:s[e*n+i+n],l=i===d?o:e===p?t:s[e*n+i+n+1];a[f++]=(r+t+o+l)/4}else a[f++]=r}c.push(a)}let f=null;if(null!=a){f=new Uint8Array(h*u);let e=0;for(let i=0;i<o;i+=2)for(let r=0;r<n;r+=2){const s=a[i*n+r];if(t){const t=r===d?s:a[i*n+r+1],o=i===p?s:a[i*n+r+n],l=r===d?o:i===p?t:a[i*n+r+n+1];f[e++]=s*t*o*l?1:0}else f[e++]=s}}return new i({width:h,height:u,pixelType:l,pixels:c,mask:f})}function x(e,t,i,r,s=0){const{width:n,height:o}=e,{width:a,height:l}=t,c=r.cols,h=r.rows,u=Math.ceil(a/c-.1/c),p=Math.ceil(l/h-.1/h);let d,f,m,g,y,x,w;const _=u*c,b=_*p*h,v=new Float32Array(b),S=new Float32Array(b),M=new Uint32Array(b),P=new Uint32Array(b);let k,T,R=0;for(let e=0;e<p;e++)for(let t=0;t<u;t++){d=12*(e*u+t),f=i[d],m=i[d+1],g=i[d+2],y=i[d+3],x=i[d+4],w=i[d+5];for(let i=0;i<h;i++){R=(e*h+i)*_+t*c,T=(i+.5)/h;for(let e=0;e<i;e++)k=(e+.5)/c,v[R+e]=(f*k+m*T+g)*n+s,S[R+e]=(y*k+x*T+w)*o+s,M[R+e]=Math.floor(v[R+e]),P[R+e]=Math.floor(S[R+e])}d+=6,f=i[d],m=i[d+1],g=i[d+2],y=i[d+3],x=i[d+4],w=i[d+5];for(let i=0;i<h;i++){R=(e*h+i)*_+t*c,T=(i+.5)/h;for(let e=i;e<c;e++)k=(e+.5)/c,v[R+e]=(f*k+m*T+g)*n+s,S[R+e]=(y*k+x*T+w)*o+s,M[R+e]=Math.floor(v[R+e]),P[R+e]=Math.floor(S[R+e])}}return{offsets_x:v,offsets_y:S,offsets_xi:M,offsets_yi:P,gridWidth:_}}e.approximateTransform=function(e,t,r,n,o="nearest"){if(!s(e))return null;"majority"===o&&(e=p(e));const{pixels:a,mask:l,bandMasks:c,pixelType:h}=e,u=e.width,d=e.height,f=i.getPixelArrayConstructor(h),m=a.length,{width:g,height:y}=t;let w=!1;for(let e=0;e<r.length;e+=3)-1===r[e]&&-1===r[e+1]&&-1===r[e+2]&&(w=!0);const{offsets_x:_,offsets_y:b,offsets_xi:v,offsets_yi:S,gridWidth:M}=x({width:u,height:d},t,r,n,"majority"===o?.5:0);let P;const k=(e,t,i,r)=>{const s=e instanceof Float32Array||e instanceof Float64Array?0:.5;for(let n=0;n<y;n++){P=n*M;for(let o=0;o<g;o++){if(_[P]<0||b[P]<0)e[n*g+o]=0;else if(r)e[n*g+o]=t[v[P]+S[P]*u];else{const r=Math.floor(_[P]),a=Math.floor(b[P]),l=Math.ceil(_[P]),c=Math.ceil(b[P]),h=_[P]-r,p=b[P]-a;if(!i||i[r+a*u]&&i[l+a*u]&&i[r+c*u]&&i[l+c*u]){const i=(1-h)*t[r+a*u]+h*t[l+a*u],d=(1-h)*t[r+c*u]+h*t[l+c*u];e[n*g+o]=(1-p)*i+p*d+s}else e[n*g+o]=t[v[P]+S[P]*u]}P++}}},T=[];let R;const A=c?.length===m,V=[];for(let e=0;e<m;e++){if(A){const t=new Uint8Array(g*y);k(t,c[e],c[e],!0),V.push(t)}R=new f(g*y),k(R,a[e],A?c[e]:l,"nearest"===o||"majority"===o),T.push(R)}const D=new i({width:g,height:y,pixelType:h,pixels:T,bandMasks:A?V:void 0});if(null!=l)D.mask=new Uint8Array(g*y),k(D.mask,l,l,!0);else if(w){D.mask=new Uint8Array(g*y);for(let e=0;e<g*y;e++)D.mask[e]=_[e]<0||b[e]<0?0:1}return D.updateStatistics(),D},e.clip=g,e.clipTile=function(e){const{pixelBlock:t,tileSize:i,level:r,row:n,col:o,useBilinear:a}=e;if(!s(t))return null;const{width:l,height:c}=i,h=2**r,u=h*l,p=h*c;let d=g(t,{y:n*p,x:o*u},{width:u,height:p});if(!d)return null;for(let e=r;e>0;e--)d=y(d,a);return d},e.colorize=function(e,t){if(!s(e))return e;if(!t||!t.indexedColormap&&!t.indexed2DColormap)return e;const i=e.clone(),r=i.pixels;let n=i.mask;const o=i.width*i.height;if(1!==r.length)return e;const{indexedColormap:a,indexed2DColormap:l,offset:c,alphaSpecified:h}=t,u=r[0],p=new Uint8Array(u.length),d=new Uint8Array(u.length),f=new Uint8Array(u.length);let m,g=0;if(a){const e=a.length-1;if(null!=n)for(let t=0;t<o;t++)n[t]&&(g=4*(u[t]-c),g<c||g>e?n[t]=0:(p[t]=a[g],d[t]=a[g+1],f[t]=a[g+2],n[t]=a[g+3]));else{n=new Uint8Array(o);for(let t=0;t<o;t++)g=4*(u[t]-c),g<c||g>e?n[t]=0:(p[t]=a[g],d[t]=a[g+1],f[t]=a[g+2],n[t]=a[g+3]);i.mask=n}}else if(l)if(null!=n)for(let e=0;e<o;e++)n[e]&&(m=l[u[e]],p[e]=m[0],d[e]=m[1],f[e]=m[2],n[e]=m[3]);else{n=new Uint8Array(o);for(let e=0;e<o;e++)m=l[u[e]],p[e]=m[0],d[e]=m[1],f[e]=m[2],n[e]=m[3];i.mask=n}return i.pixels=[p,d,f],i.statistics=null,i.pixelType="u8",i.maskIsAlpha=h,i},e.compositeBands=function(e){if(!e?.length||e.some(e=>!s(e)))return null;if(1===e.length)return e[0]?.clone()??null;const t=e,{width:r,height:n,pixelType:o}=t[0];if(t.some(e=>e.width!==r||e.height!==n))return null;const a=t.map(({mask:e})=>e).filter(e=>null!=e);let c=null;a.length&&(c=new Uint8Array(r*n),c.set(a[0]),a.length>1&&l(a.slice(1),c));const h=[];t.forEach(({pixels:e})=>h.push(...e));const u=t.map(({statistics:e})=>e).filter(e=>e?.length),p=[];return u.forEach(e=>p.push(...e)),new i({pixelType:o,width:r,height:n,mask:c,pixels:h,statistics:p.length?p:null})},e.convertPixelBlockToFeatures=function(e){const{pixelBlock:t,extent:i,fieldNames:r,skipFactor:s,skipSpatialReference:n=!1,pixelIdOffset:o=0}=e,a=[],{width:l,height:c,pixels:h,mask:u}=t,p=e.imageRowSize??l,d=i.width/l,f=i.height/c,m=h.length,g=Math.floor(s/2),{xmin:y,ymax:x}=i,w=n?void 0:i.spatialReference.toJSON();for(let e=g;e<c;e+=s)for(let t=g;t<l;t+=s){const i=e*l+t;if(!u||u[i]){const s={x:y+(t+.5)*d,y:x-(e+.5)*f,spatialReference:w},n={objectId:o+e*p+t};for(let e=0;e<m;e++)n[r[e+1]]=h[e][i];a.push({geometry:s,attributes:n})}}return a},e.countCategoricalPixels=function(e,t){const{width:i,height:r,pixels:s,mask:n}=e,o=s[0];let a=0;for(let e=0;e<r;e++){let r=e*i;for(let e=0;e<i;e++,r++)n&&!n[r]||(t[o[r]]++,a++)}return a},e.createColormapLUT=function(e){if(!e)return;const t=e.colormap;if(!t||0===t.length)return;const i=t.sort((e,t)=>e[0]-t[0]),r=i[0][0]<0?i[0][0]:0,s=Math.max(256,i[i.length-1][0]-r+1),n=new Uint8Array(4*s),o=[],a=5===i[0].length;if(s>65536)return i.forEach(e=>{o[e[0]-r]=a?e.slice(1):e.slice(1).concat([255])}),{indexed2DColormap:o,offset:r,alphaSpecified:a};if(e.fillUnspecified){let e=i[0];for(let t=e[0]-r,o=0;t<s;t++)n[4*t]=e[1],n[4*t+1]=e[2],n[4*t+2]=e[3],n[4*t+3]=a?e[4]:255,t===e[0]-r&&(e=o===i.length-1?e:i[++o])}else for(let e=0;e<i.length;e++){const t=i[e],s=4*(t[0]-r);n[s]=t[1],n[s+1]=t[2],n[s+2]=t[3],n[s+3]=a?t[4]:255}return{indexedColormap:n,offset:r,alphaSpecified:a}},e.createMaskLUT=function(e,t,i){if("u8"!==e&&"s8"!==e&&"u16"!==e&&"s16"!==e)return null;const r=e.includes("16")?65536:256,s=e.includes("s")?-r/2:0,n=new Uint8Array(r);if(t)for(let e=0;e<t.length;e++){const i=Math.ceil(t[2*e]-s),r=Math.floor(t[2*e+1]-s);for(let e=i;e<=r;e++)n[e]=255}else n.fill(255);if(i)for(let e=0;e<i.length;e++)n[i[e]-s]=0;return{lut:n,offset:s}},e.createRangeMaps=function(e,i,r=!1){const s=1e-5,n=new Float32Array(27),o=i.length;for(let a=0;a<9;a++)n[3*a]=e[2*a]??t.numberMaxFloat32-1,n[3*a+1]=e[2*a+1]??t.numberMaxFloat32,n[3*a+2]=i[a]??0,a<o&&(a>0&&(n[3*a]-=s),e[2*a+1]!==e[2*a]&&(a<o-1||!r)&&(n[3*a+1]-=s));return n},e.createRemapLUT=function(e){const{srcPixelType:t,inputRanges:s,outputValues:n,allowUnmatched:o,noDataRanges:a,isLastInputRangeInclusive:l,outputPixelType:c}=e;if("u8"!==t&&"s8"!==t&&"u16"!==t&&"s16"!==t)return null;const h=t.includes("16")?65536:256,u=t.includes("s")?-h/2:0,p=i.createEmptyBand(c,h),d=new Uint8Array(h);o&&d.fill(255);const[f,m]=r.getPixelValueRange(c);if(s?.length&&n?.length){const e=1e-6,t=s.map(t=>t-e);t[0]=s[0],l&&(t[t.length-1]=s[s.length-1]);for(let e=0;e<t.length;e++){const i=n[e]>m?m:n[e]<f?f:n[e],r=Math.ceil(t[2*e]-u),o=s[2*e+1]===s[2*e]?r:Math.floor(t[2*e+1]-u);for(let e=r;e<=o;e++)p[e]=i,d[e]=255}}if(a?.length)for(let e=0;e<a.length;e++){const t=Math.ceil(a[2*e]-u),i=Math.floor(a[2*e+1]-u);for(let e=t;e<=i;e++)d[e]=0}return{lut:p,offset:u,mask:d}},e.extractBands=function(e,t){return t?.length&&s(e)?e.extractBands(t):e},e.getClipBounds=c,e.getLocalArithmeticNorthRotations=function(e,t){const{coefficients:i,spacing:r}=t,{offsets_x:s,offsets_y:n,gridWidth:o}=x(e,e,i,{rows:r[0],cols:r[1]}),{width:a,height:l}=e,c=new Float32Array(a*l),h=180/Math.PI;for(let e=0;e<l;e++)for(let t=0;t<a;t++){const i=e*o+t,r=0===e?i:i-o,u=e===l-1?i:i+o,p=s[r]-s[u],d=n[u]-n[r];if(isNaN(p)||isNaN(d))c[e*a+t]=90;else{let i=Math.atan2(d,p)*h;i=(360+i)%360,c[e*a+t]=i}}return c},e.getValidPixels=function(e,t){const{width:i,height:r,pixels:s,mask:n}=e,o=t.width/i,a=t.height/r,{xmin:l,ymax:c}=t,h=t.spatialReference.toJSON(),u=[];for(let e=0;e<r;e++)for(let t=0;t<i;t++){const r=e*i+t;if(!n||n[r]){const i={x:l+(t+.5)*o,y:c-(e+.5)*a,spatialReference:h},n=s.map(e=>e[r]);u.push({location:i,value:n})}}return u},e.highlightPixels=function(e,t,i){if(!s(e))return;const{width:r,height:n,pixels:o,mask:a}=e,l=r*n,c=new Uint8Array(l),{ranges:h,color:u}=i,p=o[i.bandId];if(!p)return;const d=1===h.length,[f,m]=h[0];for(let e=0;e<l;e++)if(!a||a[e]){const t=p[e];if(d)t>=f&&t<=m&&(c[e]=1);else for(let i=0;i<h.length;i++)if(t>=h[i][0]&&t<=h[i][1]){c[e]=1;break}}const{pixels:g}=t;if(1===g.length&&(g[1]=g[0].slice(),g[2]=g[0].slice()),t.mask){const e=t.mask;for(let t=0;t<l;t++)e[t]&&(e[t]=255,c[t]&&(g[0][t]=u[0],g[1][t]=u[1],g[2][t]=u[2],e[t]=u[3]))}else{const e=new Uint8Array(l).fill(255);for(let t=0;t<l;t++)c[t]&&(g[0][t]=u[0],g[1][t]=u[1],g[2][t]=u[2],e[t]=u[3]);t.mask=e}t.maskIsAlpha=!0},e.interpolateOffsets=x,e.isValidPixelBlock=s,e.lookupBandValues=n,e.lookupPixels=function(e,t){if(!s(e))return null;const{pixels:r,mask:o}=e,a=r.length;let l=t.lut;const{offset:c}=t;l&&1===l[0].length&&(l=r.map(()=>l));const h=[],u=t.outputPixelType||"u8";for(let e=0;e<a;e++){const t=n(r[e],o,l[e],c||0,u);h.push(t)}const p=new i({width:e.width,height:e.height,pixels:h,mask:o,pixelType:u});return p.updateStatistics(),p},e.mask=function(e,t){if(!s(e))return null;const{width:r,height:c,pixels:h}=e,u=r*c,p=new Uint8Array(u);e.mask?p.set(e.mask):p.fill(255);const d=h.length,{includedRanges:f,noDataValues:m,outputPixelType:g,matchAll:y,lookups:x}=t;if(x){const e=[];for(let t=0;t<d;t++){const i=x[t],r=n(h[t],p,i.lut,i.offset||0,"u8");e.push(r)}1===e.length?p.set(e[0]):y?a(e,p):l(e,p)}else if(y){const e=[];for(let t=0;t<d;t++){const i=new Uint8Array(u);i.set(p),o(h[t],f?.slice(2*t,2*t+2),m?.[t],i),e.push(i)}1===e.length?p.set(e[0]):a(e,p)}else for(let e=0;e<d;e++)o(h[e],f?.slice(2*e,2*e+2),m?.[e],p);return new i({width:r,height:c,pixelType:g,pixels:h,mask:p})},e.maxMapSizeGpu=9,e.mosaic=u,e.mosaicPixelData=function(e,t){if(!e||0===e.length)return null;const i=e.find(e=>e.pixelBlock);if(null==i?.pixelBlock)return null;const r=(i.extent.xmax-i.extent.xmin)/i.pixelBlock.width,s=(i.extent.ymax-i.extent.ymin)/i.pixelBlock.height,n=.01*Math.min(r,s),o=e.sort((e,t)=>Math.abs(e.extent.ymax-t.extent.ymax)>n?t.extent.ymax-e.extent.ymax:Math.abs(e.extent.xmin-t.extent.xmin)>n?e.extent.xmin-t.extent.xmin:0),a=Math.min.apply(null,o.map(e=>e.extent.xmin)),l=Math.min.apply(null,o.map(e=>e.extent.ymin)),c=Math.max.apply(null,o.map(e=>e.extent.xmax)),h=Math.max.apply(null,o.map(e=>e.extent.ymax)),p={x:Math.round((t.xmin-a)/r),y:Math.round((h-t.ymax)/s)},d={width:Math.round((c-a)/r),height:Math.round((h-l)/s)},f={width:Math.round((t.xmax-t.xmin)/r),height:Math.round((t.ymax-t.ymin)/s)};return Math.round(d.width/i.pixelBlock.width)*Math.round(d.height/i.pixelBlock.height)!==o.length||p.x<0||p.y<0||d.width<f.width||d.height<f.height?null:{extent:t,pixelBlock:u(o.map(e=>e.pixelBlock),d,{clipOffset:p,clipSize:f})}},e.remap=function(e,t){if(!s(e))return null;const{width:n,height:o}=e,{inputRanges:a,outputValues:l,outputPixelType:c,noDataRanges:h,allowUnmatched:u,replacementValue:p,isLastInputRangeInclusive:d}=t,f=e.pixels[0],m=i.createEmptyBand(c,f.length),g=e.mask,y=new Uint8Array(n*o);g?y.set(g):y.fill(255);const x=e.pixelType.startsWith("f")?1e-6:0,w=a.map(e=>e-x);w[0]=a[0],w[w.length-1]=a[a.length-1]+(d?1e-6:0);const _=a.length/2,[b,v]=r.getPixelValueRange(c);for(let e=0;e<o;e++)for(let t=0;t<n;t++){const i=e*n+t;if(y[i]){const e=f[i];let t=!1;for(let r=_-1;r>=0;r--)if(e===a[2*r]||e>w[2*r]&&e<w[2*r+1]){m[i]=l[r],t=!0;break}t||(u?m[i]=e>v?v:e<b?b:p??e:y[i]=0)}}const S=h?.length;if(S)for(let e=0;e<o;e++)for(let t=0;t<n;t++){const i=e*n+t;if(!g||g[i]){const e=f[i];for(let t=0;t<S;t+=2)if(e>=h[t]&&e<=h[t+1]){m[i]=0,y[i]=0;break}}}return new i({width:n,height:o,pixelType:c,pixels:[m],mask:y})},e.remapColor=function(e,t){if(!s(e))return null;const i=e.clone(),{pixels:r}=i,n=i.width*i.height,o=t.length,a=Math.floor(o/2),l=t[Math.floor(a)],c=r[0],h=new Uint8Array(n),u=new Uint8Array(n),p=new Uint8Array(n);let d=i.mask;const f=4===t[0].mappedColor.length;d||(d=new Uint8Array(n),d.fill(f?255:1),i.mask=d);for(let e=0;e<n;e++)if(d[e]){const i=c[e];let r=!1,s=a,n=l,f=0,m=o-1;for(;m-f>1;){if(i===n.value){r=!0;break}i>n.value?f=s:m=s,s=Math.floor((f+m)/2),n=t[Math.floor(s)]}r||(i===t[f].value?(n=t[f],r=!0):i===t[m].value?(n=t[m],r=!0):i<t[f].value?r=!1:i>t[f].value&&(i<t[m].value?(n=t[f],r=!0):m===o-1?r=!1:(n=t[m],r=!0))),r?(h[e]=n.mappedColor[0],u[e]=n.mappedColor[1],p[e]=n.mappedColor[2],d[e]=n.mappedColor[3]):h[e]=u[e]=p[e]=d[e]=0}return i.pixels=[h,u,p],i.mask=d,i.pixelType="u8",i.maskIsAlpha=f,i},e.resampleByMajority=p,e.setValidBoundary=function(e,t,i){if(!s(e))return null;const{width:r,height:n}=e,o=t.x,a=t.y,l=i.width+o,c=i.height+a;if(o<0||a<0||l>r||c>n)return e;if(0===o&&0===a&&l===r&&c===n)return e;e.mask||(e.mask=new Uint8Array(r*n));const h=e.mask;for(let e=0;e<n;e++){const t=e*r;for(let i=0;i<r;i++)h[t+i]=e<a||e>=c||i<o||i>=l?0:1}return e.updateStatistics(),e},e.split=function(e,t,i=0,r=!0){if(!s(e))return null;const{width:n,height:o}=t;let{width:a,height:l}=e;const c=new Map,h={x:0,y:0},u=1+i;let p=e;for(let e=0;e<u;e++){const i=Math.ceil(a/n),s=Math.ceil(l/o);for(let r=0;r<s;r++){h.y=r*o;for(let s=0;s<i;s++){h.x=s*n;const i=g(p,h,t);c.set(`${e}/${r}/${s}`,i)}}e<u-1&&(p=y(p,r)),a=Math.round(a/2),l=Math.round(l/2)}return c},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/PixelBlock":function(){define(["exports","../../chunks/tslib.es6","../../core/Error","../../core/JSONSupport","../../core/lang","../../core/Logger","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/accessorSupport/decorators/subclass","./SimpleBandStatistics","./rasterFormats/pixelRangeUtils"],function(e,t,i,r,s,n,o,a,l,c,h){"use strict";var u;return e.default=u=class extends r.JSONSupport{static createEmptyBand(e,t){return new(u.getPixelArrayConstructor(e))(t)}static combineBandMasks(e){if(e.length<2)return e[0];const t=e[0].length,i=new Uint8Array(t).fill(255);for(let r=0;r<e.length;r++){const s=e[r];for(let e=0;e<t;e++)s[e]||(i[e]=0)}return i}static getPixelArrayConstructor(e){let t;switch(e){case"u1":case"u2":case"u4":case"u8":t=Uint8Array;break;case"u16":t=Uint16Array;break;case"u32":t=Uint32Array;break;case"s8":t=Int8Array;break;case"s16":t=Int16Array;break;case"s32":t=Int32Array;break;case"f32":case"c64":case"c128":case"unknown":t=Float32Array;break;case"f64":t=Float64Array}return t}constructor(e){super(e),this.width=null,this.height=null,this.pixelType="f32",this.validPixelCount=null,this.mask=null,this.maskIsAlpha=!1,this.premultiplyAlpha=!1,this.statistics=null,this.depthCount=1}castPixelType(e){if(!e)return"f32";let t=e.toLowerCase();return["u1","u2","u4"].includes(t)?t="u8":["unknown","u8","s8","u16","s16","u32","s32","f32","f64"].includes(t)||(t="f32"),t}getPlaneCount(){return this.pixels?.length}addData(e){if(!e.pixels||e.pixels.length!==this.width*this.height)throw new i("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");this.pixels||(this.pixels=[]),this.statistics||(this.statistics=[]),this.pixels.push(e.pixels),this.statistics.push(e.statistics??new c.SimpleBandStatistics)}getAsRGBA(){const e=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case"s8":case"s16":case"u16":case"s32":case"u32":case"f32":case"f64":this._fillFromNon8Bit(e);break;default:this._fillFrom8Bit(e)}return new Uint8ClampedArray(e)}getAsRGBAFloat(){const e=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(e),e}updateStatistics(){if(!this.pixels)return;this.statistics=this.pixels.map(e=>function(e,t){let i=1/0,r=-1/0;const s=e.length;let n,o=0;if(null!=t)for(n=0;n<s;n++)t[n]&&(o=e[n],i=o<i?o:i,r=o>r?o:r);else for(n=0;n<s;n++)o=e[n],i=o<i?o:i,r=o>r?o:r;return new c.SimpleBandStatistics(i,r)}(e,this.mask));const e=this.mask;let t=0;if(null!=e)for(let i=0;i<e.length;i++)e[i]&&t++;else t=this.width*this.height;this.validPixelCount=t}clamp(e){if(!e||"f64"===e||"f32"===e||!this.pixels)return;const[t,i]=h.getPixelValueRange(e),r=this.pixels,s=this.width*this.height,n=r.length;let o,a,l;const c=[];for(let h=0;h<n;h++){l=u.createEmptyBand(e,s),o=r[h];for(let e=0;e<s;e++)a=o[e],l[e]=a>i?i:a<t?t:a;c.push(l)}this.pixels=c,this.pixelType=e}extractBands(e){const{pixels:t,statistics:i}=this;if(null==e||0===e.length||!t||0===t.length)return this;const r=t.length,s=e.some(e=>e>=t.length),n=r===e.length&&!e.some((e,t)=>e!==t);if(s||n)return this;const o=this.bandMasks?.length===r?e.map(e=>this.bandMasks[e]):void 0;let{mask:a,validPixelCount:l}=this;const{width:c,height:h}=this;return o?.length&&(a=u.combineBandMasks(o),l=a.filter(e=>!!e).length),new u({pixelType:this.pixelType,width:c,height:h,mask:a,bandMasks:o,validPixelCount:l,maskIsAlpha:this.maskIsAlpha,pixels:e.map(e=>t[e]),statistics:i&&e.map(e=>i[e])})}clone(){const e=new u({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount,premultiplyAlpha:this.premultiplyAlpha,depthCount:this.depthCount});let t;null!=this.mask&&(e.mask=new Uint8Array(this.mask)),this.noDataValues&&(e.noDataValues=[...this.noDataValues]),this.bandMasks&&(e.bandMasks=this.bandMasks.map(e=>new Uint8Array(e)));const i=u.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){e.pixels=[];const r=!!this.pixels[0].slice;for(t=0;t<this.pixels.length;t++)e.pixels[t]=r?this.pixels[t].slice():new i(this.pixels[t])}if(this.statistics)for(e.statistics=[],t=0;t<this.statistics.length;t++)e.statistics[t]=s.clone(this.statistics[t]);return e}getTransferableObject(){const{pixels:e,bandMasks:t,mask:i}=this;this.pixels=[],this.bandMasks=void 0,this.mask=void 0;const r=this.toJSON();this.pixels=e,this.bandMasks=t,this.mask=i,r.pixels=e?[...e]:e,r.bandMasks=t?[...t]:t,r.mask=i;const s=[];return[...e??[],i,...t??[]].filter(e=>null!=e&&ArrayBuffer.isView(e)).forEach(e=>{e&&!s.includes(e.buffer)&&s.push(e.buffer)}),{pixelBlock:r,transferList:s}}_fillFrom8Bit(e){const{mask:t,maskIsAlpha:i,premultiplyAlpha:r,pixels:s}=this;if(!e||!s?.length)return void n.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");let o,a,l,c;o=a=l=s[0],s.length>=3?(a=s[1],l=s[2]):2===s.length&&(a=s[1]);const h=new Uint32Array(e),u=this.width*this.height;if(o.length===u)if(null!=t&&t.length===u)if(i)for(c=0;c<u;c++){const e=t[c];if(e){const t=e/255;h[c]=r?e<<24|l[c]*t<<16|a[c]*t<<8|o[c]*t:e<<24|l[c]<<16|a[c]<<8|o[c]}}else for(c=0;c<u;c++)t[c]&&(h[c]=255<<24|l[c]<<16|a[c]<<8|o[c]);else for(c=0;c<u;c++)h[c]=255<<24|l[c]<<16|a[c]<<8|o[c];else n.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.")}_fillFromNon8Bit(e){const{pixels:t,mask:i,statistics:r}=this;if(!e||!t?.length)return void n.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");const s=this.pixelType;let o=1,a=0,l=1;if(r&&r.length>0){for(const e of r)if(null!=e.minValue&&(a=Math.min(a,e.minValue)),null!=e.maxValue&&null!=e.minValue){const t=e.maxValue-e.minValue;l=Math.max(l,t)}o=255/l}else{let e=255;"s8"===s?(a=-128,e=127):"u16"===s?e=65535:"s16"===s?(a=-32768,e=32767):"u32"===s?e=4294967295:"s32"===s?(a=-2147483648,e=2147483647):"f32"===s?(a=-34e38,e=34e38):"f64"===s&&(a=-Number.MAX_VALUE,e=Number.MAX_VALUE),o=255/(e-a)}const c=new Uint32Array(e),h=this.width*this.height;let u,p,d,f,m;if(u=p=d=t[0],u.length!==h)return n.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(t.length>=2)if(p=t[1],t.length>=3&&(d=t[2]),null!=i&&i.length===h)for(f=0;f<h;f++)i[f]&&(c[f]=255<<24|(d[f]-a)*o<<16|(p[f]-a)*o<<8|(u[f]-a)*o);else for(f=0;f<h;f++)c[f]=255<<24|(d[f]-a)*o<<16|(p[f]-a)*o<<8|(u[f]-a)*o;else if(null!=i&&i.length===h)for(f=0;f<h;f++)m=(u[f]-a)*o,i[f]&&(c[f]=255<<24|m<<16|m<<8|m);else for(f=0;f<h;f++)m=(u[f]-a)*o,c[f]=255<<24|m<<16|m<<8|m}_fillFrom32Bit(e){const{pixels:t,mask:i}=this;if(!e||!t?.length)return n.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");let r,s,o,a;r=s=o=t[0],t.length>=3?(s=t[1],o=t[2]):2===t.length&&(s=t[1]);const l=this.width*this.height;if(r.length!==l)return n.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");let c=0;if(null!=i&&i.length===l)for(a=0;a<l;a++)e[c++]=r[a],e[c++]=s[a],e[c++]=o[a],e[c++]=1&i[a];else for(a=0;a<l;a++)e[c++]=r[a],e[c++]=s[a],e[c++]=o[a],e[c++]=1}},t.__decorate([o.property({json:{write:!0}})],e.default.prototype,"width",void 0),t.__decorate([o.property({json:{write:!0}})],e.default.prototype,"height",void 0),t.__decorate([o.property({json:{write:!0}})],e.default.prototype,"pixelType",void 0),t.__decorate([a.cast("pixelType")],e.default.prototype,"castPixelType",null),t.__decorate([o.property({json:{write:!0}})],e.default.prototype,"validPixelCount",void 0),t.__decorate([o.property({json:{write:!0}})],e.default.prototype,"mask",void 0),t.__decorate([o.property({json:{write:!0}})],e.default.prototype,"maskIsAlpha",void 0),t.__decorate([o.property({json:{write:!0}})],e.default.prototype,"pixels",void 0),t.__decorate([o.property()],e.default.prototype,"premultiplyAlpha",void 0),t.__decorate([o.property({json:{write:!0}})],e.default.prototype,"statistics",void 0),t.__decorate([o.property({json:{write:!0}})],e.default.prototype,"depthCount",void 0),t.__decorate([o.property({json:{write:!0}})],e.default.prototype,"noDataValues",void 0),t.__decorate([o.property({json:{write:!0}})],e.default.prototype,"bandMasks",void 0),e.default=u=t.__decorate([l.subclass("esri.layers.support.PixelBlock")],e.default),e.default})},"esri/layers/support/SimpleBandStatistics":function(){define(["exports"],function(e){"use strict";e.SimpleBandStatistics=class{constructor(e=null,t=null,i=null){this.minValue=e,this.maxValue=t,this.noDataValue=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/rasterFormats/pixelRangeUtils":function(){define(["exports"],function(e){"use strict";const t={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34028234663852886e22,34028234663852886e22],f64:[-Number.MAX_VALUE,Number.MAX_VALUE],unknown:void 0,c64:void 0,c128:void 0};function i(e){return t[e]??[-34028234663852886e22,34028234663852886e22]}const r={u1:1,u2:1,u4:1,u8:1,s8:1,u16:2,s16:2,u32:4,s32:4,f32:4,f64:8,unknown:4,c64:16,c128:32};function s(e){return r[e]}function n(e){return(e?.startsWith("s")||e?.startsWith("u"))??!1}e.clipBandToPixelTypeRange=function(e,t,r,s){let[o,a]=i(r);const l=n(r);return l&&(o-=1e-5,a+=1e-5),l?r.startsWith("u")?function(e,t,i,r){const[s,n]=r;for(let r=0;r<t.length;r++)if(t[r]){const o=e[r];o<s||o>n?t[r]=0:i[r]=o+.5|0}}(e,t,s,[o,a]):function(e,t,i,r){const[s,n]=r;for(let r=0;r<t.length;r++)if(t[r]){const o=e[r];o<s||o>n?t[r]=0:i[r]=o+(o>0?.5:-.5)|0}}(e,t,s,[o,a]):function(e,t,i,r){const[s,n]=r;for(let r=0;r<t.length;r++)if(t[r]){const o=e[r];o<s||o>n?t[r]=0:i[r]=o}}(e,t,s,[o,a])},e.convertNoDataToMask=function(e,t,r){if(e.depthCount&&e.depthCount>1)return;const{pixels:s,statistics:n,pixelType:o}=e,a=s[0].length,l=e.bandMasks??[],c=e.mask??new Uint8Array(a).fill(255),h="f32"===o||"f64"===o,u=i(o);let p=!1;for(let e=0;e<s.length;e++){const i="number"==typeof t?t:t[e];if(null==i)continue;const a=n?.[e]?.minValue??u[0],d=n?.[e]?.maxValue??u[1];if(a>i+Number.EPSILON||d<i-Number.EPSILON)continue;const f=l[e]||c.slice(),m=s[e],g=r?.customFloatTolerance;if(h&&0!==g){let e=g;e||(e=Math.abs(i)>=9999999e31?2e-7*Math.abs(i):"f32"===o?2**-23:Number.EPSILON);for(let t=0;t<m.length;t++)f[t]&&Math.abs(m[t]-i)<e&&(m[t]=0,f[t]=0,c[t]=0,p=!0)}else for(let e=0;e<m.length;e++)f[e]&&m[e]===i&&(m[e]=0,f[e]=0,c[e]=0,p=!0);l[e]=f}if(p){const t=e.bandMasks||e.pixels.length>1?l:null;r?.matchAllNoData?e.mask=t&&t.length>1?function(e){if(e.length<2)return e[0];const t=e[0].length,i=new Uint8Array(t).fill(0);for(let r=0;r<e.length;r++){const s=e[r];for(let e=0;e<t;e++)s[e]&&(i[e]=255)}return i}(t):c:(e.bandMasks=t,e.mask=c)}p&&"updateStatistics"in e&&e.updateStatistics()},e.fixNaN=function(e,t){for(let i=0;i<t.length;i++)t[i]&&isNaN(e[i])&&(t[i]=0,e[i]=0)},e.getByteCount=s,e.getBytesPerPixel=function(e){return s(e.pixelType)*e.bandCount},e.getIntegerPixelType=function(e,t){return null==e||null==t?"s32":e<0?e>=-128&&t<128?"s8":e>=-32768&&t<32768?"s16":"s32":t<256?"u8":t<65536?"u16":"u32"},e.getPixelValueRange=i,e.isIntegerPixelType=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/layers/support/ExportStrategy":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/support/TileInfo","../../viewStateUtils","../../engine/Bitmap","../../tiling/TileInfoView","../../tiling/TileKey"],function(e,t,i,r,s,n,o,a,l,c,h,u,p,d,f,m){"use strict";const g=c.create(),y=[0,0],x=new m(0,0,0,0);return e.default=class extends i{constructor(e){super(e),this._imagePromise=null,this.bitmaps=[],this.hidpi=!1,this.imageMaxWidth=2048,this.imageMaxHeight=2048,this.imageRotationSupported=!1,this.imageNormalizationSupported=!1,this.update=s.debounce(async(e,t)=>{if(s.throwIfAborted(t),!e.stationary||this.destroyed)return;const i=e.state,r=h.getInfo(i.spatialReference),n=this.hidpi?e.pixelRatio:1,o=i.worldScreenWidth>0,a=o&&this.imageNormalizationSupported&&i.worldScreenWidth<i.size[0],l=Math.round((this.imageMaxWidth??0)/n),c=Math.round((this.imageMaxHeight??0)/n);a?(y[0]=i.worldScreenWidth,y[1]=i.size[1]):this.imageRotationSupported?(y[0]=i.size[0],y[1]=i.size[1]):p.getOuterSize(y,i);const u=Math.floor(y[0])>l||Math.floor(y[1])>c,d=r&&(i.extent.xmin<r.valid[0]||i.extent.xmax>r.valid[1]),f=!this.imageNormalizationSupported&&d,m=!u&&!f,g=this.imageRotationSupported?i.rotation:0,x=this.container.children.slice();if(m){const e=a?i.paddedViewState.center:i.center;this._imagePromise=this._singleExport(i,y,e,i.resolution,g,n,t)}else{let e=Math.min(l,c);o&&(e=Math.min(i.worldScreenWidth,e),e=Math.round(i.worldScreenWidth/Math.ceil(i.worldScreenWidth/e))),this._imagePromise=this._tiledExport(i,e,n,t)}try{const e=await this._imagePromise??[];s.throwIfAborted(t);const i=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=e;for(const t of x)e.includes(t)||i.push(t.fadeOut().then(()=>{t.remove(),t.destroy()}));for(const t of e)i.push(t.fadeIn());await Promise.all(i)}catch(e){this._imagePromise=null,s.throwIfAbortError(e)}},5e3),this.updateExports=s.debounce(async e=>{const t=[];for(const i of this.container.children){if(!i.visible||!i.stage)return;t.push(e(i).then(()=>{i.invalidateTexture(),i.requestRender()}))}this._imagePromise=s.eachAlways(t).then(()=>this._imagePromise=null),await this._imagePromise})}destroy(){this.bitmaps.forEach(e=>e.destroy()),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(e,t,i,r,n,o){const a=await this.fetchSource(e,Math.floor(t*n),Math.floor(i*n),{rotation:r,pixelRatio:n,signal:o});s.throwIfAborted(o);const l=new d.Bitmap(null,!0);return l.x=e.xmin,l.y=e.ymax,l.resolution=e.width/t,l.rotation=r,l.pixelRatio=n,l.opacity=0,this.container.addChild(l),await l.setSourceAsync(a,o),s.throwIfAborted(o),l}async _singleExport(e,t,i,r,s,n,o){p.getBBox(g,i,r,t);const a=c.toExtent(g,e.spatialReference);return[await this._export(a,t[0],t[1],s,n,o)]}_tiledExport(e,t,i,r){const s=u.create({size:t,spatialReference:e.spatialReference,scales:[e.scale]}),n=new f(s),o=n.getTileCoverage(e);if(!o)return null;const a=[];return o.forEach((s,o,l,h)=>{x.set(s,o,l,0),n.getTileBounds(g,x);const u=c.toExtent(g,e.spatialReference);a.push(this._export(u,t,t,0,i,r).then(e=>(0!==h&&(x.set(s,o,l,h),n.getTileBounds(g,x),e.x=g[0],e.y=g[3]),e)))}),Promise.all(a)}},t.__decorate([n.property()],e.default.prototype,"_imagePromise",void 0),t.__decorate([n.property()],e.default.prototype,"bitmaps",void 0),t.__decorate([n.property()],e.default.prototype,"container",void 0),t.__decorate([n.property()],e.default.prototype,"fetchSource",void 0),t.__decorate([n.property()],e.default.prototype,"hidpi",void 0),t.__decorate([n.property()],e.default.prototype,"imageMaxWidth",void 0),t.__decorate([n.property()],e.default.prototype,"imageMaxHeight",void 0),t.__decorate([n.property()],e.default.prototype,"imageRotationSupported",void 0),t.__decorate([n.property()],e.default.prototype,"imageNormalizationSupported",void 0),t.__decorate([n.property()],e.default.prototype,"requestUpdate",void 0),t.__decorate([n.property()],e.default.prototype,"updating",null),e.default=t.__decorate([l.subclass("esri.views.2d.layers.support.ExportStrategy")],e.default),e.default})},"esri/views/2d/viewStateUtils":function(){define(["exports"],function(e){"use strict";const t=Math.PI/180;e.getBBox=function(e,t,i,r){const[s,n]=t,[o,a]=r,l=.5*i;return e[0]=s-l*o,e[1]=n-l*a,e[2]=s+l*o,e[3]=n+l*a,e},e.getOuterSize=function(e,i){const r=i.rotation*t,s=Math.abs(Math.cos(r)),n=Math.abs(Math.sin(r)),[o,a]=i.size;return e[0]=Math.round(a*n+o*s),e[1]=Math.round(a*s+o*n),e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/layers/imagery/VectorFieldView2D":function(){define(["exports","../../../../chunks/tslib.es6","../../../../Graphic","../../../../request","../../../../core/Accessor","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../geometry/support/spatialReferenceUtils","../../../../layers/support/rasterFunctions/rasterProjectionHelper","../../../../layers/support/rasterFunctions/vectorFieldUtils","../../engine/imagery/RasterVFContainer","./ImageryVFStrategy"],function(e,t,i,r,s,n,o,a,l,c,h,u,p,d,f,m,g,y){"use strict";return e.default=class extends s{constructor(){super(...arguments),this.attached=!1,this.container=new g.RasterVFContainer,this.type="imageryVF",this._dataParameters={exportParametersVersion:0,bbox:"",symbolTileSize:0,time:""},this._fetchpixels=async(e,t,i,r)=>{const s=await this._projectFullExtentPromise,{layer:n}=this,{symbolTileSize:o}=n.renderer,{extent:a,width:l,height:c}=m.snapImageToSymbolTile(e,t,i,o,s);if(null!=s&&!s.intersects(e))return{extent:a,pixelBlock:null};const h={bbox:`${a.xmin}, ${a.ymin}, ${a.xmax}, ${a.ymax}`,exportParametersVersion:n.exportImageServiceParameters.version,symbolTileSize:o,time:JSON.stringify(this.timeExtent||"")};if(this._canReuseVectorFieldData(h)){const e=this.getPixelData();if(null!=e&&`${e.extent.xmin}, ${e.extent.ymin}, ${e.extent.xmax}, ${e.extent.ymax}`===h.bbox)return e}const{pixelBlock:u}=await n.fetchPixels(a,l,c,{timeExtent:this.timeExtent,interpolation:n.interpolation,signal:r});if(this._dataParameters=h,null==u)return{extent:a,pixelBlock:null};const{dataType:p}=n.rasterInfo;return{extent:a,pixelBlock:"vector-uv"===p&&u?await n.convertVectorFieldData(u,"vector-uv",{signal:r}):u}}}get updating(){return!this.attached||this._strategy.updating}attach(){this._projectFullExtentPromise=this._getProjectedFullExtent(this.view.spatialReference),this._strategy=new y({container:this.container,fetchPixels:this._fetchpixels}),this.addHandles(a.watch(()=>this.layer.renderer,e=>this._updateSymbolizerParams(e),a.syncAndInitial),"attach")}detach(){this._strategy.destroy(),this.container.children.forEach(e=>e.destroy()),this.container.removeAllChildren(),this.removeHandles("attach"),this._strategy=this.container=this._projectFullExtentPromise=null}getPixelData(){const e=this.container.children[0]?.rawPixelData;if(this.updating||!e)return null;const{extent:t,pixelBlock:i}=e;return{extent:t,pixelBlock:i}}hitTest(e){return new i({attributes:{},geometry:e.clone(),layer:this.layer})}update(e){this._strategy.update(e,this._symbolizerParams).catch(e=>{o.isAbortError(e)||n.getLogger(this).error(e)})}redraw(){const{renderer:e}=this.layer;e&&(this._updateSymbolizerParams(e),this._strategy.redraw(this._symbolizerParams))}_canReuseVectorFieldData(e){const t=this._dataParameters.exportParametersVersion===e.exportParametersVersion,i=this._dataParameters.time===e.time,r=this._dataParameters.symbolTileSize===e.symbolTileSize,s=this._dataParameters.bbox===e.bbox;return t&&i&&r&&s}async _getProjectedFullExtent(e){try{return f.projectExtent(this.layer.fullExtent,e)}catch(t){try{const t=(await r(this.layer.url,{query:{option:"footprints",outSR:d.srToRESTValue(e),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return t?p.fromJSON(t):null}catch{return null}}}_updateSymbolizerParams(e){"vector-field"===e?.type&&(this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null}))}},t.__decorate([l.property()],e.default.prototype,"attached",void 0),t.__decorate([l.property()],e.default.prototype,"container",void 0),t.__decorate([l.property()],e.default.prototype,"layer",void 0),t.__decorate([l.property()],e.default.prototype,"timeExtent",void 0),t.__decorate([l.property()],e.default.prototype,"type",void 0),t.__decorate([l.property()],e.default.prototype,"view",void 0),t.__decorate([l.property()],e.default.prototype,"updating",null),e.default=t.__decorate([u.subclass("esri.views.2d.layers.imagery.VectorFieldView2D")],e.default),e.default})},"esri/layers/support/rasterFunctions/rasterProjectionHelper":function(){define(["require","exports","../../../core/arrayUtils","../../../core/Error","../../../core/promiseUtils","../../../core/unitUtils","../../../geometry/Extent","../../../chunks/pe","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/support/spatialReferenceUtils"],function(e,t,i,r,s,n,o,a,l,c,h,u,p){"use strict";function d(){if(!v)throw new r("rasterprojectionhelper-project","projection operator is not loaded")}const f=(e,t,i,r=0)=>{if(1===i[0])return[0,0];let s=1,n=-1,o=1,a=-1;for(let t=0;t<e.length;t+=2)isNaN(e[t])||(s=s>e[t]?e[t]:s,n=n>e[t]?n:e[t],o=o>e[t+1]?e[t+1]:o,a=a>e[t+1]?a:e[t+1]);const{cols:l,rows:c}=t,h=(n-s)/l/i[0],u=(a-o)/c/i[1],p=2*r;let d=0,f=!1,m=[0,0];for(let t=0;t<l-3;t++){for(let i=0;i<c-3;i++){const r=t*c*2+2*i,s=(e[r]+e[r+4]+e[r+4*c]+e[r+4*c+4])/4,n=(e[r+1]+e[r+5]+e[r+4*c+1]+e[r+4*c+5])/4,o=Math.abs((s-e[r+2*c+2])/h),a=Math.abs((n-e[r+2*c+3])/u);if(o+a>d&&(d=o+a,m=[o,a]),p&&d>p){f=!0;break}}if(f)break}return m},m={3395:20037508.342789244,3410:17334193.943686873,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53034:20015086.79602057,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54034:20037508.342789244,54079:20037508.342789244,54080:20037508.342789244,54100:20037508.342789244,54101:20037508.342789244},g=new Map,y=new Map,x=500;let w,_,b,v=!1;function S(e,t,i){if(d(),i){const i=_.execute(e,t);return b.getTransformation(t,e.spatialReference,i)}return b.getTransformation(e.spatialReference,t,e)}function M(e,t,i){const r=n.getMetersPerUnitForSR(t)/n.getMetersPerUnitForSR(i);return{x:e.x*r,y:e.y*r}}function P(e,t,i){const{spatialReference:s}=i;if(!s||!t||s.equals(t))return e;if(s.isGeographic&&t.isGeographic)return M(e,s,t);if(d(),!v)throw new r("raster-projection-helper:project-dataset-resolution","geometry engine is not loaded");let{x:o,y:a}=e;const l=(o+a)/2*n.getMetersPerUnitForSR(s);let h=1;l>30&&(h=30/l,o*=h,a*=h);const u=256,p=o*u/2,f=a*u/2,{x:m,y:g}=i.center,y=[];for(let e=0;e<=u;e++)y.push([m-p,g-f+e*a]);for(let e=1;e<=u;e++)y.push([m-p+e*o,g+f]);for(let e=1;e<=u;e++)y.push([m+p,g+f-e*a]);for(let e=1;e<u;e++)y.push([m+p-e*o,g-f]);y.push(y[0]);const x=new c({rings:[y],spatialReference:s}),w=_.execute(x,t);if(!w)return M(e,s,t);const b=w.extent,S=L(t);if(null==b||null!=S&&b.width>=S)return M(e,s,t);const P=function(e){let t=0;for(const i of e){const e=i.length;let r=i[0][0]*(i[1][1]-i[e-2][1]);for(let t=1;t<e-1;t++)r+=i[t][0]*(i[t+1][1]-i[t-1][1]);t+=r/2}return Math.abs(t)}(w.rings),k=o*a*u*u,T=Math.sqrt(P/k)/h,R={x:b.width/h/u,y:b.height/h/u},A={x:o*T,y:a*T},V=R.x*R.y;return Math.abs(V-A.x*A.y)/V<.1?R:A}function k(e,t){return("number"==typeof e?e:(e.x+e.y)/2)*n.getMetersPerUnitForSR(t)*96*39.37}function T(e,t=.01){return n.getMetersPerUnitForSR(e)?t/n.getMetersPerUnitForSR(e):0}function R(e,t,i,r=!0){const s=e.spatialReference;if(s.equals(t))return e;d();const n=_.execute(e,t,{geographicTransformation:i});return r&&n?(A([e],[n],s,t),n):n}function A(e,t,i,r){const s=B(i,!0),n=B(r,!0),o=T(i,x),a=T(r,x);if(o&&null!=s&&null!=n)for(let i=0;i<e.length;i++){const r=t[i];if(!r)continue;const{x:l}=e[i],{x:c}=r;c>=n[1]-a&&Math.abs(l-s[0])<o?r.x-=n[1]-n[0]:c<=n[0]+a&&Math.abs(l-s[1])<o&&(r.x+=n[1]-n[0])}}function V(e){const{inSR:t,outSR:i,preferPE:r}=e;if(t.equals(i)){const{points:t}=C(e,null);return t}if(t.isWebMercator&&i.isWGS84||t.isWGS84&&i.isWebMercator)return function(e){const{cols:t,rows:i,xres:r,yres:s,usePixelCenter:n,inSR:o,outSR:a}=e;let{xmin:c,ymax:u}=e;n&&(c+=r/2,u-=s/2);const p=[],d=[],f=Math.max(t,i);for(let e=0;e<f;e++){const n=c+r*Math.min(t,e),f=u-s*Math.min(i,e),m=h.projectWithoutEngine(new l({x:n,y:f,spatialReference:o}),o,a);e<=t&&p.push(m.x),e<=i&&d.push(m.y)}const m=[];for(let e=0;e<t;e++)for(let t=0;t<i;t++)m.push([p[e],d[t]]);return m}(e);if(r){if(t.isGeographic)return D(e);if(null!=U(t))return D(e)}return function(e){const{points:t}=C(e,null),{inSR:i,outSR:r,datumTransformation:s}=e,n=t.map(e=>new l(e[0],e[1],i)),o=_.executeMany(n,r,{geographicTransformation:s});return s&&A(n,o,i,r),o.map(e=>e?[e.x,e.y]:[NaN,NaN])}(e)}function D(e){const{inSR:t,outSR:i,datumTransformation:r}=e,s=U(t),{points:n,mask:o}=C(e,s);if(!t.isGeographic){const e=t.wkid?a.PeFactory.coordsys(t.wkid):a.PeFactory.fromString(t.isGeographic?a.PeDefs.PE_TYPE_GEOGCS:a.PeDefs.PE_TYPE_PROJCS,t.wkt2||t.wkt);a.PeCSTransformations.projToGeog(e,n.length,n)}if(null!=r&&r.steps.length){let e;const t=179.9955;if(i.isGeographic&&(e=n.map(([e])=>e>t?1:e<-t?-1:0)),r.steps.forEach(e=>{const t=e.wkid?a.PeFactory.geogtran(e.wkid):a.PeFactory.fromString(a.PeDefs.PE_TYPE_GEOGTRAN,e.wkt);a.PeGTTransformations.geogToGeog(t,n.length,n,null,e.isInverse?a.PeDefs.PE_TRANSFORM_2_TO_1:a.PeDefs.PE_TRANSFORM_1_TO_2)}),e)for(let i=0;i<n.length;i++){const r=e[i],s=n[i][0],o=s>t?1:s<-t?-1:0;r&&o&&r!==o&&(n[i][0]=r>0?s+360:s-360)}}if(!i.isGeographic){const e=U(i,!0),t=null!=e&&e.isEnvelope?[e.bbox[1],e.bbox[3]]:[-90,90];!function(e,t){const[i,r]=t;for(let t=0;t<e.length;t++){const s=e[t][1];(s<i||s>r)&&(e[t]=[NaN,NaN])}}(n,t);const r=i.wkid?a.PeFactory.coordsys(i.wkid):a.PeFactory.fromString(i.isGeographic?a.PeDefs.PE_TYPE_GEOGCS:a.PeDefs.PE_TYPE_PROJCS,i.wkt2||i.wkt);a.PeCSTransformations.geogToProj(r,n.length,n)}let l=n;if(o&&n.length!==o.length){l=[];for(let e=0,t=0;e<o.length;e++)o[e]?l.push(n[t++]):l.push([NaN,NaN])}return l}function U(e,t=!1){let i=e.wkid||e.wkt2||e.wkt;if(!i||e.isGeographic)return null;if(i=String(i),g.has(i)){const e=g.get(i);return t?e?.gcs:e?.pcs}const r=e.wkid?a.PeFactory.coordsys(e.wkid):a.PeFactory.fromString(e.isGeographic?a.PeDefs.PE_TYPE_GEOGCS:a.PeDefs.PE_TYPE_PROJCS,e.wkt2||e.wkt),s=E(r,T(e,1e-4)),n=E(r,0,!0);return g.set(i,{pcs:s,gcs:n}),t?n:s}function E(e,t=0,i=!1){const r=a.PePCSInfo.generate(e),s=i?e.horizonGcsGenerate():e.horizonPcsGenerate();if(!r||!s?.length)return null;let n=!1,o=s.find(e=>1===e.getInclusive()&&1===e.getKind());if(!o){if(o=s.find(e=>1===e.getInclusive()&&0===e.getKind()),!o)return null;n=!0}const l=i?0:(2===r.getNorthPoleLocation()?1:0)|(2===r.getSouthPoleLocation()?2:0),c=r.isPannableRectangle(),h=o.getCoord();if(n)return{isEnvelope:n,isPannable:c,vertices:h,coef:null,bbox:[h[0][0]-t,h[0][1]-t,h[1][0]+t,h[1][1]+t],poleLocation:l};let u=0;const p=[];let[d,f]=h[0],[m,g]=h[0];for(let e=0,t=h.length;e<t;e++){u++,u===t&&(u=0);const[i,r]=h[e],[s,n]=h[u];if(n===r)p.push([i,s,r,n,2]);else{const e=(s-i)/(n-r||1e-4),t=i-e*r;r<n?p.push([e,t,r,n,0]):p.push([e,t,n,r,1])}d=d<i?d:i,f=f<r?f:r,m=m>i?m:i,g=g>r?g:r}return{isEnvelope:!1,isPannable:c,vertices:h,coef:p,bbox:[d,f,m,g],poleLocation:l}}function C(e,t){const i=[],{cols:r,rows:s,xres:n,yres:o,usePixelCenter:a}=e;let{xmin:l,ymax:c}=e;if(a&&(l+=n/2,c-=o/2),null==t){for(let e=0;e<r;e++)for(let t=0;t<s;t++)i.push([l+n*e,c-o*t]);return{points:i}}const h=new Uint8Array(r*s);if(t.isEnvelope){const{bbox:[e,a,u,p]}=t;for(let d=0,f=0;d<r;d++){const r=l+n*d,m=t.isPannable||r>=e&&r<=u;for(let e=0;e<s;e++,f++){const t=c-o*e;m&&t>=a&&t<=p&&(i.push([r,t]),h[f]=1)}}return{points:i,mask:h}}const u=t.coef,p=[];for(let e=0;e<s;e++){const t=c-o*e,i=[],r=[];for(let e=0;e<u.length;e++){const[s,n,o,a,l]=u[e];if(t===o&&o===a)i.push(s),i.push(n),r.push(2),r.push(2);else if(t>=o&&t<=a){const e=s*t+n;i.push(e),r.push(l)}}let s=i;if(i.length>2){let e=2===r[0]?0:r[0],t=i[0];s=[];for(let n=1;n<r.length;n++)2===r[n]&&n!==r.length-1||(r[n]!==e&&(s.push(0===e?Math.min(t,i[n-1]):Math.max(t,i[n-1])),e=r[n],t=i[n]),n===r.length-1&&s.push(0===r[n]?Math.min(t,i[n]):Math.max(t,i[n])));s.sort((e,t)=>e-t)}else i[0]>i[1]&&(s=[i[1],i[0]]);p.push(s)}for(let e=0,t=0;e<r;e++){const r=l+n*e;for(let e=0;e<s;e++,t++){const s=c-o*e,n=p[e];if(2===n.length)r>=n[0]&&r<=n[1]&&(i.push([r,s]),h[t]=1);else if(n.length>2){let e=!1;for(let t=0;t<n.length;t+=2)if(r>=n[t]&&r<=n[t+1]){e=!0;break}e&&(i.push([r,s]),h[t]=1)}}}return{points:i,mask:h}}function F(e,t){const i=L(e[0].spatialReference);if(e.length<2||null==i)return e[0];if(t=t??T(e[0].spatialReference),1===(e=e.filter(e=>e.width>t)).length)return e[0];let{xmin:r,xmax:s,ymin:n,ymax:a}=e[0];for(let t=1;t<e.length;t++){const r=e[t];s=r.xmax+i*t,n=Math.min(n,r.ymin),a=Math.max(a,r.ymax)}return new o({xmin:r,xmax:s,ymin:n,ymax:a,spatialReference:e[0].spatialReference})}function I(e,t,r=null,s=!0){const n=e.spatialReference;if(n.equals(t)||!t)return e;const a=j(e),l=L(n,!0),h=L(t);if(0===a||null==l||null==h){const i=O(e,t,r,s);if(i&&null==l&&null!=h&&Math.abs(i.width-h)<T(t)&&_.isLoaded()){const r=U(n);if(null!=r&&0===r.poleLocation&&e.width<(r.bbox[2]-r.bbox[0])/2)return function(e,t){const i=L(t);if(null==i)return null;let{xmin:r,ymin:s,xmax:n,ymax:a}=e;const l=e.spatialReference,h=new c({spatialReference:l,rings:[[[r,s],[n,s],[n,a],[r,a],[r,s]]]}),u=_.execute(h,t);if(2!==u.rings.length||!u.rings[0].length||!u.rings[1].length)return null;const{rings:p}=u,d=T(l),f=new o({spatialReference:t});for(let e=0;e<2;e++){r=n=p[e][0][0],s=a=p[e][0][1];for(let t=0;t<p[e].length;t++)r=r>p[e][t][0]?p[e][t][0]:r,n=n<p[e][t][0]?p[e][t][0]:n,s=s>p[e][t][1]?p[e][t][1]:s,a=a<p[e][t][1]?p[e][t][1]:a;if(0===e)f.ymin=s,f.ymax=a,f.xmin=r,f.xmax=n;else if(f.ymin=Math.min(f.ymin,s),f.ymax=Math.max(f.ymax,a),Math.abs(n-i/2)<d)f.xmin=r,f.xmax=f.xmax+i;else{if(!(Math.abs(r+i/2)<d))return null;f.xmax=n+i}}return f}(e,t)||i}return i}const u=e.clone().normalize();if(1===u.length&&e.xmax<l&&e.xmax-l/2>T(n)){const{xmin:t,xmax:i}=e;for(let r=0;r<=a;r++){const s=0===r?t:-l/2,c=r===a?i-l*r:l/2;u[r]=new o({xmin:s,xmax:c,ymin:e.ymin,ymax:e.ymax,spatialReference:n})}}const p=u.map(e=>O(e,t,r,s)).filter(i.isSome);return 0===p.length?null:F(p)}function O(e,t,i,r=!0,s=!0){const n=e.spatialReference;if(n.equals(t)||!t)return e;d();const o=_.execute(e,t,{geographicTransformation:i});if(s&&t.isWebMercator&&o&&(o.ymax=Math.min(20037508.342787,o.ymax),o.ymin=Math.max(-20037508.342787,o.ymin),o.ymin>=o.ymax))return null;if(!r||!o)return o;const a=B(n,!0),c=B(t,!0);if(null==a||null==c)return o;const h=T(n,.001),u=T(n,x),p=T(t,.001);if(Math.abs(o.xmin-c[0])<p&&Math.abs(o.xmax-c[1])<p){const r=Math.abs(e.xmin-a[0]),s=Math.abs(a[1]-e.xmax);if(r<h&&s>u){o.xmin=c[0];const r=[];r.push(new l(e.xmax,e.ymin,n)),r.push(new l(e.xmax,(e.ymin+e.ymax)/2,n)),r.push(new l(e.xmax,e.ymax,n));const s=r.map(e=>R(e,t,i)).filter(e=>!isNaN(e?.x)).map(e=>e.x);o.xmax=Math.max.apply(null,s)}if(s<h&&r>u){o.xmax=c[1];const r=[];r.push(new l(e.xmin,e.ymin,n)),r.push(new l(e.xmin,(e.ymin+e.ymax)/2,n)),r.push(new l(e.xmin,e.ymax,n));const s=r.map(e=>R(e,t,i)).filter(e=>!isNaN(e?.x)).map(e=>e.x);o.xmin=Math.min.apply(null,s)}}else{const e=T(t,.001);Math.abs(o.xmin-c[0])<e&&(o.xmin=c[0]),Math.abs(o.xmax-c[1])<e&&(o.xmax=c[1])}return o}function L(e,t=!1){if(!e)return null;const i=t?20037508.342787:20037508.342788905;return e.isWebMercator?2*i:e.wkid&&e.isGeographic?360:2*m[e.wkid]||null}function B(e,t=!1){if(e.isGeographic)return[-180,180];const i=L(e,t);return null!=i?[-i/2,i/2]:null}function z(e,t,i,r){let s=(e-t)/i;return s-Math.floor(s)!==0?s=Math.floor(s):r&&(s-=1),s}function j(e,t=!1){const i=L(e.spatialReference);if(null==i)return 0;const r=t?0:-i/2,s=T(e.spatialReference),n=!t&&Math.abs(e.xmax-i/2)<s?i/2:e.xmax,o=!t&&Math.abs(e.xmin+i/2)<s?-i/2:e.xmin;return z(n,r,i,!0)-z(o,r,i,!1)}function G(e){const{projectedExtent:t,srcBufferExtent:i,pixelSize:r,datumTransformation:s,rasterTransform:n}=e,o=t.spatialReference,a=i.spatialReference;d();const{xmin:c,ymin:h,xmax:u,ymax:p}=t,f=L(a),m=null!=f&&(e.hasWrapAround||"gcs-shift"===n?.type),g=e.spacing||[32,32],y=g[0]*r.x,w=g[1]*r.y,_=1===g[0],b=Math.ceil((u-c)/y-.1/g[0])+(_?0:1),v=Math.ceil((p-h)/w-.1/g[1])+(_?0:1),S=V({cols:b,rows:v,xmin:c,ymax:p,xres:y,yres:w,inSR:o,outSR:a,datumTransformation:s,preferPE:g[0]<=4,usePixelCenter:_}),M=[];let P,k=0;const R=_?-1:NaN,{xmin:A,xmax:D,ymax:E,width:C,height:F}=i,I=T(a,x),O=null!=f&&A>0&&D>f/2,B=U(o),z=null!=B&&B.poleLocation>0;for(let e=0;e<b;e++){const t=[];for(let i=0;i<v;i++){let r=S[e*v+i];if(m&&r[0]>D&&r[0]>f/2-I?r[0]-=f:m&&0===e&&r[0]<0&&O&&!n&&(r[0]+=f),!r||isNaN(r[0])||isNaN(r[1]))M.push(R),M.push(R),t.push(null),k++;else{if(n){const e=n.inverseTransform(new l({x:r[0],y:r[1],spatialReference:a}));r=[e.x,e.y]}t.push(r),e>0&&m&&P[i]&&r[0]<P[i][0]&&(r[0]+=f,z&&r[0]>D&&r[0]>f&&(r[0]-=f)),M.push((r[0]-A)/C),M.push((E-r[1])/F)}}P=t}return{offsets:M,error:null,coefficients:null,outofBoundPointCount:k,spacing:g,size:_?[b,v]:[b-1,v-1]}}function N(e,t,i){const{cols:r,rows:s}=t,n=new Float32Array((r-1)*(s-1)*2*6),o=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),a=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let t=0;t<r-1;t++){for(let i=0;i<s-1;i++){let l=t*s*2+2*i;const c=e[l],h=e[l+1],u=e[l+2],p=e[l+3];l+=2*s;const d=e[l],f=e[l+1],m=e[l+2],g=e[l+3];let y=0,x=12*(i*(r-1)+t);for(let e=0;e<3;e++)n[x++]=o[y++]*c+o[y++]*u+o[y++]*m;y=0;for(let e=0;e<3;e++)n[x++]=o[y++]*h+o[y++]*p+o[y++]*g;y=0;for(let e=0;e<3;e++)n[x++]=a[y++]*c+a[y++]*d+a[y++]*m;y=0;for(let e=0;e<3;e++)n[x++]=a[y++]*h+a[y++]*f+a[y++]*g}if(i)for(let e=0;e<n.length;e++)isNaN(n[e])&&(n[e]=-1)}return n}function H(e,t){const i=e.clone().normalize();return 1===i.length?i[0]:F(i,t)}function q(e,t,i=!1){const{pixelSize:r,extent:s}=e,n=S(s,t,!1),o=I(H(s,(r.x+r.y)/16),t,n);return!o||i||0===j(o)?o:O(s,t,n)}t.computeProjectedScales=function(e,t,i){const r=i?.tileSize??512,s=i?.alignGlobalDatasetWithAGOL??!0,n=!!i?.limitToSrcResolution,{extent:o,spatialReference:a,pixelSize:l}=e,c=P(l,t,o);if(null==c)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const h=(c.x+c.y)/2,p=k(h,t),d=t.isGeographic?256/r*295828763.7958547:256/r*591657527.591555;let f="vector-magdir"===e.dataType||"vector-uv"===e.dataType;const m=q(e,t,!0),g=Math.min(Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2),Math.ceil(Math.log(d/2/p)/Math.LN2));if(!f&&m&&s&&(t.isGeographic||t.isWebMercator)){const i=L(t);if(f=j(m)>0||null!=i&&m.width>i/4,!f&&null!=i){let t=-1;if(g<3)t=2**g*h*r;else if(e.storageInfo){const{maximumPyramidLevel:i=0,pyramidScalingFactor:s=2}=e.storageInfo;t=s**i*h*r}const s=Math.ceil(i/t);f=1===s||2===s&&i/2-m.xmax<t}}let y,x=p;const w=Math.min(2,Math.max(1.414,e.storageInfo?.pyramidScalingFactor||2));if(f){x=d;const i=t.isGeographic?1341104507446289e-21:.29858214164761665,r=k(i,t),s=t.isGeographic?4326:3857;y=P({x:i,y:i},a,q(e,new u({wkid:s}),!0)),y.x*=x/r,y.y*=x/r}else{y={x:l.x,y:l.y};let e=0;for(;x<.5005*d&&e<g;)e++,x*=w,y.x*=w,y.y*=w;Math.max(x,d)/Math.min(x,d)<=1.001&&(x=d)}const _=[x],b=[{x:y.x,y:y.y}],v=Math.min(70.5310735,p)/1.001;for(;x>=v;)x/=w,y.x/=w,y.y/=w,_.push(x),b.push({x:y.x,y:y.y});if(n){const e=.001*l.x;let t=b.findIndex(t=>t.x>=l.x-e&&t.x<=l.x+e);t>-1?(b.length=t+1,_.length=t+1):(t=b.findIndex(t=>t.x<=l.x+e),t>0&&(b.length=t,_.length=t))}return{projectedPixelSize:c,scales:_,srcResolutions:b,isCustomTilingScheme:!f}},t.defaultGridSpacing=32,t.defaultProjectionToleranceInPixels=4,t.getDefaultDatumTransformationForDataset=S,t.getProjectedGridPoints=V,t.getProjectionOffsetGrid=function(e){const t=e.isAdaptive&&null==e.spacing;let i=e.spacing||[32,32],r=G(e),s={cols:r.size[0]+1,rows:r.size[1]+1};const n=r.outofBoundPointCount>0&&r.outofBoundPointCount<r.offsets.length/2;let o=r.outofBoundPointCount===r.offsets.length/2||t&&n?[0,0]:f(r.offsets,s,i,4);const l=(o[0]+o[1])/2,c=e.projectedExtent.spatialReference,h=e.srcBufferExtent.spatialReference;if(t&&(n||l>4)&&(c.isGeographic||U(c),i=[4,4],r=G({...e,spacing:i}),s={cols:r.size[0]+1,rows:r.size[1]+1},o=f(r.offsets,s,i,4)),r.error=o,i[0]>1&&(r.coefficients=N(r.offsets,s,n)),e.includeGCSGrid&&!c.isGeographic&&!c.isWebMercator)if(h.isGeographic)r.gcsGrid={offsets:r.offsets,coefficients:r.coefficients,spacing:i};else{const t=U(c);if(null!=t&&!t.isEnvelope){const t=function(e){if(!e||e.isGeographic)return e;const t=String(e.wkid||e.wkt2||e.wkt);let i;return y.has(t)?i=y.get(t):(i=(e.wkid?a.PeFactory.coordsys(e.wkid):a.PeFactory.fromString(a.PeDefs.PE_TYPE_PROJCS,e.wkt2||e.wkt)).getGeogcs().getCode(),y.set(t,i)),new u({wkid:i})}(c),o=I(e.projectedExtent,t),{offsets:l}=G({...e,srcBufferExtent:o,spacing:i}),h=N(l,s,n);r.gcsGrid={offsets:l,coefficients:h,spacing:i}}}return r},t.getRasterDatasetAlignmentInfo=function(e){const t=e.storageInfo.origin.x,i=L(e.spatialReference,!0);if(null==i)return{originX:t,halfWorldWidth:null,pyramidsInfo:null};const r=i/2,{nativePixelSize:s,storageInfo:n,extent:o}=e,{maximumPyramidLevel:a,blockWidth:l,pyramidScalingFactor:c}=n;let h=s.x;const u=[],p=null!=e.transform&&"gcs-shift"===e.transform.type,d=t+(p?0:r),f=p?i-t:r-t;for(let e=0;e<=a;e++){const e=(o.xmax-t)/h/l,i=e-Math.floor(e)===0?e:Math.ceil(e),r=f/h/l,s=r-Math.floor(r)===0?r:Math.ceil(r),n=Math.floor(d/h/l),a=Math.round(d/h)%l,p=(l-Math.round(f/h)%l)%l;u.push({resolutionX:h,blockWidth:l,datasetColumnCount:i,worldColumnCountFromOrigin:s,leftMargin:a,rightPadding:p,originColumnOffset:n}),h*=c}return{originX:t,halfWorldWidth:r,pyramidsInfo:u,hasGCSSShiftTransform:p}},t.getSourceScale=function(e,t){const{pixelSize:i,extent:r}=e;return k(P(i,t,r),t)},t.getWorldWidth=L,t.getWorldWrapCount=j,t.load=async function(){return w||(w=s.createResolver(),_=await new Promise((t,i)=>e(["../../../geometry/operators/projectOperator"],t,i)),b=await new Promise((t,i)=>e(["../../../geometry/operators/support/geographicTransformationUtils"],t,i)),_.isLoaded()||await _.load(),b.isLoaded()||await b.load(),v=!0,w.resolve()),w.promise},t.minimumGridSpacing=4,t.projectDatasetExtent=q,t.projectDatasetResolution=P,t.projectExtent=I,t.projectPoint=R,t.projectPolygon=function(e,t,i){if("extent"===e.type){const{xmin:t,ymin:i,xmax:r,ymax:s,spatialReference:n}=e;e=new c({rings:[[[t,s],[r,s],[r,i],[t,i],[t,s]]],spatialReference:n})}return e.spatialReference.equals(t)?e:(d(),_.execute(e,t,{geographicTransformation:i}))},t.projectResolution=function(e,t,i,r){const s=e.spatialReference;if(!s||!t||s.equals(t))return e;d();const n=i.center,a=new o({xmin:n.x-e.x/2,xmax:n.x+e.x/2,ymin:n.y-e.y/2,ymax:n.y+e.y/2,spatialReference:s}),l=_.execute(a,t,{geographicTransformation:r}),c=L(t);return null==l||null!=c&&l.width>=c?M(e,s,t):{x:l.width,y:l.height}},t.shiftExtent=function(e){const{spatialReference:t}=e,i=p.getInfo(t);if(!i)return e;const[r,s]=i.valid,n=s-r;let a=0;if(e.xmin<r){const t=r-e.xmin;a=Math.ceil(t/n)}else if(e.xmin>s){const t=e.xmin-s;a=-Math.ceil(t/n)}return new o({spatialReference:e.spatialReference,xmin:e.xmin+a*n,ymin:e.ymin,xmax:e.xmax+a*n,ymax:e.ymax})},t.snapExtent=H,t.snapPyramid=function(e,t,i){const{storageInfo:r,pixelSize:s}=t;let o=0,a=!1;const{pyramidResolutions:c}=r,h="mixed"===r.tileInfo.format?.toLowerCase()?Math.max(1,Math.min(3,r.tileInfo.dpi/96)):1,u=(e.x+e.y)/2/h;if(null!=c&&c.length){const e=c[c.length-1],r=(e.x+e.y)/2,h=(s.x+s.y)/2;if(u<=h)o=0;else if(u>=r)o=c.length,a=u/r>8;else{let e,t=h;for(let r=1;r<=c.length;r++){if(e=(c[r-1].x+c[r-1].y)/2,u<=e){u===e?o=r:"down"===i?(o=r-1,a=u/t>8):o="up"===i||u-t>e-u||u/t>2?r:r-1;break}t=e}}const p=0===o?s:c[o-1];return a&&Math.min(p.x,p.y)*n.getMetersPerUnitForSR(t.spatialReference)>19567&&(a=!1),{pyramidLevel:o,pyramidResolution:new l({x:p.x,y:p.y,spatialReference:t.spatialReference}),excessiveReading:a}}const p=Math.log(e.x/s.x)/Math.LN2,d=Math.log(e.y/s.y)/Math.LN2,f=t.storageInfo.maximumPyramidLevel||0;o="down"===i?Math.floor(Math.min(p,d)):"up"===i?Math.ceil(Math.max(p,d)):Math.round((p+d)/2),o<0?o=0:o>f&&(a=o>f+3,o=f);const m=2**o;return{pyramidLevel:o,pyramidResolution:new l({x:m*t.nativePixelSize.x,y:m*t.nativePixelSize.y,spatialReference:t.spatialReference}),excessiveReading:a}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/rasterFunctions/vectorFieldUtils":function(){define(["exports","../../../core/jsonMap","../PixelBlock","./pixelUtils"],function(e,t,i,r){"use strict";const s=new Map;s.set("meter-per-second",1),s.set("kilometer-per-hour",.277778),s.set("knots",.514444),s.set("feet-per-second",.3048),s.set("mile-per-hour",.44704);const n=180/Math.PI,o=new t.JSONMap({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function a(e,t){return s.get(e)/s.get(t)||1}function l(e){return(450-e)%360}function c(e,t="geographic"){const[i,r]=e,s=Math.sqrt(i*i+r*r);let o=Math.atan2(r,i)*n;return o=(360+o)%360,"geographic"===t&&(o=l(o)),[s,o]}function h(e,t="geographic"){let i=e[1];"geographic"===t&&(i=l(i)),i%=360;const r=e[0];return[r*Math.cos(i/n),r*Math.sin(i/n)]}function u(e,t,s="geographic",n=1){if(!r.isValidPixelBlock(e))return e;const{pixels:o,width:a,height:l}=e,u=a*l,p=o[0],d=o[1],f=e.pixelType.startsWith("f")?e.pixelType:"f32",m=i.createEmptyBand(f,u),g=i.createEmptyBand(f,u);let y=0;for(let e=0;e<l;e++)for(let e=0;e<a;e++)"vector-uv"===t?([m[y],g[y]]=c([p[y],d[y]],s),m[y]*=n):([m[y],g[y]]=h([p[y],d[y]],s),m[y]*=n,g[y]*=n),y++;const x=new i({pixelType:f,width:e.width,height:e.height,mask:e.mask,validPixelCount:e.validPixelCount,maskIsAlpha:e.maskIsAlpha,pixels:[m,g]});return x.updateStatistics(),x}const p=d(0,0,0);function d(e=0,t=0,i=Math.PI,r=!0){r&&(i=(2*Math.PI-i)%(2*Math.PI));const s=r?-1:1,n=13*s,o=-7*s,a=-2*s,l=-16*s,c=21.75,[h,u]=m(0,t+n,i,c),[p,d]=m(e-5.5,t+o,i,c),[f,g]=m(e+5.5,t+o,i,c),[y,x]=m(e-1.5,t+a,i,c),[w,_]=m(e+1.5,t+a,i,c),[b,v]=m(e-1.5,t+l,i,c),[S,M]=m(e+1.5,t+l,i,c);return[h,u,p,d,y,x,w,_,f,g,b,v,S,M]}function f(e=0,t=Math.PI,i=!0){i&&(t=(2*Math.PI-t)%(2*Math.PI));const r=i?-1:1,s=5*r,n=20*r,o=25*r,a=45,l=2*r,c=i?1:-1,h=5*c;let[u,p]=[0+h,0-n],[d,f]=[u+2*c,p],[g,y]=[d-0*c,f+l],[x,w]=[0-h,0-o],[_,b]=[x+0*c,w-l],v=Math.ceil(e/5),S=Math.floor(v/10);v-=8*S;const M=[],P=[];for(let e=0;e<v/2;e++,S--){S<=0&&v%2==1&&e===(v-1)/2&&(x=0,_=x+0*c,w=(w+p)/2,b=w-l);const[i,r]=m(x,w,t,a);if(S>0){const[e,s]=m(d,w,t,a),[n,o]=m(u,p,t,a);M.push(e),M.push(s),M.push(i),M.push(r),M.push(n),M.push(o)}else{const[e,s]=m(d,f,t,a),[n,o]=m(g,y,t,a),[l,c]=m(_,b,t,a);P.push(i),P.push(r),P.push(l),P.push(c),P.push(n),P.push(o),P.push(e),P.push(s)}w+=s,p+=s,f+=s,y+=s,b+=s}const[k,T]=m(0+h,0+n,t,a),R=7*c,[A,V]=m(0+R,0+n,t,a),[D,U]=m(0+h,0-o,t,a),[E,C]=m(0+R,0-o,t,a);return{pennants:M,barbs:P,shaft:[k,T,A,V,D,U,E,C]}}function m(e,t,i,r=1){const s=Math.sqrt(e*e+t*t)/r,n=(2*Math.PI+Math.atan2(t,e))%(2*Math.PI);return[s,(2*Math.PI+n-i)%(2*Math.PI)]}const g=[0,1,3,6,10,16,21,27,33,40,47,55,63],y=[0,.5,1,1.5,2],x=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function w(e,t,i,r){const s=a(r||"knots",i);let n;for(n=1;n<t.length;n++)if(n===t.length-1){if(e<t[n]*s)break}else if(e<=t[n]*s)break;return Math.min(n-1,t.length-2)}function _(e,t,i,r,s){let n=0;switch(t){case"beaufort_kn":n=w(e,g,"knots",i);break;case"beaufort_km":n=w(e,g,"kilometer-per-hour",i);break;case"beaufort_ft":n=w(e,g,"feet-per-second",i);break;case"beaufort_m":n=w(e,g,"meter-per-second",i);break;case"classified_arrow":n=w(e,s??[],r,i);break;case"ocean_current_m":n=w(e,y,"meter-per-second",i);break;case"ocean_current_kn":n=w(e,x,"knots",i)}return n}const b=[];function v(e,t){let i=0,r=0;const{width:s,height:n,mask:l}=e,c=e.pixels[0],h=[],u=[],p=a(o.fromJSON(t.inputUnit),"knots"),d="wind_speed"===t.style?5:Number.MAX_VALUE;for(let e=0;e<n;e++)for(let t=0;t<s;t++){const o=c[e*s+t]*p;if((!l||l[e*s+t])&&o<d){for(let r=0;r<4;r++)h[i++]=(t+.5)/s,h[i++]=(e+.5)/n,h[i++]=r<2?-.5:.5,h[i++]=r%2==0?-.5:.5,h[i++]=0,h[i++]=o;const a=4*(i/24-1);u[r++]=a,u[r++]=a+1,u[r++]=a+2,u[r++]=a+1,u[r++]=a+2,u[r++]=a+3}}return{vertexData:new Float32Array(h),indexData:new Uint32Array(u)}}e.convertToLocalDirections=function(e,t,i,s="geographic"){if(!r.isValidPixelBlock(e)||null==i)return e;const n="vector-magdir"===t?e.clone():u(e,t),o=n.pixels[1];for(let e=0;e<o.length;e++)o[e]="geographic"===s?(o[e]+i[e]+270)%360:(o[e]+360-i[e])%360;return"vector-magdir"===t?n:u(n,"vector-magdir")},e.convertVectorFieldData=u,e.convertVectorFieldUnit=function(e,t,i=1){if(1===i||!r.isValidPixelBlock(e))return e;const s=e.clone(),{pixels:n,width:o,height:a}=s,l=n[0],c=n[1];let h=0;for(let e=0;e<a;e++)for(let e=0;e<o;e++)"vector-uv"===t?(l[h]*=i,c[h]*=i):l[h]*=i,h++;return s.updateStatistics(),s},e.createVFMesh=function(e,t){return"simple_scalar"===t.style?v(e,t):"wind_speed"===t.style?function(e,t){if(0===b.length)for(let e=0;e<30;e++)b.push(f(5*e,0,!t.invertDirection));const i=a(o.fromJSON(t.inputUnit),"knots"),{width:r,height:s,mask:n}=e,l=e.pixels[0],c=e.pixels[1],h=[],u=[];let p=0,d=0;for(let e=0;e<s;e++)for(let t=0;t<r;t++){const o=e*r+t,a=l[o]*i;if((!n||n[e*r+t])&&a>=5){const i=(c[o]+360)%360/180*Math.PI,{pennants:n,barbs:l,shaft:f}=b[Math.min(Math.floor(a/5),29)];if(n.length+l.length===0)continue;let m=h.length/6;const g=(t+.5)/r,y=(e+.5)/s;for(let e=0;e<n.length;e+=2)h[p++]=g,h[p++]=y,h[p++]=n[e],h[p++]=n[e+1]+i,h[p++]=0,h[p++]=a;for(let e=0;e<l.length;e+=2)h[p++]=g,h[p++]=y,h[p++]=l[e],h[p++]=l[e+1]+i,h[p++]=0,h[p++]=a;for(let e=0;e<f.length;e+=2)h[p++]=g,h[p++]=y,h[p++]=f[e],h[p++]=f[e+1]+i,h[p++]=0,h[p++]=a;for(let e=0;e<n.length/6;e++)u[d++]=m,u[d++]=m+1,u[d++]=m+2,m+=3;for(let e=0;e<l.length/8;e++)u[d++]=m,u[d++]=m+1,u[d++]=m+2,u[d++]=m+1,u[d++]=m+2,u[d++]=m+3,m+=4;u[d++]=m+0,u[d++]=m+1,u[d++]=m+2,u[d++]=m+1,u[d++]=m+3,u[d++]=m+2,m+=4}}return{vertexData:new Float32Array(h),indexData:new Uint32Array(u)}}(e,t):function(e,t){const{style:i,inputUnit:r,outputUnit:s,breakValues:n}=t,a=o.fromJSON(r),l=o.fromJSON(s);let c=0,h=0;const{width:u,height:f,mask:m}=e,g=e.pixels[0],y=e.pixels[1],x=null!=m?m.filter(e=>e>0).length:u*f,w=new Float32Array(42*x),b=new Uint32Array(15*x),v=t.invertDirection?d(0,0,0,!1):p;for(let e=0;e<f;e++)for(let t=0;t<u;t++){const r=e*u+t;if(!m||m[e*u+t]){const s=(y[r]+360)%360/180*Math.PI,o=_(g[r],i,a,l,n);for(let i=0;i<v.length;i+=2)w[c++]=(t+.5)/u,w[c++]=(e+.5)/f,w[c++]=v[i],w[c++]=v[i+1]+s,w[c++]=o,w[c++]=g[r];const p=7*(c/42-1);b[h++]=p,b[h++]=p+1,b[h++]=p+2,b[h++]=p+0,b[h++]=p+4,b[h++]=p+3,b[h++]=p+0,b[h++]=p+2,b[h++]=p+3,b[h++]=p+2,b[h++]=p+5,b[h++]=p+3,b[h++]=p+5,b[h++]=p+6,b[h++]=p+3}}return{vertexData:w,indexData:b}}(e,t)},e.createVFMeshScalar=v,e.getUnitConversionFactor=a,e.sampleVectorField=function(e,t,r,s=[0,0],n=.5){const{width:o,height:a,mask:l}=e,[u,p]=e.pixels,[d,f]=s,m=Math.round((o-d)/r),g=Math.round((a-f)/r),y=m*g,x=new Float32Array(y),w=new Float32Array(y),_=new Uint8Array(y),b="vector-uv"===t;for(let e=0;e<g;e++)for(let t=0;t<m;t++){let i=0;const s=e*m+t,g=Math.max(0,e*r+f),y=Math.max(0,t*r+d),v=Math.min(a,g+r),S=Math.min(o,y+r);for(let e=g;e<v;e++)for(let t=y;t<S;t++){const r=e*o+t;if(!l||l[r]){i++;const e=b?[u[r],p[r]]:[u[r],(360+p[r])%360],[t,n]=b?e:h(e);x[s]+=t,w[s]+=n}}if(i>=(v-g)*(S-y)*(1-n)){_[s]=1;const[e,t]=c([x[s]/i,w[s]/i]);x[s]=e,w[s]=t}else _[s]=0,x[s]=0,w[s]=0}const v=new i({width:m,height:g,pixels:[x,w],mask:_});return v.updateStatistics(),v},e.snapImageToSymbolTile=function(e,t,i,r,s){if(null==s||!s.spatialReference.equals(e.spatialReference))return{extent:e,width:Math.round(t/r),height:Math.round(i/r),resolution:e.width/t};const n=s.xmin,o=s.ymax,a=(e.xmax-e.xmin)/t*r,l=(e.ymax-e.ymin)/i*r,c=(a+l)/2;return e.xmin=n+Math.floor((e.xmin-n)/a)*a,e.xmax=n+Math.ceil((e.xmax-n)/a)*a,e.ymin=o+Math.floor((e.ymin-o)/l)*l,e.ymax=o+Math.ceil((e.ymax-o)/l)*l,{extent:e,width:Math.round(e.width/a),height:Math.round(e.height/l),resolution:c}},e.unitKebabDict=o,e.uvComponentToVector=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/imagery/RasterVFContainer":function(){define(["exports","./BrushVectorField","../webgl/WGLContainer"],function(e,t,i){"use strict";e.RasterVFContainer=class extends i{constructor(){super(...arguments),this.symbolTypes=["triangle"]}prepareRenderPasses(e){const i=e.registerRenderPass({name:"imagery (vf)",brushes:[t],target:()=>this.children,drawPhase:1});return[...super.prepareRenderPasses(e),i]}doRender(e){this.visible&&1===e.drawPhase&&this.symbolTypes.forEach(t=>{e.renderPass=t,super.doRender(e)})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/engine/imagery/BrushVectorField":function(){define(["../webgl/brushes/WGLBrush","../../../webgl/enums"],function(e,t){"use strict";const i=new Float32Array([.27058823529411763,.4588235294117647,.7098039215686275,1,.396078431372549,.5372549019607843,.7215686274509804,1,.5176470588235295,.6196078431372549,.7294117647058823,1,.6352941176470588,.7058823529411765,.7411764705882353,1,.7529411764705882,.8,.7450980392156863,1,.8705882352941177,.8901960784313725,.7490196078431373,1,1,1,.7490196078431373,1,1,.8627450980392157,.6313725490196078,1,.9803921568627451,.7254901960784313,.5176470588235295,1,.9607843137254902,.596078431372549,.4117647058823529,1,.9294117647058824,.4588235294117647,.3176470588235294,1,.9098039215686274,.08235294117647059,.08235294117647059,1]),r=new Float32Array([0,92/255,230/255,1]),s={beaufort_ft:i,beaufort_m:i,beaufort_km:i,beaufort_mi:i,beaufort_kn:new Float32Array([.1568627450980392,.5725490196078431,.7803921568627451,1,.34901960784313724,.6352941176470588,.7294117647058823,1,.5058823529411764,.7019607843137254,.6705882352941176,1,.6274509803921569,.7607843137254902,.6078431372549019,1,.7490196078431373,.8313725490196079,.5411764705882353,1,.8549019607843137,.9019607843137255,.4666666666666667,1,.9803921568627451,.9803921568627451,.39215686274509803,1,.9882352941176471,.8352941176470589,.3254901960784314,1,.9882352941176471,.7019607843137254,.4,1,.9803921568627451,.5529411764705883,.20392156862745098,1,.9686274509803922,.43137254901960786,.16470588235294117,1,.9411764705882353,.2784313725490196,.11372549019607843,1]),classified_arrow:new Float32Array([.2196078431372549,.6588235294117647,0,1,.5450980392156862,1.2117647058823529,0,1,1,1,0,1,1,.5019607843137255,0,1,1,0,0,1]),ocean_current_m:new Float32Array([.3058823529411765,.10196078431372549,.6,1,.7019607843137254,.10588235294117647,.10196078431372549,1,.792156862745098,.5019607843137255,.10196078431372549,1,.6941176470588235,.6941176470588235,.6941176470588235,1]),ocean_current_kn:new Float32Array([0,0,0,1,0,.1450980392156863,.39215686274509803,1,.3058823529411765,.10196078431372549,.6,1,.592156862745098,0,.39215686274509803,1,.7019607843137254,.10588235294117647,.10196078431372549,1,.6941176470588235,.3058823529411765,.10196078431372549,1,.792156862745098,.5019607843137255,.10196078431372549,1,.6941176470588235,.7019607843137254,.20392156862745098,1,.6941176470588235,.6941176470588235,.6941176470588235,1]),simple_scalar:r,single_arrow:r,wind_speed:new Float32Array([0,0,0,1])},n=[0,20];return class extends e{constructor(){super(...arguments),this._desc={magdir:{vsPath:"raster/magdir",fsPath:"raster/magdir",locations:new Map([["a_pos",0],["a_offset",1],["a_vv",2]])},scalar:{vsPath:"raster/scalar",fsPath:"raster/scalar",locations:new Map([["a_pos",0],["a_offset",1],["a_vv",2]])}}}dispose(){}prepareState({context:e}){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),e.setStencilWriteMask(0),e.setStencilTestEnabled(!0),e.setStencilOp(7680,7680,7681)}draw(e,t){if(null==t.source||0===t.source.validPixelCount)return;const{context:i,timeline:r}=e;if(r.begin(this.name),i.setStencilFunction(514,t.stencilRef,255),t.updateVectorFieldVAO(e),"scalar"===e.renderPass){const i=t.vaoData.scalar;i&&this._drawScalars(e,t,i.vao,i.elementCount)}else{const i=t.vaoData.magdir;i&&this._drawTriangles(e,t,i.vao,i.elementCount)}r.end(this.name)}_drawTriangles(e,i,r,o){const{context:a,painter:l,requestRender:c,allowDelayedRender:h}=e,{symbolizerParameters:u}=i,p=u.dataRange?["dataRange"]:[];"geographic"===u.rotationType&&p.push("rotationGeographic");const d=l.materialManager.getProgram(this._desc.magdir,p);if(h&&null!=c&&!d.compiled)return void c();a.useProgram(d);const{coordScale:f,opacity:m,transforms:g}=i;d.setUniform2fv("u_coordScale",f),d.setUniform1f("u_opacity",m),d.setUniformMatrix3fv("u_dvsMat3",g.displayViewScreenMat3);const{style:y,dataRange:x,rotation:w,symbolPercentRange:_}=u;d.setUniform4fv("u_colors",s[y]),d.setUniform2fv("u_dataRange",x||n),d.setUniform1f("u_rotation",w),d.setUniform2fv("u_symbolPercentRange",_);const b=this._getSymbolSize(e,i);d.setUniform2fv("u_symbolSize",b),a.bindVAO(r),a.drawElements(t.PrimitiveType.TRIANGLES,o,t.DataType.UNSIGNED_INT,0)}_drawScalars(e,i,r,s){const{context:o,painter:a,requestRender:l,allowDelayedRender:c}=e,{symbolizerParameters:h}=i,u=[];"wind_speed"===h.style?u.push("innerCircle"):h.dataRange&&u.push("dataRange"),"geographic"===h.rotationType&&u.push("rotationGeographic");const p=a.materialManager.getProgram(this._desc.scalar,u);if(c&&null!=l&&!p.compiled)return void l();o.useProgram(p);const{coordScale:d,opacity:f,transforms:m}=i;p.setUniform2fv("u_coordScale",d),p.setUniform1f("u_opacity",f),p.setUniformMatrix3fv("u_dvsMat3",m.displayViewScreenMat3);const{dataRange:g,symbolPercentRange:y}=h;p.setUniform2fv("u_dataRange",g||n),p.setUniform2fv("u_symbolPercentRange",y);const x=this._getSymbolSize(e,i);p.setUniform2fv("u_symbolSize",x),o.bindVAO(r),o.drawElements(t.PrimitiveType.TRIANGLES,s,t.DataType.UNSIGNED_INT,0)}_getSymbolSize(e,t){const i=t.key?2**(e.displayLevel-t.key.level):t.resolution/e.state.resolution,{symbolTileSize:r}=t.symbolizerParameters;return[r/(Math.round((t.width-t.offset[0])/r)*r)/i,r/(Math.round((t.height-t.offset[1])/r)*r)/i]}}})},"esri/views/2d/layers/imagery/ImageryVFStrategy":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../engine/imagery/RasterVFDisplayObject"],function(e,t,i,r,s,n,o,a,l,c,h){"use strict";return e.default=class extends i{constructor(e){super(e),this._loading=null,this.update=s.debounce((e,t)=>this._update(e,t).catch(e=>{s.isAbortError(e)||r.getLogger(this).error(e)}))}get updating(){return!!this._loading}redraw(e){if(!this.container.children.length)return;const t=this.container.children[0];t.symbolizerParameters=e,t.invalidateVAO(),this.container.symbolTypes="wind_speed"===e.style?["scalar","triangle"]:"simple_scalar"===e.style?["scalar"]:["triangle"],this.container.requestRender()}async _update(e,t,i){if(!e.stationary)return;const{extent:r,spatialReference:s}=e.state,n=new c({xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax,spatialReference:s}),[o,a]=e.state.size;this._loading=this.fetchPixels(n,o,a,i);const l=await this._loading;this._addToDisplay(l,t,e.state),this._loading=null}_addToDisplay(e,t,i){if(null==e.pixelBlock)return this.container.children.forEach(e=>e.destroy()),void this.container.removeAllChildren();const{extent:r,pixelBlock:s}=e,n=new h.RasterVFDisplayObject(s);n.offset=[0,0],n.symbolizerParameters=t,n.rawPixelData=e,n.invalidateVAO(),n.x=r.xmin,n.y=r.ymax,n.pixelRatio=i.pixelRatio,n.rotation=i.rotation,n.resolution=i.resolution,n.width=s.width*t.symbolTileSize,n.height=s.height*t.symbolTileSize,this.container.children.forEach(e=>e.destroy()),this.container.removeAllChildren(),this.container.symbolTypes="wind_speed"===t.style?["scalar","triangle"]:"simple_scalar"===t.style?["scalar"]:["triangle"],this.container.addChild(n)}},t.__decorate([n.property()],e.default.prototype,"fetchPixels",void 0),t.__decorate([n.property()],e.default.prototype,"container",void 0),t.__decorate([n.property()],e.default.prototype,"_loading",void 0),t.__decorate([n.property()],e.default.prototype,"updating",null),e.default=t.__decorate([l.subclass("esri.views.2d.layers.imagery.ImageryVFStrategy")],e.default),e.default})},"esri/views/2d/engine/imagery/RasterVFDisplayObject":function(){define(["exports","../../../../core/has","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f32","../../../../core/libs/gl-matrix-2/factories/vec2f32","../../../../layers/support/rasterFunctions/vectorFieldUtils","../DisplayObject","../webgl/Utils","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexArrayObject","../../../webgl/VertexBuffer"],function(e,t,i,r,s,n,o,a,l,c,h,u){"use strict";class p extends o.DisplayObject{constructor(e=null){super(),this._source=null,this._symbolizerParameters=null,this._vaoInvalidated=!0,this.coordScale=[1,1],this.height=null,this.key=null,this.offset=null,this.stencilRef=0,this.resolution=null,this.pixelRatio=1,this.x=0,this.y=0,this.rotation=0,this.rawPixelData=null,this.vaoData=null,this.width=null,this.source=e}destroy(){super.destroy(),null!=this.vaoData&&(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null)}get symbolizerParameters(){return this._symbolizerParameters}set symbolizerParameters(e){JSON.stringify(this._symbolizerParameters)!==JSON.stringify(e)&&(this._symbolizerParameters=e,this.invalidateVAO())}get source(){return this._source}set source(e){this._source=e,this.invalidateVAO()}invalidateVAO(){this._vaoInvalidated||null==this.vaoData||(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null,this._vaoInvalidated=!0,this.requestRender())}updateVectorFieldVAO(e){if(this._vaoInvalidated){if(this._vaoInvalidated=!1,null!=this.source&&null==this.vaoData){const{style:t}=this.symbolizerParameters;switch(t){case"beaufort_ft":case"beaufort_km":case"beaufort_kn":case"beaufort_m":case"beaufort_mi":case"classified_arrow":case"ocean_current_kn":case"ocean_current_m":case"single_arrow":{const t=n.createVFMesh(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(e.context,t);this.vaoData={magdir:i}}break;case"simple_scalar":{const t=n.createVFMeshScalar(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(e.context,t);this.vaoData={scalar:i}}break;case"wind_speed":{const t=n.createVFMesh(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(e.context,t),r=n.createVFMeshScalar(this.source,this.symbolizerParameters),s=this._createVectorFieldVAO(e.context,r);this.vaoData={magdir:i,scalar:s}}}}this.ready(),this.requestRender()}}_createTransforms(){return{displayViewScreenMat3:r.create()}}setTransform(e){const t=i.identity(this.transforms.displayViewScreenMat3),[r,n]=e.toScreenNoRotation([0,0],[this.x,this.y]),o=this.resolution/this.pixelRatio/e.resolution,a=o*this.width,l=o*this.height,c=Math.PI*this.rotation/180;i.translate(t,t,s.fromValues(r,n)),i.translate(t,t,s.fromValues(a/2,l/2)),i.rotate(t,t,-c),i.translate(t,t,s.fromValues(-a/2,-l/2)),i.scaleByVec2(t,t,s.fromValues(a,l)),i.multiply(this.transforms.displayViewScreenMat3,e.displayViewMat3,t)}onAttach(){this.invalidateVAO()}onDetach(){this.invalidateVAO()}_createVectorFieldVAO(e,t){const{vertexData:i,indexData:r}=t,s=l.BufferObject.createIndex(e,35044,new Uint32Array(r)),n=a.createProgramDescriptor("vector-field",[{location:0,name:"a_pos",count:2,type:c.DataType.FLOAT,normalized:!1},{location:1,name:"a_offset",count:2,type:c.DataType.FLOAT,normalized:!1},{location:2,name:"a_vv",count:2,type:c.DataType.FLOAT,normalized:!1}]),o=new u.VertexBuffer(e,n.bufferLayout,new Float32Array(i));return{vao:new h.VertexArrayObject(e,o,s),elementCount:r.length}}}e.RasterVFDisplayObject=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/ImageryLayerView":function(){define(["../../chunks/tslib.es6","../../core/Error","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/Point","../../layers/support/timeSupport","../../layers/support/rasterFunctions/rasterProjectionHelper","../../rest/support/Query","./support/popupUtils"],function(e,t,i,r,s,n,o,a,l,c,h,u,p){"use strict";return s=>{const n=s;let o=class extends n{constructor(...e){super(...e),this.view=null}get timeExtent(){return c.combineTimeExtent(this.layer,this.view?.timeExtent,this._get("timeExtent"))}async fetchPopupFeaturesAtLocation(e,r){const{layer:s}=this;if(!e)throw new t("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:n}=s,o=p.getFetchPopupTemplate(s,r);if(!n||null==o)return[];const a=await o.getRequiredFields();i.throwIfAborted(r);const c=new u;c.timeExtent=this.timeExtent,c.geometry=e,c.outFields=a,c.outSpatialReference=e.spatialReference;const{resolution:h,spatialReference:d}=this.view,f="2d"===this.view.type?new l(h,h,d):new l(.5*h,.5*h,d),{returnTopmostRaster:m,showNoDataRecords:g}=o.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},y={returnDomainValues:!0,returnTopmostRaster:m,pixelSize:f,showNoDataRecords:g,signal:r?.signal};return s.queryVisibleRasters(c,y).then(e=>e)}async getSourceScale(){return await h.load(),await this.layer.load(),h.getSourceScale(this.layer.serviceRasterInfo,this.view.spatialReference)}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return e.__decorate([r.property()],o.prototype,"layer",void 0),e.__decorate([r.property()],o.prototype,"suspended",void 0),e.__decorate([r.property({readOnly:!0})],o.prototype,"timeExtent",null),e.__decorate([r.property()],o.prototype,"view",void 0),o=e.__decorate([a.subclass("esri.views.layers.ImageryLayerView")],o),o}})},"esri/layers/support/timeSupport":function(){define(["exports","../../support/timeUtils"],function(e,t){"use strict";e.combineTimeExtent=function(e,i,r){if(null==e?.timeInfo)return null;const{datesInUnknownTimezone:s=!1,timeOffset:n,useViewTime:o}=e;let a=e.timeExtent;s&&(a=t.toLocalTimeExtent(a));let l=o?i&&a?i.intersection(a):i||a:a;return!l||l.isEmpty||l.isAllTime?l:(n&&(l=l.offset(-n.value,n.unit)),s&&(l=t.toUTCTimeExtent(l)),l.equals(r)?r:l)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/support/timeUtils":function(){define(["exports","../core/arrayUtils","../core/lang","../core/timeUtils","../chunks/TimeExtent","../webmap/utils","../webscene/utils"],function(e,t,i,r,s,n,o){"use strict";function a(e){return void 0!==e.timeInfo}async function l(e,i){if(0===e.length)return s.TimeExtent.allTime;await Promise.all(e.map(e=>e.load({signal:i})));const r=e.filter(a),n=e.filter(e=>!a(e)&&null!=e.visibilityTimeExtent);if(0===r.length&&0===n.length)return s.TimeExtent.allTime;const o=[],l=[];for(const e of r)"feature"!==e?.type&&"map-image"!==e?.type||!e.timeInfo?.hasLiveData?l.push(e):o.push(e);const c=e=>null==e||e.isAllTime,h=[...l.map(e=>{const t=e.timeInfo?.fullTimeExtent,{visibilityTimeExtent:i}=e;return t?.intersection(i)??i}),...n.map(e=>e.visibilityTimeExtent)];if(h.some(c))return s.TimeExtent.allTime;const u=o.map(async e=>{const t=(await e.fetchRecomputedExtents({signal:i}))?.timeExtent??e.timeInfo?.fullTimeExtent,{visibilityTimeExtent:r}=e;return t?.intersection(r)??r}),p=(await Promise.allSettled(u)).map(e=>"fulfilled"===e.status?e.value:null);if(p.some(c))return s.TimeExtent.allTime;const d=[...p,...h].filter(t.isSome);return 0===d.length?s.TimeExtent.allTime:d.reduce((e,t)=>e.union(t))}e.getTimeExtentFromLayers=l,e.getTimeSliderSettingsFromWebDocument=async function(e,t){if(!n.isWebMap(e)&&!o.isWebScene(e))return null;await e.load({signal:t});const r=e?.widgets?.timeSlider;if(!r)return null;const a=await async function(e,t){return e.widgets?.timeSlider?.fullTimeExtent??l(e.allLayers,t)}(e,t),c=r.loop,h=function(e){const t=e.numThumbs??2,i=e.currentTimeExtent;if(i){const{start:e,end:r}=i;return null!=e&&null!=r&&e.getTime()===r.getTime()?"instant":2===t?"time-window":null==e||0===e.getTime()?"cumulative-from-start":"cumulative-from-end"}return 2===t?"time-window":"cumulative-from-start"}(r),u=r.stopDelay??2e3,p=function(e){const{numStops:t,stopInterval:r,stops:s}=e;return s?{dates:i.clone(s)}:r?{interval:r.clone()}:{count:t??5}}(r),d=function(e,t){const i=e.currentTimeExtent;if(!i)return null;const{start:r,end:n}=i,o=r??n??null;switch(t){case"time-window":return new s.TimeExtent({start:r,end:n});case"cumulative-from-start":return new s.TimeExtent({start:null,end:o});case"cumulative-from-end":return new s.TimeExtent({start:o,end:null});case"instant":return new s.TimeExtent({start:o,end:o})}}(r,h);return{fullTimeExtent:a,loop:c,mode:h,playRate:u,stops:p,timeExtent:d}},e.toLocalTimeExtent=function(e){if(!e)return e;const{start:t,end:i}=e;return new s.TimeExtent({start:null!=t?r.offsetDate(t,t.getTimezoneOffset(),"minutes"):t,end:null!=i?r.offsetDate(i,i.getTimezoneOffset(),"minutes"):i})},e.toUTCTimeExtent=function(e){if(!e)return e;const{start:t,end:i}=e;return new s.TimeExtent({start:null!=t?r.offsetDate(t,-t.getTimezoneOffset(),"minutes"):t,end:null!=i?r.offsetDate(i,-i.getTimezoneOffset(),"minutes"):i})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/webscene/utils":function(){define(["exports","../support/tagSymbols"],function(e,t){"use strict";e.isWebScene=function(e){return null!=e&&"object"==typeof e&&t.WebSceneTag in e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/support/tagSymbols":function(){define(["exports"],function(e){"use strict";const t=Symbol("WebScene");e.WebSceneTag=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/support/popupUtils":function(){define(["exports","../../../layers/support/fieldUtils"],function(e,t){"use strict";function i(e,t){return e&&"object"==typeof e?t?.checkPopupEnabled&&"popupEnabled"in e&&!e.popupEnabled?null:"popupTemplate"in e&&e.popupTemplate?e.popupTemplate:null!=t&&t.defaultPopupTemplateEnabled&&"defaultPopupTemplate"in e&&e.defaultPopupTemplate?e.defaultPopupTemplate:null:null}e.getFetchPopupTemplate=i,e.getRequiredFields=async function(e,i=e.popupTemplate){if(null==i)return[];const r=await i.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:s}=i,{objectIdField:n,typeIdField:o,globalIdField:a,relationships:l}=e;if(r.includes("*"))return["*"];const c=s?t.getFeatureEditFields(e):[],h=t.fixFields(e.fieldsIndex,[...r,...c]);return o&&h.push(o),h&&n&&e.fieldsIndex?.has(n)&&!h.includes(n)&&h.push(n),h&&a&&e.fieldsIndex?.has(a)&&!h.includes(a)&&h.push(a),l&&l.forEach(t=>{const{keyField:i}=t;h&&i&&e.fieldsIndex?.has(i)&&!h.includes(i)&&h.push(i)}),h},e.hasPopupTemplate=function(e,t){return null!=i(e,{defaultPopupTemplateEnabled:t})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/RefreshableLayerView":function(){define(["exports","../../chunks/tslib.es6","../../core/Logger","../../core/promiseUtils","../../core/reactiveUtils","../../core/has","../../core/RandomLCG","../../core/Error","../../core/accessorSupport/decorators/subclass"],function(e,t,i,r,s,n,o,a,l){"use strict";e.RefreshableLayerView=e=>{const n=e;let o=class extends n{initialize(){this.addHandles(s.on(()=>this.layer,"refresh",e=>{this.doRefresh(e.dataChanged).catch(e=>{r.isAbortError(e)||i.getLogger(this).error(e)})}),"RefreshableLayerView")}};return o=t.__decorate([l.subclass("esri.views.layers.RefreshableLayerView")],o),o},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/highlightOptionsUtils":function(){define(["exports","../../core/Collection","./HighlightDefaults","./HighlightOptions"],function(e,t,i,r){"use strict";e.createInitialHighlightOptions=function(){return new t([new r({name:i.defaultHighlightName}),new r({name:i.temporaryHighlightName,color:i.temporaryHighlightColor})])},e.getHighlightName=function(e){return e?.name??i.defaultHighlightName},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/PixelHighlightOptions":function(){define(["exports","../../chunks/tslib.es6","../../Color","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./HighlightDefaults"],function(e,t,i,r,s,n,o,a,l,c){"use strict";return e.default=class extends r.JSONSupport{constructor(e){super(e),this.color=c.defaultColor.clone()}},t.__decorate([s.property({type:i,nonNullable:!0,json:{write:!0}})],e.default.prototype,"color",void 0),t.__decorate([s.property({nonNullable:!0,json:{write:!0}})],e.default.prototype,"ranges",void 0),t.__decorate([s.property({json:{write:!0}})],e.default.prototype,"bandId",void 0),e.default=t.__decorate([l.subclass("esri.views.support.PixelHighlightOptions")],e.default),e.default})},"*noref":1}}),define(["../../../chunks/tslib.es6","../../../Graphic","../../../core/arrayUtils","../../../core/Collection","../../../core/handleUtils","../../../core/has","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass","../../../support/GraphicsCollection","../engine/flow/FlowView2D","./LayerView2D","./graphics/GraphicsView2D","./graphics/HighlightGraphicContainer","./imagery/ImageryView2D","./imagery/VectorFieldView2D","../../layers/ImageryLayerView","../../layers/LayerView","../../layers/RefreshableLayerView","../../support/highlightOptionsUtils","../../support/PixelHighlightOptions"],function(e,t,i,r,s,n,o,a,l,c,h,u,p,d,f,m,g,y,x,w,_,b){"use strict";let v=class extends(y(w.RefreshableLayerView(p.LayerView2DMixin(x)))){constructor(){super(...arguments),this._exportImageVersion=-1,this._highlightGraphics=new h.GraphicsCollection,this._highlightView=void 0,this._pixelHighlightId=0,this.layer=null,this.subview=null}get pixelData(){const{subview:e}=this;return this.updating||!e?null:"getPixelData"in e?e.getPixelData():null}update(e){this.subview?.update(e)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.view&&(this._highlightView=new d({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new f(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container)),this.addAttachHandles([o.watch(()=>this.layer.exportImageServiceParameters.version,e=>{e&&this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())},o.sync),o.watch(()=>this.timeExtent,e=>{const{subview:t}=this;t&&(t.timeExtent=e,"redraw"in t?this.requestUpdate():t.redrawOrRefetch())},o.sync),this.layer.on("redraw",()=>{const{subview:e}=this;e&&("redraw"in e?e.redraw():e.redrawOrRefetch())}),o.watch(()=>this.layer.renderer,()=>this._setSubView())])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.container.removeAllChildren(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null,this._highlightView?.destroy(),this._exportImageVersion=-1}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e,n){if(!((Array.isArray(e)?e[0]:r.isCollection(e)?e.at(0):e)instanceof t))return s.makeHandle();let o=[];Array.isArray(e)||r.isCollection(e)?o=e.map(e=>e.clone()):e instanceof t&&(o=[e.clone()]);const a=o?.filter(i.isSome);if(!a?.length)return s.makeHandle();const l=_.getHighlightName(n);return this._addHighlightGraphics(o,l),s.makeHandle(()=>!this.destroyed&&this._removeHighlightGraphics(o,l))}highlightPixels(e){this._pixelHighlightOptions=l.ensureClass(b,e);const{subview:t}=this;"imagery"===t?.type&&this._updateHighlightOptions(t),this._pixelHighlightId++;const i=this._pixelHighlightId;return s.makeHandle(()=>{i===this._pixelHighlightId&&(this._pixelHighlightOptions=void 0,"imagery"===this.subview?.type&&this._updateHighlightOptions(this.subview))})}_addHighlightGraphics(e,t){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),t)}_removeHighlightGraphics(e,t){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),t)}async doRefresh(){this.requestUpdate()}isUpdating(){const e=!this.subview||this.subview.updating||!!this._highlightView?.updating;return n("esri-2d-log-updating")&&console.log(`Updating ImageryLayerView2D (${this.layer.id}): ${e}\n-> subview ${!this.subview||this.subview.updating}\n-> higlightView ${this._highlightView?.updating}\n`),e}_processHighlight(){const e=this._getHighlights();this._highlightView?.setHighlight(e)}_setSubView(){if(!this.view)return;const e=this.layer.renderer?.type;let t="imagery";if("vector-field"===e?t="imageryVF":"flow"===e&&(t="flow"),this.subview){const{type:e}=this.subview;if(e===t)return this._attachSubview(this.subview),void("flow"===e?this.subview.redrawOrRefetch():"imagery"===e&&"lerc"===this.layer.format?this.subview.redraw():this.requestUpdate());this._detachSubview(this.subview),this.subview?.destroy()}"imagery"===t?(this.subview=new m({layer:this.layer,view:this.view,timeExtent:this.timeExtent}),this.subview.pixelHighlightOptions=this._pixelHighlightOptions):this.subview="imageryVF"===t?new g({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new u({layer:this.layer,layerView:this}),this._attachSubview(this.subview),this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0))}_detachSubview(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}_updateHighlightOptions(e){"imagery"===e?.type&&(e.pixelHighlightOptions=this._pixelHighlightOptions,e.attached&&("lerc"===this.layer.format?e.redraw():this.requestUpdate()))}};return e.__decorate([a.property()],v.prototype,"pixelData",null),e.__decorate([a.property()],v.prototype,"subview",void 0),v=e.__decorate([c.subclass("esri.views.2d.layers.ImageryLayerView2D")],v),v});