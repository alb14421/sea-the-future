// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/handleUtils","../../../../../../core/has","../../../../../../core/MapUtils","../../../../../../core/promiseUtils","./ATileLoadStrategy","./chunks/PagedTileSourceChunk","../../support/FeatureSetReaderJSON"],function(e,t,o,r,s,a,i,n){"use strict";class l{constructor(e,o){this.subscription=e,this._pages=new Set,this._controller=new AbortController,this._done=!1,this._handles=t.handlesGroup([s.onAbort(e.signal,()=>this._controller.abort()),s.onAbort(o,()=>this._controller.abort())])}destroy(){this._controller.abort(),this._handles.remove()}get pageStart(){let e=-1;for(const t of this._pages.values())e=Math.max(e,t);return e+1}get done(){return this._done}get options(){return{signal:this._controller.signal}}add(e,t){this._pages.add(e),this._done=this._done||t}}class d extends a.ATileLoadStrategy{constructor(){super(...arguments),this._loadStates=new Map}destroy(){super.destroy();for(const e of this._loadStates.values())e.destroy();this._loadStates.clear()}get about(){return{supportsDisplayFilter:!0,willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(e){const t=r.getOrCreateMapValue(this._loadStates,e.key.id,()=>new l(e,this._options));for await(const e of this._fetchPages(t))this._addChunk(e)}unload(e){super.unload(e),this._loadStates.get(e.key.id)?.destroy(),this._loadStates.delete(e.key.id)}async*_fetchPages(e){let t;try{for await(const t of this._concurrentPageStream(e))s.throwIfAborted(e.options),0!==t.size()&&(yield t)}catch(e){t=e}if(t&&s.isAbortError(t)||(yield new i.PagedTileSourceChunk(n.FeatureSetReaderJSON.empty(this._metadata),null,e.subscription.tile,-1,!0)),t)throw t}async*_concurrentPageStream(e){const t=o("featurelayer-query-tile-concurrency"),r=this._pageStreamAll(e),s=[];let a=!1,i=1;for(;!a;){const e=[];for(;!a&&s.length<i;){const t=r.next();if(!t.value){a=!0;break}const o=t.value;o.then(e=>{e.reader.exceededTransferLimit||(a=!0)}).catch(e=>{a=!0}).finally(()=>{s.splice(s.indexOf(o),1)}),s.push(o),e.push(o)}for(const t of e)yield t;s.length&&await Promise.race(s),i<t&&(i+=1)}}*_pageStreamAll(e){const t=Math.ceil(o("featurelayer-query-tile-max-features")/this._queryInfo.pageSize);for(let o=0;o<t;o++)yield this._downloadPage(o,e)}async _downloadPage(e,t){s.throwIfAborted(t.options);const o=t.subscription.tile,r=this._queryInfo.createPagedTileQuery(o,e),a=await this._fetch(r,t.options,{chunkId:`${o.id}-${e}`});return s.throwIfAborted(t.options),new i.PagedTileSourceChunk(a,r.inner.toJSON(),o,e,!1)}}e.PagedTileLoadStrategy=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});