// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../../core/has","../../../../../../../core/workers/Connection","../../../../../../../geometry/support/quantizationUtils","../../../../../../../layers/graphics/featureConversionUtils","../../../../../../../layers/ogc/ogcFeatureUtils","../../../../../../../rest/query/operations/query","../../../support/FeatureSetReaderJSON","../../../support/FeatureSetReaderPBF"],function(e,t,a,r,s,i,n,u,o){"use strict";class c{constructor(e,t){this.service=e,this._metadata=t}destroy(){}}class m extends c{constructor(e,t){super(e,t),this._portsOpen=async function(e){const t=new a;return await t.open(e,{}),t}(e.source).then(e=>this.client=e)}destroy(){this.client.close(),this.client=null}async executeQuery(e,t){await this._portsOpen;const a=await this.client.invoke("queryFeatures",e.toJSON(),t);return u.FeatureSetReaderJSON.fromFeatureSet(a,this._metadata)}}class d extends c{async executeQuery(e,t){const{data:a}=await n.executeQueryPBFBuffer(this.service.source,e,t),r=!e.quantizationParameters;return o.FeatureSetReaderPBF.fromBuffer(a,this._metadata,r)}}class y extends c{async executeQuery(e,t){const{source:a,queryMetadata:i}=this.service;if(null!=e.quantizationParameters&&!i.supportsQuantization){const i=e.clone(),o=r.toQuantizationTransform(i.quantizationParameters);i.quantizationParameters=null;const{data:c}=await n.executeQuery(a,i,this._metadata.spatialReference,t),m=s.convertFromFeatureSet(c,this._metadata.featureIdInfo);return s.quantizeOptimizedFeatureSet(o,m),u.FeatureSetReaderJSON.fromOptimizedFeatureSet(m,this._metadata)}const{data:o}=await n.executeQuery(a,e,this._metadata.spatialReference,t);return"esriGeometryPoint"===this._metadata.geometryType&&(o.features=o.features?.filter(e=>{if(null!=e.geometry){const t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0})),u.FeatureSetReaderJSON.fromFeatureSet(o,this._metadata)}}class p extends c{async executeQuery(e,t){if(e.quantizationParameters&&!this.service.queryMetadata.supportsQuantization){const a=e.clone(),n=r.toQuantizationTransform(a.quantizationParameters);a.quantizationParameters=null;const o=await i.queryOptimizedFeatureSet(this.service.source,e,t);return s.quantizeOptimizedFeatureSet(n,o),u.FeatureSetReaderJSON.fromOptimizedFeatureSet(o,this._metadata)}const a=await i.queryOptimizedFeatureSet(this.service.source,e,t);return u.FeatureSetReaderJSON.fromOptimizedFeatureSet(a,this._metadata)}}e.SourceAdapter=c,e.createQueryAdapter=function(e,a){switch(e.type){case"memory":return new m(e,a);case"ogc":return new p(e,a);case"feature-service":return e.queryMetadata.supportsFormatPBF&&t("featurelayer-pbf")?new d(e,a):new y(e,a)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});