// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/promiseUtils","../../../../../core/uuid","./strategies/support/snapshotUtils"],function(e,t,s,r,i,a,h){"use strict";e.FeatureCache=class{constructor(e,s,o,c){this.store=e,this.queryInfo=s,this._options=o,this._fetch=c,this._nextBatch=new Set,this._fetchFeatures=i.debounce(async()=>{if(0===this._nextBatch.size||this._options.signal?.aborted)return;const e=Array.from(this._nextBatch);this._nextBatch.clear(),e.length>8e3&&r.getLogger("esri.views.2d.layers.FeatureLayerView2D").warn(new t("highlight-too-many-features","highlight is limited to 8000 features on large layers configured with a display filter to avoid performance issues"));const s=this.queryInfo.objectIdsQueryPageSize,i=Math.ceil(8e3/s),o=Math.min(i,Math.ceil(e.length/s)),c=Array.from({length:o},(t,r)=>{const i=r*s,a=Math.min(i+s,e.length);return{num:r,query:this.queryInfo.createObjectIdsQuery(e.slice(i,a))}});try{await h.fetchPages({chunkPrefix:"cache."+a.generateUUID(),fetch:this._fetch},this.store,c,this._options)}catch(e){}})}prepareCacheUpdate(e,t){if(t)for(const e of t)this._nextBatch.delete(e);for(const t of e)this._nextBatch.add(t)}applyCacheUpdate(){return 0===this._nextBatch.size||this._options.signal?.aborted?null:this._fetchFeatures().catch(()=>{})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});