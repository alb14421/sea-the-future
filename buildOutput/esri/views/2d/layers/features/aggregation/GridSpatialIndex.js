// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/unitUtils","./AAggregateSpatialIndex","./GridCell"],function(e,t,i,s){"use strict";function l(e,i){return t.getMetersPerUnitForSR(e)*t.inchesPerMeter*96/i}class n extends i.AAggregateSpatialIndex{constructor(e){super(e),this._cells=new Map,this._pixelsPerMapUnit=l(e.spatialReference,e.scale)}put(e){for(const t of this._cells.values()){const i=e.get(t.id);i?i.merge(t):e.set(t.id,t.clone())}}putBounded(e,t,i){const s=[t.xmin,t.ymin,t.xmax,t.ymax],[l,n,o,r]=s,a=Math.floor(l*this._pixelsPerMapUnit/this._options.cellSize),c=Math.floor(n*this._pixelsPerMapUnit/this._options.cellSize),p=Math.ceil(o*this._pixelsPerMapUnit/this._options.cellSize),h=Math.ceil(r*this._pixelsPerMapUnit/this._options.cellSize);for(let t=c;t<=h;t++)for(let i=a;i<=p;i++){const s=`${i}.${t}`,l=this._cells.get(s);if(!l)continue;const n=e.get(l.id);n?l&&!e.has(l.id)&&n.merge(l):e.set(l.id,l.clone())}}_insert(e,t,i,s){const l=t*this._pixelsPerMapUnit,n=i*this._pixelsPerMapUnit,o=Math.floor(l/this._options.cellSize),r=Math.floor(n/this._options.cellSize);this._getCellOrCreate(o,r).insert(e,s,t,i)}_getCellOrCreate(e,t){const i=s.GridCell.createId(e,t);let l=this._cells.get(i);if(!l){const n=1*this._options.cellSize/this._pixelsPerMapUnit;l=s.GridCell.create(e,t,this._options.fields,n),this._cells.set(i,l)}return l}}e.GridSpatialIndex=n,e.pixelsPerMapUnit=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});