// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/memoryEstimations","../../../../../core/pbf","../../../../../layers/graphics/OptimizedGeometry","./FeatureSetCache","./FeatureSetReader","./FeatureSetReaderPBFHeader"],function(e,t,r,s,a,n,i,h,o,d,u){"use strict";const c=268435455,l=128e3,g={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},small64:{delta:new Float64Array(0),decoded:new Float64Array(0)},large:{delta:new Int32Array(l),decoded:new Int32Array(l)},large64:{delta:new Float64Array(0),decoded:new Float64Array(0)}};function _(e,t){return t?e<=g.small64.delta.length?g.small64:(e<=g.large64.delta.length||(g.large64.delta=new Float64Array(Math.round(1.25*e)),g.large64.decoded=new Float64Array(Math.round(1.25*e))),g.large64):e<=g.small.delta.length?g.small:(e<=g.large.delta.length||(g.large.delta=new Int32Array(Math.round(1.25*e)),g.large.decoded=new Int32Array(Math.round(1.25*e))),g.large)}function f(e){for(;e.next();){if(1===e.tag())return e.getMessage();e.skip()}return null}function y(e,t,r,s,a){return!!e&&0===t*a-s*r&&t*s+r*a>0}class I extends d.FeatureSetReader{static fromBuffer(e,r,a=!1){const n=r.geometryType,h=function(e){try{const t=2,r=new i(new Uint8Array(e),new DataView(e));for(;r.next();){if(r.tag()===t)return f(r.getMessage());r.skip()}}catch(e){const r=new t("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});s.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(r)}return null}(e),o=u.parseHeader(h,"esriGeometryPoint"===n,r.featureIdInfo,a);return new I(h,o,r,a)}constructor(e,t,r,s){super(r),this._use64Bit=s,this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0},this._parseCaches=new Array,this._geometryType=r.geometryType,this._reader=e,this._header=t,this._hasNext=t.hasFeatures,this._isPoints="esriGeometryPoint"===r.geometryType}get _size(){return this._header.featureCount}get fields(){return this._header.fields}get geometryType(){return this._geometryType}get hasZ(){return!1}get hasM(){return!1}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this._size}getInTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._featureIndex=e}getAttributeHash(){let e="";for(const t of this._header.fields.fields)e+=this._readAttributeAtIndex(t.index)+".";return e}getObjectId(){if(1===this._header.idFieldIndices.length)return this._readAttributeAtIndex(this._header.idFieldIndices[0]);const e=this._header.idFieldIndices.map(e=>this._readAttributeAtIndex(e));return JSON.stringify(e)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(e){this._header.displayIds[this._featureIndex]=e}readGeometryArea(){return this._cache.area||this._readGeometry(!0),this._cache.area}copy(){const e=this._reader.clone(),t=new I(e,this._header,this.metadata,this._use64Bit);return this.copyInto(t),t}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}get usedMemory(){return n.baseObjectMemory+(this._cache.geometry?.usedMemory??0)}_readX(){return this._header.centroid[2*this._featureIndex]}_readY(){return this._header.centroid[2*this._featureIndex+1]}_readServerCentroid(){const e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];return e===c?null:new h([],[e,t])}_readGeometry(e=!1){if(void 0===this._cache.geometry){let t=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===c)return null;const e=this._header.centroid[2*this._featureIndex],r=this._header.centroid[2*this._featureIndex+1];t=new h([],[e,r])}else{const r=this._header.offsets.geometry[this._featureIndex],s=this._reader;if(0===r)return null;s.move(r);try{t=e?this._parseGeometryForDisplay(s):this._parseGeometry(s)}catch(e){return null}}return 0===t?.coords.length&&(t=null),this._cache.geometry=t,t}return this._cache.geometry}_readAttribute(e,t){const r=this._header.fields.get(e);if(null==r)return;const s=this._readAttributeAtIndex(r.index),a=this._header.fields.isDateField(r.name);return t?null==s?s:a?new Date(s):s:s}_readAttributes(){const e={};for(const t of this._header.fields.fields)e[t.name]=this._readAttributeAtIndex(t.index);return e}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext,e._parseCaches=this._parseCaches}_readAttributeAtIndex(e){let t=this._parseCaches[e];if(t||(t=new o.FeatureSetCache(this.getSize()),this._parseCaches[e]=t),t.has(this._featureIndex))return t.get(this._featureIndex);const r=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],s=this._reader;s.move(r);const a=function(e){const t=e.getLength(),r=e.pos()+t;for(;e.pos()<r&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}(s);return t.set(this._featureIndex,a),a}_readGeometryDeltaDecoded(e=!1){if(void 0===this._cache.unquantGeometry){const t=this._readGeometry(e);if(!t)return this._cache.unquantGeometry=void 0,null;if(!this.getInTransform())return this._cache.unquantGeometry=t,t;const r=_(t.coords.length,this._use64Bit).decoded,s=t.clone(r),a=s.coords;let n=0;for(const e of s.lengths){for(let t=1;t<e;t++){const e=2*(n+t),r=2*(n+t-1);a[e]+=a[r],a[e+1]+=a[r+1]}n+=e}return this._cache.unquantGeometry=s,s}return this._cache.unquantGeometry}_parseGeometry(e){const t=e.asUnsafe(),r=t.getLength(),s=t.pos()+r,a=[],n=[];for(;t.pos()<s&&t.next();)switch(t.tag()){case 2:{const e=t.getUInt32(),r=t.pos()+e;for(;t.pos()<r;)n.push(t.getUInt32());break}case 3:{const e=t.getUInt32(),r=t.pos()+e;for(a.push(t.getSInt64()),a.push(t.getSInt64()),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();t.pos()<r;)a.push(t.getSInt64()),a.push(t.getSInt64()),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();break}default:t.skip()}return new h(n,a)}_parseGeometryForDisplay(e){const t=e.asUnsafe(),r=t.getLength(),s=t.pos()+r,n=[],i=[];let o=0,d=0,u=null,c=0;const l="esriGeometryPolygon"===this.geometryType,g="esriGeometryPolyline"===this.geometryType,f=l?3:g?2:1,I=l||g;for(;t.pos()<s&&t.next();)switch(t.tag()){case 2:{const e=t.getUInt32(),r=t.pos()+e;for(;t.pos()<r;){const e=t.getUInt32();n.push(e),o+=e}u=_(2*o,this._use64Bit).delta;break}case 3:{t.getUInt32();const e=2+(this.hasZ?1:0)+(this.hasM?1:0);a.assertIsSome(u);for(const r of n){if(d+e*r>u.length){for(let e=0;e<r;e++)t.getSInt64(),t.getSInt64(),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();continue}let s=0,a=t.getSInt64(),n=t.getSInt64();this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64(),u[d++]=a,u[d++]=n,s+=1;for(let e=1;e<r;e++){const e=t.getSInt64(),r=t.getSInt64(),i=a+e,h=n+r;c+=-.5*(i-a)*(h+n),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64(),0===e&&0===r||y(I,u[d-2],u[d-1],e,r)?(u[d-2]+=e,u[d-1]+=r):(u[d++]=e,u[d++]=r,s+=1),a=i,n=h}s>=f?i.push(s):d-=s*e}break}default:t.skip()}return this._cache.area=c,i.length?new h(i,u):null!=u?this._createDeltaQuantizedExtrudedGeometry(u[0],u[1]):null}}e.FeatureSetReaderPBF=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});