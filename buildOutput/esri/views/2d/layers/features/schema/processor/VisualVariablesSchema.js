// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/has","../../../../../../core/screenUtils","../../../../../../core/unitUtils","../../../../../../renderers/support/lengthUtils","../../../../engine/webgl/definitions","./schemaUtils","../../support/rendererUtils"],function(e,a,i,l,t,s,r,u){"use strict";function n(e){if(!e.stops?.length)return null;const a=e.stops.sort((e,a)=>e.value-a.value),i=r.padStops(a,8),l=i.map(({value:e})=>e),t=i.map(({color:e})=>r.premultiplyColor(e));return{values:l,colors:t}}function o(e){if(!e.stops?.length)return null;const a=e.stops.sort((e,a)=>e.value-a.value),i=r.padStops(a,8);return{opacityValues:i.map(({value:e})=>e),opacities:i.map(({opacity:e})=>e)}}function p(e){return{rotationType:"geographic"===e.rotationType?0:1}}function c(e){if(!e.stops?.length)return null;if(e.stops.some(e=>e.useMaxValue||e.useMinValue))return(a,l)=>{const t=a.statisticsByLevel.get(l.key.level),u=e.stops.map(a=>({value:a.useMaxValue?t?.get(e.field)?.maxValue??0:a.useMinValue?t?.get(e.field)?.minValue??0:a.value,size:a.size?i.pt2px(a.size):s.nanMagicNumber})).sort((e,a)=>e.value-a.value),n=r.padStops(u,8);return{values:n.map(({value:e})=>e),sizes:n.map(({size:e})=>e)}};const a=e.stops.sort((e,a)=>e.value-a.value),l=r.padStops(a,8);return{values:l.map(({value:e})=>e),sizes:l.map(({size:e})=>i.pt2px(e))}}function V(e){return a=>{const{state:i}=a;return{unitValueToPixelsRatio:l.getMetersPerUnitForSR(i.spatialReference)/t.meterIn[e.valueUnit??"meters"]/i.resolution}}}function v(e,a){const i=a.length;if(e<a[0].value||1===i)return a[0].size;for(let l=1;l<i;l++)if(e<a[l].value){const i=(e-a[l-1].value)/(a[l].value-a[l-1].value);return a[l-1].size+i*(a[l].size-a[l-1].size)}return a[i-1].size}function S(e){const{minDataValue:a,maxDataValue:l,minSize:t,maxSize:s}=e;if("object"==typeof t&&"object"==typeof s)return(e,r)=>{const u=e.state.scale,n=i.pt2px(v(u,t.stops)),o=i.pt2px(v(u,s.stops));return{minMaxValueAndSize:[a,l,n,o]}};if("object"==typeof t||"object"==typeof s)throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[a,l,i.pt2px(t),i.pt2px(s)]}}const b={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function f(e){return"number"==typeof e.minDataValue&&"number"==typeof e.maxDataValue&&null!=e.minSize&&null!=e.maxSize?"min-max":"$view.scale"===e?.valueExpression&&Array.isArray(e.stops)?"scale-stops":null==e.field&&"$view.scale"===e?.valueExpression||!(Array.isArray(e.stops)||"levels"in e&&e.levels)?null!=e.field||"$view.scale"!==e?.valueExpression?"unit-value":null:"field-stops"}e.createVisualVariableColor=n,e.createVisualVariableOpacity=o,e.createVisualVariableRotation=p,e.createVisualVariableSizeMinMaxValue=S,e.createVisualVariableSizeStops=c,e.createVisualVariableSizeUnitValue=V,e.createVisualVariableUniforms=function(e){const a={...b};if(!e||!("visualVariables"in e)||!e.visualVariables)return a;for(const i of u.simplifyVisualVariables(e.visualVariables))switch(i.type){case"color":a.visualVariableColor=n(i);break;case"opacity":a.visualVariableOpacity=o(i);break;case"rotation":a.visualVariableRotation=p(i);break;case"size":switch(f(i)){case"field-stops":a.visualVariableSizeStops=c(i);break;case"scale-stops":"outline"===i.target?a.visualVariableSizeOutlineScaleStops=c(i):a.visualVariableSizeScaleStops=c(i);break;case"min-max":a.visualVariableSizeMinMaxValue=S(i);break;case"unit-value":a.visualVariableSizeUnitValue=V(i)}}return a},e.getMaxSizeVVSize=function(e,a=128,i=1.25){if(e.visualVariableSizeMinMaxValue)return"function"==typeof e.visualVariableSizeMinMaxValue?128:Math.max(e.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*i,a);if(e.visualVariableSizeScaleStops){if("function"==typeof e.visualVariableSizeScaleStops)return 128;const l=e.visualVariableSizeScaleStops.sizes;return Math.max(l[l.length-1]*i,a)}if(e.visualVariableSizeStops){if("function"==typeof e.visualVariableSizeStops)return 128;const l=e.visualVariableSizeStops.sizes;return Math.max(l[l.length-1]*i,a)}return e.visualVariableSizeUnitValue?256:0},e.noVisualVariables=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});