// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/screenUtils","../../../../../../layers/support/OrderByInfo","./LabelMatcherSchema","./MatcherSchema","./StorageSchema","./VisualVariablesSchema"],function(e,r,t,a,i,s,n){"use strict";function l(e,r){return e.fields.map(e=>({...e.toJSON(),type:o(e,r)}))}function o(e,r){const{onStatisticExpression:t,onStatisticField:a,statisticType:i}=e;switch(i){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(t){const{returnType:e}=t;return e?"string"===e?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const e=r.find(e=>e.name===a);return e?e.type:"esriFieldTypeString"}}}function c(e){return 2===e.techniqueType}function u(e){if("simple"===e.type&&e.meshes.some(c))return!0;if("interval"===e.type){if(e.intervals.some(e=>e.meshes.some(c)))return!0;if(e.backgroundFill.some(c))return!0}if("map"===e.type){if(e.map.some(e=>e.symbol.some(c)))return!0;if(e.backgroundFill.some(c))return!0}return!1}e.createSimpleProcessorSchema=async function(e,o,c,b){const f=c.featureReduction;if(f)switch(f.type){case"binning":return async function(e,t,o,c,b){const f=l(e,c.fields),m=e.renderer,p=await i.createMatcherSchema(t,m),y=s.createStorageSchema(m,[null,null]),d=n.createVisualVariableUniforms(m),g=await a.createLabelMatcherSchema(t,{geometryType:"polygon",labelingInfoSource:c.labelingInfoSource+"-binning",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},d),h=u(p),S="geohash"===e.binType?{type:"geohash",fixBinLevel:e.fixedBinLevel??3}:{type:"grid",size:r.pt2px(e.size),fixedBinLevel:e.fixedBinLevel};return{storage:y,mesh:{properties:{sortKey:null,timeZone:o.timeZone,returnMeshObjectId:h,displayRefreshVersion:b,currentUser:o.currentUser},strategy:{type:"binning",fields:f,index:S,featureFilter:o.filters[0]},factory:{labels:g,symbology:p}},expressionProperties:{timeExtent:o.timeExtent?.toJSON()}}}(f,e,o,c,b);case"cluster":return async function(e,t,o,c,b){const f=l(e,c.fields),m={type:"cluster",feature:await i.createMatcherSchema(t,e.effectiveFeatureRenderer),cluster:await i.createMatcherSchema(t,e.effectiveClusterRenderer)},p=n.createVisualVariableUniforms(e.effectiveFeatureRenderer),y={type:"cluster",feature:await a.createLabelMatcherSchema(t,c,p),cluster:await a.createLabelMatcherSchema(t,{geometryType:"point",labelingInfoSource:c.labelingInfoSource+"-clusters",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},p)},d=s.createStorageSchema(e.effectiveFeatureRenderer,[null,null]),g=u(m);return{storage:d,mesh:{properties:{sortKey:null,timeZone:o.timeZone,displayRefreshVersion:b,returnMeshObjectId:g,currentUser:o.currentUser},strategy:{type:"cluster",fields:f,featureFilter:o.filters[0],clusterRadius:r.pt2px(e.clusterRadius/2)},factory:{labels:y,symbology:m}},expressionProperties:{timeExtent:o.timeExtent?.toJSON()}}}(f,e,o,c,b)}if(c.trackInfo?.enabled)return async function(e,r,t,o,c){const b=l(e,o.fields),f={type:"track",previousObservation:await i.createMatcherSchema(r,e.previousObservations.renderer),latestObservation:await i.createMatcherSchema(r,e.latestObservations.renderer),trackLine:await i.createMatcherSchema(r,e.trackLines.renderer)},m={type:"track",previousObservation:await a.createLabelMatcherSchema(r,{geometryType:o.geometryType,labelingInfoSource:o.labelingInfoSource+"-track-prev",labelingInfo:e.previousObservations.labelingInfo,labelsVisible:e.previousObservations.labelsVisible},n.createVisualVariableUniforms(e.previousObservations.renderer)),latestObservation:await a.createLabelMatcherSchema(r,{geometryType:o.geometryType,labelingInfoSource:o.labelingInfoSource+"-track-latest",labelingInfo:e.latestObservations.labelingInfo,labelsVisible:e.latestObservations.labelsVisible},n.createVisualVariableUniforms(e.latestObservations.renderer)),trackLine:await a.createLabelMatcherSchema(r,{geometryType:"polyline",labelingInfoSource:o.labelingInfoSource+"-track-line",labelingInfo:e.trackLines.labelingInfo,labelsVisible:e.trackLines.labelsVisible},n.createVisualVariableUniforms(e.trackLines.renderer))},p=s.createTrackStorageSchema(e,[null,null]),y=u(f);return{storage:p,mesh:{properties:{sortKey:null,timeZone:t.timeZone,returnMeshObjectId:y,displayRefreshVersion:c,currentUser:t.currentUser},strategy:{type:"track",featureFilter:t.filters[0],fields:b,maxDisplayDuration:e.maxDisplayDuration?.toMilliseconds()??0,maxDisplayObservationsPerTrack:e.maxDisplayObservationsPerTrack,showLatestObservation:e.latestObservations.visible,showPreviousObservations:e.previousObservations.visible,showTrackLine:e.trackLines.visible,timeField:e.timeField},factory:{labels:m,symbology:f}},expressionProperties:{timeExtent:t.timeExtent?.toJSON()}}}(c.trackInfo,e,o,c,b);const m=function(e,r,a){const i=null!=r&&"unique-value"===r.type&&r.orderByClassesEnabled;if("default"!==e||i||(e=[new t({field:a,order:"descending"})]),"default"!==e&&e?.length){e.length;const r=e[0],t="ascending"===r.order?"asc":"desc";return r.field?{field:r.field,order:t}:r.valueExpression?{expression:r.valueExpression,order:t}:null}return i?{byRenderer:!0,order:"asc"}:null}(c.orderBy,c.renderer,c.objectIdField),p=s.createStorageSchema(c.renderer,o.filters),y=await async function(e,r){const t=r.renderer,s=n.createVisualVariableUniforms(t);return{symbology:await i.createMatcherSchema(e,t),labels:await a.createLabelMatcherSchema(e,r,s)}}(e,c),d=u(y.symbology);return{storage:p,mesh:{properties:{sortKey:m,timeZone:o.timeZone,returnMeshObjectId:d,displayRefreshVersion:b,currentUser:o.currentUser},strategy:{type:"feature"},factory:y},expressionProperties:{timeExtent:o.timeExtent?.toJSON()}}},e.getAggregateFields=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});