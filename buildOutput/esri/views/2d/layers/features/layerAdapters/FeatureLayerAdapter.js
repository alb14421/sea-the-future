// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/lang","../../../../../layers/support/arcgisLayerUrl","./featureReductionUtils","./featureServiceUtils","./floorFilterUtils","./geometryUtils","./labelingUtils","../schema/SourceSchema","../schema/processor/SimpleProcessorSchema","../support/rendererUtils"],function(e,t,r,i,a,o,s,l,n,c,d){"use strict";e.FeatureLayerAdapter=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,r=l.getFeatureReductionDeconflictionEnabled(t,e)??l.getLayerDeconflictionEnabled(t),a=i.getEffectiveFeatureReduction(t,e),o=[...t.labelingInfo||[],...a?.labelingInfo||[]];return[{vvEvaluators:{0:l.createLabelVVEvaluator(t.renderer)},deconflictionEnabled:r,labelingInfo:o}]}async createServiceOptions(e){const i=this.layer,{capabilities:o,editingInfo:l,typeIdField:n,globalIdField:c,datesInUnknownTimezone:d,dateFieldsTimeZone:u,orderBy:p,subtypeField:y,refreshInterval:f}=i,h=i.fieldsIndex.toJSON(),m=s.getServiceGeometryType(i),g=i.timeInfo?.toJSON(),b=i.spatialReference.toJSON(),F=i.types?.map(e=>e.toJSON()),S=t.clone(this.layer.parsedUrl);this.layer.dynamicDataSource&&(S.query={layer:JSON.stringify({source:this.layer.dynamicDataSource})});let I=this.layer.objectIdField;if(p?.length){const e=!p[0].valueExpression&&p[0].field;e&&(I=e)}const R=r.isHostedAgolService(S.path),E=!(null!=l?.lastEditDate)&&f>0,v=a.createSnapshotInfo(R,E,o,m,e.extent,i.fullExtent),x=e.spatialReference.toJSON();return{type:"feature-service",source:S,isSourceHosted:R,orderByFields:I,outSpatialReference:x,metadata:{typeIdField:n??void 0,types:F,timeReferenceUnknownClient:d,dateFieldsTimeZone:u,subtypeField:y,globalIdField:c,fieldsIndex:h,geometryType:m,featureIdInfo:a.createFeatureIdInfo(i),timeInfo:g,spatialReference:b,outSpatialReference:x,subtypes:this.layer.subtypes?.map(e=>e.toJSON())},queryMetadata:{maxRecordCount:o.query.maxRecordCount,supportsCompactGeometry:o.query.supportsCompactGeometry,supportsDefaultSpatialReference:o.query.supportsDefaultSpatialReference,supportsFormatPBF:o.query.supportsFormatPBF,supportsMaxRecordCountFactor:o.query.supportsMaxRecordCountFactor,supportsQuantization:o.query.supportsQuantization,lastEditDate:l?.lastEditDate?.getTime(),snapshotInfo:v}}}createSourceSchema(e,t){const{apiKey:r,definitionExpression:i,displayFilterInfo:a,customParameters:o,gdbVersion:s,historicMoment:l,subtypeCode:c,subtypeField:d,timeExtent:u}=this.layer,p={definitionExpression:i,displayFilterInfo:a,customParameters:o,gdbVersion:s,historicMoment:l,subtypeCode:c,subtypeField:d,timeExtent:u};return n.createFeatureSourceSchema(p,e,t,r)}createProcessorSchema(e,t,r){const{fields:a,renderer:o,geometryType:s,labelingInfo:l,labelsVisible:n,orderBy:d,objectIdField:u,trackInfo:p}=this.layer,y={fields:a.map(e=>e.toJSON()),renderer:o?.clone(),labelingInfoSource:this.layer.id,featureReduction:i.getEffectiveFeatureReduction(this.layer,t),geometryType:s,labelingInfo:l,labelsVisible:n,objectIdField:u,orderBy:d??"default",trackInfo:p};return c.createSimpleProcessorSchema(e,t,y,r)}get hasRequiredSupport(){return d.isRendererSupported(this.layer.renderer)}get timeOptions(){return this.layer}addFilters(e,t){return o.addFloorFilter(this.layer,e,t)}getUpdateHashProperties(e){return[()=>this.layer.apiKey,()=>this.layer.customParameters,()=>this.layer.definitionExpression,()=>i.getEffectiveFeatureReduction(this.layer,e),()=>o.hasFloorFilter(this.layer,e)?e.floors:null,()=>this.layer.gdbVersion,()=>this.layer.historicMoment,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>this.layer.orderBy,()=>this.layer.outFields,()=>this.layer.renderer,()=>this.layer.subtypeCode,()=>this.layer.trackInfo]}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});