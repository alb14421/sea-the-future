// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/sql","../../../../../layers/knowledgeGraph/constants","../../../../../layers/support/FeatureFilter","./featureReductionUtils","./geometryUtils","./labelingUtils","../schema/SourceSchema","../schema/processor/SimpleProcessorSchema","../support/rendererUtils"],function(e,t,r,a,i,o,l,n,s,u){"use strict";function c(e){return"link-chart"===e.parentCompositeLayer.type&&"hidden"===e.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode}e.KnowledgeGraphSublayerAdapter=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,r=l.getFeatureReductionDeconflictionEnabled(t,e)??l.getLayerDeconflictionEnabled(t);return[{vvEvaluators:{0:l.createLabelVVEvaluator(t.renderer)},deconflictionEnabled:r}]}async createServiceOptions(e){const t=this.layer,{capabilities:r,objectIdField:a}=t,i=t.fieldsIndex.toJSON(),l=o.getServiceGeometryType(t),n=t.spatialReference.toJSON(),s=await t.source.openPorts(),u=a,c=e.spatialReference.toJSON();return{type:"memory",source:s,orderByFields:u,outSpatialReference:c,metadata:{fieldsIndex:i,geometryType:l,featureIdInfo:{type:"object-id",fieldName:t.objectIdField},spatialReference:n,outSpatialReference:c,globalIdField:null,subtypeField:null,subtypes:null,timeInfo:t.timeInfo?.toJSON(),timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:r.query.maxRecordCount,supportsCompactGeometry:r.query.supportsCompactGeometry,supportsDefaultSpatialReference:r.query.supportsDefaultSpatialReference,supportsFormatPBF:r.query.supportsFormatPBF,supportsMaxRecordCountFactor:r.query.supportsMaxRecordCountFactor,supportsQuantization:r.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,t){const{definitionExpression:r,displayFilterInfo:a}=this.layer,i={definitionExpression:r,displayFilterInfo:a,customParameters:null};return n.createFeatureSourceSchema(i,e,t,null)}createProcessorSchema(e,t,r){const{fields:a,renderer:o,geometryType:l,labelingInfo:n,labelsVisible:u,objectIdField:c}=this.layer,p={fields:a.map(e=>e.toJSON()),renderer:o?.clone(),labelingInfoSource:this.layer.id,featureReduction:i.getEffectiveFeatureReduction(this.layer,t),geometryType:l,labelingInfo:n,labelsVisible:u,objectIdField:c,orderBy:"default"};return s.createSimpleProcessorSchema(e,t,p,r)}get hasRequiredSupport(){return u.isRendererSupported(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.definitionExpression,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>i.getEffectiveFeatureReduction(this.layer,e),()=>c(this.layer)]}hasFilters(e){return c(this.layer)}addFilters(e,i){if(c(this.layer)){const i=t.sqlAnd(e?.where,`${r.systemIsSpatialFieldName}=1`);if(!i)return e;e??=new a,e.where=i}return e}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});