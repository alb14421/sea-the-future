// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/lang","../../../../../core/mathUtils","../../../../../core/sql","../../../../../layers/support/arcgisLayerUrl","../../../../../layers/support/FeatureFilter","./featureServiceUtils","./floorFilterUtils","./geometryUtils","./labelingUtils","../schema/SourceSchema","../schema/processor/SubtypeProcessorSchema"],function(e,t,r,a,s,l,i,o,n,u,c,y){"use strict";e.SubtypeGroupLayerAdapter=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer;return[{vvEvaluators:{},deconflictionEnabled:t.sublayers.some(e=>u.getLayerDeconflictionEnabled(e)),labelingInfo:t.sublayers.toArray().filter(e=>!!e.labelingInfo).flatMap(e=>e.labelingInfo)}]}async createServiceOptions(e){const r=this.layer,{capabilities:a,datesInUnknownTimezone:l,dateFieldsTimeZone:o,editingInfo:u,globalIdField:c,objectIdField:y,refreshInterval:p,subtypeField:d}=r,m=r.fieldsIndex.toJSON(),b=n.getServiceGeometryType(r),f=r.timeInfo?.toJSON(),h=r.spatialReference.toJSON(),S=t.clone(this.layer.parsedUrl),g=y,F=!(null!=u?.lastEditDate)&&p>0,I=s.isHostedAgolService(S.path),x=e.spatialReference.toJSON(),R=i.createSnapshotInfo(I,F,a,b,e.extent,r.fullExtent);return{type:"feature-service",source:S,isSourceHosted:I,orderByFields:g,outSpatialReference:x,metadata:{timeReferenceUnknownClient:l,dateFieldsTimeZone:o,subtypeField:d,globalIdField:c,fieldsIndex:m,geometryType:b,featureIdInfo:i.createFeatureIdInfo(this.layer),timeInfo:f,spatialReference:h,outSpatialReference:x,subtypes:this.layer.subtypes?.map(e=>e.toJSON()),typeIdField:null,types:null},queryMetadata:{maxRecordCount:a.query.maxRecordCount,supportsCompactGeometry:a.query.supportsCompactGeometry,supportsDefaultSpatialReference:a.query.supportsDefaultSpatialReference,supportsFormatPBF:a.query.supportsFormatPBF,supportsMaxRecordCountFactor:a.query.supportsMaxRecordCountFactor,supportsQuantization:a.query.supportsQuantization,lastEditDate:u?.lastEditDate?.getTime(),snapshotInfo:R}}}createSourceSchema(e,t){const{definitionExpression:r,customParameters:a,gdbVersion:s,historicMoment:l,subtypeField:i,timeExtent:o,apiKey:n,displayFilterInfo:u}=this.layer,y={queryScaleRanges:this.layer.sublayers.items.map(e=>({subtypeCode:e.subtypeCode,minScale:e.minScale,maxScale:e.maxScale})),definitionExpression:r,displayFilterInfo:u,customParameters:a,gdbVersion:s,historicMoment:l,subtypeField:i,timeExtent:o};return c.createFeatureSourceSchema(y,e,t,n)}createProcessorSchema(e,t,r){const a={labelingInfoSource:this.layer.id,subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,(e,t)=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfoSource:this.layer.id+`-${t}`,labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible,renderer:e.renderer,subtypeCode:e.subtypeCode,orderBy:null}))};return y.createSubtypeProcessorSchema(e,t,a,r)}addFilters(e,t){e=o.addFloorFilter(this.layer,e,t);const s=this.layer.sublayers.filter(e=>!function(e,t){return e.visible&&(0===e.minScale||r.floatEqualAbsolute(t.scale,e.minScale)||t.scale<e.minScale)&&(0===e.maxScale||r.floatEqualAbsolute(t.scale,e.maxScale)||t.scale>e.maxScale)}(e,t)).map(e=>e.subtypeCode);if(!s.length)return e;e??=new l;const i=`NOT ${this.layer.subtypeField} IN (${s.join(",")})`;return e.where=a.sqlAnd(e.where,i),e}get hasRequiredSupport(){return!0}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.apiKey,()=>this.layer.customParameters,()=>this.layer.definitionExpression,()=>o.hasFloorFilter(this.layer,e)?e.floors:null,()=>this.layer.outFields,()=>this.layer.gdbVersion,()=>this.layer.historicMoment,()=>this.layer.sublayers.map(({renderer:e,labelsVisible:t,labelingInfo:r,visible:a,minScale:s,maxScale:l})=>({renderer:e,labelsVisible:t,labelingInfo:r,visible:a,minScale:s,maxScale:l}))]}setGraphicOrigin(e){const t=this.layer.findSublayerForFeature(e);e.layer=e.sourceLayer=t,e.origin=t?.graphicOrigin}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});