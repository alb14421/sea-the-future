// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
require({cache:{"esri/views/2d/layers/BitmapTileLayerView2D":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Logger","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../engine/BitmapTileContainer"],function(e,t,r,i,s,o,a,n){"use strict";e.BitmapTileLayerView2D=e=>{const r=e;let i=class extends r{attach(){this.view.timeline.record(`${this.layer.title} (BitmapTileLayer) Attach`),this._bitmapView=new n.BitmapTileContainer(this._tileInfoView),this.container.addChild(this._bitmapView)}detach(){this.container.removeChild(this._bitmapView),this._bitmapView?.removeAllChildren(),this._bitmapView=null}};return i=t.__decorate([a.subclass("esri.views.2d.layers.BitmapTileLayerView2D")],i),i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/layers/LayerView2D":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Collection","../../../core/collectionUtils","../../../core/Error","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../linkChart/utils","../engine/Container","./support/HighlightCounter","./support/util","../support/highlightOptionsUtils","../../layers/support/ClipRect","../../layers/support/Geometry","../../layers/support/Path","../../support/HighlightOptions","../../support/layerViewUtils"],function(e,t,r,i,s,o,a,n,l,c,p,h,u,d,y,g,f,m,b,w,_){"use strict";const v=r.ofType({key:"type",base:null,typeMap:{rect:f,path:b,geometry:m}}),S=new(r.ofType(w));e.LayerView2DMixin=e=>{const n=e;let l=class extends n{constructor(){super(...arguments),this._highlightCounter=new d.HighlightCounter,this.attached=!1,this.clips=new v,this.highlights=null,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this._visibleAtCurrentScale=!0}initialize(){const e=this.view?.spatialReferenceLocked??!0,t=this.view?.spatialReference;t&&e&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new s("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new u.Container),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([o.watch(()=>this.suspended,e=>{this.container&&(this.container.visible=!e)},o.syncAndInitial),o.watch(()=>this.updateSuspended,e=>{this.view&&!e&&this.updateRequested&&this.view.requestUpdate()},o.syncAndInitial),o.watch(()=>this.layer?.opacity??1,e=>{this.container&&(this.container.opacity=e)},o.syncAndInitial),o.watch(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",e=>{this.container&&(this.container.blendMode=e)},o.syncAndInitial),o.watch(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,e=>{this.container&&(this.container.effect=e)},o.syncAndInitial),o.watch(()=>this._mergedHighlights.items.map(e=>({name:e.name,options:{fillColor:e.color,haloColor:e.haloColor,fillOpacity:e.fillOpacity,haloOpacity:e.haloOpacity,haloWidth:e.haloWidth,haloBlur:e.haloBlur}})),()=>{this.container.highlightGradient=y.createOrReuseHighlightGradient(this.container.highlightGradient,this._mergedHighlights.items)},o.syncAndInitial),o.watch(()=>this._mergedHighlights.items.map(e=>e.name),()=>{this._processHighlight()}),o.on(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},o.syncAndInitial),o.watch(()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}),({scale:e,scaleRange:t})=>{const r=_.isInEffectiveScaleRange(t,e);r!==this._visibleAtCurrentScale&&(this._visibleAtCurrentScale=r)},o.syncAndInitial)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(e=>{e===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get highlightOptions(){return g.getDefaultHighlightOptions(this)}set highlightOptions(e){g.setDefaultHighlightOptions(this,e)}get hasHighlight(){return this._highlightCounter.size>0}get _mergedHighlights(){if(!this.view)return S;if(!this.highlights)return this.view.highlights;const e=this.view.highlights.clone();for(const t of this.highlights){const r=e.find(e=>e.name===t.name);r&&r.assignFrom(t)}return e}get highlightIds(){return Array.from(this._highlightCounter.objectIds)}get scheduler(){return this.view.scheduler}get spatialReferenceSupported(){const e=this.view?.spatialReference;return null==e||this.supportsSpatialReference(e)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this._updatingHandles?.updating||this.container.transitioning)}get visibleAtCurrentScale(){return this._visibleAtCurrentScale}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(e){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",e),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(e))):this.updateRequested=!1}hitTest(e,t){return Promise.resolve(null)}supportsSpatialReference(e){return!0}canResume(){if(!this.spatialReferenceSupported)return!1;switch(this.layer?.type){case"link-chart":case"knowledge-graph-sublayer":case"graphics":break;default:if(h.isLinkChartView(this.view)&&!this.view.inGeographicLayout)return!1}return!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const e=super.getSuspendInfo(),t=!this.spatialReferenceSupported;return t&&(e.spatialReferenceNotSupported=t),e}addAttachHandles(e){this.addHandles(e,"attach")}_addHighlights(e,t){this._highlightCounter.add(e,t)&&this._processHighlight()}_removeHighlights(e,t){this._highlightCounter.delete(e,t)&&this._processHighlight()}_processHighlight(){}_getHighlights(){const e=[];for(const[t,r]of this._highlightCounter.highlightNamesByObjectId){const i=this._getHighlightBits(r);e.push({objectId:t,highlightFlags:i})}return e}_getHighlightBits(e){const t=new Set(e);let r=1,i=0;if(!this.view)return 0;const s=this._mergedHighlights;for(const{name:e}of s)t.delete(e)&&(i=r),r<<=1;return i}};return t.__decorate([a.property()],l.prototype,"attached",void 0),t.__decorate([a.property({type:v,set(e){const t=i.referenceSetter(e,this._get("clips"),v);this._set("clips",t)}})],l.prototype,"clips",void 0),t.__decorate([a.property()],l.prototype,"container",void 0),t.__decorate([a.property({type:w})],l.prototype,"highlightOptions",null),t.__decorate([a.property({type:r.ofType(w)})],l.prototype,"highlights",void 0),t.__decorate([a.property()],l.prototype,"_mergedHighlights",null),t.__decorate([a.property()],l.prototype,"moving",void 0),t.__decorate([a.property({readOnly:!0})],l.prototype,"spatialReferenceSupported",null),t.__decorate([a.property({readOnly:!0})],l.prototype,"updateParameters",void 0),t.__decorate([a.property()],l.prototype,"updateRequested",void 0),t.__decorate([a.property()],l.prototype,"updating",null),t.__decorate([a.property()],l.prototype,"view",void 0),t.__decorate([a.property()],l.prototype,"_visibleAtCurrentScale",void 0),t.__decorate([a.property({readOnly:!0})],l.prototype,"visibleAtCurrentScale",null),l=t.__decorate([p.subclass("esri.views.2d.layers.LayerView2D")],l),l},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/linkChart/utils":function(){define(["exports"],function(e){"use strict";e.isLinkChartView=function(e){return null!=e&&"object"==typeof e&&"2d"===e.type&&"linkchart"===e.view2dType},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/layers/support/HighlightCounter":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/MapUtils","../../../../core/ReactiveMap","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,o,a,n,l,c){"use strict";e.HighlightCounter=class extends r{constructor(){super(...arguments),this._idToCounters=new s}get size(){return this._idToCounters.size}get objectIds(){return this._idToCounters.keys()}get highlightNamesByObjectId(){return function*(e){for(const[t,r]of e)yield[t,r.keys()]}(this._idToCounters)}add(e,t){let r=!1;for(const s of e){const e=i.getOrCreateMapValue(this._idToCounters,s,()=>(r=!0,new Map)),o=e.get(t)??0;o||(r=!0),e.set(t,o+1)}return r}delete(e,t){let r=!1;for(const i of e){const e=this._idToCounters.get(i);if(!e)continue;let s=e.get(t);null!=s&&(s--,s>0?e.set(t,s):(e.delete(t),r=!0),0===e.size&&(this._idToCounters.delete(i),r=!0))}return r}},e.HighlightCounter=t.__decorate([c.subclass("esri.views.2d.layers.support.HighlightCounter")],e.HighlightCounter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/support/ClipRect":function(){define(["exports","../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./ClipArea"],function(e,t,r,i,s,o,a,n){"use strict";var l;return e.default=l=class extends n{constructor(e){super(e),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new l({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}},t.__decorate([r.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"left",void 0),t.__decorate([r.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"right",void 0),t.__decorate([r.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"top",void 0),t.__decorate([r.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"bottom",void 0),e.default=l=t.__decorate([a.subclass("esri.views.layers.support.ClipRect")],e.default),e.default})},"esri/views/layers/support/ClipArea":function(){define(["exports","../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,o,a,n){"use strict";return e.default=class extends r.JSONSupport{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}},t.__decorate([i.property({readOnly:!0})],e.default.prototype,"version",null),e.default=t.__decorate([n.subclass("esri.views.layers.support.ClipArea")],e.default),e.default})},"esri/views/layers/support/Geometry":function(){define(["exports","../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../../../geometry/Geometry","../../../geometry/Polygon","../../../geometry/support/jsonUtils","./ClipArea"],function(e,t,r,i,s,o,a,n,l,c,p,h){"use strict";var u;const d={base:l,key:"type",typeMap:{extent:n,polygon:c}};return e.default=u=class extends h{constructor(e){super(e),this.type="geometry",this.geometry=null}clone(){return new u({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}},t.__decorate([r.property({types:d,json:{read:p.fromJSON,write:!0}})],e.default.prototype,"geometry",void 0),e.default=u=t.__decorate([a.subclass("esri.views.layers.support.Geometry")],e.default),e.default})},"esri/views/layers/support/Path":function(){define(["exports","../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./ClipArea"],function(e,t,r,i,s,o,a,n){"use strict";return e.default=class extends n{constructor(e){super(e),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}},t.__decorate([r.property({type:[[[Number]]],json:{write:!0}})],e.default.prototype,"path",void 0),e.default=t.__decorate([a.subclass("esri.views.layers.support.Path")],e.default),e.default})},"esri/views/2d/layers/graphics/HighlightGraphicContainer":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","./AGraphicContainer","../support/util"],function(e,t,r,i,s,o,a,n,l){"use strict";return e.default=class extends n.AGraphicContainer{get hasHighlight(){return this.children.some(e=>e.hasData)}renderChildren(e){this.attributeView.update(),16===e.drawPhase&&this.children.some(e=>e.hasData)&&(super.renderChildren(e),e.context.setColorMask(!0,!0,!0,!0),l.renderHighlight(e,!1,e=>{this._renderChildren(e,1)}))}},e.default=t.__decorate([a.subclass("esri.views.2d.layers.graphics.HighlightGraphicContainer")],e.default),e.default})},"esri/views/2d/layers/support/imageUtils":function(){define(["exports"],function(e){"use strict";function t(e){const t=document.createElement("canvas");return[t.width,t.height]=e,t}e.createBlankImage=t,e.resampleImage=function(e,r,i,s){if(i.level===s.level)return r;const o=e.tileInfo.size,a=e.getTileResolution(i.level),n=e.getTileResolution(s.level);let l=e.getLODInfoAt(s.level);const c=l.getXForColumn(s.col),p=l.getYForRow(s.row);l=e.getLODInfoAt(i.level);const h=l.getXForColumn(i.col),u=l.getYForRow(i.row),d=function(e){return e instanceof HTMLImageElement?e.naturalWidth:e.width}(r)/o[0],y=function(e){return e instanceof HTMLImageElement?e.naturalHeight:e.height}(r)/o[1],g=Math.round(d*((c-h)/a)),f=Math.round(y*(-(p-u)/a)),m=Math.round(d*o[0]*(n/a)),b=Math.round(y*o[1]*(n/a)),w=t(o);return w.getContext("2d").drawImage(r,g,f,m,b,0,0,o[0],o[1]),w},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/RefreshableLayerView":function(){define(["exports","../../chunks/tslib.es6","../../core/Logger","../../core/promiseUtils","../../core/reactiveUtils","../../core/has","../../core/RandomLCG","../../core/Error","../../core/accessorSupport/decorators/subclass"],function(e,t,r,i,s,o,a,n,l){"use strict";e.RefreshableLayerView=e=>{const o=e;let a=class extends o{initialize(){this.addHandles(s.on(()=>this.layer,"refresh",e=>{this.doRefresh(e.dataChanged).catch(e=>{i.isAbortError(e)||r.getLogger(this).error(e)})}),"RefreshableLayerView")}};return a=t.__decorate([l.subclass("esri.views.layers.RefreshableLayerView")],a),a},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/support/highlightUtils":function(){define(["exports","../../../core/arrayUtils","../../../core/Collection","../../../support/guards"],function(e,t,r,i){"use strict";e.getHighlightGraphics=function(e){if(!e)return[];let s=i.isGraphic(e)?[e]:r.isCollection(e)?e.toArray():Array.isArray(e)?e:[];return s=s?.filter(t.isSome),0===(s?.length??0)?[]:s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/support/MapServiceLayerViewHelper":function(){define(["require","exports","../../../chunks/tslib.es6","../../../Color","../../../core/Accessor","../../../core/arrayUtils","../../../core/Error","../../../core/has","../../../core/MapUtils","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/sql","../../../core/unitUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../../../geometry/support/scaleUtils","../../../layers/support/fieldUtils","../../../layers/support/floorFilterUtils","../../../renderers/support/clickToleranceUtils","../../../rest/identify","../../../rest/support/IdentifyParameters","../../../support/loadArcade","../../../symbols/SimpleMarkerSymbol","./popupUtils"],function(e,t,r,i,s,o,a,n,l,c,p,h,u,d,y,g,f,m,b,w,_,v,S,I,T,x){"use strict";let P=null;function V(e,t,r){const i=[];if(!e)return i;const s=e=>{const o=0===e.minScale||t<=e.minScale,a=0===e.maxScale||t>=e.maxScale;if(e.visible&&o&&a)if(e.sublayers)e.sublayers.forEach(s);else if(e.popupEnabled){const t=x.getFetchPopupTemplate(e,{...r,defaultPopupTemplateEnabled:!1});null!=t&&i.unshift({sublayer:e,popupTemplate:t})}};return e.map(s),i}t.MapServiceLayerViewHelper=class extends s{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=c.debounce(async e=>{this.destroyed||await this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch(()=>{}))})}initialize(){const e=e=>{for(const t of e){const{sourceLayer:e}=t;null!=e&&"geometryType"in e&&"point"===e.geometryType&&t.visible&&(t.visible=!1,this.highlightGraphicUpdated?.({graphic:t,property:"visible",oldValue:!0,newValue:!1}))}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([p.on(()=>this.highlightGraphics,"change",t=>e(t.added),{onListenerAdd:t=>e(t)})])}async fetchPopupFeaturesAtLocation(e,t){const{layerView:{layer:r,view:{scale:i}}}=this;if(!e)throw new a("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:r});const s=V(r.sublayers,i,t);if(!s.length)return[];const o=await async function(e,t){if(e.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(t.map(({sublayer:e})=>e.load().then(()=>e.capabilities.operations.supportsQuery)))}catch{return!1}}(r,s);if(!((r.capabilities?.operations?.supportsIdentify??1)&&r.version>=10.5||o))throw new a("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:r});return o?this._fetchPopupFeaturesUsingQueries(e,s,t):this._fetchPopupFeaturesUsingIdentify(e,s,t)}clearHighlights(){this.highlightGraphics?.removeAll()}async _updateHighlightedFeaturesSymbols(e){for(const t of e)this._updateSymbology(t)}_updateSymbology(e){if("point"===e.geometry?.type)return this._updatePointSymbology(e)}_setGraphicSymbol(e,t){if(!t)return;const r=e.symbol;e.symbol=t,this.highlightGraphicUpdated?.({graphic:e,property:"symbol",oldValue:r,newValue:t})}_updatePointSymbology(t){const r=t.sourceLayer&&"renderer"in t.sourceLayer&&t.sourceLayer.renderer,{highlightGraphicUpdated:s,highlightGraphics:o,layerView:{view:a}}=this,n=e=>{e.visible||(e.visible=!0,s?.({graphic:e,property:"visible",oldValue:!1,newValue:!0}))};r&&"getSymbolAsync"in r?r.getSymbolAsync(t).then(async s=>{s||=new T;let l=null;const c="visualVariables"in r?r.visualVariables?.find(e=>"size"===e.type):void 0;c&&(P||(P=(await new Promise((t,r)=>e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,r))).getSize),l=P(c,t,{view:a.type,scale:a.scale,shape:"simple-marker"===s.type?s.style:null})),l||="width"in s&&"height"in s&&null!=s.width&&null!=s.height?Math.max(s.width,s.height):"size"in s?s.size:16,o?.includes(t)&&(this._setGraphicSymbol(t,new T({style:"square",size:l,color:new i([255,255,255,1/255]),xoffset:"xoffset"in s?s.xoffset:0,yoffset:"yoffset"in s?s.yoffset:0})),n(t))}):n(t)}async _updateHighlightedFeaturesGeometries(e){const{layerView:{layer:t,view:r},highlightGraphics:i,highlightGraphicUpdated:s}=this;if(this._highlightGeometriesResolution=e,!s||!i?.length||!t.capabilities.operations.supportsQuery)return;const o=this._getTargetResolution(e),a=new Map;for(const e of i)if(!this._featuresResolutions.has(e)||this._featuresResolutions.get(e)>o){const t=e.sourceLayer;l.getOrCreateMapValue(a,t,()=>new Map).set(e.getObjectId(),e)}const n=Array.from(a,([e,t])=>{const i=e.createQuery();return i.objectIds=[...t.keys()],i.outFields=[e.objectIdField],i.returnGeometry=!0,i.maxAllowableOffset=o,i.outSpatialReference=r.spatialReference,e.queryFeatures(i)}),c=await Promise.all(n);if(!this.destroyed)for(const{features:e}of c)for(const t of e){const e=t.sourceLayer,r=a.get(e).get(t.getObjectId());if(r&&i.includes(r)){const e=r.geometry;r.geometry=t.geometry,s({graphic:r,property:"geometry",oldValue:e,newValue:r.geometry}),this._featuresResolutions.set(r,o)}}}_getTargetResolution(e){const t=e*u.getMetersPerUnitForSR(this.layerView.view.spatialReference),r=t/16;return r<=10?0:e/t*r}async _fetchPopupFeaturesUsingIdentify(e,t,r){const i=await this._createIdentifyParameters(e,t,r);if(null==i)return[];const{results:s}=await v.identify(this.layerView.layer.parsedUrl,i,r);return s.map(e=>e.feature)}async _createIdentifyParameters(e,t,r){const{floors:i,layer:s,timeExtent:o,view:{spatialReference:a,scale:l}}=this.layerView;if(!t.length)return null;await Promise.all(t.map(({sublayer:e})=>e.load(r).catch(()=>{})));const c=Math.min(n("mapservice-popup-identify-max-tolerance"),s.allSublayers.reduce((e,t)=>t.renderer?_.calculateTolerance({renderer:t.renderer,pointerType:r?.pointerType}):e,2)),p=this.createFetchPopupFeaturesQueryGeometry(e,c),h=m.getResolutionForScale(l,a),u=Math.round(p.width/h),d=new f({xmin:p.center.x-h*u,ymin:p.center.y-h*u,xmax:p.center.x+h*u,ymax:p.center.y+h*u,spatialReference:p.spatialReference});return new S({floors:i,gdbVersion:"gdbVersion"in s?s.gdbVersion:void 0,geometry:e,height:u,layerOption:"popup",mapExtent:d,returnGeometry:!0,spatialReference:a,sublayers:s.sublayers,timeExtent:o,tolerance:c,width:u})}async _fetchPopupFeaturesUsingQueries(e,t,r){const{layerView:{floors:i,timeExtent:s}}=this,a=t.map(async({sublayer:t,popupTemplate:o})=>{if(await t.load(r).catch(()=>{}),t.capabilities&&!t.capabilities.operations.supportsQuery)return[];const a=t.createQuery(),n=_.calculateTolerance({renderer:t.renderer,pointerType:r?.pointerType}),l=this.createFetchPopupFeaturesQueryGeometry(e,n),p=new Set,[u]=await Promise.all([x.getRequiredFields(t,o),t.renderer?.collectRequiredFields(p,t.fieldsIndex)]);c.throwIfAborted(r),b.collectFields(p,t.fieldsIndex,u);const d=Array.from(p).sort();a.geometry=l,a.outFields=d,a.timeExtent=s;const y=w.getLayerFloorFilterClause(i,t);if(a.where=h.sqlAnd(a.where,y),t.capabilities?.query.supportsOrderBy&&t.orderBy?.[0]){const e=t.orderBy[0],r=!e.valueExpression&&e.field,i="ascending"===e.order?"asc":"desc";r&&(a.orderByFields=[`${r} ${i}`])}const g=this._getTargetResolution(l.width/n),f=await function(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some(e=>"expression"===e.type)?I.loadArcade():Promise.resolve()}(o);c.throwIfAborted(r);const m="point"===t.geometryType||f&&f.arcadeUtils.hasGeometryOperations(o);m||(a.maxAllowableOffset=g);let{features:v}=await t.queryFeatures(a,r);const S=m?0:g;v=await async function(e,t,r){const i=e.renderer;return i&&"defaultSymbol"in i&&!i.defaultSymbol&&(t=i.valueExpression?await Promise.all(t.map(e=>i.getSymbolAsync(e,r).then(t=>t?e:null))).then(e=>e.filter(e=>null!=e)):t.filter(e=>null!=i.getSymbol(e))),t}(t,v,r);for(const e of v)this._featuresResolutions.set(e,S);return v});return(await Promise.allSettled(a)).reduce((e,t)=>"fulfilled"===t.status?[...e,...t.value]:e,[]).filter(o.isSome)}},r.__decorate([d.property({constructOnly:!0})],t.MapServiceLayerViewHelper.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),r.__decorate([d.property({constructOnly:!0})],t.MapServiceLayerViewHelper.prototype,"layerView",void 0),r.__decorate([d.property({constructOnly:!0})],t.MapServiceLayerViewHelper.prototype,"highlightGraphics",void 0),r.__decorate([d.property({constructOnly:!0})],t.MapServiceLayerViewHelper.prototype,"highlightGraphicUpdated",void 0),r.__decorate([d.property({constructOnly:!0})],t.MapServiceLayerViewHelper.prototype,"updatingHandles",void 0),t.MapServiceLayerViewHelper=r.__decorate([g.subclass("esri.views.layers.support.MapServiceLayerViewHelper")],t.MapServiceLayerViewHelper),t.collectPopupProviders=V,t.isMapServiceLayerView=function(e,t){return"tile"===t.type||"map-image"===t.type},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/floorFilterUtils":function(){define(["exports"],function(e){"use strict";function t(e,t){if(!e?.length)return null;const r=e.filter(e=>""!==e).map(e=>`'${e}'`);return r.push("''"),`${t} IN (${r.join(",")}) OR ${t} IS NULL`}e.getFloorFilterClause=function(e){const r=e.layer;return"floorInfo"in r&&r.floorInfo?.floorField&&"floors"in e.view?t(e.view.floors,r.floorInfo.floorField):null},e.getLayerFloorFilterClause=function(e,r){return"floorInfo"in r&&r.floorInfo?.floorField?t(e,r.floorInfo.floorField):null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/renderers/support/clickToleranceUtils":function(){define(["exports"],function(e){"use strict";function t(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function r(e,t){return"number"==typeof e?e:e?.stops?.length?function(e){let t=0,r=0;for(let i=0;i<e.length;i++){const s=e[i].size;"number"==typeof s&&(t+=s,r++)}return t/r}(e.stops):t}e.calculateTolerance=function(e){const i=e?.renderer,s=e?.pointerType,o="touch"===s?9:6;if(!i)return o;const a="visualVariables"in i?function(e,t){if(!t)return e;const i=t.filter(e=>"size"===e.type).map(t=>{const{maxSize:i,minSize:s}=t;return(r(i,e)+r(s,e))/2});let s=0;const o=i.length;if(0===o)return e;for(let e=0;e<o;e++)s+=i[e];const a=Math.floor(s/o);return Math.max(a,e)}(o,i.visualVariables):o;if("simple"===i.type)return t(a,i.symbol);if("unique-value"===i.type){let e=a;return i.uniqueValueInfos?.forEach(r=>{e=t(e,r.symbol)}),e}if("class-breaks"===i.type){let e=a;return i.classBreakInfos.forEach(r=>{e=t(e,r.symbol)}),e}return"dot-density"===i.type||i.type,a},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/rest/identify":function(){define(["exports","../request","../geometry/support/normalizeUtils","./utils","./operations/identify","./support/IdentifyParameters","./support/IdentifyResult"],function(e,t,r,i,s,o,a){"use strict";function n(e){const t=e.data;return t.results=t.results||[],t.exceededTransferLimit=Boolean(t.exceededTransferLimit),t.results=t.results.map(e=>a.fromJSON(e)),t}e.identify=async function(e,a,l){const c=(a=function(e){return o.from(e)}(a)).geometry?[a.geometry]:[],p=i.parseUrl(e);return p.path+="/identify",r.normalizeCentralMeridian(c).then(e=>{const r=s.identifyToIdentifyRESTParameters(a,{geometry:e?.[0]}),o=i.encode({...p.query,f:"json",...r}),c=i.asValidOptions(o,l);return t(p.path,c).then(n).then(e=>function(e,t){if(!t?.length)return e;const r=new Map;t.forEach(function e(t){r.set(t.id,t),t.sublayers&&t.sublayers.forEach(e)});for(const t of e.results)t.feature.sourceLayer=r.get(t.layerId);return e}(e,a.sublayers))})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/rest/operations/identify":function(){define(["exports","../../core/sql","../../geometry/support/jsonUtils","../../geometry/support/scaleUtils","../../geometry/support/spatialReferenceUtils","../../layers/support/floorFilterUtils","../../layers/support/sublayerUtils"],function(e,t,r,i,s,o,a){"use strict";function n(e){const{mapExtent:r,floors:s,width:n,sublayers:l,layerIds:c,layerOption:p,gdbVersion:h}=e,u=l?.find(e=>null!=e.layer)?.layer?.serviceSublayers,d="popup"===p,y={},g={extent:r,width:n,spatialReference:r?.spatialReference},f=i.getScale(g),m=[],b=e=>{const t=0===f,r=0===e.minScale||f<=e.minScale,i=0===e.maxScale||f>=e.maxScale;if(e.visible&&(t||r&&i))if(e.sublayers)e.sublayers.forEach(b);else{if(!1===c?.includes(e.id)||d&&(!e.popupTemplate||!e.popupEnabled))return;m.unshift(e)}};if(l?.forEach(b),l&&!m.length)y.layerIds=[];else{const e=a.isExportDynamic(m,u,h),r=m.map(e=>{const t=o.getLayerFloorFilterClause(s,e);return e.toExportImageJSON(t)});if(e)y.dynamicLayers=JSON.stringify(r);else{if(l){let e=m.map(({id:e})=>e);c&&(e=e.filter(e=>c.includes(e))),y.layerIds=e}else c?.length&&(y.layerIds=c);const e=function(e,r){const i=!!e?.length,s=r.filter(e=>null!=e.definitionExpression||i&&null!=e.floorInfo);return s.length?s.map(r=>{const i=o.getLayerFloorFilterClause(e,r),s=t.sqlAnd(i,r.definitionExpression);return{id:r.id,definitionExpression:s??void 0}}):null}(s,m);if(null!=e&&e.length){const t={};for(const r of e)r.definitionExpression&&(t[r.id]=r.definitionExpression);Object.keys(t).length&&(y.layerDefs=JSON.stringify(t))}}}return y}e.identifyToIdentifyRESTParameters=function(e,t){const{dpi:i,gdbVersion:o,geometry:a,geometryPrecision:l,height:c,historicMoment:p,layerOption:h,mapExtent:u,maxAllowableOffset:d,returnFieldName:y,returnGeometry:g,returnUnformattedValues:f,returnZ:m,spatialReference:b,timeExtent:w,tolerance:_,width:v}=e.toJSON(),{dynamicLayers:S,layerDefs:I,layerIds:T}=n(e),x=null!=t?.geometry?t.geometry:null,P={historicMoment:p,geometryPrecision:l,maxAllowableOffset:d,returnFieldName:y,returnGeometry:g,returnUnformattedValues:f,returnZ:m,tolerance:_},V=x?.toJSON()||a;P.imageDisplay=`${v},${c},${i}`,o&&(P.gdbVersion=o),V&&(delete V.spatialReference,P.geometry=JSON.stringify(V),P.geometryType=r.getJsonType(V));const C=b??V?.spatialReference??u?.spatialReference;if(C&&(P.sr=s.srToRESTValue(C)),P.time=w?[w.start,w.end].join(","):null,u){const{xmin:e,ymin:t,xmax:r,ymax:i}=u;P.mapExtent=`${e},${t},${r},${i}`}return I&&(P.layerDefs=I),S&&!I&&(P.dynamicLayers=S),P.layers="popup"===h?"visible":h,T&&!S&&(P.layers+=`:${T.join(",")}`),P},e.toDynamicLayersJSON=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/sublayerUtils":function(){define(["exports"],function(e){"use strict";function t(e,t){if(!e?.length||null==t)return!0;const r=t.slice().reverse().flatten(({sublayers:e})=>e&&e.toArray().reverse()).map(e=>e.id).toArray();if(e.length>r.length)return!1;let i=0;const s=r.length;for(const{id:t}of e){for(;i<s&&r[i]!==t;)i++;if(i>=s)return!1}return!0}e.isExportDynamic=function(e,r,i){return!!e.some(e=>{const t=e.source,r=!t||"map-layer"===t.type&&t.mapLayerId===e.id&&(null==t.gdbVersion||t.gdbVersion===i);e.commitProperty("renderer"),e.commitProperty("labelingInfo"),e.commitProperty("opacity"),e.commitProperty("labelsVisible"),e.commitProperty("orderBy");const s=e.layer?.capabilities?.exportMap?.supportsSublayerOrderBy??!1;return!r||e.originIdOf("renderer")>2||e.originIdOf("labelingInfo")>2||e.originIdOf("opacity")>2||e.originIdOf("labelsVisible")>2||s&&e.originIdOf("orderBy")>2})||!t(e,r)},e.isSublayerOverhaul=function(e){return!!e&&e.some(e=>null!=e.minScale||null!=e.layerDefinition?.minScale)},e.shouldWriteSublayerStructure=function(e,r,i){return r.flatten(({sublayers:e})=>e).length!==e.length||!!e.some(e=>e.originIdOf("minScale")>i||e.originIdOf("maxScale")>i||e.originIdOf("renderer")>i||e.originIdOf("labelingInfo")>i||e.originIdOf("opacity")>i||e.originIdOf("labelsVisible")>i||e.originIdOf("source")>i)||!t(e,r)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/rest/support/IdentifyParameters":function(){define(["../../chunks/tslib.es6","../../core/Collection","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../geometry/Extent","../../geometry/SpatialReference","../../geometry/support/jsonUtils","../../geometry/support/typeUtils","../../chunks/TimeExtent"],function(e,t,r,i,s,o,a,n,l,c,p,h,u,d){"use strict";var y;let g=y=class extends r.JSONSupport{static from(e){return s.ensureClass(y,e)}constructor(e){super(e),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}};return e.__decorate([i.property({type:Number,json:{write:!0}})],g.prototype,"dpi",void 0),e.__decorate([i.property()],g.prototype,"floors",void 0),e.__decorate([i.property({type:String,json:{write:!0}})],g.prototype,"gdbVersion",void 0),e.__decorate([i.property({types:u.geometryTypes,json:{read:h.fromJSON,write:!0}})],g.prototype,"geometry",void 0),e.__decorate([i.property({type:Number,json:{write:!0}})],g.prototype,"geometryPrecision",void 0),e.__decorate([i.property({type:Number,json:{write:!0}})],g.prototype,"height",void 0),e.__decorate([i.property({type:Date})],g.prototype,"historicMoment",void 0),e.__decorate([l.writer("historicMoment")],g.prototype,"writeHistoricMoment",null),e.__decorate([i.property({type:[Number],json:{write:!0}})],g.prototype,"layerIds",void 0),e.__decorate([i.property({type:["top","visible","all","popup"],json:{write:!0}})],g.prototype,"layerOption",void 0),e.__decorate([i.property({type:c,json:{write:!0}})],g.prototype,"mapExtent",void 0),e.__decorate([i.property({type:Number,json:{write:!0}})],g.prototype,"maxAllowableOffset",void 0),e.__decorate([i.property({type:Boolean,json:{write:!0}})],g.prototype,"returnFieldName",void 0),e.__decorate([i.property({type:Boolean,json:{write:!0}})],g.prototype,"returnGeometry",void 0),e.__decorate([i.property({type:Boolean,json:{write:!0}})],g.prototype,"returnM",void 0),e.__decorate([i.property({type:Boolean,json:{write:!0}})],g.prototype,"returnUnformattedValues",void 0),e.__decorate([i.property({type:Boolean,json:{write:!0}})],g.prototype,"returnZ",void 0),e.__decorate([i.property({type:p,json:{write:!0}})],g.prototype,"spatialReference",void 0),e.__decorate([i.property({type:t})],g.prototype,"sublayers",void 0),e.__decorate([i.property({type:d.TimeExtent,json:{write:!0}})],g.prototype,"timeExtent",void 0),e.__decorate([i.property({type:Number,json:{write:!0}})],g.prototype,"tolerance",void 0),e.__decorate([i.property({type:Number,json:{write:!0}})],g.prototype,"width",void 0),g=y=e.__decorate([n.subclass("esri.rest.support.IdentifyParameters")],g),g})},"esri/rest/support/IdentifyResult":function(){define(["../../chunks/tslib.es6","../../Graphic","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../geometry/support/typeUtils"],function(e,t,r,i,s,o,a,n,l,c,p){"use strict";let h=class extends r.JSONSupport{constructor(e){super(e),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(e,r){return t.fromJSON({attributes:{...r.attributes},geometry:{...r.geometry}})}writeFeature(e,t){if(!e)return;const{attributes:r,geometry:i}=e;r&&(t.attributes={...r}),null!=i&&(t.geometry=i.toJSON(),t.geometryType=p.typeKebabDictionary.toJSON(i.type))}};return e.__decorate([i.property({type:String,json:{write:!0}})],h.prototype,"displayFieldName",void 0),e.__decorate([i.property({type:t})],h.prototype,"feature",void 0),e.__decorate([n.reader("feature",["attributes","geometry"])],h.prototype,"readFeature",null),e.__decorate([c.writer("feature")],h.prototype,"writeFeature",null),e.__decorate([i.property({type:Number,json:{write:!0}})],h.prototype,"layerId",void 0),e.__decorate([i.property({type:String,json:{write:!0}})],h.prototype,"layerName",void 0),h=e.__decorate([l.subclass("esri.rest.support.IdentifyResult")],h),h})},"esri/views/layers/support/popupUtils":function(){define(["exports","../../../layers/support/fieldUtils"],function(e,t){"use strict";function r(e,t){return e&&"object"==typeof e?t?.checkPopupEnabled&&"popupEnabled"in e&&!e.popupEnabled?null:"popupTemplate"in e&&e.popupTemplate?e.popupTemplate:null!=t&&t.defaultPopupTemplateEnabled&&"defaultPopupTemplate"in e&&e.defaultPopupTemplate?e.defaultPopupTemplate:null:null}e.getFetchPopupTemplate=r,e.getRequiredFields=async function(e,r=e.popupTemplate){if(null==r)return[];const i=await r.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:s}=r,{objectIdField:o,typeIdField:a,globalIdField:n,relationships:l}=e;if(i.includes("*"))return["*"];const c=s?t.getFeatureEditFields(e):[],p=t.fixFields(e.fieldsIndex,[...i,...c]);return a&&p.push(a),p&&o&&e.fieldsIndex?.has(o)&&!p.includes(o)&&p.push(o),p&&n&&e.fieldsIndex?.has(n)&&!p.includes(n)&&p.push(n),l&&l.forEach(t=>{const{keyField:r}=t;p&&r&&e.fieldsIndex?.has(r)&&!p.includes(r)&&p.push(r)}),p},e.hasPopupTemplate=function(e,t){return null!=r(e,{defaultPopupTemplateEnabled:t})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/drapedUtils":function(){define(["exports","../../core/unitUtils","../../geometry/Extent","../../renderers/support/clickToleranceUtils"],function(e,t,r,i){"use strict";function s(e,i,s,o=new r){let a=0;if("2d"===s.type)a=i*(s.resolution??0);else if("3d"===s.type){const r=s.overlayPixelSizeInMapUnits(e),o=s.basemapSpatialReference;a=null==o||o.equals(s.spatialReference)?i*r:t.getMetersPerUnitForSR(o)/t.getMetersPerUnitForSR(s.spatialReference)}const n=e.x-a,l=e.y-a,c=e.x+a,p=e.y+a,{spatialReference:h}=s;return o.xmin=Math.min(n,c),o.ymin=Math.min(l,p),o.xmax=Math.max(n,c),o.ymax=Math.max(l,p),o.spatialReference=h,o}let o=new r;e.cleanupDrapedUtils=function(){o=new r},e.createQueryGeometry=s,e.intersectsDrapedGeometry=function(e,t,r){const a=r.toMap(e);return null!=a&&s(a,i.calculateTolerance(),r,o).intersects(t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/highlightOptionsUtils":function(){define(["exports","../../core/Collection","./HighlightDefaults","./HighlightOptions"],function(e,t,r,i){"use strict";e.createInitialHighlightOptions=function(){return new t([new i({name:r.defaultHighlightName}),new i({name:r.temporaryHighlightName,color:r.temporaryHighlightColor})])},e.getHighlightName=function(e){return e?.name??r.defaultHighlightName},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})},"*noref":1}}),define(["../../../chunks/tslib.es6","../../../core/handleUtils","../../../core/Logger","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/spatialReferenceUtils","../../../support/GraphicsCollection","../../../core/Error","../../../core/scheduling","../../../Color","../../../core/mathUtils","../../../config","../../../core/floatRGBA","../../../geometry/Extent","../../../geometry/Geometry","../../../geometry/Multipoint","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/Polyline","../../../symbols/Font","../../../core/ObjectPool","../../../symbols/cim/effects/EffectAddControlPoints","../../../symbols/cim/effects/EffectArrow","../../../symbols/cim/effects/EffectBuffer","../../../symbols/cim/effects/EffectControlMeasureLine","../../../symbols/cim/effects/EffectCut","../../../symbols/cim/effects/EffectDashes","../../../symbols/cim/effects/EffectDonut","../../../symbols/cim/effects/EffectEnclosingPolygon","../../../symbols/cim/effects/EffectJog","../../../symbols/cim/effects/EffectMove","../../../symbols/cim/effects/EffectOffset","../../../symbols/cim/effects/EffectRadial","../../../symbols/cim/effects/EffectReverse","../../../symbols/cim/effects/EffectRotate","../../../symbols/cim/effects/EffectScale","../../../symbols/cim/effects/EffectSuppress","../../../symbols/cim/effects/EffectTaperedPolygon","../../../symbols/cim/effects/EffectWave","../../../symbols/cim/placements/PlacementAlongLineSameSize","../../../symbols/cim/placements/PlacementAtExtremities","../../../symbols/cim/placements/PlacementAtRatioPositions","../../../symbols/cim/placements/PlacementInsidePolygon","../../../symbols/cim/placements/PlacementOnLine","../../../symbols/cim/placements/PlacementOnVertices","../../../symbols/cim/placements/PlacementPolygonCenter","../../../symbols/cim/constants","../../../core/libs/gl-matrix-2/factories/vec2f32","../../../symbols/support/defaults","../../../symbols/cim/OverrideHelper","../../../layers/effects/EffectView","../../../core/Accessor","../engine/transitions/FadeTransition","../../../core/libs/gl-matrix-2/factories/vec4f32","../../webgl/enums","../engine/webgl/shaders/BackgroundPrograms","../../webgl/Program","../../webgl/checkWebGLError","../../webgl/VertexAttributeLayouts","../../webgl/BufferObject","../engine/webgl/AFeatureTile","../engine/webgl/DisplayEntity","../engine/webgl/shaderGraph/techniques/featureTechniqueUtils","../engine/webgl/cpuMapped/MappedMesh","../engine/webgl/number","../engine/webgl/shaders/TileInfoPrograms","../../webgl/Texture","../engine/webgl/shaders/BitBlitPrograms","../../../request","../../../core/urlUtils","../../../core/pbf","../engine/webgl/shaders/StencilPrograms","../engine/webgl/shaderGraph/techniques/shaders/BlendShader","../engine/webgl/shaderGraph/techniques/shaders/OpacityShader","../engine/webgl/shaders/HighlightPrograms","../../webgl/FramebufferObject","../engine/webgl/meshing/SimpleMesh","../../webgl/Renderbuffer","../engine/webgl/PooledUint32Array","../engine/webgl/Profiler","../engine/webgl/shaderGraph/techniques/TechniqueRegistry","../engine/webgl/shaderGraph/techniques/animated/attributes","../engine/webgl/mesh/templates/templateUtils","../engine/webgl/shaderGraph/techniques/line/LineMeshWriter","../engine/webgl/shaderGraph/techniques/dotDensity/DotDensityMeshWriter","../engine/webgl/shaderGraph/techniques/fill/ComplexFillMeshWriter","../engine/webgl/shaderGraph/techniques/fill/ComplexOutlineFillMeshWriter","../engine/webgl/shaderGraph/techniques/fill/FillMeshWriter","../engine/webgl/shaderGraph/techniques/fill/GradientFillMeshWriter","../engine/webgl/shaderGraph/techniques/fill/OutlineFillMeshWriter","../engine/webgl/shaderGraph/techniques/fill/PatternFillMeshWriter","../engine/webgl/shaderGraph/techniques/fill/PatternOutlineFillMeshWriter","../engine/webgl/shaderGraph/techniques/heatmap/HeatmapMeshWriter","../../../geometry/support/aaBoundingBox","../engine/webgl/shaderGraph/techniques/text/TextMeshWriter","../engine/webgl/shaderGraph/techniques/line/GradientStrokeMeshWriter","../engine/webgl/shaderGraph/techniques/line/TexturedLineMeshWriter","../engine/webgl/shaderGraph/techniques/markers/MarkerMeshWriter","../../../core/sql/UnknownTimeZone","../../../intl/locale","../../../layers/support/fieldUtils","../../../time/constants","../engine/webgl/animations/instructions","../engine/webgl/shaderGraph/techniques/pieChart/PieChartMeshWriter","../../webgl/renderState","../../3d/webgl-engine/core/shaderModules/glsl","../../webgl/testSVGPremultipliedAlpha","../../../chunks/pe","../engine/webgl/meshing/definitions","../engine/webgl/shaderGraph/techniques/shaders/VideoScreenShader","../LabelManager","./graphics/GraphicsView2D","../../../core/accessorSupport/watch","../../../core/accessorSupport/tracking/SimpleTrackingTarget","../../../chunks/earcut","../../../core/libs/gl-matrix-2/factories/vec3f32","../../../geometry/support/normalizeUtilsCommon","../../../geometry/SpatialReference","../../../geometry/support/Ellipsoid","../../../kernel","./support/util","../navigation/MapViewNavigation","../../../core/asyncUtils","../../../core/support/UpdatingHandles","../engine/webgl/shaderGraph/techniques/shaders/MagnifierShader","../../../core/unitUtils","../../../geometry/ellipsoidUtils","../../../geometry/projection/projectors","../engine/webgl/shaderGraph/techniques/shaders/GridShader","../../../geometry/support/geodesicConstants","./BitmapTileLayerView2D","./LayerView2D","./graphics/HighlightGraphicContainer","./support/imageUtils","../tiling/TileInfoView","../tiling/TileKey","../tiling/TileQueue","../tiling/TileStrategy","../../layers/LayerView","../../layers/RefreshableLayerView","../../layers/support/highlightUtils","../../layers/support/MapServiceLayerViewHelper","../../support/drapedUtils","../../support/highlightOptionsUtils","../../support/Scheduler"],function(e,t,r,i,s,o,a,n,l,c,p,h,u,d,y,g,f,m,b,w,_,v,S,I,T,x,P,V,C,R,M,H,O,L,G,U,E,F,A,q,j,k,N,B,D,z,W,Q,J,$,Z,K,X,Y,ee,te,re,ie,se,oe,ae,ne,le,ce,pe,he,ue,de,ye,ge,fe,me,be,we,_e,ve,Se,Ie,Te,xe,Pe,Ve,Ce,Re,Me,He,Oe,Le,Ge,Ue,Ee,Fe,Ae,qe,je,ke,Ne,Be,De,ze,We,Qe,Je,$e,Ze,Ke,Xe,Ye,et,tt,rt,it,st,ot,at,nt,lt,ct,pt,ht,ut,dt,yt,gt,ft,mt,bt,wt,_t,vt,St,It,Tt,xt,Pt,Vt,Ct,Rt,Mt,Ht,Ot,Lt,Gt,Ut,Et,Ft,At,qt){"use strict";const jt=[0,0];let kt=class extends(Gt.RefreshableLayerView(xt.BitmapTileLayerView2D(Pt.LayerView2DMixin(Lt)))){constructor(){super(...arguments),this._fetchQueue=null,this._highlightGraphics=new c.GraphicsCollection,this._highlightView=null,this._popupHighlightHelper=null,this._tileStrategy=null,this.layer=null}get resampling(){return!("resampling"in this.layer)||!1!==this.layer.resampling}get tilemapCache(){return"tilemapCache"in this.layer?this.layer.tilemapCache:null}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume(),this._highlightView?.processUpdate(e)}attach(){const e="tileServers"in this.layer?this.layer.tileServers:null,t=this.tilemapCache;if(this._tileInfoView=new Rt(this.layer.tileInfo,this.layer.fullExtent,t?.effectiveMinLOD,t?.effectiveMaxLOD),this._fetchQueue=new Ht({tileInfoView:this._tileInfoView,concurrency:e&&10*e.length||10,process:(e,t)=>this.fetchTile(e,t),scheduler:this.scheduler,priority:qt.TaskPriority.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new Ot({cachePolicy:"keep",resampling:this.resampling,acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView}),Et.isMapServiceLayerView(this,this.layer)){const e=this._highlightView=new at({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new Vt(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1});this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new Et.MapServiceLayerViewHelper({createFetchPopupFeaturesQueryGeometry:(e,t)=>Ft.createQueryGeometry(e,t,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:({graphic:t,property:r})=>e.graphicUpdateHandler({graphic:t,property:r}),layerView:this,updatingHandles:this._updatingHandles})}this.requestUpdate(),this.addAttachHandles(this._updatingHandles.add(()=>this.resampling,()=>{this.doRefresh()})),super.attach()}detach(){super.detach(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._popupHighlightHelper?.destroy(),this._highlightView?.destroy(),this._fetchQueue=this._tileStrategy=this._tileInfoView=this._popupHighlightHelper=null}async fetchPopupFeaturesAtLocation(e,t){return this._popupHighlightHelper?this._popupHighlightHelper.fetchPopupFeaturesAtLocation(e,t):[]}highlight(e,r){const i=Ut.getHighlightGraphics(e);if(0===i.length)return t.makeHandle();const s=At.getHighlightName(r);return this._addHighlightGraphics(i,s),t.makeHandle(()=>!this.destroyed&&this._removeHighlightGraphics(i,s))}_processHighlight(){const e=this._getHighlights();this._highlightView?.setHighlight(e)}_addHighlightGraphics(e,t){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),t)}_removeHighlightGraphics(e,t){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),t)}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return l.equals(this.layer.tileInfo?.spatialReference,e)}async doRefresh(){if(this.attached){if(this.suspended)return this._tileStrategy.clear(),void this.requestUpdate();this._fetchQueue.reset(),this._tileStrategy.refresh(e=>this._updatingHandles.addPromise(this._enqueueTileFetch(e)))}}acquireTile(e){const t=this._bitmapView.createTile(e),r=t.bitmap;return[r.x,r.y]=this._tileInfoView.getTileCoords(jt,t.key),r.resolution=this._tileInfoView.getTileResolution(t.key),[r.width,r.height]=this._tileInfoView.tileInfo.size,this._updatingHandles.addPromise(this._enqueueTileFetch(t)),this._bitmapView.addChild(t),this.requestUpdate(),t}releaseTile(e){this._fetchQueue.abort(e.key.id),this._bitmapView.removeChild(e),e.once("detach",()=>e.destroy()),this.requestUpdate()}async fetchTile(e,t={}){return this.tilemapCache?this._fetchTileWithTilemapCache(e,t):this._fetchTileWithoutTilemapCache(e,t)}async _fetchTileWithoutTilemapCache(e,t={}){const{signal:r,resamplingLevel:s=0}=t;try{return await this._fetchImage(e,r)}catch(r){if(i.isAbortError(r))throw r;if(!this.resampling)return Ct.createBlankImage(this._tileInfoView.tileInfo.size);if(s<3){const r=this._tileInfoView.getTileParentId(e.id);if(r){const i=new Mt(r),o=await this._fetchTileWithoutTilemapCache(i,{...t,resamplingLevel:s+1});return Ct.resampleImage(this._tileInfoView,o,i,e)}}return Ct.createBlankImage(this._tileInfoView.tileInfo.size)}}async _fetchTileWithTilemapCache(e,t={}){const r=this.tilemapCache,{signal:s,resamplingLevel:o=0}=t,a=new Mt(0,0,0,0);let n,l=null;try{if(l=await r.fetchAvailabilityUpsample(e.level,e.row,e.col,a,{signal:s}),!this.resampling&&a.level!==e.level)return await i.waitTick(t),Ct.createBlankImage(this._tileInfoView.tileInfo.size);n=await this._fetchImage(a,s)}catch(r){if(i.isAbortError(r))throw r;if(this.resampling&&"unknown"===l&&o<3){const r=this._tileInfoView.getTileParentId(e.id);if(r){a.set(r);try{n=await this._fetchTileWithTilemapCache(a,{...t,resamplingLevel:o+1})}catch{}}}}return n?this.resampling?Ct.resampleImage(this._tileInfoView,n,a,e):n:Ct.createBlankImage(this._tileInfoView.tileInfo.size)}async _enqueueTileFetch(e){if(!this._fetchQueue.has(e.key.id)){try{const t=await this._fetchQueue.push(e.key);e.bitmap.source=t,e.bitmap.width=this._tileInfoView.tileInfo.size[0],e.bitmap.height=this._tileInfoView.tileInfo.size[1],e.once("attach",()=>this.requestUpdate())}catch(e){i.isAbortError(e)||r.getLogger(this).error(e)}this.requestUpdate()}}async _fetchImage(e,t){return this.layer.fetchImageBitmapTile(e.level,e.row,e.col,{signal:t})}};return e.__decorate([s.property()],kt.prototype,"resampling",null),e.__decorate([s.property()],kt.prototype,"tilemapCache",null),kt=e.__decorate([n.subclass("esri.views.2d.layers.TileLayerView2D")],kt),kt});