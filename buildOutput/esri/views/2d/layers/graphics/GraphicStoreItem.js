// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/memoryEstimations","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/boundsUtils","../../../../geometry/support/coordsUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtilsSync","../../../../geometry/support/curves/curveUtils","../../../../geometry/support/curves/densifyCurvedGeometry","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/data/projectionSupport","./densificationConstants","./graphicsUtils"],function(e,t,i,s,r,o,n,a,m,y,h,u,c){"use strict";class d{static fromGraphic(e,t,i,s){return new d(e.geometry,t,e.attributes,e.visible,e.uid,e.version,i,s)}constructor(e,t,s,r,o,n,a,m){this.geometry=e,this.symbol=t,this.attributes=s,this.visible=r,this.objectId=o,this._version=n,this.zOrder=a,this.displayId=m,this.symbolBounds=i.empty(),this.prevSymbolBounds=i.empty(),this.size=[0,0,0,0],this.geometryBounds=i.empty(),this._isDensificationDirty=!1,this._densificationDeviation=1/0}get projectedGeometry(){return this._projectedGeometry}get linearCIM(){return this.symbolResource?.symbolInfo.linearCIM}get usedMemory(){return 128+t.estimateAttributesMemory(this.attributes)+y.estimateGeometryMemory(this.geometry)}get hasAnimations(){const{linearCIM:e}=this;return!!e&&e.some(e=>"animationParams"in e&&!!e.animationParams)}get hasCurvedGeoemtry(){return null!=this.geometry&&"mesh"!==this.geometry.type&&a.isCurvedGeometry(this.geometry)}update(e,t,s){return(this._version!==e.version||this.zOrder!==s||this.symbol!==t)&&(this.prevSymbolBounds=this.symbolBounds,this.symbolBounds=i.empty(),this.zOrder=s,this.geometry=e.geometry,this.attributes=e.attributes,this.symbol=t,this.visible=e.visible,this._version=e.version,this.symbolResource=null,this._projectedGeometry=null,i.empty(this.geometryBounds),this._minDensificationDeviation=null,this._isDensificationDirty=!0,!0)}updateDensificationResolution(e){if(!this.hasCurvedGeoemtry)return!1;const t=Math.max(function(e){return 2**Math.round(Math.log2(e))*u.getMaxDeviationInPixels()}(e),this._minDensificationDeviation??0);return t!==this._densificationDeviation&&(this._densificationDeviation=t,this._isDensificationDirty=!0,!0)}async projectAndNormalize(e){let t,r=this.geometry;if(r&&r.spatialReference&&"mesh"!==r.type&&("extent"===r.type&&(r=c.polygonFromExtent(r)),t=a.isCurvedGeometry(r)?m.densifyCurvedGeometry(r,{maxSegmentLength:1/0,minSegmentsPerCurve:u.getCoarseSegmentsPerCurve()}):r.toJSON(),this._projectedGeometry=await l(t,r.spatialReference,e),s.getBoundsXY(this.geometryBounds,this._projectedGeometry),this.hasCurvedGeoemtry&&null!=this._projectedGeometry)){const e=i.width(this.geometryBounds),t=i.height(this.geometryBounds);this._minDensificationDeviation=function(e,t){if(e>0&&t>0){const i=Math.min(e,t)/2,s=2*Math.PI/u.getApproximateMaxDensificationSegments();return i*(1-Math.cos(s/2))}return null}(e,t)}}async densifyCurvedGeometryForDisplay(e){if(!this.hasCurvedGeoemtry||!this._isDensificationDirty)return;this._isDensificationDirty=!1;const t=this.geometry;if(!t||!t.spatialReference||"mesh"===t.type)return;const i=e.metersPerUnit/t.spatialReference.metersPerUnit,s=this._densificationDeviation*i,r=m.densifyCurvedGeometry(t,{maxDeviation:s,minSegmentsPerCurve:u.getMinSegmentsPerCurve()});this._projectedGeometry=await l(r,t.spatialReference,e)}}async function l(e,t,i){await h.checkProjectionSupport(e.spatialReference,i);const s=n.normalizeCentralMeridianForDisplay(e);if(!s)return;const a=h.project(s,t,i);return a&&r.closeRingsAndFixWinding(a),o.isExtent(a)?c.polygonFromExtent(a):a}e.GraphicStoreItem=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});