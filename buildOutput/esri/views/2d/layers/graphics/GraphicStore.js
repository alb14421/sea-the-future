// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../core/has","../../../../core/screenUtils","../../../../chunks/rbush","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/normalizeUtils","../../../../geometry/support/spatialReferenceUtils","../../../../symbols/cim/CIMSymbolDrawHelper","../../../../symbols/cim/CIMSymbolHelper","../../engine/webgl/definitions","./GraphicStoreItem","./graphicsUtils","./GraphicUpdateMessage"],function(e,t,s,i,o,r,n,l,a,c,u,h){"use strict";const m=1e-5;function d(e,t){return t.zOrder-e.zOrder}return class{constructor(e,t,s,i,o){this._items=new Map,this._boundsDirty=!1,this._outSpatialReference=e,this._cimResourceManager=t,this._hittestDrawHelper=new n.HittestDrawHelper(t),this._tileInfoView=s,this._store=o;const r=s.getClosestInfoForScale(i);this._resolution=this._tileInfoView.getTileResolution(r.level)}destroy(){this._hittestDrawHelper.destroy()}items(){return this._items.values()}getItem(e){return this._items.get(e)}async update(e,t,s){const i=[],o=[],r=[],n=new Set,l=[];let a=0;for(const r of e.items){a++;const e=r.uid,u=this._items.get(e),h=t(r);if(n.add(e),u){const e=u.update(r,h,a),t=u.updateDensificationResolution(this._resolution);e&&l.push(this._updateItem(u,s)),(e||t)&&o.push(u);continue}const m=this._store.createDisplayIdForObjectId(e),d=c.GraphicStoreItem.fromGraphic(r,h,a,m);d.updateDensificationResolution(this._resolution),l.push(this._updateItem(d,s)),this._items.set(d.objectId,d),i.push(d)}for(const[e,t]of this._items.entries())n.has(e)||(this._store.releaseDisplayIdForObjectId(e),this._items.delete(e),r.push(t));return await Promise.all(l),this._index=null,new h.GraphicUpdateMessage(i,o,r)}updateLevel(e){if(this._resolution===e)return!1;this._index=null,this._boundsDirty=!0,this._resolution=e;for(const e of this.items())if(e.hasCurvedGeoemtry)return!0;return!1}hitTest(t,s,r,n,l){const c=e("esri-mobile"),h=c?a.hittestToleranceMobile:a.hittestToleranceDesktop,m=h+(c?0:a.hittestToleranceSmallSymbol);t=o.normalizeMapX(t,this._tileInfoView.spatialReference);const p=n*window.devicePixelRatio*m,f=i.create();f[0]=t-p,f[1]=s-p,f[2]=t+p,f[3]=s+p;const _=n*window.devicePixelRatio*h,y=i.create();y[0]=t-_,y[1]=s-_,y[2]=t+_,y[3]=s+_;const b=.5*n*(m+u.pixelBuffer),I=this._searchIndex(t-b,s-b,t+b,s+b);if(!I||0===I.length)return[];const g=[],x=i.create(),S=i.create();for(const e of I){if(!e.visible)continue;const{geometryBounds:t,symbolResource:s}=e;this._getSymbolBounds(x,s,t,S,l),S[3]=S[2]=S[1]=S[0]=0,i.intersects(x,f)&&g.push(e)}if(0===g.length)return[];const w=this._hittestDrawHelper,B=[];for(const e of g){const{projectedGeometry:t,symbolResource:s}=e;if(!s)continue;const{textInfo:i,symbolInfo:o}=s,r=o.cimSymbol;w.hitTest(y,r.symbol,t,i,l,n)&&B.push(e)}return B.sort(d),B.map(e=>e.objectId)}queryItems(e){return 0===this._items.size?[]:this._searchForItems(e)}clear(){this._items.clear(),this._index=null}async _updateItem(e,t){await e.projectAndNormalize(this._outSpatialReference),await t(e);const{size:s}=e;s[0]=s[1]=s[2]=s[3]=0,this._getSymbolBounds(e.symbolBounds,e.symbolResource,e.geometryBounds,e.size,0)}_searchIndex(e,t,i,o){return this._boundsDirty&&(this._items.forEach(e=>this._getSymbolBounds(e.symbolBounds,e.symbolResource,e.geometryBounds,e.size,0)),this._boundsDirty=!1),this._index||(this._index=s.rbush(9,e=>({minX:e.symbolBounds[0],minY:e.symbolBounds[1],maxX:e.symbolBounds[2],maxY:e.symbolBounds[3]})),this._index.load(Array.from(this._items.values()))),this._index.search({minX:e,minY:t,maxX:i,maxY:o})}_searchForItems(e){const t=this._tileInfoView.spatialReference,s=e.bounds,o=r.getInfo(t);if(o&&t.isWrappable){const[t,r]=o.valid,n=Math.abs(s[2]-r)<m,l=Math.abs(s[0]-t)<m;if((!n||!l)&&(n||l)){const o=e.resolution;let l;l=n?i.create([t,s[1],t+o*u.pixelBuffer,s[3]]):i.create([r-o*u.pixelBuffer,s[1],r,s[3]]);const a=this._searchIndex(s[0],s[1],s[2],s[3]),c=this._searchIndex(l[0],l[1],l[2],l[3]);return[...new Set([...a,...c])]}}return this._searchIndex(s[0],s[1],s[2],s[3])}_getSymbolBounds(e,s,o,r,n){if(!s||!s.symbolInfo.linearCIM)return null;if(e||(e=i.create()),i.copy(e,o),!r||0===r[0]&&0===r[1]&&0===r[2]&&0===r[3]){const{textInfo:e,symbolInfo:i}=s,o=i.cimSymbol;r||(r=[0,0,0,0]);const a=l.CIMSymbolInflatedSizeHelper.getSymbolInflateSize(r,o.symbol,this._cimResourceManager,n,e);r[0]=t.pt2px(a[0]),r[1]=t.pt2px(a[1]),r[2]=t.pt2px(a[2]),r[3]=t.pt2px(a[3])}const a=this._resolution,c=l.CIMSymbolInflatedSizeHelper.safeSize(r);return e[0]-=c*a,e[1]-=c*a,e[2]+=c*a,e[3]+=c*a,e}}});