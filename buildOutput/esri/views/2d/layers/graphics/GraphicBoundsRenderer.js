// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../core/maybe","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f32","../../../../core/libs/gl-matrix-2/factories/vec2f32","../../../../core/libs/gl-matrix-2/factories/vec3f32","../../../../geometry/support/normalizeUtils","../../engine/DisplayObject","../../engine/webgl/Utils","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexArrayObject","../../../webgl/VertexBuffer"],function(e,t,r,i,a,s,n,o,l,c,u,f){"use strict";const h=Math.PI/180;class _ extends n.DisplayObject{constructor(e){super(),this._program=null,this._vao=null,this._vertexBuffer=null,this._indexBuffer=null,this._dvsMat3=r.create(),this._localOrigin={x:0,y:0},this._getBounds=e}destroy(){super.destroy(),this._vao&&(this._vao.dispose(),this._vao=null,this._vertexBuffer=null,this._indexBuffer=null),this._program=e.disposeMaybe(this._program)}doRender(e){const{context:t}=e,r=this._getBounds();if(r.length<1)return;this._createShaderProgram(t),this._updateMatricesAndLocalOrigin(e),this._updateBufferData(t,r),t.setBlendingEnabled(!0),t.setDepthTestEnabled(!1),t.setStencilWriteMask(0),t.setStencilTestEnabled(!1),t.setBlendFunction(1,771),t.setColorMask(!0,!0,!0,!0);const i=this._program;t.bindVAO(this._vao),t.useProgram(i),i.setUniformMatrix3fv("u_dvsMat3",this._dvsMat3),t.gl.lineWidth(1),t.drawElements(c.PrimitiveType.LINES,8*r.length,c.DataType.UNSIGNED_INT,0),t.bindVAO(null)}_createTransforms(){return{displayViewScreenMat3:r.create()}}_createShaderProgram(e){this._program||(this._program=e.programCache.acquire("precision highp float;\n        uniform mat3 u_dvsMat3;\n\n        attribute vec2 a_position;\n\n        void main() {\n          mediump vec3 pos = u_dvsMat3 * vec3(a_position, 1.0);\n          gl_Position = vec4(pos.xy, 0.0, 1.0);\n        }","precision mediump float;\n      void main() {\n        gl_FragColor = vec4(0.75, 0.0, 0.0, 0.75);\n      }",d().attributes))}_updateMatricesAndLocalOrigin(e){const{state:r}=e,{displayMat3:n,size:o,resolution:l,pixelRatio:c,rotation:u,viewpoint:f}=r,_=h*u,{x:d,y:g}=f.targetGeometry,p=s.normalizeMapX(d,r.spatialReference);this._localOrigin.x=p,this._localOrigin.y=g;const m=c*o[0],v=c*o[1],x=l*m,b=l*v,y=t.identity(this._dvsMat3);t.multiply(y,y,n),t.translate(y,y,i.fromValues(m/2,v/2)),t.scale(y,y,a.fromValues(o[0]/x,-v/b,1)),t.rotate(y,y,-_)}_updateBufferData(e,t){const{x:r,y:i}=this._localOrigin,a=8*t.length,s=new Float32Array(a),n=new Uint32Array(8*t.length);let o=0,c=0;for(const e of t)e&&(s[2*o]=e[0]-r,s[2*o+1]=e[1]-i,s[2*o+2]=e[0]-r,s[2*o+3]=e[3]-i,s[2*o+4]=e[2]-r,s[2*o+5]=e[3]-i,s[2*o+6]=e[2]-r,s[2*o+7]=e[1]-i,n[c]=o+0,n[c+1]=o+3,n[c+2]=o+3,n[c+3]=o+2,n[c+4]=o+2,n[c+5]=o+1,n[c+6]=o+1,n[c+7]=o+0,o+=4,c+=8);const h=d();this._vertexBuffer?this._vertexBuffer.setData(s.buffer):this._vertexBuffer=new f.VertexBuffer(e,h.bufferLayout,s.buffer,35048),this._indexBuffer?this._indexBuffer.setData(n):this._indexBuffer=l.BufferObject.createIndex(e,35048,n),this._vao||(this._vao=new u.VertexArrayObject(e,this._vertexBuffer,this._indexBuffer))}}const d=()=>o.createProgramDescriptor("bounds",[{location:0,name:"a_position",count:2,type:c.DataType.FLOAT}]);return _});