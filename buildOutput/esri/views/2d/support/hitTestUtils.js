// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../Graphic","../../../core/arrayUtils","../../../core/iteratorUtils","./clippingUtils","../../support/screenUtils"],function(e,t,i,r,a,l){"use strict";function n(e,i,r,a,l,n){return s=>{if(s instanceof t){if(s.layer===e)n?.();else{const t=e.allLayerViews.find(e=>e.layer===s.layer);t&&l?.(t)}a(c(s))}else if("layer"in s&&"element"in s);else if("subtype-sublayer"===s.type){const t=e.allLayerViews.find(e=>e.layer===s.parent);t&&r(s,t)}else{const t=e.allLayerViews.find(e=>e.layer===s);t&&i(t)}}}function s(e,t){if(e)if(r.isIterable(e))for(const i of e)if(r.isIterable(i))for(const e of i)t(e);else t(i);else t(e)}function c(e){const t=e.getObjectId();return t?`${e.layer?.uid??e.sourceLayer?.uid??"MapView"}/${t}`:`"MapView/${e.uid}`}function o(e,t){const i=e.layer;"subtype-group"===i?.type&&i.sublayers.forEach(e=>{t(e)})}e.hitTest=async function(e,t,r){const p=l.isSupportedScreenPointEvent(t)?l.createScreenPointFromSupportedEvent(e,t):t;if(!e.ready||isNaN(p.x)||isNaN(p.y))return{screenPoint:p,results:[]};let d=new Set;const u=new Set;let y=!1,f=null,h=null;r?.include?s(r.include,n(e,e=>{d.add(e),o(e,e=>u.add(e))},(e,t)=>{u.add(e),d.add(t)},e=>{f||(f=new Set),f.add(e)},e=>d.add(e),()=>y=!0)):(y=!0,d=new Set(e.allLayerViews),d.forEach(e=>{o(e,e=>u.add(e))})),r?.exclude&&s(r.exclude,n(e,e=>{d.delete(e),o(e,e=>u.delete(e))},e=>u.delete(e),e=>{h||(h=new Set),h.add(e)}));const g=e.toMap(p),w=e.allLayerViews.filter(t=>!t.suspended&&d.has(t)&&t.clips.every(t=>a.clipContainsPoint(e,t,p,g))).reverse();let S=[...y?e.graphicsView.hitTest(g).map(e=>({type:"graphic",graphic:e,layer:null,mapPoint:g})):[],...await Promise.all(w.map(e=>e.hitTest(g,p)).toArray())].filter(i.isSome).flat().filter(i.isSome);return S=S.filter(e=>"graphic"!==e.type||"subtype-group"!==e.layer?.type||u.has(e.graphic.layer)),f&&(S=S.filter(e=>!("graphic"in e)||!e.graphic||f?.has(c(e.graphic)))),h&&(S=S.filter(e=>!("graphic"in e)||!e.graphic||!h?.has(c(e.graphic)))),{screenPoint:p,results:S}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});