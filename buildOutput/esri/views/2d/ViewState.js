// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../Viewpoint","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/libs/gl-matrix-2/math/common","../../core/libs/gl-matrix-2/math/mat2d","../../core/libs/gl-matrix-2/factories/mat2df32","../../core/libs/gl-matrix-2/factories/mat2df64","../../core/libs/gl-matrix-2/math/mat3","../../core/libs/gl-matrix-2/factories/mat3f32","../../core/libs/gl-matrix-2/math/vec2","../../core/libs/gl-matrix-2/factories/vec2f32","../../core/libs/gl-matrix-2/factories/vec2f64","../../core/libs/gl-matrix-2/types/vec2","../../geometry/Extent","../../geometry/Point","../../geometry/support/normalizeUtils","./viewpointUtils"],function(t,e,i,s,r,o,a,n,c,p,l,h,m,d,f,u,v,y,w,_,g,x){"use strict";var R;const M=[0,0];let b=R=class extends i.JSONSupport{constructor(t){super(t),this._viewpoint2D={center:v.create(),rotation:0,scale:0,spatialReference:void 0},this.center=[0,0],this.extent=new w,this.id=0,this.inverseTransform=h.create(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=h.create(),this.transformNoRotation=h.create(),this.displayMat3=d.create(),this.displayViewMat3=d.create(),this.viewMat3=d.create(),this.viewMat2d=l.create(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(t){this._set("pixelRatio",t),this._update()}set size(t){this._set("size",t),this._update()}set viewpoint(t){if(t){const e=this._viewpoint2D,i=t.targetGeometry;e.center[0]=i.x,e.center[1]=i.y,e.rotation=t.rotation,e.scale=t.scale,e.spatialReference=i.spatialReference}this._update()}get visibleArea(){const[t,e]=this.size;return[this.toMap([0,0],0,0),this.toMap([0,0],0,e),this.toMap([0,0],t,e),this.toMap([0,0],t,0)]}copy(t){const e=this.size,i=this.viewpoint;return i&&e?(this.viewpoint=x.copy(i,t.viewpoint),this._set("size",f.copy(e,t.size))):(this.viewpoint=t.viewpoint.clone(),this._set("size",[t.size[0],t.size[1]])),this._set("pixelRatio",t.pixelRatio),this}clone(){return new R({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(t,e,i){return y.isVec2(e)?f.transformMat2d(t,e,this.inverseTransform):(M[0]=e,M[1]=i,f.transformMat2d(t,M,this.inverseTransform))}toScreen(t,e,i){return y.isVec2(e)?f.transformMat2d(t,e,this.transform):(M[0]=e,M[1]=i,f.transformMat2d(t,M,this.transform))}toScreenNoRotation(t,e,i){return y.isVec2(e)?f.transformMat2d(t,e,this.transformNoRotation):(M[0]=e,M[1]=i,f.transformMat2d(t,M,this.transformNoRotation))}wrapMapCoordinate(t,e){f.copy(t,e);const[i]=e,[s]=this.center,{extent:r,spatialReference:o}=this;let{xmin:a,xmax:n}=r;if(o.isWrappable){const t=x.getWorldWidth(o)/2;a=Math.max(a,s-t),n=Math.min(n,s+t)}return(i<a||i>n)&&(t[0]=g.getClosestDenormalizedXToReference(i,s,o)),t}getScreenTransform(t,e){const{center:i}=this._viewpoint2D,s=this._get("pixelRatio")||1,r=this._get("size");return x.getMatrix(t,i,r,e,0,s),t}_update(){const{center:t,spatialReference:i,scale:s,rotation:r}=this._viewpoint2D,o=this._get("pixelRatio")||1,a=this._get("size"),n=new e({targetGeometry:new _(t[0],t[1],i),scale:s,rotation:r});if(this._set("viewpoint",n),!a||!i||!s)return;this.resolution=x.getResolution(n),this.rotation=r,this.scale=s,this.spatialReference=i,f.copy(this.center,t);const l=0!==a[0]?2/a[0]:0,h=0!==a[1]?-2/a[1]:0;m.set(this.displayMat3,l,0,0,0,h,0,-1,1,1);const d=m.identity(this.viewMat3),v=u.fromValues(a[0]/2,a[1]/2),y=u.fromValues(-a[0]/2,-a[1]/2),w=c.toRadian(r);m.translate(d,d,v),m.rotate(d,d,w),m.translate(d,d,y),m.multiply(this.displayViewMat3,this.displayMat3,d);const g=p.fromTranslation(this.viewMat2d,v);return p.rotate(g,g,w),p.translate(g,g,y),x.getExtent(this.extent,n,a),x.getTransform(this.transform,n,a,o),p.invert(this.inverseTransform,this.transform),x.getTransformNoRotation(this.transformNoRotation,n,a,o),this.worldScreenWidth=x.getWorldScreenWidth(this.spatialReference,this.resolution),this._set("id",this.id+1),this.notifyChange("visibleArea"),this}};return t.__decorate([s.property({readOnly:!0})],b.prototype,"id",void 0),t.__decorate([s.property({value:1,json:{write:!0}})],b.prototype,"pixelRatio",null),t.__decorate([s.property({json:{write:!0}})],b.prototype,"size",null),t.__decorate([s.property()],b.prototype,"spatialReference",void 0),t.__decorate([s.property({type:e,json:{write:!0}})],b.prototype,"viewpoint",null),t.__decorate([s.property({readOnly:!0})],b.prototype,"visibleArea",null),b=R=t.__decorate([n.subclass("esri.views.2d.ViewState")],b),b});