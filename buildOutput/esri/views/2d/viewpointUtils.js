// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../Viewpoint","../../core/Collection","../../core/mathUtils","../../core/unitUtils","../../core/libs/gl-matrix-2/math/common","../../core/libs/gl-matrix-2/math/mat2d","../../core/libs/gl-matrix-2/factories/mat2df64","../../core/libs/gl-matrix-2/math/vec2","../../core/libs/gl-matrix-2/factories/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/projectionUtils","../../geometry/SpatialReference","../../geometry/support/normalizeUtils","../../geometry/support/spatialReferenceUtils"],function(e,t,n,r,a,o,i,c,s,l,u,f,m,y,g,p,d){"use strict";const x=180/Math.PI;function h(e){return e.wkid?e:e.spatialReference||g.WGS84}function b(e,t){return t.type?s.set(e,t.x,t.y):s.copy(e,t)}function w(e){return a.getMetersPerUnitForSR(e)}function R(e,t,n=0){let a=e.width,o=e.height;if(0!==n){const t=r.deg2rad(n),i=Math.abs(Math.cos(t)),c=Math.abs(Math.sin(t));a=e.width*i+e.height*c,o=e.width*c+e.height*i}const i=Math.max(1,t[0]),c=Math.max(1,t[1]);return Math.max(a/i,o/c)*F(e.spatialReference)}async function S(e,t,r,a){let o,i;if(!e)return null;if(Array.isArray(e)&&!e.length)return null;if(n.isCollection(e)&&(e=e.toArray()),Array.isArray(e)&&e.length&&"object"==typeof e[0]){const n=e.every(e=>"attributes"in e),o=e.some(e=>!e.geometry);let i=e;if(n&&o&&t&&t.allLayerViews){const n=new Map;for(const t of e){const e=t.layer,r=n.get(e)||[],a=t.attributes[e.objectIdField];null!=a&&r.push(a),n.set(e,r)}const r=[];n.forEach((e,n)=>{const a=t.allLayerViews?.find(e=>e.layer.id===n.id);if(a&&"queryFeatures"in a){const t=n.createQuery();t.objectIds=e,t.returnGeometry=!0,r.push(a.queryFeatures(t))}});const a=await Promise.all(r),o=[];for(const e of a)if(e&&e.features&&e.features.length)for(const t of e.features)null!=t.geometry&&o.push(t.geometry);i=o}for(const e of i)a=await S(e,t,r,a);return a}if(Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])o=new m(e);else if(e instanceof f)o=e;else if("geometry"in e)if(e.geometry)o=e.geometry;else if(e.layer){const n=e.layer,r=t.allLayerViews?.find(e=>e.layer.id===n.id);if(r&&"queryFeatures"in r){const t=n.createQuery();t.objectIds=[e.attributes[n.objectIdField]],t.returnGeometry=!0;const a=await r.queryFeatures(t);o=a?.features?.[0]?.geometry}}if(null==o)return null;switch(o.type){case"point":i=new u({xmin:o.x,ymin:o.y,xmax:o.x,ymax:o.y,spatialReference:o.spatialReference});break;case"extent":case"multipoint":case"polygon":case"polyline":i=p.getDenormalizedExtent(o);break;default:i=o.extent}if(!i)return null;y.isLoaded()||y.canProjectWithoutEngine(i.spatialReference,r)||await y.load();const c=y.project(i,r);if(!c)return null;if(a){const e=c.center,t=e.clone();t.x=p.getClosestDenormalizedXToReference(e.x,a.center.x,r),t.x!==e.x&&c.centerAt(t),a=a.union(c)}else a=c;return a}function G(e,t){const n=h(e);return d.equals(n,t)||n.imageCoordinateSystem||t.imageCoordinateSystem?e:y.project(e,t)}function A(e,t){const n=e.targetGeometry,r=t.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function M(e,t,n){return n?s.set(e,.5*(t[0]-n.right+n.left),.5*(t[1]-n.bottom+n.top)):s.scale(e,t,.5)}const T=function(){const e=l.create();return function(t,n,r){const a=n.targetGeometry;b(e,a);const o=.5*v(n);return t.xmin=e[0]-o*r[0],t.ymin=e[1]-o*r[1],t.xmax=e[0]+o*r[0],t.ymax=e[1]+o*r[1],t.spatialReference=a.spatialReference,t}}(),j=function(){const e=l.create();return function(t,n,r){return s.sub(t,function(e,t){return s.scale(e,t,.5)}(t,n),M(e,n,r))}}(),k=function(){const e=c.create(),t=l.create();return function(n,r,a,o){const c=v(r),l=P(r);return s.set(t,c,c),i.fromScaling(e,t),i.rotate(e,e,l),i.translate(e,e,j(t,a,o)),i.translate(e,e,[0,o.top-o.bottom]),s.set(n,e[4],e[5])}}();function v(e){return e.scale*z(e.targetGeometry?.spatialReference)}function z(e){return d.isValid(e)?1/(39.37*w(e)*96):1}function P(e){return o.toRadian(e.rotation)||0}function F(e){return d.isValid(e)?39.37*w(e)*96:1}const C=function(){const e=l.create(),t=l.create(),n=l.create();return function(r,a,o,c,l,u){return s.negate(e,a),s.scale(t,o,.5*u),s.set(n,1/c*u,-1/c*u),i.fromTranslation(r,t),l&&i.rotate(r,r,l),i.scale(r,r,n),i.translate(r,r,e),r}}(),E=function(){const e=l.create();return function(t,n,r,a){const o=v(n),i=P(n);return b(e,n.targetGeometry),C(t,e,r,o,i,a)}}(),V=function(){const e=l.create();return function(t,n,r,a){const o=v(n);return b(e,n.targetGeometry),C(t,e,r,o,0,a)}}();function N(e){const t=d.getInfo(e);return t?t.valid[1]-t.valid[0]:0}const W=function(){const e=l.create(),t=l.create(),n=[0,0,0];return function(r,a,o){s.subtract(e,r,a),s.normalize(e,e),s.subtract(t,r,o),s.normalize(t,t),s.cross(n,e,t);let i=Math.acos(s.dot(e,t)/(s.length(e)*s.length(t)))*x;return n[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),q=function(){const e=l.create();return function(t,n,r,a){const o=t.targetGeometry;return A(t,n),k(e,n,r,a),o.x+=e[0],o.y+=e[1],t}}(),B=function(e,t,n){A(e,t);const r=e.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e},I=function(){const e=l.create();return function(t,n,r,a,o){o||(o="center"),s.sub(e,r,a),s.scale(e,e,.5);const i=e[0],c=e[1];switch(o){case"center":s.set(e,0,0);break;case"left":s.set(e,-i,0);break;case"top":s.set(e,0,c);break;case"right":s.set(e,i,0);break;case"bottom":s.set(e,0,-c);break;case"top-left":s.set(e,-i,c);break;case"bottom-left":s.set(e,-i,-c);break;case"top-right":s.set(e,i,c);break;case"bottom-right":s.set(e,i,-c)}return X(t,n,e),t}}(),L=function(){const e=l.create();return function(t,n,r,a,o){return A(t,n),isNaN(r)||0===r||(O(e,a,n,o),t.scale=n.scale*r,Q(e,e,t,o),X(t,t,s.set(e,e[0]-a[0],a[1]-e[1]))),t}}(),U=function(){const e=l.create();return function(t,n,r,a,o,i){return A(t,n),isNaN(r)||0===r||(O(e,o,n,i),t.scale=n.scale*r,t.rotation+=a,Q(e,e,t,i),X(t,t,s.set(e,e[0]-o[0],o[1]-e[1]))),t}}(),D=function(){const e=l.create(),t=l.create();return function(n,r,a,o,i,c,l){return j(t,c,l),s.add(e,i,t),o?U(n,r,a,o,e,c):L(n,r,a,e,c)}}(),O=function(){const e=c.create();return function(t,n,r,a){return s.transformMat2d(t,n,function(e,t,n){return E(e,t,n,1),i.invert(e,e)}(e,r,a))}}(),Q=function(){const e=c.create();return function(t,n,r,a){return s.transformMat2d(t,n,E(e,r,a,1))}}(),X=function(){const e=l.create(),t=c.create();return function(n,r,a){A(n,r);const o=v(r),c=n.targetGeometry;return i.fromRotation(t,P(r)),i.scale(t,t,l.fromValues(o,o)),s.transformMat2d(e,a,t),c.x+=e[0],c.y+=e[1],n}}();e.addPadding=q,e.angleBetween=W,e.centerAt=B,e.copy=A,e.create=async function(e,n){if(!e||!n)return new t({targetGeometry:new m,scale:0,rotation:0});let r=n.spatialReference;const{constraints:a,padding:o,viewpoint:i,size:c}=n,s=[o?c[0]-o.left-o.right:c[0],o?c[1]-o.top-o.bottom:c[1]];let l=null;e instanceof t?l=e:e.viewpoint?l=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(l=e.target);let g=null;l?.targetGeometry?g=l.targetGeometry:e instanceof u?g=e:e instanceof f?g=await S(e,n,r):e&&(g=await S(e.center,n,r)||await S(e.target,n,r)||await S(e,n,r)),!g&&i?.targetGeometry?g=i.targetGeometry:!g&&n.extent&&(g=n.extent),r||(r=h(n.spatialReference||n.extent||g)),y.isLoaded()||d.equals(g.spatialReference,r)||y.canProjectWithoutEngine(g.spatialReference,r)||await y.load();const x=G(g,r),b="center"in x?x.center:x;!1!==n.pickClosestTarget&&"point"===b.type&&"point"===i.targetGeometry?.type&&(b.x=p.getClosestDenormalizedXToReference(b.x,i.targetGeometry.x,b.spatialReference));let w=0;l?w=l.rotation:e.hasOwnProperty("rotation")?w=e.rotation:i&&(w=i.rotation);let A=0;A=null!=l?.targetGeometry&&"point"===l.targetGeometry.type?l.scale:"scale"in e&&e.scale?e.scale:"zoom"in e&&-1!==e.zoom&&a&&a.effectiveLODs?a.zoomToScale(e.zoom):Array.isArray(g)||"point"===g.type||"extent"===g.type&&0===g.width&&0===g.height?i.scale:R(G(g.extent,r),s,w);const M=function(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&null!=e.layer?.minScale&&null!=e.layer.maxScale){const t=e.layer;return{min:t.minScale,max:t.maxScale}}if(Array.isArray(e)&&e.length&&e.every(e=>"layer"in e)){let t=0,n=0;for(const r of e){const e=r.layer;e?.minScale&&e.maxScale&&(t=e.minScale<t?e.minScale:t,n=e.maxScale>n?e.maxScale:n)}return t&&n?{min:t,max:n}:null}}}(e.target??e);M&&(M.min&&M.min<A?A=M.min:M.max&&M.max>A&&(A=M.max));let T=new t({targetGeometry:b,scale:A,rotation:w});return a&&(T=a.fit(T),a.constrainByGeometry(T),a.rotationEnabled||(T.rotation=i.rotation)),T},e.extentToScale=R,e.getAnchor=M,e.getExtent=T,e.getMatrix=C,e.getPaddingMapTranslation=k,e.getPaddingScreenTranslation=j,e.getResolution=v,e.getResolutionToScaleFactor=F,e.getScaleToResolutionFactor=z,e.getTransform=E,e.getTransformNoRotation=V,e.getWorldScreenWidth=function(e,t){return Math.round(N(e)/t)},e.getWorldWidth=N,e.padAndScaleAndRotateBy=D,e.resize=I,e.rotateBy=function(e,t,n){return A(e,t),e.rotation+=n,e},e.rotateTo=function(e,t,n){return A(e,t),e.rotation=n,e},e.scaleAndRotateBy=U,e.scaleTo=function(e,t,n){return A(e,t),e.scale=n,e},e.setExtent=function(e,t,n,r,a){return B(e,t,n.center),e.scale=R(n,r),a?.constraints?.constrain(e),e},e.toMap=O,e.toScreen=Q,e.translateBy=X,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});