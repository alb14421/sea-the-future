// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../core/Handles","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/unitUtils","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f32","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f32","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../geometry/projectionUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/scaleUtils","../../../geometry/support/spatialReferenceUtils","../engine/DisplayObject","../engine/webgl/shaderGraph/techniques/grid/GridTechnique","./constants","./gridUtils"],function(e,t,r,i,s,n,a,o,l,c,h,d,u,m,p,g,f,_){"use strict";const R=c.create();class j extends p.DisplayObject{constructor(){super(),this._handles=new e,this._projectedCenter=null,this._metersPerSRUnit=null,this._technique=new g.GridTechnique,this._grid=null,this.visible=!0}destroy(){super.destroy(),this._handles=r.destroyMaybe(this._handles),this._technique.shutdown()}get grid(){return this._grid}set grid(e){this._grid=e,this._handles.removeAll(),this._handles.add([i.watch(()=>e?.center,()=>{this._projectedCenter=null},i.initial),i.watch(()=>[e?.center,e?.dynamicScaling,e?.majorLineColor,e?.majorLineInterval,e?.minorLineColor,e?.rotateWithMap,e?.rotation,e?.spacing,e?.units],()=>this.requestRender(),i.initial)])}_createTransforms(){return{displayViewScreenMat3:a.create()}}doRender(e){if(1!==e.drawPhase||null==this.grid||!this.visible)return;const{spacing:t,units:r,majorLineInterval:i,dynamicScaling:n,majorLineColor:a,minorLineColor:o}=this.grid;if(0===t)return;if(this._updateDerivedValues(e),null==this._projectedCenter||null==this._metersPerSRUnit)return;const{scale:l,spatialReference:c}=e.state,h=s.convertUnit(t,r,"meters"),d=this._metersPerSRUnit*u.getResolutionForScale(l,c),m=h/d;if(!n&&m<f.minimumPixelsPerStrideForDisplayWhenScalingOff)return;const p=h*_.getScaleFactor(i,m,n);this._updateTransform(e,d,p),this._technique.render(e,{transform:{dvs:this.transforms.displayViewScreenMat3},config:{pxPerCell:p/d,minorLineColor:y(o),majorLineColor:y(a),majorLineInterval:i,halfWidth:.25,aaWidth:.5}})}_updateDerivedValues(e){if(!this.grid)return;const{center:t}=this.grid,{spatialReference:r}=e.state;this._projectedCenter&&m.equals(this._projectedCenter.spatialReference,r)||(this._metersPerSRUnit=null,m.equals(t.spatialReference,r)?this._projectedCenter=t:h.isLoadedOrLoadFor(t.spatialReference,r)?this._projectedCenter=h.project(t,r):this.requestRender()),null==this._metersPerSRUnit&&null!=this._projectedCenter&&(this._metersPerSRUnit=_.measureMetersPerUnitAtReferencePoint(this._projectedCenter))}_updateTransform(e,r,i){const{grid:s}=this,{center:a,rotation:c,size:h,spatialReference:u}=e.state;if(null==s||null==this._projectedCenter||null==this._metersPerSRUnit)return;const m=r*(h[0]/2),p=r*(h[1]/2),g=this._metersPerSRUnit/i,f=this._projectedCenter,_=t.deg2rad(s.rotation),j=t.deg2rad(c),y=this.transforms.displayViewScreenMat3;n.fromRotation(y,-_);const S=u.isWrappable?d.getClosestDenormalizedXToReference(f.x,a[0],u):f.x,C=o.set(R,S,f.y),U=o.sub(R,a,C);var v,b;o.scale(U,U,g),s.rotateWithMap||o.rotate(U,U,l.ZEROS,-j),o.rotate(U,U,l.ZEROS,-_),o.scale(U,U,1/s.majorLineInterval),b=U,(v=U)[0]=b[0]-Math.trunc(b[0]),v[1]=b[1]-Math.trunc(b[1]),o.scale(U,U,s.majorLineInterval),o.rotate(U,U,l.ZEROS,_),n.translate(y,y,U),s.rotateWithMap&&n.rotate(y,y,j);const P=m/i,L=p/i,q=o.set(R,P,L);n.scaleByVec2(y,y,q)}}function y(e){const[t,r,i,s]=e.toArray().map(e=>e/255);return[t*s,r*s,i*s,s]}return j});