// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/Handles","../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../chunks/boundedPlane","../../../../../geometry/support/spatialReferenceUtils","./Manipulation","./utils","../../../../interactive/dragEventPipeline","../../../../interactive/GraphicManipulator","../../../../interactive/editGeometry/support/editPlaneUtils"],function(t,e,a,i,r,n,s,l,o,c,h,p,d){"use strict";const u=1e-6;function _(t){const e=r.length(t.basis1),a=r.length(t.basis2);return.3*Math.min(e,a)}class g extends o.Manipulation{constructor(t){super(),this._handles=new e,this._planeStart=s.create(),this._displayPlaneStart=s.create(),this._originCache=n.create(),this._axisCache=i.create(),this._renderStartCache=n.create(),this._renderEndCache=n.create(),this._resizeOriginCache=n.create(),this._view=t.view,this._tool=t.tool,this._graphic=t.graphic,this._direction=t.direction,this._preserveAspectRatio=t.preserveAspectRatio,this._manipulator=this._createManipulator(),this._handles.add([this._manipulator.events.on("grab-changed",t=>c.onGrabChangedHandle(t,this._manipulator))]),this.forEachManipulator(t=>this._tool.manipulators.add(t))}destroy(){this._handles.destroy(),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._graphic=null,this._manipulator=null,this._direction=null,this._handles=null,this._planeStart=null,this._displayPlaneStart=null,this._originCache=null,this._axisCache=null,this._renderStartCache=null,this._renderEndCache=null,this._resizeOriginCache=null,this._preserveAspectRatio=null}forEachManipulator(t){t(this._manipulator,1)}createDragPipeline(t,e){let i=null,n=null,o=null,c=0,p=null,g=null;const v=this._planeStart,m=this._displayPlaneStart,b=this._direction;return h.createManipulatorDragEventPipeline(this._manipulator,(y,f)=>{f.next(e=>{if("start"===e.action){y.cursor="grabbing";const e=t();i=e.plane,n=e.displayPlane,o=e.editGeometryOperations,c=10*this._view.resolution,s.copy(i,v),s.copy(n,m);const a=l.getInfo(o.data.spatialReference);p=a?a.valid[1]-a.valid[0]-30*this._view.resolution:null}return e}).next(h.screenToMap(this._view)).next(t=>{const e=r.copy(this._renderStartCache,[t.mapStart.x,t.mapStart.y,0]),a=r.copy(this._renderEndCache,[t.mapEnd.x,t.mapEnd.y,0]),i=r.copy(this._resizeOriginCache,m.origin);r.scaleAndAdd(i,i,m.basis1,-b[0]),r.scaleAndAdd(i,i,m.basis2,-b[1]),r.subtract(a,a,i),r.subtract(e,e,i);const s=0!==b[0]&&0!==b[1],l=_(m),o=_(n)/l,h=(t,i)=>{if(0===t)return 1;let n=r.length(i),l=.5*t*r.dot(i,a)/n;const h=l<0?-1:1;s&&(l+=(n-.5*t*r.dot(i,e)/n)*h*o);const p=n<1.5*c?1:u;return n=Math.max(n-c,u),h>0&&(l-=10*this._view.resolution),h*Math.max(h*(l/n),p)},p=h(b[0],m.basis1),d=h(b[1],m.basis2);return{...t,direction:b,factor1:p,factor2:d}}).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(t=>{const n=r.copy(this._originCache,v.origin);r.scaleAndAdd(n,n,v.basis1,-b[0]),r.scaleAndAdd(n,n,v.basis2,-b[1]);const l=a.set(this._axisCache,v.basis1[0],v.basis1[1]);a.normalize(l,l);const c=o.data.allVerticesUnordered,h="start"===t.action?0:1,u=o.scaleVertices(c,n,l,t.factor1,t.factor2,h,1);return p&&p<o.data.geometry.extent.width&&g?o.updateVertices(c,g):(s.copy(v,i),d.apply(u,i),g=u.operation,e(t,u)),t}).next(t=>("end"===t.action&&(y.cursor="grab"),t))})}_createManipulator(){return new p.GraphicManipulator({view:this._view,graphic:this._graphic,selectable:!0,cursor:"grab"})}}t.ScaleManipulation=g,t.calculateDiagonalResizeHandleScale=_,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});