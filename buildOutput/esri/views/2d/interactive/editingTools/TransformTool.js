// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../Graphic","../../../../core/colorUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../../../../geometry/Polygon","../../../../geometry/projectionUtils","../../../../chunks/boundedPlane","../../../../geometry/support/spatialReferenceUtils","../../../../layers/GraphicsLayer","../../../../symbols/SimpleFillSymbol","../../../../symbols/SimpleMarkerSymbol","./manipulations/DragManipulation","./manipulations/RotateManipulation","./manipulations/ScaleManipulation","./manipulations/utils","../../../interactive/InteractiveToolBase","../../../interactive/keybindings","../../../interactive/editGeometry/EditGeometry","../../../interactive/editGeometry/EditGeometryOperations","../../../interactive/editGeometry/support/editPlaneUtils","../../../support/hitTestSelectUtils","../../../support/screenUtils"],function(e,t,i,a,s,r,o,n,c,l,h,p,d,_,y,u,g,m,f,v,G,b,w,R,T,C,S,M,P,k,A,O,U,x,D){"use strict";const B=[[1,1],[1,-1],[-1,-1],[-1,1],[1,0],[0,-1],[-1,0],[0,1]];e.TransformTool=class extends P.InteractiveToolBase{constructor(e){super(e),this._initialControlPoints=null,this._initialGeometry=null,this._graphic=null,this._planeCache=v.create(),this._displayPlaneCache=v.create(),this._mainAxisCache=_.create(),this._rotationHandleCache=u.create(),this._cornerA=u.create(),this._cornerB=u.create(),this._cornerC=u.create(),this._cornerD=u.create(),this._avgAB=u.create(),this._avgBC=u.create(),this._avgCD=u.create(),this._avgDA=u.create(),this._preserveAspectRatio=new M.PreserveAspectRatio,this._snapRotation=new M.SnapRotation,this._graphicsLayer=new b({internal:!0,listMode:"hide",visible:!1,title:"TransformTool layer"}),this._sharedUndoStack=[],this._sharedRedoStack=[],this._isOpacityToggled=!1,this._factor=1,this.preserveAspectRatio=null,this.snapRotation=null,this.type="transform"}initialize(){this._initialize()}destroy(){const{map:e}=this.view;this._dragManipulation.destroy(),this._rotateManipulation.destroy(),this._scaleManipulations.forEach(e=>e.destroy()),this._editGeometryOperations.destroy(),e.removeMany([this._graphicsLayer]),this._graphicsLayer.removeAll(),this._graphicsLayer=s.destroyMaybe(this._graphicsLayer),this._initialControlPoints=null,this._initialGeometry=null,this._graphic=null,this._preserveAspectRatio=null,this._snapRotation=null,this._planeCache=null,this._displayPlaneCache=null,this._rotationHandleCache=null,this._mainAxisCache=null,this._cornerA=null,this._cornerB=null,this._cornerC=null,this._cornerD=null,this._avgAB=null,this._avgBC=null,this._avgCD=null,this._avgDA=null,this._sharedUndoStack=null,this._sharedRedoStack=null}get _plane(){const e=this._graphic.geometry;if(null==e)return null;const t=this._editGeometryOperations.data,i=t.parts[0].segments[0],a=d.subtract(this._mainAxisCache,i.leftVertex.pos,i.rightVertex.pos);d.normalize(a,a);let s=80*this.view.resolution;const r=this.view.spatialReference;return G.equals(r,e.spatialReference)&&(s*=o.getMetersPerUnitForSR(r)/o.getMetersPerUnitForSR(e.spatialReference)),U.calculateOrientedBounds(a,t,s,this._planeCache)}get _displayPlane(){const e=this._plane;if(!e)return null;const t=this._displayPlaneCache;v.copy(e,t);const i=10*this.view.resolution;return y.scale(t.basis1,t.basis1,1+i/y.length(t.basis1)),y.scale(t.basis2,t.basis2,1+i/y.length(t.basis2)),t}get _backgroundGraphicGeometry(){const e=this._displayPlane;if(!e)return null;const t=this.view.spatialReference;return this._updateDisplayPlaneConrers(e),new m({spatialReference:t,rings:[[this._cornerA,this._cornerB,this._cornerC,this._cornerD,this._cornerA]]})}get _rotateGraphicGeometry(){const e=this._plane;if(!e)return null;const t=this._rotationHandleCache;return y.normalize(t,e.basis1),y.scale(t,t,30*this.view.resolution),y.add(t,t,e.origin),y.add(t,t,e.basis1),new g({x:t[0],y:t[1],spatialReference:this.view.spatialReference})}get _scaleGraphicGeometries(){const e=this._displayPlane;if(!e)return[];const t=this.view.spatialReference;this._updateDisplayPlaneConrers(e);const{_cornerA:i,_cornerB:a,_cornerC:s,_cornerD:r}=this,o=y.lerp(this._avgAB,i,a,.5),n=y.lerp(this._avgBC,a,s,.5),c=y.lerp(this._avgCD,s,r,.5),l=y.lerp(this._avgDA,r,i,.5);return[new g({x:i[0],y:i[1],spatialReference:t}),new g({x:a[0],y:a[1],spatialReference:t}),new g({x:s[0],y:s[1],spatialReference:t}),new g({x:r[0],y:r[1],spatialReference:t}),new g({x:o[0],y:o[1],spatialReference:t}),new g({x:n[0],y:n[1],spatialReference:t}),new g({x:c[0],y:c[1],spatialReference:t}),new g({x:l[0],y:l[1],spatialReference:t})]}onActivate(){this.visible=!0}onDeactivate(){this.visible=!1}onShow(){this._graphicsLayer.visible=!0}onHide(){this._graphicsLayer.visible=!1}canUndo(){return this._editGeometryOperations.canUndo}canRedo(){return this._editGeometryOperations.canRedo}undo(){this._editGeometryOperations.undo(),this.updateGraphics()}redo(){this._editGeometryOperations.redo(),this.updateGraphics()}refresh(){const{view:e,target:t}=this,i="georeference"in t?t.georeference.coords:t.geometry,a=this._editGeometryOperations,s=a.data.parts[0].vertices,r=A.EditGeometry.fromGeometry(f.project(i,e.spatialReference),2).parts[0].vertices;s.forEach((e,t)=>{a.setVertexPosition(e,r[t].pos)}),this.updateGraphics()}reset(){const{target:e}=this;if("georeference"in e){const t=e.georeference;"control-points"===t.type&&(t.controlPoints=this._initialControlPoints)}else e.geometry=this._initialGeometry;this.refresh(),this._sharedUndoStack.length=0,this._sharedRedoStack.length=0}updateGraphics(){const e=this._editGeometryOperations.data.geometry;"georeference"in this.target&&(this.target.georeference.coords=e),this._graphic.geometry=e,this._backgroundGraphic.geometry=this._backgroundGraphicGeometry,this._rotateGraphic.geometry=this._rotateGraphicGeometry,this._scaleGraphicGeometries.forEach((e,t)=>{this._scaleGraphics[t].geometry=e})}setSharedUndoStack(e){this._sharedUndoStack=e}setSharedRedoStack(e){this._sharedRedoStack=e}async _initialize(){const{view:e,target:t}=this;if("georeference"in t){const e=t.georeference;this._graphic=new i({geometry:e.coords}),this._initialControlPoints="control-points"===e.type?e.controlPoints:null}else this._graphic=t,this._initialGeometry=t.geometry;e.map.addMany([this._graphicsLayer]),e.focus(),this.visible=!1,this.finishToolCreation(),await this._loadProjectionEngine(),this._editGeometryOperations=O.EditGeometryOperations.fromGeometry(f.project(this._graphic.geometry,e.spatialReference),2),this._backgroundGraphic=new i({symbol:new w({color:"transparent",outline:{type:"simple-line",color:e.effectiveTheme.accentColor,width:2}}),geometry:this._backgroundGraphicGeometry}),this._rotateGraphic=new i({symbol:new R({color:a.getContrast(e.effectiveTheme.accentColor),outline:{type:"simple-line",color:e.effectiveTheme.accentColor,width:1}}),geometry:this._rotateGraphicGeometry}),this._scaleGraphics=this._scaleGraphicGeometries.map(t=>new i({symbol:new R({size:6,style:"square",color:a.getContrast(e.effectiveTheme.accentColor),outline:{type:"simple-line",color:e.effectiveTheme.accentColor,width:1}}),geometry:t})),this._graphicsLayer.graphics.addMany([this._backgroundGraphic,this._rotateGraphic,...this._scaleGraphics]),this._dragManipulation=new T.DragManipulation({tool:this,view:e,graphic:this._graphic}),this._rotateManipulation=new C.RotateManipulation({tool:this,view:e,graphic:this._rotateGraphic,snapRotation:this._snapRotation}),this._scaleManipulations=this._scaleGraphics.map((t,i)=>new S.ScaleManipulation({tool:this,view:e,graphic:t,direction:B[i],preserveAspectRatio:this._preserveAspectRatio})),this.addHandles([this._dragManipulation.createDragPipeline(this._getInfo.bind(this),this._updateGraphics.bind(this)),this._rotateManipulation.createDragPipeline(this._getInfo.bind(this),this._updateGraphics.bind(this)),...this._scaleManipulations.map(e=>e.createDragPipeline(this._getInfo.bind(this),this._updateGraphics.bind(this))),r.watch(()=>this.view.scale,()=>this.active?this.updateGraphics():null),e.on("click",async i=>{if(null!=e.activeTool&&e.activeTool!==this)return;const a=D.createScreenPointFromEvent(i),s=[];e.map.allLayers.forEach(e=>{"vector-tile"!==e.type&&"imagery"!==e.type||s.push(e)});const r=await this.view.hitTest(a,{exclude:s}),o=r.results;if(0===o.length)e.activeTool=null;else{const i=x.findFirstGraphicHit(r.results),a="georeference"in t,s=o.map(e=>"media"===e.type?e.element:null).filter(Boolean),n=new Set([...this._graphicsLayer.graphics,a?null:t].filter(Boolean));a&&s.includes(t)||null!=i&&n.has(i.graphic)?null==e.activeTool&&(e.activeTool=this):e.activeTool=null}})]);const s=e=>{this.addHandles(e.events.on("grab-changed",e=>{"georeference"in t&&("start"===e.action?t.opacity*=.5:"end"===e.action&&(t.opacity*=2))}))};this._dragManipulation.forEachManipulator(s),this._rotateManipulation.forEachManipulator(s),this._scaleManipulations.forEach(e=>e.forEachManipulator(s));const o=new k.KeyBindings;o.addToggle(k.mediaKeys.preserveAspectRatio,()=>{null==this.preserveAspectRatio&&(this._preserveAspectRatio.enabled=!this._preserveAspectRatio.enabled)}),o.addToggle(k.mediaKeys.rotateIncrements,()=>{null==this.snapRotation&&(this._snapRotation.enabled=!this._snapRotation.enabled)}),o.add(k.mediaKeys.toggleOpacity,()=>{"georeference"in t&&(t.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled)}),o.addToggle(k.mediaKeys.factorModifier,e=>this._factor="key-down"===e.type?10:1),o.add(k.mediaKeys.scaleUp,()=>this._scale(this._factor)),o.add(k.mediaKeys.scaleDown,()=>this._scale(-this._factor)),o.add(k.mediaKeys.moveUp,()=>this._move(0,this._factor)),o.add(k.mediaKeys.moveDown,()=>this._move(0,-this._factor)),o.add(k.mediaKeys.moveLeft,()=>this._move(-this._factor,0)),o.add(k.mediaKeys.moveRight,()=>this._move(this._factor,0)),this.addHandles([e.on("key-down",t=>{e.activeTool===this&&o.dispatch(e.inputManager,t)}),e.on("key-up",t=>{e.activeTool===this&&o.dispatch(e.inputManager,t)})])}async _loadProjectionEngine(){const e=this._graphic.geometry;return f.initializeProjection(e.spatialReference,this.view.spatialReference)}_updateDisplayPlaneConrers(e){const{basis1:t,basis2:i,origin:a}=e,s=this._cornerA;y.add(s,a,t),y.add(s,s,i);const r=this._cornerB;y.add(r,a,t),y.subtract(r,r,i);const o=this._cornerC;y.subtract(o,a,t),y.subtract(o,o,i);const n=this._cornerD;y.subtract(n,a,t),y.add(n,n,i)}_getInfo(){return{editGeometryOperations:this._editGeometryOperations,plane:this._plane,displayPlane:this._displayPlane}}_updateGraphics(e,t){"start"===e.action&&(this._sharedUndoStack.push({tool:this,operation:t}),this._sharedRedoStack.length=0),this.updateGraphics()}_scale(e){const t=this._editGeometryOperations,i=t.data.geometry.extent?.width,a=(i+e*this.view.resolution)/i,s=t.scale(this._plane.origin,_.UNIT_X,a,a,0,1);this._sharedUndoStack.push({tool:this,operation:s}),this._sharedRedoStack.length=0,this.updateGraphics()}_move(e,t){const i=this._editGeometryOperations.move(e*this.view.resolution,t*this.view.resolution,0,0);this._sharedUndoStack.push({tool:this,operation:i}),this._sharedRedoStack.length=0,this.updateGraphics()}},t.__decorate([n.property()],e.TransformTool.prototype,"_plane",null),t.__decorate([n.property()],e.TransformTool.prototype,"_backgroundGraphicGeometry",null),t.__decorate([n.property()],e.TransformTool.prototype,"_rotateGraphicGeometry",null),t.__decorate([n.property()],e.TransformTool.prototype,"_scaleGraphicGeometries",null),t.__decorate([n.property()],e.TransformTool.prototype,"preserveAspectRatio",void 0),t.__decorate([n.property()],e.TransformTool.prototype,"snapRotation",void 0),t.__decorate([n.property({constructOnly:!0,nonNullable:!0})],e.TransformTool.prototype,"target",void 0),t.__decorate([n.property({readOnly:!0})],e.TransformTool.prototype,"type",void 0),t.__decorate([n.property({constructOnly:!0})],e.TransformTool.prototype,"view",void 0),e.TransformTool=t.__decorate([p.subclass("esri.views.2d.interactive.editingTools.TransformTool")],e.TransformTool),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});