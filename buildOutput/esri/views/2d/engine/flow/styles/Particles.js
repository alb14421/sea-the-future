// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/promiseUtils","../utils","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject","../../../../webgl/VertexAttributeLocations","../../../../webgl/VertexBuffer","../../../../webgl/VertexElementDescriptor"],function(e,t,a,r,s,i,o,n,l){"use strict";class m{constructor(e){this._params=e}get animated(){return this._params.flowSpeed>0}isCompatible(e){return e instanceof m&&a.areStreamlinesCompatible(this._params,e._params)}async load(e,a){const{extent:r,size:s}=e;t.throwIfAborted(a);const i=await this._params.loadImagery(r,s[0],s[1],this._params.timeExtent,a),{vertexData:o,indexData:n}=await this._params.createFlowMesh("Particles",this._params.simulationSettings,i,a);return new f(o,n,{color:this._params.color,opacity:this._params.opacity,size:this._params.size})}render(e,t,r){const{context:i}=e,{program:o}=r;i.setFaceCullingEnabled(!1),i.setBlendingEnabled(!0),i.setBlendFunction(1,771),i.useProgram(o),o.setUniform1f("u_time",t.time),o.setUniform1f("u_trailLength",this._params.trailLength),o.setUniform1f("u_flowSpeed",this._params.flowSpeed),o.setUniform1f("u_featheringSize",this._params.featheringSize),o.setUniform1f("u_featheringOffset",this._params.featheringOffset),o.setUniform1f("u_introFade",this._params.introFade?1:0),o.setUniform1f("u_fadeToZero",this._params.fadeToZero?1:0),o.setUniform1f("u_decayRate",this._params.decayRate),o.setUniformMatrix3fv("u_dvsMat3",t.dvsMat3),o.setUniformMatrix3fv("u_displayViewMat3",t.displayViewMat3),a.setUniforms(o,"color","vec4",this._params.color),a.setUniforms(o,"opacity","float",this._params.opacity),a.setUniforms(o,"size","float",this._params.size),i.bindVAO(r.vertexArray),i.drawElements(s.PrimitiveType.TRIANGLES,r.indexCount,s.DataType.UNSIGNED_INT,0)}}const p=[new l.VertexElementDescriptor("a_xyts0",4,s.DataType.FLOAT,0,64),new l.VertexElementDescriptor("a_xyts1",4,s.DataType.FLOAT,16,64),new l.VertexElementDescriptor("a_typeIdDurationSeed",4,s.DataType.FLOAT,32,64),new l.VertexElementDescriptor("a_extrudeInfo",4,s.DataType.FLOAT,48,64)],c={vsPath:"raster/flow/particles",fsPath:"raster/flow/particles",locations:o.fromLayout(p)};class f{constructor(e,t,a){this._vertexData=e,this._indexData=t,this._values=a}attach(e){const{context:t}=e,a=new n.VertexBuffer(t,p,this._vertexData),s=r.BufferObject.createIndex(t,35044,this._indexData),o=new i.VertexArrayObject(t,a,s),l=[];"ramp"===this._values.color.kind&&l.push("vvColor"),"ramp"===this._values.opacity.kind&&l.push("vvOpacity"),"ramp"===this._values.size.kind&&l.push("vvSize");const m=e.getProgram(c,l);this.vertexArray=o,this.program=m,this.indexCount=this._indexData.length,this._vertexData=null,this._indexData=null}detach(){this.vertexArray.dispose()}get ready(){return this.program.compiled}}e.Particles=m,e.ParticlesResources=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});