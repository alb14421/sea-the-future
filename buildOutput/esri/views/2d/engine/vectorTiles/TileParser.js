// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../core/pbf","../../../../core/promiseUtils","../../../../geometry/libtess","../../../../geometry/support/TileClipper","./Feature","./GeometryUtils","./IndexMemoryBuffer","./SourceLayerData","./VertexMemoryBuffer","./buckets/CircleBucket","./buckets/FillBucket","./buckets/LineBucket","./buckets/SymbolBucket"],function(e,t,r,s,i,n,o,l,a,c,u,f,h){"use strict";return class{constructor(t,r,i,o,l,a){if(this._pbfTiles={},this._tileClippers={},this._client=i,this._tile=r,this._sourceDataMaxLOD=o,a){this._styleLayerUIDs=new Set;for(const e of a)this._styleLayerUIDs.add(e)}this._styleRepository=l,this._layers=this._styleRepository?.layers??[];const[c,u,f]=r.tileKey.split("/").map(parseFloat);this._level=c;const h=n.getTileMargins(this._level);for(const r of Object.keys(t)){const i=t[r];if(this._pbfTiles[r]=new e(new Uint8Array(i.protobuff),new DataView(i.protobuff)),i.refKey){const[e]=i.refKey.split("/").map(parseFloat),t=c-e;if(t>0){const e=(1<<t)-1,i=u&e,n=f&e;this._tileClippers[r]=new s.TileClipper(t,i,n,8,h)}}this._tileClippers[r]||(this._tileClippers[r]=new s.SimpleBuilder)}}_canParseStyleLayer(e){return!this._styleLayerUIDs||this._styleLayerUIDs.has(e)}async parse(e){const t=r.loadLibtess(),s=this._initialize(e),{returnedBuckets:i}=s;this._processLayers(s),this._linkReferences(s),this._filterFeatures(s);const n=[],o=new Set,l=(e,t)=>{o.has(e)||(n.push({name:e,repeat:t}),o.add(e))},a={};for(const e of i)e.getResources(e.tileClipper,l,a);if(4===this._tile.status)return[];const c=this._fetchResources(n,a,e);return Promise.all([...c,t]).then(()=>this._processFeatures(s.returnedBuckets))}_initialize(e){const t=e?.signal;return{signal:t,sourceNameToTileData:this._parseTileData(this._pbfTiles),layers:this._layers,zoom:this._level,sourceNameToTileClipper:this._tileClippers,sourceNameToUniqueSourceLayerBuckets:{},sourceNameToUniqueSourceLayers:{},returnedBuckets:[],layerIdToBucket:{},referencerUIDToReferencedId:new Map}}_processLayers(e){const{sourceNameToTileData:t,zoom:r,layers:s,sourceNameToTileClipper:i,sourceNameToUniqueSourceLayerBuckets:n,sourceNameToUniqueSourceLayers:o,returnedBuckets:l,layerIdToBucket:a,referencerUIDToReferencedId:c}=e,u=this._sourceDataMaxLOD;for(let e=s.length-1;e>=0;e--){const f=s[e];if(r<u){if(f.minzoom&&r<Math.floor(f.minzoom)||f.maxzoom&&r>=f.maxzoom)continue}else if(f.maxzoom&&r>=f.maxzoom)continue;if(0===f.type||!this._canParseStyleLayer(f.uid)||!t[f.source]||!i[f.source])continue;const h=t[f.source],p=i[f.source],_=f.sourceLayer,y=h[_];if(y){let e=o[f.source];if(e||(e=o[f.source]=new Set),e.add(f.sourceLayer),f.refLayerId)c.set(f.uid,f.refLayerId);else{const e=this._createBucket(f);if(e){e.layerUIDs=[f.uid],e.layerExtent=y.extent,e.tileClipper=p;let t=n[f.source];t||(t=n[f.source]={});let r=t[_];r||(r=t[_]=[]),r.push(e),l.push(e),a[f.id]=e}}}}}_linkReferences(e){const{layerIdToBucket:t,referencerUIDToReferencedId:r}=e;r.forEach((e,r)=>{t[e]&&t[e].layerUIDs.push(r)})}_filterFeatures(e){const{signal:r,sourceNameToTileData:s,sourceNameToUniqueSourceLayerBuckets:n,sourceNameToUniqueSourceLayers:o}=e,l=10*this._level,a=10*(this._level+1),c=[],u=[];for(const e of Object.keys(o))o[e].forEach(t=>{c.push(t),u.push(e)});for(let e=0;e<c.length;e++){const o=u[e],f=c[e];if(!s[o]||!n[o])continue;const h=s[o][f],p=n[o][f];if(!p||0===p.length)continue;if(t.isAborted(r))return;let _=0;const y=h.getData();for(;y.nextTag(2);){const e=y.getMessage(),t=new i(e,h,_++);e.release();const r=t.values;if(r){const e=r._minzoom;if(e&&e>=a)continue;const t=r._maxzoom;if(t&&t<=l)continue}for(const e of p)e.pushFeature(t)}}}_fetchResources(e,t,r){const s=[],i=this._tile.getWorkerTileHandler();let n,o;e.length>0&&(n=i.fetchSprites(e,this._client,r),s.push(n));for(const e in t){const n=t[e];n.size>0&&(o=i.fetchGlyphs(this._tile.tileKey,e,n,this._client,r),s.push(o))}return s}_processFeatures(e){const t=e.filter(e=>e.hasFeatures()||this._canParseStyleLayer(e.layer.uid));for(const e of t)e.processFeatures(e.tileClipper);return t}_parseTileData(e){const t={};for(const r of Object.keys(e)){const s=e[r],i={};for(;s.next();)switch(s.tag()){case 3:{const e=s.getMessage(),t=new l(e);e.release(),i[t.name]=t;break}default:s.skip()}t[r]=i}return t}_createBucket(e){switch(e.type){case 0:return null;case 1:return this._createFillBucket(e);case 2:return this._createLineBucket(e);case 4:return this._createCircleBucket(e);case 3:return this._createSymbolBucket(e)}}_createFillBucket(e){return new u(e,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new a.FillVertexBuffer(e.fillMaterial.getStride()),new o.TriangleIndexBuffer,new a.OutlineVertexBuffer(e.outlineMaterial.getStride()),new o.TriangleIndexBuffer)}_createLineBucket(e){return new f(e,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new a.LineVertexBuffer(e.lineMaterial.getStride()),new o.TriangleIndexBuffer)}_createCircleBucket(e){return new c(e,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new a.CircleVertexBuffer(e.circleMaterial.getStride()),new o.TriangleIndexBuffer)}_createSymbolBucket(e){const t=this._tile;return new h(t.tileKey,e,this._level,new a.SymbolVertexBuffer(e.iconMaterial.getStride()),new o.TriangleIndexBuffer,new a.SymbolVertexBuffer(e.textMaterial.getStride()),new o.TriangleIndexBuffer,t.placementEngine,t.getWorkerTileHandler())}}});