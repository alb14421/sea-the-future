// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../core/maybe","../vtlBrushes","./shaders/VTLMaterialManager"],function(e,t,s){"use strict";const l=1e-6,r=[null];return class{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache={vtlBackground:null,vtlFill:null,vtlLine:null,vtlCircle:null,vtlSymbol:null},this._vtlMaterialManager=new s}dispose(){this._brushCache.vtlBackground?.dispose(),this._brushCache.vtlFill?.dispose(),this._brushCache.vtlLine?.dispose(),this._brushCache.vtlCircle?.dispose(),this._brushCache.vtlSymbol?.dispose(),this._brushCache=null,this._vtlMaterialManager=e.disposeMaybe(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(e,s,n){const a=n.layers;e.renderPass="translucent";let i=this._brushCache.vtlSymbol;null==i&&(i=new t.vtlBrushes.vtlSymbol,this._brushCache.vtlSymbol=i),r[0]=s;for(let t=0;t<a.length;t++){const s=a[t];if(3!==s.type)continue;const n=s.getLayoutProperty("visibility");if(n&&1===n.getValue())continue;const u=e.displayLevel;void 0!==s.minzoom&&s.minzoom>u+l||void 0!==s.maxzoom&&s.maxzoom<=u-l||(e.styleLayerUID=s.uid,e.styleLayer=s,i.drawMany(e,r))}r[0]=null}drawBackground(e,s,n){if(0===n.backgroundBucketIds.length)return;const{context:a,displayLevel:i,requiredLevel:u}=e;s.key.level=u,a.setBlendingEnabled(!0),a.setDepthTestEnabled(!1),a.setStencilTestEnabled(!1),e.renderPass="background";let o=this._brushCache.vtlBackground;null==o&&(o=new t.vtlBrushes.vtlBackground,this._brushCache.vtlBackground=o),r[0]=s,n.backgroundBucketIds.forEach(t=>{const s=n.getLayerById(t);if(0!==s.type)return;const a=s.getLayoutProperty("visibility");a&&1===a.getValue()||void 0!==s.minzoom&&s.minzoom>i+l||void 0!==s.maxzoom&&s.maxzoom<=i-l||(e.styleLayerUID=s.uid,e.styleLayer=s,o.drawMany(e,r))}),r[0]=null}drawTile(e,t,s,l){const{context:r}=e,n=s.layers;r.setBlendingEnabled(!1),r.setDepthTestEnabled(!0),r.setDepthWriteEnabled(!0),r.setDepthFunction(515);const a=n.filter(e=>{if(null!=l&&l!==e.type||!t.layerData.has(e.uid))return!1;const s=e.getLayoutProperty("visibility");return 1!==s?.getValue()});e.renderPass="opaque";for(let s=a.length-1;s>=0;--s)this._renderStyleLayer(a[s],e,t);r.setDepthWriteEnabled(!1),r.setBlendingEnabled(!0),r.setBlendFunctionSeparate(1,771,1,771),e.renderPass="translucent",a.forEach(s=>this._renderStyleLayer(s,e,t)),r.setDepthTestEnabled(!1),r.bindVAO(null)}_renderStyleLayer(e,s,n){const{renderPass:a}=s;let i;switch(e.type){case 0:if("background"!==a)return;i=this._brushCache.vtlBackground,i||(i=new t.vtlBrushes.vtlBackground,this._brushCache.vtlBackground=i);break;case 1:if("opaque"!==a&&"translucent"!==s.renderPass)return;i=this._brushCache.vtlFill,null==i&&(i=new t.vtlBrushes.vtlFill,this._brushCache.vtlFill=i);break;case 2:if("translucent"!==a)return;i=this._brushCache.vtlLine,null==i&&(i=new t.vtlBrushes.vtlLine,this._brushCache.vtlLine=i);break;case 4:if("translucent"!==a)return;i=this._brushCache.vtlCircle,null==i&&(i=new t.vtlBrushes.vtlCircle,this._brushCache.vtlCircle=i);break;case 3:if("translucent"!==a)return;i=this._brushCache.vtlSymbol,null==i&&(i=new t.vtlBrushes.vtlSymbol,this._brushCache.vtlSymbol=i)}const{displayLevel:u}=s,{minzoom:o,maxzoom:h}=e;if(void 0!==o&&o>u+l||void 0!==h&&h<=u-l)return;const{context:c}=s;c.setStencilTestEnabled(!1),c.setStencilWriteMask(0),s.styleLayerUID=e.uid,s.styleLayer=e,r[0]=n,i.drawMany(s,r),r[0]=null}}});