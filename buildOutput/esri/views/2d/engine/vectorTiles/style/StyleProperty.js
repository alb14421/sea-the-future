// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../../Color","../../../../../colorUtils","../GeometryUtils","../expression/expression","../expression/types"],function(t,e,r,i,l){"use strict";class a{constructor(t,e){let r;switch(this.isDataDriven=!1,this.interpolator=null,t.type){case"number":case"color":r=!0;break;case"array":r="number"===t.value;break;default:r=!1}if((null==e||""===e&&"color"===t.type)&&(e=t.default),Array.isArray(e)&&e.length>0&&i.ops[e[0]]){const r={number:l.numberType,color:l.colorType,string:l.stringType,boolean:l.booleanType,enum:l.stringType};try{const a="array"===t.type?l.arrayType(r[t.value]||l.valueType,t.length):r[t.type],s=i.createExpression(e,null,a);this.getValue=this._buildExpression(s,t),this.isDataDriven=!0,s instanceof i.Interpolate&&s.input instanceof i.Zoom&&(this.interpolator=s)}catch(e){console.log(e.message),this.getValue=this._buildSimple(t.default)}return}r&&"interval"===e.type&&(r=!1);const a=e?.stops&&e.stops.length>0;if(a)for(const r of e.stops)r[1]=this._validate(r[1],t);if(this.isDataDriven=!!e&&!!e.property,this.isDataDriven)if(void 0!==e.default&&(e.default=this._validate(e.default,t)),a)switch(e.type){case"identity":this.getValue=this._buildIdentity(e,t);break;case"categorical":this.getValue=this._buildCategorical(e,t);break;default:this.getValue=r?this._buildInterpolate(e,t):this._buildInterval(e,t)}else this.getValue=this._buildIdentity(e,t);else a?this.getValue=r?this._buildZoomInterpolate(e):this._buildZoomInterval(e):(e=this._validate(e,t),this.getValue=this._buildSimple(e))}_validate(t,e){if("number"===e.type){if(null!=e.minimum&&t<e.minimum)return e.minimum;if(null!=e.maximum&&t>e.maximum)return e.maximum}else"color"===e.type?t=a._parseColor(t):"enum"===e.type?"string"==typeof t&&(t=e.values.indexOf(t)):"array"===e.type&&"enum"===e.value?t=t.map(t=>"string"==typeof t?e.values.indexOf(t):t):"string"===e.type&&(t=l.valueToString(t));return t}_buildSimple(t){return()=>t}_buildExpression(t,e){return(r,i)=>{try{const l=t.evaluate(i,r);return void 0===l?e.default:this._validate(l,e)}catch(t){return console.log(t.message),e.default}}}_buildIdentity(t,e){return(r,i)=>{let l;return i&&(l=i.values[t.property]),void 0!==l&&(l=this._validate(l,e)),null!=l?l:void 0!==t.default?t.default:e.default}}_buildCategorical(t,e){return(r,i)=>{let l;return i&&(l=i.values[t.property]),l=this._categorical(l,t.stops),void 0!==l?l:void 0!==t.default?t.default:e.default}}_buildInterval(t,e){return(r,i)=>{let l;return i&&(l=i.values[t.property]),"number"==typeof l?this._interval(l,t.stops):void 0!==t.default?t.default:e.default}}_buildInterpolate(t,e){return(r,i)=>{let l;return i&&(l=i.values[t.property]),"number"==typeof l?this._interpolate(l,t.stops,t.base||1):void 0!==t.default?t.default:e.default}}_buildZoomInterpolate(t){return e=>this._interpolate(e,t.stops,t.base||1)}_buildZoomInterval(t){return e=>this._interval(e,t.stops)}_categorical(t,e){const r=e.length;for(let i=0;i<r;i++)if(e[i][0]===t)return e[i][1]}_interval(t,e){const r=e.length;let i=0;for(let l=0;l<r&&e[l][0]<=t;l++)i=l;return e[i][1]}_interpolate(t,e,i){let l,a;const s=e.length;for(let r=0;r<s;r++){const i=e[r];if(!(i[0]<=t)){a=i;break}l=i}if(l&&a){const e=a[0]-l[0],s=t-l[0],n=1===i?s/e:(i**s-1)/(i**e-1);if(Array.isArray(l[1])){const t=l[1],e=a[1],i=[];for(let l=0;l<t.length;l++)i.push(r.interpolate(t[l],e[l],n));return i}return r.interpolate(l[1],a[1],n)}return l?l[1]:a?a[1]:void 0}static _isEmpty(t){for(const e in t)if(t.hasOwnProperty(e))return!1;return!0}static _parseColor(r){return Array.isArray(r)?r:"string"==typeof r?e.parseToUnitRgba(r)??void 0:r instanceof t&&!this._isEmpty(r)?t.toUnitRGBA(r):void 0}}return a});