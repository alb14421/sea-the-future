// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../geometry/support/aaBoundingRect","../constants","../GeometryUtils","../shaders/VTLBackgroundMaterial","../shaders/VTLCircleMaterial","../shaders/VTLFillMaterial","../shaders/VTLLineMaterial","../shaders/VTLSymbolMaterial","./Filter","./StyleDefinition","./StyleProperty","../../webgl/definitions"],function(t,i,e,a,n,r,o,s,l,h,u,c,p){"use strict";class g{constructor(t,i,e,a){switch(this.type=t,this.typeName=i.type,this.id=i.id,this.source=i.source,this.sourceLayer=i["source-layer"],this.minzoom=i.minzoom,this.maxzoom=i.maxzoom,this.filter=i.filter,this.layout=i.layout,this.paint=i.paint,this.z=e,this.uid=a,t){case 0:this._layoutDefinition=u.StyleDefinition.backgroundLayoutDefinition,this._paintDefinition=u.StyleDefinition.backgroundPaintDefinition;break;case 1:this._layoutDefinition=u.StyleDefinition.fillLayoutDefinition,this._paintDefinition=u.StyleDefinition.fillPaintDefinition;break;case 2:this._layoutDefinition=u.StyleDefinition.lineLayoutDefinition,this._paintDefinition=u.StyleDefinition.linePaintDefinition;break;case 3:this._layoutDefinition=u.StyleDefinition.symbolLayoutDefinition,this._paintDefinition=u.StyleDefinition.symbolPaintDefinition;break;case 4:this._layoutDefinition=u.StyleDefinition.circleLayoutDefinition,this._paintDefinition=u.StyleDefinition.circlePaintDefinition}this._layoutProperties=this._parseLayout(this.layout),this._paintProperties=this._parsePaint(this.paint)}getFeatureFilter(){return void 0!==this._featureFilter?this._featureFilter:this._featureFilter=h.createFilter(this.filter)}getLayoutProperty(t){return this._layoutProperties[t]}getPaintProperty(t){return this._paintProperties[t]}getLayoutValue(t,i,e){let a;const n=this._layoutProperties[t];return n&&(a=n.getValue(i,e)),void 0===a&&(a=this._layoutDefinition[t].default),a}getPaintValue(t,i,e){let a;const n=this._paintProperties[t];return n&&(a=n.getValue(i,e)),void 0===a&&(a=this._paintDefinition[t].default),a}isPainterDataDriven(){const t=this._paintProperties;if(t)for(const i in t)if(t[i].isDataDriven)return!0;return!1}isIntersectingFeature(t,i,e,a,n,r,o){return!1}getFeatureInflatedBounds(t,i,e,a){return null}_parseLayout(t){const i={};for(const e in t){const a=this._layoutDefinition[e];a&&(i[e]=new c(a,t[e]))}return i}_parsePaint(t){const i={};for(const e in t){const a=this._paintDefinition[e];a&&(i[e]=new c(a,t[e]))}return i}computeAttributesKey(t,i,e,a){let n=0,r=0;for(const t of i){let i=3;if(!t||t!==a){const a=e[t],{isLayout:n,isOptional:r}=a,o=n?this.getLayoutProperty(t):this.getPaintProperty(t);i=o?.interpolator?2:o?.isDataDriven?1:r&&!o?3:0}r|=i<<n,n+=2}return r<<3|t}}function y(t){const e=t?.getGeometry();if(null==e)return null;let a=1/0,n=1/0,r=-1/0,o=-1/0;for(const t of e)if(t)for(const i of t)a=Math.min(a,i.x),n=Math.min(n,i.y),r=Math.max(r,i.x),o=Math.max(o,i.y);return i.fromValues(a,n,r,o)}t.BackgroundStyleLayer=class extends g{constructor(t,i,e,a){super(t,i,e,a),this.backgroundMaterial=new n.VTLBackgroundMaterial(this.computeAttributesKey(0,n.VTLBackgroundMaterial.ATTRIBUTES,n.VTLBackgroundMaterial.ATTRIBUTES_INFO))}},t.CircleStyleLayer=class extends g{constructor(t,i,e,a){super(t,i,e,a),this.circleMaterial=new r.VTLCircleMaterial(this.computeAttributesKey(5,r.VTLCircleMaterial.ATTRIBUTES,r.VTLCircleMaterial.ATTRIBUTES_INFO))}getFeatureInflatedBounds(t,i,a,n){const r=y(t);if(!r)return null;const o=this.getPaintValue("circle-translate",i,t),s=Math.max(o[0],o[1]);r[0]-=s,r[2]-=s,r[1]+=s,r[3]+=s;const l=n*(e.tilePixelRatio*(this.getPaintValue("circle-radius",i,t)+this.getPaintValue("circle-stroke-width",i,t))/2);return r[0]-=l,r[1]-=l,r[2]+=l,r[3]+=l,r}isIntersectingFeature(t,i,n,r,o,s,l){const h=r.getGeometry();if(!h)return!1;const u=e.tilePixelRatio/l.normalizationRatio;t=t/l.normalizationRatio+l.normalizationOffsetX,i=i/l.normalizationRatio+l.normalizationOffsetY,n*=u;const c=a.translateAnchor(this.getPaintValue("circle-translate",o,r),this.getPaintValue("circle-translate-anchor",o,r),s,u),p=u*(this.getPaintValue("circle-radius",o,r)+this.getPaintValue("circle-stroke-width",o,r));let g,y;for(const e of h)if(e)for(const a of e)if(g=a.x+c.x,y=a.y+c.y,Math.sqrt((t-g)*(t-g)+(i-y)*(i-y))-n<=p)return!0;return!1}},t.FillStyleLayer=class extends g{constructor(t,i,e,a){super(t,i,e,a);const n=this.getPaintProperty("fill-color"),r=this.getPaintProperty("fill-opacity"),s=this.getPaintProperty("fill-pattern");this.hasDataDrivenColor=n?.isDataDriven,this.hasDataDrivenOpacity=r?.isDataDriven,this.hasDataDrivenFill=this.hasDataDrivenColor||this.hasDataDrivenOpacity||s?.isDataDriven;const l=this.getPaintProperty("fill-outline-color");this.outlineUsesFillColor=!l,this.hasDataDrivenOutlineColor=l?.isDataDriven,this.hasDataDrivenOutline=l?l.isDataDriven:!!n&&n.isDataDriven,this.hasDataDrivenOutline=(l?this.hasDataDrivenOutlineColor:this.hasDataDrivenColor)||this.hasDataDrivenOpacity,this.fillMaterial=new o.VTLFillMaterial(this.computeAttributesKey(1,o.VTLFillMaterial.ATTRIBUTES,o.VTLFillMaterial.ATTRIBUTES_INFO)),this.outlineMaterial=new o.VTLOutlineMaterial(this.computeAttributesKey(2,this.outlineUsesFillColor?o.VTLOutlineMaterial.ATTRIBUTES_FILL:o.VTLOutlineMaterial.ATTRIBUTES_OUTLINE,this.outlineUsesFillColor?o.VTLOutlineMaterial.ATTRIBUTES_INFO_FILL:o.VTLOutlineMaterial.ATTRIBUTES_INFO_OUTLINE),this.outlineUsesFillColor)}getFeatureInflatedBounds(t,i,e,a){const n=y(t);if(!n)return null;const r=this.getPaintValue("fill-translate",i,t),o=a*Math.max(r[0],r[1]);return n[0]-=o,n[2]-=o,n[1]+=o,n[3]+=o,n}isIntersectingFeature(t,i,n,r,o,s,l){const h=r.getGeometry();if(!h)return!1;const u=e.tilePixelRatio/l.normalizationRatio;t=t/l.normalizationRatio+l.normalizationOffsetX,i=i/l.normalizationRatio+l.normalizationOffsetY;const c=a.translateAnchor(this.getPaintValue("fill-translate",o,r),this.getPaintValue("fill-translate-anchor",o,r),s,e.tilePixelRatio);return t-=u*c.x,i-=u*c.y,!!a.pointInPolygon(t,i,h)||a.distanceFromToPolylineWithinThreshold(t,i,h,u*n)}},t.IconLayout=class{constructor(t,i,e){let a;this.allowOverlap=t.getLayoutValue("icon-allow-overlap",i),this.ignorePlacement=t.getLayoutValue("icon-ignore-placement",i),this.keepUpright=t.getLayoutValue("icon-keep-upright",i),this.optional=t.getLayoutValue("icon-optional",i),this.rotationAlignment=t.getLayoutValue("icon-rotation-alignment",i),2===this.rotationAlignment&&(this.rotationAlignment=e?0:1),a=t.getLayoutProperty("icon-anchor"),a?.isDataDriven?this._anchorProp=a:this.anchor=t.getLayoutValue("icon-anchor",i),a=t.getLayoutProperty("icon-offset"),a?.isDataDriven?this._offsetProp=a:this.offset=t.getLayoutValue("icon-offset",i),a=t.getLayoutProperty("icon-padding"),a?.isDataDriven?this._paddingProp=a:this.padding=t.getLayoutValue("icon-padding",i),a=t.getLayoutProperty("icon-rotate"),a?.isDataDriven?this._rotateProp=a:this.rotate=t.getLayoutValue("icon-rotate",i),a=t.getLayoutProperty("icon-size"),a?.isDataDriven?this._sizeProp=a:this.size=t.getLayoutValue("icon-size",i)}update(t,i){this._anchorProp&&(this.anchor=this._anchorProp.getValue(t,i)),this._offsetProp&&(this.offset=this._offsetProp.getValue(t,i)),this._paddingProp&&(this.padding=this._paddingProp.getValue(t,i)),this._rotateProp&&(this.rotate=this._rotateProp.getValue(t,i)),this._sizeProp&&(this.size=this._sizeProp.getValue(t,i))}},t.IndexItem=class{constructor(t,i,e,a,n,r){this.layer=t,this.feature=i,this.bounds=e,this.normalizationRatio=a,this.normalizationOffsetX=n,this.normalizationOffsetY=r}},t.LineStyleLayer=class extends g{constructor(t,i,e,a){super(t,i,e,a);const n=this.getPaintProperty("line-pattern");if(this.lineMaterial=new s.VTLLineMaterial(this.computeAttributesKey(3,s.VTLLineMaterial.ATTRIBUTES,s.VTLLineMaterial.ATTRIBUTES_INFO,n?"line-dasharray":"")),this.hasDataDrivenLine=this.getPaintProperty("line-blur")?.isDataDriven||this.getPaintProperty("line-color")?.isDataDriven||this.getPaintProperty("line-gap-width")?.isDataDriven||this.getPaintProperty("line-offset")?.isDataDriven||this.getPaintProperty("line-opacity")?.isDataDriven||this.getPaintProperty("line-pattern")?.isDataDriven||this.getPaintProperty("line-dasharray")?.isDataDriven||this.getLayoutProperty("line-cap")?.isDataDriven||this.getPaintProperty("line-width")?.isDataDriven,this.canUseThinTessellation=!1,!this.hasDataDrivenLine){const t=this.getPaintProperty("line-width");if(!t||"number"==typeof t&&.5*t<p.thinLineHalfWidthThreshold){const t=this.getPaintProperty("line-offset");(!t||"number"==typeof t&&0===t)&&(this.canUseThinTessellation=!0)}}}getDashKey(t,i){let e;switch(i){case 0:default:e="Butt";break;case 1:e="Round";break;case 2:e="Square"}return`dasharray-[${t.toString()}]-${e}`}getFeatureInflatedBounds(t,i,e,a){const n=y(t);if(!n)return null;const r=this.getPaintValue("line-translate",i,t),o=a*Math.max(r[0],r[1]);n[0]-=o,n[2]-=o,n[1]+=o,n[3]+=o;const s=a*Math.abs(this.getPaintValue("line-offset",i,t)||0),l=a*(this.getPaintValue("line-width",i,t)/2);return n[0]-=s+l,n[1]-=s+l,n[2]+=s+l,n[3]+=s+l,n}isIntersectingFeature(t,i,n,r,o,s,l){let h=r.getGeometry();if(!h)return!1;const u=e.tilePixelRatio/l.normalizationRatio;t=t/l.normalizationRatio+l.normalizationOffsetX,i=i/l.normalizationRatio+l.normalizationOffsetY;const c=a.translateAnchor(this.getPaintValue("line-translate",o,r),this.getPaintValue("line-translate-anchor",o,r),s,e.tilePixelRatio);t-=u*c.x,i-=u*c.y;const p=u*this.getPaintValue("line-offset",o,r)||0;0!==p&&(h=a.offsetLine(h,-p));const g=this.getPaintValue("line-width",o,r)/2;return a.distanceFromToPolylineWithinThreshold(t,i,h,u*(n+g))}},t.StyleLayer=g,t.SymbolStyleLayer=class extends g{constructor(t,i,e,a){super(t,i,e,a),this.iconMaterial=new l.VTLIconMaterial(this.computeAttributesKey(4,l.VTLIconMaterial.ATTRIBUTES,l.VTLIconMaterial.ATTRIBUTES_INFO)),this.textMaterial=new l.VTLTextMaterial(this.computeAttributesKey(6,l.VTLTextMaterial.ATTRIBUTES,l.VTLTextMaterial.ATTRIBUTES_INFO)),this.hasDataDrivenIcon=this.getPaintProperty("icon-color")?.isDataDriven||this.getPaintProperty("icon-halo-blur")?.isDataDriven||this.getPaintProperty("icon-halo-color")?.isDataDriven||this.getPaintProperty("icon-halo-width")?.isDataDriven||this.getPaintProperty("icon-opacity")?.isDataDriven||this.getLayoutProperty("icon-size")?.isDataDriven,this.hasDataDrivenText=this.getPaintProperty("text-color")?.isDataDriven||this.getPaintProperty("text-halo-blur")?.isDataDriven||this.getPaintProperty("text-halo-color")?.isDataDriven||this.getPaintProperty("text-halo-width")?.isDataDriven||this.getPaintProperty("text-opacity")?.isDataDriven||this.getLayoutProperty("text-size")?.isDataDriven}},t.TextLayout=class{constructor(t,i,e){let a;this.allowOverlap=t.getLayoutValue("text-allow-overlap",i),this.ignorePlacement=t.getLayoutValue("text-ignore-placement",i),this.keepUpright=t.getLayoutValue("text-keep-upright",i),this.optional=t.getLayoutValue("text-optional",i),this.rotationAlignment=t.getLayoutValue("text-rotation-alignment",i),2===this.rotationAlignment&&(this.rotationAlignment=e?0:1),a=t.getLayoutProperty("text-anchor"),a?.isDataDriven?this._anchorProp=a:this.anchor=t.getLayoutValue("text-anchor",i),a=t.getLayoutProperty("text-justify"),a?.isDataDriven?this._justifyProp=a:this.justify=t.getLayoutValue("text-justify",i),a=t.getLayoutProperty("text-letter-spacing"),a?.isDataDriven?this._letterSpacingProp=a:this.letterSpacing=t.getLayoutValue("text-letter-spacing",i),a=t.getLayoutProperty("text-line-height"),a?.isDataDriven?this._lineHeightProp=a:this.lineHeight=t.getLayoutValue("text-line-height",i),a=t.getLayoutProperty("text-max-angle"),a?.isDataDriven?this._maxAngleProp=a:this.maxAngle=t.getLayoutValue("text-max-angle",i),a=t.getLayoutProperty("text-max-width"),a?.isDataDriven?this._maxWidthProp=a:this.maxWidth=t.getLayoutValue("text-max-width",i),a=t.getLayoutProperty("text-offset"),a?.isDataDriven?this._offsetProp=a:this.offset=t.getLayoutValue("text-offset",i),a=t.getLayoutProperty("text-padding"),a?.isDataDriven?this._paddingProp=a:this.padding=t.getLayoutValue("text-padding",i),a=t.getLayoutProperty("text-rotate"),a?.isDataDriven?this._rotateProp=a:this.rotate=t.getLayoutValue("text-rotate",i),a=t.getLayoutProperty("text-size"),a?.isDataDriven?this._sizeProp=a:this.size=t.getLayoutValue("text-size",i),a=t.getLayoutProperty("text-writing-mode"),a?.isDataDriven?this._writingModeProp=a:this.writingMode=t.getLayoutValue("text-writing-mode",i)}update(t,i){this._anchorProp&&(this.anchor=this._anchorProp.getValue(t,i)),this._justifyProp&&(this.justify=this._justifyProp.getValue(t,i)),this._letterSpacingProp&&(this.letterSpacing=this._letterSpacingProp.getValue(t,i)),this._lineHeightProp&&(this.lineHeight=this._lineHeightProp.getValue(t,i)),this._maxAngleProp&&(this.maxAngle=this._maxAngleProp.getValue(t,i)),this._maxWidthProp&&(this.maxWidth=this._maxWidthProp.getValue(t,i)),this._offsetProp&&(this.offset=this._offsetProp.getValue(t,i)),this._paddingProp&&(this.padding=this._paddingProp.getValue(t,i)),this._rotateProp&&(this.rotate=this._rotateProp.getValue(t,i)),this._sizeProp&&(this.size=this._sizeProp.getValue(t,i)),this._writingModeProp&&(this.writingMode=this._writingModeProp.getValue(t,i))}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});