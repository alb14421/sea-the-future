// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../../core/lang","./StyleLayer"],function(e,t){"use strict";class r{constructor(t,r=!0){if(this.backgroundBucketIds=[],this._uidToLayer=new Map,this._layerByName={},this._runningId=0,this._style=r?e.clone(t):t,this._style.layers||(this._style.layers=[]),this.version=parseFloat(this._style.version),this.layers=this._style.layers.map((e,t,r)=>this._create(e,t,r)).filter(e=>!!e),this.layers)for(let e=0;e<this.layers.length;e++){const t=this.layers[e];this._layerByName[t.id]=t,this._uidToLayer.set(t.uid,t),0===t.type&&this.backgroundBucketIds.push(t.id)}this._identifyRefLayers()}getLayerStyleProperties(e,t){const r=this.getStyleLayerByUID(e),a=0!==r?.getLayoutValue("symbol-placement",t);let i=r?.getLayoutValue("icon-rotation-alignment",t);2===i&&(i=a?0:1);let s=r?.getLayoutValue("text-rotation-alignment",t);2===s&&(s=a?0:1);const l=r?.getPaintValue("icon-translate",t),y=r?.getPaintValue("icon-translate-anchor",t),n=r?.getPaintValue("text-translate",t),o=r?.getPaintValue("text-translate-anchor",t);return{geometryType:null,iconAllowOverlap:r?.getLayoutValue("icon-allow-overlap",t),iconIgnorePlacement:r?.getLayoutValue("icon-ignore-placement",t),textAllowOverlap:r?.getLayoutValue("text-allow-overlap",t),textIgnorePlacement:r?.getLayoutValue("text-ignore-placement",t),iconRotationAlignment:i,textRotationAlignment:s,iconTranslateAnchor:y,iconTranslate:l,textTranslateAnchor:o,textTranslate:n}}isPainterDataDriven(e){const t=this._layerByName[e];return!!t&&t.isPainterDataDriven()}getStyleLayerId(e){return e>=this.layers.length?null:this.layers[e].id}getStyleLayerByUID(e){return this._uidToLayer.get(e)??null}getStyleLayerIndex(e){const t=this._layerByName[e];return t?this.layers.indexOf(t):-1}setStyleLayer(e,t){if(!e?.id)return;const a=this._style;null!=t&&t>=this.layers.length&&(t=this.layers.length-1);let i,s=!0;const l=this._layerByName[e.id];if(l){const y=this.layers.indexOf(l);t||(t=y),t===y?(s=!1,i=r._recreateLayer(e,l),this.layers[t]=i,a.layers[t]=e):(this.layers.splice(y,1),a.layers.splice(y,1),i=this._create(e,t,this.layers),this.layers.splice(t,0,i),a.layers.splice(t,0,e))}else i=this._create(e,t,this.layers),!t||t>=this.layers.length?(this.layers.push(i),a.layers.push(e)):(this.layers.splice(t,0,i),a.layers.splice(t,0,e));this._layerByName[e.id]=i,this._uidToLayer.set(i.uid,i),s&&this._recomputeZValues(),this._identifyRefLayers()}getStyleLayer(e){const t=this._layerByName[e];return t?{type:t.typeName,id:t.id,source:t.source,"source-layer":t.sourceLayer,minzoom:t.minzoom,maxzoom:t.maxzoom,filter:t.filter,layout:t.layout,paint:t.paint}:null}deleteStyleLayer(e){const t=this._layerByName[e];if(t){delete this._layerByName[e],this._uidToLayer.delete(t.uid);const r=this.layers.indexOf(t);this.layers.splice(r,1),this._style.layers.splice(r,1),this._recomputeZValues(),this._identifyRefLayers()}}getLayerById(e){return this._layerByName[e]}getLayoutProperties(e){const t=this._layerByName[e];return t?t.layout:null}getPaintProperties(e){const t=this._layerByName[e];return t?t.paint:null}setPaintProperties(e,t){const a=this._layerByName[e];if(!a)return;const i={type:a.typeName,id:a.id,source:a.source,"source-layer":a.sourceLayer,minzoom:a.minzoom,maxzoom:a.maxzoom,filter:a.filter,layout:a.layout,paint:t},s=r._recreateLayer(i,a),l=this.layers.indexOf(a);this.layers[l]=s,this._style.layers[l].paint=t,this._layerByName[a.id]=s,this._uidToLayer.set(a.uid,s)}setLayoutProperties(e,t){const a=this._layerByName[e];if(!a)return;const i={type:a.typeName,id:a.id,source:a.source,"source-layer":a.sourceLayer,minzoom:a.minzoom,maxzoom:a.maxzoom,filter:a.filter,layout:t,paint:a.paint},s=r._recreateLayer(i,a),l=this.layers.indexOf(a);this.layers[l]=s,this._style.layers[l].layout=t,this._layerByName[a.id]=s,this._uidToLayer.set(a.uid,s)}setStyleLayerVisibility(e,t){const a=this._layerByName[e];if(!a)return;const i=a.layout||{};i.visibility=t;const s={type:a.typeName,id:a.id,source:a.source,"source-layer":a.sourceLayer,minzoom:a.minzoom,maxzoom:a.maxzoom,filter:a.filter,layout:i,paint:a.paint},l=r._recreateLayer(s,a),y=this.layers.indexOf(a);this.layers[y]=l,this._style.layers[y].layout=i,this._layerByName[a.id]=l,this._uidToLayer.set(a.uid,l)}getStyleLayerVisibility(e){const t=this._layerByName[e];if(!t)return"none";const r=t.layout;return r?.visibility??"visible"}_recomputeZValues(){const e=this.layers,t=1/(e.length+1);for(let r=0;r<e.length;r++)e[r].z=1-(1+r)*t}_identifyRefLayers(){const e=[],t=[];let r=0;for(const a of this.layers){const i=a.layout;if(1===a.type){const t=a;let s=a.source+"|"+a.sourceLayer;s+="|"+(i?.visibility??""),s+="|"+a.minzoom,s+="|"+a.maxzoom,s+="|"+JSON.stringify(a.filter),(t.hasDataDrivenFill||t.hasDataDrivenOutline)&&(s+="|"+r),e.push({key:s,layer:a})}else if(2===a.type){const e=a,s=a.paint,l=null!=s&&(null!=s["line-pattern"]||null!=s["line-dasharray"]);let y=a.source+"|"+a.sourceLayer;y+="|"+(i?.visibility??""),y+="|"+a.minzoom,y+="|"+a.maxzoom,y+="|"+JSON.stringify(a.filter),y+="|"+(void 0!==i?i["line-cap"]:""),y+="|"+(void 0!==i?i["line-join"]:""),(e.hasDataDrivenLine||l)&&(y+="|"+r),t.push({key:y,layer:a})}++r}this._assignRefLayers(e),this._assignRefLayers(t)}_assignRefLayers(e){let t,r;e.sort((e,t)=>e.key<t.key?-1:e.key>t.key?1:0);const a=e.length;for(let i=0;i<a;i++){const s=e[i];if(s.key===t)s.layer.refLayerId=r;else if(t=s.key,r=s.layer.id,1===s.layer.type){if(!s.layer.getPaintProperty("fill-outline-color"))for(let l=i+1;l<a;l++){const a=e[l];if(a.key!==t)break;if(a.layer.getPaintProperty("fill-outline-color")){e[i]=a,e[l]=s,r=a.layer.id;break}}}else if(2===s.layer.type){let l=s.layer;for(let y=i+1;y<a;y++){const a=e[y];if(a.key!==t)break;const n=a.layer;(l.canUseThinTessellation&&!n.canUseThinTessellation||!l.canUseThinTessellation&&(n.getPaintProperty("line-pattern")||n.getPaintProperty("line-dasharray")))&&(l=n,e[i]=a,e[y]=s,r=a.layer.id)}}}}_create(e,r,a){const i=1-(1+r)*(1/(a.length+1)),s=this._runningId++;switch(e.type){case"background":return new t.BackgroundStyleLayer(0,e,i,s);case"fill":return new t.FillStyleLayer(1,e,i,s);case"line":return new t.LineStyleLayer(2,e,i,s);case"symbol":return new t.SymbolStyleLayer(3,e,i,s);case"raster":return console.warn(`Unsupported vector tile raster layer ${e.id}`),null;case"circle":return new t.CircleStyleLayer(4,e,i,s)}return null}static _recreateLayer(e,r){switch(e.type){case"background":return new t.BackgroundStyleLayer(0,e,r.z,r.uid);case"fill":return new t.FillStyleLayer(1,e,r.z,r.uid);case"line":return new t.LineStyleLayer(2,e,r.z,r.uid);case"symbol":return new t.SymbolStyleLayer(3,e,r.z,r.uid);case"raster":return console.warn(`Unsupported vector tile raster layer ${e.id}`),null;case"circle":return new t.CircleStyleLayer(4,e,r.z,r.uid)}return null}}return r});