// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../Graphic","../../../../core/MapUtils","../../../../core/pbf","../../../../core/libs/rbush/PooledRBush","../../../../graphic/VectorTileGraphicOrigin","./constants","./Feature","./GeometryUtils","./SourceLayerData","./style/StyleLayer"],function(e,t,s,i,r,l,o,n,a,y){"use strict";const c=(e,t)=>{const s=e.vtlSymbol.sourceTile,i=t.vtlSymbol.sourceTile;return s.level!==i.level?s.level-i.level:s.row!==i.row?s.row-i.row:s.col!==i.col?s.col-i.col:e.styleLayerUID-t.styleLayerUID};class u{constructor(e,t,s,i,r){this.tileKey=e,this._tileLayerData=t,this._styleRepository=s,this._tileHandler=i,this._parentLayer=r,this._index=null,this._tileKeyToPBF=new Map}static create(e,t,s,i,r){return new u(e,t,s,i,r)}clear(){this._index?.clear(),this._tileKeyToPBF.clear()}async queryAttributes(e,t,s,r,l){if(0===this._tileLayerData.size||!this._styleRepository||!this._tileHandler)return[];null===this._index&&(this._index=new i.PooledRBush(100,h),await this._indexLayers());const o=[];return this._queryIndex(o,e,t,s,this.tileKey.level,r),l&&l?.length>0&&await this._getSymbolsAttributes(o,l),o}async _indexLayers(){const e=this.tileKey,t=this._styleRepository.layers,s=await this._getTilePayload(e);for(const[i,r]of this._tileLayerData){const l=t[i],o=s.find(e=>e.sourceName===l.source);if(!o)continue;const{protobuff:n,key:a}=o;if(3!==r.type){const t=1<<e.level-a.level,s=e.row-a.row*t,i=e.col-a.col*t;this._indexLayer(l,n,e.level,t,s,i)}}}_indexLayer(e,t,i,r,c,u){const h=e.sourceLayer,d=e.getFeatureFilter(),g=i,_=i+1,f=n.getTileMargins(g),w=new s(new Uint8Array(t),new DataView(t));for(;w.next();)switch(w.tag()){case 3:{const t=w.getMessage(),s=new a(t);if(t.release(),s.name!==h)continue;const n=s.getData(),m=s.extent/r,b=m*u-f,x=m*c-f,p=b+m+2*f,L=x+m+2*f,v=m/l.tilePixelSize,I=l.tileCoordSize/m,T=m*u,D=m*c;for(;n.nextTag(2);){const t=n.getMessage(),r=new o(t,s);if(t.release(),d&&!d.filter(r,i))continue;const l=r.values||{},a=l._minzoom,c=l._maxzoom;if(a&&a>=10*_||c&&c<=10*g)continue;const u=e.getFeatureInflatedBounds(r,g,s.extent,v);null==u||u[0]>p||u[1]>L||u[2]<b||u[3]<x||(u[0]=(u[0]-T)*I,u[1]=(u[1]-D)*I,u[2]=(u[2]-T)*I,u[3]=(u[3]-D)*I,this._index.insert(new y.IndexItem(e,r,u,I,T,D)))}break}default:w.skip()}w.release()}async _getSymbolsAttributes(e,t){if(!t||0===t.length)return e;const s=[];if(t.sort(c),t.length>0){let e=0,{styleLayerUID:i}=t[0];for(let r=1;r<t.length;r++){const{styleLayerUID:l}=t[r];l!==i&&(s.push({from:e,to:r,styleLayerUID:i,sourceTileKey:t[r-1].vtlSymbol.sourceTile}),e=r,i=l)}const r=t.length-1;s.push({from:e,to:t.length,styleLayerUID:i,sourceTileKey:t[r].vtlSymbol.sourceTile})}const i=this._styleRepository.layers;for(const r of s){const s=await this._getTilePayload(r.sourceTileKey),l=i[r.styleLayerUID],o=!!l&&s.find(e=>e.sourceName===l.source);o&&this._addSymbolsAttributes(e,t.slice(r.from,r.to).map(e=>e.vtlSymbol.featureIndex),r.styleLayerUID,o)}return e}_addSymbolsAttributes(t,s,i,l){const o=this._styleRepository.layers,n=l.key,a=this.tileKey,y=1<<a.level-n.level,c=a.row-n.row*y,u=a.col-n.col*y;this._getSymbolAttributes(l.protobuff,s,i,y,c,u).forEach(s=>{const{attributes:l,tilePoint:n}=s;t.push({layerId:o[i].id,layerIndex:i,graphic:new e({attributes:l,origin:new r(this._parentLayer,o[i].id,i)}),tilePoint:n})})}_getSymbolAttributes(e,t,i,r,n,y){const c=[],u=this._styleRepository.layers;let h=0;t.sort((e,t)=>e-t);const d=new s(new Uint8Array(e),new DataView(e));for(;d.next();)switch(d.tag()){case 3:{const e=d.getMessage(),s=new a(e);if(e.release(),s.name!==u[i].sourceLayer)continue;const g=s.getData(),_=s.extent/r,f=l.tileCoordSize/_,w=_*y,m=_*n;let b=0;for(;g.nextTag(2);){const e=g.getMessage();if(b++===t[h]){const t=new o(e,s),i=t.values,r=t.getGeometry(),l=null!=r?[f*(r[0][0].x-w),f*(r[0][0].y-m)]:null;c.push({attributes:i,tilePoint:l}),h++}if(e.release(),h===t.length)return c}break}default:d.skip()}return d.release(),c}_queryIndex(t,s,i,o,n,a){const y=l.tilePixelRatio*o*(window.devicePixelRatio||1);return this._index?.search({minX:s-y,minY:i-y,maxX:s+y,maxY:i+y},l=>{const{layer:y,feature:c}=l;y.isIntersectingFeature(s,i,o,c,n,a,l)&&t.push({layerId:y.id,layerIndex:y.uid,tilePoint:null,graphic:new e({attributes:c.values,origin:new r(this._parentLayer,l.layer.id,l.layer.uid)})})}),t}async _getTilePayload(e){return t.getOrCreateMapValue(this._tileKeyToPBF,e.id,()=>this._tileHandler.fetchTilePBFs(e)).then(e=>e)}}const h=e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]});return u});