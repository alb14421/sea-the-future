// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","./ScriptUtils","../webgl/Rect"],function(t,e,i){"use strict";t.TextShaping=class{constructor(t,e,i,s,o,c,a){this._glyphItems=t,this._maxWidth=e,this._lineHeight=i,this._letterSpacing=s,this._hAnchor=o,this._vAnchor=c,this._justify=a}getShaping(t,i,s){const o=this._letterSpacing,c=this._lineHeight,a=this._justify,h=this._maxWidth,l=[];let n=0,r=0;for(const i of t){const t=i.codePointAt(0);if(null==t)continue;const c=s&&e.hasVerticalOrientation(t);let a;for(const e of this._glyphItems)if(a=e[t],a)break;l.push({codePoint:t,x:n,y:r,vertical:c,glyphMosaicItem:a}),a&&(n+=a.metrics.advance+o)}let f=n;h>0&&(f=n/Math.max(1,Math.ceil(n/h)));const p=t.includes("â€‹"),m=[],g=l.length;for(let t=0;t<g-1;t++){const i=l[t].codePoint,s=e.allowsIdeographicBreak(i);if(e.isLineBreak(i)||s){let e=0;if(10===i)e-=1e4;else if(s&&p)e+=150;else{40!==i&&65288!==i||(e+=50);const s=l[t+1].codePoint;41!==s&&65289!==s||(e+=50)}m.push(this._buildBreak(t+1,l[t].x,f,m,e,!1))}}const d=this._optimalBreaks(this._buildBreak(g,n,f,m,0,!0));let y=0;const u=i?-c:c;let x=0;for(let t=0;t<d.length;t++){const i=d[t];let s=x;for(;s<i&&e.isWhiteSpace(l[s].codePoint);)l[s].glyphMosaicItem=null,++s;let o=i-1;for(;o>s&&e.isWhiteSpace(l[o].codePoint);)l[o].glyphMosaicItem=null,--o;if(s<=o){const t=l[s].x;for(let e=s;e<=o;e++)l[e].x-=t,l[e].y=r;let e=l[o].x;l[o].glyphMosaicItem&&(e+=l[o].glyphMosaicItem.metrics.advance),y=Math.max(e,y),a&&this._applyJustification(l,s,o)}x=i,r+=u}if(l.length>0){const t=d.length-1,e=(a-this._hAnchor)*y;let s=(-this._vAnchor*(t+1)+.5)*c;i&&t&&(s+=t*c);for(const t of l)t.x+=e,t.y+=s}return l.filter(t=>t.glyphMosaicItem)}static getTextBox(t,e){if(!t.length)return null;let i=1/0,s=1/0,o=0,c=0;for(const a of t){const t=a.glyphMosaicItem.metrics.advance,h=a.x,l=a.y-17,n=h+t,r=l+e;i=Math.min(i,h),o=Math.max(o,n),s=Math.min(s,l),c=Math.max(c,r)}return{x:i,y:s,width:o-i,height:c-s}}static getBox(t){if(!t.length)return null;let e=1/0,i=1/0,s=0,o=0;for(const c of t){const{height:t,left:a,top:h,width:l}=c.glyphMosaicItem.metrics,n=c.x,r=c.y-(t-Math.abs(h)),f=n+l+a,p=r+t;e=Math.min(e,n),s=Math.max(s,f),i=Math.min(i,r),o=Math.max(o,p)}return{x:e,y:i,width:s-e,height:o-i}}static addDecoration(t,e){const s=t.length;if(0===s)return;let o=t[0].x+t[0].glyphMosaicItem.metrics.left,c=t[0].y;for(let a=1;a<s;a++){const s=t[a];if(s.y!==c){const h=t[a-1].x+t[a-1].glyphMosaicItem.metrics.left+t[a-1].glyphMosaicItem.metrics.width;t.push({codePoint:0,x:o,y:c+e-3,vertical:!1,glyphMosaicItem:{sdf:!0,rect:new i(4,0,4,8),metrics:{width:h-o,height:8,left:0,top:0,advance:0},page:0,code:0}}),c=s.y,o=s.x+s.glyphMosaicItem.metrics.left}}const a=t[s-1].x+t[s-1].glyphMosaicItem.metrics.left+t[s-1].glyphMosaicItem.metrics.width;t.push({codePoint:0,x:o,y:c+e-3,vertical:!1,glyphMosaicItem:{sdf:!0,rect:new i(4,0,4,8),metrics:{width:a-o,height:8,left:0,top:0,advance:0},page:0,code:0}})}_breakScore(t,e,i,s){const o=(t-e)*(t-e);return s?t<e?o/2:2*o:o+Math.abs(i)*i}_buildBreak(t,e,i,s,o,c){let a=null,h=this._breakScore(e,i,o,c);for(const t of s){const s=e-t.x,l=this._breakScore(s,i,o,c)+t.score;l<=h&&(a=t,h=l)}return{index:t,x:e,score:h,previousBreak:a}}_optimalBreaks(t){return t?this._optimalBreaks(t.previousBreak).concat(t.index):[]}_applyJustification(t,e,i){const s=t[i],o=s.vertical?24:s.glyphMosaicItem?s.glyphMosaicItem.metrics.advance:0,c=(s.x+o)*this._justify;for(let s=e;s<=i;s++)t[s].x-=c}},t.sdfGlyphBaseline=17,t.sdfGlyphSize=24,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});