// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../core/Error","../../../../core/events","../../../../core/Handles","../../../../core/Logger","../../../../core/maybe","../../../../core/perspectiveUtils","../../../../core/reactiveUtils","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../support/mediaLayerUtils","../DisplayObject","./animatedFormats/utils","../../../webgl/Texture","../../../webgl/TextureDescriptor"],function(e,t,i,r,s,n,a,o,d,l,h,u,c,p,m){"use strict";const y=[1,1],w=o.create(),x={none:"None",loop:"Loop",oscillate:"Oscillate"};class v extends u.DisplayObject{constructor(n){super(),this.elementView=n,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=l.create(),this._handles=new i,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([a.watch(()=>this.elementView.element.opacity,e=>this.opacity=e,a.initial),a.watch(()=>[this.elementView.coords],()=>{this.requestRender()},a.initial),a.watch(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._handles.remove("play"),this.texture=s.disposeMaybe(this.texture),this.requestRender()},a.initial),a.when(()=>this.elementView.element.loaded,()=>{const e=this.elementView.element;this.ready(),h.isVideoElement(e)&&null!=e.content&&(this._handles.add([t.on(e.content,"play",()=>this.requestRender()),t.on(e.content,"loadeddata",()=>this.requestRender()),t.on(e.content,"loaded",()=>this.requestRender())]),"requestVideoFrameCallback"in e.content?e.content.requestVideoFrameCallback(()=>this.requestRender()):this._handles.add([t.on(e.content,"seeked",()=>this.requestRender())]),this.requestRender())},a.initial)]),n.element.load().catch(t=>{r.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new e("element-load-error","Element cannot be displayed",{element:n,error:t}))})}getMesh(e){throw new Error("Method not implemented.")}destroy(){super.destroy(),this._handles.destroy(),this.texture=s.disposeMaybe(this.texture)}get textureSize(){return y}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,i=this.elementView.element.content;if(null!=i){const e=i instanceof HTMLImageElement,s=i instanceof HTMLVideoElement,n=e?i.naturalWidth:s?i.videoWidth:i.width,a=e?i.naturalHeight:s?i.videoHeight:i.height;if(this._updatePerspectiveTransform(n,a),this.texture){if(s)if(i.readyState>=i.HAVE_CURRENT_DATA)this._updateTextureAndRequestRender(i);else{const e=()=>{this._updateTextureAndRequestRender(i),i.removeEventListener("canplay",e),i.removeEventListener("seeked",e)};i.addEventListener("canplay",e),i.addEventListener("seeked",e)}}else{const e=new m.TextureDescriptor(n,a);if(e.wrapMode=33071,e.preMultiplyAlpha=!0,"getFrame"in i){const s=i=>{this.texture?this.texture.setData(i):this.texture=new p.Texture(t,e,i),this.requestRender()};"animationOptions"in this.elementView.element&&this._handles.add(c.play(i,(r=this.elementView.element.animationOptions)?{type:"CIMAnimatedSymbolProperties",...r,playAnimation:r.playing,repeatType:r.repeatType?x[r.repeatType]:void 0}:{type:"CIMAnimatedSymbolProperties"},null,s),"play")}else this.texture=new p.Texture(t,e,i);this.texture.generateMipmap(),s&&("requestVideoFrameCallback"in i?i.requestVideoFrameCallback(()=>this.requestRender()):i.paused||this.requestRender())}}var r;super.beforeRender(e)}_updateTextureAndRequestRender(e){this.texture.setData(e),this.texture.generateMipmap(),"requestVideoFrameCallback"in e?e.requestVideoFrameCallback(()=>this.requestRender()):e.paused||this.requestRender()}_createTransforms(){return null}draw(e,t){this.isReady&&null!=this.texture?t.render(e,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:y,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices}):this.requestRender()}updateDrawCoords(e,t,i,r){const{coords:s,bounds:n}=this.elementView;if(null==s||null==n)return;const[a,o,d,l]=s.rings[0],h=this._vertices,{x:u,y:c}=e;h.set([o[0]-u,o[1]-c,a[0]-u,a[1]-c,d[0]-u,d[1]-c,l[0]-u,l[1]-c]);let p=t;if(r){const[e,,t]=n,{worldWidth:i,xBounds:s}=r,[a,o]=s;e<a&&t>a?p=i:t>o&&e<o&&(p=-i)}this.wrapAroundShift=p,this.isWrapAround=0!==p}_updatePerspectiveTransform(e,t){const i=this._vertices;n.getProjectiveTransform(w,[0,0,e,0,0,t,e,t],[i[0],i[1],i[4],i[5],i[2],i[3],i[6],i[7]]),d.set(this.perspectiveTransform,w[6]/w[8]*e,w[7]/w[8]*t)}}return v});