// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../../core/arrayUtils"],function(e){"use strict";return class{constructor(e,r){this.brushes=e,this.name=r.name,this.drawPhase=r.drawPhase||1,this._targetFn=r.target,this.effects=r.effects||[],this.enableDefaultDraw=r.enableDefaultDraw??(()=>!0),this.forceDrawByDisplayOrder=!!r.forceDrawByDisplayOrder}render(e){const{context:r,profiler:t}=e,s=this._targetFn(),n=this.drawPhase&e.drawPhase;if(t.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(e,s),t.recordPassEnd();for(const t of this.effects){if(!t.enable())continue;const n=t.apply,a=t.args?.(),i=r.getViewport(),d=r.getBoundFramebufferObject(),f=e.passOptions;this._bindEffect(e,n,a),this._doRender(e,s,n.defines),this._drawAndUnbindEffect(e,n,i,d,f,a)}}}_doRender(e,r,t){if(null==r)return;const{profiler:s,context:n}=e;for(const a of this.brushes){if(s.recordBrushStart(a.name),null!=a.brushEffect){const s=n.getViewport(),i=n.getBoundFramebufferObject(),d=e.passOptions;this._bindEffect(e,a.brushEffect),this._drawWithBrush(a,e,r,t),this._drawAndUnbindEffect(e,a.brushEffect,s,i,d)}else this._drawWithBrush(a,e,r,t);s.recordBrushEnd()}}_drawWithBrush(r,t,s,n){e.isArrayLike(s)?(r.prepareState(t,n),r.drawMany(t,s,n)):s.visible&&(r.prepareState(t,n),r.draw(t,s,n))}_bindEffect(e,r,t){const{profiler:s}=e;s.recordPassStart(this.name+"."+r.name),r.bind(e,t);const n=r.createOptions(e,t);e.passOptions=n}_drawAndUnbindEffect(e,r,t,s,n,a){const{profiler:i,context:d}=e;e.passOptions=n,i.recordBrushStart(r.name),r.draw(e,a),r.unbind(e,a),d.bindFramebuffer(s);const{x:f,y:o,width:c,height:h}=t;d.setViewport(f,o,c,h),i.recordBrushEnd(),i.recordPassEnd()}}});