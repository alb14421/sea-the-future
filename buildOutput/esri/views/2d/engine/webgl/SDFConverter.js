// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../core/floatRGBA","../../../../core/promiseUtils","../svgUtils"],function(t,e,i){"use strict";const s=1e20;return class{constructor(t,e=2){this._textureSize=t,this._rasterizationScale=e,this._canvasSize=this._textureSize*this._rasterizationScale,this._svg=null;const{_canvasSize:i}=this,s=document.createElement("canvas");s.width=s.height=i,this._context=s.getContext("2d",{willReadFrequently:!1}),this._gridOuter=new Float64Array(i*i),this._gridInner=new Float64Array(i*i),this._f=new Float64Array(i),this._d=new Float64Array(i),this._z=new Float64Array(i+1),this._v=new Int16Array(i)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg=i.destroyHiddenSvg(this._svg)}draw(i,r,n){const{_canvasSize:o,_textureSize:a,_rasterizationScale:h}=this,_=a/4;this._initSVG();const c=this.createSVGString(i,r);return new Promise((i,r)=>{const l=new Image;l.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(c),l.onload=()=>{l.onload=null,this._context.clearRect(0,0,o,o),this._context.drawImage(l,0,0,o,o);const e=this._context.getImageData(0,0,o,o),r=new Uint8Array(a*a*4);for(let t=0;t<o*o;t++){const i=e.data[4*t+3]/255;this._gridOuter[t]=1===i?0:0===i?s:Math.max(0,.5-i)**2,this._gridInner[t]=1===i?s:0===i?0:Math.max(0,i-.5)**2}this._edt(this._gridOuter,o,o),this._edt(this._gridInner,o,o);for(let e=0;e<a*a;e++){let i=0;for(let t=0;t<h;t++){const s=Math.floor(e/a)*h+t;for(let t=0;t<h;t++){const r=s*o+(e%a*h+t);i+=this._gridOuter[r]-this._gridInner[r]}}i/=h*h,i/=h;const s=.5-i/(2*_);t.packFloatRGBA(s,r,4*e)}i(r)};const d=n?.signal;d&&e.onAbort(d,()=>r(e.createAbortError()))})}_initSVG(){return this._svg||(this._svg=i.createHiddenSvg()),this._svg}createSVGString(t,e){const s=this._initSVG(),r=i.createSvgElement("path");r.setAttribute("d",t),s.appendChild(r);const n=r.getBBox(),o=n.width/n.height,a=this._canvasSize/2;let h,_,c;if(o>1){h=a/n.width;const t=a*(1/o);_=this._canvasSize/4,c=a-t/2}else h=a/n.height,_=a-a*o/2,c=this._canvasSize/4;const l=-n.x*h+_,d=-n.y*h+c;r.setAttribute("style",`transform: matrix(${h}, 0, 0, ${h}, ${l}, ${d})`),r.setAttribute("stroke-width",""+.5/h);const g=`<svg style="fill:${e?"red":"none"}; stroke:${e?"none":"red"}" height="${this._canvasSize}" width="${this._canvasSize}" xmlns="http://www.w3.org/2000/svg">${s.innerHTML}</svg>`;return s.removeChild(r),g}_edt(t,e,i){const s=this._f,r=this._d,n=this._v,o=this._z;for(let a=0;a<e;a++){for(let r=0;r<i;r++)s[r]=t[r*e+a];this._edt1d(s,r,n,o,i);for(let s=0;s<i;s++)t[s*e+a]=r[s]}for(let a=0;a<i;a++){for(let i=0;i<e;i++)s[i]=t[a*e+i];this._edt1d(s,r,n,o,e);for(let i=0;i<e;i++)t[a*e+i]=Math.sqrt(r[i])}}_edt1d(t,e,i,r,n){i[0]=0,r[0]=-s,r[1]=+s;for(let e=1,o=0;e<n;e++){let n=(t[e]+e*e-(t[i[o]]+i[o]*i[o]))/(2*e-2*i[o]);for(;n<=r[o];)o--,n=(t[e]+e*e-(t[i[o]]+i[o]*i[o]))/(2*e-2*i[o]);o++,i[o]=e,r[o]=n,r[o+1]=+s}for(let s=0,o=0;s<n;s++){for(;r[o+1]<s;)o++;e[s]=(s-i[o])*(s-i[o])+t[i[o]]}}}});