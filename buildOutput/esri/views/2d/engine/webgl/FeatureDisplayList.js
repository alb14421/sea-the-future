// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/has","./cpuMapped/FreeList","./shaderGraph/techniques/featureTechniqueUtils","../../../webgl/enums"],function(t,e,n,i,a){"use strict";function s(t,e){return t<<16|255&e}class r{constructor(t,e,n,i,a){this.instance=t,this.materialKey=e,this.target=n,this.start=i,this.count=a}get textureKey(){return 255&this.materialKey}get indexEnd(){return this.start+this.count}extend(t){this.count+=t}render(t){this.instance.techniqueRef.render(t,this)}get key(){return this.target.key}getStencilReference(){return this.target.stencilRef}getAttributePrecisionPackFactors(){const t=this.instance.instanceId;return this.target.getMesh(t).getAttributePrecisionPackFactors()}draw(t,e){i.isHittest(t)?this.drawCompute(t.context,e):this.drawGeometry(t.context,e)}drawCompute(t,e){const n=this.instance.instanceId,i=this.target.getMesh(n).getComputeVAO(t,e),s=this.start*Uint32Array.BYTES_PER_ELEMENT/3;t.bindVAO(i,e.locations),t.drawElements(a.PrimitiveType.POINTS,this.count/3,a.DataType.UNSIGNED_INT,s),t.bindVAO(null)}drawGeometry(t,e){const n=this.instance.instanceId,i=this.target.getMesh(n).getGeometryVAO(t,e),s=this.start*Uint32Array.BYTES_PER_ELEMENT;t.bindVAO(i,e.locations),t.drawElements(a.PrimitiveType.TRIANGLES,this.count,a.DataType.UNSIGNED_INT,s),t.bindVAO(null)}}class d{constructor(){this._length=0,this._minOrderedLength=0,this._materialKeys=new Set}static fromDisplayEntities(t,e,n,i){const a=new d;for(const r of t.values())for(const t of r.records){const r=n.getInstance(t.instanceId),d=s(r.instanceId,t.textureKey);a.addRecord(r,d,t.indexStart,t.indexCount,t.vertexStart,t.vertexCount,e,i)}return a}get length(){return this._length}get minOrderedLength(){return this._minOrderedLength}get minUnorderedLength(){return this._materialKeys.size}render(t,e){const{drawPhase:n}=t;for(const i of this.infos()){const a=i.instance.techniqueRef;a.drawPhase&n&&(null==e||a.type===e)&&i.render(t)}}addRecord(t,e,i,a,s,d,h,l){let o=i,c=a;if(c||(o=s,c=d),!c)return;if(null==this._head){const i=new r(t,e,h,o,c);return this._head=new n.List(i),this._tail=this._head,this._length++,void this._minOrderedLength++}if(1===l)return this._insert(t,e,h,o,c,this._tail,null);let u=null,_=this._head;const g=t.instanceId,y=t.techniqueRef.symbologyPlane;if(2===l&&(2===y||3===y))return this._insert(t,e,h,o,c,this._tail,null);for(;_;){const n=_.data.instance,i=n.instanceId,a=n.techniqueRef.symbologyPlane,s=u?.data.instance.instanceId;if(y<a||g===s&&g!==i)return this._insert(t,e,h,o,c,u,_);u=_,_=_.next}this._insert(t,e,h,o,c,u,null)}*infos(){if(null!=this._head)for(const t of this._head.values())yield t}_insert(t,e,i,a,s,d,h){if(null==d&&null==h){const d=new r(t,e,i,a,s);return this._head=new n.List(d),this._tail=this._head,this._length++,void this._minOrderedLength++}return e!==this._tail.data.materialKey&&this._minOrderedLength++,this._materialKeys.add(e),null==d&&null!=h?this._insertAtHead(t,e,i,a,s,h):null!=d&&null==h?this._insertAtEnd(t,e,i,a,s,d):null!=d&&null!=h?this._insertAtMiddle(t,e,i,a,s,d,h):void 0}_insertAtHead(t,e,i,a,s,d){const h=a+s;if(e===d.data.materialKey&&i===d.data.target&&h===d.data.start)d.data.start=a,d.data.count+=s;else{const h=new r(t,e,i,a,s);this._head=new n.List(h),this._head.next=d,this._length++}}_insertAtEnd(t,e,i,a,s,d){if(d.data.materialKey===e&&d.data.indexEnd===a)d.data.count+=s;else{const h=new r(t,e,i,a,s);this._tail=new n.List(h),d.next=this._tail,this._length++}}_insertAtMiddle(t,e,i,a,s,d,h){const l=a+s;if(d.data.materialKey===e&&d.data.target===i&&d.data.indexEnd===a)d.data.count+=s,d.data.materialKey===h.data.materialKey&&d.data.target===h.data.target&&d.data.indexEnd===h.data.start&&(d.data.count+=h.data.count,d.next=h.next,this._length--);else if(e===h.data.materialKey&&i===h.data.target&&l===h.data.start)h.data.start=a,h.data.count+=s;else{const l=new r(t,e,i,a,s),o=new n.List(l);d.next=o,o.next=h,this._length++}}}t.DisplayList=d,t.DisplayListInfo=r,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});