// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["../../../../core/Error","../../../../core/Logger","../../../../chunks/earcut","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../layers/graphics/featureConversionUtils","../../../../layers/graphics/OptimizedGeometry","./number","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexBuffer"],function(e,t,r,n,i,o,c,s,a,f,h){"use strict";const m=(e,t,r,n)=>{let i=0;for(let n=1;n<r;n++){const r=e[2*(t+n-1)],o=e[2*(t+n-1)+1];i+=(e[2*(t+n)]-r)*(e[2*(t+n)+1]+o)}return n?i>0:i<0},u=({coords:e,lengths:t},n)=>{const i=[];for(let o=0,c=0;o<t.length;c+=t[o],o+=1){const s=c,a=[];for(;o<t.length-1&&m(e,c+t[o],t[o+1],n);o+=1,c+=t[o])a.push(c+t[o]-s);const f=e.slice(2*s,2*(c+t[o])),h=r.earcut(f,a,2);for(const e of h)i.push(e+s)}return i};class l{constructor(e,t,r,n=!1){this.vertices=e,this.indices=t,this.primitiveType=r,this.isMapSpace=n,this._cache={}}static fromPath(e){const t=o.convertFromNestedArray(new c,e.path,!1,!1),r=t.coords,n=new Uint32Array(u(t,!0)),i=new Uint32Array(r.length/2);for(let e=0;e<i.length;e++)i[e]=s.i1616to32(Math.floor(r[2*e]),Math.floor(r[2*e+1]));return new l(i,n,f.PrimitiveType.TRIANGLES)}static fromGeometry(r,n){const i=n.geometry?.type;switch(i){case"polygon":return l.fromPolygon(r,n.geometry);case"extent":return l.fromMapExtent(r,n.geometry);default:return t.getLogger("esri.views.2d.engine.webgl.Mesh2D").error(new e("mapview-bad-type",`Unable to create a mesh from type ${i}`,n)),l.fromScreenExtent({xmin:0,ymin:0,xmax:1,ymax:1})}}static fromPolygon(e,t){const r=o.convertFromPolygon(new c,t,!1,!1),a=r.coords,h=new Uint32Array(u(r,!1)),m=new Uint32Array(a.length/2),y=i.create(),x=i.create();for(let t=0;t<m.length;t++)n.set(y,a[2*t],a[2*t+1]),e.toScreen(x,y),m[t]=s.i1616to32(Math.floor(x[0]),Math.floor(x[1]));return new l(m,h,f.PrimitiveType.TRIANGLES,!0)}static fromScreenExtent({xmin:e,xmax:t,ymin:r,ymax:n}){const i=new Uint32Array([s.i1616to32(e,r),s.i1616to32(t,r),s.i1616to32(e,n),s.i1616to32(e,n),s.i1616to32(t,r),s.i1616to32(t,n)]),o=new Uint32Array([0,1,2,3,4,5]);return new l(i,o,f.PrimitiveType.TRIANGLES)}static fromMapExtent(e,t){const[r,n]=e.toScreen([0,0],[t.xmin,t.ymin]),[i,o]=e.toScreen([0,0],[t.xmax,t.ymax]),c=new Uint32Array([s.i1616to32(r,n),s.i1616to32(i,n),s.i1616to32(r,o),s.i1616to32(r,o),s.i1616to32(i,n),s.i1616to32(i,o)]),a=new Uint32Array([0,1,2,3,4,5]);return new l(c,a,f.PrimitiveType.TRIANGLES)}destroy(){null!=this._cache.indexBuffer&&this._cache.indexBuffer.dispose(),this._cache.vertexBuffer?.dispose(),this._cache.indexBuffer=this._cache.vertexBuffer=null}getIndexBuffer(e,t=35044){return this._cache.indexBuffer??=a.BufferObject.createIndex(e,t,this.indices),this._cache.indexBuffer}getVertexBuffers(e,t){return this._cache.vertexBuffer??=new h.VertexBuffer(e,t,this.vertices),this._cache.vertexBuffer}}return l});