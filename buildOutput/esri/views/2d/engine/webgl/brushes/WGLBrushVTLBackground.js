// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/factories/mat3f32","../../../../../core/libs/gl-matrix-2/factories/vec4f32","../definitions","./WGLBrush","../../../../webgl/enums","../../../../webgl/VertexArrayObject","../../../../webgl/VertexBuffer"],function(t,e,r,i,o,a,s,n,l,c){"use strict";t.WGLBrushVTLBackground=class extends s{constructor(){super(...arguments),this._color=o.fromValues(1,0,0,1),this._patternMatrix=i.create(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao=r.disposeMaybe(this._vao)}drawMany(t,r){const{context:i,painter:o,requestRender:s,allowDelayedRender:l}=t;this._loadWGLResources(t);const c=t.displayLevel,u=t.styleLayer,f=u.backgroundMaterial,d=o.vectorTilesMaterialManager,g=u.getPaintValue("background-color",c),_=u.getPaintValue("background-opacity",c),m=u.getPaintValue("background-pattern",c),p=void 0!==m,h=1|window.devicePixelRatio,x=t.spriteMosaic;let y,v;const b=h>a.vtlHighResCutoff?2:1,M=this._programOptions;M.pattern=p;const w=d.getMaterialProgram(i,f,M);if(!l||null==s||w.compiled){if(i.bindVAO(this._vao),i.useProgram(w),p){const t=x.getMosaicItemPosition(m,!0);if(null!=t){const{tl:e,br:r,page:o}=t;y=r[0]-e[0],v=r[1]-e[1];const s=x.getPageSize(o);null!=s&&(x.bind(i,9729,o,a.vtlTextureBindingUnitSprites),w.setUniform4f("u_tlbr",e[0],e[1],r[0],r[1]),w.setUniform2fv("u_mosaicSize",s),w.setUniform1i("u_texture",a.vtlTextureBindingUnitSprites))}w.setUniform1f("u_opacity",_)}else{const t=g[3]*_;this._color[0]=t*g[0],this._color[1]=t*g[1],this._color[2]=t*g[2],this._color[3]=t,w.setUniform4fv("u_color",this._color)}w.setUniform1f("u_depth",u.z||0);for(const t of r){if(w.setUniform1f("u_coord_range",t.rangeX),w.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),p){const r=Math.max(2**(Math.round(c)-t.key.level),1),i=b*t.width*r,o=i/e.nextPowerOfTwo(y),a=i/e.nextPowerOfTwo(v);this._patternMatrix[0]=o,this._patternMatrix[4]=a,w.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}i.setStencilFunction(514,0,255),i.drawArrays(n.PrimitiveType.TRIANGLE_STRIP,0,4)}}else s()}_loadWGLResources(t){if(this._vao)return;const{context:e,styleLayer:r}=t,i=r.backgroundMaterial,o=new Int8Array([0,0,1,0,0,1,1,1]),a=new c.VertexBuffer(e,i.geometryLayout,o);this._vao=new l.VertexArrayObject(e,a)}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});