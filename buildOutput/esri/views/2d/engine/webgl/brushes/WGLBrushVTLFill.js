// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../definitions","./WGLBrush","../../../../webgl/enums"],function(t,e,i,n){"use strict";const a=1/65536;t.WGLBrushVTLFill=class extends i{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(t,e){const{displayLevel:i,renderPass:n,spriteMosaic:a,styleLayerUID:l}=t;let r=!1;for(const t of e)if(t.layerData.has(l)){const e=t.layerData.get(l);if(e.fillIndexCount>0||e.outlineIndexCount>0){r=!0;break}}if(!r)return;const o=t.styleLayer,s=o.getPaintProperty("fill-pattern"),u=void 0!==s,f=u&&s.isDataDriven;let d;if(u&&!f){const t=s.getValue(i);d=a.getMosaicItemPosition(t,!0)}const c=!u&&o.getPaintValue("fill-antialias",i);let p=!0,y=1;if(!u){const t=o.getPaintProperty("fill-color"),e=o.getPaintProperty("fill-opacity");if(!t?.isDataDriven&&!e?.isDataDriven){const t=o.getPaintValue("fill-color",i);y=o.getPaintValue("fill-opacity",i)*t[3],y>=1&&(p=!1)}}if(p&&"opaque"===n)return;const g=o.getPaintValue("fill-translate",i),m=o.getPaintValue("fill-translate-anchor",i);(p||"translucent"!==n)&&this._drawFill(t,l,o,e,g,m,u,d,f);const v=!o.hasDataDrivenOutlineColor&&o.outlineUsesFillColor&&y<1;c&&"opaque"!==n&&!v&&this._drawOutline(t,l,o,e,g,m)}_drawFill(t,i,l,r,o,s,u,f,d){if(u&&!d&&null==f)return;const{context:c,displayLevel:p,state:y,painter:g,pixelRatio:m,spriteMosaic:v,requestRender:M,allowDelayedRender:_}=t,P=l.fillMaterial,T=g.vectorTilesMaterialManager,U=m>e.vtlHighResCutoff?2:1,x=this._fillProgramOptions;x.pattern=u;const D=T.getMaterialProgram(c,P,x);if(_&&null!=M&&!D.compiled)return void M();if(c.useProgram(D),null!=f){const{page:t}=f,i=v.getPageSize(t);null!=i&&(v.bind(c,9729,t,e.vtlTextureBindingUnitSprites),D.setUniform2fv("u_mosaicSize",i),D.setUniform1i("u_texture",e.vtlTextureBindingUnitSprites))}D.setUniformMatrix3fv("u_displayMat3",1===s?y.displayMat3:y.displayViewMat3),D.setUniform2fv("u_fillTranslation",o),D.setUniform1f("u_depth",l.z+a);let S=-1;for(const t of r){if(!t.layerData.has(i))continue;t.key.level!==S&&(S=t.key.level,P.setDataUniforms(D,p,l,S,v));const a=t.layerData.get(i);if(!a.fillIndexCount)continue;a.prepareForRendering(c);const r=a.fillVAO;if(null!=r){if(c.bindVAO(r),D.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),c.setStencilFunction(514,t.stencilRef,255),u){const e=Math.max(2**(Math.round(p)-t.key.level),1),i=t.rangeX/(U*t.width*e);D.setUniform1f("u_patternFactor",i)}if(d){const t=a.patternMap;if(!t)continue;for(const[i,a]of t){const t=v.getPageSize(i);null!=t&&(v.bind(c,9729,i,e.vtlTextureBindingUnitSprites),D.setUniform2fv("u_mosaicSize",t),D.setUniform1i("u_texture",e.vtlTextureBindingUnitSprites),c.drawElements(n.PrimitiveType.TRIANGLES,a[1],n.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]))}}else c.drawElements(n.PrimitiveType.TRIANGLES,a.fillIndexCount,n.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.fillIndexStart);t.triangleCount+=a.fillIndexCount/3}}}_drawOutline(t,e,i,l,r,o){const{context:s,displayLevel:u,state:f,painter:d,pixelRatio:c,spriteMosaic:p,requestRender:y,allowDelayedRender:g}=t,m=i.outlineMaterial,v=d.vectorTilesMaterialManager,M=.75/c,_=this._outlineProgramOptions,P=v.getMaterialProgram(s,m,_);if(g&&null!=y&&!P.compiled)return void y();s.useProgram(P),P.setUniformMatrix3fv("u_displayMat3",1===o?f.displayMat3:f.displayViewMat3),P.setUniform2fv("u_fillTranslation",r),P.setUniform1f("u_depth",i.z+a),P.setUniform1f("u_outline_width",M);let T=-1;for(const t of l){if(!t.layerData.has(e))continue;t.key.level!==T&&(T=t.key.level,m.setDataUniforms(P,u,i,T,p));const a=t.layerData.get(e);if(a.prepareForRendering(s),!a.outlineIndexCount)continue;const l=a.outlineVAO;null!=l&&(s.bindVAO(l),P.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),s.setStencilFunction(514,t.stencilRef,255),s.drawElements(n.PrimitiveType.TRIANGLES,a.outlineIndexCount,n.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.outlineIndexStart),t.triangleCount+=a.outlineIndexCount/3)}}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});