// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/libs/gl-matrix-2/factories/vec2f32","../../vectorTiles/decluttering/config","../definitions","../GeometryUtils","./WGLBrush","../../../../webgl/enums"],function(e,t,i,a,n,r,s){"use strict";const o=1/65536;e.WGLBrushVTLSymbol=class extends r{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=t.create()}dispose(){}drawMany(e,t){const i=e.styleLayer;this._drawIcons(e,i,t),this._drawText(e,i,t)}_drawIcons(e,t,r){const{context:s,displayLevel:o,painter:l,spriteMosaic:u,state:f,styleLayerUID:c,requestRender:p,allowDelayedRender:d}=e,y=t.iconMaterial,g=l.vectorTilesMaterialManager;let m,_=!1;for(const e of r)if(e.layerData.has(c)&&(m=e.layerData.get(c),m.iconPerPageElementsMap.size>0)){_=!0;break}if(!_)return;const h=t.getPaintValue("icon-translate",o),M=t.getPaintValue("icon-translate-anchor",o);let U=t.getLayoutValue("icon-rotation-alignment",o);2===U&&(U=0===t.getLayoutValue("symbol-placement",o)?1:0);const T=0===U,x=t.getLayoutValue("icon-keep-upright",o)&&T,v=m.isIconSDF,P=this._iconProgramOptions;P.sdf=v;const S=g.getMaterialProgram(s,y,P);if(d&&null!=p&&!S.compiled)return void p();s.useProgram(S),S.setUniformMatrix3fv("u_displayViewMat3",0===U?f.displayViewMat3:f.displayMat3),S.setUniformMatrix3fv("u_displayMat3",1===M?f.displayMat3:f.displayViewMat3),S.setUniform2fv("u_iconTranslation",h),S.setUniform1f("u_depth",t.z),S.setUniform1f("u_mapRotation",n.degToByte(f.rotation)),S.setUniform1f("u_keepUpright",x?1:0),S.setUniform1f("u_level",10*o),S.setUniform1i("u_texture",a.vtlTextureBindingUnitSprites),S.setUniform1f("u_fadeDuration",i.fadeDuration/1e3);let D=-1;for(const i of r){if(!i.layerData.has(c))continue;if(i.key.level!==D&&(D=i.key.level,y.setDataUniforms(S,o,t,D,u)),m=i.layerData.get(c),0===m.iconPerPageElementsMap.size)continue;m.prepareForRendering(s),m.updateOpacityInfo();const a=m.iconVAO;if(null!=a){s.bindVAO(a),S.setUniformMatrix3fv("u_dvsMat3",i.transforms.displayViewScreenMat3),S.setUniform1f("u_time",(performance.now()-m.lastOpacityUpdate)/1e3);for(const[t,a]of m.iconPerPageElementsMap)this._renderIconRange(e,S,a,t,i)}}}_renderIconRange(e,t,i,n,r){const{context:o,spriteMosaic:l}=e;this._spritesTextureSize[0]=l.getWidth(n)/4,this._spritesTextureSize[1]=l.getHeight(n)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),l.bind(o,9729,n,a.vtlTextureBindingUnitSprites),this._setStencilState(e,r),o.drawElements(s.PrimitiveType.TRIANGLES,i[1],s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]),r.triangleCount+=i[1]/3}_drawText(e,r,s){const{context:l,displayLevel:u,glyphMosaic:f,painter:c,pixelRatio:p,spriteMosaic:d,state:y,styleLayerUID:g,requestRender:m,allowDelayedRender:_}=e,h=r.textMaterial,M=c.vectorTilesMaterialManager;let U,T=!1;for(const e of s)if(e.layerData.has(g)&&(U=e.layerData.get(g),U.glyphPerPageElementsMap.size>0)){T=!0;break}if(!T)return;const x=r.getPaintProperty("text-opacity");if(x&&!x.isDataDriven&&0===x.getValue(u))return;const v=r.getPaintProperty("text-color"),P=!v||v.isDataDriven||v.getValue(u)[3]>0,S=r.getPaintProperty("text-halo-width"),D=r.getPaintProperty("text-halo-color"),E=(!S||S.isDataDriven||S.getValue(u)>0)&&(!D||D.isDataDriven||D.getValue(u)[3]>0);if(!P&&!E)return;let V=r.getLayoutValue("text-rotation-alignment",u);2===V&&(V=0===r.getLayoutValue("symbol-placement",u)?1:0);const w=0===V,R=r.getLayoutValue("text-keep-upright",u)&&w,L=.8*3/p;this._glyphTextureSize||(this._glyphTextureSize=t.fromValues(f.width/4,f.height/4));const I=r.getPaintValue("text-translate",u),b=r.getPaintValue("text-translate-anchor",u),z=this._sdfProgramOptions,N=M.getMaterialProgram(l,h,z);if(_&&null!=m&&!N.compiled)return void m();l.useProgram(N),N.setUniformMatrix3fv("u_displayViewMat3",0===V?y.displayViewMat3:y.displayMat3),N.setUniformMatrix3fv("u_displayMat3",1===b?y.displayMat3:y.displayViewMat3),N.setUniform2fv("u_textTranslation",I),N.setUniform1f("u_depth",r.z+o),N.setUniform2fv("u_mosaicSize",this._glyphTextureSize),N.setUniform1f("u_mapRotation",n.degToByte(y.rotation)),N.setUniform1f("u_keepUpright",R?1:0),N.setUniform1f("u_level",10*u),N.setUniform1i("u_texture",a.vtlTextureBindingUnitGlyphs),N.setUniform1f("u_antialiasingWidth",L),N.setUniform1f("u_fadeDuration",i.fadeDuration/1e3);let G=-1;for(const t of s){if(!t.layerData.has(g))continue;if(t.key.level!==G&&(G=t.key.level,h.setDataUniforms(N,u,r,G,d)),U=t.layerData.get(g),0===U.glyphPerPageElementsMap.size)continue;U.prepareForRendering(l),U.updateOpacityInfo();const i=U.textVAO;if(null==i)continue;l.bindVAO(i),N.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),this._setStencilState(e,t);const a=(performance.now()-U.lastOpacityUpdate)/1e3;N.setUniform1f("u_time",a),U.glyphPerPageElementsMap.forEach((e,i)=>{this._renderGlyphRange(l,e,i,f,N,E,P,t)})}}_renderGlyphRange(e,t,i,n,r,o,l,u){n.bind(e,9729,i,a.vtlTextureBindingUnitGlyphs),o&&(r.setUniform1f("u_halo",1),e.drawElements(s.PrimitiveType.TRIANGLES,t[1],s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),u.triangleCount+=t[1]/3),l&&(r.setUniform1f("u_halo",0),e.drawElements(s.PrimitiveType.TRIANGLES,t[1],s.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),u.triangleCount+=t[1]/3)}_setStencilState(e,t){const{context:i,is3D:a,stencilSymbols:n}=e;if(i.setStencilTestEnabled(!0),n)return i.setStencilWriteMask(255),void i.setStencilFunction(519,t.stencilRef,255);i.setStencilWriteMask(0),a?i.setStencilFunction(514,t.stencilRef,255):i.setStencilFunction(516,255,255)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});