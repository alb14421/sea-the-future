// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../Technique","../shaders/raster/RasterColorizerLUTShader","../shaders/raster/RasterColorizerShadedReliefShader","../shaders/raster/RasterColorizerStretchShader"],function(e,i,t,o,r){"use strict";class n extends i.Technique{constructor(){super(...arguments),this.name="BrushRasterColorizer",this.type=0,this.shaders={lut:new t.RasterColorizerLUTShader,stretch:new r.RasterColorizerStretchShader,shadedRelief:new o.RasterColorizerShadedReliefShader}}render(e,i){for(const t of i.bitmaps){if(!t.source||t.suspended)continue;e.timeline.begin(this.name);const{painter:i}=e;i.setPipelineState({depth:!1,stencil:{test:{mask:255,ref:t.stencilRef,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:"composite"}}),t.updateTexture(e),t.processedTexture||t.updateProcessedTexture();const{type:o}=t.symbolizerParameters,r="stretch"===o?this._getStretchOptions(t):"lut"===o?this._getLutOptions(t):this._getShadedReliefOptions(t);"bilinear"!==t.interpolation||e.context.capabilities.textureFloatLinear||(r.defines.bilinear=!0);const{pixelHighlightOptions:n}=e;if(n&&!t.isRendereredSource){const e=t.bandIds?.length?t.bandIds.indexOf(n.bandId):0;if(e>=0&&e<=2){r.defines.applyPixelHighlights=!0;const i=new Float32Array(9);i[3*e]=1,r.uniforms.highlightConfig={...n,bandSwap:i}}}i.submitDrawMesh(e.context,r,i.quadMesh),e.timeline.end(this.name)}}_getLutOptions(e){const{config:i,projectionConfig:t,colormapConfig:o,pixelMaskConfig:r,projectionDefines:n}=this._getCommonConfig(e),s=this._getInterpolationDefines("nearest",!1);return{shader:this.shaders.lut,uniforms:{projectionConfig:t,config:i,colormapConfig:o,pixelMaskConfig:r},defines:{...n,...s,applyPixelMask:!!r,applyPixelHighlights:!1},optionalAttributes:null,useComputeBuffer:!1}}_getStretchOptions(e){const i=e.symbolizerParameters,{config:t,projectionConfig:o,colormapConfig:r,pixelMaskConfig:n,projectionDefines:s}=this._getCommonConfig(e),a=this._getInterpolationDefines(e.interpolation,1===i.bandCount);return{shader:this.shaders.stretch,uniforms:{projectionConfig:o,config:t,stretchConfig:i,colormapConfig:r,pixelMaskConfig:n},defines:{...s,...a,isMultiband:i.bandCount>1,applyColormap:!!r,useGamma:i.useGamma,noOp:e.isRendereredSource&&!e.processed,applyPixelMask:!!n,applyPixelHighlights:!1},optionalAttributes:null,useComputeBuffer:!1}}_getShadedReliefOptions(e){const i=e.symbolizerParameters,{config:t,projectionConfig:o,colormapConfig:r,pixelMaskConfig:n,projectionDefines:s}=this._getCommonConfig(e),a=this._getInterpolationDefines(e.interpolation,!0);return{shader:this.shaders.shadedRelief,uniforms:{projectionConfig:o,config:t,hillshadeConfig:i,colormapConfig:r,pixelMaskConfig:n},defines:{...s,...a,isMultidirectional:i.hillshadeType>0,applyColormap:!!r,applyPixelMask:!!n,applyPixelHighlights:!1},optionalAttributes:null,useComputeBuffer:!1}}_getCommonConfig(e){const{coordScale:i,computedOpacity:t,transforms:o}=e,{names:r,textures:n}=e.getTextures({useProcessedTexture:e.processed}),s=n[r.indexOf("u_image")],a=e.getRasterTextureSize(),l={texture:{texture:s,unit:0},dvsMat3:o.displayViewScreenMat3,coordScale:i,srcImageSize:a,opacity:t},p=n[r.indexOf("u_transformGrid")],{transformGrid:c}=e,f=!(!p||!c),d=f?{transformTexture:{texture:p,unit:2},targetImageSize:[e.width,e.height],transformSpacing:c.spacing,transformGridSize:c.size}:void 0,u=n[r.indexOf("u_colormap")],{colormap:g,colormapOffset:h}=e.symbolizerParameters,m=u&&g?{colormapTexture:{texture:u,unit:1},colormapOffset:h??0,colormapMaxIndex:g.length/4-1}:void 0,C=n[r.indexOf("u_mask")];return{config:l,projectionConfig:d,colormapConfig:m,pixelMaskConfig:C?{maskTexture:{texture:C,unit:3}}:void 0,projectionDefines:{applyProjection:f,lookupProjection:f&&1===c.spacing[0]}}}_getInterpolationDefines(e,i){const t="bilinear"===e&&i;return{bilinear:t,bicubic:"cubic"===e,nearestOnEdge:t}}}e.RasterColorizerTechnique=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});