// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../../core/screenUtils","../../../../../../../geometry/GeometryCursor","../../../../../../../symbols/cim/constants","../../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper","../../../definitions","./AnimatedMeshWriter","./attributes","./ComputedAnimatedParams","../shaders/constants"],function(e,t,i,r,s,n,a,o,l,c){"use strict";class d extends a.AAnimatedMeshWriter{get vertexSpec(){return{createComputedParams:l.createComputedAnimatedMeshParams,optionalAttributes:{zoomRange:o.zoomRange,value1Position2Value2:o.value1Position2Value2,lineLength:o.lineLength},attributes:{id:o.id,bitset:o.bitset,pos:o.pos,offset:o.offset.marker,uv:o.uv.marker,animationPointerAndBaseSizeAndReferenceSize:o.animationPointerAndBaseSizeAndReferenceSize,sizing:o.sizing,angle:o.angle}}}_write(e,t){const i=this.evaluatedMeshParams.sprite,{textureBinding:r}=i;e.recordStart(this.instanceId,this.attributeLayout,r);const s=t.getDisplayId();if(this.shift&&"esriGeometryPolyline"===t.geometryType)this._writeParticles(e,t);else if(null!=this.evaluatedMeshParams.placement)this._writePlacedMarkers(e,t);else if("esriGeometryPolygon"===t.geometryType){const i=t.readCentroidForDisplay();if(!i)return;const[r,n]=i.coords;this._writeQuad(e,s,r,n)}else if("esriGeometryPoint"===t.geometryType){const i=t.readXForDisplay(),r=t.readYForDisplay();this._writeQuad(e,s,i,r)}else{const i=t.readGeometryForDisplay();i&&i.forEachVertex((t,i)=>{this._writeQuad(e,s,t,i)})}e.recordEnd()}_writePlacedMarkers(e,n){const a=i.GeometryCursor.fromFeatureSetReaderCIM(n)?.clone();if(!a)return;const o=s.CIMMarkerPlacementHelper.getPlacement(a,-1,this.evaluatedMeshParams.placement,t.pt2px(1),e.id);if(!o)return;const l=n.getDisplayId();let c=o.next(),d=null;for(;null!=c;){const t=c.tx,i=-c.ty;if(Math.abs(t)>r.maxTileCoordValue||Math.abs(i)>r.maxTileCoordValue){c=o.next();continue}const s=-c.getAngle();e.recordBounds(t,i,64,64),this.shift?d&&this._writeQuad(e,l,d[0],d[1],void 0,s):this._writeQuad(e,l,t,i,void 0,s),d=[t,i],c=o.next()}}_writeParticles(e,t){const i=t.getDisplayId(),r=t.readGeometryForDisplay();if(!r)return;const s=[];r.forEachVertex((e,t)=>{s.push([e,t])});const n=function(e){const t=[];let i=0;for(let r=1;r<e.length;r++){const s=e[r-1],n=e[r],a=n[0]-s[0],o=n[1]-s[1],l=Math.sqrt(a*a+o*o),c=a/l,d=o/l;t.push({a:{position:s,distance:i,direction:[c,d]},b:{position:n,distance:i+l,direction:[c,d]}}),i+=l}return t}(s);let a=0;for(let e=1;e<s.length;e++){const t=s[e][0]-s[e-1][0],i=s[e][1]-s[e-1][1],r=Math.sqrt(t*t+i*i);a+=r}const o=t=>{for(const r of n){const{a:s,b:n}=r;this._writeQuad(e,i,s.position[0],s.position[1],[s.distance-t,n.position[0],n.position[1],n.distance-t],this.evaluatedMeshParams.angleToLine?Math.atan2(s.direction[1],s.direction[0]):0,a,!0)}},{placement:l}=this.evaluatedMeshParams;if(!l||"placementTemplate"in l||"CIMMarkerPlacementOnVertices"===l.type){let e;if(l&&"CIMMarkerPlacementOnVertices"!==l.type)e=l.placementTemplate;else{e=[0];for(const t of n){const{a:i,b:r}=t,s=i.position[0]-r.position[0],n=i.position[1]-r.position[1],a=Math.sqrt(s*s+n*n);e.push(a)}}let t=-1*a;for(;t<2*a;)for(const i of e)t+=i,o(t)}else"CIMMarkerPlacementAtExtremities"===l.type?"JustBegin"===l.extremityPlacement?o(1):"JustEnd"===l.extremityPlacement?(o(a-1),o(-1)):"Both"===l.extremityPlacement&&(o(1),o(a-1)):"CIMMarkerPlacementOnLine"===l.type&&o(a/2)}_writeQuad(e,t,i,r,s,a=0,o=0,l=!1){const d=this.evaluatedMeshParams.sprite,{rect:m}=d,u=m.x+n.spritePadding,h=m.y+n.spritePadding,p=m.x+m.width-n.spritePadding,f=m.y+m.height-n.spritePadding,y=e.vertexCount();l||e.recordBounds(i,r,64,64);const x={texXmin:u,texYmin:h,texXmax:p,texYmax:f,value1Position2Value2:s,angle:a/c.c256ToRad,lineLength:o};for(let s=0;s<4;s++)this._writeVertex(e,t,i,r,x);e.indexEnsureSize(6),e.indexWrite(y),e.indexWrite(y+1),e.indexWrite(y+2),e.indexWrite(y+1),e.indexWrite(y+3),e.indexWrite(y+2)}}e.AnimatedMarkerMeshWriter=class extends d{constructor(){super(...arguments),this.shift=!1}},e.AnimatedMarkerShiftMeshWriter=class extends d{constructor(){super(...arguments),this.shift=!0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});