// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../../core/screenUtils","../../../../../../../geometry/GeometryCursor","../../../definitions","../../../TurboLine","../../../mesh/templates/templateUtils","../fill/meshWriterUtils","../mesh/MeshWriter","../mesh/utils","../../../../../../webgl/enums"],function(t,e,s,i,r,n,a,o,c,h){"use strict";class l{constructor(){this.extrusionOffsetX=0,this.extrusionOffsetY=0,this.normalX=0,this.normalY=0,this.directionX=0,this.directionY=0,this.distance=0,this.pathLength=0,this.distanceOffset=0,this.lineLength=0}}const p={createComputedParams:t=>t,optionalAttributes:{zoomRange:{type:h.DataType.SHORT,count:2,packPrecisionFactor:i.minMaxZoomPrecisionFactor,pack:({scaleInfo:t},{tileInfo:e})=>a.getMinMaxZoom(t,e)}},attributes:{id:{type:h.DataType.UNSIGNED_BYTE,count:3,pack:"id"},pos:{type:h.DataType.SHORT,count:2,pack:"position",packPrecisionFactor:10},bitset:{type:h.DataType.UNSIGNED_BYTE,count:1},color:{type:h.DataType.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>a.processColorInput(t)},offset:{type:h.DataType.BYTE,count:2,packPrecisionFactor:16,packTessellation:({extrusionOffsetX:t,extrusionOffsetY:e})=>[a.packRounded(t,16),a.packRounded(e,16)]},normal:{type:h.DataType.BYTE,count:2,packPrecisionFactor:16,packTessellation:({normalX:t,normalY:e})=>[a.packRounded(t,16),a.packRounded(e,16)]},halfWidth:{type:h.DataType.HALF_FLOAT,count:1,pack:({width:t})=>e.pt2px(.5*t)},referenceHalfWidth:{type:h.DataType.HALF_FLOAT,count:1,pack:({referenceWidth:t})=>e.pt2px(.5*t)}}};class u{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0,this.pathLength=0,this.distanceOffset=0}}const d=65535;class m extends o.MeshWriter{constructor(t,e,s,i){super(t,e,s,i),this.vertexSpec=p,this._currentWrite=new u,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:d,textured:!1},this._tessParams=new l,this._initializeTessellator()}writeLineVertices(t,e,s){const i=this._getLines(e);null!=i&&this._writeVertices(t,s,i)}_initializeTessellator(){this._lineTessellator=new r.LineTessellation(this._writeTesselatedVertex.bind(this),this._writeTriangle.bind(this),!0)}_write(t,e,i){const r=i??s.GeometryCursor.fromFeatureSetReaderCIM(e);r&&this._writeGeometry(t,e,r)}_writeGeometry(t,e,s,i){t.recordStart(this.instanceId,this.attributeLayout,i),this.writeLineVertices(t,s,e),t.recordEnd()}_getLines(t){return n.clipLinesMarshall(t,c.getLineClippingMargin(this.evaluatedMeshParams))}_writeVertices(t,s,r){const{_currentWrite:n,_tessellationOptions:o,evaluatedMeshParams:c}=this,{width:h,capType:l,joinType:p,miterLimit:u,hasSizeVV:m}=c,f=e.pt2px(.5*h);o.halfWidth=f,o.capType=a.processLineCapInput(l),o.joinType=a.processLineJoinInput(p),o.miterLimit=u;const _=!m;n.out=t,n.id=s.getDisplayId(),n.vertexCount=0,n.indexCount=0,n.vertexFrom=t.vertexCount(),n.vertexBounds=_&&f<i.thinLineHalfWidthThreshold?0:1;for(const{line:t,start:e,pathLength:s}of r)o.initialDistance=e%d,n.pathLength=s,n.distanceOffset=Math.floor(e/d)*d,this._lineTessellator.tessellate(t,o,_)}_writeTesselatedVertex(t,e,s,i,r,n,a,o,c,h,l){const{out:p,id:u,vertexBounds:d,pathLength:m,distanceOffset:f}=this._currentWrite;return this.hasEffects&&p.recordBounds(t,e,d,d),this._tessParams.extrusionOffsetX=a,this._tessParams.extrusionOffsetY=o,this._tessParams.normalX=c,this._tessParams.normalY=h,this._tessParams.directionX=r,this._tessParams.directionY=n,this._tessParams.distance=l,this._tessParams.pathLength=m,this._tessParams.distanceOffset=f,this._writeVertex(p,u,t,e,this._tessParams),this._currentWrite.vertexFrom+this._currentWrite.vertexCount++}_writeTriangle(t,e,s){const{out:i}=this._currentWrite;i.indexEnsureSize(3),i.indexWrite(t),i.indexWrite(e),i.indexWrite(s),this._currentWrite.indexCount+=3}}t.LineMeshWriter=m,t.LineTessellationParams=l,t.LineVertexSpec=p,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});