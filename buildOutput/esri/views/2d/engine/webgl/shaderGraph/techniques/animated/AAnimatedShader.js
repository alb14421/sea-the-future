// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../../chunks/tslib.es6","../../../../../../../symbols/cim/animationDebugFlags","../../../animations/instructions","../../GraphShaderModule","../../graph/glsl","./AnimationUniformInfo","../markers/markerConstants","../shaders/AFeatureShader","../shaders/constants","../shaders/LocalTileOffset","../shaders/MosaicInfo","../shaders/utils","../shaders/VisualVariableColor","../shaders/VisualVariableOpacity","../shaders/VisualVariableRotation","../shaders/VisualVariableSizeMinMaxValue","../shaders/VisualVariableSizeScaleStops","../shaders/VisualVariableSizeStops","../shaders/VisualVariableSizeUnitValue","../shaders/vvUtils"],function(t,e,i,a,o,l,n,s,r,u,c,p,d,m,y,V,b,S,g,_,v){"use strict";class f extends r.FeatureVertexInput{}e.__decorate([o.location(3,l.Vec2)],f.prototype,"offset",void 0),e.__decorate([o.location(4,l.Vec4)],f.prototype,"sizing",void 0),e.__decorate([o.location(5,l.Vec4)],f.prototype,"value1Position2Value2",void 0),e.__decorate([o.location(6,l.Vec4)],f.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),e.__decorate([o.location(7,l.Vec2)],f.prototype,"zoomRange",void 0),e.__decorate([o.location(8,l.Float)],f.prototype,"lineLength",void 0);class h extends r.FeatureFragmentInput{}class w extends r.AFeatureShader{_vertexPreamble(t,e,i){const{id:a,offset:o,animationPointerAndBaseSizeAndReferenceSize:n,sizing:r}=t,c=n.xy,p=n.z,m=n.w,y=r.xy,V=this._getEvalParams(t,y,i);let b,S;if(t.value1Position2Value2){const e=F(c,6,V).a,i=t.pos,a=t.value1Position2Value2.yz,o=t.value1Position2Value2.x,n=t.value1Position2Value2.w,s=e.subtract(o).divide(n.subtract(o));S=i.add(a.subtract(i).multiply(s)),b=l.step(new l.Float(1),s).add(l.step(new l.Float(0),l.negate(s)))}else S=t.pos,b=new l.Float(0);const g=r.z,_=d.getBit(t.bitset,s.MarkerConstants.bitset.isStroke),f=r.w,h=d.getBit(t.bitset,s.MarkerConstants.bitset.scaleSymbolsProportionally),w=F(c,0,V),x=l.cond([l.equal(d.getBit(t.bitset,s.MarkerConstants.bitset.isMapAligned),new l.Float(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new l.Float(0)]),z=new l.Mat2(l.cos(x),l.sin(x.multiply(-1)),l.sin(x),l.cos(x)).multiply(w.xy),P=w.z.subtract(x).subtract(e.multiply(u.c256ToRad)),T=w.w,M=d.getBit(t.bitset,s.MarkerConstants.bitset.isSDF),I=v.getVisualVariableSize(this,a,new l.Float(m)).divide(new l.Float(m));return{baseSize:p,animationPointer:c,strokeWidth:g,isOutline:_,unscaledDistanceToPx:f,scaleSymbolsProportionally:h,isSDF:M,position:this._getScreenPosition({id:a,pos:S,offset:o,referenceSize:m,translation:z,rotation:P,scale:T,vvScale:I}),evalParams:V,vvScale:I,scale:T,clip:b}}_getScreenPosition(t){const{pos:e,translation:i,rotation:a,scale:o,offset:n,id:s,vvScale:r}=t,u=v.getVisualVariableAngle(this,s).multiply(Math.PI/180),c=i.x.multiply(4/3),p=i.y.multiply(-1).multiply(4/3),d=l.sin(u),m=l.cos(u),y=m.multiply(c).add(l.negate(d).multiply(p)),V=d.multiply(c).add(m.multiply(p)),b=l.sin(a.subtract(u)),S=l.cos(a.subtract(u)),g=new l.Float(0),_=new l.Float(1),{pixelRatio:f}=this.animationInfo,h=new l.Mat3(_,g,g,g,_,g,y.multiply(f),V.multiply(f),_),w=new l.Mat3(S,b.multiply(-1),g,b,S,g,0,0,_),F=o.multiply(r).multiply(f).multiply(4/3),x=w.multiply(F),z=this.animationInfo.toScreen.multiply(new l.Vec3(e,1)),P=h.multiply(z).xy,T=x.multiply(new l.Vec3(n,0)).xy;return P.add(T)}_clip(t,e){let a=super.clip(t,e);const o=l.lessThanEqual(this._getLocalTimeOrigin(t),new l.Float(0));return i.animationDebugFlags.forceGlobalTimeOrigin||(a=a.add(l.cond([o,()=>new l.Float(2)],[!0,()=>new l.Float(0)]))),a}_getLocalTimeOrigin(t){return this.storage.getLocalTimeOrigin(t)}_toNdc(t){return this.animationInfo.toNdc.multiply(new l.Vec3(t,1)).xy}_getEvalParams(t,e,i){const{globalTime:a,animationTextureSize:o,animationTexture:l}=this.animationInfo;return{globalTime:a,localTimeOrigin:this._getLocalTimeOrigin(t.id),animationTextureSize:o,animationTexture:l,pixelDimensions:e,lineLength:i}}_getColor(t,e){return l.ifElse(l.equal(e.isSDF,new l.Float(1)),this._getSDFColor(t,e),this._getSpriteColor(t,e))}_getSpriteColor(t,e){return l.texture2D(this.mosaicInfo.texture,t).multiply(e.color)}_getSDFColor(t,e){const i=l.texture2D(this.mosaicInfo.texture,t),a=new l.Float(.5).subtract(d.rgba2float(i)).multiply(e.distanceToPx).multiply(u.softEdgeRatio),o=l.clamp(new l.Float(.5).subtract(a),new l.Float(0),new l.Float(1)),n=e.color.multiply(o),s=e.outlineSize.multiply(.5),r=l.abs(a).subtract(s),c=l.clamp(new l.Float(.5).subtract(r),new l.Float(0),new l.Float(1)),p=e.outlineColor.multiply(c);return new l.Float(1).subtract(p.a).multiply(n).add(p)}}function F(t,e,i){const o=t.add(new l.Vec2(e,0)),n=l.texture2D(i.animationTexture,o.add(.5).divide(i.animationTextureSize)).xy;return t=t.add(n),l.block({animationPointer:t,...i},l.Vec4,null,t=>{const{out:e}=t;if(!e)throw new Error("out is null");return a.generateVirtualMachineSource({...t,out:e})})}e.__decorate([o.uniform(p.MosaicInfo)],w.prototype,"mosaicInfo",void 0),e.__decorate([o.uniform(n.AnimationUniformInfo)],w.prototype,"animationInfo",void 0),e.__decorate([o.uniform(c.LocalTileOffset)],w.prototype,"localTileOffset",void 0),e.__decorate([o.option(m.VisualVariableColor)],w.prototype,"visualVariableColor",void 0),e.__decorate([o.option(y.VisualVariableOpacity)],w.prototype,"visualVariableOpacity",void 0),e.__decorate([o.option(b.VisualVariableSizeMinMaxValue)],w.prototype,"visualVariableSizeMinMaxValue",void 0),e.__decorate([o.option(S.VisualVariableSizeScaleStops)],w.prototype,"visualVariableSizeScaleStops",void 0),e.__decorate([o.option(g.VisualVariableSizeStops)],w.prototype,"visualVariableSizeStops",void 0),e.__decorate([o.option(_.VisualVariableSizeUnitValue)],w.prototype,"visualVariableSizeUnitValue",void 0),e.__decorate([o.option(V.VisualVariableRotation)],w.prototype,"visualVariableRotation",void 0),t.AAnimatedFragmentInput=h,t.AAnimatedShader=w,t.AAnimatedVertexInput=f,t.getValue=F,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});