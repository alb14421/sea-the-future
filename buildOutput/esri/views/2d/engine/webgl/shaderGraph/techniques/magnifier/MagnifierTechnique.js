// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../../core/mathUtils","../../../../../../../core/maybe","../../../../../../../core/urlUtils","../../utils","../Technique","../shaders/MagnifierShader","../../../../../../webgl/Texture","../../../../../../webgl/TextureDescriptor"],function(e,t,i,s,r,o,a,u,n){"use strict";class l extends o.Technique{constructor(){super(...arguments),this.type=16,this._resourcePixelRatio=1,this._position=[0,0,0,0],this.shaders={magnifier:new a.MagnifierShader}}updateResources(e,i,s,r){e.pixelRatio!==this._resourcePixelRatio&&this._destroyResources(),this._readbackTexture||this._initializeResources(e,i,s,r);const{context:o,pixelRatio:a}=e,{factor:u,offset:n,position:l}=r,{size:c}=e.state,h=r.size*a,p=1/u,x=Math.ceil(p*h);this._readbackTexture.resize(x,x);const d=a*c[0],T=a*c[1],_=.5*x,m=.5*x,b=t.clamp(a*l.x,_,d-_-1),f=t.clamp(T-a*l.y,m,T-m-1),y=b-_,g=f-m,M=this._readbackTexture;o.bindTexture(M,0),o.gl.copyTexImage2D(M.descriptor.target,0,M.descriptor.pixelFormat,y,g,x,x,0);const k=(b+n.x*a)/d*2-1,w=(f-n.y*a)/T*2-1,R=h/d*2,v=h/T*2;this._position[0]=k,this._position[1]=w,this._position[2]=R,this._position[3]=v}render(e,t){const{context:i,painter:s}=e;s.setPipelineState(r.simplePipelineState);const o={readbackTexture:{texture:this._readbackTexture,unit:0},maskTexture:{texture:this._maskTexture,unit:7},overlayTexture:{texture:this._overlayTexture,unit:6},drawPos:this._position,...t};s.submitDrawMesh(i,{shader:this.shaders.magnifier,uniforms:{config:o},defines:null,optionalAttributes:null,useComputeBuffer:!1},s.quadMesh)}shutdown(){this._destroyResources()}_initializeResources(e,t,i,r){const o=e.context;this._resourcePixelRatio=e.pixelRatio;const a=Math.ceil(r.size*e.pixelRatio);i.width=a,i.height=a;const l=new n.TextureDescriptor(Math.ceil(a/r.factor));l.internalFormat=6408,l.wrapMode=33071,l.samplingMode=9728,l.flipped=!0,l.preMultiplyAlpha=!s.isSVG(i.src)||!e.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new u.Texture(o,l,i),t.width=a,t.height=a,l.pixelFormat=l.internalFormat=6406,this._maskTexture=new u.Texture(o,l,t),l.pixelFormat=l.internalFormat=6408,l.samplingMode=9729,l.flipped=!1,this._readbackTexture=new u.Texture(o,l)}_destroyResources(){i.disposeMaybe(this._maskTexture),i.disposeMaybe(this._overlayTexture),i.disposeMaybe(this._readbackTexture),this._maskTexture=null,this._overlayTexture=null,this._readbackTexture=null}}e.MagnifierTechnique=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});