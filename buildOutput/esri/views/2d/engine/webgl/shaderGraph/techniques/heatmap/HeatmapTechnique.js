// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../FeatureTechnique","../featureTechniqueUtils","./HeatmapResources","../shaders/HeatmapAccumulateShader","../shaders/HeatmapResolveShader"],function(e,t,s,r,i,n){"use strict";class u extends t.FeatureTechnique{constructor(){super(...arguments),this.type=13,this.drawPhase=73,this.shaders={accumulate:new i.HeatmapAccumulateShader,resolve:new n.HeatmapResolveShader},this._isBound=!1,this._resources=new Map}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:r,painter:i,state:n}=e,u=t.instance.getInput(),{isFieldActive:o}=u.uniforms,l=this._getOrCreateResourcesRecord(r),h=l.loadQualityProfile(r);s.isHittest(e)||this._bind(e,l,u),i.setShader({shader:this.shaders.accumulate,uniforms:{...s.getFeatureUniforms(e,t.target),kernelControls:{radius:d(u,n),isFieldActive:o?1:0}},defines:{...s.getSelectionDefines(e),...h.defines},optionalAttributes:{},useComputeBuffer:s.isHittest(e)});const p=s.isHittest(e)?c:a;i.setPipelineState(p),i.submitDraw(e,t)}getStencilReference(e){return o(e)}renderResolvePass(e,t){if(s.isHittest(e))return;const{context:r,painter:i}=e,n=this._resources.get(r);if(null==this._prevFBO||null==this._prevViewport||!n?.initialized)return;const{defines:u}=n.loadQualityProfile(r),{minDensity:o,maxDensity:a,radius:c}=t.getInput().uniforms,d=n.accumulateFramebuffer,h=n.resolveGradientTexture,p={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:8,texture:d.colorTexture},minAndInvRange:[o,1/(a-o)],normalization:3/(c*c*Math.PI)},gradient:{texture:{unit:9,texture:h}}},defines:u,optionalAttributes:{},useComputeBuffer:!1};r.bindFramebuffer(this._prevFBO),r.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),r.bindTexture(d.colorTexture,8),r.bindTexture(h,9),i.setPipelineState(l),i.submitDrawMesh(r,p,i.quadMesh),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new r.HeatmapResources,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,s){if(this._isBound)return;const{context:r,state:i,pixelRatio:n}=e,u=r.getBoundFramebufferObject(),o=r.getViewport();this._prevFBO=u,this._prevViewport=o;const{gradient:a,gradientHash:c}=s.uniforms;t.ensureResolveGradientTexture(r,c,a);const{width:l,height:h}=o,p=function(e,t){const s=t>1.5?.25:.5;return e<1/(2*s)?1:s}(d(s,i),n),f=l*p,m=h*p,_=t.ensureAccumulateFBO(r,f,m);r.blitFramebuffer(u,_,1024),r.bindFramebuffer(_),r.setViewport(0,0,_.width,_.height),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear(16384),this._isBound=!0}}function o(e){return e.key.level+1}const a={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:o,compare:518,mask:255,op:{fail:7680,zFail:7680,zPass:7681}}}},c={...a,stencil:!1},l={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function d(e,t){const{referenceScale:s,radius:r}=e.uniforms;return r*(0!==s?s/t.scale:1)}e.HeatmapTechnique=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});