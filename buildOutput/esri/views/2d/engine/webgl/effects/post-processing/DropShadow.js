// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/maybe","../../../../../../core/screenUtils","../../VertexStream","../../../../../webgl/FramebufferObject","../../../../../webgl/Texture","../../../../../webgl/TextureDescriptor"],function(e,t,r,s,i,o,a){"use strict";const n=[1,0],l=[0,1];e.DropShadow=class{constructor(){this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",locations:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",locations:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",locations:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture=t.disposeMaybe(this._layerFBOTexture),this._horizontalBlurFBO=t.disposeMaybe(this._horizontalBlurFBO),this._verticalBlurFBO=t.disposeMaybe(this._verticalBlurFBO)}draw(e,t,i){const{context:o,state:a,painter:u}=e,{materialManager:c}=u,h=this._programDesc,p=t.width,d=t.height,_=[Math.round(p),Math.round(d)],{blurRadius:f,offsetX:B,offsetY:b,color:m}=i,x=[r.pt2px(B),r.pt2px(b)];this._createOrResizeResources(e,p,d,_);const F=this._horizontalBlurFBO,O=this._verticalBlurFBO;o.setStencilWriteMask(0),o.setStencilTestEnabled(!1),o.setDepthWriteEnabled(!1),o.setDepthTestEnabled(!1);const T=this._layerFBOTexture;t.copyToTexture(0,0,p,d,0,0,T),this._quad||(this._quad=new s(o,[-1,-1,1,-1,-1,1,1,1])),o.setViewport(0,0,_[0],_[1]);const w=this._quad;w.bind(),o.setBlendingEnabled(!1);const g=c.getProgram(h.blur,[{name:"radius",value:Math.ceil(f)}]);o.useProgram(g),o.bindFramebuffer(F),o.bindTexture(t.colorTexture,4),g.setUniform1i("u_colorTexture",4),g.setUniform2fv("u_texSize",_),g.setUniform2fv("u_direction",n),g.setUniform1f("u_sigma",f),w.draw(),o.bindFramebuffer(O),o.bindTexture(F?.colorTexture,5),g.setUniform1i("u_colorTexture",5),g.setUniform2fv("u_direction",l),w.draw(),o.bindFramebuffer(t),o.setViewport(0,0,p,d);const z=c.getProgram(h.composite);o.useProgram(z),o.bindTexture(O?.colorTexture,2),z.setUniform1i("u_blurTexture",2),o.bindTexture(T,3),z.setUniform1i("u_layerFBOTexture",3),z.setUniform4fv("u_shadowColor",[m[3]*(m[0]/255),m[3]*(m[1]/255),m[3]*(m[2]/255),m[3]]),z.setUniformMatrix3fv("u_displayViewMat3",a.displayMat3),z.setUniform2fv("u_shadowOffset",x),w.draw(),o.setBlendingEnabled(!0),o.setStencilTestEnabled(!0),o.setBlendFunction(1,771),w.unbind()}_createOrResizeResources(e,t,r,s){const{context:n}=e;if(!this._horizontalBlurFBO||this._size[0]!==t||this._size[1]!==r){if(this._size[0]=t,this._size[1]=r,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(s[0],s[1]);else{const e=new a.TextureDescriptor(s[0],s[1]);e.internalFormat=6408,e.wrapMode=33071,this._horizontalBlurFBO=new i.FramebufferObject(n,e)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(s[0],s[1]);else{const e=new a.TextureDescriptor(s[0],s[1]);e.internalFormat=6408,e.wrapMode=33071,this._verticalBlurFBO=new i.FramebufferObject(n,e)}if(this._layerFBOTexture)this._layerFBOTexture.resize(t,r);else{const e=new a.TextureDescriptor(t,r);e.internalFormat=6408,e.wrapMode=33071,this._layerFBOTexture=new o.Texture(n,e)}}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});