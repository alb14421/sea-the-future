// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/maybe","../../VertexStream","../../../../../webgl/FramebufferObject","../../../../../webgl/TextureDescriptor"],function(e,t,s,i,r){"use strict";const o=[1,0],n=[0,1],a=[1,.8,.6,.4,.2],u=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];e.Bloom=class{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",locations:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",locations:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",locations:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",locations:new Map([["a_position",0]])}}}dispose(){if(this._quad=t.disposeMaybe(this._quad),this._intensityFBO=t.disposeMaybe(this._intensityFBO),this._compositeFBO=t.disposeMaybe(this._compositeFBO),this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}draw(e,t,i){const{width:r,height:l}=t,{context:c,painter:m}=e,{materialManager:h}=m,p=c.gl,_=this._programDesc,{strength:d,radius:f,threshold:b}=i;this._quad||(this._quad=new s(c,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,r,l),c.setStencilTestEnabled(!1),c.setBlendingEnabled(!0),c.setBlendFunction(1,771),c.setStencilWriteMask(0);const F=this._quad;F.bind(),c.bindFramebuffer(this._intensityFBO);const B=h.getProgram(_.luminosityHighPass);c.useProgram(B),c.bindTexture(t.colorTexture,0),B.setUniform1i("u_texture",0),B.setUniform3fv("u_defaultColor",[0,0,0]),B.setUniform1f("u_defaultOpacity",0),B.setUniform1f("u_luminosityThreshold",b),B.setUniform1f("u_smoothWidth",.01);const O=[Math.round(r/2),Math.round(l/2)];c.setViewport(0,0,O[0],O[1]),c.setClearColor(0,0,0,0),c.clear(p.COLOR_BUFFER_BIT),F.draw(),c.setBlendingEnabled(!1);let g=this._intensityFBO.colorTexture;for(let e=0;e<this._nMips;e++){const t=h.getProgram(_.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[e]}]);c.useProgram(t),c.bindTexture(g,e+1),t.setUniform1i("u_colorTexture",e+1),t.setUniform2fv("u_texSize",O),t.setUniform2fv("u_direction",o),c.setViewport(0,0,O[0],O[1]);const s=this._mipsFBOs[e];c.bindFramebuffer(s.horizontal),F.draw(),g=s.horizontal.colorTexture,c.bindFramebuffer(s.vertical),c.bindTexture(g,e+1),t.setUniform2fv("u_direction",n),F.draw(),g=s.vertical.colorTexture,O[0]=Math.round(O[0]/2),O[1]=Math.round(O[1]/2)}c.setViewport(0,0,r,l);const x=h.getProgram(_.composite,[{name:"nummips",value:5}]);c.bindFramebuffer(this._compositeFBO),c.useProgram(x),x.setUniform1f("u_bloomStrength",d),x.setUniform1f("u_bloomRadius",f),x.setUniform1fv("u_bloomFactors",a),x.setUniform3fv("u_bloomTintColors",u),c.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),x.setUniform1i("u_blurTexture1",1),c.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),x.setUniform1i("u_blurTexture2",2),c.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),x.setUniform1i("u_blurTexture3",3),c.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),x.setUniform1i("u_blurTexture4",4),c.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),x.setUniform1i("u_blurTexture5",5),F.draw(),c.bindFramebuffer(t),c.setBlendingEnabled(!0);const T=h.getProgram(_.blit);c.useProgram(T),c.bindTexture(this._compositeFBO.colorTexture,6),T.setUniform1i("u_texture",6),c.setBlendFunction(1,1),F.draw(),F.unbind(),c.setBlendFunction(1,771),c.setStencilTestEnabled(!0)}_createOrResizeResources(e,t,s){const{context:o}=e;if(this._compositeFBO&&this._size[0]===t&&this._size[1]===s)return;this._size[0]=t,this._size[1]=s;const n=[Math.round(t/2),Math.round(s/2)];if(this._compositeFBO)this._compositeFBO.resize(t,s);else{const e=new r.TextureDescriptor(t,s);e.internalFormat=6408,e.wrapMode=33071,this._compositeFBO=new i.FramebufferObject(o,e)}if(this._intensityFBO)this._intensityFBO.resize(n[0],n[1]);else{const e=new r.TextureDescriptor(n[0],n[1]);e.internalFormat=6408,e.wrapMode=33071,this._intensityFBO=new i.FramebufferObject(o,e)}for(let e=0;e<this._nMips;e++){if(this._mipsFBOs[e])this._mipsFBOs[e].horizontal.resize(n[0],n[1]),this._mipsFBOs[e].vertical.resize(n[0],n[1]);else{const t=new r.TextureDescriptor(n[0],n[1]);t.internalFormat=6408,t.wrapMode=33071,this._mipsFBOs[e]={horizontal:new i.FramebufferObject(o,t),vertical:new i.FramebufferObject(o,t)}}n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});