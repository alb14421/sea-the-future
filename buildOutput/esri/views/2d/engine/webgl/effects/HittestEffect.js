// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/has","../definitions","./Effect","../../../../webgl/enums"],function(t,e,s,i,o){"use strict";class n extends i.Effect{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions({pixelRatio:t},i){if(!i.length)return null;const o=i.shift(),n=o.x,r=o.y;this._outstanding=o;const l=e("esri-mobile");return{type:"hittest",distance:(l?s.hittestToleranceMobile:s.hittestToleranceDesktop)*t,smallSymbolDistance:(l?s.hittestToleranceMobile:s.hittestToleranceSmallSymbol)*t,smallSymbolSizeThreshold:s.hittestSmallSymbolThreshold,position:[n,r]}}bind(t){const{context:e,attributeView:s}=t;if(!s.size)return;const i=s.getBlock(2);if(null==i)return;const o=i.getFBO(e);e.setViewport(0,0,s.size,s.size),e.bindFramebuffer(o),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(16640)}unbind(){}draw(t){if(null==this._outstanding)return;const e=this._outstanding;this._outstanding=null,this._resolve(t,e.resolvers)}async _resolve(t,e){const{context:s,attributeView:i}=t,n=i.getBlock(2);if(null==n)return void e.forEach(t=>t.resolve([]));const r=n.getFBO(s),l=new Uint8Array(r.width*r.height*4);try{await r.readPixelsAsync(0,0,r.width,r.height,6408,o.PixelType.UNSIGNED_BYTE,l)}catch(t){return void e.forEach(t=>t.resolve([]))}const c=[];for(let t=0;t<l.length;t+=4){const e=t/4;l[t]&&c.push(e)}e.forEach(t=>t.resolve(c))}}t.HittestEffect=n,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});