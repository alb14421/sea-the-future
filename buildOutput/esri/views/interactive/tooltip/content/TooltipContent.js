// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../chunks/tslib.es6","../../../../core/a11yUtils","../../../../core/events","../../../../core/has","../../../../core/memoize","../../../../core/promiseUtils","../../../../core/scheduling","../../../../core/unitFormatUtils","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../support/getDefaultUnitForView","../../keybindings","../css","../fields/parsingAndFormattingUtils","../../../../widgets/Widget","../../../../chunks/componentsUtils","../../../../widgets/support/widgetUtils","../../../../widgets/support/decorators/messageBundle","../../../../widgets/support/jsxFactory"],function(t,e,o,n,i,s,r,a,l,c,d,p,u,h,_,f,g,m,y,w,b,v,C,I){"use strict";const T=Symbol("dragHandles");async function x(t){await(t?.setFocus())}function A(t){return(Array.isArray(t)?t:[t]).flat(10).filter(t=>!!t)}e.TooltipContent=class extends w{constructor(){super(...arguments),this._focusAbortController=new AbortController,this._transitionInfo=null,this._mode="feedback",this._getFormatters=r.memoize(y.getFormatters),this._onHeaderPointerDown=t=>{const e=t.target;e instanceof HTMLElement&&"calcite-button"!==e?.tagName?.toLowerCase()&&(this.removeHandles(T),t.preventDefault(),t.stopPropagation(),e.setPointerCapture(t.pointerId),this.tooltip.onDragStart(t.clientX,t.clientY),this.addHandles([i.on(e,"pointermove",({clientX:t,clientY:e})=>{this.tooltip.onDrag(t,e)}),i.on(e,["pointerup","pointercancel"],o=>{this.removeHandles(T),e.releasePointerCapture(t.pointerId),this.tooltip.onDragEnd()}),i.on(e,"touchstart",t=>t.preventDefault())],T))},this._onDiscard=()=>{this.destroyed||(this.tooltip.emit("discard"),this.info.clearInputValues(),this.exitInputMode())},this._onCommit=(t,e)=>{if(this.destroyed)return;if(this.tooltip.emit("commit",{type:e}),"commit-and-exit"===e)return void this.exitInputMode();if("commit-on-blur"===e)return;const o=this._getFocusableElements(),n=o.length,i=o.indexOf(t);if(-1===i)return void this.exitInputMode();const s=((i+("commit-and-next"===e?1:-1))%n+n)%n;x(o.at(s))},this._onKeyDown=t=>{switch(t.code){case g.tooltipKeys.next:return this._onNextKey(t);case g.tooltipKeys.discard:return t.stopPropagation(),this._onDiscard()}}}get mode(){return this._mode}get _displayUnits(){const{displayUnits:t}=this.info.sketchOptions.values,e=f.getDefaultUnitForView(this.tooltip.view);return{length:t.length??e,verticalLength:t.verticalLength??e,area:t.area??e}}get _inputUnitInfos(){const t=this._messagesUnits,e=e=>({unit:e,abbreviation:c.unitName(t,e,"abbr")}),{inputUnits:o}=this.info.sketchOptions.values,n=f.getDefaultUnitForView(this.tooltip.view),i=o.length??n,s=o.verticalLength??n,r=o.area??n;return{length:e(d.defaultLengthUnit(i)),verticalLength:e(d.defaultVerticalLengthUnit(s)),area:e(d.defaultAreaUnit(r)),angle:e("degrees")}}get _formatters(){return this._getFormatters(this._messagesUnits,this._displayUnits)}get fieldContext(){return{formatters:this._formatters,inputUnitInfos:this._inputUnitInfos,messages:this._messagesTooltip,sketchOptions:this.info.sketchOptions,onCommit:this._onCommit,onDiscard:this._onDiscard}}render(){const{visibleElements:t}=this.info.sketchOptions.tooltips,e=this._renderedContent,o=this._renderedActions,n=this._renderedHelpMessage,i=e.length>0,s=i||!!n,r="input"===this.mode;return I.tsx("div",{class:v.classes(m.content,r&&m.contentInputMode),onkeydown:this._onKeyDown,tabIndex:-1},r&&s&&t.header?I.tsx("div",{class:m.contentHeader,"data-testid":"tooltip-header",key:"header",onpointerdown:this._onHeaderPointerDown},I.tsx("calcite-button",{appearance:"transparent","data-testid":"tooltip-back-button",iconFlipRtl:"both",iconStart:"chevron-left",key:"discard-button",kind:"neutral",onclick:this._onDiscard,scale:"s",tabIndex:-1}),o.length>0?I.tsx(I.tsxFragment,null,I.tsx("div",{class:m.contentHeaderSpacer,key:"spacer"}),I.tsx("div",{class:m.contentHeaderActions,key:"actions"},o)):null):null,i?I.tsx("div",{class:m.table,key:"content"},...e):null,n)}destroy(){this._focusAbortController.abort(),this._transitionInfo?.transition.skipTransition()}_renderActions(){return null}loadDependencies(){return b.loadCalciteComponents({button:()=>new Promise((e,o)=>t(["../../../../chunks/index2"],e,o)),icon:()=>new Promise((e,o)=>t(["../../../../chunks/index7"],e,o)),input:()=>new Promise((e,o)=>t(["../../../../chunks/index4"],e,o))})}async enterInputMode(t,e){try{await this._transitionTo("input",e),await this._focusField(t)}catch(t){a.throwIfNotAbortError(t)}}async exitInputMode({focusOnView:t=!0}={}){try{const{container:e,info:o}=this;o.clearInputValues();const n=t?e?.closest(".esri-view")?.querySelector(".esri-view-surface"):null;await this._transitionTo("feedback"),n instanceof HTMLElement&&n.focus()}catch(t){a.throwIfNotAbortError(t)}}_onNextKey(t){const e=this._getFocusableElements(),o=e.at(0),n=e.at(-1);o&&n&&(t.shiftKey?document.activeElement===o&&(t.preventDefault(),t.stopPropagation(),x(n)):document.activeElement===n&&(t.preventDefault(),t.stopPropagation(),x(o)))}get _renderedContent(){return A(this._renderContent())}get _renderedActions(){return A(this._renderActions())}get _renderedHelpMessage(){const{sketchOptions:t,visibleElements:e}=this.info;if(!e.helpMessage)return null;const o=t.tooltips.helpMessage??this._defaultHelpMessage;if(!o)return null;const n=t.tooltips.helpMessageIcon??"information";return I.tsx("div",{class:m.helpMessage,key:"help-message"},n?I.tsx("calcite-icon",{class:m.helpMessageIcon,icon:n,scale:"s"}):null,I.tsx("div",{class:m.helpMessageText},o))}get _defaultHelpMessage(){const{helpMessage:t,viewType:e}=this.info;if(null==t)return null;const o="3d"===e?"helpMessages3d":"helpMessages2d";return this._messagesTooltip?.sketch?.[o]?.[t]}async _focusField(t){this._focusAbortController?.abort(),this._focusAbortController=new AbortController;const{signal:e}=this._focusAbortController;await this._waitForInputs(),a.throwIfAborted(e);const o=this._getFocusableInputs(),n=t?o.find(e=>e.getAttribute("data-field-name")===t):o.at(0);await x(n)}async _transitionTo(t,e){if(this._mode===t&&!this._transitionInfo)return;if(this._transitionInfo?.mode===t)return this._transitionInfo.transition.finished;this._transitionInfo?.transition.skipTransition();const o=async()=>{this.destroyed||(this._mode=t,await l.waitTick(),this.destroyed||(this.renderNow(),await l.waitTick(),this.destroyed||e?.()))};if(!this.domNode?.firstChild||!document.startViewTransition||n.prefersReducedMotion())return void await o();this.autoRenderingEnabled=!1;const i=this._transitionInfo={transition:document.startViewTransition(async()=>{this.destroyed||i!==this._transitionInfo||(this.autoRenderingEnabled=!0,await o())}),mode:t};try{await i.transition.finished}finally{i===this._transitionInfo&&(this._transitionInfo=null)}}async _waitForInputs(){const t=()=>Array.from(this.domNode?.querySelectorAll("calcite-input")??[]);for(;0===t().length;)await a.after(k);await l.waitAnimationFrame()}_getFocusableInputs(){return Array.from(this.domNode?.querySelectorAll("calcite-input:not([read-only]):not([disabled])")??[])}_getFocusableElements(){const t=this.domNode?.querySelector(`.${m.drawContentHeaderActions}`);return[...Array.from(t?.querySelectorAll(`.${m.contentHeaderActions} calcite-button:not([disabled])`)??[]),...this._getFocusableInputs()]}},o.__decorate([C.messageBundle("esri/core/t9n/Units"),p.property()],e.TooltipContent.prototype,"_messagesUnits",void 0),o.__decorate([C.messageBundle("esri/views/interactive/tooltip/t9n/Tooltip"),p.property()],e.TooltipContent.prototype,"_messagesTooltip",void 0),o.__decorate([p.property()],e.TooltipContent.prototype,"info",void 0),o.__decorate([p.property()],e.TooltipContent.prototype,"tooltip",void 0),o.__decorate([p.property()],e.TooltipContent.prototype,"_mode",void 0),o.__decorate([p.property()],e.TooltipContent.prototype,"mode",null),o.__decorate([p.property()],e.TooltipContent.prototype,"_displayUnits",null),o.__decorate([p.property()],e.TooltipContent.prototype,"_inputUnitInfos",null),o.__decorate([p.property()],e.TooltipContent.prototype,"_formatters",null),o.__decorate([p.property()],e.TooltipContent.prototype,"fieldContext",null),o.__decorate([p.property()],e.TooltipContent.prototype,"_renderedContent",null),o.__decorate([p.property()],e.TooltipContent.prototype,"_renderedActions",null),o.__decorate([p.property()],e.TooltipContent.prototype,"_renderedHelpMessage",null),o.__decorate([p.property()],e.TooltipContent.prototype,"_defaultHelpMessage",null),e.TooltipContent=o.__decorate([_.subclass("esri.views.interactive.tooltip.content.TooltipContent")],e.TooltipContent);const k=20;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});