// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../core/arrayUtils","../../core/has","../../core/lang","../../core/mathUtils","../../core/screenUtils","../../geometry/projectionUtils","../../geometry/support/meshVertexSpaceUtils","../../layers/graphics/hydratedFeatures","../../support/elevationInfoUtils","./editGeometry/EditGeometryOperations"],function(e,t,n,r,a,l,o,c,i,s,u){"use strict";function p(e,t){let n=null,r=null;return a=>{if("cancel"===a.action)return void(null!=r&&(r.execute({action:"cancel"}),n=null,r=null));const l={action:a.action,screenStart:a.start,screenEnd:a.screenPoint};"start"===a.action&&null==n&&(n=new S,r=new S,t(e,n,r,a.pointerType,l)),null!=n&&n.execute(l),"end"===a.action&&null!=n&&(n=null,r=null)}}function d(e){let t=null;return n=>{if("start"===n.action&&(t=function(e,t){const n=e.operations;if(!n)return null;const r=n.data.geometry,a=i.hydratedSpatialReference(t);if(r.spatialReference.equals(a))return f(e,n,()=>{});if("mesh"!==r.type){const t=m(r,a);if(null==t)return null;const l=r.spatialReference;return f(e,u.EditGeometryOperations.fromGeometry(t,n.viewingMode),()=>{const e=o.project(r,l);n.trySetGeometry(e)})}if(c.isMeshWithRelativeVertexSpace(r)){const t=m(r.origin,a);if(!t)return null;const l=r.spatialReference,c=u.EditGeometryOperations.fromGeometry(t,n.viewingMode);return f(e,n,()=>{const e=o.project(c.data.geometry,l),t=e.x-r.origin.x,a=e.y-r.origin.y,i=(e.z??0)-(r.origin.z??0);n.move(t,a,i)})}return null}(e,n.mapStart.spatialReference)),null==t)return null;const r=n.mapEnd.x-n.mapStart.x,a=n.mapEnd.y-n.mapStart.y,l=(n.mapEnd.z??0)-(n.mapStart.z??0);return t.move(r,a,l,n.action),{...n,translationX:r,translationY:a,translationZ:l}}}function m(e,t){return null==e?null:e.spatialReference.equals(t)?e.clone():o.project(e,t)}function f(e,t,n){let r=0,a=0,l=0;return{move:(o,c,i,s)=>{"start"===s&&(r=0,a=0,l=0);const u=o-r,p=c-a,d=i-l;t.move(u,p,d),r+=u,a+=p,l+=d,n(),"end"===s&&e.endInteraction?.()}}}function y(e){const t=e.operations?.createResetState();return e=>(t?.remove(),e)}const E=()=>{};class S{constructor(){this.execute=E}next(e,t=new S){return null!=e&&(this.execute=n=>{const r=e(n);null!=r&&t.execute(r)}),t}}function x(e,t,n){const r=t.elevationProvider.getElevation(e.x,e.y,e.z??0,e.spatialReference,"scene")??0,a=i.clonePoint(e);return a.z=r,a.hasZ=!0,a.z=s.getZForElevationMode(a,t,n),a}e.EventPipeline=S,e.addMapDelta=function(){let e=0,t=0,n=0;return r=>{"start"===r.action&&(e=r.mapStart.x,t=r.mapStart.y,n=r.mapStart.z);const a=r.mapEnd.x-e,l=r.mapEnd.y-t,o=r.mapEnd.z-n;return e=r.mapEnd.x,t=r.mapEnd.y,n=r.mapEnd.z,{...r,mapDeltaX:a,mapDeltaY:l,mapDeltaZ:o,mapDeltaSpatialReference:r.mapStart.spatialReference}}},e.addScreenDelta=function(){let e=0,t=0;return n=>{"start"===n.action&&(e=n.screenStart.x,t=n.screenStart.y);const r=n.screenEnd.x-e,a=n.screenEnd.y-t;return e=n.screenEnd.x,t=n.screenEnd.y,{...n,screenDeltaX:r,screenDeltaY:a}}},e.constrainToMapAxis=function(e,t){const n=[e.x,e.y,e.z??0],r=t,a=[Math.cos(r),Math.sin(r)],l=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(0===l)return null;a[0]/=l,a[1]/=l;const o=e=>{const t=(e.x-n[0])*a[0]+(e.y-n[1])*a[1];e.x=n[0]+t*a[0],e.y=n[1]+t*a[1]};return e=>(o(e.mapStart),o(e.mapEnd),{...e,axis:a})},e.createDragEventPipelineCallback=p,e.createManipulatorDragEventPipeline=function(e,t){return e.events.on("drag",p(e,t))},e.dragAtLocation=function(e,t){let n=null,r=0,o=0;return c=>{if("start"===c.action&&(n=e.toScreen?.(t),null!=n&&(n.x<0||n.x>e.width||n.y<0||n.y>e.height?n=null:(r=c.screenStart.x-n.x,o=c.screenStart.y-n.y))),null==n)return null;const i=a.clamp(c.screenEnd.x-r,0,e.width),s=a.clamp(c.screenEnd.y-o,0,e.height),u=l.createScreenPoint(i,s);return c.screenStart=n,c.screenEnd=u,c}},e.dragManipulatedObject=d,e.dragManipulatedObjectMany=function(e){const n=e.map(e=>d(e)).filter(t.isSome);return e=>{const t=e.mapEnd.x-e.mapStart.x,r=e.mapEnd.y-e.mapStart.y,a=e.mapEnd.z-e.mapStart.z;return n.forEach(t=>t(e)),{...e,translationX:t,translationY:r,translationZ:a}}},e.resetManipulatedObject=y,e.resetManipulatedObjectMany=function(e){const t=e.map(e=>y(e)).filter(e=>null!=e);return e=>(t.forEach(t=>t(e)),e)},e.resetProperties=function(e,t){const n=new Map;for(const a of t)n.set(a,r.clone(e[a]));return t=>(n.forEach((t,n)=>{e[n]=t}),t)},e.sceneSnappingAtLocation=function(e,t,n=[]){if("2d"===e.type)return e=>e;let r=null;return a=>{"start"===a.action&&(r=e.toMap(a.screenStart,{exclude:n}),null!=r&&(r.z=s.getZForElevationMode(r,e,t)));const l=e.toMap(a.screenEnd,{exclude:n});null!=l&&(l.z=s.getZForElevationMode(l,e,t));const o=null!=r&&null!=l?{sceneStart:r,sceneEnd:l}:null;return{...a,scenePoints:o}}},e.sceneSnappingAtProjectedLocation=function(e,t){if("2d"===e.type)return e=>e;let n=null;return r=>{"start"===r.action&&(n=x(r.mapStart,e,t));const a=x(r.mapEnd,e,t),l=null!=n&&null!=a?{sceneStart:n,sceneEnd:a}:null;return{...r,scenePoints:l}}},e.screenToMap=function(e,t=null,n){let r=null;const a=null==t||e.spatialReference?.equals(t)?e=>e:e=>null!=e?o.project(e,t):e,l={exclude:[],...n};return t=>{if("start"===t.action&&(r=a(e.toMap(t.screenStart,l))),null==r)return null;const n=a(e.toMap(t.screenEnd,l));return null!=n?{...t,mapStart:r,mapEnd:n}:null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});