// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/arrayUtils","../../../core/handleUtils","../../../core/has","../../../core/mapCollectionUtils","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/unitUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/vec2","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/libs/gl-matrix-2/math/common","../../../core/support/UpdatingHandles","../../../support/elevationInfoUtils","../sketch/constraints","../sketch/normalizedPoint","./FeatureSnappingSourceInfo","./snappingUtils","./candidates/DrapedEdgeSnappingCandidate","./candidates/EdgeSnappingCandidate","./candidates/FeatureSnappingCandidate","./candidates/RightAngleSnappingCandidate","../support/viewUtils"],function(e,t,n,r,a,i,s,o,c,u,l,p,d,g,S,h,y,f,m,_,v,w,F,b,C,P,x,E,I){"use strict";function M(e,t,n,r,a,i,{spatialReference:s}){const o=h.copy(A,t);o[0]+=n,o[1]+=r,o[2]+=a;const c=I.vectorToScreenPoint(o,s,_.absoluteHeightElevationInfo,i);return c?b.screenDistance(c,e):1/0}t.FeatureSnappingEngine=class extends r{get updating(){return this._snappingSources.some(e=>null==e?.valid||!0===e.valid&&!0===e.snappingSource?.updating)||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=1,this._updatingHandles=new m.UpdatingHandles,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=o.mapCollectionAsync(()=>this.options?._effectiveFeatureSources,(e,t)=>this._createSourceInfo(e,t));this._snappingSources=e,this.addHandles([i.destroyHandle(e),u.watch(()=>({rulesEnabled:!!this.options?.attributeRulesEnabled,sources:this._snappingSources.filter(a.isSome)}),({rulesEnabled:e,sources:t})=>{for(const n of t)n.attributeRulesEnabled=e},u.sync)])}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,n,r){if(!(t&this._domain&&null!=this.options&&this.options.effectiveFeatureEnabled))return[];const a=[],i=this._computeScreenSizeDistanceParameters(e,n);for(const t of this._snappingSources){if(!t?.valid||!t.snappingSource?.layerSource?.enabled||t.layerView?.suspended)continue;const s=t.getFetchCandidatesParameters(e,n,i);for(const e of s)a.push(t.snappingSource.fetchCandidates(e,r).then(e=>e.filter(e=>!this._candidateIsExcluded(t.snappingSource,e,n.excludeFeature))))}const s=(await c.allSettledValues(a)).flat();return this._addRightAngleCandidates(s,e,i,n),c.throwIfAborted(r),b.sortCandidatesInPlace(e,s),s}_addRightAngleCandidates(e,t,n,r){const a=null!=r.vertexHandle?r.vertexHandle.rightSegment?.rightVertex?.pos:null!=r.editGeometryOperations&&"polygon"===r.editGeometryOperations.data.type?r.editGeometryOperations.data.parts[0]?.getFirstVertex()?.pos:null,i=null!=r.vertexHandle?r.vertexHandle.leftSegment?.leftVertex?.pos:null!=r.editGeometryOperations?r.editGeometryOperations.data.parts[0]?.getLastVertex()?.pos:null,{view:s}=this,o=w.fromAnyMapPoint(a,s,r),c=w.fromAnyMapPoint(i,s,r),u=e.length;for(let r=0;r<u;r++)this._addRightAngleCandidate(e[r],c,t,n,e),this._addRightAngleCandidate(e[r],o,t,n,e)}_addRightAngleCandidate(e,t,n,r,a){if(null==t||!function(e){return(e instanceof P.EdgeSnappingCandidate||e instanceof C.DrapedEdgeSnappingCandidate)&&!function({constraint:{start:e,end:t}}){const n=h.squaredDistance(e,t),r=S.squaredDistance(w.asVec2(e),w.asVec2(t));return n<f.getEpsilon()||r/n<H}(e)}(e))return;const i=e.constraint.closestTo(t),s=(i[0]-n[0])/r.x,o=(i[1]-n[1])/r.y,{start:c,end:u}=e.constraint;if(s*s+o*o<=1){const n=S.squaredDistance(w.asVec2(i),w.asVec2(c))>S.squaredDistance(w.asVec2(i),w.asVec2(u))?c:u,r=new E.RightAngleSnappingCandidate({targetPoint:w.markAsTarget(i),otherVertex:t,otherVertexType:0,previousVertex:n,constraint:new v.VerticalHalfPlaneConstraint(t,i),objectId:e.objectId,isDraped:e.isDraped,domain:1});a.push(r)}}_computeScreenSizeDistanceParameters(e,t){let n=null!=this.options?this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1):0;return null==this.view?{x:n,y:n,z:n,distance:n}:"2d"===this.view.type?(n*=this.view.resolution,{x:n,y:n,z:n,distance:n}):this._computeScreenSizeDistanceParameters3D(e,n,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,n,r){const{spatialReference:a}=r;n.renderCoordsHelper.toRenderCoords(e,a,R);const i=n.state.camera.computeScreenPixelSizeAt(R),s=i*n.renderCoordsHelper.unitInMeters,o=s/l.getMetersPerUnitForSR(a),c=s/l.getMetersPerVerticalUnitForSR(a),u=t*o,p=t*c,d=I.vectorToScreenPoint(e,a,_.absoluteHeightElevationInfo,n),g=d?M(d,e,o,0,0,n,r):0,S=d?M(d,e,0,o,0,n,r):0,h=d?M(d,e,0,0,c,n,r):0;return{x:0===g?0:u/g,y:0===S?0:u/S,z:0===h?0:p/h,distance:i*t}}_candidateIsExcluded(e,t,n){if(null==n)return!1;const r=this._getCandidateObjectId(t);if(null==r)return!1;const a=e.layerSource.layer;return"graphics"===a.type?n.uid===r:n.sourceLayer===a&&!(!n.attributes||!("objectIdField"in a))&&n.attributes[a.objectIdField]===r}_getCandidateObjectId(e){return e instanceof x.FeatureSnappingCandidate?e.objectId:null}async _createSourceInfo(e,t){const n=e.layer;n.loaded||(await n.load(),c.throwIfAborted(t));const{view:r}=this,a=await this._createFeatureSnappingSourceType(e);return c.throwIfAborted(t),null==a?new F.FeatureSnappingSourceInfo({}):new F.FeatureSnappingSourceInfo({snappingSource:a,view:r,layer:n})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;return null==t||"3d"!==t.type?null:new((await this._getSourceModule("scene")).SceneLayerSnappingSource)({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source?.type){case"feature-layer":case"oriented-imagery":return new((await this._getSourceModule("featureService")).FeatureServiceSnappingSource)({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return"mesh"===e.layer.geometryType?null:new((await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource)({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new((await this._getSourceModule("graphics")).GraphicsSnappingSource)({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new((await this._getSourceModule("notes")).GraphicsSnappingSource)({getGraphicsLayers:()=>e.layer.sublayers?.toArray()??[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(null==t.loader){const t=this._loadSourceModule(e),n={module:null,loader:t};this._sourceModules[e]=n;const r=await t,a={module:r,loader:t};return this._sourceModules[e]=a,r}return null==t.module?t.loader:t.module}_loadSourceModule(t){const n=this._updatingHandles;switch(t){case"featureService":return n.addPromise(new Promise((t,n)=>e(["./featureSources/FeatureServiceSnappingSource"],t,n)));case"featureCollection":return n.addPromise(new Promise((t,n)=>e(["./featureSources/FeatureCollectionSnappingSource"],t,n)));case"graphics":case"notes":return n.addPromise(new Promise((t,n)=>e(["./featureSources/GraphicsSnappingSource"],t,n)));case"scene":return n.addPromise(new Promise((t,n)=>e(["./featureSources/SceneLayerSnappingSource"],t,n)))}}get test(){}},n.__decorate([p.property({constructOnly:!0})],t.FeatureSnappingEngine.prototype,"spatialReference",void 0),n.__decorate([p.property({constructOnly:!0})],t.FeatureSnappingEngine.prototype,"view",void 0),n.__decorate([p.property()],t.FeatureSnappingEngine.prototype,"options",void 0),n.__decorate([p.property({readOnly:!0})],t.FeatureSnappingEngine.prototype,"updating",null),n.__decorate([p.property()],t.FeatureSnappingEngine.prototype,"_snappingSources",void 0),t.FeatureSnappingEngine=n.__decorate([g.subclass("esri.views.interactive.snapping.FeatureSnappingEngine")],t.FeatureSnappingEngine);const R=y.create(),A=y.create(),H=1e-4;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});