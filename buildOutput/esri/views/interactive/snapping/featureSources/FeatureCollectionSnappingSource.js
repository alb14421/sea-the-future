// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/memoize","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/sql","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../support/elevationInfoUtils","../snappingUtils","./queryEngineUtils","./snappingCandidateElevationAlignment","./snappingCandidateElevationFilter","./symbologySnappingCandidates"],function(e,t,n,i,r,o,a,l,p,s,c,y,u,g,d,S,h,v){"use strict";e.FeatureCollectionSnappingSource=class extends n{get availability(){return 1}get _snappingElevationAligner(){const{view:e}=this,{layer:t}=this.layerSource,n=null!=e&&"3d"===e.type;return n&&"subtype-group"!==t.type?S.getSnappingCandidateElevationAligner(n,{elevationInfo:t.elevationInfo,alignPointsInFeatures:async(n,i)=>(await r.whenOrAbort(e.whenLayerView(t),i)).elevationAlignPointsInFeatures(n,i)}):S.getSnappingCandidateElevationAligner()}get _snappingElevationFilter(){const{view:e}=this,t=null!=e&&"3d"===e.type&&"subtype-group"!==this.layerSource.layer.type;return h.getSnappingCandidateElevationFilter(t)}get _symbologySnappingFetcher(){const{view:e}=this,{layer:t}=this.layerSource;return null!=e&&"3d"===e.type&&"subtype-group"!==t.type?v.getSymbologySnappingCandidatesFetcher(this._symbologySnappingSupported,async(n,i)=>{const o=await e.whenLayerView(t);return r.throwIfAborted(i),o.queryForSymbologySnapping({candidates:n,spatialReference:e.spatialReference},i)}):v.getSymbologySnappingCandidatesFetcher()}get _layerView(){const{view:e}=this;if(null==e)return null;const{layer:t}=this.layerSource;return e.allLayerViews.find(e=>e.layer===t)}get _layerView3D(){const{view:e}=this;return null==e||"2d"===e.type?null:this._layerView}get _symbologySnappingSupported(){return null!=this._layerView3D&&this._layerView3D.symbologySnappingSupported}initialize(){const{view:e}=this,{layer:t}=this.layerSource;null!=e&&"3d"===e.type&&"subtype-group"!==t.type&&this.addHandles([e.elevationProvider.on("elevation-change",({context:e})=>{const{elevationInfo:n}=t;u.elevationContextAffectsAlignment(e,n)&&this._snappingElevationAligner.notifyElevationSourceChange()}),o.watch(()=>t.elevationInfo,()=>this._snappingElevationAligner.notifyElevationSourceChange(),o.initial),o.watch(()=>null!=this._layerView3D?this._layerView3D.layer?.renderer:null,()=>this._symbologySnappingFetcher.notifySymbologyChange(),o.initial),o.on(()=>this._layerView3D?.layer,["edits","apply-edits"],()=>this._symbologySnappingFetcher.notifySymbologyChange())])}constructor(e){super(e),this.view=null,this.updating=!1,this._memoizedMakeGetGroundElevation=i.memoize(d.makeGetGroundElevation)}refresh(){}async fetchCandidates(e,t){const{layer:n}=this.layerSource,{source:i}=n;if(!i?.querySnapping)return[];const o=n.createQuery();this._layerView&&"effectiveDisplayFilter"in this._layerView&&(o.where=a.sqlAnd(o.where,this._layerView.effectiveDisplayFilter?.where));const l="returnZ"in n?n.returnZ:void 0,p=g.makeSnappingQuery({parameters:e,mode:this.view?.type??"2d",returnZ:l,filter:o}),s=await i.querySnapping(p,{signal:t});r.throwIfAborted(t);const c=e.coordinateHelper.spatialReference,y=await this._snappingElevationAligner.alignCandidates(s.candidates,c,t);r.throwIfAborted(t);const u=await this._symbologySnappingFetcher.fetch(y,t);r.throwIfAborted(t);const S=0===u.length?y:[...y,...u],h=this._snappingElevationFilter.filter(p,S),v=this._memoizedMakeGetGroundElevation(this.view,c);return h.map(e=>d.convertSnappingCandidate(e,v))}},t.__decorate([l.property({constructOnly:!0})],e.FeatureCollectionSnappingSource.prototype,"layerSource",void 0),t.__decorate([l.property({constructOnly:!0})],e.FeatureCollectionSnappingSource.prototype,"view",void 0),t.__decorate([l.property()],e.FeatureCollectionSnappingSource.prototype,"_snappingElevationAligner",null),t.__decorate([l.property()],e.FeatureCollectionSnappingSource.prototype,"_snappingElevationFilter",null),t.__decorate([l.property()],e.FeatureCollectionSnappingSource.prototype,"_symbologySnappingFetcher",null),t.__decorate([l.property()],e.FeatureCollectionSnappingSource.prototype,"_layerView",null),t.__decorate([l.property()],e.FeatureCollectionSnappingSource.prototype,"_layerView3D",null),t.__decorate([l.property()],e.FeatureCollectionSnappingSource.prototype,"_symbologySnappingSupported",null),e.FeatureCollectionSnappingSource=t.__decorate([y.subclass("esri.views.interactive.snapping.featureSources.FeatureCollectionSnappingSource")],e.FeatureCollectionSnappingSource),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});