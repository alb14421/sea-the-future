// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/has","../../../../core/LRUCache","../../../../core/MapUtils","../../../../core/promiseUtils","../../../../core/unitUtils","../../../../symbols/support/unitConversionUtils"],function(e,t,n,s,o,i,a){"use strict";class r{async alignCandidates(e,t,n){return e}notifyElevationSourceChange(){}}class c{constructor(e,t){this._elevationInfo=e,this._alignPointsInFeatures=t,this._alignmentsCache=new n.LRUCache(1024),this._cacheVersion=0}async alignCandidates(e,t,n){const s=this._elevationInfo;return null==s||"absolute-height"!==s.mode||s.featureExpressionInfo?this._alignComputedElevationCandidates(e,t,n):(function(e,t,n){const{offset:s,unit:o}=n;if(null==s)return;const r=i.getMetersPerVerticalUnitForSR(t),c=o??"meters",l=s*(a.getMetersPerUnit(c)/r);for(const t of e)switch(t.type){case"edge":t.start.z+=l,t.end.z+=l;continue;case"vertex":t.target.z+=l;continue}}(e,t,s),e)}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}async _alignComputedElevationCandidates(e,t,n){const i=new Map;for(const t of e)s.getOrCreateMapValue(i,t.objectId,d).push(t);const[a,r,c]=this._prepareQuery(i,t),l=await this._alignPointsInFeatures(a,n);if(o.throwIfAborted(n),c!==this._cacheVersion)return this._alignComputedElevationCandidates(e,t,n);this._applyCacheAndResponse(a,l,r);const{drapedObjectIds:u,failedObjectIds:h}=l,p=[];for(const t of e){const{objectId:e}=t;u.has(e)&&"edge"===t.type&&(t.draped=!0),h.has(e)||p.push(t)}return p}_prepareQuery(e,t){const n=[],s=[];for(const[t,o]of e){const e=[];for(const n of o)this._addToQueriesOrCachedResult(t,n.target,e,s),"edge"===n.type&&(this._addToQueriesOrCachedResult(t,n.start,e,s),this._addToQueriesOrCachedResult(t,n.end,e,s));0!==e.length&&n.push({objectId:t,points:e})}return[{spatialReference:t.toJSON(),pointsInFeatures:n},s,this._cacheVersion]}_addToQueriesOrCachedResult(e,t,n,s){const o=u(e,t),i=this._alignmentsCache.get(o);null==i?n.push(t):s.push(new l(t,i))}_applyCacheAndResponse(e,{elevations:t,drapedObjectIds:n,failedObjectIds:s},o){for(const e of o)e.apply();let i=0;const a=this._alignmentsCache;for(const{objectId:o,points:r}of e.pointsInFeatures){if(s.has(o)){i+=r.length;continue}const e=!n.has(o);for(const n of r){const s=u(o,n),r=t[i++];n.z=r,e&&a.put(s,r,1)}}}}class l{constructor(e,t){this.point=e,this.z=t}apply(){this.point.z=this.z}}function u(e,{x:t,y:n,z:s,spatialReference:o}){return`${e}-${t}-${n}-${s??0}}-wkid:${o?.wkid}`}function d(){return[]}e.getSnappingCandidateElevationAligner=function(e=!1,t){if(e){const{elevationInfo:e,alignPointsInFeatures:n}=t;return new c(e,n)}return new r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});