// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Evented","../../../core/handleUtils","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/coordsUtils","./EditGeometry","./operations/AppendVertex","./operations/UpdateVertices","./operations/RemoveVertices","./operations/SplitSegment","./operations/SetVertexPosition","./operations/ClosePart","./operations/MoveMesh","./operations/MoveVertex","./operations/OffsetEdgeVertex","./operations/RotateVertex","./operations/ScaleVertex","./operations/SetAllVertexPositions","./operations/UndoGroup"],function(e,t,r,s,i,a,o,n,d,p,h,c,l,u,m,y,V,v,g){"use strict";class x extends t.Evented{constructor(e,t,r=!1){super(),this.data=e,this.viewingMode=t,this.allowCurves=r,this._undoStack=[],this._redoStack=[],this._listener=this.data.on("change",e=>{e.addedVertices&&this.emit("vertex-add",{type:"vertex-add",vertices:e.addedVertices,operation:e.operation}),e.removedVertices&&this.emit("vertex-remove",{type:"vertex-remove",vertices:e.removedVertices,operation:e.operation}),e.updatedVertices&&this.emit("vertex-update",{type:"vertex-update",vertices:e.updatedVertices,operation:e.operation})})}destroy(){super.destroy(),this._listener.remove()}splitSegment(e,t){return this._apply(new p.SplitSegment(this.data,e,t))}updateVertices(e,t,r=1){return this._apply(new n.UpdateVertices(this.data,e,t),r)}move(e,t,r,s=1){return a.isMeshEditGeometry(this.data)?this._apply(new l.MoveMesh(this.data,e,t,r),s):this.moveVertices(this.data.allVerticesUnordered,e,t,r,s)}moveVertices(e,t,r,s,i=1){return a.isMeshEditGeometry(this.data)?this._apply(new l.MoveMesh(this.data,t,r,s),i):this.updateVertices(e,new u.MoveVertex(this.data.coordinateHelper,t,r,s),i)}scale(e,t,r,s,i=1,a=0){return this.scaleVertices(this.data.allVerticesUnordered,e,t,r,s,i,a)}scaleVertices(e,t,r,s,i,a=1,o=0){return this.updateVertices(e,new V.ScaleVertex(t,r,s,i,o),a)}rotate(e,t,r=1,s=0){return this.rotateVertices(this.data.allVerticesUnordered,e,t,r,s)}rotateVertices(e,t,r,s=1,i=0){return this.updateVertices(e,new y.RotateVertex(t,r,i),s)}removeVertices(e){return this._apply(new d.RemoveVertices(this.data,e,this._minNumVerticesPerType))}appendVertex(e){return 0===this.data.parts.length?null:this._apply(new o.AppendVertex(this.data,this.data.parts[0],e))}setVertexPosition(e,t){return this._apply(new h.SetVertexPosition(this.data,e,t))}offsetEdge(e,t,r,s=1){return this.updateVertices([t.leftVertex,t.rightVertex],new m.OffsetEdgeVertex(this.data.coordinateHelper,e,t,r),s)}trySetGeometry(e,t=1){const{data:r}=this,{coordinateHelper:s}=r;if(r.type!==e.type||!r.spatialReference.equals(e.spatialReference)||s.hasZ()!==e.hasZ||s.hasM()!==e.hasM||!i.hasCompatibleTopology(r.geometry,e)||a.isMeshEditGeometry(r))return;const o=Array.from(a.EditGeometry.fromGeometry(e,this.viewingMode,{allowCurves:this.allowCurves}).iterateVerticesUnordered(),e=>e.pos);return this.setVertexPositions(o,t)}setVertexPositions(e,t=1){return this._apply(new v.SetAllVertexPositions(this.data,e),t)}createResetState(){if(a.isMeshEditGeometry(this.data))return this._createResetStateMesh();const e=this.data.geometry.clone();return r.makeHandle(()=>this.trySetGeometry(e))}closePart(e){return this.data.parts.includes(e)?this._apply(new c.ClosePart(this.data,e)):null}canRemoveVertex(e){return e.vertices.length>this._minNumVerticesPerType}createUndoGroup(){const e=new g.UndoGroup;return this._apply(e),r.makeHandle(()=>e.close())}undo(){if(this._undoStack.length>0){const e=this._undoStack.pop();return e.undo(),this._redoStack.push(e),e}return null}redo(){if(this._redoStack.length>0){const e=this._redoStack.pop();return e.apply(),this._undoStack.push(e),e}return null}get canUndo(){return this._undoStack.length>0}get canRedo(){return this._redoStack.length>0}get lastOperation(){return this._undoStack.length>0?this._undoStack[this._undoStack.length-1]:null}get _minNumVerticesPerType(){switch(this.data.type){case"point":return 1;case"polyline":return 2;case"polygon":return 3;default:return 0}}_apply(e,t=1){return 0!==t&&null!=this.lastOperation&&this.lastOperation.accumulate(e)||(e.apply(),this._undoStack.push(e),this._redoStack=[]),e}_createResetStateMesh(){if(!a.isMeshEditGeometry(this.data))return r.makeHandle();const e=this.data.geometry,{vertexSpace:t}=e;if(t.origin){const i=s.clone(t.origin);return r.makeHandle(()=>{e.vertexSpace.origin=i})}const i=e.vertexAttributes.clonePositional();return r.makeHandle(()=>{e.vertexAttributes=i,e.vertexAttributesChanged()})}static fromGeometry(e,t,r){return new x(a.EditGeometry.fromGeometry(e,t,r),t,!!r?.allowCurves)}}e.EditGeometryOperations=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});