// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.34/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/arrayUtils","../../../core/compilerUtils","../../../core/Evented","../../../geometry/Polygon","../../../geometry/Polyline","../../../geometry/support/curves/curveUtils","../coordinateHelper","./unnormalizationHelper"],function(e,t,i,r,n,s,o,h,c){"use strict";class l{constructor(e){this.part=e,this.leftSegment=null,this.rightSegment=null,this.type="vertex",this.index=null}get pos(){return this._pos}set pos(e){this._pos=e,this.part.unnormalizeVertexPositions()}}class a{constructor(e,t,i){this.part=e,this.leftVertex=t,this.rightVertex=i,this.type="line",t.rightSegment=this,i.leftSegment=this}toCurveOrCoordinate(){return[...this.rightVertex.pos]}}class g{constructor(e,t,i,r){this.part=e,this.leftVertex=t,this.rightVertex=i,this.curveDefinition=r,this.type="bezier",t.rightSegment=this,i.leftSegment=this}toCurveOrCoordinate(){return{b:[[...this.rightVertex.pos],[...this.curveDefinition.controlPoint1],[...this.curveDefinition.controlPoint2]]}}}class p{constructor(e,t,i,r){this.part=e,this.leftVertex=t,this.rightVertex=i,this.curveDefinition=r,this.type="circular-arc",t.rightSegment=this,i.leftSegment=this}toCurveOrCoordinate(){const e=this.rightVertex.pos,{interiorPoint:t}=this.curveDefinition;return{c:[[...e],[...t]]}}}class u{constructor(e,t,i,r){this.part=e,this.leftVertex=t,this.rightVertex=i,this.curveDefinition=r,this.type="elliptic-arc-4",t.rightSegment=this,i.leftSegment=this}toCurveOrCoordinate(){const e=this.rightVertex.pos,{centerPoint:t,sweep:i,orientation:r}=this.curveDefinition;return{a:[[...e],[...t],i,r]}}}class f{constructor(e,t,i,r){this.part=e,this.leftVertex=t,this.rightVertex=i,this.curveDefinition=r,this.type="elliptic-arc-7",t.rightSegment=this,i.leftSegment=this}toCurveOrCoordinate(){const e=this.rightVertex.pos,{centerPoint:t,sweep:i,orientation:r,rotation:n,semiMajorAxisLength:s,minorMajorAxisRatio:o}=this.curveDefinition;return{a:[[...e],t,i,r,n,s,o]}}}class d{constructor(e,t){this._spatialReference=e,this._viewingMode=t,this.vertices=[],this.segments=[],this.index=null}unnormalizeVertexPositions(){this.vertices.length<=1||c.unnormalize(this.vertices,c.getUnnormalizationInfo(this._spatialReference,this._viewingMode))}updateVertexIndex(e,t){const{vertices:i}=this;if(0===i.length)return;const r=i[0];let n=null,s=e,o=t;do{n=s,n.index=o++,s=n.rightSegment?n.rightSegment.rightVertex:null}while(null!=s&&s!==r);n.leftSegment&&n!==i[i.length-1]&&this.swapVertices(i.indexOf(n),i.length-1)}getFirstVertex(){return this.vertices.at(0)}getLastVertex(){return this.vertices.at(-1)}isClosed(){return null!==this.getFirstVertex()?.leftSegment}swapVertices(e,t){const{vertices:i}=this,r=i[e];i[e]=i[t],i[t]=r}*iterateVertices(){const e=this.getFirstVertex();let t=e;if(t)do{yield t,t=t.rightSegment?.rightVertex}while(t!==e&&null!=t)}}class m extends r.Evented{constructor(e,t){super(),this.type=e,this.coordinateHelper=t,this._geometry=null,this._dirty=!0,this.parts=[]}get geometry(){if(this._dirty){switch(this.type){case"point":this._geometry=this._toPoint();break;case"polyline":this._geometry=this._toPolyline();break;case"polygon":this._geometry=this._toPolygon();break;case"mesh":break;default:i.neverReached(this.type)}this._dirty=!1}return this._geometry}get spatialReference(){return this.coordinateHelper.spatialReference}get allVerticesUnordered(){return Array.from(this.iterateVerticesUnordered())}*iterateVerticesUnordered(){for(const e of this.parts)for(const t of e.vertices)yield t}get allVertices(){return Array.from(this.iterateVertices())}*iterateVertices(){for(const e of this.parts)yield*e.iterateVertices()}notifyChanges(e){this._dirty=!0,this.emit("change",e)}_toPoint(){const{parts:e,coordinateHelper:t}=this;return e.at(0)?.vertices.length?t.vectorToPoint(e[0].vertices[0].pos):null}_toPolyline(){const e=[];let t=!1;for(const i of this.parts){if(i.vertices.length<1)continue;const r=i.vertices[0],n=[];n.push(r.pos);let s=r.rightSegment;for(;s;)t||="line"!==s.type,n.push(s.toCurveOrCoordinate()),s=s.rightVertex.rightSegment;e.push(n)}return new s({paths:t?void 0:e,curvePaths:t?e:void 0,spatialReference:this.spatialReference,hasZ:this.coordinateHelper.hasZ(),hasM:this.coordinateHelper.hasM()})}_toPolygon(){const e=[];let t=!1;for(const i of this.parts){if(i.vertices.length<1)continue;const r=i.vertices[0],n=[];n.push(r.pos);let s=r.rightSegment;for(;s&&(t||="line"!==s.type,n.push(s.toCurveOrCoordinate()),s=s.rightVertex.rightSegment,s?.leftVertex!==r););e.push(n)}return new n({rings:t?void 0:e,curveRings:t?e:void 0,spatialReference:this.spatialReference,hasZ:this.coordinateHelper.hasZ(),hasM:this.coordinateHelper.hasM()})}static fromGeometry(e,i,r){const n=e.spatialReference,s=h.createCoordinateHelper(e.hasZ,e.hasM,n),c=new m(e.type,s);switch(e.type){case"polygon":!function(e,i,r,n){const s=i.spatialReference,h=e.coordinateHelper,{rings:c,curveRings:l}=i,a=l&&n?l:c;for(let i=0;i<a.length;++i){const n=a[i],c=new d(s,r);if(c.index=i,e.parts.push(c),n.length<1)continue;let l=null,g=null;for(let e=0;e<n.length-1;++e)g=v(c,h,g,n[e]),l??=g;n.length>1&&t.equals(o.getEndpoint(n[n.length-1]),l?.pos)?g&&l&&c.segments.push(y(c,g,l,n[n.length-1])):g=v(c,h,g,n[n.length-1])}}(c,e,i,r?.allowCurves??!1);break;case"polyline":!function(e,t,i,r){const n=t.spatialReference,s=e.coordinateHelper,{curvePaths:o,paths:h}=t,c=o&&r?o:h;for(let t=0;t<c.length;++t){const r=c[t],o=new d(n,i);if(o.index=t,e.parts.push(o),r.length<1)continue;let h=null;for(let e=0;e<r.length;++e)h=v(o,s,h,r[e])}}(c,e,i,r?.allowCurves??!1);break;case"point":x(c,e,i);break;case"mesh":x(c,e.origin,i),c._geometry=e,c._dirty=!1}return c}}function v(e,t,i,r){const n=new l(e);e.vertices.push(n);const s=o.getEndpoint(r);return n.pos=t.arrayToVector(s),n.index=e.vertices.length-1,i&&e.segments.push(y(e,i,n,r)),n}function y(e,t,i,r){if(o.isCoordinate(r))return new a(e,t,i);if(o.isBezierCurve(r)){const[,n,s]=r.b;return new g(e,t,i,{controlPoint1:[...n],controlPoint2:[...s]})}if(o.isCircularArc(r)){const[,n]=r.c;return new p(e,t,i,{interiorPoint:[...n]})}if(o.isEllipticArc4(r)){const[,n,s,o]=r.a;return new u(e,t,i,{centerPoint:[...n],sweep:s,orientation:o})}const[,n,s,h,c,l,d]=r.a;return new f(e,t,i,{centerPoint:[...n],sweep:s,orientation:h,rotation:c,semiMajorAxisLength:l,minorMajorAxisRatio:d})}function x(e,t,i){const r=t.spatialReference,n=e.coordinateHelper,s=new d(r,i);s.index=0;const o=new l(s);o.index=0,o.pos=n.pointToVector(t),s.vertices.push(o),e.parts.push(s)}e.BezierSegment=g,e.CircularArcSegment=p,e.EditGeometry=m,e.EllipticArc4Segment=u,e.EllipticArc7Segment=f,e.LineSegment=a,e.Part=d,e.Vertex=l,e.createConnectingSegment=y,e.isMeshEditGeometry=function(e){return"mesh"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});