/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"./config.js";import{id as r}from"./kernel.js";import t from"./core/Error.js";import{h as s,clone as n}from"./core/lang.js";import{g as o}from"./chunks/MapUtils.js";import{isAborted as a,onAbort as i,createAbortError as l,isAbortError as u}from"./core/promiseUtils.js";import{getOrigin as c,urlToObject as d,join as p,removeQueryParameters as f,removeTrailingSlash as h,Url as m,makeAbsolute as y,hasSameOrigin as g,i as w,changeHost as v,getAppUrl as b,queryToObject as q,isDataProtocol as S,isBlobProtocol as k,normalize as T,getInterceptor as C,isTrustedServer as O,toHTTPS as L,objectToQuery as j,getProxyRule as E,getProxyUrl as x,addQueryParameters as U,addProxyRule as A}from"./core/urlUtils.js";import{w as D}from"./chunks/persistableUrlUtils.js";import"./chunks/object.js";import"./chunks/Logger.js";import"./chunks/string.js";import"./chunks/jsonUtils.js";import"./chunks/handleUtils.js";import"./chunks/events.js";import"./chunks/maybe.js";const I={mapserver:"MapServer",imageserver:"ImageServer",featureserver:"FeatureServer",knowledgegraphserver:"KnowledgeGraphServer",sceneserver:"SceneServer",streamserver:"StreamServer",vectortileserver:"VectorTileServer","3dtilesserver":"3DTilesServer",videoserver:"VideoServer"},P=Object.values(I),R=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/rest\\/services\\/(.+?)\\/(${P.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),M=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/([^/\\n]+)\\/(${P.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),H=/(.*?)\/(?:layers\/)?(\d+)\/?$/i;function F(e){return R.test(e)}function N(e){if(null==e)return null;const r=d(e),t=r?.path.match(R)||r?.path.match(M);if(!t)return null;const[,s,n,o,a]=t,i=n.indexOf("/");return{title:$(-1!==i?n.slice(i+1):n),serverType:I[o.toLowerCase()],sublayer:null!=a&&""!==a?parseInt(a,10):null,url:{path:s}}}function _(e){const r=d(e).path.match(H);return r?{serviceUrl:r[1],sublayerId:Number(r[2])}:null}function $(e){return(e=e.replaceAll(/\s*[/_]+\s*/g," "))[0].toUpperCase()+e.slice(1)}function W(e,r){const t=[];if(e){const r=N(e);null!=r&&r.title&&t.push(r.title)}if(r){const e=$(r);t.push(e)}if(2===t.length){if(t[0].toLowerCase().includes(t[1].toLowerCase()))return t[0];if(t[1].toLowerCase().includes(t[0].toLowerCase()))return t[1]}return t.join(" - ")}function K(e){let r=c(e,!0);return!!r&&(r=r.toLowerCase(),r.endsWith(".arcgis.com")&&(r.startsWith("services")||r.startsWith("tiles")||r.startsWith("features")||/^[a-z\d-]+\.svcs[a-z\d-]*\./.test(r)))}function z(e,r){return e?h(f(e,r)):e}function B(e){let{url:r}=e;if(!r)return{url:r};r=f(r,e.logger);const t=d(r),s=N(t.path);let n;if(null!=s)null!=s.sublayer&&null==e.layer.layerId&&(n=s.sublayer),r=s.url.path;else if(e.nonStandardUrlAllowed){const e=_(t.path);null!=e&&(r=e.serviceUrl,n=e.sublayerId)}return{url:h(r),layerId:n}}function G(e,r,t,s,n){D(r,s,"url",n),s.url&&null!=e.layerId&&(s.url=p(s.url,t,e.layerId.toString()))}function Q(e){if(!e)return!1;const r=e.toLowerCase(),t=r.includes("/services/"),s=r.includes("/mapserver/wmsserver"),n=r.includes("/imageserver/wmsserver"),o=r.includes("/wmsserver");return t&&(s||n||o)}function J(e){if(!e)return!1;const r=new m(y(e)),t=r.authority?.toLowerCase();return"server.arcgisonline.com"===t||"services.arcgisonline.com"===t}const V=new Set(["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"]);function X(r){if(!ee(r))return null;const t=e=>e instanceof RegExp?e.test(r):"string"==typeof e&&r.startsWith(e),s=e.apiKeys;if(Array.isArray(s.scopes))for(const e of s.scopes)if(Array.isArray(e.urls)){if(e.urls.some(t))return e.token}else if(t(e.urls))return e.token;return s.basemapStyles&&/^https?:\/\/(i?basemaps|basemapstyles)-api\.arcgis\.com\//i.test(r)?s.basemapStyles:e.apiKey&&/^https?:\/\/.+\.arcgis\.com(\/|$)/i.test(r)?e.apiKey:null}function Y(){return null!=e.apiKey||null!=e.apiKeys.basemapStyles}function Z(e,r){return r?ee(e):null!=X(e)}function ee(e){const r=c(e,!0);return!!r&&!V.has(r)&&!e.endsWith("/sharing/rest/generateToken")}function re(e,r,t=!1,n){return new Promise((o,i)=>{if(a(n))return void i(te());let l=()=>{d(),i(new Error(`Unable to load ${r}`))},u=()=>{const r=e;d(),o(r)},c=()=>{if(!e)return;const r=e;d(),r.src="",i(te())};const d=()=>{s("esri-image-decode")||(e.removeEventListener("error",l),e.removeEventListener("load",u)),l=null,u=null,e=null,null!=n&&n.removeEventListener("abort",c),c=null,t&&URL.revokeObjectURL(r)};null!=n&&n.addEventListener("abort",c),s("esri-image-decode")?e.decode().then(u,l):(e.addEventListener("error",l),e.addEventListener("load",u))})}function te(){try{return new DOMException("Aborted","AbortError")}catch{const e=new Error;return e.name="AbortError",e}}const se="Timeout exceeded";function ne(e){return"object"==typeof e&&!!e&&"message"in e&&e.message===se}const oe=new Map;function ae(e){const r=N(e)?.url.path.toLowerCase();if(!r)return e;const t=oe.get(r);return t?v(e,t):e}async function ie(e,r){e instanceof URL&&(e=e.toString()),r?.query instanceof URLSearchParams&&(r.query=q(r.query.toString().replaceAll("+"," ")));const t=S(e),n=k(e);n||t||(e=T(e));const u={url:e,requestOptions:{...r}},d=e=>({data:e,getAllHeaders:me,getHeader:me,httpStatus:200,requestOptions:u.requestOptions,url:u.url}),p=C(e,ce.internalInterceptors);if(p){const e=await Se(p,u);if(null!=e)return d(e)}let f=C(e);if(f){const e=await Se(f,u);if(null!=e)return d(e);f.after||f.error||(f=null)}if(e=u.url,"image"===(r=u.requestOptions).responseType&&(s("host-webworker")||s("host-node")))throw we("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),u);if("head"===r.method){if(r.body)throw we("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),u);if(t||n)throw we("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),u)}if(await async function(){s("host-webworker")&&(!le&&globalThis.invokeStaticMessage?le=await import("./chunks/request.js"):ue=!0)}(),le)return le.execute(e,r);const h=new AbortController,m=i(r,()=>h.abort()),y={controller:h,credential:void 0,credentialToken:void 0,fetchOptions:void 0,hasToken:!1,interceptor:f,params:u,redoRequest:!1,useIdentity:ce.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},g=r.useRequestQueue?async function(e){const r=function(e){let r,t;return"string"==typeof e?(r=c(e,!0),t=K(e)):(r=e.origin,t=K(e.toString())),null==r?null:{origin:r,isHosted:t}}(e.params.url);if(!r)return Ce(e);const{QueueProcessor:t}=await import("./chunks/QueueProcessor.js"),n=o(Te,r.origin,()=>{const e=r.isHosted?s("request-queue-concurrency-hosted"):s("request-queue-concurrency-non-hosted");return new t({concurrency:e,process:e=>{if(a(e.params.requestOptions))throw we("",l("Request canceled"),e.params);return Ce(e)}})});return n.push(e)}(y):Ce(y),w=await g.finally(()=>m?.remove());return f?.after?.(w),w}let le,ue=!1;const ce=e.request,de="FormData"in globalThis,pe=new Set([499,498,403,401]),fe=new Set(["COM_0056","COM_0057","SB_0008"]),he=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],me=()=>null,ye=Symbol();function ge(e){const r=c(e);return!r||r.endsWith(".arcgis.com")||ie._corsServers.includes(r)||O(r)}function we(e,r,s,o){let a;const i={url:s.url,requestOptions:s.requestOptions,getAllHeaders:me,getHeader:me,ssl:!1};if(r instanceof t)return r.details?(r.details=n(r.details),r.details.url=s.url,r.details.requestOptions=s.requestOptions):r.details=i,r;if(r){const e=o&&(()=>Array.from(o.headers)),t=o&&(e=>o.headers.get(e)),s=o?.status,n=r.message;n&&(a=n),e&&t&&(i.getAllHeaders=e,i.getHeader=t),i.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||s||0,i.subCode=r.subcode,i.messageCode=r.messageCode,"string"==typeof r.details?(i.messages=[r.details],a??=r.details):(i.messages=r.details,a??=i.messages?.[0]),i.raw=ye in r?r[ye]:r}return a??="Error",u(r)?l():new t(e,a,i)}async function ve(){r||await import("./identity/IdentityManager.js")}function be(e){return he.some(r=>r.test(e))}async function qe(t){let n=t.params.url,o=ae(n);const a=t.params.requestOptions,i=t.fetchOptions??{},u=k(n)||S(n),p=a.responseType||"json",f=u?0:null!=a.timeout?a.timeout:ce.timeout;let h=!1;if(!u){t.useSSL&&(n=L(n));let l={...a.query};t.credentialToken&&(l.token=t.credentialToken);let u=j(l);s("esri-url-encodes-apostrophe")&&(u=u.replaceAll("'","%27"));const p=o.length+1+u.length;let f;h="delete"===a.method||"post"===a.method||"put"===a.method||!!a.body||p>ce.maxUrlLength;const m=a.useProxy||!!E(n);if(m){const e=x(n);f=e.path,!h&&f.length+1+p>ce.maxUrlLength&&(h=!0),e.query&&(l={...e.query,...l})}if("HEAD"===i.method&&(h||m)){if(h){if(p>ce.maxUrlLength)throw we("request:invalid-parameters",new Error("URL exceeds maximum length"),t.params);throw we("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),t.params)}if(m)throw we("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),t.params)}if(h?(i.method="delete"===a.method?"DELETE":"put"===a.method?"PUT":"POST",a.body?n=U(n,l):(i.body=j(l),i.headers||(i.headers={}),i.headers["Content-Type"]="application/x-www-form-urlencoded")):n=U(n,l),m&&(t.useProxy=!0,n=`${f}?${n}`),l.token&&de&&i.body instanceof FormData&&!w(n)&&i.body.set("token",l.token),a.hasOwnProperty("withCredentials"))t.withCredentials=a.withCredentials;else if(!g(n,b()))if(O(n))t.withCredentials=!0;else if(r){const e=r.findServerInfo(n);e?.webTierAuth&&(t.withCredentials=!0)}t.withCredentials&&(i.credentials="include",function(r){const t=e.request.crossOriginNoCorsDomains;if(t){let e=c(r);if(e)return e=e.toLowerCase(),!g(e,b())&&t[e]<Date.now()-36e5}return!1}(n)&&await async function(r){const t=d(r);r=t.path,"json"===t.query?.f&&(r+="?f=json");try{await fetch(r,{mode:"no-cors",credentials:"include"})}catch{}const s=e.request.crossOriginNoCorsDomains,n=c(r);s&&n&&(s[n.toLowerCase()]=Date.now())}(h?U(n,l):n)),o=ae(n)}let m,y,v=0,q=!1;f>0&&(v=setTimeout(()=>{q=!0,t.controller.abort()},f));try{if("native-request-init"===a.responseType)y=i,y.url=o,a.signal?y.signal=a.signal:delete y.signal;else if("image"!==a.responseType||"default"!==i.cache||"GET"!==i.method||h||function(e){if(e)for(const r of Object.getOwnPropertyNames(e))if(e[r])return!0;return!1}(a.headers)||!u&&!t.useProxy&&ce.proxyUrl&&!ge(n)){if(ie._beforeFetch&&await ie._beforeFetch(n,i),m=await fetch(o,i),ie._afterFetch&&await ie._afterFetch(m),t.useProxy||function(e){const r=c(e);r&&!ie._corsServers.includes(r)&&ie._corsServers.push(r)}(n),"native"===a.responseType)y=m;else if("HEAD"!==i.method)if(m.ok){switch(p){case"array-buffer":y=await m.arrayBuffer();break;case"blob":case"image":y=await m.blob();break;default:y=await m.text()}if(v&&(clearTimeout(v),v=0),"json"===p||"xml"===p||"document"===p)if(y)switch(p){case"json":y=JSON.parse(y);break;case"xml":y=ke(y,"application/xml");break;case"document":y=ke(y,"text/html")}else y=null;if(y){if("array-buffer"===p||"blob"===p){const e=m.headers.get("Content-Type");if(e&&/application\/json|text\/plain/i.test(e)&&y["blob"===p?"size":"byteLength"]<=750)try{const e=await new Response(y).json();e.error&&(y=e)}catch{}}"image"===p&&y instanceof Blob&&(y=await Le(URL.createObjectURL(y),t,!0))}}else{y=await m.text();try{y=JSON.parse(y)}catch{}}}else y=await Le(o,t)}catch(e){if("AbortError"===e.name){if(q)throw new Error(se);throw l("Request canceled")}if(!(!m&&e instanceof TypeError&&ce.proxyUrl)||a.body||"delete"===a.method||"head"===a.method||"post"===a.method||"put"===a.method||t.useProxy||ge(n))throw e;t.redoRequest=!0,A({proxyUrl:ce.proxyUrl,urlPrefix:c(n)??""})}finally{v&&clearTimeout(v)}return[m,y]}async function Se(e,r){if(null!=e.responseData)return e.responseData;if(e.headers&&(r.requestOptions.headers={...r.requestOptions.headers,...e.headers}),e.query&&(r.requestOptions.query={...r.requestOptions.query,...e.query}),e.before){let s,n;try{n=await e.before(r)}catch(e){s=we("request:interceptor",e,r)}if((n instanceof Error||n instanceof t)&&(s=we("request:interceptor",n,r)),s)throw e.error&&e.error(s),s;return n}}function ke(e,r){let t;try{t=(new DOMParser).parseFromString(e,r)}catch{}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}ie._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"],ie._beforeFetch=void 0,ie._afterFetch=void 0;const Te=new Map;async function Ce(t){let s,n;await async function(e){const t=e.params.url,s=e.params.requestOptions,n=e.controller.signal,o=s.body;let i=null,l=null;if(de&&"HTMLFormElement"in globalThis&&(o instanceof FormData?i=o:o instanceof HTMLFormElement&&(i=new FormData(o))),"string"==typeof o&&(l=o),e.fetchOptions={cache:s.cacheBust?"no-cache":"default",credentials:"same-origin",headers:s.headers||{},method:"head"===s.method?"HEAD":"GET",mode:"cors",priority:ce.priority,redirect:"follow",signal:n},(i||l)&&(e.fetchOptions.body=i||l),(ue||"anonymous"===s.authMode)&&(e.useIdentity=!1),e.hasToken=!!(/token=/i.test(t)||s.query?.token||i?.get("token")),!e.hasToken){const r=X(t);r&&(s.query??={},s.query.token=r,e.hasToken=!0)}if(e.useIdentity&&!e.hasToken&&!e.credential&&!e.credentialToken&&!be(t)&&!a(n)){let o;"immediate"===s.authMode?(await ve(),o=await r.getCredential(t,{signal:n})):"no-prompt"===s.authMode?(await ve(),o=await r.getCredential(t,{prompt:!1,signal:n}).catch(()=>{})):r&&(o=r.findCredential(t)),o&&(e.credential=o,e.credentialToken=o.token,e.useSSL=!!o.ssl)}}(t);try{do{[s,n]=await qe(t)}while(!await Oe(t,s,n))}catch(e){const r=we("request:server",e,t.params,s);throw r.details.ssl=t.useSSL,t.interceptor?.error&&t.interceptor.error(r),r}const o=t.params.url;if(n)if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(o)){if(!t.hasToken&&!t.credentialToken&&n.user?.username&&!O(o)){const e=c(o,!0);e&&ce.trustedServers.push(e)}Array.isArray(n.authorizedCrossOriginNoCorsDomains)&&function(r){e.request.crossOriginNoCorsDomains||(e.request.crossOriginNoCorsDomains={});const t=e.request.crossOriginNoCorsDomains;for(let e of r)e=e.toLowerCase(),/^https?:\/\//.test(e)?t[c(e)??""]=0:(t[c("http://"+e)??""]=0,t[c("https://"+e)??""]=0)}(n.authorizedCrossOriginNoCorsDomains)}else"json"===(t.params.requestOptions.responseType||"json")&&function(e,r){const t=r?.preferredHost;if(!t||g(e,`https://${t}`,!0))return;const s=N(e);if(!s||"FeatureServer"!==s.serverType||w(e))return;const n=s.url.path.toLowerCase();oe.has(n)||oe.set(n,t)}(o,n);const i=t.credential;if(i&&r){const e=r.findServerInfo(i.server);let t=e?.owningSystemUrl;if(t){t=t.replace(/\/?$/,"/sharing");const e=r.findCredential(t,i.userId);e&&-1===r._getIdenticalSvcIdx(t,e)&&e.resources.unshift(t)}}return{data:n,getAllHeaders:s?()=>Array.from(s.headers):me,getHeader:s?e=>s.headers.get(e):me,httpStatus:s?.status??200,requestOptions:t.params.requestOptions,ssl:t.useSSL,url:t.params.url}}async function Oe(e,t,s){if(e.redoRequest)return e.redoRequest=!1,!1;const n=e.params.requestOptions;if(!t||"native"===n.responseType||"native-request-init"===n.responseType)return!0;let o,a;if(s&&(s.error&&"object"==typeof s.error?o=s.error:"error"===s.status&&Array.isArray(s.messages)&&(o={...s},o[ye]=s,o.details=s.messages)),!o&&!t.ok)throw o=new Error(`Unable to load ${t.url} status: ${t.status}`),o[ye]=s,o;let i,l=null;o&&(a=Number(o.code),l=o.hasOwnProperty("subcode")?Number(o.subcode):null,i=o.messageCode,i=i?.toUpperCase());const u=n.authMode;if(403===a&&(4===l||o.message?.toLowerCase().includes("ssl")&&!o.message.toLowerCase().includes("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&("no-prompt"!==u||498===a)&&void 0!==a&&pe.has(a)&&!be(e.params.url)&&(403!==a||(!i||!fe.has(i))&&(null==l||2===l&&e.credentialToken))){await ve();try{const t=await r.getCredential(e.params.url,{error:we("request:server",o,e.params),credential:e.credential,prompt:"no-prompt"!==u,signal:e.controller.signal,token:e.credentialToken});return e.credential=t,e.credentialToken=t.token,e.useSSL=e.useSSL||t.ssl,!1}catch(r){if("no-prompt"===u)return e.credential=void 0,e.credentialToken=void 0,!1;o=r}}if(o)throw o;return!0}function Le(e,r,t=!1){const s=r.controller.signal,n=new Image;return r.withCredentials?n.crossOrigin="use-credentials":n.crossOrigin="anonymous",n.alt="",n.fetchPriority=ce.priority,n.src=e,re(n,e,t,s)}export{B as a,ee as b,$ as c,F as d,ie as default,J as e,Z as f,X as g,Y as h,K as i,_ as j,Q as k,re as l,ne as m,N as p,z as s,W as t,G as w};
