/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{i as t,clone as e}from"../core/lang.js";import{o as n}from"../chunks/timeUtils.js";import s from"../time/TimeExtent.js";import{i}from"../chunks/utils11.js";import{W as r}from"../chunks/tagSymbols.js";import"../chunks/date.js";import"../chunks/jsonMap.js";import"../chunks/object.js";import"../chunks/locale.js";import"../chunks/handleUtils.js";import"../chunks/constants.js";import"../chunks/datetime.js";import"../chunks/tslib.es6.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/string.js";import"../chunks/maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/utils.js";import"../chunks/tracking.js";import"../chunks/ensureType.js";import"../chunks/MapUtils.js";import"../chunks/Warning.js";import"../core/Error.js";import"../chunks/get.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../core/promiseUtils.js";import"../chunks/events.js";import"../chunks/SetUtils.js";import"../chunks/SimpleTrackingTarget.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../chunks/Version2.js";import"../chunks/Version.js";function o(t){return void 0!==t.timeInfo}async function u(e,n){if(0===e.length)return s.allTime;await Promise.all(e.map(t=>t.load({signal:n})));const i=e.filter(o),r=e.filter(t=>!o(t)&&null!=t.visibilityTimeExtent);if(0===i.length&&0===r.length)return s.allTime;const u=[],m=[];for(const t of i)"feature"!==t?.type&&"map-image"!==t?.type||!t.timeInfo?.hasLiveData?m.push(t):u.push(t);const l=t=>null==t||t.isAllTime,c=[...m.map(t=>{const e=t.timeInfo?.fullTimeExtent,{visibilityTimeExtent:n}=t;return e?.intersection(n)??n}),...r.map(t=>t.visibilityTimeExtent)];if(c.some(l))return s.allTime;const a=u.map(async t=>{const e=(await t.fetchRecomputedExtents({signal:n}))?.timeExtent??t.timeInfo?.fullTimeExtent,{visibilityTimeExtent:s}=t;return e?.intersection(s)??s}),p=(await Promise.allSettled(a)).map(t=>"fulfilled"===t.status?t.value:null);if(p.some(l))return s.allTime;const f=[...p,...c].filter(t);return 0===f.length?s.allTime:f.reduce((t,e)=>t.union(e))}async function m(t,n){if(!i(t)&&!function(t){return null!=t&&"object"==typeof t&&r in t}(t))return null;await t.load({signal:n});const o=t?.widgets?.timeSlider;if(!o)return null;const m=await async function(t,e){return t.widgets?.timeSlider?.fullTimeExtent??u(t.allLayers,e)}(t,n),l=o.loop,c=function(t){const e=t.numThumbs??2,n=t.currentTimeExtent;if(n){const{start:t,end:s}=n;return null!=t&&null!=s&&t.getTime()===s.getTime()?"instant":2===e?"time-window":null==t||0===t.getTime()?"cumulative-from-start":"cumulative-from-end"}return 2===e?"time-window":"cumulative-from-start"}(o),a=o.stopDelay??2e3,p=function(t){const{numStops:n,stopInterval:s,stops:i}=t;return i?{dates:e(i)}:s?{interval:s.clone()}:{count:n??5}}(o),f=function(t,e){const n=t.currentTimeExtent;if(!n)return null;const{start:i,end:r}=n,o=i??r??null;switch(e){case"time-window":return new s({start:i,end:r});case"cumulative-from-start":return new s({start:null,end:o});case"cumulative-from-end":return new s({start:o,end:null});case"instant":return new s({start:o,end:o})}}(o,c);return{fullTimeExtent:m,loop:l,mode:c,playRate:a,stops:p,timeExtent:f}}function l(t){if(!t)return t;const{start:e,end:i}=t;return new s({start:null!=e?n(e,-e.getTimezoneOffset(),"minutes"):e,end:null!=i?n(i,-i.getTimezoneOffset(),"minutes"):i})}function c(t){if(!t)return t;const{start:e,end:i}=t;return new s({start:null!=e?n(e,e.getTimezoneOffset(),"minutes"):e,end:null!=i?n(i,i.getTimezoneOffset(),"minutes"):i})}export{u as getTimeExtentFromLayers,m as getTimeSliderSettingsFromWebDocument,c as toLocalTimeExtent,l as toUTCTimeExtent};
