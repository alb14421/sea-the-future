/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../request.js";import{z as t,h as r}from"../core/lang.js";import o from"../core/Error.js";import{i as n}from"./mat4.js";import{c as s}from"./mat4f64.js";import{k as a,t as i,e as l}from"./vec3.js";import{b as c,c as u}from"./vec3f64.js";import{canProjectWithoutEngine as f}from"./projectionUtils.js";import p from"../geometry/SpatialReference.js";import{p as d}from"./projectVectorToVector.js";import{c as m,e as h,m as y,l as g}from"./aaBoundingRect.js";import{g as b}from"./sphere.js";import{f as w}from"./featurePopupQueryUtils.js";import v from"../rest/support/Query.js";import{r as M,g as x}from"./I3SBinaryReader.js";import{U as S}from"./unitUtils.js";import{c as R}from"./computeTranslationToOriginAndRotation.js";import{c as I,p as j,a as T}from"./symbolColorUtils.js";import{O as k,c as U}from"./orientedBoundingBox.js";import{e as W}from"./Emissions.glsl.js";import{s as C}from"./layerViewUtils.js";function A(e,t,r,o,n){const a="east-north-up"===r?c(e):function(e,t,r){const o=u(),n=e[3],s=2**(Math.ceil(Math.log(n)*Math.LOG2E/K)*K+G);if(r.isGeographic){const t=s/S(r).radius*180/Math.PI,n=Math.round(e[1]/t),a=Math.max(-90,Math.min(90,n*t)),i=t/Math.cos((Math.abs(a)-t/2)/180*Math.PI),l=Math.round(e[0]/i)*i;o[0]=l,o[1]=a}else{const t=Math.round(e[0]/s),r=Math.round(e[1]/s);o[0]=t*s,o[1]=r*s}const a=e[2]+t,i=Math.round(a/s);return o[2]=i*s,o}(e,t,o),i=s();return R(o,a,i,n),i}const G=1,K=5-G;function L(e){return e?parseInt(e.slice(e.lastIndexOf("/")+1),10):void 0}function q(e){if(r("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes?.encoding)return!0;return!1}function O(e,t,r,o){r.traverse(t,t=>{const r=t.serviceMbsInIndexSR;return 0!==(null!=r&&z(e,r))&&(o(t),!0)})}function P(e,t,r){let o=0,n=0;for(let s=0;s<t.length&&o<e.length;s++)e[o]===t[s]&&(r(s)&&(e[n]=e[o],n++),o++);e.length=n}function F(e,r,o){let n=0,s=0;for(;n<o.length;)t(e,o[n])>=0===r&&(o[s]=o[n],s++),n++;o.length=s}function B(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return E[0]=(e[0]-t.position[0])/t.rotationScale[0],E[1]=(e[1]-t.position[1])/t.rotationScale[4],E[2]=(e[2]-t.position[0])/t.rotationScale[0],E[3]=(e[3]-t.position[1])/t.rotationScale[4],E}const E=m();function z(e,t){const r=t[0],o=t[1],n=t[3],s=e[0]-r,a=r-e[2],i=e[1]-o,l=o-e[3],c=Math.max(s,a,0),u=Math.max(i,l,0),f=c*c+u*u;return f>n*n?0:f>0?1:-Math.max(s,a,i,l)>n?3:2}function V(e,t,r){const o=[],n=r?.missingFields,s=r?.originalFields;let a=!1;for(const r of e){const e=t.get(r);e?(s?.push(r),o.push(e.name),r!==e.name&&(a=!0)):n?.push(r)}return r&&"hasMismatchedCasing"in r&&(r.hasMismatchedCasing=a),o}async function $(e,t,r,n,s,a){if(0===t.length)return[];const i=e.attributeStorageInfo;if(null!=e.associatedLayer)try{return await async function(e,t,r,o){const n=[],s={hasMismatchedCasing:!1,originalFields:n},a=V(r,e.fieldsIndex,s),i=new v({outFields:[...a]});if(await w(e,t,i,{updateSourceAttributes:!0,...o}),!s.hasMismatchedCasing)return t;for(let e=0;e<t.length;e++){const r=t[e];if(r.attributes)for(let e=0;e<n.length;e++){const t=n[e],o=a[e];o in r.attributes&&(r.attributes[t]=r.attributes[o],delete r.attributes[o])}}return t}(e.associatedLayer,t,n,a)}catch(t){if(e.associatedLayer.loaded)throw t}if(i){const o=function({globalIdField:e},t,r,o){const n=new Map,s=[],a=o();for(const o of t){const t=o.attributes?.[r],i=null==t?o.getGlobalId():void 0;for(let r=0;r<a.length;r++){const l=a[r],c=Q(l,t,e,i);if(c<0)continue;let u=n.get(l.node);u||(u={node:l.node,indices:[],graphics:[]},s.push(u),n.set(l.node,u)),u.indices.push(c),u.graphics.push(o);for(let e=r;e>0;e--)a[e]=a[e-1];a[0]=l;break}}return s}(e,t,r,s),l=e.parsedUrl.path;return await Promise.allSettled(o.map(t=>function(e,t,r,o,n,s,a,i){return D(e,t,r.resources.attributes,o,n,s,a,i)}(l,i,t.node,t.indices,n,e.apiKey,e.customParameters,a).then(e=>{for(let r=0;r<t.graphics.length;r++){const o=t.graphics[r],n=e[r];if(o.attributes)for(const e in o.attributes)e in n||(n[e]=o.attributes[e]);o.attributes=n}}))),t}throw new o("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function Q(e,t,r,o){if(null!=t&&"number"==typeof t)return e.featureIds.indexOf(t);if(null==o||null==r)return-1;const n=e.attributeInfo?.attributeData?.[r];return n?n.indexOf(o):-1}async function D(t,r,o,n,s,a,i,l){const c=[];for(const e of r)if(e&&s.includes(e.name)){const r=`${t}/nodes/${o}/attributes/${e.key}/0`;c.push({url:r,storageInfo:e})}const u=await Promise.allSettled(c.map(t=>e(t.url,{responseType:"array-buffer",query:{...i,token:a},signal:l?.signal}).then(e=>M(t.storageInfo,e.data)))),f=[];for(const e of n){const t={};for(let r=0;r<u.length;r++){const o=u[r];if("fulfilled"===o.status){const n=o.value;t[c[r].storageInfo.name]=x(n,e)}}f.push(t)}return f}function Z(e){const t=e.store,r=t.indexCRS||t.geographicCRS,n=void 0===r?t.indexWKT:void 0;if(n){if(!e.spatialReference)throw new o("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new o("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const s=r?new p(L(r)):e.spatialReference;return s.equals(e.spatialReference)?e.spatialReference:s}function H(e){const t=e.store,r=t.vertexCRS||t.projectedCRS,n=void 0===r?t.vertexWKT:void 0;if(n){if(!e.spatialReference)throw new o("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new o("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const s=r?new p(L(r)):e.spatialReference;return s.equals(e.spatialReference)?e.spatialReference:s}function J(e,t,r){if(!f(e,t))throw C("scene layer",e?.wkid,t?.wkid);if("local"===r&&!function(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}(e,t))throw C("scene layer",e?.wkid,t?.wkid)}function N(e,t,r){if(e.serviceUpdateTimeStamp?.lastUpdate!==t.serviceUpdateTimeStamp?.lastUpdate||!r.isEmpty||e.associatedLayer?.url!==t.associatedLayer?.url)throw new o("layerview:recycle-failed","Could not recycle layerview")}function X(e,t,r){const o=Z(e),n=H(e);J(o,t,r),J(n,t,r)}function Y(e){if(null==e.store?.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes?.position)throw new o("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t}function _(e,t){X(e,t.spatialReference,t.viewingMode)}function ee(e){if(null==e.store?.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes?.position)throw new o("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t}function te(e,t){J(e.spatialReference,t.spatialReference,t.viewingMode)}function re(e){return"mesh-3d"===e.type}function oe(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.symbols;if(0===t.length)return!0;for(const e of t){if(!re(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||null==t.material?.color||"replace"!==t.material.colorMixMode)return!0}return!1}const ne=I({color:[0,0,0,0],opacity:0});class se{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function ae(e){const t=new se;let r=!1,o=!1;for(const n of e.symbolLayers.items)if("fill"===n.type&&n.enabled){const e=n.material,s=n.edges;if(null!=e&&!r){const o=e.color,s=j(e.colorMixMode),a={strength:e.emissive?.strength??W,source:"color"===e.emissive?.source?1:0};t.material=null!=o?{color:[o.r/255,o.g/255,o.b/255],alpha:o.a,colorMixMode:s,emissive:a}:{color:[1,1,1],alpha:1,colorMixMode:1,emissive:a},t.castShadows=n.castShadows,r=!0}null==s||o||(t.edgeMaterial=T(s,{}),o=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1,emissive:{strength:W,source:0}}),t}function ie(e,t){return(0|e)+(0|t)|0}function le(e,t,r,o,s,c,u){if(!c||0===c.length||null==t||!e.serviceMbsInIndexSR)return null;const f=A(e.serviceMbsInIndexSR,s,"none",r,t);n(ge,f);let p=null,m=1/0,w=-1/0;if(c.forEach(n=>(n=>{if("replace"!==n.type)return;const c=n.geometry;if(!c?.hasZ)return;h(pe);const f=c.spatialReference||o,v=c.rings.reduce((e,r)=>r.reduce((e,r)=>(a(he,r[0],r[1],r[2]),d(he,f,he,t),i(he,he,ge),y(pe,he),Math.min(he[2],e)),e),1/0);(()=>{if(!p)if(p=fe,h(de),null!=e.serviceObbInIndexSR){e.serviceObbInIndexSR.transform(me,r,t,s,u),me.getCorners(p);for(const e of p)i(e,e,ge),y(de,e)}else{const o=e.serviceMbsInIndexSR;if(!o)return;const n=o[3];d(b(o),r,he,t),i(he,he,ge),he[2]+=s;for(let e=0;e<8;++e){const t=1&e?n:-n,r=2&e?n:-n,o=4&e?n:-n,s=p[e];l(s,[he[0]+t,he[1]+r,he[2]+o]),y(de,s)}}})(),g(de,pe)&&(m=Math.min(m,v),w=Math.max(w,v))})(n)),m===1/0)return null;const v=(e,t,r)=>{i(he,r,f),e[t]=he[0],e[t+1]=he[1],e[t+2]=he[2],t+=24,r[2]=m,i(he,r,f),e[t]=he[0],e[t+1]=he[1],e[t+2]=he[2],t+=24,r[2]=w,i(he,r,f),e[t]=he[0],e[t+1]=he[1],e[t+2]=he[2]};for(let e=0;e<8;++e)v(ye.data,3*e,p[e]);return U(ye)}function ce(e){return e[3]>=0}function ue(e){null!=e&&(e[3]=-1)}const fe=[u(),u(),u(),u(),u(),u(),u(),u()],pe=m(),de=m(),me=new k,he=u(),ye={data:new Array(72),size:3,exclusive:!0,stride:3},ge=s();export{V as a,X as b,N as c,q as d,J as e,P as f,Z as g,ie as h,ue as i,ce as j,z as k,H as l,O as m,ee as n,F as o,te as p,D as q,oe as r,Y as s,_ as t,le as u,A as v,$ as w,ae as x,ne as y,B as z};
