/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{t as e,n as t}from"./arcadeEnvironment.js";import{N as r,R as n,I as o,p as a,j as i,q as s,r as l,s as c,v as u,t as p,u as f,w as m,x as w,y as d,z as h,c as y,d as g,f as b,b as j,A as v,S,B as x,C as F}from"./languageUtils.js";import{a as k,c as O,A as I,r as M,b as C,d as R,e as A,f as U,g as N,h as E,i as B,j as P,k as G,l as D,m as L}from"./arcade.js";import{D as z}from"./Dictionary.js";import{A as K,e as Z}from"./enum.js";import{F as _}from"./Feature.js";import{A as T}from"./aiServices.js";import{registerFunctions as q}from"./geomasync.js";import"../core/lang.js";import{L as W}from"./Logger.js";import V from"../geometry/Geometry.js";import Q from"../geometry/SpatialReference.js";import{d as H,e as J,c as Y,b as $,a as X}from"./guards.js";import"../config.js";import"./object.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"./jsonUtils.js";import"./TimeOnly.js";import"./string.js";import"./UnknownTimeZone.js";import"./datetime.js";import"./locale.js";import"./handleUtils.js";import"../geometry/Extent.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./MapUtils.js";import"./get.js";import"./utils.js";import"./metadata.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./tracking.js";import"./Warning.js";import"../geometry/Point.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./events.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"../core/accessorSupport/decorators/cast.js";import"./reader.js";import"./writer.js";import"./unitUtils.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"../request.js";import"./persistableUrlUtils.js";import"../geometry/support/webMercatorUtils.js";import"./ImmutableArray.js";import"./shared2.js";import"../layers/support/Field.js";import"../core/JSONSupport.js";import"./enumeration.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./number2.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"../geometry/Polyline.js";import"../geometry/support/jsonUtils.js";import"./deepClone.js";import"../core/sql/WhereClause.js";import"./streamLayerUtils.js";import"./unitConversion.js";import"./hash.js";import"./uuid.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"./featureConversionUtils.js";import"./aaBoundingBox.js";import"./DoubleArray.js";import"./OptimizedFeature.js";import"./memoryEstimations.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"./createFeatureId.js";import"../layers/support/FieldsIndex.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./constants.js";import"./timeZoneUtils.js";import"./utils9.js";import"./commonProperties3.js";import"./portalUtils.js";import"./operatorsWorkerConnection.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"./SimpleObservable.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"./date.js";import"./number.js";import"./substitute.js";import"./messages.js";import"./utils12.js";const ee=()=>W.getLogger("esri.arcade.arcadeAsyncRuntime"),te=Symbol("uninitialized");function re(e){if(e===te)throw new K(null,"InvalidIdentifier",null)}function ne(e){return re(e),e}function oe(t,r){const n=e(r);if(null!==t.localScope){const e=t.localScope[n];if(void 0!==e)return{scope:t.localScope,id:n,var:e}}const o=t.globalScope[n];if(void 0!==o)return{scope:t.globalScope,id:n,var:o};throw new K(t,"InvalidIdentifier",r)}function ae(t,r,n="InvalidIdentifier"){const o=e(r);if(null!==t.localScope){const e=t.localScope[o];if(void 0!==e)return re(e),e.value}const a=t.globalScope[o];if(void 0!==a)return re(a),a.value;throw new K(t,n,r)}const ie=function(){};async function se(e,t){const r=[];for(let n=0;n<t.arguments.length;n++)r.push(await me(e,t.arguments[n]));return r}async function le(e,t,r){return!0===t.preparsed?r(e,null,t.arguments):r(e,t,await se(e,t))}ie.prototype=Object.freeze(Object.create(null));class ce extends x{constructor(e,t,r,n){super(),this.definition=e,this.context=t,this._params=r,this._locals=n}createFunction(e){return(...t)=>{const r={spatialReference:this.context.spatialReference,console:this.context.console,lrucache:this.context.lrucache,timeZone:this.context.timeZone??null,exports:this.context.exports,libraryResolver:this.context.libraryResolver,interceptor:this.context.interceptor,services:this.context.services,abortSignal:this.context.abortSignal,localScope:new ie,depthCounter:{depth:e.depthCounter.depth+1},globalScope:this.context.globalScope,track:this.context.track};if(r.depthCounter.depth>64)throw new K(e,"MaximumCallDepth",null);return ue(r,this.definition.body,this._params,this._locals,t,null)}}call(e,t){return fe(e,t,(r,n,o)=>{const a={spatialReference:e.spatialReference,services:e.services,console:e.console,libraryResolver:e.libraryResolver,exports:e.exports,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,localScope:new ie,abortSignal:e.abortSignal,globalScope:e.globalScope,depthCounter:{depth:e.depthCounter.depth+1},track:e.track};if(a.depthCounter.depth>64)throw new K(e,"MaximumCallDepth",t);return ue(a,this.definition.body,this._params,this._locals,o,t)})}marshalledCall(e,t,r,n){return n(e,t,async(o,a,s)=>{const l={spatialReference:e.spatialReference,services:e.services,globalScope:r.globalScope,depthCounter:{depth:e.depthCounter.depth+1},libraryResolver:e.libraryResolver,exports:e.exports,console:e.console,abortSignal:e.abortSignal,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,localScope:new ie,track:e.track};return s=s.map(t=>!i(t)||t instanceof S?t:F(t,e,n)),F(await ue(l,this.definition.body,this._params,this._locals,s,t),r,n)})}}async function ue(e,t,r,a,i,c){if(r.length!==i.length)throw new K(e,"WrongNumberOfParameters",c);if(null!=e.localScope){for(let t=0;t<r.length;t++)e.localScope[r[t]]={value:i[t]};for(const t of a)e.localScope[t]=te}const u=await we(e,t);if(u instanceof n)return u.value;if(u===s)throw new K(e,"UnexpectedToken",c);if(u===l)throw new K(e,"UnexpectedToken",c);return u instanceof o?u.value:u}class pe extends v{constructor(e){super(),this.moduleGlobalContext=e}global(t){const r=e(t),n=this.moduleGlobalContext.globalScope[r];if(re(n),i(n.value)&&!(n.value instanceof S)){const e=new S;return e.fn=n.value,e.parameterEvaluator=le,e.context=this.moduleGlobalContext,this.moduleGlobalContext.globalScope[r]={value:e},e}return n.value}setGlobal(t,r){if(i(r))throw new K(null,"AssignModuleFunction",null);const n=e(t);if(void 0===this.moduleGlobalContext.globalScope[n])throw new K(null,"ModuleExportNotFound",null);this.moduleGlobalContext.globalScope[n]={value:r}}hasGlobal(t){return this.moduleGlobalContext.exports.has(e(t))}static async load(e,r){const{globals:n,exports:o}=O(r),a=new Ce;for(const e of n)e in a||(a[e]=te);const i=e.spatialReference??Q.WebMercator,s={lrucache:e.lrucache,interceptor:e.interceptor,services:e.services,console:e.console??Ae,abortSignal:e.abortSignal??t,timeZone:e.timeZone??null,spatialReference:i,track:null,depthCounter:{depth:1},libraryResolver:new I(e.libraryResolver._moduleSingletons,r.loadedModules),exports:o,localScope:null,globalScope:a};return await be(s,r),new pe(s)}}async function fe(e,t,r){return!0===t.preparsed?r(e,null,t.arguments):r(e,t,await se(e,t))}async function me(e,t){t.breakpoint&&await t.breakpoint();try{switch(t.type){case"UpdateExpression":return await async function(e,t){const r=t.argument;if("CallExpression"===r.type)throw new K(e,"NeverReach",t);if("MemberExpression"===r.type){const n=await me(e,r.object);let o,a;if(!0===r.computed)o=await me(e,r.property);else{if("Identifier"!==r.property.type)throw new K(e,"Unrecognized",t);o=r.property.name}if($(n)){if(!X(o))throw new K(e,"ArrayAccessMustBeNumber",t);if(o<0&&(o=n.length+o),o<0||o>=n.length)throw new K(e,"OutOfBounds",t);a=f(n[o]),n[o]="++"===t.operator?a+1:a-1}else if(n instanceof z){if(!1===Y(o))throw new K(e,"KeyAccessorMustBeString",t);if(!0!==n.hasField(o))throw new K(e,"FieldNotFound",t,{key:o});a=f(n.field(o)),n.setField(o,"++"===t.operator?a+1:a-1)}else if(n instanceof pe){if(!1===Y(o))throw new K(e,"ModuleAccessorMustBeString",t);if(!0!==n.hasGlobal(o))throw new K(e,"ModuleExportNotFound",t);a=f(n.global(o)),n.setGlobal(o,"++"===t.operator?a+1:a-1)}else{if(!g(n))throw y(n)?new K(e,"Immutable",t):new K(e,"InvalidParameter",t);if(!1===Y(o))throw new K(e,"KeyAccessorMustBeString",t);if(!0!==n.hasField(o))throw new K(e,"FieldNotFound",t,{key:o});a=f(n.field(o)),n.setField(o,"++"===t.operator?a+1:a-1)}return!1===t.prefix?a:"++"===t.operator?a+1:a-1}const n=oe(e,r),o=f(ne(n.var).value),a="++"===t.operator?o+1:o-1;return n.scope[n.id]={value:a},!1===t.prefix?o:"++"===t.operator?o+1:o-1}(e,t);case"AssignmentExpression":return await async function(e,t){const r=t.left;if("MemberExpression"===r.type){const n=await me(e,r.object);let o;if(!0===r.computed)o=await me(e,r.property);else{if("Identifier"!==r.property.type)throw new K(e,"InvalidIdentifier",t);o=r.property.name}const a=await me(e,t.right);if($(n)){if(!X(o))throw new K(e,"ArrayAccessMustBeNumber",t);if(o<0&&(o=n.length+o),o<0||o>n.length)throw new K(e,"OutOfBounds",t);if(o===n.length){if("="!==t.operator)throw new K(e,"OutOfBounds",t);n[o]=ge(a,t.operator,n[o],t,e)}else n[o]=ge(a,t.operator,n[o],t,e)}else if(n instanceof z){if(!1===Y(o))throw new K(e,"KeyAccessorMustBeString",t);if(!0===n.hasField(o))n.setField(o,ge(a,t.operator,n.field(o),t,e));else{if("="!==t.operator)throw new K(e,"FieldNotFound",t,{key:o});n.setField(o,ge(a,t.operator,null,t,e))}}else if(n instanceof pe){if(!1===Y(o))throw new K(e,"KeyAccessorMustBeString",t);if(!0!==n.hasGlobal(o))throw new K(e,"ModuleExportNotFound",t);n.setGlobal(o,ge(a,t.operator,n.global(o),t,e))}else{if(!g(n))throw y(n)?new K(e,"Immutable",t):new K(e,"InvalidParameter",t);if(!1===Y(o))throw new K(e,"KeyAccessorMustBeString",t);if(!0===n.hasField(o))n.setField(o,ge(a,t.operator,n.field(o),t,e));else{if("="!==t.operator)throw new K(e,"FieldNotFound",t,{key:o});n.setField(o,ge(a,t.operator,null,t,e))}}return u}const n=oe(e,r),o=await me(e,t.right);return n.scope[n.id]={value:ge(o,t.operator,"="!==t.operator?ne(n.var).value:null,t,e)},u}(e,t);case"TemplateLiteral":return await async function(e,t){let r="",n=0;for(const o of t.quasis)if(r+=o.value?o.value.cooked:"",!1===o.tail){if(t.expressions[n]){const o=await me(e,t.expressions[n]);if(i(o))throw new K(e,"NoFunctionInTemplateLiteral",t);r+=m(o)}n++}return r}(e,t);case"Identifier":return Se(e,t);case"MemberExpression":return await async function(e,t){const r=await me(e,t.object);if(null===r)throw new K(e,"MemberOfNull",t);if(!1===t.computed){if("Identifier"===t.property.type){if(r instanceof z||h(r))return r.field(t.property.name);if(r instanceof V)return P(r,t.property.name,e,t);if(r instanceof pe){if(!r.hasGlobal(t.property.name))throw new K(e,"InvalidIdentifier",t);return r.global(t.property.name)}throw new K(e,"InvalidMemberAccessKey",t)}throw new K(e,"InvalidMemberAccessKey",t)}let n=await me(e,t.property);if(r instanceof z||h(r)){if(Y(n))return r.field(n);throw new K(e,"InvalidMemberAccessKey",t)}if(r instanceof pe){if(Y(n))return r.global(n);throw new K(e,"InvalidMemberAccessKey",t)}if(r instanceof V){if(Y(n))return P(r,n,e,t);throw new K(e,"InvalidMemberAccessKey",t)}if($(r)){if(X(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=r.length+n),n>=r.length||n<0)throw new K(e,"OutOfBounds",t);return r[n]}throw new K(e,"InvalidMemberAccessKey",t)}if(y(r)){if(X(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=r.length()+n),n>=r.length()||n<0)throw new K(e,"OutOfBounds",t);return r.get(n)}throw new K(e,"InvalidMemberAccessKey",t)}if(Y(r)){if(X(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=r.length+n),n>=r.length||n<0)throw new K(e,"OutOfBounds",t);return r[n]}throw new K(e,"InvalidMemberAccessKey",t)}throw new K(e,"InvalidMemberAccessKey",t)}(e,t);case"Literal":return t.value;case"CallExpression":return await async function(e,t){if("MemberExpression"===t.callee.type){const r=await me(e,t.callee.object);if(!(r instanceof pe))throw new K(e,"FunctionNotFound",t);const n=!1===t.callee.computed?t.callee.property.name:await me(e,t.callee.property);if(!r.hasGlobal(n))throw new K(e,"FunctionNotFound",t);const o=r.global(n);if(!i(o))throw new K(e,"CallNonFunction",t);return o.call(e,t)}if("Identifier"!==t.callee.type)throw new K(e,"FunctionNotFound",t);const r=ae(e,t.callee,"FunctionNotFound");if(i(r))return r.call(e,t);throw new K(e,"CallNonFunction",t)}(e,t);case"UnaryExpression":return await async function(e,t){const r=await me(e,t.argument);if(J(r)){if("!"===t.operator)return!r;if("-"===t.operator)return-1*f(r);if("+"===t.operator)return 1*f(r);if("~"===t.operator)return~f(r);throw new K(e,"UnsupportUnaryOperator",t)}if("-"===t.operator)return-1*f(r);if("+"===t.operator)return 1*f(r);if("~"===t.operator)return~f(r);throw new K(e,"UnsupportUnaryOperator",t)}(e,t);case"BinaryExpression":return await async function(e,t){const r=await me(e,t.left),n=await me(e,t.right);switch(t.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":return d(f(r),f(n),t.operator);case"==":return p(r,n);case"!=":return!p(r,n);case"<":case">":case"<=":case">=":return w(r,n,t.operator);case"+":return Y(r)||Y(n)?m(r)+m(n):f(r)+f(n);case"-":return f(r)-f(n);case"*":return f(r)*f(n);case"/":return f(r)/f(n);case"%":return f(r)%f(n);default:throw new K(e,"UnsupportedOperator",t)}}(e,t);case"LogicalExpression":return await async function(e,t){const r=await me(e,t.left);if(!J(r))throw new K(e,"LogicalExpressionOnlyBoolean",t);switch(t.operator){case"||":{if(!0===r)return r;const n=await me(e,t.right);if(J(n))return n;throw new K(e,"LogicExpressionOrAnd",t)}case"&&":{if(!1===r)return r;const n=await me(e,t.right);if(J(n))return n;throw new K(e,"LogicExpressionOrAnd",t)}default:throw new K(e,"LogicExpressionOrAnd",t)}}(e,t);case"ArrayExpression":return await async function(e,t){const r=[];for(let n=0;n<t.elements.length;n++)r.push(await me(e,t.elements[n]));for(let n=0;n<r.length;n++){if(i(r[n]))throw new K(e,"NoFunctionInArray",t);r[n]===u&&(r[n]=null)}return r}(e,t);case"ObjectExpression":return await async function(e,t){const r=[];for(let n=0;n<t.properties.length;n++){const o=t.properties[n],a=await me(e,o.value),i="Identifier"===o.key.type?o.key.name:await me(e,o.key);r[n]={key:i,value:a}}const n=Object.create(null),o=new Map;for(let a=0;a<r.length;a++){const s=r[a];if(i(s.value))throw new K(e,"NoFunctionInDictionary",t);if(!1===Y(s.key))throw new K(e,"KeyMustBeString",t);let l=s.key.toString();const c=l.toLowerCase();o.has(c)?l=o.get(c):o.set(c,l),s.value===u?n[l]=null:n[l]=s.value}const a=new z(n);return a.immutable=!1,a}(e,t);default:throw new K(e,"Unrecognized",t)}}catch(r){throw Z(e,t,r)}}async function we(t,r){r.breakpoint&&await r.breakpoint();try{switch(r.type){case"ImportDeclaration":return await async function(e,t){const r=oe(e,t.specifiers[0].local),n=e.libraryResolver;if(null==n)throw ee().error("Internal error: module loader not initialized"),new K(e,"NeverReach",t);const o=n.loadLibrary(r.id);let a;return n._moduleSingletons?.has(o.uri)?a=n._moduleSingletons.get(o.uri):(a=await pe.load(e,o.syntax),n._moduleSingletons?.set(o.uri,a)),r.scope[r.id]={value:a},u}(t,r);case"ExportNamedDeclaration":return await async function(e,t){return await we(e,t.declaration),u}(t,r);case"VariableDeclaration":return await async function(e,t){for(const r of t.declarations)await ve(e,r);return u}(t,r);case"BlockStatement":return await be(t,r);case"FunctionDeclaration":return await async function(t,r){if(null!=t.localScope)throw ee().error("Function declarations are only valid in global scope."),new K(t,"NeverReach",r);const n=e(r.id);if(!(n in t.globalScope))throw ee().error(`Function "${n}" not declared.`),new K(t,"NeverReach",r);const o=D(r),a=r.params.map(t=>e(t)),i=Array.from(o).filter(e=>!a.includes(e));return t.globalScope[n]={value:new ce(r,t,a,i)},u}(t,r);case"ReturnStatement":return await async function(e,t){if(null===t.argument)return new n(u);const r=await me(e,t.argument);return new n(r)}(t,r);case"IfStatement":return await async function(e,t){const r=await me(e,t.test);if(!0===r)return we(e,t.consequent);if(!1===r)return null!==t.alternate?we(e,t.alternate):u;throw new K(e,"BooleanConditionRequired",t)}(t,r);case"ExpressionStatement":return await async function(e,t){const r=await me(e,t.expression);return r===u?u:new o(r)}(t,r);case"ForStatement":return await async function(e,t){try{for(null!==t.init&&("VariableDeclaration"===t.init.type?await we(e,t.init):await me(e,t.init));;){if(null!==t.test){const r=await me(e,t.test);if(!0===e.abortSignal?.aborted)throw new K(e,"Cancelled",t);if(!1===r)break;if(!0!==r)throw new K(e,"BooleanConditionRequired",t)}const r=await we(e,t.body);if(r===s)break;if(r instanceof n)return r;null!==t.update&&await me(e,t.update)}return u}catch(e){throw e}}(t,r);case"WhileStatement":return await async function(e,t){let r=await me(e,t.test);if(!1===r)return u;if(!0!==r)throw new K(e,"BooleanConditionRequired",t);for(;!0===r;){const o=await we(e,t.body);if(o===s)break;if(o instanceof n)return o;if(r=await me(e,t.test),!0!==r&&!1!==r)throw new K(e,"BooleanConditionRequired",t)}return u}(t,r);case"ForInStatement":return await async function(e,t){const r=await me(e,t.right);"VariableDeclaration"===t.left.type&&await we(e,t.left);const n=oe(e,"VariableDeclaration"===t.left.type?t.left.declarations[0].id:t.left);return $(r)||Y(r)?await de(e,t,r,n):y(r)?await he(e,t,r,n):r instanceof z||h(r)?await de(e,t,r.keys(),n,"k"):b(r)?await ye(e,t,r,n):j(r)?await de(e,t,G(r),n,"k"):u}(t,r);case"ForOfStatement":return await async function(e,t){const r=await me(e,t.right);"VariableDeclaration"===t.left.type&&await we(e,t.left);const o=oe(e,"VariableDeclaration"===t.left.type?t.left.declarations[0].id:t.left);return $(r)||Y(r)?await de(e,t,r,o,"k"):y(r)?await he(e,t,r,o,"k"):r instanceof z||h(r)?await async function(e,t,r,o){for(const a of r.keys()){const i=r.field(a);o.scope[o.id]={value:z.containerEntry(a,i)};const l=await we(e,t.body);if(l===s)break;if(l instanceof n)return l}return u}(e,t,r,o):b(r)?await ye(e,t,r,o):j(r)?await async function(e,t,r,o){for(const a of G(r)){const i=P(r,a,e,t,1);o.scope[o.id]={value:z.containerEntry(a,i)};const l=await we(e,t.body);if(l===s)break;if(l instanceof n)return l}return u}(e,t,r,o):u}(t,r);case"BreakStatement":return s;case"EmptyStatement":return u;case"ContinueStatement":return l;default:throw new K(t,"Unrecognized",r)}}catch(e){throw Z(t,r,e)}}async function de(e,t,r,o,a="i"){const i=r.length;for(let l=0;l<i;l++){if("k"===a){if(l>=r.length)throw new K(e,"OutOfBounds",t);o.scope[o.id]={value:r[l]}}else o.scope[o.id]={value:l};const i=await we(e,t.body);if(i===s)break;if(i instanceof n)return i}return u}async function he(e,t,r,o,a="i"){const i=r.length();for(let l=0;l<i;l++){o.scope[o.id]="k"===a?{value:r.get(l)}:{value:l};const i=await we(e,t.body);if(i===s)break;if(i instanceof n)return i}return u}async function ye(e,t,r,o){const a=r.iterator(e.abortSignal);let i;for(;null!=(i=await a.next());){const a=_.createFromGraphicLikeObject(i.geometry,i.attributes,r,e.timeZone);a._underlyingGraphic=i,o.scope[o.id]={value:a};const l=await we(e,t.body);if(l===s)break;if(l instanceof n)return l}return u}function ge(e,t,r,n,o){switch(t){case"=":return e===u?null:e;case"/=":return f(r)/f(e);case"*=":return f(r)*f(e);case"-=":return f(r)-f(e);case"+=":return Y(r)||Y(e)?m(r)+m(e):f(r)+f(e);case"%=":return f(r)%f(e);default:throw new K(o,"UnsupportedOperator",n)}}async function be(e,t){return je(e,t,0)}async function je(e,t,r){if(r>=t.body.length)return u;const o=await we(e,t.body[r]);return o instanceof n||o===s||o===l||r===t.body.length-1?o:je(e,t,r+1)}async function ve(e,t){let r=null;r=null===t.init?null:await me(e,t.init),r===u&&(r=null);const n=oe(e,t.id);n.scope[n.id]={value:r}}function Se(e,t){return ae(e,t)}async function xe(e,t){c(null===t.arguments?[]:t.arguments,3,3,e,t);const r=await me(e,t.arguments[0]);if(!1===J(r))throw new K(e,"BooleanConditionRequired",t);return me(e,r?t.arguments[1]:t.arguments[2])}async function Fe(e,t){c(null===t.arguments?[]:t.arguments,2,3,e,t);const r=await me(e,t.arguments[0]);if(3===t.arguments.length){const n=await me(e,t.arguments[1]),o=B(r,n);return null!=o&&""!==o?o:me(e,t.arguments[2])}return null==r||""===r?me(e,t.arguments[1]):r}async function ke(e,t){if(t.arguments.length<2)throw new K(e,"WrongNumberOfParameters",t);if(2===t.arguments.length)return me(e,t.arguments[1]);if((t.arguments.length-1)%2==0)throw new K(e,"WrongNumberOfParameters",t);return Oe(e,t,1,await me(e,t.arguments[0]))}async function Oe(e,t,r,n){const o=await me(e,t.arguments[r]);if(p(o,n))return me(e,t.arguments[r+1]);const a=t.arguments.length-r;return 1===a?me(e,t.arguments[r]):2===a?null:3===a?me(e,t.arguments[r+2]):Oe(e,t,r+2,n)}async function Ie(e,t){if(t.arguments.length<3)throw new K(e,"WrongNumberOfParameters",t);if(t.arguments.length%2==0)throw new K(e,"WrongNumberOfParameters",t);const r=await me(e,t.arguments[0]);if(!1===J(r))throw new K(e,"BooleanConditionRequired",t.arguments[0]);return Me(e,t,0,r)}async function Me(e,t,r,n){if(!0===n)return me(e,t.arguments[r+1]);if(3===t.arguments.length-r)return me(e,t.arguments[r+2]);const o=await me(e,t.arguments[r+2]);if(!1===J(o))throw new K(e,"ModuleExportNotFound",t.arguments[r+2]);return Me(e,t,r+2,o)}const Ce=function(){const e=Object.create(null);M(e,le),C(e,le),R(e,le,Se),A(e,le),U(e,le),N(e,le),E(e,le),q({functions:e,compiled:!1,signatures:null,evaluateIdentifier:null,mode:"async",standardFunction:le,standardFunctionAsync:fe}),e.iif=xe,e.defaultvalue=Fe,e.decode=ke,e.when=Ie;const t=function(){this.textformatting={value:z.textFormatting()}};(t.prototype=Object.create(null)).infinity=Object.freeze({value:Number.POSITIVE_INFINITY}),t.prototype.pi=Object.freeze({value:Math.PI});for(const[n,o]of Object.entries(e))t.prototype[n]=Object.freeze({value:new r(o)});return t}();function Re(e){const t={mode:"async",compiled:!1,functions:Object.create(null),signatures:[],standardFunction:le,standardFunctionAsync:fe,evaluateIdentifier:Se};for(let r=0;r<e.length;r++)e[r].registerFunctions(t);for(const[e,n]of Object.entries(t.functions))Ce.prototype[e]=Object.freeze({value:new r(n)});for(let e=0;e<t.signatures.length;e++)k(t.signatures[e],"async")}function Ae(e){console.log(e)}function Ue(c,u){const p=new Set(Object.keys(u?.vars||{}).map(t=>e(t))),f=new Set(Object.keys(u?.customfunctions||{}).map(t=>e(t))),{globals:m,exports:w}=O(c);return async e=>{const u=e.spatialReference??Q.WebMercator;let d=null;c.usesModules&&(d=new I(new Map,c.loadedModules));const h=new Ce;for(const t of f)null!=e.customfunctions&&t in e.customfunctions?h[t]={value:new r(e.customfunctions[t])}:h[t]=te;for(const t of p){if(null==e.vars||!(t in e.vars)){t in h||(h[t]=te);continue}const r=e.vars[t]??null;H(r)?h[t]={value:_.createFromGraphic(r,e.timeZone??null)}:h[t]={value:r}}for(const e of m)e in h||(h[e]=te);const y={lrucache:e.lrucache,interceptor:e.interceptor,services:e.services,console:e.console??Ae,abortSignal:e.abortSignal??t,timeZone:e.timeZone??null,spatialReference:u,track:e.track,depthCounter:{depth:1},libraryResolver:d,exports:w,localScope:null,globalScope:h},g=await be(y,c);if(g instanceof n||g instanceof o){const e=g.value;if(a(e))return null;if(i(e))throw new K(y,"IllegalResult",null);return e}if(a(g))return null;if(g===s)throw new K(y,"IllegalResult",null);if(g===l)throw new K(y,"IllegalResult",null);throw new K(y,"NeverReach",null)}}function Ne(e,t){return Ue(e,t)(t)}Re([L]),Re([T]);export{Ne as executeScript,Re as extend,Ue as prepareScript};
