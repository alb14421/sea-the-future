/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{id as t}from"../kernel.js";import{a as e}from"./asyncUtils.js";import n from"../core/Error.js";import{J as r}from"./jsonMap.js";import{parseWhereClause as s}from"../core/sql.js";import{n as o}from"./uuid.js";import{c as i}from"../core/accessorSupport/decorators/subclass.js";import a,{C as u}from"../layers/support/CodedValueDomain.js";import{q as c}from"./featureQueryAll.js";import{isStringField as l,isIntegerField as p}from"../layers/support/fieldUtils.js";import{h as d,j as f}from"./layerUtils.js";import y from"../renderers/SimpleRenderer.js";import m from"../renderers/UniqueValueRenderer.js";import h from"../rest/support/AttachmentQuery.js";import{normalizationTypeJsonMap as w}from"../rest/support/NormalizationBinParametersMixin.js";import b from"../rest/support/Query.js";import g from"../rest/support/RelationshipQuery.js";import{s as I}from"./typeUtils2.js";const j=new r({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});async function F(t,e,r,s){const o=await J(t);if(await x(t,e,s),!o.addAttachment)throw new n(s,"Layer source does not support addAttachment capability");return o.addAttachment(e,r)}function x(t,e,r){const{attributes:s}=e,{objectIdField:o}=t;return t.capabilities?.data?.supportsAttachment?e?s?o&&s[o]?Promise.resolve():Promise.reject(new n(r,`feature is missing the identifying attribute ${o}`)):Promise.reject(new n(r,"'attributes' are required on a feature to query attachments")):Promise.reject(new n(r,"A feature is required to add/delete/update attachments")):Promise.reject(new n(r,"this layer doesn't support attachments"))}async function q(t,e,r,s,o){const i=await J(t);if(await x(t,e,o),!i.updateAttachment)throw new n(o,"Layer source does not support updateAttachment capability");return i.updateAttachment(e,r,s)}async function P(t,e,n){const{applyEdits:r}=await import("./editingSupport.js"),s=await t.load();let o=n;return"feature"===s.type&&s.infoFor3D&&null!=e.deleteFeatures&&null!=s.globalIdField&&(o={...o,globalIdToObjectId:await et(s,e.deleteFeatures,s.globalIdField)}),r(s,s.source,e,n)}async function v(t,e,n){const{uploadAssets:r}=await import("./editingSupport.js"),s=await t.load();return r(s,s.source,e,n)}async function S(t,e,r,s){const o=await J(t);if(await x(t,e,s),!o.deleteAttachments)throw new n(s,"Layer source does not support deleteAttachments capability");return o.deleteAttachments(e,r)}async function A(t,e,r){const s=(await t.load({signal:e?.signal})).source;if(!s.fetchRecomputedExtents)throw new n(r,"Layer source does not support fetchUpdates capability");return s.fetchRecomputedExtents(e)}async function O(t,e,r,s){e=h.from(e),await t.load();const o=t.source,i=t.capabilities;if(!i?.data?.supportsAttachment)throw new n(s,"this layer doesn't support attachments");const{attachmentTypes:a,objectIds:u,globalIds:c,num:l,size:p,start:d,where:f}=e;if(!i?.operations?.supportsQueryAttachments&&(a?.length>0||c?.length>0||p?.length>0||l||d||f))throw new n(s,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",e);if(!(u?.length||c?.length||f))throw new n(s,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",e);if(!o.queryAttachments)throw new n(s,"Layer source does not support queryAttachments capability",e);return!i?.attachment?.supportsOrderByFields&&e.orderByFields?.length&&((e=e.clone()).orderByFields=null),o.queryAttachments(e)}async function L(t,e,r,s){const o=await J(t);if(!o.queryObjectIds)throw new n(s,"Layer source does not support queryObjectIds capability");return o.queryObjectIds(b.from(e)??t.createQuery(),r)}async function E(t,e,r,s){const o=await J(t);if(!o.queryFeatureCount)throw new n(s,"Layer source does not support queryFeatureCount capability");return o.queryFeatureCount(b.from(e)??t.createQuery(),r)}async function D(t,e,r,s){const o=await J(t);if(!o.queryExtent)throw new n(s,"Layer source does not support queryExtent capability");return o.queryExtent(b.from(e)??t.createQuery(),r)}async function C(t,e,r,s){const o=await J(t);if(!o.queryRelatedFeatures)throw new n(s,"Layer source does not support queryRelatedFeatures capability");return o.queryRelatedFeatures(g.from(e),r)}async function T(t,e,r,s){const o=await J(t);if(!o.queryRelatedFeaturesCount)throw new n(s,"Layer source does not support queryRelatedFeaturesCount capability");return o.queryRelatedFeaturesCount(g.from(e),r)}async function B(t){const e=t.source;if(e?.refresh)try{const{dataChanged:n,updates:r}=await e.refresh();if(null!=r&&(t.sourceJSON={...t.sourceJSON,...r},t.read(r,{origin:"service",url:t.parsedUrl})),n)return!0}catch{}if(t.definitionExpression)try{return(await s(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}function R(t){const e=new b;e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,e.outFields=["*"],e.multipatchOption="multipatch"===t.geometryType?"xyFootprint":null;const n=t.capabilities?.query;n&&(e.compactGeometryEnabled=n.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=n.supportsDefaultSpatialReference);const r=t.capabilities?.data;r?.supportsZ&&null!=t.returnZ&&(e.returnZ=t.returnZ),r?.supportsM&&null!=t.returnM&&(e.returnM=t.returnM);const{timeOffset:s,timeExtent:o}=t;return e.timeExtent=null!=s&&null!=o?o.offset(-s.value,s.unit):o||null,e}function k(t){const{globalIdField:e,fields:n}=t;if(e)return e;if(n)for(const t of n)if("esriFieldTypeGlobalID"===t.type)return t.name}function M(t){const{objectIdField:e,fields:n}=t;if(e)return e;if(n)for(const t of n)if("esriFieldTypeOID"===t.type)return t.name}function z(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}function N(t,e,n,r){const s=n?.feature,o=!!t.subtypes?.length;if(o&&!n?.excludeImpliedDomains){const n=Q(t,e);if(n)return n}const i=o&&G(t,s);if(i){const t=i?.domains?.[e];return"inherited"===t?.type?r:t}const a=nt(t.types,t.typeIdField,s);if(a){const t=a.domains&&a.domains[e];if(t&&"inherited"!==t?.type)return t}if(r)return r;if(!n?.excludeImpliedDomains){const n=U(t,e);if(n)return n}return null}function G(t,e){const{subtypes:n,subtypeField:r}=t;if(!e?.attributes||!n?.length||!r)return null;const s=e.attributes[r];return null==s?null:n.find(t=>t.code===s)}function Q(t,e){const{fieldsIndex:n,subtypeField:r}=t,{name:s,type:o}=n.get(e)??{};if(!s)return null;if((r&&n.get(r)?.name)===s&&t.subtypes?.length){const e=t.subtypes.map(t=>new u({code:V(t.code,o),name:t.name}));if(e?.length)return new a({codedValues:e})}return null}function U(t,e){const{fieldsIndex:n}=t,{name:r,type:s}=n.get(e)??{};if(!r)return null;if(("typeIdField"in t?n.get(t.typeIdField)?.name:null)===r&&"types"in t&&t.types?.length){const e=t.types.map(t=>new u({code:V(t.id,s),name:t.name}));return new a({codedValues:e})}return null}function V(t,e){return e?l({type:e})&&"number"==typeof t?`${t}`:p({type:e})&&"string"==typeof t?Number.parseInt(t,10):t:t}async function J(t){return(await t.load()).source}async function $(e,n){if(!t)return;const r=t.findCredential(e);if(r)return r.userId;let s;try{const r=await d(e,n);r&&(s=await t.checkSignInStatus(`${r}/sharing`))}catch(t){}return s?s.userId:null}async function H(e,n){if(!t)return;if(t.findCredential(e))return;let r;try{const s=await d(e,n);s&&(r=await t.checkSignInStatus(`${s}/sharing`))}catch(t){}if(r)try{const r=null!=n?n.signal:null;await t.getCredential(e,{signal:r})}catch(t){}}async function Z(t,e,n){const r=t.parsedUrl?.path;r&&t.authenticationTriggerEvent===e&&await H(r,n)}async function W(t){const e=t.parsedUrl?.path;e&&function(t){return function(t){return!(!f(t)||!t.capabilities?.query.supportsCurrentUser)}(t)&&("serviceDefinitionExpression"in t&&_(t.serviceDefinitionExpression)||"definitionExpression"in t&&_(t.definitionExpression))}(t)&&await H(e)}function _(t){return!!t?.toLowerCase().includes("current_user")}function K(t){return!rt(t)&&(t.userHasUpdateItemPrivileges||t.editingEnabled)}const X=i({types:I});function Y(t,e){if(t.defaultSymbol)return t.types?.length?new m({defaultSymbol:X(t.defaultSymbol,t,e),field:t.typeIdField,uniqueValueInfos:t.types.map(t=>({id:t.id,symbol:X(t.symbol,t,e)}))}):new y({symbol:X(t.defaultSymbol,t,e)})}function tt(t){let e=t.sourceJSON?.cacheMaxAge;if(!e)return!1;const n=t.editingInfo?.lastEditDate?.getTime();return null==n||(e*=1e3,Date.now()-n<e)}async function et(t,n,r){if(null==n)return null;const s=[],{objectIdField:i}=t;if(n.forEach(t=>{let e=null;if("attributes"in t){const{attributes:n}=t;e={globalId:n[r],objectId:null!=n[i]&&-1!==n[i]?n[i]:null}}else e={globalId:t.globalId,objectId:null!=t.objectId&&-1!==t.objectId?t.objectId:null};null!=e.globalId&&(null!=e.objectId&&-1!==e.objectId||s.push(e.globalId))}),0===s.length)return null;const a=t.createQuery();a.where=s.map(t=>`${r}='${t}'`).join(" OR "),a.returnGeometry=!1,a.outFields=[i,r],a.cacheHint=!1;const u=await e(c(t,a));if(!u.ok)return null;const l=new Map,p=u.value.features;for(const t of p){const e=t.attributes[r],n=t.attributes[i];null!=e&&null!=n&&-1!==n&&l.set(o(e),n)}return l}function nt(t,e,n){if(!e||!n||!t)return null;const r=n.getAttribute(e);return null==r?null:t.find(t=>{const{id:e}=t;return null!=e&&e.toString()===r.toString()})??null}function rt(t){return t.sourceJSON?.isMultiServicesView||function(t){return!!t.sourceJSON?.capabilities?.toLowerCase().split(",").map(t=>t.trim()).includes("map")}(t)}function st(t,e,r){const s=e?.queryAttributeBins;if(!e?.operations?.supportsQueryBins||!s)throw new n(r,"Layer source does not support binning");switch(t.binParameters.type){case"auto-interval":if(!s.supportsAutoInterval)throw new n(r,"Layer source does not support auto-interval binning");if(t.binParameters.normalizationType&&(!s.supportsNormalization||!ot(t.binParameters.normalizationType,s.supportedNormalizationTypes)))throw new n(r,"Layer source does not support normalization binning");break;case"date":if(!s.supportsDate)throw new n(r,"Layer source does not support date binning");if(t.binParameters.snapToData&&!s.supportsSnapToData)throw new n(r,"Layer source does not support snapToData binning");if(t.binParameters.returnFullIntervalBin&&!s.supportsReturnFullIntervalBin)throw new n(r,"Layer source does not support returnFullIntervalBin binning");break;case"fixed-boundaries":if(!s.supportsFixedBoundaries)throw new n(r,"Layer source does not support fixed-boundaries binning");break;case"fixed-interval":if(!s.supportsFixedInterval)throw new n(r,"Layer source does not support fixed-interval binning");if(t.binParameters.normalizationType&&(!s.supportsNormalization||!ot(t.binParameters.normalizationType,s.supportedNormalizationTypes)))throw new n(r,"Layer source does not support normalization binning")}if(t.binParameters.stackBy&&!s.supportsStackBy)throw new n(r,"Layer source does not support stackBy binning");if(t.binParameters.splitBy&&!s.supportsSplitBy)throw new n(r,"Layer source does not support splitBy binning");if(t.binParameters.firstDayOfWeek&&!s.supportsFirstDayOfWeek)throw new n(r,"Layer source does not support firstDayOfWeek binning");const o=s?.supportedStatistics;if(t.outStatistics&&o){const e=new Map([["count","count"],["sum","sum"],["min","min"],["max","max"],["avg","avg"],["stddev","stddev"],["var","var"],["percentile-continuous","percentileContinuous"],["percentile-discrete","percentileDiscrete"],["centroid-aggregate","centroid"],["convex-hull-aggregate","convexHull"],["envelope-aggregate","envelope"]]);for(const{statisticType:s}of t.outStatistics){const t=e.get(s);if(t&&!o[t])throw new n(r,`Layer source does not support ${s} statistic type`)}}}function ot(t,e){return null!=t&&!!e?.[w.toJSON(t)]}export{j as A,_ as B,tt as C,rt as D,z as E,$ as F,et as G,W as H,Z as a,P as b,Y as c,nt as d,H as e,K as f,N as g,B as h,F as i,R as j,S as k,A as l,Q as m,G as n,L as o,E as p,O as q,D as r,C as s,T as t,q as u,st as v,U as w,k as x,M as y,v as z};
