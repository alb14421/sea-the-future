/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../Graphic.js";import t from"../core/Error.js";import{L as o}from"./Logger.js";import{g as r}from"./MapUtils.js";import{isPromiseLike as i}from"../core/promiseUtils.js";import{a as n}from"./uuid.js";import{c as a,d as s,f as l,e as p}from"./templateUtils2.js";import u from"../geometry/Extent.js";import c from"../geometry/Multipoint.js";import d from"../geometry/Point.js";import m from"../geometry/Polygon.js";import f from"../geometry/Polyline.js";import{a as y}from"./layerUtils.js";import{isPoint as g}from"../geometry/support/jsonUtils.js";import{g as h}from"./networkFieldUtils.js";const b=100;function w(e){return"point"===e.type}function I(e){return"polygon"===e.type}function T(e){return"polyline"===e.type}function j(e){return!!e&&"radial"===e.type}function A(e){let t=null;for(const o of e)if(o.graphic.geometry){const e=o.graphic.geometry,r=w(e)?new u({spatialReference:e.spatialReference,xmin:e.x,xmax:e.x,ymax:e.y,ymin:e.y}):e.extent;t=null==t?r?.clone():t.union(r.extent)}return t}function G(e){const t=new Map;for(const o of e)r(t,o.id,()=>({addFeatures:[],id:o.id,identifierFields:{globalIdField:o.layer.globalIdField,objectIdField:o.layer.objectIdField}})).addFeatures?.push(o.graphic);return[...t.values()]}function P({edits:o,geometry:r,relationships:i,tag:s="",template:l}){if(j(r)){const e=r.geometry.clone();for(const t of e.paths)P({geometry:new f({spatialReference:e.spatialReference,paths:[t],hasZ:e.hasZ,hasM:e.hasM}),template:l,edits:o,relationships:i,tag:s});return}const{definition:p,layer:u}=l;r=function(e,t){if(!e)return null;if(e.hasZ===t.hasZ&&e.hasM===t.hasM)return e;switch(e.type){case"point":return new d({spatialReference:e.spatialReference,x:e.x,y:e.y,...t.hasZ?e.hasZ?{z:e.z}:{z:k(t)}:{},...t.hasM?e.hasM?{m:e.m}:{m:x(t)}:{}});case"polygon":return new m({spatialReference:e.spatialReference,rings:M(e.rings,t.hasZ,t.hasM,k(t),x(t),e.hasM?e.hasZ?3:2:-1,e.hasZ?2:-1),hasZ:t.hasZ,hasM:t.hasM});case"polyline":return new f({spatialReference:e.spatialReference,paths:M(e.paths,t.hasZ,t.hasM,k(t),x(t),e.hasM?e.hasZ?3:2:-1,e.hasZ?2:-1),hasZ:t.hasZ,hasM:t.hasM});case"multipoint":return new c({spatialReference:e.spatialReference,hasZ:t.hasZ,hasM:t.hasM,points:S(e.points,t.hasZ,t.hasM,k(t),x(t),e.hasM?e.hasZ?3:2:-1,e.hasZ?2:-1)});default:return e}}(r,u);const y=new e({attributes:p.defaultValues?{...p.defaultValues}:{},geometry:r,sourceLayer:u});if(L(y,u),u.globalIdField&&(y.attributes[u.globalIdField]=n()),o.push({id:u.layerId,graphic:y,tag:s,layer:u}),0!==p.relationships.length)for(const r of p.relationships||[]){const s=r.template;if(null==r.relationshipMetadata||!a(s))throw new t("shared-template:missing-relationship-metadata-or-definition","Relationship part must have metadata and a fully loaded template with definition");const{layer:l}=s,u=new e({attributes:{...p.defaultValues},sourceLayer:l});L(u,l),l.globalIdField&&(u.attributes[l.globalIdField]=n()),o.push({graphic:u,id:l.layerId,tag:"",layer:l}),i.push({...r.relationshipMetadata,sourceGraphic:y,destinationGraphic:u})}}function M(e,t,o,r,i,n,a){const s=[];for(const l of e)s.push(S(l,t,o,r,i,n,a));return s}function S(e,t,o,r,i,n,a){const s=[];for(const l of e){const e=[l[0],l[1]];t&&(e[2]=a>-1?l[2]:r),o&&(e[t?3:2]=n>-1?l[n]:i),s.push(e)}return s}function k(e){return e.capabilities.editing?.zDefault??0}function x(e){return e.capabilities.editing.supportsUpdateWithoutM?void 0:0}function L(e,t){y(t)&&(e.sourceLayer=t.findSublayerForFeature(e))}const F={"buffer-line-to-polygon":()=>import("./bufferLineToPolygon.js"),"buffer-point-to-polygon":()=>import("./bufferPointToPolygon.js"),"buffer-polygon-to-polygon":()=>import("./bufferPolygonToPolygon.js"),"connection-point":()=>import("./connectionPoint.js"),"equally-spaced":()=>import("./equallySpaced.js"),"offset-line":()=>import("./offsetLine.js"),"offset-primary-line":()=>import("./offsetPrimaryLine.js"),"point-at-all-vertices-of-line":()=>import("./pointAtAllVerticesOfLine.js"),"point-at-beginning-of-line":()=>import("./pointAtBeginningOfLine.js"),"point-at-beginning-of-radial":()=>import("./pointAtBeginningOfRadial.js"),"point-at-end-of-line":()=>import("./pointAtEndOfLine.js"),"point-at-interior-vertices":()=>import("./pointAtInteriorVertices.js"),"point-at-intersection-vertices-of-line":()=>import("./pointAtIntersectionVerticesOfLine.js"),"point-at-not-beginning-of-line":()=>import("./pointAtNotBeginningOfLine.js"),"point-at-not-end-of-line":()=>import("./pointAtNotEndOfLine.js"),"point-at-polygon-centroid":()=>import("./pointAtPolygonCentroid.js"),"point-at-polygon-not-start":()=>import("./pointAtPolygonNotStart.js"),"point-at-polygon-start":()=>import("./pointAtPolygonStart.js"),"point-identity":()=>import("./pointIdentity.js"),"point-primary-identity":()=>import("./pointPrimaryIdentity.js"),"polygon-boundary":()=>import("./polygonBoundary.js"),"polygon-boundary-two-point":()=>import("./polygonBoundaryTwoPoint.js"),"polygon-identity":()=>import("./polygonIdentity.js"),"polygon-primary-identity":()=>import("./polygonPrimaryIdentity.js"),"polygon-vertices":()=>import("./polygonVertices.js"),"radial-lines":()=>import("./radialLines.js"),"two-point-lines":()=>import("./twoPointLines.js")},Z=()=>o.getLogger("esri.editing.sharedTemplates.executor.createTemplateExecutor"),N="globalid";async function R(e){const t=await function(e){const t=F[e];if(!t)throw new Error(`Builder type ${e} is not supported.`);return t()}(e.builderType);return o=>t.execute({...o,templatePart:e})}function v(t,o,r){const{associationGraphics:i,associationsTable:a,edits:s,utilityNetworkHelper:l,relationships:p}=r,u=l.findAgat(t.graphic,t.layer),c=l.findAgat(o.graphic,o.layer);if(!u||!c)return;const d=l.findRules(u).map(e=>e.fromNetworkSource?.sourceId!==u.networkSourceId||e.fromAssetGroup?.assetGroupCode!==u.assetGroup||null!==e.fromAssetType?.assetTypeCode&&e.fromAssetType?.assetTypeCode!==u.assetType||e.toNetworkSource.sourceId!==c.networkSourceId||e.toAssetGroup?.assetGroupCode!==c.assetGroup||null!==e.toAssetType&&e.toAssetType?.assetTypeCode!==c.assetType?e.toNetworkSource.sourceId!==u.networkSourceId||e.toAssetGroup?.assetGroupCode!==u.assetGroup||null!==e.toAssetType&&e.toAssetType?.assetTypeCode!==u.assetType||e.fromNetworkSource.sourceId!==c.networkSourceId||e.fromAssetGroup?.assetGroupCode!==c.assetGroup||null!==e.fromAssetType?.assetTypeCode&&e.fromAssetType?.assetTypeCode!==c.assetType?null:{rule:e,from:{agat:c,item:o},to:{agat:u,item:t}}:{rule:e,from:{agat:u,item:t},to:{agat:c,item:o}}).filter(e=>4===e?.rule.ruleType||5===e?.rule.ruleType||2===e?.rule.ruleType?null:e).filter(e=>null!==e);if(0===d.length)return;const m=h(a),f=new Set;for(const t of d){const o={};o[m.fromNetworkSourceId]=t.rule.fromNetworkSource.sourceId,o[m.fromGlobalId]=t.from.item.graphic.attributes[t.from.item.layer.globalIdField??N],o[m.fromTerminalId]=null,t.rule.fromTerminal&&(o[m.fromTerminalId]=t.rule.fromTerminal.terminalId),o[m.toNetworkSourceId]=t.rule.toNetworkSource.sourceId,o[m.toGlobalId]=t.to.item.graphic.attributes[t.to.item.layer.globalIdField??N],o[m.toTerminalId]=null,t.rule.toTerminal&&(o[m.toTerminalId]=t.rule.toTerminal.terminalId),o[m.associationType]=t.rule.ruleType,o[m.percentAlong]=null,o[m.isContentVisible]=2===t.rule.ruleType?1:0,o[m.status]=0,o[m.globalId]=n();const r=`${o[m.fromNetworkSourceId]}-${o[m.fromGlobalId]}-${o[m.toNetworkSourceId]}-${o[m.toGlobalId]}-${o[m.associationType]}`;if(f.has(r))continue;f.add(r);const l=new e({attributes:o,sourceLayer:a});i.add(l),s.push({id:a.layerId,graphic:l,tag:"",layer:a}),p.push({sourceGraphic:t.to.item.graphic,sourceLayerId:t.to.item.layer.layerId,destinationGraphic:l,destinationLayerId:a.layerId,sourceField:t.to.item.layer.globalIdField??N,destinationField:m.toGlobalId??N}),p.push({sourceGraphic:t.from.item.graphic,sourceLayerId:t.from.item.layer.layerId,destinationGraphic:l,destinationLayerId:a.layerId,sourceField:t.from.item.layer.globalIdField??N,destinationField:m.fromGlobalId??N})}}const C=Object.freeze(Object.defineProperty({__proto__:null,createTemplateExecutor:async function(e){if(!a(e))throw new t("template-executor:template-not-loaded","The template must be loaded before it can be executed.");if(s(e))return function(e){return t=>{const o=[],r=[];P({geometry:t,template:e,edits:o,relationships:r});const i=A(o);return{edits:G(o),relationships:r,primary:o[0]??null,featureExtent:i,rotationPoint:i?.center??null}}}(e);if(l(e))return async function(e){const{definition:t}=e,o=await Promise.all(t.allParts.map(R));return(n,a)=>{const s=[],l=[],p=new Set,u=()=>{if(t.createUtilityNetworkAssociations&&"completion"===a){const{utilityNetwork:e,utilityNetworkAssociationsTable:o}=t;e&&o?function(e){const{edits:t,utilityNetworkHelper:o}=e,i=new Map;for(const e of t)""!==e.tag&&o.layerIdToSourceIdLookup.has(e.id)&&r(i,e.tag,()=>[]).push(e);for(const t of i.values())if(!(t.length<2))for(let o=0;o<t.length;o++){const r=t[o];for(let i=o+1;i<t.length;i++)v(r,t[i],e)}}({associationGraphics:p,associationsTable:o,edits:s,relationships:l,utilityNetworkHelper:e}):Z().warn("Unable to create utility network associations between group template features. The utility network or its associations table is unavailable.")}const e=A(s);return{associationGraphics:p,edits:G(s),relationships:l,primary:s[0]??null,featureExtent:e,rotationPoint:e?.center??null}};if(null==n)return Z().warn("No geometry provided to group template executor. Result will be empty."),u();const c=o.map(t=>t({edits:s,mode:a,parentTemplate:e,relationships:l,shape:n})).filter(i);return 0===c.length?u():Promise.all(c).then(()=>u())}}(e);if(p(e))return async function(e){const{createPresetServiceEdit:o}=await import("./createPresetServiceEdit.js");return(r,i,n=0)=>{if(!g(r))throw new t("template-executor:invalid-input-geometry","The input geometry for a preset template must be a point.");const a=[],s=[],l=o({geometry:r,template:e,edits:a,relationships:s,rotation:n,mode:i});return{edits:G(a),relationships:s,primary:a[0]??null,featureExtent:A(a),rotationPoint:l}}}(e);throw new t("template-executor:unsupported-template-type","The template type is not supported.")}},Symbol.toStringTag,{value:"Module"}));export{w as a,I as b,P as c,j as d,C as e,T as i,b as m};
