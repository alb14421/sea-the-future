/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{throwIfAborted as e}from"../core/promiseUtils.js";import{c as t}from"./vec3f64.js";import n from"../geometry/SpatialReference.js";import{a as o}from"./projectPointToVector.js";import{m as r}from"./dehydratedPoint.js";import{r as s}from"./elevationInfoUtils.js";import{b as a,c as i,E as c,d as p,S as l}from"./ElevationContext.js";import{l as d}from"../layers/support/fieldUtils.js";async function f(d,f,u,m,g){const{elevationProvider:h,renderCoordsHelper:y}=d,{elevationInfo:j}=f,{pointsInFeatures:I,spatialReference:v}=m,S=n.fromJSON(v),b=a(j,!0),w=await i(b,S,g);e(g);const R=[],x=new Set,D=new Set,C=new c,P=r(0,0,0,n.WGS84),q=new l,z=t();P.spatialReference=S;const E=d.elevationProvider.spatialReference??d.spatialReference;for(const{objectId:e,points:t}of I){const n=u(e);if(null==n){for(const e of t)R.push(e.z??0);x.add(e);continue}n.isDraped&&D.add(e);const r=n.graphic.geometry;C.setFromElevationInfo(s(r,j)),C.updateFeatureExpressionInfoContext(w,n.graphic,f);for(const{x:e,y:n,z:r}of t)P.x=e,P.y=n,P.z=r??0,await o(P,z,E,0,{signal:g}),p(z,h,C,y,q),R.push(q.z)}return{elevations:R,drapedObjectIds:D,failedObjectIds:x}}async function u(t,n,o){if(null==t||0===n.candidates.length)return m;const r=t.graphics3DGraphicsByObjectID??t.graphics3DGraphics,s=[],a=[],{renderer:i}=t,c=null!=i&&"arcadeRequired"in i&&i.arcadeRequired?d():null,p=async(e,{graphic:n,graphics3DSymbol:r})=>{const s=await c,a=await t.getRenderingInfoAsync(n,i,s,{signal:o});return null==a?[]:r.queryForSnapping(e,f,a,o)},{candidates:l,spatialReference:f}=n;for(let e=0;e<l.length;++e){const t=l[e],{objectId:n}=t,o="number"==typeof n?r?.get(n):void 0;if(null==o)continue;const{graphics3DSymbol:i}=o;i.symbologySnappingSupported&&(s.push(p(t,o)),a.push(e))}if(0===s.length)return m;const u=await Promise.all(s);e(o);const g=[],h=[];for(let e=0;e<u.length;++e){const t=u[e],n=a[e];for(const e of t)g.push(e),h.push(n)}return{candidates:g,sourceCandidateIndices:h}}const m={candidates:[],sourceCandidateIndices:[]};export{f as e,u as q};
