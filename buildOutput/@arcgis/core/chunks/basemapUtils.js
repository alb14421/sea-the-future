/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../core/Collection.js";import{m as a}from"./maybe.js";import{normalize as r,Url as t,makeAbsolute as n}from"../core/urlUtils.js";import{e as l}from"./utils5.js";import{e as i}from"./basemapDefinitions.js";function s(e){return"Web Scene"===e.portalItem?.type||e.referenceLayers.some(e=>"scene"===e.type)}function u(e){return!!e?.portalItem?.tags?.some(e=>"beta"===e.toLowerCase())}function c(e,a){const r=e.allLayerViews.find(e=>e.uid===a);return r?.layer.parent===e.map?.basemap}function o(e){let a=null;const r=L(e),t=!r?.baseLayers.length;for(const e in i){const n=R(r,h(i[e]),{mustMatchReferences:t});if("equal"===n){a=e;break}"base-layers-equal"===n&&(a=e)}return a}function f(e,a){return e===a||null!=e?.portalItem?.id&&e.portalItem.id===a?.portalItem?.id||"equal"===R(L(e),L(a),{mustMatchReferences:!0})}function p(e){return!!e?.baseLayers.concat(e.referenceLayers).some(y)}function y(e){if(d(e.url))return!0;if("vector-tile"===e.type)for(const a in e.sourceNameToSource){const r=e.sourceNameToSource[a];if(d(r?.sourceUrl))return!0}return!1}function m(e,a){if(null==a||null==e)return{spatialReference:null,updating:!1};if("not-loaded"===a.loadStatus)return a.load(),{spatialReference:null,updating:!0};if(a.spatialReference)return{spatialReference:a.spatialReference,updating:!1};if(0===a.baseLayers.length)return{spatialReference:null,updating:!1};const r=a.baseLayers.at(0);switch(r.loadStatus){case"not-loaded":r.load();case"loading":return{spatialReference:null,updating:!0};case"failed":return{spatialReference:null,updating:!1}}const t=(("supportedSpatialReferences"in r?r.supportedSpatialReferences:null)||["tileInfo"in r?r.tileInfo?.spatialReference:r.spatialReference]).filter(Boolean),n=e.spatialReference;return n?{spatialReference:t.find(e=>n.equals(e))??t[0]??null,updating:!1}:{spatialReference:t[0],updating:!1}}const b=/^(basemaps|ibasemaps).*-api\.arcgis\.com$/i;function d(e){if(!e)return!1;const a=new t(n(e));return!!a.authority&&b.test(a.authority)}function L(e){return e?!e.loaded&&e.resourceInfo?h(e.resourceInfo.data):{baseLayers:S(e.baseLayers),referenceLayers:S(e.referenceLayers)}:null}function S(a){return(e.isCollection(a)?a.toArray():a).map(v)}function v(e){return{type:e.type,effect:"effect"in e?e.effect:void 0,url:x("urlTemplate"in e&&e.urlTemplate||e.url||"styleUrl"in e&&e.styleUrl||""),minScale:"minScale"in e&&null!=e.minScale?e.minScale:0,maxScale:"maxScale"in e&&null!=e.maxScale?e.maxScale:0,opacity:null!=e.opacity?e.opacity:1,visible:null==e.visible||!!e.visible,sublayers:"map-image"!==e.type&&"wms"!==e.type||null==e.sublayers?void 0:e.sublayers?.map(e=>({id:e.id,visible:e.visible})),activeLayerId:"wmts"===e.type?e.activeLayer?.id:void 0}}function g(e){return e.isReference||"ArcGISSceneServiceLayer"===e.layerType}function h(e){return e?{baseLayers:I((e.baseMapLayers??[]).filter(e=>!g(e))),referenceLayers:I((e.baseMapLayers??[]).filter(e=>g(e)))}:null}function I(e){return e.map(e=>function(e){let a;switch(e.layerType){case"VectorTileLayer":a="vector-tile";break;case"ArcGISTiledMapServiceLayer":a="tile";break;case"ArcGISSceneServiceLayer":a="scene";break;default:a="unknown"}return{type:a,effect:e.effect,url:x(e.templateUrl||e.urlTemplate||e.styleUrl||e.url),minScale:e.minScale??0,maxScale:e.maxScale??0,opacity:e.opacity??1,visible:null==e.visibility||!!e.visibility,sublayers:void 0,activeLayerId:void 0}}(e))}function R(e,a,r){return null!=e!=(null!=a)?"not-equal":e&&a?q(e.baseLayers,a.baseLayers)?q(e.referenceLayers,a.referenceLayers)?"equal":r.mustMatchReferences?"not-equal":"base-layers-equal":"not-equal":"equal"}function q(e,a){if(e.length!==a.length)return!1;for(let r=0;r<e.length;r++)if(!w(e[r],a[r]))return!1;return!0}function w(e,a){if(e.type!==a.type||e.url!==a.url||e.minScale!==a.minScale||e.maxScale!==a.maxScale||e.visible!==a.visible||e.opacity!==a.opacity)return!1;if(!l(e.effect,a.effect))return!1;if(null!=e.activeLayerId||null!=a.activeLayerId)return e.activeLayerId===a.activeLayerId;if(null!=e.sublayers||null!=a.sublayers){if(null==e.sublayers||null==a.sublayers||e.sublayers.length!==a.sublayers.length)return!1;for(let r=0;r<e.sublayers.length;r++){const t=e.sublayers.at(r),n=a.sublayers.at(r);if(t?.id!==n?.id||t?.visible!==n?.visible)return!1}}return!0}function x(e){return e?r(e).replace(/^\s*https?:/i,"").toLowerCase():""}function T(e){if(!e)return null;const{thumbnailUrl:r}=e;if(r)return r;const t=o(e);return t?i[t].thumbnailUrl:a(e.baseLayers,U)}function U(e){return"portalItem"in e?e.portalItem?.thumbnailUrl:void 0}export{o as a,v as b,s as c,u as d,f as e,m as f,T as g,p as h,y as i,c as j,w as l};
