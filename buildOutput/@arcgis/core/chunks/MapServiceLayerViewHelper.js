/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../Color.js";import r from"../core/Accessor.js";import{h as s,i}from"../core/lang.js";import o from"../core/Error.js";import{g as a}from"./MapUtils.js";import{debounce as l,throwIfAborted as n}from"../core/promiseUtils.js";import{on as p}from"../core/reactiveUtils.js";import{sqlAnd as c}from"../core/sql.js";import{m as u}from"./unitUtils.js";import{property as h}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as y}from"../core/accessorSupport/decorators/subclass.js";import d from"../geometry/Extent.js";import{e as m}from"./scaleUtils.js";import{collectFields as f,l as g}from"../layers/support/fieldUtils.js";import{g as b}from"./floorFilterUtils.js";import{a as w}from"./drapedUtils.js";import{identify as v}from"../rest/identify.js";import x from"../rest/support/IdentifyParameters.js";import S from"../symbols/SimpleMarkerSymbol.js";import{g as j,a as F}from"./popupUtils.js";let _=null;function P(e,t){return"tile"===t.type||"map-image"===t.type}let G=class extends r{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=l(async e=>{this.destroyed||await this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch(()=>{}))})}initialize(){const e=e=>{for(const t of e){const{sourceLayer:e}=t;null!=e&&"geometryType"in e&&"point"===e.geometryType&&t.visible&&(t.visible=!1,this.highlightGraphicUpdated?.({graphic:t,property:"visible",oldValue:!0,newValue:!1}))}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([p(()=>this.highlightGraphics,"change",t=>e(t.added),{onListenerAdd:t=>e(t)})])}async fetchPopupFeaturesAtLocation(e,t){const{layerView:{layer:r,view:{scale:s}}}=this;if(!e)throw new o("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:r});const i=function(e,t,r){const s=[];if(!e)return s;const i=e=>{const o=0===e.minScale||t<=e.minScale,a=0===e.maxScale||t>=e.maxScale;if(e.visible&&o&&a)if(e.sublayers)e.sublayers.forEach(i);else if(e.popupEnabled){const t=F(e,{...r,defaultPopupTemplateEnabled:!1});null!=t&&s.unshift({sublayer:e,popupTemplate:t})}};return e.map(i),s}(r.sublayers,s,t);if(!i.length)return[];const a=await async function(e,t){if(e.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(t.map(({sublayer:e})=>e.load().then(()=>e.capabilities.operations.supportsQuery)))}catch{return!1}}(r,i);if(!((r.capabilities?.operations?.supportsIdentify??1)&&r.version>=10.5||a))throw new o("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:r});return a?this._fetchPopupFeaturesUsingQueries(e,i,t):this._fetchPopupFeaturesUsingIdentify(e,i,t)}clearHighlights(){this.highlightGraphics?.removeAll()}async _updateHighlightedFeaturesSymbols(e){for(const t of e)this._updateSymbology(t)}_updateSymbology(e){if("point"===e.geometry?.type)return this._updatePointSymbology(e)}_setGraphicSymbol(e,t){if(!t)return;const r=e.symbol;e.symbol=t,this.highlightGraphicUpdated?.({graphic:e,property:"symbol",oldValue:r,newValue:t})}_updatePointSymbology(e){const r=e.sourceLayer&&"renderer"in e.sourceLayer&&e.sourceLayer.renderer,{highlightGraphicUpdated:s,highlightGraphics:i,layerView:{view:o}}=this,a=e=>{e.visible||(e.visible=!0,s?.({graphic:e,property:"visible",oldValue:!1,newValue:!0}))};r&&"getSymbolAsync"in r?r.getSymbolAsync(e).then(async s=>{s||=new S;let l=null;const n="visualVariables"in r?r.visualVariables?.find(e=>"size"===e.type):void 0;n&&(_||(_=(await import("./visualVariableUtils.js").then(e=>e.l)).getSize),l=_(n,e,{view:o.type,scale:o.scale,shape:"simple-marker"===s.type?s.style:null})),l||="width"in s&&"height"in s&&null!=s.width&&null!=s.height?Math.max(s.width,s.height):"size"in s?s.size:16,i?.includes(e)&&(this._setGraphicSymbol(e,new S({style:"square",size:l,color:new t([255,255,255,1/255]),xoffset:"xoffset"in s?s.xoffset:0,yoffset:"yoffset"in s?s.yoffset:0})),a(e))}):a(e)}async _updateHighlightedFeaturesGeometries(e){const{layerView:{layer:t,view:r},highlightGraphics:s,highlightGraphicUpdated:i}=this;if(this._highlightGeometriesResolution=e,!i||!s?.length||!t.capabilities.operations.supportsQuery)return;const o=this._getTargetResolution(e),l=new Map;for(const e of s)if(!this._featuresResolutions.has(e)||this._featuresResolutions.get(e)>o){const t=e.sourceLayer;a(l,t,()=>new Map).set(e.getObjectId(),e)}const n=Array.from(l,([e,t])=>{const s=e.createQuery();return s.objectIds=[...t.keys()],s.outFields=[e.objectIdField],s.returnGeometry=!0,s.maxAllowableOffset=o,s.outSpatialReference=r.spatialReference,e.queryFeatures(s)}),p=await Promise.all(n);if(!this.destroyed)for(const{features:e}of p)for(const t of e){const e=t.sourceLayer,r=l.get(e).get(t.getObjectId());if(r&&s.includes(r)){const e=r.geometry;r.geometry=t.geometry,i({graphic:r,property:"geometry",oldValue:e,newValue:r.geometry}),this._featuresResolutions.set(r,o)}}}_getTargetResolution(e){const t=e*u(this.layerView.view.spatialReference),r=t/16;return r<=10?0:e/t*r}async _fetchPopupFeaturesUsingIdentify(e,t,r){const s=await this._createIdentifyParameters(e,t,r);if(null==s)return[];const{results:i}=await v(this.layerView.layer.parsedUrl,s,r);return i.map(e=>e.feature)}async _createIdentifyParameters(e,t,r){const{floors:i,layer:o,timeExtent:a,view:{spatialReference:l,scale:n}}=this.layerView;if(!t.length)return null;await Promise.all(t.map(({sublayer:e})=>e.load(r).catch(()=>{})));const p=Math.min(s("mapservice-popup-identify-max-tolerance"),o.allSublayers.reduce((e,t)=>t.renderer?w({renderer:t.renderer,pointerType:r?.pointerType}):e,2)),c=this.createFetchPopupFeaturesQueryGeometry(e,p),u=m(n,l),h=Math.round(c.width/u),y=new d({xmin:c.center.x-u*h,ymin:c.center.y-u*h,xmax:c.center.x+u*h,ymax:c.center.y+u*h,spatialReference:c.spatialReference});return new x({floors:i,gdbVersion:"gdbVersion"in o?o.gdbVersion:void 0,geometry:e,height:h,layerOption:"popup",mapExtent:y,returnGeometry:!0,spatialReference:l,sublayers:o.sublayers,timeExtent:a,tolerance:p,width:h})}async _fetchPopupFeaturesUsingQueries(e,t,r){const{layerView:{floors:s,timeExtent:o}}=this,a=t.map(async({sublayer:t,popupTemplate:i})=>{if(await t.load(r).catch(()=>{}),t.capabilities&&!t.capabilities.operations.supportsQuery)return[];const a=t.createQuery(),l=w({renderer:t.renderer,pointerType:r?.pointerType}),p=this.createFetchPopupFeaturesQueryGeometry(e,l),u=new Set,[h]=await Promise.all([j(t,i),t.renderer?.collectRequiredFields(u,t.fieldsIndex)]);n(r),f(u,t.fieldsIndex,h);const y=Array.from(u).sort();a.geometry=p,a.outFields=y,a.timeExtent=o;const d=b(s,t);if(a.where=c(a.where,d),t.capabilities?.query.supportsOrderBy&&t.orderBy?.[0]){const e=t.orderBy[0],r=!e.valueExpression&&e.field,s="ascending"===e.order?"asc":"desc";r&&(a.orderByFields=[`${r} ${s}`])}const m=this._getTargetResolution(p.width/l),v=await function(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some(e=>"expression"===e.type)?g():Promise.resolve()}(i);n(r);const x="point"===t.geometryType||v&&v.arcadeUtils.hasGeometryOperations(i);x||(a.maxAllowableOffset=m);let{features:S}=await t.queryFeatures(a,r);const F=x?0:m;S=await async function(e,t,r){const s=e.renderer;return s&&"defaultSymbol"in s&&!s.defaultSymbol&&(t=s.valueExpression?await Promise.all(t.map(e=>s.getSymbolAsync(e,r).then(t=>t?e:null))).then(e=>e.filter(e=>null!=e)):t.filter(e=>null!=s.getSymbol(e))),t}(t,S,r);for(const e of S)this._featuresResolutions.set(e,F);return S});return(await Promise.allSettled(a)).reduce((e,t)=>"fulfilled"===t.status?[...e,...t.value]:e,[]).filter(i)}};e([h({constructOnly:!0})],G.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),e([h({constructOnly:!0})],G.prototype,"layerView",void 0),e([h({constructOnly:!0})],G.prototype,"highlightGraphics",void 0),e([h({constructOnly:!0})],G.prototype,"highlightGraphicUpdated",void 0),e([h({constructOnly:!0})],G.prototype,"updatingHandles",void 0),G=e([y("esri.views.layers.support.MapServiceLayerViewHelper")],G);export{G as M,P as i};
