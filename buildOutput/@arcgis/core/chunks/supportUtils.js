/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../Graphic.js";import t from"../core/Error.js";import o from"../geometry/Point.js";import r from"../geometry/Polygon.js";import n from"../geometry/Polyline.js";import a from"../layers/GraphicsLayer.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/Multipoint.js";import"./Logger.js";import"./aaBoundingBox.js";import"../core/lang.js";import"./mathUtils.js";import{g as i}from"./assets.js";import{a as s}from"./enums2.js";import{executeQueryStreaming as l}from"../rest/knowledgeGraphService.js";import c from"../rest/knowledgeGraph/GraphQueryStreaming.js";import u from"../symbols/CIMSymbol.js";import y from"../symbols/SimpleFillSymbol.js";import m from"../symbols/TextSymbol.js";let p,f=null;function d(){return p||(p=import("./lclayout.js").then(e=>e.l).then(({default:e})=>e({locateFile:e=>i(`esri/libs/linkchartlayout/${e}`)})).then(e=>{f=e}),p)}const h={right:0,left:1,top:2,bottom:3},g={none:0,"start-only":1,"start-and-end":2};function E(e,t,o,r,n,a){const i=o.length,s=n.length,l=Float64Array.BYTES_PER_ELEMENT,c=Uint32Array.BYTES_PER_ELEMENT,u=Uint8Array.BYTES_PER_ELEMENT,y=16+i*(u+2*l)+s*(2*c),m=f._malloc(y);try{const u=m+16-m%16,y=u+i*l,p=y+i*l,d=p+s*c,h=d+s*c,g=()=>[f.HEAPF64.subarray(u>>3,(u>>3)+i),f.HEAPF64.subarray(y>>3,(y>>3)+i),f.HEAPU32.subarray(p>>2,(p>>2)+s),f.HEAPU32.subarray(d>>2,(d>>2)+s),f.HEAPU8.subarray(h,h+i)],[E,b,L,w,v]=g();E.set(o),b.set(r),L.set(n),w.set(a),v.set(t);const M=e(i,h,u,y,s,p,d);let x=null,T=null;if(0===M.value){const e=f.getLayoutLinksTypes(),t=f.getLayoutLinksVerticesEndIndices(),o=f.getLayoutLinksVertices(),r=f.countLayoutLinksVertices();!s||e&&t?r&&!o?M.value=1:(x={types:new Uint8Array(f.HEAPU8.subarray(e,e+s)),vertexEndIndex:new Uint32Array(f.HEAPU32.subarray(t>>2,(t>>2)+s)),vertices:new Float64Array(f.HEAPF64.subarray(o>>3,(o>>3)+2*r))},T=f.getAuxiliaryGraphicElements()):M.value=1}const[A,S,P,k,j]=g();return o.set(A),r.set(S),n.set(P),a.set(k),t.set(j),{status:M.value,links:x,graphics:T}}finally{f._free(m),f.cleanupLayout()}}var b,L,w,v,M,x,T;function A(e,t){const o=new Map;if(t.dataModel?.relationshipTypes)for(const e of t.dataModel.relationshipTypes)e.name&&o.set(e.name,[]);for(const t of e)o.has(t.typeName)&&o.get(t.typeName)?.push(t.id);return o}async function S(e,t,o){const r=[],n=A(e,t),a={},i=[];for(const[e,t]of n){if(t.length<1)continue;const o=`${e}_ids`;a[o]=t,i.push(`MATCH (n)-[r:${e}]->(m) WHERE id(r) in $${o} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(0===i.length)return[];const s=i.join(" UNION "),u=new c({openCypherQuery:s,bindParameters:a}),y=(await l(t,u,o?.requestOptions)).resultRowsStream.getReader();for(;;){const{done:e,value:t}=await y.read();if(e)break;for(const e of t)r.push({id:e[0],typeName:e[1]}),r.push({id:e[2],typeName:e[3]})}return r}async function P(e,t,o){const r=new Map,n=A(e,t),a={},i=[];for(const[e,t]of n){if(t.length<1)continue;const o=`${e}_ids`;a[o]=t,i.push(`MATCH (n)-[r:${e}]->(m) WHERE id(r) in $${o} RETURN id(r), id(n), id(m)`)}if(0===i.length)return r;const s=i.join(" UNION "),u=new c({openCypherQuery:s,bindParameters:a}),y=(await l(t,u,o?.requestOptions)).resultRowsStream.getReader();for(;;){const{done:e,value:t}=await y.read();if(e)break;for(const e of t)r.set(e[0],[e[1],e[2]])}return r}!function(e){e.getMinIdealEdgeLength=function(){return f.getMinIdealEdgeLength()},e.apply=function(e,t,o,r,n,a,i=2,s=1,l=-1){return E((t,o,r,n,a,c,u)=>f.applyForceDirectedLayout(e,t,o,r,n,a,c,u,i,s,l),t,o,r,n,a)}}(b||(b={})),function(e){e.apply=function(e,t,o,r,n,a,i=2,s=1,l=-1){return E((t,o,r,n,a,c,u)=>f.applyCommunityLayout(e,t,o,r,n,a,c,u,i,s,l),t,o,r,n,a)}}(L||(L={})),function(e){e.apply=function(e,t,o,r,n,a){return E((t,o,r,n,a,i,s)=>f.applySimpleLayout(e,t,o,r,n,a,i,s),t,o,r,n,a)}}(w||(w={})),function(e){e.apply=function(e,t,o,r,n,a){return E((t,o,r,n,a,i,s)=>f.applyHierarchicalLayout(e,t,o,r,n,a,i,s),t,o,r,n,a)}}(v||(v={})),function(e){e.apply=function(e,t,o,r,n,a){return E((t,o,r,n,a,i,s)=>f.applyRadialTreeLayout(e,t,o,r,n,a,i,s),t,o,r,n,a)}}(M||(M={})),function(e){e.apply=function(e,t,o,r,n,a){return E((t,o,r,n,a,i,s)=>f.applySmartTreeLayout(e,t,o,r,n,a,i,s),t,o,r,n,a)}}(x||(x={})),function(e){e.apply=function(e,t,o,r,n,a,i,s,l,c,u,y){return E((t,o,r,i,s,m,p)=>{if(n.length!==t)return{value:1};if(a.length!==t)return{value:1};if(l.length!==s)return{value:1};if(c.length!==s)return{value:1};const d=Float64Array.BYTES_PER_ELEMENT,E=16,b=f._malloc(E+t*d),L=f._malloc(E+t*d),w=f._malloc(E+s*d),v=f._malloc(E+s*d),M=b+E-b%E,x=L+E-L%E,T=w+E-w%E,A=v+E-v%E;try{return f.HEAPF64.subarray(M>>3,(M>>3)+t).set(n),f.HEAPF64.subarray(x>>3,(x>>3)+t).set(a),f.HEAPF64.subarray(T>>3,(T>>3)+s).set(l),f.HEAPF64.subarray(A>>3,(A>>3)+s).set(c),f.applyChronologicalLayout(e,t,o,r,i,M,x,s,m,p,T,A,u,function(e){const t={timeDirection:"right",timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:"start-and-end",showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...e?.toJSON()??{},eventsTicksVisualization:e?.eventsTicksVisualization??"start-and-end"};return{...t,timeDirection:{value:h[t.timeDirection]??h.right},eventsTicksVisualization:{value:g[t.eventsTicksVisualization]??g["start-and-end"]}}}(y))}finally{f._free(b),f._free(L),f._free(w),f._free(v)}},t,o,r,i,s)}}(T||(T={}));const k="ESRI__ChronologicalLayoutOverlay",j=()=>k,C=t=>{const i=[],s={type:"CIMGeometricEffectCut",beginCut:3,endCut:3};for(const o of t.chronologicalAuxiliaryGraphics?.lines??[]){const t={type:"CIMSolidStroke",enable:!0,width:o.width,color:[o.color.r,o.color.g,o.color.b,Math.round(o.color.a/100*255)],effects:o.dashPattern.length>0?[{type:"CIMGeometricEffectDashes",dashTemplate:o.dashPattern,lineDashEnding:"NoConstraint"},s]:void 0},r={type:"CIMVectorMarker",enable:!0,size:10,frame:{xmin:-5,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[-2.06,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:[o.color.r,o.color.g,o.color.b,Math.round(o.color.a/100*255)]}]}}],markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineEnd",offsetAlongLine:0}},a=new u({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:o.arrowheadSizeAtEnd?[t,r]:[t]}}});for(const t of o.elements){const o=new n({paths:[[[t.origin.x,t.origin.y],[t.destination.x,t.destination.y]]]});i.push(new e({geometry:o,symbol:a}))}}for(const o of t.chronologicalAuxiliaryGraphics?.polygons??[]){const t=new y({color:[o.color.r,o.color.g,o.color.b,o.color.a/100],style:"solid",outline:null});for(const n of o.elements){const o=new r({rings:[n.points.map(e=>[e.x,e.y])]});i.push(new e({geometry:o,symbol:t}))}}for(const r of t.chronologicalAuxiliaryGraphics?.texts??[]){let t="middle",n="center";switch(r.direction?.value){case h.left:n="right";break;case h.right:n="left";break;case h.bottom:t="bottom"}for(const a of r.elements){const s=new m({color:[r.color.r,r.color.g,r.color.b,r.color.a/100],text:a.str,font:{size:r.height,weight:"bold"},verticalAlignment:t,horizontalAlignment:n}),l=new o({x:a.anchor.x,y:a.anchor.y});i.push(new e({geometry:l,symbol:s}))}}return new a({graphics:i,listMode:"hide",title:k,id:k})},R=e=>s.get(e)??"radial-root-centric";function _(e){if(!e.spatialReference.isWGS84)throw new t("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map(e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]])}export{T as L,j as a,C as b,R as c,S as d,w as e,x as f,P as g,M as h,v as i,L as j,b as k,d as l,_ as u};
