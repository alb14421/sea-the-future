/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../core/Error.js";import{L as e}from"./Logger.js";import{b as n}from"./maybe.js";import{i as o,a as r}from"./aaBoundingBox.js";import{f as s}from"./aaBoundingRect.js";import{isPoint as u,isPolygon as l,isPolyline as c,isMultipoint as i}from"../geometry/support/jsonUtils.js";import{O as a}from"./OptimizedFeature.js";import{O as f}from"./OptimizedFeatureSet.js";import{O as h}from"./OptimizedGeometry.js";import{a as m}from"./createFeatureId.js";function g(t,e){return t?e?4:3:e?3:2}const d=()=>e.getLogger("esri.layers.graphics.featureConversionUtils"),y={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0,esriGeometryMultiPatch:3,esriGeometryEnvelope:0},p=(t,e,n,o,r,s)=>{t[n]=r,t[n+1]=s},w=(t,e,n,o,r,s)=>{t[n]=r,t[n+1]=s,t[n+2]=e[o+2]},M=(t,e,n,o,r,s)=>{t[n]=r,t[n+1]=s,t[n+2]=e[o+3]},G=(t,e,n,o,r,s)=>{t[n]=r,t[n+1]=s,t[n+2]=e[o+2],t[n+3]=e[o+3]};function b(t,e,n,o){if(t){if(n)return e&&o?G:w;if(e&&o)return M}else if(e&&o)return w;return p}function P({scale:t,translate:e},n){return Math.round((n-e[0])/t[0])}function T({scale:t,translate:e},n){return Math.round((e[1]-n)/t[1])}function I({scale:t,translate:e},n){return Math.round((n-e[0])/t[0])}function x({scale:t,translate:e},n){return Math.round((n-e[1])/t[1])}function Z({scale:t,translate:e},n,o){return n*t[o]+e[o]}function N(t,e,n){return t?e?n?L(t):F(t):n?v(t):j(t):null}function j(t){const e=t.coords;return{x:e[0],y:e[1]}}function k(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t}function F(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2]}}function z(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t}function v(t){const e=t.coords;return{x:e[0],y:e[1],m:e[2]}}function E(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.m,t}function L(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2],m:e[3]}}function O(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t.coords[3]=e.m,t}function U(t,e){return t&&e?O:t?z:e?E:k}function R(t,e,n=U(null!=e.z,null!=e.m)){return n(t,e)}function S(t,e,n){if(null==t)return null;const o=g(e,n),r=[];for(let e=0;e<t.coords.length;e+=o){const n=[];for(let r=0;r<o;r++)n.push(t.coords[e+r]);r.push(n)}return e?n?{points:r,hasZ:e,hasM:n}:{points:r,hasZ:e}:n?{points:r,hasM:n}:{points:r}}function q(t,e,n=g(e.hasZ,e.hasM)){t.lengths[0]=e.points.length;const o=t.coords;let r=0;for(const t of e.points)for(let e=0;e<n;e++)o[r++]=t[e];return t}function V(t,e,n){if(!t)return null;const o=g(e,n),{coords:r,lengths:s}=t,u=[];let l=0;for(const t of s){const e=[];for(let n=0;n<t;n++){const t=[];for(let e=0;e<o;e++)t.push(r[l++]);e.push(t)}u.push(e)}return e?n?{paths:u,hasZ:e,hasM:n}:{paths:u,hasZ:e}:n?{paths:u,hasM:n}:{paths:u}}function Y(t,e,n=g(e.hasZ,e.hasM)){const{lengths:o,coords:r}=t;let s=0;for(const t of e.paths){for(const e of t)for(let t=0;t<n;t++)r[s++]=e[t];o.push(t.length)}return t}function $(t,e,n){if(!t)return null;const o=g(e,n),{coords:r,lengths:s}=t,u=[];let l=0;for(const t of s){const e=[];for(let n=0;n<t;n++){const t=[];for(let e=0;e<o;e++)t.push(r[l++]);e.push(t)}u.push(e)}return e?n?{rings:u,hasZ:e,hasM:n}:{rings:u,hasZ:e}:n?{rings:u,hasM:n}:{rings:u}}function _(t,e,n=e.hasZ,o=e.hasM){return B(t,e.rings,n,o)}function B(t,e,n,o){const r=g(n,o),{lengths:s,coords:u}=t;let l=0;gt(t);for(const t of e){for(const e of t)for(let t=0;t<r;t++)u[l++]=e[t];s.push(t.length)}return t}const A=[],C=[];function D(t,e,n,o,r){A[0]=t;const[s]=H(C,A,e,n,o,r);return dt(A),dt(C),s}function H(e,n,o,r,s,u){if(dt(e),!o){for(const t of n){const n=m(t,u);e.push(new a(null,t.attributes,null,n))}return e}switch(o){case"esriGeometryPoint":return function(t,e,n,o,r){const s=U(n,o);for(const n of e){const e=null!=n.geometry?s(new h,n.geometry):null;t.push(new a(e,n.attributes,null,m(n,r)))}return t}(e,n,r,s,u);case"esriGeometryMultipoint":return function(t,e,n,o,r){const s=g(n,o);for(const n of e){const e=null!=n.geometry?q(new h,n.geometry,s):null;t.push(new a(e,n.attributes,null,m(n,r)))}return t}(e,n,r,s,u);case"esriGeometryPolyline":return function(t,e,n,o,r){const s=g(n,o);for(const n of e){const e=null!=n.geometry?Y(new h,n.geometry,s):null,o=null!=n.centroid?R(new h,n.centroid):null;t.push(new a(e,n.attributes,o,m(n,r)))}return t}(e,n,r,s,u);case"esriGeometryPolygon":case"esriGeometryMultiPatch":return function(t,e,n,o,r){for(const s of e){const e=null!=s.geometry?_(new h,s.geometry,n,o):null,u=m(s,r);null!=s.centroid?t.push(new a(e,s.attributes,k(new h,s.centroid),u)):t.push(new a(e,s.attributes,null,u))}return t}(e,n,r,s,u);default:d().error("convertToFeatureSet:unknown-geometry",new t("internal:geometry",`Unable to parse unknown geometry type '${o}'`)),dt(e)}return e}function J(t,e,n,o){C[0]=t,W(A,C,e,n,o);const r=A[0];return dt(A),dt(C),r}function K(e,n,o){if(null==e)return null;const r=new h;return"hasZ"in e&&null==n&&(n=e.hasZ),"hasM"in e&&null==o&&(o=e.hasM),u(e)?U(null!=n?n:null!=e.z,null!=o?o:null!=e.m)(r,e):l(e)?_(r,e,n,o):c(e)?Y(r,e,g(n,o)):i(e)?q(r,e,g(n,o)):void d().error("convertFromGeometry:unknown-geometry",new t("internal:geometry",`Unable to parse unknown geometry type '${e}'`))}function Q(e,n,o,r){const s=e&&("coords"in e?e:e.geometry);if(null==s)return null;switch(n){case"esriGeometryPoint":{let t=j;return o&&r?t=L:o?t=F:r&&(t=v),t(s)}case"esriGeometryMultipoint":return S(s,o,r);case"esriGeometryPolyline":return V(s,o,r);case"esriGeometryPolygon":return $(s,o,r);default:return d().error("convertToGeometry:unknown-geometry",new t("internal:geometry",`Unable to parse unknown geometry type '${n}'`)),null}}function W(e,n,o,r,s){if(dt(e),null==o)return function(t,e){for(const n of e)t.push({attributes:n.attributes});return t}(e,n);switch(o){case"esriGeometryPoint":return function(t,e,n,o){let r=j;n&&o?r=L:n?r=F:o&&(r=v);for(const n of e){const{geometry:e,attributes:o}=n,s=null!=e?r(e):null;t.push({attributes:o,geometry:s})}return t}(e,n,r,s);case"esriGeometryMultipoint":return function(t,e,n,o){for(const{geometry:r,attributes:s}of e)t.push({attributes:s,geometry:null!=r?S(r,n,o):null});return t}(e,n,r,s);case"esriGeometryPolyline":return function(t,e,n,o){for(const{geometry:r,attributes:s}of e)t.push({attributes:s,geometry:null!=r?V(r,n,o):null});return t}(e,n,r,s);case"esriGeometryPolygon":return function(t,e,n,o){for(const{geometry:r,attributes:s,centroid:u}of e){const e=null!=r?$(r,n,o):null;if(null!=u){const n=j(u);t.push({attributes:s,centroid:n,geometry:e})}else t.push({attributes:s,geometry:e})}return t}(e,n,r,s);default:d().error("convertToFeatureSet:unknown-geometry",new t("internal:geometry",`Unable to parse unknown geometry type '${o}'`))}return e}function X(t){const{spatialReference:e,transform:n,fields:o,hasM:r,hasZ:s,features:u,geometryType:l,exceededTransferLimit:c,queryGeometry:i,queryGeometryType:a}=t,f={features:W([],u,l,s,r),fields:o,geometryType:l,spatialReference:e,queryGeometry:Q(i,a,!1,!1)};return n&&(f.transform=n),c&&(f.exceededTransferLimit=c),r&&(f.hasM=r),s&&(f.hasZ=s),f}function tt(t,e){const n=new f,{hasM:o,hasZ:r,features:s,spatialReference:u,geometryType:l,exceededTransferLimit:c,transform:i,fields:a}=t;return a&&(n.fields=a),n.geometryType=l??null,n.spatialReference=u??null,s&&H(n.features,s,l,r,o,e),c&&(n.exceededTransferLimit=c),o&&(n.hasM=o),r&&(n.hasZ=r),i&&(n.transform=i),n}function et(t){const{transform:e,features:n,hasM:o,hasZ:r}=t;if(!e)return t;for(const t of n)null!=t.geometry&&ct(t.geometry,t.geometry,o,r,e),null!=t.centroid&&ct(t.centroid,t.centroid,o,r,e);return t.transform=null,t}function nt(t,e){const{geometryType:n,features:o,hasM:r,hasZ:s}=e;if(!t)return e;for(let e=0;e<o.length;e++){const u=o[e],l=u.weakClone();l.geometry=new h,ot(l.geometry,u.geometry,r,s,n,t),u.centroid&&(l.centroid=new h,ot(l.centroid,u.centroid,r,s,"esriGeometryPoint",t)),o[e]=l}return e.transform=t,e}function ot(t,e,n,o,r,s,u=n,l=o){if(gt(t),!e?.coords.length)return null;const c=y[r],{coords:i,lengths:a}=e,f=g(n,o),h=g(n&&u,o&&l),m=b(n,o,u,l);if(!a.length)return m(t.coords,i,0,0,P(s,i[0]),T(s,i[1])),gt(t,f,0),t;let d,p,w,M,G=0,I=0,x=I;for(const e of a){if(e<c)continue;let n=0;I=x,w=d=P(s,i[G]),M=p=T(s,i[G+1]),m(t.coords,i,I,G,w,M),n++,G+=f,I+=h;for(let o=1;o<e;o++,G+=f)w=P(s,i[G]),M=T(s,i[G+1]),w===d&&M===p||(m(t.coords,i,I,G,w-d,M-p),I+=h,n++,d=w,p=M);n>=c&&(t.lengths.push(n),x=I)}return dt(t.coords,x),t.coords.length?t:null}function rt(t,e,n,o,r,s,u=n,l=o){if(gt(t),!e?.coords.length)return null;const c=y[r],{coords:i,lengths:a}=e,f=g(n,o),h=g(n&&u,o&&l),m=b(n,o,u,l);if(!a.length)return m(t.coords,i,0,0,i[0],i[1]),gt(t,f,0),t;let d=0;const p=s*s;for(const e of a){if(e<c){d+=e*f;continue}const n=t.coords.length/h,o=d,r=d+(e-1)*f;m(t.coords,i,t.coords.length,o,i[o],i[o+1]),ut(t.coords,i,f,p,m,o,r),m(t.coords,i,t.coords.length,r,i[r],i[r+1]);const s=t.coords.length/h-n;s>=c?t.lengths.push(s):dt(t.coords,n*h),d+=e*f}return t.coords.length?t:null}function st(t,e,n,o){const r=t[e],s=t[e+1],u=t[n],l=t[n+1],c=t[o],i=t[o+1];let a=u,f=l,h=c-a,m=i-f;if(0!==h||0!==m){const t=((r-a)*h+(s-f)*m)/(h*h+m*m);t>1?(a=c,f=i):t>0&&(a+=h*t,f+=m*t)}return h=r-a,m=s-f,h*h+m*m}function ut(t,e,n,o,r,s,u){let l,c=o,i=0;for(let t=s+n;t<u;t+=n)l=st(e,t,s,u),l>c&&(i=t,c=l);c>o&&(i-s>n&&ut(t,e,n,o,r,s,i),r(t,e,t.length,i,e[i],e[i+1]),u-i>n&&ut(t,e,n,o,r,i,u))}function lt(t,e,n,u){if(!e?.coords?.length)return null;const l=g(n,u);let c=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,f=Number.NEGATIVE_INFINITY;if(e&&e.coords){const t=e.coords;for(let e=0;e<t.length;e+=l){const n=t[e],o=t[e+1];c=Math.min(c,n),a=Math.max(a,n),i=Math.min(i,o),f=Math.max(f,o)}}return o(t)?r(t,c,i,a,f):s(c,i,a,f,t),t}function ct(t,e,o,r,s){const{coords:u,lengths:l}=e,c=g(o,r);if(!u.length)return t!==e&&gt(t),t;n(s);const{originPosition:i,scale:a,translate:f}=s,h=yt;h.originPosition=i;const m=h.scale;m[0]=a[0]??1,m[1]=-(a[1]??1),m[2]=a[2]??1,m[3]=a[3]??1;const d=h.translate;if(d[0]=f[0]??0,d[1]=f[1]??0,d[2]=f[2]??0,d[3]=f[3]??0,!l.length){for(let e=0;e<c;++e)t.coords[e]=Z(h,u[e],e);return t!==e&&gt(t,c,0),t}let y=0;for(let e=0;e<l.length;e++){const n=l[e];t.lengths[e]=n;for(let e=0;e<c;++e)t.coords[y+e]=Z(h,u[y+e],e);let o=t.coords[y],r=t.coords[y+1];y+=c;for(let e=1;e<n;e++,y+=c){o+=u[y]*m[0],r+=u[y+1]*m[1],t.coords[y]=o,t.coords[y+1]=r;for(let e=2;e<c;++e)t.coords[y+e]=Z(h,u[y+e],e)}}return t!==e&&gt(t,u.length,l.length),t}function it(t,e,n,o,r,s){if(gt(t),t.lengths.push(...e.lengths),n===r&&o===s)for(let n=0;n<e.coords.length;n++)t.coords.push(e.coords[n]);else{const u=g(n,o),l=b(n,o,r,s),c=e.coords;for(let e=0;e<c.length;e+=u)l(t.coords,c,t.coords.length,e,c[e],c[e+1])}return t}function at(t,e,n,o){let r=0,s=t[o*e],u=t[o*(e+1)];for(let l=1;l<n;l++){const n=s+t[o*(e+l)],c=u+t[o*(e+l)+1],i=(n-s)*(c+u);s=n,u=c,r+=i}return.5*r}function ft(t,e){const{coords:n,lengths:o}=t;let r=0,s=0;for(let t=0;t<o.length;t++){const u=o[t];s+=at(n,r,u,e),r+=u}return Math.abs(s)}function ht(t,e,n,o){return 0===t*o-n*e&&t*n+e*o>0}function mt(t,e,n,o,r){const s=g(o,r);if(!t.lengths.length){if(t.coords.length<2)return null;const[n,o]=t.coords,r=I(e,n),s=x(e,o);return new h([],[r,s])}const u=new h([],[0,0]),l=y[n],c="esriGeometryPolygon"===n||"esriGeometryPolyline"===n;let i=0,a=0;for(let n=0;n<t.lengths.length;n++){const o=t.lengths[n],r=a;let f=I(e,t.coords[s*i]),h=x(e,t.coords[s*i+1]);u.coords[a++]=f,u.coords[a++]=h;let m=0,g=0,d=1;for(let n=1;n<o;n++){const o=I(e,t.coords[s*(n+i)]),r=x(e,t.coords[s*(n+i)+1]);if(o!==f||r!==h){const t=o-f,e=r-h;c&&ht(m,g,t,e)?(u.coords[a-2]+=t,u.coords[a-1]+=e,f+=t,h+=e):(u.coords[a++]=o,u.coords[a++]=r,f=o,h=r,m=t,g=e,d+=1)}}d<l?a=r:u.lengths.push(d),i+=o}return 0===u.lengths.length?null:u}function gt(t,e=0,n=0){dt(t.lengths,n),dt(t.coords,e)}function dt(t,e=0){t.length!==e&&(t.length=e)}const yt={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};export{Q as a,K as b,X as c,H as d,J as e,D as f,lt as g,rt as h,S as i,$ as j,V as k,N as l,_ as m,et as n,tt as o,mt as p,ot as q,it as r,ft as s,P as t,ct as u,T as v,R as w,B as x,nt as y};
