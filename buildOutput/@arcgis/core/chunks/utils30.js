/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../core/Error.js";import{L as e}from"./Logger.js";import{D as r,P as s}from"./enums.js";import{V as n}from"./VertexElementDescriptor.js";import{B as i}from"./definitions.js";import{B as o}from"./BoundingBox.js";import{n as a}from"./string.js";const c=()=>e.getLogger("esri.views.2d.engine.webgl.Utils");function u(e){switch(e){case s.UNSIGNED_BYTE:return 1;case s.UNSIGNED_SHORT_4_4_4_4:return 2;case s.FLOAT:return 4;default:return void c().error(new t("webgl-utils",`Unable to handle type ${e}`))}}function l(e){switch(e){case s.UNSIGNED_BYTE:return Uint8Array;case s.UNSIGNED_SHORT_4_4_4_4:return Uint16Array;case s.FLOAT:return Float32Array;default:return void c().error(new t("webgl-utils",`Unable to handle type ${e}`))}}function f(t){let e=0;const s=t.map(t=>{const s=new n(t.name,t.count,t.type,e,0,t.normalized||!1);return e+=t.count*function(t){switch(t){case r.BYTE:case r.UNSIGNED_BYTE:return 1;case r.SHORT:case r.UNSIGNED_SHORT:case r.HALF_FLOAT:return 2;case r.FLOAT:case r.INT:case r.UNSIGNED_INT:return 4}}(t.type),s});return s.forEach(t=>t.stride=e),s}const h=new Map,d=(t,e)=>{if(!h.has(t)){const r={bufferLayout:f(e),attributes:(t=>{const e=new Map;for(const r of t)e.set(r.name,r.location);return e})(e)};h.set(t,r)}return h.get(t)},E=t=>t.includes("data:image/svg+xml");function I(t){const e=[];for(let r=0;r<t.length;r++)e.push(t.charCodeAt(r));return e}function p(t){if(null==t)return"";const{type:e}=t;switch(e){case"CIMMarkerPlacementAlongLineRandomSize":return`${e}-${t.seed}-${t.randomization}`;case"CIMMarkerPlacementAlongLineVariableSize":return`${e}-${t.maxRandomOffset}-${t.numberOfSizes}-${t.seed}-${t.variationMethod}`;case"CIMMarkerPlacementAtExtremities":return`${e}-${t.extremityPlacement}-${t.offsetAlongLine}`;case"CIMMarkerPlacementAtRatioPositions":return`${e}-${t.beginPosition}-${t.endPosition}-${t.flipFirst}-${JSON.stringify(t.positionArray)}`;case"CIMMarkerPlacementAtMeasuredUnits":return`${e}-${t.interval}-${t.skipMarkerRate}-${t.placeAtExtremities}`;case"CIMMarkerPlacementInsidePolygon":return`${e}-${t.stepX}-${t.stepY}-${t.randomness}-${t.gridType}-${t.seed}-${t.shiftOddRows}`;case"CIMMarkerPlacementOnLine":return`${e}-${t.relativeTo}-${t.startPointOffset}`;case"CIMMarkerPlacementOnVertices":return`${e}-${t.placeOnControlPoints}-${t.placeOnEndPoints}-${t.placeOnRegularVertices}`;case"CIMMarkerPlacementPolygonCenter":return`${e}-${t.method}`;default:return`${e}`}}class m{static{this.byteSizeHint=7*Uint32Array.BYTES_PER_ELEMENT}constructor(t,e,r,s,n,i,o){this.instanceId=t,this.textureKey=e,this.indexStart=r,this.indexCount=s,this.vertexStart=n,this.vertexCount=i,this.overlaps=o}updateBaseOffsets(t){this.vertexStart+=t.vertexFrom,this.indexStart+=t.indexFrom}clone(){return new m(this.instanceId,this.textureKey,this.indexStart,this.indexCount,this.vertexStart,this.vertexCount,this.overlaps)}static write(t,e,r,s,n,i,o,a){t.push(e),t.push(r),t.push(s),t.push(n),t.push(i),t.push(o),t.push(a)}serialize(t){return t.push(this.instanceId),t.push(this.textureKey),t.push(this.indexStart),t.push(this.indexCount),t.push(this.vertexStart),t.push(this.vertexCount),t.push(this.overlaps),t}static deserialize(t){const e=t.readInt32(),r=t.readInt32(),s=t.readInt32(),n=t.readInt32(),i=t.readInt32(),o=t.readInt32(),a=t.readInt32();return new m(e,r,s,n,i,o,a)}}function y(t,e){if(null!==e){t.push(e.length);for(const r of e)r.serialize(t);return t}t.push(0)}function S(t,e,r){const s=t.readInt32(),n=new Array(s);for(let s=0;s<n.length;s++)n[s]=e.deserialize(t,r);return n}class T{static{this.byteSizeHint=2*Uint32Array.BYTES_PER_ELEMENT+m.byteSizeHint}constructor(t,e){this.id=t,this.sortKey=e,this.records=[]}serialize(t){return t.push(this.id),t.writeF32(this.sortKey),y(t,this.records),t}static deserialize(t){const e=t.readInt32(),r=t.readF32(),s=new T(e,r);return s.records=S(t,m)??[],s}}class _{constructor(t,e,r,s,n,i,o,a,c,u,l,f=[],h=0,d=0){this.displayId=t,this.labelClassId=e,this.labelIdHash=r,this.hash=s,this.anchorX=n,this.anchorY=i,this.directionX=o,this.directionY=a,this.maxScale=c,this.minScale=u,this.referenceBounds=l,this.bounds=f,this.recordStart=h,this.recordCount=d,this.priority=0,this._colliders=null,this.uniqueSymbol=null,this.selectedForRendering=!1}get xTile(){return this.anchorX}get yTile(){return this.anchorY}colliders(t){if(!this._colliders){const e=t.attributeView,r=i;let s=this.referenceBounds?.size??0;const n=t.layerView.labelingCollisionInfos[0].vvEvaluators[0];if(null!=n){const t=n(e.getVisualVariableData(this.displayId,0));s=isNaN(t)||null==t||t===1/0?s:t}const o=this.minScale?t.layerView.view.featuresTilingScheme.scaleToZoom(this.minScale):0,a=this.maxScale?t.layerView.view.featuresTilingScheme.scaleToZoom(this.maxScale):25,c=this.directionX*(r+s/2),u=this.directionY*(r+s/2);this._colliders=this.bounds.map(t=>({labelId:this.labelIdHash,xTile:this.anchorX,yTile:this.anchorY,dxPixels:t.x-t.halfWidth+c,dyPixels:t.y-t.halfHeight+u,hard:!0,partIndex:1,width:t.width+2,height:t.height+2,angle:0,xScreen:0,yScreen:0,dxScreen:0,dyScreen:0,enabled:!0,minLod:o,maxLod:a}))}return this._colliders}get id(){return this.displayId}serialize(t){t.push(this.displayId),t.push(this.labelClassId),t.push(this.labelIdHash),t.push(this.hash),t.push(this.recordStart),t.push(this.recordCount),t.writeF32(this.anchorX),t.writeF32(this.anchorY),t.writeF32(this.directionX),t.writeF32(this.directionY),t.writeF32(this.maxScale),t.writeF32(this.minScale),this.referenceBounds?(t.writeF32(this.referenceBounds.size),t.writeF32(this.referenceBounds.offsetX),t.writeF32(this.referenceBounds.offsetY)):(t.writeF32(0),t.writeF32(0),t.writeF32(0)),y(t,this.bounds)}static deserialize(t){const e=t.readInt32(),r=t.readInt32(),s=t.readInt32(),n=t.readInt32(),i=t.readInt32(),a=t.readInt32(),c=t.readF32(),u=t.readF32(),l=t.readF32(),f=t.readF32(),h=t.readF32(),d=t.readF32(),E=t.readF32(),I=t.readF32(),p=t.readF32(),m=S(t,o)??[];return new _(e,r,s,n,c,u,l,f,h,d,{size:E,offsetX:I,offsetY:p},m,i,a)}}const g=new Float32Array(1),M=new Uint32Array(g.buffer);function N(t){return g[0]=t,M[0]}function b(t){return M[0]=t,g[0]}function F(t,e){return 65535&t|e<<16}function w(t){const e=N(t),r=e>>>31;let s=e>>>23&255,n=8388607&e;return s-=127,s>15?r<<15|31744:s<-25?0:(s<-14&&(n+=8388608,n/=2**(-14-s),s=-15),s+=15,n/=8192,n=function(t){const e=Math.floor(t),r=t-e;return e<1023&&(r>.5||.5===r&&e%2==1)?e+1:e}(n),r<<15|s<<10|n)}function U(t){let e=t>>>15,r=t>>10&31,s=1023&t;return e=e?-1:1,r-=15,s/=1024,r>-15?s+=1:r=-14,e*2**r*s}function P(t,e,s,n){const i=s.packPrecisionFactor??1;switch(s.type){case r.BYTE:if(1===s.count)t.setInt8(n+s.offset,e*i);else for(let r=0;r<s.count;r++){const o=r*Int8Array.BYTES_PER_ELEMENT;t.setInt8(n+s.offset+o,e[r]*i)}break;case r.UNSIGNED_BYTE:if(1===s.count)t.setUint8(n+s.offset,e*i);else for(let r=0;r<s.count;r++){const o=r*Uint8Array.BYTES_PER_ELEMENT;t.setUint8(n+s.offset+o,e[r]*i)}break;case r.SHORT:if(1===s.count)t.setInt16(n+s.offset,e*i,!0);else for(let r=0;r<s.count;r++){const o=r*Int16Array.BYTES_PER_ELEMENT;t.setInt16(n+s.offset+o,e[r]*i,!0)}break;case r.UNSIGNED_SHORT:if(1===s.count)t.setUint16(n+s.offset,e*i,!0);else for(let r=0;r<s.count;r++){const o=r*Uint16Array.BYTES_PER_ELEMENT;t.setUint16(n+s.offset+o,e[r]*i,!0)}break;case r.INT:if(1===s.count)t.setInt32(n+s.offset,e*i,!0);else for(let r=0;r<s.count;r++){const o=r*Int32Array.BYTES_PER_ELEMENT;t.setInt32(n+s.offset+o,e[r]*i,!0)}break;case r.UNSIGNED_INT:if(1===s.count)t.setUint32(n+s.offset,e*i,!0);else for(let r=0;r<s.count;r++){const o=r*Uint32Array.BYTES_PER_ELEMENT;t.setUint32(n+s.offset+o,e[r]*i,!0)}break;case r.FLOAT:if(1===s.count)t.setFloat32(n+s.offset,e*i,!0);else for(let r=0;r<s.count;r++){const o=r*Float32Array.BYTES_PER_ELEMENT;t.setFloat32(n+s.offset+o,e[r]*i,!0)}break;case r.HALF_FLOAT:if(1===s.count)t.setUint16(n+s.offset,w(e*i),!0);else for(let r=0;r<s.count;r++){const o=r*Uint16Array.BYTES_PER_ELEMENT;t.setUint16(n+s.offset+o,w(e[r]*i),!0)}}}function x(t,e,s){switch(e.type){case r.BYTE:{if(1===e.count)return t.getInt8(s+e.offset);const r=[];for(let n=0;n<e.count;n++){const i=n*Int8Array.BYTES_PER_ELEMENT;r.push(t.getInt8(s+e.offset+i))}return r}case r.UNSIGNED_BYTE:{if(1===e.count)return t.getUint8(s+e.offset);const r=[];for(let n=0;n<e.count;n++){const i=n*Uint8Array.BYTES_PER_ELEMENT;r.push(t.getUint8(s+e.offset+i))}return r}case r.SHORT:{if(1===e.count)return t.getInt16(s+e.offset,!0);const r=[];for(let n=0;n<e.count;n++){const i=n*Int16Array.BYTES_PER_ELEMENT;r.push(t.getInt16(s+e.offset+i,!0))}return r}case r.UNSIGNED_SHORT:{if(1===e.count)return t.getUint16(s+e.offset,!0);const r=[];for(let n=0;n<e.count;n++){const i=n*Uint16Array.BYTES_PER_ELEMENT;r.push(t.getUint16(s+e.offset+i,!0))}return r}case r.INT:{if(1===e.count)return t.getInt32(s+e.offset,!0);const r=[];for(let n=0;n<e.count;n++){const i=n*Int32Array.BYTES_PER_ELEMENT;r.push(t.getInt32(s+e.offset+i,!0))}return r}case r.UNSIGNED_INT:{if(1===e.count)return t.getUint32(s+e.offset,!0);const r=[];for(let n=0;n<e.count;n++){const i=n*Uint32Array.BYTES_PER_ELEMENT;r.push(t.getUint32(s+e.offset+i,!0))}return r}case r.FLOAT:{if(1===e.count)return t.getFloat32(s+e.offset,!0);const r=[];for(let n=0;n<e.count;n++){const i=n*Float32Array.BYTES_PER_ELEMENT;r.push(t.getFloat32(s+e.offset+i,!0))}return r}case r.HALF_FLOAT:{if(1===e.count)return U(t.getUint16(s+e.offset,!0));const r=[];for(let n=0;n<e.count;n++){const i=n*Uint16Array.BYTES_PER_ELEMENT;r.push(U(t.getUint16(s+e.offset+i,!0)))}return r}}}function A(t){const e=t.map(({name:t,count:e,type:r})=>`${t}.${e}.${r}`).join(",");return a(e)}function L(t,e,r,s,n,i,o){if(t.primitiveName===e){let e=s?.readWithDefault(n,i,t[r]&&o);return"text"===t.type&&(e=e.toString()),void(t[r]=e)}if("type"in t&&null!=t.type){if(t.effects)for(const a of t.effects)L(a,e,r,s,n,i,o);switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(t.symbolLayers)for(const a of t.symbolLayers)L(a,e,r,s,n,i,o);break;case"CIMTextSymbol":t.symbol&&L(t.symbol,e,r,s,n,i,o);break;case"CIMHatchFill":t.lineSymbol&&L(t.lineSymbol,e,r,s,n,i,o);break;case"CIMPictureMarker":case"CIMCharacterMarker":case"CIMVectorMarker":if(t.markerPlacement&&L(t.markerPlacement,e,r,s,n,i,o),"CIMVectorMarker"===t.type&&t.markerGraphics)for(const a of t.markerGraphics)L(a,e,r,s,n,i,o),L(a.symbol,e,r,s,n,i,o)}}}function $(t){const e=Math.max(1.25*t.width,20);return null!=t.effects&&t.effects.length>0?400:e}export{T as D,_ as L,u as a,m as b,d as c,$ as d,L as e,b as f,l as g,S as h,F as i,I as j,p as k,E as l,P as p,N as t,x as u,A as v};
