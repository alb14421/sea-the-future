/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{a as e,b as t,_ as r}from"./tslib.es6.js";import{EventEmitter as s,EventedAccessor as i}from"../core/Evented.js";import{throwIfAborted as o,throwIfNotAbortError as n,createResolver as a}from"../core/promiseUtils.js";import{whenOnce as l,watch as d,initial as m}from"../core/reactiveUtils.js";import{property as c}from"../core/accessorSupport/decorators/property.js";import{i as u,h as p}from"../core/lang.js";import"./Logger.js";import{subclass as h}from"../core/accessorSupport/decorators/subclass.js";import f from"../geometry/Extent.js";import{initializeProjection as y,project as _}from"./projectionUtils.js";import g from"../geometry/SpatialReference.js";import{a as b}from"./QueryEngine.js";import j from"../rest/support/Query.js";import{read as C}from"../renderers/support/jsonUtils.js";import w from"../Color.js";import I,{d as x}from"../symbols/IconSymbol3DLayer.js";import v,{d as S}from"../symbols/ObjectSymbol3DLayer.js";import{S as R}from"./Symbol3DMaterial.js";import{c as P}from"./mat4f64.js";import{c as A,O as D,a as T}from"./vec3f64.js";import{Z as U,O as L}from"./vec4f64.js";import{s as B,u as O,w as M,x as F}from"./graphicUtils.js";import{n as E}from"./placementUtils.js";import{p as V}from"./projectBuffer.js";import{p as k}from"./projectVectorToVector.js";import{v as G,d as z,l as q,t as Q}from"./aaBoundingRect.js";import{b as N,g as H}from"./Indices.js";import{e as W,r as J,d as $}from"./sdfPrimitives.js";import{A as Z}from"./orientedBoundingBox.js";import{b as X,k as Y,c as K,i as ee,t as te}from"./mat4.js";import{c as re}from"./computeTranslationToOriginAndRotation.js";import{c as se,r as ie,f as oe}from"./aaBoundingBox.js";import{o as ne,b as ae}from"./symbolLayerUtils3D.js";import{i as le}from"./primitiveObjectSymbolUtils.js";import{av as de,aw as me}from"./Matrix4PassUniform.js";import{j as ce,s as ue,k as pe,D as he}from"./DefaultMaterial.js";import fe from"../core/Accessor.js";import{c as ye}from"./asyncUtils.js";import{R as _e}from"./ReactiveMap.js";import{waitTick as ge}from"../core/scheduling.js";import{d as be,g as je,h as Ce,f as we}from"./memoryEstimations.js";import{g as Ie}from"./utils29.js";import{c as xe,m as ve}from"./handleUtils.js";import{P as Se,B as Re}from"./PooledRBush.js";import{g as Pe}from"./OptimizedFeature.js";import{O as Ae}from"./OptimizedGeometry.js";import{f as De}from"./query.js";import Te from"../core/Error.js";import{P as Ue}from"./pbf.js";import{n as Le}from"./quantizationUtils.js";import Be from"../layers/support/FieldsIndex.js";import{a as Oe,b as Me}from"./pbfQueryUtils.js";import{H as Fe}from"./HUDMaterial.js";import{R as Ee}from"./RenderCoordsHelper.js";import"../core/Handles.js";import"../config.js";import"./object.js";import"./string.js";import"./maybe.js";import"./Lifecycle.js";import"./metadata.js";import"./utils.js";import"./tracking.js";import"./ensureType.js";import"./MapUtils.js";import"./Warning.js";import"./get.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./watch.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"./nextTick.js";import"./PooledArray.js";import"./events.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"./reader.js";import"./unitUtils.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./persistableUrlUtils.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./SimpleObservable.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./boundsUtils.js";import"./mathUtils.js";import"../geometry/Polyline.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./geodesicConstants.js";import"../geometry/support/jsonUtils.js";import"./featureConversionUtils.js";import"./OptimizedFeatureSet.js";import"./createFeatureId.js";import"./WhereClauseCache.js";import"./LRUCache.js";import"./MemCache.js";import"../core/sql/WhereClause.js";import"./TimeOnly.js";import"./enum.js";import"./UnknownTimeZone.js";import"./datetime.js";import"./locale.js";import"./guards.js";import"./fieldType.js";import"./timeSupport.js";import"./projectionSupport.js";import"./json.js";import"./QueryEngineCapabilities.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./utils14.js";import"./screenUtils.js";import"./timeUtils.js";import"./date.js";import"./constants.js";import"./heatmapUtils.js";import"./vec4.js";import"./common.js";import"./utils7.js";import"./basemapUtils.js";import"../core/Collection.js";import"./shared.js";import"./utils5.js";import"./colorUtils.js";import"./basemapDefinitions.js";import"./messages.js";import"./timeZoneUtils.js";import"./utils13.js";import"./generateRendererUtils.js";import"./enumeration.js";import"./queryUtils.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./simplify.js";import"./utils9.js";import"./utils10.js";import"./SnappingCandidate.js";import"../rest/support/AutoIntervalBinParameters.js";import"../rest/support/BinParametersBase.js";import"../core/Clonable.js";import"../rest/support/AttributeBinsGrouping.js";import"../rest/support/NormalizationBinParametersMixin.js";import"../rest/support/DateBinParameters.js";import"../rest/support/DateBinTimeInterval.js";import"../rest/support/FixedBoundariesBinParameters.js";import"../rest/support/FixedIntervalBinParameters.js";import"./Scheduler.js";import"./signal.js";import"./debugFlags.js";import"./typeUtils.js";import"./DataLayerSource.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../time/TimeExtent.js";import"./typeUtils3.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"./opacityUtils.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"./visualVariableUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"./typeUtils2.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils3.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils4.js";import"./colors.js";import"./DoubleArray.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"./lineMarkers.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"./commonProperties2.js";import"../symbols/support/jsonUtils.js";import"./layerUtils.js";import"../layers/catalog/catalogUtils.js";import"./defaults.js";import"./defaultsJSON.js";import"./RendererLegendOptions.js";import"../renderers/DictionaryRenderer.js";import"./DictionaryScriptEvaluator.js";import"./Version.js";import"./ArcadeExpression.js";import"./utils6.js";import"./defaultCIMValues.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../renderers/PieChartRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"./diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils.js";import"./vec3.js";import"./vec3f32.js";import"./plane.js";import"./vector.js";import"./mat3f64.js";import"./quatf64.js";import"./vec2f64.js";import"./mathUtils2.js";import"./ray.js";import"./mat3.js";import"./BufferView.js";import"./vec2.js";import"./meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../geometry/support/MeshLocalVertexSpace.js";import"./dehydratedPoint.js";import"./hydratedFeatures.js";import"./debugFlags2.js";import"./projectPointToVector.js";import"./glsl.js";import"./floatRGBA.js";import"./quat.js";import"./spatialReferenceEllipsoidUtils.js";import"./HUDIntersectorResult.js";import"./Intersector.js";import"./triangle.js";import"./lineSegment.js";import"./Texture.js";import"./enums.js";import"./boundedPlane.js";import"./sphere.js";import"./Emissions.glsl.js";import"./videoUtils.js";import"./requestImageUtils.js";import"./AlphaCutoff.js";import"./renderState.js";import"./BooleanBindUniform.js";import"./VertexColor.glsl.js";import"./Intersector2.js";import"../views/3d/webgl/RenderCamera.js";import"./frustum.js";import"./InterleavedLayout.js";import"./types.js";import"./VertexElementDescriptor.js";import"./VertexAttributeLocations.js";import"./VertexBuffer.js";import"./BufferObject.js";import"./SceneLighting.js";import"./CameraSpace.glsl.js";import"../views/3d/webgl.js";import"../Camera.js";import"../CameraLayout.js";import"./Cyclical.js";import"./earthUtils.js";import"../views/3d/webgl/RenderNode.js";import"./ShaderBuilder.js";import"./Matrix4sPassUniform.js";import"./quickselect.js";import"./queryZScale.js";import"./HUDVisibility.glsl.js";import"./projectVectorToPoint.js";import"./coordinateSystem.js";import"./dehydratedFeatureUtils.js";class Ve{constructor(e,t,r){this.renderCommandContext=e,this.renderCommandBuffer=t,this.pipelineStateCommands=r}append(e){this.appendRenderCommands(e.renderCommandBuffer),this.appendPipelineStateCommands(e.pipelineStateCommands)}appendRenderCommands(e){this.renderCommandBuffer.commands.push(...e.commands),this.renderCommandBuffer.transferList.push(...e.transferList)}appendPipelineStateCommand(e){this.pipelineStateCommands.push(e)}appendPipelineStateCommands(e){for(const t of e)this.appendPipelineStateCommand(t)}async execute(){for(const e of this.pipelineStateCommands)e();await this.renderCommandContext.dispatchRenderCommands(this.renderCommandBuffer)}static create(e,t=[]){return new Ve(e,e.createRenderCommandBuffer(),t)}}function ke(){return new I({material:new R({color:new w("red")})})}function Ge(e){const{featureCount:t}=e;if(0===t)return new Uint32Array;const r=new Uint32Array(t);return e.getObjectIdsArray(r),r}function ze(e){const{featureCount:t}=e;if(0===t)return new Float64Array;const r=new Float64Array(3*t);return e.getCoordinatesArray(r),r}function qe(e,t){const r=t.viewSpatialReference,s=t.renderSpatialReference,{extent:i}=e,o=G(i),n=A();return k([o[0],o[1],0],r,n,s),n}function Qe(e){const t=new Map;for(const[r,s]of e)t.set(r,{...s,indices:N(s.indices)});return t}class Ne{constructor(e,t){this._context=null,this._symbolLayer=null,this._draped=!1,this._loaded=!1,this._loadingPromise=null,this._iconTextureID=null,this._materialId=null,this._context=t,this._symbolLayer=e}get loaded(){return this._loaded}load(){return null==this._loadingPromise&&(this._loadingPromise=this._load()),this._loadingPromise}_destroy(){this._iconTextureID=null}async _load(){const e=this._context.renderCommandContext,t=await e.createTexture(()=>W("circle"));this._iconTextureID=t;const r={anchorPosition:E.center,occlusionTest:!0,hasSlicePlane:!1,color:this._getFillColor(),outlineColor:this._getOutlineColor(),outlineSize:1,distanceFieldBoundingBox:$,textureId:t,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:J("circle")};this._materialId=await e.createMaterial({type:"hud",parameters:r}),await e.createDirectRenderer(this._materialId),this._loaded=!0}async createAddCommand(e){const{_materialId:t,_context:r}=this,{renderCommandContext:s}=r;if(null==t)throw new Error("expected material not to be null");const i=await this._createGeometry(e);if(null==i)return r.createPipelineCommand();const o=qe(e,r);return r.createPipelineCommand(s.addDirectRendererGeometry(e.id,i,o))}async _createGeometry(e){const{_materialId:t,_context:r}=this,{mainThreadDelegate:s}=r,{featureCount:i}=e;if(0===i||null==t)return null;const o=Ge(e),n=ze(e),a=function(e,t){const r=e.length/3,s=t.viewSpatialReference,i=t.renderSpatialReference,o=new Float64Array(3*r);if(!V(e,s,0,o,i,0,r))throw new Error("Failed to project coordinates");return o}(await s.applyElevationAlignmentTo(n),r),l=new Float64Array([0,0,1]),d=new Float64Array([255,255,255,255]),m=new Float64Array([24,24]),c=new Float64Array([0,0,0,1]),u=new Float64Array([0,0]),p=new Float64Array([0]),h=new Uint32Array(i);for(let e=0;e<i;++e)h[e]=e;const f=new Uint32Array(i);for(let e=0;e<i;++e)f[e]=0;const y=[["position",new Z(a,h,3,!0)],["normal",new Z(l,f,3,!0)],["uv0",new Z(u,f,2,!0)],["color",new Z(d,f,4,!0)],["rotation",new Z(p,f,1,!0)],["size",new Z(m,f,2,!0)],["centerOffsetAndDistance",new Z(c,f,4,!0)]],_=new Uint8Array(i);return e.getVisibilityArray(_),{attributes:Qe(y),olidColor:void 0,transformation:P(),materialId:t,objectIds:o,visibilities:_}}async createRemoveCommand(e){const{_materialId:t,_context:r}=this,s=r.renderCommandContext;return null==t?r.createPipelineCommand():r.createPipelineCommand(s.removeDirectRendererGeometryBuffer(t,e))}async createUpdateVisibilityCommand(e){const{_materialId:t,_context:r}=this,s=r.renderCommandContext;if(null==t)return r.createPipelineCommand();const i=new Uint8Array(e.featureCount);return e.getVisibilityArray(i),r.createPipelineCommand(s.updateVisibility(t,e.id,i))}async createUpdateLayerViewOpacityCommand(e){const{_context:t,_materialId:r}=this,s=t.renderCommandContext;return null==r?t.createPipelineCommand():t.createPipelineCommand(s.updateMaterial({type:"hud",materialId:r,parameters:{color:this._getFillColor(),outlineColor:this._getOutlineColor()}}))}async createUpdateElevationCommand(e){const{_materialId:t,_context:r}=this,{renderCommandContext:s}=r,{featureCount:i,id:o}=e;if(null==t||0===i)return r.createPipelineCommand();const n=await this._createGeometry(e);if(null==n)return r.createPipelineCommand();const a=qe(e,r);return r.createPipelineCommand(s.updateDirectRendererGeometry(o,n,a))}async createDestroyCommand(){const{_iconTextureID:e,_context:t}=this,r=t.renderCommandContext;let s;return s=null!=e?await r.releaseTexture(e):Ve.create(r),s.appendPipelineStateCommand(()=>this._destroy()),s}_getOutlineColor(){const e=this._getLayerOpacity(),t=this._symbolLayer,r=t?.outline?.color;if(null!=r){const t=w.toUnitRGB(r),s=r.a*e;return[t[0],t[1],t[2],s]}return[0,0,0,0]}_getFillColor(){if(null!=(e=this._getPrimitive())&&("cross"===e||"x"===e))return We;var e;const t=null==this._getPrimitive(),r=this._symbolLayer?.material?.color;return this._getCombinedOpacityAndColor(r,{hasIntrinsicColor:t})}_getLayerOpacity(){return this._context.layerViewInfo.fullOpacity}_getCombinedOpacity(e,t=He){const r=this._draped?1:this._getLayerOpacity();return e?r*e.a:t.hasIntrinsicColor?r:0}_getCombinedOpacityAndColor(e,t=He){const r=this._getCombinedOpacity(e,t),s=null!=e?w.toUnitRGB(e):D;return B(s,r)}_getPrimitive(){return e=this._symbolLayer,e.resource?.href?null:e.resource?.primitive??x;var e}}const He={hasIntrinsicColor:!1},We=U;class Je{constructor(e,t){this._loaded=!1,this._loadingPromise=null,this._context=null,this._symbol=null,this._symbolLayerRenderers=[],this._context=t,this._symbol=e}_destroy(){}get loaded(){return this._loaded}load(){return null==this._loadingPromise&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const{_context:e,_symbol:t,_symbolLayerRenderers:r}=this,s=[];for(const i of t.symbolLayers){const t=e.symbolRendererFactory.createSymbolRendererFromSymbolLayer(i);null!=t&&(s.push(t.load()),r.push(t))}await Promise.all(s),this._loaded=!0}async createDestroyCommand(){const{_context:e,_symbolLayerRenderers:t}=this,r=[];for(const e of t)r.push(e.createDestroyCommand());const s=e.joinPipelineCommands(await Promise.all(r));return s.appendPipelineStateCommand(()=>this._destroy()),s}async createAddCommand(e){const{_context:t,_symbolLayerRenderers:r}=this,s=[];for(const t of r)s.push(t.createAddCommand(e));return t.joinPipelineCommands(await Promise.all(s))}async createRemoveCommand(e){const{_context:t,_symbolLayerRenderers:r}=this,s=[];for(const t of r)s.push(t.createRemoveCommand(e));return t.joinPipelineCommands(await Promise.all(s))}async createUpdateVisibilityCommand(e){const{_context:t,_symbolLayerRenderers:r}=this,s=[];for(const t of r)s.push(t.createUpdateVisibilityCommand(e));return t.joinPipelineCommands(await Promise.all(s))}async createUpdateLayerViewOpacityCommand(e){const{_context:t,_symbolLayerRenderers:r}=this,s=[];for(const t of r)s.push(t.createUpdateLayerViewOpacityCommand(e));return t.joinPipelineCommands(await Promise.all(s))}async createUpdateElevationCommand(e){const{_context:t,_symbolLayerRenderers:r}=this,s=[];for(const t of r)s.push(t.createUpdateElevationCommand(e));return t.joinPipelineCommands(await Promise.all(s))}}class $e{constructor(e,t){this._symbol=null,this._featureData=new Map,this._loaded=!1,this._loadingPromise=null,this._renderer=null,this._context=t,this._renderer=e}async load(){return null==this._loadingPromise&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const{_renderer:e,_context:t}=this;this._symbol=t.symbolRendererFactory.createSymbolRendererFromSymbol(e.symbol),this._loaded=!0}get loaded(){return this._loaded}async createAddCommand(e){const t=this._context,r=await this._provisionSymbol(),s=null==r?t.createPipelineCommand():await r.createAddCommand(e);return s.appendPipelineStateCommand(()=>this._featureData.set(e.id,e)),s}async createRemoveCommand(e){const t=this._context,r=await this._provisionSymbol(),s=null==r?t.createPipelineCommand():await r.createRemoveCommand(e);return s.appendPipelineStateCommand(()=>this._featureData.delete(e)),s}async createUpdateVisibilityCommand(e){const t=this._context,r=await this._provisionSymbol();return null==r?t.createPipelineCommand():await r.createUpdateVisibilityCommand(e)}async createUpdateLayerViewOpacityCommand(e){const t=this._context,r=await this._provisionSymbol();return null==r?t.createPipelineCommand():await r.createUpdateLayerViewOpacityCommand(e)}async createUpdateElevationCommand(){const{_featureData:e,_context:t}=this,r=await this._provisionSymbol();if(null==r)return t.createPipelineCommand();const s=[];for(const t of e.values())s.push(r.createUpdateElevationCommand(t));const i=await Promise.all(s);return t.joinPipelineCommands(i)}async createDestroyCommand(){const{_symbol:e,_context:t,_featureData:r}=this;if(!e)return t.createPipelineCommand();const s=[];for(const e of r.keys())s.push(this.createRemoveCommand(e));s.push(e.createDestroyCommand());const i=await Promise.all(s);return t.joinPipelineCommands(i)}async _provisionSymbol(){const e=this._symbol;return e?(e.loaded||await e.load(),e):null}}function Ze(e,t){let r=e.get(t);return r&&!r.exclusive&&(r={...r,exclusive:!0,data:de(r.data)},e.set(t,r)),r}const Xe=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];class Ye{constructor(e,t){this._loaded=!1,this._loadingPromise=null,this._primitiveMaterialId=null,this._lodRendererId=null,this._context=null,this._symbolLayer=null,this._primitive=null,this._context=t,this._symbolLayer=e}_destroy(){this._lodRendererId=null,this._primitiveMaterialId=null}get loaded(){return this._loaded}get _isPrimitive(){return null!=this._primitive}load(){return null==this._loadingPromise&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext,t=this._getLayerOpacity();let r={usePBR:!0,isSchematic:!0,mrrFactors:ue,ambient:D,diffuse:D,hasSlicePlane:!1,castShadows:!0,layerOpacity:t,offsetTransparentBackfaces:!1,screenSizePerspective:{}};if(r.externalColor=L,r.instanced=!0,this._isPrimitive){const e=new ce;e.layerOpacity=t,r={...r,cullFace:Ke(pe(e))}}const s=await e.createMaterial({type:"default",parameters:r}),i=this._symbolLayer.resource;this._primitive=i&&le(i?.primitive)?i.primitive:S;const o=function(e,t){const r=(e,r,s=!1)=>({levels:e.map(e=>{const i=Qe(r(e.tesselation));return s&&function(e){const t=e,r=t.get("position").data,s=t.get("normal").data;if(s){const t=Ze(e,"normal").data;for(let e=0;e<s.length;e+=3){const r=s[e+1];t[e+1]=-s[e+2],t[e+2]=r}}if(r){const t=Ze(e,"position").data;for(let e=0;e<r.length;e+=3){const s=r[e+1];t[e+1]=-r[e+2],t[e+2]=s}}}(i),{components:[{attributes:i,olidColor:void 0,transformation:null,materialId:t,visibilities:new Uint8Array([1]),objectIds:new Uint32Array([-1])}],minScreenSpaceRadius:e.minScreenSpaceRadius}})});switch(e){case"cone":return r(Xe,e=>M(1,.5,e,!1),!0);case"sphere":return r([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],e=>O(.5,e,!0));case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}(this._primitive,s);this._lodRendererId=await e.createLodRenderer(o),this._primitiveMaterialId=s,this._loaded=!0}async createDestroyCommand(){const{_lodRendererId:e,_primitiveMaterialId:t,_context:r}=this,s=r.renderCommandContext,i=[];return null!=e&&i.push(s.destroyLodRenderer(e)),null!=t&&i.push(s.destroyMaterial(t)),new Ve(s,s.mergeRenderCommandBuffers(i),[()=>this._destroy()])}async createAddCommand(e){const t=this._context,{renderCommandContext:r,mainThreadDelegate:s}=t;if(null==this._lodRendererId)throw new Error("expected lod renderer id to not be null");const{featureCount:i}=e;if(0===i)return t.createPipelineCommand();const o=this._isPrimitive,n=this._primitive||S,a=se(ne(n)),l=T(ie(a)),d=T(ae(l,{isPrimitive:o,width:100,depth:null,height:null})),m=new Float64Array(16*i),c=new Float64Array(16*i),u=ze(e),p=await s.applyElevationAlignmentTo(u);for(let e=0;e<i;++e){const t=e,r=p[3*e+0],s=p[3*e+1],i=p[3*e+2],o=this._computeGlobalTransform(r,s,i,this._context.viewSpatialReference,rt),n=this._computeLocalTransform(d,l,tt);this._writeMatrixToTypedBuffer(m,t,n),this._writeMatrixToTypedBuffer(c,t,o)}const h=Ge(e),f=new Uint8Array(i);e.getVisibilityArray(f);const y={featureIds:new Uint32Array(h),visibility:f,localTransforms:m,globalTransforms:c};return t.createPipelineCommand(r.addLodInstances(this._lodRendererId,e.id,y))}async createRemoveCommand(e){const{_context:t,_lodRendererId:r}=this,s=t.renderCommandContext;return null==r?t.createPipelineCommand():t.createPipelineCommand(s.removeLodInstances(r,e))}async createUpdateVisibilityCommand(e){const{_lodRendererId:t,_context:r}=this,s=r.renderCommandContext;if(null==t)return r.createPipelineCommand();const i=new Uint8Array(e.featureCount);return e.getVisibilityArray(i),r.createPipelineCommand(s.updateVisibility(t,e.id,i))}async createUpdateLayerViewOpacityCommand(e){const{_context:t}=this,r=t.renderCommandContext,s=this._primitiveMaterialId;if(null==s)return t.createPipelineCommand();const i=this._getLayerOpacity();let o={layerOpacity:i};if(this._isPrimitive){const e=new ce;e.layerOpacity=i,o={...o,cullFace:Ke(pe(e))}}return t.createPipelineCommand(r.updateMaterial({type:"default",materialId:s,parameters:o}))}async createUpdateElevationCommand(e){const{_context:t,_lodRendererId:r}=this,{renderCommandContext:s,mainThreadDelegate:i}=t,{featureCount:o,id:n}=e;if(null==r||0===o)return t.createPipelineCommand();const a=new Float64Array(16*o),l=ze(e),d=await i.applyElevationAlignmentTo(l);for(let e=0;e<o;++e){const t=e,r=d[3*e+0],s=d[3*e+1],i=d[3*e+2],o=this._computeGlobalTransform(r,s,i,this._context.viewSpatialReference,rt);this._writeMatrixToTypedBuffer(a,t,o)}return t.createPipelineCommand(s.updateLodInstancesData(r,n,a))}_writeMatrixToTypedBuffer(e,t,r){let s=16*t;for(let t=0;t<16;t++)e[s++]=r[t]}_computeGlobalTransform(e,t,r,s,i){return et[0]=e,et[1]=t,et[2]=r,re(s,et,i,this._context.renderSpatialReference),i}_computeLocalTransform(e,t,r){return X(r),this._applyObjectScale(e,t,r),r}_applyObjectScale(e,t,r){const s=F(e,e,t,this._context.renderCoordsHelper.unitInMeters);1===s[0]&&1===s[1]&&1===s[2]||Y(r,r,s)}_getLayerOpacity(){return this._context.layerViewInfo.fullOpacity}}function Ke(e){return e?0:2}const et=A(),tt=P(),rt=P();class st{constructor(e,t){this._symbols=new Array,this._featureDataPartitioning=new Map,this._loaded=!1,this._loadingPromise=null,this._renderer=null,this._context=t,this._renderer=e}async load(){return null==this._loadingPromise&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){this._symbols[0]=new Ne(ke(),this._context),this._symbols[1]=new Ye(new v,this._context),this._loaded=!0}get loaded(){return this._loaded}async createAddCommand(e){const t=this._context,r=this._partition(e),s=await Promise.all(r.map(async({index:e,features:t})=>{const r=await this._provisionSymbol(e);return await(r?.createAddCommand(t))})),i=t.joinPipelineCommands(s);return i.appendPipelineStateCommand(()=>this._featureDataPartitioning.set(e.id,r)),i}async createRemoveCommand(e){const{_featureDataPartitioning:t,_context:r}=this,s=r.renderCommandContext,i=t.get(e);if(null==i)return new Ve(s,s.createRenderCommandBuffer(),[]);const o=await Promise.all(i.map(async({index:e,features:t})=>{const r=this._getLoadedSymbol(e);return await(r?.createRemoveCommand(t.id))})),n=r.joinPipelineCommands(o);return n.appendPipelineStateCommand(()=>t.delete(e)),n}async createUpdateVisibilityCommand(e){const{_featureDataPartitioning:t,_context:r}=this,s=r.renderCommandContext,i=t.get(e.id);if(null==i)return new Ve(s,s.createRenderCommandBuffer(),[]);const o=await Promise.all(i.map(async({index:e,features:t})=>{const r=this._getLoadedSymbol(e);return await(r?.createUpdateVisibilityCommand(t))}));return r.joinPipelineCommands(o)}async createUpdateLayerViewOpacityCommand(e){const t=this._context,r=[];for(let t=0;t<this._symbols.length;++t){const s=this._symbols[t];null!=s&&s.loaded&&r.push(s.createUpdateLayerViewOpacityCommand(e))}const s=await Promise.all(r);return t.joinPipelineCommands(s)}async createUpdateElevationCommand(){const{_featureDataPartitioning:e,_context:t}=this,r=[];for(const t of e.values()){const e=t.map(async({index:e,features:t})=>{const r=this._getLoadedSymbol(e);return await(r?.createUpdateElevationCommand(t))});r.push(...e)}const s=await Promise.all(r);return t.joinPipelineCommands(s)}async createDestroyCommand(){const{_featureDataPartitioning:e,_context:t}=this,r=[];for(const t of e.keys())r.push(this.createRemoveCommand(t));for(const e of this._symbols)r.push(e.createDestroyCommand());const s=await Promise.all(r);return t.joinPipelineCommands(s)}async _provisionSymbol(e){if(null==e)return null;const t=this._symbols[e];return t?(t.loaded||await t.load(),t):null}_getLoadedSymbol(e){if(null==e)return null;const t=this._symbols[e];return null!=t&&t.loaded?t:null}_partition(e){const t=Ge(e);if(null==t)throw new Error("unable to fetch objectIds");const{featureCount:r}=e,s=[[],[]];for(let e=0;e<r;++e)s[t[e]%2].push(e);return s.map((t,r)=>new it(r,e.subset(new Uint32Array(t)))).filter(e=>e.features.featureCount>0)}}class it{constructor(e,t){this.index=e,this.features=t}}class ot{constructor(e,t,r,s,i,o,n){this.viewSpatialReference=e,this.renderSpatialReference=t,this.mainThreadDelegate=r,this.renderCoordsHelper=s,this.renderCommandContext=i,this.layerInfo=o,this.layerViewInfo=n,this.symbolRendererFactory=new nt(this)}createPipelineCommand(e=this.renderCommandContext.createRenderCommandBuffer(),t=[]){return new Ve(this.renderCommandContext,e,t)}joinPipelineCommands(e){return 0===e.length?this.createPipelineCommand():e.filter(e=>null!=e).reduce((e,t)=>(e.append(t),e))}}class nt{constructor(e){this.context=e}createSymbolRendererFromJSON(e){const t=C(e??at)??void 0;if(!t)throw new Error("Failed to create renderer");const r=t.type;switch(r){case"simple":return new $e(t,this.context);case"unique-value":return new st(t,this.context);default:return console.warn(`Unable to create symbolrenderer for renderer of ${r}`),this.createSymbolRendererFromJSON(at)}}createSymbolRendererFromSymbol(e){const t=e?.type;switch(t){case"point-3d":return new Je(e,this.context);case"picture-marker":case"simple-marker":return new Ne(ke(),this.context);default:return console.warn(`Unable to create symbolrenderer for symbol of ${t}`),null}}createSymbolRendererFromSymbolLayer(e){const t=e.type;return"icon"===t?new Ne(e,this.context):(console.warn(`Unable to create symbolrenderer for symbolLayer of ${t}`),null)}}const at={type:"simple"};class lt{constructor(e,t){this._parent=e,this._subsetIndices=t,this.id=Ie(`featureDataSubset-${e.id}-`)}get tileId(){return this._parent.tileId}get extent(){return this._parent.extent}get featureCount(){return this._subsetIndices.length}get usedMemory(){return this._parent.usedMemory+be+this._subsetIndices.byteLength}get isFullyEnabled(){for(const e of this._subsetIndices)if(!this._parent.getEnabled(e))return!1;return!0}getObjectId(e){return this._parent.getObjectId(this._subsetIndices[e])}getAttribute(e,t){return this._parent.getAttribute(this._subsetIndices[e],t)}getAttributeAsTimestamp(e,t){return this._parent.getAttribute(this._subsetIndices[e],t)}getAttributes(e){return this._parent.getAttributes(this._subsetIndices[e])}getCoordinates(e,t,r){return this._parent.getCoordinates(this._subsetIndices[e],t,r)}getOptimizedGeometry(e){return this._parent.getOptimizedGeometry(this._subsetIndices[e])}getCentroid(e,t){return this._parent.getCentroid(this._subsetIndices[e],t)}getBounds(e){return this._parent.getBounds(this._subsetIndices[e])}getBoundingBox(e){return this._parent.getBoundingBox(this._subsetIndices[e])}getObjectIdsArray(e,t,r){return this._parent.getObjectIdsArray(e,this._translatedIndices(t),r)}getCoordinatesArray(e,t,r){return this._parent.getCoordinatesArray(e,this._translatedIndices(t),r)}objectIds(e){return this._parent.objectIds(this._translatedIndices(e))}subset(e){const{_subsetIndices:t}=this,r=new Uint32Array(e.length);for(let s=0;s<r.length;++s)r[s]=t[e[s]];return new lt(this._parent,r)}disableObjectIds(e){if(0===e.size)return;const{featureCount:t}=this,r=new Array;for(let s=0;s<t;++s)this.getEnabled(s)&&e.has(this.getObjectId(s))&&r.push(s);if(0!==r.length)for(const e of r)this.setEnabled(e,!1)}setEnabled(e,t){this._parent.setEnabled(this._subsetIndices[e],t)}getEnabled(e){return this._parent.getEnabled(this._subsetIndices[e])}enableAll(){const{_subsetIndices:e,_parent:t}=this;for(const r of e)t.setEnabled(r,!0)}getVisibilityArray(e,t,r){return this._parent.getVisibilityArray(e,this._translatedIndices(t),r)}enabledObjectIds(e){return this._parent.enabledObjectIds(this._translatedIndices(e))}*_translatedIndices(e){const{_subsetIndices:t}=this;if(null!=e)for(const r of e)yield t[r];else yield*t}}class dt{constructor(e){this._tile=e,this.id=Ie(`featureData-${e.id}-`),this._enabled=new Array(e.featureCount).fill(!0)}get tileId(){return this._tile.id}get featureCount(){return this._tile.featureCount}get usedMemory(){return be+je(this.id)}get extent(){return this._tile.descriptor.extent}get isFullyEnabled(){return this._enabled.every(e=>e)}getObjectId(e){return this._tile.getObjectId(e)}getAttribute(e,t){return this._tile.getAttribute(e,t)}getAttributeAsTimestamp(e,t){return this._tile.getAttribute(e,t)}getAttributes(e){return this._tile.getAttributes(e)}getCoordinates(e,t,r){return this._tile.getCoordinates(e,t,r)}getOptimizedGeometry(e){return this._tile.getOptimizedGeometry(e)}getCentroid(e,t){return this._tile.getCentroid(e,t)}getBounds(e){return this._tile.getBounds(e)}getBoundingBox(e){return this._tile.getBoundingBox(e)}getObjectIdsArray(e,t,r){return this._tile.getObjectIdsArray(e,t,r)}getCoordinatesArray(e,t,r){return this._tile.getCoordinatesArray(e,t,r)}objectIds(e){return this._tile.objectIds(e)}subset(e){return new lt(this,e)}disableObjectIds(e){if(0===e.size)return;const{_enabled:t}=this,r=new Array;for(const s of this._allFeatureIndices())t[s]&&e.has(this.getObjectId(s))&&r.push(s);if(0!==r.length)for(const e of r)t[e]=!1}setEnabled(e,t){this._enabled[e]=t}getEnabled(e){return this._enabled[e]}enableAll(){this._enabled.fill(!0)}getVisibilityArray(e,t=this._allFeatureIndices(),r=0){const{_enabled:s}=this;for(const i of t)e[r++]=Number(s[i]);return r}*enabledObjectIds(e=this._allFeatureIndices()){const{_enabled:t}=this;for(const r of e)t[r]&&(yield this.getObjectId(r))}*_allFeatureIndices(){const{featureCount:e}=this;for(let t=0;t<e;++t)yield t}}let mt=class extends fe{constructor(e){super(e),this.extent=null,this._tileHandles=new _e,this._wanted=new _e,this._updateRequested=!1,this._synchronizationTask=null,this._requestedTiles=new Array}destroy(){this._tileHandles.clear(),this._wanted.clear()}get updating(){return this._updateRequested||!(this._synchronizationTask?.finished??1)}get _boundingRect(){const{extent:e}=this;return null==e?null:z(e)}get _missingTiles(){const e=new Array,t=this._wanted,r=this._tileHandles;for(const s of t.values())null==r.get(s.id)?.featureData&&e.push(s);return e}onTileTreeChange({tiles:e}){this._requestedTiles=e,this._scheduleTilesSync()}_scheduleTilesSync(){if(this._updateRequested)return;this._updateRequested=!0;const e=this._synchronizationTask,t=ye(async()=>{try{await l(()=>e?.finished??!0),await ge(),this._updateRequested=!1,await this._synchronizeTiles()}finally{this._synchronizationTask===t&&(this._synchronizationTask=null)}});this._synchronizationTask=t}async _synchronizeTiles(){const e=this._requestedTiles,t=this._tileHandles,r=new Array;for(const s of e)t.has(s.id)||r.push(s);const s=new Array;for(const r of t.values()){const{id:t}=r;e.every(e=>e.id!==t)&&s.push(r.descriptor)}const i=this._tileHandles,{_boundingRect:o}=this,n=null!=o?r.filter(e=>!e.extent||q(o,e.extent)):r,a=this._wanted,l=new Array;for(const{id:e}of s)a.delete(e);for(const e of n)a.set(e.id,e);const d=this._missingTiles;for(const e of s){const{id:t}=e;if(d.some(t=>ct(t,e)||ct(e,t)))continue;const r=i.get(t);null!=r&&l.push(this._removeTile(r))}for(const e of n)l.push(this._addTile(e));const m=await Promise.allSettled(l);for(const e of m)"rejected"===e.status&&console.error(e.reason)}forEachTile(e){for(const t of this._tileHandles.values()){const r=t.featureData;null!=r&&e(r)}}*loadedTiles(){for(const e of this._tileHandles.values()){const t=e.featureData;null!=t&&(yield t)}}async _removeTile(r){r.loadTask.abort(),this._tileHandles.delete(r.id),this._validate();const{featureData:s}=r;if(null!=s){const r={stack:[],error:void 0,hasError:!1};try{e(r,await this.tileLocks.lock([s.tileId]),!1);const t=await this.createRemoveCommand(s.id);await(t?.execute())}catch(e){r.error=e,r.hasError=!0}finally{t(r)}}}async _addTile(e){const{_tileHandles:t}=this,r=t.get(e.id);if(null!=r){if(!pt(r)||r.featureData.isFullyEnabled)return;return r.featureData.enableAll(),void await this._onTileLoad(r)}const s=new ut(e,ye(async t=>{const r=await this.loadTile(e,t);return o(t),new dt(r)}));this._tileHandles.set(s.id,s);try{await s.loadTask.promise}catch(e){return void n(e)}!function(e){if(!pt(e))throw new Error}(s),await this._onTileLoad(s)}async _onTileLoad(r){const s={stack:[],error:void 0,hasError:!1};try{const{_wanted:t,_tileHandles:o,_missingTiles:n}=this,a=r.descriptor,l=new Array,d=new Array,m=new Array,c=new Set;for(const e of o.values()){if(e===r)continue;const{descriptor:s,id:i}=e;if(!t.has(i)&&!n.some(e=>ct(e,s)||ct(s,e))){o.delete(i),e.loadTask.abort();const{featureData:t}=e;null!=t&&l.push(t);continue}if(pt(e)){if(ct(a,s)){const t=e.featureData;for(const e of t.objectIds())c.add(e)}if(ct(s,a)){const{featureData:t}=e;d.push(t)}}}c.size>0&&(r.featureData.disableObjectIds(c),this._validateRemoval(r.featureData,c)),this._validate(),m.push(r.featureData);const p=[...m,...l,...d].map(e=>e.tileId);if(e(s,await this.tileLocks.lock(p),!1),0!==d.length){const e=r.featureData,t=new Set(e.objectIds());for(const e of d)e.disableObjectIds(t),this._validateRemoval(e,t)}const h=l.map(e=>this.createRemoveCommand(e.id)),f=m.map(e=>this.createAddCommand(e)),y=d.map(e=>this.createUpdateCommand(e)),_=0===(i=(await Promise.all([...h,...f,...y])).filter(u)).length?null:i.reduce((e,t)=>(e.append(t),e));await(_?.execute())}catch(e){s.error=e,s.hasError=!0}finally{t(s)}var i}_validate(){if(!p("feature-pipeline-3d-test-validation"))return;const e=new Array;for(const t of this._tileHandles.values()){if(!pt(t))continue;const{featureData:r}=t;e.push({featureData:r,objectIds:new Set(r.enabledObjectIds())})}for(let t=0;t<e.length;++t){const{featureData:r,objectIds:s}=e[t];for(let i=t+1;i<e.length;++i){const{featureData:t,objectIds:o}=e[i];for(const e of o)if(s.has(e))throw new Error(`${r.id} and ${t.id} both contain ${e}.`)}}}_validateRemoval(e,t){if(p("feature-pipeline-3d-test-validation"))for(const r of e.enabledObjectIds())if(t.has(r))throw new Error(`Failed to remove ${r} from ${e.id}!`)}};function ct({lij:[e,t,r]},{lij:[s,i,o]}){const n=s-e;return n>=0&&t===i>>n&&r===o>>n}r([c()],mt.prototype,"updating",null),r([c({constructOnly:!0})],mt.prototype,"loadTile",void 0),r([c({constructOnly:!0})],mt.prototype,"createAddCommand",void 0),r([c({constructOnly:!0})],mt.prototype,"createRemoveCommand",void 0),r([c({constructOnly:!0})],mt.prototype,"createUpdateCommand",void 0),r([c({constructOnly:!0})],mt.prototype,"tileLocks",void 0),r([c()],mt.prototype,"extent",void 0),r([c()],mt.prototype,"_boundingRect",null),r([c()],mt.prototype,"_missingTiles",null),r([c()],mt.prototype,"_updateRequested",void 0),r([c()],mt.prototype,"_synchronizationTask",void 0),mt=r([h("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],mt);class ut{constructor(e,t){this.descriptor=e,this.loadTask=t}get id(){return this.descriptor.id}get featureData(){return this.loadTask.value}}function pt(e){return null!=e.featureData}class ht{constructor(){this._previousActions=new Map}async lock(e){const{_previousActions:t}=this,r=e.map(e=>t.get(e)).filter(u),s=Promise.allSettled(r),i=a(),o=ve(()=>i.resolve()),n=i.promise.finally(()=>{for(const r of e)t.get(r)===n&&t.delete(r)});for(const r of e)t.set(r,n);return await s,xe(o)}}class ft{constructor(e,t){this._index=e,this._view=t}get usedMemory(){return be+Ce}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new yt(this._index,this._view,e)}}class yt extends ft{constructor(e,t,r){super(e,t),this._geometryOverride=r}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return Pe(new Ae,this._geometryOverride,e.hasZ,e.hasM)}}class _t{constructor(e,t){this.featureData=e,this.bounds=t}}class gt{constructor(){this._tileBounds=new Map,this.events=new s,this.featureAdapter=bt.shared}get usedMemory(){return be+be*this._tileBounds.size}addTile(e){const{featureCount:t}=e;if(0===t)return;const r=new Se(9,t=>e.getBounds(t)),s=new Array;for(let e=0;e<t;++e)s[e]=e;r.load(s),this._tileBounds.set(e.id,new _t(e,r)),this.events.emit("changed")}removeTile(e){this._tileBounds.delete(e),this.events.emit("changed")}clear(){this._tileBounds.clear(),this.events.emit("changed")}forEach(e){for(const{featureData:t,bounds:r}of this._tileBounds.values())r.all(r=>{t.getEnabled(r)&&e(new ft(r,t))})}forEachInBounds(e,t){jt.minX=e[0],jt.minY=e[1],jt.maxX=e[2],jt.maxY=e[3];for(const{featureData:e,bounds:r}of this._tileBounds.values())r.search(jt,r=>{e.getEnabled(r)&&t(new ft(r,e))})}forEachBounds(e,t){for(const r of e)t(r.getBoundingBox())}getFullExtent(e){let t=1/0,r=1/0,s=-1/0,i=-1/0;for(const{bounds:e}of this._tileBounds.values()){const{minX:o,minY:n,maxX:a,maxY:l}=e.toJSON();t=Math.min(t,o),r=Math.min(r,n),s=Math.min(s,a),i=Math.min(i,l)}return{xmin:t,ymin:r,xmax:s,ymax:i,spatialReference:e}}}class bt{static{this.shared=new bt}getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}}const jt=new Re;class Ct{constructor(e,t,r){this.descriptor=e,this._pages=t,this._pageSize=r;const s=we+t.reduce((e,{usedMemory:t})=>e+t,0),i=3*Ce;this.usedMemory=be+s+i,this.featureCount=t.reduce((e,t)=>e+t.featureCount,0)}get id(){return this.descriptor.id}getObjectId(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getObjectId(r)}getAttribute(e,t){const{pageIndex:r,featurePageIndex:s}=this._translateIndex(e);return this._pages[r].getAttribute(s,t)}getAttributeAsTimestamp(e,t){const{pageIndex:r,featurePageIndex:s}=this._translateIndex(e);return this._pages[r].getAttributeAsTimestamp(s,t)}getAttributes(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getAttributes(r)}getCoordinates(e,t,r){const{pageIndex:s,featurePageIndex:i}=this._translateIndex(e);this._pages[s].getCoordinates(i,t,r)}getOptimizedGeometry(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getOptimizedGeometry(r)}getCentroid(e,t){const{pageIndex:r,featurePageIndex:s}=this._translateIndex(e);return this._pages[r].getCentroid(s,t)}getBounds(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getBounds(r)}getBoundingBox(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getBoundingBox(r)}getObjectIdsArray(e,t=this._allFeatureIndices(),r=0){let s=r;for(const{page:r,indices:i}of this._batchPageIndices(t))s=r.getObjectIdsArray(e,i,s);return s}getCoordinatesArray(e,t=this._allFeatureIndices(),r=0){let s=r;for(const{page:r,indices:i}of this._batchPageIndices(t))s=r.getCoordinatesArray(e,i,s);return s}*objectIds(e=this._allFeatureIndices()){for(const{page:t,indices:r}of this._batchPageIndices(e))for(const e of t.objectIds(r))yield e}*_allFeatureIndices(){const{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_translateIndex(e){const{_pageSize:t}=this;return{pageIndex:Math.floor(e/t),featurePageIndex:e%t}}*_batchPageIndices(e){const t=new Array;{let r=0,s=new Array;for(const i of e){const{pageIndex:e,featurePageIndex:o}=this._translateIndex(i);r!==e&&(0!==s.length&&t.push({pageIndex:r,indices:s}),r=e,s=[]),s.push(o)}0!==s.length&&t.push({pageIndex:r,indices:s})}const{_pages:r}=this;for(const{pageIndex:e,indices:s}of t)yield{page:r[e],indices:s}}}class wt{constructor(e){this._reader=new Ue(new Uint8Array(e),new DataView(e)),this._index=function(e){for(;e.next();){if(2===e.tag())return It(e.getMessage());e.skip()}vt()}(this._reader)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}get usedMemory(){return this._reader.usedMemory}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){const{_index:{fieldsIndex:r,attributeIndices:s}}=this,i=r.get(t)?.index;if(null==i)return;const o=s[e*r.fields.length+i],n=this._reader;return n.move(o),St(n)}getAttributeAsTimestamp(e,t){const r=this.getAttribute(e,t);return"string"==typeof r?new Date(r).getTime():"number"==typeof r||null==r?r:null}getAttributes(e){const{_index:{fieldsIndex:t,attributeIndices:r}}=this,s=e*t.fields.length,i=this._reader,o={};for(const e of t.fields){const t=r[s+e.index];i.move(t),o[e.name]=St(i)}return o}getCoordinates(e,t,r=0){const s=this._reader,{transform:i,featureIndices:o}=this._index,{scale:n,translate:a}=i;s.move(o[e]),this._readCoordinates(n,a,t,r)}getOptimizedGeometry(e){const t=A();return this.getCoordinates(e,t),new Ae([],t)}getCentroid(e,{hasZ:t,hasM:r}){this.getCoordinates(e,Rt);const[s,i,o]=Rt,n=[s,i];return t&&(n[3]=o),r&&(n[t?4:3]=0),new Ae([],n)}getBounds(e){this.getCoordinates(e,Rt);const[t,r]=Rt,s=new Re;return s.minX=t,s.minY=r,s.maxX=t,s.maxY=r,s}getBoundingBox(e){this.getCoordinates(e,Rt);const[t,r,s]=Rt;return oe(t,r,s,t,r,s)}getObjectIdsArray(e,t=this._allFeatureIndices(),r=0){const s=this._reader,{objectIdFieldName:i,attributeIndices:o,fieldsIndex:n}=this._index,a=n.get(i).index,l=n.fields.length;for(const i of t){const t=o[i*l+a];s.move(t),e[r++]=St(s)}return r}getCoordinatesArray(e,t=this._allFeatureIndices(),r=0){const s=this._reader,{transform:i,featureIndices:o}=this._index,{scale:n,translate:a}=i;for(const i of t){const t=o[i];s.move(t),r=this._readCoordinates(n,a,e,r)}return r}*objectIds(e=this._allFeatureIndices()){const t=this._reader,{objectIdFieldName:r,attributeIndices:s,fieldsIndex:i}=this._index,o=i.get(r).index,n=i.fields.length;for(const r of e){const e=s[r*n+o];t.move(e),yield St(t)}}*_allFeatureIndices(){const{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_readCoordinates([e,t,r],[s,i,o],n,a){const l=this._reader,d=l.getLength(),m=l.pos()+d;for(;l.pos()<m&&l.next();)switch(l.tag()){case 2:{const d=l.getLength(),m=l.pos()+d;for(;l.pos()<m&&l.next();)3===l.tag()?(l.getUInt32(),n[a++]=s+e*l.getSInt64(),n[a++]=i+t*l.getSInt64(),n[a++]=o+r*l.getSInt64()):l.skip();break}default:l.skip()}return a}}function It(e){for(;e.next();){if(1===e.tag())return xt(e.getMessage());e.skip()}vt()}function xt(e){let t,r,s=!1,i=!1,o=0;const n=new Array,a=new Array,l=new Array;for(;e.next();)switch(e.tag()){case 1:r=e.getString();break;case 7:0!==e.getEnum()&&vt();break;case 9:s=e.getBool()??!1;break;case 12:t=Le(e.processMessage(Me));break;case 13:{const t=e.processMessage(Oe);t.index=o++,n.push(t);break}case 15:{a.push(e.pos());const t=e.getUInt32(),r=e.pos()+t;for(;e.pos()<r&&e.next();)1===e.tag()?(l.push(e.pos()),e.skip()):e.skip();break}case 10:i=e.getBool()??!1;break;default:e.skip()}const d=new Be(n);return null!=t&&i&&null!=r&&d.has(r)||vt(),{transform:t,exceededTransferLimit:s,fieldsIndex:d,objectIdFieldName:r,featureIndices:a,attributeIndices:l}}function vt(){const e=new Te("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(e),e}function St(e){const t=e.getLength(),r=e.pos()+t;for(;e.pos()<r&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}const Rt=A();class Pt{constructor(e,t,r,s,i){this.spatialReference=e,this.url=r,this.objectIdField=s,this.capabilities=i;const{supportsMaxRecordCountFactor:o,maxRecordCount:n}=this.capabilities.query,a=o?4:1,l=(n??8e3)*a;this._pageSize=Math.min(8e3,l);const d=t.clone();d.cacheHint=!0,d.resultType="tile",d.outSpatialReference=e,d.returnGeometry=!0,d.returnZ=!0,d.maxRecordCountFactor=a,d.num=this._pageSize,d.outFields=[s],this._baseQuery=d}async fetch(e,t){const{spatialReference:r,_pageSize:s}=this,i=Q(e.extent,r),n=this._baseQuery.clone();n.geometry=i;const a=new Array;let l=0,d=!1,m=1;for(;!d;){const e=[];for(let r=0;r<m;++r)e.push(this._fetchPage(n,l++,t));const r=await Promise.all(e);o(t);for(const e of r){const t=0!==e.featureCount;d||=!e.exceededTransferLimit||!t,t&&a.push(e)}m=Math.min(m+1,4)}return new Ct(e,a,s)}async _fetchPage(e,t,r){const s=e.clone();s.start=t*this._pageSize;const i=(await De(this.url,s,{signal:r})).data;return o(r),new wt(i)}}class At{constructor(e,t){this._mainThreadDelegate=t,this._bufferWriters=new Map,this.globalViewingMode=1===e}createRenderCommandBuffer(e=[],t=[]){return{commands:e,transferList:t}}mergeRenderCommandBuffers(e){const t=this.createRenderCommandBuffer();for(const r of e)null!=r&&(t.commands.push(...r.commands),t.transferList.push(...r.transferList));return t}async createTexture(e){const{data:t,parameters:r}=e();return await this._mainThreadDelegate.createTexture(t,r)}async releaseTexture(e){const t=this._destroyTexture(e);return new Ve(this,t,[])}_destroyTexture(e){return{commands:[{id:"destroy-texture",textureId:e}],transferList:[]}}async createMaterial(e){const{type:t,parameters:r}=e,s=Ie("material");let i,o;switch(t){case"default":i=new he(e.parameters,{spherical:this.globalViewingMode}),o={type:t,materialId:s,parameters:e.parameters};break;case"hud":i=new Fe(r,this.globalViewingMode),o={type:t,materialId:s,parameters:e.parameters}}return this._bufferWriters.set(s,i.createBufferWriter()),await this._mainThreadDelegate.createMaterial(o),s}destroyMaterial(e){return{commands:[{id:"destroy-material",materialId:e}],transferList:[]}}updateMaterial(e){return{commands:[{...e,id:"update-material"}],transferList:[]}}async createDirectRenderer(e){return await this._mainThreadDelegate.createDirectRenderer(e),e}async destroyDirectRenderer(e){await this._mainThreadDelegate.destroyDirectRenderer(e)}addDirectRendererGeometry(e,t,r){const{materialId:s}=t;if(null==this._bufferWriters.get(s))throw new Error(`no bufferwriter found for material ${s}`);const{renderGeometryBuffer:i,renderGeometryBufferItems:o}=this.createRenderGeometryBuffer(t,r);return this.addDirectRendererGeometryBuffer(s,e,i,o,r)}updateDirectRendererGeometry(e,t,r){const{materialId:s}=t;if(null==this._bufferWriters.get(s))throw new Error(`no bufferwriter found for material ${s}`);const{renderGeometryBuffer:i,renderGeometryBufferItems:o}=this.createRenderGeometryBuffer(t,r);return this.updateDirectRendererGeometryBuffer(s,e,i,o,r)}addDirectRendererGeometryBuffer(e,t,r,s,i){const{objectIds:o,visibilities:n}=s;return{commands:[{id:"add-direct-renderer-geometry-buffer",rendererId:e,groupId:t,renderGeometryBuffer:r,renderGeometryBufferItems:s,localOrigin:i}],transferList:[r.data,o.buffer,n.buffer]}}updateDirectRendererGeometryBuffer(e,t,r,s,i){const{objectIds:o,visibilities:n}=s;return{commands:[{id:"update-direct-renderer-geometry-buffer",rendererId:e,groupId:t,renderGeometryBuffer:r,renderGeometryBufferItems:s,localOrigin:i}],transferList:[r.data,o.buffer,n.buffer]}}removeDirectRendererGeometryBuffer(e,t){return{commands:[{id:"remove-direct-renderer-geometry-buffer",rendererId:e,groupId:t}],transferList:[]}}async createLodRenderer(e){const t=Ie("lod-renderer"),r=new Set,s={levels:e.levels.map(e=>({components:e.components.map(e=>{const t=e.attributes.get("position");if(!t||0===t.indices.length)throw new Error("positions attribute expected");const s=H(t.indices.length/3),i=new me(s,3,t);if(null==this._bufferWriters.get(e.materialId))throw new Error("writer not found");const{renderGeometryBuffer:o}=this.createRenderGeometryBuffer(e,null);return r.add(o.data),{materialId:e.materialId,renderGeometryBuffer:o,boundingInfo:{bbMax:i.bbMax,bbMin:i.bbMin}}}),minScreenSpaceRadius:e.minScreenSpaceRadius}))};return await this._mainThreadDelegate.createLodRenderer(t,s,Array.from(r)),t}destroyLodRenderer(e){return{commands:[{id:"destroy-lod-renderer",rendererId:e}],transferList:[]}}addLodInstances(e,t,r){return{commands:[{id:"add-lod-instances",rendererId:e,groupId:t,data:r}],transferList:[r.featureIds.buffer,r.globalTransforms.buffer,r.localTransforms.buffer,r.visibility.buffer]}}removeLodInstances(e,t){return{commands:[{id:"remove-lod-instances",rendererId:e,groupId:t}],transferList:[]}}updateLodInstancesData(e,t,r){return{commands:[{id:"update-lod-instance-data",rendererId:e,groupId:t,globalTransforms:r}],transferList:[r.buffer]}}updateVisibility(e,t,r){return{commands:[{id:"update-visibility",rendererId:e,groupId:t,visibility:r}],transferList:[r.buffer]}}async dispatchRenderCommands(e){0!==e.commands.length&&await this._mainThreadDelegate.executeRenderCommands(e)}createRenderGeometryBuffer(e,t){const{materialId:r,visibilities:s,objectIds:i}=e,o=this._bufferWriters.get(r);if(null==o)throw new Error("no registered bufferWriter for material found");let n=null;if(e.transformation&&t)K(Dt,e.transformation),Dt[12]-=t[0],Dt[13]-=t[1],Dt[14]-=t[2],n=Dt;else{if(t)throw new Error("not implemented");e.transformation&&(n=e.transformation)}let a=null;n&&(ee(Tt,Dt),te(Tt,Tt),a=Tt);const l=e.attributes,d=o.elementCount(l),m=o.layout.stride/4;d>Math.floor(Ut/m)&&console.warn("geometry with very large number of elements encountered");const c=o.layout.createBuffer(d),u=o.write(n,a,l,e.olidColor,c,0);if(null==u)throw new Error("Bufferwriter.write does not provide item information.");if(s.length!==u.numItems||i.length!==u.numItems)throw new Error("Unexpected mismatch between number of RenderGeometryBufferItems and provided objectIds/visibility flags.");return{renderGeometryBuffer:{data:c.buffer,elementCount:d},renderGeometryBufferItems:{objectIds:i,visibilities:s,ranges:{numVertices:u.numVerticesPerItem,numItems:u.numItems}}}}}const Dt=P(),Tt=P(),Ut=4194304;let Lt=class extends i{constructor(){super(...arguments),this.remoteClient=null,this._featureStore=new gt,this._tileLocks=new ht,this._tileManager=null,this._renderer=null,this._fetcher=null,this._queryEngine=null,this._defaultQueryJSON=null,this._mainThreadDelegate=null,this._viewSpatialReference=null,this._renderCommandContext=null,this._context=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager?.destroy()}async setup({viewSpatialReference:e,renderSpatialReference:t,viewingMode:r,layerInfo:s,layerViewInfo:i}){const o=g.fromJSON(e);this._viewSpatialReference=o;const n=g.fromJSON(t);this._fetcher=new Pt(this._viewSpatialReference,j.fromJSON(s.baseQuery),s.url,s.objectIdField,s.capabilities),this._queryEngine=new b({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",featureIdInfo:{type:"object-id",fieldName:s.objectIdField},fieldsIndex:s.fieldIndex,availableFields:[s.objectIdField],spatialReference:e,featureStore:this._featureStore,timeInfo:s.timeInfo}),this._mainThreadDelegate={createTexture:async(e,t)=>{const r={data:e,parameters:t};return await this.remoteClient.invoke("createTexture",r,{transferList:[e.buffer]})},releaseTexture:async e=>{const t={uid:e};await this.remoteClient.invoke("releaseTexture",t)},createMaterial:async e=>{const t={materialJSON:e};await this.remoteClient.invoke("createMaterial",t)},destroyMaterial:async e=>{const t={materialId:e};await this.remoteClient.invoke("destroyMaterial",t)},createDirectRenderer:async e=>{const t={materialId:e};await this.remoteClient.invoke("createDirectRenderer",t)},destroyDirectRenderer:async e=>{const t={materialId:e};await this.remoteClient.invoke("destroyDirectRenderer",t)},createLodRenderer:async(e,t,r)=>{const s={rendererId:e,lodRenderGeometry:t};await this.remoteClient.invoke("createLoDRenderer",s,{transferList:r})},destroyLodRenderer:async e=>{const t={rendererId:e};await this.remoteClient.invoke("destroyLoDRenderer",t)},executeRenderCommands:async e=>{const t={commands:e.commands};await this.remoteClient.invoke("dispatchRenderCommands",t,{transferList:e.transferList})},applyElevationAlignmentTo:async e=>{const t={mapPoints:e};return await this.remoteClient.invoke("applyElevationAlignment",t,{transferList:[e.buffer]})}};const a=Ee.create(r,n),l=new At(r,this._mainThreadDelegate);this._renderCommandContext=l;const c=new ot(o,n,this._mainThreadDelegate,a,l,s,i);this._context=c,this._renderer=c.symbolRendererFactory.createSymbolRendererFromJSON(s.renderer),this._defaultQueryJSON=new j({outSpatialReference:o}).toJSON();let u=null;if(null!=s.fullExtent){const e=f.fromJSON(s.fullExtent);await y(e.spatialReference,o),u=_(e,o)}return this._tileManager=new mt({loadTile:(e,t)=>this._fetcher.fetch(e,t),createAddCommand:(e,t)=>this._createAddFeatureDataCommand(e,t),createRemoveCommand:e=>this._createRemoveFeatureDataCommand(e),createUpdateCommand:(e,t)=>this._createUpdateFeatureDataVisibilityCommand(e,t),tileLocks:this._tileLocks,extent:u}),this.addHandles(d(()=>this.updating,e=>{this.emit("notify-updating",{updating:e})}),m),null!=this._renderer&&await this._renderer.load(),Ot}async executeQuery(e,t){return{result:await this._queryEngine.executeQuery(this._ensureQuery(e),t)}}async executeQueryForIds(e,t){const r=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(e),t);return{result:Array.from(r)}}async executeQueryForCount(e,t){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(e),t)}}async executeQueryForExtent(e,t){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(e),t)}}async executeQueryForLatestObservations(e,t){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(e),t)}}onTileTreeChange(e){return this._tileManager.onTileTreeChange(e),Promise.resolve(Ot)}async onElevationChange(e){return Ot}async onLayerViewOpacityChange(e){const{_context:t,_renderer:r}=this;if(t.layerViewInfo.fullOpacity=e,null==r)return Ot;const s=await r.createUpdateLayerViewOpacityCommand(e);return await s.execute(),Ot}async onRendererChange(r){const{_context:s}=this,i=s.symbolRendererFactory.createSymbolRendererFromJSON(r);await i.load();const o=this._renderer;this._renderer=i;const n=[...this._tileManager.loadedTiles()],a=n.map(e=>e.tileId);{const r={stack:[],error:void 0,hasError:!1};try{e(r,await this._tileLocks.lock(a),!1);const t=n.flatMap(e=>[o.createRemoveCommand(e.id),i.createAddCommand(e)]),l=await Promise.all(t),d=s.joinPipelineCommands(l);await d.execute()}catch(e){r.error=e,r.hasError=!0}finally{t(r)}}const l=await o.createDestroyCommand();return await l.execute(),Ot}async _createAddFeatureDataCommand(e,t){const r=this._featureStore,s=this._renderer;let i;return i=null!=s?await s.createAddCommand(e):Ve.create(this._renderCommandContext),o(t),i.appendPipelineStateCommand(()=>{r.addTile(e)}),i}async _createRemoveFeatureDataCommand(e){const t=this._featureStore,r=this._renderer;let s;return s=null!=r?await r.createRemoveCommand(e):Ve.create(this._renderCommandContext),s.appendPipelineStateCommand(()=>{t.removeTile(e)}),s}async _createUpdateFeatureDataVisibilityCommand(e,t){const r=this._renderer;let s;return s=null!=r?await r.createUpdateVisibilityCommand(e):Ve.create(this._renderCommandContext),o(t),s}_ensureQuery(e){return e??this._defaultQueryJSON}};r([c()],Lt.prototype,"updating",null),Lt=r([h("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],Lt);const Bt=Lt,Ot={result:void 0};export{Bt as default};
