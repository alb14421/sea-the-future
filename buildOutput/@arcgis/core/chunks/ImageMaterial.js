/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{D as e,q as t}from"./BufferView.js";import{F as s,T as i,i as r,h as a,f as o}from"./Emissions.glsl.js";import{N as n,a as l,t as p,S as c,h as u,o as d,C as h,k as f,R as v,l as m,s as g,m as x,p as P,w as _,r as T,u as w,U as y,x as D,D as b,y as C,W as S,A as j,X as I,Y as O}from"./Matrix4PassUniform.js";import{i as F}from"./ITexture.js";import{T as B,D as M}from"./VertexColor.glsl.js";import{T as A}from"./TriangleMaterial.js";import{P as W}from"./DefaultLayouts.js";import{I as z,g as E}from"./glsl.js";import{S as V}from"./ShaderBuilder.js";import{m as k,d as q,c as L,p as U}from"./renderState.js";import{_ as $}from"./tslib.es6.js";const G=Object.freeze(Object.defineProperty({__proto__:null,ImageMaterialPassParameters:class extends n{},build:function(e){const t=new V,{vertex:r,fragment:a,varyings:o}=t,{output:n,perspectiveInterpolation:f}=e;return l(r,e),t.include(B,e),t.include(p,e),t.fragment.include(c,e),t.include(u,e),t.include(d,e),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),f&&t.attributes.add("perspectiveDivide","float"),r.main.add(E`
    vpos = position;
    forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
    vTexCoord = uv0;
    gl_Position = transformPosition(proj, view, vpos);
    ${z(f,"gl_Position *= perspectiveDivide;")}`),o.add("vpos","vec3",{invariant:!0}),o.add("vTexCoord","vec2"),a.include(h),a.uniforms.add(new s("opacity",e=>e.opacity),new i("tex",e=>e.glTexture)).main.add(E`
    discardBySlice(vpos);
    discardByTerrainDepth();
    ${z(9===n,"fragColor = vec4(0, 0, 0, 1); return;")}
    vec4 finalColor = texture(tex, vTexCoord) * opacity;
    outputColorHighlightOID(finalColor, vpos, finalColor.rgb);`),t}},Symbol.toStringTag,{value:"Module"}));class H extends f{constructor(e,t){super(e,t,new v(G,()=>Promise.resolve().then(()=>G)),N(t).locations)}_getPipelineState(e,t){const{oitPass:s,output:i,hasOccludees:a,cullFace:o}=e,n=0===s;return k({blending:r(i)?n?U:y(s):null,culling:L(o),depthTest:{func:w(s)},depthWrite:T(e),drawBuffers:_(s,i),colorWrite:q,stencilWrite:a?P:null,stencilTest:a?t?g:x:null,polygonOffset:m(e)})}initializePipeline(e){return this._occludeePipeline=this._getPipelineState(e,!0),this._getPipelineState(e,!1)}getPipeline(e){return e?this._occludeePipeline:super.getPipeline()}}function N(e){let t=W;return e.perspectiveInterpolation&&(t=t.clone().f32("perspectiveDivide")),t}class R extends b{constructor(e){super(),this.draped=e,this.cullFace=0,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.perspectiveInterpolation=!0,this.textureCoordinateType=0,this.emissionSource=0,this.discardInvisibleFragments=!0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.snowCover=!1}}$([D({count:3})],R.prototype,"cullFace",void 0),$([D()],R.prototype,"enableOffset",void 0),$([D()],R.prototype,"writeDepth",void 0),$([D()],R.prototype,"hasOccludees",void 0),$([D()],R.prototype,"terrainDepthTest",void 0),$([D()],R.prototype,"cullAboveTerrain",void 0),$([D()],R.prototype,"perspectiveInterpolation",void 0);class X extends A{constructor(e){super(e,K),this.supportsEdges=!0,this.produces=new Map([[2,e=>a(e)],[4,e=>o(e)&&this.parameters.writeDepth],[8,e=>o(e)&&!this.parameters.writeDepth],[18,e=>o(e)||a(e)]]),this._configuration=new R(e.draped)}dispose(){this.setParameters({texture:void 0})}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=t.hasOccludees,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<C,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.perspectiveInterpolation=this.parameters.perspectiveInterpolation,this._configuration}get visible(){return!0}createGLMaterial(e){return new Y(e)}createBufferWriter(){return new J(N(this.parameters))}}class Y extends j{constructor(e){super({...e,...e.material.parameters}),this.parameters=e;const t=this._material.parameters.texture;F(t)&&e.textures.updater.add(t)}dispose(){this.parameters.textures.updater.remove(this._material.parameters.texture)}beginSlot(e){return this.getTechnique(H,e)}}class J extends M{write(s,i,r,a,o,n){for(const a of this.layout.fields.keys()){const l=r.get(a);if(l)if("perspectiveDivide"===a){e(1===l.size);const s=o.getField(a,t);s&&I(l,s,n)}else O(a,l,s,i,o,n)}return null}}class K extends S{constructor(e,t){super(),this.texture=e,this.draped=t,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=0,this.opacity=1,this.perspectiveInterpolation=!1}get glTexture(){return this.texture.glTexture}}export{X as I};
