/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{G as t}from"./SimpleGeometryCursor.js";import{a as e,v as s,H as i,I as n,b as o,G as r,C as h,o as m,u as a,t as c,P as l,r as u}from"./Point2D.js";import{E as f,P as g}from"./Envelope.js";import{Envelope2D as _}from"./Envelope2D.js";import{G as d,ao as p,ap as P,aq as T,A as b,ar as D,d as S,b as I,S as x,q as F,L as C,_ as N,u as y,Z as w,r as E,ak as G,as as v,aj as z}from"./ProjectionTransformation.js";import{T as k}from"./Transformation2D.js";import"./tslib.es6.js";import"./OperatorDefinitions.js";function q(t){const e=t.getInputSR(),s=t.getOutputSR();let i=!1;do{if(e.equals(s)){i=!1;break}if(!X(e)||!X(s)){i=!1;break}if(2===e.getCoordinateSystemType()){i=!0;break}if(2===s.getCoordinateSystemType()){i=!0;break}const n=t.getGeographicTransformations();if(null!==n&&n.count()>0){i=!0;break}}while(0);return i}class L{constructor(t,e,s,i){this.m_horizon2Env=new _,this.m_horizon2=t,this.m_sr=e,this.m_bInclusive2=s,this.m_pannableExtent=i.clone(),this.m_segIter=null,this.m_qtIter=null,null!==t?(t.queryEnvelope(this.m_horizon2Env),this.m_gcs360=i.width(),this.m_gcs180=.5*this.m_gcs360,this.m_gcs90=.25*this.m_gcs360,this.m_pannableFactor=1,this.m_horizon2Env.width()-this.m_gcs360>0&&(this.m_pannableFactor+=Math.ceil((this.m_horizon2Env.width()-this.m_gcs360)/this.m_gcs360)),this.m_period=this.m_gcs360):(this.m_horizon2Env.setEmpty(),this.m_gcs360=Number.NaN,this.m_gcs180=Number.NaN,this.m_gcs90=Number.NaN,this.m_pannableFactor=Number.NaN,this.m_period=Number.NaN),this.m_gcsTolerance=null!=e?e.getTolerance(0):Number.NaN}isPointStartInHorizon(t,e){if(!this.m_horizon2)return!0;let s=J(new g(t),this.m_horizon2,!0,this.m_period);do{const e=t.clone();if(e.x-=s*this.m_period,this.m_horizon2.getGeometryType()===r.enumPolygon){let t;if(t=this.m_horizon2Env.contains(e)?F(this.m_horizon2,e,0):0,this.m_bInclusive2){if(0===t)return!1}else if(1===t)return!1}else{const t=this.m_horizon2Env.contains(e);if(this.m_bInclusive2){if(!t)return!1}else if(t)return!1}}while(this.m_horizon2Env.xmin+ ++s*this.m_period<t.x);return!0}isAdjoiningLineInHorizon(t,e,s){if(!this.m_horizon2)return!0;const i=new l,n=new l;$(t,e,this.m_gcs90,this.m_gcs180,this.m_gcs360,i,n);const h=Math.max(i.x,n.x),m=new C;m.setStart2D(i),m.setEnd2D(n);let a=J(m,this.m_horizon2,!0,this.m_period);do{const t=i.clone(),e=n.clone();if(t.x-=a*this.m_period,e.x-=a*this.m_period,this.m_horizon2.getGeometryType()===r.enumPolygon){const s=new C;s.setStartXY(t),s.setEndXY(e);const i=new _,n=new _;if(s.queryEnvelope(i),n.setCoords({env2D:i}),n.inflateCoords(this.m_gcsTolerance,this.m_gcsTolerance),this.m_horizon2Env.isIntersecting(n)){const t=this.m_horizon2.getImpl(),e=t.getAccelerators();null!==e&&null!==e.getRasterizedGeometry()&&o(0);{let i=null;if(null!==e&&(i=e.getQuadTree()),null!==i){this.m_qtIter||(this.m_qtIter=i.getIteratorForQT()),this.m_qtIter.resetIterator(s,this.m_gcsTolerance),this.m_segIter||(this.m_segIter=t.querySegmentIterator());for(let t=this.m_qtIter.next();-1!==t;t=this.m_qtIter.next()){const e=i.getElement(t);if(this.m_segIter.resetToVertex(e,-1),this.m_segIter.nextSegment().isIntersecting(s,this.m_gcsTolerance))return!1}}else for(this.m_segIter||(this.m_segIter=t.querySegmentIterator()),this.m_segIter.resetToFirstPath();this.m_segIter.nextPath();)for(;this.m_segIter.hasNextSegment();){const t=this.m_segIter.nextSegment(),e=new _;if(t.queryEnvelope(e),e.isIntersecting(n)&&t.isIntersecting(s,this.m_gcsTolerance))return!1}}}}else if(this.m_bInclusive2){const s=this.m_horizon2Env.contains(t),i=this.m_horizon2Env.contains(e);if(s&&i)return!0}else{const s=this.m_horizon2Env.clone();if(s.inflateCoords(this.m_gcsTolerance,this.m_gcsTolerance),0!==s.clipLine(t,e))return!1}}while(this.m_horizon2Env.xmin+ ++a*this.m_period<h);return!this.m_bInclusive2}isEnvelopeInHorizon(t,e){if(!this.m_horizon2)return!0;const s=new f({env2D:t});let i=J(s,this.m_horizon2,!0,this.m_period);do{const n=t.clone();if(n.move(-i*this.m_period,0),s.setCoords(n.xmin,n.ymin,n.xmax,n.ymax),!Z(s,this.m_horizon2,this.m_sr,this.m_bInclusive2,e))return!1}while(this.m_horizon2Env.xmin+ ++i*this.m_period<t.xmax);return!0}}class R{constructor(t,e,s){this.m_splitLines2=null,this.m_scalars=[],this.m_splitIter=null,this.m_splitLines2=t,this.m_transform1=e,this.m_pannableExtent=s.clone(),this.m_gcs360=s.width(),this.m_gcs180=.5*this.m_gcs360,this.m_gcs90=.25*this.m_gcs360,null!==e?(this.m_gcsTolerance=this.m_transform1.getOutputSR().getTolerance(0),this.m_halfGcsTolerance=.5*this.m_gcsTolerance,this.m_gcsToleranceSq=this.m_gcsTolerance*this.m_gcsTolerance):(this.m_gcsTolerance=Number.NaN,this.m_halfGcsTolerance=Number.NaN,this.m_gcsToleranceSq=Number.NaN)}hasSplitLines(){return null!=this.m_splitLines2}getSplitLineFactorEx(t,e,s,i,n,o){const r=new l,h=new l;$(i,n,this.m_gcs90,this.m_gcs180,this.m_gcs360,r,h);const m=new C;for(m.setStartXY(r),m.setEndXY(h),this.m_splitIter?this.m_splitIter.resetToFirstPath():this.m_splitIter=this.m_splitLines2.getImpl().querySegmentIterator();this.m_splitIter.nextPath();)for(;this.m_splitIter.hasNextSegment();){const i=this.m_splitIter.nextSegment(),n=.5*(i.getStartX()+i.getEndX());W(this.m_gcs180,this.m_gcs360,n,m);const r=new _;m.queryEnvelope(r),r.inflateCoords(this.m_gcsTolerance,this.m_gcsTolerance);const h=new _;if(i.queryEnvelope(h),r.isIntersecting(h)&&(this.m_scalars.length<2&&(this.m_scalars.length=2),1===m.intersect(i,null,this.m_scalars,null,this.m_gcsTolerance)&&this.m_scalars[0]>0&&this.m_scalars[0]<1)){const n=it(e,s,this.m_scalars[0]),r=O(t.getCoord2D(n),this.m_transform1);return i.isIntersectingPoint(r,this.m_halfGcsTolerance)?n:this.getSplitLineFactor(t,e,s,i,o)}}return-1}getSplitLineFactor(t,e,s,i,n){let o=e,r=s;const h=.5*(i.getStartX()+i.getEndX()),m=new C,a=t.getCoord2D(o),c=t.getCoord2D(r),u=O(a,this.m_transform1),f=O(c,this.m_transform1);for(;o<r;){const e=new l,s=new l;$(u,f,this.m_gcs90,this.m_gcs180,this.m_gcs360,e,s),m.setStartXY(e),m.setEndXY(s),W(this.m_gcs180,this.m_gcs360,h,m);const n=l.sqrDistance(m.getStartXY(),m.getEndXY());if(n<=this.m_gcsToleranceSq)break;if(Number.isNaN(n))return Number.NaN;let g=it(o,r,this.m_scalars[0]);if(o<g&&g<r||(g=.5*(r+o)),o===g||g===r)return g;const _=t.getCoord2D(g),d=O(_,this.m_transform1),p=new l;$(u,d,this.m_gcs90,this.m_gcs180,this.m_gcs360,e,p),m.setStartXY(e),m.setEndXY(p),W(this.m_gcs180,this.m_gcs360,h,m);let P=m.intersect(i,null,this.m_scalars,null,this.m_halfGcsTolerance);if(0!==P){if(1===this.m_scalars[0])return g;r=g,c.setCoordsPoint2D(_),f.setCoordsPoint2D(d)}else{if($(d,f,this.m_gcs90,this.m_gcs180,this.m_gcs360,p,s),m.setStartXY(p),m.setEndXY(s),W(this.m_gcs180,this.m_gcs360,h,m),P=m.intersect(i,null,this.m_scalars,null,this.m_halfGcsTolerance),0===P)return g;if(0===this.m_scalars[0])return g;o=g,a.setCoordsPoint2D(_),u.setCoordsPoint2D(d)}}return.5*(r+o)}}class M{constructor(){this.m_bPrepared=!1,this.m_bNeedsShapePreservingProject=!1,this.m_inputTransform=null,this.m_transform1=null,this.m_transform2=null,this.m_extentFrom=null,this.m_horizon1=null,this.m_horizon2=null,this.m_pannableExtentFrom=new _,this.m_pannableExtentTo=new _,this.m_pannableExtentGcsTo=new _,this.m_bClipTopBottomFrom=!1,this.m_bNeedsGeoTransform=!1,this.m_bIsPannableFrom=!1,this.m_bIsPannableTo=!1,this.m_bInclusive1=!1,this.m_bInclusive2=!1,this.m_bSrFromIsPcs=!1,this.m_bSrToIsPcs=!1,this.m_fromTolerance=Number.NaN,this.m_toTolerance=Number.NaN,this.m_gcsToTolerance=Number.NaN,this.m_aFrom=Number.NaN,this.m_mpuFrom=Number.NaN,this.m_rpuFrom=Number.NaN,this.m_rpuGcsTo=Number.NaN,this.m_aTo=Number.NaN,this.m_mpuTo=Number.NaN,this.m_stages=0}prepare(t,s,i){this.m_bPrepared&&n(""),t||e("");const r=t.getInputSR(),h=t.getOutputSR();X(r)&&X(h)||e("shape preserving project requires PCS or GCS");const m=r.getCoordinateSystemType(),a=h.getCoordinateSystemType();this.m_bSrFromIsPcs=2===m,this.m_bSrToIsPcs=2===a;let c=null,l=null,u=null,f=null;this.m_bSrFromIsPcs?(c=r,u=r.getGCS(),this.m_aFrom=st(u),this.m_mpuFrom=et(c),this.m_rpuFrom=Number.NaN):(u=r,this.m_rpuFrom=tt(u),this.m_aFrom=Number.NaN),this.m_bSrToIsPcs?(l=h,f=h.getGCS(),this.m_aTo=st(f),this.m_mpuTo=et(l)):(f=h,this.m_aTo=Number.NaN,this.m_mpuTo=Number.NaN),this.m_rpuGcsTo=tt(f);const g=t.getGeographicTransformations();this.m_bNeedsGeoTransform=null!==g&&g.count()>0;const _=r.equals(h);if(this.m_bNeedsShapePreservingProject=!_&&(this.m_bSrFromIsPcs||this.m_bSrToIsPcs||this.m_bNeedsGeoTransform),!this.m_bNeedsShapePreservingProject)return this.m_inputTransform=t,this.m_extentFrom=s?s.clone():null,void(this.m_bPrepared=!0);if(this.m_bIsPannableFrom=r.isPannable(),this.m_bIsPannableTo=h.isPannable(),this.m_bIsPannableFrom&&(this.m_pannableExtentFrom=r.getPannableExtent()),this.m_bIsPannableTo&&(this.m_pannableExtentTo=h.getPannableExtent()),this.m_bSrToIsPcs){this.m_pannableExtentGcsTo=f.getPannableExtent();const t=l.getCentralMeridian(),e=this.m_pannableExtentGcsTo.getCenter();e.x=t,this.m_pannableExtentGcsTo.centerAt(e)}else this.m_pannableExtentGcsTo=this.m_pannableExtentTo.clone();this.m_fromTolerance=r.getTolerance(0),this.m_toTolerance=h.getTolerance(0),this.m_gcsToTolerance=f.getTolerance(0);{const e=t.getExtendedParams(),n=e.clipWithInputHorizon,o=e.clipWithOutputHorizon;n&&this.setHorizon1(t,s,i),o&&this.setHorizon2(t,i),this.checkAndSetStages(t,i)}const d=p();d.setFlag(1073741824,!0),d.setFlag(536870912,!0);const b=P();if(b.clipWithInputHorizon=!1,b.clipWithOutputHorizon=!1,1===this.m_stages)this.m_transform1=T(!1,r,h,g,b,d);else if(2===this.m_stages){d.setFlag(2147483648,!0),this.m_transform1=T(!1,r,f,g,b,d);const t=p();this.m_transform2=T(!1,f,h,null,b,t)}else{o(null!=l),b.centralMeridianOfOutputGCS=l.getCentralMeridian(),this.m_transform1=T(!1,r,f,g,b,d);const t=p();t.setFlag(2147483648,!0),this.m_transform2=T(!1,f,h,null,b,t)}this.m_inputTransform=t,this.m_extentFrom=s?s.clone():null,this.m_bPrepared=!0}execute(t,e,s,i){return this.m_bPrepared||n(""),o(!t.hasAttribute(10)),this.execute_(t,e,s,i)}checkIfNeedsReset(t,e){return o(0),!1}setHorizon1(t,e,s){const i=t.getInputSR();let n,o=null;const r=new _;if(this.m_bSrFromIsPcs){n=!0,o=i.getPCSHorizon(),o.queryEnvelope(r),this.m_bIsPannableFrom&&(o=new f({xmin:this.m_pannableExtentFrom.xmin,ymin:r.ymin,xmax:this.m_pannableExtentFrom.xmax,ymax:r.ymax}));let t=!1;null!=e&&(t=function(t,e,s,i,n,o,r){const h=[!1];return V(t,s,e,!0,n,o,!0,Number.NaN,h,r),h[0]}(e,o,i,0,this.m_bIsPannableFrom,this.m_pannableExtentFrom,s)),t||(this.m_horizon1=o,this.m_bInclusive1=true)}else this.m_bClipTopBottomFrom=!0,this.m_bInclusive1=!0}setHorizon2(t,e){const s=t.getOutputSR();if(1===s.getCoordinateSystemType())return this.m_horizon2=null,void(this.m_bInclusive2=!1);let i=null;const n=new _,o=s.getGCSHorisonIsInclusive();i=s.getGCSHorizon(),i.queryEnvelope(n);const r=s.getCentralMeridian();if(this.m_bIsPannableTo){const t=new f({xmin:this.m_pannableExtentGcsTo.xmin,ymin:n.ymin,xmax:this.m_pannableExtentGcsTo.xmax,ymax:n.ymax});t.centerAt(r,0),i=t}this.m_horizon2=i,this.m_bInclusive2=o}checkAndSetStages(t,e){const s=t.getOutputSR().getGCSSplitLines();if(this.m_horizon2||s){if(this.m_horizon2.getGeometryType()===r.enumEnvelope){const t=new _;this.m_horizon2.queryEnvelope(t);const e=t.width(),s=t.height();e>=h/this.m_rpuGcsTo&&s>=Math.PI/this.m_rpuGcsTo&&(this.m_horizon2=null)}if(this.m_horizon2||s){if(null!==this.m_horizon2&&!this.m_bNeedsGeoTransform&&!this.m_bSrFromIsPcs){const e=t.getOutputSR().getGCS();return t.getInputSR().equals(e)?(this.m_horizon1=this.m_horizon2,this.m_bInclusive1=this.m_bInclusive2,this.m_bClipTopBottomFrom=!1,this.m_horizon2=null,this.m_bInclusive2=!1,void(this.m_stages=1)):void(this.m_stages=2)}this.m_stages=3}else this.m_stages=1}else this.m_stages=1}execute_(t,e,n,o){if(!this.m_bNeedsShapePreservingProject)return(new d).execute(t,this.m_inputTransform,o);if(!t)return null;s(t),i(t);let h,c=t.getGeometryType();return m(c)?(h=function(t){const e=new I({vd:t.getDescription()});return e.addSegment(t,!0),e}(t),c=r.enumPolyline):h=t,h.isEmpty()?h:a(c)?this.executeEx(t,e,n,o):(new d).execute(t,this.m_inputTransform,o)}executeEx(t,e,s,i){let n;t.hasNonLinearSegments()&&c(""),n=this.m_bIsPannableFrom?(new d).foldInto360Range(t,this.m_transform1.getInputSR()):t;let o,r=s;return r>0||(r=100*this.m_toTolerance),o=1===this.m_stages?this.executeGood(n,e,r,i):2===this.m_stages?this.executeBad(n,e,r,i):this.executeUgly(n,e,r,i),this.filterOverDensification(o,this.m_inputTransform.getOutputSR(),r,i)}executeGood(t,e,s,i){const n=s*s;let o,r;return o=e>0?this.getMinLengthInSrFrom(e):this.getMinLengthInSrFrom(1e-5),r=this.m_bClipTopBottomFrom?b(t,this.m_transform1.getInputSR()):Q(t,this.m_transform1.getInputSR(),this.m_horizon1,this.m_bInclusive1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,!0,Number.NaN,i),r=D(r,this.m_transform1.getOutputSR(),i),r=A(r,this.m_transform1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,this.m_bIsPannableTo,this.m_pannableExtentTo,null,null,0,null,o,n,i),r=(new d).execute(r,this.m_transform1,i),r}executeBad(t,e,s,i){let n;n=e>0?e*(Math.PI/180/this.m_rpuGcsTo):Math.PI/180/this.m_rpuGcsTo*1e-5;const o=s*s;let r;return r=this.m_bClipTopBottomFrom?b(t,this.m_transform1.getInputSR()):t,r=(new d).execute(r,this.m_transform1,i),r=Q(r,this.m_transform2.getInputSR(),this.m_horizon2,this.m_bInclusive2,!0,this.m_pannableExtentGcsTo,!0,Number.NaN,i),r=D(r,this.m_transform2.getOutputSR(),i),r=A(r,this.m_transform2,!0,this.m_pannableExtentGcsTo,this.m_bIsPannableTo,this.m_pannableExtentTo,null,null,0,null,n,o,i),r=(new d).execute(r,this.m_transform2,i),r}executeUgly(t,e,s,i){const n=s*s;let o;o=e>0?this.getMinLengthInSrFrom(e):this.getMinLengthInSrFrom(1e-5);let r=null;r=this.m_bClipTopBottomFrom?b(t,this.m_transform1.getInputSR()):Q(t,this.m_transform1.getInputSR(),this.m_horizon1,this.m_bInclusive1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,!0,Number.NaN,i);let h=r;const m=new L(this.m_horizon2,this.m_transform2.getInputSR(),this.m_bInclusive2,this.m_pannableExtentGcsTo),a=this.m_transform2.getOutputSR().getGCSSplitLines(),c=new R(a,this.m_transform1,this.m_pannableExtentGcsTo);if(r=A(r,this.m_transform1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,this.m_bIsPannableTo,this.m_pannableExtentTo,this.m_transform2,m,this.m_pannableExtentGcsTo,c,o,n,i),null!==r){h=null,r=(new d).execute(r,this.m_transform1,i);const t=Math.PI/180/this.m_rpuGcsTo*2;return r=Q(r,this.m_transform2.getInputSR(),this.m_horizon2,this.m_bInclusive2,!0,this.m_pannableExtentGcsTo,!1,t,i),r=(new d).execute(r,this.m_transform2,i),r}let l=Number.NaN;l=s>0?s:100*this.m_toTolerance,l/=this.m_rpuGcsTo*this.m_aTo/this.m_mpuTo;const u=l*l;let f;return r=A(h,this.m_transform1,this.m_bIsPannableFrom,this.m_pannableExtentFrom,!0,this.m_pannableExtentGcsTo,null,null,0,null,o,u,i),h=null,r=(new d).execute(r,this.m_transform1,i),f=e>0?e*(Math.PI/180/this.m_rpuGcsTo):Math.PI/180/this.m_rpuGcsTo*1e-5,r=Q(r,this.m_transform2.getInputSR(),this.m_horizon2,this.m_bInclusive2,!0,this.m_pannableExtentGcsTo,!1,Number.NaN,i),r=D(r,this.m_transform2.getOutputSR(),i),r=A(r,this.m_transform2,!0,this.m_pannableExtentGcsTo,this.m_bIsPannableTo,this.m_pannableExtentTo,null,null,0,null,f,n,i),r=(new d).execute(r,this.m_transform2,i),r}getMinLengthInSrFrom(t){let e;return e=this.m_bSrFromIsPcs?this.m_aFrom*(t*Math.PI/180)/this.m_mpuFrom:t*Math.PI/180*(1/this.m_rpuFrom),e}filterOverDensification(t,e,s,i){let n=function(t,e){if(t.isEmpty()||!t.hasAttribute(10))return t;const s=e*e;let i=t.getAttributeStreamRef(10),n=!1;const o=new C,r=[];let h=!1;for(let e=0,m=t.getPathCount();e<m;e++){const m=t.getPathStart(e),a=t.getPathEnd(e),c=t.isClosedPath(e);if(!(a>m))continue;{const t=c?m:a-1;0===i.read(m)&&0===i.read(t)||(n||(i=i.clone(),n=!0),i.write(m,0),i.write(t,0))}const u=c?a+1:a;let f=m;for(let e=m;e<u;e++){const c=e===a?m:e;if(0===i.read(c)){if(e-f>1){r.push({from:f,to:e});const c=new l;for(;r.length>0;){const e=r.at(-1);r.pop(),o.setStartXY(t.getXY(e.from));const u=e.to===a?m:e.to;o.setEndXY(t.getXY(u));let f=s,g=-1;for(let s=e.from+1,i=e.to;s<i;s++){const e=t.getXY(s),i=o.getClosestCoordinate(e,!1);o.queryCoord2D(i,c);const n=l.sqrDistance(c,e);f<n&&(f=n,g=s)}g>=0?(n||(i=i.clone(),n=!0),i.write(g,0),g-e.from>1&&r.push({from:e.from,to:g}),e.to-g>1&&r.push({from:g,to:e.to})):h=!0}}f=c}}}if(!h)return t;const m=function(t,e){const s=t.createInstance(),i=new g;for(let n=0,o=t.getPathCount();n<o;n++){let o=!0,r=0,h=0;const m=t.getPathStart(n),a=t.getPathEnd(n);let c=!0;for(let l=m;l<a;l++)1===e.read(l)?(!c&&h>0&&(s.addSegmentsFromPath(t,n,r-m,h,o),h=0),c=!0):c?(c=!1,t.getPointByVal(l,i),o?(s.startPathPoint(i),o=!1):s.lineToPoint(i),r=l):h++;h>0&&s.addSegmentsFromPath(t,n,r-m,h,o)}return s}(t,i);return m.dropAttribute(10),m}(t,s);return n.dropAttribute(10),n!==t&&n.getGeometryType()===r.enumPolygon&&(n=(new S).execute(n,e,!1,i)),n}}function X(t){if(!t)return!1;const e=t.getCoordinateSystemType();return 2===e||1===e}function A(t,e,s,i,n,o,r,h,m,a,c,l,u){const f=t.createInstance();f.addAttribute(10);const g=t.querySegmentIterator(),_=[],d=[],p=new x,P=t.getDescription().getAttributeCount()>1,T=new nt(e,s,i,n,o,r,h,a,c,l,P?d:null,_,u);for(;g.nextPath();)for(;g.hasNextSegment();){const t=g.nextSegment(),e=t.getStartXY(),s=t.getEndXY(),i=e.compare(s)>0,n=B(i,t,p);if(_.length=0,d.length=0,!T.densifySegment(g.isFirstSegmentInPath(),n))return null;i&&U(P?d:null,_),_.at(-1).setCoordsPoint2D(t.getEndXY());const o=f.getPointCount();if(P){const e=B(i,t,p);H(g.isFirstSegmentInPath(),g.isLastSegmentInPath()&&!g.isPathClosed(),t,e,d,_,f)}else Y(g.isFirstSegmentInPath(),g.isLastSegmentInPath()&&!g.isPathClosed(),_,f);if(T.needsPostFiltering()){f.addAttribute(10);const t=f.getAttributeStreamRef(10);for(let e=1,s=_.length-1;e<s;e++)t.write(e+o,1)}}return f}function Y(t,e,s,i){t&&i.insertPath2D(-1,null,0,0,!0);const n=i.getPathCount()-1;e?i.insertPointsFromPoints(n,-1,s,0,s.length,!0):i.insertPointsFromPoints(n,-1,s,0,s.length-1,!0)}function H(t,e,s,i,n,o,r){r.reserve(r.getPointCount()+o.length-1);const h=new g;if(s.queryStart(h),t?r.startPathPoint(h):r.lineToPoint(h),o.length>2){const t=i.calculateLength2D();for(let e=1;e<o.length-1;e++){const s=i.lengthToT(n[e]*t);i.queryCoord(s,h),h.setXY(o[e]),r.lineToPoint(h)}}e&&(s.queryEnd(h),r.lineToPoint(h))}function O(t,e){const s=e.getInputSR(),i=e.getOutputSR(),n=new l;2===s.getCoordinateSystemType()?(n.setCoordsPoint2D(t),G(s,0,[n],1)):n.setCoordsPoint2D(t);const o=new l;o.setCoordsPoint2D(n),v(e,[o],null,1,!1);const r=new l;return 2===i.getCoordinateSystemType()?(r.setCoordsPoint2D(o),z(i,[r],1,!1)):r.setCoordsPoint2D(o),r}function j(t,e,s,i,n,o,r,h){if(n){const n=o.width(),m=.5*n;if(i){const i=.25*n;let o=!1;const a=new l,c=new l;if(Math.abs(t.y)===i?(a.setCoords(s.x,t.y),c.setCoordsPoint2D(s),o=!0):Math.abs(s.y)===i&&(c.setCoords(t.x,s.y),a.setCoordsPoint2D(t),o=!0),Math.abs(e.y)===i&&(o||(a.setCoordsPoint2D(t),c.setCoordsPoint2D(s),o=!0),a.x=e.x),o)return K(e,a,m,n,r),K(e,c,m,n,h),!0}let a=0;t.x-e.x>m&&s.x-e.x>m?a-=n:e.x-t.x>m&&e.x-s.x>m&&(a+=n),Math.abs(e.x-(t.x+a))<m?(r.setCoordsPoint2D(t),K(r,s,m,n,h),r.x+=a,h.x+=a):(r.setCoordsPoint2D(s),K(r,t,m,n,h),r.x+=a,h.x+=a)}else r.setCoordsPoint2D(t),h.setCoordsPoint2D(s);return!1}function B(t,e,s){return t?(s.create(e.getGeometryType()),e.copyTo(s.get()),s.get().reverse(),s.get()):e}function U(t,e){e.reverse(),null!==t&&t.reverse()}function W(t,e,s,i){const n=.5*(i.getStartX()+i.getEndX());if(n-s>t){const t=new k;t.setShiftCoords(-e,0),i.applyTransformation(t)}else if(s-n>t){const t=new k;t.setShiftCoords(e,0),i.applyTransformation(t)}}function Q(t,e,s,i,n,o,r,h,m){const a=[!1];r&&V(t,e,s,i,n,o,!0,h,a,m);let c=t;return a[0]||(c=V(c,e,s,i,n,o,!1,h,null,m)),c=function(t,e,s,i){let n;if(!e)return t;const o=s.getCenter().x,r=s.width(),h=.5*r,m=new _;t.queryEnvelope(m);const a=m.getCenter().x;let c=0;if(a-o>h?c=-Math.ceil((a-o-h)/r)*r:o-a>h&&(c=Math.ceil((o-a-h)/r)*r),0!==c){n=i?t:t.clone();const e=new k;e.setShiftCoords(c,0),n.applyTransformation(e)}else n=t;return n}(c,n,o,c!==t),c}function V(t,e,s,i,n,o,h,m,a,c){if(h&&(a[0]=!1),null==s)return t;const l=new _,u=new _;s.queryEnvelope(l),t.queryEnvelope(u);const f=t.getGeometryType(),g=s.getGeometryType(),d=e.getTolerance(0);if(!n){if(h)return a[0]=Z(t,s,e,i,c),null;let n;return n=i?g===r.enumEnvelope?N(t,l,d,m,c):(new y).execute(t,s,e,c):(new w).execute(t,s,e,c),n===s&&(n=s.clone()),n}const p=o.width(),P=p*Math.ceil(l.width()/p);let T=null;if(i){let o=J(t,s,n,P),b=0;const D=new k;do{let n=null;if(g===r.enumEnvelope){const r=s.clone();if(D.setShiftCoords(o*P,0),r.applyTransformation(D),h){if(a[0]=Z(t,r,e,i,c),!a[0])return null}else{const e=new _;r.queryEnvelope(e),n=N(t,e,d,m,c)}}else{const r=t.clone();if(D.setShiftCoords(-o*P,0),r.applyTransformation(D),h){if(a[0]=Z(r,s,e,i,c),!a[0])return null}else n=(new y).execute(r,s,e,c),n===s&&(n=s.clone())}if(!h){if(n.isEmpty())continue;if(f===r.enumPolygon){const t=new _;if(n.queryEnvelope(t),t.width()<=d)continue}g===r.enumEnvelope&&(D.setShiftCoords(-o*P,0),n===t&&(n=n.clone()),n.applyTransformation(D)),null===T?T=n===t?n.clone():n:T.add(n,!1)}b++}while(l.xmin+ ++o*P<u.xmax);if(h)return null;null===T&&(T=t.createInstance()),f===r.enumPolygon&&b>1&&p-u.width()<=10*d&&(T=(new S).execute(T,e,!0,c))}else{let o=J(t,s,n,P);if(T=t.clone(),0!==o){const t=new k;t.setShiftCoords(-o*P,0),T.applyTransformation(t)}do{if(h){if(a[0]=Z(T,s,e,i,c),!a[0])return null}else if(T=(new w).execute(T,s,e,c),T===s&&(T=s.clone()),T.isEmpty())break;const t=new k;t.setShiftCoords(-P,0),T.applyTransformation(t)}while(l.xmin+ ++o*P<u.xmax);if(h)return null;if(!T.isEmpty()&&0!==o){const t=new k;t.setShiftCoords(o*P,0),T.applyTransformation(t)}}return T}function Z(t,e,s,i,n){let o;if(e.getGeometryType()===r.enumPolygon)o=E(e,t,s,i?64:4,n);else if(i){const s=new _,i=new _;e.queryEnvelope(s),t.queryEnvelope(i),o=s.containsEnvelope(i)}else o=E(e,t,s,4,n);return o}function J(t,e,s,i){if(!s)return 0;let n=0;const o=new _;e.queryEnvelope(o);const r=new _;t.queryEnvelope(r);const h=o.xmin+i;for(;h+i+n*i>r.xmin;)n--;for(;h+n*i<r.xmin;)n++;return n}function K(t,e,s,i,n){e.x-t.x>s?n.setCoords(e.x-i,e.y):t.x-e.x>s?n.setCoords(e.x+i,e.y):n.setCoordsPoint2D(e)}function $(t,e,s,i,n,o,r){Math.abs(t.y)===s?(o.setCoords(e.x,t.y),r.setCoordsPoint2D(e)):Math.abs(e.y)===s?(o.setCoordsPoint2D(t),r.setCoords(t.x,e.y)):(o.setCoordsPoint2D(t),K(o,e,i,n,r))}function tt(t){return t.getUnit().getUnitToBaseFactor()}function et(t){return t.getUnit().getUnitToBaseFactor()}function st(t){return t.getPECoordSys().getDatum().getSpheroid().getAxis()}function it(t,e,s){return s<=.5?t+(e-t)*s:e-(e-t)*(1-s)}class nt{checkSegment(){for(let t=0;t<this.n;t++){if(null!==this.pSplitLines2Info&&this.pSplitLines2Info.hasSplitLines()&&!this.bCheckIfNoDensificationNeededForCurve){const t=this.pSplitLines2Info.getSplitLineFactorEx(this.rectifiedSegment,this.leftFactor,this.rightFactor,this.leftGcsToDensifiedPoint,this.rightGcsToDensifiedPoint,this.progressTracker);if(Number.isNaN(t))return-1;if(-1!==t&&this.leftFactor<t&&t<this.rightFactor)return this.cutFactor=t,this.cutFromDensifiedPoint.assign(this.rectifiedSegment.getCoord2D(this.cutFactor)),this.cutToDensifiedPoint.assign(O(this.cutFromDensifiedPoint,this.transform)),this.cutGcsToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.cutToDensifiedPoint.assign(O(this.cutGcsToDensifiedPoint,this.transform2)),this.midFactor=this.cutFactor,this.midFromDensifiedPoint.setCoordsPoint2D(this.cutFromDensifiedPoint),this.midToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.midGcsToDensifiedPoint.setCoordsPoint2D(this.cutGcsToDensifiedPoint),1}if(this.cutFactor=it(this.leftFactor,this.rightFactor,this.scalars[t]),this.cutFromDensifiedPoint.assign(this.rectifiedSegment.getCoord2D(this.cutFactor)),this.cutToDensifiedPoint.assign(O(this.cutFromDensifiedPoint,this.transform)),null!==this.transform2&&(this.cutGcsToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.cutToDensifiedPoint.assign(O(this.cutGcsToDensifiedPoint,this.transform2))),0===t&&(this.midFactor=this.cutFactor,this.midFromDensifiedPoint.setCoordsPoint2D(this.cutFromDensifiedPoint),this.midToDensifiedPoint.setCoordsPoint2D(this.cutToDensifiedPoint),this.midGcsToDensifiedPoint.setCoordsPoint2D(this.cutGcsToDensifiedPoint)),this.bIsPannableFrom&&!this.bCheckIfNoDensificationNeededForCurve&&Math.abs(this.leftFromDensifiedPoint.x-this.rightFromDensifiedPoint.x)>=.25*this.pannableExtentFrom.width())return 1;let e;if(this.bCheckIfNoDensificationNeededForCurve){const t=this.projCurveSegment.get().getClosestCoordinate(this.cutToDensifiedPoint,!1),s=this.projCurveSegment.get().getCoord2D(t);e=l.sqrDistance(this.cutToDensifiedPoint,s)}else{const s=new l,i=new l,n=j(this.leftToDensifiedPoint,this.cutToDensifiedPoint,this.rightToDensifiedPoint,this.bSrToIsGcs,this.bIsPannableTo,this.pannableExtentTo,s,i);this.line.setStartXY(s),this.line.setEndXY(i);const o=this.line.getClosestCoordinate(this.cutToDensifiedPoint,!0);if(n||t>0||Math.abs(o-this.scalars[t])<.3){const t=this.line.getCoord2D(o);e=l.sqrDistance(this.cutToDensifiedPoint,t)}else e=2*this.maxDeviationInSrToSq,this.bNeedPostFiltering=!0}if(e>this.maxDeviationInSrToSq)return this.bCheckIfNoDensificationNeededForCurve=!1,1}return 0}constructor(t,e,s,i,n,o,r,h,m,a,c,f,g){this.leftFromDensifiedPoint=new l,this.rightFromDensifiedPoint=new l,this.cutFromDensifiedPoint=new l,this.midFromDensifiedPoint=new l,this.leftToDensifiedPoint=new l,this.rightToDensifiedPoint=new l,this.cutToDensifiedPoint=new l,this.midToDensifiedPoint=new l,this.line=new C,this.leftGcsToDensifiedPoint=new l,this.rightGcsToDensifiedPoint=new l,this.cutGcsToDensifiedPoint=new l,this.midGcsToDensifiedPoint=new l,this.bSrToIsGcs=!1,this.bIsCurve=!1,this.leftFactor=0,this.rightFactor=0,this.bIsFirstInPath=!1,this.rectifiedSegment=null,this.transform=null,this.bIsPannableFrom=!1,this.pannableExtentFrom=new _,this.bIsPannableTo=!1,this.bNeedPostFiltering=!1,this.pannableExtentTo=new _,this.transform2=null,this.pHorizon2Info=null,this.pSplitLines2Info=null,this.minLengthInSrFrom=0,this.maxDeviationInSrToSq=0,this.cutFactor=0,this.midFactor=0,this.pDensifiedFactors=null,this.pDensifiedPoints=[],this.rightFromDensifiedPointsStack=[],this.rightToDensifiedPointsStack=[],this.rightGcsToDensifiedPointsStack=[],this.rightFactorsStack=[],this.projCurveSegment=new x,this.n=0,this.bCheckIfNoDensificationNeededForCurve=!1,this.scalars=u(7,Number.NaN),this.progressTracker=g,this.transform=t,this.bIsPannableFrom=e,this.pannableExtentFrom.assign(s),this.bIsPannableTo=i,this.pannableExtentTo.assign(n),this.transform2=o,this.pHorizon2Info=r,this.pSplitLines2Info=h,this.minLengthInSrFrom=m,this.maxDeviationInSrToSq=a,this.pDensifiedFactors=c,this.pDensifiedPoints=f,this.progressTracker=g,this.bNeedPostFiltering=!1}needsPostFiltering(){return this.bNeedPostFiltering}densifySegment(t,e){if(this.bIsFirstInPath=t,this.rectifiedSegment=e,this.leftGcsToDensifiedPoint.setNAN(),this.rightGcsToDensifiedPoint.setNAN(),this.cutGcsToDensifiedPoint.setNAN(),this.midGcsToDensifiedPoint.setNAN(),this.bSrToIsGcs=null!=this.transform2?1===this.transform2.getOutputSR().getCoordinateSystemType():1===this.transform.getOutputSR().getCoordinateSystemType(),this.bIsCurve=this.rectifiedSegment.isCurve(),this.leftFactor=0,this.rightFactor=1,this.leftFromDensifiedPoint.assign(this.rectifiedSegment.getStartXY()),this.rightFromDensifiedPoint.assign(this.rectifiedSegment.getEndXY()),this.leftToDensifiedPoint.assign(O(this.leftFromDensifiedPoint,this.transform)),this.rightToDensifiedPoint.assign(O(this.rightFromDensifiedPoint,this.transform)),null!==this.transform2&&(this.leftGcsToDensifiedPoint.setCoordsPoint2D(this.leftToDensifiedPoint),this.rightGcsToDensifiedPoint.setCoordsPoint2D(this.rightToDensifiedPoint),this.leftToDensifiedPoint.assign(O(this.leftGcsToDensifiedPoint,this.transform2)),this.rightToDensifiedPoint.assign(O(this.rightGcsToDensifiedPoint,this.transform2)),this.bIsFirstInPath&&!this.pHorizon2Info.isPointStartInHorizon(this.leftGcsToDensifiedPoint,this.progressTracker)))return!1;this.rightFromDensifiedPointsStack.length=0,this.rightToDensifiedPointsStack.length=0,this.rightGcsToDensifiedPointsStack.length=0,this.rightFactorsStack.length=0,this.rightFromDensifiedPointsStack.push(this.rightFromDensifiedPoint.clone()),this.rightToDensifiedPointsStack.push(this.rightToDensifiedPoint.clone()),this.rightFactorsStack.push(this.rightFactor),null!=this.transform2&&this.rightGcsToDensifiedPointsStack.push(this.rightGcsToDensifiedPoint.clone()),null!==this.pDensifiedPoints&&this.pDensifiedPoints.push(this.leftFromDensifiedPoint.clone()),null!==this.pDensifiedFactors&&this.pDensifiedFactors.push(this.leftFactor),this.bIsCurve?this.rectifiedSegment.getGeometryType()===r.enumBezier?this.n=7:this.n=5:this.n=3,function(t,e){for(let s=0;s<t;s++){let i=Math.ceil(s/2)/(t+1);s%2!=0&&(i=-i);const n=.5+i;e[s]=n}}(this.n,this.scalars);const s=this.rectifiedSegment.calculateLength2D();if(this.bCheckIfNoDensificationNeededForCurve=!1,this.bIsCurve){const t=new I({vd:this.rectifiedSegment.getDescription()});let e=(new d).execute(t,this.transform,this.progressTracker);if(null!==this.transform2){const t=new _;if(e.queryEnvelope(t),!this.pHorizon2Info.isEnvelopeInHorizon(t,this.progressTracker))return!1;e=(new d).execute(e,this.transform2,this.progressTracker)}e.getSegmentBuffer(0,this.projCurveSegment,!1),this.bCheckIfNoDensificationNeededForCurve=!0}for(;this.rightFromDensifiedPointsStack.length>0;){let t=!1;if(this.cutFactor=Number.NaN,this.midFactor=Number.NaN,this.midFromDensifiedPoint.setNAN(),this.midToDensifiedPoint.setNAN(),(this.rightFactor-this.leftFactor)*s>this.minLengthInSrFrom){const e=this.checkSegment();if(-1===e)return!1;t=0!==e}if(t)this.rightFromDensifiedPoint.setCoordsPoint2D(this.midFromDensifiedPoint),this.rightToDensifiedPoint.setCoordsPoint2D(this.midToDensifiedPoint),this.rightFactor=this.midFactor,this.rightFromDensifiedPointsStack.push(this.rightFromDensifiedPoint.clone()),this.rightToDensifiedPointsStack.push(this.rightToDensifiedPoint.clone()),this.rightFactorsStack.push(this.rightFactor),null!==this.transform2&&(this.rightGcsToDensifiedPoint.setCoordsPoint2D(this.midGcsToDensifiedPoint),this.rightGcsToDensifiedPointsStack.push(this.rightGcsToDensifiedPoint.clone()));else{if(null!==this.transform2&&!this.pHorizon2Info.isAdjoiningLineInHorizon(this.leftGcsToDensifiedPoint,this.rightGcsToDensifiedPoint,this.progressTracker))return!1;if(this.rightFromDensifiedPointsStack.pop(),this.rightToDensifiedPointsStack.pop(),this.rightFactorsStack.pop(),null!==this.transform2&&this.rightGcsToDensifiedPointsStack.pop(),null!==this.pDensifiedPoints&&this.pDensifiedPoints.push(this.rightFromDensifiedPoint.clone()),null!==this.pDensifiedFactors&&this.pDensifiedFactors.push(this.rightFactor),this.rightFromDensifiedPointsStack.length>0){this.leftFromDensifiedPoint.setCoordsPoint2D(this.rightFromDensifiedPoint),this.leftToDensifiedPoint.setCoordsPoint2D(this.rightToDensifiedPoint),this.leftFactor=this.rightFactor;const t=this.rightFromDensifiedPointsStack.at(-1),e=this.rightToDensifiedPointsStack.at(-1);if(this.rightFromDensifiedPoint.setCoordsPoint2D(t),this.rightToDensifiedPoint.setCoordsPoint2D(e),this.rightFactor=this.rightFactorsStack.at(-1),null!==this.transform2){this.leftGcsToDensifiedPoint.setCoordsPoint2D(this.rightGcsToDensifiedPoint);const t=this.rightGcsToDensifiedPointsStack.at(-1);this.rightGcsToDensifiedPoint.setCoordsPoint2D(t)}}}}return!0}}class ot{getOperatorType(){return 10315}supportsCurves(){return!1}accelerateGeometry(t,e,s){return!1}canAccelerateGeometry(t){return!1}executeMany(t,e,s,i,n,o){return q(s)?new rt(t,e,s,i,n,o):(new d).executeMany(t,s,o)}execute(t,e,s,i,n){if(!q(e))return(new d).execute(t,e,n);const o=new M;return o.prepare(e,null,n),o.execute(t,s,i,n)}}class rt extends t{constructor(t,s,i,n,o,r){super(),this.m_spp=null,this.m_index=-1,t||e(""),this.m_progressTracker=r,this.m_geometries=t,this.m_geometriesExtent=s?s.clone():null,this.m_transform=i,this.m_minSegmentLengthInDegrees=n,this.m_maxDeviationInSrTo=o}tock(){return!0}getRank(){return 1}next(){this.m_spp||(this.m_spp=new M,this.m_spp.prepare(this.m_transform,this.m_geometriesExtent,this.m_progressTracker));const t=this.m_geometries.next();return s(t),i(t),null!=t?(this.m_index=this.m_geometries.getGeometryID(),this.m_spp.execute(t,this.m_minSegmentLengthInDegrees,this.m_maxDeviationInSrTo,this.m_progressTracker)):null}getGeometryID(){return this.m_index}}export{ot as OperatorShapePreservingProject};
