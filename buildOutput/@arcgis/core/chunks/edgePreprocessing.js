/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{g as e,e as t}from"./mathUtils.js";import{P as s}from"./PooledArray.js";import{x as a,k as o,e as n,d as c,h as r,c as l,n as i,y as h}from"./vec3.js";import{c as g}from"./vec3f64.js";function p(t,s,g){const p=t.vertices.position,u=t.vertices.componentIndex,d=w.position0,D=w.position1,M=w.faceNormal0,P=w.faceNormal1,{edges:b,normals:k}=function(e){const t=e.faces.length/3,s=e.faces,a=e.neighbors,o=e.vertices.position;m.length=A.length=0;for(let e=0;e<t;e++){const t=3*e,n=a[t],c=a[t+1],h=a[t+2],g=s[t],p=s[t+1],u=s[t+2];o.getVec(g,y),o.getVec(p,N),o.getVec(u,V),r(N,N,y),r(V,V,y),l(y,N,V),i(y,y),A.pushArray(y),(-1===n||g<p)&&(m.push(g),m.push(p),m.push(e),m.push(n)),(-1===c||p<u)&&(m.push(p),m.push(u),m.push(e),m.push(c)),(-1===h||u<g)&&(m.push(u),m.push(g),m.push(e),m.push(h))}return{edges:m,normals:A}}(t),E=b.length/4,L=s.allocate(E);let U=0;const q=E,z=g?.allocate(q);let B=0,C=0,G=0;f.length=0;for(let e=0;e<E;++e){const t=4*e;p.getVec(b.data[t],d),p.getVec(b.data[t+1],D);const s=f.pushNew();s.index=4*e,s.length=a(d,D)}f.sort((e,t)=>t.length-e.length);const H=new Array,J=new Array;f.forAll(({length:t,index:a})=>{const r=b.data[a],i=b.data[a+1],f=b.data[a+2],m=b.data[a+3],A=-1===m;if(p.getVec(r,d),p.getVec(i,D),A){const e=3*f;o(M,k.data[e],k.data[e+1],k.data[e+2]),n(P,M),w.componentIndex=u.get(r),w.cosAngle=c(M,P)}else{let e=3*f;if(o(M,k.data[e],k.data[e+1],k.data[e+2]),e=3*m,o(P,k.data[e],k.data[e+1],k.data[e+2]),w.componentIndex=u.get(r),w.cosAngle=c(M,P),y=j,w.cosAngle>y)return;w.cosAngle<-.9999&&n(P,M)}var y,N;C+=t,G++,A||(N=F,w.cosAngle<N)?(s.write(L,U++,w),H.push(t)):function(t,s){const a=e(t.cosAngle);return h(x,t.position1,t.position0),a*(c(l(v,t.faceNormal0,t.faceNormal1),x)>0?-1:1)>s}(w,I)&&(z&&g&&g.write(z,B++,w),J.push(t))});const K=new Float32Array(H.reverse()),O=new Float32Array(J.reverse()),Q=z&&g?{instancesData:z.slice(0,B),lodInfo:{lengths:O}}:void 0;return{regular:{instancesData:L.slice(0,U),lodInfo:{lengths:K}},silhouette:Q,averageEdgeLength:C/G}}class u{constructor(){this.index=0,this.length=0}}function d(){f.prune(),m.prune(),A.prune()}const f=new s({allocator:e=>e||new u,deallocator:null}),m=new s({deallocator:null}),A=new s({deallocator:null}),w=new class{constructor(){this.position0=g(),this.position1=g(),this.faceNormal0=g(),this.faceNormal1=g(),this.componentIndex=0,this.cosAngle=0}},v=g(),x=g(),y=g(),N=g(),V=g(),I=t(4),j=Math.cos(I),D=t(35),F=Math.cos(D);export{d as c,p as e};
