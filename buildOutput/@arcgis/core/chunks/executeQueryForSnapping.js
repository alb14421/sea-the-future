/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{clone as e}from"../core/lang.js";import{signalFromSignalOrOptions as t}from"../core/promiseUtils.js";import{fromJSON as a}from"../geometry/support/jsonUtils.js";import{normalizeCentralMeridian as r}from"../geometry/support/normalizeUtils.js";import{p as i}from"./unitUtils.js";import{c as s,p as n}from"./projectionSupport.js";import{v as o,Q as l,g as p}from"./QueryEngine.js";import{n as c}from"./queryUtils.js";import{g as m}from"./timeSupport.js";async function u(u,f,y){const d=t(y),{point:x,distance:g,returnEdge:R,vertexMode:w}=f;if(!R&&"none"===w)return{candidates:[]};let h=e(f.query);h=await u.schedule(()=>c(h,u.definitionExpression,u.spatialReference),d),h=await u.reschedule(()=>o(h,{availableFields:u.availableFields,fieldsIndex:u.fieldsIndex,geometryType:u.geometryType,spatialReference:u.spatialReference}),d);const j=!i(x.spatialReference,u.spatialReference);j&&await s(x.spatialReference,u.spatialReference);const b="number"==typeof g?g:g.x,S="number"==typeof g?g:g.y,Q={xmin:x.x-b,xmax:x.x+b,ymin:x.y-S,ymax:x.y+S,spatialReference:x.spatialReference},U=j?n(Q,u.spatialReference):Q;if(!U)return{candidates:[]};const v=(await r(a(x),null,{signal:d}))[0],F=(await r(a(U),null,{signal:d}))[0];if(null==v||null==F)return{candidates:[]};const T=new l(await u.reschedule(()=>u.searchFeatures(p(F.toJSON())),d),h,u);await u.reschedule(()=>u.executeObjectIdsQuery(T),d),await u.reschedule(()=>u.executeTimeQuery(T),d),await u.reschedule(()=>u.executeAttributesQuery(T),d),await u.reschedule(()=>async function(e,t,a){const{query:r}=t,{spatialRel:i}=r;if(!t?.items?.length||!r.geometry||!i)return;const s=await m(i,r.geometry,e.geometryType,e.hasZ,e.hasM),n=await e.runSpatialFilter(t.items,e=>s(e.geometry),a);t.items=n}(u,T,d),d);const q=v.toJSON(),E=j?n(q,u.spatialReference):q,I=j?Math.max(U.xmax-U.xmin,U.ymax-U.ymin)/2:g;return T.createSnappingResponse({...f,point:E,distance:I},h.returnZ,x.spatialReference)}export{u as e};
