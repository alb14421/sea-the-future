/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{p as t}from"./screenUtils.js";import{m as n}from"./timeUtils.js";import s from"../geometry/Point.js";import i from"../geometry/SpatialReference.js";import{b as o}from"./quantizationUtils.js";import{l as r,h as l}from"./unitUtils.js";import{isTimeOnlyField as a,l as u,isNumericField as f,numericTypes as c}from"../layers/support/fieldUtils.js";import{c as m,e as d}from"./heatmapUtils.js";import{i as p}from"./utils7.js";import{p as h,a as $}from"./utils13.js";let y=null;const g=/^(?<hh>([01][0-9])|(2[0-3])):(?<mm>[0-5][0-9])(:(?<ss>[0-5][0-9]))?(\.(?<ms>\d+))?$/;function j(e,t,n,i){const a=r(n)?l(n):null,u=a?Math.round((a.valid[1]-a.valid[0])/t.scale[0]):null;return e.map(e=>{const n=new s(e.geometry);return o(t,n,n),e.geometry=a?function(e,t,n){return e.x<0?e.x+=t:e.x>n&&(e.x-=t),e}(n,u??0,i[0]):n,e})}function b(e,n=18,s,i,o){const r=new Float64Array(i*o);n=Math.round(t(n));let l=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;const u=m(s);for(const{geometry:t,attributes:s}of e){const{x:e,y:f}=t,c=Math.max(0,e-n),m=Math.max(0,f-n),p=Math.min(o,f+n),h=Math.min(i,e+n),$=+u(s);for(let t=m;t<p;t++)for(let s=c;s<h;s++){const o=t*i+s,u=d(s-e,t-f,n)*$,c=r[o]+=u;l=Math.min(l,c),a=Math.max(a,c)}}return{min:l,max:a}}function x(e){const t=g.exec(e);if(!t)return null;const{hh:s,mm:i,ss:o,ms:r}=t.groups;return Number(s)*n.hours+Number(i)*n.minutes+Number(o)*n.seconds+Number(r||0)}async function w(e,t,n=!0){if(!t)return[];const{field:s,field2:o,field3:r,fieldDelimiter:l,fieldInfos:f,timeZone:c}=e,m=s&&f?.find(e=>e.name.toLowerCase()===s.toLowerCase()),d=!!m&&a(m),g=!!m&&p(m),j=e.valueExpression,b=e.normalizationType,w=e.normalizationField,I=e.normalizationTotal,F=[],N=e.viewInfoParams;let v=null,E=null;if(j){if(!y){const{arcadeUtils:e}=await u();y=e}y.hasGeometryOperations(j)&&await y.enableGeometryOperations(),v=y.createFunction(j),E=N?y.getViewInfo({viewingMode:N.viewingMode,scale:N.scale,spatialReference:new i(N.spatialReference)}):null}const U=e.fieldInfos,M=t[0]&&"declaredClass"in t[0]&&"esri.Graphic"===t[0].declaredClass||!U?null:{fields:U};return t.forEach(e=>{const t=e.attributes;let i;if(j){const t=M?Object.assign({},e,{layer:M}):e,n=y.createExecContext(t,E,c);i=y.executeFunction(v,n)}else t&&(i=t[s],o?(i=`${h(i)}${l}${h(t[o])}`,r&&(i=`${i}${l}${h(t[r])}`)):"string"==typeof i&&n&&(g?i=i?new Date(i).getTime():null:d&&(i=i?x(i):null)));if(b&&"number"==typeof i&&isFinite(i)){const e=t&&parseFloat(t[w]);i=$(i,b,e,I)}F.push(i)}),F}function I(e){const t=e.field,n=e.normalizationType,s=e.normalizationField;let i;return"field"===n?i="(NOT "+s+" = 0)":"log"!==n&&"natural-log"!==n&&"square-root"!==n||(i=`(${t} > 0)`),i}function F(e,t,n){const s=null!=t?e+" >= "+t:"",i=null!=n?e+" <= "+n:"";let o="";return o=s&&i?E(s,i):s||i,o?"("+o+")":""}function N(t,n,s,i){let o;return n?n.name!==t.objectIdField&&i.includes(n.type)||(o=new e(s,"'field' should be one of these types: "+i.join(","))):o=new e(s,"'field' is not defined in the layer schema"),o}function v(t,n,s){let i;return n?n.name!==t.objectIdField&&f(n)||(i=new e(s,"'field' should be one of these numeric types: "+c.join(","))):i=new e(s,"'field' is not defined in the layer schema"),i}function E(e,t){let n=null!=e?e:"";return null!=t&&t&&(n=n?"("+n+") AND ("+t+")":t),n}function U(t,n){if(t&&"intersects"!==t.spatialRelationship)return new e(n,"Only 'intersects' spatialRelationship is supported for featureFilter")}function M(t,n,s){const i=function(e){const t=e.layer;return e.fields.filter(e=>!t.getField(e))}({layer:t,fields:n});if(i.length)return new e(s,"Unknown fields: "+i.join(", ")+". You can only use fields defined in the layer schema");const o=function(e){const t=e.layer;return e.fields.filter(e=>{const n=t.getFieldUsageInfo(e);return!n||!n.supportsStatistics})}({layer:t,fields:n});return o.length?new e(s,"Unsupported fields: "+o.join(", ")+". You can only use fields that can be fetched i.e. AdapterFieldUsageInfo.supportsStatistics must be true"):void 0}function T(e,t,n){const s=[],i=[],o=[],r=[],l=[];e.forEach((e,t)=>{const a=e.field?"field":"expression",u=e.field||e.valueExpression;e.field?(l.push(u),i.push(`var ${a}${t} = Number($feature["${u}"]);`)):(s.push(`function getValueForExpr${t}() {\n  ${u} \n}`),i.push(`var ${a}${t} = Number(getValueForExpr${t}());`)),n||o.push(`${a}${t} = IIf(${a}${t} < 0, 0, ${a}${t});`),r.push(`${a}${t}`)});const a=s.length?null:l.reduce((e,t)=>`${e} + ${t}`);let u=null;return t||n?t?n||a&&(u=`(( ${a} ) >= 0)`):a&&(u=`(( ${a} ) <> 0)`):a&&(u=`(( ${a} ) > 0)`),{valueExpression:[s.length?s.join("\n"):"",i.join("\n"),o.join("\n"),`var total = ${r.join(" + ")};`,"return total;"].filter(Boolean).join("\n\n"),sqlExpression:a,sqlWhere:u}}export{I as a,w as b,b as c,v as d,U as e,N as f,F as g,T as h,E as m,j as q,x as t,M as v};
