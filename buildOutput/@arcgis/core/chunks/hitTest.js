/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../Graphic.js";import{i as n}from"../core/Handles.js";import{s as i,b as t}from"./screenUtils.js";import{c as r}from"./vec3f64.js";import s from"../geometry/Point.js";import a from"../geometry/SpatialReference.js";import{p as l}from"./projectVectorToVector.js";import{f as o}from"./LayerConstants.js";import{t as c}from"./layerUtils.js";import{d as u}from"./debugFlags2.js";import{g as d}from"./ElevationProvider.js";import{t as p,I as f}from"./Intersector2.js";import{i as m}from"./HUDIntersectorResult.js";import{a as y,b as g}from"./intersectorUtilsConversions.js";async function h(e,n,i,r){const s=i?I(e,i):r,a=t(n.x,n.y);s.requiresGroundFeedback=!0,s.enableDraped=!0;const l=new f(e.state.viewingMode);l.options.selectionMode=!0,l.options.store=2,e.sceneIntersectionHelper.intersectIntersectorScreen(a,l,s);const o=await async function(e,n,i){const t=new Array;let r,s=null;const a={defer(e){r=e()}};for(let l=0;l<n.length;l++){const o=n[l],u=g(o,e);if(null!=u&&(u===e.map.ground||"type"in u&&c(u.type)))break;const d=y(o,e,a)??await r;if(r=null,null==d)continue;if("graphic"===d.type){if(null==s&&l!==n.length-1&&(s=new Set),null!=s){const e=U(d.graphic);if(s.has(e))continue;s.add(e)}if(!E(i,d.graphic))continue}const p=j(e,o),f=o.distanceInRenderSpace;if("media"===d.type){const e=d.element.toSource(p);t.push({...d,mapPoint:p,distance:f,sourcePoint:e})}else t.push({...d,mapPoint:p,distance:f})}return t}(e,l.results.all,s.graphics),d=l.results.ground,p=g(d,e),h=null!=p&&"type"in p&&c(p.type)?p:null,w={screenPoint:n,results:o,ground:{mapPoint:j(e,d),distance:m(d)?d.distanceInRenderSpace:0,layer:h}};return u.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(w.intersector=l),w}function w(e,n,t,r){const s=t?I(e,t):r,a=!(!s.graphics?.include&&!s.graphics?.exclude),l=!(!s.mediaElements?.include&&!s.mediaElements?.exclude),o=i(n);s.enableDraped=s.include&&!s.include.has(p)||s.exclude?.has(p);const c=e.sceneIntersectionHelper,u=new f(e.state.viewingMode);if(u.options.selectionMode=!0,u.options.store=a||l?2:0,u.options.excludeLabels=t?.excludeLabels??!1,c.intersectIntersectorScreen(o,u,s),a||l){for(const n of u.results.all){const i=y(n,e);if(null==i)return j(e,n);if(a&&("graphic"!==i.type||E(s.graphics,i.graphic)))return j(e,n);if(l&&("media"!==i.type||S(s.mediaElements,i.element)))return j(e,n)}return null}return j(e,u.results.min)}function j(e,n,i){return n.getIntersectionPoint(P)?(i=V(e,P,i),2===n.intersector&&e.basemapTerrain&&(i.z=d(e.basemapTerrain,i)??0),i):null}function U(e){const n=e.sourceLayer,i=e.layer,t=n&&"objectIdField"in n?n:i&&"objectIdField"in i?i:n;if(t){const n=t.objectIdField??o,i=e.attributes?.[n];if(i)return`o-${t.id}-${i}`}return`u-${e.uid}`}function E(e,n){return S(e,U(n))}function S(e,n){return null==e||(null==e.include||e.include.has(n))&&(null==e.exclude||!e.exclude.has(n))}function V(e,n,i){let t=e.spatialReference||a.WGS84;return l(n,e.renderSpatialReference,P,t)?n=P:(t=a.WGS84,l(n,e.renderSpatialReference,P,t)&&(n=P)),i?(i.x=n[0],i.y=n[1],i.z=n[2],i.spatialReference=t):i=new s(n,t),i}function I(e,n){const i=b(e,n.include,0),t=b(e,n.exclude,1);return{include:i.layerViewUids,exclude:t.layerViewUids,graphics:{include:i.graphicUids,exclude:t.graphicUids},mediaElements:{include:i.mediaElements,exclude:t.mediaElements}}}function b(i,t,r,s=new x){if(!t)return s;if(t instanceof e)!function(e,n){e.graphicUids??=new Set,e.graphicUids.add(n)}(s,U(t)),0===r&&(null!=i.graphicsView&&t.layer===i?T(s,i.graphicsView.uid):t.layer&&R(s,i,t.layer.uid));else if("layer"in t&&"element"in t)!function(e,n){e.mediaElements??=new Set,e.mediaElements.add(n)}(s,t.element),0===r&&R(s,i,t.layer.uid);else if(n(t))for(const e of t)e===i.graphics&&null!=i.graphicsView?T(s,i.graphicsView.uid):e===i.map.ground?T(s,p):b(i,e,r,s);else"layer"in t&&function(e,n,i){const t=n.allLayerViews.find(e=>e.layer.uid===i.layer.uid);if(!t)return;e.layerViewUids??=new Map;const r=e.layerViewUids.get(t.uid);!0!==r&&(r?r.add(i.id):e.layerViewUids.set(t.uid,new Set([i.id])))}(s,i,t),"uid"in t&&R(s,i,t.uid);return s}class x{constructor(){this.layerViewUids=null,this.graphicUids=null,this.mediaElements=null}}function R(e,n,i){const t=n.allLayerViews.find(e=>e.layer.uid===i);t&&T(e,t.uid)}function T(e,n){e.layerViewUids??=new Map,e.layerViewUids.set(n,!0)}const P=r();export{V as c,I as e,h,w as t};
