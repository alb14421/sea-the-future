/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Error.js";import"./Logger.js";import"../core/lang.js";import{subclass as s}from"../core/accessorSupport/decorators/subclass.js";import{unpackFieldNames as r,populateMissingFields as a}from"../layers/support/fieldUtils.js";import{a as o,g as p}from"./popupUtils.js";const i=i=>{const c=i;let n=class extends c{_validateFetchPopupFeatures(e){const{layer:s}=this,{popupEnabled:r}=s;if(!r)throw new t("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:s});if(!o(s,e))throw new t("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}async prepareFetchPopupFeatures(e){}async fetchPopupFeaturesFromGraphics(e,t){if(this._validateFetchPopupFeatures(t),0===e.length)return[];const s="scene"===this.layer.type&&null!=this.layer.associatedLayer?this.layer.associatedLayer:this.layer;let i=[];"fieldsIndex"in this.layer&&(i=r(this.layer.fieldsIndex,await p(s,o(this.layer,t)))),await this.prepareFetchPopupFeatures(i);const c=new Set,n=[],l=[];for(const t of e)a(t,i,c)?l.push(t):n.push(t);if(0===l.length)return n;const u=new Map;for(let t=0;t<e.length;t++)u.set(e[t].getObjectId()??0,t);const h=await this.whenGraphicAttributes(l,[...c]).catch(()=>l).then(e=>n.concat(e));return h.sort((e,t)=>{const s=e.getObjectId()??0,r=u.get(s)??0,a=t.getObjectId()??0;return r-(u.get(a)??0)}),h}};return n=e([s("esri.views.3d.layers.support.PopupSceneLayerView")],n),n};export{i as P};
