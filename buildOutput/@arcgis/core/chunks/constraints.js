/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{watch as t,syncAndInitial as e}from"../core/reactiveUtils.js";import{i as s}from"./SetUtils.js";import{sqlAnd as n}from"../core/sql.js";import{b as r}from"./timeUtils.js";import{u as i,s as o,c as a,d as c,B as u,a as f,k as h,h as l,e as d,x as p,g as m,n as g,w as y,D as _}from"./vec3.js";import{m as k}from"./dehydratedPoint.js";import M from"../rest/support/Query.js";import{V as w}from"./InputManager.js";import{b as x}from"./keybindings.js";import{d as j,b as L,e as v,g as P,a as T,f as q,c as z}from"./normalizedPoint.js";import{i as b}from"./utils11.js";import{i as D,e as S}from"../core/lang.js";import{f as O,h as R}from"./mathUtils.js";import{d as Z,k as I,g as A,j as U,b as E,l as H,s as C,h as G,q as N,p as V}from"./vec2.js";import{c as J,f as B,Z as K}from"./vec2f64.js";import{c as Q,b as F,f as W,e as X}from"./vec3f64.js";import{s as Y,f as $}from"./vec4.js";import{c as tt}from"./vec4f64.js";import{t as et}from"./geodesicConstants.js";import{directGeodeticSolver as st,inverseGeodeticSolver as nt,InverseGeodeticSolverResult as rt}from"../geometry/support/geodesicUtils.js";import{c as it,j as ot,f as at,u as ct,t as ut,o as ft,p as ht,g as lt,l as dt}from"./plane.js";import{e as pt,h as mt,j as gt,p as yt,g as _t}from"./sphere.js";import{t as kt}from"./mathUtils2.js";import{g as Mt}from"./common.js";import{i as wt}from"./geometry2dUtils.js";const xt=Symbol("grid-placement-graphic");function jt(t,e){const s=t.x-e.x,n=t.y-e.y;return s*s+n*n}function Lt(t,e){return Math.sqrt(jt(t,e))}function vt(t,e){e.sort((e,s)=>i(e.targetPoint,t)-i(s.targetPoint,t))}function Pt({parameters:{point:t,distance:e,returnEdge:i,vertexMode:o,coordinateHelper:{spatialReference:a},filter:c},mode:u,returnZ:f,filter:h}){const l=h?.clone()??new M({where:"1=1"});return l.returnZ=f??"3d"===u,c&&(l.geometry=c.geometry,l.distance=c.distance,l.spatialRelationship=c.spatialRelationship,l.where=n(l.where,c.where),l.timeExtent=r(l.timeExtent,c.timeExtent),l.objectIds=(d=l.objectIds,p=c.objectIds,d||p?p?d?Array.from(s(new Set(d),new Set(p))):p:d:null)),{point:k(t[0],t[1],t[2],a.toJSON()),mode:u,distance:e,returnEdge:i,vertexMode:o,query:l.toJSON()};var d,p}function Tt(t,e,s){return{left:j(t.leftVertex.pos,e,s),right:j(t.rightVertex.pos,e,s)}}const qt=Symbol("snapping-toggle");function zt(s,n=()=>{}){const r=t(()=>({view:s.view,snappingOptions:s.snappingOptions}),({view:t,snappingOptions:e})=>{if(s.removeHandles(qt),!t||!e)return;const r=w.TOOL,i=[t.on("key-down",t=>{t.key!==x.toggle||t.repeat||(e.enabledToggled=!0,n())},r),t.on("key-up",t=>{t.key===x.toggle&&(e.enabledToggled=!1,n())},r),t.on("pointer-move",t=>{const s=t.native.ctrlKey;e.enabledToggled!==s&&(e.enabledToggled=s,n())},r)];s.addHandles(i,qt)},e);s.addHandles(r)}function bt(t){return b(t)&&"utilityNetworks"in t&&!!t.utilityNetworks?.length}function Dt({start:t,end:e,type:s},n,r){const i=[],o=Z(Bt,e,t),a=Z(Kt,t,n),c=I(o),u=2*A(o,a),f=u*u-4*c*(I(a)-r*r);if(0===f){const e=-u/(2*c);(0===s||e>=0)&&i.push(U(J(),t,o,e))}else if(f>0){const e=Math.sqrt(f),n=(-u+e)/(2*c);(0===s||n>=0)&&i.push(U(J(),t,o,n));const r=(-u-e)/(2*c);(0===s||r>=0)&&i.push(U(J(),t,o,r))}return i}function St(t,e){const s=t.start,n=t.end,r=Z(Bt,n,s),i=h(Ft,-r[1],r[0],0),a=e.start,u=e.end,l=o(Wt,u,a),d=c(l,i),p=h(Xt,s[0],s[1],0),m=o(Yt,p,a),g=c(m,i),y=Mt();if(Math.abs(d)<y)return Math.abs(g),[];const _=f($t,a,l,g/d);if(0===e.type){const t=o(te,_,a);if(c(t,l)<-y)return[]}if(1===t.type){const t=E(Kt,_,s);if(A(t,r)<-y)return[]}return[F(_)]}function Ot(t,e){return Et(Ct(se,0,t),Ct(ne,0,e)).map(([t,e])=>B(t,e))}function Rt(t,e,s){return It(t,Ct(se,t[2],e),s)}function Zt(t,e,s,n=Q()){const r=Z(Bt,t,e),i=G(r);return U(n,e,r,0===i?1:s/i),n[2]=t[2],n}function It(t,{start:e,end:s,type:n},r=Q()){const i=o(Qt,t,e),a=o(Ft,s,e),u=c(i,a)/c(a,a);return f(r,e,a,0===n?Math.max(u,0):u)}const At=(()=>{const t=Q(),e=Q(),s=Q();return({start:n,end:r},{center:i,radius:o,normal:a,slicePlane:u})=>{const h=at(i,a,ee);if(Nt(ct(h,n),0)&&Nt(ct(h,r),0)){kt(a,t,e);const h=(n,r)=>(l(s,r,i),C(n,c(s,t),c(s,e)),n),p=wt({start:h(Bt,n),end:h(Kt,r)},K,o),m=[];for(const[s,n]of p){const r=d(Q(),i);f(r,r,t,s),f(r,r,e,n),u&&!Vt(u,r)||m.push(r)}return m}const m=Q();return ut(h,n,r,m)?!Nt(p(m,i),o)||u&&!Vt(u,m)?[]:[m]:[]}})();function Ut({start:t,end:e,type:s},n,r){const i=[],o=l(Qt,e,t),a=Z(Kt,t,n),c=I(o),u=2*A(o,a),h=u*u-4*c*(I(a)-r*r);if(0===h){const e=-u/(2*c);(1===s||e>=0)&&i.push(f(Q(),t,o,e))}else if(h>0){const e=Math.sqrt(h),n=(-u+e)/(2*c);(1===s||n>=0)&&i.push(f(Q(),t,o,n));const r=(-u-e)/(2*c);(1===s||r>=0)&&i.push(f(Q(),t,o,r))}return i}function Et(t,e){const s=t.start,n=t.end,r=e.start,i=e.end,h=o(Qt,n,s),l=o(Ft,i,r),d=o(Wt,r,s),p=a(Xt,h,l);if(!Nt(c(d,p),0))return[];const m=u(p);if(Nt(m,0))return[];const g=a(Yt,d,l),y=c(g,p)/m,_=f($t,s,h,y);if(0===t.type){const t=o(te,_,s);if(c(h,t)<-1e-6)return[]}if(0===e.type){const t=o(te,_,r);if(c(l,t)<-1e-6)return[]}return[F(_)]}function Ht(t,e,s,n){const[r,i]=t,[o,a]=s,c=o-r,u=a-i,f=c*c+u*u,h=Math.sqrt(f);if(h>e+n)return[];if(h<Math.abs(e-n))return[];if(Nt(h,0)&&Nt(e,n))return[];const l=(e*e-n*n+f)/(2*h),d=Math.sqrt(e*e-l*l),p=d*u/h,m=d*c/h,[g,y]=H(Bt,t,s,l/h);return Nt(p,m)?[B(g,y)]:[B(g+p,y-m),B(g-p,y+m)]}function Ct(t,e,{start:s,end:n,type:r}){return h(t.start,s[0],s[1],e),h(t.end,n[0],n[1],e),t.type=Jt[r],t}function Gt(t,e){return Nt(t[2],e[2])}function Nt(t,e){return O(Math.abs(t-e),0,Mt())}function Vt(t,e){return ot(t,e)}const Jt={0:1,1:0},Bt=J(),Kt=J(),Qt=Q(),Ft=Q(),Wt=Q(),Xt=Q(),Yt=Q(),$t=Q(),te=Q(),ee=it(),se={start:Q(),end:Q(),type:1},ne={start:Q(),end:Q(),type:1};class re{intersect(t){return De(this,t)}closestPoints(t){return[this.closestTo(t)]}}class ie extends re{constructor(t){super(),this.point=t}equals(t){return this===t||Ve(t)&&m(this.point,t.point)}closestTo(){return P(this.point)}}class oe extends re{constructor(t,e,s){super(),this.start=t,this.end=e,this.lineLike={start:t,end:e,type:s}}equals(t){return this===t||Je(t)&&this.lineLike.type===t.lineLike.type&&m(this.start,t.start)&&m(this.end,t.end)}closestTo(t){const e=L();return It(t,this.lineLike,e),e}}class ae extends oe{constructor(t,e){super(t,e,1)}}class ce extends oe{constructor(t,e){super(t,e,0)}}class ue extends re{constructor(t){super(),this.constraints=t}equals(t){return this===t||Ne(t)&&S(this.constraints,t.constraints,(t,e)=>t.equals(e))}closestTo(t){let e,s=1/0;for(const n of this.constraints){const r=n.closestTo(t),o=i(t,r);o<s&&(s=o,e=r)}return P(e??t)}closestPoints(t){return this.constraints.flatMap(e=>e===this?[]:e.closestPoints(t))}}class fe extends re{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||Qe(t)&&this.center[0]===t.center[0]&&this.center[1]===t.center[1]&&this.radius===t.radius}closestTo(t){const e=L();return Zt(t,this.center,this.radius,e),e}}class he extends re{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||Fe(t)&&m(this.center,t.center)&&this.radius===t.radius}closestTo(t){const e=L();return Zt(t,this.center,this.radius,e),e[2]=this.center[2],e}asCircle(){return new le(P(this.center),this.radius,q(0,0,1))}}class le extends re{constructor(t,e,s,n=void 0){super(),this.center=t,this.radius=e,this.normal=s,this.slicePlane=n}equals(t){return this===t||We(t)&&m(this.center,t.center)&&m(this.normal,t.normal)&&this.radius===t.radius}closestTo(t){const{center:e,radius:s}=this;ht(this.getPlane(pe),t,de);const n=o(de,de,e),r=y(n);if(Nt(r,0))return P(t);const i=s/Math.sqrt(r),a=L();f(a,e,n,i);const{slicePlane:c}=this;if(c&&!Vt(c,a)){const e=Oe(c,this);return e?.closestTo(t)??P(t)}return a}getPlane(t=it()){return at(this.center,this.normal,t)}}const de=Q(),pe=it();class me extends re{constructor(t){super(),this.z=t}equals(t){return this===t||Be(t)&&this.z===t.z}closestTo(t){return q(t[0],t[1],this.z)}getPlane(t=it()){return h(ge,0,0,this.z),at(ge,X,t)}}const ge=Q();class ye extends re{constructor(t,e,s){super(),this.start=t,this.end=e,this.planeLike={start:T(t),end:T(e),type:s}}equals(t){return this===t||Ke(t)&&this.planeLike.type===t.planeLike.type&&m(this.start,t.start)&&m(this.end,t.end)}closestTo(t){const e=L();return Rt(t,this.planeLike,e),e}closestEndTo(t){const{start:e,end:s}=this.planeLike;return Math.sign(A(Z(_e,s,e),Z(ke,T(t),e)))>0?this.end:this.start}getPlane(t=it()){const e=d(Me,this.end);return e[2]+=1,dt(this.start,this.end,e,t)}getSlicePlane(t=it()){const{start:e,end:s,type:n}=this.planeLike;if(0===n)return;const r=h(Me,e[0],e[1],0),i=h(we,s[0],s[1],0),o=l(we,i,r);return at(r,o,t),t}}const _e=J(),ke=J(),Me=Q(),we=Q();class xe extends ye{constructor(t,e){super(t,e,1)}}class je extends ye{constructor(t,e){super(t,e,0)}}class Le extends re{constructor(t,e){super(),this.sphere=mt(t,e)}equals(t){return this===t||Xe(t)&&gt(this.sphere,t.sphere)}closestTo(t){const e=L();return yt(this.sphere,t,e),e}get center(){return _t(this.sphere)}get radius(){return this.sphere[3]}}class ve extends re{constructor(t,e,s){super(),this.start=t,this.end=e,this.getZ=s,this.planeLike={start:T(t),end:T(e),type:0}}equals(t){return this===t||Ye(t)&&m(this.start,t.start)&&m(this.end,t.end)&&this.getZ===t.getZ}closestTo(t){return function(t,e){const s=L();return Rt(e,t.planeLike,s),s[2]=t.getZ(s[0],s[1])??$e,s}(this,t)}addIfOnTheGround(t,e){for(const s of e){const e=this.getZ(s[0],s[1])??0;Nt(s[2],e)&&(s[2]=e,t.push(s))}}}class Pe extends re{constructor(t,e,s){super(),this._x=t,this._y=e,this._z=s}equals(t){return this===t||t instanceof Pe&&this._x===t._x&&this._y===t._y&&this._z===t._z}closestTo([t,e,s]){return z(this._x??t,this._y??e,this._z??s)}}class Te extends re{constructor(t,e,s,n,r){super(),this._origin=t,this._spatialReference=e,this._distanceMeters=s,this._z=n,this._directionDegrees=r}equals(t){return this===t||t instanceof Te&&V(this._origin,t._origin)&&this._spatialReference===t._spatialReference&&this._distanceMeters===t._distanceMeters&&this._z===t._z&&this._directionDegrees===t._directionDegrees}closestTo([t,e,s]){return C(qe,t,e),V(qe,this._origin)||this._applyDirectionAndDistance(qe),z(qe[0],qe[1],this._z??s)}_applyDirectionAndDistance(t){if(null!=this._directionDegrees&&null!=this._distanceMeters)st(t,this._origin,this._directionDegrees,this._distanceMeters,this._spatialReference);else if(null!=this._directionDegrees)!function(t,e,s,n,r){let{azimuth:i,distance:o}=nt(be,e,n,r);i??=0;let a=o*Math.cos((i-s)*et);a=Math.max(0,a),st(t,e,s,a,r)}(t,this._origin,this._directionDegrees,t,this._spatialReference);else if(null!=this._distanceMeters){const{azimuth:e}=nt(ze,this._origin,t,this._spatialReference);st(t,this._origin,e??0,this._distanceMeters,this._spatialReference)}}}const qe=[0,0],ze=new rt,be=new rt;function De(t,e){if(Ne(t)){const s=[];for(const n of t.constraints){const t=n.intersect(e);t&&s.push(t)}return Ge(s)}if(Ne(e))return De(e,t);if(Ye(t))return Ue(t,e);if(Ye(e))return Ue(e,t);if(Ve(t)){const{point:s}=t;if(Ve(e))return m(s,e.point)?t:void 0;const n=e.closestTo(s);return _(n,s)?t:void 0}if(Je(t)){if(Ve(e))return De(e,t);if(Je(e))return He(Et(t.lineLike,e.lineLike));if(Be(e))return Se(t,e);if(Ke(e))return He(St(e.planeLike,t.lineLike));if(Qe(e))return He(Ut(t.lineLike,e.center,e.radius));if(We(e))return He(At(t.lineLike,e));if(Fe(e))return function({lineLike:t},{center:e,radius:s}){const n=e[2];return He(Ut(t,e,s).filter(t=>Nt(t[2],n)))}(t,e);if(Xe(e))return function({lineLike:t},{sphere:e}){return He(pt(e,t.start,t.end))}(t,e)}else if(Be(t)){if(Ve(e)||Je(e))return De(e,t);if(Be(e))return function(t,e){return Nt(t.z,e.z)?t:void 0}(t,e);if(Ke(e))return function({z:t},{planeLike:e}){const[s,n]=e.start,[r,i]=e.end,o=q(s,n,t),a=q(r,i,t);return 0===e.type?new ae(o,a):new ce(o,a)}(t,e);if(Qe(e))return function(t,e){const[s,n]=e.center;return new he(q(s,n,t.z),e.radius)}(t,e);if(We(e))return Re(t,e);if(Fe(e))return s=t,Nt((n=e).center[2],s.z)?n:void 0;if(Xe(e))return function(t,{center:e,radius:s}){const n=Math.abs(e[2]-t.z);if(n>s&&!Nt(n,s))return;const r=q(e[0],e[1],t.z),i=Math.sqrt(s**2-n**2);return Nt(i,0)?void 0:new he(r,i)}(t,e)}else if(Ke(t)){if(Ve(e)||Je(e)||Be(e))return De(e,t);if(Ke(e))return Ee(Ot(t.planeLike,e.planeLike));if(Qe(e))return Ee(Dt(t.planeLike,e.center,e.radius));if(We(e))return Ie(t,e);if(Fe(e))return Ze(t,e);if(Xe(e))return Ae(t,e)}else if(Qe(t)){if(Ve(e)||Je(e)||Be(e)||Ke(e))return De(e,t);if(Qe(e))return Ee(Ht(T(t.center),t.radius,T(e.center),e.radius));if(We(e))return;if(Fe(e))return function(t,e){return Nt(N(T(t.center),T(e.center)),0)&&Nt(t.radius,e.radius)?e:Ce(Ht(T(t.center),t.radius,T(e.center),e.radius),e.center[2])}(t,e);if(Xe(e))return}else if(We(t)){if(Ve(e)||Je(e)||Be(e)||Ke(e)||Qe(e))return De(e,t);if(We(e))return;if(Fe(e))return void e.asCircle();if(Xe(e))return}else if(Fe(t)){if(Ve(e)||Je(e)||Be(e)||Ke(e)||Qe(e)||We(e))return De(e,t);if(Fe(e))return function(t,e){if(Gt(t.center,e.center))return Nt(N(T(t.center),T(e.center)),0)&&Nt(t.radius,e.radius)?t:Ce(Ht(T(t.center),t.radius,T(e.center),e.radius),t.center[2])}(e,t);if(Xe(e))return}else if(Xe(t)){if(Ve(e)||Je(e)||Be(e)||Ke(e)||Qe(e)||Fe(e))return De(e,t);if(Xe(e))return}var s,n}const Se=(()=>{const t=it();return(e,s)=>{const{start:n,end:r}=e;if(Gt(n,r)&&Nt(n[2],s.z))return e;const i=L();return ut(s.getPlane(t),n,r,i)?new ie(i):void 0}})(),Oe=(()=>{const t=tt(),e=Q(),s=Q();return(n,r,i)=>{const{normal:o,center:u,radius:h}=r;kt(o,e,s);const l=lt(n),d=h*c(l,e),p=h*c(l,s);Y(t,u[0],u[1],u[2],1);const m=$(n,t),y=Math.hypot(d,p),_=Nt(y,0);if(Nt(ct(n,u),0)){if(_)return r;if(Nt(h,0))return!i||Vt(i,u)?new ie(P(u)):void 0;a(e,l,o),g(e,e);const t=new Array,s=F(u);f(s,s,e,h),i&&!Vt(i,s)||t.push(s);const n=F(u);return f(n,n,e,-h),i&&!Vt(i,n)||t.push(n),He(t)}if(_)return;const k=-m/y;if(Math.abs(k)>1||Nt(k,1))return;const M=Math.atan(d/p),w=R(k)-M,x=Math.PI-w,j=new Array,L=Q();f(L,u,e,h*Math.cos(w)),f(L,L,s,h*Math.sin(w)),j.push(L);const v=Q();return f(v,u,e,h*Math.cos(x)),f(v,v,s,h*Math.sin(x)),j.push(v),He(i?function(t,e){return e.filter(e=>Vt(t,e))}(i,j):j)}})(),Re=(()=>{const t=it();return(e,s)=>Oe(e.getPlane(t),s,s.slicePlane)})(),Ze=(()=>{const t=it();return(e,{center:s,radius:n})=>{const r=Dt(e.planeLike,s,n),i=s[2];e.getSlicePlane(t);const o=new Array;for(const[e,s]of r){const n=[e,s,i];Vt(t,n)&&o.push(n)}return He(o)}})(),Ie=(()=>{const t=it(),e=it();return(s,n)=>Oe(s.getPlane(t),n,s.getSlicePlane(e))})(),Ae=(()=>{const t=it();return(e,{center:s,radius:n})=>{const r=e.getPlane(t),i=ft(r,s),o=Math.abs(i);if(o>n&&!Nt(o,n))return;const a=Math.sqrt(n**2-i**2);if(Nt(a,0)){const t=L();return ht(r,s,t),new ie(t)}const c=L(),u=F(lt(r));return f(c,s,u,i),new le(c,a,u,e.getSlicePlane())}})();function Ue(t,e){const{planeLike:s,getZ:n}=t,r=new Array;if(Ve(e))t.addIfOnTheGround(r,(i=s,f=e.point,function({start:t,end:e,type:s},n){const r=o(Qt,n,t),i=o(Ft,e,t),f=a(Wt,i,r),h=u(f)/u(i),l=Mt();if(h<l)switch(s){case 1:return[F(n)];case 0:return c(i,r)<-l?[]:[F(n)]}return[]}(Ct(se,f[2],i),f)));else if(Je(e))t.addIfOnTheGround(r,St(s,e.lineLike));else if(Qe(e))for(const[t,i]of Dt(s,e.center,e.radius)){const e=n(t,i);null!=e&&r.push(W(t,i,e))}else if(Ke(e)||Ye(e))for(const[t,i]of Ot(s,e.planeLike)){const e=n(t,i)??$e;r.push(W(t,i,e))}var i,f;return He(r)}function Ee(t){return Ge(t.map(([t,e])=>{const s=q(t,e,0),n=q(t,e,1);return new ae(s,n)}))}function He(t){return Ge(t.map(t=>t?new ie(v(t)):void 0))}function Ce(t,e){return He(t.map(([t,s])=>[t,s,e]))}function Ge(t){if(0!==t.length)return 1===t.length?t[0]??void 0:new ue(t.filter(D))}function Ne(t){return t instanceof ue}function Ve(t){return t instanceof ie}function Je(t){return t instanceof oe}function Be(t){return t instanceof me}function Ke(t){return t instanceof ye}function Qe(t){return t instanceof fe}function Fe(t){return t instanceof he}function We(t){return t instanceof le}function Xe(t){return t instanceof Le}function Ye(t){return t instanceof ve}const $e=0;export{Pe as C,ve as D,Te as G,me as H,ae as L,ie as P,xe as V,zt as a,Lt as b,fe as c,Ge as d,Ve as e,jt as f,xt as g,Tt as h,bt as i,je as j,Pt as m,It as p,vt as s};
