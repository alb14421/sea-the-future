/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../request.js";import{urlToObject as t,join as n}from"../core/urlUtils.js";import{getJsonType as r}from"../geometry/support/jsonUtils.js";import{normalizeCentralMeridian as i}from"../geometry/support/normalizeUtils.js";import{Z as a}from"./unitUtils.js";import{p as s}from"./pbfQueryUtils.js";import{a as o}from"./queryZScale.js";function u(e){const t={};for(const n in e){if("declaredClass"===n)continue;const r=e[n];if(null!=r&&"function"!=typeof r)if(Array.isArray(r)){t[n]=[];for(let e=0;e<r.length;e++)t[n][e]=u(r[e])}else"object"==typeof r?r.toJSON&&(t[n]=JSON.stringify(r)):t[n]=r}return t}const l="Layer does not support extent calculation.";function c(e,t,n){const i=e.geometry,s=e.toJSON();delete s.compactGeometryEnabled,delete s.defaultSpatialReferenceEnabled;const o=s;let u,l,c;if(i&&(l=i.spatialReference,c=a(l),o.geometryType=r(i),o.geometry=function(e,t){if(t&&"extent"===e.type)return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(t&&"point"===e.type)return`${e.x},${e.y}`;const n=e.toJSON();return delete n.spatialReference,JSON.stringify(n)}(i,e.compactGeometryEnabled),o.inSR=c),s.groupByFieldsForStatistics&&(o.groupByFieldsForStatistics=s.groupByFieldsForStatistics.join(",")),s.objectIds)switch(n?.uniqueIdFields?.length){case void 0:o.objectIds=s.objectIds.join(",");break;case 1:o.uniqueIds=JSON.stringify(s.objectIds),delete o.objectIds;break;default:o.uniqueIds=JSON.stringify(s.objectIds.map(e=>JSON.parse(e))),delete o.objectIds}if(s.orderByFields&&(o.orderByFields=s.orderByFields.join(",")),!s.outFields||!s.returnDistinctValues&&(t?.returnCountOnly||t?.returnExtentOnly||t?.returnIdsOnly)?delete o.outFields:s.outFields.includes("*")?o.outFields="*":o.outFields=s.outFields.join(","),s.outSR?(o.outSR=a(s.outSR),u=e.outSpatialReference):i&&(s.returnGeometry||s.returnCentroid)&&(o.outSR=o.inSR,u=l),s.returnGeometry&&delete s.returnGeometry,s.outStatistics&&(o.outStatistics=JSON.stringify(s.outStatistics)),s.fullText&&(o.fullText=JSON.stringify(s.fullText)),s.pixelSize&&(o.pixelSize=JSON.stringify(s.pixelSize)),s.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=l&&null!=e.quantizationParameters?.extent&&l.equals(e.quantizationParameters.extent.spatialReference)&&delete s.quantizationParameters.extent.spatialReference,o.quantizationParameters=JSON.stringify(s.quantizationParameters)),s.parameterValues&&(o.parameterValues=JSON.stringify(s.parameterValues)),s.rangeValues&&(o.rangeValues=JSON.stringify(s.rangeValues)),s.dynamicDataSource&&(o.layer=JSON.stringify({source:s.dynamicDataSource}),delete s.dynamicDataSource),s.timeExtent){const e=s.timeExtent,{start:t,end:n}=e;null==t&&null==n||(o.time=t===n?t:`${t??"null"},${n??"null"}`),delete s.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=l&&null!=u&&l.equals(u)&&(o.defaultSR=o.inSR,delete o.inSR,delete o.outSR),o}async function d(e,t,n,r,i){const a=t.timeExtent?.isEmpty?{data:{features:[]}}:await g(e,t,"json",r,void 0,i);return o(t,n,a.data),a}async function y(e,t,n,r,i){if(t.timeExtent?.isEmpty)return{data:n.createFeatureResult()};const a=await f(e,t,r,i),o=a;return o.data=s(a.data,n),o}function f(e,t,n,r){return g(e,t,"pbf",n,void 0,r)}function m(e,t,n,r){return t.timeExtent?.isEmpty?Promise.resolve({data:{objectIds:[]}}):g(e,t,"json",n,{returnIdsOnly:!0},r)}function p(e,t,n,r){return t.timeExtent?.isEmpty?Promise.resolve({data:{count:0}}):g(e,t,"json",n,{returnIdsOnly:!0,returnCountOnly:!0},r)}async function S(e,t,n){if(t.timeExtent?.isEmpty)return{data:{count:0,extent:null}};const r=await g(e,t,"json",n,{returnExtentOnly:!0,returnCountOnly:!0}),i=r.data;if(i.hasOwnProperty("extent"))return r;if(i.features)throw new Error(l);if(i.hasOwnProperty("count"))throw new Error(l);return r}function O(e,t){if(!e.returnIdsOnly||!t.uniqueIdFields)return e;const n={...e,returnUniqueIdsOnly:!0};return delete n.returnIdsOnly,n}async function g(r,a,s,o={},l={},d={}){const y="string"==typeof r?t(r):r,f=a.geometry?[a.geometry]:[],m=await i(f,null,{signal:o.signal}),p=m?.[0];null!=p&&((a=a.clone()).geometry=p);const S=u({...y.query,f:s,...O(l,d),...c(a,l,d)});return e(n(y.path,function(e,t){return null!=e.formatOf3DObjects&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}(a,l)?"query3d":"query"),{...o,responseType:"pbf"===s?"array-buffer":"json",query:{...S,...o.query}})}export{p as a,m as b,S as c,y as d,d as e,f,u as m,g as r};
