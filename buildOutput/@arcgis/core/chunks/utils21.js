/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../Color.js";import"../intl.js";import t from"../core/Collection.js";import"../core/lang.js";import n from"../core/Error.js";import{c as i,f as s}from"./date.js";import{r as o}from"./numberUtils.js";import{P as r}from"./PointSizeSplatAlgorithm.js";import{a}from"./scaleUtils.js";import l from"../renderers/visualVariables/SizeVariable.js";import m from"../renderers/visualVariables/support/SizeStop.js";import{s as u}from"./spatialStatistics.js";import{v as c}from"./binningUtils.js";import{b as f,f as d,c as p,g as y}from"./layerUtils3.js";import w from"../smartMapping/statistics/classBreaks.js";import h from"../smartMapping/statistics/summaryStatistics.js";import{getAgeExpressions as g}from"../smartMapping/statistics/support/ageUtils.js";import{k as b,m as v,j,n as S,i as z}from"./utils7.js";import D from"../symbols/ExtrudeSymbol3DLayer.js";import T from"../symbols/FillSymbol3DLayer.js";import x from"../symbols/IconSymbol3DLayer.js";import U from"../symbols/LineSymbol3D.js";import V from"../symbols/LineSymbol3DLayer.js";import L from"../symbols/MeshSymbol3D.js";import k from"../symbols/ObjectSymbol3DLayer.js";import M from"../symbols/PathSymbol3DLayer.js";import F from"../symbols/PointSymbol3D.js";import I from"../symbols/PolygonSymbol3D.js";import B from"../symbols/SimpleFillSymbol.js";import C from"../symbols/SimpleLineSymbol.js";import E from"../symbols/SimpleMarkerSymbol.js";import Z from"../symbols/edges/SketchEdges3D.js";import P from"../symbols/edges/SolidEdges3D.js";import{g as A,s as R}from"./timeZoneUtils.js";import{getBackgroundColorTheme as $}from"../views/support/colorUtils.js";import{f as q}from"./messages.js";import{s as N}from"./substitute.js";const Y=[{size:10,width:0},{size:20,width:.5},{size:80,width:1},{size:250,width:2}];async function W(e){const{layerAdapter:t,...i}=await async function(e){const{view:t}=e;if(!(e&&t&&e.layer))throw new n("outline:missing-parameters","'view' and 'layer' parameters are required");e.forBinning&&c(e,"outline");const{layer:i,...s}=e,o=e.forBinning?f:d,r=p(i,o,e.forBinning);if(!r)throw new n("outline:invalid-parameters","'layer' must be one of these types: "+y(o).join(", "));const a={layerAdapter:r,...s,view:t};await t.when();const l=null!=a.signal?{signal:a.signal}:null;if(await r.load(l),"polygon"!==r.geometryType)throw new n("outline:not-supported",`outline is not supported for geometryType: ${r.geometryType}`);return a}(e),s=await t.getSampleFeatures({sampleSize:-1,returnGeometry:!0,...i},"json");if(!s?.length)throw new n("outline:insufficient-info","No features are available to calculate statistics");const o=await u({features:s,geometryType:t.geometryType});if(!(o&&"avgSize"in o&&o.avgSize))throw new n("outline:insufficient-info","average polygon size is invalid");return function(e,t){const n=e.avgSize,i=a(1,t.spatialReference),s=Y.map(e=>new m({size:e.width,value:Math.round(n/e.size*i)}));return s.sort((e,t)=>e.value-t.value),{visualVariables:[new l({target:"outline",valueExpression:"$view.scale",stops:s})],opacity:.25}}({...o,avgSize:o.avgSize},i.view)}const G=/^(\d+(\.\d+)?)\s*(%)$/i,O=new e([0,0,0,.4]),_=new Set(["hours","minutes","seconds"]),H=[...j.light,...j.dark];function J(e,t,n,o){if("string"==typeof e){const t=n.getField(e);if(t&&z(t))return t.alias||t.name}else if("number"==typeof e||e instanceof Date){const r=null!=t&&_.has(t),a=i(r?"short-date-short-time":"short-date");if(o&&r){const t=n.layer,{timeZone:i}=A("preferredTimeZone"in t?t.preferredTimeZone:null,"datesInUnknownTimezone"in t&&t.datesInUnknownTimezone,o.timeZone,a,"date");return s(e,{...a,timeZone:i,timeZoneName:R})}return s(e,a)}return e}function K(e,t,n){return e+t>0&&0>e-t&&n<0?0:e}function Q(e,t,n,i){const{avg:s,stddev:o,min:r,max:a}=e,l=X(e,!!n,i??!0);let m=l?l[0]:r,u=l?l[1]:a;return l?{minDataValue:m,maxDataValue:u,defaultValuesUsed:!0}:("above"===t?m=K(s,o,r):"below"===t&&(u=K(s,o,r)),{minDataValue:m,maxDataValue:u,defaultValuesUsed:!1})}function X(e,t,n){let i,s;const o=function(e){let t,n,i=e&&e.statistics;if(i||(i={}),null==i.min)if(e.isDate){const e=ee();t=e[0],n=e[1]}else t=0,n=100;else if(i.min===i.max)if(e.isDate){const e=ee(i.min);t=e[0],n=e[1]}else i.min<0?(t=2*i.min,n=0):i.min>0?(t=0,n=2*i.min):(t=0,n=100);return{min:null!=t?t:i.min,max:null!=n?n:i.max,defaultValuesUsed:null!=t||null!=n}}({statistics:e,isDate:t});return o.defaultValuesUsed?(i=o.min,s=o.max):!n||null!=e.avg&&e.stddev||(i=e.min,s=e.max),null!=i&&null!=s?[i,s]:null}function ee(e){const t=("number"==typeof e?new Date(e):new Date).getUTCFullYear();let n=Date.UTC(t,0,1,12,0,0,0),i=Date.UTC(t,11,31,12,0,0,0);return"number"==typeof e&&(e<n&&(n=e),e>i&&(i=e)),[n,i]}function te({minDataValue:e,maxDataValue:t,defaultValuesUsed:n},i,s,o=!0){return n||"above"===s||"below"===s?se(e,t,5):oe(i,o)}function ne(e,t){const{avg:n,stddev:i}=e,s=e.min,r=e.max;if(null==n||null==i){const[n,i]=X(e,t,!0);return se(n,i,5)}const a=K(n,i,s),l=r-a,m=a-s,u=Math.max(l,m);return o([a-u,a-u/2,a,u/2+a,a+u],{strictBounds:!0})}function ie(e,t){const{min:n,max:i}=t,[s,r,a,l,m]=e,u=null!=n&&s<n,c=null!=i&&m>i;if(null==n||null==i||!u&&!c)return e;const f=u?n:s,d=c?i:m;return o([f,u?f+(a-f)/2:r,a,c?a+(d-a)/2:l,d],{strictBounds:!0})}function se(e,t,n){const i=(t-e)/(n-1),s=[e];for(let t=1;t<=n-2;t++)s.push(e+t*i);return s.push(t),o(s,{strictBounds:!0})}function oe({min:e,max:t,avg:n,stddev:i},s=!0){if(null==e||null==t||null==n||null==i)return[];let r=n-i,a=n+i;r<e&&(r=e),a>t&&(a=t),s&&(n=r+(a-r)/2);let l=o([r,a],{strictBounds:!0});return r=l[0],a=l[1],l=[r,r+(n-r)/2,n,n+(a-n)/2,a],o(l,{strictBounds:!0})}function re(e,t,n){switch(t){case"point":case"multipoint":return n?"noDataSize"in e?e.noDataSize:null:"size"in e?e.size:null;case"polyline":return n?"noDataWidth"in e?e.noDataWidth:null:"width"in e?e.width:null;case"polygon":return"size"in e?e.size:null;default:return}}function ae(e,t,n){switch(t){case"point":case"multipoint":case"polygon":{if(!("outline"in e))return null;const t={color:e.outline.color,width:e.outline.width};if(null!=n&&t.color){const e=t.color.clone();e.a=n,t.color=e}return t}default:return}}function le(e,n){const{type:i,size:s,color:o,outline:r}=n;let a;switch(e){case"point":case"multipoint":if("2d"===i)a=new E({color:o,size:s,outline:{color:r.color,width:r.width}});else if("3d-flat"===i)a=new F({symbolLayers:new t([new x({size:s,resource:{primitive:"circle"},material:{color:o},outline:{color:r.color,size:r.width}})])});else if(i?.includes("3d-volumetric")){const e="3d-volumetric-uniform"===i,r=new k({height:s,resource:{primitive:e?"sphere":"cylinder"},material:{color:o}});e||(r.width=n.widthAndDepth,r.depth=n.widthAndDepth),a=new F({symbolLayers:new t([r])})}break;case"polyline":"2d"===i?a=new C({color:o,width:s}):"3d-flat"===i?a=new U({symbolLayers:new t([new V({size:s,material:{color:o}})])}):"3d-volumetric"===i&&(a=new U({symbolLayers:new t([new M({width:"number"==typeof s?s:parseFloat(s),height:"number"==typeof s?s:parseFloat(s),material:{color:o}})])}));break;case"polygon":"2d"===i?a=new B({color:o,outline:{color:r.color,width:r.width}}):"3d-flat"===i?a=new I({symbolLayers:new t([new T({material:{color:o},outline:{color:r.color,size:r.width}})])}):"3d-volumetric"===i&&(a=new I({symbolLayers:new t([new D({size:s,material:{color:o}})])}));break;case"mesh":{const e=n.meshInfo?.colorMixMode,i=n.meshInfo?.edgesType;a=new L({symbolLayers:new t([new T({material:{color:o,colorMixMode:e||null},edges:"solid"===i?new P({color:O}):"sketch"===i?new Z({color:O}):null})])});break}}return a}function me(e,t,i){const s=function(e){const t=e.layer;return e.fields.filter(e=>!t.getField(e))}({layer:e,fields:t});if(s.length)return new n(i,"Unknown fields: "+s.join(", ")+". You can only use fields defined in the layer schema");const o=function(e){const t=e.layer;return e.fields.filter(e=>{const n=t.getFieldUsageInfo(e);return!n||!n.supportsRenderer})}({layer:e,fields:t});return o.length?new n(i,"Unsupported fields: "+o.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0}async function ue(e,t){const n={layer:e.layer,view:e.view,filter:e.filter,signal:e.signal},[i,s]=await Promise.all([w(e).catch(he),t?W(n).catch(he):null]),o=X({min:i?.minValue,max:i?.maxValue,avg:null,stddev:null},!1,!1);return{result:o?await w({...e,classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:o[0],maxValue:o[1],normalizationTotal:o[0]+o[1]}):i,defaultValuesUsed:!!o,outlineResult:s}}function ce(e){return h({outStatisticTypes:b,...e})}function fe(e,t){let{minSize:n,maxSize:i}=e;return"height"===t&&(n=((i-n)/2+n)/4.6,i*=2),{minSize:n,maxSize:i}}function de(e){return G.test(e)}function pe(e){if(null==e)return;const t=e.match(G),n=Number(t[1]);return"%"===t[3]?new r({scaleFactor:n/100}):void 0}function ye(e,t,n,i){e.startTime=t instanceof Date?t.getTime():t,e.endTime=n instanceof Date?n.getTime():n,e.units=i,e.field="string"==typeof t?t:"string"==typeof n?n:null}async function we(e,t){let n=null,i=null;if(!e&&!t)return{basemapId:n,basemapTheme:i};if(t&&(i=await $(t),e||(e=t.map?.basemap)),e&&(n=v(e,H,!1),n&&!i)){const e=S(n);null!=e&&(i=e)}return!n&&i&&(n="dark"===i?"dark-gray":"gray"),{basemapId:n,basemapTheme:i}}function he(e){const t=e.name?.toLowerCase();if(!t||t?.includes(":insufficient-info")||t?.includes(":insufficient-data"))return null;throw e}async function ge(e,t){const{layer:n,startTime:i,endTime:s,view:o}=e,r=g({layer:n,startTime:i,endTime:s,unit:t}).valueExpression,a=await q("esri/smartMapping/t9n/smartMapping");return{valueExpression:r,title:N(a[`ageInfo_${t}`],{unit:t,startTime:J(i,t,n,o),endTime:J(s,t,n,o)})}}export{we as a,ce as b,te as c,ue as d,he as e,pe as f,Q as g,ge as h,le as i,ae as j,re as k,de as l,X as m,se as n,W as o,oe as p,fe as q,ne as r,ie as s,ye as u,me as v};
