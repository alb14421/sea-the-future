/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{Z as e,n as t,p as n,a as r,b as i,_ as s,I as a,G as o,r as m,P as u,e as l,$ as c,t as d,m as h}from"./Point2D.js";import{b6 as _,b7 as p,a as f,b8 as k,b9 as b,c as y,W as T,ba as N,bb as g,P as v,b as x,S as A,M as S,bc as w,bd as C,be as D,bf as j,bg as F,bh as O,bi as I}from"./ProjectionTransformation.js";import{j as z,k as E,P,E as B,l as V,m as M,n as R,o as U,p as W}from"./Envelope.js";import"./Envelope2D.js";import{k as X,a8 as L,T as Y,R as G}from"./unitUtils.js";import"./Transformation2D.js";import"./SimpleGeometryCursor.js";import"./tslib.es6.js";import"./OperatorDefinitions.js";import"../core/lang.js";import"./jsonMap.js";import"./object.js";import"./string.js";import"./pe.js";import"./assets.js";import"../config.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"./Logger.js";import"./jsonUtils.js";import"./MapUtils.js";import"../core/promiseUtils.js";import"./handleUtils.js";import"./events.js";import"./maybe.js";import"./persistableUrlUtils.js";function K(){if(-1===this.m_i)return this.m_i=0,{value:{m_token:1,m_value:null},done:!1};if(this.m_i<this.m_keys.length){const e=this.m_bReturnKey,t=Math.trunc(this.m_i);return this.m_bReturnKey=!this.m_bReturnKey,this.m_i+=.5,e?{value:{m_token:5,m_value:this.m_keys[t]},done:!1}:{value:{m_token:6,m_value:this.m_o[this.m_keys[t]]},done:!1}}return{value:{m_token:3,m_value:null},done:!0}}function q(){if(-1===this.m_i)return this.m_i=0,{value:{m_token:2,m_value:null},done:!1};if(this.m_i<this.m_a.length){const e={value:{m_token:6,m_value:this.m_a[this.m_i++]},done:!1};return this.m_strict||void 0===e.value.m_value&&(e.value.m_value=Number.NaN),e}return{value:{m_token:4,m_value:null},done:!0}}_(e=>{let t,n;"number"==typeof e?t=e:n=e;const r={wkid:t,wkt:n};let i,s;if(n){i=G(n);const e=X(r);if(!i&&!e)throw new Error(`Unsupported WKT type: ${n}`)}else i=!X(r);return s=t&&L.has(t)?Math.PI/200:i?Y(r):Math.PI/180,{isPCS:i,metersOrRadiansPerUnit:s,semiMajor:0,wkidOrWkt:e}});class Z{createJSONObjectIterator(e){return{m_iteratorType:"object",m_o:e,m_keys:this.m_options.strict?Object.keys(e):Object.keys(e).filter(t=>void 0!==e[t]),m_i:-1,m_bReturnKey:!0,next:K}}createJSONArrayIterator(e){return{m_iteratorType:"array",m_strict:this.m_options.strict,m_i:-1,m_a:e,next:q}}constructor(e,t){this.m_currentToken=0,this.m_options=t?{...t}:{strict:!0};const n=e;this.m_iteratorStack=[n instanceof Array?this.createJSONArrayIterator(n):this.createJSONObjectIterator(n)],this.m_nextFlatToken={m_value:null,m_token:0}}nextToken(){if(0===this.m_iteratorStack.length)return this.m_currentToken=0;switch(this.m_nextFlatToken=this.m_iteratorStack.at(-1).next().value,this.m_currentValue=void 0,this.m_nextFlatToken.m_token){case 1:return this.m_currentToken=1;case 3:return this.m_iteratorStack.pop(),this.m_currentToken=3;case 2:return this.m_currentToken=2;case 4:return this.m_iteratorStack.pop(),this.m_currentToken=4;case 5:return this.m_currentValue=this.m_nextFlatToken.m_value,this.m_currentToken=5;case 6:if(this.m_nextFlatToken.m_value instanceof Array)return this.m_iteratorStack.push(this.createJSONArrayIterator(this.m_nextFlatToken.m_value)),this.nextToken();if(this.m_nextFlatToken.m_value instanceof Object)return this.m_iteratorStack.push(this.createJSONObjectIterator(this.m_nextFlatToken.m_value)),this.nextToken();if("number"==typeof this.m_nextFlatToken.m_value)return this.m_currentValue=this.m_nextFlatToken.m_value,Number.isSafeInteger(this.m_currentValue)&&this.m_currentValue>=e()&&this.m_currentValue<=t()?this.m_currentToken=8:this.m_currentToken=7;if("string"==typeof this.m_nextFlatToken.m_value)return this.m_currentValue=this.m_nextFlatToken.m_value,this.m_currentToken=6;if("boolean"==typeof this.m_nextFlatToken.m_value)return this.m_currentValue=this.m_nextFlatToken.m_value,this.m_currentToken=this.m_nextFlatToken.m_value?11:12;if("object"==typeof this.m_nextFlatToken.m_value)return this.m_currentValue=null,this.m_currentToken=10;n("unrecognized json element type")}return n("unrecognized json element type"),0}currentToken(){return this.m_currentToken}skipChildren(){if(0!==this.m_iteratorStack.length)switch(this.m_currentValue=void 0,this.m_nextFlatToken.m_token){case 1:return this.m_iteratorStack.pop(),this.m_nextFlatToken.m_token=3,void(this.m_currentToken=3);case 2:return this.m_iteratorStack.pop(),this.m_nextFlatToken.m_token=4,void(this.m_currentToken=4)}}currentString(){return 6!==this.m_currentToken&&5!==this.m_currentToken&&r("invalid token"),this.m_currentValue}currentDoubleValue(){return 7!==this.m_currentToken&&8!==this.m_currentToken&&r("invalid token"),this.m_currentValue}currentInt32Value(){return 8!==this.m_currentToken&&r("invalid token"),this.m_currentValue}currentInt64Value(){return i(0),0n}currentBoolValue(){return 12!==this.m_currentToken&&11!==this.m_currentToken&&r("invalid token"),this.m_currentValue}isError(){return 0}}class J{constructor(e){return this.m_buffer=null,this.m_view=null,this.m_sz=0,this.m_offset=0,this.m_bOwnsBuffer=!0,this.m_bLittleEndian=!0,this.m_element=new ArrayBuffer(8),this.m_elementBytes=new Uint8Array(this.m_element),this.m_elementView=new DataView(this.m_element),this.m_elementDouble=new Float64Array(this.m_element),this.m_elementFloat=new Float32Array(this.m_element),this.m_elementInt64=new BigInt64Array(this.m_element),this.m_elementInt32=new Int32Array(this.m_element),this.m_elementInt16=new Int16Array(this.m_element),void 0!==e.sz?(this.m_sz=e.sz,e.buffer?(this.m_sz<0&&s("size out of range"),this.m_buffer=e.buffer,this.m_offset=void 0!==e.offset?e.offset:0,this.m_view=void 0!==e.offset?new DataView(e.buffer,e.offset,e.sz):new DataView(this.m_buffer),this.m_bOwnsBuffer=!1,void(this.m_bLittleEndian=!0)):(this.m_sz<0&&s("size out of range"),void(this.m_sz>0&&(this.m_buffer=new ArrayBuffer(this.m_sz),this.m_view=new DataView(this.m_buffer))))):e.move?(this.m_sz=e.move.m_sz,this.m_buffer=e.move.m_buffer,this.m_view=e.move.m_view,this.m_bOwnsBuffer=e.move.m_bOwnsBuffer,this.m_bLittleEndian=e.move.m_bLittleEndian,e.move.m_buffer=null,e.move.m_view=null,e.move.m_sz=0,void(e.move.m_bOwnsBuffer=!0)):void n("unrecognized constructor options")}swapBytesDouble(){this.doSwap()&&(this.m_elementDouble[0]=this.m_elementBytes[0]<<56|this.m_elementBytes[1]<<48|this.m_elementBytes[2]<<40|this.m_elementBytes[3]<<32|this.m_elementBytes[4]<<24|this.m_elementBytes[5]<<16|this.m_elementBytes[6]<<8|this.m_elementBytes[7])}swapBytesInt32(){this.doSwap()&&(this.m_elementInt32[0]=this.m_elementBytes[0]<<24|this.m_elementBytes[1]<<16|this.m_elementBytes[2]<<8|this.m_elementBytes[3])}getOffset(){return this.m_offset}assignMove(e){return this===e||(this.clear(),this.m_sz=e.m_sz,this.m_buffer=e.m_buffer,this.m_view=e.m_view,this.m_bOwnsBuffer=e.m_bOwnsBuffer,this.m_bLittleEndian=e.m_bLittleEndian,e.m_buffer=null,e.m_sz=0,e.m_bOwnsBuffer=!0),this}doSwap(){return this.m_bLittleEndian!==(1===J.getNativeByteOrder())}setNativeByteOrder(){this.m_bLittleEndian=1===J.getNativeByteOrder()}setOrder(e){this.m_bLittleEndian=1===e}getOrder(){return this.m_bLittleEndian?1:0}getView(){return this.m_view||a("buffer not defined"),this.m_view}static getNativeByteOrder(){return 1}clear(){this.m_buffer=null,this.m_sz=0,this.m_bOwnsBuffer=!0}size(){return this.m_sz}readDouble(e){return this.doSwap()?(this.m_elementDouble[0]=this.m_view.getFloat64(e,this.m_bLittleEndian),this.swapBytesDouble(),this.m_elementDouble[0]):this.m_view.getFloat64(e,this.m_bLittleEndian)}writeDouble(e,t){this.m_elementDouble[0]=t,this.swapBytesDouble(),this.m_view.setFloat64(e,this.m_elementDouble[0],this.m_bLittleEndian)}readInt32(e){return this.doSwap()?(this.m_elementInt32[0]=this.m_view.getInt32(e,this.m_bLittleEndian),this.swapBytesInt32(),this.m_elementInt32[0]):this.m_view.getInt32(e,this.m_bLittleEndian)}writeInt32(e,t){this.m_elementInt32[0]=t,this.swapBytesInt32(),this.m_view.setInt32(e,this.m_elementInt32[0],this.m_bLittleEndian)}getPtr(){return this.m_buffer}setSizeNoRealloc(e){i(e>=0&&e<=this.m_sz),this.m_sz=e}}function H(e){let t=!1;for(;3!==e.nextToken();){const n=e.currentString();e.nextToken(),"uwkid"===n?t||(t=!0,8===e.currentToken()&&e.currentInt32Value()):e.skipChildren()}return null}function Q(e){let t=!1,n=!1,r=!1,i=!1,s=!1,a=!1,o=!1,m=!1,u=!1,l=!1,c=!1,d=!1,h=!1,_=!1,v=!1,x=!1,A=!1,S=-1,w=-1,C=-1,D=-1,j=0,F=0,O=0,I=0,z=0,E=0,P=0,B=0,V=0,M=0,R="",U="",W=null;for(;3!==e.nextToken();){const p=e.currentString();e.nextToken(),"wkid"===p?t||(t=!0,8===e.currentToken()&&(S=e.currentInt32Value())):"latestWkid"===p?n||(n=!0,8===e.currentToken()&&(w=e.currentInt32Value())):"wkt"===p?s||(s=!0,6===e.currentToken()&&(R=e.currentString())):"wkt2"===p?s||6===e.currentToken()&&(U=e.currentString()):"vcsWkid"===p?r||(r=!0,8===e.currentToken()&&(C=e.currentInt32Value())):"latestVcsWkid"===p?i||(i=!0,8===e.currentToken()&&(D=e.currentInt32Value())):"xyTolerance"===p?o||(o=!0,a=!0,j=e.currentDoubleValue()):"zTolerance"===p?m||(m=!0,a=!0,F=e.currentDoubleValue()):"mTolerance"===p?u||(u=!0,a=!0,O=e.currentDoubleValue()):"falseX"===p?l||(l=!0,a=!0,P=e.currentDoubleValue()):"falseY"===p?c||(c=!0,a=!0,B=e.currentDoubleValue()):"falseZ"===p?d||(d=!0,a=!0,V=e.currentDoubleValue()):"falseM"===p?h||(h=!0,a=!0,M=e.currentDoubleValue()):"xyUnits"===p?_||(_=!0,a=!0,I=e.currentDoubleValue()):"zUnits"===p?v||(v=!0,a=!0,z=e.currentDoubleValue()):"mUnits"===p?x||(x=!0,a=!0,E=e.currentDoubleValue()):"unit"===p?A||(A=!0,W=H(e)):e.skipChildren()}D<=0&&C>0&&(D=C),C<=0&&D>0&&(C=D);let X=null,L=!0;if(0!==R.length&&(L=!1,p(R)&&(X=f(R))),X||0===U.length||(L=!1,p(U)&&(X=f(U))),!X&&w>0&&(L=!1,k(w)&&(D<=0||b())&&(X=y(w,D))),!X&&S>0&&(L=!1,k(S)&&(C<=0||b())&&(X=y(S,C))),L&&(X=T(W)),a&&X){const e=new N;X.queryPrecisionDescriptorWithoutFalseXY(e),o&&e.setTolerance(0,j),m&&e.setTolerance(1,F),u&&e.setTolerance(2,O),_&&l&&c&&e.setGridParams(P,B,I),v&&d&&e.setZParams(V,z),x&&h&&e.setMParams(M,E),X=g(X,e)}return X}function $(e,t,n,i){2!==i.currentToken()&&r("failed to parse multipath: array of array of vertices is expected");const s=e?new v:new x,a=s,o=V(0),d=z(2,0),h=M(0);let _=null,p=null,f=null,k=null,b=null,y=0,T=0,N=0;const g=new A,S=u.getNAN();let w=0,C=0;const D=e?1:0;for(;4!==i.nextToken();){2!==i.currentToken()&&r("failed to parse multipath: ring/path array is expected");let n=2,s=0,v=!0;const x=4;let A=0,j=0;const F=u.getNAN(),I=m(x,Number.NaN),E=m(x,Number.NaN);let P=!1;for(i.nextToken();4!==i.currentToken();){if(t&&1===i.currentToken())v&&r("failed to parse multipath: starting vertex array is expected"),f||(f=M(w-1,1),k=V(w-1,-1),b=z(0)),P=!0,n=1,({segFlag:N,toPointSz:A}=ae(g,I,S,i));else{for(P=!1,2!==i.currentToken()&&r("failed to parse multipath: array is expected, rings/paths vertices consist of arrays of coordinates"),A=0;4!==i.nextToken();)A===x&&r("failed to parse multipath: each vertex array has to have at most 4 elements"),I[A++]=ne(i);A<2&&r("failed to parse multipath: each vertex array has to have at least 2 elements"),R(I[0],I[1])||r("failed to parse multipath: x and y must be finite")}i.nextToken();do{if(d.size()===2*w&&d.resize(ie(w)),d.writePoint2D(2*w,F.setCoords(I[0],I[1])),_&&_.size()===w&&_.resize(se(w)),A>2?(_||(_=z(w+1,Number.NaN)),_.write(w,I[2])):_&&_.write(w,Number.NaN),p&&p.size()===w&&p.resize(se(w)),A>3?(p||(p=z(w+1,Number.NaN)),p.write(w,I[3])):p&&p.write(w,Number.NaN),v)C++,o.add(w),h.add(D),v=!1,j=A,l(E,I,0,0,j);else if(null!==f)if(P){const e=O(N),t=b.size();b.resize(t+e),f.add(N),k.add(y),g.get().writeInBufferStream(b,y),y+=e,a.incCurveType(N,1),T++}else f.add(1),k.add(-1);w++,s++,S.setCoords(I[0],I[1])}while(s<n&&4===i.currentToken())}0!==s&&(e&&s>n&&A===j&&0===c(I,E,A)?(w--,s--):null!==f&&(f.add(1),k.add(-1)))}return w&&(o.resize(C),h.resize(C),w>0&&(o.add(w),h.add(0)),a.setAttributeStreamRef(0,d),a.setPathFlagsStreamRef(h),a.setPathStreamRef(o),null!==f&&(a.updateCurveCounter(T),a.setSegmentData(k,b,f,y)),a.notifyModifiedFlags(65535)),{geometry:s,as:_,bs:p}}function ee(e,t){2!==t.currentToken()&&r("failed to parse multipoint: array of vertices is expected");let n=0;const i=new S,s=z(2,0);let a=0;const o=m(4,Number.NaN),l=new u;let c=null,d=null;for(;4!==t.nextToken();){for(2!==t.currentToken()&&r("failed to parse multipoint: array is expected, multipoint vertices consist of arrays of cooridinates"),a=0;4!==t.nextToken();)4===a&&r("failed to parse multipoint: each vertex array has to have at most 4 elements"),o[a++]=ne(t);a<2&&r("failed to parse multipoint: each vertex array has to have at least 2 elements"),R(o[0],o[1])||r("failed to parse multipoint: x and y must be finite"),s.size()===2*n&&s.resize(ie(n)),s.writePoint2D(2*n,l.setCoords(o[0],o[1])),c&&c.size()===n&&c.resize(se(n)),a>2?(c||(c=z(n+1,Number.NaN)),c.write(n,o[2])):c&&c.write(n,Number.NaN),d&&d.size()===n&&d.resize(se(n)),a>3?(d||(d=z(n+1,Number.NaN)),d.write(n,o[3])):d&&d.write(n,Number.NaN),n++}if(n){const e=i.getImpl();e.setAttributeStreamRef(0,s),e.resizeNoInit(n),e.notifyModifiedFlags(65535)}return{geometry:i,as:c,bs:d}}function te(e,t){2!==t.currentToken()&&r("failed to parse array of IDs: array of array of integers is expected");const n=U(2,0);let i=0,s=-1;for(;4!==t.nextToken();){const e=i;n.size()===i&&n.resize(se(i)),i++;let a=0;for(-1===s?s=2===t.currentToken()?1:0:1===s&&2!==t.currentToken()&&r("failed to parse array of IDs: array of array of integers is expected"),0===s&&(n.size()===i&&n.resize(se(i)),n.write(i,re(t)),a++,i++);4!==t.nextToken();)n.size()===i&&n.resize(se(i)),n.write(i,re(t)),a++,i++;if(n.write(e,a),0===s)break}return n.resize(i),n}function ne(e){const t=e.currentToken();if(10===t||6===t&&"NaN"===e.currentString())return Number.NaN;{const t=e.currentDoubleValue();return Number.isNaN(t)?Number.NaN:t}}function re(e){return e.currentInt32Value()}function ie(e){let t=2*Math.trunc(3*(e+1)/2);return t<8?t=8:t<32&&(t=32),t}function se(e){let t=Math.trunc(3*(e+1)/2);return t<4?t=4:t<16&&(t=16),t}function ae(e,t,n,s,a){const o={segFlag:0,toPointSz:0};let m=s.currentToken();m=s.nextToken();const l=s.currentString(),c=l[0];for((1!==l.length||"a"!==c&&"b"!==c&&"c"!==c&&"n"!==c&&"q"!==c)&&r('failed to parse curve: expecting "a", "b", "n", "q", or "c"'),m=s.nextToken(),2!==m&&r("failed to parse curve: start array is expected for curve parameters"),m=s.nextToken(),2!==m&&r("failed to parse curve: start array is expected for to point"),o.toPointSz=0;4!==s.nextToken();)4===o.toPointSz&&r("failed to parse curve: vertex array cannot have more than 4 elements"),t[o.toPointSz++]=ne(s);o.toPointSz<2&&r("failed to parse curve: vertex array must have at least 2 elements");const d=u.construct(t[0],t[1]),_=u.getNAN();let p=-1,f=-1,k=!1,b=Number.NaN,y=Number.NaN,T=Number.NaN;const N=[u.getNAN(),u.getNAN(),u.getNAN()],g=u.getNAN();if("a"===c){m=s.nextToken(),2!==m&&r("failed to parse curve: start array is expected for center point"),m=s.nextToken();const e=ne(s);m=s.nextToken();const t=ne(s);m=s.nextToken(),4!==m&&r("failed to parse curve: end array is expected for center point"),_.setCoords(e,t),m=s.nextToken(),p=s.currentInt32Value(),m=s.nextToken(),f=s.currentInt32Value(),m=s.nextToken(),4!==m?(k=!1,b=ne(s),m=s.nextToken(),y=ne(s),m=s.nextToken(),T=ne(s),m=s.nextToken(),4!==m&&r("failed to parse curve: end array is expected for curve parameters")):k=!0,o.segFlag=4}else if("b"===c){for(let e=0;e<2;e++){m=s.nextToken(),2!==m&&r("failed to parse curve: start array is expected for control point"),m=s.nextToken();const t=ne(s);m=s.nextToken();const n=ne(s);m=s.nextToken(),4!==m&&r("failed to parse curve: end array is expected for control point"),N[e].setCoords(t,n)}m=s.nextToken(),4!==m&&r("failed to parse curve: end array is expected for curve parameters"),o.segFlag=2}else if("n"===c){{m=s.nextToken(),2!==m&&r("failed to parse curve: start array is expected for control point"),m=s.nextToken();const e=ne(s);m=s.nextToken();const t=ne(s);m=s.nextToken(),4!==m&&r("failed to parse curve: end array is expected for control point"),N[0].setCoords(e,t)}m=s.nextToken();const e=ne(s);m=s.nextToken();const t=ne(s);m=s.nextToken();const n=ne(s);N[1].setCoords(e,t),N[2].setCoords(n,n),m=s.nextToken(),4!==m&&r("failed to parse curve: end array is expected for curve parameters"),o.segFlag=8}else if("q"===c){for(let e=0;e<1;e++){m=s.nextToken(),2!==m&&r("failed to parse curve: start array is expected for control point"),m=s.nextToken();const t=ne(s);m=s.nextToken();const n=ne(s);m=s.nextToken(),4!==m&&r("failed to parse curve: end array is expected for control point"),N[e].setCoords(t,n)}m=s.nextToken(),4!==m&&r("failed to parse curve: end array is expected for curve parameters"),o.segFlag=16}else{m=s.nextToken(),2!==m&&r("failed to parse curve: start array is expected for interior point"),m=s.nextToken();const e=ne(s);m=s.nextToken();const t=ne(s);m=s.nextToken(),4!==m&&r("failed to parse curve: end array is expected for interior point"),g.setCoords(e,t),m=s.nextToken(),4!==m&&r("failed to parse curve: end array is expected for curve parameters"),o.segFlag=4}if(m=s.nextToken(),3!==m&&r("failed to parse curve: end object is expected for curve"),"a"===c)if(e.createEllipticArc(),k){const t=!0;oe(e.get(),n,d,_,t,p,f)}else!function(e,t,n,r,i,s,a,o,m){e.dropAllAttributes();const u=new ArrayBuffer(44),l=new J({sz:44,buffer:u});let c=0;l.writeDouble(c,r.x),c+=8,l.writeDouble(c,r.y),c+=8,l.writeDouble(c,a),c+=8,l.writeDouble(c,o),c+=8,l.writeDouble(c,m),c+=8;let d=0;s||(d|=2048),i&&(d|=4096),l.writeInt32(c,d),c+=4,function(e,t,n,r){e.m_bits=0,e.m_center.x=r.readDouble(0),e.m_center.y=r.readDouble(8),e.m_rotation=r.readDouble(16),e.m_semiMajorAxis=r.readDouble(24),e.m_minorMajorRatio=r.readDouble(32),e.m_XStart=t.x,e.m_YStart=t.y,e.m_XEnd=n.x,e.m_YEnd=n.y;const i=r.readInt32(40);if(1&i)return!1;let s=!!(64&i),a=!!(128&i);const o=!!(2048&i),m=!!(4096&i);!(512&i)&&!(1024&i)||a||(s=!0),a&&!t.equals(n)?(a=!1,s=!0):s&&t.equals(n)&&(a=!0,s=!1),a?(e.m_center.assign(t),e.m_startAngle=e.m_center.x,e.m_sweepAngle=e.m_center.y,F(e,Number.NaN,o,m),e.m_semiMajorAxis=0,e.m_interior.setCoordsPoint2D(t)):s?(e.m_center.setNAN(),e.m_semiMajorAxis=1,e.m_minorMajorRatio=0,e.m_center.setNAN(),e.m_sweepAngle=0,e.m_startAngle=0,D(e),e.queryCoord2D(.5,e.m_interior)):e.constructEllipticArcEndPointsCenter(t,n,e.m_semiMajorAxis,e.m_minorMajorRatio,e.m_rotation,!m,o,e.m_center),e.setProjectionBehavior(1),D(e)}(e,t,n,l)}(e.get(),n,d,_,p,f,b,y,T);else if("b"===c)e.createCubicBezier(),function(e,t,n,r){e.dropAllAttributes();const s=new ArrayBuffer(32),a=new J({sz:32,buffer:s});let o=0;a.writeDouble(o,r[0].x),o+=8,a.writeDouble(o,r[0].y),o+=8,a.writeDouble(o,r[1].x),o+=8,a.writeDouble(o,r[1].y),o+=8,function(e,t,n,r){i(32<=r.size()),e.m_cp=h(u,2),e.m_cp[0].x=r.readDouble(0),e.m_cp[0].y=r.readDouble(8),e.m_cp[1].x=r.readDouble(16),e.m_cp[1].y=r.readDouble(24),e.m_XStart=t.x,e.m_YStart=t.y,e.m_XEnd=n.x,e.m_YEnd=n.y}(e,t,n,a)}(e.get(),n,d,N);else if("n"===c)e.createQuadraticRationalBezier(),function(e,t,n,r,i,s,a){e.dropAllAttributes();const o=new ArrayBuffer(40),m=new J({sz:40,buffer:o});let u=0;m.writeDouble(u,r.x),u+=8,m.writeDouble(u,r.y),u+=8,m.writeDouble(u,i),u+=8,m.writeDouble(u,s),u+=8,m.writeDouble(u,a),u+=8,function(e,t,n,r){e.m_cp.x=r.readDouble(0),e.m_cp.y=r.readDouble(8),e.m_weights[0]=r.readDouble(16),e.m_weights[1]=r.readDouble(24),e.m_weights[2]=r.readDouble(32),e.m_XStart=t.x,e.m_YStart=t.y,e.m_XEnd=n.x,e.m_YEnd=n.y}(e,t,n,m)}(e.get(),n,d,N[0],N[1].x,N[1].y,N[2].x);else if("q"===c)e.createQuadraticBezier(),e.get().construct(n,N[0],d);else{e.createEllipticArc();const t=!1;oe(e.get(),n,d,g,t,-1,-1)}return o}function oe(e,t,n,r,i,a,o){e.dropAllAttributes();const m=new ArrayBuffer(20),l=new J({sz:20,buffer:m});let c=0;l.writeDouble(c,r.x),c+=8,l.writeDouble(c,r.y),c+=8;let d=0;i?(o||(d|=8),a&&(d|=16)):d|=128,l.writeInt32(c,d),c+=4,function(e,t,n,r){0>=r.size()&&s("Byte_buffer out of range access"),e.m_bits=0,e.m_rotation=0,e.m_cosr=1,e.m_sinr=0,e.setStartXY(t),e.setEndXY(n);const i=u.getNAN();i.x=r.readDouble(0),i.y=r.readDouble(8);const a=r.readInt32(16);if(1&a)return e.m_semiMajorAxis=0,e.m_minorMajorRatio=1,e.m_interior.assign(i),e.m_center.setNAN(),e.m_sweepAngle=0,e.m_startAngle=0,D(e),!1;let o=!!(64&a);const m=!!(128&a);let l=!!(32&a);const c=!!(8&a),d=!!(16&a),h=t.equals(n);o&&!h&&(o=!1,l=!0),l&&h&&(o=!0,l=!1,i.setCoords(0,0)),o||(m?l?(e.m_semiMajorAxis=1,e.m_minorMajorRatio=0,e.m_interior.assign(i),e.m_center.setNAN(),e.m_sweepAngle=0,e.m_startAngle=0):(e.constructCircularArcThreePoint(t,n,i),h&&c===e.isClockwise()&&e.reverse()):l?(e.m_semiMajorAxis=1,e.m_minorMajorRatio=0,e.m_center.setNAN(),e.m_sweepAngle=0,e.m_startAngle=0,D(e),e.queryCoord2D(.5,e.m_interior)):j(e,t,n,i,c,d)),o&&(e.m_center.assign(t),e.m_startAngle=i.x,e.m_sweepAngle=i.y,F(e,Number.NaN,c,d),e.m_semiMajorAxis=0,e.m_minorMajorRatio=1,e.m_interior.setCoordsPoint2D(t)),e.setProjectionBehavior(0),D(e)}(e,t,n,l)}function me(e,t,n,r,s){const a=e.getGeometryType();if(a===o.enumEllipticArc)return function(e,t,n,r,s){i(!C(e));const a=e.getEndXY(),o=e.hasAttribute(1)&&!t,m=e.hasAttribute(2)&&!n;let u=Number.NaN,l=Number.NaN;if(o&&(u=e.getEndAttributeAsDbl(1,0)),m&&(l=e.getEndAttributeAsDbl(2,0)),e.isDegenerateToLine()||e.isDegenerate(0))return le(o,m,a.x,a.y,u,l,r,s),!0;const c=0===e.projectionBehavior(),d=!!c&&e.isClosed();if(c&&!d)s.startObject(),s.addFieldName("c"),s.startArray(),le(o,m,a.x,a.y,u,l,r,s),ce(e.m_interior.x,e.m_interior.y,17,s),s.endArray(),s.endObject();else if(c){s.startObject(),s.addFieldName("a"),s.startArray(),le(o,m,a.x,a.y,u,l,r,s);const t=0,n=0;ce(e.m_center.x+t,e.m_center.y+n,17,s);const i=!e.isMajor();s.addInt32(i?1:0);const c=e.isClockwise();s.addInt32(c?1:0),s.endArray(),s.endObject()}else{s.startObject(),s.addFieldName("a"),s.startArray(),le(o,m,a.x,a.y,u,l,r,s);const t=e;ce(t.m_center.x,t.m_center.y,17,s);const n=!t.isMajor();s.addInt32(n?1:0);const i=t.isClockwise();s.addInt32(i?1:0),s.addDouble(t.m_rotation,17),s.addDouble(t.m_semiMajorAxis,17),s.addDouble(t.m_minorMajorRatio,17),s.endArray(),s.endObject()}return!1}(e,t,n,r,s);if(a===o.enumBezier)return ue(e,t,n,r,s);if(a===o.enumRationalBezier2)return function(e,t,n,r,i){const s=e.getEndXY(),a=e.hasAttribute(1)&&!t,o=e.hasAttribute(2)&&!n;let m=Number.NaN,u=Number.NaN;a&&(m=e.getEndAttributeAsDbl(1,0)),o&&(u=e.getEndAttributeAsDbl(2,0)),i.startObject(),i.addFieldName("n"),i.startArray(),le(a,o,s.x,s.y,m,u,r,i),ce(e.m_cp.x,e.m_cp.y,r,i);const l=r;return i.addDouble(e.m_weights[0],l),i.addDouble(e.m_weights[1],l),i.addDouble(e.m_weights[2],l),i.endArray(),i.endObject(),!1}(e,t,n,r,s);if(a===o.enumBezier2){const i=new w;return i.constructFromQuadraticSegment(e),ue(i,t,n,r,s)}d("")}function ue(e,t,n,r,i){const s=e.getEndXY(),a=e.hasAttribute(1)&&!t,o=e.hasAttribute(2)&&!n;let m=Number.NaN,u=Number.NaN;return a&&(m=e.getEndAttributeAsDbl(1,0)),o&&(u=e.getEndAttributeAsDbl(2,0)),i.startObject(),i.addFieldName("b"),i.startArray(),le(a,o,s.x,s.y,m,u,r,i),ce(e.m_cp[0].x,e.m_cp[0].y,r,i),ce(e.m_cp[1].x,e.m_cp[1].y,r,i),i.endArray(),i.endObject(),!1}function le(e,t,n,r,i,s,a,o){o.startArray(),o.addDouble(n,a),o.addDouble(r,a),e&&o.addDouble(i,a),t&&o.addDouble(s,a),o.endArray()}function ce(e,t,n,r){r.startArray(),r.addDouble(e,n),r.addDouble(t,n),r.endArray()}function de(e,t,n,r){const s=n.getImpl(),a=!!(2&t),o=!!(4&t),m=!!(8&t),u=s.hasAttribute(1)&&!a,l=s.hasAttribute(2)&&!o,c=s.hasAttribute(3)&&!m,h=s.hasNonLinearSegments();u&&(r.addFieldName("hasZ"),r.addBool(!0)),l&&(r.addFieldName("hasM"),r.addBool(!0)),e?h?r.addFieldName("curveRings"):r.addFieldName("rings"):h?r.addFieldName("curvePaths"):r.addFieldName("paths");let _=null;const p=[];if(n.isEmpty())r.startArray(),r.endArray();else{const e=17-(31&t>>13);r.startArray();const i=n.getPathCount();let m=0;const f=s.getAttributeStreamRef(0);let k=null,b=null,y=null;const T=new A;let N=null,g=null,v=null;h&&(N=s.getSegmentFlagsStreamRef(),g=s.getSegmentIndexStreamRef(),v=s.getSegmentDataStreamRef()),u&&(k=s.getAttributeStreamRef(1)),l&&(b=s.getAttributeStreamRef(2)),c&&(y=s.getAttributeStreamRef(3),_=W(3,0));for(let t=0;t<i;t++){r.startArray(),c&&p.push(0);const i=n.getPathEnd(t);if(m===i){r.endArray();continue}const s=n.isClosedPath(t);let h=f.read(2*m),x=f.read(2*m+1),A=u?k.read(m):Number.NaN,S=l?b.read(m):Number.NaN,w=c?y.read(m):0;he(u,l,h,x,A,S,e,r);let C=1;c&&(_.add(w),p[p.length-1]++);const D=h,j=x,F=A,O=S,I=w;let z=!1,E=0,P=Number.NaN,B=Number.NaN,V=0;for(let t=m+1,n=m,M=s?i+1:i;t<M;t++,n++){const s=null!==N?31&N.read(n):1;let m,M;if(t<i?(m=f.read(2*t),M=f.read(2*t+1),u&&(P=k.read(t)),l&&(B=b.read(t)),c&&(V=y.read(t))):(m=D,M=j,P=F,B=O,V=I),1!==s){z=!0,4===s?T.createEllipticArc():2===s?T.createCubicBezier():16===s?T.createQuadraticBezier():8===s?T.createQuadraticRationalBezier():d("JSON export.unsupported curve");const t=T.get(),i=g.read(n);t.setStartXYCoords(h,x),t.setEndXYCoords(m,M),u&&(t.setStartAttribute(1,0,A),t.setEndAttribute(1,0,P)),l&&(t.setStartAttribute(2,0,S),t.setEndAttribute(2,0,B)),t.readFromBufferStream(v,i),me(T.get(),a,o,e,r)&&E++}else he(u,l,m,M,P,B,e,r);c&&(_.add(V),p[p.length-1]++),C++,h=m,x=M,A=P,S=B,w=V}z&&0===E||(C<2&&E<1&&(he(u,l,h,x,A,S,e,r),C++,c&&(_.add(w),p[p.length-1]++)),s&&C<3&&E<2&&(he(u,l,D,j,F,O,e,r),C++,h=D,x=j,A=F,S=O,w=I,c&&(_.add(I),p[p.length-1]++))),r.endArray(),m=i}r.endArray()}if(c){r.addFieldName("ids"),r.startArray();let e=0;for(let t=0,n=p.length;t<n;++t){const n=p[t];i(0===n||null!==_&&e+n<=_.size()),r.startArray();for(let t=0;t<n;++t)r.addInt32(_.read(e)),e++;r.endArray()}r.endArray()}}function he(e,t,n,r,i,s,a,o){o.startArray(),o.addDouble(n,a),o.addDouble(r,a),e&&o.addDouble(i,a),t&&o.addDouble(s,a),o.endArray()}const _e="a".charCodeAt(0),pe="A".charCodeAt(0),fe="*".charCodeAt(0),ke="b".charCodeAt(0),be="\\".charCodeAt(0),ye="[".charCodeAt(0),Te="{".charCodeAt(0),Ne=":".charCodeAt(0),ge=".".charCodeAt(0),ve=",".charCodeAt(0),xe='"'.charCodeAt(0),Ae="]".charCodeAt(0),Se="}".charCodeAt(0),we="e".charCodeAt(0),Ce="E".charCodeAt(0),De="f".charCodeAt(0),je="F".charCodeAt(0),Fe="/".charCodeAt(0),Oe="-".charCodeAt(0),Ie="+".charCodeAt(0),ze="n".charCodeAt(0),Ee="N".charCodeAt(0),Pe="r".charCodeAt(0),Be="t".charCodeAt(0),Ve="u".charCodeAt(0),Me="0".charCodeAt(0),Re="9".charCodeAt(0);class Ue{constructor(e){this.m_functionStack=[],this.m_pushPositions=[],this.m_utf8Decoder=new TextDecoder("utf-8",{fatal:!0}),void 0===e?(this.m_startToken=Number.MAX_SAFE_INTEGER,this.m_endToken=0,this.m_currentTokenType=0,this.m_functionStack.push(()=>this.accept_()),this.m_jsonString=null,this.m_bHasEscapes=!1):e.jsonString?this.resetParserFromString(e.jsonString):e.jsonStream?d("streaming json parsing not yet impl"):n("invalid constructor parameter")}prepSubstrString_(){}getCurrentSubstrString_(){return this.m_jsonString.slice(this.m_startToken,this.m_endToken)}stepOverCharString_(){this.m_endToken++}peekCharString_(){return this.m_jsonString.charCodeAt(this.m_endToken)}getString_(e){const t=this.m_jsonString?.slice(this.m_startToken,this.m_startToken+e-1);return this.m_endToken+=e-1,{s:t,bDone:this.m_endToken>=this.m_jsonString.length}}incrementString_(){this.m_endToken++}eofString_(){return this.m_endToken>=this.m_jsonString.length}setStringFunctions_(){this.m_prepSubstr=this.prepSubstrString_,this.m_getCurrentSubstr=this.getCurrentSubstrString_,this.m_stepOverChar=this.stepOverCharString_,this.m_peekChar=this.peekCharString_,this.m_get=this.getString_,this.m_increment=this.incrementString_,this.m_eof=this.eofString_}setStreamFunctions_(){d("streaming json parsing not yet impl")}reset_(){this.m_jsonString=null,this.m_endToken=0,this.m_startToken=Number.MAX_SAFE_INTEGER,this.m_currentTokenType=0,this.m_bHasEscapes=!1,this.m_functionStack.length=0,this.m_functionStack.push(()=>this.start_()),this.m_pushPositions.length=0}resetParserFromString(e){this.reset_(),this.setStringFunctions_(),this.m_jsonString=e}resetParserFromStream(e){d("streaming json parsing not yet impl")}resetToPosition(e){return!!this.m_jsonString&&(this.m_endToken=e,this.m_startToken=Number.MAX_VALUE,this.m_currentTokenType=0,this.m_functionStack.length=0,e>=this.m_jsonString.length?(this.m_functionStack.push(()=>this.accept_()),!1):(this.m_functionStack.push(()=>this.start_()),!0))}nextToken(){return this.m_functionStack.at(-1)(),this.m_currentTokenType}currentToken(){return this.m_currentTokenType}currentTokenStartIndex(){return this.m_startToken}currentTokenEndIndex(){return this.m_endToken}currentText(){return i(0),""}childrenAsString(){return i(0),""}skipChildren(){this.skipChildren_()}skipChildren_(){if(1===this.m_currentTokenType){let e=1;do{this.m_currentTokenType=this.nextToken(),1===this.m_currentTokenType?e++:3===this.m_currentTokenType&&e--}while(3!==this.m_currentTokenType||0!==e);return}if(2===this.m_currentTokenType){let e=1;do{this.m_currentTokenType=this.nextToken(),2===this.m_currentTokenType?e++:4===this.m_currentTokenType&&e--}while(4!==this.m_currentTokenType||0!==e);return}}currentTerminalAsString_(){switch(this.m_currentTokenType){case 7:case 8:case 9:return this.m_getCurrentSubstr().slice(0,this.m_endToken-this.m_startToken);case 10:return"null";case 11:return"true";case 12:return"false"}r("invalid token")}toUTF8_(e,t){let n=0,r=e;for(;t.charCodeAt(r)===be&&t.charCodeAt(r+1)===Ve;)n++,r+=6;r=e;const i=new Uint8Array(n);let s=0;for(;t.charCodeAt(r)===be&&t.charCodeAt(r+1)===Ve;)i[s++]=Number.parseInt(t.slice(r+2,r+6),16),r+=6;return{u8s:this.m_utf8Decoder.decode(i),end:r}}unquoteCurrentString_(){let e="",t=1;const n=this.m_endToken-this.m_startToken-1;let r=0;const i=this.m_getCurrentSubstr();for(let s=t;s<n;s++)if(i.charCodeAt(s)!==be)r++;else{switch(r>0&&(e+=i.slice(t,t+r)),i.charCodeAt(++s)){case xe:e+='"';break;case Ve:{const{u8s:t,end:n}=this.toUTF8_(s-1,i);s=n-1,e+=t;break}case be:e+="\\";break;case Fe:e+="/";break;case ke:e+="\b";break;case De:e+="\f";break;case ze:e+="\n";break;case Pe:e+="\r";break;case Be:e+="\t"}t=s+1,r=0}return r>0&&(e+=i.slice(t,t+r)),e}currentString(){return 5!==this.m_currentTokenType&&6!==this.m_currentTokenType?this.currentTerminalAsString_():this.m_bHasEscapes?this.unquoteCurrentString_():this.m_getCurrentSubstr().slice(1,this.m_endToken-this.m_startToken-2+1)}currentDoubleValue(){if(7!==this.m_currentTokenType&&8!==this.m_currentTokenType&&9!==this.m_currentTokenType&&6!==this.m_currentTokenType&&10!==this.m_currentTokenType&&r("invalid token"),10===this.m_currentTokenType)return Number.NaN;let e=this.m_getCurrentSubstr(),t=this.m_endToken-this.m_startToken;if(6===this.m_currentTokenType){if("NaN"===this.currentString())return Number.NaN;e=e.slice(1),t-=2,0===t&&r("invalid token")}const n=Number.parseFloat(e);if(6===this.m_currentTokenType)Number.isNaN(n)&&r("invalid token");else if(Number.isNaN(n))return Number.NaN;return n}currentInt32Value(){8!==this.m_currentTokenType&&6!==this.m_currentTokenType&&r("invalid token");let e=this.m_getCurrentSubstr(),t=this.m_endToken-this.m_startToken;6===this.m_currentTokenType&&(e=e.slice(1),t-=2,0===t&&r("invalid token"));const n=parseInt(e);return Number.isNaN(n)&&r("invalid token"),n}currentInt64Value(){return i(0),0n}currentBoolValue(){return i(0),!1}isError(){return 0}JSONString(){return i(0),""}pushPosition(){return i(0),!1}popPosition(){return i(0),!1}skipCStyleComments_(){i(0)}skipCppStyleComments_(){i(0)}skipComments_(){this.m_prepSubstr();let e=this.m_peekChar();this.m_stepOverChar(),this.m_eof()&&r("invalid token"),e=this.m_peekChar(),e===fe?this.skipCStyleComments_():e===Fe?this.skipCppStyleComments_():r("invalid token")}skipWhiteSpace_(){let e;do{this.m_eof()&&r("invalid token");let t=this.m_peekChar();for(;t>=9&&t<=13||32===t;)this.m_increment(),this.m_eof()&&r("invalid token"),t=this.m_peekChar();t===Fe?(this.m_startToken=this.m_endToken,e=!0,this.skipComments_()):e=!1}while(e)}rightBracket_(){return this.m_peekChar()===Ae&&(this.m_startToken=this.m_endToken,this.m_increment(),this.m_currentTokenType=4,!0)}rightBrace_(){return this.m_peekChar()===Se&&(this.m_startToken=this.m_endToken,this.m_increment(),this.m_currentTokenType=3,!0)}string_(){this.m_prepSubstr(),this.m_bHasEscapes=!1,this.m_stepOverChar(),this.m_eof()&&r("invalid token");let e=this.m_peekChar();for(;e!==xe;){const t=e===be;if(this.m_stepOverChar(),this.m_eof()&&r("invalid token"),e=this.m_peekChar(),t)if(this.m_bHasEscapes=!0,e===xe||e===be||e===Fe||e===ke||e===De||e===ze||e===Pe||e===Be)this.m_stepOverChar(),this.m_eof()&&r("invalid token"),e=this.m_peekChar();else if(e===Ve)for(let t=0;t<4;t++)this.m_stepOverChar(),this.m_eof()&&r("invalid token"),e=this.m_peekChar(),e>=Me&&e<=Re||e>=_e&&e<=De||e>=pe&&e<=je||r("invalid token");else r("invalid token")}this.m_stepOverChar()}comma_(){return this.m_peekChar()===ve&&(this.m_increment(),!0)}colon_(){return this.m_peekChar()===Ne&&(this.m_increment(),!0)}fieldNameEnd_(){this.skipWhiteSpace_(),this.m_functionStack.pop(),this.colon_()?(this.skipWhiteSpace_(),this.value_()):r("invalid token")}fieldNameStart_(){this.m_startToken=this.m_endToken,this.m_peekChar()!==xe&&r("invalid token"),this.string_(),this.m_currentTokenType=5,this.m_functionStack.push(()=>this.fieldNameEnd_())}pairEnd_(){this.skipWhiteSpace_(),this.comma_()?(this.skipWhiteSpace_(),this.fieldNameStart_()):this.rightBrace_()?this.m_functionStack.pop():r("invalid token")}arrayStart_(){this.skipWhiteSpace_(),this.m_functionStack.pop(),this.rightBracket_()||(this.m_functionStack.push(()=>this.elementEnd_()),this.value_())}elementEnd_(){this.skipWhiteSpace_(),this.comma_()?(this.skipWhiteSpace_(),this.value_()):this.rightBracket_()?this.m_functionStack.pop():r("invalid token")}objectStart_(){this.skipWhiteSpace_(),this.m_functionStack.pop(),this.rightBrace_()||(this.m_functionStack.push(()=>this.pairEnd_()),this.fieldNameStart_())}valueStartObject_(){this.m_increment(),this.m_currentTokenType=1,this.m_functionStack.push(()=>this.objectStart_())}valueStartArray_(){this.m_increment(),this.m_currentTokenType=2,this.m_functionStack.push(()=>this.arrayStart_())}valueString_(){this.string_(),this.m_currentTokenType=6}int_(){this.m_peekChar()!==Me?this.digits_():this.m_stepOverChar()}digits_(){let e=this.m_peekChar();do{this.m_stepOverChar(),this.m_eof()&&r("invalid token"),e=this.m_peekChar()}while(e>=Me&&e<=Re)}frac_(){let e=this.m_peekChar();this.m_stepOverChar(),this.m_eof()&&r("invalid token"),e=this.m_peekChar(),e>=Me&&e<=Re||r("invalid token"),this.digits_()}exp_(){let e=this.m_peekChar();this.m_stepOverChar(),this.m_eof()&&r("invalid token"),e=this.m_peekChar(),e!==Ie&&e!==Oe||(this.m_stepOverChar(),this.m_eof()&&r("invalid token"),e=this.m_peekChar()),e>=Me&&e<=Re||r("invalid token"),this.digits_()}valueNumber_(){this.m_prepSubstr();let e=!1,t=this.m_peekChar();if(t===Oe?(this.m_stepOverChar(),this.m_eof()&&r("invalid token"),t=this.m_peekChar(),e=!0,t>=Me&&t<=Re||r("invalid token"),this.int_()):this.int_(),t=this.m_peekChar(),t===ge)this.m_currentTokenType=7,this.frac_(),t=this.m_peekChar(),t!==we&&t!==Ce||this.exp_();else if(t===we||t===Ce)this.m_currentTokenType=7,this.exp_();else{let t=0;e&&t++;const n=this.m_endToken-this.m_startToken-t;if(n<10)this.m_currentTokenType=8;else if(10===n){const n=this.m_getCurrentSubstr();e?n.slice(t)<="2147483648"?this.m_currentTokenType=8:this.m_currentTokenType=9:n.slice(t)<="2147483647"?this.m_currentTokenType=8:this.m_currentTokenType=9}else if(n<19)this.m_currentTokenType=9;else if(19===n){const n=this.m_getCurrentSubstr();e?n.slice(t)<="9223372036854775808"?this.m_currentTokenType=9:this.m_currentTokenType=7:n.slice(t)<="9223372036854775807"?this.m_currentTokenType=9:this.m_currentTokenType=7}else this.m_currentTokenType=7}}valueNull_(){const{s:e,bDone:t}=this.m_get(5);t&&r("invalid token"),"null"!==e&&r("invalid token"),this.m_currentTokenType=10}valueTrue_(){const{s:e,bDone:t}=this.m_get(5);t&&r("invalid token"),"true"!==e&&r("invalid token"),this.m_currentTokenType=11}valueFalse_(){const{s:e,bDone:t}=this.m_get(6);t&&r("invalid token"),"false"!==e&&r("invalid token"),this.m_currentTokenType=12}valueNan_(){const{s:e,bDone:t}=this.m_get(4);t&&r("invalid token"),"NaN"!==e&&r("invalid token"),this.m_currentTokenType=7}value_(){this.m_startToken=this.m_endToken;const e=this.m_peekChar();e===Te?this.valueStartObject_():e===ye?this.valueStartArray_():e===xe?this.valueString_():e===Oe||e>=Me&&e<=Me+9?this.valueNumber_():e===ze?this.valueNull_():e===Be?this.valueTrue_():e===De?this.valueFalse_():e===Ee?this.valueNan_():r("invalid token")}start_(){this.skipWhiteSpace_(),this.m_functionStack.pop(),this.m_functionStack.push(()=>this.accept_());const e=this.m_peekChar();e!==Te&&e!==ye&&r("invalid token"),this.value_()}accept_(){this.m_startToken=this.m_endToken,this.m_currentTokenType=0}}const We=new class{constructor(){this.m_pendingKey=null,this.m_acceptedObject=null,this.m_currentObject=[]}reset(){this.m_pendingKey=null,this.m_acceptedObject=null,this.m_currentObject.length=0}startObject(){const e={};this.m_pendingKey?(this.m_currentObject.at(-1)[this.m_pendingKey]=e,this.m_pendingKey=null):Array.isArray(this.m_currentObject.at(-1))&&this.m_currentObject.at(-1).push(e),this.m_currentObject.push(e)}startArray(){const e=[];this.m_pendingKey?(this.m_currentObject.at(-1)[this.m_pendingKey]=e,this.m_pendingKey=null):Array.isArray(this.m_currentObject.at(-1))&&this.m_currentObject.at(-1).push(e),this.m_currentObject.push(e)}endObject(){this.m_acceptedObject=this.m_currentObject.at(-1),this.m_currentObject.pop()}endArray(){this.m_currentObject.pop()}addFieldName(e){this.m_pendingKey=e}addValue_(e){this.m_pendingKey?(this.m_currentObject.at(-1)[this.m_pendingKey]=e,this.m_pendingKey=null):this.m_currentObject.at(-1).push(e)}addString(e){this.addValue_(e)}addDouble(e,t){this.addValue_(e)}addInt64(e){i(0)}addInt32(e){this.addValue_(e)}addBool(e){this.addValue_(e)}addNull(){this.addValue_(null)}getObject(){return this.m_acceptedObject}},Xe=new class{getOperatorType(){return 10405}accelerateGeometry(e,t,n){return!1}canAccelerateGeometry(e){return!1}supportsCurves(){return!0}execute(e,t,s,a,m,u){!function(e,t,s,a){if(t||s){if(a.startObject(),null!==t)switch(t.getGeometryType()){case o.enumPolygon:de(!0,e,t,a);break;case o.enumPolyline:de(!1,e,t,a);break;case o.enumMultiPoint:!function(e,t,n){const r=t.getImpl(),s=r.hasAttribute(1)&&!(2&e),a=r.hasAttribute(2)&&!(4&e),o=r.hasAttribute(3)&&!(8&e);s&&(n.addFieldName("hasZ"),n.addBool(!0)),a&&(n.addFieldName("hasM"),n.addBool(!0)),n.addFieldName("points");const m=t.getPointCount();if(t.isEmpty())n.startArray(),n.endArray();else{const t=17-(31&e>>13);n.startArray();const i=r.getAttributeStreamRef(0);let o=null,u=null;s&&(o=r.getAttributeStreamRef(1)),a&&(u=r.getAttributeStreamRef(2));for(let e=0;e<m;e++){const r=i.read(2*e),m=i.read(2*e+1);let l=Number.NaN,c=Number.NaN;s&&(l=o.read(e)),a&&(c=u.read(e)),he(s,a,r,m,l,c,t,n)}n.endArray()}if(o){let e=null;r.isEmpty()||(e=r.getAttributeStreamRef(3)),i(0===m||null!==e&&e.size()>=m),n.addFieldName("ids"),n.startArray();for(let t=0;t<m;t++)n.addInt32(e.read(t));n.endArray()}}(e,t,a);break;case o.enumPoint:!function(e,t,n){const r=t.hasAttribute(1)&&!(2&e),i=t.hasAttribute(2)&&!(4&e),s=t.hasAttribute(3)&&!(8&e);if(t.isEmpty())return n.addFieldName("x"),n.addNull(),n.addFieldName("y"),n.addNull(),r&&(n.addFieldName("z"),n.addNull()),i&&(n.addFieldName("m"),n.addNull()),void(s&&(n.addFieldName("id"),n.addInt32(0)));const a=17-(31&e>>13);n.addFieldName("x"),n.addDouble(t.getX(),a),n.addFieldName("y"),n.addDouble(t.getY(),a),r&&(n.addFieldName("z"),n.addDouble(t.getZ(),a)),i&&(n.addFieldName("m"),n.addDouble(t.getM(),a)),s&&(n.addFieldName("id"),n.addInt32(t.getID()))}(e,t,a);break;case o.enumEnvelope:!function(e,t,n){const r=t.hasAttribute(1)&&!(2&e),i=t.hasAttribute(2)&&!(4&e),s=t.hasAttribute(3)&&!(8&e);if(t.isEmpty())return n.addFieldName("xmin"),n.addNull(),n.addFieldName("ymin"),n.addNull(),n.addFieldName("xmax"),n.addNull(),n.addFieldName("ymax"),n.addNull(),r&&(n.addFieldName("zmin"),n.addNull(),n.addFieldName("zmax"),n.addNull()),i&&(n.addFieldName("mmin"),n.addNull(),n.addFieldName("mmax"),n.addNull()),void(s&&(n.addFieldName("idmin"),n.addInt32(0),n.addFieldName("idmax"),n.addInt32(0)));const a=17-(31&e>>13);if(n.addFieldName("xmin"),n.addDouble(t.getXMin(),a),n.addFieldName("ymin"),n.addDouble(t.getYMin(),a),n.addFieldName("xmax"),n.addDouble(t.getXMax(),a),n.addFieldName("ymax"),n.addDouble(t.getYMax(),a),r){const e=t.queryInterval(1,0);n.addFieldName("zmin"),n.addDouble(e.vmin,a),n.addFieldName("zmax"),n.addDouble(e.vmax,a)}if(i){const e=t.queryInterval(2,0);n.addFieldName("mmin"),n.addDouble(e.vmin,a),n.addFieldName("mmax"),n.addDouble(e.vmax,a)}if(s){const e=t.queryInterval(3,0);n.addFieldName("idmin"),n.addInt32(e.vmin),n.addFieldName("idmax"),n.addInt32(e.vmax)}}(e,t,a);break;case o.enumMultipatch:i(0);break;default:n("exportToJSON")}null!==s&&(a.addFieldName("spatialReference"),function(e,t,n){n.startObject();let i=0;t.isCustomWkid()||(i=t.getOldID());let s=0;const a=t.getVCS();if(null!==a&&(a.isCustomWkid()||(s=a.getOldID()),s<=0&&(i=0)),i>0){n.addFieldName("wkid"),n.addInt32(i);const e=t.getLatestID();if(e>0&&e!==i&&(n.addFieldName("latestWkid"),n.addInt32(e)),s>0){n.addFieldName("vcsWkid"),n.addInt32(s);const e=t.getLatestVerticalID();e!==s&&(n.addFieldName("latestVcsWkid"),n.addInt32(e))}}if(0===t.getCoordinateSystemType())n.addFieldName("wkid"),n.addNull(),null!==t.getUnit()&&(n.addFieldName("unit"),function(e,t,n){n.startObject();const i=t.getID();i<=0&&r("cannot export unit that has no valid WKID"),n.addFieldName("uwkid"),n.addInt32(i),n.endObject()}(0,t.getUnit(),n));else if(i<=0||1&e){let r="";64&e&&(r=t.getText2(),n.addFieldName("wkt2"),n.addString(r));const i=t.getText();i!==r&&(n.addFieldName("wkt"),n.addString(i))}if(16&e){const e=new N;t.queryPrecisionDescriptor(e),n.addFieldName("xyTolerance"),n.addDouble(e.getTolerance(0)),n.addFieldName("zTolerance"),n.addDouble(e.getTolerance(1)),n.addFieldName("mTolerance"),n.addDouble(e.getTolerance(2)),n.addFieldName("falseX"),n.addDouble(e.getFalseX()),n.addFieldName("falseY"),n.addDouble(e.getFalseY()),n.addFieldName("xyUnits"),n.addDouble(e.getGridUnitsXY()),n.addFieldName("falseZ"),n.addDouble(e.getFalseZ()),n.addFieldName("zUnits"),n.addDouble(e.getGridUnitsZ()),n.addFieldName("falseM"),n.addDouble(e.getFalseM()),n.addFieldName("mUnits"),n.addDouble(e.getGridUnitsM())}n.endObject()}(e,s,a)),a.endObject()}}(e,t,s,a)}exportSpatialReference(e,t,n,r){i(0)}exportProjectionTransformation(e,t,n,r){i(0)}exportDatumTransformation(e,t,n,r){i(0)}static geometryTypeToString(e){return i(0),""}},Le=new class{getOperatorType(){return 10404}accelerateGeometry(e,t,n){return!1}canAccelerateGeometry(e){return!1}supportsCurves(){return!0}execute(e,t,s,a,m,u,l){let c;"string"==typeof s?(c=new Ue({jsonString:s}),c.nextToken()):c=s,1!==c.currentToken()&&r("failed to import map geometry: start of object is expected");const d=function(e,t,s,a,m){let u=!1,l=!1,c=!1,d=!1,h=!1,_=!1,p=!1,f=!1,k=!1,b=!1,y=!1,T=!1,N=!1,g=!1,A=!1,w=!1,C=!1,D=!1,j=!1,F=!1,O=!1,I=!1,V=!1,M=!1,R=Number.NaN,W=Number.NaN,X=Number.NaN,L=Number.NaN,Y=0,G=Number.NaN,K=Number.NaN,q=Number.NaN,Z=Number.NaN,J=Number.NaN,H=Number.NaN,ie=Number.NaN,se=Number.NaN,ae=0,oe=0,me=!1,ue=!1,le=null,ce=null,de=null,he=null,_e=null;for(;3!==s.nextToken();){const t=s.currentString();if(s.nextToken(),"spatialReference"===t){if(m&&!u){u=!0,1===s.currentToken()?he=Q(s):10!==s.currentToken()&&r("failed to parse spatial reference: object or null is expected");continue}}else if(a)if("hasZ"===t){if(!l){l=!0,me=11===s.currentToken();continue}}else if("hasM"===t){if(!c){c=!0,ue=11===s.currentToken();continue}}else if("rings"===t){if(!(h||_||e!==o.enumUnknown&&e!==o.enumPolygon)){h=!0,({geometry:_e,as:le,bs:ce}=$(!0,!1,0,s));continue}}else if("curveRings"===t){if(!_&&(e===o.enumUnknown||e===o.enumPolygon)){_=!0,({geometry:_e,as:le,bs:ce}=$(!0,!0,0,s));continue}}else if("paths"===t){if(!(p||f||e!==o.enumUnknown&&e!==o.enumPolyline)){p=!0,({geometry:_e,as:le,bs:ce}=$(!1,!1,0,s));continue}}else if("curvePaths"===t){if(!f&&(e===o.enumUnknown||e===o.enumPolyline)){f=!0,({geometry:_e,as:le,bs:ce}=$(!1,!0,0,s));continue}}else if("points"===t){if(!k&&(e===o.enumUnknown||e===o.enumMultiPoint)){k=!0,({geometry:_e,as:le,bs:ce}=ee(0,s));continue}}else if("ids"===t){if(!d){d=!0,de=te(0,s);continue}}else if("x"===t){if(!b&&(e===o.enumUnknown||e===o.enumPoint)){b=!0,R=ne(s);continue}}else if("y"===t){if(!y&&(e===o.enumUnknown||e===o.enumPoint)){y=!0,W=ne(s);continue}}else if("z"===t){if(!T&&(e===o.enumUnknown||e===o.enumPoint)){T=!0,X=ne(s);continue}}else if("m"===t){if(!N&&(e===o.enumUnknown||e===o.enumPoint)){N=!0,L=ne(s);continue}}else if("id"===t){if(!g&&(e===o.enumUnknown||e===o.enumPoint)){g=!0,Y=re(s);continue}}else if("xmin"===t){if(!A&&(e===o.enumUnknown||e===o.enumEnvelope)){A=!0,G=ne(s);continue}}else if("ymin"===t){if(!w&&(e===o.enumUnknown||e===o.enumEnvelope)){w=!0,K=ne(s);continue}}else if("mmin"===t){if(!O&&(e===o.enumUnknown||e===o.enumEnvelope)){O=!0,ie=ne(s);continue}}else if("zmin"===t){if(!j&&(e===o.enumUnknown||e===o.enumEnvelope)){j=!0,J=ne(s);continue}}else if("idmin"===t){if(!V&&(e===o.enumUnknown||e===o.enumEnvelope)){V=!0,ae=re(s);continue}}else if("xmax"===t){if(!C&&(e===o.enumUnknown||e===o.enumEnvelope)){C=!0,q=ne(s);continue}}else if("ymax"===t){if(!D&&(e===o.enumUnknown||e===o.enumEnvelope)){D=!0,Z=ne(s);continue}}else if("mmax"===t){if(!I&&(e===o.enumUnknown||e===o.enumEnvelope)){I=!0,se=ne(s);continue}}else if("zmax"===t){if(!F&&(e===o.enumUnknown||e===o.enumEnvelope)){F=!0,H=ne(s);continue}}else if("idmax"===t){if(!M&&(e===o.enumUnknown||e===o.enumEnvelope)){M=!0,oe=re(s);continue}}else"materials"===t&&i(0);s.skipChildren()}if(h||_||p||f||k){let e=null,t=null;const r=_e;me&&(_e.addAttribute(1),e=le,e||(e=z(r.getPointCount(),Number.NaN))),ue&&(_e.addAttribute(2),t=me?ce:le),null!=de&&_e.addAttribute(3),me&&null!=e&&r.setAttributeStreamRef(1,e),ue&&null!=t&&r.setAttributeStreamRef(2,t),null!=de&&function(e,t){if(e.isEmpty())return;const r=U(2,0),i=e.getGeometryType();let s=0;i===S.type?s=1:i===x.type||i===v.type?s=e.getPathCount():n("not implemented"),r.resize(e.getPointCount(),0);let a=0;for(let o=0;o<s;++o){const s=t.read(a);a++;const m=a+s;let u=0,l=0;i===S.type?u=e.getPointCount():i===x.type||i===v.type?(u=e.getPathSize(o),l=e.getPathStart(o)):n("not implemented");for(let e=0,n=Math.min(s,u);e<n;++e)r.write(l,t.read(a)),a++,l++;a=m}e.getImpl().setAttributeStreamRef(3,r)}(r,de)}else if(b||y||N||T||g){E(R,W)||r("failed to parse point: x and y must be finite or nan"),(Number.isNaN(W)||Number.isNaN(R))&&(R=Number.NaN,W=Number.NaN);const e=new P({x:R,y:W});T&&e.setZ(X),N&&e.setM(L),g&&e.setID(Y),_e=e}else if(A||w||C||D||j||F||O||I||V||M){(Number.isNaN(K)||Number.isNaN(q)||Number.isNaN(Z))&&(G=Number.NaN);const e=new B({xmin:G,ymin:K,xmax:q,ymax:Z});j&&F&&e.setInterval(1,0,J,H),O&&I&&e.setInterval(2,0,ie,se),V&&M&&e.setInterval(3,0,ae,oe),_e=e}return{..._e?{geom:_e}:{},...he?{sr:he}:{}}}(t,0,c,a,m);return new I(d)}importSpatialReference(e){const t=Q(e);return null===t&&n("failed to import spatial reference"),t}importProjectionTransformation(e,t){return i(0),{}}importDatumTransformation(e,t){return i(0),{}}static stringToGeometryType(e){return(e=e.toLowerCase()).startsWith("esrigeometry")||r("string_to_geometry_type"),e.endsWith("point")?o.enumPoint:e.endsWith("envelope")?o.enumEnvelope:e.endsWith("multipoint")?o.enumMultiPoint:e.endsWith("polyline")?o.enumPolyline:e.endsWith("polygon")?o.enumPolygon:void r("string_to_geometry_type")}};function Ye(e){return Array.isArray(e)?e[0].spatialReference:e.spatialReference}function Ge(e,t){const n=new Z(e,{strict:!1});return n.nextToken(),Le.execute(0,o.enumUnknown,n,!0,t)}function Ke(e){let t=null;return[e.map(e=>{if(null==t){const n=qe(e);return t=n.getSpatialReference(),n.getGeometry()}return Ze(e)}),t]}function qe(e){return Ge(e,!0)}function Ze(e){return Ge(e,!1).getGeometry()}function Je(e,t){return e instanceof I&&(t=e.getSpatialReference(),e=e.getGeometry()),e?.isEmpty()?null:(We.reset(),Xe.execute(0,e,t,We),We.getObject())}export{Ke as fromGeometries,qe as fromGeometry,Ze as fromGeometryToGXGeometry,Ye as getSpatialReference,Je as toGeometry};
