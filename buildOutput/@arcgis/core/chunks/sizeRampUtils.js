/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../Color.js";import{g as o}from"./colorUtils2.js";import{r as s,n as e,p as i}from"./numberUtils.js";import{u as r}from"./referenceSizeUtils.js";import{updateSpikeSymbol as l}from"../smartMapping/renderers/support/spikeUtils.js";import m from"../symbols/SimpleLineSymbol.js";import p from"../symbols/SimpleMarkerSymbol.js";import{applyCIMSymbolColor as a}from"../symbols/support/cimSymbolUtils.js";import{getCIMSymbolPreviewSize as n}from"./previewCIMSymbol.js";import{i as j}from"./typeUtils2.js";import{i as y,d as c}from"./utils8.js";import{getAuthoringInfoVisualVariableByTheme as u,getSymbolForFlowRenderer as b,createStopLabel as f}from"./utils17.js";import"./widgetUtils.js";import{i as d}from"./modeUtils.js";import"./colorUtils.js";import"./mathUtils.js";import"./ensureType.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./MapUtils.js";import"./vec4.js";import"./common.js";import"./vec4f64.js";import"../intl.js";import"./date.js";import"./jsonMap.js";import"./locale.js";import"./handleUtils.js";import"./constants.js";import"./datetime.js";import"./number.js";import"./substitute.js";import"./messages.js";import"../core/Error.js";import"../core/promiseUtils.js";import"./events.js";import"./maybe.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./persistableUrlUtils.js";import"./assets.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./utils.js";import"./metadata.js";import"./enumeration.js";import"./reader.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./tracking.js";import"./Warning.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./SetUtils.js";import"../core/sql.js";import"./guards.js";import"../symbols/Symbol.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./SimpleTrackingTarget.js";import"./screenUtils.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/MarkerSymbol.js";import"./utils6.js";import"./defaultCIMValues.js";import"./CIMSymbolHelper.js";import"./BidiEngine.js";import"./aaBoundingRect.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./pe.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./boundsUtils.js";import"../symbols/Font.js";import"./labelPoint.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./zmUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polyline.js";import"./OptimizedGeometry.js";import"./memoryEstimations.js";import"./GeometryUtils.js";import"./fontUtils.js";import"./rasterizingUtils.js";import"./floatRGBA.js";import"./definitions.js";import"./shapingUtils.js";import"./mat2d.js";import"./mat2df32.js";import"./vec2.js";import"./vec2f32.js";import"./Rect.js";import"./BoundingBox.js";import"./defaults.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/TextSymbol.js";import"./defaultsJSON.js";import"./CIMSymbolRasterizer.js";import"./CIMResourceManager.js";import"./imageUtils.js";import"./OverrideHelper.js";import"../layers/support/FieldsIndex.js";import"./UnknownTimeZone.js";import"./timeZoneUtils.js";import"./ArcadeExpression.js";import"./TimeOnly.js";import"./enum.js";import"./callExpressionWithFeature.js";import"./quantizationUtils.js";import"./renderUtils.js";import"./projector.js";import"./sanitizerUtils.js";import"./svgUtils.js";import"./gfxUtils.js";import"./LRUCache.js";import"./MemCache.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils3.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils4.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./vec3f64.js";import"./aaBoundingBox.js";import"./DoubleArray.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../core/reactiveUtils.js";import"../symbols/WebStyleSymbol.js";import"./asyncUtils.js";import"./jsonUtils2.js";import"./parser.js";import"./utils5.js";import"./mat4.js";import"./timeUtils.js";import"./utils7.js";import"./basemapUtils.js";import"./basemapDefinitions.js";const S=30,g=12,U=[255,255,255],h=[200,200,200],v=[128,128,128];async function w(e,i,a,S,g,U,w){const x=i.legendOptions,P=x?.customValues,C=w||await async function(s,e){if("flow"===s.type)return b(s,e);if("pie-chart"===s.type)return new p({color:null,outline:s.outline?.width?s.outline:new m});let i=null,a=null;if("simple"===s.type)i=s.symbol;else if("class-breaks"===s.type){const t=s.classBreakInfos;i=t&&t[0]&&t[0].symbol,a=t.length>1}else if("unique-value"===s.type){const t=s.uniqueValueInfos;i=t?.[0]?.symbol,a=null!=t&&t.length>1}if(!i||function(t){return j(t)?t.symbolLayers?.some(t=>"fill"===t?.type)??!1:t?.type.includes("fill")??!1}(i))return null;if(i=i.clone(),e||a)if(i.type.includes("3d"))D(i);else if(u(s,"reference-size")&&"cim"===i.type)r(i,{color:e??("class-breaks"!==s.type?new t(h):null)});else if(u(s,"spike")&&"cim"===i.type){const s=new t(h),r=new t(v),m="CIMPointSymbol"===i.data.symbol?.type?i.data.symbol:null,p=!!m?.symbolLayers?.find(({type:t})=>"CIMSolidStroke"===t)?.colorLocked;let a,n=e??void 0;if(n){const t=o(n),e=d();(!e&&t>225||e&&t<25)&&(n=s,a=p?r:s)}else n=s,a=p?r:s;l(i,{color:n,strokeColor:a})}else z(i);return i}(e,a),I=i.stops,E=!!C,O=!!P,T=null!=i.minSize&&null!=i.maxSize,V=I&&I.length>1,B=!!i.target;if(!E||!O&&!(T||V&&!B))return;const R=y(C);let F=!1,A=null,q=null;A=R&&!V?s([i.minDataValue,i.maxDataValue]):P??await async function(t,o,e,i){const r=(await import("./visualVariableUtils.js").then(t=>t.l)).getSizeRangeAtScale(t,e,i),l=r&&L(r);if(!r||!l)return;let m=l.map(o=>function(t,o,s){const e=s.minSize,i=s.maxSize,r=o.minDataValue,l=o.maxDataValue;let m;return m=t<=e?r:t>=i?l:(t-e)/(i-e)*(l-r)+r,m}(o,t,r));m=s(m);for(let s=1;s<m.length-1;s++){const r=await k(t,o,m[s],m[s-1],e,i);r&&(m[s]=r[0],l[s]=r[1])}return m}(i,C,S,g?.type);const G=e?.authoringInfo,H="univariate-color-size"===G?.type,W=H&&"above-and-below"===G?.univariateTheme,J=!!u(e,"reference-size"),N=!!u(e,"spike");if(!A&&V&&(A=I.map(t=>t.value),F=I.some(t=>!!t.label),"flow"===e.type&&(A=s(A)),F&&(q=I.map(t=>t.label))),R&&null!=A&&A?.length>2&&!W&&(A=[A[0],A[A.length-1]]),!A)return null;H&&5!==A?.length&&(A=L({minSize:A[0],maxSize:A[A.length-1]}));const Q=R?function(t,o){const s=t?.authoringInfo,e="univariate-color-size"===s?.type;let i=[12,30];if(e){const t=o[0],s=o[o.length-1],e=12,r=30;i=o.map(o=>e+(o-t)/(s-t)*(r-e))}return e&&"below"===s?.univariateTheme&&i.reverse(),i}(e,A):null,Z=c(C),K=F?null:function(t,o){const s=t.length-1;return t.map((t,e)=>f(t,e,s,o))}(A,U),X=await Promise.all(A.map(async(t,o)=>{let s=R?Q[o]:await M(i,C,t,S,g?.type),m=s;J&&(s*=24/i.maxSize||1,m=24);const p=function(t,o,s,e){"univariate-color-size"===s?.authoringInfo?.type&&"above-and-below"===s?.authoringInfo?.univariateTheme&&"class-breaks"===s.type&&(t=function(t,o){const s=t.classBreakInfos,e=s.length,i=e<2||!(o>=2)?s[0].symbol.clone():s[e-1].symbol.clone(),r=t.visualVariables?.some(t=>"color"===t.type);return r&&(i.type.includes("3d")?D(i):z(i)),i}(s,e));const i=t.clone();if(j(i))y(i)||i.symbolLayers.forEach(t=>{"fill"!==t.type&&(t.size=o)});else if("esri.symbols.SimpleMarkerSymbol"===i.declaredClass)i.size=o;else if("esri.symbols.PictureMarkerSymbol"===i.declaredClass){const t=i.width,s=i.height;i.height=o,i.width=o*(t/s)}else"esri.symbols.SimpleLineSymbol"!==i.declaredClass?function(t){return"esri.symbols.TextSymbol"===t.declaredClass}(i)?i.font&&(i.font.size=o):"cim"===i.type&&u(s,"reference-size")?r(i,{innerDotSize:o,outerRingSize:24}):"cim"===i.type&&u(s,"spike")&&l(i,{defaultHeight:o,primitiveOverrides:null}):i.width=o;return i}(C,s,e,o);return N&&"cim"===p.type&&(m=await n(p)),{value:t,symbol:p,label:F?q[o]:K[o],size:m,outlineSize:Z}}));return X.reverse()}function D(t){"line-3d"===t.type?t.symbolLayers.forEach(t=>{t.material={color:v}}):t.symbolLayers.forEach(t=>{"icon"!==t.type||t.resource?.href?t.material={color:h}:(t.material={color:U},t.outline={color:v,size:1.5})})}function z(o){const s=d();if("cim"===o.type)a(o,new t(h));else if(o.type.includes("line"))o.color=v;else if(o.color=s?v:U,"simple-marker"===o.type)if(o.outline){const t=o.outline?.color?.toHex();"#ffffff"===t&&(o.outline.color=v)}else o.outline={color:v,width:1.5}}function L(t){const o=t.minSize,s=(t.maxSize-o)/4,e=[];for(let t=0;t<5;t++)e.push(o+s*t);return e}async function k(t,o,r,l,m,p){const a=await M(t,o,r,m,p),n=await M(t,o,l,m,p),j=e(r),y=j.fractional;let c=j.integer,u=null,b=null;r>0&&r<1&&(u=10**y,c=e(r*=u).integer);for(let e=c-1;e>=0;e--){const l=10**e;let j=Math.floor(r/l)*l,y=Math.ceil(r/l)*l;null!=u&&(j/=u,y/=u);let c=(j+y)/2;[,c]=s([j,c,y],{indexes:[1]});const f=await M(t,o,j,m,p),d=await M(t,o,y,m,p),S=await M(t,o,c,m,p),g=i(a,f,n,null),U=i(a,d,n,null),h=i(a,S,n,null);let v=g.previous<=20,w=U.previous<=20;if(v&&w&&(g.previous<=U.previous?(v=!0,w=!1):(w=!0,v=!1)),v?b=[j,f]:w?b=[y,d]:h.previous<=20&&(b=[c,S]),b)break}return b}async function M(t,o,s,e,i){const{getSize:r}=await import("./visualVariableUtils.js").then(t=>t.l);return r(t,s,{scale:e,view:i,shape:"simple-marker"===o.type?o.style:null})}export{w as getRampStops,S as realWorldMaxSize,g as realWorldMinSize};
