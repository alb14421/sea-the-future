/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../request.js";import t from"../core/Error.js";import{L as n}from"./Logger.js";import{makeAbsolute as i,addQueryParameters as a,urlToObject as r}from"../core/urlUtils.js";import s from"../geometry/SpatialReference.js";import{w as o}from"./unitUtils.js";import{project as l}from"../geometry/support/webMercatorUtils.js";import{c,a as u,b as d}from"./featureConversionUtils.js";import{O as f}from"./OptimizedFeatureSet.js";import{v as m,i as p,c as g}from"./geojson.js";import{c as y}from"./clientSideDefaults.js";import{m as w}from"./sourceUtils.js";import b from"../layers/support/FieldsIndex.js";import{k as j}from"./fieldType.js";import{a as h}from"./constants.js";const F=()=>n.getLogger("esri.layers.ogc.ogcFeatureUtils"),I="startindex",T=new Set([I,"offset"]),k="http://www.opengis.net/def/crs/",x=`${k}OGC/1.3/CRS84`;async function S(n,o,l={},c=5){const{links:u}=n,d=W(u,"items","application/geo+json")||W(u,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==d)throw new t("ogc-feature-layer:missing-items-page","Missing items url");const{apiKey:f,customParameters:g,signal:w}=l,k=i(d.href,n.landingPage.url),x={limit:c,...g,token:f},S=a(k,x),{data:v}=await e(S,{signal:w,headers:{accept:"application/geo+json"}}),O=function(e,t,n){if(!n)return;const i=W(n,"next","application/geo+json"),a=r(i?.href)?.query;if(!a)return;const s=r(e).query,o=Object.keys(s??{}),l=Object.entries(a).filter(([e])=>!o.includes(e)).find(([e,n])=>T.has(e.toLowerCase())&&Number.parseInt(n,10)===t),c=l?.[0];return c}(S,c,v.links)??I;m(v);const q=p(v,{geometryType:o.geometryType}),P=o.fields||q.fields||[],N=null!=o.hasZ?o.hasZ:q.hasZ,C=q.geometryType,$=o.objectIdField||q.objectIdFieldName||"OBJECTID";let G=o.timeInfo;const R=P.find(({name:e})=>e===$);if(R)R.editable=!1,R.nullable=!1;else{if(!q.objectIdFieldType)throw new t("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");P.unshift({name:$,alias:$,type:"number"===q.objectIdFieldType?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if($!==q.objectIdFieldName){const e=P.find(({name:e})=>e===q.objectIdFieldName);e&&(e.type="esriFieldTypeInteger")}P===q.fields&&q.unknownFields.length>0&&F().warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:q.unknownFields}});for(const e of P){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new t("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(!j.jsonValues.includes(e.type))throw new t("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(G){const e=new b(P);if(G.startTimeField){const t=e.get(G.startTimeField);t?(G.startTimeField=t.name,t.type="esriFieldTypeDate"):G.startTimeField=null}if(G.endTimeField){const t=e.get(G.endTimeField);t?(G.endTimeField=t.name,t.type="esriFieldTypeDate"):G.endTimeField=null}if(G.trackIdField){const t=e.get(G.trackIdField);t?G.trackIdField=t.name:(G.trackIdField=null,F().warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:G}}))}G.timeReference||={timeZoneIANA:h},G.startTimeField||G.endTimeField||(F().warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:G}}),G=void 0)}const D=C?y(C):null,M=function(e){const t=e.extent?.spatial;if(!t)return null;const n=t.bbox[0],i=4===n.length,[a,r]=n,o=i?void 0:n[2];return{xmin:a,ymin:r,xmax:i?n[2]:n[3],ymax:i?n[3]:n[4],zmin:o,zmax:i?void 0:n[5],spatialReference:s.WGS84.toJSON()}}(n);return{drawingInfo:D,extent:M,geometryType:C,fields:P,hasZ:!!N,objectIdField:$,paginationParameter:O,timeInfo:G}}async function v(n,a={}){const{links:r,url:s}=n,o=W(r,"data","application/json")||W(r,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(null==o)throw new t("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:l,customParameters:c,signal:u}=a,d=i(o.href,s),{data:f}=await e(d,{signal:u,headers:{accept:"application/json"},query:{...c,token:l}});for(const e of f.collections)e.landingPage=n;return f}async function O(n,a={}){const{links:r,url:s}=n,o=W(r,"conformance","application/json")||W(r,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(null==o)throw new t("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:l,customParameters:c,signal:u}=a,d=i(o.href,s),{data:f}=await e(d,{signal:u,headers:{accept:"application/json"},query:{...c,token:l}});return f}async function q(t,n={}){const{apiKey:i,customParameters:a,signal:r}=n,{data:s}=await e(t,{signal:r,headers:{accept:"application/json"},query:{...a,token:i}});return s.url=t,s}async function P(t,n={}){const{links:a,url:r}=t,s=W(a,"service-desc","application/vnd.oai.openapi+json;version=3.0");if(null==s)return F().warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:l,signal:c}=n,u=i(s.href,r),{data:d}=await e(u,{signal:c,headers:{accept:"application/vnd.oai.openapi+json;version=3.0"},query:{...l,token:o}});return d}function N(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),n=t?.groups;if(!n)return null;const{authority:i,code:a}=n;switch(i.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return s.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return s.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(a,10);return Number.isNaN(e)?null:e}default:return null}}async function C(e,t,n){const i=await $(e,t,n);return c(i)}async function $(n,a,r){const{collection:{links:c,landingPage:{url:m}},layerDefinition:p,maxRecordCount:y,queryParameters:{apiKey:j,customParameters:h},spatialReference:F,supportedCrs:I}=n,T=W(c,"items","application/geo+json")||W(c,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==T)throw new t("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:k,num:x,start:S,timeExtent:v,where:O}=a;if(a.objectIds)throw new t("ogc-feature-layer:query-by-objectids-not-supported","Queries with object ids are not supported");const q=s.fromJSON(F),P=a.outSpatialReference??q,N=P.isWGS84?null:G(P,I),C=function(e,t){if(!function(e){return null!=e&&"extent"===e.type}(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:R(e)};const i=G(n,t);return null!=i?{bbox:R(e),"bbox-crs":i}:n.isWebMercator?{bbox:R(l(e,s.WGS84))}:null}(k,I),$=function(e){if(null==e)return null;const{start:t,end:n}=e;return`${null!=t?t.toISOString():".."}/${null!=n?n.toISOString():".."}`}(v),D=function(e){return null!=e&&e&&"1=1"!==e?e:null}(O),M=x??(null==S?y:10),Z=0===S?void 0:S,{fields:L,geometryType:K,hasZ:U,objectIdField:A,paginationParameter:J}=p,z=i(T.href,m),{data:E}=await e(z,{...r,query:{...h,...C,crs:N,datetime:$,query:D,limit:M,[J]:Z,token:j},headers:{accept:"application/geo+json"}}),_=g(E,{geometryType:K,hasZ:U,objectIdField:A}),B=_.length===M&&!!W(E.links??[],"next","application/geo+json"),Q=new b(L);for(const e of _){const t={};w(Q,t,e.attributes,!0);for(const e of Q.fields)e.nullable&&!(e.name in t)&&(t[e.name]=null);t[A]=e.attributes[A],e.attributes=t}if(!N&&P.isWebMercator)for(const e of _)if(null!=e.geometry&&null!=K){const t=u(e.geometry,K,U,!1);t.spatialReference=s.WGS84,e.geometry=d(l(t,P))}for(const e of _)e.objectId=e.attributes[A];const V=N||!N&&P.isWebMercator?P.toJSON():o,H=new f;return H.exceededTransferLimit=B,H.features=_,H.fields=L,H.geometryType=K,H.hasZ=U,H.spatialReference=V,H}function G(e,t){const{isWebMercator:n,wkid:i}=e;if(!i)return null;const a=n?t[3857]??t[102100]??t[102113]??t[900913]:t[e.wkid];return a?`${k}${a}`:null}function R(e){if(null==e)return"";const{xmin:t,ymin:n,xmax:i,ymax:a}=e;return`${t},${n},${i},${a}`}function W(e,t,n){return e.find(({rel:e,type:i})=>e===t&&i===n)??e.find(({rel:e,type:n})=>e===t&&!n)}export{q as a,O as b,x as c,v as d,P as e,S as f,N as g,k as h,$ as i,C as q};
