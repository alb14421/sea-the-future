/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../core/Error.js";import{J as e}from"./jsonMap.js";import{n as i,k as a,j as r,w as n,p as s}from"./unitUtils.js";import{canProjectWithoutEngine as o}from"./projectionUtils.js";import{a as l}from"./extentUtils.js";import{fromJSON as m,isPolygon as u,isExtent as c,isPolyline as p}from"../geometry/support/jsonUtils.js";import{normalizeCentralMeridian as f}from"../geometry/support/normalizeUtils.js";import{c as y,p as d}from"./projectionSupport.js";const S=new e({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),g=Object.freeze({});async function R(t,e,i){const a=t.bin;return a.onField&&(a.onField=a.onField.trim()),a.onExpression?.value&&(a.onExpression.value=a.onExpression.value.trim()),a.splitBy&&(a.splitBy.value&&(a.splitBy.value=a.splitBy.value.trim()),a.splitBy.outAlias&&(a.splitBy.outAlias=a.splitBy.outAlias.trim())),a.stackBy&&(a.stackBy.value&&(a.stackBy.value=a.stackBy.value.trim()),a.stackBy.outAlias&&(a.stackBy.outAlias=a.stackBy.outAlias.trim())),"normalizationField"in a.parameters&&a.parameters.normalizationField&&(a.parameters.normalizationField=a.parameters.normalizationField.trim()),t.outStatistics?.length||(t.outStatistics=[{statisticType:"count",onStatisticField:"1",outStatisticFieldName:"frequency"}]),w(t,e,i)}async function w(t,e,i){const{outFields:a,orderByFields:r,groupByFieldsForStatistics:n,outStatistics:s}=t;if(a)for(let t=0;t<a.length;t++)a[t]=a[t].trim();if(r)for(let t=0;t<r.length;t++)r[t]=r[t].trim();if(n)for(let t=0;t<n.length;t++)n[t]=n[t].trim();if(s)for(let t=0;t<s.length;t++)s[t].onStatisticField&&(s[t].onStatisticField=s[t].onStatisticField.trim());return t.geometry&&!t.outSR&&(t.outSR=t.geometry.spatialReference),x(t,e,i)}async function x(e,s,o){if(!e)return null;let{where:p}=e;if(e.where=p=p?.trim(),(!p||/^1 *= *1$/.test(p)||s&&s===p)&&(e.where=null),!e.geometry)return e;let R=await async function(e){const{distance:s,units:o}=e,l=e.geometry;if(null==s||"vertexAttributes"in l)return l;const m=l.spatialReference,c=o?S.fromJSON(o):i(m),p=m&&(a(m)||r(m))?l:await y(m,n).then(()=>d(l,n)),f=await import("./geodesicBufferOperator.js");await f.load();const g=f.execute(p,s||1,{unit:c})??void 0;if(!g||!u(g)||0===g.rings.length)throw new t("unsupported-query:invalid-parameters","Invalid parameters for query by distance");return g}(e);if(e.distance=0,e.units=null,"esriSpatialRelEnvelopeIntersects"===e.spatialRel){const{spatialReference:t}=e.geometry;R=l(R),R.spatialReference=t}if(R){await y(R.spatialReference,o),R=function(t,e){const i=t.spatialReference;return B(t,e)&&c(t)?{spatialReference:i,rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]}:t}(R,o);const t=(await f(m(R)))[0];if(null==t)throw g;const i="quantizationParameters"in e&&e.quantizationParameters?.tolerance||"maxAllowableOffset"in e&&e.maxAllowableOffset||0,a=i&&B(R,o)?{densificationStep:8*i}:void 0,r=t.toJSON(),n=d(r,r.spatialReference,o,a);if(!n)throw g;n.spatialReference=o,e.geometry=n}return e}function B(t,e){if(!t)return!1;const i=t.spatialReference;return(c(t)||u(t)||p(t))&&!s(i,e)&&!o(i,e)}function F(t,e){return null==t?null:"string"==typeof t?e?new Date(`1970-01-01T${t}Z`).getTime():new Date(t).getTime():t instanceof Date?t.getTime():t}export{R as a,w as b,F as g,x as n,g as q,S as u};
