/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../core/Handles.js";import{m as a,h as e}from"./handleUtils.js";import{h as i}from"../core/lang.js";import{watch as s,initial as n,when as r}from"../core/reactiveUtils.js";import{M as o,R as l,b as u}from"./RenderObject.js";import c from"../Color.js";import{EventEmitter as h}from"../core/Evented.js";import{d as p,r as d}from"./maybe.js";import{l as _,B as m,m as M,a as f,x as g,v,r as w}from"./mat4.js";import{c as y}from"./mat4f64.js";import{k as x,z as b,h as E,n as S,d as D,c as A,i as T}from"./vec3.js";import{f as j,c as P}from"./vec3f64.js";import{s as I,e as O}from"./vector.js";import{a as z,b as U}from"./dragEventPipeline3D.js";import{d as L,r as R,c as C,b as F,e as H,f as q,E as X}from"./dragEventPipeline.js";import{o as Y,t as B,h as k,p as G,i as V}from"./graphicUtils.js";import{C as W}from"./ColorMaterial.js";import{b as Z}from"./elevationInfoUtils.js";import{l as J}from"./colorUtils2.js";import{c as K}from"./mathUtils.js";import{S as N}from"./settings2.js";class Q{constructor(){this._available=!0}set location(t){this._forEachManipulator3D(a=>a.location=t)}set elevationAlignedLocation(t){this._forEachManipulator3D(a=>a.elevationAlignedLocation=t)}set elevationInfo(t){this._forEachManipulator3D(a=>a.elevationInfo=t)}get renderLocation(){let t;return this._forEachManipulator3D(a=>{t||(t=a.renderLocation)}),t}set renderLocation(t){this._forEachManipulator3D(a=>a.renderLocation=t)}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D(a=>a.available=t)}get hovering(){return this.someManipulator(t=>t.hovering)}get grabbing(){return this.someManipulator(t=>t.grabbing)}get dragging(){return this.someManipulator(t=>t.dragging)}get selected(){return this.someManipulator(t=>t.selected)}hasManipulator(t){return this.someManipulator(a=>a===t)}someManipulator(t){let a=!1;return this.forEachManipulator(e=>{!a&&t(e)&&(a=!0)}),a}_forEachManipulator3D(t){this.forEachManipulator((a,e)=>{a instanceof o&&t(a,e)})}}class $ extends Q{constructor(){super(...arguments),this._interactive=!0}get interactive(){return this._interactive}set interactive(t){this._interactive!==t&&(this._interactive=t),this._updateManipulatorInteractivity()}_updateManipulatorInteractivity(){const t=!this.grabbing&&this._interactive;this.forEachManipulator(a=>{a.interactive=t||a.grabbing})}}const tt=128,at=70,et=Math.ceil(at/3*2),it=160,st=.5,nt=24,rt=9,ot=190,lt=213,ut=60,ct=23,ht=5*Math.PI/12,pt=1*Math.PI/3,dt=10,_t=.2,mt=30,Mt=53,ft=.2,gt=.3,vt=200,wt=3,yt=1e6;function xt(t,a,e){const i=(e,i)=>{a({action:e,object:t,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY})};return e((a,e,s)=>(e.next(t=>("start"===t.action&&i("start",t),t)).next(L(t)).next(t=>{switch(t.action){case"start":case"update":(t.translationX||t.translationY||t.translationZ)&&i("update",t);break;case"end":i("end",t)}return t}),{steps:e,cancel:s=s.next(R(t)).next(t=>(i("end",{screenDeltaX:0,screenDeltaY:0}),t))}))}function bt(t){if(null==t?.axis)return 1;const{mapStart:a,mapEnd:e,axis:i}=t,s=[e.x-a.x,e.y-a.y];return s[0]*i[0]+s[1]*i[1]>0?1:-1}class Et extends Q{constructor(a){super(),this._handles=new t,this._arrowManipulatorInfos=new Array,this._angle=0,this._scale=1,this._radius=at,this._updateAfterDrag=!1,this.events=new h,this._tool=a.tool,this._view=a.view,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),null!=a.radius&&(this._radius=a.radius),this._createManipulators(),this.forEachManipulator(t=>this._tool.manipulators.add(t))}set orthogonalAvailable(t){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t)}destroy(){this._handles=p(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:a}of this._arrowManipulatorInfos)t(a,1)}createManipulatedObjectDragPipeline(t,e,i){if(!e.operations)return a();const s=e.operations.data.spatialReference,n=e.graphic;return xt(e,i,a=>this.createDragPipeline((e,i,s,n,r)=>(({steps:i,cancel:s}=t(e,i,s,n,r)),a(e,i,s)),e.elevationInfo,s,n))}createDragPipeline(t,a,i,s){return e(this._arrowManipulatorInfos.map(({manipulator:e},n)=>C(e,(e,r,o,l,u)=>{const c=r.next(t=>({...t,manipulatorType:1})).next(F(this._view,e.elevationAlignedLocation)).next(z(this._view,e.elevationAlignedLocation,a,i,s)).next(H(e.location,this.angle+(n+1)*Math.PI*.5)).next(q());t(e,c,o,l,u)})))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:a},e){const i=this._radius/at,s=54*i,n=s*Math.sqrt(3)/2,r=Y(this._opaqueMaterial,n,s/2,s/2,.02);B(r,_(O.get(),x(I.get(),0,-n/3,0))),t.renderObjects=[new l(r,2),new l(r.instantiate({material:this._transparentMaterial}),1)],t.radius=n/3*2*1.2;const o=m(O.get(),e*Math.PI/2),u=_(O.get(),x(I.get(),0,100*i,0));M(a,o,u)}_createManipulators(){for(let t=0;t<4;t++){const a=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(a)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,a=f(O.get(),t,j(0,0,1));if(null==a)return;const e=g(O.get(),x(I.get(),this.displayScale,this.displayScale,this.displayScale)),i=M(O.get(),e,a);for(const t of this._arrowManipulatorInfos){const a=M(O.get(),i,t.transform);t.manipulator.modelTransform=a}}_createArrowManipulator(t){const a=new o({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:j(0,0,1)}}),e={manipulator:a,transform:y()};return this._updateArrowManipulator(e,t),this._handles.add(a.events.on("drag",t=>{this._updateAfterDrag&&"end"===t.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),e}_createMaterial(t=1){const a=new W({cullFace:2,renderOccluded:2,isDecoration:!0});return this._handles.add(s(()=>c.toUnitRGBA(this._view.effectiveTheme.accentColor),e=>{e[3]*=t,a.setParameters({color:e})},n)),a}get test(){}}class St{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&null!=this._lastDragEvent&&null!=this._next){const a=this._lastDragEvent.mapEnd,e=this._snap(this._lastDragEvent.screenEnd);if(null!=e){const i={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:!0===t?e:a,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(i)}}this._enabled=t}_snap(t){const a=null!=this._view?this._view.toMap(t,{exclude:[]}):null;return null!=a&&null!=this._view&&(a.z=Z(a,this._view,this._elevationInfo)),a}createDragEventPipelineStep(t,a){this._view=t,this._elevationInfo=a,this._lastDragEvent=null;const e=new X;return this._next=e,[t=>{if(this._lastDragEvent="end"!==t.action?{...t}:null,this._enabled){const a=this._snap(t.screenEnd);return null!=a?{action:t.action,mapStart:t.mapStart,mapEnd:a,screenStart:t.screenStart,screenEnd:t.screenEnd}:null}return{action:t.action,mapStart:t.mapStart,mapEnd:t.mapEnd,screenStart:t.screenStart,screenEnd:t.screenEnd}},e]}}class Dt extends Q{constructor(a){super(),this._handles=new t,this._snapToScene=new St,this._scale=1,this._radius=at,this._view=a.view,this._tool=a.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),null!=a.snapToScene&&(this.snapToScene=a.snapToScene),null!=a.radius&&(this._radius=a.radius),this._createManipulator(),this.forEachManipulator(t=>this._tool.manipulators.add(t))}destroy(){this._handles=p(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,1)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}get discManipulator(){return this._manipulator}createManipulatedObjectDragPipeline(t,e,i){if(!e.operations)return a();const s=e.graphic,n=e.elevationInfo,r=e.operations.data.spatialReference;return xt(e,i,a=>this.createDragPipeline((e,i,s,n,r)=>(({steps:i,cancel:s}=t(e,i,s,n,r)),a(e,i,s)),n,r,s))}createDragPipeline(t,a,e,i){const s=this._view;return C(this._manipulator,(n,r,o,l,u)=>{const c=r.next(F(s,n.elevationAlignedLocation)).next(z(s,n.elevationAlignedLocation,a,e,i)).next(...this._snapToScene.createDragEventPipelineStep(s,a)).next(t=>({...t,manipulatorType:1})).next(q());t(n,c,o,l,u)})}_updateManipulatorTransform(){const t=g(O.get(),x(I.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new o({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:j(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=k(this._discMaterial,.02,1,128,j(0,0,1),j(0,0,0));t.transformation=g(y(),j(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new l(t,2),new l(t.instantiate({material:this._discMaterialTransparent}),1)],this._manipulator.radius=this._radius/at*80}_createMaterial(t=1){const a=new W({cullFace:2,renderOccluded:2,isDecoration:!0});return this._handles.add(s(()=>c.toUnitRGBA(this._view.effectiveTheme.accentColor),e=>{e[3]*=t,a.setParameters({color:e})},n)),a}get test(){}}class At extends Q{constructor(t){super(),this._radius=at,this.events=new h,this._tool=t.tool,this._view=t.view;const a=new N({getTheme:()=>this._view.effectiveTheme});this._settings=a,null!=t.radius&&(this._radius=t.radius);const e=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:u(Tt(e,1,.25),1),materialFocused:u(Tt(e,1,0),1),materialOccludedUnfocused:u(Tt(e,.7,0),a.zManipulator.renderOccluded),materialOccludedFocused:u(Tt(e,.85,0),a.zManipulator.renderOccluded)},this._themeHandle=s(()=>this._view.effectiveTheme.accentColor,t=>{const a=Tt(t,1,.25),e=Tt(t,1,0),i=Tt(t,.7,0),s=Tt(t,.85,0),{materialUnfocused:n,materialFocused:r,materialOccludedUnfocused:o,materialOccludedFocused:l}=this._materials;n.setParameters({color:a}),r.setParameters({color:e}),o.setParameters({color:i}),l.setParameters({color:s})}),this._createManipulator(),this.forEachManipulator(t=>this._tool.manipulators.add(t))}destroy(){this._themeHandle=d(this._themeHandle),this._manipulator.applyObjectTransform=Ot,this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){t(this._manipulator,0)}createManipulatedObjectDragPipeline(t,e,i){if(!e.operations)return a();const s=e.operations.data.spatialReference;return xt(e,i,a=>this.createDragPipeline((e,i,s,n,r)=>(({steps:i,cancel:s}=t(e,i,s,n,r)),a(e,i,s)),s))}createDragPipeline(t,a){const e=this._view;return C(this._manipulator,(i,s,n,r,o)=>{const l=s.next(t=>({...t,manipulatorType:0})).next(U(e,i.renderLocation,a)).next(q());t(i,l,n,r,o)})}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._settings,a=this._radius/at,e=t.zManipulator.height*a,i=t.zManipulator.coneHeight*a,s=t.zManipulator.coneWidth*a,n=t.zManipulator.width*a,r=[j(0,0,0),j(0,0,e)],o=[j(0,0,0),j(0,0,e+i)],u=(()=>{const t=y();return v(t,t,[0,0,e]),w(t,t,Math.PI/2),t})(),{materialUnfocused:c,materialFocused:h,materialOccludedUnfocused:p,materialOccludedFocused:d}=this._materials,_=G(c,r,n/2,16,!1),m=V(c,i,s/2,16,!1);m.transformation=u,this._manipulator.renderObjects=[new l(m,1),new l(_,1),new l(m.instantiate({material:h}),2),new l(_.instantiate({material:h}),2),new l(m.instantiate({material:p}),1),new l(_.instantiate({material:p}),1),new l(m.instantiate({material:d}),2),new l(_.instantiate({material:d}),2)],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[o]}}_createManipulator(){const t=this._view,a=new o({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});a.applyObjectTransform=a=>{const e=t.state.camera,i=jt;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const s=b(e.eye,i),n=e.computeRenderPixelSizeAtDist(s),r=E(Pt,i,e.eye);S(r,r);const o=It;t.renderCoordsHelper.worldUpAtPosition(jt,o);const l=Math.abs(D(r,o)),u=A(Pt,r,o),c=A(Pt,u,o),h=K(l,.01,1),p=1-Math.sqrt(1-h*h)/h/e.fullWidth,d=this._settings,_=this._radius/at,m=d.zManipulator.width*_;T(c,S(c,c),(1/p-1)*s+n*m),a[12]-=Pt[0],a[13]-=Pt[1],a[14]-=Pt[2]},this._manipulator=a,this._updateManipulator()}get test(){}}function Tt(t,a,e){const i=J(t,e);return i.a*=a,c.toUnitRGBA(i)}const jt=P(),Pt=P(),It=P(),Ot=()=>{};class zt extends ${constructor(a){super(),this._handles=new t;const{tool:e,view:i,snapToScene:s,radius:n}=a;this._view=i,this.xyManipulation=new Dt({tool:e,view:i,snapToScene:s,radius:n}),this.xyAxisManipulation=new Et({tool:e,view:i,radius:n}),this.zManipulation=new At({tool:e,view:i,radius:n}),this.xyManipulation.available=a.xyAvailable,this.xyAxisManipulation.available=a.xyAxisAvailable,this.zManipulation.available=a.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(t=>this._handles.add(t.events.on("grab-changed",()=>this._updateManipulatorInteractivity())))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createManipulatedObjectDragPipeline(t,a,i){return e([this.xyManipulation.createManipulatedObjectDragPipeline((a,e,i,s,n)=>t(0,a,e,i,s,n),a,i),this.xyAxisManipulation.createManipulatedObjectDragPipeline((a,e,i,s,n)=>t(1,a,e,i,s,n),a,i),this.zManipulation.createManipulatedObjectDragPipeline((a,e,i,s,n)=>t(2,a,e,i,s,n),a,i)])}createDragPipeline(t,a,i,s){return e([this.xyManipulation.createDragPipeline((a,e,i,s,n)=>t(0,a,e,i,s,n),a,i,s),this.xyAxisManipulation.createDragPipeline((a,e,i,s,n)=>t(1,a,e,i,s,n),a,i,s),this.zManipulation.createDragPipeline((a,e,i,s,n)=>t(2,a,e,i,s,n),i)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator(a=>t(a,1)),this.xyAxisManipulation.forEachManipulator(a=>t(a,1)),this.zManipulation.forEachManipulator(a=>t(a,0))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator(t=>t.focused)||this.xyAxisManipulation.someManipulator(t=>t.focused);return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,a=this.xyManipulation;if(i("esri-mobile"))return;const e=[];a.forEachManipulator(t=>e.push(t)),t.forEachManipulator(t=>e.push(t));const s=()=>{const a=[];this._xyAxisVisible||t.forEachManipulator(t=>a.push(t.disableDisplay())),this._handles.remove(Ut),this._handles.add(a,Ut)};for(const t of e)this._handles.add(t.events.on("focus-changed",s));this._view.inputManager&&this._handles.add(r(()=>this._view.inputManager?.latestPointerType,s)),s()}static radiusForSymbol(t){const a=null!=t&&"point-3d"===t.type&&t.symbolLayers;return a&&a.some(t=>"icon"===t.type)?et:at}}const Ut="disable-xy-axis-display";export{$ as I,zt as M,at as a,Q as b,xt as c,et as d,bt as e,gt as f,_t as g,st as h,ct as i,ut as j,nt as k,it as l,ot as m,mt as n,lt as o,Mt as p,rt as q,vt as r,ft as s,dt as t,tt as u,ht as v,pt as w,wt as x,yt as y};
