/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../core/Error.js";import{a as e}from"./MultiOriginJSONSupport.js";import{whenOnce as o}from"../core/reactiveUtils.js";import{urlToObject as r,hasSameCanonicalPortal as i}from"../core/urlUtils.js";import{u as a}from"./originUtils.js";import s from"../geometry/SpatialReference.js";import{p as n}from"./unitUtils.js";import{webMercatorToGeographic as p}from"../geometry/support/webMercatorUtils.js";import{e as l}from"../request.js";import{u as m,n as c}from"./layerUtils.js";import u from"../portal/Portal.js";import j from"../portal/PortalItem.js";import{c as d}from"./jsonContext.js";import{r as f,t as y,a as w,h as g,b as h}from"./portalItemUtils.js";import{p as b}from"./project.js";import P from"../rest/support/ProjectParameters.js";import{h as U,i as _,f as R}from"./basemapUtils.js";import{s as S}from"./resourceUtils2.js";import{b as v,e as T,h as O}from"./saveUtils.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"./MapUtils.js";import"./Warning.js";import"./get.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./events.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"../core/JSONSupport.js";import"./jsonUtils.js";import"./multiOriginJSONSupportUtils.js";import"./writer.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"../kernel.js";import"./persistableUrlUtils.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../layers/catalog/catalogUtils.js";import"../core/Loadable.js";import"../core/Promise.js";import"./reader.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"./locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"./projectionUtils.js";import"./vec3f64.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"../geometry/Polyline.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"../geometry/support/jsonUtils.js";import"./utils9.js";import"./utils10.js";import"./utils5.js";import"./colorUtils.js";import"./screenUtils.js";import"./mat4.js";import"./common.js";import"./basemapDefinitions.js";import"./messages.js";import"./uuid.js";import"./resourceUtils.js";const W=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map(t=>t.toLowerCase());async function A(e,r,i){i??={},function(e,o){if(!o.portalItem)throw new t(`${e.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");M(e,o.portalItem)}(e,r),await o(()=>!r.updatingFromView),await r.load(),await E(r),await v(r),await k(e,r);const a=r.portalItem,{json:s,jsonContext:n}=await I(r,a,e.origin);return T(n,{errorName:`${e.name}:save`},i),await G(r,a),await async function(t,e,o,r,i){await o.update({data:r}),et(t,e,o,r,i)}(e,r,a,s,n),await Promise.all([r.updateItemThumbnail(),S(r.resourceReferences,n)]),a}async function I(t,e,o){const r=d(e,o,!0),i=t.write({},r);return await Promise.all(r.resources.pendingOperations),{json:i,jsonContext:r}}async function C(e,r,i,a){a??={};const s=function(t,e){let o=j.from(e);return o.id&&(o=o.clone(),o.id=null),o.type||(o.type=t.itemType),o.portal||(o.portal=u.getDefault()),M(t,o),o}(e,i);await o(()=>!r.updatingFromView),await r.load(),await E(r),await v(r),await k(e,r);const{json:n,jsonContext:p}=await I(r,s,e.origin);T(p,{errorName:`${e.name}:save`},a),await async function(t,e){f(e,D),f(e,K),f(e,y.METADATA),f(e,B),f(e,J),f(e,H),f(e,$),f(e,F),await G(t,e)}(r,s);const l=r.getThumbnailState(),m=await async function(e,o,r,i,a,s){const n=o.portalItem,p={item:n,authenticated:!(!n?.id||!n.portal.user)},l=r.portal;await l.signIn();const{copyAllowed:m,itemReloaded:c}=await Z(p,l);if(p.authenticated||=c,!m)throw new t(`${e.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const u=await tt(r,p,i,s);return o.portalItem=r,et(e,o,r,i,a),u}(e,r,s,n,p,a);return m&&(r.resourceReferences.portalItem=s),r.restoreThumbnailFromState(l),await Promise.all([r.updateItemThumbnail(),S(r.resourceReferences,p)]),s}function M(e,o){if(o.type!==e.itemType)throw new t(`${e.name}:portal-item-wrong-type`,`Portal item needs to have type "${e.itemType}"`)}async function k(e,r){if("linkchart"===e.name)return;if(!r.basemap?.baseLayers.length)throw new t(`${e.name}:save`,"Map does not have a valid basemap with a base layer.");let i=null;if(await o(()=>{const t=R(r.initialViewProperties,r.basemap);return i=t.spatialReference,!t.updating}),!n(i,r.initialViewProperties.spatialReference))throw new t(`${e.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:r.initialViewProperties.spatialReference,actual:i})}function E(t){const e=[];return t.basemap&&e.push(t.basemap.load()),t.ground&&e.push(t.ground.load()),Promise.allSettled(e).then(()=>{})}async function G(t,e){e.extent=await async function(t,e){const o=e.clone().normalize();let r;if(o.length>1)for(const t of o)r?t.width>r.width&&(r=t):r=t;else r=o[0];return async function(t,e){const o=e.spatialReference;if(o.isWGS84)return e.clone();if(o.isWebMercator)return p(e);const{getGeometryServiceURL:r}=await import("./geometryServiceUtils.js"),i=await r(t),a=new P({geometries:[e],outSpatialReference:s.WGS84});return(await b(i,a))[0]}(t,r)}(t.portalItem,t.initialViewProperties.viewpoint.targetGeometry),await async function(t,e){w(e,x),await function(t){const e=X(t).map(t=>t.load()).toArray();return Promise.allSettled(e).then(()=>{})}(t),function(t,e){g(e,D)||g(e,$)||g(e,F)||g(e,H)||!Y(t)?f(e,V):w(e,V)}(t,e),function(t,e){Y(t)?w(e,L):f(e,L)}(t,e),function(t,e){!g(e,B)&&function(t){return X(t).filter(t=>"group"!==t.type).every(e=>e.loaded&&function(t,e){return m(e)&&e.capabilities.operations.supportsSync||function(t){return c(t)||"map-notes"===t.type||"route"===t.type}(e)&&!e.portalItem||function(t){return("tile"===t.type||"vector-tile"===t.type)&&(t.capabilities.operations.supportsExportTiles||function(t){return"tile"===t.type&&l(t.url)&&W.some(e=>t.url?.toLowerCase().includes("/"+e+"/"))}(t)||_(t))}(e)&&!function(t){return"vector-tile"===t.type&&Object.keys(t.sourceNameToSource).length>1}(e)&&e.spatialReference.equals(t.initialViewProperties.spatialReference)}(t,e))}(t)?w(e,N):f(e,N)}(t,e),function(t,e){U(t.basemap)?w(e,z):f(e,z)}(t,e),function(t,e){t.utilityNetworks?.length?w(e,q):f(e,q)}(t,e),function(t,e){t.ipsInfo?w(e,Q):f(e,Q)}(t,e),function(t,e){h(e,y.CHARTS,O(t))}(t,e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((t,e,o)=>o.indexOf(t)===e))}(t,e)}const x=y.JSAPI,D="CollectorDisabled",V="Collector",L="Data Editing",B="OfflineDisabled",N="Offline",$="Workforce Project",F="Workforce Worker",H="Workforce Dispatcher",J="Offline Map Areas",K="FieldMapsDisabled",z=y.DEVELOPER_BASEMAP,q="UtilityNetwork",Q="IPS";function X(t){return t.allLayers.concat(t.allTables)}function Y(t){return X(t).some(t=>t.loaded&&m(t)&&t.capabilities.operations.supportsEditing&&t.editingEnabled&&("subtype-group"!==t.type||t.sublayers.some(t=>t.editingEnabled)))}async function Z(t,e){const{item:o,authenticated:r}=t;return o?.id&&o.typeKeywords?.includes("useOnly")?o.portal.portalHostname!==e.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(r||await o.reload(),{copyAllowed:"admin"===o.itemControl||"update"===o.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function tt(t,e,o,r){const a=t.portal,{item:s}=e,{folder:n,copyAllResources:p}=r;let l=!1;if(p&&s?.id&&i(s.portal.url,a.url)&&parseInt(s.portal.currentVersion,10)>=2023){const{total:t}=await s.fetchResources();l=!!t}if(l){const e=await s.copy({copyResources:"all",folder:n});t.id=e.id,t.portal=e.portal;const r=t.toJSON();await t.load(),t.read(r),await t.update({data:o})}else await a.user.addItem({item:t,folder:n,data:o});return l}function et(t,o,i,s,n){e.prototype.read.call(o,{version:s.version,authoringApp:s.authoringApp,authoringAppVersion:s.authoringAppVersion},{origin:t.origin,ignoreDefaults:!0,url:i.itemUrl?r(i.itemUrl):void 0}),a(n),o.resourceInfo=s}export{I as createJSON,tt as initializeNewItem,Z as isCopyAllowed,A as save,C as saveAs};
