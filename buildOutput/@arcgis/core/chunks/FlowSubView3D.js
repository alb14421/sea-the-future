/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{e as t,R as r}from"../core/lang.js";import{d as s,f as i,a as n}from"./maybe.js";import{debounce as o,throwIfAborted as a,ignoreAbortErrors as l}from"../core/promiseUtils.js";import{watch as u,when as h,sync as d}from"../core/reactiveUtils.js";import{property as c}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as p}from"../core/accessorSupport/decorators/subclass.js";import{projectOrLoad as f}from"./projectionUtils.js";import{d as m,t as g,l as _}from"./aaBoundingRect.js";import y from"../symbols/support/ElevationInfo.js";import{g as w,s as v}from"./utils31.js";import{S as b}from"./SubView3D.js";import{m as S}from"./makeScheduleFunction.js";import{W as T}from"./WorkerHandle.js";import j from"../Color.js";import{f as R}from"./vec3f64.js";import{n as x,l as L,c as k}from"./line.js";import{z as D}from"./elevationInfoUtils.js";import{d as E,R as M}from"./RenderGeometry.js";import{b as U}from"./loadUtils2.js";import{W as G,O as C,R as B}from"./RibbonLineMaterial.js";import{t as P}from"../views/SceneView.js";import{T as z}from"./Scheduler.js";class I extends T{constructor(e){super("FlowWorker","generateStreamlines",{generateStreamlines:e=>[e.flowData.data.buffer,e.flowData.mask.buffer],generateTiledStreamlines:e=>{const t=[];return e.flowDataTiles.forEach(e=>{"string"!=typeof e&&t.push(e.data.buffer,e.mask.buffer)}),t}},e,{strategy:"dedicated"})}generateStreamlines(e,t){return this.invokeMethod("generateStreamlines",e,t)}generateTiledStreamlines(e,t){return this.invokeMethod("generateTiledStreamlines",e,t)}}function W(e,t,r,s,i,n,o){const{spatialReference:a}=t.extent,l=[];for(let i=0;i<r.length;i+=3){const o=[r[i],r[i+1]],[u,h]=A(o,t),d=n?[u,h,E]:F(u,h,a,e,s);l.push(d)}const u=Math.floor(r.length/3),h=x(u);for(let e=0;e<u;e++)h[e]=r[3*e+2];!function(e,t){if(0===e.length||t<0||t>=e.length)return;const r=e[t];for(let t=0;t<e.length;t++)e[t]-=r}(h,Math.floor(o.getIntRange(0,h.length)));const d=L([l],void 0,[h]);return k(i,d[0])}function H(e,t,r){if(null==e)return{};const s=j.toUnitRGBA(e.color);return s[3]*=t,{color:s,width:e.trailWidth,cap:2,animationSpeed:e.flowSpeed,trailLength:e.trailLength,animation:3,emissiveStrength:r}}function A([e,t],r){const{extent:s,size:[i,n]}=r;return[e/i*s.width+s.xmin,(n-t)/n*s.height+s.ymin]}function F(e,t,r,s,i){const{absoluteZ:n}=D(e,t,0,r,s,i),o=R(e,t,n);return s.renderCoordsHelper.toRenderCoords(o,r,o),o}class V{constructor(e,t){this.streamlines=e,this.geometries=t}setMaterialParameters(e){this.attached&&this.geometries.forEach(t=>t.material.setParameters(e))}}class O extends V{constructor(e,t,r){super(e,t),this._overlayManager=r,this._drapeRenderer=null,this.drapeSourceType=2,this.updatePolicy=0,this.renderGroup=0}get attached(){return null!=this._drapeRenderer}get destroyed(){return this.attached}attach(){const{geometries:e}=this;null!=e&&(this.detach(),this._drapeRenderer=this._overlayManager.registerGeometryDrapeSource(this),this._drapeRenderer.addGeometries(e.map(e=>new M(e)),0))}detach(){this.attached&&(this._overlayManager.unregisterDrapeSource(this),this._drapeRenderer=s(this._drapeRenderer))}}class q extends V{constructor(e,t,r){super(e,t),this._stage=r,this._object3D=null,this._engineLayer=null}get attached(){return null!=this._object3D&&null!=this._engineLayer}attach(){const{geometries:e}=this;if(null==e)return;this.detach();const t=new G(this._stage,{pickable:!1,updatePolicy:1}),r=new C({geometries:e});r.visible=!0,t.add(r),this._object3D=r,this._engineLayer=t}detach(){this.attached&&(this._engineLayer=s(this._engineLayer),this._object3D=i(this._object3D))}}class N{constructor(e,t,r,s){this.extent=e,this.timeExtent=t,this.size=r,this.pixelRatio=s}}let Z=class extends b{constructor(e){super(e),this.type="flow",this.renderedTiles=null,this._abortController=null,this._frameTask=null,this.workerHandle=null,this.emissiveStrength=0,this._overrideSimulationSettings=null,this._debouncedLoad=o(async e=>{const{view:t}=this;if(!this._visible)return void this.clear();if(0===e.size)return;const r=this._computeExtent(e);if(null==r)return;const s=new N(r,this.layer.timeExtent,this._viewSizeWithEqualRatio(r),t.state.contentPixelRatio);null==this._abortController&&(this._abortController=new AbortController);const i=this._abortController,n=await this._load(s,i.signal);a(i.signal),this.clear(),this._visible&&null!=n&&(n.attach(),this._resources=n)}),this._debouncedTileUpdate=o(async()=>{const{allTiles:e}=this.surface,{featureTiles:r}=this.view,{_dataBounds:s,_featureTilesBounds:i}=this,n=e=>e.rendered&&e.visible&&K(s,e.extent);if(null==r)return void(this.renderedTiles=new Set(e.filter(e=>n(e))));const o=r.tiles.filter(e=>e.measures.visible),a=new Set;await this._frameTask.scheduleGenerator(function*(r){for(let s=0;s<e.length;++s){const l=e.at(s);n(l)&&K(i,l.extent)&&(o.some(({lij:e})=>t(e,l.lij)||P(e,l.lij))&&a.add(l),r.madeProgress(),r.done&&(r=yield))}}),this.renderedTiles=a}),this._debugStopLoading=!1}initialize(){const{surface:e,view:t}=this,{resourceController:r}=t;this.workerHandle=new I(S(r)),this._frameTask=r.scheduler.registerTask(z.FLOW_GENERATOR),this.addHandles([u(()=>this.simulationSettings,()=>this.triggerLoad(),{sync:!0,equals:(e,t)=>null==e&&null==t||null!=e&&null!=t&&v(e,t)}),u(()=>{const{elevationInfo:e}=this;return[this._visible,this._draped,e?.mode,e?.offset,e?.unit]},()=>this.triggerLoad(),d),u(()=>H(this._flowRenderer,this._opacity,this.emissiveStrength),e=>this._resources?.setMaterialParameters(e)),e.on("tiles-changed",()=>this._triggerTilesUpdate()),t.enableFeatureTiles(),u(()=>[this._dataBounds,this._featureTilesBounds],()=>this._triggerTilesUpdate()),h(()=>!t.featureTiles?.updating,()=>this._triggerTilesUpdate())]),this._triggerTilesUpdate()}destroy(){this.abort(),this.clear()}abort(){this._abortController=n(this._abortController)}get _dataBounds(){const e=f(this.layer.fullExtent,this.surface.spatialReference).geometry;return null==e?null:m(e)}get _draped(){return"on-the-ground"===this.elevationInfo.mode}get _featureTilesBounds(){const e=this.view.featureTiles?.filterExtent,t=f(e,this.surface.spatialReference).geometry;return null==t?null:m(t)}get _flowRenderer(){const e=this.layer.renderer;return"flow"!==e?.type?null:e}get _opacity(){return this.layerView.fullOpacity}get _visible(){const e=this._flowRenderer?.color;return this.layer.effectiveVisible&&this._opacity>0&&(null==e||e.a>0)}get elevationInfo(){return this.layer.elevationInfo??J}get layer(){return this.layerView.layer}get simulationSettings(){const{_flowRenderer:e,_overrideSimulationSettings:t}=this;if(null==e)return null;let r=w(e);return null!=t&&(r={...r,...t}),r}get surface(){return this.view.basemapTerrain}doRefresh(){return this.triggerLoad()}clear(){this._resources?.detach(),this._resources=null}async triggerLoad(){const{renderedTiles:e}=this;if(null==e||0===e.size||this._debugStopLoading)return;const t=this._debouncedLoad(e);return this.updatingHandles.addPromise(l(t))}async _load(e,t){const r=await this.fetchDataAndGenerateStreamlines(e,t);if(null==r||0===r.length)return null;const s=await this._createGeometry(e,r);return this._draped?new O(r,s,this.surface.overlayManager):new q(r,s,this.view.stage)}async fetchDataAndGenerateStreamlines(e,t){return null}async _createGeometry(e,t){const s=new B(H(this._flowRenderer,this._opacity,this.emissiveStrength)),i=new Array,n=new r(1),{elevationInfo:o,_draped:a,view:l}=this;return await this._frameTask.scheduleGenerator(function*(r){for(let u=0;u<t.length;++u)i.push(W(l,e,t[u],o,s,a,n)),r.madeProgress(),r.done&&(r=yield)}),i}_computeExtent(e){const{spatialReference:t}=this.surface;if(null==t)return null;const r=U(e);return null==r?null:g(r,t)}async _triggerTilesUpdate(){const e=this._debouncedTileUpdate();return this.updatingHandles.addPromise(l(e))}_viewSizeWithEqualRatio(e){const t=(e.xmax-e.xmin)/(e.ymax-e.ymin),[r,s]=this.view.size;return r<s?[r,Math.floor(r/t)]:[Math.floor(s*t),s]}get test(){}};e([c()],Z.prototype,"type",void 0),e([c()],Z.prototype,"renderedTiles",void 0),e([c()],Z.prototype,"emissiveStrength",void 0),e([c()],Z.prototype,"_dataBounds",null),e([c()],Z.prototype,"_draped",null),e([c()],Z.prototype,"_featureTilesBounds",null),e([c()],Z.prototype,"_flowRenderer",null),e([c()],Z.prototype,"_opacity",null),e([c()],Z.prototype,"_visible",null),e([c()],Z.prototype,"elevationInfo",null),e([c()],Z.prototype,"layer",null),e([c()],Z.prototype,"_overrideSimulationSettings",void 0),e([c()],Z.prototype,"simulationSettings",null),e([c()],Z.prototype,"surface",null),Z=e([p("esri.views.3d.layers.FlowSubView3D")],Z);const J=new y({mode:"relative-to-ground",offset:100});function K(e,t){return null==e||null==t||_(e,t)}export{Z as F};
