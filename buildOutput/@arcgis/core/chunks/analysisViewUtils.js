/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{watch as o,syncAndInitial as s,on as e,whenOnce as a}from"../core/reactiveUtils.js";import"./Logger.js";import"../core/lang.js";import"../core/Error.js";import{subclass as i}from"../core/accessorSupport/decorators/subclass.js";import{I as r}from"./InteractiveToolBase.js";import{c as n}from"./asyncUtils.js";import{h as l}from"./handleUtils.js";import{r as c}from"./maybe.js";import{throwIfAborted as m,isAbortError as p,onAbort as u}from"../core/promiseUtils.js";let v=class extends r{constructor(t){super(t)}initialize(){this.addHandles(o(()=>this.analysisViewData.visible,t=>this.visible=t,s))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};function d(t,e){return o(()=>t.interactive,()=>function(t,o){t.interactive?function(t,o){f(t);const{view:s,analysis:e}=t,a=new o({view:s,analysis:e,analysisViewData:t});t.tool=a,s.tools.add(a)}(t,o):f(t)}(t,e),s)}function f(t){const{view:o,tool:s}=t;null!=s&&(o.tools.remove(s),t.tool=null)}function y(t,o){const s=t.userOperation,i=n(async i=>{if(s){const t=s.promise.catch(()=>{});s?.abort(),await t,m(i)}const r=function(t,o){t.interactive=!0;const{tool:s,view:e}=t;e.activeTool=s;let i=u(o,()=>{e.activeTool===s&&(e.activeTool=null)});return n(async o=>{await a(()=>!t.tool?.active,o),i=c(i)},o)}(t,{signal:i}),v=o?.shouldRejectOnCancel??(()=>!0),d=l([e(()=>t.tool,"cancel",()=>{v()&&r.abort()})]),{tool:f}=t;try{f&&(f.resetCreated(),o?.onToolActivated?.(f)),await r.promise,m(i)}catch(t){if(i.aborted||!p(t)||v())throw t}finally{d?.remove()}},{signal:o?.abortOptions?.signal});return t.userOperation=i,i.promise.finally(()=>{t.userOperation===i&&(t.userOperation=null)})}async function h(t,o){const s=t.analysis.clone();return await y(t,{abortOptions:o?.placementOptions,onToolActivated:o?.onToolActivated,shouldRejectOnCancel:()=>{const{analysis:o}=t;return!o.valid||o.equals(s)}}),{}}v=t([i("esri.views.interactive.AnalysisToolBase")],v);export{v as A,y as a,d as c,f as r,h as s};
