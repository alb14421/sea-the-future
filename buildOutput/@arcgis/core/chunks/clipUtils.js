/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{m as t}from"./unitUtils.js";import e from"../geometry/Extent.js";import n from"../geometry/Point.js";import i from"../layers/support/PixelBlock.js";async function a(t,e,n){if("extent"===n.type)return function(t,e,n){const{width:a,height:o}=t,r=new Uint8Array(a*o),h=e.width/a,x=e.height/o;if(n.width/h<.5||n.height/x<.5)return new i({pixelType:t.pixelType,width:a,height:o,mask:r,pixels:[...t.pixels]});const{xmin:s,xmax:m,ymin:l,ymax:p}=e,{xmin:c,xmax:f,ymin:y,ymax:M}=n,u=Math.max(s,c),w=Math.min(m,f),d=Math.max(l,y),g=Math.min(p,M),T=.5*h,k=.5*x;if(w-u<T||g-d<k||w<s+T||u>m-T||d>p-k||g<l+k)return new i({pixelType:t.pixelType,width:a,height:o,mask:r,pixels:[...t.pixels]});const R=Math.max(0,(u-s)/h),j=Math.min(a,Math.max(0,(w-s)/h)),A=Math.max(0,(p-g)/x),z=Math.min(o,Math.max(0,(p-d)/x)),U=Math.round(R),E=Math.round(j)-1,P=Math.round(A),S=Math.round(z)-1;if(U===E&&R%1>.5&&j%1<.5||P===S&&A%1>.5&&z%1<.5)return new i({pixelType:t.pixelType,width:a,height:o,mask:r,pixels:[...t.pixels]});if(0===U&&0===P&&E===a&&S===o)return t;const v=t.mask;for(let t=P;t<=S;t++)for(let e=U;e<=E;e++){const n=t*a+e;r[n]=v?v[n]:255}return new i({pixelType:t.pixelType,width:a,height:o,mask:r,pixels:[...t.pixels]})}(t,e,n);const{width:a,height:r}=t,h=new Uint8Array(a*r);return(await import("../geometry/operators/intersectsOperator.js").then(t=>t.i)).execute(e,n)?"polyline"===n.type?function(t,e,n){const{width:a,height:o}=t,r=new Uint8Array(a*o),h=e.width/a,x=e.height/o,{xmin:s,ymax:m}=e,{paths:l}=n,p=t.mask;for(let t=0;t<l.length;t++){const e=l[t];for(let t=0;t<e.length-1;t++){const[n,i]=e[t],[l,c]=e[t+1],f=Math.min(i,c),y=Math.max(i,c),M=Math.max(0,Math.floor((m-y)/x)),u=Math.min(o-1,Math.floor((m-f)/x));if(!(u<M))if(M===u){const t=Math.min(n,l),e=Math.max(n,l),i=Math.max(0,Math.floor((t-s)/h)),o=Math.min(a-1,Math.floor((e-s)/h));if(o<i)continue;const x=M*a;for(let t=x+i;t<=x+o;t++)r[t]=p?p[t]:255}else{const t=(n-s)/h,e=(l-n)/(c-i)/h,o=x*e;for(let n=M;n<=u;n++){const h=e*(m-n*x-i)+t,s=Math.max(0,Math.floor(o>0?h-o:h)),l=Math.min(a-1,Math.floor(o>0?h:h-o));if(l<s)continue;const c=n*a;for(let t=c+s;t<=c+l;t++)r[t]=p?p[t]:255}}}}return new i({pixelType:t.pixelType,width:a,height:o,mask:r,pixels:[...t.pixels]})}(t,e,n):(await import("../geometry/operators/containsOperator.js").then(t=>t.c)).execute(n,e)?t:function(t,e,n){if(!t)return t;const{width:a,height:r}=t,h=o({geometry:n,size:[a,r],srcExtent:e,srcMask:t.mask});return new i({pixelType:t.pixelType,width:a,height:r,mask:h,maskIsAlpha:!1,pixels:[...t.pixels]})}(t,e,n):new i({pixelType:t.pixelType,width:a,height:r,mask:h,maskIsAlpha:!1,pixels:[...t.pixels]})}function o(t){const{geometry:e,size:n,srcExtent:i,srcMask:a}=t,[o,r]=n;let h;const x=i.width/o,s=i.height/r,{xmin:m,ymax:l}=i;if("extent"===e.type){const t=(e.xmin-m)/x,n=(e.xmax-m)/x,i=(l-e.ymax)/s,a=(l-e.ymin)/s;h=[[[t,i],[t,a],[n,a],[n,i],[t,i]]]}else h=e.rings.map(t=>t.map(([t,e])=>[(t-m)/x,(l-e)/s]));return function(t,e,n){const[i,a]=e,o=new OffscreenCanvas(i,a).getContext("2d");o.fillStyle="#f00",o.beginPath(),t.forEach(t=>{o.moveTo(t[0][0],t[0][1]);for(let e=0;e<t.length;e++)o.lineTo(t[e][0],t[e][1]);o.closePath()}),o.fill();const r=o.getImageData(0,0,i,a).data,h=i*a,x=new Uint8Array(h);let s=!1;for(let t=0;t<h;t++)n&&!n[t]||(r[4*t+3]>127?x[t]=255:s=!0);return s||n?x:void 0}(h,n,a)}function r(t,e){const{extent:i}=h(t,e,new n({x:t.pixelSize.x,y:t.pixelSize.y,spatialReference:t.spatialReference})),{extent:a}=t.extent;if(i.xmax=Math.min(i.xmax,a.xmax),i.ymax=Math.min(i.ymax,a.ymax),i.xmin<i.xmax&&i.ymin<i.ymax){const{x:e,y:n}=t.pixelSize,a=Math.round(i.width/e),o=Math.round(i.height/n);t.extent=i,t.width=a,t.height=o}}function h(n,i,a,o=!0){const{spatialReference:r}=n,{x:h,y:x}=function(e,n){if(e.spatialReference.equals(n))return e;const i=t(e.spatialReference),a=t(n);if(i===a)return e;const o=i/a;return{x:e.x*o,y:e.y*o}}(a,r);let s,m,l;const p="extent"===i.type?i:i.extent;let{xmin:c,xmax:f,ymax:y,ymin:M}=p;const{xmin:u,ymax:w}=n.extent;return o?(c=u+(c>u?h*Math.round((c-u)/h):0),y=w-(y<w?x*Math.round((w-y)/x):0),f=u+(f>u?h*Math.round((f-u)/h):0),M=w-(M<w?x*Math.round((w-M)/x):0),s=new e({xmin:c,ymax:y,xmax:f,ymin:M,spatialReference:r}),m=Math.round(s.width/h),l=Math.round(s.height/x)):(m=Math.floor((f-c)/h+.8),l=Math.floor((y-M)/x+.8),c=u+(c>u?h*Math.floor((c-u)/h+.1):0),y=w-(y<w?x*Math.floor((w-y)/x+.1):0),f=c+m*h,M=y-l*x,s=new e({xmin:c,ymax:y,xmax:f,ymin:M,spatialReference:r})),{extent:s,width:m,height:l}}export{r as a,o as b,a as c,h as s};
