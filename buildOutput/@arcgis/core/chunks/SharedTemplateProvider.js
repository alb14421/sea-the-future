/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../request.js";import r from"../core/Accessor.js";import{m as s}from"./handleUtils.js";import{g as o}from"./MapUtils.js";import{a}from"./maybe.js";import{onAbort as i,throwIfAborted as l,createAbortError as n,createResolver as p,throwIfAbortError as c}from"../core/promiseUtils.js";import{watch as d}from"../core/reactiveUtils.js";import{property as u}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./Logger.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{f,g as h,e as y,d as w}from"./templateUtils2.js";import v from"../core/Error.js";import{d as g}from"./SetUtils.js";import{i as S,a as k}from"./layerUtils.js";import{i as b}from"./utils11.js";class _ extends v{constructor(e,t){super("shared-template-query-failed",`Request to fetch templates failed. templateIds: ${e.join(",")}`,{error:t}),this.templateIds=e}}class j extends v{constructor(e,t){const r=new Set(t.map(e=>e.templateId)),s=g(new Set(e),r);super("shared-template-some-templates-missing",`The service failed to return templates for the following 'templateId's: ${Array.from(s).join(",")}`)}}class N extends v{constructor(){super("shared-template-required-properties-not-set","Values must be specified for the `definition`, `featureService`, `layer`, and `view` properties of a `SharedTemplate` in order to load it")}}class I extends v{constructor(){super("shared-template-definition-required-properties-not-set","The `featureService`, `makeSharedTemplateFromJSON`, and `view` properties must all be set in order to load a template definition")}}class T extends v{constructor(e){super("shared-template-unsupported-builder",`This template uses an unsupported builder type, '${e}'`),this.builderType=e}}class R extends v{constructor(e,t){super("shared-template-layer-resolver-error",`The 'layerResolver' function failed to provide any layers for template with 'templateId: ${e}'`,{error:t}),this.templateId=e}}class C extends v{constructor(e,t){super("shared-template-utility-network-resolver-error",`The 'utilityNetworkResolver' function threw an error while attempting to find a utility network for template with 'templateId: ${e}'`,{error:t}),this.templateId=e}}class U extends v{constructor(e){super("shared-template-layer-unavailable",`None of the layers with which the template is associated are present in the view. Layer IDs: [${e.join(",")}]`),this.layerIds=e}}class x extends v{constructor(e){super("shared-template-relationship-not-found",`Relationship class '${e}' could not be found.`),this.relationshipCatalogId=e}}const H=new Map;function L(e,t){return o(H,e,()=>{const r=new O({layerResolver:t?.layerResolver??F(e),makeSharedTemplateFromJSON:t.makeSharedTemplateFromJSON,utilityNetworkResolver:t?.utilityNetworkResolver??J(e),view:e});return e.addHandles(s(()=>{H.delete(e),r.destroy()})),r})}let O=class extends r{constructor(e){super(e),this._abortController=null,this._cache=new Map,this._pending=new Map,this._utilityNetworkLookupHelperCache=new Map,this.layerResolver=null,this.makeSharedTemplateFromJSON=null,this.utilityNetworkResolver=null,this.view=null}initialize(){this.addHandles(d(()=>this.view.spatialReference,()=>this._reset()))}destroy(){this._abortController=a(this._abortController)}async getTemplates({templateIds:e,featureService:t,signal:r}){const s=this._cache,o=this._pending,a=[],n=new Set,p=new Set,c=Symbol();for(const r of new Set(e)){const e=q(t,r);if(s.has(e))a.push(s.get(e));else if(o.has(e)){const t=o.get(e);t.subscribers.add(c),p.add(t)}else n.add(r),o.set(e,A())}if(a.length===e.length)return a;const d=()=>{for(const{subscribers:e}of p)e.delete(c)},u=i(r,d);try{const e=await this._loadTemplates({templateIds:Array.from(n),featureService:t,signal:r}),s=await Promise.all(Array.from(p).map(({resolver:e})=>e.promise));a.push(...e),a.push(...s)}catch(e){d();for(const r of n){const s=q(t,r),a=o.get(s);a?.resolver.reject(e),o.delete(s)}throw e}finally{u?.remove()}return l(r),a}async _loadTemplates({templateIds:e,featureService:r,signal:s}){if(0===e.length)return[];const o=this._cache,a=this._pending,l=this._abortController=new AbortController,p=i(s,()=>{for(const t of e)if($(a.get(q(r,t))))return;l.abort()}),d=await async function({templateIds:e,featureService:r,spatialReference:s,signal:o}){const a=`${r.url}/sharedTemplates/templates`,i=await t(a,{query:{f:"json",outSR:s,ids:e.join(",")},signal:o}).catch(t=>{throw c(t),new _(e,t)});return i.data?.templates??[]}({featureService:r,templateIds:e,signal:l.signal,spatialReference:this.view.spatialReference});if(d.length<e.length)throw new j(e,d);const u=await Promise.all(d.map(e=>this._makeTemplate({json:e,featureService:r})));for(const e of u){const t=q(r,e.templateId),i=a.get(t);!s?.aborted||$(i)?(o.set(t,e),i?.resolver.resolve(e)):i?.resolver.reject(n()),a.delete(t)}return p?.remove(),u}async _makeTemplate({json:e,featureService:t}){const{view:r}=this,s=this.makeSharedTemplateFromJSON(e);s.featureService=t,s.view=r;const{layerIds:o,subtypeCode:a}=s;try{s.layer=await this.layerResolver({featureService:t,layerIds:o,subtypeCode:a})}catch(e){throw new R(s.templateId,e)}if(f(s)&&s.definition?.createUtilityNetworkAssociations){let e=null;try{e=await this.utilityNetworkResolver(t)}catch(e){throw new C(s.templateId,e)}if(e){s.definition.utilityNetwork=await this._getOrCreateUtilityNetworkLookupHelper(e);const t=e.associationsTable;s.definition.utilityNetworkAssociationsTable=t,h(r).additionalLayers.add(t)}}if(y(s)&&s.definition){s.definition.spatialReference=r.spatialReference;for(const e of s.definition.allParts)e.geometry&&(e.geometry.spatialReference=r.spatialReference)}if(w(s)&&s.definition?.defaultValues){const e=s.definition.defaultValues,t={},{fieldsIndex:r}=s.layer;for(const o in s.definition.defaultValues)t[r.get(o)?.name??o]=e[o];s.definition.defaultValues=t}return s}async _getOrCreateUtilityNetworkLookupHelper(e){const t=this._utilityNetworkLookupHelperCache.get(e);if(t)return t;const{UtilityNetworkLookupHelper:r}=await import("./UtilityNetworkLookupHelper.js"),o=await new r({utilityNetwork:e}).load();this._utilityNetworkLookupHelperCache.set(e,o);const a=s(()=>{o.destroy(),this._utilityNetworkLookupHelperCache.delete(e)});return e.addHandles(a),this.addHandles(a),o}_reset(){this._abortController?.abort(),this._cache.clear(),this._pending.clear()}};function $(e){return null!=e&&e.subscribers.size>0}function A(){return{resolver:p(),subscribers:new Set}}function q(e,t){return`${e.url}/${t}`}function F(e){return async({featureService:t,layerIds:r})=>{if(!e.map)throw new U(r);const s=new Set(r),{allLayers:o,allTables:a}=e.map,i=o.concat(a).find(e=>e.url===t.url&&function(e){return S(e)||k(e)}(e)&&s.has(e.layerId));if(null==i)throw new U(r);return i}}function J(e){return async t=>{const{map:r}=e;if(!b(r)||!r.utilityNetworks)return null;for(const e of r.utilityNetworks)if(e.featureServiceUrl===t.url)return e.load();return null}}e([u()],O.prototype,"_abortController",void 0),e([u()],O.prototype,"_cache",void 0),e([u()],O.prototype,"_pending",void 0),e([u({constructOnly:!0})],O.prototype,"layerResolver",void 0),e([u({constructOnly:!0})],O.prototype,"makeSharedTemplateFromJSON",void 0),e([u({constructOnly:!0})],O.prototype,"utilityNetworkResolver",void 0),e([u({constructOnly:!0})],O.prototype,"view",void 0),O=e([m("esri.editing.sharedTemplates.SharedTemplateProvider")],O);export{I as S,x as a,T as b,N as c,L as g};
