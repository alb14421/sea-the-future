/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../Color.js";import{g as o}from"./colorUtils2.js";import e from"../core/Error.js";import{l as s}from"./fontUtils.js";import{p as i}from"./screenUtils.js";import{q as r,a as l}from"./quantizationUtils.js";import{a as m,g as a,b as n,c as p}from"./gfxUtils.js";import{a as c,r as h,s as y}from"./renderUtils.js";import{b as u}from"../symbols/Font.js";import"./colorUtils.js";import"./mathUtils.js";import"./ensureType.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./MapUtils.js";import"./vec4.js";import"./common.js";import"./vec4f64.js";import"../geometry/Extent.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"./metadata.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./tracking.js";import"./Warning.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./events.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./persistableUrlUtils.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./LRUCache.js";import"./MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils6.js";import"./defaultCIMValues.js";import"./projector.js";import"./sanitizerUtils.js";import"./svgUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./widgetUtils.js";import"../core/reactiveUtils.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"./utils8.js";import"./asyncUtils.js";import"./vec3f64.js";import"./jsonUtils2.js";import"./parser.js";import"./utils5.js";import"./mat4.js";import"./Symbol3DMaterial.js";import"./materialUtils.js";import"./opacityUtils.js";import"./typeUtils2.js";import"../symbols/CIMSymbol.js";import"./enumeration.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./guards.js";import"./datetime.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"./locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils3.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils4.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./DoubleArray.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"./lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";const j="picture-fill",d=120,g=document.createElement("canvas");function b(t,o,e){if("polygon"===t.type){const s=t.extent,i=0===s.width?1:s.width,l=0===s.height?1:s.height;t=r({originPosition:"upperLeft",scale:[i/o,l/e],translate:[s.xmin,s.ymax]},{},t);let m="";for(let o=0;o<t.rings.length;o++){const e=t.rings[o];for(let t=0;t<e.length;t++){const o=e[t][0],s=e[t][1];let i="";0===t?(i=`M${o.toString()} ${s.toString()}`,""!==m&&(i=` ${i}`),m+=i):t===e.length-1?(i=`l${o.toString()} ${s.toString()} Z`,""!==m&&(i=` ${i}`),m+=i):(i=`l${o.toString()} ${s.toString()}`,""!==m&&(i=` ${i}`),m+=i)}}return m}if("polyline"===t.type){const s=t.extent,i=0===s.width?1:s.width,r=0===s.height?1:s.height;t=l({originPosition:"upperLeft",scale:[i/o,r/e],translate:[s.xmin,s.ymax]},{},t);let m="";for(let o=0;o<t.paths.length;o++){const e=t.paths[o];for(let t=0;t<e.length;t++){const o=e[t][0],s=e[t][1];let i="";0===t?(i=`M${o.toString()} ${s.toString()}`,""!==m&&(i=` ${i}`),m+=i):(i=`l${o.toString()} ${s.toString()}`,""!==m&&(i=` ${i}`),m+=i)}}return m}return""}function f(t,o){const e=g.getContext("2d"),s=[];o&&(o.weight&&s.push(o.weight),o.size&&s.push(o.size+"px"),o.family&&s.push(o.family)),e.font=s.join(" ");const{width:i,actualBoundingBoxLeft:r,actualBoundingBoxRight:l,actualBoundingBoxAscent:m,actualBoundingBoxDescent:a}=e.measureText(t);return{width:Math.ceil(Math.max(i,r+l)),height:Math.ceil(m+a),x:Math.floor(r),y:Math.floor((m-a)/2)}}function S(t){const o=t?.size;return{width:null!=o&&"object"==typeof o&&"width"in o?i(o.width):null,height:null!=o&&"object"==typeof o&&"height"in o?i(o.height):null}}function w(t,o){return t>o?"dark":"light"}function x(t,o){const e="number"==typeof o?.size?o?.size:null,s=null!=e?i(e):null,r=null!=o?.maxSize?i(o.maxSize):null;let l="angle"in t?t.angle:null;null!=o?.rotation&&(l=(l??0)+o.rotation);const p=m(t);let c=a(t);"dark"!==L(t,245)||o?.ignoreWhiteSymbols||(c={width:.75,...c,color:"#bdc3c7"});let h=null;const u={shape:null,fill:p,stroke:c,offset:[0,0]};c?.width&&(c.width=Math.min(c.width,80));const g=c?.width||0;let w=null!=o?.size&&(null==o?.scale||o?.scale),x=0,M=0,v=!1;switch(t.type){case"simple-marker":{const e=t.style,{width:m,height:a}=S(o);let n=m===a&&null!=m?m:null!=s?s:Math.min(i(t.size),r||d);if(!0===o?.useMarkerSymbolSize&&null!==m&&null!==a){const o=Math.min(i(t.size),r||d);n=o>m&&o>a?Math.min(m,a):o}switch(x=n,M=n,e){case"circle":u.shape={type:"circle",cx:0,cy:0,r:.5*n},w||(x+=g,M+=g);break;case"cross":u.shape={type:"path",path:[{command:"M",values:[0,.5*M]},{command:"L",values:[x,.5*M]},{command:"M",values:[.5*x,0]},{command:"L",values:[.5*x,M]}]};break;case"diamond":u.shape={type:"path",path:[{command:"M",values:[0,.5*M]},{command:"L",values:[.5*x,0]},{command:"L",values:[x,.5*M]},{command:"L",values:[.5*x,M]},{command:"Z",values:[]}]},w||(x+=g,M+=g);break;case"square":u.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[x,0]},{command:"L",values:[x,M]},{command:"L",values:[0,M]},{command:"Z",values:[]}]},w||(x+=g,M+=g),l&&(v=!0);break;case"triangle":u.shape={type:"path",path:[{command:"M",values:[.5*x,0]},{command:"L",values:[x,M]},{command:"L",values:[0,M]},{command:"Z",values:[]}]},w||(x+=g,M+=g),l&&(v=!0);break;case"x":u.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[x,M]},{command:"M",values:[x,0]},{command:"L",values:[0,M]}]},l&&(v=!0);break;case"path":u.shape={type:"path",path:t.path||""},w||(x+=g,M+=g),l&&(v=!0),w=!0}break}case"simple-line":{const{width:t,height:e}=S(o),i=n(c).reduce((t,o)=>t+o,0),r=i&&Math.ceil(50/i),l=e??s??g,m=t??(i*r||50);if(w=!0,"polyline"===o?.geometry?.type&&o?.geometry?.extent){x=m,M=e??x;const t=1e3,s=.15*t;h=[x,M],M=h[0]>h[1]?t*h[1]/h[0]:t,x=h[0]>h[1]?t:t*h[0]/h[1],c?.width&&(c.width=c.width*t/(h[1]>h[0]?h[1]:h[0]),c.width>s&&(c.width=s)),u.shape={type:"path",path:b(o.geometry,x,M)}}else x=null!=o?.maxSize?Math.min(m,o.maxSize):m,M=l,c&&(c.width=l),u.shape={type:"path",path:[{command:"M",values:[l/2,M/2]},{command:"L",values:[x-l/2,M/2]}]};break}case j:case"simple-fill":{const t="object"==typeof o?.symbolConfig&&!!o?.symbolConfig?.isSquareFill,{width:e,height:i}=S(o);x=!t&&e!==i||null==e?null!=s?s:22:e,M=!t&&e!==i||null==i?x:i,w||(x+=g,M+=g),w=!0,o?.geometry?.extent&&"polygon"===o?.geometry?.type?(h=[x,M],M=h[0]>h[1]?1e3*h[1]/h[0]:1e3,x=h[0]>h[1]?1e3:1e3*h[0]/h[1],u.shape={type:"path",path:b(o.geometry,x,M)}):u.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[x,0]},{command:"L",values:[x,M]},{command:"L",values:[0,M]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:y.fill[0];break}case"picture-marker":{const e=Math.min(i(t.width),r||d),m=Math.min(i(t.height),r||d),{width:a,height:n}=S(o),p=a===n&&null!=a?a:null!=s?s:Math.max(e,m),c=t.width/t.height;x=c<=1?Math.ceil(p*c):p,M=c<=1?p:Math.ceil(p/c),u.shape={type:"image",x:-Math.round(x/2),y:-Math.round(M/2),width:x,height:M,src:t.url||""},l&&(v=!0);break}case"text":{const e=t,l=o?.overrideText||e.text||"Aa",m=e.font,{width:a,height:n}=S(o),p=null!=n?n:null!=s?s:Math.min(i(m.size),r||d),{width:c,height:h}=f(l,{weight:m.weight,size:p,family:m.family}),y=/[\uE600-\uE6FF]/.test(l);x=a??(y?p:c),M=y?p:h;let j=.5*(y?p:h);y&&(j+=5),u.shape={type:"text",text:l,x:e.xoffset||0,y:e.yoffset||j,align:"middle",alignBaseline:e.verticalAlignment,decoration:m&&m.decoration,rotated:e.rotated,kerning:e.kerning},u.font=m&&{size:p,style:m.style,decoration:m.decoration,weight:m.weight,family:m.family};break}}return{shapeDescriptor:u,size:[x,M],outputSize:h,renderOptions:{node:o?.node,scale:w,opacity:o?.opacity,rotations:[l],useRotationSize:v,effectView:o?.effectView,ariaLabel:o?.ariaLabel,clipBloomEffect:o?.clipBloomEffect}}}async function M(t,o){const{shapeDescriptor:r,size:l,renderOptions:m,outputSize:a}=x(t,o);if(!r.shape)throw new e("symbolPreview: renderPreviewHTML2D","symbol not supported.");await async function(t,o){const e=o.fill,s=t.color;if("pattern"===e?.type&&s&&t.type!==j){const t=await p(e.src,s.toCss(!0));e.src=t,o.fill=e}}(t,r),await async function(t,o,e,i){if(!("font"in t)||!t.font||"text"!==o.shape.type)return;try{await s(t.font)}catch{}const{width:r,height:l}=S(i);if(!/[\uE600-\uE6FF]/.test(o.shape.text)){const{width:s,height:m,x:a,y:n}=f(o.shape.text,{weight:o.font?.weight,size:o.font?.size,family:o.font?.family});e[0]=r??s,e[1]=l??m,o.shape.x=a,o.shape.y=n;let p="angle"in t?t.angle:null;if(null!=i?.rotation&&(p=(p??0)+i.rotation),p){const t=p*(Math.PI/180),o=Math.abs(Math.sin(t)),s=Math.abs(Math.cos(t));e[1]=e[0]*o+e[1]*s}}}(t,r,l,o);const n=[[r]];if("object"==typeof o?.symbolConfig&&o?.symbolConfig?.applyColorModulation){const t=.6*l[0];n.unshift([{...r,offset:[-t,0],fill:c(r.fill,-.3)}]),n.push([{...r,offset:[t,0],fill:c(r.fill,.3)}]),l[0]+=2*t,m.scale=!1}"text"===t.type&&function(t,o,e,s,r){if(null!=t.haloColor&&null!=t.haloSize){r.masking??=e.map(()=>[]);const l=i(t.haloSize);s[0]+=l,s[1]+=l,e.unshift([{...o,fill:null,stroke:{color:t.haloColor,width:2*l,join:"round",cap:"round"}}]),r.masking.unshift([{shape:{type:"rect",x:0,y:0,width:s[0]+2*u,height:s[1]+2*u},fill:[255,255,255],stroke:null},{...o,fill:[0,0,0,0],stroke:null}])}null==t.backgroundColor&&null==t.borderLineColor||(s[0]+=2*u,s[1]+=2*u,e.unshift([{shape:{type:"rect",x:0,y:0,width:s[0],height:s[1]},fill:t.backgroundColor,stroke:{color:t.borderLineColor,width:i(t.borderLineSize)}}]),r.masking?.unshift([]))}(t,r,n,l,m);const y=h(n,l,m);if(a&&y){const t="img"===y.nodeName.toLowerCase()?y:y.firstChild;"svg"===t.nodeName.toLowerCase()&&t.setAttribute("viewBox",`0 0 ${l[0].toString()} ${l[1].toString()}`),t.setAttribute("width",a[0].toString()),t.setAttribute("height",a[1].toString()),a.length>2&&(t.style.setProperty("padding-left",a[2]?.toString()+"px"),t.style.setProperty("padding-right",a[2]?.toString()+"px"),t.style.setProperty("padding-top",a[3]?.toString()+"px"),t.style.setProperty("padding-bottom",a[3]?.toString()+"px"),t.style.setProperty("box-sizing","border-box"))}return y}function L(e,s=225){const i=m(e),r=a(e),l=!i||"type"in i?null:new t(i),n=r?.color?new t(r?.color):null,p=l?w(o(l),s):null,c=n?w(o(n),s):null;return c?p?p===c?p:s>=225?"light":"dark":c:p}export{L as getContrastingBackgroundTheme,x as getRenderSymbolParameters,M as previewSymbol2D};
