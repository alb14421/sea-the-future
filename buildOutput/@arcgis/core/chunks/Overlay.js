/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{a as t}from"./events.js";import s from"../core/Handles.js";import{L as r}from"./Logger.js";import{f as i}from"./maybe.js";import{g as n}from"./perspectiveUtils.js";import{watch as a,when as o,initial as d}from"../core/reactiveUtils.js";import{c as l}from"./mat3f64.js";import{s as h}from"./vec2.js";import{c as m}from"./vec2f64.js";import{a as p}from"./mediaLayerUtils2.js";import{D as u}from"./DisplayObject.js";import{p as c}from"./utils25.js";import{a as f,T as y}from"./Texture.js";const v=[1,1],w=l(),x={none:"None",loop:"Loop",oscillate:"Oscillate"};class R extends u{constructor(n){super(),this.elementView=n,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=m(),this._handles=new s,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([a(()=>this.elementView.element.opacity,e=>this.opacity=e,d),a(()=>[this.elementView.coords],()=>{this.requestRender()},d),a(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._handles.remove("play"),this.texture=i(this.texture),this.requestRender()},d),o(()=>this.elementView.element.loaded,()=>{const e=this.elementView.element;this.ready(),p(e)&&null!=e.content&&(this._handles.add([t(e.content,"play",()=>this.requestRender()),t(e.content,"loadeddata",()=>this.requestRender()),t(e.content,"loaded",()=>this.requestRender())]),"requestVideoFrameCallback"in e.content?e.content.requestVideoFrameCallback(()=>this.requestRender()):this._handles.add([t(e.content,"seeked",()=>this.requestRender())]),this.requestRender())},d)]),n.element.load().catch(t=>{r.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new e("element-load-error","Element cannot be displayed",{element:n,error:t}))})}getMesh(e){throw new Error("Method not implemented.")}destroy(){super.destroy(),this._handles.destroy(),this.texture=i(this.texture)}get textureSize(){return v}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,s=this.elementView.element.content;if(null!=s){const e=s instanceof HTMLImageElement,i=s instanceof HTMLVideoElement,n=e?s.naturalWidth:i?s.videoWidth:s.width,a=e?s.naturalHeight:i?s.videoHeight:s.height;if(this._updatePerspectiveTransform(n,a),this.texture){if(i)if(s.readyState>=s.HAVE_CURRENT_DATA)this._updateTextureAndRequestRender(s);else{const e=()=>{this._updateTextureAndRequestRender(s),s.removeEventListener("canplay",e),s.removeEventListener("seeked",e)};s.addEventListener("canplay",e),s.addEventListener("seeked",e)}}else{const e=new f(n,a);if(e.wrapMode=33071,e.preMultiplyAlpha=!0,"getFrame"in s){const i=s=>{this.texture?this.texture.setData(s):this.texture=new y(t,e,s),this.requestRender()};"animationOptions"in this.elementView.element&&this._handles.add(c(s,(r=this.elementView.element.animationOptions)?{type:"CIMAnimatedSymbolProperties",...r,playAnimation:r.playing,repeatType:r.repeatType?x[r.repeatType]:void 0}:{type:"CIMAnimatedSymbolProperties"},null,i),"play")}else this.texture=new y(t,e,s);this.texture.generateMipmap(),i&&("requestVideoFrameCallback"in s?s.requestVideoFrameCallback(()=>this.requestRender()):s.paused||this.requestRender())}}var r;super.beforeRender(e)}_updateTextureAndRequestRender(e){this.texture.setData(e),this.texture.generateMipmap(),"requestVideoFrameCallback"in e?e.requestVideoFrameCallback(()=>this.requestRender()):e.paused||this.requestRender()}_createTransforms(){return null}draw(e,t){this.isReady&&null!=this.texture?t.render(e,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:v,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices}):this.requestRender()}updateDrawCoords(e,t,s,r){const{coords:i,bounds:n}=this.elementView;if(null==i||null==n)return;const[a,o,d,l]=i.rings[0],h=this._vertices,{x:m,y:p}=e;h.set([o[0]-m,o[1]-p,a[0]-m,a[1]-p,d[0]-m,d[1]-p,l[0]-m,l[1]-p]);let u=t;if(r){const[e,,t]=n,{worldWidth:s,xBounds:i}=r,[a,o]=i;e<a&&t>a?u=s:t>o&&e<o&&(u=-s)}this.wrapAroundShift=u,this.isWrapAround=0!==u}_updatePerspectiveTransform(e,t){const s=this._vertices;n(w,[0,0,e,0,0,t,e,t],[s[0],s[1],s[4],s[5],s[2],s[3],s[6],s[7]]),h(this.perspectiveTransform,w[6]/w[8]*e,w[7]/w[8]*t)}}export{R as O};
