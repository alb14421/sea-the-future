/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{i as e}from"../core/lang.js";import{createFieldInfos as t}from"../support/popupUtils.js";import i,{A as l}from"../tables/AttributeTableTemplate.js";import r from"../tables/elements/AttributeTableAttachmentElement.js";import s from"../tables/elements/AttributeTableFieldElement.js";import n from"../tables/elements/AttributeTableGroupElement.js";import o from"../tables/elements/AttributeTableRelationshipElement.js";import a from"../widgets/FeatureTable/support/AttachmentsColumnTemplate.js";import{i as d,a as p,b as m,c as u}from"./columnUtils.js";import f from"../widgets/FeatureTable/support/FieldColumnTemplate.js";import c from"../widgets/FeatureTable/support/GroupColumnTemplate.js";import h from"../widgets/FeatureTable/support/RelationshipColumnTemplate.js";import b from"../widgets/FeatureTable/support/TableTemplate.js";import{i as w,a as T,b as y,h as F}from"./tableUtils.js";function j(e,t){const{description:i,label:l,type:r}=e;if("field"===r){const r=e.fieldName??void 0,s=t.findIndex(e=>e.field&&e.field===r),n=s>-1?t.at(s)?.order:void 0;return new f({description:i,direction:n,fieldName:r,initialSortPriority:s,label:l})}return"attachment"===r?new a({description:i,label:l}):"relationship"===r?new h({description:i,label:l,relationshipId:e.relationshipId}):void 0}function v(t){const i=[];return t.forEach(t=>{const{hidden:l}=t;if(d(t)){if(l)return;const r=t.columns?.map(e=>E(e)).filter(e);if(!r?.length)return;i.push(new n({elements:r}))}else{const e=E(t);if(!e)return;i.push(e)}}),i}function E(e){const{fieldName:t,hidden:i}=e;if(p(e)){if(!i)return new s({fieldName:t})}else if(m(e)){if(!i)return new o({relationshipId:e.relationshipId})}else if(u(e)&&!i)return new r}async function N({layer:e,excludeAttachments:l,excludeRelationships:n,excludedFieldTypesOverride:a}){const d=[];if(!e||!w(e))return new i;await e.load();const p=t(e,{...a&&{ignoreFieldTypes:a},sortDisabled:!0});for(const{visible:e,fieldName:t}of p)e&&d.push(new s({fieldName:t}));return T(e)&&!0!==l&&d.push(new r),y(e)&&!0!==n&&e.relationships?.forEach(e=>{d.push(new o({relationshipId:e.id}))}),new i({elements:d,orderByFields:[]})}async function g(e){const{excludeAttachments:i,excludeRelationships:l,layer:r,excludedFieldTypesOverride:s}=e,n=[];return await r.load(),t(r,{...s&&{ignoreFieldTypes:s},sortDisabled:!0}).forEach(({fieldName:e,format:t,label:i,visible:l})=>{null!=e&&n.push(new f({fieldName:e,format:t,label:i,visible:l}))}),T(r)&&!0!==i&&n.push(new a),y(r)&&!0!==l&&r.relationships?.forEach(({id:e})=>{n.push(new h({relationshipId:e}))}),new b({columnTemplates:n})}async function A(i){const{layer:l,template:r,includeHiddenFields:s,excludedFieldTypesOverride:n}=i,o=r.orderByFields??[],d=function(t,i){const l=[];return t?.forEach(t=>{const{description:r,label:s,type:n}=t;if("group"===n){const n=t.elements.map(e=>j(e,i)).filter(e);if(!n?.length)return;l.push(new c({description:r,columnTemplates:n,label:s}))}else{const e=j(t,i);if(!e)return;l.push(e)}}),l}(r.elements,o);return s&&(await l.load(),t(l,{...n&&{ignoreFieldTypes:n},sortDisabled:!0}).forEach(e=>{if(!e.fieldName)return;const{fieldName:t,label:i}=e;if(!F(t,d)){const e=o.findIndex(e=>e.field&&e.field===t),l=e>-1?o.at(e)?.order:void 0;d.push(new f({direction:l,fieldName:t,initialSortPriority:e,label:i,visible:!1}))}}),T(l)&&!d.some(e=>"attachment"===e.type)&&d.push(new a({visible:!1})),y(l)&&l.relationships?.forEach(({id:e})=>{d.some(t=>"relationship"===t.type&&t.relationshipId===e)||d.push(new h({relationshipId:e,visible:!1}))})),new b({columnTemplates:d})}function x(e,t,i=!0){const{allColumns:r,columns:s}=e,n=[],o=v(s.toArray());return e.activeSortOrders.forEach(({fieldName:e,direction:t})=>{e&&t&&n.push(new l({field:e,order:t}))}),r.filter(e=>null!=e.direction&&(!e.hidden||i)).forEach(({fieldName:e,direction:t})=>{const i=n.find(t=>t.field===e);t&&!i&&n.push(new l({field:e,order:t}))}),t.elements=o,t.orderByFields=n,t}export{g as a,A as b,N as c,v as d,x as s};
