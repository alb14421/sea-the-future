/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{L as t}from"./Logger.js";import{c as e,l as i}from"./mathUtils.js";import{a as o,b as n,r as a,d as s,h as l}from"./mat4.js";import{c as r}from"./mat4f64.js";import{c,l as u}from"./vec2.js";import{f as m,c as d}from"./vec2f64.js";import{k as g,m as f,n as h,i as b,t as y,j as p,e as A}from"./vec3.js";import{f as w,b as v,c as M}from"./vec3f64.js";import{S as N}from"./SunCalc.js";import{b as T}from"./mathUtils2.js";const x={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class O{constructor(t,e){this.direct=t,this.ambient=e}}function j(t,o,n,a,s,l){g(l.ambient.color,1,1,1),l.ambient.intensity=x.global.ambient,g(l.direct.color,1,1,1),l.direct.intensity=x.global.direct;const r=o[2],m=e((Math.abs(r)-x.local.altitude)/(x.global.altitude-x.local.altitude),0,1);let h;if(l.globalFactor=m,null!=t&&(h=N.getTimes(t,o[1],o[0])),m<1){let e;if(null!=t)e=function(t,e,i){const o=t.valueOf();let n,a;e.polarException===N.PolarException.MIDNIGHT_SUN?(n=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=n+432e6):e.polarException===N.PolarException.POLAR_NIGHT?(n=o-2,a=o-1):(n=e.sunrise.valueOf(),a=e.sunset.valueOf());const s=a-n,l=n+s/2,r=s/4,m=l-r,g=l+r,h=.06*s,b=n-h/2,y=n+h/2,p=a-h/2,w=a+h/2,v=d(),T=M(),x=M();let O="";if(o<b||o>w)c(v,J),A(T,U),A(x,C),O="night";else if(o<y){const t=(o-b)/(y-b);u(v,J,K,t),f(T,U,G,t),f(x,C,$,t),O="sun rising"}else if(o<m){const t=(o-y)/(m-y);u(v,K,Q,t),f(T,G,_,t),f(x,$,q,t),O="early morning"}else if(o<l){const t=(o-m)/(l-m);u(v,Q,V,t),f(T,_,k,t),f(x,q,B,t),O="late morning"}else if(o<g){const t=(o-l)/(g-l);u(v,V,W,t),f(T,k,X,t),f(x,B,Y,t),O="early afternoon"}else if(o<p){const t=(o-g)/(p-g);u(v,W,Z,t),f(T,X,tt,t),f(x,Y,et,t),O="late afternoon"}else if(o<w){const t=(o-p)/(w-p);u(v,Z,J,t),f(T,tt,U,t),f(x,et,C,t),O="sun setting"}let j=0;switch(i){case"rainy":case"foggy":j=.8;break;case"snowy":j=.5}j>0&&(R(T,j),R(x,j));const S=F(i);return{direct:{intensity:v[0]*S.direct,color:T},ambient:{intensity:v[1]*S.ambient,color:x},timeOfDay:O}}(t,h,a);else{const t=F(a);e={direct:{intensity:x.local.directAtNoon*t.direct,color:w(1,1,1)},ambient:{intensity:x.local.ambientAtNoon*t.ambient,color:w(1,1,1)},timeOfDay:"early afternoon"}}f(l.ambient.color,e.ambient.color,l.ambient.color,m),l.ambient.intensity=i(e.ambient.intensity,l.ambient.intensity,m),f(l.direct.color,e.direct.color,l.direct.color,m),l.direct.intensity=i(e.direct.intensity,l.direct.intensity,m),l.specularStrength="rainy"===a||"snowy"===a||"foggy"===a?0:1,l.environmentStrength="rainy"===a?.7:"snowy"===a||"foggy"===a?.75:1}l.noonFactor=null!=t?function(t,i){const o=t.valueOf();let n,a;i.polarException===N.PolarException.MIDNIGHT_SUN?(n=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=n+432e6):i.polarException===N.PolarException.POLAR_NIGHT?(n=o-2,a=o-1):(n=i.sunrise.valueOf(),a=i.sunset.valueOf());const s=n+(a-n)/2;return 1-e(Math.abs(o-s)/432e5,0,1)}(t,h):1,null!=t?P(t,o,n,l.direct.directionToLightSource):S(s,n,l.direct.directionToLightSource)}function S(t,e,i){1===e?h(nt,t.eye):g(nt,0,0,1),b(at,t.viewForward,-1);const n=T(at,nt),a=Math.max(n-2*lt,0),s=.85*a/(a+1),l=Math.max(lt,n-lt-s);o(ot,-l,t.viewRight),y(i,at,ot),p(i,i,b(st,t.viewRight,rt)),h(i,i)}function P(t,i,o,r){const c=H,u=n(L);if(1===o)N.getPosition(t,0,0,c),g(r,0,0,-1),a(u,u,-c.azimuth),s(u,u,-c.altitude),y(r,r,u);else{const o=x.planarDirection,n=o.globalAngles,s=i[2];let m=(Math.abs(s)-o.localAltitude)/(o.globalAltitude-o.localAltitude);m=e(m,0,1),m<1?(N.getPosition(t,i[1],i[0],c),c.azimuth=(1-m)*c.azimuth+m*n.azimuth,c.altitude=(1-m)*c.altitude+m*n.altitude):(c.azimuth=n.azimuth,c.altitude=n.altitude),g(r,0,-1,0),l(u,u,-c.azimuth),a(u,u,-c.altitude),y(r,r,u)}}function z(t,e){if(1===e)return!0;const i=x.planarDirection;return Math.abs(t)<i.localAltitude}function D(e,i,o,n,a,s){const l=e.getTime(),r=Math.max(0,i.getTime()-l),c=Math.floor(r/o)+1,u=Math.min(s,c),m=new Array(u),d=1===u?0:r/(u-1);c>u&&t.getLogger("esri.views.3d.support.sunUtils").warnOnce("computeDirectionsOverTime",`Requested interval ${o} exceeds maximum supported interval of ${Math.floor(d)} based on the provided time range.`);for(let t=0;t<u;++t)it.setTime(l+d*t),m[t]=M(),P(it,n,a,m[t]);return m}const E=w(.5773502691896258,-.5773502691896258,.5773502691896258);class I{constructor(){this.ambient={color:w(1,1,1),intensity:.55},this.direct={color:w(1,1,1),intensity:.55,directionToLightSource:v(E)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const L=r(),H={azimuth:0,altitude:0};function F(t){switch(t){case"disabled":case"sunny":case"cloudy":return new O(1,1);case"rainy":return new O(.4,1.2);case"snowy":return new O(.5,1.3);case"foggy":return new O(.2,1.6)}}function R(t,e){const i=(t[0]+t[1]+t[2])/3;t[0]+=(i-t[0])*e,t[1]+=(i-t[1])*e,t[2]+=(i-t[2])*e}const U=w(.01,.01,.01),G=w(1,.6,.5),_=w(1,.98,.98),k=w(1,1,1),C=w(.8,.8,1),$=w(.8,.8,1),q=w(.98,.98,1),B=w(1,1,1),J=m(.01,x.local.ambientAtNight),K=m(x.local.directAtTwilight,x.local.ambientAtTwilight),Q=m(.9*x.local.directAtNoon,x.local.ambientAtNoon),V=m(x.local.directAtNoon,x.local.ambientAtNoon),W=Q,X=_,Y=q,Z=K,tt=G,et=$,it=new Date(0),ot=r(),nt=M(),at=M(),st=M(),lt=.25,rt=.2;export{I as C,j as a,S as b,D as c,z as d};
