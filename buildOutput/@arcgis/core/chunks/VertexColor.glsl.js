/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{s as o,k as e,e as t,c as r,n}from"./vec3.js";import{c as a}from"./vec3f64.js";import{D as i,B as s}from"./BufferView.js";import{A as c,c as l,B as d}from"./aaBoundingBox.js";import{ag as f,c as m,N as u,ah as v,ai as p,B as h}from"./Matrix4PassUniform.js";import{I as w,g as F}from"./glsl.js";import{U as M,d as W,l as V,m as x}from"./Emissions.glsl.js";import{c as T}from"./mat3f64.js";import{c as R}from"./mat4f64.js";class C{constructor(o=!1,e=!0){this.isVerticalRay=o,this.normalRequired=e}}const g=l();function y(e,t,r,n,a,s){if(!e.visible)return;const c=o(G,n,r),l=(o,e,t)=>{s(o,t,e)},d=new C(!1,t.options.normalRequired);if(e.boundingInfo){i(0===e.type);const o=t.tolerance;b(e.boundingInfo,r,c,o,a,d,l)}else{const o=e.attributes.get("position"),t=o.indices;S(r,c,0,t.length/3,t,o.data,o.stride,a,d,l)}}const P=a();function b(o,t,r,n,a,i,s){if(null==o)return;const l=e(P,1/(f=r)[0],1/f[1],1/f[2]);var f;if(c(g,o.bbMin),d(g,o.bbMax),null!=a&&a.applyToAabb(g),O(g,t,l,n)){const{primitiveIndices:e,position:c}=o,l=e?e.length:c.indices.length/3;if(l>k){const e=o.getChildren();if(void 0!==e){for(const o of e)b(o,t,r,n,a,i,s);return}}!function(o,e,t,r,n,a,i,s,c,l,d){const f=o[0],m=o[1],u=o[2],v=e[0],p=e[1],h=e[2],{normalRequired:w}=l;for(let o=0;o<r;++o){const e=s[o],t=3*e,r=i*n[t];let l=a[r],F=a[r+1],M=a[r+2];const W=i*n[t+1];let V=a[W],x=a[W+1],T=a[W+2];const R=i*n[t+2];let C=a[R],g=a[R+1],y=a[R+2];null!=c&&([l,F,M]=c.applyToVertex(l,F,M,o),[V,x,T]=c.applyToVertex(V,x,T,o),[C,g,y]=c.applyToVertex(C,g,y,o));const P=V-l,b=x-F,L=T-M,j=C-l,B=g-F,S=y-M,_=p*S-B*h,q=h*j-S*v,A=v*B-j*p,z=P*_+b*q+L*A;if(Math.abs(z)<=E)continue;const I=f-l,$=m-F,N=u-M,O=I*_+$*q+N*A;if(z>0){if(O<0||O>z)continue}else if(O>0||O<z)continue;const U=$*L-b*N,k=N*P-L*I,G=I*b-P*$,J=v*U+p*k+h*G;if(z>0){if(J<0||O+J>z)continue}else if(J>0||O+J<z)continue;const K=(j*U+B*k+S*G)/z;K>=0&&d(K,e,w?H(P,b,L,j,B,S,D):null)}}(t,r,0,l,c.indices,c.data,c.stride,e,a,i,s)}}const D=a();function L(e,t,r,n,a,i,s,c,l){const{data:d,stride:f}=i;S(e,o(G,t,e),r,n,a,d,f,s,c,l)}function j(o,e,t,r,n,a,i,s,c,l=null,d=0){const f=o[0],m=o[1],u=o[2],v=e[0],p=e[1],h=e[2];for(let o=t;o<r;++o){const e=d+(l?l[o]:o),t=3*e,r=i*n[t],w=a[r],F=a[r+1],M=a[r+2],W=i*n[t+1],V=a[W],x=a[W+1],T=a[W+2],R=i*n[t+2],C=V-w,g=x-F,y=T-M,P=a[R]-w,b=a[R+1]-F,L=a[R+2]-M,j=p*L-b*h,B=h*P-L*v,S=v*b-P*p,_=C*j+g*B+y*S;if(Math.abs(_)<=E)continue;const q=f-w,A=m-F,z=u-M,I=q*j+A*B+z*S;if(_>0){if(I<0||I>_)continue}else if(I>0||I<_)continue;const $=A*y-g*z,N=z*C-y*q,O=q*g-C*A,U=v*$+p*N+h*O;if(_>0){if(U<0||I+U>_)continue}else if(U>0||I+U<_)continue;const k=(P*$+b*N+L*O)/_;k>=0&&c(k,e,s?H(C,g,y,P,b,L,D):null)}}function B(o,e,t,r,n,a,i,s,c,l,d,f=null,m=0){const u=o[0],v=o[1],p=o[2],h=e[0],w=e[1],F=e[2];for(let o=t;o<r;++o){const e=m+(f?f[o]:o),t=3*e,r=i*n[t],M=a[r],W=a[r+1],V=a[r+2],x=i*n[t+1],T=a[x],R=a[x+1],C=a[x+2],g=i*n[t+2],y=a[g],P=a[g+1],b=a[g+2],L=V-c,j=s/Math.sqrt(M*M+W*W+L*L),B=M+M*j,S=W+W*j,_=V+L*j,q=C-c,A=s/Math.sqrt(T*T+R*R+q*q),z=T+T*A,I=R+R*A,$=C+q*A,N=b-c,O=s/Math.sqrt(y*y+P*P+N*N),U=z-B,k=I-S,G=$-_,J=y+y*O-B,K=P+P*O-S,Q=b+N*O-_,X=w*Q-K*F,Y=F*J-Q*h,Z=h*K-J*w,oo=U*X+k*Y+G*Z;if(Math.abs(oo)<=E)continue;const eo=u-B,to=v-S,ro=p-_,no=eo*X+to*Y+ro*Z;if(oo>0){if(no<0||no>oo)continue}else if(no>0||no<oo)continue;const ao=to*G-k*ro,io=ro*U-G*eo,so=eo*k-U*to,co=h*ao+w*io+F*so;if(oo>0){if(co<0||no+co>oo)continue}else if(co>0||no+co<oo)continue;const lo=(J*ao+K*io+Q*so)/oo;lo>=0&&d(lo,e,l?H(U,k,G,J,K,Q,D):null)}}function S(r,n,a,i,s,c,l,d,f,m){const u=n,v=J,p=Math.abs(u[0]),h=Math.abs(u[1]),w=Math.abs(u[2]),F=p>=h?p>=w?0:2:h>=w?1:2,M=F,W=u[M]<0?2:1,V=(F+W)%3,x=(F+(3-W))%3,T=u[V]/u[M],R=u[x]/u[M],C=1/u[M],g=_,y=q,P=A,{normalRequired:b}=f;for(let n=a;n<i;++n){const a=3*n,i=l*s[a];e(v[0],c[i+0],c[i+1],c[i+2]);const f=l*s[a+1];e(v[1],c[f+0],c[f+1],c[f+2]);const u=l*s[a+2];e(v[2],c[u+0],c[u+1],c[u+2]),d&&(t(v[0],d.applyToVertex(v[0][0],v[0][1],v[0][2],n)),t(v[1],d.applyToVertex(v[1][0],v[1][1],v[1][2],n)),t(v[2],d.applyToVertex(v[2][0],v[2][1],v[2][2],n))),o(g,v[0],r),o(y,v[1],r),o(P,v[2],r);const p=g[V]-T*g[M],h=g[x]-R*g[M],w=y[V]-T*y[M],F=y[x]-R*y[M],W=P[V]-T*P[M],D=P[x]-R*P[M],L=W*F-D*w,j=p*D-h*W,B=w*h-F*p;if((L<0||j<0||B<0)&&(L>0||j>0||B>0))continue;const S=L+j+B;if(0===S)continue;const _=L*(C*g[M])+j*(C*y[M])+B*(C*P[M]);if(_*Math.sign(S)<0)continue;const q=_/S;q>=0&&m(q,n,b?z(v):null)}}const _=a(),q=a(),A=a();function H(o,t,a,i,s,c,l){return e(I,o,t,a),e($,i,s,c),r(l,I,$),n(l,l),l}function z(e){return o(I,e[1],e[0]),o($,e[2],e[0]),r(D,I,$),n(D,D),D}const I=a(),$=a();function N(o,t,r){return e(r,1/(t[0]-o[0]),1/(t[1]-o[1]),1/(t[2]-o[2]))}function O(o,e,t,r){return U(o,e,t,r,1/0)}function U(o,e,t,r,n){const a=(o[0]-r-e[0])*t[0],i=(o[3]+r-e[0])*t[0];let s=Math.min(a,i),c=Math.max(a,i);const l=(o[1]-r-e[1])*t[1],d=(o[4]+r-e[1])*t[1];if(c=Math.min(c,Math.max(l,d)),c<0)return!1;if(s=Math.max(s,Math.min(l,d)),s>c)return!1;const f=(o[2]-r-e[2])*t[2],m=(o[5]+r-e[2])*t[2];return c=Math.min(c,Math.max(f,m)),!(c<0)&&(s=Math.max(s,Math.min(f,m)),!(s>c)&&s<n)}const k=1e3,E=1e-7,G=a(),J=[a(),a(),a()];class K{constructor(o){this.layout=o}elementCount(o){return o.get("position").indices.length}write(o,e,t,r,n,a){return f(t,r,this.layout,o,e,n,a)}intersect(e,t,r,n,a,i,c){const l=this.layout.createView(e).getField("position",s);if(null==l)return;const d=o(Q,i,a),f=l.count/3,m=n.options.normalRequired;!function(o,e,t,r,n,a,i,s){const c=o[0],l=o[1],d=o[2],f=e[0],m=e[1],u=e[2];for(let o=0;o<r;++o){const e=3*o,t=e+1,r=e+2,v=a*e,p=n[v],h=n[v+1],w=n[v+2],F=a*t,M=a*r,W=n[F]-p,V=n[F+1]-h,x=n[F+2]-w,T=n[M]-p,R=n[M+1]-h,C=n[M+2]-w,g=m*C-R*u,y=u*T-C*f,P=f*R-T*m,b=W*g+V*y+x*P;if(Math.abs(b)<=E)continue;const L=c-p,j=l-h,B=d-w,S=L*g+j*y+B*P;if(b>0){if(S<0||S>b)continue}else if(S>0||S<b)continue;const _=j*x-V*B,q=B*W-x*L,A=L*V-W*j,z=f*_+m*q+u*A;if(b>0){if(z<0||S+z>b)continue}else if(z>0||S+z<b)continue;const I=(T*_+R*q+C*A)/b;I>=0&&s(I,o,i?H(W,V,x,T,R,C,D):null)}}(a,d,0,f,l.typedBuffer,l.typedBufferStride,m,(o,e,t)=>c(o,t,e))}}const Q=a();function X(o){o.varyings.add("linearDepth","float",{invariant:!0})}function Y(o,e){X(o),o.vertex.code.add(F`
    void forwardLinearDepth(float _linearDepth) { ${w(e,"linearDepth = _linearDepth;")} }
  `)}function Z({code:o,uniforms:e},t){e.add(new m("dpDummy",()=>1)),o.add(F`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 hiD = hiA + hiB;
vec3 loD = loA + loB;
return  dpDummy * hiD + loD;
}`)}class oo extends M{constructor(o,e,t){super(o,"mat3",2,(r,n,a)=>r.setUniformMatrix3fv(o,e(n,a),t))}}function eo(o,e){const{attributes:t,vertex:r,varyings:n,fragment:a}=o;r.include(Z,e),t.add("position","vec3"),n.add("vPositionWorldCameraRelative","vec3"),n.add("vPosition_view","vec3",{invariant:!0}),r.uniforms.add(new W("transformWorldFromViewTH",o=>o.transformWorldFromViewTH),new W("transformWorldFromViewTL",o=>o.transformWorldFromViewTL),new v("transformViewFromCameraRelativeRS",o=>o.transformViewFromCameraRelativeRS),new p("transformProjFromView",o=>o.transformProjFromView),new oo("transformWorldFromModelRS",o=>o.transformWorldFromModelRS),new V("transformWorldFromModelTH",o=>o.transformWorldFromModelTH),new V("transformWorldFromModelTL",o=>o.transformWorldFromModelTL)),r.code.add(F`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}`),r.code.add(F`
    void forwardPosition(float fOffset) {
      vPositionWorldCameraRelative = positionWorldCameraRelative();
      if (fOffset != 0.0) {
        vPositionWorldCameraRelative += fOffset * ${e.spherical?F`normalize(transformWorldFromViewTL + vPositionWorldCameraRelative)`:F`vec3(0.0, 0.0, 1.0)`};
      }

      vPosition_view = transformViewFromCameraRelativeRS * vPositionWorldCameraRelative;
      gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
    }
  `),a.uniforms.add(new W("transformWorldFromViewTL",o=>o.transformWorldFromViewTL)),r.code.add(F`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),a.code.add(F`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)}class to extends u{constructor(){super(...arguments),this.transformWorldFromViewTH=a(),this.transformWorldFromViewTL=a(),this.transformViewFromCameraRelativeRS=T(),this.transformProjFromView=R()}}class ro extends u{constructor(){super(...arguments),this.transformWorldFromModelRS=T(),this.transformWorldFromModelTH=a(),this.transformWorldFromModelTL=a()}}function no(o){o.vertex.uniforms.add(new h("nearFar",o=>o.camera.nearFar))}function ao(o){o.vertex.code.add(F`float calculateLinearDepth(vec2 nearFar,float z) {
return (-z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)}function io(o,e){const{vertex:t}=o,r=x(e.output);r&&(o.include(eo,e),Y(o,!0),no(o),ao(o)),t.code.add(F`
    void forwardLinearDepthToWriteShadowMap() {
      ${w(r,"forwardLinearDepth(calculateLinearDepth(nearFar, vPosition_view.z));")}
    }
  `)}function so(o){ao(o),o.vertex.code.add(F`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = calculateLinearDepth(nearFar,eye.z);
return proj * eye;
}`),o.vertex.code.add(F`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}function co(o,e){e.hasVertexColors?(o.attributes.add("color","vec4"),o.varyings.add("vColor","vec4"),o.vertex.code.add(F`void forwardVertexColor() { vColor = color; }`),o.vertex.code.add(F`
      void forwardNormalizedVertexColor() { vColor = color * ${F.float(1/255)}; }
    `)):o.vertex.code.add(F`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}export{K as D,Y as F,C as M,so as T,co as V,to as a,ro as b,oo as c,Z as d,no as e,L as f,O as g,U as h,y as i,j,X as k,B as l,N as m,eo as n,io as o};
