/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{h as e}from"../core/lang.js";import{L as t}from"./Logger.js";import{r}from"./string.js";import{c as n,f as i}from"./date.js";import{f as o,c as a}from"./number.js";import{isRasterPixelValueField as s,featureHasFields as l,isTimeOnlyField as u,l as f}from"../layers/support/fieldUtils.js";import{g as c}from"./layerUtils.js";import{f as p,i as d}from"./utils7.js";import{g as m}from"./timeZoneUtils.js";import"../config.js";import"./object.js";import"./jsonMap.js";import"./locale.js";import"./handleUtils.js";import"./constants.js";import"./datetime.js";import"../core/Error.js";import"./SetUtils.js";import"../core/sql.js";import"./maybe.js";import"./guards.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"../request.js";import"./MapUtils.js";import"../core/promiseUtils.js";import"./events.js";import"./persistableUrlUtils.js";import"../core/Collection.js";import"./tslib.es6.js";import"./watch.js";import"./ObjectPool.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./get.js";import"./utils.js";import"./Lifecycle.js";import"./tracking.js";import"./SimpleTrackingTarget.js";import"../core/Evented.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./ensureType.js";import"./Warning.js";import"./ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"./shared.js";import"./SimpleObservable.js";import"../layers/catalog/catalogUtils.js";import"../core/reactiveUtils.js";import"./basemapUtils.js";import"./utils5.js";import"./colorUtils.js";import"./screenUtils.js";import"./mat4.js";import"./common.js";import"./basemapDefinitions.js";import"./assets.js";import"./messages.js";const y=()=>t.getLogger("esri.widgets.Feature.support.featureUtils"),b=/href=(""|'')/gi,g=/(\{([^{\r\n]+)\})/g,j=/'/g,h=/^\s*expression\//i,I=/(\n)/gi,T=/[\u00A0-\u9999<>&]/gim,w=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,F=/^(?:mailto:|tel:)/,U="relationships/",N=n("short-date-short-time");function v(e){if(null!=e)return(e.sourceLayer||e.layer)??void 0}async function L({type:e,value:t,event:r}){try{return"function"==typeof t?t(r):await t}catch(n){return void y().error("error",`An error occurred when calling the "${e}" function`,{error:n,graphic:r.graphic,value:t})}}function Z(e=""){if(e)return!F.test(e.trim().toLowerCase())}function q(e){return!!e&&h.test(e)}function x(e,t){const r=function(e,t){if(!t||!q(t)||!e)return;const r=t.replace(h,"").toLowerCase();return e.find(({name:e})=>e.toLowerCase()===r)}(t,e?.fieldName);return r?r.title||null:e?e.label||e.fieldName:null}function E(e,t){const r=A(t,e);return r?r.name:e}function k(e,t){return e&&e.map(e=>E(e,t))}function A(e,t){return e&&"function"==typeof e.getField&&t?e.getField(t)??null:null}function C(e){return`${e}`.trim()}function M({attributes:e,globalAttributes:t,layer:r,text:n,expressionAttributes:i,fieldInfoMap:o}){return n?R({formattedAttributes:t,template:S(n,{...t,...i,...e},r),fieldInfoMap:o}):""}function R({formattedAttributes:e,template:t,fieldInfoMap:n}){return C((i=r(r(t,e=>function(e,t){const r=t.get(e.toLowerCase());return`{${r?.fieldName||e}}`}(e,n)),e),i.replaceAll(b,"")));var i}function D(e,t){return e.replaceAll(g,(e,r,n)=>{const i=A(t,n);return i?`{${i.name}}`:r})}function S(e,t,n){const i=D(e,n);return i?i.replaceAll(w,(e,n,i)=>function(e,t,n){const i=(t=C(t))&&!t.startsWith("{");return r(e,function(e,t=!1){const r={...e};return Object.keys(r).forEach(e=>function(e,t,r=!1){const n=t[e];if("string"==typeof n){const i="%27",o=(r?encodeURIComponent(n):n).replaceAll(j,i);t[e]=o}}(e,r,t)),r}(n,i||!1))}(e,n||i,t)):i}function $(e){return null!=e&&"object"==typeof e&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&("feature"===e.type||"scene"===e.type||"subtype-group"===e.type||"subtype-sublayer"===e.type||"sublayer"===e.type)&&"when"in e}function O(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function z(e){return $(e)&&O(e)}function G(e){return!(!(e&&"object"==typeof e&&"createQuery"in e&&"getField"in e&&"queryFeatureCount"in e&&"queryFeatures"in e&&"queryObjectIds"in e&&"capabilities"in e&&"fields"in e&&"fieldsIndex"in e&&"type"in e)||"feature"!==e.type&&"subtype-group"!==e.type&&"subtype-sublayer"!==e.type&&"sublayer"!==e.type||!("when"in e))&&("subtype-sublayer"===e.type&&"parent"in e&&e.parent&&"object"==typeof e.parent?"globalIdField"in e.parent:"globalIdField"in e)}function P(e){return!!e&&"object"==typeof e&&"sourceLayer"in e&&z(e.sourceLayer)}function Q(e,t){const{fieldInfos:r,fieldName:n,preventPlacesFormatting:i,layer:l,timeZone:u}=t,f=_(r,n),c=A(l,n);if(f&&!s(n)){const t=c?.type,r=f.format?.dateFormat;if("date"===t||"date-only"===t||"time-only"===t||"timestamp-offset"===t||r)return p(e,{format:r,fieldType:t,timeZoneOptions:{layerTimeZone:l&&"preferredTimeZone"in l?l.preferredTimeZone:null,viewTimeZone:u,datesInUnknownTimezone:!(!l||!("datesInUnknownTimezone"in l)||!l.datesInUnknownTimezone)}})}const d=f?.format;return"string"==typeof e&&s(n)&&d?function(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?H(e,",",", ",t):e.includes(";")?H(e,";","; ",t):e.includes(" ")?H(e," "," ",t):o(Number(e),a(t))}(e,d):(e=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}(e,d),"string"==typeof e||null==e||null==d?V(e):o(e,i?{...a(d),minimumFractionDigits:0,maximumFractionDigits:20}:a(d)))}function H(e,t,r,n){return e.trim().split(t).map(e=>o(Number(e),a(n))).join(r)}function _(e,t){if(e?.length&&t)return e.find(e=>e.fieldName?.toLowerCase()===t.toLowerCase())}function W(e,t,r,n){const{creatorField:o,creationDateField:a,editorField:s,editDateField:l}=e;if(!t)return;const u=m(n&&"preferredTimeZone"in n?n.preferredTimeZone:null,!(!n||!("datesInUnknownTimezone"in n)||!n.datesInUnknownTimezone),r,N,"date"),f={...N,...u},c=t[l];if("number"==typeof c){const e=t[s];return{type:"edit",date:i(c,f),user:e}}const p=t[a];if("number"==typeof p){const e=t[o];return{type:"create",date:i(p,f),user:e}}return null}function B(e,t){const r=new Map;if(!e)return r;for(const n of e){if(!n.fieldName)continue;const e=E(n.fieldName,t);n.fieldName=e,r.set(e.toLowerCase(),n)}return r}function J(e){const t=[];if(!e)return t;const{fieldInfos:r,content:n}=e;return r&&t.push(...r),n&&Array.isArray(n)?(n.forEach(e=>{if("fields"===e.type){const r=e?.fieldInfos;r&&t.push(...r)}}),t):t}function K(e){return e.replaceAll(T,e=>`&#${e.charCodeAt(0)};`)}function V(e){return"string"==typeof e?e.replaceAll(I,'<br class="esri-text-new-line" />'):e}function X(t){const{value:r,fieldName:n,fieldInfos:i,fieldInfoMap:o,layer:a,graphic:s,timeZone:l}=t;if(null==r)return"";const f=function({fieldName:t,value:r,graphic:n,layer:i}){if(re(t))return null;if(!i||"function"!=typeof i.getFieldDomain)return null;const o=n&&i.getFieldDomain(t,{feature:n,excludeImpliedDomains:e("esri-widget-legacy-field-domain-calculation")});return o&&"coded-value"===o.type?o.getName(r):null}({fieldName:n,value:r,graphic:s,layer:a});if(f)return f;const c=function({fieldName:e,graphic:t,layer:r}){if(re(e))return null;if(!r||"function"!=typeof r.getFeatureType)return null;const{typeIdField:n}=r;if(!n||e!==n)return null;const i=r.getFeatureType(t);return i?i.name:null}({fieldName:n,graphic:s,layer:a});if(c)return c;if(o.get(n.toLowerCase()))return Q(r,{fieldInfos:i||Array.from(o.values()),fieldName:n,layer:a,timeZone:l});const m=a?.fieldsIndex?.get(n);return m&&(d(m)||u(m))?p(r,{fieldType:m.type,timeZoneOptions:{layerTimeZone:a&&"preferredTimeZone"in a?a.preferredTimeZone:null,viewTimeZone:l,datesInUnknownTimezone:!(!a||!("datesInUnknownTimezone"in a)||!a.datesInUnknownTimezone)}}):V(r)}function Y({fieldInfos:e,attributes:t,layer:r,graphic:n,fieldInfoMap:i,relatedInfos:o,timeZone:a}){const s={};return o?.forEach(t=>function({attributes:e,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:i,timeZone:o}){e&&t&&(t.relatedFeatures?.forEach(a=>ne({attributes:e,graphic:a,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:i,timeZone:o})),t.relatedStatsFeatures?.forEach(a=>ne({attributes:e,graphic:a,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:i,timeZone:o})))}({attributes:s,relatedInfo:t,fieldInfoMap:i,fieldInfos:e,layer:r,timeZone:a})),t&&Object.keys(t).forEach(o=>{const l=t[o];s[o]=X({fieldName:o,fieldInfos:e,fieldInfoMap:i,layer:r,value:l,graphic:n,timeZone:a})}),s}async function ee(e,t){const{layer:r,graphic:n,outFields:i,objectIds:o,returnGeometry:a,spatialReference:s}=e,l=o[0];if("number"!=typeof l&&"string"!=typeof l){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:r,graphic:n,objectId:l,requiredFields:i};return y().warn(e,t),null}if(!c(r)?.operations?.supportsQuery){const e="The specified layer cannot be queried. The following fields will not be available.",t={layer:r,graphic:n,requiredFields:i,returnGeometry:a};return y().warn(e,t),null}const u=r.createQuery();return u.objectIds=o,u.outFields=i?.length?i:[r.objectIdField],u.returnGeometry=!!a,u.returnZ=!!a,u.returnM=!!a,u.outSpatialReference=s,(await r.queryFeatures(u,t)).features[0]}async function te({graphic:e,popupTemplate:t,layer:r,spatialReference:n},i){if(!r||!t)return;if("function"==typeof r.load&&await r.load(i),!e.attributes)return;const o=r.objectIdField,a=e.attributes[o];if(null==a)return;const s=[a],u=new Set(await t.getRequiredFields(r.fieldsIndex));null==r.timeInfo?.trackIdField||u.has(r.timeInfo.trackIdField)||await async function(e){if(!e.expressionInfos?.length)return!1;const t=await f(),{arcadeUtils:{requiresTrack:r}}=t;return r(e)}(t)&&u.add(r.timeInfo.trackIdField);const c=l(e,u),p=c?[]:u.has(o)?[...u]:[...u,o],d=t.returnGeometry||await async function(e){if(!e.expressionInfos?.length)return!1;const t=await f(),{arcadeUtils:{hasGeometryFunctions:r}}=t;return r(e)}(t);if(c&&!d)return;const m=await ee({layer:r,graphic:e,outFields:p,objectIds:s,returnGeometry:d,spatialReference:n},i);m&&(m.geometry&&(e.geometry=m.geometry),m.attributes&&(e.attributes={...e.attributes,...m.attributes}))}function re(e=""){return!!e&&e.includes(U)}function ne({attributes:e,graphic:t,relatedInfo:r,fieldInfos:n,fieldInfoMap:i,layer:o,timeZone:a}){e&&t&&r&&Object.keys(t.attributes).forEach(s=>{const l=(u={layerId:r.relation.id.toString(),fieldName:s})?`${U}${u.layerId}/${u.fieldName}`:"";var u;const f=t.attributes[s];e[l]=X({fieldName:l,fieldInfos:n,fieldInfoMap:i,layer:o,value:f,graphic:t,timeZone:a})})}const ie=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},oe=({layer:e,method:t,query:r,definitionExpression:n})=>{if(!e.capabilities?.query?.supportsCacheHint||"attachments"===t)return;const i=null!=r.where?r.where:null,o=null!=r.geometry?r.geometry:null;ie(n)||ie(i)||"extent"===o?.type||"tile"===r.resultType||(r.cacheHint=!0)},ae=({query:e,layer:t,method:r})=>{oe({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},se=({queryPayload:e,layer:t,method:r})=>{oe({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})};function le(e,t,r){return e&&t&&r?"sublayer"===t.type?ce({layers:t.layer?.allSublayers,map:e,relatedLayer:t,relationship:r})||ce({layers:t.layer?.subtables,map:e,relatedLayer:t,relationship:r}):ce({layers:e.allLayers,map:e,relatedLayer:t,relationship:r})||ce({layers:e.allTables,map:e,relatedLayer:t,relationship:r}):null}function ue(e,t){return e&&"utilityNetworks"in e&&t?e.utilityNetworks?.find(e=>e.isUtilityLayer(t)):null}function fe(e,t){return e?.allTables.find(e=>"feature"===e.type&&e.layerId===t.id&&e.url===t.layer?.url)}function ce({map:e,relationship:t,relationship:{relatedTableId:r},relatedLayer:n,layers:i}){if(!i)return null;for(const o of i){if("map-image"===o.type){const r=ce({layers:o.sublayers,map:e,relatedLayer:n,relationship:t})||ce({layers:o.subtables,map:e,relatedLayer:n,relationship:t});if(r)return r;continue}if(!z(o))continue;if("sublayer"===n.type){if(o!==n&&o.id===r)return o.isTable?fe(e,o):o;continue}const i="scene"===n.type&&n.associatedLayer?n.associatedLayer.url:n.url;if(!i)return null;if("sublayer"!==o.type){if(o!==n&&o.url===i&&o.layerId===r)return o}else if(o!==n&&o.layer?.url===i&&o.id===r)return o.isTable?fe(e,o):o}return null}export{V as applyTextFormattingHTML,B as createFieldInfoMap,le as findRelatedLayer,ue as findUtilityNetwork,D as fixTokens,Y as formatAttributes,W as formatEditInfo,Q as formatValueToFieldInfo,J as getAllFieldInfos,_ as getFieldInfo,x as getFieldInfoLabel,E as getFixedFieldName,k as getFixedFieldNames,v as getSourceLayer,L as graphicCallback,K as htmlEntities,G as isAssociatedFeatureSupportedLayer,q as isExpressionField,$ as isFeatureSupportedLayer,P as isGraphicForRelatableFeatureSupportedLayer,z as isRelatableFeatureSupportedLayer,O as isRelatableLayer,re as isRelatedField,ae as preLayerQueryCallback,se as preRequestCallback,ee as querySourceLayer,te as queryUpdatedFeature,Z as shouldOpenInNewTab,R as substituteAttributes,M as substituteFieldsInLinksAndAttributes};
