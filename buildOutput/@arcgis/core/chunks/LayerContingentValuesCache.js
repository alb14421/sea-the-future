/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t,{p as n}from"../request.js";import{i}from"../core/lang.js";import{JSONSupportMixin as s}from"../core/JSONSupport.js";import{Loadable as o}from"../core/Loadable.js";import{property as r}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import a from"../core/Accessor.js";import{isStringField as u,isDateField as c}from"../layers/support/fieldUtils.js";import p from"../layers/support/Subtype.js";import{u as d}from"./featureFormUtils.js";let y=class extends a{constructor(e){super(e),this.isRetired=!1}};e([r()],y.prototype,"id",void 0),e([r()],y.prototype,"isRetired",void 0),e([r()],y.prototype,"subtype",void 0),e([r()],y.prototype,"values",void 0),y=e([l("esri.layers.support.Contingency")],y);const f=y;let m=class extends a{constructor(e){super(e)}};e([r()],m.prototype,"fieldGroup",void 0),e([r()],m.prototype,"type",void 0),m=e([l("esri.layers.support.ContingencyConstraintViolation")],m);const g=m;let h=class extends a{constructor(e){super(e),this.maxValue=null,this.minValue=null,this.codedValue=null}};e([r()],h.prototype,"objectType",void 0),e([r()],h.prototype,"maxValue",void 0),e([r()],h.prototype,"minValue",void 0),e([r()],h.prototype,"codedValue",void 0),h=e([l("esri.layers.support.ContingentValue")],h);const V=h;let b=class extends a{constructor(e){super(e)}};e([r()],b.prototype,"contingentValuesAllGroups",void 0),e([r()],b.prototype,"contingentValuesByFieldGroup",void 0),b=e([l("esri.layers.support.ContingentValuesResult")],b);const j=b;let v=class extends a{constructor(e){super(e),this.fields=null,this.isEditingRestrictive=!1}};e([r()],v.prototype,"name",void 0),e([r()],v.prototype,"fields",void 0),e([r()],v.prototype,"isEditingRestrictive",void 0),e([r()],v.prototype,"contingencies",void 0),v=e([l("esri.layers.support.FieldGroup")],v);const T=v;var G;let w=G=class extends(s(o)){constructor(e){super(e),this.request=t,this.fieldGroups=null,this.fieldGroupDefinitions=null}initialize(){}get loaded(){return super.loaded}get subtypeFieldName(){return d(this.layer).typeFieldName}static async createLoadedLayerContingentValuesCache(e){await e.load();const t=e.sourceJSON;if(void 0===e.layerId)return null;const i=t?.hasContingentValuesDefinition;if(i)return new G({layer:e}).load();if(void 0===i){const t=n(e.url);if(null==t)return null;const i=t.url.path;if((await O(i)).supportsQueryDataElements){const t=e.layerId.toString(),n=await F(i,t);if(n){const t=n.map(t=>({name:t.name,isEditingRestrictive:t.isEditingRestrictive,fields:t.fieldNames.names.map(t=>e.fieldsIndex.normalizeFieldName(t))}));return new G({layer:e,fieldGroupDefinitions:t}).load()}}}return null}async load(e){const t=this.layer.load(e).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,e));return this.addResolvingPromise(t),this}validateContingencyConstraints(e,t){const n=Object.keys(e),i=[],s=[];for(const o of this.fieldGroups){const r=o.isEditingRestrictive?"error":"warning";if(t&&!o.fields.some(e=>t.includes(e)))continue;if(!o.fields.every(e=>n.includes(e))){s.push(new g({fieldGroup:o,type:r}));continue}let l=!1;const a=e[this.subtypeFieldName],u=o.contingencies.filter(e=>!(!e.isRetired&&e.subtype)||e.subtype.code===a);if(0!==u.length){for(const t of u){let n=!0;for(const i in t.values){const s=t.values[i];if("any"!==s.objectType)if("null"===s.objectType){if(null!=e[i]){n=!1;break}}else if("code"===s.objectType){if(e[i]!==s.codedValue.code){n=!1;break}}else if("range"===s.objectType){const t=e[i];if(t<s.minValue||t>s.maxValue){n=!1;break}}}if(n){l=!0;break}}l||i.push(new g({fieldGroup:o,type:r}))}}return{invalid:i,incomplete:s}}getContingentValues(e,t,n=!1){const i=e[this.subtypeFieldName],s=null!=i,o={};let r=[];const l=this.fieldGroups.filter(e=>e.fields.includes(t));r.push(new V({objectType:"any"}));for(const a of l){let l=[];const u=a.contingencies.filter(e=>!(e.isRetired||e.subtype&&s&&e.subtype.code!==i));let c=!1;const p={};for(const n of u){let i,s=!0;for(const o in n.values){const r=n.values[o];if(t!==o){if(void 0!==e[o]&&"any"!==r.objectType)if("null"===r.objectType)null!==e[o]&&(s=!1);else if("code"===r.objectType)e[o]!==r.codedValue.code&&(s=!1);else if("range"===r.objectType){const t=e[o];(t<r.minValue||t>r.maxValue)&&(s=!1)}}else i=r,c=c||"range"===r.objectType}if(i&&s){if("any"===i.objectType){l.length=0,l.push(i);break}const e=x(i);p[e]||l.push(i),p[e]=!0}}c&&(l=C(l)),o[a.name]=l,r=n?S(r,l):[]}return 1===l.length&&n&&(r=[]),new j({contingentValuesAllGroups:r,contingentValuesByFieldGroup:o})}async _initializeContingentValues(e,t){const n=e??await this._fetchFieldGroupDefs(t);if(0===n.length)return void(this.fieldGroups=[]);const i=await this._fetchContingentValues(n,t);this.fieldGroups=i}async _fetchFieldGroupDefs(e){if(void 0===this.layer.layerId)return[];const i=this.layer.sourceJSON,s=this.layer.layerId.toString(),o=n(this.layer.url).url.path;if(i?.hasContingentValuesDefinition){const n=await async function(e,n,i){return t(`${e}/${n}/fieldgroups`,{responseType:"json",query:{f:"json"},...i}).then(e=>e.data.fieldGroups??[])}(o,s,e);return n.map(e=>({name:e.name,isEditingRestrictive:e.restrictive,fields:e.fields.map(e=>this.layer.fieldsIndex.normalizeFieldName(e))}))}return void 0!==i?.hasContingentValuesDefinition?[]:O(o,e).then(async t=>t.supportsQueryDataElements?(await F(o,s,e)).map(e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names.map(e=>this.layer.fieldsIndex.normalizeFieldName(e))})):[])}async _fetchContingentValues(e,i){if(void 0===this.layer.layerId)return[];const s=this.layer.sourceJSON,o=this.layer.layerId.toString(),r=n(this.layer.url).url.path;if(s?.hasContingentValuesDefinition){const n=await async function(e,n,i){return t(`${e}/${n}/contingentValues`,{responseType:"json",query:{f:"json"},...i}).then(e=>e.data)}(r,o,i);return this._constructFieldGroupsAGOL(e,n)}const l=await async function(e,n,i){return t(`${e}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([n]),f:"json"},...i}).then(e=>e.data.contingentValueSets?.[0])}(r,o,i);return this._constructFieldGroupsEnterprise(e,l)}_constructFieldGroupsAGOL(e,t){return e.map(e=>{const n=t.contingentValuesDefinition.fieldGroups.find(t=>t.name===e.name);if(n){let i=[];return i=t.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(e,t,n.subTypes):this._parseAGOLFieldGroup(e,t,n.contingentValues),new T({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:i})}return null}).filter(i)}_parseAGOLFieldGroupSubtype(e,t,n){let i=[];return n?.forEach(n=>{const s=this._getSubtypeAGOL(n.name);i=i.concat(this._parseAGOLFieldGroup(e,t,n.contingentValues,s))}),i}_parseAGOLFieldGroup(e,t,n,i=null){const s=[];for(const o of n??[]){const n=this._parseAGOLContingency(o,e,t,i);s.push(n)}return s}_parseAGOLContingency(e,t,n,i){const s=e.id,o=!!e.retired&&1===e.retired,r={};for(let s=0,o=0;s<t.fields.length;s++){const l=t.fields[s],a=n.typeCodes[e.types[s]];if("Code"===a){let t=e.values[o];o++;const s=this._getDomain(i,l),a=this.layer.getField(l);if("string"===a?.type){const e=n.stringDicts.find(e=>e.domain===s?.name);e&&(t=e.entries[t])}const u=s?.codedValues.find(e=>e.code===t),c=new V({codedValue:u,objectType:"code"});r[l]=c}else if("Range"===a){const t=e.values[o];o++;const n=t.range[0],i=t.range[1],s=new V({minValue:n,maxValue:i,objectType:"range"});r[l]=s}else if("Any"===a){const e=new V({objectType:"any"});r[l]=e}else{const e=new V({objectType:"null"});r[l]=e}}return new f({id:s,isRetired:o,subtype:i,values:r})}_constructFieldGroupsEnterprise(e,t){const n=t.fieldGroups;return e.map(e=>{const i=n.find(t=>t.name===e.name);if(i){const n=i.contingencies.map(n=>{const i=n.id,s=n.isRetired||!1,o=this._getSubtypeEnterprise(n.subtypeCode),r={};for(let i=0;i<e.fields.length;i++){const s=e.fields[i];let l=n.values[i];if("number"==typeof l||"string"==typeof l){const e=this._getDomain(o,s),n=this.layer.getField(s);if(u(n))l=t.stringDictionary[l];else if(c(n)){const e=new Date(`${l}+00:00`);l=e.getTime()}const i=e?.codedValues.find(e=>e.code===l),a=new V({codedValue:i,objectType:"code"});r[s]=a}else if("object"==typeof l){const e=l.minValue,t=l.maxValue,n=new V({minValue:e,maxValue:t,objectType:"range"});r[s]=n}else if(l){const e=new V({objectType:"any"});r[s]=e}else{const e=new V({objectType:"null"});r[s]=e}}return new f({id:i,isRetired:s,subtype:o,values:r})});return new T({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:n})}return null}).filter(i)}_getSubtypeEnterprise(e){const t=this.layer.sourceJSON;let n;if(t?.subtypes){const i=t.subtypes.find(t=>t.code===e);n=p.fromJSON(i)}return n||null}_getSubtypeAGOL(e){const t=this.layer.sourceJSON;let n;if(t?.subtypes){const i=t.subtypes.find(t=>t.name===e);n=p.fromJSON(i)}return n||null}_getDomain(e,t){const n=e?function(e,t){const n=e.domains;if(n){const[e,i]=Object.entries(n).find(([e])=>e.trim().toLowerCase()===t.trim().toLowerCase())||[];return i||null}return null}(e,t):this.layer.getFieldDomain(t);return"inherited"===n?.type?this.layer.getFieldDomain(t):n}};function x(e){switch(e.objectType){case"any":return"@any@";case"null":return"@null@";case"code":return e.codedValue.name+e.codedValue.code.toString();case"range":return e.minValue.toString()+"-"+e.maxValue.toString()}}function C(e){let t,n;e.sort((e,t)=>"null"===e.objectType?-1:"null"===t.objectType?1:e.minValue-t.minValue);const i=[];for(const s of e)"null"!==s.objectType?null!=t&&null!=n?n<s.minValue?(i.push(new V({objectType:"range",minValue:t,maxValue:n})),t=s.minValue,n=s.maxValue):n<s.maxValue&&(n=s.maxValue):(t=s.minValue,n=s.maxValue):i.push(s);return i.push(new V({objectType:"range",minValue:t,maxValue:n})),i}function S(e,t){if(0===e.length||0===t.length)return[];if("any"===e[0].objectType)return t;if("any"===t[0].objectType)return e;const n="range"===e[0].objectType||"range"===e[1]?.objectType,i="range"===t[0].objectType||"range"===t[1]?.objectType;return n||i?function(e,t){const n=[];let i,s=0;for(const o of e)for(;s<t.length;s++){const e=t[s];if("null"===o.objectType&&"null"===e.objectType)n.push(new V({objectType:"null"}));else{if("null"===o.objectType)break;if("null"===e.objectType)continue}if(o.maxValue<e.minValue)break;if(o.maxValue===e.minValue){n.push(new V({objectType:"range",minValue:o.maxValue,maxValue:e.minValue}));break}if(!(o.minValue>e.maxValue))if(o.minValue!==e.maxValue){if(i=o.minValue>e.minValue?o.minValue:e.minValue,o.maxValue<e.maxValue){n.push(new V({objectType:"range",minValue:i,maxValue:o.maxValue}));break}n.push(new V({objectType:"range",minValue:i,maxValue:e.maxValue}))}else n.push(new V({objectType:"range",minValue:o.minValue,maxValue:e.maxValue}))}return n}(e,t):function(e,t){const n=[];for(const i of e)t.some(e=>{if(i.objectType===e.objectType)switch(i.objectType){case"any":case"null":return!0;case"code":return i.codedValue.code===e.codedValue.code&&i.codedValue.name===e.codedValue.name}return!1})&&n.push(i);return n}(e,t)}async function F(e,n,i){return t(`${e}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([n]),f:"json"},...i}).then(e=>e.data.layerDataElements?.[0].dataElement.fieldGroups??[])}async function O(e,n){return t(e,{responseType:"json",query:{f:"json"},...n}).then(e=>e.data)}e([r({constructOnly:!0})],w.prototype,"layer",void 0),e([r({constructOnly:!0})],w.prototype,"request",void 0),e([r({type:[T]})],w.prototype,"fieldGroups",void 0),e([r({constructOnly:!0})],w.prototype,"fieldGroupDefinitions",void 0),e([r()],w.prototype,"subtypeFieldName",null),w=G=e([l("esri.layers.support.LayerContingentValuesCache")],w);const _=w;export{V as C,_ as L};
