/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as i}from"./tslib.es6.js";import t from"../Color.js";import s from"../core/Accessor.js";import{i as e}from"../core/lang.js";import{m as r,d as o}from"./handleUtils.js";import{watch as h,syncAndInitial as a}from"../core/reactiveUtils.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import{initializeProjection as n,project as c}from"./projectionUtils.js";import{G as g}from"./GraphicsCollection.js";import m from"../symbols/SimpleFillSymbol.js";import d from"../symbols/SimpleLineSymbol.js";import u from"../symbols/SimpleMarkerSymbol.js";import{g as y}from"./highlightUtils.js";let w=class extends s{get updating(){return this.graphicsView?.updating??!1}constructor(i){super(i),this._highlightCounts=new Map,this._graphicsViewLoader=null,this.graphics=new g,this.graphicsView=null,this.suspended=!1;const s=new t([255,255,255,1/255]);this._symbols=new Map([["point",new u({size:"2px",style:"square",color:s})],["polyline",new d({width:"2px",color:s})],["polygon",new m({outline:null,color:s})]])}highlight(i,t){const s=y(i);if(0===s.length)return r();let e,o=!1;return this.updatingHandles.addPromise(Promise.all([this._createHighlightGraphics(s),this._ensureGraphicsView3D()]).then(([i,s])=>{!o&&s&&(e=this._addHighlightGraphics(s,i,t))})),r(()=>{o=!0,e?.remove()})}preload(){this._ensureGraphicsView3D()}_addHighlightGraphics(i,t,s){for(const i of t)this._highlightCounts.set(i,(this._highlightCounts.get(i)??0)+1);this.graphics.addMany(t);const e=i.highlight(t,s);return r(()=>{this._removeHighlightGraphics(t),e.remove()})}_removeHighlightGraphics(i){this.graphics.removeMany(i.filter(i=>{const t=Math.max(0,(this._highlightCounts.get(i)??0)-1);return 0===t?(this._highlightCounts.delete(i),!0):(this._highlightCounts.set(i,t),!1)}))}async _ensureGraphicsView3D(){if(this.graphicsView)return this.graphicsView;this._graphicsViewLoader||(this._graphicsViewLoader=import("./GraphicsView3D.js"));const{default:i}=await this._graphicsViewLoader;if(this.destroyed)return null;const t=new i({view:this.view,layer:this.layer,getGraphics:()=>this.graphics,drapeSourcePriorityOffset:.5});return this._set("graphicsView",t),this.addHandles([o(this.graphicsView),h(()=>this.suspended,i=>{t.suspended=i},a)]),t}async _createHighlightGraphics(i){const t=i.map(({geometry:i})=>i?.spatialReference).filter(e).reduce((i,t)=>(0!==i.length&&i.at(-1)?.equals(t)||i.push(t),i),[]),s=this.view.spatialReference,r=t.map(i=>({source:i,dest:s}));try{await n(r)}catch{return[]}return i.map(i=>{const{geometry:t}=i;try{const e=t?c(t,s):null,r=i.cloneShallow();return r.geometry=e,r.symbol=this._symbols.get(e?.type),r}catch{return i}})}};i([p()],w.prototype,"graphics",void 0),i([p()],w.prototype,"graphicsView",void 0),i([p()],w.prototype,"view",void 0),i([p()],w.prototype,"layer",void 0),i([p()],w.prototype,"updatingHandles",void 0),i([p()],w.prototype,"suspended",void 0),i([p()],w.prototype,"updating",null),w=i([l("esri.views.3d.layers.support.ImageHighlightHelper3D")],w);export{w as I};
