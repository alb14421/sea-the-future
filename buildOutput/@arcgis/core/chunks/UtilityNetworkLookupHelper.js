/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import o from"../core/Error.js";import{LoadableMixin as s}from"../core/Loadable.js";import{g as t}from"./MapUtils.js";import{EsriPromise as r}from"../core/Promise.js";import{throwIfAborted as u}from"../core/promiseUtils.js";import{R as i}from"./ReactiveMap.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./Logger.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import{b as p}from"./layerUtils.js";import"./object.js";import"./maybe.js";import"./Warning.js";import"../config.js";import"./string.js";import"../core/Accessor.js";import"../core/Handles.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"./Lifecycle.js";import"./metadata.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./tracking.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"./ensureType.js";import"./events.js";import"./SimpleObservable.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"../request.js";import"./persistableUrlUtils.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"../layers/catalog/catalogUtils.js";import"../core/reactiveUtils.js";let l=class extends(s(r)){constructor(e){super(e),this.layerIdToSourceIdLookup=new i,this.sourceIdToLayerIdLookup=new i,this.sourceIdToNetworkInfo=new i,this._rulesBySourceId=new Map,this._terminalConfigurationsBySourceId=new Map}async load(e){return this.addResolvingPromise(this._load(e)),this}agatFromRule(e,o){let s;switch(o){case"to":s={networkSource:e.toNetworkSource??null,assetGroup:e.toAssetGroup??null,assetType:e.toAssetType??null};break;case"from":s={networkSource:e.fromNetworkSource??null,assetGroup:e.fromAssetGroup??null,assetType:e.fromAssetType??null};break;case"via":s={networkSource:e.viaNetworkSource??null,assetGroup:e.viaAssetGroup??null,assetType:e.viaAssetType??null}}return null===s.networkSource?null:s}agatToFullDefinition({assetGroup:e,assetType:o,networkSourceId:s}){if(null===s||null===e||null===o)return null;const t={networkSource:null,assetGroup:null,assetType:null},r=this.sourceIdToNetworkInfo.get(s);if(!r)return null;t.networkSource=r;const u=r.assetGroupLookup.get(e);return u?(t.assetGroup=u,t.assetType=u.assetTypeLookup.get(o)??null,null===t.assetType?null:t):null}findAgat(e,s){const t=p(s)?s.parent:s;if(!t)throw new o("utility-network:missing-layer","Unable to find asset group/asset type for layer. The given layer is a `SubtypeSublayer` with no parent.");if(this.utilityNetwork.featureServiceUrl!==t.url)return null;const r=this.getNetworkSourceIdForLayer(t);if(null===r)return null;const u=t.fieldsIndex.get("assettype")?.name??"";if(""===u)return null;const i=t.fieldsIndex.get("assetgroup")?.name??"";if(""===i)return null;const a=e.attributes[u],n=e.attributes[i];return null==a||null==n?null:{assetGroup:n,assetType:a,networkSourceId:r}}findAgatFullDefinition(e,o){const s=this.findAgat(e,o);return s?this.agatToFullDefinition(s):null}findRules({networkSourceId:e,assetGroup:o,assetType:s}){const t=[];if(null===e||null===o)return t;const r=this._rulesBySourceId.get(e)?.get(o);if(!r)return t;for(const e of r.generalRules)t.push(e);if(null!=s){const e=r.typeSpecificRules.get(s);if(e)for(const o of e)t.push(o)}return t}getNetworkSourceIdForLayer(e){const o=p(e)?e.parent:e;return o&&this.utilityNetwork.featureServiceUrl===o.url?this.layerIdToSourceIdLookup.get(o.layerId)??null:null}ruleMatchesAgat(e,o,s){switch(s){case"to":return!(e.toNetworkSource?.sourceId!==o.networkSourceId||e.toAssetGroup&&e.toAssetGroup.assetGroupCode!==o.assetGroup||e.toAssetType&&e.toAssetType.assetTypeCode!==o.assetType);case"from":return!(e.fromNetworkSource?.sourceId!==o.networkSourceId||e.fromAssetGroup&&e.fromAssetGroup.assetGroupCode!==o.assetGroup||e.fromAssetType&&e.fromAssetType.assetTypeCode!==o.assetType);case"via":return!(e.viaNetworkSource?.sourceId!==o.networkSourceId||e.viaAssetGroup&&e.viaAssetGroup.assetGroupCode!==o.assetGroup||e.viaAssetType&&e.viaAssetType.assetTypeCode!==o.assetType)}}ruleMatchesFullDefinitionAgat(e,o,s){switch(s){case"to":return!(e.toNetworkSource?.sourceId!==o.networkSource?.sourceId||e.toAssetGroup&&e.toAssetGroup.assetGroupCode!==o.assetGroup?.assetGroupCode||e.toAssetType&&e.toAssetType.assetTypeCode!==o.assetType?.assetTypeCode);case"from":return!(e.fromNetworkSource?.sourceId!==o.networkSource?.sourceId||e.fromAssetGroup&&e.fromAssetGroup.assetGroupCode!==o.assetGroup?.assetGroupCode||e.fromAssetType&&e.fromAssetType.assetTypeCode!==o.assetType?.assetTypeCode);case"via":return!(e.viaNetworkSource?.sourceId!==o.networkSource?.sourceId||e.viaAssetGroup&&e.viaAssetGroup.assetGroupCode!==o.assetGroup?.assetGroupCode||e.viaAssetType&&e.viaAssetType.assetTypeCode!==o.assetType?.assetTypeCode)}}terminalConfiguration(e,o,s){const t=this._terminalConfigurationsBySourceId.get(e);if(!t)return null;const r=t.get(o);return r&&r.get(s)||null}async _load(e){await this.utilityNetwork.load(),u(e);const{dataElement:s}=this.utilityNetwork;if(!s)throw new o("utility-network:no-data-element","No data element found on utility network");for(const e of s.domainNetworks)for(const o of[...e.edgeSources??[],...e.junctionSources??[]]){this.layerIdToSourceIdLookup.set(o.layerId,o.sourceId),this.sourceIdToLayerIdLookup.set(o.sourceId,o.layerId);const e=(o.assetGroups??[]).map(e=>{const o=new i;for(const s of e.assetTypes??[])o.set(s.assetTypeCode,s);return{...e,assetTypeLookup:o}}),s=new i;for(const o of e)s.set(o.assetGroupCode,o);const t={...o,assetGroupLookup:s,assetGroups:e};this.sourceIdToNetworkInfo.set(t.sourceId,t)}const t=await this.utilityNetwork.getRulesTable();u(e);for(const e of t?.rules??[])switch(e.ruleType){case 3:case 2:case 4:case 1:this._registerRule(e.fromNetworkSource.sourceId,e.fromAssetGroup.assetGroupCode,e.fromAssetType.assetTypeCode,e),this._registerRule(e.toNetworkSource.sourceId,e.toAssetGroup.assetGroupCode,e.toAssetType.assetTypeCode,e);break;case 5:this._registerRule(e.fromNetworkSource.sourceId,e.fromAssetGroup.assetGroupCode,e.fromAssetType.assetTypeCode,e),this._registerRule(e.toNetworkSource.sourceId,e.toAssetGroup.assetGroupCode,e.toAssetType.assetTypeCode,e),this._registerRule(e.viaNetworkSource.sourceId,e.viaAssetGroup.assetGroupCode,e.viaAssetType.assetTypeCode,e)}this._makeTerminalConfigurationLookups(s)}_makeTerminalConfigurationLookups(e){const o={};for(const s of e.terminalConfigurations??[])o[s.terminalConfigurationId]=s;for(const s of e.domainNetworks??[])for(const e of s.junctionSources)if("esriUNFCUTJunctionObject"===e.utilityNetworkFeatureClassUsageType||"esriUNFCUTDevice"===e.utilityNetworkFeatureClassUsageType)for(const s of e.assetGroups??[])for(const r of s.assetTypes??[])if(null!=r.terminalConfigurationId&&r.terminalConfigurationId>=0){const u=o[r.terminalConfigurationId];if(u){const o=t(this._terminalConfigurationsBySourceId,e.sourceId,()=>new Map);t(o,s.assetGroupCode,()=>new Map).set(r.assetTypeCode,u)}}}_registerRule(e,o,s,r){const u=t(this._rulesBySourceId,e,()=>new Map),i=t(u,o,()=>({generalRules:[],typeSpecificRules:new Map}));-1===s?i.generalRules.push(r):t(i.typeSpecificRules,s,()=>[]).push(r)}};e([a()],l.prototype,"layerIdToSourceIdLookup",void 0),e([a()],l.prototype,"sourceIdToLayerIdLookup",void 0),e([a()],l.prototype,"sourceIdToNetworkInfo",void 0),e([a()],l.prototype,"utilityNetwork",void 0),l=e([n("esri.networks.support.UtilityNetworkLookupHelper")],l);export{l as UtilityNetworkLookupHelper};
