/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{L as e}from"./Logger.js";import{g as t}from"./MapUtils.js";import{debounce as r,throwIfAborted as i}from"../core/promiseUtils.js";import{a as n}from"./SetUtils.js";import{a as s,i as o,b as a}from"./layerUtils.js";import d,{p as c}from"../request.js";import l from"../core/Error.js";import{join as p,normalize as v}from"../core/urlUtils.js";import u from"../editing/sharedTemplates/SharedTemplateMetadata.js";import{_ as f}from"./tslib.es6.js";import{id as m}from"../kernel.js";import y from"../core/Collection.js";import{EventedAccessor as h}from"../core/Evented.js";import{LoadableMixin as g}from"../core/Loadable.js";import{EsriPromiseMixin as w}from"../core/Promise.js";import{R as S}from"./ReactiveMap.js";import{whenOnce as I,watch as b}from"../core/reactiveUtils.js";import{property as A}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{subclass as _}from"../core/accessorSupport/decorators/subclass.js";import{U as L}from"./UpdatingHandles.js";import T from"../portal/Portal.js";import{h as V}from"./utils12.js";import U from"../rest/featureService/FeatureService.js";import j from"../core/Accessor.js";function k(e){return"feature"===e.type}function N(e){return Array.isArray(e)?e.join(","):""}function E(e){return null==e||!e.length}let x=class extends j{constructor(e){super(e),this.layers=new y,this.lockType="none",this.tables=new y,this.versionInfo=null,this.versionService=null}get layersAndTables(){return new y([...this.layers.toArray(),...this.tables.toArray()])}updateLockType(){this.lockType=this.versionInfo?this.versionService.getLockType(this.versionInfo.versionIdentifier)??"none":"none"}get featureServiceVersion(){return this.featureService.sourceJSON?.currentVersion??0}};f([A({constructOnly:!0})],x.prototype,"canCreateVersion",void 0),f([A({constructOnly:!0})],x.prototype,"canEditVersionedData",void 0),f([A({constructOnly:!0})],x.prototype,"featureService",void 0),f([A({constructOnly:!0})],x.prototype,"layers",void 0),f([A()],x.prototype,"layersAndTables",null),f([A()],x.prototype,"lockType",void 0),f([A({constructOnly:!0})],x.prototype,"tables",void 0),f([A()],x.prototype,"versionInfo",void 0),f([A({constructOnly:!0})],x.prototype,"versionService",void 0),f([A()],x.prototype,"hasAdvancedEditingUserTypeExtension",void 0),f([A()],x.prototype,"loggedInServiceUser",void 0),f([A()],x.prototype,"featureServiceVersion",null),x=f([_("esri.undoredo.support.ServiceVersionInfo")],x);const C=new Map;function M(r){return t(C,r,()=>{const t=new P({view:r});return r.addHandles({remove(){C.delete(r),t.destroy()}}),t.load().catch(t=>{e.getLogger("esri.views.Services").error("Failed to load service metadata",t)}),t})}let P=class extends(g(w(h))){constructor(t){super(t),this._updatingHandles=new L,this.items=new y,this.tablesAndLayersLookup=new S,this.additionalLayers=new y,this._debouncedCheckAndUpdateServiceInfos=r(async()=>{const e=[];for(const t of this.items){if(0===t.layersAndTables.length)continue;const r=t.layersAndTables.getItemAt(0);r?.gdbVersion!==t.versionInfo?.versionIdentifier.name&&e.push(t)}0!==e.length&&(await I(()=>!this.updating),await this._updateVersionInfos(e))}),this._debouncedLayersChanged=r(async()=>{const t=this._detectNewLayersAndTables();0!==t.length&&(await I(()=>!this._updatingHandles.updating),await this._updatingHandles.addPromise((async()=>{const r=new Set;for(const i of t)if("feature"===i.type||"subtype-group"===i.type){if(!i.url)continue;const t=c(i.url).url.path,n=this._findServiceInfo(t);if(n)this.tablesAndLayersLookup.set(i,n),i.isTable?n.tables.push(i):n.layers.push(i);else if(!r.has(t))try{await this._addServiceInfo(t,i)}catch(r){e.getLogger(this).error(`Failed to load feature service: ${t}`,r)}finally{r.add(t)}}})()))}),this._processed=new Set}destroy(){this._set("view",null),this.items.removeAll(),this.tablesAndLayersLookup.clear()}async load(t){return i(t),this.addHandles([b(()=>this.view.map,()=>{this._reset()}),b(()=>this._allLayersAndTables,()=>{this._debouncedLayersChanged().catch(t=>{e.getLogger(this).warn("Failed to update service info",t)})}),b(()=>this.items.map(e=>e.layersAndTables.map(e=>e.gdbVersion??"").join(",")),()=>{this.checkAndUpdateServiceInfos().catch(t=>{e.getLogger(this).warn("Failed to update service info",t)})})]),this.addResolvingPromise(this._debouncedLayersChanged()),this}get updating(){return"loading"===this.loadStatus||this._updatingHandles.updating}checkAndUpdateServiceInfos(){return this._debouncedCheckAndUpdateServiceInfos()}changeVersion(e,t,r){return this._updatingHandles.addPromise((async()=>{await this._changeVersionInternal(e,t,r)})())}createVersion(e){return this._updatingHandles.addPromise((async()=>{const t=e.featureServerUrl,r=this._findServiceInfo(t);if(!r?.versionService)throw new l("services:no-version-management-service","No version management service");const i=r.hasAdvancedEditingUserTypeExtension,n=r.loggedInServiceUser.toUpperCase(),s=(o=e.ownerName)&&0!==o.trim().length?e.ownerName?.trim().toUpperCase():n;var o;if(s!==n){if(r.featureServiceVersion<=11.1)throw new l("services:versioning-api-error","Version management API too old");if(!i)throw new l("services:no-advanced-editing-user-type-extension","No advanced editing extension on service")}if("SDE"===s?.toUpperCase()&&"DEFAULT"===e.versionName.toUpperCase())throw new l("services:no-valid-version-name","No valid version name");{const t=await r.versionService.getVersionInfos();if(t?.find(t=>t.versionIdentifier.name.toUpperCase()===(s+"."+e.versionName).toUpperCase()||t.versionIdentifier.name.toUpperCase()===(n+"."+e.versionName).toUpperCase()))throw new l("services:no-valid-version-name","No valid version name")}const a=await r.versionService.createVersion({versionName:e.versionName,access:s!==n?"public":e.access,description:e.description});if(s!==n){const{guid:t,name:i}=a.versionIdentifier;await r.versionService.alterVersion({guid:t,name:i},{ownerName:s,access:e.access})}e.switchToVersion&&await this._changeVersionInternal(t,a.versionIdentifier.name,a.versionIdentifier.guid),this.emit("version-created",{versionIdentifier:a.versionIdentifier,versionManagementService:r.versionService})})())}deleteVersion(e,t,r){return this._updatingHandles.addPromise((async()=>{const i=this._findServiceInfo(e);if(!i?.versionService)throw new l("services:no-version-management-service","No version management service");if(i.featureServiceVersion<=11.1)throw new l("services:versioning-api-error","Version management API too old");if(!i.hasAdvancedEditingUserTypeExtension)throw new l("services:no-advanced-editing-user-type-extension","No advanced editing extension on service");const n={name:t,guid:r};await i.versionService.deleteVersion(n)&&(await this._updateVersionInfo(i),this.emit("version-deleted",{versionIdentifier:n,versionManagementService:i.versionService}))})())}startEditing(e){return this._updatingHandles.addPromise((async()=>{const t=this._findServiceInfo(e);if(!t?.versionService)throw new l("services:no-version-management-service","No version management service");if(!t.hasAdvancedEditingUserTypeExtension)throw new l("services:no-advanced-editing-user-type-extension","No advanced editing extension on service");const r=t.versionInfo?.versionIdentifier??{name:t.versionService.defaultVersionIdentifier.name,guid:t.versionService.defaultVersionIdentifier.guid};let i=!0;("none"!==t.versionService.getLockType(r)||(i=await t.versionService.startReading(r),i))&&(i=await t.versionService.startEditing(r),t.updateLockType())})())}finishEditing(e,t){return this._updatingHandles.addPromise((async()=>{const r=this._findServiceInfo(e);if(!r?.versionService)throw new l("services:no-version-management-service","No version management service");if(!r.hasAdvancedEditingUserTypeExtension)throw new l("services:no-advanced-editing-user-type-extension","No advanced editing extension on service");const i=r.versionInfo?.versionIdentifier??{name:r.versionService.defaultVersionIdentifier.name,guid:r.versionService.defaultVersionIdentifier.guid},n=r.versionService.getLockType(i);if("none"!==n)return"read"===n?(await r.versionService.stopReading(i),void r.updateLockType()):"edit"===n?(await r.versionService.stopEditing(i,t),await r.versionService.stopReading(i),void r.updateLockType()):void 0})())}async _changeVersionInternal(e,t,r){const i=this._findServiceInfo(e);if(!i?.versionService)throw new l("services:no-version-management-service","No version management service");const n=i.versionInfo?.versionIdentifier??{name:i.versionService.defaultVersionIdentifier.name,guid:i.versionService.defaultVersionIdentifier.guid},s={name:t,guid:r};await i.versionService.changeVersion(this.view?.map,n,s)&&await this._updateVersionInfo(i)}async _updateVersionInfo(e){const t=e.versionService;if(!t)return;if(0===e.layersAndTables.length)return;const r=e.layersAndTables.getItemAt(0)?.gdbVersion,i=r?await t.getVersionIdentifierFromName(r):t.defaultVersionIdentifier;e.versionInfo=await t.getVersionInfoExtended(i)}_findServiceInfo(e){return this.items.find(t=>t.featureService.url===e)??null}_removeFeatureService(e){this.items.remove(e)}_reset(){this.additionalLayers.removeAll(),this._processed.clear(),this.tablesAndLayersLookup.clear(),this.items.removeAll()}async _findPortal(e){const t=m?.findServerInfo(e??"");if(!t?.owningSystemUrl)return null;const r=`${t.owningSystemUrl}/sharing/rest`,i=T.getDefault();return i?.loaded&&v(i.restUrl)===v(r)?i:new T({authMode:"immediate",url:t.owningSystemUrl}).load()}_updateVersionInfos(t){return this._updatingHandles.addPromise((async()=>{for(const r of t)await this._updateVersionInfo(r).catch(t=>{e.getLogger(this).error("Failed to update version details",t)})})())}async _addServiceInfo(e,t){const r=new U({url:e});await r.load();const i=await this._findPortal(e),n=i?.user?.username;let s=!1;n&&(s=await V(i,n,"advediting"));let o=null;r.versionManagementServiceUrl&&(o=new(0,(await import("../versionManagement/VersionManagementService.js")).default)({url:r.versionManagementServiceUrl}),await o.load());const a=t.isTable?[]:[t],d=t.isTable?[t]:[],c=new x({loggedInServiceUser:n??"",hasAdvancedEditingUserTypeExtension:s,versionInfo:null,lockType:"none",canEditVersionedData:!0,canCreateVersion:!0,featureService:r,versionService:o,layers:new y(a),tables:new y(d)});return o&&await this._updateVersionInfo(c),this.items.push(c),this.tablesAndLayersLookup.set(t,c),t.isTable?c.tables.push(t):c.layers.push(t),c}get _allLayersAndTables(){return[...this.view.map?.allLayers??[],...this.view.map?.allTables??[],...this.additionalLayers]}_detectNewLayersAndTables(){const e=new Set(this._allLayersAndTables),t=[];for(const r of e)"feature"!==r.type&&"subtype-group"!==r.type||this._processed.has(r)||t.push(r);for(const t of this._processed)if(!e.has(t)&&(s(t)||o(t))){const e=this.tablesAndLayersLookup.get(t);if(!e)continue;this.tablesAndLayersLookup.delete(t),t.isTable?e.tables.remove(t):e.layers.remove(t),0===e.layersAndTables.length&&this._removeFeatureService(e)}return this._processed=e,t}};f([A({constructOnly:!0})],P.prototype,"view",void 0),f([A()],P.prototype,"items",void 0),f([A()],P.prototype,"tablesAndLayersLookup",void 0),f([A()],P.prototype,"additionalLayers",void 0),f([A()],P.prototype,"updating",null),f([A()],P.prototype,"_allLayersAndTables",null),P=f([_("esri.undoredo.support.Services")],P);const H=()=>e.getLogger("esri.editing.templateUtils");function F(e){return null!=e&&"prototype"in e}function O(e){return R(e)&&!("definition"in e)}function q(e){return R(e)&&"definition"in e}function R(e){return null!=e&&"templateId"in e}function D(e){return q(e)&&"feature"===e?.type&&(null==e.definition||k(e.definition))}function J(e){return q(e)&&"group"===e?.type&&(null==e.definition||"group"===e.definition.type)}function $(e){return q(e)&&"preset"===e?.type&&(null==e.definition||"preset"===e.definition.type)}function W(e){return q(e)&&null!=e?.definition}const z=e=>null==e||"object"!=typeof e?[]:[..."templates"in e&&Array.isArray(e.templates)?e.templates:[],..."types"in e&&Array.isArray(e.types)?e.types.flatMap(e=>e.templates):[]];async function B(e,r,o){if(null==r)return e.map(e=>({layer:e,templates:z(e)}));const a=await async function(e,t){const r=await M(t).load(),i=new Set;for(const t of e)n(i,G(r,t));return await Promise.all(Array.from(i).map(e=>e.featureService.load())),i}(e,r);i(o);const c=new Map,v=Array.from(a).map(e=>async function({serviceInfo:e,out:r,signal:n}){const{featureService:o,layersAndTables:a}=e,c=await async function({featureService:e,layers:r,signal:i}){if(!e.capabilities?.editing.supportsSharedTemplates)return new Map;const n=new Map(r.map(e=>[e.layerId,e])),s=await async function({featureService:e,query:t,requestOptions:r={}}){if(E(t.layers)&&E(t.templateIds)&&(t.layers=e.layerInfos.map(e=>e.id),!t.layers.length))throw new l("query-shared-templates:invalid-parameters","Must supply a value for either the 'layers' or the 'templateIds' parameters");const i=p(e.url,"sharedTemplates","query"),n={f:"json",...r.query,...t};n.layers&&(n.layers=N(n.layers)),n.templateIds&&(n.templateIds=N(n.templateIds)),n.tags&&(n.tags=N(n.tags));const s={...r,responseType:"json",query:n};return(await d(i,s)).data.templates.map(t=>{const r=u.fromJSON(t);return r.featureService=e,r})}({featureService:e,query:{layers:Array.from(n.keys())},requestOptions:{signal:i}}),o=new Map;for(const e of s)for(const r of e.layerIds)n.has(r)&&t(o,n.get(r),()=>[]).push(e);return o}({featureService:o,layers:a.toArray(),signal:n});i(n);for(const[e,t]of c.entries())if(0!==t.length)if(s(e)){const i=K(t),n=[],s=i.get(1/0)??n;for(const t of e.sublayers){const e=i.get(t.subtypeCode)??n;r.set(t,[...e,...s])}}else r.set(e,t)}({serviceInfo:e,out:c,signal:o})),f=await Promise.allSettled(v);for(const e of f.filter(e=>"rejected"===e.status))H().warn("Failed to fetch shared templates for service. Will use standard templates if available.",e.reason);return e.map(e=>({layer:e,templates:c.get(e)??z(e)}))}function G(e,t){return a(t)&&t.parent?e.tablesAndLayersLookup.get(t.parent):o(t)?e.tablesAndLayersLookup.get(t):null}function K(e){const r=new Map;for(const i of e)t(r,i.subtypeCode??1/0,()=>[]).push(i);return r}export{F as a,R as b,W as c,D as d,$ as e,J as f,M as g,q as h,O as i,B as j,k};
