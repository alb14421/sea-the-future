/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{t}from"./definitions.js";function e(t,e){return t.x===e.x&&t.y===e.y}function i(t,e){return t.x=e.y,t.y=-e.x,t}function x(t,e){return t.x=-e.y,t.y=e.x,t}function r(t,e){return t.x=e.x,t.y=e.y,t}function n(t,e){return t.x=-e.x,t.y=-e.y,t}function s(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function y(t,e){return t.x*e.y-t.y*e.x}function o(t,e){return t.x*e.x+t.y*e.y}function h(t,e,i,x){return t.x=e.x*i+e.y*x,t.y=e.x*x-e.y*i,t}class l{constructor(t,e,i){this._writeVertex=t,this._writeTriangle=e,this._canUseThinTessellation=i,this._prevNormal={x:void 0,y:void 0},this._nextNormal={x:void 0,y:void 0},this._textureNormalLeft={x:0,y:1},this._textureNormalRight={x:0,y:-1},this._textureNormal={x:void 0,y:void 0},this._joinNormal={x:void 0,y:void 0},this._inner={x:void 0,y:void 0},this._outer={x:void 0,y:void 0},this._roundStart={x:void 0,y:void 0},this._roundEnd={x:void 0,y:void 0},this._startBreak={x:void 0,y:void 0},this._endBreak={x:void 0,y:void 0},this._innerPrev={x:void 0,y:void 0},this._innerNext={x:void 0,y:void 0},this._bevelStart={x:void 0,y:void 0},this._bevelEnd={x:void 0,y:void 0},this._bevelMiddle={x:void 0,y:void 0}}tessellate(i,x,r=this._canUseThinTessellation){!function(t){if(!t)return;const i=t.length;if(i<=1)return;let x=0;for(let r=1;r<i;r++)e(t[r],t[x])||++x===r||(t[x]=t[r]);t.length=x+1}(i),r&&x.halfWidth<t&&!x.offset?this._tessellateThin(i,x):this._tessellate(i,x)}_tessellateThin(t,e){if(t.length<2)return;const i=e.wrapDistance||65535;let x=e.initialDistance||0,r=!1,n=t[0].x,s=t[0].y;const y=t.length;for(let e=1;e<y;++e){r&&(r=!1,x=0);let y=t[e].x,o=t[e].y,h=y-n,l=o-s,_=Math.sqrt(h*h+l*l);if(h/=_,l/=_,x+_>i){r=!0;const t=(i-x)/_;_=i-x,y=(1-t)*n+t*y,o=(1-t)*s+t*o,--e}const a=this._writeVertex(n,s,0,0,h,l,l,-h,0,-1,x),c=this._writeVertex(n,s,0,0,h,l,-l,h,0,1,x);x+=_;const d=this._writeVertex(y,o,0,0,h,l,l,-h,0,-1,x),u=this._writeVertex(y,o,0,0,h,l,-l,h,0,1,x);this._writeTriangle(a,c,d),this._writeTriangle(c,d,u),n=y,s=o}}_tessellate(t,l){const _=t[0],a=t[t.length-1],c=e(_,a),d=c?3:2;if(t.length<d)return;const u=l.pixelCoordRatio,v=null!=l.capType?l.capType:0,f=null!=l.joinType?l.joinType:2,w=null!=l.miterLimit?Math.min(l.miterLimit,4):2,g=null!=l.roundLimit?Math.min(l.roundLimit,1.05):1.05,T=null!=l.halfWidth?l.halfWidth:2,m=!!l.textured;let V,b,N,k=null;const p=this._prevNormal,L=this._nextNormal;let M=-1,E=-1;const B=this._joinNormal;let S,j;const P=this._textureNormalLeft,A=this._textureNormalRight,D=this._textureNormal;let U=-1,R=-1;const W=l.wrapDistance||65535;let q=l.initialDistance||0;const X=this._writeVertex,C=this._writeTriangle,z=(t,e,i,x,r,n)=>{const s=X(b,N,S,j,i,x,t,e,r,n,q);return U>=0&&R>=0&&s>=0&&C(U,R,s),U=R,R=s,s};c&&(V=t[t.length-2],L.x=a.x-V.x,L.y=a.y-V.y,E=s(L),L.x/=E,L.y/=E);let F=!1;for(let e=0;e<t.length;++e){if(F&&(F=!1,q=0),V&&(p.x=-L.x,p.y=-L.y,M=E,q+M>W&&(F=!0)),F){const i=(W-q)/M;M=W-q,V={x:(1-i)*V.x+i*t[e].x,y:(1-i)*V.y+i*t[e].y},--e}else V=t[e];b=V.x,N=V.y;const l=e<=0&&!F,_=e===t.length-1;if(l||(q+=M),k=_?c?t[1]:null:t[e+1],k?(L.x=k.x-b,L.y=k.y-N,E=s(L),L.x/=E,L.y/=E):(L.x=void 0,L.y=void 0),!c){if(l){x(B,L),S=B.x,j=B.y,2===v&&(z(-L.y-L.x,L.x-L.y,L.x,L.y,0,-1),z(L.y-L.x,-L.x-L.y,L.x,L.y,0,1)),1===v&&(z(-L.y-L.x,L.x-L.y,L.x,L.y,-1,-1),z(L.y-L.x,-L.x-L.y,L.x,L.y,-1,1)),1!==v&&0!==v||(z(-L.y,L.x,L.x,L.y,0,-1),z(L.y,-L.x,L.x,L.y,0,1));continue}if(_){i(B,p),S=B.x,j=B.y,1!==v&&0!==v||(z(p.y,-p.x,-p.x,-p.y,0,-1),z(-p.y,p.x,-p.x,-p.y,0,1)),2===v&&(z(p.y-p.x,-p.x-p.y,-p.x,-p.y,0,-1),z(-p.y-p.x,p.x-p.y,-p.x,-p.y,0,1)),1===v&&(z(p.y-p.x,-p.x-p.y,-p.x,-p.y,1,-1),z(-p.y-p.x,p.x-p.y,-p.x,-p.y,1,1));continue}}let a,d,X=-y(p,L);if(Math.abs(X)<.01)o(p,L)>0?(B.x=p.x,B.y=p.y,X=1,a=Number.MAX_VALUE,d=!0):(x(B,L),X=1,a=1,d=!1);else{B.x=(p.x+L.x)/X,B.y=(p.y+L.y)/X,a=s(B);const t=(a-1)*T*u;d=a>4||t>M&&t>E}S=B.x,j=B.y;let C=f;switch(f){case 0:a<1.05&&(C=2);break;case 1:a<g&&(C=2);break;case 2:a>w&&(C=0)}switch(C){case 2:if(z(B.x,B.y,-p.x,-p.y,0,-1),z(-B.x,-B.y,-p.x,-p.y,0,1),_)break;if(m){const t=F?0:q;U=this._writeVertex(b,N,S,j,L.x,L.y,B.x,B.y,0,-1,t),R=this._writeVertex(b,N,S,j,L.x,L.y,-B.x,-B.y,0,1,t)}break;case 0:{const t=X<0;let e,s,y,o;if(t){const t=U;U=R,R=t,e=P,s=A}else e=A,s=P;if(d)y=t?x(this._innerPrev,p):i(this._innerPrev,p),o=t?i(this._innerNext,L):x(this._innerNext,L);else{const e=t?n(this._inner,B):r(this._inner,B);y=e,o=e}const l=t?i(this._bevelStart,p):x(this._bevelStart,p);z(y.x,y.y,-p.x,-p.y,e.x,e.y);const a=z(l.x,l.y,-p.x,-p.y,s.x,s.y);if(_)break;const c=t?x(this._bevelEnd,L):i(this._bevelEnd,L);if(d){const t=this._writeVertex(b,N,S,j,-p.x,-p.y,0,0,0,0,q);U=this._writeVertex(b,N,S,j,L.x,L.y,o.x,o.y,e.x,e.y,q),R=this._writeVertex(b,N,S,j,L.x,L.y,c.x,c.y,s.x,s.y,q),this._writeTriangle(a,t,R)}else{if(m){const t=this._bevelMiddle;t.x=(l.x+c.x)/2,t.y=(l.y+c.y)/2,h(D,t,-p.x,-p.y),z(t.x,t.y,-p.x,-p.y,D.x,D.y),h(D,t,L.x,L.y),U=this._writeVertex(b,N,S,j,L.x,L.y,t.x,t.y,D.x,D.y,q),R=this._writeVertex(b,N,S,j,L.x,L.y,o.x,o.y,e.x,e.y,q)}else{const t=U;U=R,R=t}z(c.x,c.y,L.x,L.y,s.x,s.y)}if(t){const t=U;U=R,R=t}break}case 1:{const t=X<0;let e,s;if(t){const t=U;U=R,R=t,e=P,s=A}else e=A,s=P;const y=t?n(this._inner,B):r(this._inner,B);let l,c;d?(l=t?x(this._innerPrev,p):i(this._innerPrev,p),c=t?i(this._innerNext,L):x(this._innerNext,L)):(l=y,c=y);const u=t?i(this._roundStart,p):x(this._roundStart,p),v=t?x(this._roundEnd,L):i(this._roundEnd,L),f=z(l.x,l.y,-p.x,-p.y,e.x,e.y),w=z(u.x,u.y,-p.x,-p.y,s.x,s.y);if(_)break;const g=this._writeVertex(b,N,S,j,-p.x,-p.y,0,0,0,0,q);d||this._writeTriangle(U,R,g);const T=n(this._outer,y),V=this._writeVertex(b,N,S,j,L.x,L.y,v.x,v.y,s.x,s.y,q);let k,M;const E=a>2;if(E){let e;a!==Number.MAX_VALUE?(T.x/=a,T.y/=a,e=o(p,T),e=(a*(e*e-1)+1)/e):e=-1,k=t?i(this._startBreak,p):x(this._startBreak,p),k.x+=p.x*e,k.y+=p.y*e,M=t?x(this._endBreak,L):i(this._endBreak,L),M.x+=L.x*e,M.y+=L.y*e}h(D,T,-p.x,-p.y);const W=this._writeVertex(b,N,S,j,-p.x,-p.y,T.x,T.y,D.x,D.y,q);h(D,T,L.x,L.y);const C=m?this._writeVertex(b,N,S,j,L.x,L.y,T.x,T.y,D.x,D.y,q):W,F=g,G=m?this._writeVertex(b,N,S,j,L.x,L.y,0,0,0,0,q):g;let H=-1,I=-1;if(E&&(h(D,k,-p.x,-p.y),H=this._writeVertex(b,N,S,j,-p.x,-p.y,k.x,k.y,D.x,D.y,q),h(D,M,L.x,L.y),I=this._writeVertex(b,N,S,j,L.x,L.y,M.x,M.y,D.x,D.y,q)),m?E?(this._writeTriangle(F,w,H),this._writeTriangle(F,H,W),this._writeTriangle(G,C,I),this._writeTriangle(G,I,V)):(this._writeTriangle(F,w,W),this._writeTriangle(G,C,V)):E?(this._writeTriangle(g,w,H),this._writeTriangle(g,H,I),this._writeTriangle(g,I,V)):(this._writeTriangle(g,w,W),this._writeTriangle(g,C,V)),d?(U=this._writeVertex(b,N,S,j,L.x,L.y,c.x,c.y,e.x,e.y,q),R=V):(U=m?this._writeVertex(b,N,S,j,L.x,L.y,c.x,c.y,e.x,e.y,q):f,this._writeTriangle(U,G,V),R=V),t){const t=U;U=R,R=t}break}}}}}export{l as L};
