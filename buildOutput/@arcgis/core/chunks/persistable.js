/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{c as r}from"./MD5.js";import{i as t}from"./multiOriginJSONSupportUtils.js";import{isAbsolute as o,isBlobProtocol as s,join as n,blobUrlToBlob as i,getPathExtension as c}from"../core/urlUtils.js";import{g as p}from"./uuid.js";import{g as a}from"./metadata.js";import{n as u}from"../core/Accessor.js";import{propertyJSONMeta as l}from"../core/accessorSupport/decorators/property.js";import{g as m}from"./resourceExtension.js";import{p as d,a as f,i as y,r as g,b as h}from"./persistableUrlUtils.js";function v(e){const r=e?.origins??[void 0];return(n,i)=>{const p=function(e,r,n){if("resource"===e?.type)return function(e,r,n){const i=a(r,n);return{type:String,read:(e,r,t)=>{const o=g(e,r,t);return i.type===String?o:"function"==typeof i.type?new i.type({url:o}):void 0},write:{isRequired:i.json?.write?.isRequired,writer(r,p,a,l){if(!l?.resources)return"string"==typeof r?void(p[a]=f(r,l)):void(p[a]=r.write({},l));const d=null==(I=r)?null:"string"==typeof I?I:I.url,g=f(d,{...l,verifyItemRelativeUrls:l?.verifyItemRelativeUrls?{writtenUrls:l.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},1),h=i.type!==String&&(!t(this)||l?.origin&&this.originIdOf(n)>u(l.origin)),v={object:this,propertyName:n,value:r,targetUrl:g,dest:p,targetPropertyName:a,context:l,params:e};var I;l?.portalItem&&g&&!o(g)?h&&e?.contentAddressed?j(v):h?function(e){const{context:r,targetUrl:t,params:o,value:s,dest:n,targetPropertyName:i}=e;if(!r.portalItem)return;const p=r.portalItem.resourceFromPath(t),a=w(s,t,r),u=m(a),l=c(p.path),d=o?.compress??!1;u===l?(r.resources&&U({...e,resource:p,content:a,compress:d,updates:r.resources.toUpdate}),n[i]=t):j(e)}(v):function({context:e,targetUrl:r,dest:t,targetPropertyName:o}){e.portalItem&&e.resources&&(e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(r),compress:!1}),t[o]=r)}(v):l?.portalItem&&(null==g||null!=y(g)||s(g)||h)?j(v):p[a]=g}}}}(e,r,n);switch(e?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:e,write:r}=d;return{read:e,write:r}}}}(e,n,i);for(const e of r){const r=l(n,e,i);for(const e in p)r[e]=p[e]}}}function j(t){const{targetUrl:o,params:c,value:a,context:u,dest:l,targetPropertyName:d}=t;if(!u.portalItem)return;const f=h(o),y=w(a,o,u);if(c?.contentAddressed&&"json"!==y.type)return void u.messages?.push(new e("persistable:contentAddressingUnsupported",`Property "${d}" is trying to serializing a resource with content of type ${y.type} with content addressing. Content addressing is only supported for json resources.`,{content:y}));const g=c?.contentAddressed&&"json"===y.type?r(y.jsonString):f?.filename??p(),v=n(c?.prefix??f?.prefix,g),j=`${v}.${m(y)}`;if(c?.contentAddressed&&u.resources&&"json"===y.type){const e=u.resources.toKeep.find(({resource:e})=>e.path===j)??u.resources.toAdd.find(({resource:e})=>e.path===j);if(e)return void(l[d]=e.resource.itemRelativeUrl)}const I=u.portalItem.resourceFromPath(j);s(o)&&u.resources&&u.resources.pendingOperations.push(i(o).then(e=>{I.path=`${v}.${m({type:"blob",blob:e})}`,l[d]=I.itemRelativeUrl}).catch(()=>{}));const S=c?.compress??!1;u.resources&&U({...t,resource:I,content:y,compress:S,updates:u.resources.toAdd}),l[d]=I.itemRelativeUrl}function U({object:e,propertyName:r,updates:t,resource:o,content:s,compress:n}){t.push({resource:o,content:s,compress:n,finish:t=>{!function(e,r,t){"string"==typeof e[r]?e[r]=t.url:e[r].url=t.url}(e,r,t)}})}function w(e,r,t){return"string"==typeof e?{type:"url",url:r}:{type:"json",jsonString:JSON.stringify(e.toJSON(t))}}export{v as p};
