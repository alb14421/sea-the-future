/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{T as e,D as t,A as i}from"./TimeOnly.js";import{c as r}from"./deepClone.js";import{D as s}from"./Dictionary.js";import{A as n}from"./enum.js";import{g as a,c as l,f as o,k as u,Z as f,o as h,n as c,i as d,a as y,l as m}from"./languageUtils.js";import{f as p}from"./ensureType.js";import b from"../geometry/Point.js";import{fromJSON as g}from"../geometry/support/jsonUtils.js";import _ from"../geometry/Geometry.js";import{a as T}from"./featureConversionUtils.js";import F from"../layers/support/FieldsIndex.js";import{c as w,a as x,e as A}from"./guards.js";function D(e,t,i=null){const r=v(e,!0);if(void 0!==r.hasm&&(r.hasM=r.hasm,delete r.hasm),void 0!==r.hasz&&(r.hasZ=r.hasz,delete r.hasz),void 0!==r.spatialreference&&(r.spatialReference=r.spatialreference,delete r.spatialreference),r.spatialReference||(r.spatialReference=t),void 0!==r.curverings){const e=X(r.curverings,r.hasZ,r.hasM,H);if(null==e)return null;r.curveRings=e.arrays,delete r.curverings,delete r.rings,r.hasZ=e.hasZ,r.hasM=e.hasM}else if(void 0!==r.rings){const e=X(r.rings,r.hasZ,r.hasM,B);if(null==e)return null;r.rings=e.arrays,r.hasZ=e.hasZ,r.hasM=e.hasM}if(void 0!==r.curvepaths){const e=X(r.curvepaths,r.hasZ,r.hasM,H);if(null==e)return null;r.curvePaths=e.arrays,delete r.curvepaths,delete r.paths,r.hasZ=e.hasZ,r.hasM=e.hasM}else if(void 0!==r.paths){const e=X(r.paths,r.hasZ,r.hasM,B);if(null==e)return null;r.paths=e.arrays,r.hasZ=e.hasZ,r.hasM=e.hasM}if(void 0!==r.points){const e=function(e,t,i){const r=I(e);if(r===Z)return null;const{hasZ:s,hasM:n}=W(t,i,r);return{array:K(e,B,q(s,n),V(s,n)),hasZ:s,hasM:n}}(r.points,r.hasZ,r.hasM);if(null==e)return null;r.points=e.array,r.hasZ=e.hasZ,r.hasM=e.hasM}const s=g(r);if(null!=i&&s?.type!==i)throw new n(null,"InvalidParameter",null);return s}function v(e,t=!1){const i={};for(const r of e.keys()){const s=t?r.toLowerCase():r,n=e.attributes[r];i[s]=a(n)?v(n):n}return i}const Z=Symbol("NoValue");function I(e){return Array.isArray(e)&&e.length>0?e[0]:l(e)&&e.length()>0?e.get(0):Z}const M=0;function k(e){return p(e,M)??M}function N(e){return"number"==typeof e&&!Number.isNaN(e)}const L=null;function S(e){return p(e,L)??L}function j(e){return"number"==typeof e&&!Number.isNaN(e)||null===e}function z(e){return!(e.length<2||"number"!=typeof e[0]||Number.isNaN(e[0])||"number"!=typeof e[1]||Number.isNaN(e[1]))}function G(e){return z(e)?e.length>2?e.slice(0,2):e:null}function C(e){return z(e)?N(e[2])?e.length>3?e.slice(0,3):e:[e[0],e[1],k(e[2])]:null}function O(e){return z(e)?e.length>=3&&!j(e[2])?[e[0],e[1],S(e[2])]:e.length>3?e.slice(0,3):e:null}function P(e){return z(e)?N(e[2])&&j(e[3])?e.length>4?e.slice(0,4):e:[e[0],e[1],k(e[2]),S(e[3])]:null}function R(e){return[e.x,e.y]}function J(e){return[e.x,e.y,e.z??M]}function U(e){return[e.x,e.y,e.m??L]}function E(e){return[e.x,e.y,e.z??M,e.m??L]}function V(e,t){return e?t?P:C:t?O:G}function q(e,t){return e?t?E:J:t?U:R}function B(e,t,i){return Array.isArray(e)?i(e):e instanceof b?t(e):l(e)?i(e.toArray()):null}function H(e,t,i){return Array.isArray(e)?i(e):a(e)?e.hasField("c")?function(e,t,i){if(l(e)&&(e=e.toArray()),!Array.isArray(e)||2!==e.length)throw new n(null,"InvalidParameter",null);const r=B(e[0],t,i);if(null==r)return null;const s=B(e[1],R,G);return null==s?null:{c:[r,s]}}(e.field("c"),t,i):e.hasField("a")?function(e,t,i){if(l(e)&&(e=e.toArray()),!Array.isArray(e)||4!==e.length&&7!==e.length)throw new n(null,"InvalidParameter",null);const r=B(e[0],t,i);if(null==r)return null;const s=B(e[1],R,G);if(null==s)return null;const a=e[2];if(0!==a&&1!==a)throw new n(null,"InvalidParameter",null);const o=e[3];if(0!==o&&1!==o)throw new n(null,"InvalidParameter",null);if(4===e.length)return{a:[r,s,a,o]};const u=e[4];if("number"!=typeof u)throw new n(null,"InvalidParameter",null);if(Number.isNaN(u))return null;const f=e[5];if("number"!=typeof f)throw new n(null,"InvalidParameter",null);if(Number.isNaN(f))return null;const h=e[6];if("number"!=typeof h)throw new n(null,"InvalidParameter",null);return Number.isNaN(h)?null:{a:[r,s,a,o,u,f,h]}}(e.field("a"),t,i):e.hasField("b")?function(e,t,i){if(l(e)&&(e=e.toArray()),!Array.isArray(e)||3!==e.length)throw new n(null,"InvalidParameter",null);const r=B(e[0],t,i);if(null==r)return null;const s=B(e[1],R,G);if(null==s)return null;const a=B(e[2],R,G);return null==a?null:{b:[r,s,a]}}(e.field("b"),t,i):null:e instanceof b?t(e):l(e)?i(e.toArray()):null}function K(e,t,i,r){const s=[];if(Array.isArray(e))for(const n of e){const e=t(n,i,r);null!=e&&s.push(e)}else if(l(e))for(let n=0;n<e.length();n++){const a=t(e.get(n),i,r);null!=a&&s.push(a)}return s}function Q(e,t,i){return Array.isArray(e)?e.length>=t:l(e)?e.length()>=t:e instanceof b&&e[i]}function W(e,t,i){return void 0===e&&void 0===t?{hasZ:Q(i,3,"hasZ"),hasM:Q(i,4,"hasM")}:void 0===e?!0===t?{hasZ:Q(i,4,"hasZ"),hasM:!0}:{hasZ:Q(i,3,"hasZ"),hasM:!1}:void 0===t?!0===e?{hasZ:!0,hasM:Q(i,4,"hasM")}:{hasZ:!1,hasM:Q(i,3,"hasM")}:{hasZ:!0===e,hasM:!0===t}}function X(e,t,i,r){e=function(e){const t=I(I(e));return t===Z||Array.isArray(t)||l(t)||t instanceof b?e:[e]}(e);const s=I(I(e));if(s===Z)return null;const{hasZ:n,hasM:a}=W(t,i,s),o=q(n,a),u=V(n,a),f=[];if(Array.isArray(e))for(let t=0;t<e.length;t++)f.push(K(e[t],r,o,u));else if(l(e))for(let t=0;t<e.length();t++)f.push(K(e.get(t),r,o,u));return{arrays:f,hasZ:n,hasM:a}}class Y{constructor(){this.arcadeDeclaredClass="esri.arcade.Feature",this._optimizedGeomDefinition=null,this._geometry=null,this.attributes=null,this._layer=null,this._fieldTypesFixed=!0,this.fieldsIndex=null,this.contextTimeZone=null,this.immutable=!0,this._fieldsToFixDataTypes=null,this.immutable=!0}static createFromGraphic(e,t){const i=new Y;return i.contextTimeZone=t??null,i._geometry=null!=e.geometry?e.geometry:null,void 0===e.attributes||null===e.attributes?i.attributes={}:i.attributes=e.attributes,e._sourceLayer?(i._layer=e._sourceLayer,i._fieldTypesFixed=!1):e._layer?(i._layer=e._layer,i._fieldTypesFixed=!1):e.layer&&"fields"in e.layer?(i._layer=e.layer,i._fieldTypesFixed=!1):e.sourceLayer&&"fields"in e.sourceLayer&&(i._layer=e.sourceLayer,i._fieldTypesFixed=!1),i._layer&&!i._fieldTypesFixed&&(i.fieldsIndex=this.hydrateFieldsIndex(i._layer)),i}static createFromArcadeFeature(e){if(e instanceof Y){const t=new Y;return t._fieldTypesFixed=e._fieldTypesFixed,t.attributes=e.attributes,t._geometry=e._geometry,t._optimizedGeomDefinition=e._optimizedGeomDefinition,e._layer&&(t._layer=e._layer),t.fieldsIndex=e.fieldsIndex,t.contextTimeZone=e.contextTimeZone,t}const t={};for(const i of e.keys())t[i]=e.field(i);return Y.createFromGraphicLikeObject(e.geometry(),t,e.fullSchema(),e.contextTimeZone)}static createFromOptimisedFeature(e,t,i){const r=new Y;return r._geometry=e.geometry?{geometry:e.geometry}:null,r._optimizedGeomDefinition=i,r.attributes=e.attributes||{},r._layer=t,r._fieldTypesFixed=!1,r}static createFromArcadeDictionary(e,t){const i=new Y;return i.attributes=e.field("attributes"),null!==i.attributes&&i.attributes instanceof s?(i.attributes=i.attributes.attributes,null===i.attributes&&(i.attributes={})):i.attributes={},i._geometry=e.field("geometry"),null!==i._geometry&&(i._geometry instanceof s?i._geometry=D(i._geometry,t):i._geometry instanceof _||(i._geometry=null)),i}static createFromGraphicLikeObject(e,t,i=null,r){const s=new Y;return s.contextTimeZone=r??null,null===t&&(t={}),s.attributes=t,s._geometry=null!=e?e:null,s._layer=i,s._layer&&(s._fieldTypesFixed=!1,s.fieldsIndex=this.hydrateFieldsIndex(s._layer)),s}static hydrateFieldsIndex(e){return null===e?null:o(e)?e.getFieldsIndex():e.fieldsIndex?e.fieldsIndex:F.fromLayerJSON({datesInUnknownTimezone:e.datesInUnknownTimezone,fields:e.fields,timeInfo:e.timeInfo,editFieldsInfo:e.editFieldsInfo,dateFieldsTimeReference:e.dateFieldsTimeReference??{timeZone:"UTC",respectsDaylightSaving:!1}})}repurposeFromGraphicLikeObject(e,t,i=null){null===t&&(t={}),this.attributes=t,this._geometry=e??null,this._layer=i,this._layer?this._fieldTypesFixed=!1:this._fieldTypesFixed=!0}castToText(e=!1){!1===this._fieldTypesFixed&&this._fixFieldTypes();const t=u(this.attributes,{useNumbersForDates:e});return'{"geometry":'+(null===this.geometry()?"null":f(this.geometry()))+',"attributes":'+t+"}"}_fixFieldTypes(){if(this._fieldsToFixDataTypes&&this._fieldsToFixDataTypes?.length>0)return this._fixAllFields(this._fieldsToFixDataTypes),void(this._fieldTypesFixed=!0);const e=[],t=this._layer.fields;for(let i=0;i<t.length;i++){const r=t[i],{name:s,type:n}=r;switch(n){case"date":case"esriFieldTypeDate":e.push({field:s,dataType:"date"});break;case"date-only":case"esriFieldTypeDateOnly":e.push({field:s,dataType:"date-only"});break;case"time-only":case"esriFieldTypeTimeOnly":e.push({field:s,dataType:"time-only"});break;case"timestamp-offset":case"esriFieldTypeTimestampOffset":e.push({field:s,dataType:"timestamp-offset"});break;case"geometry":case"esriFieldTypeGeometry":e.push({field:s,dataType:"geometry"})}}this._fieldsToFixDataTypes=e,e.length>0&&this._fixAllFields(e),this._fieldTypesFixed=!0}isUnknownDateTimeField(e){return"unknown"===this.fieldsIndex?.getTimeZone(e)}_fixAllFields(r){this.attributes={...this.attributes};const s=this.contextTimeZone??"system";for(let n=0;n<r.length;n++){const a=r[n].field,l=r[n].dataType;let o=this.attributes[a];if(void 0===o){for(const r in this.attributes)if(r.toLowerCase()===a.toLowerCase()){if(o=this.attributes[r],null!==o){if("time-only"===l){h(o)||(this.attributes[r]=e.fromReader(o.toString()));break}if("date-only"===l){c(o)||(this.attributes[r]=t.fromReader(o.toString()));break}if("timestamp-offset"===l){d(o)||(this.attributes[r]=i.fromReaderAsTimeStampOffset(o.toString()));break}if("date"===l){const e=this.isUnknownDateTimeField(r);o instanceof Date?this.attributes[r]=e?i.unknownDateJSToArcadeDate(o):i.dateJSAndZoneToArcadeDate(o,s):d(o)||(this.attributes[r]=e?i.unknownEpochToArcadeDate(o):i.epochToArcadeDate(o,s))}"geometry"===l&&(this.attributes[r]=null)}break}}else if(null!==o){if("time-only"===l){h(o)?this.attributes[a]=o:this.attributes[a]=e.fromReader(o.toString());continue}if("date-only"===l){c(o)?this.attributes[a]=o:this.attributes[a]=t.fromReader(o.toString());continue}if("timestamp-offset"===l){d(o)?this.attributes[a]=o:this.attributes[a]=i.fromReaderAsTimeStampOffset(o.toString());continue}if("date"===l){const e=this.isUnknownDateTimeField(a);d(o)?this.attributes[a]=o:o instanceof Date?this.attributes[a]=e?i.unknownDateJSToArcadeDate(o):i.dateJSAndZoneToArcadeDate(o,s):this.attributes[a]=e?i.unknownEpochToArcadeDate(o):i.epochToArcadeDate(o,s);continue}if("geometry"===l){this.attributes[a]=null;continue}}}}geometry(){return null===this._geometry||this._geometry instanceof _||(this._optimizedGeomDefinition?(this._geometry=g(T(this._geometry,this._optimizedGeomDefinition.geometryType,this._optimizedGeomDefinition.hasZ,this._optimizedGeomDefinition.hasM)),this._geometry.spatialReference=this._optimizedGeomDefinition.spatialReference):this._geometry=g(this._geometry)),this._geometry}field(e){this._fieldTypesFixed||this._fixFieldTypes();const t=this.attributes[e];if(void 0!==t)return t;const i=e.toLowerCase();for(const e in this.attributes)if(e.toLowerCase()===i)return this.attributes[e];if(this._hasFieldDefinition(i))return null;throw new n(null,"FieldNotFound",null,{key:e})}_hasFieldDefinition(e){if(null===this._layer)return!1;for(let t=0;t<this._layer.fields.length;t++)if(this._layer.fields[t].name.toLowerCase()===e)return!0;return!1}setField(e,t){if(this.immutable)throw new n(null,"Immutable",null);if(t instanceof Date&&(t=this.isUnknownDateTimeField(e)?i.unknownDateJSToArcadeDate(t):i.dateJSToArcadeDate(t)),!1===y(t))throw new n(null,"TypeNotAllowedInFeature",null);const r=e.toLowerCase();if(void 0===this.attributes[e]){for(const e in this.attributes)if(e.toLowerCase()===r)return void(this.attributes[e]=t);this.attributes[e]=t}else this.attributes[e]=t}hasField(e){const t=e.toLowerCase();if(void 0!==this.attributes[e])return!0;for(const e in this.attributes)if(e.toLowerCase()===t)return!0;return!!this._hasFieldDefinition(t)}keys(){let e=[];const t={};for(const i in this.attributes)e.push(i),t[i.toLowerCase()]=1;if(null!==this._layer)for(let i=0;i<this._layer.fields.length;i++){const r=this._layer.fields[i];1!==t[r.name.toLowerCase()]&&e.push(r.name)}return e=e.sort(),e}static parseAttributesFromDictionary(e){const t={};for(const i in e.attributes){const r=e.attributes[i];if(!y(r))throw new n(null,"InvalidParameter",null);t[i]=r}return t}static fromJson(e,t){let i=null;null!==e.geometry&&void 0!==e.geometry&&(i=g(e.geometry));const r={};if(null!==e.attributes&&void 0!==e.attributes)for(const t in e.attributes){const i=e.attributes[t];if(null===i)r[t]=i;else{if(!(w(i)||x(i)||A(i)||d(i)||h(i)||c(i)))throw new n(null,"InvalidParameter",null);r[t]=i}}return Y.createFromGraphicLikeObject(i,r,null,t??null)}fullSchema(){return this._layer}gdbVersion(){if(null===this._layer)return"";const e=this._layer.gdbVersion;return void 0===e?"":""===e&&this._layer.capabilities?.isVersioned?"SDE.DEFAULT":e}castAsJson(e){const t={attributes:{},geometry:!0===e?.keepGeometryType?this.geometry():this.geometry()?.toJSON()??null};for(const i in this.attributes){const r=this.attributes[i];void 0!==r&&(t.attributes[i]=m(r,e))}return t}async castAsJsonAsync(e=null,t){return this.castAsJson(t)}}r(Y);const $=Object.freeze(Object.defineProperty({__proto__:null,default:Y},Symbol.toStringTag,{value:"Module"}));export{Y as F,$ as a,D as c};
