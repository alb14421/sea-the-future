/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../request.js";import t from"../core/Error.js";import{join as s,getPathExtension as r}from"../core/urlUtils.js";import"../config.js";import"../core/lang.js";import"./object.js";import"../kernel.js";import"./MapUtils.js";import"../core/promiseUtils.js";import"./handleUtils.js";import"./events.js";import"./Logger.js";import"./string.js";import"./maybe.js";import"./persistableUrlUtils.js";import"./jsonUtils.js";async function o(e,t={},r){await e.load(r);const o=s(e.itemUrl,"resources"),{start:a=1,num:n=10,sortOrder:i="asc",sortField:c="resource"}=t,l={query:{start:a,num:n,sortOrder:i,sortField:c,token:e.apiKey},signal:r?.signal},p=await e.portal.request(o,l);return{total:p.total,nextStart:p.nextStart,resources:p.resources.map(({created:t,size:s,resource:r})=>({created:new Date(t),size:s,resource:e.resourceFromPath(r)}))}}async function a(e,r,o,a){const n=new Map;for(const{resource:e,content:s,compress:a,access:i}of r){if(!e.hasPath())throw new t(`portal-item-resource-${o}:invalid-path`,"Resource does not have a valid path");const[r,l]=c(e.path),p=`${r}/${a??""}/${i??""}`;n.has(p)||n.set(p,{prefix:r,compress:a,access:i,files:[]}),n.get(p).files.push({fileName:l,content:s})}await e.load(a);const i=s(e.userItemUrl,"add"===o?"addResources":"updateResources");for(const{prefix:t,compress:s,access:r,files:o}of n.values()){const n=25;for(let c=0;c<o.length;c+=n){const l=o.slice(c,c+n),p=new FormData;t&&"."!==t&&p.append("resourcesPrefix",t),s&&p.append("compress","true"),r&&p.append("access",r);let u=0;for(const{fileName:e,content:t}of l)p.append("file"+ ++u,t,e);p.append("f","json"),await e.portal.request(i,{method:"post",body:p,signal:a?.signal})}}}async function n(e,r,o){if(!r.hasPath())throw new t("portal-item-resources-remove:invalid-path","Resource does not have a valid path");await e.load(o);const a=s(e.userItemUrl,"removeResources");await e.portal.request(a,{method:"post",query:{resource:r.path},signal:o?.signal}),r.portalItem=null}async function i(e,t){await e.load(t);const r=s(e.userItemUrl,"removeResources");return e.portal.request(r,{method:"post",query:{deleteAll:!0},signal:t?.signal})}function c(e){const t=e.lastIndexOf("/");return-1===t?[".",e]:[e.slice(0,t),e.slice(t+1)]}function l(e){const[t,s]=function(e){const t=r(e);return null==t?[e,""]:[e.slice(0,e.length-t.length-1),`.${t}`]}(e),[o,a]=c(t);return[o,a,s]}async function p(t){return"blob"===t.type?t.blob:"json"===t.type?new Blob([t.jsonString],{type:"application/json"}):(await e(t.url,{responseType:"blob"})).data}function u(e,t){if(!e.hasPath())return null;const[r,,o]=l(e.path);return e.portalItem.resourceFromPath(s(r,t+o))}export{a as addOrUpdateResources,p as contentToBlob,o as fetchResources,u as getSiblingOfSameTypeI,i as removeAllResources,n as removeResource,l as splitPrefixFileNameAndExtension};
