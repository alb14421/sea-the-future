/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import r from"../core/Error.js";import{urlToObject as e,getFilename as t}from"../core/urlUtils.js";import{p as a,j as s}from"../request.js";import{f as o}from"./associatedFeatureServiceUtils.js";import{g as l,f as i}from"./fetchService.js";import{r as n,s as c}from"./layerUtils.js";import{l as p}from"./lazyLayerLoader.js";import{f as m}from"./requestPresets.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./jsonUtils.js";import"../kernel.js";import"./MapUtils.js";import"../core/promiseUtils.js";import"./handleUtils.js";import"./events.js";import"./maybe.js";import"./persistableUrlUtils.js";import"../portal/Portal.js";import"./tslib.es6.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./metadata.js";import"./utils.js";import"./tracking.js";import"./ensureType.js";import"./Warning.js";import"./get.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"../core/Loadable.js";import"../core/Promise.js";import"./reader.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../layers/catalog/catalogUtils.js";import"../core/reactiveUtils.js";const u={FeatureLayer:!0,SceneLayer:!0,VideoLayer:!0};async function y(p){const{properties:y,url:v}=p,w={...y,url:v},b=await async function(p,y){let f=a(p);if(null==f&&(f=await async function(r,a){const o=await m(r,{customParameters:a});let l=null,i=null;const n=o.type;if("Feature Layer"===n||"Table"===n?(l="FeatureServer",i=o.id??null):"indexedVector"===n?l="VectorTileServer":o.hasOwnProperty("mapName")?l="MapServer":o.hasOwnProperty("bandCount")&&o.hasOwnProperty("pixelSizeX")?l="ImageServer":o.hasOwnProperty("maxRecordCount")&&o.hasOwnProperty("allowGeometryUpdates")?l="FeatureServer":o.hasOwnProperty("streamUrls")?l="StreamServer":d(o)?(l="SceneServer",i=o.id):o.hasOwnProperty("layers")&&d(o.layers?.[0])&&(l="SceneServer"),!l)return null;const c=null!=i?s(r):null;return{title:null!=c&&o.name||t(r),serverType:l,sublayer:i,url:{path:null!=c?c.serviceUrl:e(r).path}}}(p,y)),null==f)throw new r("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:p});const{serverType:j,sublayer:v}=f;let w;const b={FeatureServer:"FeatureLayer",KnowledgeGraphServer:"KnowledgeGraphLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer",VideoServer:"VideoLayer"},g="FeatureServer"===j,h="SceneServer"===j,P={parsedUrl:f,Constructor:null,layerId:g||h?v??void 0:void 0,layers:[],tables:[]};switch(j){case"MapServer":if(null!=v){const{type:e}=await m(p,{customParameters:y});switch(w="FeatureLayer",e){case"Catalog Layer":w="CatalogLayer";break;case"Catalog Dynamic Group Layer":throw new r("arcgis-layers:unsupported",`fromUrl() not supported for "${e}" layers`)}}else{const r=await async function(r,e){return(await m(r,{customParameters:e})).tileInfo}(p,y);w=r?"TileLayer":"MapImageLayer"}break;case"ImageServer":{const r=await m(p,{customParameters:y}),{tileInfo:e,cacheType:t}=r;w=e?"LERC"!==e?.format?.toUpperCase()||t&&"elevation"!==t.toLowerCase()?"ImageryTileLayer":"ElevationLayer":"ImageryLayer";break}case"SceneServer":{const r=await m(f.url.path,{customParameters:y});if(w="SceneLayer",r){const e=r?.layers;if("Voxel"===r?.layerType)w="VoxelLayer";else if(e?.length){const r=e[0]?.layerType;null!=r&&null!=c[r]&&(w=c[r])}}break}case"3DTilesServer":throw new r("arcgis-layers:unsupported","fromUrl() not supported for 3DTiles layers");case"FeatureServer":if(w="FeatureLayer",null!=v){const r=await m(p,{customParameters:y});P.sourceJSON=r,P.preferredUrl=n(),w=l(r.type)}break;default:w=b[j]}if(u[w]&&null==v){const r=await async function(r,e,t){let a,s,l,c=!1;switch(e){case"FeatureServer":{const e=await i(r,{customParameters:t});l=n(r,{preferredHost:e.preferredHost}),c=!!e.layersJSON,a=e.layersJSON||e.serviceJSON;break}case"SceneServer":{const e=await async function(r,e){const t=await m(r,{customParameters:e}),a=t.layers?.[0];if(!a)return{serviceInfo:t};try{const{serverUrl:a}=await o(r),s=await m(a,{customParameters:e}).catch(()=>null);return s&&(t.tables=s.tables),{serviceInfo:t,tableServerUrl:a}}catch{return{serviceInfo:t}}}(r,t);a=e.serviceInfo,s=e.tableServerUrl;break}default:a=await m(r,{customParameters:t})}const p=a?.layers,u=a?.tables;return{preferredUrl:l,layers:p?.map(r=>({id:r.id})).reverse()||[],tables:u?.map(r=>({serverUrl:s,id:r.id})).reverse()||[],layerInfos:c?p:[],tableInfos:c?u:[]}}(p,j,y);if(g&&(P.preferredUrl=r.preferredUrl,P.sublayerInfos=r.layerInfos,P.tableInfos=r.tableInfos),1!==r.layers.length+r.tables.length)P.layers=r.layers,P.tables=r.tables,g&&r.layerInfos?.length&&(P.sublayerConstructorProvider=await async function(r){if(!r.length)return;const e=new Set,t=[];for(const{type:a}of r)e.has(a)||(e.add(a),t.push(S(l(a))));const a=await Promise.all(t),s=new Map;return Array.from(e).forEach((r,e)=>{s.set(r,a[e])}),r=>s.get(r.type)}(r.layerInfos));else if(g||h){const e=r.layerInfos?.[0]??r.tableInfos?.[0];if(P.layerId=r.layers[0]?.id??r.tables[0]?.id,P.sourceJSON=e,g){const r=e?.type;w=l(r)}}}return P.Constructor=await S(w),P}(v,y?.customParameters),{Constructor:g,layerId:h,sourceJSON:P,parsedUrl:U,layers:I,tables:L}=b;if(I.length+L.length===0)return null!=h&&(w.layerId=h),null!=P&&(w.sourceJSON=P),new g(w);const O=new(0,(await import("../layers/GroupLayer.js")).default)({title:U.title});return await async function(r,e,t){const a=e.sublayerConstructorProvider;for(const{id:s,serverUrl:o}of e.layers){const l=f(e.sublayerInfos,s),i=j(o,s,l,(l&&a?.(l))??e.Constructor,t);r.add(i)}if(e.tables.length){const a=await S("FeatureLayer");e.tables.forEach(({id:s,serverUrl:o})=>{const l=j(o,s,f(e.tableInfos,s),a,t);r.tables.add(l)})}}(O,b,w),O}function f(r,e){return r?r.find(({id:r})=>r===e):null}function j(r,e,t,a,s){const o={...s,layerId:e};return null!=r&&(o.url=r),null!=t&&(o.sourceJSON=t),"sublayerTitleMode"in a.prototype&&(o.sublayerTitleMode="service-name"),new a(o)}function d(r){return null!=r&&r.hasOwnProperty("store")&&r.hasOwnProperty("id")&&"number"==typeof r.id}async function S(r){return(0,p[r])()}export{y as fromUrl};
