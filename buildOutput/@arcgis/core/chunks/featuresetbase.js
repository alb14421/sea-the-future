/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../Graphic.js";import{A as t}from"./TimeOnly.js";import{w as r,x as i}from"./arcade.js";import{D as s}from"./Dictionary.js";import{A as o,S as n,t as a}from"./enum.js";import{F as l}from"./Feature.js";import{c as m,a as p,F as u,b as c,O as d,d as f,T as y,e as j,f as b,g as I,h as g,S as h,i as w,j as F,A as T,k as D}from"./featureSetUtils.js";import{I as S}from"./ImmutableArray.js";import{s as x,o as E,n as C,f as A,w as L,M as U,L as v,i as N,e as P,K as k,J as R,d as M,c as Z,j as $,u as O,O as V,P as z}from"./languageUtils.js";import{g as B}from"./portalUtils.js";import{E as G,i as W}from"./SpatialFilter.js";import{i as H,c as q}from"./shared2.js";import{isPromiseLike as Q}from"../core/promiseUtils.js";import K from"../core/sql/WhereClause.js";import _ from"../layers/FeatureLayer.js";import J from"../layers/support/Field.js";import Y from"../portal/Portal.js";import{queryAssociations as X}from"../rest/networks/queryAssociations.js";import ee from"../rest/networks/support/NetworkElement.js";import te from"../rest/networks/support/QueryAssociationsParameters.js";import{c as re,b as ie,f as se}from"./guards.js";import"./tslib.es6.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Accessor.js";import"../core/lang.js";import"../core/Handles.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"./MapUtils.js";import"./Warning.js";import"../core/Error.js";import"./get.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"./events.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"./jsonUtils.js";import"../core/JSONSupport.js";import"../core/accessorSupport/decorators/cast.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./datetime.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"./jsonMap.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./locale.js";import"./constants.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"./colorUtils.js";import"./mathUtils.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../core/reactiveUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"./createFeatureId.js";import"./typeUtils2.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils3.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils4.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./vec3f64.js";import"./aaBoundingBox.js";import"./DoubleArray.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"./lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./UnknownTimeZone.js";import"./arcadeEnvironment.js";import"./aiServices.js";import"./utils9.js";import"./commonProperties3.js";import"./deepClone.js";import"./streamLayerUtils.js";import"./unitConversion.js";import"./number2.js";import"./hash.js";import"./uuid.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./memoryEstimations.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"../layers/support/FieldsIndex.js";import"./timeZoneUtils.js";import"./MD5.js";import"../rest/support/AttachmentQuery.js";import"../rest/support/Query.js";import"./DataLayerSource.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../time/TimeExtent.js";import"./timeUtils.js";import"../layers/support/FeatureType.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../layers/support/FeatureTemplate.js";import"../rest/support/RelationshipQuery.js";import"./fieldType.js";import"../layers/Layer.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"./operatorsWorkerConnection.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"./number.js";import"./substitute.js";import"./messages.js";import"./MultiOriginJSONSupport.js";import"./layerContainerType.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/Element.js";import"./formUtils.js";import"../form/elements/AttachmentElement.js";import"../form/elements/inputs/attachments/AttachmentInput.js";import"./Input.js";import"../form/elements/inputs/attachments/AudioInput.js";import"./utils2.js";import"../form/elements/inputs/attachments/DocumentInput.js";import"../form/elements/inputs/attachments/ImageInput.js";import"../form/elements/inputs/attachments/SignatureInput.js";import"../form/elements/inputs/attachments/VideoInput.js";import"../form/elements/FieldElement.js";import"../form/elements/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DatePickerInput.js";import"../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../form/elements/inputs/TimePickerInput.js";import"../form/elements/RelationshipElement.js";import"../form/elements/TextElement.js";import"../form/elements/UtilityNetworkAssociationsElement.js";import"../graphic/FeatureGraphicOrigin.js";import"../graphic/GraphicOrigin.js";import"./isFeatureGraphicOrigin.js";import"./editsZScale.js";import"./queryZScale.js";import"./zscale.js";import"../rest/support/FeatureSet.js";import"../layers/mixins/APIKeyMixin.js";import"./ArcGISService.js";import"../layers/mixins/BlendLayer.js";import"./jsonUtils2.js";import"./parser.js";import"./utils5.js";import"./mat4.js";import"./common.js";import"../layers/mixins/CustomParametersMixin.js";import"../layers/mixins/DisplayFilteredLayer.js";import"../layers/support/DisplayFilterInfo.js";import"./scaleUtils.js";import"../layers/support/DisplayFilter.js";import"./displayFilterUtils.js";import"./EditBusLayer.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"../layers/mixins/FeatureLayerBase.js";import"../geometry/HeightModelInfo.js";import"./commonProperties.js";import"../symbols/support/ElevationInfo.js";import"../symbols/support/FeatureExpressionInfo.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"../tables/AttributeTableTemplate.js";import"../tables/elements/AttributeTableGroupElement.js";import"../tables/elements/AttributeTableAttachmentElement.js";import"../tables/elements/AttributeTableElement.js";import"../tables/elements/AttributeTableFieldElement.js";import"../tables/elements/AttributeTableRelationshipElement.js";import"./featureLayerUtils.js";import"./asyncUtils.js";import"./featureQueryAll.js";import"./layerUtils.js";import"../layers/catalog/catalogUtils.js";import"../renderers/SimpleRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"./visualVariableUtils.js";import"./commonProperties2.js";import"../symbols/support/jsonUtils.js";import"./defaults.js";import"./defaultsJSON.js";import"../renderers/UniqueValueRenderer.js";import"./diffUtils.js";import"./RendererLegendOptions.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils.js";import"../rest/support/NormalizationBinParametersMixin.js";import"../layers/support/GeometryFieldsInfo.js";import"../layers/support/LayerFloorInfo.js";import"./multiLayerServiceUtils.js";import"../layers/support/Relationship.js";import"./serviceCapabilitiesUtils.js";import"./infoFor3D.js";import"../layers/support/Subtype.js";import"./portalItemUtils.js";import"./projectionUtils.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../layers/mixins/FeatureReductionLayer.js";import"../layers/support/AggregateField.js";import"../layers/support/ExpressionInfo.js";import"./FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/LabelClass.js";import"./labelUtils.js";import"../renderers/support/jsonUtils.js";import"./typeUtils3.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/support/ClassBreakInfo.js";import"../renderers/DictionaryRenderer.js";import"./LRUCache.js";import"./MemCache.js";import"./DictionaryScriptEvaluator.js";import"./Version.js";import"./ArcadeExpression.js";import"./utils6.js";import"./defaultCIMValues.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"./heatmapUtils.js";import"./vec4.js";import"./vec4f64.js";import"../renderers/PieChartRenderer.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"./clusterUtils.js";import"../layers/mixins/OperationalLayer.js";import"../layers/mixins/OrderedLayer.js";import"../layers/support/OrderByInfo.js";import"../layers/mixins/PortalLayer.js";import"../layers/mixins/PublishableLayer.js";import"../layers/support/PublishingInfo.js";import"../layers/mixins/RefreshableLayer.js";import"../layers/mixins/ScaleRangeLayer.js";import"../layers/mixins/TemporalLayer.js";import"../layers/support/TimeInfo.js";import"../time/TimeInterval.js";import"../layers/mixins/TrackableLayer.js";import"../layers/support/TrackInfo.js";import"../layers/support/TrackPartInfo.js";import"./fieldProperties.js";import"./labelingInfo.js";import"./TitleCreator.js";import"./versionUtils.js";import"./styleUtils2.js";import"../support/popupUtils.js";import"./typeUtils4.js";import"../rest/networks/support/QueryAssociationsResult.js";import"../rest/networks/support/Association.js";import"./TelecomNetworkElement.js";function oe(e,t,r){const i=e.getVariables();if(i.length>0){const s={};for(const e of i)s[e]=t.evaluateIdentifier(r,{name:e});e.parameters=s}return e}function ne(e,t,r=null){for(const r in e)if(r.toLowerCase()===t.toLowerCase())return e[r];return r}function ae(e){if(null===e)return null;const t={type:ne(e,"type",""),name:ne(e,"name","")};if("range"===t.type)t.range=ne(e,"range",[]);else{t.codedValues=[];for(const r of ne(e,"codedValues",[]))t.codedValues.push({name:ne(r,"name",""),code:ne(r,"code",null)})}return t}function le(e){if(null===e)return null;const t={},r=ne(e,"wkt");null!==r&&(t.wkt=r);const i=ne(e,"wkid");return null!==i&&(t.wkid=i),t}function me(e){if(null===e)return null;const t={hasZ:ne(e,"hasz",!1),hasM:ne(e,"hasm",!1)},r=ne(e,"spatialreference");null!=r&&(t.spatialReference=le(r));const i=ne(e,"x",null);if(null!==i)return t.x=i,t.y=ne(e,"y",null),t.hasZ&&(t.z=ne(e,"z",null)),t.hasM&&(t.m=ne(e,"m",null)),t;const s=ne(e,"rings",null);if(null!==s)return t.rings=s,t;const o=ne(e,"paths",null);if(null!==o)return t.paths=o,t;const n=ne(e,"points",null);if(null!==n)return t.points=n,t;for(const r of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const i=ne(e,r,null);null!==i&&(t[r]=i)}return t}function pe(e){return"utc"===e?.toLowerCase()?"UTC":"unknown"===e?.toLowerCase()?"Unknown":e}function ue(ue){if("async"===ue.mode){ue.functions.timezone=function(e,r){return ue.standardFunctionAsync(e,r,async(i,n,a)=>{if(x(a,1,2,e,r),E(a[0]))return"Unknown";if(C(a[0]))return"Unknown";if(A(a[0])){if(await a[0].load(),1===a.length||null===a[1])return a[0].datesInUnknownTimezone?pe("unknown"):pe(a[0].dateFieldsTimeZone);if(!(a[1]instanceof s)||!1===a[1].hasField("type"))throw new o(e,"InvalidParameter",r);const t=a[1].field("type");if(!1===re(t))throw new o(e,"InvalidParameter",r);switch(L(t).toLowerCase()){case"preferredtimezone":return pe(a[0].preferredTimeZone);case"editfieldsinfo":return pe(a[0].editFieldsInfo?.timeZone??null);case"timeinfo":return pe(a[0].timeInfo?.timeZone??null);case"field":if(a[1].hasField("fieldname")&&re(a[1].field("fieldname")))return pe(a[0].fieldTimeZone(L(a[1].field("fieldname"))))}throw new o(e,"InvalidParameter",r)}const l=U(a[0],v(e));if(null===l)return null;const m=l.timeZone;return"system"===m?t.systemTimeZoneCanonicalName:"utc"===m.toLowerCase()?"UTC":"unknown"===m.toLowerCase()?"Unknown":m})},ue.functions.sqltimestamp=function(e,t){return ue.standardFunctionAsync(e,t,async(r,i,s)=>{x(s,1,3,e,t);const n=s[0];if(N(n)){if(1===s.length)return n.toSQLWithKeyword();if(2===s.length)return n.changeTimeZone(L(s[1])).toSQLWithKeyword();throw new o(e,"InvalidParameter",t)}if(C(n))return n.toSQLWithKeyword();if(A(n)){if(3!==s.length)throw new o(e,"InvalidParameter",t);await n.load();const r=L(s[1]);if(C(s[2]))return s[2].toSQLWithKeyword();if(!1===N(s[2]))throw new o(e,"InvalidParameter",t);const i=n.fieldTimeZone(r);return null==i?s[2].toSQLWithKeyword():s[2].changeTimeZone(i).toSQLWithKeyword()}throw new o(e,"InvalidParameter",t)})},ue.signatures.push({name:"sqltimestamp",min:2,max:4}),ue.functions.featuresetbyid=function(e,t){return ue.standardFunctionAsync(e,t,(r,i,s)=>{if(x(s,2,4,e,t),P(s[0])){const r=L(s[1]);let i=k(s[2],null);const n=R(k(s[3],!0));if(null===i&&(i=["*"]),!1===ie(i))throw new o(e,"InvalidParameter",t);return s[0].featureSetById(r,n,i)}throw new o(e,"InvalidParameter",t)})},ue.signatures.push({name:"featuresetbyid",min:2,max:4});const ce=new n(["datasource","parent","root"]);ue.functions.getfeatureset=function(e,t){return ue.standardFunctionAsync(e,t,async(r,i,s)=>{if(x(s,1,2,e,t),M(s[0])){const t=null==s[1]?"datasource":ce.lookup(L(s[1]));return m(s[0].fullSchema(),t,e.lrucache,e.interceptor,e.spatialReference)}throw new o(e,"InvalidParameter",t)})},ue.signatures.push({name:"getfeatureset",min:1,max:2}),ue.functions.featuresetbyportalitem=function(e,t){return ue.standardFunctionAsync(e,t,(i,s,n)=>{if(x(n,2,5,e,t),null===n[0])throw new o(e,"PortalRequired",t);if(n[0]instanceof r){const r=L(n[1]),i=L(n[2]);let s=k(n[3],null);const a=R(k(n[4],!0));if(null===s&&(s=["*"]),!1===ie(s))throw new o(e,"InvalidParameter",t);let l;return l=e.services?.portal?e.services.portal:Y.getDefault(),l=B(n[0],l),p(r,i,e.spatialReference,s,a,l,e.lrucache,e.interceptor)}if(!1===re(n[0]))throw new o(e,"PortalRequired",t);const a=L(n[0]),l=L(n[1]);let m=k(n[2],null);const u=R(k(n[3],!0));if(null===m&&(m=["*"]),!1===ie(m))throw new o(e,"InvalidParameter",t);return p(a,l,e.spatialReference,m,u,e.services?.portal??Y.getDefault(),e.lrucache,e.interceptor)})},ue.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),ue.functions.featuresetbyname=function(e,t){return ue.standardFunctionAsync(e,t,(r,i,s)=>{if(x(s,2,4,e,t),P(s[0])){const r=L(s[1]);let i=k(s[2],null);const n=R(k(s[3],!0));if(null===i&&(i=["*"]),!1===ie(i))throw new o(e,"InvalidParameter",t);return s[0].featureSetByName(r,n,i)}throw new o(e,"InvalidParameter",t)})},ue.signatures.push({name:"featuresetbyname",min:2,max:4}),ue.functions.featureset=function(e,t){return ue.standardFunction(e,t,(r,i,n)=>{x(n,1,1,e,t);const a={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(re(n[0])){const e=JSON.parse(n[0]);void 0!==e.layerDefinition?(a.layerDefinition=e.layerDefinition,a.featureSet=e.featureSet,e.layerDefinition.spatialReference&&(a.layerDefinition.spatialReference=e.layerDefinition.spatialReference)):(a.featureSet.features=e.features,a.featureSet.geometryType=e.geometryType,a.layerDefinition.geometryType=a.featureSet.geometryType,a.layerDefinition.objectIdField=e.objectIdFieldName??"",a.layerDefinition.typeIdField=e.typeIdFieldName,a.layerDefinition.globalIdField=e.globalIdFieldName,a.layerDefinition.fields=e.fields,e.spatialReference&&(a.layerDefinition.spatialReference=e.spatialReference))}else{if(!(n[0]instanceof s))throw new o(e,"InvalidParameter",t);{const r=JSON.parse(n[0].castToText(!0)),i=ne(r,"layerdefinition");if(null!==i){a.layerDefinition.geometryType=ne(i,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.globalIdField=ne(i,"globalidfield",""),a.layerDefinition.objectIdField=ne(i,"objectidfield",""),a.layerDefinition.typeIdField=ne(i,"typeidfield",""),a.layerDefinition.hasZ=!0===ne(i,"hasz",!1),a.layerDefinition.hasM=!0===ne(i,"hasm",!1);const e=ne(i,"spatialreference");e&&(a.layerDefinition.spatialReference=le(e));const t=[];for(const e of ne(i,"fields",[])){const r={name:ne(e,"name",""),alias:ne(e,"alias",""),type:ne(e,"type",""),nullable:ne(e,"nullable",!0),editable:ne(e,"editable",!0),length:ne(e,"length",null),domain:ae(ne(e,"domain"))};t.push(r)}a.layerDefinition.fields=t;const s=ne(r,"featureset");if(s){const e={};for(const r of t)e[r.name.toLowerCase()]=r.name;for(const t of ne(s,"features",[])){const r={},i=ne(t,"attributes",{});for(const t in i)r[e[t.toLowerCase()]]=i[t];a.featureSet.features.push({attributes:r,geometry:me(ne(t,"geometry"))})}}}else{a.layerDefinition.hasZ=!0===ne(r,"hasz",!1),a.layerDefinition.hasM=!0===ne(r,"hasm",!1),a.layerDefinition.geometryType=ne(r,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.objectIdField=ne(r,"objectidfieldname",""),a.layerDefinition.typeIdField=ne(r,"typeidfieldname","");const i=ne(r,"spatialreference");i&&(a.layerDefinition.spatialReference=le(i));const s=[],n=ne(r,"fields",null);if(!ie(n))throw new o(e,"InvalidParameter",t);for(const e of n){const t={name:ne(e,"name",""),alias:ne(e,"alias",""),type:ne(e,"type",""),nullable:ne(e,"nullable",!0),editable:ne(e,"editable",!0),length:ne(e,"length",null),domain:ae(ne(e,"domain"))};s.push(t)}a.layerDefinition.fields=s;const l={};for(const e of s)l[e.name.toLowerCase()]=e.name;let m=ne(r,"features",null);if(ie(m))for(const e of m){const t={},r=ne(e,"attributes",{});for(const e in r)t[l[e.toLowerCase()]]=r[e];a.featureSet.features.push({attributes:t,geometry:me(ne(e,"geometry",null))})}else m=null,a.featureSet.features=m}}}if(0==(!!(l=a).layerDefinition&&!!l.featureSet&&!1!==function(e){for(const t of["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])if(t===e)return!0;return!1}(l.layerDefinition.geometryType)&&!1!==ie(l.layerDefinition.fields)&&!1!==ie(l.featureSet.features)))throw new o(e,"InvalidParameter",t);var l;return a.layerDefinition.geometryType||(a.layerDefinition.geometryType="esriGeometryNull"),u.create(a,e.spatialReference)})},ue.signatures.push({name:"featureset",min:1,max:1}),ue.functions.filter=function(e,t){return ue.standardFunctionAsync(e,t,async(r,i,s)=>{if(x(s,2,2,e,t),ie(s[0])||Z(s[0])){const r=[];let i,n=s[0];if(n instanceof S&&(n=n.toArray()),!$(s[1]))throw new o(e,"InvalidParameter",t);i=s[1].createFunction(e);for(const e of n){const t=i(e);Q(t)?!0===await t&&r.push(e):!0===t&&r.push(e)}return r}if(A(s[0])){const t=await s[0].load(),r=K.create(s[1],{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),i=r.getVariables();if(i.length>0){const t={};for(const r of i)t[r]=ue.evaluateIdentifier(e,{name:r});r.parameters=t}return new c({parentfeatureset:s[0],whereclause:r})}throw new o(e,"InvalidParameter",t)})},ue.signatures.push({name:"filter",min:2,max:2}),ue.functions.orderby=function(e,t){return ue.standardFunctionAsync(e,t,async(r,i,s)=>{if(x(s,2,2,e,t),A(s[0])){const e=new d(s[1]);return new f({parentfeatureset:s[0],orderbyclause:e})}throw new o(e,"InvalidParameter",t)})},ue.signatures.push({name:"orderby",min:2,max:2}),ue.functions.top=function(e,t){return ue.standardFunctionAsync(e,t,async(r,i,s)=>{if(x(s,2,2,e,t),A(s[0]))return new y({parentfeatureset:s[0],topnum:s[1]});if(ie(s[0]))return O(s[1])>=s[0].length?s[0].slice():s[0].slice(0,O(s[1]));if(Z(s[0]))return O(s[1])>=s[0].length()?s[0].slice():s[0].slice(0,O(s[1]));throw new o(e,"InvalidParameter",t)})},ue.signatures.push({name:"top",min:2,max:2}),ue.functions.first=function(e,t){return ue.standardFunctionAsync(e,t,async(r,i,s)=>{if(x(s,1,1,e,t),A(s[0])){const t=await s[0].first(r.abortSignal);if(null!==t){const r=l.createFromGraphicLikeObject(t.geometry,t.attributes,s[0],e.timeZone);return r._underlyingGraphic=t,r}return t}return ie(s[0])?0===s[0].length?null:s[0][0]:Z(s[0])?0===s[0].length()?null:s[0].get(0):null})},ue.signatures.push({name:"first",min:1,max:1}),ue.functions.attachments=function(e,t){return ue.standardFunctionAsync(e,t,async(r,i,n)=>{x(n,1,2,e,t);const a={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(n.length>1)if(n[1]instanceof s){if(n[1].hasField("minsize")&&(a.minsize=O(n[1].field("minsize"))),n[1].hasField("metadata")&&(a.returnMetadata=R(n[1].field("metadata"))),n[1].hasField("maxsize")&&(a.maxsize=O(n[1].field("maxsize"))),n[1].hasField("types")){const e=V(n[1].field("types"),!1);e.length>0&&(a.types=e)}}else if(null!==n[1])throw new o(e,"InvalidParameter",t);if(M(n[0])){const t=n[0]._layer;let r;if(A(t))r=t;else{if(null==t||!H(t))return[];r=j(t,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)}return await r.load(),r.queryAttachments(n[0].field(r.objectIdField),a.minsize,a.maxsize,a.types,a.returnMetadata)}if(null===n[0])return[];throw new o(e,"InvalidParameter",t)})},ue.signatures.push({name:"attachments",min:1,max:2}),ue.functions.featuresetbyrelationshipname=function(e,t){return ue.standardFunctionAsync(e,t,async(r,i,s)=>{x(s,2,4,e,t);const n=s[0],a=L(s[1]);let l=k(s[2],null);const m=R(k(s[3],!0));if(null===l&&(l=["*"]),!1===ie(l))throw new o(e,"InvalidParameter",t);if(null===s[0])return null;if(!M(s[0]))throw new o(e,"InvalidParameter",t);const p=n._layer;let u;if(A(p))u=p;else{if(null==p||!H(p))return null;u=j(p,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)}u=await u.load();const c=u.relationshipMetaData().filter(e=>e.name===a);if(0===c.length)return null;if(void 0!==c[0].relationshipTableId&&null!==c[0].relationshipTableId&&c[0].relationshipTableId>-1)return b(u,c[0],n.field(u.objectIdField),u.spatialReference,l,m,e.lrucache,e.interceptor);let d=u.serviceUrl();if(!d)return null;d=d.endsWith("/")?d+c[0].relatedTableId.toString():d+"/"+c[0].relatedTableId.toString();const f=await I(d,u.spatialReference,l,m,e.lrucache,e.interceptor);await f.load();let y=f.relationshipMetaData();if(y=y.filter(e=>e.id===c[0].id),!1===n.hasField(c[0].keyField)||null===n.field(c[0].keyField)){const e=await u.getFeatureByObjectId(n.field(u.objectIdField),[c[0].keyField]);if(e){const t=K.create(y[0].keyField+"= @id",{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC});return t.parameters={id:e.attributes[c[0].keyField]},f.filter(t)}return new G({parentfeatureset:f})}const g=K.create(y[0].keyField+"= @id",{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC});return g.parameters={id:n.field(c[0].keyField)},f.filter(g)})},ue.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),ue.functions.featuresetbyassociation=function(t,r){return ue.standardFunctionAsync(t,r,async(i,s,n)=>{x(n,2,3,t,r);const l=n[0],m=a(L(k(n[1],""))),p=re(n[2])?L(n[2]):null;if(null===n[0])return null;if(!M(n[0]))throw new o(t,"InvalidParameter",r);let u=l._layer;if(u instanceof _&&(u=j(u,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===u)return null;if(!1===A(u))return null;await u.load();const c=u.serviceUrl(),d=await g(c,t.spatialReference,!0);if(d.unVersion>=8)return await async function(t,r,i,s,n,a,l){const m=await t.getFeatureSetInfo();if(null===(m?.layerId??null))return null;if(!n.layerIdLookup.get(m.layerId))return null;const p=t.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),u=[];switch(i){case"connected":u.push("connectivity"),u.push("junction-edge-from-connectivity"),u.push("junction-edge-to-connectivity"),u.push("junction-edge-midspan-connectivity"),u.push("junction-junction-connectivity");break;case"container":case"content":u.push("containment");break;case"structure":case"attached":u.push("attachment");break;case"junctionedge":u.push("junction-edge-from-connectivity"),u.push("junction-edge-to-connectivity");break;case"midspan":u.push("junction-edge-midspan-connectivity");break;default:throw new o(a,"InvalidParameter",l)}let c=null,d=!1;if(null!==s&&""!==s&&void 0!==s){for(const e of n.terminals)e.terminalName===s&&(c=e.terminalId);null===c&&(d=!0)}const f=[];if(!d){const s=new ee({globalId:r.field(t.globalIdField),networkSourceId:n.layerIdLookup.get(m.layerId).sourceId,...c?{terminalId:c}:""}),o=await X(p,new te({types:u,elements:[s]}));let a=0;for(const t of o.associations){let r=null,o="",l="";if(t.fromNetworkElement?.globalId===s.globalId?(r=t.toNetworkElement,l="to"):t.toNetworkElement?.globalId===s.globalId&&(r=t.fromNetworkElement,l="from"),!r)continue;switch(i){case"attached":if("attachment"!==t.associationType)continue;if("to"!==l)continue;break;case"structure":if("attachment"!==t.associationType)continue;if("from"!==l)continue;break;case"container":if("containment"!==t.associationType)continue;if("from"!==l)continue;break;case"content":if("containment"!==t.associationType)continue;if("to"!==l)continue;break;case"connected":break;case"junctionedge":"junction-edge-to-connectivity"===t.associationType?o="to":"junction-edge-from-connectivity"===t.associationType&&(o="from");break;case"midspan":if("junction-edge-midspan-connectivity"!==t.associationType)continue}const m=n.sourceIdLookup.get(r.networkSourceId)?.className??"";f.push(new e({geometry:null,attributes:{objectId:a++,globalId:r.globalId,percentAlong:t.percentAlong??0,isContentVisible:t.isContentVisible?0:1,className:m,side:o}}))}}const y=new _({source:f,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new J({name:"objectId",alias:"objectId",type:"oid"}),new J({name:"globalId",alias:"globalId",type:"global-id"}),new J({name:"percentAlong",alias:"percentAlong",type:"double"}),new J({name:"side",alias:"side",type:"string"}),new J({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new J({name:"className",alias:"className",type:"string"})]});return j(y)}(u,l,m,p,d,t,r);const f=d.associations;let y=null,b=null,I=!1;if(null!==p&&""!==p&&void 0!==p){for(const e of d.terminals)e.terminalName===p&&(b=e.terminalId);null===b&&(I=!0)}const S=f.getFieldsIndex(),E=S.get("TOGLOBALID").name,C=S.get("FROMGLOBALID").name,U=S.get("TOTERMINALID").name,v=S.get("FROMTERMINALID").name,N=S.get("FROMNETWORKSOURCEID").name,P=S.get("TONETWORKSOURCEID").name,R=S.get("ASSOCIATIONTYPE").name,Z=S.get("ISCONTENTVISIBLE").name,$=S.get("OBJECTID").name;for(const e of u.fields)if("global-id"===e.type){y=l.field(e.name);break}let O=null,V=new h(new J({name:"percentalong",alias:"percentalong",type:"double"}),K.create("0",{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC})),B=new h(new J({name:"side",alias:"side",type:"string"}),K.create("''",{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC}));const G="globalid",W="globalId",H={};for(const e in d.lkp)H[e]=d.lkp[e].sourceId;const Q=new w(new J({name:"classname",alias:"classname",type:"string"}),null,H);let Y="";switch(m){case"midspan":{Y=`((${E}='${y}') OR ( ${C}='${y}')) AND (${R} IN (5))`,Q.codefield=K.create(`CASE WHEN (${E}='${y}') THEN ${N} ELSE ${P} END`,{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC});const e=q(T.findField(f.fields,C));e.name=G,e.alias=G,O=new h(e,K.create(`CASE WHEN (${C}='${y}') THEN ${E} ELSE ${C} END`,{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC})),V=d.unVersion>=4?new D(T.findField(f.fields,S.get("PERCENTALONG").name)):new h(new J({name:"percentalong",alias:"percentalong",type:"double"}),K.create("0",{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{Y=`((${E}='${y}') OR ( ${C}='${y}')) AND (${R} IN (4,6))`,Q.codefield=K.create(`CASE WHEN (${E}='${y}') THEN ${N} ELSE ${P} END`,{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC});const e=q(T.findField(f.fields,C));e.name=G,e.alias=G,O=new h(e,K.create(`CASE WHEN (${C}='${y}') THEN ${E} ELSE ${C} END`,{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC})),B=new h(new J({name:"side",alias:"side",type:"string"}),K.create(`CASE WHEN (${R}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let e=`${E}='@T'`,t=`${C}='@T'`;null!==b&&(e+=` AND ${U}=@A`,t+=` AND ${v}=@A`),Y="(("+e+") OR ("+t+"))",Y=z(Y,"@T",y??""),e=z(e,"@T",y??""),null!==b&&(e=z(e,"@A",b.toString()),Y=z(Y,"@A",b.toString())),Q.codefield=K.create("CASE WHEN "+e+` THEN ${N} ELSE ${P} END`,{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC});const r=q(T.findField(f.fields,C));r.name=G,r.alias=G,O=new h(r,K.create("CASE WHEN "+e+` THEN ${C} ELSE ${E} END`,{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC}));break}case"container":Y=`${E}='${y}' AND ${R} = 2`,null!==b&&(Y+=` AND ${U} = `+b.toString()),Q.codefield=N,Y="( "+Y+" )",O=new F(T.findField(f.fields,C),G,G);break;case"content":Y=`(${C}='${y}' AND ${R} = 2)`,null!==b&&(Y+=` AND ${v} = `+b.toString()),Q.codefield=P,Y="( "+Y+" )",O=new F(T.findField(f.fields,E),G,G);break;case"structure":Y=`(${E}='${y}' AND ${R} = 3)`,null!==b&&(Y+=` AND ${U} = `+b.toString()),Q.codefield=N,Y="( "+Y+" )",O=new F(T.findField(f.fields,C),G,W);break;case"attached":Y=`(${C}='${y}' AND ${R} = 3)`,null!==b&&(Y+=` AND ${v} = `+b.toString()),Q.codefield=P,Y="( "+Y+" )",O=new F(T.findField(f.fields,E),G,W);break;default:throw new o(t,"InvalidParameter",r)}return I&&(Y="1 <> 1"),new T({parentfeatureset:f,adaptedFields:[new D(T.findField(f.fields,$)),new D(T.findField(f.fields,Z)),O,B,Q,V],extraFilter:Y?K.create(Y,{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC}):null})})},ue.signatures.push({name:"featuresetbyassociation",min:2,max:6}),ue.functions.groupby=function(e,t){return ue.standardFunctionAsync(e,t,async(r,i,n)=>{if(x(n,3,3,e,t),!A(n[0]))throw new o(e,"InvalidParameter",t);const a=await n[0].load(),l=[],m=[];let p=!1,u=[];if(re(n[1]))u.push(n[1]);else if(n[1]instanceof s)u.push(n[1]);else if(ie(n[1]))u=n[1];else{if(!Z(n[1]))throw new o(e,"InvalidParameter",t);u=n[1].toArray()}for(const r of u)if(re(r)){const e=K.create(L(r),{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}),t=!0===W(e)?L(r):"%%%%FIELDNAME";l.push({name:t,expression:e}),"%%%%FIELDNAME"===t&&(p=!0)}else{if(!(r instanceof s))throw new o(e,"InvalidParameter",t);{const i=r.hasField("name")?r.field("name"):"%%%%FIELDNAME",s=r.hasField("expression")?r.field("expression"):"";if("%%%%FIELDNAME"===i&&(p=!0),!i)throw new o(e,"InvalidParameter",t);l.push({name:i,expression:K.create(s||i,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})})}}if(u=[],re(n[2]))u.push(n[2]);else if(ie(n[2]))u=n[2];else if(Z(n[2]))u=n[2].toArray();else{if(!(n[2]instanceof s))throw new o(e,"InvalidParameter",t);u.push(n[2])}for(const r of u){if(!(r instanceof s))throw new o(e,"InvalidParameter",t);{const i=r.hasField("name")?r.field("name"):"",s=r.hasField("statistic")?r.field("statistic"):"",n=r.hasField("expression")?r.field("expression"):"";if(!(i&&s&&re(s)&&n))throw new o(e,"InvalidParameter",t);m.push({name:i,statistic:s,expression:K.create(n,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})})}}if(p){const e={};for(const t of a.fields)e[t.name.toLowerCase()]=1;for(const t of l)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);for(const t of m)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const r of l)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}for(const t of l)oe(t.expression,ue,e);for(const t of m)oe(t.expression,ue,e);return n[0].groupby(l,m)})},ue.signatures.push({name:"groupby",min:3,max:3}),ue.functions.distinct=function(e,t){return ue.standardFunctionAsync(e,t,async(r,n,a)=>{if(A(a[0])){x(a,2,2,e,t);const r=await a[0].load(),i=[];let n=[];if(re(a[1]))n.push(a[1]);else if(a[1]instanceof s)n.push(a[1]);else if(ie(a[1]))n=a[1];else{if(!Z(a[1]))throw new o(e,"InvalidParameter",t);n=a[1].toArray()}let l=!1;for(const a of n)if(re(a)){const e=K.create(L(a),{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}),t=!0===W(e)?L(a):"%%%%FIELDNAME";i.push({name:t,expression:e}),"%%%%FIELDNAME"===t&&(l=!0)}else{if(!(a instanceof s))throw new o(e,"InvalidParameter",t);{const s=a.hasField("name")?a.field("name"):"%%%%FIELDNAME",n=a.hasField("expression")?a.field("expression"):"";if("%%%%FIELDNAME"===s&&(l=!0),!s)throw new o(e,"InvalidParameter",t);i.push({name:s,expression:K.create(n||s,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})})}}if(l){const e={};for(const t of r.fields)e[t.name.toLowerCase()]=1;for(const t of i)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const r of i)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}for(const t of i)oe(t.expression,ue,e);return a[0].groupby(i,[])}return function(e){if(1===e.length){if(ie(e[0]))return i("distinct",e[0],-1);if(Z(e[0]))return i("distinct",e[0].toArray(),-1)}return i("distinct",e,-1)}(a)})},ue.functions.getfeaturesetinfo=function(e,t){return ue.standardFunctionAsync(e,t,async(r,i,o)=>{if(x(o,1,1,e,t),!A(o[0]))return null;const n=await o[0].getFeatureSetInfo();return n?s.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},v(e),!1,!1):null})},ue.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),ue.functions.filterbysubtypecode=function(e,t){return ue.standardFunctionAsync(e,t,async(r,i,s)=>{if(x(s,2,2,e,t),A(s[0])){const r=await s[0].load(),i=s[1];if(!se(i))throw new o(e,"InvalidParameter",t);if(r.subtypeField){const e=K.create(`${r.subtypeField}= ${s[1]}`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});return new c({parentfeatureset:s[0],whereclause:e})}if(null===r.typeIdField||""===r.typeIdField)throw new o(e,"FeatureSetDoesNotHaveSubtypes",t);const n=K.create(`${r.typeIdField}= ${s[1]}`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});return new c({parentfeatureset:s[0],whereclause:n})}throw new o(e,"InvalidParameter",t)})},ue.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{ue as registerFunctions};
