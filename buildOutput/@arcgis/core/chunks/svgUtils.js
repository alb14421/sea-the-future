/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../Color.js";import{h as e}from"../core/lang.js";import{b as i}from"./maybe.js";import{c as n}from"./mat2df32.js";import{m as r,s as o,c as a,t as s,r as l}from"./mat2d.js";import{b as h}from"./gfxUtils.js";import"./widgetUtils.js";import{t as f}from"./jsxFactory.js";let c=0,u=0,d=0;const y=e("android"),p=e("chrome")||y&&y>=4?"auto":"optimizeLegibility",g={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7,z:0},m=/([A-DF-Za-df-z])|([-+]?\d*\.?\d+(?:[eE][-+]?\d+)?)/g;let x={},w={};const k=Math.PI;function b(t,e){const i=t*(k/180);return Math.abs(e*Math.sin(i))+Math.abs(e*Math.cos(i))}function j(t){return t.map(t=>`${t.command} ${t.values.join(" ")}`).join(" ").trim()}function M(t,e,n,r,o){if(t){if("circle"===t.type)return f("circle",{cx:t.cx,cy:t.cy,fill:e,"fill-rule":"evenodd",r:t.r,stroke:n.color,"stroke-dasharray":n.dashArray,"stroke-dashoffset":n.dashOffset,"stroke-linecap":n.cap,"stroke-linejoin":n.join,"stroke-miterlimit":"4","stroke-width":n.width});if("ellipse"===t.type)return f("ellipse",{cx:t.cx,cy:t.cy,fill:e,"fill-rule":"evenodd",rx:t.rx,ry:t.ry,stroke:n.color,"stroke-dasharray":n.dashArray,"stroke-linecap":n.cap,"stroke-linejoin":n.join,"stroke-miterlimit":"4","stroke-width":n.width});if("rect"===t.type)return f("rect",{fill:e,"fill-rule":"evenodd",height:t.height,stroke:n.color,"stroke-dasharray":n.dashArray,"stroke-linecap":n.cap,"stroke-linejoin":n.join,"stroke-miterlimit":"4","stroke-width":n.width,width:t.width,x:t.x,y:t.y});if("image"===t.type)return f("image",{alt:o||"image",height:t.height,href:t.src,preserveAspectRatio:"none",width:t.width,x:t.x,y:t.y});if("path"===t.type){const i="string"!=typeof t.path?j(t.path):t.path;return f("path",{d:i,fill:e,"fill-rule":"evenodd",stroke:n.color,"stroke-dasharray":n.dashArray,"stroke-linecap":n.cap,"stroke-linejoin":n.join,"stroke-miterlimit":"4","stroke-width":n.width})}if("text"===t.type)return i(r),f("text",{"dominant-baseline":r.dominantBaseline,fill:e,"fill-rule":"evenodd","font-family":r.font.family,"font-size":r.font.size,"font-style":r.font.style,"font-variant":r.font.variant,"font-weight":r.font.weight,kerning:r.kerning,rotate:r.rotate,stroke:n.color,"stroke-dasharray":n.dashArray,"stroke-linecap":n.cap,"stroke-linejoin":n.join,"stroke-miterlimit":"4","stroke-width":n.width,"text-anchor":r.align,"text-decoration":r.decoration,"text-rendering":p,x:t.x,y:t.y},t.text)}return null}function v(e){if(!e)return{fill:"none",pattern:null,linearGradient:null};if(!("type"in e))return{fill:new t(e).toString(),pattern:null,linearGradient:null};if("pattern"===e.type){const t="patternId-"+c++;return{fill:`url(#${t})`,pattern:{id:t,x:e.x,y:e.y,width:e.width,height:e.height,image:{x:0,y:0,width:e.width,height:e.height,href:e.src}},linearGradient:null}}const i="linearGradientId-"+u++;return{fill:`url(#${i})`,pattern:null,linearGradient:{id:i,x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2,stops:e.colors.map(e=>({offset:e.offset,color:e.color&&new t(e.color).toString()}))}}}function A(e){const i={color:"none",width:1,cap:"butt",join:"4",dashArray:"none",dashOffset:"0"};return e&&(null!=e.width&&(i.width=e.width),e.cap&&(i.cap=e.cap),e.join&&(i.join=e.join.toString()),e.color&&(i.color=new t(e.color).toString()),e.dashArray&&(i.dashArray=e.dashArray),e.dashoffset&&(i.dashOffset=e.dashoffset),e.style&&!e.dashArray&&(i.dashArray=h(e).join(",")||"none")),i}function S(t,e){const n={align:null,decoration:null,kerning:null,rotate:null,font:{style:null,variant:null,weight:null,size:null,family:null}};if(t){const r=t.alignBaseline,o="baseline"===r?"auto":"top"===r?"text-top":"bottom"===r?"hanging":r;n.align=t.align,n.dominantBaseline=o,n.decoration=t.decoration,n.kerning=t.kerning?"auto":"0",n.rotate=t.rotated?"90":"0",i(e),n.font.style=e.style||"normal",n.font.variant=e.variant||"normal",n.font.weight=e.weight||"normal",n.font.size=e.size&&e.size.toString()||"10pt",n.font.family=e.family||"serif"}return n}function G(t){const{pattern:e,linearGradient:i}=t;if(e)return f("pattern",{height:e.height,id:e.id,patternUnits:"userSpaceOnUse",width:e.width,x:e.x,y:e.y},f("image",{height:e.image.height,href:e.image.href,width:e.image.width,x:e.image.x,y:e.image.y}));if(i){const t=i.stops.map((t,e)=>f("stop",{key:`${e}-stop`,offset:t.offset,"stop-color":t.color}));return f("linearGradient",{gradientUnits:"userSpaceOnUse",id:i.id,x1:i.x1,x2:i.x2,y1:i.y1,y2:i.y2},t)}return null}function $(t,e){if(!t||0===t.length)return null;const i=[];for(const e of t){const{shape:t,fill:n,stroke:r,font:o}=e,a=v(n),s=A(r),l="text"===t.type?S(t,o):null,h=M(t,a.fill,s,l);h&&i.push(h)}return f("mask",{id:e,maskUnits:"userSpaceOnUse"},f("g",null,i))}function N(t,e,i){return s(t,a(t),[e,i])}function z(t,e,i,n,r){return o(t,a(t),[e,i]),t[4]=t[4]*e-n*e+n,t[5]=t[5]*i-r*i+r,t}function B(t,e){x&&"left"in x?(null!=x.left&&x.left>t&&(x.left=t),(null==x.right||x.right<t)&&(x.right=t),(null==x.top||x.top>e)&&(x.top=e),(null==x.bottom||x.bottom<e)&&(x.bottom=e)):x={left:t,bottom:e,right:t,top:e}}function I(t){const e=t.args,i=e.length;let n;switch(t.action){case"M":case"L":case"C":case"S":case"Q":case"T":for(n=0;n<i;n+=2)B(e[n],e[n+1]);w.x=e[i-2],w.y=e[i-1];break;case"H":for(n=0;n<i;++n)B(e[n],w.y);w.x=e[i-1];break;case"V":for(n=0;n<i;++n)B(w.x,e[n]);w.y=e[i-1];break;case"m":{let t=0;"x"in w||(B(w.x=e[0],w.y=e[1]),t=2);for(n=t;n<i;n+=2)B(w.x+=e[n],w.y+=e[n+1]);break}case"l":case"t":for(n=0;n<i;n+=2)B(w.x+=e[n],w.y+=e[n+1]);break;case"h":for(n=0;n<i;++n)B(w.x+=e[n],w.y);break;case"v":for(n=0;n<i;++n)B(w.x,w.y+=e[n]);break;case"c":for(n=0;n<i;n+=6)B(w.x+e[n],w.y+e[n+1]),B(w.x+e[n+2],w.y+e[n+3]),B(w.x+=e[n+4],w.y+=e[n+5]);break;case"s":case"q":for(n=0;n<i;n+=4)B(w.x+e[n],w.y+e[n+1]),B(w.x+=e[n+2],w.y+=e[n+3]);break;case"A":for(n=0;n<i;n+=7)B(e[n+5],e[n+6]);w.x=e[i-2],w.y=e[i-1];break;case"a":for(n=0;n<i;n+=7)B(w.x+=e[n+5],w.y+=e[n+6])}}function U(t,e,i){const n=g[t.toLowerCase()];let r;"number"==typeof n&&(n?e.length>=n&&(r={action:t,args:e.slice(0,e.length-e.length%n)},i.push(r),I(r)):(r={action:t,args:[]},i.push(r),I(r)))}function F(t){const e={x:0,y:0,width:0,height:0};if("circle"===t.type)e.x=t.cx-t.r,e.y=t.cy-t.r,e.width=2*t.r,e.height=2*t.r;else if("ellipse"===t.type)e.x=t.cx-t.rx,e.y=t.cy-t.ry,e.width=2*t.rx,e.height=2*t.ry;else if("image"===t.type||"rect"===t.type)e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height;else if("path"===t.type){const i=function(t){const e=("string"!=typeof t.path?j(t.path):t.path).match(m),i=[];if(x={},w={},!e)return null;let n="",r=[];const o=e.length;for(let t=0;t<o;++t){const o=e[t],a=parseFloat(o);isNaN(a)?(n&&U(n,r,i),r=[],n=o):r.push(a)}U(n,r,i);const a={x:0,y:0,width:0,height:0};return x&&"left"in x&&(a.x=x.left,a.y=x.top,a.width=x.right-x.left,a.height=x.bottom-x.top),a}(t);e.x=i.x,e.y=i.y,e.width=i.width,e.height=i.height}return e}function O(t){const e={x:0,y:0,width:0,height:0};let i=null,n=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY;for(const o of t)i?(i.x=Math.min(i.x,o.x),i.y=Math.min(i.y,o.y),n=Math.max(n,o.x+o.width),r=Math.max(r,o.y+o.height)):(i=e,i.x=o.x,i.y=o.y,n=o.x+o.width,r=o.y+o.height);return i&&(i.width=n-i.x,i.height=r-i.y),i}function E(t,e,i,o,s,h,f,c,u){let d=(f&&h?b(h,e):e)/2,y=(f&&h?b(h,i):i)/2;if(u){const t=u[0],e=u[1];d=(f&&h?b(h,t):t)/2,y=(f&&h?b(h,e):e)/2}const p=t.width+o,g=t.height+o,m=n(),x=n();let w=!1;if(s&&0!==p&&0!==g){const t=e!==i?e/i:p/g,n=e>i?e:i;let o=1,a=1;isNaN(n)||(t>1?(o=n/p,a=n/t/g):(a=n/g,o=n*t/p)),r(x,x,z(m,o,a,d,y)),w=!0}const k=t.x+(p-o)/2,j=t.y+(g-o)/2;if(r(x,x,N(m,d-k,y-j)),!w&&(p>e||g>i)){const t=p/e>g/i,n=(t?e:i)/(t?p:g);r(x,x,z(m,n,n,k,j))}return c&&r(x,x,N(m,c[0],c[1])),h&&r(x,x,function(t,e,i,n){const r=e%360*Math.PI/180;l(t,a(t),r);const o=Math.cos(r),s=Math.sin(r),h=t[4],f=t[5];return t[4]=h*o-f*s+n*s-i*o+i,t[5]=f*o+h*s-i*s-n*o+n,t}(m,h,k,j)),`matrix(${x[0]},${x[1]},${x[2]},${x[3]},${x[4]},${x[5]})`}function T(t,e,n,r={}){const o=[],a=[],s=d++,l=function(t,e,i){const n=t?.effects.find(t=>"bloom"===t.type);if(!n)return null;const{strength:r,radius:o}=n,a=r>0?o:0,s=(r+a)*e,l=4*r+1;return f("filter",{filterUnits:"userSpaceOnUse",height:"300%",id:`bloom${i}`,width:"300%",x:"-100%",y:"-100%"},f("feMorphology",{in:"SourceGraphic",operator:"dilate",radius:(r+.5*a)*(5**(e/100)*(.4+e/100)),result:"dilate"}),f("feGaussianBlur",{in:"dilate",result:"blur",stdDeviation:s/25}),f("feGaussianBlur",{in:"blur",result:"intensityBlur",stdDeviation:s/50}),f("feComponentTransfer",{in:"SourceGraphic",result:"intensityBrightness"},f("feFuncR",{slope:l,type:"linear"}),f("feFuncG",{slope:l,type:"linear"}),f("feFuncB",{slope:l,type:"linear"})),f("feMerge",null,f("feMergeNode",{in:"intensityBlur"}),f("feMergeNode",{in:"intensityBrightness"}),f("feGaussianBlur",{stdDeviation:r/10})))}(r.effectView,e,s);let h=null;if(l){const t=r.effectView?.effects.find(t=>"bloom"===t.type),i=r.clipBloomEffect||!t.strength?0:(t.strength+t.radius/2)/3,o=e+e*i,a=n+n*i;h=[Math.max(o,10),Math.max(a,10)]}let c=e,u=n;if(r.useRotationSize)for(let i=0;i<t.length;i++){const t=r.rotations?.[i]??0;c=Math.max(b(t,e),c),u=Math.max(b(t,n),u)}for(let i=0;i<t.length;i++){const s=t[i],l=[],d=[];let y=0,p=0,g=0;for(const t of s){const{shape:e,fill:i,stroke:n,font:a,offset:s}=t;r.ignoreStrokeWidth||"text"===e.type||(y+=n?.width||0);const h=v(i),f=A(n),c="text"===e.type?S(e,a):null;o.push(G(h)),l.push(M(e,h.fill,f,c,r.ariaLabel)),d.push(F(e)),s&&(p+=s[0],g+=s[1])}const m=r.rotations?.[i]??0;r.useRotationSize&&(p+=(c-b(m,e))/2,g+=(u-b(m,n))/2);const x=E(O(d),e,n,y,r.scale??!1,m,r.useRotationSize??!1,[p,g],h);let w=null;if(r.masking){const t=`mask-${i}`,e=r.masking[i];o.push($(e,t)),w=`url(#${t})`}a.push(w?f("g",{mask:w},f("g",{transform:x},l)):f("g",{transform:x},l))}return l&&(i(h),c=h[0],u=h[1]),f("svg",{"aria-label":r.ariaLabel,focusable:!1,height:u,role:"img",style:"display: block;",width:c,xmlns:"http://www.w3.org/2000/svg"},l,f("defs",null,o),l?f("g",{filter:`url(#bloom${s})`},a):a)}export{E as a,v as b,O as c,G as d,M as e,A as f,F as g,T as r};
