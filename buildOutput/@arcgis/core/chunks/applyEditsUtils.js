/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../Graphic.js";import e from"../core/Error.js";import{L as a}from"./Logger.js";import{p as s,P as r}from"./unitUtils.js";import{parseData as o}from"../core/urlUtils.js";import{isEqualBaseGCS as n,canProjectWithoutEngine as l,projectWithoutEngine as i}from"./projectionUtils.js";import{fromJSON as u}from"../geometry/support/jsonUtils.js";import d from"../geometry/support/MeshTransform.js";import{isFeatureIdentifierArrayWithGlobalId as c,isFeatureIdentifierArrayWithObjectId as p}from"./editingSupport.js";async function m(t,e,a){const{geometry:o}=e,u={...e.attributes};if(null!=a&&"mesh"===o?.type){const{transformFieldRoles:e}=a,{origin:c,spatialReference:p,vertexSpace:m}=o,f=o.transform??new d,g="local"===m.type,b=t.spatialReference,R=b.isGeographic,h=s(b,p),y=n(p,b)&&l(p,b);if(!(g&&R&&y||!g&&!R&&h))return null;const I=i(c,p,b);if(null==I)return null;if(u[e.originX]=I.x,u[e.originY]=I.y,u[e.originZ]=I.z??0,null!=f){const{translation:t,scale:a,rotation:s}=f,o=g?1:r(p)/r(b);u[e.translationX]=t[0]*o,u[e.translationY]=t[2]*o,u[e.translationZ]=-t[1]*o,u[e.scaleX]=a[0],u[e.scaleY]=a[2],u[e.scaleZ]=a[1],u[e.rotationX]=s[0],u[e.rotationY]=s[2],u[e.rotationZ]=-s[1],u[e.rotationDeg]=s[3]}return{attributes:u}}return null==o?{attributes:u}:"mesh"===o.type||"extent"===o.type?null:{geometry:o.toJSON(),attributes:u}}async function f(t,e){const a=await Promise.all((e.addAttachments??[]).map(e=>g(t,e))),s=await Promise.all((e.updateAttachments??[]).map(e=>g(t,e))),r=e.deleteAttachments??[];return a.length||s.length||r.length?{adds:a,updates:s,deletes:[...r]}:null}async function g(t,e){const{feature:a,attachment:s}=e,{globalId:r,name:n,contentType:l,data:i,uploadId:u}=s,d={globalId:r};if(a&&("attributes"in a?d.parentGlobalId=a.attributes?.[t.globalIdField]:a.globalId&&(d.parentGlobalId=a.globalId)),u)d.uploadId=u;else if(i){const t=await o(i);t&&(d.contentType=t.mediaType,d.data=t.data),i instanceof File&&(d.name=i.name)}return n&&(d.name=n),l&&(d.contentType=l),d}function b(t,e,a){if(!e||0===e.length)return[];if(a&&c(e))return e.map(t=>t.globalId);if(p(e))return e.map(t=>t.objectId);const s=a?t.globalIdField:t.objectIdField;return s?e.map(t=>t.getAttribute(s)):[]}function R(t){const e=t?.assetMaps;if(e){for(const t of e.addResults)t.success||a.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${t.globalId}.`);for(const t of e.updateResults)t.success||a.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${t.globalId}.`)}const s=t?.attachments,r={addFeatureResults:t?.addResults?.map(h)??[],updateFeatureResults:t?.updateResults?.map(h)??[],deleteFeatureResults:t?.deleteResults?.map(h)??[],addAttachmentResults:s?.addResults?s.addResults.map(h):[],updateAttachmentResults:s?.updateResults?s.updateResults.map(h):[],deleteAttachmentResults:s?.deleteResults?s.deleteResults.map(h):[]};return t?.editMoment&&(r.editMoment=t.editMoment),r}function h(t){const a=!0===t.success?null:t.error||{code:void 0,description:"Feature edit failed"};return{objectId:t.objectId,globalId:t.globalId,error:a?new e("feature-layer-source:edit-failure",a.description,{code:a.code}):null}}function y(e,a){return new t({attributes:e.attributes,geometry:u({...e.geometry,spatialReference:a})})}function I(t,e){return{adds:t?.adds?.map(t=>y(t,e))||[],updates:t?.updates?.map(t=>({original:y(t[0],e),current:y(t[1],e)}))||[],deletes:t?.deletes?.map(t=>y(t,e))||[],spatialReference:e}}function j(t){const e=t.details.raw,a=+e.code,s=+e.extendedCode;return 500===a&&(-2147217144===s||-2147467261===s)}export{b as a,f as b,I as c,h as d,m as g,j as i,R as u};
