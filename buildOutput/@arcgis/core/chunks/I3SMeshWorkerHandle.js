/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{L as s}from"./Logger.js";import{P as t}from"./PooledArray.js";import{c as o}from"./vec3f64.js";import{W as e}from"./WorkerHandle.js";import{canProjectWithoutEngine as r}from"./projectionUtils.js";import{p as i}from"./projectVectorToVector.js";class n{constructor(s,t,o,e,r,i){this.layout=s,this.interleavedVertexData=t,this.indices=o,this.hasColors=e,this.hasModifications=r,this.positionData=i}}class a{constructor(s,t,o,e,r,i,n){this.componentOffsets=s,this.featureIds=t,this.anchorIds=o,this.anchors=e,this.transformedGeometry=r,this.globalTrafo=i,this.obb=n}}class h extends e{constructor(s){super("SceneLayerWorker","process",{process:s=>[s.geometryBuffer],project:s=>[s.positions.buffer],transformNormals:s=>[s.normals.buffer]},s,{hasInitialize:!0})}setModifications(s,t,o){const e={context:s,modifications:t,isGeodetic:o};return this.broadcast(e,"setModifications")}setLegacySchema(s,t){const o=JSON.stringify(t);return this.broadcast({context:s,jsonSchema:o},"setLegacySchema")}destroyContext(s){return this.broadcast(s,"destroyContext")}async destroyContextAndSelf(s){await this.destroyContext(s),this.destroy()}project(s,t){return this.invokeMethod("project",s,t)}transformNormals(s,t){return this.invokeMethod("transformNormals",s,t)}}const p=new t({deallocator:null}),c=o();function u(t,o,e){p.clear();let n=1/0,a=1/0,h=-1/0,u=-1/0,l=!1;for(const t of o){const o="clip"===t.type?2:"mask"===t.type?1:0,f=t.geometry;let m=s=>s;if(f.spatialReference){if(!r(f.spatialReference,e)){s.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-projection-failed","Can't project modification polygon into layer spatial reference, ignoring modification",{polygon:f});continue}m=s=>(i(s,f.spatialReference,c,e),c)}else f.hasZ||(c[2]=0,m=s=>(c[0]=s[0],c[1]=s[1],c));l=l||1===o;const d=f.rings.length,g=f.rings.some(s=>s.length<3);if(0===d||g)s.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-invalid-polygon","Ignoring invalid modification polygon (no rings or rings with less than 3 vertices).",{polygon:f});else{p.push(o),p.push(d);for(const s of f.rings){p.push(s.length);for(const t of s){const s=m(t);p.push(s[0]),p.push(s[1]),p.push(s[2]),n=Math.min(n,s[0]),a=Math.min(a,s[1]),h=Math.max(h,s[0]),u=Math.max(u,s[1])}}}}if(null!=t)if(l){const s=1e-4;p.push(2),p.push(2),p.push(4),p.push(n-s),p.push(a-s),p.push(0),p.push(h+s),p.push(a-s),p.push(0),p.push(h+s),p.push(u+s),p.push(0),p.push(n-s),p.push(u+s),p.push(0),p.push(4),p.push(t[0]),p.push(t[1]),p.push(0),p.push(t[2]),p.push(t[1]),p.push(0),p.push(t[2]),p.push(t[3]),p.push(0),p.push(t[0]),p.push(t[3]),p.push(0)}else p.push(1),p.push(1),p.push(4),p.push(t[0]),p.push(t[1]),p.push(0),p.push(t[2]),p.push(t[1]),p.push(0),p.push(t[2]),p.push(t[3]),p.push(0),p.push(t[0]),p.push(t[3]),p.push(0);p.push(3);const f=new Float64Array(p.length);for(let s=0;s<p.length;++s)f[s]=p.at(s);return f}export{h as I,n as T,a,u as t};
