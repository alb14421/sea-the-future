/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{p as t}from"./screenUtils.js";import{T as e,j as s}from"./GeometryUtils.js";import{b as r,a as i,c as n,d as a,p as o,s as c,e as u,f as l}from"./constants4.js";import{D as p}from"./enums.js";import{p as h,D as x,t as f,s as d,g as m}from"./definitions.js";import{a as y,b as _,e as g}from"./UpdateTracking2D.js";import{L as v}from"./Logger.js";import{e as b}from"./mathUtils.js";import{G as k}from"./labelPoint.js";import{h as w}from"../core/lang.js";import{t as P,l as S}from"./libtess.js";import{v as T,i as M,p as E,d as A}from"./utils30.js";import L from"../Color.js";import F from"../core/Error.js";import{L as O}from"./TurboLine.js";import"./earcut.js";import{O as D}from"./OptimizedGeometry.js";import{g as I,d as N,S as z,l as G}from"./CIMSymbolHelper.js";import{c as C}from"../geometry/Polygon.js";const U=96/72;class Y{static executeEffects(t,e,s,r){const i=U,n=I(t);let a=new z(e);for(const e of t){const t=N(e);t&&(a=t.execute(a,e,i,s,n,r))}return a}static applyEffects(t,e){if(!t)return e;const s=I(t);let r,i=new z(k.fromJSONCIM(e));for(const e of t){const t=N(e);t&&(i=t.execute(i,e,1,null,s,!1))}const n=[];let a=null;for(;r=i.next();)n.push(...C(r)),a=r.geometryType;return 0===n.length||null===a?null:"esriGeometryPolygon"===a?{rings:n}:{paths:n}}}function R(t,e){return[!!t?.minScale&&e.scaleToZoom(t.minScale)||0,!!t?.maxScale&&e.scaleToZoom(t.maxScale)||100]}function B(t){return 1<<t}function V(t){let e=0;for(const[s,r]of t)r&&(e|=1<<s);return e}function W(t){let e;if(!t)return[0,0,0,0];if("string"==typeof t){const s=L.fromString(t);if(!s)return v.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.meshWriterUtils").errorOnce(new F("mapview:mesh-processing","Unable to parse string into color",{color:t})),[0,0,0,0];e=s.toArray()}else e=t;const[s,r,i,n]=e;return[s*(n/255),r*(n/255),i*(n/255),n]}function Z(t){switch(t){case"butt":case"Butt":return 0;case"round":case"Round":return 1;case"square":case"Square":return 2}}function H(t){switch(t){case"bevel":case"Bevel":return 0;case"miter":case"Miter":return 2;case"round":case"Round":return 1}}function q(t,e){return Math.round(Math.min(Math.sqrt(t*e),255))}function j(t,e){return Math.round(t*e)/e}function X(t){switch(t){case p.BYTE:case p.UNSIGNED_BYTE:return 1;case p.SHORT:case p.UNSIGNED_SHORT:case p.HALF_FLOAT:return 2;case p.FLOAT:case p.INT:case p.UNSIGNED_INT:return 4}}class J{static fromVertexSpec(t,e){const{attributes:s,optionalAttributes:r}=t;let i,n,a;const o=[];for(const t in s){if(s[t].otherSource)continue;const e=s[t];"position"===e.pack?i={...e,name:t,offset:0}:"id"===e.pack?n={...e,name:t,offset:4}:"bitset"===t?a={...e,name:t,offset:7}:o.push({...e,name:t})}for(const t in r)if(!0===e[t]){const e=r[t];o.push({...e,name:t})}const c=function(t){const e=[],s=[],r=[];for(const i of t){const t=X(i.type)*i.count;switch(t%2||t%4||4){case 4:e.push(i);continue;case 2:s.push(i);continue;case 1:r.push(i);continue;default:throw new Error("Found unexpected dataType byte count")}}return e.push(...s),e.push(...r),e}(o),u=[];let l=8,p=1;for(const t of c)u.push({...t,offset:l}),l+=X(t.type)*t.count,t.packAlternating&&(p=Math.max(t.packAlternating.count,p));const h=Uint32Array.BYTES_PER_ELEMENT,x=l%h;return new J(i,n,a,u,l+(x?h-x:0),p)}constructor(t,e,s,r,i,n){this.position=t,this.id=e,this.bitset=s,this.standardAttributes=r,this.stride=i,this.packVertexCount=n,r.push(s),this._attributes=[t,e,s,...r]}get attributeLayout(){if(!this._attributeLayout){const t=T(this._attributes),e=this._attributes.map(t=>({name:t.name,count:t.count,offset:t.offset,type:t.type,packPrecisionFactor:t.packPrecisionFactor,normalized:t.normalized??!1}));this._attributeLayout={attributes:e,hash:t,stride:this.stride}}return this._attributeLayout}}class ${static fromVertexSpec(t,e){const s=J.fromVertexSpec(t,e);return new $(s)}constructor(t){this._spec=t,this._packed=new Uint8Array(this._spec.stride*this._spec.packVertexCount),this._packedU32View=new Uint32Array(this._packed.buffer),this._dataView=new DataView(this._packed.buffer)}get attributeLayout(){return this._spec.attributeLayout}get stride(){return this._spec.stride}writeVertex(t,e,s,r,i,n){for(let t=0;t<this._spec.packVertexCount;t++){const a=t*this._spec.stride;this._packPosition(s,r,a),this._packId(e,a);const o=this._spec.bitset;if(n){if(o.packTessellation){const t=o.packTessellation(n,i,s,r);this._pack(t,o,a)}for(const t of this._spec.standardAttributes)if(null!=t.packTessellation){const e=t.packTessellation(n,i,s,r);this._pack(e,t,a)}else if(t.packAlternating?.packTessellation){const e=t.packAlternating.packTessellation(n,i,s,r);for(let s=0;s<this._spec.packVertexCount;s++){const r=e[s];this._pack(r,t,s*this._spec.stride)}}}}t.vertexWriteRegion(this._packedU32View)}pack(t,e){for(const s of this._spec.standardAttributes)if(s.pack&&"string"!=typeof s.pack){const r=s.pack(t,e);for(let t=0;t<this._spec.packVertexCount;t++)this._pack(r,s,t*this._spec.stride)}else if(s.packAlternating?.pack){const r=s.packAlternating.pack(t,e);for(let t=0;t<this._spec.packVertexCount;t++){const e=r[t];this._pack(e,s,t*this._spec.stride)}}}_packPosition(t,e,s){const{offset:r}=this._spec.position,i=this._spec.position.packPrecisionFactor??1,n=M(t*i,e*i);this._dataView.setUint32(s+r,n,!0)}_packId(t,e){const s=t*(this._spec.id.packPrecisionFactor??1),r=4278190080&this._dataView.getUint32(e+this._spec.id.offset,!0);this._dataView.setUint32(e+this._spec.id.offset,s|r,!0)}_pack(t,e,s){E(this._dataView,t,e,s)}}class K{constructor(t,e,s,r){this._instanceId=t,this._evaluator=e,this._enabledOptionalAttributes=s,this._viewParams=r,this._evaluator.evaluator=t=>this.vertexSpec.createComputedParams(t)}get _vertexPack(){if(!this._cachedVertexPack){const t=$.fromVertexSpec(this.vertexSpec,this._enabledOptionalAttributes);this._evaluator.hasDynamicProperties||t.pack(this._evaluator.evaluatedMeshParams,this._viewParams),this._cachedVertexPack=t}return this._cachedVertexPack}get evaluatedMeshParams(){return this._evaluator.evaluatedMeshParams}get hasEffects(){return!!this.evaluatedMeshParams.effects}get effectInfos(){return this._evaluator.inputMeshParams.effects?.effectInfos}get instanceId(){return this._instanceId}get attributeLayout(){return this._vertexPack.attributeLayout}get _preventEffectClipping(){return!1}setReferences(t){this._references=t}getBoundsInfo(){return null}getTileInfo(){return this._viewParams.tileInfo}async loadDependencies(){for(const{effect:t}of this.effectInfos||[])await G(t)}enqueueRequest(t,e,s){this._evaluator.hasDynamicProperties&&this._evaluator.enqueueRequest(t,e,s)}write(t,e,s,r,i){this.ensurePacked(e,s,r);const n=this.evaluatedMeshParams.effects;if(!n||0===n.length)return void this._write(t,s,void 0,i);const a=this.getEffectCursor(t,s,n);if(!a)return;let o;for(;o=a.next();)o.invertY(),this._write(t,s,o,i)}ensurePacked(t,e,s){if(!this._evaluator.hasDynamicProperties)return;const r=this._evaluator.evaluateMeshParams(t,e,s);this._vertexPack.pack(r,this._viewParams)}hasArcadeDependency(t){return this._evaluator.hasArcadeDependency(t)}_writeVertex(t,e,s,r,i){const n=this.evaluatedMeshParams;this._vertexPack.writeVertex(t,e,s,r,n,i)}getEffectCursor(t,e,s){const r=e.readGeometryForDisplay()?.clone();if(!r)return;const i=k.fromOptimizedCIM(r,e.geometryType);i.invertY();const n=t.id||"";return Y.executeEffects(s,i,n,this._preventEffectClipping)}}function Q(t,e,s,r,i,n,a){wt=0;const o=(r-s)*n,c=i&&i.length,u=c?(i[0]-s)*n:o;let l,p,h,x,f,d=tt(e,s,0,0,u,n,!0);if(d&&d.next!==d.prev){if(c&&(d=function(t,e,s,r,i,n){const a=new Array;for(let i=0,o=r.length;i<o;i++){const c=tt(t,e,0,r[i]*n,i<o-1?r[i+1]*n:s*n,n,!1);c===c.next&&(c.steiner=!0),a.push(ot(c))}a.sort(mt);for(const t of a)i=ct(t,i);return i}(e,s,r,i,d,n)),o>80*n){l=h=e[0+s*n],p=x=e[1+s*n];for(let t=n;t<u;t+=n){const r=e[t+s*n],i=e[t+1+s*n];l=Math.min(l,r),p=Math.min(p,i),h=Math.max(h,r),x=Math.max(x,i)}f=Math.max(h-l,x-p),f=0!==f?1/f:0}st(d,t,n,l,p,f,a,0)}}function tt(t,e,s,r,i,n,a){let o;if(a===function(t,e,s,r,i,n){let a=0;for(let s=r,o=i-n;s<i;s+=n)a+=(t[o+e*n]-t[s+e*n])*(t[s+1+e*n]+t[o+1+e*n]),o=s;return a}(t,e,0,r,i,n)>0)for(let s=r;s<i;s+=n)o=nt(s+e*n,t[s+e*n],t[s+1+e*n],o);else for(let s=i-n;s>=r;s-=n)o=nt(s+e*n,t[s+e*n],t[s+1+e*n],o);return o&&dt(o,o.next)&&(at(o),o=o.next),o}function et(t,e=t){if(!t)return t;let s,r=t;do{if(s=!1,r.steiner||!dt(r,r.next)&&0!==lt(r.prev,r,r.next))r=r.next;else{if(at(r),r=e=r.prev,r===r.next)break;s=!0}}while(s||r!==e);return e}function st(t,e,s,r,i,n,a,o){if(!t)return;!o&&n&&(t=ut(t,r,i,n));let c=t;for(;t.prev!==t.next;){const u=t.prev,l=t.next;if(n?it(t,r,i,n):rt(t))e.push(u.index/s+a),e.push(t.index/s+a),e.push(l.index/s+a),at(t),t=l.next,c=l.next;else if((t=l)===c){o?1===o?st(t=yt(t,e,s,a),e,s,r,i,n,a,2):2===o&&_t(t,e,s,r,i,n,a):st(et(t),e,s,r,i,n,a,1);break}}}function rt(t){const e=t.prev,s=t,r=t.next;if(lt(e,s,r)>=0)return!1;let i=t.next.next;const n=i;let a=0;for(;i!==t.prev&&(0===a||i!==n);){if(a++,ht(e.x,e.y,s.x,s.y,r.x,r.y,i.x,i.y)&&lt(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function it(t,e,s,r){const i=t.prev,n=t,a=t.next;if(lt(i,n,a)>=0)return!1;const o=i.x<n.x?i.x<a.x?i.x:a.x:n.x<a.x?n.x:a.x,c=i.y<n.y?i.y<a.y?i.y:a.y:n.y<a.y?n.y:a.y,u=i.x>n.x?i.x>a.x?i.x:a.x:n.x>a.x?n.x:a.x,l=i.y>n.y?i.y>a.y?i.y:a.y:n.y>a.y?n.y:a.y,p=ft(o,c,e,s,r),h=ft(u,l,e,s,r);let x=t.prevZ,f=t.nextZ;for(;x&&x.z>=p&&f&&f.z<=h;){if(x!==t.prev&&x!==t.next&&ht(i.x,i.y,n.x,n.y,a.x,a.y,x.x,x.y)&&lt(x.prev,x,x.next)>=0)return!1;if(x=x.prevZ,f!==t.prev&&f!==t.next&&ht(i.x,i.y,n.x,n.y,a.x,a.y,f.x,f.y)&&lt(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;x&&x.z>=p;){if(x!==t.prev&&x!==t.next&&ht(i.x,i.y,n.x,n.y,a.x,a.y,x.x,x.y)&&lt(x.prev,x,x.next)>=0)return!1;x=x.prevZ}for(;f&&f.z<=h;){if(f!==t.prev&&f!==t.next&&ht(i.x,i.y,n.x,n.y,a.x,a.y,f.x,f.y)&&lt(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function nt(t,e,s,r){const i=bt.create(t,e,s);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function at(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ot(t){let e=t,s=t;do{(e.x<s.x||e.x===s.x&&e.y<s.y)&&(s=e),e=e.next}while(e!==t);return s}function ct(t,e){const s=function(t,e){let s=e;const r=t.x,i=t.y;let n,a=-1/0;do{if(i<=s.y&&i>=s.next.y&&s.next.y!==s.y){const t=s.x+(i-s.y)*(s.next.x-s.x)/(s.next.y-s.y);if(t<=r&&t>a){if(a=t,t===r){if(i===s.y)return s;if(i===s.next.y)return s.next}n=s.x<s.next.x?s:s.next}}s=s.next}while(s!==e);if(!n)return null;if(r===a)return n.prev;const o=n,c=n.x,u=n.y;let l,p=1/0;for(s=n.next;s!==o;)r>=s.x&&s.x>=c&&r!==s.x&&ht(i<u?r:a,i,c,u,i<u?a:r,i,s.x,s.y)&&(l=Math.abs(i-s.y)/(r-s.x),(l<p||l===p&&s.x>n.x)&&xt(s,t)&&(n=s,p=l)),s=s.next;return n}(t,e);if(!s)return e;const r=vt(s,t);return et(r,r.next),et(s,s.next)}function ut(t,e,s,r){let i;for(;i!==t;i=i.next){if(i=i||t,null===i.z&&(i.z=ft(i.x,i.y,e,s,r)),i.prev.next!==i||i.next.prev!==i)return i.prev.next=i,i.next.prev=i,ut(t,e,s,r);i.prevZ=i.prev,i.nextZ=i.next}return t.prevZ.nextZ=null,t.prevZ=null,function(t){let e,s=1;for(;;){let r,i=t;t=null,e=null;let n=0;for(;i;){n++,r=i;let a=0;for(;a<s&&r;a++)r=r.nextZ;let o=s;for(;a>0||o>0&&r;){let s;0===a?(s=r,r=r.nextZ,o--):0!==o&&r?i.z<=r.z?(s=i,i=i.nextZ,a--):(s=r,r=r.nextZ,o--):(s=i,i=i.nextZ,a--),e?e.nextZ=s:t=s,s.prevZ=e,e=s}i=r}if(e.nextZ=null,s*=2,n<2)return t}}(t)}function lt(t,e,s){return(e.y-t.y)*(s.x-e.x)-(e.x-t.x)*(s.y-e.y)}function pt(t,e,s,r){return!!(dt(t,e)&&dt(s,r)||dt(t,r)&&dt(s,e))||lt(t,e,s)>0!=lt(t,e,r)>0&&lt(s,r,t)>0!=lt(s,r,e)>0}function ht(t,e,s,r,i,n,a,o){return(i-a)*(e-o)-(t-a)*(n-o)>=0&&(t-a)*(r-o)-(s-a)*(e-o)>=0&&(s-a)*(n-o)-(i-a)*(r-o)>=0}function xt(t,e){return lt(t.prev,t,t.next)<0?lt(t,e,t.next)>=0&&lt(t,t.prev,e)>=0:lt(t,e,t.prev)<0||lt(t,t.next,e)<0}function ft(t,e,s,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-s)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function dt(t,e){return t.x===e.x&&t.y===e.y}function mt(t,e){return t.x-e.x}function yt(t,e,s,r){let i=t;do{const n=i.prev,a=i.next.next;!dt(n,a)&&pt(n,i,i.next,a)&&xt(n,a)&&xt(a,n)&&(e.push(n.index/s+r),e.push(i.index/s+r),e.push(a.index/s+r),at(i),at(i.next),i=t=a),i=i.next}while(i!==t);return i}function _t(t,e,s,r,i,n,a){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.index!==t.index&&gt(o,t)){let c=vt(o,t);return o=et(o,o.next),c=et(c,c.next),st(o,e,s,r,i,n,a,0),void st(c,e,s,r,i,n,a,0)}t=t.next}o=o.next}while(o!==t)}function gt(t,e){return t.next.index!==e.index&&t.prev.index!==e.index&&!function(t,e){let s=t;do{if(s.index!==t.index&&s.next.index!==t.index&&s.index!==e.index&&s.next.index!==e.index&&pt(s,s.next,t,e))return!0;s=s.next}while(s!==t);return!1}(t,e)&&xt(t,e)&&xt(e,t)&&function(t,e){let s=t,r=!1;const i=(t.x+e.x)/2,n=(t.y+e.y)/2;do{s.y>n!=s.next.y>n&&s.next.y!==s.y&&i<(s.next.x-s.x)*(n-s.y)/(s.next.y-s.y)+s.x&&(r=!r),s=s.next}while(s!==t);return r}(t,e)}function vt(t,e){const s=bt.create(t.index,t.x,t.y),r=bt.create(e.index,e.x,e.y),i=t.next,n=e.prev;return t.next=e,e.prev=t,s.next=i,i.prev=s,r.next=s,s.prev=r,n.next=r,r.prev=n,r}class bt{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,s){const r=wt<kt.length?kt[wt++]:new bt;return r.index=t,r.x=e,r.y=s,r.prev=null,r.next=null,r.z=null,r.prevZ=null,r.nextZ=null,r.steiner=!1,r}}const kt=[];let wt=0;for(let t=0;t<8096;t++)kt.push(new bt);const Pt=new e(0,0,0,1,0),St=new e(0,0,0,1,0);function Tt(t,e,s){let r=0;for(let i=1;i<s;i++){const s=t[2*(e+i-1)],n=t[2*(e+i-1)+1];r+=(t[2*(e+i)]-s)*(t[2*(e+i)+1]+n)}return r}function Mt(t,e,s,r,i){let n=0;for(let a=s;a<r;a+=3){const s=2*(t[a]-i),r=2*(t[a+1]-i),o=2*(t[a+2]-i);n+=Math.abs((e[s]-e[o])*(e[r+1]-e[s+1])-(e[s]-e[r])*(e[o+1]-e[s+1]))}return n}function Et(t,e){const{coords:s,lengths:r}=e,i=t;let n=0;for(let t=0;t<r.length;){let e=t,a=r[t],o=Tt(s,n,a);const c=[];for(;++e<r.length;){const t=r[e],i=Tt(s,n+a,t);if(!(i>0))break;o+=i,c.push(n+a),a+=t}const u=i.length;Q(i,s,n,n+a,c,2,0);const l=Mt(i,s,u,i.length,0),p=Math.abs(o);if(Math.abs((l-p)/Math.max(1e-7,p))>1e-5)return i.length=0,!1;t=e,n+=a}return!0}function At(t,e){if(null==t)return null;if(!function(t,e,s){let r=0;for(let e=0;e<t.lengths.length;e++){const i=t.lengths[e];for(let e=0;e<i;e++){const i=t.coords[2*(e+r)],n=t.coords[2*(e+r)+1];if(i<-128||i>s||n<-128||n>s)return!0}r+=i}return!1}(t,0,h+128))return t;Pt.setPixelMargin(e),Pt.reset(3);let s=0;for(let e=0;e<t.lengths.length;e++){const r=t.lengths[e];let i=t.coords[2*(0+s)],n=t.coords[2*(0+s)+1];Pt.moveTo(i,n);for(let e=1;e<r;e++)i=t.coords[2*(e+s)],n=t.coords[2*(e+s)+1],Pt.lineTo(i,n);Pt.close(),s+=r}const r=Pt.result(!1);if(!r)return null;const i=[],n=[];for(const t of r){let e=0;for(const s of t)n.push(s.x),n.push(s.y),e++;i.push(e)}return new D(i,n)}function Lt(t,e){St.setPixelMargin(e);const s=St,r=-e,i=h+e;let n=[],a=!1;if(!t.nextPath())return null;let o=t.pathLength(),c=!0;for(;c;){t.seekPathStart();const e=[];if(!t.pathSize)return null;s.reset(2),t.nextPoint();let u=t.x,l=t.y;if(a)s.moveTo(u,l);else{if(u<r||u>i||l<r||l>i){a=!0;continue}e.push({x:u,y:l})}let p=!1;for(;t.nextPoint();)if(u=t.x,l=t.y,a)s.lineTo(u,l);else{if(u<r||u>i||l<r||l>i){p=!0;break}e.push({x:u,y:l})}if(p)a=!0;else{if(a){const t=s.resultWithStarts();if(t)for(const e of t)n.push({...e,pathLength:o})}else n.push({line:e,start:0,pathLength:o});c=t.nextPath(),o=c?t.pathLength():0,a=!1}}return n=n.filter(t=>t.line.length>1),0===n.length?null:n}Pt.setExtent(h),St.setExtent(h);class Ft{constructor(){this.extrusionOffsetX=0,this.extrusionOffsetY=0,this.normalX=0,this.normalY=0,this.directionX=0,this.directionY=0,this.distance=0,this.pathLength=0,this.distanceOffset=0,this.lineLength=0}}const Ot={createComputedParams:t=>t,optionalAttributes:{zoomRange:{type:p.SHORT,count:2,packPrecisionFactor:x,pack:({scaleInfo:t},{tileInfo:e})=>R(t,e)}},attributes:{id:{type:p.UNSIGNED_BYTE,count:3,pack:"id"},pos:{type:p.SHORT,count:2,pack:"position",packPrecisionFactor:10},bitset:{type:p.UNSIGNED_BYTE,count:1},color:{type:p.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>W(t)},offset:{type:p.BYTE,count:2,packPrecisionFactor:16,packTessellation:({extrusionOffsetX:t,extrusionOffsetY:e})=>[j(t,16),j(e,16)]},normal:{type:p.BYTE,count:2,packPrecisionFactor:16,packTessellation:({normalX:t,normalY:e})=>[j(t,16),j(e,16)]},halfWidth:{type:p.HALF_FLOAT,count:1,pack:({width:e})=>t(.5*e)},referenceHalfWidth:{type:p.HALF_FLOAT,count:1,pack:({referenceWidth:e})=>t(.5*e)}}};class Dt{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0,this.pathLength=0,this.distanceOffset=0}}const It=65535;class Nt extends K{constructor(t,e,s,r){super(t,e,s,r),this.vertexSpec=Ot,this._currentWrite=new Dt,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:It,textured:!1},this._tessParams=new Ft,this._initializeTessellator()}writeLineVertices(t,e,s){const r=this._getLines(e);null!=r&&this._writeVertices(t,s,r)}_initializeTessellator(){this._lineTessellator=new O(this._writeTesselatedVertex.bind(this),this._writeTriangle.bind(this),!0)}_write(t,e,s){const r=s??k.fromFeatureSetReaderCIM(e);r&&this._writeGeometry(t,e,r)}_writeGeometry(t,e,s,r){t.recordStart(this.instanceId,this.attributeLayout,r),this.writeLineVertices(t,s,e),t.recordEnd()}_getLines(t){return Lt(t,A(this.evaluatedMeshParams))}_writeVertices(e,s,r){const{_currentWrite:i,_tessellationOptions:n,evaluatedMeshParams:a}=this,{width:o,capType:c,joinType:u,miterLimit:l,hasSizeVV:p}=a,h=t(.5*o);n.halfWidth=h,n.capType=Z(c),n.joinType=H(u),n.miterLimit=l;const x=!p;i.out=e,i.id=s.getDisplayId(),i.vertexCount=0,i.indexCount=0,i.vertexFrom=e.vertexCount(),i.vertexBounds=x&&h<f?0:1;for(const{line:t,start:e,pathLength:s}of r)n.initialDistance=e%It,i.pathLength=s,i.distanceOffset=Math.floor(e/It)*It,this._lineTessellator.tessellate(t,n,x)}_writeTesselatedVertex(t,e,s,r,i,n,a,o,c,u,l){const{out:p,id:h,vertexBounds:x,pathLength:f,distanceOffset:d}=this._currentWrite;return this.hasEffects&&p.recordBounds(t,e,x,x),this._tessParams.extrusionOffsetX=a,this._tessParams.extrusionOffsetY=o,this._tessParams.normalX=c,this._tessParams.normalY=u,this._tessParams.directionX=i,this._tessParams.directionY=n,this._tessParams.distance=l,this._tessParams.pathLength=f,this._tessParams.distanceOffset=d,this._writeVertex(p,h,t,e,this._tessParams),this._currentWrite.vertexFrom+this._currentWrite.vertexCount++}_writeTriangle(t,e,s){const{out:r}=this._currentWrite;r.indexEnsureSize(3),r.indexWrite(t),r.indexWrite(e),r.indexWrite(s),this._currentWrite.indexCount+=3}}const zt=w("featurelayer-fast-triangulation-enabled");class Gt extends K{async loadDependencies(){await Promise.all([super.loadDependencies(),S()])}_write(t,e,s){const r=s?.asOptimized()??e.readGeometryForDisplay(),i=this._clip(r);i&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,e,i),t.recordEnd())}_clip(t){return t?At(t,this.hasEffects?256:8):null}_writeGeometry(t,e,s){const r=s.maxLength>100,i=[],n=this.createTesselationParams(e);if(!r&&zt&&Et(i,s))return void(i.length&&this._writeVertices(t,e,s.coords,n,i));const a=function(t){const{coords:e,lengths:s}=t,{buffer:r}=P(e,s);return r}(s);this._writeVertices(t,e,a,n)}_writeVertices(t,e,s,r,i){const n=e.getDisplayId(),a=t.vertexCount(),o=this.hasEffects;let c=0;if(i)for(const e of i){const i=s[2*e],a=s[2*e+1];o&&t.recordBounds(i,a,0,0),this._writeVertex(t,n,i,a,r),c++}else for(let e=0;e<s.length;e+=2){const i=Math.round(s[e]),a=Math.round(s[e+1]);o&&t.recordBounds(i,a,0,0),this._writeVertex(t,n,i,a,r),c++}t.indexEnsureSize(c);for(let e=0;e<c;e++)t.indexWrite(e+a)}}const Ct={createComputedParams:t=>t,optionalAttributes:{zoomRange:{type:p.SHORT,count:2,packPrecisionFactor:x,pack:({scaleInfo:t},{tileInfo:e})=>R(t,e)}},attributes:{id:{type:p.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:p.UNSIGNED_BYTE,count:1},pos:{type:p.SHORT,count:2,pack:"position",packPrecisionFactor:10},color:{type:p.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>W(t)}}};class Ut extends Gt{constructor(){super(...arguments),this.vertexSpec=Ct}createTesselationParams(t){return null}}const Yt={createComputedParams:t=>t,optionalAttributes:Ct.optionalAttributes,attributes:{...Ct.attributes,tlbr:{count:4,type:p.UNSIGNED_SHORT,pack:({sprite:t})=>{const{rect:e,width:s,height:r}=t,i=e.x+d,n=e.y+d;return[i,n,i+s,n+r]}},inverseRasterizationScale:{count:1,type:p.BYTE,packPrecisionFactor:16,pack:({sprite:t})=>1/t.rasterizationScale}}};class Rt extends Ut{constructor(){super(...arguments),this.vertexSpec=Yt}_write(t,e,s){const r=s?.asOptimized()??e.readGeometryForDisplay(),i=this._clip(r);if(!i)return;const n=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,n),this._writeGeometry(t,e,i),t.recordEnd()}}function Bt(e){const{sprite:s,aspectRatio:r,scaleProportionally:i}=e,n=t(e.height),a=n>0?n:s.height;let o=n*r;return o<=0?o=s.width:i&&(o*=s.width/s.height),{width:o,height:a}}function Vt(t){const{applyRandomOffset:e,sampleAlphaOnly:s}=t;return V([[r,e],[i,s]])}const Wt={createComputedParams:t=>t,optionalAttributes:Yt.optionalAttributes,attributes:{...Yt.attributes,bitset:{count:1,type:p.UNSIGNED_BYTE,pack:Vt},width:{count:1,type:p.HALF_FLOAT,pack:t=>Bt(t).width},height:{count:1,type:p.HALF_FLOAT,pack:t=>Bt(t).height},offset:{count:2,type:p.HALF_FLOAT,pack:({offsetX:e,offsetY:s})=>[t(e),-t(s)]},scale:{count:2,type:p.UNSIGNED_BYTE,packPrecisionFactor:16,pack:({scaleX:t,scaleY:e})=>[t,e]},angle:{count:1,type:p.UNSIGNED_BYTE,pack:({angle:t})=>s(t)}}};class Zt extends Rt{constructor(){super(...arguments),this.vertexSpec=Wt}}const Ht={createComputedParams:t=>t,optionalAttributes:Ot.optionalAttributes,attributes:{...Ot.attributes,bitset:{type:p.UNSIGNED_BYTE,count:1,pack:t=>0},color:{type:p.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>W(t)}}},qt={createComputedParams:t=>t,optionalAttributes:Ot.optionalAttributes,attributes:{...Ot.attributes,bitset:{type:p.UNSIGNED_BYTE,count:1,pack:t=>V([[n,!0],[a,t.outlineUsesColorVV]])},color:{type:p.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:t})=>W(t)}}};class jt extends Nt{constructor(){super(...arguments),this.vertexSpec=qt}}class Xt extends Ut{constructor(t,e,s,r){super(t,e,s,r),this.vertexSpec=Ht,this._lineMeshWriter=this._createOutlineWriter(t,e,s,r)}_createOutlineWriter(t,e,s,r){return new jt(t,e,s,r)}_write(t,e){const s=this.evaluatedMeshParams.effects,r=this.evaluatedMeshParams.outlineEffects;if(s?.length||r?.length){if(s?.length){const r=this.getEffectCursor(t,e,s);if(r){let s;for(;s=r?.next();)s.invertY(),this._writeFill(t,e,s)}}else this._writeFill(t,e);if(r?.length){const s=this.getEffectCursor(t,e,r);if(s){let r;for(;r=s?.next();)r.invertY(),this._writeOutline(t,e,r)}}else this._writeOutline(t,e)}else this._writeSimpleOutlineFill(t,e)}_writeSimpleOutlineFill(t,e){const s=e.readGeometryForDisplay(),r=this._clip(s);r&&(this._writeGeometry(t,e,r),this._lineMeshWriter.writeLineVertices(t,k.fromOptimizedCIM(r,"esriGeometryPolyline"),e))}_writeFill(t,e,s){const r=s?.asOptimized()??e.readGeometryForDisplay(),i=this._clip(r);i&&this._writeGeometry(t,e,i)}_writeOutline(t,e,s){const r=s?.asOptimized()??e.readGeometryForDisplay(),i=this._clip(r);i&&this._lineMeshWriter.writeLineVertices(t,k.fromOptimizedCIM(i,"esriGeometryPolyline"),e)}_clip(t){return t?At(t,A(this.evaluatedMeshParams)):null}get effectInfos(){return[...this._evaluator.inputMeshParams.effects?.effectInfos??[],...this._evaluator.inputMeshParams.outlineEffects?.effectInfos??[]]}write(t,e,s,r,i){this.ensurePacked(e,s,r),t.recordStart(this.instanceId,this.attributeLayout),this._write(t,s),t.recordEnd()}ensurePacked(t,e,s){super.ensurePacked(t,e,s),this._lineMeshWriter.ensurePacked(t,e,s)}enqueueRequest(t,e,s){super.enqueueRequest(t,e,s),this._lineMeshWriter.enqueueRequest(t,e,s)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}get hasEffects(){return!!this.evaluatedMeshParams.outlineEffects}}const Jt=Wt,$t=qt,Kt={createComputedParams:t=>t,optionalAttributes:Jt.optionalAttributes,attributes:{...Jt.attributes,bitset:{type:p.UNSIGNED_BYTE,count:1,pack:t=>Vt(t)},aux1:{count:1,type:p.HALF_FLOAT,pack:t=>Bt(t).width},aux2:{count:1,type:p.HALF_FLOAT,pack:t=>Bt(t).height},aux3:{count:2,type:p.HALF_FLOAT,pack:({offsetX:e,offsetY:s})=>[t(e),t(s)]},aux4:{count:2,type:p.UNSIGNED_BYTE,pack:({scaleX:t,scaleY:e})=>[t*o,e*o]}}},Qt={createComputedParams:t=>t,optionalAttributes:Jt.optionalAttributes,attributes:{...Jt.attributes,color:$t.attributes.color,bitset:{type:p.UNSIGNED_BYTE,count:1,pack:t=>V([[n,!0]])},aux1:{count:1,type:p.HALF_FLOAT,pack:e=>t(.5*e.width)},aux2:{count:1,type:p.HALF_FLOAT,pack:e=>t(.5*e.referenceWidth)},aux3:{count:2,type:p.HALF_FLOAT,packTessellation:({extrusionOffsetX:t,extrusionOffsetY:e})=>[t,e]},aux4:{count:2,type:p.UNSIGNED_BYTE,packTessellation:({normalX:t,normalY:e})=>[t*o+c,e*o+c]}}};class te extends jt{constructor(){super(...arguments),this.vertexSpec=Qt}}class ee extends Xt{constructor(){super(...arguments),this.vertexSpec=Kt}_createOutlineWriter(t,e,s,r){return new te(t,e,s,r)}write(t,e,s,r,i){this.ensurePacked(e,s,r);const n=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,n),this._write(t,s),t.recordEnd()}ensurePacked(t,e,s){super.ensurePacked(t,e,s),this._lineMeshWriter.ensurePacked(t,e,s)}enqueueRequest(t,e,s){super.enqueueRequest(t,e,s),this._lineMeshWriter.enqueueRequest(t,e,s)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}class se{constructor(t,e){this._size=t,this._sizeUnits=e,this._relativeSize=null}get relativeSize(){return this._relativeSize??=this.calculateRelativeSize(),this._relativeSize}calculateRelativeSize(){if(0===this._sizeUnits){const t=Math.min(this._size/100,1);return[t,t]}return this.calculateRelativeSizeFromAbsolute()}}class re extends se{constructor(t,e,s,r){super(e,s),this.rotationMatrix00=1,this.rotationMatrix01=0,this.rotationMatrix10=0,this.rotationMatrix11=1,this.bounds={xmin:1/0,ymin:1/0,xmax:-1/0,ymax:-1/0},this.rotationMatrix00=Math.cos(r),this.rotationMatrix01=-Math.sin(r),this.rotationMatrix10=-this.rotationMatrix01,this.rotationMatrix11=this.rotationMatrix00;const{bounds:i,rotationMatrix00:n,rotationMatrix01:a,rotationMatrix10:o,rotationMatrix11:c}=this;t.forEachVertex((t,e)=>{const s=t*n+e*a,r=t*o+e*c;i.xmin=Math.min(i.xmin,s),i.ymin=Math.min(i.ymin,r),i.xmax=Math.max(i.xmax,s),i.ymax=Math.max(i.ymax,r)}),this.center=[(i.xmin+i.xmax)/2,(i.ymin+i.ymax)/2]}}class ie extends re{constructor(t,e,s,r){super(t,e,s,r),this.method="linear"}getRelativePosition(t,e){const{rotationMatrix00:s,rotationMatrix01:r,bounds:i}=this,{xmin:n,xmax:a}=i;return[(t*s+e*r-n)/(a-n),0]}calculateRelativeSizeFromAbsolute(){const{_size:e,bounds:s}=this,{xmin:r,xmax:i}=s;return[t(e)/(i-r),0]}}class ne extends re{constructor(t,e,s,r){super(t,e,s,r),this.method="rectangular"}getRelativePosition(t,e){const{bounds:s,center:r,rotationMatrix00:i,rotationMatrix01:n,rotationMatrix10:a,rotationMatrix11:o}=this,c=t*a+e*o,u=t*i+e*n-r[0],l=c-r[1];return[u*(2/(s.xmax-s.xmin)),-l*(2/(s.ymax-s.ymin))]}calculateRelativeSizeFromAbsolute(){const{_size:e,bounds:s}=this,{xmin:r,ymin:i,xmax:n,ymax:a}=s;return[t(2*e)/(n-r),t(2*e)/(a-i)]}}class ae extends re{constructor(t,e,s){super(t,e,s,0),this.method="circular";const{xmin:r,xmax:i,ymin:n,ymax:a}=this.bounds,o=i-r,c=a-n;this.radius=Math.sqrt(o*o+c*c)/2}getRelativePosition(t,e){const{center:s,radius:r}=this;return[(t-s[0])/r,-(e-s[1])/r]}calculateRelativeSizeFromAbsolute(){const{_size:e}=this;return[t(e)/this.radius,0]}}function oe(t,e){if(null==t)return null;const s=b(e.angle),r=e.gradientSize,i=e.gradientSizeUnits;switch(e.gradientMethod.toLowerCase()){case"linear":return new ie(t,r,i,s);case"rectangular":return new ne(t,r,i,s);case"circular":return new ae(t,r,i);default:return v.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.fill.GradientSizeHelper").errorOnce(`Gradient fill method "${e.gradientMethod}" currently unsupported.`),null}}const ce={createComputedParams:t=>t,optionalAttributes:Ct.optionalAttributes,attributes:{...Ct.attributes,bitset:{type:p.UNSIGNED_BYTE,count:1,pack:({gradientSizeUnits:t,gradientType:e})=>{let s=0;return 1===t&&(s|=B(_.isAbsolute)),"discrete"===e.toLowerCase()&&(s|=B(_.isDiscrete)),s}},tlbr:{count:4,type:p.UNSIGNED_SHORT,pack:({sprite:t})=>{const{rect:e,width:s,height:r}=t,i=e.x+d+m,n=e.y+d;return[i,n,i+s-2*m,n+r]}},relativePosition:{count:2,type:p.HALF_FLOAT,packTessellation:({gradientStats:t},e,s,r)=>t?.getRelativePosition(s,r)??[0,0]},relativeGradientSize:{count:2,type:p.HALF_FLOAT,packTessellation:({gradientStats:t})=>t?.relativeSize??[1,1]},gradientMethod:{count:1,type:p.UNSIGNED_BYTE,pack:({gradientMethod:t})=>{switch(t.toLowerCase()){case"rectangular":return y.rectangular;case"circular":return y.circular;default:return y.linear}}}}};class ue extends Gt{constructor(){super(...arguments),this.vertexSpec=ce}get _preventEffectClipping(){return!0}createTesselationParams(t){return{gradientStats:oe(this._unclippedGeometry,this.evaluatedMeshParams)}}_write(t,e,s){const r=s?.asOptimized()??e.readGeometryForDisplay();this._unclippedGeometry=r;const i=this._clip(r);if(!i)return void(this._unclippedGeometry=null);const n=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,n),this._writeGeometry(t,e,i),this._unclippedGeometry=null,t.recordEnd()}}const le={optionalAttributes:Yt.optionalAttributes,createComputedParams:t=>t,attributes:{...Yt.attributes,...Ht.attributes}},pe={optionalAttributes:Yt.optionalAttributes,createComputedParams:t=>t,attributes:{...Yt.attributes,...qt.attributes}};class he extends jt{constructor(){super(...arguments),this.vertexSpec=pe}}class xe extends Xt{constructor(){super(...arguments),this.vertexSpec=le}_createOutlineWriter(t,e,s,r){return new he(t,e,s,r)}write(t,e,s,r,i){this.ensurePacked(e,s,r);const n=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,n),this._write(t,s),t.recordEnd()}ensurePacked(t,e,s){super.ensurePacked(t,e,s),this._lineMeshWriter.ensurePacked(t,e,s)}enqueueRequest(t,e,s){super.enqueueRequest(t,e,s),this._lineMeshWriter.enqueueRequest(t,e,s)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const fe={createComputedParams:t=>t,optionalAttributes:Ot.optionalAttributes,attributes:{...Ot.attributes,bitset:{type:p.UNSIGNED_BYTE,count:1,pack:({gradientMethod:t,gradientSizeUnits:e,gradientType:s})=>V([[g.isAlongLine,"alongline"===t.toLowerCase()],[g.isAbsoluteSize,1===e],[g.isDiscrete,"discrete"===s.toLowerCase()]])},tlbr:{type:p.UNSIGNED_SHORT,count:4,pack:({sprite:t})=>{const{rect:e,width:s,height:r}=t,i=e.x+d+m,n=e.y+d;return[i,n,i+s-2*m,n+r]}},accumulatedDistance:{type:p.HALF_FLOAT,count:1,packTessellation:({distance:t,pathLength:e,distanceOffset:s})=>(s+t)/e},gradientSize:{type:p.HALF_FLOAT,count:1,pack:({gradientSize:e,gradientSizeUnits:s})=>0===s?e/100:t(e)},totalLength:{type:p.HALF_FLOAT,count:1,packTessellation:({pathLength:t})=>t},segmentDirection:{type:p.BYTE,count:2,packPrecisionFactor:16,packTessellation:({directionX:t,directionY:e})=>[t,e]}}};class de extends Nt{get _preventEffectClipping(){return!0}constructor(t,e,s,r){super(t,e,s,r),this.vertexSpec=fe,this._tessellationOptions.textured=!0}_write(t,e,s){const r=s??k.fromFeatureSetReaderCIM(e);if(!r)return;const{sprite:i}=this.evaluatedMeshParams;this._writeGeometry(t,e,r,i?.textureBinding)}}const me={createComputedParams:t=>t,optionalAttributes:Ot.optionalAttributes,attributes:{...Ot.attributes,bitset:{type:p.UNSIGNED_BYTE,count:1,pack:({shouldSampleAlphaOnly:t,shouldScaleDash:e,isSDF:s})=>V([[i,t],[u,e],[l,s]])},tlbr:{type:p.UNSIGNED_SHORT,count:4,pack:({sprite:t})=>{const{rect:e,width:s,height:r}=t,i=e.x+d,n=e.y+d;return[i,n,i+s,n+r]}},accumulatedDistance:{type:p.UNSIGNED_SHORT,count:1,packTessellation:({distance:t})=>t},segmentDirection:{type:p.BYTE,count:2,packPrecisionFactor:16,packTessellation:({directionX:t,directionY:e})=>[t,e]},offsetAlongLine:{type:p.HALF_FLOAT,count:1,pack:({offsetAlongLine:e})=>t(e)},capType:{type:p.UNSIGNED_BYTE,count:1,pack:({capType:t})=>{switch(t){case"Butt":case"butt":default:return 0;case"Square":case"square":return 1;case"Round":case"round":return 2}}}}};class ye extends Nt{constructor(t,e,s,r){super(t,e,s,r),this.vertexSpec=me,this._tessellationOptions.textured=!0}_write(t,e,s){const r=s??k.fromFeatureSetReaderCIM(e);if(!r)return;const{sprite:i}=this.evaluatedMeshParams;this._writeGeometry(t,e,r,i?.textureBinding)}}export{Gt as A,ee as C,Ut as F,de as G,Ft as L,K as M,Xt as O,xe as P,ye as T,R as a,H as b,Lt as c,W as d,V as e,q as f,B as g,Nt as h,ue as i,Rt as j,Zt as k,Y as l,Z as p,Et as t};
