/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{L as t}from"./Logger.js";import{j as n,e as r,k as e}from"./mathUtils.js";import{D as o,a3 as a,a4 as s,x as i,P as l,c as u,a5 as c}from"./unitUtils.js";import{n as f,f as p}from"./mat3.js";import{c as m}from"./mat3f64.js";import{i as g,e as y,k as A,c as d,m as h}from"./mat4.js";import{c as j,I as w}from"./mat4f64.js";import{q as v,n as T,v as x,h as F,t as E}from"./vec3.js";import{c as M}from"./vec3f64.js";import{W as R,g as S}from"./spatialReferenceEllipsoidUtils.js";import{c as b}from"./computeTranslationToOriginAndRotation.js";import{p as V}from"./projectPointToVector.js";import{i as U,v as k}from"./meshVertexSpaceUtils.js";import{t as B,n as L,a as P,b as $}from"./vec32.js";import{p as _}from"./projectBuffer.js";import{y2lat as q}from"../geometry/support/webMercatorUtils.js";import{B as N,a as W}from"./BufferView.js";import{t as Y}from"./vec42.js";const C="Projection may be possible after calling projection.load().";function D(t,n,r,e){t.error(`Failed to project from (wkid:${n.wkid}) to (wkid:${r.wkid}).${e?" ":""}${e}`)}function G(t,n,r,e,o,a){return rt(0,N.fromTypedArray(t),0,W.fromTypedArray(n),r,W.fromTypedArray(e),o,N.fromTypedArray(a))?a:null}function I(t,n,r,e,o,a){return rt(1,N.fromTypedArray(t),0,W.fromTypedArray(n),r,W.fromTypedArray(e),o,N.fromTypedArray(a))?a:null}function O(t,n,r,e){return _(t,n,0,r,e,0)?r:null}function z(t,n,r,e){return _(t,n,0,r,e,0)?r:null}function H(t,r,e){return f(st,e),B(r,t,st),n(st)&&L(r,r),r}function J(t,r,e){return p(st,e),Y(r,t,st),n(st)&&L(r,r,4),r}function K(t,n,e,o){const a=0===n;return X(t,n,e,(t,n)=>{const e=Math.cos(r(t));n[0]=a?e:1/e,n[1]=1},o)}function Q(t,n,r,e){const o=0===n;return X(t,n,r,(t,n)=>{const r=Math.cosh(-t/i.radius);n[0]=1,n[1]=o?r:1/r},e)}function X(t,n,r,e,o){const a=0===n?3:4,s=[0,0];for(let n=0,i=1;n<t.length;n+=a,i+=3){e(r[i],s);const l=t[n]*s[0],u=t[n+1]*s[1],c=t[n+2],f=1/Math.sqrt(l*l+u*u+c*c);o[n]=l*f,o[n+1]=u*f,o[n+2]=c*f,4===a&&(o[n+3]=t[n+3])}return o}function Z(t,n,r,e,o,a){if(!rt(0,N.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),1,W.fromTypedArray(n),r,W.fromTypedArray(e),o,N.fromTypedArray(a,4*Float32Array.BYTES_PER_ELEMENT)))return null;for(let n=3;n<t.length;n+=4)a[n]=t[n];return a}function tt(t,n,r,e,o,a){if(!rt(1,N.fromTypedArray(t,16),1,W.fromTypedArray(n),r,W.fromTypedArray(e),o,N.fromTypedArray(a,16)))return null;for(let n=3;n<t.length;n+=4)a[n]=t[n];return a}function nt(t,n,r,e,o){switch(b(e,r,at,e),1===t&&g(at,at),n){case 0:return f(o,at);case 1:return p(o,at)}}function rt(t,n,r,e,i,l,u,c){if(!n)return;const f=e.count;if(function(t){return t.isWGS84||o(t)||a(t)||s(t)}(i))for(let e=0;e<f;e++)l.getVec(e,et),n.getVec(e,ot),v(ot,ot,nt(t,r,et,u,st)),c.setVec(e,ot);else for(let o=0;o<f;o++){l.getVec(o,et),n.getVec(o,ot);const a=q(e.get(o,1));let s=Math.cos(a);1===r!=(0===t)&&(s=1/s),nt(t,r,et,u,st),0===t?(st[0]*=s,st[1]*=s,st[2]*=s,st[3]*=s,st[4]*=s,st[5]*=s):(st[0]*=s,st[3]*=s,st[6]*=s,st[1]*=s,st[4]*=s,st[7]*=s),v(ot,ot,st),T(ot,ot),c.setVec(o,ot)}return c}const et=M(),ot=M(),at=j(),st=m(),it=()=>t.getLogger("esri.geometry.support.meshUtils.vertexSpaceConversion");function lt(t,n,{vertexSpace:r,spatialReference:e}){if("georeferenced"===r.type){const o=t;if(!V(n,o,e))return!1;const{origin:a}=r;return F(t,o,a),!0}const o=S(e),a=t;if(!V(n,a,o))return!1;const{origin:s}=r,i=vt;if(!b(e,s,i,o))return!1;const l=g(vt,i);return null!=l&&(E(t,a,l),!0)}function ut(t,n,r){const{vertexSpace:e,transform:o,vertexAttributes:a}=t,s=U(e)?o:null,i=gt(t.spatialReference,r,3);if(k(e,n)&&(!s||y(s.localMatrix,w))&&yt(i)){const{position:t,normal:n,tangent:e}=a,o=r?.allowBufferReuse;return{position:o?t:t.slice(),normal:o?n:n?.slice(),tangent:o?e:e?.slice()}}switch(t.vertexSpace.type){case"local":return"local"===n.type?function({vertexAttributes:t,spatialReference:n,transform:r},{origin:e},o,a){const s=ct(n,a);if(!b(n,e,dt,s))return D(it(),n,s),null;if(r&&h(dt,dt,r.localMatrix),!b(n,o,ht,s))return D(it(),s,n),null;g(ht,ht);const i=h(dt,ht,dt);return mt(i,n,a,3),pt(t,i)}(t,t.vertexSpace,n.origin,r):function({spatialReference:t,vertexAttributes:n,transform:r},{origin:e},o,a){const s=ct(t,a);if(!b(t,e,dt,s))return D(it(),t,s),null;r&&h(dt,dt,r.localMatrix),mt(dt,t,a,1);const i=new Float64Array(n.position.length),l=function(t,n,r,e,o){$(e,t,dt);const a=new Float64Array(t.length);return z(e,o,a,r)?a:(D(it(),o,r),null)}(n.position,0,t,i,s);if(!l)return null;const u=function(t,n,r,e,o,a){if(null==o)return null;const s=new Float32Array(o.length);return H(o,s,a),I(s,t,n,r,e,s)?s:(D(it(),e,n),null)}(l,t,i,s,n.normal,dt);if(n.normal&&!u)return null;const c=function(t,n,r,e,o,a){if(null==o)return null;const s=new Float32Array(o.length);return J(o,s,a),tt(s,t,n,r,e,s)?s:(D(it(),e,n),null)}(l,t,i,s,n.tangent,dt);if(n.tangent&&!c)return null;if(o){const t=x(wt,o);P(l,l,t)}return{position:l,normal:u,tangent:c}}(t,t.vertexSpace,n.origin,r);case"georeferenced":return"local"===n.type?ft(t,t.vertexSpace,n.origin,r):function({vertexAttributes:t,transform:n,spatialReference:r},{origin:e},o,a){const s=gt(r,a,3),i=e||!yt(s)?d(dt,n?.localMatrix??w):null;i&&mt(i,r,a,3);const{position:l,normal:u,tangent:c}=i?pt(t,i):t,f=a?.allowBufferReuse,p=f?l:new Float64Array(l.length);let m=l;if(e&&(m=P(p,m,e)),o){const t=x(wt,o);m=P(p,m,t)}return{position:m!==t.position||f?m:m.slice(),normal:u!==t.normal||f?u:u?.slice(),tangent:c!==t.tangent||f?c:c?.slice()}}(t,t.vertexSpace,n.origin,r)}}function ct(t,n){return n?.useEllipsoid&&c(t)?R:S(t)}function ft({vertexAttributes:t,spatialReference:n,transform:r},{origin:e},o,a){const s=ct(n,a);if(!b(n,o,dt,s))return D(it(),n,s),null;const i=1/gt(n,a,2);A(dt,dt,[i,i,i]);const l=g(ht,dt),{position:u,normal:c,tangent:p}=function(t,n,r){if(!n)return t;if(!r){const{position:r,normal:e,tangent:o}=t;return{position:P(new Float64Array(r.length),r,n),tangent:o,normal:e}}const e=pt(t,r.localMatrix);return P(e.position,e.position,n),e}(t,e,r),m=new Float64Array(u.length),y=function(t,n,r,e,o){const a=O(t,n,e,o);if(!a)return D(it(),n,o),null;const s=new Float64Array(a.length);return $(s,a,r),s}(u,n,l,m,s);if(!y)return null;const d=f(jt,l),h=function(t,n,r,e,o,a,s){if(null==t)return null;const i=s??new Float32Array(t.length);return G(t,n,r,e,o,i)?(B(i,i,a),i):(D(it(),r,o),null)}(c,u,n,m,s,d,c!==t.normal?c:void 0);if(!h&&c)return null;const j=function(t,n,r,e,o,a,s){if(null==t)return null;const i=s??new Float32Array(t.length);return Z(t,n,r,e,o,i)?(B(i,i,a,4),i):(D(it(),r,o),null)}(p,u,n,m,s,d,p!==t.tangent?p:void 0);return!j&&p?null:{position:y,normal:h,tangent:j}}function pt(t,n){const r=new Float64Array(t.position.length);$(r,t.position,n);const e=t.normal?new Float32Array(t.normal.length):null,o=t.tangent?new Float32Array(t.tangent.length):null;return e&&t.normal&&H(t.normal,e,n),o&&t.tangent&&J(t.tangent,o,n),{position:r,normal:e,tangent:o}}function mt(t,n,r,e){const o=gt(n,r,e);yt(o)||A(t,t,[o,o,o])}function gt(t,n,r){const e=!!(1&r),o=!!(2&r),a=n?.sourceUnit,s=n?.targetUnit;if(!a&&!s)return 1;let i=At(a,t);e||!a||yt(i)||(it().warn("source unit conversion not supported"),i=1);let l=1/At(s,t);return o||!s||yt(l)||(it().warn("target unit conversion not supported"),l=1),i*l}function yt(t){return e(t,1)}function At(t,n){if(null==t)return 1;const r=l(n);return 1/u(r,"meters",t)}const dt=j(),ht=j(),jt=m(),wt=M(),vt=j();export{C as a,O as b,ut as c,G as d,Z as e,z as f,At as g,I as h,tt as i,K as j,Q as k,D as l,J as m,lt as p,H as t};
