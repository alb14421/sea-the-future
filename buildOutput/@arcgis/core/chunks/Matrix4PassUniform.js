/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{n as e,U as t,j as r,h as i,e as s,f as a,w as n}from"../core/lang.js";import{g as o}from"./watch.js";import{I as l,a as c,c as u}from"./mat4f64.js";import{m as h,u as d,k as f,j as m,i as p,z as g,t as v,e as _,h as x,l as b}from"./vec3.js";import{b as y,g as w}from"./Indices.js";import{W as C,D as P,o as S,e as M,B as z,f as F,g as A,q as T,x as D,b as I,c as O}from"./BufferView.js";import{P as E}from"./PooledArray.js";import{f as k,b as B,c as L,o as V,z as U,Z as j}from"./vec3f64.js";import{b as H}from"./triangle.js";import{w as N,T as R,g as $,a as q}from"./Texture.js";import{_ as G}from"./tslib.es6.js";import X from"../core/Error.js";import{l as W,e as K,c as Y}from"./mathUtils.js";import{g as Z}from"./boundedPlane.js";import{k as J,b as Q,m as ee}from"./sphere.js";import{b as te,c as re,s as ie,m as se,k as ae,v as ne,h as oe,r as le,d as ce,D as ue,G as he}from"./mat4.js";import{l as de,d as fe,U as me,E as pe,i as ge,s as ve,t as _e}from"./Emissions.glsl.js";import{g as xe,I as be}from"./glsl.js";import{f as ye}from"./mat3.js";import{c as we}from"./mat3f64.js";import{c as Ce}from"./vec4.js";import{o as Pe}from"./vec4f64.js";import{m as Se}from"./lengthUtils.js";import{c as Me,g as ze,a as Fe}from"./guards.js";import{d as Ae}from"./debugFlags2.js";import{EventEmitter as Te}from"../core/Evented.js";import{f as De,r as Ie}from"./maybe.js";import{throwIfAborted as Oe,onAbort as Ee,createAbortError as ke}from"../core/promiseUtils.js";import{isBlobProtocol as Be,isDataProtocol as Le}from"../core/urlUtils.js";import{w as Ve}from"./videoUtils.js";import{r as Ue}from"./requestImageUtils.js";import{l as je}from"../request.js";import{g as He}from"./assets.js";import{g as Ne,a as Re,C as $e,i as qe,j as Ge}from"./enums.js";import{L as Xe}from"./Logger.js";import{s as We}from"./vec2.js";import{c as Ke}from"./vec2f64.js";import{a as Ye}from"./AlphaCutoff.js";import{m as Ze,d as Je,p as Qe,a as et,s as tt,u as rt}from"./renderState.js";class it{constructor(e){this._material=e.material,this._techniques=e.techniques,this._output=e.output}dispose(){}get _stippleTextures(){return this._techniques.context?.stippleTextures}get _markerTextures(){return this._techniques.context?.markerTextures}getTechnique(e,t){return this._techniques.get(e,this._material.getConfiguration(this._output,t))}ensureResources(e){return 2}}const st=class{},at=new st;class nt{constructor(){this.uid=o()}}class ot extends nt{constructor(e){super(),this.highlightName=e,this.channel=0}}class lt extends nt{constructor(){super(...arguments),this.channel=1}}function ct(e,t,r){for(let i=0;i<r;++i)t[2*i]=e[i],t[2*i+1]=e[i]-t[2*i]}function ut(e,t){const r=e.length;for(let i=0;i<r;++i)dt[0]=e[i],t[i]=dt[0];return t}function ht(e,t){const r=e.length;for(let i=0;i<r;++i)dt[0]=e[i],dt[1]=e[i]-dt[0],t[i]=dt[1];return t}const dt=new Float32Array(2);function ft(t,r=!1){return t<=e?r?new Array(t).fill(0):new Array(t):new Float32Array(t)}function mt(t){return Array.isArray(t)?t.length<e?t:new Float32Array(t):t.length<e?Array.from(t):t}function pt(t){return(Array.isArray(t)?t.length:t.byteLength/8)<=e?Array.from(t):new Float32Array(t)}function gt(e,t,r){return Array.isArray(e)?e.slice(t,t+r):e.subarray(t,t+r)}function vt(i){if(i.length<e)return Array.from(i);if(Array.isArray(i))return Float64Array.from(i);if(!("BYTES_PER_ELEMENT"in i))return Array.from(i);switch(i.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(i);case 2:return t(i)?C().from(i):r(i)?Uint16Array.from(i):Int16Array.from(i);case 4:return Float32Array.from(i);default:return Float64Array.from(i)}}class _t{get center(){return k(this._data[0],this._data[1],this._data[2])}get radius(){return this._data[3]}get bbMin(){return k(this._data[4],this._data[5],this._data[6])}get bbMax(){return k(this._data[7],this._data[8],this._data[9])}constructor(e,t,r){this.primitiveIndices=e,this._numIndexPerPrimitive=t,this.position=r,this._data=[.1,0,0,0,0,0,0,0,0,0],this._children=void 0,P(e.length>=1),P(3===r.size||4===r.size);const{data:i,size:s,indices:a}=r;P(a.length%this._numIndexPerPrimitive===0),P(a.length>=e.length*this._numIndexPerPrimitive);const n=e.length;let o=s*a[this._numIndexPerPrimitive*e[0]];xt.clear(),xt.push(o);const l=k(i[o],i[o+1],i[o+2]),c=B(l);for(let t=0;t<n;++t){const r=this._numIndexPerPrimitive*e[t];for(let e=0;e<this._numIndexPerPrimitive;++e){o=s*a[r+e],xt.push(o);let t=i[o];l[0]=Math.min(t,l[0]),c[0]=Math.max(t,c[0]),t=i[o+1],l[1]=Math.min(t,l[1]),c[1]=Math.max(t,c[1]),t=i[o+2],l[2]=Math.min(t,l[2]),c[2]=Math.max(t,c[2])}}for(let e=0;e<3;++e)this._data[4+e]=l[e],this._data[7+e]=c[e];const u=h(L(),this.bbMin,this.bbMax,.5);let d=.5*Math.max(Math.max(c[0]-l[0],c[1]-l[1]),c[2]-l[2]),f=d*d;for(let e=0;e<xt.length;++e){o=xt.at(e);const t=i[o]-u[0],r=i[o+1]-u[1],s=i[o+2]-u[2],a=t*t+r*r+s*s;if(a<=f)continue;const n=Math.sqrt(a),l=.5*(n-d);d+=l,f=d*d;const c=l/n;u[0]+=t*c,u[1]+=r*c,u[2]+=s*c}this._data[3]=d;for(let e=0;e<3;++e)this._data[0+e]=u[e];xt.clear()}getChildren(){if(this._children||d(this.bbMin,this.bbMax)<=1)return this._children;const e=h(L(),this.bbMin,this.bbMax,.5),t=this.primitiveIndices.length,r=new Uint8Array(t),i=new Array(8);for(let e=0;e<8;++e)i[e]=0;const{data:s,size:a,indices:n}=this.position;for(let o=0;o<t;++o){let t=0;const l=this._numIndexPerPrimitive*this.primitiveIndices[o];let c=a*n[l],u=s[c],h=s[c+1],d=s[c+2];for(let e=1;e<this._numIndexPerPrimitive;++e){c=a*n[l+e];const t=s[c],r=s[c+1],i=s[c+2];t<u&&(u=t),r<h&&(h=r),i<d&&(d=i)}u<e[0]&&(t|=1),h<e[1]&&(t|=2),d<e[2]&&(t|=4),r[o]=t,++i[t]}let o=0;for(let e=0;e<8;++e)i[e]>0&&++o;if(o<2)return;const l=new Array(8);for(let e=0;e<8;++e)l[e]=i[e]>0?new Uint32Array(i[e]):void 0;for(let e=0;e<8;++e)i[e]=0;for(let e=0;e<t;++e){const t=r[e];l[t][i[t]++]=this.primitiveIndices[e]}this._children=new Array;for(let e=0;e<8;++e)void 0!==l[e]&&this._children.push(new _t(l[e],this._numIndexPerPrimitive,this.position));return this._children}static prune(){xt.prune()}}const xt=new E({deallocator:null}),bt=L(),yt=L(),wt=L(),Ct=L();class Pt{constructor(e,t,r=null,i=0,s=null,a=-1){this.material=e,this.mapPositions=r,this.type=i,this.olidColor=s,this.edgeIndicesLength=a,this._highlights=null,this._highlightOptionsCounts=null,this.id=o(),this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[e,r]of t)this._attributes.set(e,{...r,indices:y(r.indices)}),"position"===e&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(e).indices.length:this.edgeIndicesLength)}instantiate(e={}){const t=new Pt(e.material||this.material,[],this.mapPositions,this.type,this.olidColor,this.edgeIndicesLength);return this._attributes.forEach((e,r)=>{e.exclusive=!1,t._attributes.set(r,e)}),t._boundingInfo=this._boundingInfo,t.transformation=e.transformation||this.transformation,t}get attributes(){return this._attributes}getMutableAttribute(e){let t=this._attributes.get(e);return t&&!t.exclusive&&(t={...t,exclusive:!0,data:vt(t.data)},this._attributes.set(e,t)),t}setAttributeData(e,t){const r=this._attributes.get(e);r?this._attributes.set(e,{...r,exclusive:!0,data:t}):N()&&console.warn(`Setting undefined attribute ${e} data`)}get indexCount(){const e=this._attributes.values().next().value?.indices;return e?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo??=this._calculateBoundingInfo(),this._boundingInfo}computeAttachmentOrigin(e){return!!(0===this.type?this._computeAttachmentOriginTriangles(e):2===this.type?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(null!=this._transformation&&v(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){return function(e,t){if(!e)return!1;const{size:r,data:i,indices:s}=e;f(t,0,0,0),f(Ct,0,0,0);let a=0,n=0;for(let e=0;e<s.length-2;e+=3){const o=s[e]*r,l=s[e+1]*r,c=s[e+2]*r;f(bt,i[o],i[o+1],i[o+2]),f(yt,i[l],i[l+1],i[l+2]),f(wt,i[c],i[c+1],i[c+2]);const u=H(bt,yt,wt);u?(m(bt,bt,yt),m(bt,bt,wt),p(bt,bt,1/3*u),m(t,t,bt),a+=u):(m(Ct,Ct,bt),m(Ct,Ct,yt),m(Ct,Ct,wt),n+=3)}return!(0===n&&0===a||(0!==a?(p(t,t,1/a),0):0===n||(p(t,Ct,1/n),0)))}(this.attributes.get("position"),e)}_computeAttachmentOriginLines(e){const t=this.attributes.get("position");return function(e,t,r){if(!e)return!1;f(r,0,0,0),f(Ct,0,0,0);let i=0,s=0;const{size:a,data:n,indices:o}=e,l=o.length-1,c=l+(t?2:0);for(let e=0;e<c;e+=2){const t=e<l?e+1:0,c=o[e<l?e:l]*a,u=o[t]*a;bt[0]=n[c],bt[1]=n[c+1],bt[2]=n[c+2],yt[0]=n[u],yt[1]=n[u+1],yt[2]=n[u+2],p(bt,m(bt,bt,yt),.5);const h=g(bt,yt);h>0?(m(r,r,p(bt,bt,h)),i+=h):0===i&&(m(Ct,Ct,bt),s++)}return 0!==i?(p(r,r,1/i),!0):0!==s&&(p(r,Ct,1/s),!0)}(t,function(e,t){return!(!("isClosed"in e)||!e.isClosed)&&t.indices.length>2}(this.material.parameters,t),e)}_computeAttachmentOriginPoints(e){return function(e,t){if(!e)return!1;const{size:r,data:i,indices:s}=e;f(t,0,0,0);let a=-1,n=0;for(let e=0;e<s.length;e++){const o=s[e]*r;a!==o&&(t[0]+=i[o],t[1]+=i[o+1],t[2]+=i[o+2],n++),a=o}return n>1&&p(t,t,1/n),n>0}(this.attributes.get("position"),e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.attributes.get("position");if(!e||0===e.indices.length)return null;const t=0===this.type?3:1;P(e.indices.length%t===0,"Indexing error: "+e.indices.length+" not divisible by "+t);const r=w(e.indices.length/t);return new _t(r,t,e)}get transformation(){return this._transformation??l}set transformation(e){this._transformation=e&&e!==l?c(e):null}get highlights(){return this._highlights||St}get hasHighlights(){return(this._highlightOptionsCounts?.size??0)>0}foreachHighlightOptions(e){this._highlightOptionsCounts?.forEach((t,r)=>e(r))}allocateIdAndHighlight(e){const t=new ot(e);return this.addHighlight(t)}addHighlight(e){this._ensureHighlights().add(e);const{highlightName:t}=e,r=(this._highlightOptionsCounts?.get(t)??0)+1;return this._ensureHighlightOptionsCounts().set(t,r),e}_ensureHighlights(){let e=this._highlights;return e||(e=new Set,this._highlights=e),e}_ensureHighlightOptionsCounts(){let e=this._highlightOptionsCounts;return e||(e=new Map,this._highlightOptionsCounts=e),e}removeHighlight(e){if(this._highlights?.delete(e)){const{highlightName:t}=e,r=this._highlightOptionsCounts?.get(t)??0;r<=1?this._highlightOptionsCounts?.delete(t):this._ensureHighlightOptionsCounts().set(t,r-1)}}}const St=new Set;function Mt(){return!!i("enable-feature:objectAndLayerId-rendering")}class zt{constructor(e){this._bits=[...e]}equals(e){return s(this._bits,e.bits)}get code(){return this._code??=String.fromCharCode(...this._bits),this._code}get bits(){return this._bits}}class Ft extends st{constructor(){super(),this._parameterBits=this._parameterBits?.map(()=>0)??[],this._parameterNames??=[]}get key(){return this._key??=new zt(this._parameterBits),this._key}decode(e=this.key){const t=this._parameterBits;this._parameterBits=[...e.bits];const r=this._parameterNames.map(e=>`    ${e}: ${this[e]}`).join("\n");return this._parameterBits=t,r}}function At(e={}){return(t,r)=>{t.hasOwnProperty("_parameterNames")||Object.defineProperty(t,"_parameterNames",{value:t._parameterNames?.slice()??[],configurable:!0,writable:!0}),t.hasOwnProperty("_parameterBits")||Object.defineProperty(t,"_parameterBits",{value:t._parameterBits?.slice()??[0],configurable:!0,writable:!0}),t._parameterNames.push(r);const i=e.count||2,s=Math.ceil(Math.log2(i)),a=t._parameterBits;let n=0;for(;a[n]+s>16;)n++,n>=a.length&&a.push(0);const o=a[n],l=(1<<s)-1<<o;a[n]+=s,e.count?Object.defineProperty(t,r,{get(){return(this._parameterBits[n]&l)>>o},set(t){if(this[r]!==t){if(this._key=null,this._parameterBits[n]=this._parameterBits[n]&~l|+t<<o&l,"number"!=typeof t)throw new X("internal:invalid-shader-configuration",`Configuration value for ${r} must be a number, got ${typeof t}`);if(null==e.count)throw new X("internal:invalid-shader-configuration",`Configuration value for ${r} must provide a count option`)}}}):Object.defineProperty(t,r,{get(){return!!((this._parameterBits[n]&l)>>o)},set(e){if(this[r]!==e&&(this._key=null,this._parameterBits[n]=this._parameterBits[n]&~l|+e<<o&l,"boolean"!=typeof e))throw new X("internal:invalid-shader-configuration",`Configuration value for ${r} must be boolean, got ${typeof e}`)}})}}class Tt extends Ft{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}}class Dt extends Tt{constructor(){super(...arguments),this.output=0,this.oitPass=0,this.hasSlicePlane=!1,this.hasHighlightMixTexture=!1,this.bindType=1,this.instanced=!1,this.writeDepth=!0}}function It(e,t){return new Vt(e,Ut,t)}function Ot(e,t){const{curvatureDependent:r,scaleStart:i,scaleFallOffRange:s}=Ut;return new Vt(e,{curvatureDependent:{min:{curvature:r.min.curvature,tiltAngle:r.min.tiltAngle,scaleFallOffFactor:jt.curvatureDependent.min.scaleFallOffFactor},max:{curvature:r.max.curvature,tiltAngle:r.max.tiltAngle,scaleFallOffFactor:jt.curvatureDependent.max.scaleFallOffFactor}},scaleStart:i,scaleFallOffRange:s,minPixelSize:jt.minPixelSize},t)}function Et(e,t,r){const i=r.parameters;return Ht.scale=Math.min(i.divisor/(t-i.offset),1),Ht.factor=function(e){return Math.abs(e*e*e)}(e),Ht}function kt(e,t){return W(e*Math.max(t.scale,t.minScaleFactor),e,t.factor)}function Bt(e,t,r,i){i.scale=function(e,t,r){const i=Et(e,t,r);return i.minScaleFactor=0,kt(1,i)}(e,t,r),i.factor=0,i.minScaleFactor=r.minScaleFactor}function Lt(e,t,r=[0,0]){const i=Math.min(Math.max(t.scale,t.minScaleFactor),1);return r[0]=e[0]*i,r[1]=e[1]*i,r}G([At({count:10})],Dt.prototype,"output",void 0),G([At({count:3})],Dt.prototype,"oitPass",void 0),G([At()],Dt.prototype,"hasSlicePlane",void 0),G([At()],Dt.prototype,"hasHighlightMixTexture",void 0);class Vt{get minScaleFactor(){return null!=this._fontHeight?Math.min(this._description.minPixelSize/this._fontHeight,1):0}constructor(e,t,r,i={camera:{distance:0,fovY:0},divisor:0,offset:0},s){this._viewingMode=e,this._description=t,this._ellipsoidRadius=r,this.parameters=i,this._fontHeight=s,2===this._viewingMode?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return!(this.parameters&&this.parameters.camera.fovY===e.fovY&&this.parameters.camera.distance===e.distance||(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),0))}overrideFontHeight(e){return e!==this._fontHeight?new Vt(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,t,r){const{scaleStart:i,scaleFallOffRange:s}=this._description,{fovY:a,distance:n}=e,o=this._calculateCurvatureDependentParameters(e,t),l=this._coverageCompensation(e,t,o),{tiltAngle:c,scaleFallOffFactor:u}=o,h=Math.sin(c)*n,d=.5*Math.PI-c-a*(.5-i*l),f=h/Math.cos(d),m=d+a*s*l,p=(f-u*(h/Math.cos(m)))/(1-u);return r.camera.fovY=e.fovY,r.camera.distance=e.distance,r.offset=p,r.divisor=f-p,r}_calculateCurvatureDependentParametersLocal(e,t,r=Nt){return r.tiltAngle=this._description.curvatureDependent.min.tiltAngle,r.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,r}_calculateCurvatureDependentParametersGlobal(e,t,r=Nt){const i=this._description.curvatureDependent,s=1+e.distance/t,a=Math.sqrt(s*s-1),[n,o]=[i.min.curvature,i.max.curvature],l=Y((a-n)/(o-n),0,1),[c,u]=[i.min,i.max];return r.tiltAngle=W(c.tiltAngle,u.tiltAngle,l),r.scaleFallOffFactor=W(c.scaleFallOffFactor,u.scaleFallOffFactor,l),r}_surfaceCoverageCompensationLocal(e,t,r){return Z(r.tiltAngle,e.fovY)}_surfaceCoverageCompensationGlobal(e,t,r){return J(Rt,t),ee(Rt,r.tiltAngle,e.distance,e.fovY)}}const Ut={curvatureDependent:{min:{curvature:K(10),tiltAngle:K(12),scaleFallOffFactor:.5},max:{curvature:K(70),tiltAngle:K(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},jt={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14},Ht={scale:0,factor:0,minScaleFactor:0},Nt={tiltAngle:0,scaleFallOffFactor:0},Rt=Q();function $t(e,t,r,i,s){let a=r.screenLength*e.pixelRatio;null!=s&&(a=function(e,t,r,i){return kt(e,Et(t,r,i))}(a,i,t,s));const n=a*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return Y(n*t,r.minWorldLength,r.maxWorldLength)}function qt(e,t){let r=!1;for(const i in t){const a=t[i];void 0!==a&&(Array.isArray(a)?Array.isArray(e[i])&&s(a,e[i])||(e[i]=a.slice(),r=!0):e[i]!==a&&(r=!0,e[i]=a))}return r}const Gt={multiply:1,ignore:2,replace:3,tint:4};class Xt{constructor(e,t){this.id=o(),this.supportsEdges=!1,this._renderPriority=0,this._parameters=new t,qt(this._parameters,e),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(e){return!1}setParameters(e,t=!0){qt(this._parameters,e)&&(this.validateParameters(this._parameters),t&&this._parametersChanged())}validateParameters(e){}shouldRender(e){return this.visible&&this.isVisibleForOutput(e.output)&&(!this.parameters.isDecoration||e.bind.decorations)&&0!==(this.parameters.renderOccluded&e.renderOccludedMask)}isVisibleForOutput(e){return!0}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this._parametersChanged())}_parametersChanged(){this.repository?.materialChanged(this)}get renderOccludedFlags(){return this.visible?this.parameters.renderOccluded:0}get hasEmissions(){return!1}getConfiguration(e,t,r=new Dt){return r.output=e,r.hasHighlightMixTexture=8===e&&null!=t.highlightMixTexture,r}}class Wt extends st{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1}}class Kt{constructor(e){this.field=e}}class Yt extends Kt{constructor(e){super(e),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[0,0,0],this.fallback=[0,0,0]}}class Zt extends Kt{constructor(e){super(e),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0],this.fallback=[0,0,0,0]}}class Jt extends Kt{constructor(e,t=0){super(e),this.fallback=t,this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}}class Qt{}function er(e){return null!=e}function tr(e,t,r,i,s){const a=e.minSize,n=e.maxSize;if(e.useSymbolValue){const e=i.symbolSize[r];return t.minSize[r]=e,t.maxSize[r]=e,t.offset[r]=t.minSize[r],t.factor[r]=0,t.type[r]=1,!0}if(er(e.field))return er(e.stops)?!(2!==e.stops.length||!Fe(e.stops[0].size)||!Fe(e.stops[1].size)||(rr(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,r),t.type[r]=1,0)):Fe(a)&&Fe(n)&&er(e.minDataValue)&&er(e.maxDataValue)?(rr(a,n,e.minDataValue,e.maxDataValue,t,r),t.type[r]=1,!0):"unknown"!==e.valueUnit&&null!=Se[e.valueUnit]&&(t.minSize[r]=-1/0,t.maxSize[r]=1/0,t.offset[r]=0,t.factor[r]=1/Se[e.valueUnit],t.type[r]=1,!0);if(!er(e.field)){if(e.stops?.[0]&&Fe(e.stops[0].size))return t.minSize[r]=e.stops[0].size,t.maxSize[r]=e.stops[0].size,t.offset[r]=t.minSize[r],t.factor[r]=0,t.type[r]=1,!0;if(Fe(a))return t.minSize[r]=a,t.maxSize[r]=a,t.offset[r]=a,t.factor[r]=0,t.type[r]=1,!0}return!1}function rr(e,t,r,i,s,a){const n=Math.abs(i-r)>0?(t-e)/(i-r):0;s.minSize[a]=n>0?e:t,s.maxSize[a]=n>0?t:e,s.offset[a]=e-r*n,s.factor[a]=n}function ir(e,t,r){e[4*t]=r.r/255,e[4*t+1]=r.g/255,e[4*t+2]=r.b/255,e[4*t+3]=r.a}function sr(e,t,r){const i=2===r&&"arithmetic"===e.rotationType;t.offset[r]=i?90:0,t.factor[r]=i?-1:1,t.type[r]=1}class ar{constructor({supports:e,modelSize:t,symbolSize:r,unitInMeters:i,anchor:s,scale:a,rotation:n,fallbackColor:o,fallbackSize:l}){this.supports=e,this.modelSize=t??V(),this.symbolSize=r??V(),this.unitInMeters=i??1,this.anchor=s??U(),this.scale=a??V(),this.rotation=n??U(),this.fallbackColor=o??Pe(),this.fallbackSize=l??V()}}function nr(e,t,r){if(!e)return null;const i=e.reduce((e,r)=>{if(!e)return e;if(r.valueExpression)return null;switch(r.type){case"size":return t.supports.size?function(e,t,r){if(e.normalizationField||e.valueRepresentation)return null;if(!ze(e.field))return null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return null}else t.size.field=e.field}else t.size=new Yt(e.field),_(t.size.fallback,r.fallbackSize);let i;switch(e.axis){case"width":return i=tr(e,t.size,0,r),i?t:null;case"height":return i=tr(e,t.size,2,r),i?t:null;case"depth":return i=tr(e,t.size,1,r),i?t:null;case"width-and-depth":return i=tr(e,t.size,0,r),i&&tr(e,t.size,1,r),i?t:null;case null:case void 0:case"all":return i=tr(e,t.size,0,r),i=i&&tr(e,t.size,1,r),i=i&&tr(e,t.size,2,r),i?t:null;default:return e.axis,null}}(r,e,t):e;case"color":return t.supports.color?function(e,t,r){if(e.normalizationField)return null;if(Me(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.color=new Zt(e.field);const i=e.stops;for(let e=0;e<8;++e){const r=i[Math.min(e,i.length-1)];t.color.values[e]=r.value,ir(t.color.colors,e,r.color)}Ce(t.color.fallback,r.fallbackColor)}}else{if(!(e.stops&&e.stops.length>=0))return null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color=new Zt(null);for(let e=0;e<8;e++)t.color.values[e]=1/0,ir(t.color.colors,e,i);Ce(t.color.fallback,r.fallbackColor)}}return t}(r,e,t):e;case"opacity":return t.supports.opacity?function(e,t,r){if(e.normalizationField)return null;if(Me(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.opacity=new Jt(e.field,r.fallbackColor[3]);const i=e.stops;for(let e=0;e<8;++e){const r=i[Math.min(e,i.length-1)];t.opacity.values[e]=r.value,t.opacity.opacityValues[e]=r.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const i=e.stops&&e.stops.length>=0?e.stops[0].opacity:0;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0],fallback:r.fallbackColor[3]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=i}}return t}(r,e,t):null;case"rotation":return t.supports.rotation?function(e,t){if(!Me(e.field))return null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return sr(e,t.rotation,0),t;case"roll":return sr(e,t.rotation,1),t;case null:case void 0:case"heading":return sr(e,t.rotation,2),t;default:return e.axis,null}}(r,e):e;default:return null}},new Qt);return!(e.length>0&&i)||i.size||i.color||i.opacity||i.rotation?i?.size&&!function(e,t){for(let r=0;r<3;++r){let i=t.unitInMeters;1===e.type[r]&&(i*=t.modelSize[r],e.type[r]=2),e.minSize[r]=e.minSize[r]/i,e.maxSize[r]=e.maxSize[r]/i,e.offset[r]=e.offset[r]/i,e.factor[r]=e.factor[r]/i}let r;if(0!==e.type[0])r=0;else if(0!==e.type[1])r=1;else{if(0===e.type[2])return!1;r=2}for(let t=0;t<3;++t)0===e.type[t]&&(e.minSize[t]=e.minSize[r],e.maxSize[t]=e.maxSize[r],e.offset[t]=e.offset[r],e.factor[t]=e.factor[r],e.type[t]=e.type[r]);return!0}(i.size,t)?null:i:null}class or{constructor(e,t,r){this.visualVariables=e,this.materialParameters=t,this.requiresShaderTransformation=r}}function lr(e,t){if(!e)return null;if(Mt())return null;if(Ae.TESTS_DISABLE_FAST_UPDATES)return null;const r=nr(e.visualVariables,t);return r?new or(r,dr(r,t),!!r.size):null}function cr(e,t,r){if(!t||!e)return!1;const i=e.visualVariables,s=nr(t.visualVariables,r);return!!s&&!!(ur(i.size,s.size,"size")&&ur(i.color,s.color,"color")&&ur(i.rotation,s.rotation,"rotation")&&ur(i.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=dr(s,r),e.requiresShaderTransformation=!!s.size,!0)}function ur(e,t,r){if(!!e!=!!t)return!1;if(e&&e.field!==t?.field)return!1;if(e&&"rotation"===r){const r=e,i=t;for(let e=0;e<3;e++)if(r.type[e]!==i.type[e]||r.offset[e]!==i.offset[e]||r.factor[e]!==i.factor[e])return!1}return!0}class hr extends st{constructor(e){super(),this.vvSize=e?.size??null,this.vvColor=e?.color??null,this.vvOpacity=e?.opacity??null}get hasVVSize(){return!!this.vvSize}get hasVVColor(){return!!this.vvColor}get hasVVOpacity(){return!!this.vvOpacity}}function dr(e,t){const r=new hr(e);return r.vvSize&&(r.vvSymbolAnchor=t.anchor,te(_r),function(e,t,r,i=u()){const s=e||0,a=t||0,n=r||0;0!==s&&oe(i,i,-s/180*Math.PI),0!==a&&le(i,i,a/180*Math.PI),0!==n&&ce(i,i,n/180*Math.PI)}(t.rotation[2],t.rotation[0],t.rotation[1],_r),r.vvSymbolRotationMatrix=r.vvSymbolRotationMatrix||we(),ye(r.vvSymbolRotationMatrix,_r)),r}function fr(e,t,r){if(!e.vvSize)return r;re(gr,r);const i=e.vvSymbolRotationMatrix;return ie(_r,i[0],i[1],i[2],0,i[3],i[4],i[5],0,i[6],i[7],i[8],0,0,0,0,1),se(gr,gr,_r),mr(vr,e,t),ae(gr,gr,vr),ne(gr,gr,e.vvSymbolAnchor),gr}function mr(e,t,r){if(!t.vvSize)return f(e,1,1,1),e;if(Number.isNaN(r[0]))return _(e,t.vvSize.fallback);for(let i=0;i<3;++i){const s=t.vvSize.offset[i]+r[0]*t.vvSize.factor[i];e[i]=Y(s,t.vvSize.minSize[i],t.vvSize.maxSize[i])}return e}function pr(e,t){const r=null==e?0:t.attributes[e];return"number"==typeof r&&isFinite(r)?r:NaN}const gr=u(),vr=L(),_r=u();class xr extends hr{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1}}const br=8;function yr(e,t,r,i=1){const{data:s,indices:a}=e,n=t.typedBuffer,o=t.typedBufferStride,l=a.length;if(r*=o,1===i)for(let e=0;e<l;++e)n[r]=s[a[e]],r+=o;else for(let e=0;e<l;++e){const t=s[a[e]];for(let e=0;e<i;e++)n[r]=t,r+=o}}function wr(e,t,r){const{data:i,indices:s}=e,a=t.typedBuffer,n=t.typedBufferStride,o=s.length;r*=n;for(let e=0;e<o;++e){const t=2*s[e];a[r]=i[t],a[r+1]=i[t+1],r+=n}}function Cr(e,t,r,i=1){const{data:s,indices:a}=e,n=t.typedBuffer,o=t.typedBufferStride,l=a.length;if(r*=o,1===i)for(let e=0;e<l;++e){const t=3*a[e];n[r]=s[t],n[r+1]=s[t+1],n[r+2]=s[t+2],r+=o}else for(let e=0;e<l;++e){const t=3*a[e];for(let e=0;e<i;++e)n[r]=s[t],n[r+1]=s[t+1],n[r+2]=s[t+2],r+=o}}function Pr(e,t,r,i=1){const{data:s,indices:a}=e,n=t.typedBuffer,o=t.typedBufferStride,l=a.length;if(r*=o,1===i)for(let e=0;e<l;++e){const t=4*a[e];n[r]=s[t],n[r+1]=s[t+1],n[r+2]=s[t+2],n[r+3]=s[t+3],r+=o}else for(let e=0;e<l;++e){const t=4*a[e];for(let e=0;e<i;++e)n[r]=s[t],n[r+1]=s[t+1],n[r+2]=s[t+2],n[r+3]=s[t+3],r+=o}}function Sr(e,t,r){const i=e.typedBuffer,s=e.typedBufferStride;t*=s;for(let e=0;e<r;++e)i[t]=0,i[t+1]=0,i[t+2]=0,i[t+3]=0,t+=s}function Mr(e,t,r,i,s=1){if(!t)return void Cr(e,r,i,s);const{data:a,indices:n}=e,o=r.typedBuffer,l=r.typedBufferStride,c=n.length,u=t[0],h=t[1],d=t[2],f=t[4],m=t[5],p=t[6],g=t[8],v=t[9],_=t[10],x=t[12],b=t[13],y=t[14];i*=l;let w=0,C=0,P=0;const S=ue(t)?e=>{w=a[e]+x,C=a[e+1]+b,P=a[e+2]+y}:e=>{const t=a[e],r=a[e+1],i=a[e+2];w=u*t+f*r+g*i+x,C=h*t+m*r+v*i+b,P=d*t+p*r+_*i+y};if(1===s)for(let e=0;e<c;++e)S(3*n[e]),o[i]=w,o[i+1]=C,o[i+2]=P,i+=l;else for(let e=0;e<c;++e){S(3*n[e]);for(let e=0;e<s;++e)o[i]=w,o[i+1]=C,o[i+2]=P,i+=l}}function zr(e,t,r,i,s=1){if(!t)return void Cr(e,r,i,s);const{data:a,indices:n}=e,o=t,l=r.typedBuffer,c=r.typedBufferStride,u=n.length,h=o[0],d=o[1],f=o[2],m=o[4],p=o[5],g=o[6],v=o[8],_=o[9],x=o[10],b=!he(o),y=1e-6,w=.999999;i*=c;let C=0,P=0,S=0;const M=ue(o)?e=>{C=a[e],P=a[e+1],S=a[e+2]}:e=>{const t=a[e],r=a[e+1],i=a[e+2];C=h*t+m*r+v*i,P=d*t+p*r+_*i,S=f*t+g*r+x*i};if(1===s)if(b)for(let e=0;e<u;++e){M(3*n[e]);const t=C*C+P*P+S*S;if(t<w&&t>y){const e=1/Math.sqrt(t);l[i]=C*e,l[i+1]=P*e,l[i+2]=S*e}else l[i]=C,l[i+1]=P,l[i+2]=S;i+=c}else for(let e=0;e<u;++e)M(3*n[e]),l[i]=C,l[i+1]=P,l[i+2]=S,i+=c;else for(let e=0;e<u;++e){if(M(3*n[e]),b){const e=C*C+P*P+S*S;if(e<w&&e>y){const t=1/Math.sqrt(e);C*=t,P*=t,S*=t}}for(let e=0;e<s;++e)l[i]=C,l[i+1]=P,l[i+2]=S,i+=c}}function Fr(e,t,r,i,s=1){const{data:a,indices:n}=e,o=r.typedBuffer,l=r.typedBufferStride,c=n.length;if(i*=l,t===a.length&&4===t){o[i]=a[0],o[i+1]=a[1],o[i+2]=a[2],o[i+3]=a[3];const e=new Uint32Array(r.typedBuffer.buffer,r.start),t=l/4,n=e[i/=4];i+=t;const u=c*s;for(let r=1;r<u;++r)e[i]=n,i+=t;return}if(1!==s)if(4!==t)for(let e=0;e<c;++e){const t=3*n[e];for(let e=0;e<s;++e)o[i]=a[t],o[i+1]=a[t+1],o[i+2]=a[t+2],o[i+3]=255,i+=l}else for(let e=0;e<c;++e){const t=4*n[e];for(let e=0;e<s;++e)o[i]=a[t],o[i+1]=a[t+1],o[i+2]=a[t+2],o[i+3]=a[t+3],i+=l}else{if(4===t){for(let e=0;e<c;++e){const t=4*n[e];o[i]=a[t],o[i+1]=a[t+1],o[i+2]=a[t+2],o[i+3]=a[t+3],i+=l}return}for(let e=0;e<c;++e){const t=3*n[e];o[i]=a[t],o[i+1]=a[t+1],o[i+2]=a[t+2],o[i+3]=255,i+=l}}}function Ar(e,t,r,i){x(Tr,e,t);const s=Math.max(Math.sqrt(b(Tr)),1e-4);p(Tr,Tr,1/s),r[i++]=Tr[0],r[i++]=Tr[1],r[i++]=Tr[2],r[i++]=s}const Tr=L();function Dr(e,t,r,i,s=1){const a=t.typedBuffer,n=t.typedBufferStride;if(i*=n,1===s)for(let t=0;t<r;++t)a[i]=e[0],a[i+1]=e[1],a[i+2]=e[2],a[i+3]=e[3],i+=n;else for(let t=0;t<r;++t)for(let t=0;t<s;++t)a[i]=e[0],a[i+1]=e[1],a[i+2]=e[2],a[i+3]=e[3],i+=n}function Ir(e,t,r,i,s,a,n){let o={numItems:0,numVerticesPerItem:0};for(const l of r.fields.keys()){const r=e.get(l),c=r?.indices;if(r&&c)"position"===l&&(o={numItems:1,numVerticesPerItem:c.length}),Or(l,r,i,s,a,n);else if("olidColor"===l&&null!=t){const r=e.get("position")?.indices;if(r){const e=r.length;Dr(t,a.getField(l,S),e,n)}}}return o}function Or(e,t,r,i,s,a){switch(e){case"position":{P(3===t.size);const i=s.getField(e,z);P(!!i,`No buffer view for ${e}`),Mr(t,r,i,a);break}case"normal":{P(3===t.size);const r=s.getField(e,z);P(!!r,`No buffer view for ${e}`),zr(t,i,r,a);break}case"normalCompressed":case"profileRight":case"profileUp":{P(2===t.size);const r=s.getField(e,D);P(!!r,`No buffer view for ${e}`),wr(t,r,a);break}case"uv0":{P(2===t.size);const r=s.getField(e,I)??s.getField(e,O);P(!!r,`No buffer view for ${e}`),wr(t,r,a);break}case"uvi":{P(2===t.size);const r=s.getField(e,D);P(!!r,`No buffer view for ${e}`),wr(t,r,a);break}case"color":case"symbolColor":{const r=s.getField(e,S);P(!!r,`No buffer view for ${e}`),P(3===t.size||4===t.size),Fr(t,t.size,r,a);break}case"colorFeatureAttribute":case"opacityFeatureAttribute":case"sizeFeatureAttribute":{const r=s.getField(e,T)??s.getField(e,T);P(!!r,`No buffer view for ${e}`),P(1===t.size),function(e,t,r){const{data:i,indices:s}=e,a=t.typedBuffer,n=t.typedBufferStride,o=s.length,l=i[0];r*=n;for(let e=0;e<o;++e)a[r]=l,r+=n}(t,r,a);break}case"tangent":{P(4===t.size);const i=s.getField(e,A);P(!!i,`No buffer view for ${e}`),function(e,t,r,i,s=1){if(!t)return void Pr(e,r,i,s);const{data:a,indices:n}=e,o=t,l=r.typedBuffer,c=r.typedBufferStride,u=n.length,h=o[0],d=o[1],f=o[2],m=o[4],p=o[5],g=o[6],v=o[8],_=o[9],x=o[10],b=!he(o),y=1e-6,w=.999999;if(i*=c,1===s)for(let e=0;e<u;++e){const t=4*n[e],r=a[t],s=a[t+1],o=a[t+2],u=a[t+3];let C=h*r+m*s+v*o,P=d*r+p*s+_*o,S=f*r+g*s+x*o;if(b){const e=C*C+P*P+S*S;if(e<w&&e>y){const t=1/Math.sqrt(e);C*=t,P*=t,S*=t}}l[i]=C,l[i+1]=P,l[i+2]=S,l[i+3]=u,i+=c}else for(let e=0;e<u;++e){const t=4*n[e],r=a[t],o=a[t+1],u=a[t+2],C=a[t+3];let P=h*r+m*o+v*u,S=d*r+p*o+_*u,M=f*r+g*o+x*u;if(b){const e=P*P+S*S+M*M;if(e<w&&e>y){const t=1/Math.sqrt(e);P*=t,S*=t,M*=t}}for(let e=0;e<s;++e)l[i]=P,l[i+1]=S,l[i+2]=M,l[i+3]=C,i+=c}}(t,r,i,a);break}case"profileVertexAndNormal":{P(4===t.size);const r=s.getField(e,F)??s.getField(e,A);P(!!r,`No buffer view for ${e}`),Pr(t,r,a);break}case"profileAuxData":{P(3===t.size);const r=s.getField(e,M)??s.getField(e,z);P(!!r,`No buffer view for ${e}`),Cr(t,r,a);break}}}class Er extends st{constructor(e){super(),this.slicePlaneLocalOrigin=e}}function kr(e,t){jr(e,t,new fe("slicePlaneOrigin",(e,r)=>$r(t,e,r)),new fe("slicePlaneBasis1",(e,r)=>qr(t,e,r,r.slicePlane?.basis1)),new fe("slicePlaneBasis2",(e,r)=>qr(t,e,r,r.slicePlane?.basis2)))}function Br(e,t){jr(e,t,new de("slicePlaneOrigin",(e,r)=>$r(t,e,r)),new de("slicePlaneBasis1",(e,r)=>qr(t,e,r,r.slicePlane?.basis1)),new de("slicePlaneBasis2",(e,r)=>qr(t,e,r,r.slicePlane?.basis2)))}function Lr(e,t){Ur(e,t,new de("slicePlaneOrigin",(e,r)=>$r(t,e,r)),new de("slicePlaneBasis1",(e,r)=>qr(t,e,r,r.slicePlane?.basis1)),new de("slicePlaneBasis2",(e,r)=>qr(t,e,r,r.slicePlane?.basis2)))}const Vr=xe`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
bool rejectBySlice(vec3 pos) {
return sliceByPlane(pos);
}`;function Ur(e,t,...r){t.hasSlicePlane?(e.uniforms.add(...r),e.code.add(Vr)):e.code.add("bool rejectBySlice(vec3 pos) { return false; }")}function jr(e,t,...r){Ur(e,t,...r),t.hasSlicePlane?e.code.add("\n    void discardBySlice(vec3 pos) {\n      if (sliceByPlane(pos)) {\n        discard;\n      }\n    }\n\n    vec4 applySliceOutline(vec4 color, vec3 pos) {\n      SliceFactors factors = calculateSliceFactors(pos);\n\n      factors.front /= 2.0 * fwidth(factors.front);\n      factors.side0 /= 2.0 * fwidth(factors.side0);\n      factors.side1 /= 2.0 * fwidth(factors.side1);\n      factors.side2 /= 2.0 * fwidth(factors.side2);\n      factors.side3 /= 2.0 * fwidth(factors.side3);\n\n      // return after calling fwidth, to avoid aliasing caused by discontinuities in the input to fwidth\n      if (sliceByFactors(factors)) {\n        return color;\n      }\n\n      float outlineFactor = (1.0 - step(0.5, factors.front))\n        * (1.0 - step(0.5, factors.side0))\n        * (1.0 - step(0.5, factors.side1))\n        * (1.0 - step(0.5, factors.side2))\n        * (1.0 - step(0.5, factors.side3));\n\n      return mix(color, vec4(vec3(0.0), color.a), outlineFactor * 0.3);\n    }\n\n    vec4 applySlice(vec4 color, vec3 pos) {\n      return sliceEnabled() ? applySliceOutline(color, pos) : color;\n    }\n  "):e.code.add(xe`void discardBySlice(vec3 pos) { }
vec4 applySlice(vec4 color, vec3 pos) { return color; }`)}function Hr(e,t,r){return e.instancedDoublePrecision?f(Gr,r.camera.viewInverseTransposeMatrix[3],r.camera.viewInverseTransposeMatrix[7],r.camera.viewInverseTransposeMatrix[11]):t.slicePlaneLocalOrigin}function Nr(e,t){return null!=e?x(Xr,t.origin,e):t.origin}function Rr(e,t,r){return e.hasSliceTranslatedView?null!=t?ne(Kr,r.camera.viewMatrix,t):r.camera.viewMatrix:null}function $r(e,t,r){if(null==r.slicePlane)return j;const i=Hr(e,t,r),s=Nr(i,r.slicePlane),a=Rr(e,i,r);return null!=a?v(Xr,s,a):s}function qr(e,t,r,i){if(null==i||null==r.slicePlane)return j;const s=Hr(e,t,r),a=Nr(s,r.slicePlane),n=Rr(e,s,r);return null!=n?(m(Wr,i,a),v(Xr,a,n),v(Wr,Wr,n),x(Wr,Wr,Xr)):i}const Gr=L(),Xr=L(),Wr=L(),Kr=u();function Yr(e,t){if(9!==t.output)return e.vertex.code.add(xe`void forwardObjectAndLayerIdColor() {}`),void e.fragment.code.add(xe`void outputObjectAndLayerIdColor() {}`);const r=t.instanced;e.varyings.add("objectAndLayerIdColorVarying","vec4");const i=r?"instanceOlidColor":"olidColor";e.attributes.add(i,"vec4"),e.vertex.code.add(xe`
    void forwardObjectAndLayerIdColor() {
      objectAndLayerIdColorVarying = ${i} * 0.003921568627451;
    }`),e.fragment.code.add(xe`void outputObjectAndLayerIdColor() {
fragColor = objectAndLayerIdColorVarying;
}`)}function Zr(e){e.code.add(xe`struct MaskedColor {
vec4 color;
bvec4 mask;
};`)}function Jr(e){e.include(Zr),e.code.add(xe`
    MaskedColor createMaskedFromUInt8NaNColor(vec4 color) {
      return MaskedColor(color * ${xe.float(1/254)}, equal(color, vec4(255)));
    }
  `)}function Qr(e){e.include(Zr),e.code.add(xe`MaskedColor multiplyMaskedColors(MaskedColor color1, MaskedColor color2) {
vec4 masked1 = mix(color1.color, vec4(1), color1.mask);
vec4 masked2 = mix(color2.color, vec4(1), color2.mask);
return MaskedColor(masked1 * masked2, bvec4(ivec4(color1.mask) & ivec4(color2.mask)));
}`)}function ei(e){e.include(Zr),e.code.add(xe`MaskedColor createMaskedFromNaNColor(vec4 color) {
return MaskedColor(color, isnan(color));
}`)}class ti extends me{constructor(e,t,r){super(e,"vec4",1,(i,s,a)=>i.setUniform4fv(e,t(s,a),r))}}class ri extends me{constructor(e,t,r,i){super(e,"vec4",1,(r,s,a)=>r.setUniform4fv(e,t(s,a),i),r)}}class ii extends me{constructor(e,t,r,i){super(e,"float",1,(r,s,a)=>r.setUniform1fv(e,t(s,a),i),r)}}class si extends me{constructor(e,t,r){super(e,"mat3",1,(i,s,a)=>i.setUniformMatrix3fv(e,t(s,a),r))}}function ai(e,t){const{vertex:r,attributes:i}=e;t.hasVVInstancing&&(t.hasVVSize||t.hasVVColor)&&i.add("instanceFeatureAttribute","vec4"),t.hasVVSize?(r.uniforms.add(new fe("vvSizeMinSize",e=>e.vvSize.minSize)),r.uniforms.add(new fe("vvSizeMaxSize",e=>e.vvSize.maxSize)),r.uniforms.add(new fe("vvSizeOffset",e=>e.vvSize.offset)),r.uniforms.add(new fe("vvSizeFactor",e=>e.vvSize.factor)),r.uniforms.add(new fe("vvSizeFallback",e=>e.vvSize.fallback)),r.uniforms.add(new si("vvSymbolRotationMatrix",e=>e.vvSymbolRotationMatrix)),r.uniforms.add(new fe("vvSymbolAnchor",e=>e.vvSymbolAnchor)),r.code.add(xe`vec3 vvScale(vec4 _featureAttribute) {
if (isnan(_featureAttribute.x)) {
return vvSizeFallback;
}
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),r.code.add(xe`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 scale = max(vvScale(_featureAttribute), eps);
        return vec4(vvSymbolRotationMatrix * _normal / scale, 1.0);
      }

      ${t.hasVVInstancing?xe`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):r.code.add(xe`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),e.vertex.include(Zr),t.hasVVColor?(r.constants.add("vvColorNumber","int",8),r.uniforms.add(new ii("vvColorValues",e=>e.vvColor.values,8),new ri("vvColorColors",e=>e.vvColor.colors,8),new ti("vvColorFallback",e=>e.vvColor.fallback,{supportsNaN:!0})),t.hasVVInstancing&&(e.vertex.include(Qr),e.vertex.include(ei)),r.code.add(xe`
      vec4 interpolateVVColor(float value) {
        if (isnan(value)) {
          return vvColorFallback;
        }

        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${t.hasVVInstancing?xe`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return multiplyMaskedColors(color, createMaskedFromNaNColor(vvColor()));
            }
            `:xe`
            vec4 vvColor() {
              return vec4(1.0);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return color;
            }
            `}
    `)):r.code.add(xe`vec4 vvColor() {
return vec4(1.0);
}
MaskedColor applyVVColor(MaskedColor color) {
return color;
}`)}class ni extends me{constructor(e,t,r){super(e,"vec3",0,(i,s)=>i.setUniform3fv(e,t(s),r))}}class oi extends me{constructor(e,t,r){super(e,"float",0,(i,s)=>i.setUniform1f(e,t(s),r))}}class li extends me{constructor(e,t,r){super(e,"mat4",0,(i,s)=>i.setUniformMatrix4fv(e,t(s),r))}}class ci extends me{constructor(e,t,r){super(e,"mat4",2,(i,s,a)=>i.setUniformMatrix4fv(e,t(s,a),r))}}function ui(e,t){t.instancedDoublePrecision?e.constants.add("cameraPosition","vec3",j):e.uniforms.add(new de("cameraPosition",(e,t)=>f(fi,t.camera.viewInverseTransposeMatrix[3]-e.origin[0],t.camera.viewInverseTransposeMatrix[7]-e.origin[1],t.camera.viewInverseTransposeMatrix[11]-e.origin[2])))}function hi(e,t){if(!t.instancedDoublePrecision)return void e.uniforms.add(new li("proj",e=>e.camera.projectionMatrix),new ci("view",(e,t)=>ne(di,t.camera.viewMatrix,e.origin)),new de("localOrigin",e=>e.origin));const r=({camera:e})=>f(fi,e.viewInverseTransposeMatrix[3],e.viewInverseTransposeMatrix[7],e.viewInverseTransposeMatrix[11]);e.uniforms.add(new li("proj",e=>e.camera.projectionMatrix),new li("view",e=>ne(di,e.camera.viewMatrix,r(e))),new ni("localOrigin",e=>r(e)))}const di=u(),fi=L();function mi(e){e.uniforms.add(new li("viewNormal",e=>e.camera.viewInverseTransposeMatrix))}function pi(e){e.uniforms.add(new oi("pixelRatio",e=>e.camera.pixelRatio/e.overlayStretch))}let gi,vi=null,_i=null;async function xi(){return null==_i&&(gi??=(async()=>{const e=await import("./basis_transcoder.js"),t=await e.default({locateFile:e=>He(`esri/libs/basisu/${e}`)});return t.initializeBasis(),t})(),_i=gi,vi=await _i),_i}function bi(e,t,r,i,s){const a=$(t?Ne.COMPRESSED_RGBA8_ETC2_EAC:Ne.COMPRESSED_RGB8_ETC2),n=s&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(r*i*a*n)}function yi(e){return e.getNumImages()>=1&&!e.isUASTC()}function wi(e){return e.getFaces()>=1&&e.isETC1S()}function Ci(e,t,r,i,s,a,n,o){const{compressedTextureETC:l,compressedTextureS3TC:c}=e.capabilities,[u,h]=l?i?[1,Ne.COMPRESSED_RGBA8_ETC2_EAC]:[0,Ne.COMPRESSED_RGB8_ETC2]:c?i?[3,Ne.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,Ne.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],d=t.hasMipmap?r:Math.min(1,r),f=[];for(let e=0;e<d;e++)f.push(new Uint8Array(n(e,u))),o(e,u,f[e]);return t.internalFormat=h,t.hasMipmap=f.length>1,t.samplingMode=t.hasMipmap?9987:9729,t.width=s,t.height=a,new R(e,t,{type:"compressed",levels:f})}const Pi=()=>Xe.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function Si(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const Mi=Si("DXT1"),zi=Si("DXT3"),Fi=Si("DXT5"),Ai=16;function Ti(e,t){return t=Math.floor(t/Ai)*Ai,Math.min(Math.round(e/Ai)*Ai,t)}function Di(e,t){return t=Math.floor(t/Ai)*Ai,Math.min(Math.ceil(e/Ai)*Ai,t)}function Ii(e,t){const[r,i]=Oi(e,t);return e.width===r&&e.height===i?e:Ei(e,r,i)}function Oi({width:e,height:t},{maxPreferredTexturePixels:r,maxTextureSize:i}){const s=Math.max(e,t),a=e*t;if(s<=i&&a<=r)return[e,t];const n=Math.min(Math.sqrt(r/a),i/s);return[Ti(Math.round(e*n),i),Ti(Math.round(t*n),i)]}function Ei(e,t,r){if(e instanceof ImageData)return Ei(function(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const r=t.getContext("2d");if(null==r)throw new X("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return r.putImageData(e,0,0),t}(e),t,r);const i=document.createElement("canvas");return i.width=t,i.height=r,i.getContext("2d").drawImage(e,0,0,i.width,i.height),i}class ki{constructor(e,t){this._data=e,this.id=o(),this.events=new Te,this._parameters={...Li,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(e){e instanceof HTMLVideoElement?(this.update=t=>this._update(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e)}_startPreloadVideoElement(e){if(!(Be(e.src)||"auto"===e.preload&&e.crossOrigin)&&(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src,e.paused&&e.autoplay)){const t=[];Ve(e,e=>t.push(e)).then(()=>{e.play()}).finally(()=>t.forEach(e=>e.remove()))}}_startPreloadImageElement(e){Le(e.src)||Be(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const t=new q;return t.wrapMode=this._parameters.wrap??10497,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?9987:9729,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return null!=this._glTexture}get usedMemory(){return this._glTexture?.usedMemory||function(e,t){if(null==e)return 0;if(n(e)||a(e))return"image/ktx2"===t.encoding?function(e,t){if(null==vi)return e.byteLength;const r=new vi.KTX2File(new Uint8Array(e)),i=wi(r)?bi(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),t):0;return r.close(),r.delete(),i}(e,!!t.mipmap):"image/x.basis"===t.encoding?function(e,t){if(null==vi)return e.byteLength;const r=new vi.BasisFile(new Uint8Array(e)),i=yi(r)?bi(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),t):0;return r.close(),r.delete(),i}(e,!!t.mipmap):e.byteLength;const{width:r,height:i}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?Bi(e):t;return(t.mipmap?4/3:1)*r*i*(t.components||4)||0}(this._data,this._parameters)}load(e){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const t=this._data;return null==t?(this._glTexture=new R(e,this._createDescriptor(e),null),this._glTexture):(this._emptyTexture=e.emptyTexture,this._parameters.reloadable||(this._data=void 0),"string"==typeof t?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):a(t)&&"image/vnd-ms.dds"===this._parameters.encoding?this._loadFromDDSData(e,t):n(t)&&"image/vnd-ms.dds"===this._parameters.encoding?this._loadFromDDSData(e,new Uint8Array(t)):(n(t)||a(t))&&"image/ktx2"===this._parameters.encoding?this._loadFromKTX2(e,t):(n(t)||a(t))&&"image/x.basis"===this._parameters.encoding?this._loadFromBasis(e,t):a(t)?this._loadFromPixelData(e,t):n(t)?this._loadFromPixelData(e,new Uint8Array(t)):null)}_update(e,t){return null==this._glTexture||e.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=function(e,t,r){const i=function(e,t){const r=new Int32Array(e.buffer,e.byteOffset,31);if(542327876!==r[0])return Pi().error("Invalid magic number in DDS header"),null;if(!(4&r[20]))return Pi().error("Unsupported format, must contain a FourCC code"),null;const i=r[21];let s,a;switch(i){case Mi:s=8,a=Ne.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case zi:s=16,a=Ne.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Fi:s=16,a=Ne.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return Pi().error("Unsupported FourCC code:",(n=i,String.fromCharCode(255&n,n>>8&255,n>>16&255,n>>24&255))),null}var n;let o=1,l=r[4],c=r[3];(3&l||3&c)&&(Pi().warn("Rounding up compressed texture size to nearest multiple of 4."),l=l+3&-4,c=c+3&-4);const u=l,h=c;131072&r[2]&&!1!==t&&(o=Math.max(1,r[7]));let d,f,m=e.byteOffset+r[1]+4;const p=[];for(let t=0;t<o;++t)f=(l+3>>2)*(c+3>>2)*s,d=new Uint8Array(e.buffer,m,f),p.push(d),m+=f,l=Math.max(1,l>>1),c=Math.max(1,c>>1);return{textureData:{type:"compressed",levels:p},internalFormat:a,width:u,height:h}}(r,t.hasMipmap??!1);if(null==i)throw new Error("DDS texture data is null");const{textureData:s,internalFormat:a,width:n,height:o}=i;return t.samplingMode=s.levels.length>1?9987:9729,t.hasMipmap=s.levels.length>1,t.internalFormat=a,t.width=n,t.height=o,new R(e,t,s)}(e,this._createDescriptor(e),t),this._emptyTexture=null,this._glTexture}_loadFromKTX2(e,t){return this._loadAsync(()=>async function(e,t,r){null==vi&&(vi=await xi());const i=new vi.KTX2File(new Uint8Array(r));if(!wi(i))return null;i.startTranscoding();const s=Ci(e,t,i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),(e,t)=>i.getImageTranscodedSizeInBytes(e,0,0,t),(e,t,r)=>i.transcodeImage(r,e,0,0,t,0,-1,-1));return i.close(),i.delete(),s}(e,this._createDescriptor(e),t).then(e=>(this._glTexture=e,e)))}_loadFromBasis(e,t){return this._loadAsync(()=>async function(e,t,r){null==vi&&(vi=await xi());const i=new vi.BasisFile(new Uint8Array(r));if(!yi(i))return null;i.startTranscoding();const s=Ci(e,t,i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),(e,t)=>i.getImageTranscodedSizeInBytes(0,e,t),(e,t,r)=>i.transcodeImage(r,0,e,t,0,0));return i.close(),i.delete(),s}(e,this._createDescriptor(e),t).then(e=>(this._glTexture=e,e)))}_loadFromPixelData(e,t){P(this._parameters.width>0&&this._parameters.height>0);const r=this._createDescriptor(e);return r.pixelFormat=1===this._parameters.components?6409:3===this._parameters.components?6407:6408,6407!==r.pixelFormat&&6408!==r.pixelFormat||(r.compress=this._parameters.compressionOptions),r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new R(e,r,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync(async r=>{const i=await Ue(t,{signal:r});return Oe(r),this._loadFromImage(e,i)})}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync(async r=>{const i=await je(t,t.src,!1,r);return Oe(r),this._loadFromImage(e,i)})}_loadFromVideoElement(e,t){return t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync(r=>new Promise((i,s)=>{const a=()=>{t.removeEventListener("loadeddata",n),t.removeEventListener("error",o),Ie(l)},n=()=>{t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(a(),i(this._loadFromImage(e,t)))},o=e=>{a(),s(e||new X("texture:load-error","Failed to load video"))};t.addEventListener("loadeddata",n),t.addEventListener("error",o);const l=Ee(r,()=>o(ke()))}))}_loadFromImage(e,t){let r=t;r instanceof HTMLVideoElement||(r=Ii(r,e.parameters));const i=Bi(r);this._parameters.width=i.width,this._parameters.height=i.height;const s=this._createDescriptor(e);return s.pixelFormat=3===this._parameters.components?6407:6408,s.width=i.width,s.height=i.height,s.compress=this._parameters.compressionOptions,this._glTexture=new R(e,s,r),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(e){const t=new AbortController;this._loadingController=t;const r=e(t.signal);this._loadingPromise=r;const i=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null),this._emptyTexture=null};return r.then(i,i),r}unload(){if(this._glTexture=De(this._glTexture),this._emptyTexture=null,null!=this._loadingController){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}}function Bi(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}const Li={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};function Vi(e){const t=.3183098861837907;e.constants.add("PI","float",3.141592653589793),e.constants.add("LIGHT_NORMALIZATION","float",t),e.constants.add("INV_PI","float",t),e.constants.add("HALF_PI","float",1.570796326794897),e.constants.add("TWO_PI","float",6.28318530717958)}class Ui extends me{constructor(e,t,r){super(e,"vec2",0,(i,s)=>i.setUniform2fv(e,t(s),r))}}function ji(e){e.uniforms.add(new Ui("zProjectionMap",e=>function(e){const t=e.projectionMatrix;return We(Hi,t[14],t[10])}(e.camera))),e.code.add(xe`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),e.code.add(xe`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),e.code.add(xe`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)}const Hi=Ke();class Ni extends me{constructor(e,t){super(e,"sampler2D",0,(r,i)=>r.bindTexture(e,t(i)))}}function Ri(e,{occlusionPass:t,terrainDepthTest:r,cullAboveTerrain:i}){const{vertex:s,fragment:a,varyings:n}=e;if(!r)return s.code.add("void forwardViewPosDepth(vec3 pos) {}"),void a.code.add(`${t?"bool":"void"} discardByTerrainDepth() { ${be(t,"return false;")}}`);n.add("viewPosDepth","float",{invariant:!0}),s.code.add("void forwardViewPosDepth(vec3 pos) {\n    viewPosDepth = pos.z;\n  }"),a.include(ji),a.uniforms.add(new Ni("terrainDepthTexture",e=>e.terrainDepth?.attachment)).code.add(xe`
    ${t?"bool":"void"} discardByTerrainDepth() {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${t?"return viewPosDepth < linearDepth && depth < 1.0;":`if(viewPosDepth ${i?">":"<="} linearDepth) discard;`}
    }`)}function $i(e){e.code.add(xe`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}class qi extends me{constructor(e,t,r){super(e,"vec4",0,(i,s)=>i.setUniform4fv(e,t(s),r))}}function Gi(e){const{fragment:t}=e;t.code.add(xe`uint readChannelBits(uint channel, int highlightLevel) {
int llc = (highlightLevel & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(uvec2 texel, int highlightLevel) {
int lic = (highlightLevel >> 2) & 1;
return texel[lic];
}
uint readLevelBits(uvec2 texel, int highlightLevel) {
return readChannelBits(readChannel(texel, highlightLevel), highlightLevel);
}`)}class Xi extends me{constructor(e,t){super(e,"ivec2",0,(r,i)=>r.setUniform2iv(e,t(i)))}}class Wi extends me{constructor(e,t){super(e,"int",0,(r,i)=>r.setUniform1i(e,t(i)))}}class Ki extends me{constructor(e,t){super(e,"usampler2D",0,(r,i)=>r.bindTexture(e,t(i)))}}function Yi(e,t){const{fragment:r}=e,{output:i,draped:s,hasHighlightMixTexture:a}=t;8===i?(r.uniforms.add(new Wi("highlightLevel",e=>e.highlightLevel??0),new Xi("highlightMixOrigin",e=>e.highlightMixOrigin)),e.outputs.add("fragHighlight","uvec2",0),e.include(Gi),a?r.uniforms.add(new Ki("highlightMixTexture",e=>e.highlightMixTexture)).code.add(xe`uvec2 getAccumulatedHighlight() {
return texelFetch(highlightMixTexture, ivec2(gl_FragCoord.xy) - highlightMixOrigin, 0).rg;
}
void outputHighlight(bool occluded) {
if (highlightLevel == 0) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
} else {
int ll = (highlightLevel & 3) << 1;
int li = (highlightLevel >> 2) & 3;
uint bits;
if (occluded) {
bits = 3u << ll;
} else {
bits = 1u << ll;
}
uvec2 combinedHighlight = getAccumulatedHighlight();
combinedHighlight[li] |= bits;
fragHighlight = combinedHighlight;
}
}`):r.code.add(xe`void outputHighlight(bool occluded) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
}`),s?r.code.add(xe`bool isHighlightOccluded() {
return false;
}`):r.uniforms.add(new Ni("depthTexture",e=>e.mainDepth)).code.add(xe`bool isHighlightOccluded() {
float sceneDepth = texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x;
return gl_FragCoord.z > sceneDepth + 5e-7;
}`),r.code.add(xe`void calculateOcclusionAndOutputHighlight() {
outputHighlight(isHighlightOccluded());
}`)):r.code.add(xe`void calculateOcclusionAndOutputHighlight() {}`)}function Zi(e,t){e.include(Yi,t),e.include(pe,t),e.fragment.include($i);const{output:r,oitPass:i,discardInvisibleFragments:s,snowCover:a}=t,n=9===r,o=ve(r),l=ge(r)&&1===i,c=ge(r)&&1!==i;let u=0;(c||o||l)&&e.outputs.add("fragColor","vec4",u++),o&&e.outputs.add("fragEmission","vec4",u++),l&&e.outputs.add("fragAlpha","float",u++),e.fragment.code.add(xe`
    void outputColorHighlightOID(vec4 finalColor, const in vec3 vWorldPosition, vec3 emissiveSymbolColor ${be(a,", float snow")}) {
      ${be(n,"finalColor.a = 1.0;")}

      ${be(s,`if (finalColor.a < ${xe.float(Ye)}) { discard; }`)}

      finalColor = applySlice(finalColor, vWorldPosition);
      ${be(l,xe`fragColor = premultiplyAlpha(finalColor);
             fragAlpha = finalColor.a;`)}
      ${be(c,"fragColor = finalColor;")}
      ${be(o,`fragEmission = ${be(a,"mix(finalColor.a * getEmissions(emissiveSymbolColor), vec4(0.0), snow);","finalColor.a * getEmissions(emissiveSymbolColor);")}`)}
      calculateOcclusionAndOutputHighlight();
      ${be(n,"outputObjectAndLayerIdColor();")}
    }
  `)}class Ji{constructor(e,t){this._module=e,this._load=t}get(){return this._module}async reload(){return this._module=await this._load(),this._module}}class Qi{constructor(e,t,r){this._context=e,this.locations=r,this._textures=new Map,this.source=N()?t:null,t.attributeNames.forEach(e=>{r.has(e)||console.error(`Missing VertexAttributeLocation for ${e} used in shader`)}),this._glProgram=e.programCache.acquire(t.generate("vertex",!0),t.generate("fragment",!0),r),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bind=t.generateBind(this),this.bindPass=t.generateBindPass(this),this.bindDraw=t.generateBindDraw(this)}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,t){this._glProgram.setUniform1i(e,t?1:0)}setUniform1i(e,t){this._glProgram.setUniform1i(e,t)}setUniform1f(e,t,r){this._glProgram.setUniform1f(e,t,r)}setUniform2fv(e,t,r){this._glProgram.setUniform2fv(e,t,r)}setUniform3fv(e,t,r){this._glProgram.setUniform3fv(e,t,r)}setUniform4fv(e,t,r){this._glProgram.setUniform4fv(e,t,r)}setUniformMatrix3fv(e,t,r){this._glProgram.setUniformMatrix3fv(e,t,!1,r)}setUniformMatrix4fv(e,t,r){this._glProgram.setUniformMatrix4fv(e,t,!1,r)}setUniform1fv(e,t,r){this._glProgram.setUniform1fv(e,t,r)}setUniform1iv(e,t){this._glProgram.setUniform1iv(e,t)}setUniform2iv(e,t){this._glProgram.setUniform2iv(e,t)}setUniform3iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform4iv(e,t){this._glProgram.setUniform4iv(e,t)}assertCompatibleVertexAttributeLocations(e,t){let r=e.locations;if(t){const e=new Map(r);t.forEach((t,i)=>e.set(i,r.size+t)),r=e}r.size!==this.locations.size&&console.error(`VertexAttributeLocations are incompatible: ${r}, ${this.locations}`),this.locations.forEach((e,t)=>{r.get(t)!==e&&console.error(`VertexAttributeLocations are incompatible: Program has ${t} at position ${e}, VAO has it at position ${r.get(t)}.`)})}stop(){this._textures.clear()}bindTexture(e,t){t?.glName||(N()&&console.error(`Texture sampler ${e} has no given Texture in ${(new Error).stack} `),t=this._context.emptyTexture);const r=this._ensureTextureUnit(e,t);this._context.useProgram(this),this.setUniform1i(e,r.unit),this._context.bindTexture(t,r.unit)}_ensureTextureUnit(e,t){let r=this._textures.get(e);return null==r?(r={texture:t,unit:this._textures.size},this._textures.set(e,r)):r.texture=t,r}}class es{constructor(e,t,r,i){this.primitiveType=Re.TRIANGLES,this.key=t.key,this._program=new Qi(e.rctx,r.get().build(t),i),this._pipeline=this.initializePipeline(t),this.reload=async s=>{s&&await r.reload(),this.key.equals(t.key)||Xe.getLogger("esri.views.3d.webgl.ShaderTechnique").warn("Configuration was changed after construction, cannot reload shader.",r),De(this._program),this._program=new Qi(e.rctx,r.get().build(t),i),this._pipeline=this.initializePipeline(t)}}destroy(){this._program=De(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,t){return this._pipeline}initializePipeline(e){return Ze({blending:Qe,colorWrite:Je})}}function ts(e,t){return _e(e)?{buffers:[0]}:t??null}const rs=tt(1,0,1,771);function is(e){return 2===e?null:rs}function ss(e){switch(e){case 0:return rt;case 1:return rs;case 2:case 3:return null}}function as(e){if(e.draped)return null;switch(e.oitPass){case 0:case 2:return e.writeDepth?et:null;case 1:case 3:return null}}const ns=5e5,os={factor:-1,units:-2};function ls({oitPass:e,enableOffset:t}){return t&&1===e?os:null}function cs(e,t=513){return 0===e||2===e?t:515}function us(e,t){const r=ve(t);return 1===e?r?{buffers:[$e,qe,Ge]}:{buffers:[$e,qe]}:r?{buffers:[$e,qe]}:null}const hs={func:513},ds={func:519},fs={mask:255},ms={mask:0},ps=e=>({function:{func:517,ref:e,mask:e},operation:{fail:7680,zFail:7680,zPass:7680}}),gs=e=>({function:{func:519,ref:e,mask:e},operation:{fail:7680,zFail:7680,zPass:7681}}),vs={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:0}},_s={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7681}},xs={function:{func:514,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}},bs={function:{func:517,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}};class ys extends me{constructor(e,t,r){super(e,"mat4",1,(i,s,a)=>i.setUniformMatrix4fv(e,t(s,a),r))}}export{Ft as $,it as A,Ui as B,$i as C,Dt as D,li as E,qi as F,Pt as G,Yi as H,bs as I,ds as J,xs as K,ms as L,Xt as M,st as N,ot as O,hs as P,Ar as Q,Ji as R,Br as S,ki as T,is as U,ai as V,Wt as W,yr as X,Or as Y,wr as Z,ji as _,hi as a,Gt as a0,Lr as a1,kt as a2,Lt as a3,mr as a4,$t as a5,Mr as a6,zr as a7,Fr as a8,Pr as a9,Jr as aA,Qr as aB,ut as aC,ht as aD,Wi as aE,ei as aF,lr as aG,cr as aH,ar as aI,fr as aJ,gt as aK,br as aL,ri as aM,It as aN,Ot as aO,Oi as aP,ps as aQ,kr as aR,gs as aS,Sr as aa,Dr as ab,Bt as ac,ci as ad,at as ae,os as af,Ir as ag,si as ah,ys as ai,Tt as aj,ni as ak,qt as al,Di as am,Er as an,xi as ao,mt as ap,ct as aq,lt as ar,ii as as,Vi as at,Ti as au,vt as av,_t as aw,pr as ax,Gi as ay,Zr as az,ui as b,oi as c,mi as d,pi as e,pt as f,Ni as g,Yr as h,ti as i,Mt as j,es as k,ls as l,vs as m,ft as n,Zi as o,fs as p,ts as q,as as r,_s as s,Ri as t,cs as u,ss as v,us as w,At as x,ns as y,xr as z};
