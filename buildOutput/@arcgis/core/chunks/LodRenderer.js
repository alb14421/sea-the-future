/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{i as t}from"../core/lang.js";import s from"../core/Error.js";import{s as n,g as r}from"./MapUtils.js";import{d as a}from"./maybe.js";import{isAborted as i,throwIfAborted as o}from"../core/promiseUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{c as h}from"./mat4f64.js";import{t as d,h as u,d as m}from"./vec3.js";import{c as p}from"./vec3f64.js";import{c as g,b as f}from"./vec4f64.js";import{d as _}from"./debugFlags2.js";import{g as y}from"./InterleavedLayout.js";import b from"../views/3d/webgl/RenderCamera.js";import{A as v}from"./RenderGeometry.js";import{D as I}from"../views/3d/webgl.js";import{D as S}from"./BufferView.js";import{I as D,g as C,R,b as x}from"./DefaultMaterial.js";import{w as E,b as w,g as j}from"./sphere.js";import{m as L}from"./mathUtils2.js";import{O as M}from"./Octree.js";import{m as T,e as A,j as O,y as B}from"./aaBoundingBox.js";import{G as U}from"./NormalUtils.glsl.js";import{V}from"./VertexArrayObject2.js";import{V as P}from"./VertexBuffer.js";import{a0 as q}from"./Matrix4PassUniform.js";import{e as F}from"./RibbonLineMaterial.js";import{d as H}from"./HighlightDefaults.js";import{T as z,n as N}from"./Scheduler.js";import{b as G}from"./Texture.js";import{b as W}from"./VertexAttributeLocations.js";class k extends M{constructor(e,t){super(e=>E(this._instanceData.view.boundingSphere.getVec(e,this._tmpSphere)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=w(),this._tmpMat4=h()}addInstance(e){const t=this._instanceData.view.boundingSphere,s=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);d(j(this._tmpSphere),this._boundingSphere.center,s),this._tmpSphere[3]=this._boundingSphere.radius*L(s),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class Y{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,s){const n=s.computeScreenPixelSizeAt(e),r=this._worldSpaceRadius*t/n;let a=0;for(let e=1;e<this._minScreenSpaceRadii.length;++e)r>=this._minScreenSpaceRadii[e]&&(a=e);return a}}class Z{constructor(e,t){this.geometry=t;const s=e.renderContext.rctx,n=t.renderGeometry,{material:r,layout:a,buffer:i}=n;this._materials=e.materials,r.setParameters({instancedDoublePrecision:!0}),this.glMaterials=new U(r,this._materials),this.vbo=new P(s,y(a),i),this.vao=new V(s,this.vbo)}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get material(){return this.geometry.renderGeometry.material}get layout(){return this.geometry.renderGeometry.layout}get boundingInfo(){return this.geometry.boundingInfo}get numTriangles(){return this.numVertices/3}get numVertices(){return this.geometry.renderGeometry.numVertices}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,t,s,n,r,a,i,o){return this.geometry.intersect(e,t,s,n,r,a,i,o)}}class ${static async create(e,s,n){const r=await Promise.allSettled(s.components.map(t=>e.controller.schedule(()=>new Z(e,t.geometry),n))),a=r.map(e=>"fulfilled"===e.status?e.value:null).filter(t);if(i(n)||a.length!==r.length){a.forEach(e=>e.destroy()),o(n);for(const e of r)if("rejected"===e.status)throw e.reason}return new $(s.minScreenSpaceRadius,a)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,t,s,n,r,a,i){this.components.forEach(o=>o.intersect(e,t,s,n,r,a,this.boundingSphere,i))}get boundingBox(){if(null==this._boundingBox){const e=T();this.components.forEach(t=>{null!=t.boundingInfo&&(A(e,t.boundingInfo.bbMin),A(e,t.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const e=this.boundingBox,t=p();O(e,t),this._boundingSphere={center:t,radius:.5*B(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,t)=>e+t.numTriangles,0)}}let J=class extends v{constructor(e,t){super(e),this.type=6,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new b,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,e=>this._produces(e)],[4,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new D({shaderTransformation:e.shaderTransformation},e.symbol.materialParameters),this.addHandles(t.registerTask(z.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=C(this.symbol.materialParameters),this._glInstanceBufferLayout=y(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on("instance-visibility-changed",({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDatas)t[0]!==H&&e.push(t[1]);return e}hasHighlight(e){return this._highlightRenderInstanceDatas.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some(e=>e.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((e,t)=>t.reduce((e,t)=>e+t.usedMemory,e),this._levels.reduce((e,t)=>e+t.components.reduce((e,t)=>e+t.usedMemory,0),0))}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach((e,s)=>{const n=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,r=e.triangleCount;t.push({renderedInstances:n,renderedTriangles:n*r,trianglesPerInstance:r})}),{totalInstances:e,renderedInstances:t.reduce((e,t)=>e+t.renderedInstances,0),renderedTriangles:t.reduce((e,t)=>e+t.renderedTriangles,0),levels:t}}_createRenderInstanceDataArray(){const{rctx:e}=this._context.renderContext;return this.symbol.levels.map(t=>new R(e,this._instanceBufferLayout))}async initializeRenderContext(e,s){this._context=e,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();const n=await Promise.allSettled(this.symbol.levels.map(t=>$.create(e,t,s))),r=n.map(e=>"fulfilled"===e.status?e.value:null).filter(t);if(i(s)||r.length!==n.length){r.forEach(e=>e.destroy()),o(s);for(const e of n)if("rejected"===e.status)throw e.reason}this._levels=r,this._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,s=e.levels.map(e=>e.minScreenSpaceRadius);return new Y(t,s)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceDatas.forEach(e=>e.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(e=>e.components.some(e=>{const t=e.material.produces.get(4);return t?.(0)}))}hasHighlights(){return n(this._highlightRenderInstanceDatas,e=>e.some(e=>e.size>0))}_produces(e){return(8!==e||this.hasHighlights())&&(5!==e||this.hasHighlight(H))}prepareRender(e){if(!_.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(N),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e);if(!t)return null;const s=new Array,n=this.levels;return t.forEach(t=>n.forEach(({components:n},r)=>n.forEach(n=>s.push(this._beginComponent(e,t[r],n))))),s}render(e,t){const s=this._getInstanceDatas(e);if(!s||null==t)return;let n=0;const r=this.levels;s.forEach(s=>r.forEach(({components:r},a)=>r.forEach(r=>this._renderComponent(e,t[n++],s[a],r,a)))),e.rctx.unbindBuffer(34962),e.rctx.bindVAO(null)}_getInstanceDatas(e){const{output:t,bind:s}=e,n=8===t,r=5===t,a=6!==t;if(!n&&!r)return a?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDatas:i}=this;if(a){if(n){const e=s.highlight?.name;if(!e)return null;const t=i.get(e);return t?[t]:null}const e=i.get(H);return r?e?[e]:null:Array.from(i.values())}return null}intersect(e,t,s,n){if(!this.baseMaterial.visible||null==this._octree)return;const r=p();u(r,n,s);const a=r=>{this._instanceData.getCombinedModelTransform(r,ee),e.transform.set(ee),d(te,s,e.transform.inverse),d(se,n,e.transform.inverse);const a=this._instanceData.getState(r),i=this._instanceData.getLodLevel(r),o=this._levels.length;S(!!(18&a),"invalid instance state"),S(i>=0&&i<o,"invaid lod level"),this._levels[i].intersect(e,t,te,se,r,this.metadata,o)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(s,r,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){const e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new k(e,this.baseBoundingSphere);for(let s=0;s<e.capacity;++s)18&t.get(s)&&this._octreeCached.addInstance(s)}return this._octreeCached}_invalidateOctree(){this._octreeCached=a(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return new I;const t=e.viewForward,s=this._octree.findClosest(t,1,e.frustum),n=this._octree.findClosest(t,-1,e.frustum);if(null==s||null==n)return new I;const r=e.eye,a=this._instanceData.view;a.boundingSphere.getVec(s,X),u(X,X,r);const i=m(X,t)-X[3];a.boundingSphere.getVec(n,X),u(X,X,r);const o=m(X,t)+X[3];return new I(i,o)}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:n,_levelSelector:a}=this;this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.beginUpdate()));const i=this._instanceData,o=i.view;let l=i.size;const c=i.capacity;let h=this._instanceIndex;const d=Math.ceil(c/500),{_highlightRenderInstanceDatas:u}=this;for(let m=0;m<l&&!e.done;++m){h===this._cycleStartIndex&&this._startUpdateCycle();const m=o.state.get(h);let p=0;if(!(1&m)){h=h+1===c?0:h+1,l++;continue}const g=o.lodLevel.get(h);if(2&m&&this._defaultRenderInstanceData[g].freeTail(),16&m){const e=i.geHighlightOptionsPrev(h);if(e){const t=u.get(e);if(!t)throw new s("internal:lod-renderer","Internal error in lodRenderer");t[g].freeTail(),t.every(e=>e.isEmpty)&&(t.forEach(e=>e.destroy()),u.delete(e))}}if(32&m)i.freeInstance(h);else if(4&m){let e=0;if(t&&(o.modelOrigin.getVec(h,Q),e=a.selectLevel(Q,i.getCombinedMedianScaleFactor(h),n)),p=-83&m,e>=0)if(8&m){const t=i.getHighlightName(h);if(t){const n=()=>{const e=this._createRenderInstanceDataArray();return e.forEach(e=>e.beginUpdate()),e},a=r(u,t,n);if(e>=a.length)throw new s("internal:lod-renderer",`LodRenderer internal error - missing lodLevel ${e}`);K(a[e],o,h)}p|=16}else K(this._defaultRenderInstanceData[e],o,h),p|=2;o.state.set(h,p),o.lodLevel.set(h,e)}else p=-83&m,o.state.set(h,p);if(null!=this._octreeCached){const e=!!(18&m),t=!!(18&p);!e&&t?this._octreeCached.addInstance(h):e&&!t?this._octreeCached.removeInstance(h):e&&t&&64&m&&(this._octreeCached.removeInstance(h),this._octreeCached.addInstance(h))}h=h+1===c?0:h+1,h%d===0&&e.madeProgress()}this._instanceIndex=h,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.endUpdate())),this._context.requestRender()}_beginComponent(e,t,s){if(0===t.size)return null;const n=s.glMaterials.load(e.rctx,e.bind.slot,e.output);return n?.beginSlot(e.bind)}_renderComponent(e,t,s,n,r){if(!t)return;const{bind:a,rctx:i}=e;i.runAppleAmdDriverHelper();const o=i.bindTechnique(t,a,n.material.parameters,re),l=this._glInstanceBufferLayout;o.assertCompatibleVertexAttributeLocations(n.vao,W(l)),i.bindVAO(n.vao),_.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.output&&(o.setUniform4fv("externalColor",ne[Math.min(r,ne.length-1)]),o.setUniform1i("symbolColorMixMode",q.replace));const c=s.capacity,h=s.headIndex,d=s.tailIndex,u=s.firstIndex,m=(e,r)=>{G(i,o.locations,s.buffer,e),i.drawArraysInstanced(t.primitiveType,0,n.numVertices,r-e)};n.material.transparent&&null!=u?h>d?(S(u>=d&&u<=h,"invalid firstIndex"),m(u,h),m(d,u)):h<d&&(u<=h?(S(u>=0&&u<=h,"invalid firstIndex"),m(u,h),m(d,c),m(0,u)):(S(u>=d&&u<=c,"invalid firstIndex"),m(u,c),m(0,h),m(d,u))):h>d?m(d,h):h<d&&(m(0,h),m(d,c))}};function K(e,t,s){const n=e.allocateHead();var r,a,i,o;r=t,a=s,i=e.view,o=n,F(r.modelOrigin,a,i.modelOriginHi,i.modelOriginLo,o),i.model.copyFrom(o,r.model,a),i.modelNormal.copyFrom(o,r.modelNormal,a),r.color&&i.color&&i.color.copyFrom(o,r.color,a),r.olidColor&&i.olidColor&&i.olidColor.copyFrom(o,r.olidColor,a),r.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(o,r.featureAttribute,a)}e([l({constructOnly:!0})],J.prototype,"symbol",void 0),e([l({constructOnly:!0})],J.prototype,"metadata",void 0),e([l({constructOnly:!0})],J.prototype,"shaderTransformation",void 0),e([l()],J.prototype,"_instanceData",void 0),e([l()],J.prototype,"_cycleStartIndex",void 0),e([l({readOnly:!0})],J.prototype,"_enableLevelSelection",null),e([l()],J.prototype,"_updateCyclesWithStaticCamera",void 0),e([l({readOnly:!0})],J.prototype,"readyToRun",null),J=e([c("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],J);const Q=p(),X=g(),ee=h(),te=p(),se=p(),ne=[f(1,0,1,1),f(0,0,1,1),f(0,1,0,1),f(1,1,0,1),f(1,0,0,1)],re=new x;export{J as L};
