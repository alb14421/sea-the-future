/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{f as e}from"./requestPresets.js";import{f as t}from"./associatedFeatureServiceUtils.js";import{g as a}from"./fetchService.js";import{q as r}from"./layerUtils.js";class s{constructor(){this._serviceMetadatas=new Map,this._itemDatas=new Map}async fetchServiceMetadata(t,a){const r=this._serviceMetadatas.get(t);if(r)return r;const s=await e(t,a);return this._serviceMetadatas.set(t,s),s}async fetchItemData(e){const{id:t}=e;if(!t)return null;const{_itemDatas:a}=this;if(a.has(t))return a.get(t);const r=await e.fetchData();return a.set(t,r),r}async fetchCustomParameters(e,t){const a=await this.fetchItemData(e);return a&&"object"==typeof a&&(t?t(a):a.customParameters)||null}}function n(e){const t={id:e.id,name:e.name},r=a(e.type);return"FeatureLayer"!==r&&(t.layerType=r),t}async function l(e,t,a){let s;if(null==e?.layers||null==e?.tables){const l=await a.fetchServiceMetadata(t,{customParameters:c(e)?.customParameters});s=r(),(e=e||{}).layers=e.layers||l?.layers?.map(n),e.tables=e.tables||l?.tables?.map(n)}return{data:e,preferredHost:s}}function c(e){if(!e)return null;const{layers:t,tables:a}=e;return t?.length?t[0]:a?.length?a[0]:null}function u(e,t){return null==t?null:[...e.layers||[],...e.tables||[]].find(e=>e.id===t)}function i(e,t){return[...e.layers||[],...e.tables||[]].filter(({layerType:e})=>e?t.includes(e):t.includes("ArcGISFeatureLayer"))}function o(e){return(e?.layers?.length??0)+(e?.tables?.length??0)}function y(e){switch(e){case"catalog":return["CatalogLayer"];case"feature":return["ArcGISFeatureLayer"];case"oriented-imagery":return["OrientedImageryLayer"];case"subtype-group":return["SubtypeGroupLayer","SubtypeGroupTable"]}return null}function f(e){switch(e){case"CatalogLayer":return"CatalogLayer";case"OrientedImageryLayer":return"OrientedImageryLayer";case"SubtypeGroupLayer":case"SubtypeGroupTable":return"SubtypeGroupLayer"}return"FeatureLayer"}async function m(e,a,r){if(!e?.url)return a??{};if(a??={},!a.layers){const t=await r.fetchServiceMetadata(e.url);a.layers=t.layers?.map(n)}const{serverUrl:s,portalItem:l}=await t(e.url,{sceneLayerItem:e,customParameters:c(a)?.customParameters}).catch(()=>({serverUrl:null,portalItem:null}));if(null==s)return a.tables=[],a;if(!a.tables&&l){const e=await l.fetchData().catch(()=>null);if(e?.tables)a.tables=e.tables.map(n);else{const t=await r.fetchServiceMetadata(s,{customParameters:c(e)?.customParameters}).catch(()=>null);a.tables=t?.tables?.map(n)}}if(a.tables)for(const e of a.tables)e.url=`${s}/${e.id}`;return a}export{s as L,o as a,u as b,m as c,i as d,n as e,c as g,y as i,f as l,l as p};
