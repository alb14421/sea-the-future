/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../Color.js";import{f as t}from"./asyncUtils.js";import"../core/lang.js";import{a as r}from"./screenUtils.js";import{O as o}from"./vec3f64.js";import{e as n}from"./jsonUtils2.js";import{getCIMSymbolColor as l}from"../symbols/support/cimSymbolUtils.js";import{g as i}from"./gfxUtils.js";import{S as s}from"./Symbol3DMaterial.js";import{i as a,d as u}from"./typeUtils2.js";function c(e){if(!e)return 0;if(a(e)){const t=function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.size}(e);return null!=t?t:0}return r(i(e)?.width)}function f(t){if(!t)return null;if(a(t))return function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.color}(t);const r=i(t)?.color;return r?new e(r):null}function m(e){if(null==e||!("symbolLayers"in e)||null==e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some(e=>"object"===e.type);case"line-3d":return e.symbolLayers.some(e=>"path"===e.type);case"polygon-3d":return e.symbolLayers.some(e=>"object"===e.type||"extrude"===e.type);default:return!1}}function y(e){return e.resource?.href??""}function p(t,r){if(!t)return null;let o=null;return a(t)?o=function(t){const r=t.symbolLayers;if(!r)return null;let o=null;return r.forEach(e=>{"object"===e.type&&e.resource?.href||(o="water"===e.type?e.color:e.material?e.material.color:null)}),o?new e(o):null}(t):u(t)&&(o="cim"===t.type?l(t):t.color?new e(t.color):null),o?d(o,r):null}function d(t,r){if(null==r||null==t)return t;const o=t.toRgba();return o[3]=o[3]*r,new e(o)}function h(t,r,o){t&&(r||null!=o)&&(r&&(r=new e(r)),a(t)?function(t,r,o){const n=t.symbolLayers;if(!n)return;const l=(t,n=!1)=>{let l=r??t??null;return null!=o?.override&&(!l&&n&&(l=new e([255,255,255])),l&&(l.a=o.override)),d(l,o?.add)};n.forEach(e=>{if("water"===e.type)return void(e.color=d(e.color,o?.add));const t=null!=e.material?e.material.color:null,r=l(t,"icon"===e.type&&null!=e.resource?.href);null==e.material?e.material=new s({color:r}):e.material.color=r,"outline"in e&&e.outline?.color&&null!=o?.add&&(e.outline.color=d(e.outline.color,o.add)),"marker"in e&&null!=e.marker&&(e.marker.color=l(e.marker.color))})}(t,r,o):u(t)&&function(e,t,r){t=t??e.color,null!=r?.override&&t&&(t.a=r.override),t&&(e.color=d(t,r?.add)),"outline"in e&&e.outline?.color&&(e.outline.color=d(e.outline.color,r?.add))}(t,r,o))}function b(e){for(const t of e)if("number"==typeof t)return t;return null}function w(e,t,r){for(let o=0;o<3;o++){const n=e[o];switch(n){case"symbol-value":{const e=r[o];return null!=e?e/t[o]:1}case"proportional":break;default:if(n&&t[o])return n/t[o]}}return null}function g(e,t,r,o){switch(e){case"proportional":return r*o;case"symbol-value":return null!=t?t:r;default:return e}}async function j(e,r){if(e&&r)return a(e)?async function(e,r){const n=e.symbolLayers;n&&await t(n,async e=>async function(e,t){switch(e.type){case"extrude":!function(e,t){const r=t[2];"number"==typeof r&&(e.size=r)}(e,t);break;case"icon":case"line":case"text":!function(e,t){const r=b(t);null!=r&&(e.size=r)}(e,t);break;case"path":!function(e,t){const r=w(t,o,[e.width,void 0,e.height]);null!=r&&(e.width=g(t[0],e.width,1,r),e.height=g(t[2],e.height,1,r))}(e,t);break;case"object":await async function(e,t){const{resourceSize:r,symbolSize:o}=await async function(e){const{computeObjectLayerResourceSize:t}=await import("./symbolLayerUtils.js"),r=await t(e,10),{width:o,height:n,depth:l}=e,i=[o,l,n];let s=1;for(let e=0;e<3;e++){const t=i[e];if(null!=t){s=t/r[e];break}}for(let e=0;e<3;e++)null==i[e]&&(i[e]=r[e]*s);return{resourceSize:r,symbolSize:i}}(e),n=w(t,r,o);null!=n&&(e.width=g(t[0],o[0],r[0],n),e.depth=g(t[1],o[1],r[1],n),e.height=g(t[2],o[2],r[2],n))}(e,t)}}(e,r))}(e,r):void(u(e)&&function(e,t){const r=b(t);if(null!=r)switch(e.type){case"simple-marker":e.size=r;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=r,e.height=r*t):(e.width=r*t,e.height=r);break}case"simple-line":e.width=r;break;case"text":e.font.size=r}}(e,r))}function k(e,t,r){if(e&&null!=t)if(a(e)){const o=e.symbolLayers;o&&o.forEach(e=>{if("object"===e.type)switch(r){case"tilt":e.tilt=(e.tilt??0)+t;break;case"roll":e.roll=(e.roll??0)+t;break;default:e.heading=(e.heading??0)+t}"icon"===e.type&&(e.angle+=t)})}else u(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle+=t))}function L(e){if(!e)return null;const t=e.effects.filter(e=>"bloom"!==e.type).map(e=>e.toJSON());return n(t)}function v(e){return null!=e&&"polygon-3d"===e.type&&e.symbolLayers.some(e=>"extrude"===e.type)}export{j as a,k as b,h as c,c as d,p as e,L as f,f as g,y as h,m as i,d as j,v as s};
