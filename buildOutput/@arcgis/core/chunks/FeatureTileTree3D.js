/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../core/Accessor.js";import s from"../core/Collection.js";import"../core/lang.js";import{L as r}from"./Logger.js";import{r as o}from"./maybe.js";import{P as i}from"./PooledArray.js";import{watch as n,syncAndInitial as p,sync as l}from"../core/reactiveUtils.js";import{s as a}from"./signal.js";import{property as m}from"../core/accessorSupport/decorators/property.js";import{subclass as u}from"../core/accessorSupport/decorators/subclass.js";import{s as c,c as d,l as h}from"./aaBoundingRect.js";import{F as j,g as f}from"./FeatureTileDescriptor.js";import{e as y,n as _,s as g,d as b,a as v,k as S,z as T,c as M,j as x,i as L,b as U}from"./vec3.js";import{c as C,f as R,g as E,Z as w}from"./vec3f64.js";import{d as I}from"./frustum.js";import{b as P}from"./ray.js";import{U as D}from"./unitUtils.js";import{g as F}from"./spatialReferenceEllipsoidUtils.js";import{g as O,c as B,p as G}from"./projectBuffer.js";import{d as k,o as A}from"./plane.js";import{F as q}from"../views/3d/webgl.js";import V from"../views/3d/webgl/RenderCamera.js";import{t as H}from"./TextureCompressionTracker.js";import{T as z,n as W}from"./Scheduler.js";import"../core/Handles.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"./Lifecycle.js";import"./metadata.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./tracking.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../core/promiseUtils.js";import"../core/Error.js";import"./object.js";import"../config.js";import"./string.js";import"./events.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"../core/Evented.js";import"./ensureType.js";import"./MapUtils.js";import"./Warning.js";import"./shared.js";import"./SimpleObservable.js";import"./jsonUtils.js";import"./mathUtils.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./common.js";import"./mat4.js";import"./vec4.js";import"./vec4f64.js";import"./vector.js";import"./mat3f64.js";import"./mat4f64.js";import"./quatf64.js";import"./vec2f64.js";import"./mat3.js";import"./geodesicConstants.js";import"./mathUtils2.js";import"../Camera.js";import"../CameraLayout.js";import"../core/Clonable.js";import"./Cyclical.js";import"./computeTranslationToOriginAndRotation.js";import"./projectPointToVector.js";import"./projectionUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./boundsUtils.js";import"../geometry/Polyline.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./projectVectorToVector.js";import"./dehydratedPoint.js";import"./Intersector2.js";import"./HUDIntersectorResult.js";import"./sphere.js";import"./orientedBoundingBox.js";import"./quat.js";import"./vec2.js";import"./lineSegment.js";import"./earthUtils.js";import"./screenUtils.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../Color.js";import"./colorUtils.js";import"./enumeration.js";import"./materialUtils.js";import"./opacityUtils.js";import"./ElevationContext.js";import"./dehydratedFeatureUtils.js";import"./ElevationProvider.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./hydratedFeatures.js";import"../Graphic.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./guards.js";import"./datetime.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./locale.js";import"./constants.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../geometry/support/jsonUtils.js";import"./typeUtils.js";import"./createFeatureId.js";import"./typeUtils2.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils3.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils4.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./DoubleArray.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"./lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./debugFlags2.js";import"./Indices.js";import"./Matrix4PassUniform.js";import"./BufferView.js";import"./triangle.js";import"./Texture.js";import"./enums.js";import"./boundedPlane.js";import"./Emissions.glsl.js";import"./glsl.js";import"./videoUtils.js";import"./requestImageUtils.js";import"./AlphaCutoff.js";import"./renderState.js";import"./graphicUtils.js";import"./vec3f32.js";import"./meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../geometry/support/MeshLocalVertexSpace.js";import"./symbolColorUtils.js";import"./RibbonLineMaterial.js";import"./Octree.js";import"./sdfPrimitives.js";import"./floatRGBA.js";import"./ShaderBuilder.js";import"./InterleavedLayout.js";import"./types.js";import"./VertexElementDescriptor.js";import"./VertexAttributeLocations.js";import"./vec2f32.js";import"./HUDVisibility.glsl.js";import"./BooleanBindUniform.js";import"./CameraSpace.glsl.js";import"./asyncUtils.js";import"./memoryEstimations.js";import"./projectBoundingRect.js";import"./dehydratedFeatures.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"./primitiveObjectSymbolUtils.js";import"./Intersector.js";import"./DefaultMaterial.js";import"./VertexColor.glsl.js";import"./VertexBuffer.js";import"./BufferObject.js";import"./SceneLighting.js";import"../views/3d/webgl/RenderNode.js";import"./Matrix4sPassUniform.js";import"./debugFlags.js";class N{constructor(t,e){this._renderCoordsHelper=t,this.opaqueGround=e,this._cache=new Map,this._cameraForward=C(),this._cameraEye=C(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=C(),this._frustumBoundingSphereRadius=0,this._frustum=new q(t),this._renderSR=t.spatialReference;const s=F(this._renderSR);this._renderSREllipsoidRadius=D(s).radius}setup(t){this._aboveGround=t.aboveGround,this._frustum.update(t),_(this._cameraForward,t.viewForward),y(this._cameraEye,t.eye),this._cameraFovY=t.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(t){if(this._cache.has(t.id))return this._cache.get(t.id);const e=this._isVisibleInFrustum(t);return this._cache.set(t.id,e),e}_isVisibleInFrustum(t){return 2===this._renderCoordsHelper.viewingMode?this._isTileVisibleInFrustumLocal(t):this._isTileVisibleInFrustumGlobal(t)}_updateFrustumBoundingSphere(){const t=this._frustum,e=t.origin,s=ct;_(s,t.direction);const r=t.points,o=dt;g(o,r[4],e);const i=.5*b(o,o)/b(s,o),n=this._frustumBoundingSphereCenter;v(n,e,s,i);const p=1+i;this._frustumBoundingSphereRadius=p}_isTileVisibleInFrustumLocal(t){const e=t.spatialReference,s=t.extent,r=this._renderSR;if(!s)return!0;if(rt[0]=s[0],rt[1]=s[1],rt[2]=0,rt[3]=s[2],rt[4]=s[3],rt[5]=0,!G(rt,e,0,rt,r,0))return!1;S(ot[0],rt[0],rt[1],0),S(ot[1],rt[3],rt[1],0),S(ot[2],rt[3],rt[4],0),S(ot[3],rt[0],rt[4],0),S(it,.5*(rt[0]+rt[3]),.5*(rt[1]+rt[4]),.5*(rt[2]+rt[5]));const o=Ht,i=.5*T(ot[0],ot[2]),n=this._frustum,p=this._frustumBoundingSphereRadius,l=this._frustumBoundingSphereCenter,a=jt;g(a,l,it);const m=b(o,a),u=ht;if(v(u,it,o,m),T(u,l)>i+p)return!1;const c=this._cameraForward,d=b(c,Ht),h=this._cameraFovY,j=this._cameraEye;if(Math.abs(d)<Math.abs(Math.cos(.5*h))){let t=!0;const e=S(zt,c[0],c[1],0),s=b(j,e);for(let r=0;r<4;++r){const o=ot[r];if(b(o,e)-s>0){t=!1;break}}if(t)return!1}{const t=ot[0],e=ot[2];if(t[0]<=j[0]&&j[0]<=e[0]&&t[1]<=j[1]&&j[1]<=e[1])return!0}const f=st,y=this.opaqueGround&&this._aboveGround,_=this.opaqueGround&&!this._aboveGround,M=Math.min(_?kt:1/0,m+p),x=Math.max(y?-kt:-1/0,m-p);for(let t=0;t<4;++t)v(f[t],ot[t],o,M),v(f[t+4],ot[t],o,x);if(K(n.planes,f,8))return!1;if($(n.planes,f,8))return!0;for(let t=0;t<4;++t){const e=f[t],s=f[t+4];if(Wt(n.planes,e,s))return!0;const r=f[(t+1)%4];if(Wt(n.planes,e,r))return!0;const o=f[4+(t+1)%4];if(Wt(n.planes,s,o))return!0}if(Qt[0][3]=+ot[0][0],Qt[1][3]=-ot[2][0],Qt[2][3]=+ot[0][1],Qt[3][3]=-ot[2][1],Qt[4][3]=+x,Qt[5][3]=-M,$(Qt,n.points))return!0;if($(Qt,n.points))return!0;for(let t=0;t<4;++t){const e=j,s=n.points[t+4];if(Nt(Qt,e,s))return!0;const r=n.points[4+(t+1)%4];if(Nt(Qt,s,r))return!0}return!1}_isTileVisibleInFrustumGlobal(t){if(t.level<tt)return!0;const e=t.spatialReference,s=t.extent;if(!s||!e)return!0;const r=this.opaqueGround&&this._aboveGround,o=this.opaqueGround&&!this._aboveGround,i=ot,n=.5*(s[0]+s[2]);if(S(i[0],s[0],s[1],0),S(i[1],s[2],s[1],0),S(i[2],s[2],s[3],0),S(i[3],s[0],s[3],0),S(i[4],n,s[1],0),S(i[5],n,s[3],0),!function(t,e,s,r,o,i,n=1){const p=O(e,o);if(null==p)return!1;if(p===B){if(t===r&&s===i)return!0;const e=s+n;for(let o=s,n=i;o<e;++o,++n)y(r[n],t[o]);return!0}const l=s+n;for(let e=s,o=i;e<l;++e,++o)p(t[e],0,r[o],0);return!0}(i,e,0,i,this._renderSR,0,6))return!1;const p=i[0][2]>0,l=i[3][2]<0,a=p||l,m=this._renderSREllipsoidRadius;if(a){const t=pt;Y(t,Zt,i[0]);const e=lt;if(Y(e,Zt,i[1]),p){const s=nt,r=i[4],o=at;Y(o,r,Zt),Y(s,o,r);const n=i[0];M(n,t,s),Z(n,m);const p=i[1];M(p,e,s),Z(p,m)}else if(l){const s=nt,r=i[5],o=at;Y(o,r,Zt),Y(s,r,o);const n=i[3];M(n,s,t),Z(n,m);const p=i[2];M(p,s,e),Z(p,m)}}const u=it,c=g(bt,i[3],i[0]);_(c,c);const d=x(vt,i[0],i[3]);L(d,d,.5);const h=-b(d,c),j=x(St,i[0],i[1]);L(j,j,.5);const f=x(Tt,i[2],i[3]);L(f,f,.5);const R=g(Mt,f,j);_(R,R);const E=-(h+b(c,j))/b(c,R);v(u,j,R,E),Z(u,m);const w=this._frustumBoundingSphereRadius,I=this._frustumBoundingSphereCenter,P=this._frustum,D=P.planes,F=mt;_(F,u);const G=b(i[0],F)/U(i[0]),k=P.origin,q=P.points;let V=!1;if(r){{V=!0;const t=_(At,k);for(let e=0;e<4;++e){const s=q[4+e],r=g(C(),s,k);_(r,r);const o=M(C(),t,r);_(o,o);const i=M(C(),r,o);if(_(i,i),b(k,i)>m){V=!1;break}}}if(V&&b(k,F)<m*G-kt)return!1;const t=_(At,P.origin);if(b(t,F)<0)return!1;{const t=_(qt,P.direction);if(b(t,F)>Vt)return!1}}const H=Math.sqrt(1-G*G);if(H>.9)return!0;let z=!1;const W=b(F,I),N=U(I);if(N<=w&&!D.some(t=>A(t,ft)>0)){if(!r)return!0;z=!0}const J=W/N;if(!z&&W<=0&&-W>w)return!1;const X=w/N;if(Math.sqrt(1-J*J)*Math.sqrt(1-X*X)-X*J>H)return!1;if(!V){if(i.some(t=>P.intersectsPoint(t)))return!0;if(P.intersectsPoint(u))return!0}const $=yt;g($,I,ft);const st=b($,F),rt=ut;L(rt,F,st);const ct=T(rt,I),dt=e.isWGS84,ht=t.lij,jt=dt&&ht[2]===2**ht[0]-1,Rt=dt&&0===ht[2],Bt=Rt?Dt:jt?It:Et,Ht=Rt?Ft:jt?Pt:wt;if(!z){const t=i,e=Ot,s=xt,r=Lt,o=ft;for(const i of Bt){const n=t[i];if(Q(s,t[(i+1)%4],n),Q(r,o,n),Y(e,r,s),et(e,q,1))return!1}}let zt=null;if(!r&&st<1.01*w){const t=2.5*w;if(ct>G*t+w)return!1;const e=gt,s=t/G;for(let t=0;t<4;++t)L(e[t],i[t],s/m);S(e[4],0,0,0),zt=e}else{const t=(o?m+kt:st+w)/G,e=r?m-kt:(st-w)/G,s=_t;for(let r=0;r<4;++r){const o=i[r];L(s[r],o,e/m),L(s[r+4],o,t/m)}zt=s}if(K(D,zt,zt.length))return!1;const Wt=P.lines,Nt=Ut,Yt=Ct;for(const t of Wt){_(Yt,t.direction);for(const t of Ht){const e=zt[t];if(_(Nt,e),Gt(Yt,Nt,zt,q))return!1;const s=(t+1)%4;if(r){const t=zt[s];if(g(Nt,t,e),_(Nt,Nt),Gt(Yt,Nt,zt,q))return!1}if(o){const e=zt[4+t],r=zt[4+s];if(g(Nt,r,e),_(Nt,Nt),Gt(Yt,Nt,zt,q))return!1}}}return!0}}function Y(t,e,s){return M(t,e,s),_(t,t),t}function Q(t,e,s){return g(t,e,s),_(t,t),t}function Z(t,e){return L(t,t,e/U(t)),t}const J=[0,1,2,3,5];function X(t,e,s){for(let r=0;r<s;++r)if(A(t,e[r])<=0)return!1;return!0}function K(t,e,s){for(const r of J)if(X(t[r],e,s))return!0;return!1}function $(t,e,s=e.length){for(let r=0;r<s;++r){const s=e[r];let o=!0;for(const e of t)if(A(e,s)>0){o=!1;break}if(o)return!0}return!1}const tt=2;function et(t,e,s){for(const r of e)if(b(r,t)<s)return!1;return!0}const st=[C(),C(),C(),C(),C(),C(),C(),C()],rt=[0,0,0,0,0,0],ot=[C(),C(),C(),C(),C(),C()],it=C(),nt=C(),pt=C(),lt=C(),at=C(),mt=C(),ut=C(),ct=C(),dt=C(),ht=C(),jt=C(),ft=E(0,0,0),yt=C(),_t=[C(),C(),C(),C(),C(),C(),C(),C()],gt=[C(),C(),C(),C(),C()],bt=C(),vt=C(),St=C(),Tt=C(),Mt=C(),xt=C(),Lt=C(),Ut=C(),Ct=C(),Rt=C(),Et=[0,1,2,3],wt=[0,1,2,3],It=[0,1,3],Pt=[0,1,3],Dt=[1,2,3],Ft=[1,2,3],Ot=C(),Bt=[0,0];function Gt(t,e,s,r){const o=s.length,i=r.length;if(0===o||0===i)return!0;const n=Rt;Y(n,t,e);const p=i<o,l=p?s:r,a=Bt;return function(t,e,s){let r=1/0,o=-1/0;for(const t of s){const s=b(e,t);r=Math.min(r,s),o=Math.max(o,s)}t[0]=r,t[1]=o}(a,n,p?r:s),function(t,e,s,r){let o=1/0,i=-1/0;for(const n of r){const r=b(s,n);if(o=Math.min(o,r),i=Math.max(i,r),o<=e&&i>=t)return!1}return!0}(a[0],a[1],n,l)}const kt=430,At=C(),qt=C(),Vt=Math.cos(.25*Math.PI),Ht=R(0,0,1),zt=C();function Wt(t,e,s){const r={t0:0,t1:1};for(const o of J)if(!Yt(t[o],e,s,r))return!1;return r.t0<r.t1}function Nt(t,e,s){const r={t0:0,t1:1};for(const o of t)if(!Yt(o,e,s,r))return!1;return r.t0<r.t1}function Yt(t,e,s,r){let{t0:o,t1:i}=r;const n=A(t,e),p=A(t,s);if(n>=0&&p>=0)return!1;if(n<0&&p>=0){const t=-n/(p-n);if(t<o)return!1;t<i&&(i=t)}else if(n>=0&&p<0){const t=n/(n-p);if(t>i)return!1;t>o&&(o=t)}return r.t0=o,r.t1=i,!0}const Qt=[k(-1,0,0,1),k(1,0,0,-1),k(0,-1,0,1),k(0,1,0,-1),k(0,0,-1,1),k(0,0,1,-1)],Zt=E(0,0,1);class Jt{constructor(t,e,s){this._renderCoordsHelper=t,this._tilingScheme=e,this._camera=new V,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new N(t,s)}set opaqueGround(t){this._visibility.opaqueGround=t}setup(t,e,s){this._camera.copyFrom(t),this._surfaceElevation=s,this._focusOnMap[0]=e.x,this._focusOnMap[1]=e.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(t){const{measures:e,extent:s,level:r}=t;s&&(e.visible=this._visibility.compute(t),e.distance=c(s,this._focusOnMap),e.mergeable=!0,e.lodLevel=tt,e.splitPriority=Math.max(0,tt-r),e.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(t):this._updateSplitAndLodLocal(t)))}_updateSplitAndLodGlobal(t){const e=t.level,s=this._renderCoordsHelper,{eye:r,fov:o}=this._camera,i=s.referenceEllipsoid.radius,n=U(r)-i;if(2*Math.atan(i/n)<o&&n>0)return void(t.measures.lodLevel=Math.max(e,tt));const p=Xt,{extent:l}=t;if(!l)return;const{_surfaceElevation:a}=this;S(p[0],l[0],l[1],a),S(p[1],l[2],l[1],a),S(p[2],l[2],l[3],a),S(p[3],l[0],l[3],a);const m=S(Kt,.5*(l[0]+l[2]),.5*(l[1]+l[3]),a),u=this._tilingScheme.spatialReference;for(let t=0;t<4;++t)s.toRenderCoords(p[t],u,p[t]);s.toRenderCoords(m,u,m);const c=_(se.direction,m),d=b(r,c),h=L(te,c,d);this._updateSplitAndLod(t,p,m,h)}_updateSplitAndLodLocal(t){const e=Xt,{extent:s}=t;if(!s)return;const{_surfaceElevation:r}=this;S(e[0],s[0],s[1],r),S(e[1],s[2],s[1],r),S(e[2],s[2],s[3],r),S(e[3],s[0],s[3],r);const o=this._tilingScheme.spatialReference;for(let t=0;t<4;++t)this._renderCoordsHelper.toRenderCoords(e[t],o,e[t]);const i=S(Kt,.5*(e[0][0]+e[2][0]),.5*(e[0][1]+e[2][1]),.25*(e[0][2]+e[1][2]+e[2][2]+e[3][2])),n=S($t,i[0],i[1],0),{eye:p,far:l}=this._camera,a=S(te,n[0],n[1],p[2]);S(se.origin,n[0],n[1],p[2]-2*l),y(se.direction,ee),this._updateSplitAndLod(t,e,i,a)}_updateSplitAndLod(t,e,s,r){const o=Math.max(T(e[0],e[2]),T(e[1],e[3]),T(e[0],s)+T(s,e[2]),T(e[1],s)+T(s,e[3])),{eye:i,near:n,fov:p,viewForward:l,width:a,height:m,pixelRatio:u,frustum:c}=this._camera,d=b(i,l),h=b(s,l)-d,j=T(s,i);let f=h,y=h,_=j,g=j;const v=(t,e)=>e<n?1:Math.sqrt(t*t-e*e)/e;let S=v(j,h);for(const t of e){const e=b(t,l)-d;f=Math.min(f,e),y=Math.max(y,e);const s=T(t,i);g=Math.max(g,s),_=Math.min(_,s);const r=v(s,e);S=Math.min(S,r)}if(y<n)return void(t.measures.lodLevel=0);const M=Math.cos(.5*p),x=T(i,r);S>M&&x>oe*o&&(y=ie*g,f=ie*_);const L=.5*Math.sqrt(a*a+m*m)/u,U=2*Math.tan(.5*p),C=t=>Math.max(n,t)*re/L*U,R=t.level,E=o*2**R*Math.max(1,U),w=C(f),P=Math.ceil(Math.log2(Math.max(1,E/w)));if(t.measures.lodLevel=Math.max(P,t.measures.lodLevel),t.measures.splitPriority+=t.measures.lodLevel-R,R<P){const s=+I(c,e[0])+ +I(c,e[1])+ +I(c,e[2])+ +I(c,e[3]);t.measures.splitPriority+=s}const D=C(y)/w;D>2.5&&(t.measures.splitPriority+=D)}get _isGlobal(){return 1===this._renderCoordsHelper.viewingMode}}const Xt=[C(),C(),C(),C()],Kt=C(),$t=C(),te=C(),ee=E(0,0,1),se=P(w,ee),re=312,oe=.5,ie=2;let ne=class extends e{constructor(t){super(t),this.tiles=new s,this.tileSize=512,this._idToTile=new Map,this._dirty=a(!1),this._pendingTiles=a(null),this._newTiles=new i,this._tests=!1,this._measurements=new Jt(t.renderCoordsHelper,t.terrain.tilingScheme,this._opaqueGround)}initialize(){this.addHandles([n(()=>this.tileSize,()=>this._reset(),p),n(()=>[this.pointsOfInterest.cameraOnSurface?.location,this.viewState?.contentCamera,this.pointsOfInterest.focus?.location,this.terrain?.baseOpacity??1],()=>this._setDirty(),p),n(()=>this.tilingScheme,t=>{this._reset(),this._measurements=new Jt(this.renderCoordsHelper,t,this._opaqueGround)},l),n(()=>this._opaqueGround,t=>this._measurements.opaqueGround=t,l)]),this._frameWorker=this.scheduler?.registerTask(z.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=o(this._frameWorker),this._measurements=null,this._newTiles.prune()}get tilingScheme(){return this.terrain.tilingScheme?.clone()}set filterExtent(t){if(null!=t&&!t.spatialReference.equals(this.viewState.spatialReference))return void r.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const e=this._get("filterExtent");if(e===t||null!=e&&t&&e.equals(t))return;const s=null!=t?t.clone():null;this._set("filterExtent",s),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const t=d();return H(this.filterExtent,t,this.tilingScheme.spatialReference),t}get _rootTileIds(){const{tilingScheme:t}=this;return this._filterExtentRect&&t?t.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(t){t!==this._get("suspended")&&(this._set("suspended",t),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}get _opaqueGround(){return 1===(this.terrain?.baseOpacity??1)}_setDirty(){this.suspended||(this._frameWorker?this._dirty.value=!0:this.runTask(W))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(!1),this._dirty.value=!1}get readyToRun(){return this.updating}_reset(t=!0){this._newTiles.clear(),this._pendingTiles.value=null,t&&this._setDirty()}_getRootTiles(){const t=this.tilingScheme;return this._rootTileIds.map(e=>new j(e[0],e[1],e[2],t))}runTask(t){t=this._tests?W:t,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(t),null!=this._frameWorker&&(this._frameWorker.priority=z.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(t),this._pendingTiles.value||null==this._frameWorker||(this._frameWorker.priority=z.FEATURE_TILE_TREE)}_startUpdate(t){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:e,_filterExtentRect:s,_newTiles:r}=this;e.setup(this.viewState.contentCamera,this.pointsOfInterest.focus.location,this.pointsOfInterest.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter(t=>{if(e.update(t),t.measures.visible&&(!s||!t.extent||h(t.extent,s))){if(t.measures.splitPriority>0)return!0;r.push(t)}return!1}).sort(pe),this._newTiles.clear(),t.madeProgress()}_splitPendingTiles(t){const e=this._pendingTiles.value;if(!e)return;const{tilingScheme:s,_filterExtentRect:r,_newTiles:o,_measurements:i}=this;for(;e.length>0&&this._tileBudgetRatio<=2;){const n=e.pop();if(t.madeProgress(),n.measures.splitPriority>0){s.ensureMaxLod(n.level+1);const t=n.createChildren();for(const s of t)i.update(s),!s.measures.visible||r&&s.extent&&!h(s.extent,r)||(s.measures.splitPriority>0?e.push(s):o.push(s));e.sort(pe),this._mergeNewTiles(2),this._mergeNewTiles(2,!0)}else o.push(n);if(t.done)return}o.pushArray(e),this._pendingTiles.value=null,this._updateTiles(),o.clear(),i.done()}get _tileBudgetRatio(){return(this._newTiles.length+(this._pendingTiles.value?.length??0))/60}_mergeNewTiles(t,e=!1){if(this._tileBudgetRatio<=t)return;const{_newTiles:s,_measurements:r}=this;s.sort((t,e)=>e.measures.distance-t.measures.distance);const o=new Map(s.map(t=>[t.id,t])),i=s.length;for(const i of o.values()){const{lij:n,measures:p}=i;if(!p.mergeable||n[1]%2!=0||n[2]%2!=0||n[0]<=1||i.lodLevelDelta>=4)continue;const l=p.lodLevel;let a=l,m=!0;const u=o.get(f(n[0],n[1]+1,n[2]));let c=Math.abs((u?.measures.lodLevel??0)-l),d=0===c||e&&u?.measures.mergeable&&c<=1;if(!u||!d)continue;a+=u.measures.lodLevel,m&&=0===c;const h=o.get(f(n[0],n[1],n[2]+1));if(c=Math.abs((h?.measures.lodLevel??0)-l),d=0===c||e&&h?.measures.mergeable&&c<=1,!h||!d)continue;a+=h.measures.lodLevel,m&&=0===c;const y=o.get(f(n[0],n[1]+1,n[2]+1));if(c=Math.abs((y?.measures.lodLevel??0)-l),d=0===c||e&&y?.measures.mergeable&&c<=1,!y||!d)continue;a+=y.measures.lodLevel,m&&=0===c,s.removeUnordered(i),s.removeUnordered(u),s.removeUnordered(h),s.removeUnordered(y),o.delete(i.id),o.delete(u.id),o.delete(h.id),o.delete(y.id);const _=new j(n[0]-1,n[1]/2,n[2]/2,this.tilingScheme);if(r.update(_),_.measures.visible=!0,_.measures.lodLevel=a/4,_.measures.mergeable=m,s.push(_),o.set(_.id,_),this._tileBudgetRatio<=t)return}s.length<i&&this._mergeNewTiles(t,e)}_updateTiles(){this._mergeNewTiles(1),this._mergeNewTiles(1,!0);for(const t of this.tiles.items)t.used=!1;let t=!1;const e=this._newTiles.filter(e=>{const s=this._idToTile.get(e.id);return s?(t||=s.measures.lodLevel!==e.measures.lodLevel,s.measures={...e.measures},s.used=!0):this._idToTile.set(e.id,e),!s}),s=this.tiles.items.filter(t=>!t.used&&(this._idToTile.delete(t.id),!0));this.tiles.removeMany(s),this.tiles.addMany(e),this._sortTiles(),!t||s.length||e.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((t,e)=>t.measures.distance-e.measures.distance),this.tiles.forEach((t,e)=>t.loadPriority=e)}};function pe(t,e){return t.lodLevelDelta-e.lodLevelDelta||t.measures.splitPriority-e.measures.splitPriority||e.measures.distance-t.measures.distance}t([m({constructOnly:!0})],ne.prototype,"scheduler",void 0),t([m({constructOnly:!0})],ne.prototype,"renderCoordsHelper",void 0),t([m({constructOnly:!0})],ne.prototype,"pointsOfInterest",void 0),t([m({constructOnly:!0})],ne.prototype,"viewState",void 0),t([m({constructOnly:!0})],ne.prototype,"terrain",void 0),t([m()],ne.prototype,"tiles",void 0),t([m()],ne.prototype,"tileSize",void 0),t([m({readOnly:!0})],ne.prototype,"tilingScheme",null),t([m()],ne.prototype,"filterExtent",null),t([m({readOnly:!0})],ne.prototype,"_filterExtentRect",null),t([m({readOnly:!0})],ne.prototype,"_rootTileIds",null),t([m({value:!1})],ne.prototype,"suspended",null),t([m({readOnly:!0})],ne.prototype,"updating",null),ne=t([u("esri.views.3d.layers.support.FeatureTileTree3D")],ne);export{ne as FeatureTileTree3D};
