/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../core/Collection.js";import{i as t,D as n,a3 as i,a4 as r,a5 as l}from"./unitUtils.js";import{x as o}from"./layerUtils.js";import a from"../core/Error.js";import{d as s,c}from"./aaBoundingRect.js";import{g as u,T as f,m as p}from"./TerrainConst.js";function m(e){return null!=e&&"type"in e&&"vector-tile"===e.type}function h(e){return null!=e&&"type"in e&&"raster-tile"===e.type}function g(e){return null!=e&&"type"in e&&"tile-texture"===e.type}function d(e){return null!=e&&"type"in e&&"image+type"===e.type}function y(e){return b(e)||i(e)||r(e)}function b(e){return t(e)||n(e)}const T=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,n,i){if(null==e)return u();const r=e.spatialReference;if(r.isGeographic&&!b(r))return new a("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const l=f.checkUnsupported(e);if(null!=l)return l;if(null==n)return new a("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const o=function(e,t){const n=e.lods,i=n[0].resolution*2**n[0].level,r=[i*e.size[0],i*e.size[1]],l=[e.origin.x,e.origin.y],o=s(t),u=c();f.computeRowColExtent(o,r,l,u);const m=(u[2]-u[0])*(u[3]-u[1]);if(m>p){const t=n[0].scale*2**n[0].level;let r=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*t/i;const l=Math.floor(Math.log(r)/Math.log(10));return r=Math.ceil(r/10**l)*10**l,new a("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+r.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:r,requiredNumRootTiles:m,allowedNumRootTiles:p})}return null}(e,n);return o||(null==t||r.equals(t)||t.isWGS84&&r.isWebMercator?null:new a("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"))}},Symbol.toStringTag,{value:"Module"})),w={1:Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,n,i){if(null==e)return u();const r=e?.lods.length-1,l=e.spatialReference;if(l.isWebMercator){if(!f.makeWebMercatorAuxiliarySphere(r).compatibleWith(e,i))return new a("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!y(l))return new a("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!f.makeGCSWithTileSize(e.spatialReference,e.size[0],r).compatibleWith(e,i))return e.spatialReference.isWGS84?new a("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new a("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return null==t||e.spatialReference.equals(t)?null:new a("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}},Symbol.toStringTag,{value:"Module"})),2:T};function I(e,t){e||console.warn("Terrain: "+t)}let S=!1,x=!1;function M(e){x=e,S=S||e}function v(e){S=e}function E(e,t){if(S&&!e){const e=(new Error).stack?.slice(5);throw console.warn("Terrain internal: "+(t??"")+" at "+e),new Error("Assertion failed"+(t?": "+t:""))}}function L(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function R(e){return"imagery-tile-3d"===e?.type}function C(e){return"tile-3d"===e?.type}function W(e){return"vector-tile-3d"===e?.type}function j(e){return"wmts-3d"===e?.type}function G(e){return"elevation-3d"===e?.type}function O(e){return"group"===e?.type}function k(e){return e&&(C(e)||j(e)||R(e)||W(e))}function z(e){return e&&(C(e)||R(e)||W(e)||j(e))}function _(e){return z(e)||G(e)}function F(e){return h(e?.sourceLayerInfo?.data)}function V(e){return D(e?.sourceLayerInfo)||!!e?.isVTLBackground}function A(e){return g(e?.sourceLayerInfo?.data)}function q(e){const t=e?.sourceLayerInfo?.data;return d(t)||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData}function D(e){return m(e?.data)}function B(e){return null!=e&&"release"in e&&e.release(),null}function H(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function N(e,t,n,i,r){return w[i].checkIfTileInfoSupportedForViewSR(e,n,t,r)}function P(e,t,n){let i=null,r=null;if("wmts"===e?.type){const l=U(e,t,n);i=l.tileInfo,r=l.fullExtent}else{r=L(e)?e.getCompatibleFullExtent(t):e.fullExtent;const l=2===n;i=L(e)?e.getCompatibleTileInfo(t,r,l):"vector-tile"===e?.type?l&&!J(t)||K.force512VTL?e.tileInfo:e.tileInfo.getCompatibleForVTL(256):e.tileInfo}const l="tilemapCache"in e?e.tilemapCache?.effectiveMaxLOD:void 0;return null!=i&&null!=r&&null==N(i,r,t,n,l)?{tileInfo:i,fullExtent:r}:null}function U(t,n,i){const r=o(t);if(null!=r){if(!e.isCollection(r))return{tileInfo:r.tileInfo,fullExtent:r.fullExtent};{const e=r.find(e=>null==N(e.tileInfo,e.fullExtent,n,i));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}function J(e){return e.isWGS84||e.isWebMercator||n(e)||!l(e)}const K={force512VTL:!1};function Q(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function X(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function Y(e,t,n=se){return Math.abs(e-t)<n}function Z(e){return 1===e?5:7===e?3:5===e?1:7}function $(e){return 0===e?4:2===e?6:4===e?0:2}function ee(e){return 7===e||5===e}function te(e){return 7===e||1===e}function ne(e){return 7===e||6===e||5===e}function ie(e){return 1===e||2===e||3===e}function re(e){return 3===e||4===e||5===e}function le(e){return 1===e||0===e||7===e}const oe=[0,2,4,6],ae=[1,3,5,7],se=1e-5;export{re as A,ne as B,ie as C,ee as D,te as E,W as F,V as G,F as H,q as I,A as J,D as K,b as L,y as M,_ as N,O,z as P,G as Q,v as R,M as S,d as a,P as b,N as c,L as d,E as e,R as f,U as g,ae as h,h as i,S as j,X as k,Q as l,m,oe as n,$ as o,g as p,k as q,B as r,Z as s,K as t,H as u,J as v,I as w,Y as x,x as y,le as z};
