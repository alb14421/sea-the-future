/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../core/Accessor.js";import{EventEmitter as i}from"../core/Evented.js";import{watch as s,sync as r,initial as n}from"../core/reactiveUtils.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import{q as o}from"../core/lang.js";import"./Logger.js";import{subclass as h}from"../core/accessorSupport/decorators/subclass.js";import{E as c}from"./ExtentSet.js";import{T as l,Y as d}from"./Scheduler.js";import{U as p}from"./unitUtils.js";import{l as _}from"./mathUtils.js";import{i as u}from"./mat4.js";import{c as g}from"./mat4f64.js";import{j as m,i as y,y as f,t as x,k as S,d as v}from"./vec3.js";import{c as b}from"./vec3f64.js";import{c as C}from"./computeTranslationToOriginAndRotation.js";import{p as E}from"./projectBoundingRect.js";import{p as j}from"./projectVectorToVector.js";import{m as w,c as I,e as G}from"./aaBoundingBox.js";import{v as O,c as D}from"./aaBoundingRect.js";import{f as R,c as T}from"./lineSegment.js";import{c as B,b as A,a as U,v as V,o as H}from"./plane.js";import{w as k}from"./ray.js";import{f as M}from"./TextureCompressionTracker.js";import{m as z}from"./handleUtils.js";let P=class extends e{constructor(t){super(t),this._dirtyExtents=new c,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new i}initialize(){const t=this.elevationProvider,e=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=e.registerTask(F(this.graphicsCore.layer.elevationInfo?.mode),this),this.addHandles([t.on("elevation-change",t=>this._elevationChanged(t)),s(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,s(()=>F(this.graphicsCore.layer.elevationInfo?.mode),t=>this._task.priority=t)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null,this._dirtyExtents.destroy()}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.readyToRun}get readyToRun(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(t){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,t.madeProgress()),t.run(()=>this._dirtyExtents.merge(t));this.readyToRun&&!t.done;)this._updateDirtyGraphics(t),this._updateDirtyExtents(t);this.notifyChange("updating")}_updateDirtyGraphics(t){const e=this.graphicsCoreOwner.view.renderCoordsHelper,i=0===this.graphicsCore.effectiveUpdatePolicy;for(const s of this._dirtyGraphicsSet.keys()){const r=this.graphicsCore.getGraphics3DGraphicById(s);if(this._dirtyGraphicsSet.delete(s),null!=r&&(r.alignWithElevation(this.elevationProvider,e,i),this.graphicsCore.deconflictor?.setDirty(),t.madeProgress()),t.done)return}}_updateDirtyExtents(t){for(;!this._dirtyExtents.empty&&!t.done;){const e=this._dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:e,spatialReference:i});const s=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(e,i,t=>{const e=this.graphicsCore.getGraphics3DGraphicById(t);null!=e&&e.needsElevationUpdates()&&this._dirtyGraphicsSet.add(t)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-s)+.9*this._averageExtentUpdateSize,t.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((t,e)=>this._dirtyGraphicsSet.add(e))}_elevationChanged(t){if("scene"===t.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const e=t.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const t=this.graphicsCore.computedExtent;t&&e[2]>t.xmin&&e[0]<t.xmax&&e[3]>t.ymin&&e[1]<t.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",t)}else e[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(e),this.notifyChange("updating")}};function F(t){return null==t?l.ELEVATION_ALIGNMENT:"relative-to-scene"===t?l.ELEVATION_ALIGNMENT_SCENE:l.ELEVATION_ALIGNMENT}t([a()],P.prototype,"graphicsCoreOwner",void 0),t([a()],P.prototype,"graphicsCore",void 0),t([a()],P.prototype,"queryGraphicUIDsInExtent",void 0),t([a()],P.prototype,"elevationProvider",void 0),t([a({readOnly:!0})],P.prototype,"updating",null),t([a({readOnly:!0})],P.prototype,"updatingRemaining",null),P=t([h("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],P);const N=.5*Math.PI,L=N/Math.PI*180;class q{constructor(t){this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:b(),direction:b()},this._renderCoordsHelper=t.renderCoordsHelper;for(let t=0;t<4;t++)this._extent[t]={origin:b(),direction:b(),cap:{next:null,direction:b()}},this._planes[t]=B();this._planes[4]=B(),this._planes[5]=B(),this._planesWithoutFar=this._planes.slice(0,5)}update(t,e,i,s=!0){const r=this._extent;this._toRenderBoundingExtent(t,e,i),m(this._center.origin,r[0].origin,r[2].origin),y(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),s||y(this._center.direction,this._center.direction,-1);for(let t=0;t<4;t++){const e=r[t];this._renderCoordsHelper.worldUpAtPosition(e.origin,e.direction);const i=r[3===t?0:t+1];e.cap.next=i.origin,f(e.cap.direction,e.origin,i.origin),A(e.direction,e.cap.direction,e.origin,this._planes[t]),s||y(e.direction,e.direction,-1)}A(r[0].cap.direction,r[1].cap.direction,r[0].origin,this._planes[4]),s?V(this._planes[4],this._planes[5]):(U(this._planes[5],this._planes[4]),V(this._planes[4],this._planes[4])),this._maxSpan=Math.max(Math.abs(t[0]-t[2]),Math.abs(t[1]-t[3])),this._maxSpanSpatialReference=e,this._minGlobalAltitude=.9*p(this._maxSpanSpatialReference).radius}isVisibleInFrustum(t,e,i=!1){if(null==t)return!1;if(1===this._renderCoordsHelper.viewingMode){const i=this._maxSpanSpatialReference.isGeographic?L:N*e;if(this._maxSpan>i)return!0;if(null!=t.altitude&&t.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(t)}if(0===this._maxSpan){const e=this._extent[0];return!(i||!t.intersectsRay(k(e.origin,e.direction)))}for(let e=0;e<this._extent.length;e++){const s=this._extent[e];if(!i&&t.intersectsRay(k(s.origin,s.direction)))return!0;if(t.intersectsLineSegment(R(s.origin,s.cap.next,Z),s.cap.direction))return!0}const s=i?this._planes:this._planesWithoutFar;for(let e=0;e<t.lines.length;e++){const i=t.lines[e];if(M(s,i.origin,i.endpoint,i.direction))return!0}return!1}_toRenderBoundingExtentGlobal(t,e,i){O(t,Y),Y[2]=i,C(e,Y,J,this._renderCoordsHelper.spatialReference),u(K,J),w(Q);for(const{x0:s,x1:r,y0:n,y1:a}of W)for(let o=0;o<5;o++){const h=o/4;Y[0]=_(t[s],t[r],h),Y[1]=_(t[n],t[a],h),Y[2]=i,j(Y,e,Y,this._renderCoordsHelper.spatialReference),x(Y,Y,K),G(Q,Y)}S(this._extent[0].origin,Q[0],Q[1],Q[2]),S(this._extent[1].origin,Q[3],Q[1],Q[2]),S(this._extent[2].origin,Q[3],Q[4],Q[2]),S(this._extent[3].origin,Q[0],Q[4],Q[2]);for(let t=0;t<4;++t)x(this._extent[t].origin,this._extent[t].origin,J)}_toRenderBoundingExtentLocal(t,e,i){E(t,e,X,this._renderCoordsHelper.spatialReference),S(this._extent[0].origin,X[0],X[1],i),S(this._extent[1].origin,X[2],X[1],i),S(this._extent[2].origin,X[2],X[3],i),S(this._extent[3].origin,X[0],X[3],i)}_toRenderBoundingExtent(t,e,i){switch(this._renderCoordsHelper.viewingMode){case 1:this._toRenderBoundingExtentGlobal(t,e,i);break;case 2:this._toRenderBoundingExtentLocal(t,e,i);break;default:o(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(t){if(H(t.planes[4],this._center.origin)<0&&v(this._center.direction,t.direction)<0)return!0;for(let e=0;e<4;e++){const i=this._extent[e];if(H(t.planes[4],i.origin)<0&&v(i.direction,t.direction)<0)return!0}return!1}}const W=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],Y=b(),J=g(),K=g(),Q=I(),X=D(),Z=T();let $=class extends e{constructor(t){super(t),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:t}=this;this._extentIntersection=new q({renderCoordsHelper:t.view.renderCoordsHelper});const e=t.view,i=e.basemapTerrain,a=e.resourceController.scheduler;this.addHandles([e.on("resize",()=>this._viewChange()),s(()=>e.state.camera,()=>this._viewChange(),r),a.registerTask(l.FRUSTUM_VISIBILITY,this),s(()=>i.visibleElevationBounds,()=>this._elevationBoundsChange())]),"local"===e.viewingMode?this._isVisibleBelowSurface=!0:this.addHandles([s(()=>[i.baseOpacity,i.wireframe,e.map?.ground?.navigationConstraint?.type],()=>this._updateIsVisibleBelowSurface(),n)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(t){this._extent=t,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(t){this._isVisibleBelowSurfaceInternal=t,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){const t=this.graphicsCoreOwner.view,e=t.basemapTerrain,i="local"===t.viewingMode,s="none"===t.map.ground?.navigationConstraint?.type;this._isVisibleBelowSurface=i||!e.opaque||s}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const t=this.graphicsCoreOwner.view;let e;if(this._isVisibleBelowSurfaceInternal)e=-.3*p(t.spatialReference).radius;else{const{min:i,max:s}=t.basemapTerrain.visibleElevationBounds;e=i-Math.max(1,(s-i)*(1.2-1))}this._extentIntersection.update(this._extent,t.spatialReference,e)}get readyToRun(){return this.updating}runTask(t){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),d;this._updateExtentIntersection();const e=this.graphicsCoreOwner.view.frustum,i=p(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(e,i)),t.madeProgress()}};t([a({readOnly:!0})],$.prototype,"suspended",void 0),t([a({constructOnly:!0})],$.prototype,"graphicsCoreOwner",void 0),t([a({readOnly:!0})],$.prototype,"updating",void 0),$=t([h("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],$);class tt{}class et extends tt{constructor(t,e){super(),this.objectStateId=t,this.object=e}remove(){this.object.removeStateID(this.objectStateId)}}class it extends tt{constructor(t,e,i){super(),this.objectStateId=t,this.object=e,this.owner=i}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}}class st extends tt{constructor(t,e){super(),this.objectStateId=t,this._removeCallback=e,this.object=null}remove(){this._removeCallback(this.objectStateId)}}class rt{constructor(){this._items=[]}addObject(t,e){this._items.push(new et(e,t))}addRenderGeometry(t,e,i){this._items.push(new it(e,t,i))}addExternal(t,e){this._items.push(new st(e,t))}remove(t){this._remove(e=>e.objectStateId===t)}removeByObject(t){this._remove(e=>e.object===t)}removeAll(){this._items.forEach(t=>t.remove()),this._items=[]}_remove(t){const{_items:e}=this;for(let i=e.length-1;i>=0;--i){const s=e[i];t(s)&&(s.remove(),e.splice(i,1))}}}class nt extends rt{constructor(){super(...arguments),this.stateType=1}}class at extends rt{constructor(t){super(),this.highlightName=t,this.stateType=0}}class ot{constructor(t){this.objectIdField=t,this.ids=new Set,this.paused=!1}hasGraphic(t){const e=this.objectIdField?t.graphic.attributes[this.objectIdField]:t.graphic.uid;return this.ids.has(e)}}class ht extends ot{constructor(t){super(t),this.stateType=1,this.objectStateSet=new nt}}class ct extends ot{constructor(t,e){super(e),this.highlightName=t,this.stateType=0,this.objectStateSet=new at(t)}}class lt{constructor(t){this._graphicsCore=t,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(t=>t.objectStateSet.removeAll()),this._stateSets.length=0)}acquireOccludeeSet(t){const e=new ht(t);this._stateSets.push(e);const i=z(()=>this.releaseSet(e));return{set:e,handle:i}}acquireHighlightSet(t,e){const i=new ct(t,e);this._stateSets.push(i);const s=z(()=>this.releaseSet(i));return{set:i,handle:s}}releaseSet(t){t.objectStateSet.removeAll();const e=this._stateSets?this._stateSets.indexOf(t):-1;-1!==e&&this._stateSets.splice(e,1)}setUid(t,e){t.ids.add(e);const i=this._graphicsCore.graphics3DGraphics.get(e);i&&i.addObjectStateSet(t.objectStateSet)}setUids(t,e){e.forEach(e=>this.setUid(t,e))}setObjectIds(t,e){e.forEach(e=>t.ids.add(e)),this._initializeSet(t)}addGraphic(t){this._stateSets.forEach(e=>{!e.paused&&e.hasGraphic(t)&&t.addObjectStateSet(e.objectStateSet)})}removeGraphic(t){this._stateSets.forEach(e=>{e.hasGraphic(t)&&t.removeObjectState(e.objectStateSet)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(t=>t.objectStateSet.removeAll())}_initializeSet(t){const e=this._graphicsCore.graphics3DGraphics;t.objectIdField?e.forEach(e=>{e&&t.hasGraphic(e)&&e.addObjectStateSet(t.objectStateSet)}):t.ids.forEach(i=>{const s=e.get(i);s&&s.addObjectStateSet(t.objectStateSet)})}get test(){}}export{lt as G,P as a,$ as b};
