/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{c as e}from"./vec2f64.js";import{x as t,e as r,h as s,i,d as a,j as n,k as o,t as l}from"./vec3.js";import{c,O as u}from"./vec3f64.js";import{g as h,o as d}from"./plane.js";import{L as p}from"./Logger.js";import{t as m,b as y}from"./calloutUtils.js";import f from"../Color.js";import{q as g,h as b,O as v,i as _,r as S}from"../core/lang.js";import{p as P}from"./screenUtils.js";import{f as x,O,Z as E,d as C,c as L}from"./vec4f64.js";import{c as w}from"./mat4.js";import{c as j}from"./mat4f64.js";import{c as D}from"./computeTranslationToOriginAndRotation.js";import{p as F}from"./projectBuffer.js";import{S as A,u as T,s as z,d as R,E as G,z as I,g as B,h as U,i as M,j as V}from"./ElevationContext.js";import{d as N}from"./debugFlags2.js";import{S as k}from"./ElevationProvider.js";import"./Indices.js";import{ax as q,_ as H,g as $,a1 as W,F as Z,B as Q,i as J,k as X,R as Y,D as K,x as ee,M as te,W as re,A as se,a6 as ie,a7 as ae,a9 as ne,G as oe}from"./Matrix4PassUniform.js";import"./triangle.js";import"./Texture.js";import{c as le,b as ce}from"./vec4.js";import{c as ue,h as he,a as de}from"./coordsUtils.js";import{y as pe,s as me,l as ye}from"./graphicUtils.js";import{h as fe,e as ge}from"./symbolColorUtils.js";import{p as be}from"./projectPointToVector.js";import{c as ve,A as _e,B as Se,l as Pe,m as xe,j as Oe,I as Ee,J as Ce,b as Le,L as we,k as je,s as De,D as Fe,e as Ae}from"./aaBoundingBox.js";import{m as Te}from"./dehydratedPoint.js";import{O as ze,d as Re}from"./RibbonLineMaterial.js";import{A as Ge}from"./orientedBoundingBox.js";import{a as Ie}from"./string.js";import{f as Be}from"./vec2f32.js";import{F as Ue,i as Me}from"./Emissions.glsl.js";import{n as Ve}from"./InterleavedLayout.js";import{s as Ne,a as ke}from"./vec2.js";import{A as qe,H as He,a as $e}from"./HUDVisibility.glsl.js";import{g as We,I as Ze}from"./glsl.js";import{b as Qe}from"./BooleanBindUniform.js";import{F as Je}from"./CameraSpace.glsl.js";import{S as Xe}from"./ShaderBuilder.js";import{m as Ye,a as Ke,d as et,s as tt}from"./renderState.js";import{_ as rt}from"./tslib.es6.js";import{a as st}from"./AlphaCutoff.js";import{f as it}from"./asyncUtils.js";import{isAbortError as at,onAbortOrThrow as nt,throwIfAborted as ot,createAbortError as lt,createResolver as ct,onAbort as ut}from"../core/promiseUtils.js";import{c as ht}from"./memoryEstimations.js";import{O as dt}from"./ObjectPool.js";import pt from"../geometry/Polygon.js";import{p as mt}from"./projectBoundingRect.js";import{c as yt,C as ft,e as gt}from"./aaBoundingRect.js";import{p as bt,E as vt}from"./unitUtils.js";import{m as _t}from"./dehydratedFeatures.js";import{b as St}from"./featureConversionUtils.js";import{g as Pt}from"./sphere.js";import{d as xt}from"../symbols/ObjectSymbol3DLayer.js";import{p as Ot}from"./primitiveObjectSymbolUtils.js";import{D as Et}from"./DefaultMaterial.js";import{a as Ct}from"./maybe.js";import{EventedAccessor as Lt}from"../core/Evented.js";import{property as wt}from"../core/accessorSupport/decorators/property.js";import{subclass as jt}from"../core/accessorSupport/decorators/subclass.js";import{g as Dt}from"./unitConversionUtils.js";import{I as Ft}from"./Intersector2.js";import At from"../geometry/Multipoint.js";import{T as Tt,n as zt}from"./Scheduler.js";import{s as Rt}from"./signal.js";function Gt(e,a,n,o){const l=function(e,a,n){const o=Bt;return e?(n&&(o.len=t(a,n)),r(o.dir,e)):(o.len=t(a,n),s(o.dir,n,a),i(o.dir,o.dir,1/o.len)),o}(o,a,n);return function(e,t,r,s){s.clip[0]=0,s.clip[1]=r?s.len:Number.MAX_VALUE;for(let r=0;r<e.length;r++)if(!Ut(e[r],t,s))return!1;return!0}(e,a,n,l)}function It(e,t,r,o){const l=a(r,s(e,o,t));return n(e,t,i(e,r,l))}const Bt={dir:c(),len:0,clip:e()};function Ut(e,t,r){const s=a(h(e),r.dir),i=-d(e,t);if(i<0&&s>=0)return!1;if(s>-1e-6&&s<1e-6)return i>0;if((i<0||s<0)&&!(i<0&&s<0))return!0;const n=i/s;return s>0?n<r.clip[1]&&(r.clip[1]=n):n>r.clip[0]&&(r.clip[0]=n),r.clip[0]<=r.clip[1]}class Mt{constructor(e,t){this.renderer=e,this.symbol=t,this.color=null,this.size=null,this.opacity=null,this.outlineSize=null,this.heading=null,this.tilt=null,this.roll=null}}function Vt(e){return null!=e.mapPositions}function Nt(e,t,r,s,i){const a=e.stageObject,n=a.geometries;let o=0;for(const e of n){if(!Vt(e))continue;const{update:n,averageGeometrySampledElevation:l}=er(e,t,r,s,i);o+=l,n&&a.geometryVertexAttributeUpdated(e,"position")}return o/n.length}function kt(e,t,r,s,i,a){const n=e.stageObject,l=t.centerPointInElevationSR;let c=0;n.usesVerticalDistanceToGround?(s(l,Kt),T(n,Kt.verticalDistanceToGround),c=Kt.sampledElevation):(s(l,Kt),"absolute-height"!==t.mode&&(c=Kt.sampledElevation));const u=w(qt,a??n.transformation),h=o(Yt,u[12],u[13],u[14]);N.TESTS_DISABLE_OPTIMIZATIONS?(Zt[0]=l.x,Zt[1]=l.y,Zt[2]=Kt.z,D(l.spatialReference,Zt,u,i.spatialReference)&&(a?w(a,u):n.transformation=u)):i.setAltitudeOfTransformation(Kt.z,u);const d=Wt/i.unitInMeters;return(Math.abs(u[12]-h[0])>=d||Math.abs(u[13]-h[1])>=d||Math.abs(u[14]-h[2])>=d)&&(a?w(a,u):n.transformation=u),c}const qt=j();function Ht(e,t,r,s,i){const a=e.graphics3DSymbolLayer.lodRenderer;if(null==a)return 0;const n=t.centerPointInElevationSR;s(n,Kt);const l="absolute-height"!==t.mode?Kt.sampledElevation:0,c=a.instanceData,u=e.instanceIndex,h=Xt;c.getGlobalTransform(u,h);const d=o(Yt,h[12],h[13],h[14]);N.TESTS_DISABLE_OPTIMIZATIONS?(Zt[0]=n.x,Zt[1]=n.y,Zt[2]=Kt.z,D(n.spatialReference,Zt,h,i.spatialReference)&&c.setGlobalTransform(u,h)):i.setAltitudeOfTransformation(Kt.z,h);const p=Wt/i.unitInMeters;return(N.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(h[12]-d[0])>=p||Math.abs(h[13]-d[1])>=p||Math.abs(h[14]-d[2])>=p)&&c.setGlobalTransform(u,h),l}function $t(e,t,r,s,i){const a=e.stageObject,n=a.geometries;if(0===n.length)return 0;let o=0,l=null,c=0,u=!1;for(const e of n){if(!Vt(e))continue;const n=e.attributes.get("position");if(n!==l){const{update:a,averageGeometrySampledElevation:o}=er(e,t,r,s,i);c=o,l=n,u=a}u&&a.geometryVertexAttributeUpdated(e,"position"),o+=c}return o/n.length}const Wt=.01,Zt=c(),Qt=c(),Jt=c(),Xt=j(),Yt=c(),Kt=new A;function er(e,t,r,s,i){let a=!1;const n=e.transformation,o=t.requiresSampledElevationInfo;Qt[0]=n[12],Qt[1]=n[13],Qt[2]=n[14],e.invalidateBoundingInfo();const l=e.getMutableAttribute("position"),c=l.data,u=l.size,h=c.length/u,d=new k(e.mapPositions,r);let p=0,m=0;for(let e=0;e<h;e++){if(Jt[0]=c[p],Jt[1]=c[p+1],Jt[2]=c[p+2],s(d,Kt),o&&(m+=Kt.sampledElevation),N.TESTS_DISABLE_OPTIMIZATIONS)c[p]=d.array[d.offset],c[p+1]=d.array[d.offset+1],c[p+2]=Kt.z,F(c,r,p,c,i.spatialReference,p,1),c[p]-=Qt[0],c[p+1]-=Qt[1],c[p+2]-=Qt[2],a=!0;else{Zt[0]=c[p]+Qt[0],Zt[1]=c[p+1]+Qt[1],Zt[2]=c[p+2]+Qt[2],i.setAltitude(Zt,Kt.z),c[p]=Zt[0]-Qt[0],c[p+1]=Zt[1]-Qt[1],c[p+2]=Zt[2]-Qt[2];const e=Wt/i.unitInMeters;(Math.abs(Jt[0]-c[p])>=e||Math.abs(Jt[1]-c[p+1])>=e||Math.abs(Jt[2]-c[p+2])>=e)&&(a=!0)}p+=u,d.offset+=3}return m/=h,{update:a,averageGeometrySampledElevation:m}}class tr{constructor(e,t,r){this.graphic=e,this.renderingInfo=t,this.layer=r}}class rr{constructor(e,t,r){this.baseMaterial=e,this.edgeMaterial=t,this.hasSlicePlane=r}}class sr{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,r,s,i,a=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._sharedResource=r,this.elevationAligner=s,this.elevationContext=i,this._edgeState=a,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e}destroy(){if(!this._stageLayer)return;const e=this._stageLayer.stage;this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),e.renderer.edgeView?.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource?.release(),this._visible=!1,this._stageLayer=null}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}layerOpacityChanged(e,t){const{stageObject:r,_edgeState:s,_stageLayer:i}=this;if(null==s)return;const a=ir(s.baseMaterial);s.edgeMaterial.objectTransparency!==a&&(s.edgeMaterial.objectTransparency=a,this.resetEdgeObject(t)),i.stage.renderer.withEdgeView(t=>t.updateAllComponentOpacities(r,[e]))}updateHighlights(e){}slicePlaneEnabledChanged(e,t){const{stageObject:r,_edgeState:s,_stageLayer:i}=this;null!=s&&i.stage.renderer.withEdgeView(i=>{i.updateAllComponentMaterials(r,s.edgeMaterial,e,!t),s.hasSlicePlane=e})}setVisibility(e){const{_edgeState:t,stageObject:r,_stageLayer:s}=this;null!=s&&this.visible!==e&&(this._visible=e,r.visible=e,e&&!this._addedToStage&&(s.add(r),this._addedToStage=!0),null!=t&&s.stage.renderer.withEdgeView(s=>{s.hasObject(r)?s.updateObjectVisibility(r,e):e&&this._addOrUpdateEdgeObject(t,s,!1)}))}get visible(){return this._visible}alignWithElevation(e,t,r,s){null!=this.elevationAligner&&(null!=r&&z(this.elevationContext.featureExpressionInfoContext,r),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,(r,s)=>R(r,e,this.elevationContext,t,s),t),this.resetEdgeObject(s))}alignWithAbsoluteElevation(e,t,r){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,(t,r)=>{r.sampledElevation=e,r.verticalDistanceToGround=0,r.z=e},t),this.resetEdgeObject(r)}getCenterObjectSpace(e=c()){return r(e,Pt(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=ve()){const t=this.stageObject.boundingVolumeObjectSpace;return _e(e,t.min),Se(e,t.max),e}computeAttachmentOrigin(e){const t=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++;else for(const r of this.stageObject.geometries)r.computeAttachmentOrigin(or)&&(l(or,or,t),n(e.render.origin,e.render.origin,or),e.render.num++)}async getProjectedBoundingBox(e,t,r,s,i){const a=this.getBoundingBoxObjectSpace(i),n=lr,o=Pe(a)?1:n.length;for(let e=0;e<o;e++){const t=n[e];nr[0]=a[t[0]],nr[1]=a[t[1]],nr[2]=a[t[2]],l(nr,nr,this.stageObject.transformation),ar[3*e]=nr[0],ar[3*e+1]=nr[1],ar[3*e+2]=nr[2]}if(!e(ar,0,o))return null;xe(a);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let e=0;e<3*o;e+=3){for(let t=0;t<3;t++)a[t]=Math.min(a[t],ar[e+t]),a[t+3]=Math.max(a[t+3],ar[e+t]);c&&r.push({location:ar.slice(e,e+3),screenSpaceBoundingRect:c})}if(t?.service&&"absolute-height"!==this.elevationContext.mode){Oe(a,or);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let r=0;if(t.useViewElevation)r=t.service.getElevation(or[0],or[1],e)??0;else try{const i=pe(a,t.service.spatialReference,t);r=await t.service.queryElevation(or[0],or[1],s,i,e)??0}catch(e){}Ee(a,0,0,-this.alignedSampledElevation+r)}return a}addObjectState(e){0===e.stateType&&e.addObject(this.stageObject,this.stageObject.highlight(e.highlightName)),1===e.stateType&&e.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeByObject(this.stageObject)}resetEdgeObject(e){const{_edgeState:t,stageObject:r,_stageLayer:s,_visible:i}=this;null!=t&&s.stage.renderer.withEdgeView(s=>{i?this._addOrUpdateEdgeObject(t,s,e):s.removeObject(r)})}_addOrUpdateEdgeObject(e,t,r){const s=ir(e.baseMaterial);e.edgeMaterial.objectTransparency=s,t.addOrUpdateObject3D(this.stageObject,e.edgeMaterial,e.hasSlicePlane,!r).then(()=>this._stageLayer?.sync())}}function ir(e){return e.transparent?0:1}const ar=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],nr=c(),or=c(),lr=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];class cr{constructor(e,t=null){this.labelText=t,this.elevationOffset=e??0}}const ur=3,hr=3,dr=10;class pr{constructor(e){this.estimated=!1,this.verticesPerFeature=e.verticesPerFeature??0,this.verticesPerCoordinate=e.verticesPerCoordinate??0,this.drawCallsPerFeature=e.drawCallsPerFeature??0,this.memory=e.memory??new gr}}class mr extends pr{constructor(e){super(e),this.estimated=!0}}class yr extends pr{constructor(e,t){super(t),this.numComplexities=e}}class fr extends mr{constructor(e,t){super(t),this.numComplexities=e}}class gr{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}}const br=new mr({});function vr(e){return"web-style"===e.type?br:_r(e.symbolLayers.toArray().map(t=>xr(e,t)))}function _r(e){let t=0,r=0,s=0,i=!1,a=0;const n=new gr;for(const o of e)null!=o&&(t+=o.verticesPerFeature,r+=o.verticesPerCoordinate,s+=o.drawCallsPerFeature,n.bytesPerFeature+=o.memory.bytesPerFeature,n.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,n.resourceBytes+=o.memory.resourceBytes,n.draped.bytesPerFeature+=o.memory.bytesPerFeature,n.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,i=i||o.estimated,++a);return i?new fr(a,{verticesPerFeature:t,verticesPerCoordinate:r,drawCallsPerFeature:s,memory:n}):new yr(a,{verticesPerFeature:t,verticesPerCoordinate:r,drawCallsPerFeature:s,memory:n})}function Sr(e){const t=_r(e);return t.numComplexities>0&&(t.verticesPerFeature/=t.numComplexities,t.verticesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.resourceBytes/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities),t}const Pr={};function xr(e,t){const r=Or(e,t),s=fe(t)?2:0;switch(t.type){case"extrude":return new pr({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:s,memory:r});case"fill":if("mesh-3d"===e.type)return new pr({drawCallsPerFeature:s,memory:r});if(null!=t.outline&&t.outline.size>0)return new pr({verticesPerFeature:-12,verticesPerCoordinate:9,memory:r});case"water":return new pr({verticesPerFeature:-6,verticesPerCoordinate:3,memory:r});case"line":return new pr({verticesPerFeature:-6,verticesPerCoordinate:6,memory:r});case"object":return t.resource?.href?new mr({verticesPerFeature:100,memory:r}):{...Er(t.resource?.primitive??xt),memory:r};case"path":{let e=0,s=0;switch(t.profile){case"circle":e=10;break;case"quad":e=4;break;default:return void g(t.profile)}switch(t.join){case"round":s=3;break;case"miter":case"bevel":s=1;break;default:return}const i=2*e,a=e*s*2,n=a+i;let o=-2*a-i;switch(t.cap){case"none":break;case"butt":case"square":o+=2*(e-1);break;case"round":o+=2*(2*e*2+e);break;default:return}return new pr({verticesPerFeature:o,verticesPerCoordinate:n,memory:r})}case"text":{const t="label-3d"===e.type?0:2;return new pr({verticesPerFeature:6,memory:r,drawCallsPerFeature:t})}case"icon":return new pr({verticesPerFeature:6,memory:r});default:return}}function Or(e,t){const r="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?Lr.EXTRUDE_EDGES:Lr.EXTRUDE;case"fill":return null!=t.outline&&t.outline.size>0?Lr.FILL_OUTLINE:Lr.FILL;case"water":return Lr.FILL;case"line":return"round"===t.join?Lr.LINE_ROUND:Lr.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return Lr.PATH_ROUND_CIRCLE;case"quad":return Lr.PATH_ROUND_QUAD;default:return void g(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return Lr.PATH_MITER_CIRCLE;case"quad":return Lr.PATH_MITER_QUAD;default:return void g(t.profile)}default:return}case"object":return r?Lr.OBJECT_POINT:Lr.OBJECT_POLYGON;case"icon":case"text":return r?Lr.ICON_POINT:Lr.ICON_POLYGON;default:return}}function Er(e){const t=Pr[e];if(t)return t;const r=Cr(Ot(e,new Et({},{spherical:!0})).levels);return Pr[e]=new pr({verticesPerFeature:r}),Pr[e]}function Cr(e){return e.reduce((e,t,r)=>e+t.numVertices*(1/10**r),0)/e.reduce((e,t,r)=>e+1/10**r,0)}const Lr={ICON_POINT:{bytesPerFeature:3063,bytesPerFeatureLabel:3813,resourceBytes:0,draped:{bytesPerFeature:2010,bytesPerFeatureLabel:3851}},ICON_POLYGON:{bytesPerFeature:3222,bytesPerFeatureLabel:2792,resourceBytes:0,draped:{bytesPerFeature:1408,bytesPerFeatureLabel:2523}},OBJECT_POINT:{bytesPerFeature:477,bytesPerFeatureLabel:3260,resourceBytes:0,draped:{bytesPerFeature:477,bytesPerFeatureLabel:3260}},OBJECT_POLYGON:{bytesPerFeature:586,bytesPerFeatureLabel:2250,resourceBytes:0,draped:{bytesPerFeature:586,bytesPerFeatureLabel:2250}},LINE_MITER:{bytesPerFeature:1660,bytesPerFeatureLabel:2326,resourceBytes:0,draped:{bytesPerFeature:1221,bytesPerFeatureLabel:1970}},LINE_ROUND:{bytesPerFeature:544,bytesPerFeatureLabel:2173,resourceBytes:0,draped:{bytesPerFeature:383,bytesPerFeatureLabel:1808}},PATH_MITER_CIRCLE:{bytesPerFeature:22559,bytesPerFeatureLabel:2885,resourceBytes:0,draped:{bytesPerFeature:22559,bytesPerFeatureLabel:2885}},PATH_ROUND_CIRCLE:{bytesPerFeature:25707,bytesPerFeatureLabel:2666,resourceBytes:0,draped:{bytesPerFeature:25707,bytesPerFeatureLabel:2666}},PATH_MITER_QUAD:{bytesPerFeature:24444,bytesPerFeatureLabel:3248,resourceBytes:0,draped:{bytesPerFeature:24444,bytesPerFeatureLabel:3248}},PATH_ROUND_QUAD:{bytesPerFeature:24060,bytesPerFeatureLabel:3228,resourceBytes:0,draped:{bytesPerFeature:24060,bytesPerFeatureLabel:3228}},FILL:{bytesPerFeature:3558,bytesPerFeatureLabel:2829,resourceBytes:0,draped:{bytesPerFeature:1418,bytesPerFeatureLabel:2381}},FILL_OUTLINE:{bytesPerFeature:3793,bytesPerFeatureLabel:2371,resourceBytes:0,draped:{bytesPerFeature:1583,bytesPerFeatureLabel:2050}},EXTRUDE:{bytesPerFeature:4051,bytesPerFeatureLabel:2286,resourceBytes:0,draped:{bytesPerFeature:4051,bytesPerFeatureLabel:2286}},EXTRUDE_EDGES:{bytesPerFeature:3037,bytesPerFeatureLabel:1960,resourceBytes:0,draped:{bytesPerFeature:3037,bytesPerFeatureLabel:1960}}};if(b("esri-tests-disable-symbol-memory-estimators"))for(const e in Lr){const t=Lr[e];t.bytesPerFeature=0,t.bytesPerFeatureLabel=0,t.draped.bytesPerFeature=0,t.draped.bytesPerFeatureLabel=0}class wr{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=0,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){return 1===this._loadStatus?(e&&e(),this._loader??Promise.resolve()):2===this._loadStatus?(t&&t(this._loadError),this._loader??Promise.resolve()):(null==this._loader&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=1},e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=2,!at(e)&&this.logger&&e.message&&this.logger.warn(e.message),e})),this._loader.then(e,t).catch(()=>{}),this._loader)}abortLoad(){null!=this._abortController?this._abortController=Ct(this._abortController):0===this._loadStatus&&(this._loadStatus=2),this._loader=null}}const jr=()=>p.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class Dr extends wr{constructor(e,t,r,s,i=!0){super(r.schedule),this.symbol=e,this.symbolLayer=t,this._context=r,this._drivenOpacityFallbackAlwaysOpaque=i,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1,rotation:!1},this._materials=[],this.logger=jr(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new G,this.updateComplexity(),this.ignoreDrivers=s.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=Fr(this._context.renderer,i)),this._updateElevationContext()}destroy(){this.complexity=null,this._materials.length=0,super.destroy()}get view(){return this._context.stage.view}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}get estimatedMemory(){const{complexity:e}=this;return null==e?0:(this.draped?e.memory.draped:e.memory).bytesPerFeature}get usedMemory(){return this.estimatedMemory}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;const t=this._drivenProperties,r=Fr(e,this._drivenOpacityFallbackAlwaysOpaque);return r.color!==t.color||r.opacity!==t.opacity||r.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||r.size!==t.size||r.rotation!==t.rotation}get needsDrivenTransparentPass(){return this._hasDrivenColorOrOpacity&&!this._drivenProperties.opacityAlwaysOpaque}get _hasDrivenColorOrOpacity(){return this._drivenProperties.color||this._drivenProperties.opacity}_logGeometryCreationWarnings(e,t,r,s){const i=e.projectionSuccess,a="polygons"in e?e.polygons:null,n=`${s} geometry failed to be created`;i?!this._logGeometryValidationWarnings(t,r,s)&&a&&0===a.length&&"rings"===r&&t.length>0&&t[0].length>2&&jr().warnOncePerTick(`${n} (filled rings should use clockwise winding - try reversing the order of vertices)`):jr().warnOncePerTick(`${n} (failed to project geometry to view spatial reference)`)}updateFocus(e,t){}_logGeometryValidationWarnings(e,t,r){const s=`${r} geometry failed to be created`;return!e.length||1===e.length&&!e[0].length?(jr().warnOncePerTick(`${s} (no ${t} were defined)`),!0):!(Array.isArray(e)&&Array.isArray(e[0])||(jr().warnOncePerTick(`${s} (${t} should be defined as a 2D array)`),0))}_validateGeometry(e,t=null,r=null){if(null!=t&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+r+` symbol: ${e.type}`),!1;switch(e.type){case"point":{const t=e;if(!isFinite(t.x)||!isFinite(t.y))return jr().warn("point coordinate is not a valid number, graphic skipped"),!1;break}case"polygon":ue(e)}return!0}_defaultElevationInfoNoZ(){return Ar}_defaultElevationInfoZ(){return Tr}_updateElevationContext(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t=new G){const r=e.geometry,s=this.getDefaultElevationInfo(r);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:s.unit,t.mode=this.getGeometryElevationMode(r,s),t.offsetMeters=this._elevationContext.meterUnitOffset??s.offset??0;const i=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;i&&(t.mode="relative-to-ground",t.offsetMeters=0);const a=i?I:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(a,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}updateTransform(e,t,r,s){return!1}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,t=zr){const r=this.draped?1:this._getLayerOpacity();return this._drivenProperties.color?r:e?r*(this._drivenProperties.opacity?1:e.a):t.hasIntrinsicColor?r:0}_getCombinedOpacityAndColor(e,t=zr){const r=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return me(null,r);const s=null!=e?f.toUnitRGB(e):u;return me(s,r)}_getDrivenUInt8Color({color:e,opacity:t},r,s){const{color:i,opacity:a}=this._drivenProperties,n=f.toUnitRGBA(r)??(s?O:E),o=i?e??n:null,l=e||r||s,c=i?null:n[3];return me(o,a&&l?t??c:null,255)}_getDrivenUInt8ColorWithNaNSupport({color:e,opacity:t},r,s){const i=r?C(f.toUnitRGBA(r)):x(NaN,NaN,NaN,s?NaN:0);return this._drivenProperties.color&&null!=e&&le(i,e),this._drivenProperties.opacity&&null!=t&&(i[3]=t),ce(i,i,255),ge(i,i)}isFastUpdatesEnabled(){return null!=this._fastUpdates}updateComplexity(){this.complexity=this.computeComplexity()}computeComplexity(){return xr(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,r){switch(e){case"opacity":return this.layerOpacityChanged(t,r),!0;case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),2!==this.layerElevationInfoChanged(t,r,e)}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,r);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,t,r){let s=1;return e?.forEach(e=>{const i=t(e);if(null!=i){const t=e.graphic;this.setGraphicElevationContext(t,i.elevationContext),i.needsElevationUpdates=r(i.elevationContext.mode)}else s=2}),s}applyRendererDiff(e,t){return 0}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;const t=this._fastUpdates.visualVariables,r=t.size?q(t.size.field,e):0,s=t.color?q(t.color.field,e):0,i=t.opacity?q(t.opacity.field,e):0;return x(r,s,i,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&jr().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null})}}}function Fr(e,t){const r={color:!1,opacity:!1,opacityAlwaysOpaque:t,size:!1,rotation:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach(e=>{switch(e.type){case"color":if(r.color=!0,e.stops)for(let t=0;t<e.stops.length;t++){const s=e.stops[t].color;s&&s.a<1&&(r.opacityAlwaysOpaque=!1)}break;case"opacity":r.opacity=!0,r.opacityAlwaysOpaque=!1;break;case"size":r.size=!0;break;case"rotation":r.rotation=!0}}),r}const Ar={mode:"on-the-ground",offset:0,unit:"meters"},Tr={mode:"absolute-height",offset:0,unit:"meters"},zr={hasIntrinsicColor:!1},Rr=x(NaN,NaN,NaN,NaN);function Gr(e,t,r,s,i){if(Br(e,t))return null;r.localOrigin=Vr(e,t);const a=new ze({geometries:[r],castShadow:!1,layerViewUid:e.layerViewUid,graphicUid:i,usesVerticalDistanceToGround:!0});return{object:a,sampledElevation:B(a,t,e.elevationProvider,e.renderCoordsHelper,s)}}function Ir(e,t,r,s){return Br(t,r)?null:B(e,r,t.elevationProvider,t.renderCoordsHelper,s)}function Br(e,t){const r=e.clippingExtent;return!!r&&(be(t,Nr,e.elevationProvider.spatialReference),!Ce(r,Nr))}function Ur(e,t,r){const s=e.elevationContext,i=r.spatialReference;be(t,Nr,i),s.centerPointInElevationSR=Te(Nr[0],Nr[1],t.hasZ?Nr[2]:0,null!=i?i:null)}function Mr(e){switch(e.type){case"point":return e;case"polygon":case"extent":return ye(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const r=he(t,de(t)/2);return Te(r[0],r[1],r[2],e.spatialReference)}case"mesh":return e.extent.center}return null}function Vr(e,t){return be(t,Nr,e.renderCoordsHelper.spatialReference),e.localOriginFactory.getOrigin(Nr)}const Nr=c();function kr(e){e.include(H),e.uniforms.add(new $("geometryDepthTexture",e=>e.geometryDepth?.attachment)),e.code.add(We`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);
return (elementDepth < (geometryDepth - 1.0));
}`)}const qr=e(),Hr=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new Xe,{vertex:r,fragment:s}=t,{terrainDepthTest:i}=e;return r.include(qe),t.include(He,e),t.vertex.include(W,e),t.attributes.add("uv0","vec2"),r.uniforms.add(new Z("viewport",e=>e.camera.fullViewport),new Ue("lineSize",(e,t)=>e.size>0?Math.max(1,e.size)*t.camera.pixelRatio:0),new Q("pixelToNDC",e=>Ne(qr,2/e.camera.fullViewport[2],2/e.camera.fullViewport[3])),new Ue("borderSize",(e,t)=>e.borderColor?t.camera.pixelRatio:0),new Je("screenOffset",(e,t)=>Ne(qr,e.horizontalScreenOffset*t.camera.pixelRatio,0))),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),i&&t.varyings.add("depth","float"),e.occlusionTestEnabled&&t.include($e),e.hasScreenSizePerspective&&Qe(r),r.main.add(We`
    ProjectHUDAux projectAux;
    vec4 endPoint = projectPositionHUD(projectAux);

    vec3 vpos = projectAux.posModel;
    if (rejectBySlice(vpos)) {
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
    ${Ze(e.occlusionTestEnabled,We`if (!testHUDVisibility(endPoint)) {
             gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
             return;
           }`)}

    ${e.hasScreenSizePerspective?We`vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
               vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);`:"vec2 screenOffsetScaled = screenOffset;"}
    // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the
    // correct depth value
    vec3 posView = (view * vec4(position, 1.0)).xyz;
    ${Ze(i,"depth = posView.z;")}

    applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);
    vec4 startPoint = proj * vec4(posView, 1.0);

    // Apply screen offset to both start and end point
    vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
    startPoint.xy += screenOffsetNorm * startPoint.w;
    endPoint.xy += screenOffsetNorm * endPoint.w;

    // Align start and end to pixel origin
    vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
    vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${Ze(e.hudDepth,e.hudDepthAlignStart?"endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);":"startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);")}
    vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);

    // The direction of the line in screen space
    vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
    vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.hasScreenSizePerspective?We`float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
               float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);`:We`float lineSizeScaled = lineSize;
               float borderSizeScaled = borderSize;`}
    float halfPixelSize = lineSizeScaled * 0.5;

    // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
    float padding = 1.0 + borderSizeScaled;
    vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

    // Offset x/y from the center of the line in screen space
    projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

    // Compute a coverage varying which we can use in the fragment shader to determine
    // how much a pixel is actually covered by the line (i.e. to anti alias the line).
    // This works by computing two coordinates that can be linearly interpolated and then
    // subtracted to find out how far away from the line edge we are.
    float edgeDirection = (uv0.x * 2.0 - 1.0);

    float halfBorderSize = 0.5 * borderSizeScaled;
    float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
    float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

    float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

    coverageSampling = vec4(
      // Edge coordinate
      outerEdgeCoverageSampler,

      // Border edge coordinate
      outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

      // Line offset
      halfPixelSize - 0.5,

      // Border offset
      halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
    );

    lineSizes = vec2(lineSizeScaled, borderSizeScaled);
    gl_Position = projectedPosition;`),s.uniforms.add(new J("uColor",e=>e.color??E),new J("borderColor",e=>e.borderColor??E)),i&&(s.include(kr,e),s.uniforms.add(new Q("inverseViewport",e=>e.inverseViewport))),s.main.add(We`
    ${Ze(i,"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }")}

    vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

    float borderAlpha = uColor.a * borderColor.a * coverage.y;
    float colorAlpha = uColor.a * coverage.x;

    float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);
    ${Ze(!e.hudDepth,We`vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
           fragColor = vec4(finalRgb, finalAlpha);`)}`),t}},Symbol.toStringTag,{value:"Module"}));class $r extends X{constructor(e,t){super(e,t,new Y(Hr,()=>Promise.resolve().then(()=>Hr)),Wr.locations)}initializePipeline(e){const{hudDepth:t,terrainDepthTest:r}=e,s={func:r?519:513};return Ye(t?{depthTest:s,depthWrite:Ke}:{blending:tt(1,770,771,771),depthTest:s,colorWrite:et})}}const Wr=Ve().vec3f("position").vec3f("normal").vec2f16("uv0").vec4f("centerOffsetAndDistance");class Zr extends K{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.terrainDepthTest=!1,this.draped=!1}}rt([ee()],Zr.prototype,"screenCenterOffsetUnitsEnabled",void 0),rt([ee()],Zr.prototype,"occlusionTestEnabled",void 0),rt([ee()],Zr.prototype,"hasVerticalOffset",void 0),rt([ee()],Zr.prototype,"hasScreenSizePerspective",void 0),rt([ee()],Zr.prototype,"hudDepth",void 0),rt([ee()],Zr.prototype,"hudDepthAlignStart",void 0),rt([ee()],Zr.prototype,"terrainDepthTest",void 0);class Qr extends te{constructor(e,t){super(e,Yr),this.intersectDraped=void 0,this.produces=new Map([[15,e=>Me(e)],[16,e=>Me(e)]]),this._configuration=new Zr(t),this._uniqueMaterialIdentifier=Jr(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.hudDepth=16===t.slot,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration}get visible(){return this.parameters.color[3]>=st||(this.parameters.borderColor?.[3]??0)>=st}intersect(){}createGLMaterial(e){return new Xr(e)}createBufferWriter(){return new es}validateParameters(e){this._uniqueMaterialIdentifier=Jr(e)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}}function Jr({renderOccluded:e,isDecoration:t,horizontalScreenOffset:r,color:s,size:i,occlusionTest:a,shaderPolygonOffset:n,hudDepthAlignStart:o,centerOffsetUnits:l,hasSlicePlane:c,screenSizePerspective:u,verticalOffset:h,borderColor:d}){return Ie`${e}:${t}:${r}:[${s}]:${i}:${a}:${n}:${o}:${l}:${c}:${null!=u}:{${h?.screenLength}:${h?.minWorldLength}:${h?.maxWorldLength}}:[${d}]`}class Xr extends se{beginSlot(e){return this.getTechnique($r,e)}}class Yr extends re{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=x(0,0,0,1),this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const Kr=[Be(0,0),Be(1,0),Be(0,1),Be(1,0),Be(1,1),Be(0,1)];class es{constructor(){this.layout=Wr}elementCount(e){return 6*e.get("position").indices.length}write(e,t,r,s,i,a){ie(r.get("position"),e,i.position,a,6),ae(r.get("normal"),t,i.normal,a,6),ne(r.get("centerOffsetAndDistance"),i.centerOffsetAndDistance,a,6);for(let e=0;e<Kr.length;++e)i.uv0.setVec(a+e,Kr[e]);return null}}class ts extends Dr{static{this.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:1,onTheGroundChanged:2}}constructor(e,t){super(e,null,t,is),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new Qr(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const e=new Yr,t=this.symbol,r=t.callout;if(r.color){const t=f.toUnitRGBA(r.color);t[3]*=this._getLayerOpacity(),e.color=t}else e.color=E;if(e.size=P(r.size||0),t.verticalOffset){const{screenLength:r,minWorldLength:s,maxWorldLength:i}=t.verticalOffset;e.verticalOffset={screenLength:P(r),minWorldLength:s||0,maxWorldLength:null!=i?i:1/0}}e.borderColor=null!=r.border?.color?f.toUnitRGBA(r.border.color):null;const s="object"===t.symbolLayers.at(0).type,i="label-3d"===t.type;return e.occlusionTest=!s&&!!b("disable-feature:non-occluded-hud"),s&&(e.shaderPolygonOffset=0),e.hudDepthAlignStart=i,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return ss}createGraphics3DGraphic(e,t){const r=e.renderingInfo,s=e.graphic,i=this.setGraphicElevationContext(s,new G,r.elevationOffset||0),a=r.symbol,n="on-the-ground"===this._elevationContext.mode&&("cim"===a.type||!a.symbolLayers.some(e=>"object"===e.type||"text"===e.type));if("label-3d"!==a.type&&n)return null;if("point-3d"===a.type&&a.symbolLayers.every(e=>"text"===e.type&&!m(e)))return null;const o=ye(s.geometry);return null==o?null:this._createAs3DShape(o,i,r,s.uid,t)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,r){const s=this._elevationContext.mode,i=U(ts.elevationModeChangeTypes,r,s);return 1!==i||e?.forEach(e=>{const r=t(e);null!=r&&this.updateGraphicElevationContext(e.graphic,r)}),i}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t,r=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(r),t}updateGraphicElevationContext(e,t){const{elevationContext:r,metadata:s}=t;this.setGraphicElevationContext(e,r,s?.elevationOffset??0),t.needsElevationUpdates=M(r.mode)}computeComplexity(){return new pr({verticesPerFeature:6})}_getOrCreateMaterial(e,t){const r=this._perInstanceMaterialParameters(e),s=Jr(r);if(s===this._materials[0]?.uniqueMaterialIdentifier)return this._materials[0];if(t){let e=t.get(s);return null==e&&(e=new Qr(r,this._context.spherical),t.set(s,e)),e}return new Qr(r,this._context.spherical)}_createAs3DShape(e,t,r,s,i){const a=this._context.layerViewUid,n=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerViewUid:a}),o=this._getOrCreateMaterial(r,i),l=new oe(o,function(e){const{translation:t,centerOffset:r}=e,s=new Ge(t?[t[0],t[1],t[2]]:[0,0,0],rs,3,!0),i=new Ge(r?[r[0],r[1],r[2],r[3]]:[0,0,0,1],rs,4,!0);return[["position",s],["normal",new Ge([0,0,1],rs,3,!0)],["centerOffsetAndDistance",i]]}(r),null,1,n),c=Gr(this._context,e,l,t,s);if(null==c)return null;const u=new sr(this,c.object,null,kt,t);return u.metadata=new cr(r.elevationOffset),u.alignedSampledElevation=c.sampledElevation,u.needsElevationUpdates=M(t.mode),Ur(u,e,this._context.elevationProvider),u}}const rs=[0],ss={mode:"relative-to-ground",offset:0},is={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class as extends Mt{constructor(e,t,r=c(),s=L(),i=0,a="world",n=0){super(e,t),this.translation=r,this.centerOffset=s,this.horizontalScreenOffset=i,this.centerOffsetUnits=a,this.elevationOffset=n}}class ns extends tr{}const os=()=>p.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function ls(e,t){if(!y(e))return os().error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const r=cs[e.callout.type];return r?new r(e,t):(os().error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}const cs={line:ts},us=new dt(Array,e=>De(e,Fe),null,10,5),hs=yt();class ds{get labelLayers(){return this._labelLayers||v}get extent(){return this._extent}get isElevationSource(){return this.layers.some(e=>e?.isElevationSource)}constructor(e,t,r,s,i){this.graphic=e,this.graphics3DSymbol=t,this.layers=r,this._visibleFlags=255,++t.referenced,this._featureExpressionFeature=i?V(i,e,s):null}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic(t=>{t.initialize(e),t.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(16))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(t=>{"draped"===t.type&&(e=!0)}),e}isVisible(e=1,t){const r=t?this._visibleFlags|t|16*t:this._visibleFlags;return 1===e?!(15&~r):!(255&~r)}setVisibilityFlag(e,t,r){const s=this.isVisible(e);r?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);const i=this.isVisible(e);if(s===i)return!1;if(16===e)this._forEachLabelGraphic(e=>e.setVisibility(i));else{this._forEachSymbolLayerGraphic(e=>e.setVisibility(i));const e=this.isVisible(16);this._forEachLabelGraphic(t=>t.setVisibility(e))}return!0}getVisibilityFlag(e,t){return 0!==(this._visibleFlags&e*t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(null==t)return!1;this._extent=yt(),_t(t,this._extent);const r=t.spatialReference;if(!bt(r,e)&&!mt(this._extent,r,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,r){let s=e.geometry;return"mesh"!==s.type&&"extent"!==s.type||(s=pt.fromExtent("mesh"===s.type?s.extent:s)),St(s,t,r)}get usedMemory(){let e=ht(this.graphic.attributes);return this._forEachSymbolLayerGraphic(t=>e+=t.usedMemory),e}computeAttachmentOrigin(){const t={render:{origin:c(),num:0},draped:{origin:e(),num:0}};for(const e of this.layers)null!=e&&e.computeAttachmentOrigin(t);return t.render.num>1&&i(t.render.origin,t.render.origin,1/t.render.num),t.draped.num>1&&ke(t.draped.origin,t.draped.origin,1/t.draped.num),t}async getProjectedBoundingBox(e,t,r,s,i){return i||(i={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),i.boundingBox?xe(i.boundingBox):i.boundingBox=xe(),i.requiresDrapedElevation=!1,await it(this.layers,async a=>{if(null==a)return;const n="draped"===a.type?t:e,o=us.acquire(),l=await a.getProjectedBoundingBox(n,r,i.screenSpaceObjects,s,o);isFinite(l[2])&&isFinite(l[5])||(i.requiresDrapedElevation=!0),l&&Le(i.boundingBox,o),us.release(o)}),we(i.boundingBox)||ft(je(i.boundingBox,hs))?i:null}needsElevationUpdates(){for(const e of this.layers)if(null!=e&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;return this._labelLayers?.some(e=>e?.needsElevationUpdates??!1)??!1}alignWithElevation(e,t,r){this._forEachRenderedGraphic(s=>{"object3d"!==s.type&&"lod-instance"!==s.type||s.alignWithElevation(e,t,this._featureExpressionFeature,r)})}alignWithAbsoluteElevation(e,t,r){this._forEachRenderedGraphic(s=>{"object3d"===s.type&&s.alignWithAbsoluteElevation(e,t,r)})}addObjectStateSet(e){this._forEachSymbolLayerGraphic(t=>t.addObjectState(e))}removeObjectState(e){this._forEachSymbolLayerGraphic(t=>t.removeObjectState(e))}updateHighlights(e){this._forEachSymbolLayerGraphic(t=>t.updateHighlights(e))}_forEachGraphicList(e,t){e?.forEach(e=>e&&t(e))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this.labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}}class ps{constructor(e,t,r,s){this.scheduler=e,this.schedule=t,this.layerViewUid=r,this.compressionTracker=s,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return 1===this.stage.view.state.viewingMode}}function ms(e){return 2216+4096*e.symbolLayers.length+e.complexity.memory.resourceBytes}class ys extends wr{set symbol(e){this._symbol=e,e.symbolLayers.forEach((t,r)=>{const s=this.symbolLayers[r];null!=s&&(s.symbol=e,s.symbolLayer=t)})}get symbol(){return this._symbol}constructor(e,t,r){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const r=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const s=[];if(!fs){const{make:e}=await import("./Graphics3DSymbolLayerFactory.js");fs=e}for(let i=0;i<r;i++){const a=t.at(i);if(!1===a.enabled)continue;gs.renderPriority=1-(1+i)/r,gs.renderPriorityStep=1/r,gs.ignoreDrivers=a.ignoreDrivers;const n=fs(this.symbol,a,this._context,gs),o=nt(e,()=>{this.symbolLayers[i]=null,n.destroy()});o&&s.push(o),this.symbolLayers[i]=n}if(await it(this.symbolLayers,async(e,t)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}}),s.forEach(e=>e.remove()),ot(e),this.symbolLayers.length&&!this.symbolLayers.some(e=>!!e))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return null!=t?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>e?.queryForSnapping)}updateFocus(e,t){this.symbolLayers.forEach(r=>r?.updateFocus(e,t))}createGraphics3DGraphic(e,t){const{graphic:r}=e,s=this.symbolLayers.map(t=>t?.createGraphics3DGraphic(e)??null),i=this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null;return new ds(r,t||this,s,e.layer,i)}get complexity(){return _r(this.symbolLayers.map(e=>e?.complexity))}globalPropertyChanged(e,t){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const r=this.symbolLayers[s],i=e=>{const t=e.layers[s];return t instanceof sr?t:null};if(null!=r&&!r.globalPropertyChanged(e,t,i))return!1}return!0}applyRendererDiff(e,t){return 1!==this.loadStatus?0:this.symbolLayers.reduce((r,s)=>0!==r&&null!=s?Math.min(r,s.applyRendererDiff(e,t)):r,2)}prepareSymbolPatch(e){if(2===this.loadStatus)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const r=t.symbolLayers.diff;this.symbolLayers.forEach((t,s)=>{if(null==t)return;const i=r[s];if(i){const r={diff:i,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(r),e.symbolStatePatches.push(...r.symbolLayerStatePatches),r.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((e,t)=>{const i=e.layers[s];null!=i&&r.graphics3DGraphicPatches.forEach(e=>e(i,t))})}})}updateGeometry(e,t){return this._updateGeometryOrTransform(e,(e,r)=>e.updateGeometry(r,t))}updateTransform(e,t,r,s){return this._updateGeometryOrTransform(e,(e,i)=>e.updateTransform(i,t,r,s))}_updateGeometryOrTransform(e,t){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(null==s)continue;const i=e.layers[r];if(!i||!t(s,i))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const r=this.symbolLayers[t];if(null==r)continue;const s=e.layers[t];null!=s&&r.onRemoveGraphic(s)}}getFastUpdateStatus(){let e=!1,t=!1;for(const r of this.symbolLayers)if(null!=r){if(0===r.loadStatus)return 3;r.isFastUpdatesEnabled()?t=!0:e=!0}return t?e?2:1:e?0:4}async queryForSnapping(e,t,r,s){const i=this.symbolLayers.filter(_).filter(e=>null!=e.queryForSnapping).map(i=>i.queryForSnapping(e,t,r,s)),a=await Promise.all(i);return ot(s),a.flat()}destroy(){if(!this.destroyed){super.destroy();for(const e of this.symbolLayers)null!=e&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get cachedMemory(){return ms(this)}}let fs=null;const gs=new class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};class bs extends wr{constructor(e,t,r){super(t),this.symbol=e,this._convert=r,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),null!=this.graphics3DSymbol&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.complexity:br}globalPropertyChanged(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return null!=this.graphics3DSymbol?this.graphics3DSymbol.applyRendererDiff(e,t):0}prepareSymbolPatch(e){null!=this.graphics3DSymbol&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.updateGeometry(e,t)}updateTransform(e,t,r,s){return this.graphics3DSymbol?.updateTransform(e,t,r,s)??!1}onRemoveGraphic(){}updateFocus(){}getFastUpdateStatus(){return this.graphics3DSymbol?.getFastUpdateStatus()??3}destroy(){null!=this.graphics3DSymbol&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}get cachedMemory(){return ms(this)}}const vs=1.2,_s=E,Ss=4;class Ps{constructor(e="scene"){this.context=e,this.extent=gt()}}const xs=Symbol("layerHandles");let Os=class extends Lt{get spatialReference(){return this.view?.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=new Ft(this.view.state.viewingMode),this._intersector.options.store=0;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this.addHandles([t.on(["layerObjectAdded","layerObjectRemoved","transformationChanged","shaderTransformationChanged"],e=>this._objectChanged(e)),t.on(["geometryAdded","geometryRemoved"],({object:e})=>this._objectChanged(e)),t.on("attributesChanged",({attribute:e,object:t})=>Re(e)&&this._objectChanged(t))],xs)}dispose(){this.removeHandles(xs)}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=vt(this.layer.spatialReference),r=Dt(e.unit??"meters");this._elevationOffset=(e.offset??0)*r/t}else this._elevationOffset=0}getElevation(e,t,r,s){if(ws[0]=e,ws[1]=t,ws[2]=r,!this._renderCoordsHelper.toRenderCoords(ws,s,ws))return p.getLogger(this).error("could not project point for elevation alignment"),null;const i=this._elevationOffset,a=this._zmin+i,n=this._zmax+i;return this._renderCoordsHelper.setAltitude(js,n,ws),this._renderCoordsHelper.setAltitude(Ds,a,ws),this._intersector.reset(js,Ds,null),this._intersector.intersect(this._intersectLayers,null,1,null,e=>!!e.lastValidElevationBB),this._intersector.results.min.getIntersectionPoint(ws)?this._renderCoordsHelper.getAltitude(ws):null}_objectChanged(e){const t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;xe(Es);const r=e.lastValidElevationBB;r.isEmpty()||this._expandExtent(t,r.min,r.max,Es);const{min:s,max:i}=e.boundingVolumeWorldSpace;this._expandExtent(t,s,i,Es),je(Es,Cs.extent),this._zmin=Math.min(this._zmin,Es[2]),this._zmax=Math.max(this._zmax,Es[5]),Cs.spatialReference=t,this.emit("elevation-change",Cs),Cs.spatialReference=null,r.assignMinMax(s,i)}_computeLayerExtent(e,t){return xe(Es),null!=e&&t.objects.forEach(t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,Es)),Es}_expandExtent(e,t,r,s){for(let i=0;i<8;++i)ws[0]=1&i?t[0]:r[0],ws[1]=2&i?t[1]:r[1],ws[2]=4&i?t[2]:r[2],this._renderCoordsHelper.fromRenderCoords(ws,ws,e),Ae(s,ws);return s}};rt([wt({constructOnly:!0})],Os.prototype,"layer",void 0),rt([wt({constructOnly:!0})],Os.prototype,"stageLayer",void 0),rt([wt({constructOnly:!0})],Os.prototype,"view",void 0),rt([wt()],Os.prototype,"spatialReference",null),Os=rt([jt("esri.views.3d.layers.support.StageLayerElevationProvider")],Os);const Es=xe(),Cs=new Ps;function Ls(){Cs.spatialReference=null}const ws=c(),js=c(),Ds=c();class Fs{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,r){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,r)}async queryElevation(e,t,r,s,i){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,i,r,s)}}class As{constructor(e,t,r,s){this.spatialReference=t,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions={...s,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(Tt.ELEVATION_QUERY,this)}destroy({completeTasks:e}={completeTasks:!1}){if(this._frameTask.remove(),this.readyToRun)if(e)this.runTask(zt);else for(const e of this._queries)e.result.reject(lt())}queryElevation(e,t,r,s=0){const i=ct(),a={x:e,y:t,minDemResolution:s,result:i,signal:r};return this._queries.push(a),ut(r,()=>{S(this._queries,a),i.reject(lt())}),i.promise}get readyToRun(){return this._queries.length>0}runTask(e){const t=this._queries;this._queries=[];const r=this._getElevationQueryProvider();if(!r)return t.forEach(e=>e.result.reject()),void e.madeProgress();const s=t.map(e=>[e.x,e.y]),i=t.reduce((e,t)=>Math.min(e,t.minDemResolution),1/0),a=new At({points:s,spatialReference:this.spatialReference}),n=t.length>1&&t.some(e=>!!e.signal)?new AbortController:null,o=null!=n?n.signal:t[0].signal;if(null!=n){let e=0;t.forEach(r=>ut(r.signal,()=>{e++,r.result.reject(lt()),e===t.length&&n.abort()}))}const l={...this._queryOptions,minDemResolution:i,signal:o};r.queryElevation(a,l).then(e=>{t.forEach((t,r)=>{null!=t.signal&&t.signal.aborted?t.result.reject(lt()):t.result.resolve(e.geometry.points[r][2])})}).catch(e=>{t.forEach(t=>t.result.reject(e))}),e.madeProgress()}get test(){}}function Ts(e,t,r){if(null==e||null==r)return!1;let s=!0;return Rs[0]=null!=e.xmin?e.xmin:0,Rs[1]=null!=e.ymin?e.ymin:0,Rs[2]=null!=e.zmin?e.zmin:0,s=s&&F(Rs,e.spatialReference,0,t,r,0),Rs[0]=null!=e.xmax?e.xmax:0,Rs[1]=null!=e.ymax?e.ymax:0,Rs[2]=null!=e.zmax?e.zmax:0,s=s&&F(Rs,e.spatialReference,0,t,r,3),null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.zmin&&(t[2]=-1/0),null==e.xmax&&(t[3]=1/0),null==e.ymax&&(t[4]=1/0),null==e.zmax&&(t[5]=1/0),s}function zs(e,t,r){if(null==e||null==r)return!1;let s=!0;return Rs[0]=null!=e.xmin?e.xmin:0,Rs[1]=null!=e.ymin?e.ymin:0,Rs[2]=null!=e.zmin?e.zmin:0,s=s&&F(Rs,e.spatialReference,0,Rs,r,0),t[0]=Rs[0],t[1]=Rs[1],Rs[0]=null!=e.xmax?e.xmax:0,Rs[1]=null!=e.ymax?e.ymax:0,Rs[2]=null!=e.zmax?e.zmax:0,s=s&&F(Rs,e.spatialReference,0,Rs,r,0),t[2]=Rs[0],t[3]=Rs[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),s}const Rs=c();class Gs{constructor(){this._pendingCompressionTasks=Rt(0)}get compressing(){return!!this._pendingCompressionTasks.value}increment(){this._pendingCompressionTasks.value++}decrement(){this._pendingCompressionTasks.value--}}export{dr as A,ur as B,hr as C,Nt as D,Ps as E,cr as F,Dr as G,It as H,Ss as I,ns as J,As as K,as as L,Ls as M,rr as O,Mt as R,Os as S,Gs as T,Fs as V,sr as a,ys as b,Sr as c,vr as d,ps as e,Gt as f,tr as g,bs as h,Vt as i,_s as j,Mr as k,Vr as l,ls as m,Ur as n,Gr as o,Ts as p,kt as q,Rr as r,vs as s,zs as t,Ir as u,$t as v,Or as w,pr as x,Cr as y,Ht as z};
