/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{d as e}from"./colorUtils.js";import{a as t}from"./devEnvironmentUtils.js";import{j as r}from"./mathUtils.js";import{m as o,n as s,f as n}from"./mat3.js";import{f as a,c as i}from"./mat3f64.js";import{i as l}from"./mat4.js";import{c as u}from"./mat4f64.js";import{O as c}from"./vec2f64.js";import{t as m,h as f,H as d,l as p,n as x,m as h}from"./vec3.js";import{c as g}from"./vec3f64.js";import{m as T,e as b}from"./aaBoundingBox.js";import{n as y,G as w,T as v}from"./Matrix4PassUniform.js";import{B,g as R,o as M,A as j,E as S,F as A}from"./BufferView.js";import{b as E,t as F,n as O,f as C}from"./vec32.js";import{t as I,b as L}from"./vec42.js";import{c as P,a as U}from"./indexUtils.js";import{D as _}from"./DefaultLoadingContext.js";import{i as D}from"./resourceUtils3.js";import{Z as V,O as k}from"./vec2f32.js";import{l as G,p as H}from"./wosrLoader.js";import{A as W}from"./orientedBoundingBox.js";import{D as z,u as N,s as Q,e as $,a as q}from"./DefaultMaterial.js";function K(e){if(null==e)return null;const t=null!=e.offset?e.offset:V,r=null!=e.rotation?e.rotation:0,s=null!=e.scale?e.scale:k,n=a(1,0,0,0,1,0,t[0],t[1],1),l=a(Math.cos(r),-Math.sin(r),0,Math.sin(r),Math.cos(r),0,0,0,1),u=a(s[0],0,0,0,s[1],0,0,0,1),c=i();return o(c,l,u),o(c,n,c),c}class Z{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class J{constructor(e,t,r){this.name=e,this.lodThreshold=t,this.pivotOffset=r,this.stageResources=new Z,this.numberOfVertices=0}}async function X(o,a){const i=Y(t(o));if("wosr"===i.fileType){const e=await(a.cache?a.cache.loadWOSR(i.url,a):G(i.url,a)),{engineResources:t,referenceBoundingBox:r}=H(e,a);return{lods:t,referenceBoundingBox:r,isEsriSymbolResource:!1,isWosr:!0}}let V;if(a.cache)V=await a.cache.loadGLTF(i.url,a,!!a.usePBR);else{const{loadGLTF:e}=await import("./loader.js");V=await e(new _(a.streamDataRequester),i.url,a,a.usePBR)}const k=V.model.meta?.ESRI_proxyEllipsoid,Z=V.meta.isEsriSymbolResource&&null!=k&&"EsriRealisticTreesStyle"===V.meta.ESRI_webstyle;Z&&!V.customMeta.esriTreeRendering&&(V.customMeta.esriTreeRendering=!0,function(t,r){for(let o=0;o<t.model.lods.length;++o){const s=t.model.lods[o];for(const n of s.parts){const s=n.attributes.normal;if(null==s)return;const a=n.attributes.position,i=a.count,c=g(),T=g(),b=g(),y=new Float32Array(4*i),w=new Float32Array(3*i),v=l(u(),n.transform);let M=0,j=0;for(let l=0;l<i;l++){a.getVec(l,T),s.getVec(l,c),m(T,T,n.transform),f(b,T,r.center),d(b,b,r.radius);const i=b[2],u=p(b),g=Math.min(.45+.55*u*u,1)**e;d(b,b,r.radius),null!==v&&m(b,b,v),x(b,b),o+1!==t.model.lods.length&&t.model.lods.length>1&&h(b,b,c,i>-1?.2:Math.min(-4*i-3.8,1)),w[M]=b[0],w[M+1]=b[1],w[M+2]=b[2],M+=3,y[j]=g,y[j+1]=g,y[j+2]=g,y[j+3]=1,j+=4}n.attributes.normal=new B(w),n.attributes.color=new R(y)}}}(V,k));const X=!!a.usePBR,te=V.meta.isEsriSymbolResource?{usePBR:X,isSchematic:!1,treeRendering:Z,mrrFactors:$}:{usePBR:X,isSchematic:!1,treeRendering:!1,mrrFactors:q},re={...a.materialParameters,treeRendering:Z},{engineResources:oe,referenceBoundingBox:se}=function(t,o,a,i,l,u){const m=t.model,f=new Array,d=new Map,p=new Map,x=m.lods.length,h=T();return m.lods.forEach((t,g)=>{const T=!0===i.skipHighLods&&(x>1&&0===g||x>3&&1===g)||!1===i.skipHighLods&&null!=l&&g!==l;if(T&&0!==g)return;const _=new J(t.name,t.lodThreshold,[0,0,0]);t.parts.forEach(t=>{const l=T?new z({},i):function(t,r,o,s,n,a,i,l,u){const m=t.materials.get(r.material);if(null==m)return null;const{normal:f,color:d,texCoord0:p,tangent:x}=r.attributes,h=r.material+(f?"_normal":"")+(d?"_color":"")+(p?"_texCoord0":"")+(x?"_tangent":""),g=null!=r.attributes.texCoord0,T=null!=r.attributes.normal,b=function(e){switch(e){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":case null:case void 0:return 1}}(m.alphaMode);if(!a.has(h)){if(g){const e=(e,r=!1,o=!1)=>{if(null!=e&&!i.has(e)){const s=t.textures.get(e);if(s){const t=s.data,n=r&&!D(t)?l.compressionOptions:void 0;i.set(e,new v(D(t)?t.data:t,{...s.parameters,preMultiplyAlpha:!D(t)&&o,encoding:D(t)?t.encoding:void 0,compressionOptions:n}))}}},r=1!==b&&!u;e(m.colorTexture,r,1!==b),e(m.normalTexture),e(m.occlusionTexture,!0),e(m.emissiveTexture),e(m.metallicRoughnessTexture,!0)}const o=1/e,f=m.color[0]**o,d=m.color[1]**o,p=m.color[2]**o,x=m.emissiveFactor[0]**o,y=m.emissiveFactor[1]**o,w=m.emissiveFactor[2]**o,B=null!=m.colorTexture&&g?i.get(m.colorTexture):null,R=N(m),M=null!=m.normalTextureTransform?.scale?m.normalTextureTransform?.scale:c;a.set(h,new z({...s,customDepthTest:1,textureAlphaMode:b,textureAlphaCutoff:m.alphaCutoff,diffuse:[f,d,p],ambient:[f,d,p],opacity:"OPAQUE"===m.alphaMode?1:m.opacity,doubleSided:m.doubleSided,doubleSidedType:"winding-order",cullFace:m.doubleSided?0:2,hasVertexColors:!!r.attributes.color,hasVertexTangents:!!r.attributes.tangent,normalType:T?0:2,castShadows:!0,receiveShadows:m.receiveShadows,receiveAmbientOcclusion:m.receiveAmbientOcclusion,textureId:null!=B?B.id:void 0,colorMixMode:m.colorMixMode,normalTextureId:null!=m.normalTexture&&g?i.get(m.normalTexture).id:void 0,textureAlphaPremultiplied:null!=B&&!!B.parameters.preMultiplyAlpha,occlusionTextureId:null!=m.occlusionTexture&&g?i.get(m.occlusionTexture).id:void 0,emissiveTextureId:null!=m.emissiveTexture&&g?i.get(m.emissiveTexture).id:void 0,metallicRoughnessTextureId:null!=m.metallicRoughnessTexture&&g?i.get(m.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[x,y,w],mrrFactors:R?Q:[m.metallicFactor,m.roughnessFactor,s.mrrFactors[2]],isSchematic:R,colorTextureTransformMatrix:K(m.colorTextureTransform),normalTextureTransformMatrix:K(m.normalTextureTransform),scale:[M[0],M[1]],occlusionTextureTransformMatrix:K(m.occlusionTextureTransform),emissiveTextureTransformMatrix:K(m.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:K(m.metallicRoughnessTextureTransform),...n},l))}const y=a.get(h);if(o.stageResources.materials.push(y),g){const e=e=>{null!=e&&o.stageResources.textures.push(i.get(e))};e(m.colorTexture),e(m.normalTexture),e(m.occlusionTexture),e(m.emissiveTexture),e(m.metallicRoughnessTexture)}return y}(m,t,_,o,a,d,p,i,u),{geometry:f,vertexCount:x}=function(e,t){const o=e.attributes.position.count,a=P(e.indices||o,e.primitiveType),i=y(3*o),{typedBuffer:l,typedBufferStride:u}=e.attributes.position;E(i,l,e.transform,3,u);const c=[["position",new W(i,a,3,!0)]];if(null!=e.attributes.normal){const t=y(3*o),{typedBuffer:n,typedBufferStride:i}=e.attributes.normal;s(ee,e.transform),F(t,n,ee,3,i),r(ee)&&O(t,t),c.push(["normal",new W(t,a,3,!0)])}if(null!=e.attributes.tangent){const t=y(4*o),{typedBuffer:s,typedBufferStride:i}=e.attributes.tangent;n(ee,e.transform),I(t,s,ee,4,i),r(ee)&&O(t,t,4),c.push(["tangent",new W(t,a,4,!0)])}if(null!=e.attributes.texCoord0){const t=y(2*o),{typedBuffer:r,typedBufferStride:s}=e.attributes.texCoord0;U(t,r,2,s),c.push(["uv0",new W(t,a,2,!0)])}const m=e.attributes.color;if(null!=m){const t=new Uint8Array(4*o);4===m.elementCount?m instanceof R?L(t,m,1,255):(m instanceof M||m instanceof j)&&L(t,m,1/255,255):(t.fill(255),m instanceof B?C(t,m.typedBuffer,1,255,4,m.typedBufferStride):(e.attributes.color instanceof S||e.attributes.color instanceof A)&&C(t,m.typedBuffer,1/255,255,4,e.attributes.color.typedBufferStride)),c.push(["color",new W(t,a,4,!0)])}return{geometry:new w(t,c),vertexCount:o}}(t,l??new z({},i)),V=f.boundingInfo;null!=V&&0===g&&(b(h,V.bbMin),b(h,V.bbMax)),null!=l&&(_.stageResources.geometries.push(f),_.numberOfVertices+=x)}),T||f.push(_)}),{engineResources:f,referenceBoundingBox:h}}(V,te,re,a,i.specifiedLodIndex,Z);return{lods:oe,referenceBoundingBox:se,isEsriSymbolResource:V.meta.isEsriSymbolResource,isWosr:!1}}function Y(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}const ee=i(),te=Object.freeze(Object.defineProperty({__proto__:null,fetch:X,parseUrl:Y},Symbol.toStringTag,{value:"Module"}));export{X as f,K as g,te as o};
