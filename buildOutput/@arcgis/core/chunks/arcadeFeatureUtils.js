/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{a as e,b as r}from"./tslib.es6.js";import{i as t}from"./shared2.js";import{L as a}from"./Logger.js";import{sqlAnd as n}from"../core/sql.js";import i from"../layers/FeatureLayer.js";import{i as s}from"./streamLayerUtils.js";import{i as o}from"./guards.js";import{applyTextFormattingHTML as c,htmlEntities as u}from"./featureUtils.js";const l=()=>a.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");function d(e){return c(u(e))}function p(e){return{scale:e?.scale,timeProperties:{currentStart:e?.timeExtent?.start,currentEnd:e?.timeExtent?.end,startIncluded:!0,endIncluded:!0}}}function f(e){return{$voxel:e}}function y(e){if(o(e))return e.getTime();if("number"==typeof e)return e;if("string"==typeof e)return new Date(e).getTime();throw new Error(`Unexpected time value: ${e}`)}async function m(e,r,t){const a=r.sourceLayer||r.layer;if(null==a||!("timeInfo"in a))return null;const i=a.timeInfo?.trackIdField;if(null==i)return null;const o=r.getAttribute(i);if(null==o)return null;let c,u;if("string"==typeof o)c=`"${i.replaceAll('"','""')}" = '${o.replaceAll("'","''")}'`;else{if("number"!=typeof o)return l().warn("Expected track id to be a string or number"),null;c=`"${i.replaceAll('"','""')}" = ${o}`}if("stream"===a.type&&null!=t){const e=await t.whenLayerView(a),r=e.createQuery();r.returnGeometry=!0,r.where=n(r.where,c),u=(await e.queryFeatures(r)).features}else{if(!("queryFeatures"in a))return null;{const e=a.createQuery();e.returnGeometry=!0,e.where=n(e.where,c),u=(await a.queryFeatures(e)).features}}const d=a.fieldsIndex.normalizeFieldName(a.timeInfo.startField)??s,p=a.timeInfo.endField?a.fieldsIndex.normalizeFieldName(a.timeInfo.endField):null,f=u.map(r=>{const a=r.getObjectId();if(null==a)throw new Error("Cannot identify observation");const n=e.ArcadeFeature.createFromGraphic(r,t?.timeZone),i=y(r.getAttribute(d));return{id:a,feature:n,startTime:i,endTime:null!=p?y(r.getAttribute(p)):i,stats:{totalDistance:void 0,distance:void 0,speed:void 0,acceleration:void 0}}}).sort((e,r)=>e.startTime-r.startTime),m="esri.TrackGraphic"===r.declaredClass?f.length-1:f.findIndex(e=>r.getObjectId()===e.id);if(m<0)throw new Error("Couldn't locate feature in observations");return{observations:f,currentObservationIndex:m}}async function w(e,r,a,n,i,s){const o=(r.sourceLayer||r.layer)??void 0;return{vars:{$feature:r,$layer:null!=o&&t(o)?o:"scene"===o?.type&&null!=o.associatedLayer?o.associatedLayer:void 0,$map:a,$datastore:o&&"url"in o?o.url:void 0,$userInput:n,$graph:"knowledge-graph-sublayer"===o?.type?o.parentCompositeLayer?.knowledgeGraph:void 0,$view:p(i)},track:s?await m(e,r,i):null}}async function g(){const[e,r,{default:t}]=await Promise.all([import("../arcade.js"),import("./arcade.js").then(e=>e.L),import("./Feature.js").then(e=>e.a)]);return{executor:e,syntaxUtils:r,ArcadeFeature:t}}async function v(t,a,n){const{executor:{createArcadeProfile:s,createArcadeExecutor:o},syntaxUtils:c}=n,u=function(e){const r="esri.views.3d.layers.VoxelGraphic"===e.declaredClass;return e.isAggregate?"popup-feature-reduction":r?"popup-voxel":"popup"}(a),d=s(u);let y;try{y=await o(t,d)}catch(e){return l().error("arcade-executor-error",{error:e,expression:t}),null}const g=new Set;y.variablesUsed.includes("$view")&&(c.scriptUsesViewProperties(y.syntaxTree,["scale"])&&g.add("view-scale"),c.scriptUsesViewProperties(y.syntaxTree,["timeProperties"])&&g.add("view-time-extent"));const v=c.scriptUsesTrack(y.syntaxTree);return{dependencies:g,async evaluate({graphic:a,interceptor:s,location:o,map:c,options:d,spatialReference:g,view:h}){const x={stack:[],error:void 0,hasError:!1};try{const r=e(x,await async function(e,{arcade:r,graphic:t,map:a,location:n,view:s,options:o,interceptor:c,arcadeExecutor:u,usesTrack:l}){switch(e){case"popup":return{...await w(r,t,a,n,s,l),[Symbol.dispose](){}};case"popup-feature-reduction":{const e=new Set(u.variablesUsed);return await async function(e,r,t,a,n,s,o){let c=null;if(s.has("$aggregatedfeatures")){const e=await async function({graphic:e,view:r,options:t}){const{isAggregate:a}=e,n=e.layer??e.sourceLayer;if(!a||!n||"2d"!==r?.type)return[];const i=await r.whenLayerView(n);if(!function(e){return"createQuery"in e&&"queryFeatures"in e}(i))return[];const s=i.createQuery(),o=e.getObjectId();s.aggregateIds=null!=o?[o]:[];const{features:c}=await i.queryFeatures(s,t);return c}({graphic:r,view:t,options:a}),s=r.sourceLayer||r.layer;c=function({layer:e,aggregatedFeatures:r,interceptor:t}){const{fields:a,objectIdField:n,geometryType:s,spatialReference:o}=e,c="displayField"in e?e.displayField:void 0;return new i({fields:a,objectIdField:n,geometryType:s,spatialReference:o,displayField:c,interceptor:t,..."feature"===e.type?{templates:e.templates,typeIdField:e.typeIdField,types:e.types}:null,source:r})}({layer:s,aggregatedFeatures:e,interceptor:n})}return{vars:{$feature:r,$aggregatedFeatures:c,$view:p(t)},track:o?await m(e,r,t):null,[Symbol.dispose]:()=>c?.[Symbol.dispose]()}}(r,t,s,o,c,e,l)}case"popup-voxel":return{vars:f(t),track:null,[Symbol.dispose](){}};default:throw new Error(`Unexpected profile name ${e}`)}}(u,{arcade:n,graphic:a,map:c,location:o,view:h,options:d,interceptor:s,arcadeExecutor:y,usesTrack:v}),!1),F={abortSignal:d?.signal??void 0,interceptor:s??void 0,rawOutput:!0,spatialReference:g??void 0,timeZone:h?.timeZone,track:r.track,console(...e){l().info(...e)}};try{return await y.executeAsync(r.vars,F)}catch(e){if(d?.signal?.aborted)return;return void l().error("arcade-execution-error",{error:e,graphic:a,expression:t})}}catch(e){x.error=e,x.hasError=!0}finally{r(x)}}}}async function h({expression:e,graphic:r}){return e?v(e,r,await g()):null}async function x(e,r){if(!e?.length)return{dependencies:new Set,expressions:new Map};const t=await g(),a=new Set,n=new Map;for(const i of e){const e=await v(i.expression,r,t);n.set(`expression/${i.name}`,e),e?.dependencies.forEach(e=>a.add(e))}return{dependencies:a,expressions:n}}export{x as a,h as c,d as f};
