/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{r as t}from"./WGLContainer.js";import{_ as e,c as i}from"./tslib.es6.js";import{G as o,a as s,t as n,x as a,j as r,F as l,n as m,y as u,l as c,z as h,c as d,A as p,g as y,B as g,C as w,D as v,h as _,E as f,o as b,V as x,u as C,S as M,w as T,p as S,H as k,q as E,U as z,r as P,I as A,J as L,K as R,L as j,s as O,f as B,N as I,O as D,P as N,Q as F,R as q,m as V,M as Z}from"./GraphShaderModule.js";import{u as G,o as U,m as $,a as W}from"./utils26.js";import{C as H}from"./CircularArray.js";import{EventEmitter as Q}from"../core/Evented.js";import{h as J}from"../core/lang.js";import{c as K}from"./testSVGPremultipliedAlpha.js";import X from"../core/Accessor.js";import{property as Y}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as tt}from"../core/accessorSupport/decorators/subclass.js";import{S as et}from"./SymbolFader.js";import{p as it}from"./definitions.js";import ot from"../Viewpoint.js";import{d as st}from"./maybe.js";import nt from"../geometry/Point.js";import{t as at,k as rt,s as lt,l as mt,r as ut,m as ct,p as ht}from"./viewpointUtils.js";import{g as dt}from"../widgets/Compass/CompassViewModel.js";import{c as pt,b as yt}from"./screenUtils.js";import{V as gt}from"./InputManager.js";import{when as wt}from"../core/reactiveUtils.js";import{i as vt}from"./vec3.js";import{c as _t,f as ft}from"./vec3f64.js";import{P as bt,R as xt,Z as Ct}from"./ZoomMomentumEstimator.js";import{s as Mt,i as Tt,c as St}from"./vec2.js";import{c as kt}from"./vec2f64.js";import{m as Et}from"./constants4.js";const zt={vertexShader:t("bitBlit/bitBlit.vert"),fragmentShader:t("bitBlit/bitBlit.frag")},Pt={vertexShader:t("stencil/stencil.vert"),fragmentShader:t("stencil/stencil.frag")};class At extends E{}e([b(0,x)],At.prototype,"position",void 0);let Lt=class extends z{};e([C(M)],Lt.prototype,"layerTexture",void 0),e([C(M)],Lt.prototype,"backbufferTexture",void 0),e([C(l)],Lt.prototype,"opacity",void 0),e([C(l)],Lt.prototype,"inFadeOpacity",void 0);class Rt extends o{constructor(){super(...arguments),this.type="BlendShader"}vertex(t){return{uv:t.position,glPosition:new s(G(t.position),0,1)}}fragment(t){const e=new m,i=n(this.config.layerTexture,t.uv),o=n(this.config.backbufferTexture,t.uv),y=a(r(i.a,new l(0)),i.rgb,i.rgb.divide(i.a)),g=a(r(o.a,new l(0)),o.rgb,o.rgb.divide(o.a)),w=this.config.opacity.multiply(i.a),v=o.a;switch(this.blendMode){case"destination-over":e.fragColor=new s(y.multiply(w).multiply(U(v)).add(g.multiply(v)),w.add(v).subtract(w.multiply(v)));break;case"source-in":{const t=new s(y.multiply(w).multiply(v),w.multiply(v)),i=new s(g.multiply(v),v).multiply(U(this.config.opacity)).multiply(this.config.inFadeOpacity);e.fragColor=t.add(i)}break;case"destination-in":{const t=new s(g.multiply(v).multiply(w),v.multiply(w)),i=new s(g.multiply(v),v).multiply(new s(U(this.config.opacity).multiply(this.config.inFadeOpacity)));e.fragColor=t.add(i)}break;case"source-out":e.fragColor=new s(y.multiply(w).multiply(U(v)),w.multiply(U(v)));break;case"destination-out":e.fragColor=new s(g.multiply(v).multiply(U(w)),v.multiply(U(w)));break;case"source-atop":e.fragColor=new s(y.multiply(w).multiply(v).add(g.multiply(v.multiply(U(w)))),v);break;case"destination-atop":e.fragColor=new s(y.multiply(w.multiply(U(v))).add(g.multiply(v).multiply(w)),w);break;case"xor":e.fragColor=new s(y.multiply(w.multiply(U(v))).add(g.multiply(v.multiply(U(w)))),w.multiply(U(v)).add(v.multiply(U(w))));break;case"multiply":e.fragColor=new s(y.multiply(w).multiply(g.multiply(v)).add(y.multiply(w).multiply(U(v))).add(g.multiply(v).multiply(U(w))),w.add(v.multiply(U(w))));break;case"screen":e.fragColor=new s(y.add(g).subtract(y.multiply(g)).multiply(w.multiply(v)).add(y.multiply(w).multiply(U(v))).add(g.multiply(v).multiply(U(w))),w.add(v.multiply(U(w))));break;case"overlay":{const t=new c(Ot(g.r,y.r),Ot(g.g,y.g),Ot(g.b,y.b));e.fragColor=jt(t,y,g,w,v)}break;case"darken":{const t=p(y,g);e.fragColor=jt(t,y,g,w,v)}break;case"lighter":e.fragColor=new s(y.multiply(w).add(g.multiply(v)),w.add(v));break;case"lighten":{const t=d(y,g);e.fragColor=jt(t,y,g,w,v)}break;case"color-dodge":{const t=u(new c(Bt(g.r,y.r),Bt(g.g,y.g),Bt(g.b,y.b)),new c(0),new c(1));e.fragColor=jt(t,y,g,w,v)}break;case"color-burn":{const t=new c(It(g.r,y.r),It(g.g,y.g),It(g.b,y.b));e.fragColor=jt(t,y,g,w,v)}break;case"hard-light":{const t=new c(Dt(g.r,y.r),Dt(g.g,y.g),Dt(g.b,y.b));e.fragColor=jt(t,y,g,w,v)}break;case"soft-light":{const t=new c(Nt(g.r,y.r),Nt(g.g,y.g),Nt(g.b,y.b));e.fragColor=jt(t,y,g,w,v)}break;case"difference":{const t=h(g.subtract(y));e.fragColor=jt(t,y,g,w,v)}break;case"exclusion":{const t=y.add(g).subtract(new l(2).multiply(y).multiply(g));e.fragColor=jt(t,y,g,w,v)}break;case"invert":e.fragColor=new s(new c(1).subtract(g).multiply(w).multiply(v).add(g.multiply(v).multiply(U(w))),v);break;case"vivid-light":{const t=new c(u(Ft(g.r,y.r),new l(0),new l(1)),u(Ft(g.g,y.g),new l(0),new l(1)),u(Ft(g.b,y.b),new l(0),new l(1)));e.fragColor=jt(t,y,g,w,v)}break;case"hue":{const t=$t(y,g,g);e.fragColor=jt(t,y,g,w,v)}break;case"saturation":{const t=$t(g,y,g);e.fragColor=jt(t,y,g,w,v)}break;case"color":{const t=Ut(y,g);e.fragColor=jt(t,y,g,w,v)}break;case"luminosity":{const t=Ut(g,y);e.fragColor=jt(t,y,g,w,v)}break;case"plus":e.fragColor=u(new s(i.r.add(g.r),i.g.add(g.g),i.b.add(g.b),w.add(v)),new s(0),new s(1));break;case"minus":e.fragColor=new s(u(new c(g.r.subtract(i.r),g.g.subtract(i.g),g.b.subtract(i.b)),new c(0),new c(1)),v.multiply(w));break;case"average":{const t=g.add(y).divide(2);e.fragColor=jt(t,y,g,w,v)}break;case"reflect":{const t=u(new c(Wt(g.r,y.r),Wt(g.g,y.g),Wt(g.b,y.b)),new c(0),new c(1));e.fragColor=jt(t,y,g,w,v)}break;default:e.fragColor=i.multiply(this.config.opacity)}return e}}function jt(t,e,i,o,n){return new s(t.multiply(o).multiply(n).add(e.multiply(o).multiply(U(n))).add(i.multiply(n).multiply(U(o))),o.add(n.multiply(U(o))))}function Ot(t,e){return new l(1).subtract(g(new l(.5),e)).multiply(U(new l(2).multiply(U(e).multiply(U(t))))).add(g(new l(.5),e).multiply(new l(2).multiply(e).multiply(t)))}function Bt(t,e){return a(r(t,new l(0)),new l(0),a(r(e,new l(1)),new l(1),p(new l(1),t.divide(new l(1).subtract(e)))))}function It(t,e){return a(r(t,new l(1)),new l(1),a(r(e,new l(0)),new l(0),U(p(new l(1),U(t).divide(e)))))}function Dt(t,e){return new l(1).subtract(g(new l(.5),e)).multiply(new l(2).multiply(e).multiply(t)).add(g(new l(.5),e).multiply(U(new l(2).multiply(U(e).multiply(U(t))))))}function Nt(t,e){return w([v(e,new l(.5)),()=>{const i=new l(2).multiply(e),o=U(i),s=U(t);return t.subtract(o.multiply(t).multiply(s))}],[v(t,new l(.25)),()=>{const i=new l(2).multiply(e),o=W(i).multiply(t),s=new l(16).multiply(t).subtract(new l(12)).multiply(t).add(new l(3));return t.add(o.multiply(s))}],[!0,()=>{const i=new l(2).multiply(e),o=W(i),s=k(t).subtract(t);return t.add(o.multiply(s))}])}function Ft(t,e){const i=U(g(new l(.5),e)).multiply(It(t,new l(2).multiply(e))),o=g(new l(.5),e).multiply(Bt(t,new l(2).multiply($(e,.5))));return i.add(o)}function qt(t){return p(p(t.r,t.g),t.b)}function Vt(t){return d(d(t.r,t.g),t.b)}function Zt(t){return _(t,new c(.3,.59,.11))}function Gt(t){return Vt(t).subtract(qt(t))}function Ut(t,e){const i=Zt(t),o=Zt(e).subtract(i);return function(t){const e=Zt(t),i=qt(t),o=Vt(t);return w([f(i,new l(0)),()=>{const o=t.subtract(e).multiply(e),s=e.subtract(i);return e.add(o.divide(s))}],[y(o,new l(1)),()=>{const i=t.subtract(e),s=U(e),n=i.multiply(s),a=o.subtract(e);return e.add(n.divide(a))}],[!0,t])}(t.add(new c(o)))}function $t(t,e,i){const o=qt(t),s=Gt(t),n=Gt(e);return Ut(a(y(s,new l(0)),()=>t.subtract(o).multiply(n).divide(s),new c(0)),i)}function Wt(t,e){return a(r(e,new l(1)),e,()=>{const i=U(e),o=t.multiply(t).divide(i);return p(o,new l(1))})}e([T],Rt.prototype,"blendMode",void 0),e([C(Lt)],Rt.prototype,"config",void 0),e([i(0,S(At))],Rt.prototype,"vertex",null),e([i(0,S(class extends P{}))],Rt.prototype,"fragment",null);class Ht extends E{}e([b(0,x)],Ht.prototype,"position",void 0);let Qt=class extends z{};e([C(M)],Qt.prototype,"layerTexture",void 0),e([C(l)],Qt.prototype,"opacity",void 0);class Jt extends o{constructor(){super(...arguments),this.type="OpacityShader"}vertex(t){return{uv:t.position,glPosition:new s(t.position.subtract(new x(.5)).multiply(2),0,1)}}fragment(t){const e=new m;return e.fragColor=n(this.config.layerTexture,t.uv).multiply(this.config.opacity),e}}e([C(Qt)],Jt.prototype,"config",void 0),e([i(0,S(Ht))],Jt.prototype,"vertex",null),e([i(0,S(class extends P{}))],Jt.prototype,"fragment",null);const Kt={vertexShader:t("highlight/textured.vert"),fragmentShader:t("highlight/highlight.frag")},Xt={vertexShader:t("highlight/textured.vert"),fragmentShader:t("highlight/blur.frag")},Yt=!!J("esri-2d-profiler");class te{constructor(t,e){if(this._events=new Q,this._entries=new Map,this._timings=new H(10),this._currentContainer=null,this._currentPass=null,this._currentBrush=null,this._currentSummary=null,!Yt)return;this._ext=K(t.gl,{}),this._debugOutput=e;const i=t.gl;if(!this.enableCommandLogging)return;let o;for(o in i)if("function"==typeof i[o]){const t=i[o],e=o.includes("draw");i[o]=(...s)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:o,args:s,isDrawCommand:e}),this._currentSummary&&(this._currentSummary.commands++,e&&this._currentSummary.drawCommands++),t.apply(i,s))}}get enableCommandLogging(){return!("object"==typeof Yt&&Yt.disableCommands)}recordContainerStart(t){Yt&&(this._currentContainer=t)}recordContainerEnd(){Yt&&(this._currentContainer=null)}recordPassStart(t){Yt&&(this._currentPass=t,this._initSummary())}recordPassEnd(){Yt&&(this._currentPass=null,this._emitSummary())}recordBrushStart(t){Yt&&(this._currentBrush=t)}recordBrushEnd(){Yt&&(this._currentBrush=null)}recordStart(t){if(Yt&&null!=this._ext){if(this._entries.has(t)){const e=this._entries.get(t),i=this._ext.resultAvailable(e.query),o=this._ext.disjoint();if(i&&!o){const i=this._ext.getResult(e.query)/1e6;let o=0;if(null!=this._timings.enqueue(i)){const t=this._timings.entries,e=t.length;let i=0;for(const e of t)i+=e;o=i/e}const s=i.toFixed(2),n=o?o.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${t}, ${s} ms (${n} last 10 avg)\n${e.commandsLen} Commands (${e.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(e.summaries),console.log("Commands: ",e.commands),console.groupEnd()):console.log(`Frame report for ${t}, ${s} ms (${n} last 10 avg)`),this._debugOutput.innerHTML=`${s} (${n})`}for(const t of e.handles)t.remove();this._ext.deleteQuery(e.query),this._entries.delete(t)}const e={name:t,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(e.handles.push(this._events.on("command",t=>{e.commandsLen++,e.commands.push(t),t.isDrawCommand&&e.drawCommands++})),e.handles.push(this._events.on("summary",t=>{e.summaries.push(t)}))),this._ext.beginTimeElapsed(e.query),this._entries.set(t,e)}}recordEnd(t){Yt&&null!=this._ext&&this._entries.has(t)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._currentSummary&&this._events.emit("summary",this._currentSummary)}}class ee extends E{}e([b(0,x)],ee.prototype,"position",void 0),e([b(1,x)],ee.prototype,"texcoord",void 0),e([b(2,l)],ee.prototype,"w",void 0);let ie=class extends z{};e([C(M)],ie.prototype,"texture",void 0),e([C(l)],ie.prototype,"opacity",void 0);class oe extends o{constructor(){super(...arguments),this.type="VideoScreenShader"}vertex(t){const{position:e,texcoord:i,w:o}=t;return{glPosition:new s(e,0,o),texcoord:i}}fragment(t){const e=new m;return e.fragColor=n(this.config.texture,t.texcoord).multiply(this.config.opacity),e}}e([C(ie)],oe.prototype,"config",void 0),e([i(0,S(ee))],oe.prototype,"vertex",null),e([i(0,S(class extends P{}))],oe.prototype,"fragment",null);class se{constructor(){this.styles=new Map,this.layerContexts=new Map}get cachedStyles(){return this.styles}setLabelClassStyle(t,e,i){this.layerContexts.set(t,e),this.styles.set(t,i)}}let ne=class extends X{constructor(t){super(t),this._faderWorkingSet=[],this._styleRepository=new se,this.lastUpdateId=-1,this.updateRequested=!1,this.view=null,this.symbolFader=new et("feature-tile",this._styleRepository,(t,e)=>{t.updateLabelVisibility(),t.requestRender(),t.isReady&&(t.decluttered=!0)},this._faderWorkingSet,it,7e6)}get updating(){return J("esri-2d-log-updating")&&console.log(`Updating LabelManager ${this.updateRequested}:\n-> updateRequested: ${this.updateRequested}`),this.updateRequested}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view?.requestUpdate())}processUpdate(t){this.doUpdate(t)?this.updateRequested=!1:(this.updateRequested=!0,this.view?.requestUpdate())}setLabelSchemaStyles(t,e){let i;switch(t.type){case"label":i=t.classes;break;case"subtype":i=Array.from(Object.values(t.renderers).flatMap(t=>t.classes));break;case"cluster":i=[...t.cluster.classes,...t.feature.classes];break;case"track":i=[...t.latestObservation.classes,...t.previousObservation.classes,...t.trackLine.classes]}for(const t of i){const i=ae(t);this._styleRepository.setLabelClassStyle(t.labelClassId,e,i)}}doUpdate(t){const e=this.view;if(!e)return!1;const i=e.allLayerViews.map(t=>t.featureContainer).filter(t=>!!t&&t?.hasLabels);if(i.length>0){this._faderWorkingSet.length=0;for(const e of i)for(const i of e.tiles||[])i.setTransform(t.state),this._faderWorkingSet.push(i);const o=t.state.scale,s=e.featuresTilingScheme.scaleToZoom(o);return this.symbolFader.update(s,t.state)}return!0}};function ae(t){const e="esriGeometryPolyline"===t.geometryType?0:1,i="esriGeometryPolyline"===t.geometryType?0:1;return{geometryType:t.geometryType,iconAllowOverlap:!t.deconflictionEnabled,iconIgnorePlacement:!1,textAllowOverlap:!t.deconflictionEnabled,textIgnorePlacement:!1,iconRotationAlignment:e,textRotationAlignment:e,iconTranslateAnchor:i,iconTranslate:[0,0],textTranslateAnchor:i,textTranslate:[0,0]}}e([Y()],ne.prototype,"updateRequested",void 0),e([Y()],ne.prototype,"updating",null),e([Y()],ne.prototype,"view",void 0),ne=e([tt("esri.views.2d.LabelManager")],ne);const re="esri-zoom-box",le={container:`${re}__container`,overlay:`${re}__overlay`,background:`${re}__overlay-background`,box:`${re}__outline`},me="Shift";let ue=class extends X{constructor(t){super(t),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._rafId=null,this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(t){this.removeAllHandles(),this._destroyOverlay(),this._set("view",t),t&&this.addHandles([t.on("drag",[me],t=>this._handleDrag(t,1),gt.INTERNAL),t.on("drag",[me,"Control"],t=>this._handleDrag(t,-1),gt.INTERNAL)])}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(t,e,i,o){this._box.x=t,this._box.y=e,this._box.width=i,this._box.height=o,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(t,e,i,o,s){const n=this.view,a=n.toMap(pt(t+.5*i,e+.5*o));let r=Math.max(i/n.width,o/n.height);-1===s&&(r=1/r),this._destroyOverlay(),this.navigation.end(),n.goTo({center:a,scale:n.scale*r},{animationMode:"always",duration:dt()})}_updateBox(t,e,i,o){const s=this._boxShape;s.setAttributeNS(null,"x",""+t),s.setAttributeNS(null,"y",""+e),s.setAttributeNS(null,"width",""+i),s.setAttributeNS(null,"height",""+o),s.setAttributeNS(null,"class",le.box)}_updateBackground(t,e,i,o){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(t,e,i,o,this.view.width,this.view.height))}_createContainer(){const t=document.createElement("div");t.className=le.container,this.view.root.appendChild(t),this._container=t}_createOverlay(){const t=this.view.width,e=this.view.height,i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS(null,"d","M 0 0 L "+t+" 0 L "+t+" "+e+" L 0 "+e+" Z"),i.setAttributeNS(null,"class",le.background);const o=document.createElementNS("http://www.w3.org/2000/svg","rect"),s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),s.setAttributeNS(null,"class",le.overlay),s.appendChild(i),s.appendChild(o),this._container.appendChild(s),this._backgroundShape=i,this._boxShape=o,this._overlay=s}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(t,e,i,o,s,n){const a=t+i,r=e+o;return"M 0 0 L "+s+" 0 L "+s+" "+n+" L 0 "+n+" ZM "+t+" "+e+" L "+t+" "+r+" L "+a+" "+r+" L "+a+" "+e+" Z"}_handleDrag(t,e){const i=t.x,o=t.y,s=t.origin.x,n=t.origin.y;let a,r,l,m;switch(i>s?(a=s,l=i-s):(a=i,l=s-i),o>n?(r=n,m=o-n):(r=o,m=n-o),t.action){case"start":this._start();break;case"update":this._update(a,r,l,m);break;case"end":this._end(a,r,l,m,e)}t.stopPropagation()}_redraw(){if(!this._rafId)return;if(this._rafId=null,!this._overlay)return;const{x:t,y:e,width:i,height:o}=this._box;this._updateBox(t,e,i,o),this._updateBackground(t,e,i,o),this._rafId=requestAnimationFrame(this._redraw)}};e([Y()],ue.prototype,"navigation",void 0),e([Y()],ue.prototype,"view",null),ue=e([tt("esri.views.2d.navigation.ZoomBox")],ue);let ce=class extends X{constructor(t){super(t),this.animationTime=0,this.momentumEstimator=new bt(500,6,.92),this.momentum=null,this.tmpMomentum=_t(),this.momentumFinished=!1,this.viewpoint=new ot({targetGeometry:new nt,scale:0,rotation:0}),this._previousDrag=null,wt(()=>this.momentumFinished,()=>this.navigation.stop())}begin(t,e){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(e),this._previousDrag=e}update(t,e){this.addToEstimator(e);let i=e.center.x,o=e.center.y;const s=this._previousDrag;i=s?s.center.x-i:-i,o=s?o-s.center.y:o,t.viewpoint=at(this.viewpoint,t.viewpoint,[i||0,o||0]),this._previousDrag=e}end(t,e){this.addToEstimator(e);const i=t.navigation.effectiveMomentumEnabled;this.momentum=i?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(t),this._previousDrag=null,this.navigation.end()}addToEstimator(t){const e=t.center.x,i=t.center.y,o=yt(-e,i),s=ft(-e,i,0);this.momentumEstimator.add(o,s,.001*t.timestamp)}onAnimationUpdate(t){this.navigation.animationManager?.animateContinuous(t.viewpoint,(e,i)=>{const{momentum:o,animationTime:s,tmpMomentum:n}=this,a=.001*i;if(!(this.momentumFinished=!o||o.isFinished(s))){const i=o.valueDelta(s,a);vt(n,o.direction,i),at(e,e,n),t.constraints.constrainByGeometry(e)}this.animationTime+=a})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};e([Y()],ce.prototype,"momentumFinished",void 0),e([Y()],ce.prototype,"viewpoint",void 0),e([Y()],ce.prototype,"navigation",void 0),ce=e([tt("esri.views.2d.navigation.actions.Pan")],ce);let he=class extends X{constructor(t){super(t),this._animationTime=0,this._momentumFinished=!1,this._previousAngle=0,this._previousRadius=0,this._previousCenter=null,this._rotationMomentumEstimator=new xt(.6,.15,.95),this._rotationDirection=1,this._startAngle=0,this._startRadius=0,this._updateTimestamp=null,this._zoomDirection=1,this._zoomMomentumEstimator=new Ct,this._zoomOnly=null,this.viewpoint=new ot({targetGeometry:new nt,scale:0,rotation:0}),this.zoomMomentum=null,this.rotateMomentum=null,this.addHandles(wt(()=>this._momentumFinished,()=>this.navigation.stop()))}begin(t,e){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=e.angle,this._previousRadius=this._startRadius=e.radius,this._previousCenter=e.center,this._updateTimestamp=null,t.constraints.rotationEnabled&&this.addToRotateEstimator(0,e.timestamp),this.addToZoomEstimator(e,1)}update(t,e){null===this._updateTimestamp&&(this._updateTimestamp=e.timestamp);const i=e.angle,o=e.radius,s=e.center,n=Math.abs(180*(i-this._startAngle)/Math.PI),a=Math.abs(o-this._startRadius),r=this._startRadius/o;if(this._previousRadius&&this._previousCenter){const l=o/this._previousRadius;let m=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=m>=0?1:-1,this._zoomDirection=l>=1?1:-1,t.constraints.rotationEnabled?(null===this._zoomOnly&&e.timestamp-this._updateTimestamp>200&&(this._zoomOnly=a-n>0),null===this._zoomOnly||this._zoomOnly?m=0:this.addToRotateEstimator(i-this._startAngle,e.timestamp)):m=0,this.addToZoomEstimator(e,r),this.navigation.setViewpoint([s.x,s.y],1/l,m,[this._previousCenter.x-s.x,s.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=o,this._previousCenter=s}end(t){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(t),this.navigation.end()}addToRotateEstimator(t,e){this._rotationMomentumEstimator.add(t,.001*e)}addToZoomEstimator(t,e){this._zoomMomentumEstimator.add(e,.001*t.timestamp)}canZoomIn(t){const e=t.scale,i=t.constraints.effectiveMaxScale;return 0===i||e>i}canZoomOut(t){const e=t.scale,i=t.constraints.effectiveMinScale;return 0===i||e<i}onAnimationUpdate(t){this.navigation.animationManager?.animateContinuous(t.viewpoint,(e,i)=>{const o=!this.canZoomIn(t)&&this._zoomDirection>1||!this.canZoomOut(t)&&this._zoomDirection<1,s=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),n=o||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),a=.001*i;if(this._momentumFinished=s&&n,!this._momentumFinished){const i=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,a))*this._rotationDirection*180/Math.PI:0;let o=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,a)):1;const s=kt(),n=kt();if(this._previousCenter){Mt(s,this._previousCenter.x,this._previousCenter.y),rt(n,t.size,t.padding),Tt(s,s,n);const{constraints:a,scale:r}=t,l=r*o;o<1&&!a.canZoomInTo(l)?(o=r/a.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):o>1&&!a.canZoomOutTo(l)&&(o=r/a.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),lt(e,t.viewpoint,o,i,s,t.size),t.constraints.constrainByGeometry(e)}}this._animationTime+=a})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};e([Y()],he.prototype,"_momentumFinished",void 0),e([Y()],he.prototype,"viewpoint",void 0),e([Y()],he.prototype,"navigation",void 0),he=e([tt("esri.views.2d.navigation.actions.Pinch")],he);const de=kt(),pe=kt();let ye=class extends X{constructor(t){super(t),this._previousCenter=kt(),this.viewpoint=new ot({targetGeometry:new nt,scale:0,rotation:0})}begin(t,e){this.navigation.begin(),Mt(this._previousCenter,e.center.x,e.center.y)}update(t,e){const{state:{size:i,padding:o}}=t;Mt(de,e.center.x,e.center.y),mt(pe,i,o),t.viewpoint=ut(this.viewpoint,t.state.paddedViewState.viewpoint,ct(pe,this._previousCenter,de)),St(this._previousCenter,de)}end(){this.navigation.end()}};e([Y()],ye.prototype,"viewpoint",void 0),e([Y()],ye.prototype,"navigation",void 0),ye=e([tt("esri.views.2d.navigation.actions.Rotate")],ye);const ge=new ot({targetGeometry:new nt}),we=[0,0];let ve=class extends X{constructor(t){super(t),this._endTimer=null,this._lastEventTimestamp=null,this.animationManager=null,this.interacting=!1}initialize(){this.pan=new ce({navigation:this}),this.rotate=new ye({navigation:this}),this.pinch=new he({navigation:this}),this.zoomBox=new ue({view:this.view,navigation:this})}destroy(){this.pan=st(this.pan),this.rotate=st(this.rotate),this.pinch=st(this.pinch),this.zoomBox=st(this.zoomBox),this.animationManager=null}begin(){this.stop(),this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(250)}async zoom(t,e=this._getDefaultAnchor()){if(this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return t<1?this.zoomIn(e):this.zoomOut(e);this.setViewpoint(e,t,0,[0,0])}async zoomIn(t){const e=this.view,i=e.constraints.snapToNextScale(e.scale);return this._zoomToScale(i,t)}async zoomOut(t){const e=this.view,i=e.constraints.snapToPreviousScale(e.scale);return this._zoomToScale(i,t)}setViewpoint(t,e,i,o){this.begin(),this.view.stateManager.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,t,e,i,o),this.end()}setViewpointImmediate(t,e=0,i=[0,0],o=this._getDefaultAnchor()){this.view.stateManager.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,o,t,e,i)}continuousRotateClockwise(){const t=this.view.viewpoint;this.animationManager?.animateContinuous(t,t=>{ut(t,t,-1)})}continuousRotateCounterclockwise(){const t=this.view.viewpoint;this.animationManager?.animateContinuous(t,t=>{ut(t,t,1)})}resetRotation(){this.view.constraints.rotationEnabled&&(this.view.rotation=0)}continuousPanLeft(){this._continuousPan([-10,0])}continuousPanRight(){this._continuousPan([10,0])}continuousPanUp(){this._continuousPan([0,10])}continuousPanDown(){this._continuousPan([0,-10])}continuousPanVector({x:t,y:e}){this._continuousPan([10*t,10*e])}stop(){this.pan.stopMomentumNavigation(),this.animationManager?.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(t){const e=this.view.viewpoint;this.animationManager?.animateContinuous(e,e=>{at(e,e,t),this.view.constraints.constrainByGeometry(e)})}_startTimer(t){return null!==this._endTimer||(this._endTimer=setTimeout(()=>{this._endTimer=null;const t=performance.now()-(this._lastEventTimestamp??0);t<250?this._endTimer=this._startTimer(t):this._set("interacting",!1)},t)),this._endTimer}_getDefaultAnchor(){const{size:t,padding:{left:e,right:i,top:o,bottom:s}}=this.view;return we[0]=.5*(t[0]-i+e),we[1]=.5*(t[1]-s+o),we}async _zoomToScale(t,e=this._getDefaultAnchor()){const{view:i}=this,{constraints:o,scale:s,viewpoint:n,size:a,padding:r}=i,l=o.canZoomInTo(t),m=o.canZoomOutTo(t);if(!(t<s&&!l||t>s&&!m))return ht(ge,n,t/s,0,e,a,r),o.constrainByGeometry(ge),i.goTo(ge,{animate:!0,animationMode:"always",duration:dt(),pickClosestTarget:!1})}_scaleRotateTranslateViewpoint(t,e,i,o,s){const{view:n}=this,{size:a,padding:r,constraints:l,scale:m,viewpoint:u}=n,c=m*i,h=l.canZoomInTo(c),d=l.canZoomOutTo(c);return(i<1&&!h||i>1&&!d)&&(i=1),at(u,u,s),ht(t,u,i,o,e,a,r),l.constrainByGeometry(t)}};e([Y()],ve.prototype,"animationManager",void 0),e([Y({type:Boolean,readOnly:!0})],ve.prototype,"interacting",void 0),e([Y()],ve.prototype,"pan",void 0),e([Y()],ve.prototype,"pinch",void 0),e([Y()],ve.prototype,"rotate",void 0),e([Y()],ve.prototype,"view",void 0),e([Y()],ve.prototype,"zoomBox",void 0),ve=e([tt("esri.views.2d.navigation.MapViewNavigation")],ve);const _e=ve;class fe extends E{}e([b(0,x)],fe.prototype,"position",void 0);let be=class extends z{};e([C(M)],be.prototype,"readbackTexture",void 0),e([C(M)],be.prototype,"maskTexture",void 0),e([C(M)],be.prototype,"overlayTexture",void 0),e([C(s)],be.prototype,"background",void 0),e([C(s)],be.prototype,"drawPos",void 0),e([C(l)],be.prototype,"maskEnabled",void 0),e([C(l)],be.prototype,"overlayEnabled",void 0);class xe extends o{constructor(){super(...arguments),this.type="MagnifierShader"}vertex(t){const e=t.position,i=t.position.subtract(new x(.5)).multiply(this.config.drawPos.zw),o=this.config.drawPos.xy.add(i);return{glPosition:new s(o,0,1),texCoord:e}}fragment(t){let e=n(this.config.readbackTexture,function(t){const e=t.multiply(new x(2)).subtract(1);return a(r(e.x,new l(0)).and(r(e.y,new l(0))),new x(.5),()=>{const t=A(e.y,e.x),i=L(R(e),new l(Et)),o=new x(j(t),O(t));return i.multiply(o).multiply(new x(.5)).add(new l(.5))})}(t.texCoord));e=e.add(new l(1).subtract(e.a)).multiply(this.config.background);const i=a(r(this.config.maskEnabled,new l(1)),n(this.config.maskTexture,t.texCoord).a,new l(1));e=e.multiply(i);const o=a(r(this.config.overlayEnabled,new l(1)),n(this.config.overlayTexture,t.texCoord),new s(0)),u=new m;return u.fragColor=o.add(new l(1).subtract(o.a).multiply(e)),u}}e([C(be)],xe.prototype,"config",void 0),e([i(0,S(fe))],xe.prototype,"vertex",null),e([i(0,S(class extends P{}))],xe.prototype,"fragment",null);class Ce extends E{}e([b(0,x)],Ce.prototype,"position",void 0);class Me extends z{}e([C(Z)],Me.prototype,"dvs",void 0);class Te extends z{}e([C(l)],Te.prototype,"halfWidth",void 0),e([C(l)],Te.prototype,"aaWidth",void 0),e([C(l)],Te.prototype,"pxPerCell",void 0),e([C(s)],Te.prototype,"minorLineColor",void 0),e([C(s)],Te.prototype,"majorLineColor",void 0),e([C(D)],Te.prototype,"majorLineInterval",void 0);class Se extends o{constructor(){super(...arguments),this.type="GridShader"}vertex(t){const e=t.position.multiply(2).subtract(1);return{gridPos:this.transform.dvs.multiply(new c(e,1)).xy,glPosition:new s(e,0,1)}}fragment(t){const e=h(t.gridPos),i=B(e),o=p(i.x,new l(1).subtract(i.x)),s=p(i.y,new l(1).subtract(i.y)),n=new x(o,s).multiply(this.config.pxPerCell).subtract(this.config.halfWidth),r=p(n.x,n.y),u=new l(1).subtract(I(new l(0),this.config.aaWidth,r)),c=new D(N(e.x)),d=new D(N(e.y)),w=new l(F(c,this.config.majorLineInterval)),v=new l(F(d,this.config.majorLineInterval)),_=a(f(n.x,n.y),w,v),b=y(q(g(n.x,this.config.aaWidth),g(n.y,this.config.aaWidth)),new l(.5)),C=p(w,v),M=a(b,C,_),T=V(this.config.majorLineColor,this.config.minorLineColor,p(M,new l(1))),S=new m;return S.fragColor=T.multiply(u),S}}e([C(Me)],Se.prototype,"transform",void 0),e([C(Te)],Se.prototype,"config",void 0),e([i(0,S(Ce))],Se.prototype,"vertex",null),e([i(0,S(class extends P{}))],Se.prototype,"fragment",null);export{Rt as B,Se as G,ne as L,_e as M,Jt as O,te as P,oe as V,Xt as a,zt as b,xe as c,Kt as h,Pt as s};
