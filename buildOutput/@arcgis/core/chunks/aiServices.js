/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{t}from"./arcadeEnvironment.js";import{D as e}from"./Dictionary.js";import{A as r}from"./enum.js";import{s,c as o,O as n}from"./languageUtils.js";import a from"../core/Error.js";import{L as i}from"./Logger.js";import{g as c}from"./MapUtils.js";import l from"../portal/Portal.js";import u from"../request.js";import{g as p,p as h,a as d}from"./utils9.js";import{_ as m}from"./tslib.es6.js";import{JSONSupport as g}from"../core/JSONSupport.js";import{property as y}from"../core/accessorSupport/decorators/property.js";import{subclass as f}from"../core/accessorSupport/decorators/subclass.js";import{a as _}from"./commonProperties3.js";import{c as w,b as S}from"./guards.js";let x=class extends g{constructor(t){super(t),this.text=null,this.detectedLanguage="en",this.detectedLanguageScore=-1}};m([y({type:String,json:{write:!0}})],x.prototype,"key",void 0),m([y({type:String,json:{write:!0}})],x.prototype,"text",void 0),m([y({type:String,json:{read:{source:"detectedLanguage.language"},write:{target:"detectedLanguage.language"}}})],x.prototype,"detectedLanguage",void 0),m([y({type:Number,json:{read:{source:"detectedLanguage.score"},write:{target:"detectedLanguage.score"}}})],x.prototype,"detectedLanguageScore",void 0),m([y({type:Object,json:{write:!0}})],x.prototype,"translation",void 0),x=m([f("esri.rest.support.TranslateResult")],x);let v=class extends g{constructor(t){super(t)}};m([y({type:String,json:{write:!0}})],v.prototype,"key",void 0),m([y({type:String,json:{write:!0}})],v.prototype,"text",void 0),v=m([f("esri.rest.support.TranslateContent")],v);let j=class extends g{constructor(t){super(t),this.to=null,this.contents=null,this.portalUrl="https://www.arcgis.com",this.translator="esri",this.from=null,this.apiKey=null,this.requestSource=null}};m([y({type:[String],json:{write:!0}})],j.prototype,"to",void 0),m([y({type:[v],json:{write:!0}})],j.prototype,"contents",void 0),m([y({type:String,json:{write:!0}})],j.prototype,"portalUrl",void 0),m([y({type:String,json:{write:!0,default:"esri"}})],j.prototype,"translator",void 0),m([y({type:String,json:{write:!0}})],j.prototype,"from",void 0),m([y(_)],j.prototype,"apiKey",void 0),m([y({type:String,json:{name:"x-esri-request-source"}})],j.prototype,"requestSource",void 0),j=m([f("esri.rest.support.TranslateParameters")],j);class T{constructor(t,e){this.portal=t,this._debugLog=e}async translate(t){this.portal.loaded||await this.portal.load();const e=this.portal.helperServices?.aiUtilityServices;if(null==e)return{success:!1};const r=e.url+e.translateUtility;try{return t.requestSource??="arcade",{success:!0,results:(await async function(t,e,r){const s=e.toJSON();s.contents=JSON.stringify(s.contents),s.token=await p(e.portalUrl,e.apiKey,{signal:r?.signal,prompt:"no-prompt"!==r?.authMode});const o=h(t),n=d(o.query,{...r,query:s,method:"post",authMode:"anonymous"});return(await u(o.path,n)).data.results.map(t=>x.fromJSON(t))}(r,t,{authMode:"no-prompt"})).map(t=>t.toJSON())}}catch(t){return null!=this._debugLog&&(t instanceof Error||t instanceof a)&&this._debugLog(`TranslateText error: ${t.message}`),i.getLogger("esri.arcade.functions.aiServices").error(t),{success:!1}}}}class L{constructor(t,e,r){this._parameters=t,this._maxTotalContentSize=e,this._maxContentsLength=r,this._requests=[],this._normalizedContents=new Map,this._contentsTotalSize=0}tryAdd(t){const e=new Set(t.filter(t=>!this._normalizedContents.has(t.text)).map(t=>t.text));if(this._requests.length+e.size>this._maxContentsLength)return null;let r=0;for(const t of e)r+=t.length;if((r+this._contentsTotalSize)*(this._parameters.to.length??1)>this._maxTotalContentSize)return null;const s=this._requests.length;for(const{key:e,text:r}of t)c(this._normalizedContents,r,()=>[]).push({batchIdx:s,key:e});return this._requests.push(t),this._contentsTotalSize+=r,s}async send(t){const e=[],r=[];let s=0;for(const[t,o]of this._normalizedContents)e.push(new v({key:String(s++),text:t})),r.push(o);const o=new j(this._parameters);o.contents=e;const n=await t.translate(o);if(!n.success)return Array.from(this._requests,()=>n);const a=Array.from(this._requests,()=>({success:!0,results:[]}));for(const t of n.results){const e=Number(t.key);for(const s of r[e])a[s.batchIdx].results.push({...t,key:s.key})}return a}}function k(t){const e=[...new Set(t.to)].sort(),r=t.from??null,s=t.portalUrl,o=t.translator,n=t.apiKey??null;return JSON.stringify([e,r,s,o,n])}async function C(t,e,r){try{return(await t.yieldFor(r))[e]}catch{return{success:!1}}}const b=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:class{constructor(t,e,{maxTotalContentSize:r=5e4,maxContentsLength:s=1e3}={}){this._executor=t,this._service=e,this._openBatches=new Map,this._maxTotalContentSize=r,this._maxContentsLength=s}create(t){return{translate:async e=>{const r=k(e),{contents:s,to:o,from:n,translator:a,portalUrl:i,apiKey:c}=e;if(null==o)return{success:!1};if(null==s||s.every(t=>0===t.text.length))return{success:!1};const l=this._openBatches.get(r);if(null!=l){const e=l.data.tryAdd(s);if(null!=e)return await C(t,e,l);l.send()}const u=new L({to:o,from:n,translator:a,portalUrl:i,apiKey:c},this._maxTotalContentSize,this._maxContentsLength),p=u.tryAdd(s);if(null!=p){const e=this._executor.openBatch(u,{open:t=>{this._openBatches.set(r,t)},execute:t=>t.send(this._service),close:t=>{this._openBatches.get(r)===t&&this._openBatches.delete(r)}});return await C(t,p,e)}return await this._service.translate(e)}}}},PortalTranslationService:T,getTranslateParametersKey:k,registerFunctions:function(a){"async"===a.mode&&(a.functions[t("TranslateText")]=function(t,i){return a.standardFunctionAsync(t,i,async(t,a,i)=>{if(s(i,2,3,t,a),!w(i[0])&&!S(i[0])&&!o(i[0]))throw new r(t,"InvalidParameter",a);const c=n(i[0]);if(!w(i[1])&&!S(i[1])&&!o(i[1]))throw new r(t,"InvalidParameter",a);const u=n(i[1]);let p=null;if(i.length>=3){if(!w(i[2]))throw new r(t,"InvalidParameter",a);p=i[2]}const h=c.map((t,e)=>new v({key:String(e),text:t})),d=t.services?.portal??l.getDefault(),m=new j({to:u,contents:h,from:p,portalUrl:d.restUrl.replace(/\/sharing\/rest$/,"")}),g=new Map;let y=null;if(null!=t.lrucache){const e=t.lrucache;y??=k(m),m.contents=m.contents?.filter(t=>{const r=e.getCachedTranslation(y,t.text);return null==r||(g.set(t.key,{...r,key:t.key,text:t.text}),!1)})}if(m.contents?.length){const s=t.services?.translation??new T(d,t.console),o=await s.translate(m);if(!o.success)return new e({__proto__:null,success:!1});for(const e of o.results){const s=m.contents?.find(t=>t.key===e.key)?.text;if(null==s)throw new r(null,"NeverReach",null);g.set(e.key,e),null!=t.lrucache&&(y??=k(m),t.lrucache.setCachedTranslation(y,s,{detectedLanguage:e.detectedLanguage,translation:e.translation}))}}const f=Array.from(h,s=>{const o=x.fromJSON(g.get(s.key));if(null==o)throw new r(null,"NeverReach",null);return o.text=s.text,e.convertJsonToArcade(o.toJSON(),t.timeZone??"system",!0)});return new e({__proto__:null,success:!0,results:f})})})}},Symbol.toStringTag,{value:"Module"}));export{b as A};
