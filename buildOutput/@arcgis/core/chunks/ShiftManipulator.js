/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../Color.js";import{watch as t,initial as r}from"../core/reactiveUtils.js";import{b as i,f as s,c as o}from"./vec3f64.js";import{e as a,g as n,h as c,s as l,j as d,r as u,v as g,k as m,l as p,m as h,n as f,o as b,q as w,t as v,u as j,w as _,x as M,y as C,z as P}from"./sliceToolConfig.js";import{a as x,M as y,w as R,R as U,r as O}from"./RenderObject.js";import{m as S,c as T,i as k,n as W}from"./graphicUtils.js";import{R as A}from"./RibbonLineMaterial.js";import{k as D,m as H,f as L}from"./colorUtils2.js";import{c as I}from"./maybe.js";import{A as B}from"./orientedBoundingBox.js";import{a as F,i as G,N as E,k as V,R as z,aj as q,A as N,G as $}from"./Matrix4PassUniform.js";import{I as J}from"./ImageMaterial.js";import{h as K,B as Q,r as X,m as Y,k as Z,b as ee,v as te,j as re}from"./mat4.js";import{c as ie}from"./mat4f64.js";import{r as se}from"./quat.js";import{l as oe,i as ae,e as ne,j as ce,h as le,d as de,n as ue,k as ge,c as me,w as pe}from"./vec3.js";import{s as he,d as fe,e as be,g as we}from"./vector.js";import ve from"../analysis/SlicePlane.js";import"../core/lang.js";import{L as je}from"./Logger.js";import{r as _e,e as Me}from"./mathUtils.js";import{e as Ce}from"./screenUtils.js";import"../geometry/Extent.js";import Pe from"../geometry/Point.js";import{tryProjectWithZConversion as xe}from"./projectionUtils.js";import{c as ye,r as Re,n as Ue,u as Oe,f as Se,i as Te}from"./boundedPlane.js";import{b as ke,f as We}from"./plane.js";import{c as Ae}from"./ray.js";import{f as De}from"./vec4f64.js";import{O as He,a as Le,L as Ie}from"./LineVisualElement.js";import{c as Be}from"./vec4.js";import{F as Fe,i as Ge}from"./Emissions.glsl.js";import{D as Ee}from"./VertexColor.glsl.js";import{P as Ve}from"./DefaultLayouts.js";import{T as ze}from"./TriangleMaterial.js";import{g as qe}from"./glsl.js";import{S as Ne}from"./ShaderBuilder.js";import{m as $e,d as Je,p as Ke}from"./renderState.js";import{R as Qe}from"./RenderCoordsHelper.js";import{b as Xe}from"./ray2.js";import{C as Ye}from"./ColorMaterial.js";const Ze=De(0,0,0,.04);function et({accentColor:e}){return D(e,.5)}function tt({accentColor:e}){return D(e,.7)}const rt=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new Ne,{vertex:r,fragment:i,attributes:s,varyings:o}=t;return F(r,e),s.add("position","vec3"),s.add("uv0","vec2"),o.add("vUV","vec2"),r.main.add(qe`vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);`),i.uniforms.add(new G("backgroundColor",e=>e.backgroundColor),new G("gridColor",e=>e.gridColor),new Fe("gridWidth",e=>e.gridWidth)).main.add(qe`const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
fragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;`),t}},Symbol.toStringTag,{value:"Module"}));class it extends E{constructor(){super(...arguments),this.backgroundColor=De(1,0,0,.5),this.gridColor=De(0,1,0,.5),this.gridWidth=4}}class st extends V{constructor(e,t){super(e,t,new z(rt,()=>Promise.resolve().then(()=>rt)),Ve.locations)}initializePipeline(){return $e({blending:Ke,depthTest:{func:513},colorWrite:Je})}}class ot extends ze{constructor(e){super(e,nt),this.produces=new Map([[8,e=>Ge(e)]]),this._configuration=new q}get visible(){return!0}createGLMaterial(e){return new at(e)}createBufferWriter(){return new Ee(Ve)}getConfiguration(){return this._configuration}}class at extends N{constructor(e){super(e)}beginSlot(e){return this.getTechnique(st,e)}}class nt extends it{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1}}class ct extends He{constructor(e){super(e),this._material=null,this._renderOccluded=4,this._gridWidth=1,this._gridColor=De(1,0,0,1),this._backgroundColor=De(1,0,0,1),this.applyProperties(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(e){this._gridWidth!==e&&(this._gridWidth=e,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(e){Be(this._gridColor,e),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){Be(this._backgroundColor,e),this._updateMaterial()}createExternalResources(){this._material=new ot(this._materialParameters)}destroyExternalResources(){this._material=null}forEachMaterial(e){e(this._material)}createGeometries(e){if(null!=this._material){const t=S(this._material);e.addGeometry(t)}}get _materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateMaterial(){this._material?.setParameters(this._materialParameters)}}function lt(e,t,r,i,s,o,a,n){return function(e,t,r,i,s,o){const a=de(e,t),n=he.get(),c=he.get();switch(0===i?Math.abs(a)>g?1:2:i){case 2:{const i=Math.abs(a)<=d?e:r.viewUp;me(n,i,t),ne(c,t);break}case 1:me(n,r.viewUp,t),me(c,t,n);break;case 3:{const i=Math.abs(a)<=d?t:r.viewUp;me(n,i,e),me(c,e,n);break}}const l=me(he.get(),n,c);de(l,r.viewForward)>0&&ae(c,c,-1),ue(s,n),ue(o,c)}(t,a.worldUpAtPosition(e,he.get()),s,o,n.basis1,n.basis2),ae(n.basis1,n.basis1,r),ae(n.basis2,n.basis2,i),ne(n.origin,e),ke(n.basis2,n.basis1,n.origin,n.plane),n}function dt(e,t,r,i,s,o){const a=ne(he.get(),s.origin);ce(a,a,ae(he.get(),s.basis1,e.direction[0]<0?1:-1)),ce(a,a,ae(he.get(),s.basis2,e.direction[1]<0?1:-1));const c=oe(s.basis1),l=oe(s.basis2),d=le(he.get(),r,a),u=le(he.get(),t,a);let g=0,m=0;if(Ct(e)){const t=Mt(s),r=Mt(o);g=c-.5*e.direction[0]*de(s.basis1,u)/c,m=l-.5*e.direction[1]*de(s.basis2,u)/l;const i=r/t;g*=i,m*=i}const p=g+.5*e.direction[0]*de(s.basis1,d)/c,h=m+.5*e.direction[1]*de(s.basis2,d)/l,f=ae(he.get(),s.basis1,p/c),b=ae(he.get(),s.basis2,h/l);(p<=0||jt(o.origin,f,i)<=n)&&ne(f,o.basis1),(h<=0||jt(o.origin,b,i)<=n)&&ne(b,o.basis2);const w=ne(he.get(),a);return ce(w,w,ae(he.get(),f,e.direction[0]<0?-1:1)),ce(w,w,ae(he.get(),b,e.direction[1]<0?-1:1)),Se(w,f,b,o)}function ut(e,t){return c*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function gt(e,t,r,i){const s=me(he.get(),t,r);return me(s,s,t),We(e,s,i)}function mt(e,t){return x(e.basis1,e.basis2,e.origin,t)}function pt(e,t,r,i){const s=t.worldUpAtPosition(e.origin,he.get()),o=he.get();switch(r){case 1:ne(o,s);break;case 2:ne(o,e.basis1)}return We(e.origin,o,i)}function ht(e,t,r,s){const o=vt(r,2),a=be.get();K(a,t,o.edge*Math.PI/2);const n=ue(he.get(),o.basis);let c=ae(he.get(),n,o.direction*s.computeScreenPixelSizeAt(o.position)*l);ce(c,c,o.position);const d=s.projectToRenderScreen(c,Ce(he.get())),u=function(e,t){const[r,i,s,o]=e.viewport,a=Math.min(s,o)/16;let n=!0;return t[0]<r+a?(t[0]=r+a,n=!1):t[0]>r+s-a&&(t[0]=r+s-a,n=!1),t[1]<i+a?(t[1]=i+a,n=!1):t[1]>i+o-a&&(t[1]=i+o-a,n=!1),n}(s,d);Xe(s,d,kt),ue(kt.direction,kt.direction);const g=he.get();!u&&Te(r,kt,g)&&(c=g),a[12]=0,a[13]=0,a[14]=0,e.modelTransform=a,e.renderLocation=i(c),u?e.state|=Tt:e.state&=~Tt}function ft(e,t,r,i){const s=oe(i.basis1),o=oe(i.basis2),a=_t(i),n=Mt(i),c=ge(he.get(),0,0,0);ce(c,ae(he.get(),i.basis1,t.direction[0]),ae(he.get(),i.basis2,t.direction[1])),ce(c,i.origin,c);let l=0,d=1;if(Ct(t))1===t.direction[0]&&-1===t.direction[1]?l=Wt:1===t.direction[0]&&1===t.direction[1]?l=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(l=3*Math.PI/2),d=n;else{const e=0!==t.direction[0]?1:2;l=1===e?Wt:0,d=(1===e?o:s)-a}const u=Q(be.get(),l);Z(u,u,ge(he.get(),d,d,d)),Y(u,r,u),u[12]=0,u[13]=0,u[14]=0,e.modelTransform=u,e.renderLocation=c}function bt(e,t,r,i){const s=i.worldUpAtPosition(r.origin,he.get()),o=vt(r,0),a=Q(be.get(),o.edge*Math.PI/2);X(a,a,-Rt(r,s)),Y(a,t,a),a[12]=0,a[13]=0,a[14]=0,e.modelTransform=a,e.renderLocation=o.position}function wt(e,t,r){const i=vt(r,1),s=Q(be.get(),i.edge*Math.PI/2);X(s,s,Wt),Y(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=i.position}function vt(e,t){switch(t){case 0:return{basis:e.basis1,direction:1,position:ce(he.get(),e.origin,e.basis1),edge:t};case 1:return{basis:e.basis2,direction:1,position:ce(he.get(),e.origin,e.basis2),edge:t};case 2:return{basis:e.basis1,direction:-1,position:le(he.get(),e.origin,e.basis1),edge:t};case 3:return{basis:e.basis2,direction:-1,position:le(he.get(),e.origin,e.basis2),edge:t}}}function jt(e,t,r){const i=r.projectToRenderScreen(ce(he.get(),e,t),Ce(he.get())),s=r.projectToRenderScreen(le(he.get(),e,t),Ce(he.get()));return pe(le(i,i,s))}function _t(e){const t=oe(e.basis1),r=oe(e.basis2);return u*Math.min(t,r)}function Mt(e){return _t(e)}function Ct(e){return 0!==e.direction[0]&&0!==e.direction[1]}function Pt(e){return new Ie({view:e,attached:!1,color:tt(e.effectiveTheme),width:a,renderOccluded:4,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]],isDecoration:!0})}function xt(e){return new ct({view:e,attached:!1,backgroundColor:Ze,gridColor:et(e.effectiveTheme),gridWidth:4,renderOccluded:4,isDecoration:!0})}function yt(e,t,r,i=new ve){if(null==e)return null;const{renderCoordsHelper:s}=t,o=s.fromRenderCoords(e.origin,new Pe({spatialReference:t.spatialReference}));if(null==o)return null;const a=xe(o,r);if(null==a)return null;i.position=a;const n=2*oe(e.basis1),c=2*oe(e.basis2),l=Qe.renderUnitScaleFactor(t.spatialReference,r);i.width=n*l,i.height=c*l;const d=s.worldUpAtPosition(e.origin,he.get());return i.tilt=_e(Rt(e,d)),i.heading=s.headingAtPosition(e.origin,e.basis1)-90,i}function Rt(e,t){return fe(t,e.basis2,e.basis1)+Wt}function Ut(e,t){if(null==e?.position)return null;const r=Le(e.position,t.spatialReference,t.elevationProvider);if(null==r)return null;const i=Qe.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),s=e.width*i,o=e.height*i;return{position:r,heading:e.heading,tilt:e.tilt,renderWidth:s,renderHeight:o}}function Ot(e,t,r,i=ye()){if(null==e)return null;const s=function(e,t,r,i,s,o,a=ye()){return o.toRenderCoords(e,a.origin)?(o.worldBasisAtPosition(a.origin,0,a.basis1),o.worldBasisAtPosition(a.origin,1,a.basis2),ke(a.basis2,a.basis1,a.origin,a.plane),Re(a,-Me(t),Ue(a),a),Re(a,Me(r),a.basis1,a),ae(a.basis1,a.basis1,i/2),ae(a.basis2,a.basis2,s/2),Oe(a),a):(je.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,i);return r.tiltEnabled||null==s||function(e,t,r){const i=t.worldUpAtPosition(e.origin,he.get()),s=e.basis1,o=Rt(e,i),a=Math.round(o/Wt)*Wt;Re(e,a-o,s,r)}(s,t.renderCoordsHelper,s),s}const St=16,Tt=32,kt=Ae(),Wt=Math.PI/2,At=16,Dt=32;function Ht(e){return null!=("building-scene-3d"===e.type?e:null)}class Lt extends y{constructor(i,s){const o=Ct(s),a=o?m:p,n=a*h,c=p,l={renderOccluded:4,isDecoration:!0},d=new A({...l,width:a}),u=new A({...l,width:n}),g=new A({...l,width:c});super({view:i,...R,...It({isCorner:o,unfocusedMaterial:d,focusedMaterial:u,outlineMaterial:g})}),this._themeHandle=t(()=>i.effectiveTheme.accentColor,t=>{const r=e.toUnitRGBA(t);d.setParameters({color:r}),u.setParameters({color:r}),g.setParameters({color:r})},r)}destroy(){this._themeHandle.remove(),super.destroy()}}function It({isCorner:e,unfocusedMaterial:t,focusedMaterial:r,outlineMaterial:i}){const o=e?[s(1,0,0),s(0,0,0),s(0,1,0)]:[s(1,0,0),s(-1,0,0)];return{renderObjects:[new U(T(t,o),17),new U(T(r,o),18),new U(T(i,o),32)],collisionType:{type:"line",paths:[o]},radius:e?f:b,state:16}}class Bt extends y{constructor(i,s){const o=H(i.effectiveTheme.accentColor,.5),a=L(i.effectiveTheme.accentColor),n=s(o,a),c=new J({draped:!1,texture:n.texture,writeDepth:!1,renderOccluded:16,isDecoration:!0}),l=O.calloutWidth,d=new A({width:l,renderOccluded:4,isDecoration:!0});super({view:i,...Ft({imageMaterial:c,calloutMaterial:d})}),this._material=c,this._textureHandle=n,this._themeHandle=t(()=>i.effectiveTheme.accentColor,t=>{const r=H(t,.5),i=L(t),o=this._textureHandle;this._textureHandle=s(r,i),c.setParameters({texture:this._textureHandle.texture}),o?.release(),d.setParameters({color:e.toUnitRGBA(t)})},r)}destroy(){this._textureHandle=I(this._textureHandle),this._themeHandle.remove(),this._material.dispose(),super.destroy()}}function Ft({imageMaterial:e,calloutMaterial:t}){const{focusMultiplier:r,calloutLength:i,discRadius:s}=O,o=s*r,a=(e,t)=>{const r=[0,1,2,2,3,0];return new $(t,[["position",new B([i-e,-e,0,i+e,-e,0,i+e,e,0,i-e,e,0],r,3,!0)],["uv0",new B([0,0,1,0,1,1,0,1],r,2,!0)]])},n=T(t,[[0,0,0],[i-s,0,0]]),c=T(t,[[0,0,0],[i-o,0,0]]);return{autoScaleRenderObjects:!1,collisionPriority:1,collisionType:{type:"disc",direction:[0,0,1],offset:[i,0,0]},focusMultiplier:r,radius:s,renderObjects:[new U(a(s,e),17),new U(n,17),new U(a(o,e),18),new U(c,18)],state:16}}class Gt extends y{constructor(i,s){const o=new A({width:1,renderOccluded:4,isDecoration:!0}),a=new Ye({cullFace:2,renderOccluded:16,isDecoration:!0}),n=new Ye({cullFace:2,renderOccluded:16,isDecoration:!0}),c=new Ye({cullFace:2,renderOccluded:16,isDecoration:!0}),l=new Ye({writeDepth:!1,cullFace:1,renderOccluded:2,isDecoration:!0});super({view:i,...Et({offsetMode:s,tubeMaterial:a,tipMaterial:n,capMaterial:c,outlineMaterial:l,calloutMaterial:o})}),this._themeHandle=t(()=>i.effectiveTheme.accentColor,t=>{const r=L(t),i=e.toUnitRGBA(t),s=e.toUnitRGBA(r),d=e.toUnitRGBA(e.blendColors(r,t,.4)),u=e.toUnitRGBA(e.blendColors(r,t,.14));o.setParameters({color:i}),a.setParameters({color:u}),n.setParameters({color:s}),c.setParameters({color:d}),l.setParameters({color:i})},r)}destroy(){this._themeHandle.remove(),super.destroy()}}function Et({offsetMode:e,tubeMaterial:t,tipMaterial:r,capMaterial:i,outlineMaterial:a,calloutMaterial:n}){const c=0===e?l:0,d=[s(c,0,-_/2),s(c,0,_/2)],u=function(e){const t=le(o(),e[e.length-1],e[e.length-2]);ue(t,t),ae(t,t,v),ce(t,t,e[e.length-1]);{const r=le(o(),e[0],e[1]);return ue(r,r),ae(r,r,v),ce(r,r,e[0]),[r,...e,t]}}(d),g=Vt({vertices:d,padding:0,materials:{tube:t,tip:r,cap:i}}),m=Vt({vertices:d,padding:j,materials:{tube:a,tip:a,cap:a}}),p=T(n,[[c,0,0],[c-l,0,0]]),h=T(n,[[c,0,0],[c-l,0,0]]);return{renderObjects:[...g.normal.map(e=>new U(e,17)),...m.normal.map(e=>new U(e,17)),new U(p,17|Tt),...g.focused.map(e=>new U(e,18)),...m.focused.map(e=>new U(e,18)),new U(h,18|Tt)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[u]},collisionPriority:1,radius:w,state:16}}function Vt({vertices:e,padding:t,materials:r}){const i=i=>{const a=e.slice(),n=le(he.get(),a[0],a[1]);ue(n,n);const c=le(he.get(),a[a.length-1],a[a.length-2]);if(ue(c,c),t>0){const e=ae(o(),c,-t);a[a.length-1]=ce(e,e,a[a.length-1]);const r=ae(o(),n,-t);a[0]=ce(r,r,a[0])}const l=i?M:1,d=v*l,u=w*l,g=ee(be.get());if(t>0){const e=d/4,r=ge(he.get(),0,e,0),i=1+t/e;te(g,g,r),Z(g,g,ge(he.get(),i,i,i)),te(g,g,ae(r,r,-1/i))}const m=ee(ie()),p=s(0,1,0),h=re(ie(),se(we.get(),p,c));h[12]=a[a.length-1][0],h[13]=a[a.length-1][1],h[14]=a[a.length-1][2],Y(h,h,g);const f=r.tube,b=function(e,t,r){const i=[];for(let t=0;t<12;t++){const r=t/12*2*Math.PI;i.push([Math.cos(r)*e,Math.sin(r)*e])}return W(r,i,t,[],[],!1)}(C*(i?P:1)+t,a,f);b.transformation=m;const j=[b],_=r.tip,x=k(_,d,u,24,!1,!1,!0);x.transformation=h,j.push(x);const y=r.cap,R=k(y,d,u,24,!1,!0,!1);R.transformation=h,j.push(R);const U=re(ie(),se(we.get(),p,n));return U[12]=a[0][0],U[13]=a[0][1],U[14]=a[0][2],Y(U,U,g),j.push(x.instantiate({transformation:U})),j.push(R.instantiate({transformation:U})),j};return{normal:i(!1),focused:i(!0)}}export{St as D,Tt as I,Bt as R,Gt as S,Ot as a,yt as b,Lt as c,xt as d,Pt as e,pt as f,ut as g,lt as h,Ht as i,mt as j,bt as k,wt as l,ft as m,tt as n,Ze as o,Ut as p,gt as q,dt as r,et as s,Ct as t,ht as u,Mt as v,At as w,Dt as x};
