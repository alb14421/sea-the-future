/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{f as t,g as r,a as n,h as i}from"../geometry/Extent.js";import{isPolygon as s,isExtent as o,getJsonType as l}from"../geometry/support/jsonUtils.js";import{A as a}from"./unitUtils.js";import{h as u,q as p,i as c,j as f,k as m,l as y,r as R,m as S}from"./featureConversionUtils.js";import{O as d}from"./OptimizedGeometry.js";import{c as h}from"./projectionSupport.js";import{t as g}from"../core/lang.js";const G=new d,I=new d,j=new d,w={esriGeometryPoint:y,esriGeometryPolyline:m,esriGeometryPolygon:f,esriGeometryMultipoint:c};function v(e,t,r,n=e.hasZ,i=e.hasM){if(null==t)return null;const s=e.hasZ&&n,o=e.hasM&&i;if(r){const l=p(j,t,e.hasZ,e.hasM,"esriGeometryPoint",r,n,i);return y(l,s,o)}return y(t,s,o)}function N(e,t,r,n,i,s,o=t,l=r){const a=t&&o,c=r&&l,f=null!=n?"coords"in n?n:n.geometry:null;if(null==f)return null;if(i){let n=u(I,f,t,r,e,i,o,l);return s&&(n=p(j,n,a,c,e,s)),w[e]?.(n,a,c)??null}if(s){const n=p(j,f,t,r,e,s,o,l);return w[e]?.(n,a,c)??null}return R(G,f,t,r,o,l),w[e]?.(G,a,c)??null}function P(e){return e&&M in e?JSON.parse(JSON.stringify(e,O)):e}const M="_geVersion",O=(e,t)=>e===M?void 0:t;function E(e,t){return e?t?4:3:t?3:2}function T(e,t,r,n,i){if(!e)return!1;const s=E(t,r),{coords:o,lengths:l}=e;let a=!1,u=0;for(const e of l)a=b(a,o,s,u,e,n,i),u+=e*s;return a}function b(e,t,r,n,i,s,o){let l=e,a=n;for(let e=n,u=n+i*r;e<u;e+=r){a=e+r,a===u&&(a=n);const i=t[e],p=t[e+1],c=t[a],f=t[a+1];(p<o&&f>=o||f<o&&p>=o)&&i+(o-p)/(f-p)*(c-i)<s&&(l=!l)}return l}const C="unsupported-query",A={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},q={esriGeometryPoint:!0,esriGeometryMultiPatch:!1,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},x={esriGeometryPoint:!0,esriGeometryMultiPatch:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1},F={esriSpatialRelIntersects:()=>import("./intersectsOperator.js"),esriSpatialRelContains:()=>import("./containsOperator.js"),esriSpatialRelCrosses:()=>import("./crossesOperator.js"),esriSpatialRelDisjoint:()=>import("./disjointOperator.js"),esriSpatialRelEnvelopeIntersects:null,esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:()=>import("./overlapsOperator.js"),esriSpatialRelTouches:()=>import("./touchesOperator.js"),esriSpatialRelWithin:()=>import("./withinOperator.js"),esriSpatialRelRelation:null};async function U(e,l,a,u,p){if(s(l)){if("esriGeometryPoint"===a&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=S(new d,l,!1,!1);return t=>function(e,t,r,n){return T(e,!1,!1,n.coords[0],n.coords[1])}(e,0,0,t)}if("esriGeometryMultipoint"===a){const t=S(new d,l,!1,!1);if("esriSpatialRelContains"===e)return e=>function(e,t,r,n,i,s){const o=E(i,s),{coords:l,lengths:a}=n;if(!a)return!1;for(let t=0,r=0;t<a.length;t++,r+=o)if(!T(e,!1,!1,l[r],l[r+1]))return!1;return!0}(t,0,0,e,u,p)}}if(o(l)){if("esriGeometryPoint"===a&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return e=>n(l,N(a,u,p,e));if("esriGeometryMultipoint"===a&&"esriSpatialRelContains"===e)return e=>i(l,N(a,u,p,e));if("esriSpatialRelIntersects"===e){const e=function(e){return"mesh"===e?t:r(e)}(a);return t=>e(l,N(a,u,p,t))}}"esriSpatialRelEnvelopeIntersects"===e&&(e="esriSpatialRelIntersects");const c=await function(e){const t=F[e];if(null==t)throw new Error(`Cannot load unsupported spatial operator: ${e}`);return t()}(e);return e=>c.execute(l,N(a,u,p,e))}async function V(t,r,n){const{spatialRel:i,geometry:s}=t;if(s){if(null==(o=i)||!0!==A[o])throw new e(C,"Unsupported query spatial relationship",{query:t});var o;if(a(s.spatialReference)&&a(n)){if(!function(e){return null!=e&&!0===q[l(e)]}(s))throw new e(C,"Unsupported query geometry type",{query:t});if(!function(e){return null!=e&&!0===x[e]}(r))throw new e(C,"Unsupported layer geometry type",{query:t});if(t.outSR)return h(t.geometry?.spatialReference,t.outSR)}}}function Z(e){if(o(e))return!0;if(s(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1}async function _(e,t){if(!e)return null;const r=t.featureAdapter,{startTimeField:n,endTimeField:i}=e;let s=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;if(n&&i)await t.forEach(e=>{const t=r.getAttribute(g(e),n),l=r.getAttribute(g(e),i);null==t||isNaN(t)||(s=Math.min(s,t)),null==l||isNaN(l)||(o=Math.max(o,l))});else{const e=n||i;await t.forEach(t=>{const n=r.getAttribute(g(t),e);null==n||isNaN(n)||(s=Math.min(s,n),o=Math.max(o,n))})}return{start:s,end:o}}function D(e,t,r){if(!t||!e)return null;const{startTimeField:n,endTimeField:i}=e;if(!n&&!i)return null;const{start:s,end:o}=t;if(null===s&&null===o)return null;if(void 0===s&&void 0===o)return()=>!1;const l=r.getAttributeAsTimestamp?.bind(r)??r.getAttribute.bind(r);return n&&i?function(e,t,r,n,i){return null!=n&&null!=i?s=>{const o=e(s,t),l=e(s,r);return(null==o||o<=i)&&(null==l||l>=n)}:null!=n?t=>{const i=e(t,r);return null==i||i>=n}:null!=i?r=>{const n=e(r,t);return null==n||n<=i}:void 0}(l,n,i,s,o):function(e,t,r,n){return null!=r&&null!=n&&r===n?n=>e(n,t)===r:null!=r&&null!=n?i=>{const s=e(i,t);return null!=s&&s>=r&&s<=n}:null!=r?n=>{const i=e(n,t);return null!=i&&i>=r}:null!=n?r=>{const i=e(r,t);return null!=i&&i<=n}:void 0}(l,n||i,s,o)}export{D as a,N as b,P as c,V as d,_ as e,Z as f,U as g,v as t};
