/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{m as e}from"./mathUtils.js";import{f as t}from"./maybe.js";import{c as a}from"./mat3f32.js";import{f as i}from"./vec4f32.js";import{q as n,r,u as s}from"./definitions.js";import{a as o,D as l}from"./enums.js";import{V as c}from"./VertexArrayObject.js";import{V as f}from"./VertexBuffer.js";import{c as u,f as d}from"./vec2f32.js";import{f as p}from"./config.js";class m{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(e,t){}draw(e,t,a){}drawMany(e,t,a){for(const i of t)i.visible&&this.draw(e,i,a)}}class y extends m{constructor(){super(...arguments),this._color=i(1,0,0,1),this._patternMatrix=a(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao=t(this._vao)}drawMany(t,a){const{context:i,painter:s,requestRender:l,allowDelayedRender:c}=t;this._loadWGLResources(t);const f=t.displayLevel,u=t.styleLayer,d=u.backgroundMaterial,p=s.vectorTilesMaterialManager,m=u.getPaintValue("background-color",f),y=u.getPaintValue("background-opacity",f),g=u.getPaintValue("background-pattern",f),_=void 0!==g,M=1|window.devicePixelRatio,h=t.spriteMosaic;let v,U;const x=M>r?2:1,P=this._programOptions;P.pattern=_;const E=p.getMaterialProgram(i,d,P);if(!c||null==l||E.compiled){if(i.bindVAO(this._vao),i.useProgram(E),_){const e=h.getMosaicItemPosition(g,!0);if(null!=e){const{tl:t,br:a,page:r}=e;v=a[0]-t[0],U=a[1]-t[1];const s=h.getPageSize(r);null!=s&&(h.bind(i,9729,r,n),E.setUniform4f("u_tlbr",t[0],t[1],a[0],a[1]),E.setUniform2fv("u_mosaicSize",s),E.setUniform1i("u_texture",n))}E.setUniform1f("u_opacity",y)}else{const e=m[3]*y;this._color[0]=e*m[0],this._color[1]=e*m[1],this._color[2]=e*m[2],this._color[3]=e,E.setUniform4fv("u_color",this._color)}E.setUniform1f("u_depth",u.z||0);for(const t of a){if(E.setUniform1f("u_coord_range",t.rangeX),E.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),_){const a=Math.max(2**(Math.round(f)-t.key.level),1),i=x*t.width*a,n=i/e(v),r=i/e(U);this._patternMatrix[0]=n,this._patternMatrix[4]=r,E.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}i.setStencilFunction(514,0,255),i.drawArrays(o.TRIANGLE_STRIP,0,4)}}else l()}_loadWGLResources(e){if(this._vao)return;const{context:t,styleLayer:a}=e,i=a.backgroundMaterial,n=new Int8Array([0,0,1,0,0,1,1,1]),r=new f(t,i.geometryLayout,n);this._vao=new c(t,r)}}class g extends m{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(e,t){const{context:a,displayLevel:i,requiredLevel:n,state:r,painter:s,spriteMosaic:c,styleLayerUID:f,requestRender:u,allowDelayedRender:d}=e;if(!t.some(e=>e.layerData.get(f)?.circleIndexCount??!1))return;const p=e.styleLayer,m=p.circleMaterial,y=s.vectorTilesMaterialManager,g=p.getPaintValue("circle-translate",i),_=p.getPaintValue("circle-translate-anchor",i),M=this._programOptions,h=y.getMaterialProgram(a,m,M);if(d&&null!=u&&!h.compiled)return void u();a.useProgram(h),h.setUniformMatrix3fv("u_displayMat3",1===_?r.displayMat3:r.displayViewMat3),h.setUniform2fv("u_circleTranslation",g),h.setUniform1f("u_depth",p.z),h.setUniform1f("u_antialiasingWidth",1.2);let v=-1;for(const e of t){if(!e.layerData.has(f))continue;e.key.level!==v&&(v=e.key.level,m.setDataUniforms(h,i,p,v,c));const t=e.layerData.get(f);if(!t.circleIndexCount)continue;t.prepareForRendering(a);const r=t.vao;null!=r&&(a.bindVAO(r),h.setUniformMatrix3fv("u_dvsMat3",e.transforms.displayViewScreenMat3),n!==e.key.level?a.setStencilFunction(514,e.stencilRef,255):a.setStencilFunction(516,255,255),a.drawElements(o.TRIANGLES,t.circleIndexCount,l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t.circleIndexStart),e.triangleCount+=t.circleIndexCount/3)}}}const _=1/65536;class M extends m{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(e,t){const{displayLevel:a,renderPass:i,spriteMosaic:n,styleLayerUID:r}=e;let s=!1;for(const e of t)if(e.layerData.has(r)){const t=e.layerData.get(r);if(t.fillIndexCount>0||t.outlineIndexCount>0){s=!0;break}}if(!s)return;const o=e.styleLayer,l=o.getPaintProperty("fill-pattern"),c=void 0!==l,f=c&&l.isDataDriven;let u;if(c&&!f){const e=l.getValue(a);u=n.getMosaicItemPosition(e,!0)}const d=!c&&o.getPaintValue("fill-antialias",a);let p=!0,m=1;if(!c){const e=o.getPaintProperty("fill-color"),t=o.getPaintProperty("fill-opacity");if(!e?.isDataDriven&&!t?.isDataDriven){const e=o.getPaintValue("fill-color",a);m=o.getPaintValue("fill-opacity",a)*e[3],m>=1&&(p=!1)}}if(p&&"opaque"===i)return;const y=o.getPaintValue("fill-translate",a),g=o.getPaintValue("fill-translate-anchor",a);(p||"translucent"!==i)&&this._drawFill(e,r,o,t,y,g,c,u,f);const _=!o.hasDataDrivenOutlineColor&&o.outlineUsesFillColor&&m<1;d&&"opaque"!==i&&!_&&this._drawOutline(e,r,o,t,y,g)}_drawFill(e,t,a,i,s,c,f,u,d){if(f&&!d&&null==u)return;const{context:p,displayLevel:m,state:y,painter:g,pixelRatio:M,spriteMosaic:h,requestRender:v,allowDelayedRender:U}=e,x=a.fillMaterial,P=g.vectorTilesMaterialManager,E=M>r?2:1,S=this._fillProgramOptions;S.pattern=f;const D=P.getMaterialProgram(p,x,S);if(U&&null!=v&&!D.compiled)return void v();if(p.useProgram(D),null!=u){const{page:e}=u,t=h.getPageSize(e);null!=t&&(h.bind(p,9729,e,n),D.setUniform2fv("u_mosaicSize",t),D.setUniform1i("u_texture",n))}D.setUniformMatrix3fv("u_displayMat3",1===c?y.displayMat3:y.displayViewMat3),D.setUniform2fv("u_fillTranslation",s),D.setUniform1f("u_depth",a.z+_);let I=-1;for(const e of i){if(!e.layerData.has(t))continue;e.key.level!==I&&(I=e.key.level,x.setDataUniforms(D,m,a,I,h));const i=e.layerData.get(t);if(!i.fillIndexCount)continue;i.prepareForRendering(p);const r=i.fillVAO;if(null!=r){if(p.bindVAO(r),D.setUniformMatrix3fv("u_dvsMat3",e.transforms.displayViewScreenMat3),p.setStencilFunction(514,e.stencilRef,255),f){const t=Math.max(2**(Math.round(m)-e.key.level),1),a=e.rangeX/(E*e.width*t);D.setUniform1f("u_patternFactor",a)}if(d){const e=i.patternMap;if(!e)continue;for(const[t,a]of e){const e=h.getPageSize(t);null!=e&&(h.bind(p,9729,t,n),D.setUniform2fv("u_mosaicSize",e),D.setUniform1i("u_texture",n),p.drawElements(o.TRIANGLES,a[1],l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]))}}else p.drawElements(o.TRIANGLES,i.fillIndexCount,l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i.fillIndexStart);e.triangleCount+=i.fillIndexCount/3}}}_drawOutline(e,t,a,i,n,r){const{context:s,displayLevel:c,state:f,painter:u,pixelRatio:d,spriteMosaic:p,requestRender:m,allowDelayedRender:y}=e,g=a.outlineMaterial,M=u.vectorTilesMaterialManager,h=.75/d,v=this._outlineProgramOptions,U=M.getMaterialProgram(s,g,v);if(y&&null!=m&&!U.compiled)return void m();s.useProgram(U),U.setUniformMatrix3fv("u_displayMat3",1===r?f.displayMat3:f.displayViewMat3),U.setUniform2fv("u_fillTranslation",n),U.setUniform1f("u_depth",a.z+_),U.setUniform1f("u_outline_width",h);let x=-1;for(const e of i){if(!e.layerData.has(t))continue;e.key.level!==x&&(x=e.key.level,g.setDataUniforms(U,c,a,x,p));const i=e.layerData.get(t);if(i.prepareForRendering(s),!i.outlineIndexCount)continue;const n=i.outlineVAO;null!=n&&(s.bindVAO(n),U.setUniformMatrix3fv("u_dvsMat3",e.transforms.displayViewScreenMat3),s.setStencilFunction(514,e.stencilRef,255),s.drawElements(o.TRIANGLES,i.outlineIndexCount,l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i.outlineIndexStart),e.triangleCount+=i.outlineIndexCount/3)}}}class h extends m{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(e,t){const{context:a,displayLevel:i,state:r,painter:s,pixelRatio:c,spriteMosaic:f,styleLayerUID:u,requestRender:d,allowDelayedRender:p}=e;if(!t.some(e=>e.layerData.get(u)?.lineIndexCount??!1))return;const m=e.styleLayer,y=m.lineMaterial,g=s.vectorTilesMaterialManager,_=m.getPaintValue("line-translate",i),M=m.getPaintValue("line-translate-anchor",i),h=m.getPaintProperty("line-pattern"),v=void 0!==h,U=v&&h.isDataDriven;let x,P;if(v&&!U){const e=h.getValue(i);x=f.getMosaicItemPosition(e)}let E=!1;if(!v){const e=m.getPaintProperty("line-dasharray");if(P=void 0!==e,E=P&&e.isDataDriven,P&&!E){const t=e.getValue(i),a=m.getDashKey(t,m.getLayoutValue("line-cap",i));x=f.getMosaicItemPosition(a)}}const S=1/c,D=this._programOptions;D.pattern=v,D.sdf=P;const I=g.getMaterialProgram(a,y,D);if(p&&null!=d&&!I.compiled)return void d();if(a.useProgram(I),I.setUniformMatrix3fv("u_displayViewMat3",r.displayViewMat3),I.setUniformMatrix3fv("u_displayMat3",1===M?r.displayMat3:r.displayViewMat3),I.setUniform2fv("u_lineTranslation",_),I.setUniform1f("u_depth",m.z),I.setUniform1f("u_antialiasing",S),x&&null!=x){const{page:e}=x,t=f.getPageSize(e);null!=t&&(f.bind(a,9729,e,n),I.setUniform2fv("u_mosaicSize",t),I.setUniform1i("u_texture",n))}let w=-1;for(const e of t){if(!e.layerData.has(u))continue;e.key.level!==w&&(w=e.key.level,y.setDataUniforms(I,i,m,w,f));const t=2**(i-w)/c;I.setUniform1f("u_zoomFactor",t);const r=e.layerData.get(u);if(!r.lineIndexCount)continue;r.prepareForRendering(a);const s=r.vao;if(null!=s){if(a.bindVAO(s),I.setUniformMatrix3fv("u_dvsMat3",e.transforms.displayViewScreenMat3),a.setStencilFunction(514,e.stencilRef,255),U||E){const e=r.patternMap;if(!e)continue;for(const[t,i]of e){const e=f.getPageSize(t);null!=e&&(f.bind(a,9729,t,n),I.setUniform2fv("u_mosaicSize",e),I.setUniform1i("u_texture",n),a.drawElements(o.TRIANGLES,i[1],l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]))}}else a.drawElements(o.TRIANGLES,r.lineIndexCount,l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*r.lineIndexStart);e.triangleCount+=r.lineIndexCount/3}}}}const v=256/360,U=1/Math.LN2;function x(e){return t=e*v,(t%=256)>=0?t:t+256;var t}function P(e){return Math.log(e)*U}const E=1/65536;class S extends m{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=u()}dispose(){}drawMany(e,t){const a=e.styleLayer;this._drawIcons(e,a,t),this._drawText(e,a,t)}_drawIcons(e,t,a){const{context:i,displayLevel:r,painter:s,spriteMosaic:o,state:l,styleLayerUID:c,requestRender:f,allowDelayedRender:u}=e,d=t.iconMaterial,m=s.vectorTilesMaterialManager;let y,g=!1;for(const e of a)if(e.layerData.has(c)&&(y=e.layerData.get(c),y.iconPerPageElementsMap.size>0)){g=!0;break}if(!g)return;const _=t.getPaintValue("icon-translate",r),M=t.getPaintValue("icon-translate-anchor",r);let h=t.getLayoutValue("icon-rotation-alignment",r);2===h&&(h=0===t.getLayoutValue("symbol-placement",r)?1:0);const v=0===h,U=t.getLayoutValue("icon-keep-upright",r)&&v,P=y.isIconSDF,E=this._iconProgramOptions;E.sdf=P;const S=m.getMaterialProgram(i,d,E);if(u&&null!=f&&!S.compiled)return void f();i.useProgram(S),S.setUniformMatrix3fv("u_displayViewMat3",0===h?l.displayViewMat3:l.displayMat3),S.setUniformMatrix3fv("u_displayMat3",1===M?l.displayMat3:l.displayViewMat3),S.setUniform2fv("u_iconTranslation",_),S.setUniform1f("u_depth",t.z),S.setUniform1f("u_mapRotation",x(l.rotation)),S.setUniform1f("u_keepUpright",U?1:0),S.setUniform1f("u_level",10*r),S.setUniform1i("u_texture",n),S.setUniform1f("u_fadeDuration",p/1e3);let D=-1;for(const n of a){if(!n.layerData.has(c))continue;if(n.key.level!==D&&(D=n.key.level,d.setDataUniforms(S,r,t,D,o)),y=n.layerData.get(c),0===y.iconPerPageElementsMap.size)continue;y.prepareForRendering(i),y.updateOpacityInfo();const a=y.iconVAO;if(null!=a){i.bindVAO(a),S.setUniformMatrix3fv("u_dvsMat3",n.transforms.displayViewScreenMat3),S.setUniform1f("u_time",(performance.now()-y.lastOpacityUpdate)/1e3);for(const[t,a]of y.iconPerPageElementsMap)this._renderIconRange(e,S,a,t,n)}}}_renderIconRange(e,t,a,i,r){const{context:s,spriteMosaic:c}=e;this._spritesTextureSize[0]=c.getWidth(i)/4,this._spritesTextureSize[1]=c.getHeight(i)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),c.bind(s,9729,i,n),this._setStencilState(e,r),s.drawElements(o.TRIANGLES,a[1],l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),r.triangleCount+=a[1]/3}_drawText(e,t,a){const{context:i,displayLevel:n,glyphMosaic:r,painter:o,pixelRatio:l,spriteMosaic:c,state:f,styleLayerUID:u,requestRender:m,allowDelayedRender:y}=e,g=t.textMaterial,_=o.vectorTilesMaterialManager;let M,h=!1;for(const e of a)if(e.layerData.has(u)&&(M=e.layerData.get(u),M.glyphPerPageElementsMap.size>0)){h=!0;break}if(!h)return;const v=t.getPaintProperty("text-opacity");if(v&&!v.isDataDriven&&0===v.getValue(n))return;const U=t.getPaintProperty("text-color"),P=!U||U.isDataDriven||U.getValue(n)[3]>0,S=t.getPaintProperty("text-halo-width"),D=t.getPaintProperty("text-halo-color"),I=(!S||S.isDataDriven||S.getValue(n)>0)&&(!D||D.isDataDriven||D.getValue(n)[3]>0);if(!P&&!I)return;let w=t.getLayoutValue("text-rotation-alignment",n);2===w&&(w=0===t.getLayoutValue("symbol-placement",n)?1:0);const V=0===w,T=t.getLayoutValue("text-keep-upright",n)&&V,R=.8*3/l;this._glyphTextureSize||(this._glyphTextureSize=d(r.width/4,r.height/4));const L=t.getPaintValue("text-translate",n),N=t.getPaintValue("text-translate-anchor",n),b=this._sdfProgramOptions,A=_.getMaterialProgram(i,g,b);if(y&&null!=m&&!A.compiled)return void m();i.useProgram(A),A.setUniformMatrix3fv("u_displayViewMat3",0===w?f.displayViewMat3:f.displayMat3),A.setUniformMatrix3fv("u_displayMat3",1===N?f.displayMat3:f.displayViewMat3),A.setUniform2fv("u_textTranslation",L),A.setUniform1f("u_depth",t.z+E),A.setUniform2fv("u_mosaicSize",this._glyphTextureSize),A.setUniform1f("u_mapRotation",x(f.rotation)),A.setUniform1f("u_keepUpright",T?1:0),A.setUniform1f("u_level",10*n),A.setUniform1i("u_texture",s),A.setUniform1f("u_antialiasingWidth",R),A.setUniform1f("u_fadeDuration",p/1e3);let O=-1;for(const s of a){if(!s.layerData.has(u))continue;if(s.key.level!==O&&(O=s.key.level,g.setDataUniforms(A,n,t,O,c)),M=s.layerData.get(u),0===M.glyphPerPageElementsMap.size)continue;M.prepareForRendering(i),M.updateOpacityInfo();const a=M.textVAO;if(null==a)continue;i.bindVAO(a),A.setUniformMatrix3fv("u_dvsMat3",s.transforms.displayViewScreenMat3),this._setStencilState(e,s);const o=(performance.now()-M.lastOpacityUpdate)/1e3;A.setUniform1f("u_time",o),M.glyphPerPageElementsMap.forEach((e,t)=>{this._renderGlyphRange(i,e,t,r,A,I,P,s)})}}_renderGlyphRange(e,t,a,i,n,r,c,f){i.bind(e,9729,a,s),r&&(n.setUniform1f("u_halo",1),e.drawElements(o.TRIANGLES,t[1],l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),f.triangleCount+=t[1]/3),c&&(n.setUniform1f("u_halo",0),e.drawElements(o.TRIANGLES,t[1],l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),f.triangleCount+=t[1]/3)}_setStencilState(e,t){const{context:a,is3D:i,stencilSymbols:n}=e;if(a.setStencilTestEnabled(!0),n)return a.setStencilWriteMask(255),void a.setStencilFunction(519,t.stencilRef,255);a.setStencilWriteMask(0),i?a.setStencilFunction(514,t.stencilRef,255):a.setStencilFunction(516,255,255)}}export{S as W,y as a,g as b,h as c,M as d,m as e,P as l};
