/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{p as t}from"../request.js";import{f as r}from"./fetchService.js";import{i as o,d as a,g as s,p as i,c as p,a as l,L as n,l as c,e as m}from"./loadUtils.js";import{p as u,q as y,w as d}from"./layerUtils.js";import j from"../portal/Portal.js";import{a as f}from"./jsonContext.js";import{h as g}from"./portalItemUtils.js";import{l as w}from"./styleUtils2.js";import{f as h}from"./requestPresets.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./MapUtils.js";import"../core/promiseUtils.js";import"./handleUtils.js";import"./events.js";import"./maybe.js";import"./persistableUrlUtils.js";import"./associatedFeatureServiceUtils.js";import"../portal/PortalItem.js";import"./tslib.es6.js";import"./assets.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./metadata.js";import"./utils.js";import"./tracking.js";import"./ensureType.js";import"./Warning.js";import"./get.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"../core/Loadable.js";import"../core/Promise.js";import"./reader.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./pe.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"./locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../layers/catalog/catalogUtils.js";import"../core/reactiveUtils.js";import"./projectionUtils.js";import"./vec3f64.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"../geometry/Polyline.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./asyncUtils.js";async function b(t,o){const a=t.instance.portalItem;if(a?.id)return await a.load(o),function(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:r?.type,expectedType:t.supportedTypes.join(", ")})}(t),t.validateItem&&t.validateItem(a),async function(t,o){const a=t.instance,y=a.portalItem;if(!y)return;let{url:d}=y;const{title:j}=y,b=f(y,"portal-item");if("group"===a.type)return async function(t,o,a){const y=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:d,type:j}=y;if("Group Layer"===j){if(!g(y,"Map"))throw new e("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return async function(t,r){const o=t.portalItem,a=await o.fetchData("json");if(!a)return;if(!r.populateGroupLayer)throw new e("portal:missing-populate-group-layer","Missing populate group layer");const s=f(o,"web-map");t.read(a,s),await r.populateGroupLayer(t,a,{context:s}),t.resourceReferences={portalItem:o,paths:s.readResourcePaths??[]}}(t,a)}return t.read({title:d},o),async function(t,o){let a;const{portalItem:y}=t;if(!y)return;const d=y.type,j=o.layerModuleTypeMap;if(!j)throw new e("portal:missing-layer-module-type-map","Layer module type map is required to construct sub layers");switch(d){case"Feature Service":case"Feature Collection":a=j.FeatureLayer;break;case"Stream Service":a=j.StreamLayer;break;case"Scene Service":a=j.SceneLayer;break;case"Video Service":a=j.VideoLayer;break;default:throw new e("portal:unsupported-item-type-as-group",`The item type '${d}' is not supported as a 'GroupLayer'`)}const f="Video Service"===d,g=new n;let[w,{data:b}]=await Promise.all([a(),f?{data:null}:v(o,g)]),I=()=>w;if(f)return async function(e,t,r){const{portalItem:o}=e;if(!o?.url)return;const a=await h(o.url);a&&S(e,t,null,{layers:a.layers?.map(({id:e,name:t})=>({id:e,name:t}))},r)}(t,I,j);if("Feature Service"===d){const e=s(b)?.customParameters;b=y.url?(await i(b,y.url,g)).data:{},I=await async function(e,t){const{layers:r,tables:o}=e,a=[...r??[],...o??[]];if(!a.length)return;const s=new Set,i=[];for(const{layerType:e}of a){const r=e??"ArcGISFeatureLayer";if(s.has(r))continue;s.add(r);const o=t[c(r)];i.push(o())}const p=await Promise.all(i),l=new Map;return Array.from(s).forEach((e,t)=>{l.set(e,p[t])}),({layerType:e})=>{const t=e??"ArcGISFeatureLayer";return l.get(t)}}(b,j)||I;const{provider:o,preferredHost:a}=await async function(e,t){const{layersJSON:o,preferredHost:a}=await r(e,t);if(!o)return{provider:null,preferredHost:a};const s=[...o.layers,...o.tables];return{provider:e=>s.find(t=>t.id===e.id),preferredHost:a}}(y.url,{customParameters:e,loadContext:g});return u(y,a),await S(t,I,I,b,j,o)}return"Scene Service"===d&&y.url&&(b=await p(y,b,g)),l(b)>0?await S(t,I,null,b,j):await async function(e,t,r){const{portalItem:o}=e;if(!o?.url)return;const a=await h(o.url);a&&S(e,t,null,{layers:a.layers?.map(m),tables:a.tables?.map(m)},r)}(t,I,j)}(t,a)}(a,b,t);d&&"media"!==a.type&&a.read({url:d},b);const I=new n,{data:P,preferredHost:T}=await v(t,I,o);return d=y.url,"isUrlHostModified"in a&&(T?a.applyPreferredHost({preferredHost:T}):a.applyHostFromPortalItem()),P&&a.read(P,b),a.resourceReferences={portalItem:y,paths:b.readResourcePaths??[]},"subtype-group"!==a.type&&a.read({title:j},b),w(a,b)}(t,o)}async function S(e,t,r,o,a,s){let i=o.layers||[];const p=o.tables||[];if("Feature Collection"===e.portalItem?.type?(i.forEach((e,t)=>{e.id=t,"Table"===e?.layerDefinition?.type&&p.push(e)}),i=i.filter(e=>"Table"!==e?.layerDefinition?.type)):(i.reverse(),p.reverse()),i.forEach(r=>{const a=s?.(r);if(a||!s){const s=I(e,t(r),o,r,a);e.add(s)}}),p.length){const t=r?null:await a.FeatureLayer();p.forEach(a=>{const i=s?.(a);if(i||!s){const s=I(e,r?r(a):t,o,a,i);e.tables.add(s)}})}}function I(e,t,r,o,a){const s=e.portalItem,i={portalItem:s.clone(),layerId:o.id};null!=o.url&&(i.url=o.url);const p=new t(i);if("sourceJSON"in p&&(p.sourceJSON=a),"subtype-group"!==p.type&&"catalog"!==p.type&&(p.sublayerTitleMode="service-name"),"Feature Collection"===s.type){const e={origin:"portal-item",portal:s.portal||j.getDefault()};p.read(o,e);const t=r.showLegend;null!=t&&p.read({showLegend:t},e)}return p}async function v(e,r,i){if(!1===e.supportsData)return{data:void 0};const p=e.instance,n=p.portalItem;if(!n)return{data:void 0};let c=null;try{c=await n.fetchData("json",i)}catch(e){}if(function(e){return"stream"!==e.type&&"layerId"in e}(p)){let e=null;const{count:i,preferredHost:m}=await async function(e,r,o){if(r?.layers&&r?.tables)return{count:l(r)};const a=t(e.url);if(!a)return{count:1};const i=a.url.path,p=await o.fetchServiceMetadata(i,{customParameters:s(r)?.customParameters}).catch(()=>null);return{count:(r?.layers?.length??p?.layers?.length??0)+(r?.tables?.length??p?.tables?.length??0),preferredHost:d(e)?y():null}}(n,c,r);if(u(n,m),(c?.layers||c?.tables)&&i>0){if(null==p.layerId){const e=o(p.type),t=e?.length?a(c,e)[0]:s(c);t&&(p.layerId=t.id)}e=function(e,t){const{layerId:r}=t,o=e.layers?.find(e=>e.id===r)||e.tables?.find(e=>e.id===r);return o&&function(e,t){const r="layerType"in e&&e.layerType,{type:o}=t;return!("feature"===o&&r&&"ArcGISFeatureLayer"!==e.layerType||"catalog"===o&&!r||"oriented-imagery"===o&&!r||"subtype-group"===o&&!r)}(o,t)?o:null}(c,p),"OrientedImageryLayer"===e?.layerType&&"oriented-imagery"===p.type&&p.supportedSourceTypes.add("Feature Layer"),e&&null!=c.showLegend&&(e.showLegend=c.showLegend)}return i>1&&"sublayerTitleMode"in p&&"service-name"!==p.sublayerTitleMode&&(p.sublayerTitleMode="item-title-and-service-name"),{data:e,preferredHost:m}}return{data:c}}export{b as load};
