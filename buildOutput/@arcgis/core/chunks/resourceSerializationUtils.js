/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../request.js";import t from"../core/Error.js";import{g as s}from"./MapUtils.js";import{b as r}from"./featureConversionUtils.js";import{O as i}from"./OptimizedGeometry.js";import a from"../geometry/SpatialReference.js";import{E as n,a as o,g as l}from"../rest/knowledgeGraphService.js";import{a as c}from"./object.js";class d{constructor(){this.version="",this.queryResult=new u}}class u{constructor(){this.featureResult=new y}}class y{constructor(){this.objectIdFieldName="",this.uniqueIdField=new p,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new f,this.geometryType=null,this.spatialReference=new a,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new m,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}}class p{constructor(){this.name="",this.isSystemMaintained=!1}}class f{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}}class m{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new h,this.translate=new _}}class h{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}}class _{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}}class g{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}}class T{constructor(){this.attributes=[],this.compressedGeometry=new w,this.centroid=new w,this.aggregateGeometries=[]}}class w{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}}const b=["ELEMENTUID","TYPENAME"],E={ELEMENTUID:"ELEMENTUID",TYPENAME:"TYPENAME"},N={ELEMENTUID:"ELEMENTUID",TYPENAME:"TYPENAME",FROMUID:"FROMUID",TOUID:"TOUID"},q={upperLeft:0,lowerLeft:1},F={sqlTypeBigInt:0,sqlTypeBinary:1,sqlTypeBit:2,sqlTypeChar:3,sqlTypeDate:4,sqlTypeDecimal:5,sqlTypeDouble:6,sqlTypeFloat:7,sqlTypeGeometry:8,sqlTypeGUID:9,sqlTypeInteger:10,sqlTypeLongNVarchar:11,sqlTypeLongVarbinary:12,sqlTypeLongVarchar:13,sqlTypeNChar:14,sqlTypeNVarChar:15,sqlTypeOther:16,sqlTypeReal:17,sqlTypeSmallInt:18,sqlTypeSqlXml:19,sqlTypeTime:20,sqlTypeTimestamp:21,sqlTypeTimestamp2:22,sqlTypeTinyInt:23,sqlTypeVarbinary:24,sqlTypeVarchar:25};function M(e){const t=new w;t.geometryType=c(n,e.geometry_type.value);const s=[],r=[];for(let t=0;t<e.lengths.length;t++)s.push(e.lengths[t]);for(let t=0;t<e.coords.length;t++)r.push(e.coords[t]);return t.lengths=s,t.coords=r,t}function I(e){const t=new g;return t.name=e.name,t.alias=e.alias,t.fieldType=c(o,e.field_type.value),t.sqlType=c(F,e.sql_type.value),t.domain=e.domain,t.defaultValue=e.default_value,t}function S(e){const t=I(e);return t.geometryType=c(n,e.geometry_type.value),t}async function k(r,i){i??=!1;const a={generateAllSublayers:i,namedTypeDefinitions:new Map};return await async function(s){const r=await e(s,{responseType:"array-buffer"}),i=await r.data;return async function(e){const s=new((await l()).MapOfObjectIdentifierSetsDecoder),r=s.decode(new Uint8Array(e)),i=new Map;if(0!==r.error_code)throw new t("knowledge-graph:layer-support-utils",r.error_message);const a=s.get_map_of_identifier_sets(),n=a.keys,o=n.size();for(let e=0;e<o;e++){const s=n.get(e),r=a.query_identifier_set(s),o=[];if(1===r.id_array_type.value){const e=r.get_globalid_array(),t=e.count();for(let s=0;s<t;s++)o.push(e.get_globalid_at(s))}else if(3===r.id_array_type.value){const e=r.get_identifier_array(),t=e.count();for(let s=0;s<t;s++)o.push(e.get_identifier_at(s).toString())}else if(2===r.id_array_type.value){const e=r.get_string_array(),t=e.count();for(let s=0;s<t;s++)o.push(e.get_string_at(s))}else{if(0!==r.id_array_type.value)throw new t("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const e=r.get_oid_array(),t=e.count();for(let s=0;s<t;s++)o.push(e.get_objectid_at(s).toString())}}i.set(s,o)}return s.delete(),i}(new Uint8Array(i))}(r).then(e=>{!function(e,t){for(const[r,i]of e){const e=s(t.namedTypeDefinitions,r,()=>({useAllData:!1,members:new Map}));for(const t of i)e.members.has(t)||e.members.set(t,{id:t})}}(e,a)}),a}async function D(e,t,s){const r=await l(),i=new r.FeatureCollection;try{v(i,r,e,"entities",t,s);const a=new r.FeatureCollectionEncoder,n=G(i,a),o=structuredClone(n);return a.delete(),o}finally{i.delete()}}async function A(e,t,s){const r=await l(),i=new r.FeatureCollection;try{v(i,r,e,"relationships",t,s);const a=new r.FeatureCollectionEncoder,n=G(i,a),o=structuredClone(n);return a.delete(),o}finally{i.delete()}}async function L(e){const s=await l(),r=new s.MapOfObjectIdentifierSets;!function(e,t,s){for(const[r,i]of s.namedTypeDefinitions){if(!i.members||i.useAllData)continue;const s=i.members.keys();let a=!1,n=!0;const o=new t.ObjectIdArray,l=new t.StringArray,c=new t.GlobalIdArray,d=new t.IdentifierArray,u=new t.ObjectIdentifierSet;for(const e of s)n&&(a=!isNaN(Number(e)),n=!1),a?o.add_objectid(Number(e)):(l.add_string(e),c.add_globalid(e)),d.add_identifier(e);u.set_oid_array(o),u.set_string_array(l),u.set_globalid_array(c),u.set_identifier_array(d),o.delete(),l.delete(),c.delete(),d.delete(),e.put_identifier_set(r,u),u.delete()}}(r,s,e);const i=new s.MapOfObjectIdentifierSetsEncoder;try{i.set_map_of_identifier_sets(r),i.encode();const e=i.get_encoding_result();if(0!==e.error.error_code)throw new t("knowledge-graph:layer-support-utils",e.error.error_message);const s=structuredClone(e.get_byte_buffer());return i.delete(),s}finally{r.delete()}}function v(e,t,s,i,a,n){e.version="";const l=new t.QueryResult,c=new t.FeatureResult,d="entities"===i?E:N;c.unique_id_field={name:d[d.ELEMENTUID],isSystemMaintained:!1},c.globalid_field_name=d[d.ELEMENTUID],c.geohash_field_name="",c.geometry_properties={shapeAreaFieldName:"",shapeLengthFieldName:"",units:""},c.spatial_reference={wkid:4326,latestWkid:4326,vcsWkid:0,latestVcsWkid:0,wkt:""},c.exceeded_transfer_limit=!1,c.has_z=!1,c.has_m=!1,c.transform={quantizeOriginPosition:{value:q.upperLeft},scale:{xScale:1e-9,yScale:1e-9,mScale:1e-4,zScale:1e-4},translate:{xTranslate:-400,yTranslate:-400,mTranslate:-1e5,zTranslate:-1e5}};for(const e of Object.keys(d).filter(e=>isNaN(Number(e)))){const s=new t.Field;if(s.name=e,s.alias=e,s.sql_type={value:F.sqlTypeBigInt},"entities"===i)switch(e){case d[d.ELEMENTUID]:case d[d.TYPENAME]:s.field_type={value:o.esriFieldTypeString}}else switch(e){case d[d.ELEMENTUID]:case d[d.TYPENAME]:case N[N.FROMUID]:case N[N.TOUID]:s.field_type={value:o.esriFieldTypeString}}s.domain="",c.add_field(s),s.delete()}const u=new Map;for(const e of a.dataModel.entityTypes)u.set(e.name,"entities");for(const e of a.dataModel.relationshipTypes)u.set(e.name,"relationships");for(const[e,a]of s.namedTypeDefinitions)if(i===u.get(e))for(const s of a.members.values()){const a=new t.Feature;for(const r of Object.keys(d).filter(e=>isNaN(Number(e))))if("entities"===i)switch(r){case d[d.ELEMENTUID]:a.add_attribute(s.id,t.esriFieldType.esriFieldTypeString);break;case d[d.TYPENAME]:a.add_attribute(e,t.esriFieldType.esriFieldTypeString)}else switch(r){case d[d.ELEMENTUID]:a.add_attribute(s.id,t.esriFieldType.esriFieldTypeString);break;case N[N.FROMUID]:a.add_attribute(n.has(s.id)?n.get(s.id)[0]:"",t.esriFieldType.esriFieldTypeString);break;case N[N.TOUID]:a.add_attribute(n.has(s.id)?n.get(s.id)[1]:"",t.esriFieldType.esriFieldTypeString);break;case d[d.TYPENAME]:a.add_attribute(e,t.esriFieldType.esriFieldTypeString)}let o;if(s.linkChartLocation&&"x"in s.linkChartLocation?o=r(s.linkChartLocation):s.linkChartLocation&&(o=s.linkChartLocation),s.linkChartLocation&&o){const e=new t.FeatureCollectionGeometry;let s=!1;switch(i){case"entities":e.geometry_type=t.esriGeometryType.esriGeometryPoint,s=!0;break;case"relationships":e.geometry_type=t.esriGeometryType.esriGeometryPolyline}e.coords=new Float64Array(o.coords),e.lengths=new Uint32Array(s?[1]:o.lengths),a.set_compressed_geometry(e),e.delete()}c.add_feature(a),a.delete()}switch(i){case"entities":c.geometry_type=t.esriGeometryType.esriGeometryPoint;break;case"relationships":c.geometry_type=t.esriGeometryType.esriGeometryPolyline}return l.set_feature_result(c),e.set_query_result(l),c.delete(),l.delete(),e}async function U(s){const r=await e(s,{responseType:"array-buffer"});return async function(e){const s=new((await l()).FeatureCollectionDecoder),r=s.decode(new Uint8Array(e));if(0!==r.error_code)throw new t("knowledge-graph:layer-support-utils",r.error_message);const i=function(e){const t=new d;t.version=e.version;const s=e.get_query_result();if(0!==s.results_type.value)throw new Error("Got a non-feature collection type");const r=s.get_feature_result(),i=t.queryResult.featureResult;i.objectIdFieldName=r.objectid_field_name,i.exceededTransferLimit=r.exceeded_transfer_limit,i.hasM=r.has_m,i.hasZ=r.has_z,i.geometryType=c(n,r.geometry_type.value),i.globalIdFieldName=r.globalid_field_name,i.geohashFieldName=r.geohash_field_name;const a=i.uniqueIdField,o=r.unique_id_field;a.name=o.name,a.isSystemMaintained=o.isSystemMaintained;const l=i.geometryProperties,u=r.geometry_properties;l.shapeAreaFieldName=u.shapeAreaFieldName,l.shapeLengthFieldName=u.shapeLengthFieldName,l.units=u.units;const y=i.spatialReference,p=r.spatial_reference;y.wkid=p.wkid,y.latestWkid=p.latestWkid,y.vcsWkid=p.vcsWkid,y.latestVcsWkid=p.latestVcsWkid,y.wkt=p.wkt,i.transform=function(e){const t=new m;t.quantizeOriginPosition=c(q,e.quantizeOriginPosition.value);const s=t.scale,r=e.scale;s.xScale=r.xScale,s.yScale=r.yScale,s.mScale=r.mScale,s.zScale=r.zScale;const i=t.translate,a=e.translate;return i.xTranslate=a.xTranslate,i.yTranslate=a.yTranslate,i.mTranslate=a.mTranslate,i.zTranslate=a.zTranslate,t}(r.transform);const f=i.fields,h=i.fieldNameToAttributeIndexMap,_=r.fields,g=_.size();for(let e=0;e<g;e++){const t=_.get(e),s=I(t);f.push(s),h[s.name]=e,t.delete()}_.delete();const w=i.values,E=r.values_count();for(let e=0;e<E;e++)w.push(r.get_value_at(e));const N=i.features,F=r.features,k=F.size();if(k>0)for(const e of b)if(void 0===h[e])throw new Error(`Feature collection missing required attribute: ${e}`);for(let e=0;e<k;e++){const t=new T,s=F.get(e),r=t.attributes,i=s.attributes_count();for(let e=0;e<i;e++)r.push(s.get_attribute_at(e));const a=s.get_compressed_geometry();a&&(t.compressedGeometry=M(a),t.centroid=M(s.get_centroid()));const n=t.aggregateGeometries,o=s.aggregate_geometries,l=o.size();for(let e=0;e<l;e++){const t=o.get(e),s=M(t);n.push(s),t.delete()}o.delete(),N.push(t),s.delete()}F.delete();const D=i.geometryFields,A=r.geometry_fields,L=A.size();for(let e=0;e<L;e++){const t=A.get(e),s=S(t);D.push(s),t.delete()}return A.delete(),t}(s.get_feature_collection());return s.delete(),i}(await r.data)}function O(e,t){if(!e?.queryResult?.featureResult)return t;const r=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const a of e.queryResult.featureResult.features){const e=a.attributes[r.TYPENAME],n=s(t.namedTypeDefinitions,e,()=>({useAllData:!1,members:new Map})),o=a.attributes[r.ELEMENTUID];if(a.compressedGeometry?.coords?.length>0){let e=a.compressedGeometry.lengths;"esriGeometryPoint"===a.compressedGeometry.geometryType&&(e=[]),n.members.set(o,{id:o,linkChartLocation:new i(e,a.compressedGeometry.coords)})}else n.members.set(o,{id:o})}return t}const G=(e,s)=>{s.set_feature_collection(e),s.encode();const r=s.get_encoding_result();if(0!==r.error.error_code)throw new t("knowledge-graph:layer-support-utils",r.error.error_message);return r.get_byte_buffer()},C={fetchAndConvertSerializedLinkChart:e=>async function(e){const t=[],s={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(U(e.entitiesUrl).then(e=>{O(e,s)})),e.relationshipsUrl&&t.push(U(e.relationshipsUrl).then(e=>{O(e,s)})),await Promise.all(t),s}(e)};export{D as a,A as b,C as c,k as f,L as s};
