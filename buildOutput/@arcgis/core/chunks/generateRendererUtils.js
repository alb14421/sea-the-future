/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{J as t}from"./jsonMap.js";import{JSONSupport as a}from"../core/JSONSupport.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{L as n}from"./Logger.js";import{e as s}from"./enumeration.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";const i=new t({esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation",esriClassifyDefinedInterval:"defined-interval"}),o=new t({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"});let u=class extends a{constructor(e){super(e),this.type="class-breaks-definition",this.breakCount=null,this.classificationField=null,this.classificationMethod=null,this.normalizationField=null,this.normalizationType=null}set standardDeviationInterval(e){"standard-deviation"===this.classificationMethod&&this._set("standardDeviationInterval",e)}set definedInterval(e){"defined-interval"===this.classificationMethod&&this._set("definedInterval",e)}};function c(e,t){return Number(e.toFixed(t))}function f(e){const t=m(e),a=[],l=t.uniqueValues.length;for(let e=0;e<l;e++){const l=t.uniqueValues[e],n=t.valueFrequency[e],s=l.toString();a.push({value:l,count:n,label:s})}return{uniqueValues:a}}function p(e,t){const{normalizationTotal:a}=e,l=function(e,t){const a=e.definition,{classificationMethod:l,normalizationType:n,definedInterval:s}=a,r=a.breakCount??1,i=[];let o=e.values;if(0===o.length)return[];o=o.sort((e,t)=>e-t);const[u,f]=t??[o.at(0),o.at(-1)];if("equal-interval"===l)if(o.length>=r){const e=(f-u)/r;let t=u;for(let a=1;a<r;a++){const l=c(u+a*e,6);i.push({minValue:t,maxValue:l,label:d(t,l,n)}),t=l}i.push({minValue:t,maxValue:f,label:d(t,f,n)})}else o.forEach(e=>{i.push({minValue:e,maxValue:e,label:d(e,e,n)})});else if("natural-breaks"===l){const t=m(o),a=e.valueFrequency||t.valueFrequency,l=function(e,t,a){const l=e.length,n=[];a>l&&(a=l);for(let e=0;e<a;e++)n.push(Math.round(e*l/a-1));n.push(l-1);let s=h(n,e,t,a);return function(e,t,a,l,n,s){let r=0,i=0,o=0,u=0,c=!0;for(let f=0;f<2&&c;f++){0===f&&(c=!1);for(let f=0;f<s-1;f++)for(;a[f+1]+1!==a[f+2];){a[f+1]=a[f+1]+1;const s=b(f,a,l,n);o=s.sbMean,r=s.sbSdcm;const p=b(f+1,a,l,n);if(u=p.sbMean,i=p.sbSdcm,!(r+i<t[f]+t[f+1])){a[f+1]=a[f+1]-1;break}t[f]=r,t[f+1]=i,e[f]=o,e[f+1]=u,c=!0}for(let f=s-1;f>0;f--)for(;a[f]!==a[f-1]+1;){a[f]=a[f]-1;const s=b(f-1,a,l,n);o=s.sbMean,r=s.sbSdcm;const p=b(f,a,l,n);if(u=p.sbMean,i=p.sbSdcm,!(r+i<t[f-1]+t[f])){a[f]=a[f]+1;break}t[f-1]=r,t[f]=i,e[f-1]=o,e[f]=u,c=!0}}return c}(s.mean,s.sdcm,n,e,t,a)&&(s=h(n,e,t,a)),n}(t.uniqueValues,a,r);let s=u;for(let e=1;e<r;e++)if(t.uniqueValues.length>e){const a=c(t.uniqueValues[l[e]],6);i.push({minValue:s,maxValue:a,label:d(s,a,n)}),s=a}i.push({minValue:s,maxValue:f,label:d(s,f,n)})}else if("quantile"===l)if(o.length>=r&&u!==f){let e=u,t=Math.ceil(o.length/r),a=0;for(let l=1;l<r;l++){let s=t+a-1;s>o.length&&(s=o.length-1),s<0&&(s=0),i.push({minValue:e,maxValue:o[s],label:d(e,o[s],n)}),e=o[s],a+=t,t=Math.ceil((o.length-a)/(r-l))}i.push({minValue:e,maxValue:f,label:d(e,f,n)})}else{let e=-1;for(let t=0;t<o.length;t++){const a=o[t];a!==e&&(e=a,i.push({minValue:e,maxValue:a,label:d(e,a,n)}),e=a)}}else if("standard-deviation"===l){const e=function(e){let t=0;for(let a=0;a<e.length;a++)t+=e[a];return t/=e.length,t}(o),t=function(e,t){let a=0;for(let l=0;l<e.length;l++){const n=e[l];a+=(n-t)*(n-t)}return a/=e.length,Math.sqrt(a)}(o,e);if(0===t)i.push({minValue:o[0],maxValue:o[0],label:d(o[0],o[0],n)});else{const a=function(e,t,a,l,n){let s=Math.max(l-e,t-l)/n/a;return s=s>=1?1:s>=.5?.5:.25,s}(u,f,r,e,t),l=a*t;let s=0,o=u;for(let t=r;t>=1;t--){const a=c(e-(t-.5)*l,6);i.push({minValue:o,maxValue:a,label:d(o,a,n)}),o=a,s++}let p=c(e+.5*l,6);i.push({minValue:o,maxValue:p,label:d(o,p,n)}),o=p,s++;for(let t=1;t<=r;t++)p=s===2*r?f:c(e+(t+.5)*l,6),i.push({minValue:o,maxValue:p,label:d(o,p,n)}),o=p,s++}}else if("defined-interval"===l){if(!s)return i;const[e,a]=t??[o.at(0),o.at(-1)],l=Math.ceil((a-e)/s);let r=e;for(let t=1;t<l;t++){const a=c(e+t*s,6);i.push({minValue:r,maxValue:a,label:d(r,a,n)}),r=a}i.push({minValue:r,maxValue:a,label:d(r,a,n)})}return i}(e,t);return{classBreaks:l,normalizationTotal:a}}function d(e,t,a){let l=null;return l=e===t?a&&"percent-of-total"===a?e+"%":e.toString():a&&"percent-of-total"===a?e+"% - "+t+"%":e+" - "+t,l}function m(e){const t=[],a=[];let l=Number.MIN_VALUE,n=1,s=-1;for(let r=0;r<e.length;r++){const i=e[r];i===l?(n++,a[s]=n):null!==i&&(t.push(i),l=i,n=1,a.push(n),s++)}return{uniqueValues:t,valueFrequency:a}}function h(e,t,a,l){let n=[],s=[],r=[],i=0;const o=[],u=[];for(let n=0;n<l;n++){const l=b(n,e,t,a);o.push(l.sbMean),u.push(l.sbSdcm),i+=u[n]}let c,f=i,p=!0;for(;p||i<f;){p=!1,n=[];for(let t=0;t<l;t++)n.push(e[t]);for(let a=0;a<l;a++)for(let n=e[a]+1;n<=e[a+1];n++)if(c=t[n],a>0&&n!==e[a+1]&&Math.abs(c-o[a])>Math.abs(c-o[a-1]))e[a]=n;else if(a<l-1&&e[a]!==n-1&&Math.abs(c-o[a])>Math.abs(c-o[a+1])){e[a+1]=n-1;break}f=i,i=0,s=[],r=[];for(let n=0;n<l;n++){s.push(o[n]),r.push(u[n]);const l=b(n,e,t,a);o[n]=l.sbMean,u[n]=l.sbSdcm,i+=u[n]}}if(i>f){for(let t=0;t<l;t++)e[t]=n[t],o[t]=s[t],u[t]=r[t];i=f}return{mean:o,sdcm:u}}function b(e,t,a,l){let s=0,r=0;for(let n=t[e]+1;n<=t[e+1];n++){const e=l[n];s+=a[n]*e,r+=e}r<=0&&n.getLogger("esri.rest.support.generateRendererUtils").warn("Exception in Natural Breaks calculation");const i=s/r;let o=0;for(let n=t[e]+1;n<=t[e+1];n++)o+=l[n]*(a[n]-i)**2;return{sbMean:i,sbSdcm:o}}e([s({classBreaksDef:"class-breaks-definition"})],u.prototype,"type",void 0),e([l({json:{write:!0}})],u.prototype,"breakCount",void 0),e([l({json:{write:!0}})],u.prototype,"classificationField",void 0),e([l({type:String,json:{read:i.read,write:i.write}})],u.prototype,"classificationMethod",void 0),e([l({json:{write:!0}})],u.prototype,"normalizationField",void 0),e([l({json:{read:o.read,write:o.write}})],u.prototype,"normalizationType",void 0),e([l({value:null,json:{write:!0}})],u.prototype,"standardDeviationInterval",null),e([l({value:null,json:{write:!0}})],u.prototype,"definedInterval",null),u=e([r("esri.rest.support.ClassBreaksDefinition")],u);export{u as C,f as a,p as c};
