/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{O as e}from"./ObjectPool.js";import{m as t}from"./handleUtils.js";import{equals as r,equalsShallow as s}from"../core/lang.js";import{schedule as n}from"../core/scheduling.js";import{c as l}from"./SetUtils.js";import{v as o}from"./get.js";import{L as i}from"./Lifecycle.js";import{r as u}from"./tracking.js";import{S as c}from"./SimpleTrackingTarget.js";import{a}from"./utils.js";function f(e){e.length=0}class d{constructor(t=50,r=50){this._pool=new e(Array,void 0,f,r,t)}acquire(){return this._pool.acquire()}release(e){this._pool.release(e)}prune(){this._pool.prune(0)}static acquire(){return h.acquire()}static release(e){return h.release(e)}static prune(){h.prune()}}const h=new d(100);class p extends e{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=null}acquire(...e){const t=super.acquire(...e);return this._set.delete(t),t}release(e){e&&!this._set.has(e)&&(super.release(e),this._set.add(e))}_dispose(e){this._set.delete(e),super._dispose(e)}}let m=0;const _=0;function v(){return++m}let g=!1;const q=[];function y(e,r){let s=new c(function t(){if(!s||l)return;if(g)return void w(t);const o=n;s.clear(),g=!0,l=!0,n=u(s,e),l=!1,g=!1,r(n,o),V()}),n=null,l=!1;return l=!0,n=u(s,e),l=!1,t(function(){s&&(s.destroy(),s=null,n=null)})}function k(e,r){let s=new c(function(){r(n,l)}),n=null;function l(){return s?(s.clear(),n=u(s,e),n):null}return l(),t(function(){s&&(s.destroy(),s=null),n=null})}function j(e,r){let s=!1,n=!1;const l=!!r?.sync;let o=new c(()=>{s||n||(n=!0,l?i():queueMicrotask(i))});function i(){n=!1,o&&!s&&(g?w(i):(o.clear(),g=!0,s=!0,u(o,e),s=!1,g=!1,V()))}return s=!0,u(o,e),s=!1,t(function(){o&&(o.destroy(),o=null)})}function w(e){q.includes(e)||q.unshift(e)}function V(){for(;q.length;)q.pop()()}class S{constructor(){this.uid=v(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static{this.pool=new p(S)}static acquireUntracked(e,t,s,n,l){return this.pool.acquire(0,e,t,s,n,l,r)}static acquireTracked(e,t,r,s){return this.pool.acquire(1,e,t,r,null,null,s)}notify(e,t){0===this.type?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t,void 0,void 0)}acquire(e,t,r,s,n,l,o){this.uid=v(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=r,this.getValue=s,this.target=n,this.path=l,this.equals=o}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=v(),this.removed=!0}}const b=new d,E=new Set;let T;function D(e){E.delete(e),E.add(e),T||(T=n(U))}function O(e){if(e.removed)return;const t=e.oldValue,r=e.getValue();e.equals(t,r)||(e.oldValue=r,e.notify(r,t))}function R(e){for(const t of E.values())t.target===e&&(t.removed=!0)}function U(){let e=10;for(;T&&e--;){T=null;const e=Y(),t=b.acquire();for(const r of e){const e=r.uid;O(r),e===r.uid&&r.removed&&t.push(r)}for(const e of E)e.removed&&(t.push(e),E.delete(e));for(const e of t)S.pool.release(e);b.release(t),b.release(e),x.forEach(e=>e())}}function Y(){const e=b.acquire();e.length=E.size;let t=0;for(const r of E)e[t]=r,++t;return E.clear(),e}const x=new Set;function A(e){return x.add(e),t(()=>x.delete(e))}function L(e,s,n,l=!1){return e.__accessor__&&e.__accessor__.lifecycle!==i.DESTROYED?l?function(e,t,s){const n=a(e,t,s,(e,t,s)=>{let l=!1;return y(()=>o(e,t),(o,u)=>{e.__accessor__.lifecycle!==i.DESTROYED?l||(l=!0,r(u,o)||s.call(e,o,u,t,e),l=!1):n.remove()})});return n}(e,s,n):function(e,r,s){let n=a(e,r,s,(e,r,s)=>{let l,u,c=k(()=>o(e,r),(t,o)=>{e.__accessor__?.lifecycle===i.DESTROYED||l&&l.uid!==u?n.remove():(l||(l=S.acquireUntracked(t,s,o,e,r),u=l.uid),D(l))});return t(()=>{c.remove(),l&&(l.uid!==u||l.removed||(l.removed=!0,D(l)),l=null),n=c=null})});return n}(e,s,n):t()}function z(e,r,n=!1,l=s){return n?function(e,t,r){let s=!1;return y(e,(e,n)=>{s||(s=!0,r(n,e)||t(e,n),s=!1)})}(e,r,l):function(e,r,s){let n,l,o=k(e,(e,t)=>{n&&n.uid!==l?o.remove():(n||(n=S.acquireTracked(e,r,t,s),l=n.uid),D(n))});return t(()=>{o.remove(),n&&(n.uid!==l||n.removed||(n.removed=!0,D(n)),n=null),o=null})}(e,r,l)}function M(e){return l(E,t=>t.oldValue===e)}export{d as A,p as R,j as a,L as b,A as c,U as d,V as e,v as g,M as i,_ as n,R as r,z as w};
