/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../Color.js";import n from"../Graphic.js";import{q as a}from"../core/lang.js";import{L as i}from"./Logger.js";import{m as t}from"./lengthUtils.js";function r(e){return e&&"esri.renderers.visualVariables.SizeVariable"===e.declaredClass}function l(e){return null!=e&&!isNaN(e)&&isFinite(e)}function s(e){return e.valueExpression?"expression":e.field&&"string"==typeof e.field?"field":"unknown"}function o(e,n){const a=n||s(e),i=e.valueUnit||"unknown";return"unknown"===a?"constant":e.stops?"stops":null!=e.minSize&&null!=e.maxSize&&null!=e.minDataValue&&null!=e.maxDataValue?"clamped-linear":"unknown"===i?null!=e.minSize&&null!=e.minDataValue?e.minSize&&e.minDataValue?"proportional":"additive":"identity":"real-world-size"}const u=()=>i.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),c=e=>u().warn(`The visualVariable should be an instance of esri.renderers.visualVariables.${e}`),f=()=>u().error("Use of arcade expressions requires an arcade context"),p=new n,d=Math.PI,m=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function v(n,a,i){const t="visualVariables"in n?n.visualVariables?.find(e=>"color"===e.type):n;if(!t)return;if("esri.renderers.visualVariables.ColorVariable"!==t.declaredClass)return void c("ColorVariable");const r="number"==typeof a,s=r?null:a,o=s?.attributes;let u=r?a:null;const p=t.field,{ipData:d,hasExpression:m}=t.cache;let v=t.cache.compiledFunc;if(!p&&!m){const e=t.stops;return e&&e[0]&&e[0].color}if("number"!=typeof u)if(m){if(null==i?.arcade)return void f();const e={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},n=i.arcade.arcadeUtils,a=n.getViewInfo(e),r=n.createExecContext(s,a,i.timeZone);if(!v){const e=n.createSyntaxTree(t.valueExpression);v=n.createFunction(e),t.cache.compiledFunc=v}u=n.executeFunction(v,r)}else o&&(u=o[p]);const b=t.normalizationField,h=null!=o&&null!=b?parseFloat(o[b]):void 0;if(null!=u&&(!b||r||!isNaN(h)&&0!==h)){l(h)&&!r&&(u/=h);const n=w(u,d);if(n){const a=n[0],r=n[1],l=a===r?t.stops[a].color:e.blendColors(t.stops[a].color,t.stops[r].color,n[2],null!=i?i.color:void 0);return new e(l)}}}function b(e,n,a){const i="visualVariables"in e?e.visualVariables?.find(e=>"opacity"===e.type):e;if(!i)return;if("esri.renderers.visualVariables.OpacityVariable"!==i.declaredClass)return void c("OpacityVariable");const t="number"==typeof n,r=t?null:n,s=r?.attributes;let o=t?n:null;const u=i.field,{ipData:p,hasExpression:d}=i.cache;let m=i.cache.compiledFunc;if(!u&&!d){const e=i.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof o)if(d){if(null==a?.arcade)return void f();const e={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},n=a.arcade.arcadeUtils,t=n.getViewInfo(e),l=n.createExecContext(r,t,a.timeZone);if(!m){const e=n.createSyntaxTree(i.valueExpression);m=n.createFunction(e),i.cache.compiledFunc=m}o=n.executeFunction(m,l)}else s&&(o=s[u]);const v=i.normalizationField,b=null!=s&&null!=v?parseFloat(s[v]):void 0;if(null!=o&&(!v||t||!isNaN(b)&&0!==b)){l(b)&&!t&&(o/=b);const e=w(o,p);if(e){const n=e[0],a=e[1];if(n===a)return i.stops[n].opacity;{const t=i.stops[n].opacity;return t+(i.stops[a].opacity-t)*e[2]}}}}function h(e,n,a){const i="visualVariables"in e?e.visualVariables?.find(e=>"rotation"===e.type):e;if(!i)return;if("esri.renderers.visualVariables.RotationVariable"!==i.declaredClass)return void c("RotationVariable");const t=i.axis||"heading",r="heading"===t&&"arithmetic"===i.rotationType?90:0,l="heading"===t&&"arithmetic"===i.rotationType?-1:1,s="number"==typeof n?null:n,o=s?.attributes,u=i.field,{hasExpression:p}=i.cache;let d=i.cache.compiledFunc,m=null;if(!u&&!p)return m;if(p){if(null==a?.arcade)return void f();const e={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},n=a.arcade.arcadeUtils,t=n.getViewInfo(e),r=n.createExecContext(s,t,a.timeZone);if(!d){const e=n.createSyntaxTree(i.valueExpression);d=n.createFunction(e),i.cache.compiledFunc=d}m=n.executeFunction(d,r)}else o&&(m=o[u]);return m="number"!=typeof m||isNaN(m)?null:r+l*m,m}function V(e,n,a){const i="visualVariables"in e?e.visualVariables?.find(e=>"size"===e.type):e;if(!i)return;if("esri.renderers.visualVariables.SizeVariable"!==i.declaredClass)return void c("SizeVariable");const t=function(e,n,a){const i="number"==typeof n,t=i?null:n,r=t?.attributes;let s=i?n:null;const{isScaleDriven:o}=e.cache;let u=e.cache.compiledFunc;if(o){const n=null!=a?a.scale:void 0,i=null!=a?a.view:void 0;s=null==n||"3d"===i?function(e){let n=null,a=null;const i=e.stops;return i?(n=i[0].value,a=i[i.length-1].value):(n=e.minDataValue||0,a=e.maxDataValue||0),(n+a)/2}(e):n}else if(!i)switch(e.inputValueType){case"expression":{if(null==a?.arcade)return void f();const n={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},i=a.arcade.arcadeUtils,r=i.getViewInfo(n),l=i.createExecContext(t,r,a.timeZone);if(!u){const n=i.createSyntaxTree(e.valueExpression);u=i.createFunction(n),e.cache.compiledFunc=u}s=i.executeFunction(u,l);break}case"field":r&&(s=r[e.field]);break;case"unknown":s=null}if(!l(s))return null;if(i||!e.normalizationField)return s;const c=r?parseFloat(r[e.normalizationField]):null;return l(c)&&0!==c?s/c:null}(i,n,a),r=y(t,i,n,a,i.cache.ipData);return null==r||isNaN(r)?void 0:r}function g(e,n,a){return null==e?null:r(e)?V(e,n,a):l(e)?e:null}function x(e,n,a){return l(a)&&e>a?a:l(n)&&e<n?n:e}function y(e,n,a,i,r){switch(n.transformationType){case"additive":return function(e,n,a,i){const t=g(n.minSize,a,i)||n.minDataValue;return null==e&&null==t?null:(e??0)+(t??0)}(e,n,a,i);case"constant":return function(e,n,a){const i=e.stops;let t=i?.length&&i[0].size;return null==t&&(t=e.minSize),g(t,n,a)}(n,a,i);case"clamped-linear":return function(e,n,a,i){const t=g(n.minSize,a,i);if(null==e)return t;const{minDataValue:r,maxDataValue:l}=n;if(null==r||null==l)return null;const s=(e-r)/(l-r),o=g(n.maxSize,a,i),u=null!=i?i.shape:void 0;if(e<=r)return t;if(e>=l)return o;if(null==t||null==o)return null;if("area"===n.scaleBy&&u){const e="circle"===u,n=e?d*(t/2)**2:t*t,a=n+s*((e?d*(o/2)**2:o*o)-n);return e?2*Math.sqrt(a/d):Math.sqrt(a)}return t+s*(o-t)}(e,n,a,i);case"proportional":return function(e,n,a,i){const t=g(n.minSize,a,i);if(null==e||null==t)return t;const r=null!=i?i.shape:void 0,{minDataValue:l}=n;if(null==l)return null;const s=e/l,o=g(n.maxSize,a,i);let u=null;return u="circle"===r?2*Math.sqrt(s*(t/2)**2):"square"===r||"diamond"===r||"image"===r?Math.sqrt(s*t**2):s*t,x(u,t,o)}(e,n,a,i);case"stops":return function(e,n,a,i,t){if(null==e)return null;const[r,l,s]=w(e,t);if(r===l)return g(n.stops?.[r].size,a,i);{const e=g(n.stops?.[r].size,a,i),t=g(n.stops?.[l].size,a,i);return null==e||null==t?null:e+(t-e)*s}}(e,n,a,i,r);case"real-world-size":return function(e,n,a,i){const r=(i?.resolution??1)*t[n.valueUnit],l=g(n.minSize,a,i),s=g(n.maxSize,a,i),{valueRepresentation:o}=n;if(null==e)return l;let u=null;return u="area"===o?2*Math.sqrt(e/d)/r:"radius"===o||"distance"===o?2*e/r:e/r,x(u,l,s)}(e,n,a,i);case"identity":return e;case"unknown":return null}}function z(e,n,a){const{isScaleDriven:i}=e.cache;if(!(i&&"3d"===a||n))return null;const t={scale:n,view:a};let r=g(e.minSize,p,t),l=g(e.maxSize,p,t);if(null!=r||null!=l){if(r>l){const e=l;l=r,r=e}return{minSize:r,maxSize:l}}}function S(e,n,a){if(!e.visualVariables)return;const i=[],t=[],r=[],l=[],s=[];for(const n of e.visualVariables)switch(n.type){case"color":t.push(n);break;case"opacity":r.push(n);break;case"rotation":s.push(n);break;case"size":l.push(n)}return t.forEach(e=>{const t=v(e,n,a);i.push({variable:e,value:t})}),r.forEach(e=>{const t=b(e,n,a);i.push({variable:e,value:t})}),s.forEach(e=>{const t=h(e,n,a);i.push({variable:e,value:t})}),l.forEach(e=>{const t=V(e,n,a);i.push({variable:e,value:t})}),i}function w(e,n){if(!n)return;let a=0,i=n.length-1;return n.some((n,t)=>e<n?(i=t,!0):(a=t,!1)),[a,i,(e-n[a])/(n[i]-n[a])]}function F(e,n,i){const t=["proportional","proportional","proportional"];for(const r of e){const e=r.useSymbolValue?"symbol-value":V(r,n,i)??"proportional";switch(r.axis){case"width":t[0]=e;break;case"depth":t[1]=e;break;case"height":t[2]=e;break;case"width-and-depth":t[0]=e,t[1]=e;break;case"all":case void 0:case null:t[0]=e,t[1]=e,t[2]=e;break;default:a(r.axis)}}return t}const k=Object.freeze(Object.defineProperty({__proto__:null,getAllSizes:F,getColor:v,getOpacity:b,getRotationAngle:h,getSize:V,getSizeForValue:y,getSizeFromNumberOrVariable:g,getSizeRangeAtScale:z,getVisualVariableValues:S,viewScaleRE:m},Symbol.toStringTag,{value:"Module"}));export{h as a,S as b,V as c,o as d,r as e,s as f,F as g,z as h,l as i,v as j,b as k,k as l,m as v};
