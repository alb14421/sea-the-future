/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{C as e}from"./CIMSymbolHelper.js";import{d as t}from"./defaultCIMValues.js";import{_ as i,c as s}from"./tslib.es6.js";import{u as o,F as a,V as r,S as n,M as l,U as u,t as p,Z as c,b as d,d as m,am as h,G as y,B as f,n as v,a as g,x as b,g as x,o as w,l as S,w as V,a0 as z,q as P,at as A,r as _,f as M,$ as T,C as R,m as C,a3 as D,D as O,a5 as I,s as F,L as k,au as L,j as B,y as U,Y as E,as as N,a1 as j,av as H,z as q,K as W,aw as G,a6 as Z,E as K,ax as $,h as Y,ay as X,A as Q,p as J,az as ee,i as te,c as ie,T as se,N as oe,H as ae,e as re,O as ne,a9 as le,ac as ue,J as pe,aA as ce}from"./GraphShaderModule.js";import{h as de,t as me,R as he,i as ye}from"../core/lang.js";import{f as fe,M as ve,a as ge,b as be,e as xe,U as we}from"./UpdateTracking2D.js";import{m as Se,p as Ve,Y as ze,Z as Pe,D as Ae,B as _e,_ as Me}from"./definitions.js";import{b as Te,g as Re,c as Ce,d as De,u as Oe,i as Ie,r as Fe,e as ke,f as Le,h as Be,j as Ue,o as Ee}from"./utils26.js";import{j as Ne,k as je,g as He,l as qe,o as We,a as Ge,b as Ze,t as Ke,q as $e,r as Ye,c as Xe,d as Qe,s as Je,p as et,u as tt,v as it,h as st,i as ot,e as at,f as rt}from"./constants4.js";import{i as nt,m as lt}from"./mat3.js";import{c as ut}from"./mat3f32.js";import{g as pt,f as ct,h as dt,j as mt,k as ht,l as yt,i as ft,m as vt}from"./util.js";import{D as gt,a as bt,c as xt,P as wt}from"./enums.js";import{B as St}from"./BufferObject.js";import{R as Vt,a as zt,F as Pt}from"./FramebufferObject.js";import"./Program.js";import{a as At,T as _t}from"./Texture.js";import{V as Mt}from"./VertexArrayObject.js";import{V as Tt}from"./VertexBuffer.js";import{V as Rt}from"./VertexElementDescriptor.js";import{L as Ct}from"./Logger.js";import{f as Dt}from"./maybe.js";import{l as Ot}from"./heatmapTextureUtils.js";import{p as It,t as Ft}from"./screenUtils.js";import{f as kt,g as Lt}from"./rasterizingUtils.js";import{r as Bt}from"./WGLContainer.js";import{m as Ut}from"./unitUtils.js";import{m as Et}from"./lengthUtils.js";import{a as Nt}from"./streamLayerUtils.js";import jt from"../core/Error.js";import{g as Ht}from"./capabilities2.js";import{ignoreAbortErrors as qt,createResolver as Wt}from"../core/promiseUtils.js";import{QueueProcessor as Gt}from"./QueueProcessor.js";const Zt=new class{get forceStaticPath(){return"disabled"===de("esri-cim-animations-enable-status")}get forceAnimatedPath(){return"forced"===de("esri-cim-animations-enable-status")}get freezeGlobalTime(){return de("esri-cim-animations-freeze-time")??!1}get spotlightAnimatedSymbols(){return!!de("esri-cim-animations-spotlight")}get forceGlobalTimeOrigin(){return!1!==de("esri-cim-animations-freeze-time")}},Kt={[gt.BYTE]:1,[gt.UNSIGNED_BYTE]:1,[gt.SHORT]:2,[gt.UNSIGNED_SHORT]:2,[gt.HALF_FLOAT]:2,[gt.INT]:4,[gt.UNSIGNED_INT]:4,[gt.FLOAT]:4};class $t{constructor(e,t){this._boundPart=null,this.vertexBuffers=new Map,this.indexBuffers=new Map,this.groups=[];for(const i in t.vertex){const{data:s,layout:o}=t.vertex[i],a=new Tt(e,o,s);this.vertexBuffers.set(i,a)}for(const i in t.index){const{data:s}=t.index[i],o=St.createIndex(e,35044,s);this.indexBuffers.set(i,o)}for(const e of t.groups)this.groups.push({...e,vertexArrays:new Map});this.parts=t.parts}bind(e,t,i){this._boundPart=i;const{group:s}=this.parts[this._boundPart],o=this.groups[s];if(!o)throw new Error(`Missing group ${s}.`);let a=o.vertexArrays.get(t.stringHash);if(!a){const i=me(new Set(t.locations.keys())),s=o.index?this.indexBuffers.get(o.index):null,r=new Map;for(const[e,t]of this.vertexBuffers)t.layout.filter(e=>i.has(e.name)).length>0&&r.set(e,t);a=new Mt(e,r,s),o.vertexArrays.set(t.stringHash,a)}e.bindVAO(a)}draw(e){if(null==this._boundPart)throw new Error("Mesh.bind() has not been called.");const{start:t,count:i}=this.parts[this._boundPart],{group:s}=this.parts[this._boundPart],{primitive:o,index:a}=this.groups[s];if(a){const s=this.indexBuffers.get(a);if(!s)throw new Error(`Missing index buffer "${a}".`);const{indexType:r}=s;if(!r)throw new Error("Buffer type error.");e.drawElements(o,i,r,t*Kt[r])}else e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){this.groups.forEach(({vertexArrays:e})=>e.forEach(e=>e.disposeVAOOnly())),this.vertexBuffers.forEach(e=>e.dispose()),this.indexBuffers.forEach(e=>e.dispose())}}const Yt={position:{type:gt.SHORT,count:2}};class Xt extends $t{static create(e,t){const i=[];let{stride:s}=t;if(null==s){s=0;for(const[e,{count:i,type:o,offset:a}]of Object.entries(t.layout)){if(null!=a)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");s+=i*Kt[o]}}let o=0;for(const[e,{count:a,offset:r,type:n,normalized:l}]of Object.entries(t.layout)){null!=r&&(o=r);const t=new Rt(e,a,n,o,s,null!=l&&l,0);i.push(t),o+=a*Kt[n]}const a={primitive:t.primitive};null!=t.index&&(a.index="indexData");let{count:r}=t;if(null==r&&(r=t.index?t.index.length:t.vertex.byteLength/s,Math.floor(r)!==r))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${s}.`);const n={start:0,count:r,group:0,primitive:t.primitive},l={vertex:{vertexData:{data:t.vertex,layout:i}},parts:[n],groups:[a]};return null!=t.index&&(l.index={indexData:{data:t.index}}),new Xt(e,l,t.layout)}static fromVertexStream(e,t){return Xt.create(e,{primitive:bt.TRIANGLE_STRIP,vertex:new Uint16Array(t),layout:Yt})}constructor(e,t,i){super(e,t),this._spec=i}bind(e,t,i=0){super.bind(e,t,i)}}class Qt extends u{}i([o(a)],Qt.prototype,"globalTime",void 0),i([o(r)],Qt.prototype,"animationTextureSize",void 0),i([o(n)],Qt.prototype,"animationTexture",void 0),i([o(l)],Qt.prototype,"toScreen",void 0),i([o(l)],Qt.prototype,"toNdc",void 0),i([o(a)],Qt.prototype,"mapRotation",void 0),i([o(a)],Qt.prototype,"pixelRatio",void 0);class Jt extends u{getVisualVariableData(e){if(!this._vvData){const t=this.getAttributeDataCoords(e);this._vvData=p(this.visualVariableData,t).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(e){if(!this._uv){const t=Te(e),i=this.size,s=c(t.x),o=c(t.y).multiply(c(256)),a=c(t.z).multiply(c(256)).multiply(c(256)),n=d(s.add(o).add(a)),l=m(n,i),u=n.subtract(l).divide(i);this._uv=new r(l,u).add(.5).divide(i)}return this._uv}getFilterData(e){const t=this.getAttributeDataCoords(e);return p(this.filterFlags,t).setDebugName("storage0")}getAnimationData(e){const t=this.getAttributeDataCoords(e);return p(this.animation,t).setDebugName("storage1")}getVVData(e){return this.getVisualVariableData(e)}getDataDrivenData0(e){const t=this.getAttributeDataCoords(e);return p(this.dataDriven0,t).setDebugName("storage30")}getDataDrivenData1(e){const t=this.getAttributeDataCoords(e);return p(this.dataDriven1,t).setDebugName("storage31")}getDataDrivenData2(e){const t=this.getAttributeDataCoords(e);return p(this.dataDriven2,t).setDebugName("storage32")}getGPGPUData(e){const t=this.getAttributeDataCoords(e);return p(this.gpgpu,t).setDebugName("storage4")}getLocalTimeOrigin(e){const t=this.getAttributeDataCoords(e);return p(this.localTimeOrigin,t).x.setDebugName("storage5")}getFilterFlags(e){return de("webgl-ignores-sampler-precision")?h(this.getFilterData(e).x.multiply(d(255))):this.getFilterData(e).x.multiply(d(255))}getLabelVisibility(e){const t=this.getFilterData(e).y.multiply(255);return new a(1).subtract(t)}getAnimationValue(e){return this.getAnimationData(e).x}getSizeValue(e){return this.getVisualVariableData(e).x}getColorValue(e){return this.getVisualVariableData(e).y}getOpacityValue(e){return this.getVisualVariableData(e).z}getRotationValue(e){return this.getVisualVariableData(e).w}}i([o(n)],Jt.prototype,"filterFlags",void 0),i([o(n)],Jt.prototype,"animation",void 0),i([o(n)],Jt.prototype,"gpgpu",void 0),i([o(n)],Jt.prototype,"localTimeOrigin",void 0),i([o(n)],Jt.prototype,"visualVariableData",void 0),i([o(n)],Jt.prototype,"dataDriven0",void 0),i([o(n)],Jt.prototype,"dataDriven1",void 0),i([o(n)],Jt.prototype,"dataDriven2",void 0),i([o(a)],Jt.prototype,"size",void 0);class ei extends u{}i([o(a)],ei.prototype,"activeReasons",void 0),i([o(a)],ei.prototype,"highlightAll",void 0);class ti extends u{}i([o(r)],ti.prototype,"position",void 0),i([o(a)],ti.prototype,"distance",void 0),i([o(a)],ti.prototype,"smallSymbolDistance",void 0),i([o(a)],ti.prototype,"smallSymbolSizeThreshold",void 0);class ii extends u{}i([o(l)],ii.prototype,"displayViewScreenMat3",void 0),i([o(l)],ii.prototype,"displayViewMat3",void 0),i([o(l)],ii.prototype,"displayMat3",void 0),i([o(l)],ii.prototype,"viewMat3",void 0),i([o(l)],ii.prototype,"tileMat3",void 0),i([o(a)],ii.prototype,"displayZoomFactor",void 0),i([o(a)],ii.prototype,"requiredZoomFactor",void 0),i([o(r)],ii.prototype,"tileOffset",void 0),i([o(a)],ii.prototype,"currentScale",void 0),i([o(a)],ii.prototype,"currentZoom",void 0),i([o(a)],ii.prototype,"metersPerSRUnit",void 0),i([o(a)],ii.prototype,"rotation",void 0),i([o(a)],ii.prototype,"pixelRatio",void 0);class si extends P{}i([w(0,S)],si.prototype,"id",void 0),i([w(1,a)],si.prototype,"bitset",void 0),i([w(2,r)],si.prototype,"pos",void 0);class oi extends A{}i([w(14,r)],oi.prototype,"nextPos1",void 0),i([w(15,r)],oi.prototype,"nextPos2",void 0);class ai extends _{}class ri extends y{clip(e,t){let i=new a(0);const s=this.storage.getFilterFlags(e);if(i=i.add(d(2).multiply(d(1).subtract(Re(s,0)))),this.inside?i=i.add(d(2).multiply(d(1).subtract(Re(s,1)))):this.outside?i=i.add(d(2).multiply(Re(s,1))):this.highlight&&(i=i.add(d(2).multiply(d(1).subtract(this._checkHighlight(s))))),null!=t){const e=new a(1).subtract(f(t.x,this.view.currentZoom)),s=f(t.y,this.view.currentZoom);i=i.add(new a(2).multiply(e.add(s)))}return i}getFragmentOutput(e,t,i=new a(1/255)){const s=new v;return s.fragColor=this._maybeWriteHittest(t)??this._maybeHighlight(e,i)??e,s}_maybeHighlight(e,t){return this.highlight?new g(e.rgb,f(t,e.a)):null}_checkHighlight(e){let t=this._checkHighlightBit(e,0);for(let i=1;i<Se;i++)t=t.add(this._checkHighlightBit(e,i));return f(new a(.1),t.add(this.highlight.highlightAll))}_checkHighlightBit(e,t){return Ce(e,t).multiply(De(this.highlight.activeReasons,t))}maybeRunHittest(e,t,i){if(null==this.hittestRequest)return null;const s=this.hittest(e,t,i);let o=b(x(s,this.hittestRequest.distance),new a(2),new a(0));const r=this.storage.getAttributeDataCoords(e.id),n=Oe(r);o=o.add(this.clip(e.id,e.zoomRange));const l=new g(new a(1/255),0,0,0);return{glPointSize:new a(1),glPosition:new g(n,o,1),color:l}}_maybeWriteHittest(e){return null!=this.hittestRequest?e.color:null}}i([V],ri.prototype,"inside",void 0),i([V],ri.prototype,"outside",void 0),i([z(ei)],ri.prototype,"highlight",void 0),i([o(Jt)],ri.prototype,"storage",void 0),i([o(ii)],ri.prototype,"view",void 0),i([z(ti)],ri.prototype,"hittestRequest",void 0);class ni extends u{getPatternOffsetAtTileOrigin(e,t=new a(0),i=new a(1)){const s=new r(Ne).divide(e);let o=e.multiply(M(this.maxIntsToLocalOrigin.multiply(s))).add(this.tileOffsetFromLocalOrigin).subtract(new a(.5).multiply(e));return o=new r(o.x.multiply(i).subtract(o.y.multiply(t)),o.x.multiply(t).add(o.y.multiply(i))),m(o,e)}}i([o(r)],ni.prototype,"tileOffsetFromLocalOrigin",void 0),i([o(r)],ni.prototype,"maxIntsToLocalOrigin",void 0);class li extends u{}i([o(r)],li.prototype,"size",void 0),i([o(n)],li.prototype,"texture",void 0);class ui extends u{getColor(e,t,i){return R([I(Ie(e),i),t],[O(e,this.values.first()),this.colors.first()],[D(e,this.values.last()),this.colors.last()],[!0,()=>{const t=this.values.findIndex(t=>x(t,e)),i=this.values.get(t),s=t.subtract(1),o=this.values.get(s),a=e.subtract(o).divide(i.subtract(o));return C(this.colors.get(s),this.colors.get(t),a)}])}}i([o(T.ofType(g,8))],ui.prototype,"colors",void 0),i([o(T.ofType(a,8))],ui.prototype,"values",void 0);class pi extends u{getOpacity(e){return R([Ie(e),new a(1)],[O(e,this.opacityValues.first()),this.opacities.first()],[D(e,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const t=this.opacityValues.findIndex(t=>x(t,e)),i=this.opacityValues.get(t),s=t.subtract(1),o=this.opacityValues.get(s),a=e.subtract(o).divide(i.subtract(o));return C(this.opacities.get(s),this.opacities.get(t),a)}])}}i([o(T.ofType(a,8))],pi.prototype,"opacities",void 0),i([o(T.ofType(a,8))],pi.prototype,"opacityValues",void 0);class ci extends u{getVVRotationMat4(e){return b(Ie(e),L.identity(),()=>{const t=this.getNormalizedAngle(e).multiply(je),i=F(t),s=k(t);return new L(s,i,0,0,i.multiply(new a(-1)),s,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return b(Ie(e),l.identity(),()=>{const t=this.getNormalizedAngle(e).multiply(je),i=F(t),s=k(t);return new l(s,i,0,i.multiply(new a(-1)),s,0,0,0,1)})}getNormalizedAngle(e){const t=B(this.rotationType,new a(1));return b(t,new a(90).subtract(e),e)}}i([o(a)],ci.prototype,"rotationType",void 0);class di extends u{getSize(e,t){const i=this.minMaxValueAndSize.xy,s=this.minMaxValueAndSize.zw;return b(Ie(e),t,()=>{const t=e.subtract(i.x).divide(i.y.subtract(i.x)),o=U(t,new a(0),new a(1));return s.x.add(o.multiply(s.y.subtract(s.x)))})}}i([o(g)],di.prototype,"minMaxValueAndSize",void 0);class mi extends u{getSizeForViewScale(e){return R([O(e,this.values.first()),this.sizes.first()],[D(e,this.values.last()),this.sizes.last()],[!0,()=>{const t=this.values.findIndex(t=>x(t,e)),i=this.values.get(t),s=t.subtract(1),o=this.values.get(s),a=e.subtract(o).divide(i.subtract(o));return C(this.sizes.get(s),this.sizes.get(t),a)}])}}i([o(T.ofType(a,8))],mi.prototype,"sizes",void 0),i([o(T.ofType(a,8))],mi.prototype,"values",void 0);class hi extends u{getSize(e,t){const i=R([Ie(e),t],[O(e,this.values.first()),this.sizes.first()],[D(e,this.values.last()),this.sizes.last()],[!0,()=>{const t=this.values.findIndex(t=>x(t,e)),i=this.values.get(t),s=t.subtract(1),o=this.values.get(s),a=e.subtract(o).divide(i.subtract(o));return C(this.sizes.get(s),this.sizes.get(t),a)}]);return b(Ie(i),t,i)}}i([o(T.ofType(a,8))],hi.prototype,"sizes",void 0),i([o(T.ofType(a,8))],hi.prototype,"values",void 0);class yi extends u{getSize(e,t){return b(Ie(e),t,e.multiply(this.unitValueToPixelsRatio))}}function fi(e){return null!=e.visualVariableSizeMinMaxValue||null!=e.visualVariableSizeScaleStops||null!=e.visualVariableSizeStops||null!=e.visualVariableSizeUnitValue}function vi(e,t,i){if(fi(e)){const s=e.storage.getSizeValue(t);return e.visualVariableSizeMinMaxValue?.getSize(s,i)??e.visualVariableSizeScaleStops?.getSizeForViewScale(e.view.currentScale)??e.visualVariableSizeStops?.getSize(s,i)??e.visualVariableSizeUnitValue?.getSize(s,i)}return i}function gi(e,t,i,s=new E(!1)){if(null==e.visualVariableColor)return i;const o=e.storage.getColorValue(t);return e.visualVariableColor.getColor(o,i,s)}function bi(e,t){if(null==e.visualVariableOpacity)return new a(1);const i=e.storage.getOpacityValue(t);return e.visualVariableOpacity.getOpacity(i)}function xi(e,t){if(null==e.visualVariableRotation)return l.identity();const i=e.storage.getRotationValue(t);return e.visualVariableRotation.getVVRotationMat3(i)}i([o(a)],yi.prototype,"unitValueToPixelsRatio",void 0);class wi extends si{}i([w(3,r)],wi.prototype,"offset",void 0),i([w(4,g)],wi.prototype,"sizing",void 0),i([w(5,g)],wi.prototype,"value1Position2Value2",void 0),i([w(6,g)],wi.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),i([w(7,r)],wi.prototype,"zoomRange",void 0),i([w(8,a)],wi.prototype,"lineLength",void 0);class Si extends ai{}class Vi extends ri{_vertexPreamble(e,t,i){const{id:s,offset:o,animationPointerAndBaseSizeAndReferenceSize:r,sizing:n}=e,l=r.xy,u=r.z,p=r.w,c=n.xy,d=this._getEvalParams(e,c,i);let m,h;if(e.value1Position2Value2){const t=zi(l,6,d).a,i=e.pos,s=e.value1Position2Value2.yz,o=e.value1Position2Value2.x,r=e.value1Position2Value2.w,n=t.subtract(o).divide(r.subtract(o));h=i.add(s.subtract(i).multiply(n)),m=f(new a(1),n).add(f(new a(0),j(n)))}else h=e.pos,m=new a(0);const y=n.z,v=De(e.bitset,ve.bitset.isStroke),g=n.w,b=De(e.bitset,ve.bitset.scaleSymbolsProportionally),x=zi(l,0,d),w=R([B(De(e.bitset,ve.bitset.isMapAligned),new a(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new a(0)]),S=new H(k(w),F(w.multiply(-1)),F(w),k(w)).multiply(x.xy),V=x.z.subtract(w).subtract(t.multiply(He)),z=x.w,P=De(e.bitset,ve.bitset.isSDF),A=vi(this,s,new a(p)).divide(new a(p));return{baseSize:u,animationPointer:l,strokeWidth:y,isOutline:v,unscaledDistanceToPx:g,scaleSymbolsProportionally:b,isSDF:P,position:this._getScreenPosition({id:s,pos:h,offset:o,referenceSize:p,translation:S,rotation:V,scale:z,vvScale:A}),evalParams:d,vvScale:A,scale:z,clip:m}}_getScreenPosition(e){const{pos:t,translation:i,rotation:s,scale:o,offset:r,id:n,vvScale:u}=e,p=function(e,t){if(null==e.visualVariableRotation)return new a(0);const i=e.storage.getRotationValue(t);return e.visualVariableRotation.getNormalizedAngle(i)}(this,n).multiply(Math.PI/180),c=i.x.multiply(4/3),d=i.y.multiply(-1).multiply(4/3),m=F(p),h=k(p),y=h.multiply(c).add(j(m).multiply(d)),f=m.multiply(c).add(h.multiply(d)),v=F(s.subtract(p)),g=k(s.subtract(p)),b=new a(0),x=new a(1),{pixelRatio:w}=this.animationInfo,V=new l(x,b,b,b,x,b,y.multiply(w),f.multiply(w),x),z=new l(g,v.multiply(-1),b,v,g,b,0,0,x),P=o.multiply(u).multiply(w).multiply(4/3),A=z.multiply(P),_=this.animationInfo.toScreen.multiply(new S(t,1)),M=V.multiply(_).xy,T=A.multiply(new S(r,0)).xy;return M.add(T)}_clip(e,t){let i=super.clip(e,t);const s=O(this._getLocalTimeOrigin(e),new a(0));return Zt.forceGlobalTimeOrigin||(i=i.add(R([s,()=>new a(2)],[!0,()=>new a(0)]))),i}_getLocalTimeOrigin(e){return this.storage.getLocalTimeOrigin(e)}_toNdc(e){return this.animationInfo.toNdc.multiply(new S(e,1)).xy}_getEvalParams(e,t,i){const{globalTime:s,animationTextureSize:o,animationTexture:a}=this.animationInfo;return{globalTime:s,localTimeOrigin:this._getLocalTimeOrigin(e.id),animationTextureSize:o,animationTexture:a,pixelDimensions:t,lineLength:i}}_getColor(e,t){return b(B(t.isSDF,new a(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return p(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=p(this.mosaicInfo.texture,e),s=new a(.5).subtract(Fe(i)).multiply(t.distanceToPx).multiply(qe),o=U(new a(.5).subtract(s),new a(0),new a(1)),r=t.color.multiply(o),n=t.outlineSize.multiply(.5),l=q(s).subtract(n),u=U(new a(.5).subtract(l),new a(0),new a(1)),c=t.outlineColor.multiply(u);return new a(1).subtract(c.a).multiply(r).add(c)}}function zi(e,t,i){const s=e.add(new r(t,0)),o=p(i.animationTexture,s.add(.5).divide(i.animationTextureSize)).xy;return e=e.add(o),N({animationPointer:e,...i},g,null,e=>{const{out:t}=e;if(!t)throw new Error("out is null");return fe({...e,out:t})})}i([o(li)],Vi.prototype,"mosaicInfo",void 0),i([o(Qt)],Vi.prototype,"animationInfo",void 0),i([o(ni)],Vi.prototype,"localTileOffset",void 0),i([z(ui)],Vi.prototype,"visualVariableColor",void 0),i([z(pi)],Vi.prototype,"visualVariableOpacity",void 0),i([z(di)],Vi.prototype,"visualVariableSizeMinMaxValue",void 0),i([z(mi)],Vi.prototype,"visualVariableSizeScaleStops",void 0),i([z(hi)],Vi.prototype,"visualVariableSizeStops",void 0),i([z(yi)],Vi.prototype,"visualVariableSizeUnitValue",void 0),i([z(ci)],Vi.prototype,"visualVariableRotation",void 0);class Pi extends wi{}i([w(9,g)],Pi.prototype,"tlbr",void 0);class Ai extends A{}i([w(13,r)],Ai.prototype,"nextPos1",void 0),i([w(14,r)],Ai.prototype,"nextPos2",void 0);class _i extends Si{}class Mi extends Vi{_fragmentPoly(e){const t=m(e.uv,new a(1)),i=C(e.tlbr.xy,e.tlbr.zw,t);return this._getColor(i,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth})}_vertexPoly(e){const{position:t,animationPointer:i,evalParams:s,isOutline:o,unscaledDistanceToPx:r,vvScale:n,strokeWidth:l,scaleSymbolsProportionally:u,scale:p,isSDF:c,baseSize:d,clip:m}=this._vertexPreamble(e,new a(0),e.lineLength||new a(0)),h=this._toNdc(t);let y=zi(i,1,s);y=new g(y.rgb.multiply(y.a),y.a);let f=zi(i,2,s);f=new g(f.rgb.multiply(f.a),f.a);let v=zi(i,3,s);v=new g(v.rgb.multiply(v.a),v.a);const b=zi(i,4,s).a,x=zi(i,5,s).a,w=gi(this,e.id,y,I(ke(e.bitset,ve.bitset.colorLocked),new E(o))),S=C(w,f,v),V=bi(this,e.id),z=C(V,b,x),P=S.multiply(z),A=this.clip(e.id,e.zoomRange).add(m.multiply(2)),_=r.multiply(n);return{unscaledDistanceToPx:r,vvScale:n,strokeWidth:l,scaleSymbolsProportionally:u,scale:p,isSDF:c,baseSize:d,ndc:h,color:P,z:A,isOutline:o,evalParams:s,distanceToPx:_}}}function Ti(e,t,i){const s=i.subtract(t),o=e.subtract(t),r=Y(o,X(s)),n=U(r.divide(W(s)),new a(0),new a(1));return G(e,t.add(n.multiply(i.subtract(t))))}function Ri(e){const t=q(e);return f(t.x.add(t.y).add(t.z),new a(1.05))}function Ci(e,t,i,s){const o=new l(i.x.multiply(s.y).subtract(s.x.multiply(i.y)),s.x.multiply(t.y).subtract(t.x.multiply(s.y)),t.x.multiply(i.y).subtract(i.x.multiply(t.y)),i.y.subtract(s.y),s.y.subtract(t.y),t.y.subtract(i.y),s.x.subtract(i.x),t.x.subtract(s.x),i.x.subtract(t.x)),r=t.x.multiply(i.y.subtract(s.y)),n=i.x.multiply(s.y.subtract(t.y)),u=s.x.multiply(t.y.subtract(i.y)),p=r.add(n).add(u);return new a(1).divide(p).multiply(o.multiply(new S(1,e)))}function Di(e,t,i,s){return B(Ri(Ci(e,t,i,s)),new a(1))}function Oi(e,t,i,s){const o=i.subtract(t),r=s.subtract(t),n=Le(o,r),l=Z(K(n,new a(We)),x(n,new a(-We)));return R([Z($(l),Di(e.xy,t,i,s)),new a(-1)],[!0,()=>{const o=Ti(e,t,i),a=Ti(e,i,s),r=Ti(e,s,t);return Q(Q(o,a),r)}])}function Ii(e){return e.distance.add(1)}function Fi(e,t,i){const{viewMat3:s,tileMat3:o}=e.view,a=s.multiply(o),r=a.multiply(new S(t.pos,1)),n=a.multiply(new S(i.nextPos1,1)),l=a.multiply(new S(i.nextPos2,1));return Oi(e.hittestRequest.position,r.xy,n.xy,l.xy)}class ki extends si{}i([w(3,g)],ki.prototype,"color",void 0),i([w(4,r)],ki.prototype,"zoomRange",void 0);class Li extends ri{constructor(){super(...arguments),this.type="FillShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const i=bi(this,e.id),s=gi(this,e.id,e.color).multiply(i),o=this.view.displayViewScreenMat3.multiply(new S(e.pos.xy,1)),a=this.clip(e.id,e.zoomRange);return{glPosition:new g(o.xy,a,1),color:s,...this.maybeRunHittest(e,t,null)}}fragment(e){return this.getFragmentOutput(e.color,e,new a(0))}hittest(e,t){return Fi(this,e,t)}}i([z(ui)],Li.prototype,"visualVariableColor",void 0),i([z(pi)],Li.prototype,"visualVariableOpacity",void 0),i([s(0,J(ki)),s(1,J(oi))],Li.prototype,"vertex",null),i([s(0,J(ai))],Li.prototype,"fragment",null);class Bi extends ki{}function Ui(e,t,i,s,o){const a=B(De(o,Ze),d(1)),r=Fe(new g(e,0));return b(a,ee(s.divide(t.x),i.divide(t.y),0,j(i.divide(t.x)),s.divide(t.y),0,Be(te(r,0)),Be(te(0,r)),1),ee(s.divide(t.x),i.divide(t.y),0,j(i.divide(t.x)),s.divide(t.y),0,0,0,1))}function Ei(e,t){const i=e.view.requiredZoomFactor,s=new r(t.width,t.height),o=s.multiply(t.scale).multiply(i),n=t.angle.multiply(He),l=F(n),u=k(n),p=Ui(t.id,o,l,u,t.bitset),c=e.localTileOffset.getPatternOffsetAtTileOrigin(s,l,u),d=i.multiply(t.scale).multiply(t.offset.subtract(c)).divide(o),m=new S(t.pos,1),h=p.multiply(m).xy.subtract(d),y=t.tlbr.divide(e.mosaicInfo.size.xyxy);let f=De(t.bitset,Ge);return null!=e.visualVariableColor&&(f=b(Ie(e.storage.getColorValue(t.id)),new a(0),f)),{tileTextureCoord:h,tlbr:y,sampleAlphaOnly:f}}function Ni(e,t){const i=m(t.tileTextureCoord,new a(1)),s=C(t.tlbr.xy,t.tlbr.zw,i);let o=p(e.mosaicInfo.texture,s);return o=b(x(t.sampleAlphaOnly,new a(.5)),o.aaaa,o),t.color.multiply(o)}i([w(5,g)],Bi.prototype,"tlbr",void 0),i([w(6,a)],Bi.prototype,"width",void 0),i([w(7,a)],Bi.prototype,"height",void 0),i([w(8,r)],Bi.prototype,"offset",void 0),i([w(9,r)],Bi.prototype,"scale",void 0),i([w(10,a)],Bi.prototype,"angle",void 0);class ji extends Li{constructor(){super(...arguments),this.type="ComplexFillShader"}vertex(e,t){return{...super.vertex(e,t),...Ei(this,e)}}fragment(e){const t=Ni(this,e);return this.getFragmentOutput(t,e,new a(0))}}i([o(li)],ji.prototype,"mosaicInfo",void 0),i([o(ni)],ji.prototype,"localTileOffset",void 0),i([s(0,J(Bi)),s(1,J(oi))],ji.prototype,"vertex",null),i([s(0,J(class extends ai{}))],ji.prototype,"fragment",null);class Hi extends Mi{constructor(){super(...arguments),this.type="AnimatedFillShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const{distanceToPx:i,ndc:s,z:o,color:r,isOutline:n,strokeWidth:u,isSDF:p,baseSize:c,scale:d,scaleSymbolsProportionally:m}=this._vertexPoly(e),h=this.view.requiredZoomFactor,y=e.sizing.xy,f=y.multiply(h),v=new a(0),b=F(v),x=k(v),w=Ui(e.id,f,b,x,e.bitset),V=this.localTileOffset.getPatternOffsetAtTileOrigin(y,b,x),z=h.multiply(e.offset.subtract(V)).divide(f),P=new S(e.pos,1),A=w.multiply(P).xy.subtract(z),_=e.tlbr.divide(this.mosaicInfo.size.xyxy);return{glPosition:new g(s,o,1),tlbr:_,uv:A,color:r.multiply(new a(1).subtract(n)),outlineColor:r.multiply(n),distanceToPx:i,strokeWidth:u.multiply(C(new a(1),d,m)),isOutline:n,isSDF:p,...this.maybeRunHittest(e,t,{pos:e.pos,size:c,sizeCorrection:new a(1),isMapAligned:new a(1),vvRotationMat3:new l(1,0,0,0,1,0,0,0,1),placementMat3:new l(1,0,0,0,1,0,0,0,1),outlineSize:new a(1),distanceToPx:i,isSDF:p})}}fragment(e){const t=this._fragmentPoly(e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return Fi(this,e,t)}}i([s(0,J(Pi)),s(1,J(Ai))],Hi.prototype,"vertex",null),i([s(0,J(_i))],Hi.prototype,"fragment",null);let qi=class extends si{};i([w(3,g)],qi.prototype,"color",void 0),i([w(4,r)],qi.prototype,"offset",void 0),i([w(5,r)],qi.prototype,"normal",void 0),i([w(6,a)],qi.prototype,"halfWidth",void 0),i([w(7,a)],qi.prototype,"referenceHalfWidth",void 0),i([w(8,r)],qi.prototype,"zoomRange",void 0);let Wi=class extends ai{};class Gi extends u{}function Zi(e){return ie(new a(Ke).multiply(f(e,new a($e))),new a(1))}function Ki(e,t){const{halfWidth:i,normal:s}=e,o=Zi(i),r=W(s).multiply(i);return U(o.multiply(i.subtract(r)).divide(t.add(o).subtract(new a(1))),new a(0),new a(1))}function $i(e,t){const{id:i,offset:s,pos:o,normal:r,zoomRange:n}=t,{displayViewScreenMat3:l,displayViewMat3:u}=e.view,p=gi(e,i,t.color),c=bi(e,i),d=function(e,t){const{id:i,halfWidth:s,referenceHalfWidth:o}=t;if(fi(e)){const t=vi(e,i,new a(2).multiply(o));return new a(.5).multiply(s.divide(ie(o,new a(Ye)))).multiply(t)}return s}(e,t),m=new a(.5).multiply(e.antialiasingControls.antialiasing),h=ie(d.add(m),new a(.45)).add(new a(.1).multiply(m)),y=Zi(h).multiply(h).multiply(s),v=u.multiply(new S(y,new a(0))),b=l.multiply(new S(o,new a(1))).add(v),x=new a(2).multiply(f(d,new a(0))).add(e.clip(i,n)),w=new g(b.xy,x,1);return{color:p,opacity:c,halfWidth:h,normal:r,scaledOffset:y,scaledHalfWidth:d,glPosition:new g(w.xy,x,1)}}function Yi(e,t){const{opacity:i,color:s}=e,o=Ki(e,t);return i.multiply(s).multiply(o)}i([o(a)],Gi.prototype,"antialiasing",void 0),i([o(a)],Gi.prototype,"blur",void 0);class Xi extends ri{constructor(){super(...arguments),this.type="LineShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const i=$i(this,e);return{...i,...this.maybeRunHittest(e,t,i.halfWidth)}}fragment(e){const t=Yi(e,this.antialiasingControls.blur);return this.getFragmentOutput(t,e)}hittest(e,t,i){const{viewMat3:s,tileMat3:o}=this.view,a=s.multiply(o),r=a.multiply(new S(e.pos,1)),n=a.multiply(new S(t.nextPos1,1)),l=a.multiply(new S(t.nextPos2,1)),{distance:u,smallSymbolDistance:p,smallSymbolSizeThreshold:c}=this.hittestRequest,d=f(i,c.multiply(.5)).multiply(u.subtract(p)),m=this.hittestRequest.position;return Q(Ti(m,r.xy,n.xy),Ti(m,r.xy,l.xy)).subtract(i).add(d)}}i([o(Gi)],Xi.prototype,"antialiasingControls",void 0),i([z(ui)],Xi.prototype,"visualVariableColor",void 0),i([z(pi)],Xi.prototype,"visualVariableOpacity",void 0),i([z(di)],Xi.prototype,"visualVariableSizeMinMaxValue",void 0),i([z(mi)],Xi.prototype,"visualVariableSizeScaleStops",void 0),i([z(hi)],Xi.prototype,"visualVariableSizeStops",void 0),i([z(yi)],Xi.prototype,"visualVariableSizeUnitValue",void 0),i([s(0,J(qi)),s(1,J(oi))],Xi.prototype,"vertex",null),i([s(0,J(Wi))],Xi.prototype,"fragment",null);class Qi extends Pi{}i([w(10,a)],Qi.prototype,"accumulatedDistance",void 0),i([w(11,r)],Qi.prototype,"normal",void 0),i([w(12,r)],Qi.prototype,"segmentDirection",void 0);class Ji extends Mi{constructor(){super(...arguments),this.type="AnimatedLineShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const{animationPointerAndBaseSizeAndReferenceSize:i}=e,s=i.xy,{distanceToPx:o,ndc:n,z:u,color:p,isOutline:c,strokeWidth:d,isSDF:m,baseSize:h,scale:y,scaleSymbolsProportionally:f,evalParams:v}=this._vertexPoly(e),b=e.sizing.xy,x=b.x.multiply(h).divide(b.y),w=zi(s,6,v).a,S=e.accumulatedDistance.subtract(w),{normal:V}=e,z=e.normal.y,P=S.divide(this.view.displayZoomFactor).add(Y(e.segmentDirection,e.offset)).divide(x),A=z.add(1).divide(2),_=new r(P,A),M=e.tlbr.divide(this.mosaicInfo.size.xyxy);return{glPosition:new g(n,u,1),tlbr:M,uv:_,color:p.multiply(new a(1).subtract(c)),outlineColor:p.multiply(c),distanceToPx:o,strokeWidth:d.multiply(C(new a(1),y,f)),isOutline:c,isSDF:m,halfWidth:h.divide(2),normal:V,...this.maybeRunHittest(e,t,{pos:e.pos,size:h,sizeCorrection:new a(1),isMapAligned:new a(1),vvRotationMat3:new l(1,0,0,0,1,0,0,0,1),placementMat3:new l(1,0,0,0,1,0,0,0,1),outlineSize:new a(1),distanceToPx:o,isSDF:m})}}fragment(e){const t=this._fragmentPoly(e),{halfWidth:i,normal:s}=e,o=Zi(i),r=W(s).multiply(i),n=U(o.multiply(i.subtract(r)).divide(o.subtract(new a(1))),new a(0),new a(1));return this.getFragmentOutput(t.multiply(n),e)}hittest(e,t,i){const{viewMat3:s,tileMat3:o}=this.view,a=s.multiply(o),r=a.multiply(new S(e.pos,1)),n=a.multiply(new S(t.nextPos1,1)),l=a.multiply(new S(t.nextPos2,1)),{distance:u,smallSymbolDistance:p,smallSymbolSizeThreshold:c}=this.hittestRequest,d=f(i,c.multiply(.5)).multiply(u.subtract(p)),m=this.hittestRequest.position;return Q(Ti(m,r.xy,n.xy),Ti(m,r.xy,l.xy)).subtract(i).add(d)}}i([s(0,J(Qi)),s(1,J(Ai))],Ji.prototype,"vertex",null),i([s(0,J(class extends _i{}))],Ji.prototype,"fragment",null);class es extends wi{}i([w(9,r)],es.prototype,"uv",void 0),i([w(10,a)],es.prototype,"angle",void 0);class ts extends A{}function is(e,t,i,s){return t.multiply(e.x).add(i.multiply(e.y)).add(s.multiply(e.z))}i([w(11,r)],ts.prototype,"offsetNextVertex1",void 0),i([w(12,r)],ts.prototype,"offsetNextVertex2",void 0),i([w(13,r)],ts.prototype,"textureUVNextVertex1",void 0),i([w(14,r)],ts.prototype,"textureUVNextVertex2",void 0);class ss extends Vi{constructor(){super(...arguments),this.type="AnimatedMarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=e.uv.divide(this.mosaicInfo.size),{position:s,animationPointer:o,evalParams:r,isOutline:n,unscaledDistanceToPx:u,vvScale:p,strokeWidth:c,scaleSymbolsProportionally:d,scale:m,isSDF:h,baseSize:y,clip:f}=this._vertexPreamble(e,e.angle,e.lineLength||new a(0)),v=this._toNdc(s);let b=zi(o,1,r);b=new g(b.rgb.multiply(b.a),b.a);let x=zi(o,2,r);x=new g(x.rgb.multiply(x.a),x.a);let w=zi(o,3,r);w=new g(w.rgb.multiply(w.a),w.a);const S=zi(o,4,r).a,V=zi(o,5,r).a,z=gi(this,e.id,b,I(ke(e.bitset,ve.bitset.colorLocked),new E(n))),P=C(z,x,w),A=bi(this,e.id),_=C(A,S,V),M=P.multiply(_),T=this.clip(e.id,e.zoomRange).add(f.multiply(2)),R=u.multiply(p);return{glPosition:new g(v,T,1),uv:i,color:M.multiply(new a(1).subtract(n)),outlineColor:M.multiply(n),distanceToPx:R,strokeWidth:c.multiply(C(new a(1),m,d)),isOutline:n,isSDF:h,...this.maybeRunHittest(e,t,{pos:e.pos,size:y,sizeCorrection:new a(1),isMapAligned:new a(1),vvRotationMat3:new l(1,0,0,0,1,0,0,0,1),placementMat3:new l(1,0,0,0,1,0,0,0,1),outlineSize:new a(1),distanceToPx:R,isSDF:h})}}fragment(e){let t=this._getColor(e.uv,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth});return Zt.spotlightAnimatedSymbols&&(t=t.add(new g(0,.3,0,.3))),this.getFragmentOutput(t,e)}hittest(e,t,i){return b(K(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_hittestSmallMarker(e,t,i){const{position:s,distance:o,smallSymbolDistance:a}=this.hittestRequest,r=o.subtract(a),{viewMat3:n,tileMat3:l}=this.view,u=n.multiply(l).multiply(new S(i.pos,1)).xy,p=i.size.multiply(.5);return G(u,s).subtract(p).add(r)}_hittestMarker(e,t,i){const s=this._vertexPreamble({...e},e.angle,new a(0)).position,o=this._vertexPreamble({...e,offset:t.offsetNextVertex1},e.angle,new a(0)).position,r=this._vertexPreamble({...e,offset:t.offsetNextVertex2},e.angle,new a(0)).position,n=this.hittestRequest.position,l=this.hittestRequest.distance,u=Oi(n,s,o,r);return b(x(u,l),u,this._hittestSamples(s,o,r,e,t,i))}_hittestSamples(e,t,i,s,o,n){const{outlineSize:l,isSDF:u,distanceToPx:p}=n,c=this.hittestRequest.position,d=this.hittestRequest.distance,m=Ci(c.add(new r(j(d),j(d))),e,t,i),h=Ci(c.add(new r(0,j(d))),e,t,i),y=Ci(c.add(new r(d,j(d))),e,t,i),v=Ci(c.add(new r(j(d),0)),e,t,i),b=Ci(c,e,t,i),x=Ci(c.add(new r(d,0)),e,t,i),w=Ci(c.add(new r(j(d),d)),e,t,i),S=Ci(c.add(new r(0,d)),e,t,i),V=Ci(c.add(new r(d,d)),e,t,i),z=s.uv.divide(this.mosaicInfo.size),P=o.textureUVNextVertex1.divide(this.mosaicInfo.size),A=o.textureUVNextVertex2.divide(this.mosaicInfo.size),_={color:new g(1,1,1,1),outlineSize:l,outlineColor:new g(1,1,1,1),isSDF:u,distanceToPx:p};let M=new a(0);return M=M.add(Ri(m).multiply(this._getColor(is(m,z,P,A),_).a)),M=M.add(Ri(h).multiply(this._getColor(is(h,z,P,A),_).a)),M=M.add(Ri(y).multiply(this._getColor(is(y,z,P,A),_).a)),M=M.add(Ri(v).multiply(this._getColor(is(v,z,P,A),_).a)),M=M.add(Ri(b).multiply(this._getColor(is(b,z,P,A),_).a)),M=M.add(Ri(x).multiply(this._getColor(is(x,z,P,A),_).a)),M=M.add(Ri(w).multiply(this._getColor(is(w,z,P,A),_).a)),M=M.add(Ri(S).multiply(this._getColor(is(S,z,P,A),_).a)),M=M.add(Ri(V).multiply(this._getColor(is(V,z,P,A),_).a)),f(M,new a(.05)).multiply(Ii(this.hittestRequest))}}i([s(0,J(es)),s(1,J(ts))],ss.prototype,"vertex",null),i([s(0,J(class extends Si{}))],ss.prototype,"fragment",null);class os extends se{constructor(){super(...arguments),this.symbologyPlane=0,this._input=null}}class as extends os{render(e,t){const{context:i,painter:s}=e,{target:o}=t,{freezeGlobalTime:a}=Zt,r=s.textureManager.animationStore.getTexture(i,0),n=[2/e.state.size[0],0,0,0,-2/e.state.size[1],0,-1,1,1],l=Array.from(nt(ut(),n)),u=Array.from(lt(ut(),l,o.transforms.displayViewScreenMat3)),p=t.instance.getInput(),c=s.textureManager.getMosaicInfo(i,t.textureKey,!1),{optionalAttributes:d}=p,m=d.zoomRange,h=d.value1Position2Value2,y="accumulatedDistance"in d&&d.accumulatedDistance,f="segmentDirection"in d&&d.segmentDirection,v="normal"in d&&d.normal;s.setShader({shader:this.shaders.geometry,uniforms:{...mt(e,t.target,p.uniforms),...dt(e,t.target),mosaicInfo:c,animationInfo:{globalTime:!1===a?e.time/1e3:a,animationTextureSize:[r.descriptor.width,r.descriptor.height],animationTexture:{unit:6,texture:r},toScreen:u,toNdc:n,mapRotation:e.state.rotation,pixelRatio:e.state.pixelRatio},localTileOffset:ct(t.target)},defines:{...pt(e)},optionalAttributes:{zoomRange:m,value1Position2Value2:h,accumulatedDistance:y,segmentDirection:f,normal:v},useComputeBuffer:!0}),s.setPipelineState({...ht(e)}),s.submitDraw(e,t),!1===a&&o.requestRender()}}class rs extends P{}i([w(0,r)],rs.prototype,"pos",void 0);class ns extends u{}i([o(a)],ns.prototype,"dotSize",void 0);class ls extends u{}i([o(n)],ls.prototype,"locations",void 0),i([o(a)],ls.prototype,"pixelRatio",void 0),i([o(a)],ls.prototype,"tileZoomFactor",void 0);class us extends y{constructor(){super(...arguments),this.type="DotDensityPointShader"}vertex(e){const t=new l(1,0,0,0,-1,0,0,1,1).multiply(new S(e.pos.xy.divide(Ve),1)),i=p(this.draw.locations,t.xy),s=ie(this.instance.dotSize.divide(2),new a(1));let o=new a(0);o=o.add(f(i.a,new a(1e-6)).multiply(2));let r=s.add(this.instance.dotSize);const n=this.view.displayViewScreenMat3.multiply(new S(e.pos.add(.5),1)),u=new g(n.xy,o,1),c=this.instance.dotSize.divide(r),d=new a(-1).divide(s.divide(r));return r=r.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:u,glPointSize:r,color:i,ratio:c,invEdgeRatio:d}}fragment(e){const t=W(e.glPointCoord.subtract(.5)).multiply(2),i=oe(new a(0),new a(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),s=new v;return s.fragColor=e.color.multiply(i),s}}i([o(ns)],us.prototype,"instance",void 0),i([o(ls)],us.prototype,"draw",void 0),i([o(ii)],us.prototype,"view",void 0),i([s(0,J(rs))],us.prototype,"vertex",null),i([s(0,J(class extends ai{}))],us.prototype,"fragment",null);class ps extends si{}i([w(3,a)],ps.prototype,"inverseArea",void 0);class cs extends u{}i([o(T.ofType(g,2))],cs.prototype,"isActive",void 0),i([o(T.ofType(g,8))],cs.prototype,"colors",void 0),i([o(a)],cs.prototype,"dotValue",void 0);class ds extends u{}i([o(n)],ds.prototype,"dotTexture0",void 0),i([o(n)],ds.prototype,"dotTexture1",void 0),i([o(a)],ds.prototype,"tileZoomFactor",void 0),i([o(a)],ds.prototype,"pixelRatio",void 0),i([o(a)],ds.prototype,"tileDotsOverArea",void 0);class ms extends ri{constructor(){super(...arguments),this.type="DotDensityPolygonShader"}_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){const t=new l(2/Ve,0,0,0,-2/Ve,0,-1,1,1).multiply(new S(e.pos,1)),i=this.clip(e.id),s=new g(t.xy,i,1),o=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),a=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),r=this.draw.tileZoomFactor.multiply(Ve).divide(this.draw.pixelRatio),n=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),u=this._dotThreshold(a,this.instance.dotValue,this.draw.tileDotsOverArea),p=e.pos.add(.5).divide(r);return{glPosition:s,color:new g(0,0,0,0),textureCoords:p,thresholds0:n,thresholds1:u}}fragment(e){const t=new v,i=p(this.draw.dotTexture0,e.textureCoords),s=p(this.draw.dotTexture1,e.textureCoords),o=e.thresholds0.subtract(i),r=e.thresholds1.subtract(s);let n;const l=L.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),u=L.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const e=f(new a(0),o),t=f(new a(0),r),i=Y(e,o).add(Y(t,r)),s=f(i,new a(0)),p=new a(1).subtract(s),c=i.add(s),d=o.multiply(e).divide(c),m=r.multiply(t).divide(c),h=l.multiply(d).add(u.multiply(m));n=p.multiply(h)}else{const e=ie(Ue(o),Ue(r)),t=f(e,new a(0)),i=new a(1).subtract(t),s=f(e,o),p=f(e,r),c=l.multiply(s).add(u.multiply(p));n=i.multiply(c)}return t.fragColor=n,t}hittest(e){return Ii(this.hittestRequest)}}i([V],ms.prototype,"blending",void 0),i([o(cs)],ms.prototype,"instance",void 0),i([o(ds)],ms.prototype,"draw",void 0),i([s(0,J(ps))],ms.prototype,"vertex",null),i([s(0,J(ai))],ms.prototype,"fragment",null);const hs={pos:{count:2,type:gt.UNSIGNED_SHORT}};class ys{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(null==this._dotFBO){const t=Ve,i=Ve,s=new At(t,i);s.samplingMode=9728,s.wrapMode=33071;const o=new Vt(e,new zt(xt.DEPTH24_STENCIL8,t,i));this._dotFBO=new Pt(e,s,o)}return this._dotFBO}getDotDensityMesh(e){if(null==this._dotMesh){const t=Ve,i=t*t,s=2,o=new Int16Array(i*s);for(let e=0;e<t;e++)for(let i=0;i<t;i++)o[s*(i+e*t)]=i,o[s*(i+e*t)+1]=e;this._dotMesh=Xt.create(e,{primitive:bt.POINTS,vertex:o,count:i,layout:hs})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),null===this._dotTextures){const s=new he(i);this._dotTextures=[this._allocDotDensityTexture(e,t,s),this._allocDotDensityTexture(e,t,s)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){const s=new Float32Array(t*t*4);for(let e=0;e<s.length;e++)s[e]=i.getFloat();const o=new At(t);return o.dataType=wt.FLOAT,o.samplingMode=9728,new _t(e,o,s)}}function fs(e){const t=1/e;return{antialiasing:t,blur:0+t}}class vs extends si{}i([w(3,r)],vs.prototype,"offset",void 0),i([w(4,g)],vs.prototype,"color",void 0),i([w(5,r)],vs.prototype,"normal",void 0),i([w(6,a)],vs.prototype,"halfWidth",void 0),i([w(7,a)],vs.prototype,"referenceHalfWidth",void 0),i([w(8,r)],vs.prototype,"zoomRange",void 0);class gs extends Wi{}function bs(e,t,i){const{id:s,bitset:o}=t,r=De(o,Xe),n=x(r,new a(.5)),l=$i(e,t),u=b(n,l.halfWidth,new a(0)),p=bi(e,s),c=gi(e,s,t.color),d=b(n,b(ke(o,Qe),c,t.color),c.multiply(p)),m=e.view.displayViewScreenMat3.multiply(new S(t.pos.xy,1)),h=e.clip(t.id),y=new g(m.xy,h,1),f=b(n,l.glPosition,y),v=i&&e.maybeRunHittest(t,i,n);return{isOutline:r,color:d,opacity:new a(1),halfWidth:u,normal:l.normal,glPosition:f,...v}}class xs extends ri{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}}i([o(Gi)],xs.prototype,"antialiasingControls",void 0),i([z(ui)],xs.prototype,"visualVariableColor",void 0),i([z(pi)],xs.prototype,"visualVariableOpacity",void 0),i([z(di)],xs.prototype,"visualVariableSizeMinMaxValue",void 0),i([z(mi)],xs.prototype,"visualVariableSizeScaleStops",void 0),i([z(hi)],xs.prototype,"visualVariableSizeStops",void 0),i([z(yi)],xs.prototype,"visualVariableSizeUnitValue",void 0);class ws extends xs{constructor(){super(...arguments),this.type="OutlineFillShader"}vertex(e,t){return bs(this,e,t)}fragment(e){const{color:t,isOutline:i}=e,s=x(i,new a(.5)),o=Yi(e,this.antialiasingControls.blur),r=b(s,o,t),n=b(s,new a(1/255),new a(0));return this.getFragmentOutput(r,e,n)}hittest(e,t,i){return b(i,Ii(this.hittestRequest),Fi(this,e,t))}}i([s(0,J(vs)),s(1,J(oi))],ws.prototype,"vertex",null),i([s(0,J(gs))],ws.prototype,"fragment",null);class Ss extends ki{}function Vs(e,t){const i=t.tlbr.xy,s=t.tlbr.zw,o=s.x.subtract(i.x),n=i.y.subtract(s.y),u=new r(o,n).multiply(t.inverseRasterizationScale),p=u.multiply(e.view.requiredZoomFactor),c=function(e){const t=new a(1),i=new a(0);return new l(t.divide(e.x),i.divide(e.y),0,j(i.divide(e.x)),t.divide(e.y),0,0,0,1)}(p),d=e.localTileOffset.getPatternOffsetAtTileOrigin(u).divide(p),m=new S(t.pos,1);return{tileTextureCoord:c.multiply(m).xy.subtract(d),tlbr:t.tlbr.divide(e.mosaicInfo.size.xyxy)}}function zs(e,t){const i=m(e.tileTextureCoord,new a(1)),s=C(e.tlbr.xy,e.tlbr.zw,i),o=p(t.texture,s);return e.color.multiply(o)}i([w(5,g)],Ss.prototype,"tlbr",void 0),i([w(6,a)],Ss.prototype,"inverseRasterizationScale",void 0);class Ps extends Li{constructor(){super(...arguments),this.type="PatternFillShader"}vertex(e,t){return{...super.vertex(e,t),...Vs(this,e)}}fragment(e){const t=zs(e,this.mosaicInfo);return this.getFragmentOutput(t,e,new a(0))}}i([o(li)],Ps.prototype,"mosaicInfo",void 0),i([o(ni)],Ps.prototype,"localTileOffset",void 0),i([s(0,J(Ss)),s(1,J(oi))],Ps.prototype,"vertex",null),i([s(0,J(class extends ai{}))],Ps.prototype,"fragment",null);class As extends vs{}i([w(9,g)],As.prototype,"tlbr",void 0),i([w(10,a)],As.prototype,"inverseRasterizationScale",void 0);class _s extends gs{}class Ms extends ws{constructor(){super(...arguments),this.type="PatternOutlineFillShader"}vertex(e,t){return{...bs(this,e,t),...Vs(this,e)}}fragment(e){const{isOutline:t}=e,i=x(t,new a(.5)),s=Yi(e,this.antialiasingControls.blur),o=zs(e,this.mosaicInfo),r=b(i,s,o),n=b(i,new a(1/255),new a(0));return this.getFragmentOutput(r,e,n)}}i([o(li)],Ms.prototype,"mosaicInfo",void 0),i([o(ni)],Ms.prototype,"localTileOffset",void 0),i([s(0,J(As)),s(1,J(oi))],Ms.prototype,"vertex",null),i([s(0,J(_s))],Ms.prototype,"fragment",null);const Ts=1/et;class Rs extends si{}i([w(3,g)],Rs.prototype,"color",void 0),i([w(4,g)],Rs.prototype,"tlbr",void 0),i([w(5,a)],Rs.prototype,"angle",void 0),i([w(6,a)],Rs.prototype,"aux1",void 0),i([w(7,a)],Rs.prototype,"aux2",void 0),i([w(8,r)],Rs.prototype,"aux3",void 0),i([w(9,r)],Rs.prototype,"aux4",void 0),i([w(10,r)],Rs.prototype,"zoomRange",void 0);class Cs extends xs{constructor(){super(...arguments),this.type="ComplexOutlineFillShader"}vertex(e,t){const{aux1:i,aux2:s,aux3:o,aux4:r}=e,n={...e,width:i,height:s,offset:o,scale:r.multiply(Ts)},l=bs(this,{...e,halfWidth:i,referenceHalfWidth:s,offset:o,normal:r.subtract(Je).multiply(Ts)}),u=Ei(this,n),p=x(l.isOutline,new a(.5));return{...l,...u,...Object.assign({},this.maybeRunHittest(e,t,p))}}fragment(e){const{isOutline:t}=e,i=x(t,new a(.5)),s=Yi(e,this.antialiasingControls.blur),o=Ni(this,e),r=b(i,s,o),n=b(i,new a(1/255),new a(0));return this.getFragmentOutput(r,e,n)}hittest(e,t,i){return b(i,Ii(this.hittestRequest),Fi(this,e,t))}}i([o(li)],Cs.prototype,"mosaicInfo",void 0),i([o(ni)],Cs.prototype,"localTileOffset",void 0),i([s(0,J(Rs)),s(1,J(oi))],Cs.prototype,"vertex",null),i([s(0,J(class extends _s{}))],Cs.prototype,"fragment",null);class Ds extends ki{}i([w(5,g)],Ds.prototype,"tlbr",void 0),i([w(6,r)],Ds.prototype,"relativePosition",void 0),i([w(7,a)],Ds.prototype,"gradientMethod",void 0),i([w(8,r)],Ds.prototype,"relativeGradientSize",void 0);class Os extends Li{constructor(){super(...arguments),this.type="GradientFillShader"}vertex(e,t){const{tlbr:i,relativePosition:s,gradientMethod:o,relativeGradientSize:r}=e,n=b(ke(e.bitset,be.isAbsolute),this.view.displayZoomFactor,new a(1));return{...super.vertex(e,t),tlbr:i,relativePosition:s,gradientMethod:o,gradientSize:r.multiply(n),isDiscrete:De(e.bitset,be.isDiscrete)}}fragment(e){const{tlbr:t,relativePosition:i,gradientMethod:s,gradientSize:o,isDiscrete:n}=e,l=b(x(n,new a(.5)),o.subtract(1),new r(0)),u=R([B(s,new a(ge.rectangular)),()=>{const e=q(i).add(l).divide(o);return Ee(ie(e.x,e.y))}],[B(s,new a(ge.circular)),Ee(ae(Y(i,i)).add(l.x).divide(o.x))],[!0,Ee(i.x.add(l.x).divide(o.x))]),c=new r(U(u,new a(0),new a(1)),.5),d=C(t.xy,t.zw,c).divide(this.mosaicInfo.size),m=p(this.mosaicInfo.texture,d),h=e.color.a;return this.getFragmentOutput(m.multiply(h),e,new a(0))}}i([o(li)],Os.prototype,"mosaicInfo",void 0),i([s(0,J(Ds)),s(1,J(oi))],Os.prototype,"vertex",null),i([s(0,J(class extends ai{}))],Os.prototype,"fragment",null);class Is{destroy(){this._accumulateFramebuffer=Dt(this._accumulateFramebuffer),this._resolveGradientTexture=Dt(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return null!=this._accumulateFramebuffer&&null!=this._resolveGradientTexture}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(null==this._qualityProfile){const t=Ot(e,Ct.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources"));this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==wt.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(null==this._accumulateFramebuffer){const{dataType:s,samplingMode:o,pixelFormat:a,internalFormat:r}=this.loadQualityProfile(e),n=new At(t,i);n.pixelFormat=a,n.internalFormat=r,n.dataType=s,n.samplingMode=o,n.wrapMode=33071;const l=new zt(xt.DEPTH24_STENCIL8,t,i);this._accumulateFramebuffer=new Pt(e,n,l)}else{const{width:e,height:s}=this._accumulateFramebuffer;e===t&&s===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(null==this._resolveGradientTexture){const t=new At;t.wrapMode=33071,this._resolveGradientTexture=new _t(e,t),this._prevGradientHash=null}return this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t),this._resolveGradientTexture}}function Fs(e){return e?.25:1}class ks extends si{}i([w(5,r)],ks.prototype,"offset",void 0);class Ls extends u{}i([o(a)],Ls.prototype,"radius",void 0),i([o(a)],Ls.prototype,"isFieldActive",void 0);class Bs extends ri{constructor(){super(...arguments),this.type="HeatmapAccumulateShader",this.usesHalfFloatPrecision=!1}vertex(e){const{radius:t,isFieldActive:i}=this.kernelControls,s=e.offset,o=i.multiply(this.storage.getVVData(e.id).x).add(new a(1).subtract(i)),r=this.view.displayViewScreenMat3.multiply(new S(e.pos,1)).add(this.view.displayViewMat3.multiply(new S(s,0)).multiply(t)),n=this.clip(e.id);return{glPosition:new g(r.xy,n,1),offset:s,fieldValue:o,color:new g(0),...this.maybeRunHittest(e,{},null)}}fragment(e){const{offset:t,fieldValue:i}=e,s=W(t),o=f(s,new a(1)),r=new a(1).subtract(s.multiply(s)),n=r.multiply(r),l=o.multiply(n).multiply(i).multiply(new a(Fs(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new g(l),e)}hittest(e){const{viewMat3:t,tileMat3:i}=this.view;return s=t.multiply(i).multiply(new S(e.pos,1)).xy,o=this.kernelControls.radius,a=this.hittestRequest.position,G(s,a).subtract(o);var s,o,a}}i([V],Bs.prototype,"usesHalfFloatPrecision",void 0),i([o(Ls)],Bs.prototype,"kernelControls",void 0),i([s(0,J(ks))],Bs.prototype,"vertex",null),i([s(0,J(class extends ai{}))],Bs.prototype,"fragment",null);class Us extends P{}i([w(0,r)],Us.prototype,"position",void 0);class Es extends u{}i([o(n)],Es.prototype,"texture",void 0),i([o(r)],Es.prototype,"minAndInvRange",void 0),i([o(a)],Es.prototype,"normalization",void 0);class Ns extends u{}i([o(n)],Ns.prototype,"texture",void 0);class js extends y{constructor(){super(...arguments),this.type="HeatmapResolveShader",this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new g(e.position.multiply(2).subtract(1),1,1),uv:e.position}}fragment(e){const{accumulatedDensity:t,gradient:i}=this;let s=p(t.texture,e.uv).r.divide(new a(Fs(this.usesHalfFloatPrecision)));s=s.multiply(t.normalization),s=s.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const o=p(i.texture,new r(s,.5)),n=new v;return n.fragColor=new g(o.rgb.multiply(o.a),o.a),n}}function Hs(e){return e.key.level+1}i([V],js.prototype,"usesHalfFloatPrecision",void 0),i([o(Es)],js.prototype,"accumulatedDensity",void 0),i([o(Ns)],js.prototype,"gradient",void 0),i([s(0,J(Us))],js.prototype,"vertex",null),i([s(0,J(class extends _{}))],js.prototype,"fragment",null);const qs={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:Hs,compare:518,mask:255,op:{fail:7680,zFail:7680,zPass:7681}}}},Ws={...qs,stencil:!1},Gs={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function Zs(e,t){const{referenceScale:i,radius:s}=e.uniforms;return s*(0!==i?i/t.scale:1)}const Ks=360/254;class $s extends si{}i([w(3,g)],$s.prototype,"color",void 0),i([w(4,r)],$s.prototype,"offset",void 0),i([w(5,r)],$s.prototype,"textureUV",void 0),i([w(6,r)],$s.prototype,"fontAndReferenceSize",void 0),i([w(7,g)],$s.prototype,"outlineColor",void 0),i([w(8,g)],$s.prototype,"haloColor",void 0),i([w(9,r)],$s.prototype,"outlineAndHaloSize",void 0),i([w(10,r)],$s.prototype,"zoomRange",void 0),i([w(11,a)],$s.prototype,"clipAngle",void 0),i([w(12,g)],$s.prototype,"referenceSymbol",void 0),i([w(15,a)],$s.prototype,"visibility",void 0);class Ys extends A{}i([w(13,r)],Ys.prototype,"offsetNextVertex1",void 0),i([w(14,r)],Ys.prototype,"offsetNextVertex2",void 0);class Xs extends ri{constructor(){super(...arguments),this.type="TextShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.textRenderPassType=0,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t){const{clipAngle:i,zoomRange:s,visibility:o}=e,r=i.multiply(Ks),n=q(this.view.rotation.subtract(r)),l=Q(new a(360).subtract(n),n);let u=new a(0);const p=re(this.view.currentZoom.multiply(Ae)).divide(Ae),c=s.x,d=s.y,m=new a(1).subtract(f(c,p)).multiply(2),h=f(new a(90),l).multiply(2),y=new a(2).multiply(new a(1).subtract(f(p,d)));return u=u.add(t.multiply(m)),u=u.add(t.multiply(h)),u=u.add(y),o&&(u=u.add(o)),u}vertex(e,t){const i=De(e.bitset,st),s=new a(1).subtract(i);let o=e.fontAndReferenceSize[0];const n=e.fontAndReferenceSize[1];let u=o.divide(tt);const p=1===this.textRenderPassType?e.outlineColor:2===this.textRenderPassType?e.haloColor:this._getVertexColor(e),c=this.view.displayViewScreenMat3.multiply(new S(e.pos,1));let d=e.offset,m=new a(1),h=l.identity(),y=new r(0);if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const t=e.referenceSymbol,i=t.xy,s=t.z,o=this._unpackDirection(t.w),a=vi(this,e.id,s).divide(2),r=o.multiply(a.add(_e));y=i.add(r),d=d.add(y)}else m=vi(this,e.id,n).divide(n),o=o.multiply(m),u=u.multiply(m),d=d.multiply(m),h=xi(this,e.id),d=h.multiply(new S(d,0)).xy;const f=De(e.bitset,ot),v=this._getViewRotationMatrix(f).multiply(new S(d,0));let w=this.isLabel?this.clipLabel(e,f):this.clip(e.id,e.zoomRange);w=this.isBackgroundPass?w.add(s.multiply(2)):w.add(i.multiply(2));let V=new a(0);if(1===this.textRenderPassType&&(w=w.add(b(B(e.outlineAndHaloSize.x,new a(0)),new a(2),new a(0))),V=new a(e.outlineAndHaloSize.x).divide(u).divide(it)),2===this.textRenderPassType){const t=e.outlineAndHaloSize.x,i=new a(e.outlineAndHaloSize.y);w=w.add(b(B(i,new a(0)),new a(2),new a(0))),V=i.add(t).divide(u).divide(it)}const z=this.isLabel?x(w,new a(1)):new E(!1);return{glPosition:new g(c.xy.add(v.xy),w,1),color:p,size:u,textureUV:e.textureUV.divide(this.mosaicInfo.size),antialiasingWidth:new a(.105*tt).divide(o).divide(this.view.pixelRatio),outlineDistanceOffset:V,...this.maybeRunHittest(e,t,{vvSizeAdjustment:m,vvRotation:h,labelOffset:y,labelClipped:z})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,s=new a(1).subtract(e);return t.multiply(e).add(i.multiply(s))}fragment(e){const t=new a(2/8),i=new a(1).subtract(t),s=p(this.mosaicInfo.texture,e.textureUV).a;let o=i.subtract(e.outlineDistanceOffset);this.highlight&&(o=o.divide(2));const r=e.antialiasingWidth,n=oe(o.subtract(r),o.add(r),s);return this.getFragmentOutput(e.color.multiply(n),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:s,labelOffset:o,labelClipped:a}){let r,n,l;this.isLabel?(r=new S(e.offset.add(o),0),n=new S(t.offsetNextVertex1.add(o),0),l=new S(t.offsetNextVertex2.add(o),0)):(r=s.multiply(new S(e.offset.multiply(i),0)),n=s.multiply(new S(t.offsetNextVertex1.multiply(i),0)),l=s.multiply(new S(t.offsetNextVertex2.multiply(i),0)));const{viewMat3:u,tileMat3:p}=this.view,c=u.multiply(p).multiply(new S(e.pos,1)),d=c.add(p.multiply(r)).xy,m=c.add(p.multiply(n)).xy,h=c.add(p.multiply(l)).xy,y=Oi(this.hittestRequest.position,d.xy,m.xy,h.xy);return this.isLabel?b(a,Ii(this.hittestRequest),y):y}_unpackDirection(e){const t=new ne(e),i=le(t,new ne(2)),s=ue(t,new ne(3));return new r(new a(i).subtract(1),new a(s).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new E(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(e.id),s=this.visualVariableOpacity.getOpacity(i);t=t.multiply(s)}return t}}i([z(ui)],Xs.prototype,"visualVariableColor",void 0),i([z(pi)],Xs.prototype,"visualVariableOpacity",void 0),i([z(ci)],Xs.prototype,"visualVariableRotation",void 0),i([z(di)],Xs.prototype,"visualVariableSizeMinMaxValue",void 0),i([z(mi)],Xs.prototype,"visualVariableSizeScaleStops",void 0),i([z(hi)],Xs.prototype,"visualVariableSizeStops",void 0),i([z(yi)],Xs.prototype,"visualVariableSizeUnitValue",void 0),i([o(li)],Xs.prototype,"mosaicInfo",void 0),i([V],Xs.prototype,"textRenderPassType",void 0),i([V],Xs.prototype,"isBackgroundPass",void 0),i([V],Xs.prototype,"isLabel",void 0),i([s(0,J($s)),s(1,J(Ys))],Xs.prototype,"vertex",null),i([s(0,J(class extends ai{}))],Xs.prototype,"fragment",null);class Qs extends qi{}i([w(9,a)],Qs.prototype,"accumulatedDistance",void 0),i([w(10,a)],Qs.prototype,"totalLength",void 0),i([w(11,a)],Qs.prototype,"gradientSize",void 0),i([w(12,r)],Qs.prototype,"segmentDirection",void 0),i([w(13,g)],Qs.prototype,"tlbr",void 0);class Js extends u{}i([o(a)],Js.prototype,"isColorPass",void 0);class eo extends Xi{constructor(){super(...arguments),this.type="GradientStrokeShader"}vertex(e,t){const{totalLength:i,gradientSize:s,segmentDirection:o,tlbr:r}=e,n=$i(this,e),l=De(e.bitset,xe.isAlongLine),u=i.divide(this.view.displayZoomFactor),p=b(ke(e.bitset,xe.isAbsoluteSize),()=>{const e=b(x(l,new a(.5)),u,n.halfWidth);return s.divide(e)},s),c=e.accumulatedDistance.add(Y(o,n.scaledOffset).divide(u)),d=r.divide(this.mosaicInfo.size.xyxy);return{...n,tlbr:d,relativePositionAlongLine:c,relativeGradientSize:p,isAlongLine:De(e.bitset,xe.isAlongLine),isDiscrete:De(e.bitset,xe.isDiscrete),...this.maybeRunHittest(e,t,n.halfWidth)}}fragment(e){const{isAlongLine:t,isDiscrete:i,relativePositionAlongLine:s,relativeGradientSize:o,normal:n,tlbr:l}=e,u=Ki(e,this.antialiasingControls.blur),c=(d=n.y,f(new a(0),d).multiply(2).subtract(1)).multiply(Q(W(n),new a(1)));var d;const m=new a(.5).multiply(c).add(new a(.5)),h=b(x(t,new a(.5)),s,m),y=b(x(i,new a(.5)),o.subtract(1),new a(0)),v=Ee(h.add(y).divide(o)),g=C(l.xy,l.zw,new r(U(v,new a(0),new a(1)),.5)),w=p(this.mosaicInfo.texture,g),S=e.opacity.multiply(u),V=this.getFragmentOutput(w.multiply(S),e),z=f(new a(.5),this.technique.isColorPass).multiply(de("gradient-depth-epsilon")),P=f(new a(0),n.y).multiply(new a(de("gradient-depth-bias")).subtract(z));return V.glFragDepth=U(W(n).add(P),new a(0),new a(1)),V}}i([o(li)],eo.prototype,"mosaicInfo",void 0),i([o(Js)],eo.prototype,"technique",void 0),i([s(0,J(Qs)),s(1,J(oi))],eo.prototype,"vertex",null);class to extends qi{}i([w(9,a)],to.prototype,"accumulatedDistance",void 0),i([w(10,r)],to.prototype,"segmentDirection",void 0),i([w(11,a)],to.prototype,"offsetAlongLine",void 0),i([w(12,a)],to.prototype,"capType",void 0),i([w(13,g)],to.prototype,"tlbr",void 0);class io extends Xi{constructor(){super(...arguments),this.type="TexturedLineShader"}_getDistanceRatio(e,t){const i=De(e.bitset,at);return i.multiply(ie(t,new a(.25)).multiply(new a(2))).add(new a(1).subtract(i).multiply(It(1)))}_getSDFAlpha(e){const{halfWidth:t,normal:i,tlbr:s,patternSize:o,accumulatedDistance:n,offsetAlongLine:l,dashToPx:u,capType:c}=e,d=o.x.divide(kt).multiply(u),m=M(n.add(l).divide(d)),h=C(s.xy,s.zw,new r(m,.5)),y=Fe(p(this.mosaicInfo.texture,h)).multiply(2).subtract(1).multiply(Lt).multiply(u),f=i.y.multiply(t),v=R([B(c,new a(1)),y.subtract(t)],[B(c,new a(2)),ae(pe(ie(y,new a(0)),new a(2)).add(f.multiply(f))).subtract(t)],[!0,y]),b=U(new a(.25).subtract(v),new a(0),new a(1));return new g(b)}_getPatternColor(e){const{halfWidth:t,normal:i,color:s,accumulatedDistance:o,patternSize:n,sampleAlphaOnly:l,tlbr:u}=e,c=n.y.multiply(new a(2).multiply(t).divide(n.x)),d=M(o.divide(c)),m=new a(.5).multiply(i.y).add(new a(.5)),h=C(u.xy,u.zw,new r(m,d));let y=p(this.mosaicInfo.texture,h);return null!=this.visualVariableColor&&(y=b(x(l,new a(.5)),new g(s.a),s)),y}vertex(e,t){const{segmentDirection:i,tlbr:s,bitset:o}=e,n=$i(this,e),l=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(Y(i,n.scaledOffset)),u=new r(s.z.subtract(s.x),s.w.subtract(s.y)),p=s.divide(this.mosaicInfo.size.xyxy),c=De(o,rt),d=De(o,Ge),m=b(x(c,new a(.5)),this._getDistanceRatio(e,n.scaledHalfWidth),new a(1));return{...n,tlbr:p,patternSize:u,accumulatedDistance:l,isSDF:c,sampleAlphaOnly:d,dashToPx:m,offsetAlongLine:e.offsetAlongLine,capType:e.capType,...this.maybeRunHittest(e,t,n.halfWidth)}}fragment(e){const{color:t,opacity:i,isSDF:s}=e,o=Ki(e,this.antialiasingControls.blur),r=b(x(s,new a(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),n=t.multiply(i).multiply(o).multiply(r);return this.getFragmentOutput(n,e)}}i([o(li)],io.prototype,"mosaicInfo",void 0),i([s(0,J(to)),s(1,J(oi))],io.prototype,"vertex",null);class so extends si{}i([w(3,g)],so.prototype,"color",void 0),i([w(4,g)],so.prototype,"outlineColor",void 0),i([w(5,r)],so.prototype,"offset",void 0),i([w(6,r)],so.prototype,"textureUV",void 0),i([w(7,g)],so.prototype,"sizing",void 0),i([w(8,a)],so.prototype,"placementAngle",void 0),i([w(9,a)],so.prototype,"sdfDecodeCoeff",void 0),i([w(10,r)],so.prototype,"zoomRange",void 0);class oo extends A{}function ao(e,t,i,s){return t.multiply(e.x).add(i.multiply(e.y)).add(s.multiply(e.z))}function ro(e){return e.multiply(e).divide(128)}i([w(11,r)],oo.prototype,"offsetNextVertex1",void 0),i([w(12,r)],oo.prototype,"offsetNextVertex2",void 0),i([w(13,r)],oo.prototype,"textureUVNextVertex1",void 0),i([w(14,r)],oo.prototype,"textureUVNextVertex2",void 0);class no extends ri{constructor(){super(...arguments),this.type="MarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=ro(e.sizing.x),s=ro(e.sizing.y),o=ro(e.sizing.z),r=e.placementAngle,n=De(e.bitset,ve.bitset.isSDF),u=De(e.bitset,ve.bitset.isMapAligned),p=De(e.bitset,ve.bitset.scaleSymbolsProportionally),c=ke(e.bitset,ve.bitset.colorLocked),d=bi(this,e.id),m=gi(this,e.id,e.color,c).multiply(d),h=this.view.displayViewScreenMat3.multiply(new S(e.pos.xy,1)),y=vi(this,e.id,o).divide(o),f=i.multiply(y),v=e.offset.xy.multiply(y);let b=s.multiply(p.multiply(y.subtract(1)).add(1));b=Q(b,ie(f.subtract(.99),new a(0)));const x=ie(b,new a(1)),w=Q(b,new a(1)),V=l.fromRotation(r.multiply(He)),z=xi(this,e.id),P=this._getViewRotationMatrix(u).multiply(z).multiply(V).multiply(new S(v.xy,0)),A=this.clip(e.id,e.zoomRange),_=new g(h.xy.add(P.xy),A,1),M=e.textureUV.divide(this.mosaicInfo.size),T=e.outlineColor.multiply(w),R=De(e.bitset,ve.bitset.overrideOutlineColor),C=e.sdfDecodeCoeff.multiply(f);return{glPosition:_,color:m,textureUV:M,outlineColor:T,outlineSize:x,distanceToPx:C,isSDF:n,overrideOutlineColor:R,...this.maybeRunHittest(e,t,{pos:e.pos,size:f,sizeCorrection:y,isMapAligned:u,vvRotationMat3:z,placementMat3:V,outlineSize:x,distanceToPx:C,isSDF:n})}}fragment(e){const t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return b(K(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,s=new a(1).subtract(e);return t.multiply(e).add(i.multiply(s))}_getViewScreenMatrix(e){const t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,s=new a(1).subtract(e);return t.multiply(e).add(i.multiply(s))}_getColor(e,t){return b(B(t.isSDF,new a(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return p(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=p(this.mosaicInfo.texture,e),s=new a(.5).subtract(Fe(i)).multiply(t.distanceToPx).multiply(qe),o=U(new a(.5).subtract(s),new a(0),new a(1)),r=t.color.multiply(o);let n=t.outlineSize;this.highlight&&(n=ie(n,t.overrideOutlineColor.multiply(4)));const l=n.multiply(.5),u=q(s).subtract(l),c=U(new a(.5).subtract(u),new a(0),new a(1)),d=C(t.outlineColor,t.color,t.overrideOutlineColor).multiply(c);return new a(1).subtract(d.a).multiply(r).add(d)}_hittestSmallMarker(e,t,i){const{position:s,distance:o,smallSymbolDistance:a}=this.hittestRequest,r=o.subtract(a),{viewMat3:n,tileMat3:l}=this.view,u=n.multiply(l).multiply(new S(i.pos,1)).xy,p=i.size.multiply(.5);return G(u,s).subtract(p).add(r)}_hittestMarker(e,t,i){const{pos:s,sizeCorrection:o,isMapAligned:a}=i,r=new S(e.offset.multiply(o),0),n=new S(t.offsetNextVertex1.multiply(o),0),l=new S(t.offsetNextVertex2.multiply(o),0),{viewMat3:u,tileMat3:p}=this.view,c=u.multiply(p).multiply(new S(s,1)),d=this._getViewScreenMatrix(a).multiply(i.vvRotationMat3).multiply(i.placementMat3),m=c.add(d.multiply(r)).xy,h=c.add(d.multiply(n)).xy,y=c.add(d.multiply(l)).xy,f=this.hittestRequest.position,v=this.hittestRequest.distance,g=Oi(f,m,h,y);return b(x(g,v),g,this._hittestSamples(m,h,y,e,t,i))}_hittestSamples(e,t,i,s,o,n){const{outlineSize:l,isSDF:u,distanceToPx:p}=n,c=this.hittestRequest.position,d=this.hittestRequest.distance,m=Ci(c.add(new r(j(d),j(d))),e,t,i),h=Ci(c.add(new r(0,j(d))),e,t,i),y=Ci(c.add(new r(d,j(d))),e,t,i),v=Ci(c.add(new r(j(d),0)),e,t,i),b=Ci(c,e,t,i),x=Ci(c.add(new r(d,0)),e,t,i),w=Ci(c.add(new r(j(d),d)),e,t,i),S=Ci(c.add(new r(0,d)),e,t,i),V=Ci(c.add(new r(d,d)),e,t,i),z=s.textureUV.divide(this.mosaicInfo.size),P=o.textureUVNextVertex1.divide(this.mosaicInfo.size),A=o.textureUVNextVertex2.divide(this.mosaicInfo.size),_={color:new g(1),outlineColor:new g(1),overrideOutlineColor:new a(1),outlineSize:l,distanceToPx:p,isSDF:u};let M=new a(0);return M=M.add(Ri(m).multiply(this._getColor(ao(m,z,P,A),_).a)),M=M.add(Ri(h).multiply(this._getColor(ao(h,z,P,A),_).a)),M=M.add(Ri(y).multiply(this._getColor(ao(y,z,P,A),_).a)),M=M.add(Ri(v).multiply(this._getColor(ao(v,z,P,A),_).a)),M=M.add(Ri(b).multiply(this._getColor(ao(b,z,P,A),_).a)),M=M.add(Ri(x).multiply(this._getColor(ao(x,z,P,A),_).a)),M=M.add(Ri(w).multiply(this._getColor(ao(w,z,P,A),_).a)),M=M.add(Ri(S).multiply(this._getColor(ao(S,z,P,A),_).a)),M=M.add(Ri(V).multiply(this._getColor(ao(V,z,P,A),_).a)),f(M,new a(.05)).multiply(Ii(this.hittestRequest))}}i([z(ui)],no.prototype,"visualVariableColor",void 0),i([z(pi)],no.prototype,"visualVariableOpacity",void 0),i([z(ci)],no.prototype,"visualVariableRotation",void 0),i([z(di)],no.prototype,"visualVariableSizeMinMaxValue",void 0),i([z(mi)],no.prototype,"visualVariableSizeScaleStops",void 0),i([z(hi)],no.prototype,"visualVariableSizeStops",void 0),i([z(yi)],no.prototype,"visualVariableSizeUnitValue",void 0),i([o(li)],no.prototype,"mosaicInfo",void 0),i([s(0,J(so)),s(1,J(oo))],no.prototype,"vertex",null),i([s(0,J(class extends ai{}))],no.prototype,"fragment",null);class lo{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map(([e,t])=>`${e}.${t}`).join(".");this._locationInfo={stringHash:t,locations:e,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){return`${Object.keys(e).map(t=>`${t}.${e[t]}`).join(".")}.${Object.keys(i).filter(e=>i[e]).map(e=>`${e}_${i[e].toString()}`).join(".")}.${Object.keys(t).filter(e=>this.optionPropertyKeys.has(e)).join(".")}`}getProgram(e,t,i,s){let o="",a="";for(const e in i)if(i[e]){const t="boolean"==typeof i[e]?`#define ${e}\n`:`#define ${e} ${i[e]}\n`;o+=t,a+=t}return o+=this.vertexShader,a+=this.fragmentShader,new ce(o,a,this.renamedLocationsMap,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const e in this.required){const i=this.required[e];t.push({uniformHydrated:null,shaderModulePath:e,uniformName:e,uniformType:i.type,uniformArrayElementType:uo(i),uniformArrayLength:po(i)})}for(const i in e){const s=this.options[i];if(e[i])for(const e in s){const o=s[e];t.push({uniformHydrated:null,shaderModulePath:`${i}.${e}`,uniformName:e,uniformType:o.type,uniformArrayElementType:uo(o),uniformArrayLength:po(o)})}}return t}}const uo=e=>"array"===e.type?e.elementType?.type:void 0,po=e=>"array"===e.type?e.size:void 0,co={hittestDist:a,hittestPos:r},mo={filterFlags:n,animation:n,visualVariableData:n,dataDriven0:n,dataDriven1:n,dataDriven2:n,gpgpu:n,size:a},ho={displayViewScreenMat3:l,displayViewMat3:l,displayMat3:l,viewMat3:l,tileMat3:l,displayZoomFactor:a,requiredZoomFactor:a,tileOffset:r,currentScale:a,currentZoom:a,metersPerSRUnit:a};class yo extends lo{constructor(){super(...arguments),this.vertexShader=Bt("materials/pie/pie.vert"),this.fragmentShader=Bt("materials/pie/pie.frag"),this.required={...mo,...ho,outlineWidth:a,colors:T,defaultColor:g,othersColor:g,outlineColor:g,donutRatio:a,sectorThreshold:a},this.options={hittestUniforms:co,visualVariableSizeMinMaxValue:{minMaxValueAndSize:g},visualVariableSizeScaleStops:{sizes:{type:"array",elementType:a,size:8},values:{type:"array",elementType:a,size:8}},visualVariableSizeStops:{sizes:{type:"array",elementType:a,size:8},values:{type:"array",elementType:a,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:a},visualVariableOpacity:{opacities:{type:"array",elementType:a,size:8},opacityValues:{type:"array",elementType:a,size:8}},highlightUniforms:{highlightAll:a,activeReasons:a}},this.locations={pos:{index:0,type:r},id:{index:1,type:S},bitset:{index:2,type:a},offset:{index:3,type:r},texCoords:{index:4,type:r},size:{index:5,type:r},referenceSize:{index:6,type:a},zoomRange:{index:7,type:r}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={type:"array",elementType:g,size:e}}}const fo={fill:new class extends os{constructor(){super(...arguments),this.type=9,this.shaders={geometry:new Li}}render(e,t){const{painter:i}=e,s=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...mt(e,t.target,s.uniforms),...dt(e,t.target)},defines:pt(e),optionalAttributes:s.optionalAttributes,useComputeBuffer:ft(e)}),i.setPipelineState(ht(e)),i.submitDraw(e,t)}},patternFill:new class extends os{constructor(){super(...arguments),this.type=21,this.shaders={geometry:new Ps}}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...mt(e,t.target,o.uniforms),...dt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:ct(t.target)},defines:{...pt(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:ft(e)}),s.setPipelineState(ht(e)),s.submitDraw(e,t)}},complexFill:new class extends os{constructor(){super(...arguments),this.type=6,this.shaders={geometry:new ji}}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...mt(e,t.target,o.uniforms),...dt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:ct(t.target)},defines:{...pt(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:ft(e)}),s.setPipelineState(ht(e)),s.submitDraw(e,t)}},gradientFill:new class extends os{constructor(){super(...arguments),this.type=10,this.shaders={geometry:new Os},this.symbologyPlane=0}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...mt(e,t.target,o.uniforms),...dt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...pt(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:ft(e)}),s.setPipelineState(ht(e)),s.submitDraw(e,t)}},outlineFill:new class extends os{constructor(){super(...arguments),this.type=19,this.shaders={geometry:new ws}}render(e,t){const{painter:i,pixelRatio:s}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...mt(e,t.target,o.uniforms),...dt(e,t.target),antialiasingControls:fs(s)},defines:{...pt(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:ft(e)}),i.setPipelineState(ht(e)),i.submitDraw(e,t)}},patternOutlineFill:new class extends os{constructor(){super(...arguments),this.type=22,this.shaders={geometry:new Ms}}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...mt(e,t.target,a.uniforms),...dt(e,t.target),antialiasingControls:fs(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:ct(t.target)},defines:{...pt(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:ft(e)}),s.setPipelineState(ht(e)),s.submitDraw(e,t)}},complexOutlineFill:new class extends os{constructor(){super(...arguments),this.type=7,this.shaders={geometry:new Cs}}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...mt(e,t.target,a.uniforms),...dt(e,t.target),antialiasingControls:fs(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:ct(t.target)},defines:{...pt(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:ft(e)}),s.setPipelineState(ht(e)),s.submitDraw(e,t)}},marker:new class extends os{constructor(){super(...arguments),this.type=17,this.shaders={geometry:new no},this.symbologyPlane=2}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...mt(e,t.target,o.uniforms),...dt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey,!0)},defines:{...pt(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:ft(e)}),s.setPipelineState(ht(e)),s.submitDraw(e,t)}},pieChart:new class extends os{constructor(){super(...arguments),this.type=23,this.shaders={geometry:new yo},this.symbologyPlane=2}render(e,t){const{painter:i}=e,{instance:s,target:o}=t,a=this.shaders.geometry,r=s.getInput(),n=r.uniforms.numberOfFields,l=ft(e),u=dt(e,o),p=pt(e);a.setNumberOfFields(n),i.setShader({shader:a,uniforms:{...mt(e,t.target,r.uniforms.shader),...u.storage,...u.view,...u.highlight,highlightUniforms:u.highlight,hittestUniforms:u.hittestRequest?{hittestDist:u.hittestRequest?.distance,hittestPos:u.hittestRequest?.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!r.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!r.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!r.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!r.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!r.uniforms.shader.visualVariableOpacity,HITTEST:l,highlight:u.highlight?1:0,...p,numberOfFields:n},optionalAttributes:{},useComputeBuffer:l}),i.setPipelineState(ht(e)),i.submitDraw(e,t)}},line:new class extends os{constructor(){super(...arguments),this.type=15,this.shaders={geometry:new Xi},this.symbologyPlane=1}render(e,t){const{painter:i,pixelRatio:s}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...mt(e,t.target,o.uniforms),...dt(e,t.target),antialiasingControls:fs(s)},defines:{...pt(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:ft(e)}),i.setPipelineState(ht(e)),i.submitDraw(e,t)}},texturedLine:new class extends os{constructor(){super(...arguments),this.type=26,this.shaders={geometry:new io},this.symbologyPlane=1}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...mt(e,t.target,a.uniforms),...dt(e,t.target),antialiasingControls:fs(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...pt(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:ft(e)}),s.setPipelineState(ht(e)),s.submitDraw(e,t)}},gradientStroke:new class extends os{constructor(){super(...arguments),this.type=11,this.shaders={geometry:new eo},this.symbologyPlane=1}_getShaderOptions(e,t,i){const{context:s,painter:o,pixelRatio:a}=e,r=t.instance.getInput();return{shader:this.shaders.geometry,uniforms:{...mt(e,t.target,r.uniforms),...dt(e,t.target),antialiasingControls:fs(a),mosaicInfo:o.textureManager.getMosaicInfo(s,t.textureKey),technique:{isColorPass:i}},defines:{...pt(e)},optionalAttributes:r.optionalAttributes,useComputeBuffer:ft(e)}}render(e,t){const{painter:i}=e;if(ft(e)||yt(e)){const s=ht(e);return i.setPipelineState(s),i.setShader(this._getShaderOptions(e,t,1)),void i.submitDraw(e,t)}e.context.setClearDepth(1),e.context.clear(256),i.setShader(this._getShaderOptions(e,t,0)),i.setPipelineState({color:!1,depth:{write:{zNear:0,zFar:1},test:513},stencil:{write:!1,test:{ref:e=>e.stencilRef,compare:514,mask:255,op:{fail:7680,zFail:7680,zPass:7680}}}}),i.submitDraw(e,t),i.setShader(this._getShaderOptions(e,t,1)),i.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:{write:!1,test:515},stencil:{write:!1,test:{ref:e=>e.stencilRef,compare:514,mask:255,op:{fail:7680,zFail:7680,zPass:7680}}}}),i.submitDraw(e,t)}},text:new class extends os{constructor(){super(...arguments),this.type=25,this.shaders={geometry:new Xs},this.symbologyPlane=3}render(e,t){const{context:i,painter:s}=e,o=pt(e),a=t.instance.getInput(),r={shader:this.shaders.geometry,uniforms:{...mt(e,t.target,a.uniforms),...dt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...o,isBackgroundPass:!0,isLabel:!1,textRenderPassType:0},optionalAttributes:a.optionalAttributes,useComputeBuffer:ft(e)};s.setShader(r),s.setPipelineState(ht(e)),s.submitDraw(e,t),s.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:2}}),s.submitDraw(e,t),s.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:1}}),s.submitDraw(e,t),s.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:0}}),s.submitDraw(e,t)}},label:new class extends os{constructor(){super(...arguments),this.type=14,this.shaders={geometry:new Xs},this.drawPhase=14,this.symbologyPlane=3}render(e,t){const{context:i,painter:s}=e,o=pt(e),a={...ht(e),stencil:{write:!1,test:{ref:()=>255,compare:516,mask:255,op:{fail:7680,zFail:7680,zPass:7680}}}},r=t.instance.getInput(),n={shader:this.shaders.geometry,uniforms:{...mt(e,t.target,r.uniforms),...dt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...o,textRenderPassType:0,isBackgroundPass:!0,isLabel:!0},optionalAttributes:r.optionalAttributes,useComputeBuffer:ft(e)};s.setPipelineState(a),s.setShader(n),s.submitDraw(e,t),s.setShader({...n,defines:{...o,textRenderPassType:2,isBackgroundPass:!1,isLabel:!0}}),s.submitDraw(e,t),s.setShader({...n,defines:{...o,textRenderPassType:0,isBackgroundPass:!1,isLabel:!0}}),s.submitDraw(e,t)}},heatmap:new class extends os{constructor(){super(...arguments),this.type=13,this.drawPhase=73,this.shaders={accumulate:new Bs,resolve:new js},this._isBound=!1,this._resources=new Map}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:i,painter:s,state:o}=e,a=t.instance.getInput(),{isFieldActive:r}=a.uniforms,n=this._getOrCreateResourcesRecord(i),l=n.loadQualityProfile(i);ft(e)||this._bind(e,n,a),s.setShader({shader:this.shaders.accumulate,uniforms:{...dt(e,t.target),kernelControls:{radius:Zs(a,o),isFieldActive:r?1:0}},defines:{...pt(e),...l.defines},optionalAttributes:{},useComputeBuffer:ft(e)});const u=ft(e)?Ws:qs;s.setPipelineState(u),s.submitDraw(e,t)}getStencilReference(e){return Hs(e)}renderResolvePass(e,t){if(ft(e))return;const{context:i,painter:s}=e,o=this._resources.get(i);if(null==this._prevFBO||null==this._prevViewport||!o?.initialized)return;const{defines:a}=o.loadQualityProfile(i),{minDensity:r,maxDensity:n,radius:l}=t.getInput().uniforms,u=o.accumulateFramebuffer,p=o.resolveGradientTexture,c={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:8,texture:u.colorTexture},minAndInvRange:[r,1/(n-r)],normalization:3/(l*l*Math.PI)},gradient:{texture:{unit:9,texture:p}}},defines:a,optionalAttributes:{},useComputeBuffer:!1};i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(u.colorTexture,8),i.bindTexture(p,9),s.setPipelineState(Gs),s.submitDrawMesh(i,c,s.quadMesh),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new Is,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;const{context:s,state:o,pixelRatio:a}=e,r=s.getBoundFramebufferObject(),n=s.getViewport();this._prevFBO=r,this._prevViewport=n;const{gradient:l,gradientHash:u}=i.uniforms;t.ensureResolveGradientTexture(s,u,l);const{width:p,height:c}=n,d=function(e,t){const i=t>1.5?.25:.5;return e<1/(2*i)?1:i}(Zs(i,o),a),m=p*d,h=c*d,y=t.ensureAccumulateFBO(s,m,h);s.blitFramebuffer(r,y,1024),s.bindFramebuffer(y),s.setViewport(0,0,y.width,y.height),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(16384),this._isBound=!0}},dotDensity:new class extends os{constructor(){super(...arguments),this.type=8,this.shaders={polygon:new ms,point:new us,fill:new Li},this._resources=new Map}render(e,t){yt(e)||ft(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:{...dt(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...pt(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:ft(e)}),i.setPipelineState(ht(e)),i.submitDraw(e,t)}_renderDotDensity(e,t){const{context:i,painter:s,requiredLevel:o}=e,a=t.instance.getInput().uniforms,r=this._getOrCreateResourcesRecord(i),n=r.getDotDensityTextures(i,Ve,a.seed),l=1/2**(o-t.target.key.level),u=Ve,p=u*window.devicePixelRatio*u*window.devicePixelRatio,c=1/l*(1/l),d=a.dotScale?e.state.scale/a.dotScale:1,m=a.dotValue*d*c;s.setShader({shader:this.shaders.polygon,uniforms:{...dt(e,t.target),instance:{isActive:a.isActive,colors:a.colors,dotValue:Math.max(1,m)},draw:{dotTexture0:{unit:Pe,texture:n[0]},dotTexture1:{unit:ze,texture:n[1]},tileZoomFactor:l,pixelRatio:window.devicePixelRatio,tileDotsOverArea:p/(Ve*window.devicePixelRatio*Ve*window.devicePixelRatio)}},defines:{...pt(e),blending:a.blending},optionalAttributes:{},useComputeBuffer:!1});const h=i.getViewport();i.setViewport(0,0,Ve,Ve);const y=i.getBoundFramebufferObject(),f=r.getFBO(i);i.bindFramebuffer(f),i.setClearColor(0,0,0,0),i.clear(16384),s.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),s.updatePipelineState(i),s.submitDraw(e,t),i.bindFramebuffer(y),i.setViewport(h.x,h.y,h.width,h.height);const v=r.getFBO(i).colorTexture,g={shader:this.shaders.point,uniforms:{view:vt(e,t.target),instance:{dotSize:a.dotSize},draw:{locations:{unit:Pe,texture:v},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...pt(e)},optionalAttributes:{},useComputeBuffer:!1};s.setPipelineState(ht(e)),s.submitDrawMesh(i,g,r.getDotDensityMesh(i))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new ys,this._resources.set(e,t)),t}},animatedMarker:new class extends as{constructor(){super(...arguments),this.type=2,this.symbologyPlane=2,this.shaders={geometry:new ss}}},animatedMarkerShift:new class extends as{constructor(){super(...arguments),this.type=3,this.symbologyPlane=2,this.shaders={geometry:new ss}}},animatedFill:new class extends as{constructor(){super(...arguments),this.type=0,this.symbologyPlane=0,this.shaders={geometry:new Hi}}},animatedLine:new class extends as{constructor(){super(...arguments),this.type=1,this.symbologyPlane=1,this.shaders={geometry:new Ji}}}};function vo(){for(const e in fo)fo[e].startup()}function go(e){for(const t in fo)fo[t].shutdown(e)}function bo(e,t){const i=e.slice(0,t),s=t-i.length;for(let e=0;e<s;e++){const e=i[i.length-1];i.push(e)}return i}function xo(e){if(!e)return[0,0,0,0];const{r:t,g:i,b:s,a:o}=e;return[t*(o/255),i*(o/255),s*(o/255),o]}const wo=()=>Ct.getLogger("esri.views.2d.layers.features.support.rendererUtils");function So(e){return e.map(e=>function(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}(e)?function(e){return e.stops=(t=e.type,(i=e.stops??[]).length<=8?i:(wo().warn(`Found ${i.length} Visual Variable stops, but MapView only supports 8. Displayed stops will be simplified.`),i.length>16?function(e,t){const[i,...s]=t,o=s.pop(),a=s[0].value,r=s[s.length-1].value,n=(r-a)/6,l=[];for(let i=a;i<r;i+=n){let o=0;for(;i>=s[o].value;)o++;const a=s[o],r=t[o-1],n=i-r.value,u=a.value===r.value?1:n/(a.value-r.value);if("color"===e){const e=s[o],a=t[o-1],r=e.color.clone();r.r=Vo(a.color.r,r.r,u),r.g=Vo(a.color.g,r.g,u),r.b=Vo(a.color.b,r.b,u),r.a=Vo(a.color.a,r.a,u),l.push({value:i,color:r,label:e.label})}else if("size"===e){const e=s[o],a=t[o-1],r=Ft(e.size),n=Vo(Ft(a.size),r,u);l.push({value:i,size:n,label:e.label})}else{const e=s[o],a=Vo(t[o-1].opacity,e.opacity,u);l.push({value:i,opacity:a,label:e.label})}}return[i,...l,o]}(t,i):function(e){const[t,...i]=e,s=i.pop();for(;i.length>6;){let e=0,t=0;for(let s=1;s<i.length;s++){const o=i[s-1],a=i[s],r=Math.abs(a.value-o.value);r>t&&(t=r,e=s)}i.splice(e,1)}return[t,...i,s]}(i))),e;var t,i}(e.clone()):e)}function Vo(e,t,i){return(1-i)*e+i*t}function zo(e){if(!e)return!0;switch(e.type){case"dot-density":break;case"heatmap":if(!function(){const{supportsColorBufferFloat:e,supportsColorBufferFloatBlend:t,supportsColorBufferHalfFloat:i}=Ht();return e&&t||i}()){const e=Ht(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(t=>!e[t]).join(", ");return wo().errorOnce(new jt("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}function Po(e){if(!e.stops?.length)return null;const t=bo(e.stops.sort((e,t)=>e.value-t.value),8),i=t.map(({value:e})=>e),s=t.map(({color:e})=>xo(e));return{values:i,colors:s}}function Ao(e){if(!e.stops?.length)return null;const t=bo(e.stops.sort((e,t)=>e.value-t.value),8);return{opacityValues:t.map(({value:e})=>e),opacities:t.map(({opacity:e})=>e)}}function _o(e){return{rotationType:"geographic"===e.rotationType?0:1}}function Mo(e){if(!e.stops?.length)return null;if(e.stops.some(e=>e.useMaxValue||e.useMinValue))return(t,i)=>{const s=t.statisticsByLevel.get(i.key.level),o=bo(e.stops.map(t=>({value:t.useMaxValue?s?.get(e.field)?.maxValue??0:t.useMinValue?s?.get(e.field)?.minValue??0:t.value,size:t.size?It(t.size):Me})).sort((e,t)=>e.value-t.value),8);return{values:o.map(({value:e})=>e),sizes:o.map(({size:e})=>e)}};const t=bo(e.stops.sort((e,t)=>e.value-t.value),8);return{values:t.map(({value:e})=>e),sizes:t.map(({size:e})=>It(e))}}function To(e){return t=>{const{state:i}=t;return{unitValueToPixelsRatio:Ut(i.spatialReference)/Et[e.valueUnit??"meters"]/i.resolution}}}function Ro(e,t){const i=t.length;if(e<t[0].value||1===i)return t[0].size;for(let s=1;s<i;s++)if(e<t[s].value){const i=(e-t[s-1].value)/(t[s].value-t[s-1].value);return t[s-1].size+i*(t[s].size-t[s-1].size)}return t[i-1].size}function Co(e){const{minDataValue:t,maxDataValue:i,minSize:s,maxSize:o}=e;if("object"==typeof s&&"object"==typeof o)return(e,a)=>{const r=e.state.scale,n=It(Ro(r,s.stops)),l=It(Ro(r,o.stops));return{minMaxValueAndSize:[t,i,n,l]}};if("object"==typeof s||"object"==typeof o)throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[t,i,It(s),It(o)]}}const Do={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function Oo(e,t=128,i=1.25){if(e.visualVariableSizeMinMaxValue)return"function"==typeof e.visualVariableSizeMinMaxValue?128:Math.max(e.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*i,t);if(e.visualVariableSizeScaleStops){if("function"==typeof e.visualVariableSizeScaleStops)return 128;const s=e.visualVariableSizeScaleStops.sizes;return Math.max(s[s.length-1]*i,t)}if(e.visualVariableSizeStops){if("function"==typeof e.visualVariableSizeStops)return 128;const s=e.visualVariableSizeStops.sizes;return Math.max(s[s.length-1]*i,t)}return e.visualVariableSizeUnitValue?256:0}function Io(e){const t={...Do};if(!e||!("visualVariables"in e)||!e.visualVariables)return t;for(const i of So(e.visualVariables))switch(i.type){case"color":t.visualVariableColor=Po(i);break;case"opacity":t.visualVariableOpacity=Ao(i);break;case"rotation":t.visualVariableRotation=_o(i);break;case"size":switch(Fo(i)){case"field-stops":t.visualVariableSizeStops=Mo(i);break;case"scale-stops":"outline"===i.target?t.visualVariableSizeOutlineScaleStops=Mo(i):t.visualVariableSizeScaleStops=Mo(i);break;case"min-max":t.visualVariableSizeMinMaxValue=Co(i);break;case"unit-value":t.visualVariableSizeUnitValue=To(i)}}return t}function Fo(e){return"number"==typeof e.minDataValue&&"number"==typeof e.maxDataValue&&null!=e.minSize&&null!=e.maxSize?"min-max":"$view.scale"===e?.valueExpression&&Array.isArray(e.stops)?"scale-stops":null==e.field&&"$view.scale"===e?.valueExpression||!(Array.isArray(e.stops)||"levels"in e&&e.levels)?null!=e.field||"$view.scale"!==e?.valueExpression?"unit-value":null:"field-stops"}function ko(e){return!!(e.visualVariableSizeMinMaxValue||e.visualVariableSizeScaleStops||e.visualVariableSizeStops||e.visualVariableSizeUnitValue||e.visualVariableSizeOutlineScaleStops)}function Lo(e){return!!e.visualVariableRotation}function Bo(e){return e.spriteRasterizationParam?e.spriteRasterizationParam:{type:"sprite-rasterization-param",resource:{type:"CIMPictureMarker",url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAJOgAACToAYJjBRwAAAAsSURBVEhL7c0xAQAwDASh+jf9lcCU7TDA27ECKqACKqACKqACKqACKqDjYPuLVfSmMPfafQAAAABJRU5ErkJggg==",size:16,invertBackfaceTexture:!1,scaleX:1,textureFilter:"Picture"},overrides:[]}}function Uo(e){return e.minScale||e.maxScale?{minScale:e.minScale??0,maxScale:e.maxScale??0}:null}function Eo(e){if(null==e)return null;if(Array.isArray(e)){const[t,i,s,o]=e;return[t,i,s,255*o]}return"string"==typeof e?e:{...e,defaultValue:Eo(e?.defaultValue)}}async function No(t,i){const{cimResourceManager:s,cimAnalyzer:o,scaleExpression:a}=i.schemaOptions;await Promise.all(e.fetchResources(t.symbol,s,[]));const r=o.analyzeSymbolReference(t,!1),n={scaleInfo:Uo(t),scaleExpression:a},l=[];for(const e of r)switch(e.type){case"marker":l.push(...jo(e,i,n));break;case"fill":l.push(...$o(e,i,n));break;case"outlineFill":l.push(...Go(e,i,n));break;case"gradientFill":l.push(...Xo(e,i,n));break;case"line":l.push(...Jo(e,i,n));break;case"gradientStroke":l.push(...sa(e,i,n));break;case"text":l.push(...aa(e,i,n))}return l}function jo(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o,r=e.isOutline?{...Do,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation};if(e.animationParams){const{hasShiftAnimation:t}=e.animationParams.params,s=t?fo.animatedMarkerShift:fo.animatedMarker;return Ho(a.ensureInstance(s,{uniforms:r,optionalAttributes:{zoomRange:!0,value1Position2Value2:e.animationParams.params.hasShiftAnimation,lineLength:t}}),e,0,i)}return Wo(a.ensureInstance(fo.marker,{uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,s,i)}function Ho(e,t,i,s){return t.animationParams?[e.createMeshInfo({pixelDimensions:t.pixelDimensions,texelDimensions:t.texelDimensions,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,sprite:Bo(t),animations:t.animationParams,scaleInfo:s.scaleInfo,scaleSymbolsProportionally:t.scaleSymbolsProportionally,strokeWidth:t.outlineWidth,isMapAligned:1===t.alignment,colorLocked:t.colorLocked,isStroke:t.isStroke,baseSize:t.baseSize,placement:t.markerPlacement,referenceSize:t.referenceSize,angleToLine:!!t.markerPlacement&&t.markerPlacement.placement&&"angleToLine"in t.markerPlacement.placement&&t.markerPlacement.placement.angleToLine,sizeRatio:t.sizeRatio,patternHeight:null})]:[]}function qo(e,t,i,s){return t.animationParams?[e.createMeshInfo({effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,sprite:Bo(t),animations:t.animationParams,scaleInfo:s.scaleInfo,scaleSymbolsProportionally:!1,strokeWidth:1,isMapAligned:!0,colorLocked:t.colorLocked||!1,isStroke:!1,baseSize:"width"in t?t.width:-1,placement:null,referenceSize:2,angleToLine:!1,sizeRatio:1,patternHeight:"fill"===t.type&&t.spriteRasterizationParam?t.height:null,joinType:"join"in t?t.join:"round",capType:"cap"in t?t.cap:"round",miterLimit:"miterLimit"in t&&t.miterLimit||2})]:[]}function Wo(e,i,s,{scaleInfo:o,scaleExpression:a}){const r=ko(s);return[e.createMeshInfo({size:i.size,scaleX:i.scaleX,anchorX:i.anchorPoint.x,anchorY:i.anchorPoint.y,angle:i.rotation,color:Eo(i.color)??[0,0,0,0],colorLocked:i.colorLocked,frameHeight:i.frameHeight,widthRatio:i.widthRatio,scaleInfo:o,offsetX:i.offsetX,offsetY:i.offsetY,outlineColor:Eo(i.outlineColor)??[0,0,0,0],outlineSize:i.outlineWidth,referenceSize:i.referenceSize||t.CIMVectorMarker.size,rotateClockwise:i.rotateClockwise,scaleFactor:a??1,sizeRatio:i.sizeRatio,alignment:i.alignment,isAbsoluteAnchorPoint:i.isAbsoluteAnchorPoint,scaleSymbolsProportionally:i.scaleSymbolsProportionally,sprite:i.spriteRasterizationParam,hasSizeVV:r,placement:i.markerPlacement,effects:i.effects?{type:"cim-effect-infos",effectInfos:i.effects}:null,transforms:i.transform,minPixelBuffer:Oo(s)})]}function Go(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o;return Zo(a.ensureInstance(fo.outlineFill,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:null,visualVariableSizeScaleStops:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function Zo(e,t,i){const s=Eo(t.color)??[0,0,0,0],o=Eo(t.outlineColor)??[0,0,0,0];return[e.createMeshInfo({color:s,outlineColor:o,width:t.outlineWidth,referenceWidth:t.referenceWidth,capType:t.cap,joinType:t.join,miterLimit:t.miterLimit,outlineUsesColorVV:!t.outlineColorLocked,hasSizeVV:!1,scaleInfo:i.scaleInfo,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,outlineEffects:t.outlineEffects?{type:"cim-effect-infos",effectInfos:t.outlineEffects}:null})]}function Ko(e,t,{scaleInfo:i}){return[e.createMeshInfo({color:Eo(t.color)??[0,0,0,0],scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function $o(e,t,i){if(!e.spriteRasterizationParam)return function(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o,r={visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity};if(e.animationParams){const t=fo.animatedFill;return qo(a.ensureInstance(t,{uniforms:{...r,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),e,0,i)}return Ko(a.ensureInstance(fo.fill,{uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}(e,t,i);const{uniforms:s,schemaOptions:o}=t,{store:a}=o,r={visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity};if(e.animationParams){const t=fo.animatedFill;return qo(a.ensureInstance(t,{uniforms:{...r,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),e,0,i)}return Yo(a.ensureInstance(fo.complexFill,{uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,null!=s.visualVariableColor,i)}function Yo(e,t,i,{scaleInfo:s}){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const o=!!t.hasUnresolvedReplacementColor&&(!i||t.colorLocked),a=t.sampleAlphaOnly&&!o,r=t.spriteRasterizationParam;return[e.createMeshInfo({color:Eo(t.color)??[0,0,0,0],height:t.height,aspectRatio:t.scaleX,offsetX:t.offsetX,offsetY:t.offsetY,scaleX:1,scaleY:1,angle:t.angle,applyRandomOffset:t.applyRandomOffset,sampleAlphaOnly:a,scaleProportionally:"CIMHatchFill"===r.resource.type,sprite:r,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function Xo(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o;return Qo(a.ensureInstance(fo.gradientFill,{uniforms:{visualVariableColor:null,visualVariableOpacity:s.visualVariableOpacity},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function Qo(e,t,{scaleInfo:i}){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const s=t.spriteRasterizationParam;return[e.createMeshInfo({color:Eo(t.color)??[0,0,0,0],angle:t.angle,gradientMethod:t.gradientMethod,gradientSize:t.gradientSize,gradientSizeUnits:t.gradientSizeUnits,gradientType:t.gradientType,sprite:s,scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function Jo(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o,r=e.isOutline?{...Do,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue};if(e.animationParams){const{hasShiftAnimation:t}=e.animationParams.params,s=fo.animatedLine;return qo(a.ensureInstance(s,{uniforms:{...r,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,accumulatedDistance:!0,segmentDirection:!0,normal:!0,lineLength:t}}),e,0,i)}const n={uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}},l=!!(r.visualVariableSizeMinMaxValue||r.visualVariableSizeScaleStops||r.visualVariableSizeStops||r.visualVariableSizeUnitValue);return e.spriteRasterizationParam?ia(a.ensureInstance(fo.texturedLine,n),e,l,i):ta(a.ensureInstance(fo.line,n),e,l,i)}function ea(e,t,{scaleInfo:i}){return{color:Eo(e.color)??[0,0,0,0],width:e.width,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,scaleInfo:i,hasSizeVV:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}}function ta(e,t,i,s){if(t.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");const o=ea(t,i,s);return[e.createMeshInfo(o)]}function ia(e,t,i,s){const{spriteRasterizationParam:o,scaleDash:a,sampleAlphaOnly:r}=t;if(!o)throw new Error("InternalError: Sprite should be defined");return[e.createMeshInfo({...ea(t,i,s),offsetAlongLine:t.offsetAlongLine??0,shouldScaleDash:a??!1,shouldSampleAlphaOnly:r,isSDF:"CIMPictureStroke"!==o.resource.type&&"CIMGradientStroke"!==o.resource.type,sprite:o})]}function sa(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o;return oa(a.ensureInstance(fo.gradientStroke,{uniforms:e.isOutline?{...Do,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:null,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function oa(e,t,i){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const s=t.spriteRasterizationParam;return[e.createMeshInfo({...ea(t,!1,i),gradientMethod:t.gradientMethod,gradientSize:t.gradientSize,gradientSizeUnits:t.gradientSizeUnits,gradientType:t.gradientType,sprite:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function aa(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o;return ra(a.ensureInstance(fo.text,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableRotation:s.visualVariableRotation,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo,referenceSymbol:!1,clipAngle:!1,visibility:!1}}),e,s,i)}function ra(e,t,i,{scaleInfo:s,scaleExpression:o}){return[e.createMeshInfo({boxBackgroundColor:Eo(t.backgroundColor),boxBorderLineColor:Eo(t.borderLineColor),boxBorderLineSize:t.borderLineWidth??0,color:Eo(t.color)??[0,0,0,0],offsetX:t.offsetX,offsetY:t.offsetY,postAngle:t.angle,fontSize:t.size,referenceSize:t.referenceSize,decoration:t.decoration,haloColor:Eo(t.haloColor)??[0,0,0,0],haloSize:t.haloSize??0,outlineColor:Eo(t.outlineColor)??[0,0,0,0],outlineSize:t.outlineSize,lineWidth:t.lineWidth||512,lineHeightRatio:1,horizontalAlignment:t.horizontalAlignment??"center",verticalAlignment:t.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:t.textRasterizationParam,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,placement:t.markerPlacement,transforms:t.transform,scaleFactor:o??1,minPixelBuffer:Oo(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,labelClassId:-1})]}function na(e,t){return{type:"simple",filters:t,capabilities:{maxTextureSize:Ht().maxTextureSize},bindings:pa(e)}}function la(e,t){const i=Ht();return{type:"multi",target:"feature",keyField:Nt,filters:t,capabilities:{maxTextureSize:i.maxTextureSize},bindings:{0:pa(e.trackLines.renderer),1:pa(e.latestObservations.renderer),2:pa(e.previousObservations.renderer)}}}function ua(e){switch(e){case"opacity":return 2;case"color":return 1;case"rotation":return 3;case"size":return 0;default:return null}}function pa(e){if(!e)return[];switch(e.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return ca(e);case"dot-density":return function(e){const t=[];for(const i of e.attributes)t.push({binding:t.length,expression:i.valueExpression,field:i.field});return t}(e);case"pie-chart":return function(e){const t=ca(e);let i=4;for(const s of e.attributes)t.push({binding:i++,expression:s.valueExpression,field:s.field});return t}(e);case"heatmap":return function({valueExpression:e,field:t}){return e||t?[{binding:0,expression:e,field:t}]:[]}(e)}}function ca(e){return"visualVariables"in e&&e.visualVariables?.length?So(e.visualVariables).map(e=>function(e){switch(e.type){case"size":return function(e){return"$view.scale"===e.valueExpression?null:{binding:ua(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression,valueRepresentation:e.valueRepresentation}}(e);case"color":case"opacity":return function(e){return{binding:ua(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression}}(e);case"rotation":return function(e){return{binding:ua(e.type),expression:e.valueExpression,field:e.field}}(e)}}(e)).filter(ye):[]}class da{constructor(){this.type="override-batch",this.messages=[],this._resovler=Wt()}get promise(){return this._resovler.promise}resolve(){this._resovler.resolve()}add(e){this.messages.push(e)}}class ma{constructor(e){this.updateTracking=new we({debugName:"FeatureCommandQueue"}),this.process=e.process,this._queueProcessor=new Gt({concurrency:1,process:async e=>{if("override-batch"===e.type){const e=this._nextOverrideBatch;if(null==e)throw new Error("InternalError: Override should be defined");return this._nextOverrideBatch=null,await this.process(e),void e.resolve()}return this.process(e)}})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return qt(this.updateTracking.addPromise(this._doPush(e)))}async _doPush(e){const t=this._queueProcessor,i=t.last();switch(e.type){case"update":case"highlight":if(i?.type===e.type)return;return t.push(e);case"override":case"edit":return this._pushOverride(e)}}_pushOverride(e){return null==this._nextOverrideBatch&&(this._nextOverrideBatch=new da,this._queueProcessor.push(this._nextOverrideBatch)),this._nextOverrideBatch.add(e),this._nextOverrideBatch.promise}}export{ma as F,$t as M,Xt as S,fo as T,oa as a,Qo as b,Zo as c,ra as d,qo as e,ia as f,Uo as g,ta as h,Ko as i,Yo as j,Ho as k,Wo as l,na as m,Do as n,Io as o,xo as p,Oo as q,No as r,ko as s,Lo as t,la as u,zo as v,ca as w,Zt as x,vo as y,go as z};
