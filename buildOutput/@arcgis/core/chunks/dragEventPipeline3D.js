/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{s as e,b as n,d as r}from"./screenUtils.js";import{c as t}from"./vec2f64.js";import{c as s,h as o,l,e as a,d as c,i as u,j as i}from"./vec3.js";import{c as d}from"./vec3f64.js";import p from"../geometry/Point.js";import{projectPoint as f}from"./projectionUtils.js";import{i as m,c as S,g as E,f as g}from"./plane.js";import{c as j,a as y}from"./ray.js";import{b as x,c as v}from"./vector.js";import{b as w}from"./elevationInfoUtils.js";import{f as I}from"./ray2.js";import{I as b,t as C}from"./Intersector2.js";import{E as H}from"./dragEventPipeline.js";function R(e,n){return h(e,()=>n)}function P(e){return h(e,e=>e.plane)}function h(n,t){const s=d(),o=d();let l=!1;return a=>{const c=t(a);if("start"===a.action){const t=e(a.screenStart,r(x.get())),o=I(n.state.camera,t,B);null!=o&&(l=m(c,o,s))}if(!l)return null;const u=e(a.screenEnd,r(x.get())),i=I(n.state.camera,u,B);return null==i?null:m(c,i,o)?{...a,renderStart:s,renderEnd:o,plane:c,ray:i}:null}}function M(e,r,t,s=null,o=null){return function(e,r,t=0,s=null,o=null){let l=null;return a=>{if("start"===a.action&&(l=e.sceneIntersectionHelper.intersectElevationFromScreen(n(a.screenStart.x,a.screenStart.y),r,t,o),null!=l&&null!=s&&!f(l,l,s)))return null;if(null==l)return null;const c=e.sceneIntersectionHelper.intersectElevationFromScreen(n(a.screenEnd.x,a.screenEnd.y),r,t,o);return null==c||null!=s&&!f(c,c,s)?null:{...a,mapStart:l,mapEnd:c}}}(e,t,w(r,e,t),s,o)}function U(e,n,r,t){const s=r.toMap(e.screenStart);return null!=s?M(n,s,r.elevationInfo,t):null}function F(e,n,r){let t=null;const p=new H;return p.next(R(e,function(e,n){const r=G,t=z,l=S();e.renderCoordsHelper.worldUpAtPosition(n,r);const a=s(E(l),r,o(t,n,e.state.camera.eye));return s(a,a,r),g(n,a,l)}(e,n))).next(function(e,n){const r=d(),t=l(n);e.renderCoordsHelper.worldUpAtPosition(n,r);const s=d(),p=d(),f=s=>(o(s,s,n),v(r,s,s),"global"===e.viewingMode&&l(s)*Math.sign(c(r,s))<.001-t&&o(s,u(s,r,.001),n),i(s,s,n),s);return e=>(e.renderStart=f(a(s,e.renderStart)),e.renderEnd=f(a(p,e.renderEnd)),e)}(e,n)).next(k(e,r)).next(e=>{e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,t=e}),e=>(t=null,p.execute(e),t)}function T(n,t){const s=s=>{const o=e(s,r(q)),l=I(n.state.camera,o,B);if(null==l)return null;const a=y(t,l,G,z);return a?.[0]};return e=>{const n=s(e.screenStart);if(null==n)return null;const r=s(e.screenEnd);return null==r?null:{...e,renderStart:n,renderEnd:r}}}function k(e,n){const r=e.renderCoordsHelper;return e=>{const t=r.fromRenderCoords(e.renderStart,new p({spatialReference:n})),s=r.fromRenderCoords(e.renderEnd,new p({spatialReference:n}));return null!=t&&null!=s?{...e,mapStart:t,mapEnd:s}:null}}function A(e){let n=null;return r=>{switch(r.action){case"start":n=e.disableDisplay();break;case"end":case"cancel":null!=n&&(n.remove(),n=null)}return r}}function D(r,t=null){const s=new b(r.state.viewingMode);s.options.selectionMode=!0,s.options.store=0,s.options.hud=!1;const o=n(),l={requiresGroundFeedback:!0,enableDraped:!0,exclude:new Set},a=d(),c=t??r.spatialReference,u=n=>{r.map.ground&&r.map.ground.opacity<1?l.exclude.add(C):l.exclude.delete(C),r.sceneIntersectionHelper.intersectIntersectorScreen(e(n,o),s,l);const t=s.results.min;let u;if(t.getIntersectionPoint(a))u=2===t.intersector?0:1;else{if(!s.results.ground.getIntersectionPoint(a))return null;u=0}return{location:r.renderCoordsHelper.fromRenderCoords(a,new p({spatialReference:c})),surfaceType:u}};let i;return e=>{if("start"===e.action){const n=u(e.screenStart);i=null!=n?n.location:null}if(null==i)return null;const n=u(e.screenEnd);return null!=n?.location?{...e,mapStart:i,mapEnd:n.location,surfaceType:n.surfaceType}:null}}const q=t(),G=d(),z=d(),B=j();export{M as a,F as b,D as c,T as d,U as e,P as f,k as g,A as h,R as s};
