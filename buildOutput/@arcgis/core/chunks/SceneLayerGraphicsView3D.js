/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"../core/lang.js";import{L as t}from"./Logger.js";import{d as r}from"./maybe.js";import{e as s}from"./memoryEstimations.js";import{throwIfAborted as i}from"../core/promiseUtils.js";import{initial as o,watch as a}from"../core/reactiveUtils.js";import{g as p}from"./watch.js";import{property as n}from"../core/accessorSupport/decorators/property.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import{k as m}from"./vec3.js";import{c as d,Z as u}from"./vec3f64.js";import{p as c}from"./projectBuffer.js";import{p as h}from"./projectVectorToVector.js";import{c as j,d as g}from"../geometry/Extent.js";import{n as y,a as f}from"./DoubleArray.js";import{g as b}from"./zscale.js";import _ from"../graphic/SceneGraphicOrigin.js";import{f as v}from"./LayerConstants.js";import{e as w}from"./dehydratedFeatures.js";import{I}from"./dehydratedPoint.js";import{a as S}from"./hydratedFeatures.js";import{I as x,a as C}from"./I3SOverrides.js";import U from"../layers/support/FeatureFilter.js";import E from"../rest/support/Query.js";import{j as D}from"./basemapUtils.js";import{d as O}from"./guards.js";import{W as V}from"./WorkerHandle.js";import{L as F}from"./LayerView3D.js";import{G as N,Q as M,a as P}from"./Graphics3DFeatureProcessor.js";import{S as A,a as L,c as G,n as R,b as T,d as B}from"./SceneLayerView.js";import{g as H}from"./I3SBinaryReader.js";import{Evented as k}from"../core/Evented.js";import{f as q,s as Q}from"./MapUtils.js";import{c as z,b as W,d as Z,w as K}from"./I3SUtil.js";import{a as J}from"./attributeUtils.js";import{T as Y,D as $}from"./TemporalSceneLayerView.js";import{n as X,e as ee,i as te}from"./highlightUtils2.js";import{L as re}from"./LayerViewPerformanceInfo.js";import{P as se}from"./PopupSceneLayerView.js";import{d as ie}from"./debugFlags2.js";import{c as oe,V as ae}from"./orientedBoundingBox.js";import{u as pe}from"../views/SceneView.js";import{h as ne}from"./popupUtils.js";import{g as le}from"./highlightOptionsUtils2.js";import{a as me,c as de}from"./layerViewUtils.js";import{T as ue}from"./Scheduler.js";import"../config.js";import"./object.js";import"./string.js";import"./handleUtils.js";import"../core/Error.js";import"./events.js";import"./ObjectPool.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./SetUtils.js";import"./get.js";import"./utils.js";import"./Lifecycle.js";import"./tracking.js";import"./SimpleTrackingTarget.js";import"./ensureType.js";import"./metadata.js";import"./Warning.js";import"./common.js";import"./mathUtils.js";import"./unitUtils.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./persistableUrlUtils.js";import"./geodesicConstants.js";import"../geometry/Multipoint.js";import"./writer.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ObservableBase.js";import"./reader.js";import"../geometry/SpatialReference.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./projectPointToVector.js";import"./projectionUtils.js";import"./SimpleObservable.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../graphic/GraphicOrigin.js";import"./isSceneGraphicOrigin.js";import"./aaBoundingBox.js";import"./quantizationUtils.js";import"./typeUtils.js";import"../layers/support/Field.js";import"./enumeration.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Collection.js";import"./shared.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./datetime.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./locale.js";import"./constants.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"./colorUtils.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../geometry/support/jsonUtils.js";import"./createFeatureId.js";import"./typeUtils2.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils3.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils4.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"./lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./projectBoundingRect.js";import"./ViewingMode.js";import"./MemCache.js";import"./uuid.js";import"./mat3.js";import"./mat3f64.js";import"./projectBoundingSphere.js";import"./meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../geometry/support/MeshLocalVertexSpace.js";import"./sphere.js";import"./mat4.js";import"./vec4.js";import"./vec4f64.js";import"./ray.js";import"./vector.js";import"./mat4f64.js";import"./quatf64.js";import"./vec2f64.js";import"./resourceUtils3.js";import"./DefaultMaterial.js";import"./Emissions.glsl.js";import"./glsl.js";import"./BooleanBindUniform.js";import"./Matrix4PassUniform.js";import"./Indices.js";import"./BufferView.js";import"./vec2.js";import"./triangle.js";import"./lineSegment.js";import"./Texture.js";import"./enums.js";import"./boundedPlane.js";import"./plane.js";import"./mathUtils2.js";import"./lengthUtils.js";import"./videoUtils.js";import"./requestImageUtils.js";import"./AlphaCutoff.js";import"./renderState.js";import"./VertexColor.glsl.js";import"./Intersector2.js";import"../views/3d/webgl/RenderCamera.js";import"./frustum.js";import"./HUDIntersectorResult.js";import"./InterleavedLayout.js";import"./types.js";import"./VertexElementDescriptor.js";import"./VertexAttributeLocations.js";import"./VertexBuffer.js";import"./BufferObject.js";import"./SceneLighting.js";import"./CameraSpace.glsl.js";import"../views/3d/webgl.js";import"../Camera.js";import"../CameraLayout.js";import"./Cyclical.js";import"./computeTranslationToOriginAndRotation.js";import"./earthUtils.js";import"../views/3d/webgl/RenderNode.js";import"./quat.js";import"./spatialReferenceEllipsoidUtils.js";import"./ShaderBuilder.js";import"./Matrix4sPassUniform.js";import"./asyncUtils.js";import"./colorUtils2.js";import"./EllipsoidMode.js";import"./ElevationContext.js";import"./dehydratedFeatureUtils.js";import"./ElevationProvider.js";import"./unitConversionUtils.js";import"./TextureCompressionTracker.js";import"./graphicUtils.js";import"./vec3f32.js";import"./symbolColorUtils.js";import"./RibbonLineMaterial.js";import"./Octree.js";import"./sdfPrimitives.js";import"./floatRGBA.js";import"./vec2f32.js";import"./HUDVisibility.glsl.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"./primitiveObjectSymbolUtils.js";import"./Intersector.js";import"./signal.js";import"./ReactiveSet.js";import"./number.js";import"./featureQueryAll.js";import"../time/TimeExtent.js";import"./timeUtils.js";import"./DataLayerSource.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"./utils5.js";import"./basemapDefinitions.js";import"./messages.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"./substitute.js";import"./heightModelInfoUtils.js";import"../geometry/HeightModelInfo.js";import"./hash.js";import"./diffUtils.js";import"./UpdatingHandles.js";import"./renderingInfoUtils.js";import"./visualVariableUtils.js";import"./ExtentSet.js";import"../layers/Layer.js";import"../renderers/UniqueValueRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"./commonProperties2.js";import"../symbols/support/jsonUtils.js";import"./layerUtils.js";import"../layers/catalog/catalogUtils.js";import"./defaults.js";import"./defaultsJSON.js";import"./RendererLegendOptions.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils.js";import"./rendererConversion.js";import"./optimizedFeatureQueryEngineAdapter.js";import"./PooledRBush.js";import"./quickselect.js";import"./GridLocalOriginFactory.js";import"./InputManager.js";import"./Graphics3DObjectStates.js";import"./floorFilterUtils.js";import"./QueryEngine.js";import"./WhereClauseCache.js";import"./LRUCache.js";import"../core/sql/WhereClause.js";import"./TimeOnly.js";import"./enum.js";import"./UnknownTimeZone.js";import"./timeSupport.js";import"./projectionSupport.js";import"./json.js";import"./QueryEngineCapabilities.js";import"./utils14.js";import"./heatmapUtils.js";import"./utils7.js";import"./timeZoneUtils.js";import"./utils13.js";import"./generateRendererUtils.js";import"./queryUtils.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./simplify.js";import"./utils9.js";import"./utils10.js";import"./SnappingCandidate.js";import"../rest/support/AutoIntervalBinParameters.js";import"../rest/support/BinParametersBase.js";import"../rest/support/AttributeBinsGrouping.js";import"../rest/support/NormalizationBinParametersMixin.js";import"../rest/support/DateBinParameters.js";import"../rest/support/DateBinTimeInterval.js";import"../rest/support/FixedBoundariesBinParameters.js";import"../rest/support/FixedIntervalBinParameters.js";import"../layers/support/FieldsIndex.js";import"../rest/support/FeatureSet.js";import"./featureServiceUtils.js";import"../views/layers/LayerView.js";import"./featurePopupQueryUtils.js";import"./timeSupport2.js";import"../support/timeUtils.js";import"./utils11.js";import"./Version2.js";import"./Version.js";import"./tagSymbols.js";import"../Viewpoint.js";import"./domUtils.js";import"./GraphicsCollection.js";import"./coordinateSystem.js";import"./scaleUtils.js";import"./TilemapCache.js";import"./TileKey.js";import"../views/View.js";import"../Map.js";import"../Basemap.js";import"./loadAll.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../support/BasemapStyle.js";import"./writeUtils.js";import"../Ground.js";import"./groundInstanceUtils.js";import"./CollectionFlattener.js";import"../effects/FocusAreas.js";import"../effects/FocusArea.js";import"./persistable.js";import"./MD5.js";import"./multiOriginJSONSupportUtils.js";import"./resourceExtension.js";import"../effects/FocusAreaOutline.js";import"./PolygonCollection.js";import"./editableLayers.js";import"./basemapEnsureType.js";import"./collectionUtils2.js";import"../support/LayersMixin.js";import"../support/TablesMixin.js";import"../views/BasemapView.js";import"../views/Magnifier.js";import"./SelectionManager.js";import"./ReactiveMap.js";import"./selectionUtils.js";import"../views/Theme.js";import"./ViewEvents.js";import"./keybindings.js";import"./screenUtils2.js";import"./HighlightDefaults.js";import"../views/support/HighlightOptions.js";import"../views/input/Input.js";import"../views/input/gamepad/GamepadSettings.js";import"../views/input/gamepad/GamepadInputDevice.js";import"../views/navigation/Navigation.js";import"./a11yUtils.js";import"../views/navigation/NavigationActionMap.js";import"../views/navigation/gamepad/GamepadSettings.js";import"./projectionUtils2.js";import"../views/BreakpointsOwner.js";import"../views/DOMContainer.js";import"./projector.js";import"./sanitizerUtils.js";import"../views/GroundView.js";import"./cameraUtils.js";import"./projectVectorToPoint.js";import"./spatialReferenceSupport.js";import"../layers/support/ElevationSampler.js";import"./TerrainConst.js";import"../layers/support/LOD.js";import"../layers/support/TileInfo.js";import"../views/PopupView.js";import"../views/ViewAnimation.js";import"./FramebufferObject.js";import"./VertexArrayObject2.js";import"./VertexArrayObject.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"./RenderGeometry.js";import"./NestedMap.js";import"./axisAngleDegrees.js";import"./sunUtils.js";import"./SunCalc.js";import"../views/3d/environment/SunLighting.js";import"../webscene/SunLighting.js";import"../views/3d/environment/VirtualLighting.js";import"../webscene/VirtualLighting.js";import"../webscene/Environment.js";import"./lightingTypes.js";import"../webscene/background/Background.js";import"../webscene/background/ColorBackground.js";import"./easing.js";import"./unitBezier.js";import"./Animation.js";import"./ray2.js";import"./viewpointUtils2.js";import"../views/ui/UI.js";import"./modeUtils.js";import"./widgetUtils.js";import"./unitFormatUtils.js";import"./quantityUtils.js";import"../widgets/Widget.js";import"./componentsUtils.js";import"./jsxWidgetSupport.js";import"./messageBundle.js";import"./jsxFactory.js";import"./ZoomMomentumEstimator.js";import"./HUDMaterial.js";import"./labelFormatUtils.js";import"./labelUtils.js";import"./ArcadeExpression.js";import"./NormalUtils.glsl.js";import"./fontUtils.js";import"./placementUtils.js";import"./elevationInfoUtils.js";import"./hitTest.js";import"./intersectorUtilsConversions.js";import"./hitTestSelectUtils.js";import"./RenderCoordsHelper.js";import"./terrainUtils.js";import"../views/3d/support/SceneViewPerformanceInfo.js";import"../views/3d/support/LayerPerformanceInfo.js";import"./DefaultLoadingContext.js";import"./wosrLoader.js";import"./mapCollectionUtils.js";import"./ElevationQueryTileCache.js";import"./ElevationSamplerData.js";import"./Normals.js";import"./TileStrategy.js";import"./TileKey2.js";import"./ScheduledQueueProcessor.js";import"./constants3.js";import"./mat3f32.js";import"./SymbolRepository.js";import"./config.js";import"./TiledDisplayObject.js";import"./DisplayObject.js";import"./definitions.js";import"./GeometryUtils.js";import"./RenderableTile.js";import"./resources.js";import"./vec32.js";import"./vec33.js";import"./BlendColorsPremultiplied.glsl.js";import"./vec4f32.js";import"../views/3d/webgl/ManagedFBO.js";import"./testSVGPremultipliedAlpha.js";import"./RenderingContext.js";import"./ProgramCache.js";import"./Program.js";import"./capabilities2.js";import"./RenderingContextOptions.js";import"./ITexture.js";import"./screenshotUtils.js";import"./imageUtils.js";import"./edgePreprocessing.js";import"./drapedUtils.js";import"./makeScheduleFunction.js";import"./WebGLRequirements.js";import"../views/ui/DefaultUI.js";import"../widgets/Attribution.js";import"../widgets/Attribution/AttributionViewModel.js";import"./globalCss.js";import"./accessibleHandler.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"./utils24.js";import"../widgets/support/GoTo.js";import"./goToUtils.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";import"./debugFlags.js";class ce extends V{constructor(e){super("SceneLayerWorker","dracoDecompressPointCloudData",{dracoDecompressPointCloudData:e=>[e.geometryBuffer]},e,{hasInitialize:!0})}}class he extends k{constructor(e,t){super(),this._updateAndCompare=e,this._notifyUpdated=t,this._nodes=new Map,this._graphics=new Map,this._duplicates=new Map}clear(){if(this._graphics.size>0){const e=this.toArray();this._graphics.clear(),this.emit("change",{added:[],removed:e})}this._nodes.clear()}get length(){return this._graphics.size}get(e){return this._graphics.get(e)}getNode(e){return this._nodes.get(e)}hasNode(e){return this._nodes.has(e)}nodes(){return this._nodes.values()}addNode(e,t){this._nodes.set(e,t);const r=t.graphics;if(0===r.length)return;const s=new Set;for(let t=0;t<r.length;t++){const i=r[t],o=i.objectId,a=this._graphics.get(o);if(a){s.add(o),i!==a&&(r[t]=a);const p=this._duplicates.get(o);p?p.push(e):this._duplicates.set(o,[a.nodeIndex,e])}else i.nodeIndex=e,this._graphics.set(o,i)}s.size&&this._updateForeignGraphics(t);const i=s.size>0?r.filter(e=>!s.has(e.objectId)):r;i.length>0&&this.emit("change",{added:i,removed:[]})}removeNode(e){const t=this._nodes.get(e);if(!t)return;this._nodes.delete(e);const r=new Set,s=[];for(const i of t.graphics){const t=i.objectId,o=this._graphics.get(t);if(!o)continue;const a=this._duplicates.get(t);if(a){const s=a.indexOf(e);if(-1===s)continue;if(a.splice(s,1),o.nodeIndex===e){let e=this.getNode(a[0]);for(let t=1;t<a.length;t++){const r=this.getNode(a[t]);(null==e||null!=r&&r.node.level>e.node.level)&&(e=r)}null!=e&&r.add(e)}1===a.length&&this._duplicates.delete(t)}else this._graphics.delete(t),s.push(i)}s.length>0&&this.emit("change",{added:[],removed:s}),r.forEach(e=>this._updateForeignGraphics(e))}_updateForeignGraphics(e){const t=[],r=e.node.index,s=e.node.level;let i=0;for(;i<e.graphics.length;){const o=e.graphics[i].nodeIndex;if(o===r){i++;continue}let a=1;for(;i+a<e.graphics.length&&e.graphics[i+a].nodeIndex===o;)a++;const p=this.getNode(o);if(null!=p&&p.node.level>s)i+=a;else{for(let s=i;s<i+a;s++){const i=e.graphics[s];i.nodeIndex=r,this._updateAndCompare(i,e,s)&&t.push(i)}i+=a}}t.length>0&&this._notifyUpdated(t)}toArray(){return Array.from(this._graphics.values())}find(e){return q(this._graphics,e)}some(e){return Q(this._graphics,e)}forEach(e){this._graphics.forEach(t=>e(t))}forEachNode(e){this._nodes.forEach((t,r)=>e(t,r))}get nodeCount(){return this._nodes.size}_checkInvariants(){const e=new Map;this._nodes.forEach((t,r)=>{t.graphics.forEach(t=>{e.set(t.objectId,1+(e.get(t.objectId)??0)),this._duplicates.get(t.objectId)})}),e.forEach((e,t)=>{const r=this._graphics.get(t);if(!r)return;if(!this._nodes.get(r.nodeIndex))return;const s=this._duplicates.get(t);s&&s.forEach(e=>{this._nodes.get(e)})})}}const je=B();class ge{constructor(e,t,r,s){this.graphics=e,this.featureIds=t,this.attributeInfo=r,this.node=s}get cachedMemory(){return this.graphics.reduce((e,t)=>w(t)+e,s(this.featureIds)+1024)}}let ye=class extends(Y($(se(F(A))))){constructor(){super(...arguments),this.type="scene-layer-graphics-3d",this._queryEngine=null,this._memCache=null,this._interactiveEditingSessions=new Map,this._pendingEditsQueue=Promise.resolve(),this.loadedGraphics=new he((e,t,r)=>function(e,t,r){const s=t.attributeInfo;if(null==s?.loadedAttributes||null==s.attributeData)return!1;let i=!1;for(const{name:t}of s.loadedAttributes)if(s.attributeData[t]){const o=H(s.attributeData[t],r);o!==e.attributes[t]&&(e.attributes[t]=o,i=!0)}return i}(e,t,r),e=>this.processor.graphicsCore.recreateGraphics(e)),this.holeFilling="always",this.progressiveLoadFactor=1,this.supportsHeightUnitConversion=!0,this._coordinatesOutsideExtentErrors=0,this._maxCoordinatesOutsideExtentErrors=20}tryRecycleWith(e,t){return e.url===this.layer.url&&this._i3sOverrides.isEmpty?e.load(t).then(()=>{i(t),z(this.layer,e,this._i3sOverrides),this.layer=e,this._i3sOverrides.destroy();const s=this.view.resourceController?.memoryController;this._i3sOverrides=new x({view:this.view,layer:e,memoryController:s}),r(this._queryEngine),this._setupQueryEngine(),this.processor.resetObjectStates()}):null}initialize(){this.addResolvingPromise(this.layer.indexInfo);const e=this.view.resourceController?.memoryController;this._i3sOverrides=new x({view:this.view,layer:this.layer,memoryController:e}),W(this.layer,this.view.spatialReference,this.view.viewingMode),this._fieldsHelper=new L({layerView:this}),this._updatingHandles.add(()=>this.layer.rangeInfos,e=>this._rangeInfosChanged(e),o),this._updatingHandles.add(()=>this.layer.renderer,(e,t)=>this._rendererChange(e,t)),this._updatingHandles.add(()=>[this.parsedDefinitionExpression,this.layer.excludeObjectIds],()=>this._filterChange()),this._set("processor",new N({owner:this,preferredUpdatePolicy:0,scaleVisibilityEnabled:!me(),filterVisibilityEnabled:!0,timeExtentEnabled:!1,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,setUidToIdOnAdd:!1,dataExtent:this.layer.fullExtent,updateClippingExtent:e=>this._updateClippingExtent(e)})),this.processor.elevationAlignment?.events.on("invalidate-elevation",({extent:e,spatialReference:t})=>this._controller.updateElevationChanged(e,t)),this.supportsHeightUnitConversion&&(this._verticalScale=b("point",this.layer.spatialReference,this.view.spatialReference)),this.addResolvingPromise(this.processor.when()),this._memCache=this.view.resourceController.memoryController.newCache(`psl-${this.uid}`),this._controller=new C({layerView:this}),Z(this.layer.geometryDefinitions)&&(this._workerHandle=new ce(e=>this.view.resourceController.immediate.schedule(e))),this.addHandles(this.layer.on("apply-edits",e=>this._updatingHandles.addPromise(e.result))),this.addHandles([this.layer.on("edits",e=>{const t=this._pendingEditsQueue.then(()=>this._handleEdits(e)).then();this._pendingEditsQueue=t,this._updatingHandles.addPromise(t)}),a(()=>ie.I3S_TREE_SHOW_TILES,e=>{if(e&&!this._treeDebugger){const e=this._controller.crsIndex;import("./I3STreeDebugger.js").then(({I3STreeDebugger:t})=>{!this._treeDebugger&&ie.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new t({lv:this,view:this.view,nodeSR:e}))})}else e||!this._treeDebugger||ie.I3S_TREE_SHOW_TILES||(this._treeDebugger.destroy(),this._treeDebugger=null)},o)]),this.when(()=>{this._setupQueryEngine(),this._updatingHandles.add(()=>this.maximumNumberOfFeatures,e=>this._controller.featureTarget=e,o),this._updatingHandles.add(()=>this.suspended,e=>{e&&this._removeAllNodeData()})})}destroy(){this._treeDebugger=r(this._treeDebugger),this._i3sOverrides=r(this._i3sOverrides),this._set("processor",r(this.processor)),this._controller=r(this._controller),this._queryEngine=r(this._queryEngine),this._workerHandle=r(this._workerHandle),this._memCache=r(this._memCache),this.loadedGraphics.clear(),this._fieldsHelper=r(this._fieldsHelper)}get i3slayer(){return this.layer}get layerViewUid(){return this.uid}get updatingProgressValue(){return this._controller?.updatingProgress??1}get visibleAtCurrentScale(){return me()?de(this.layer.effectiveScaleRange,this.view.scale):!this.processor?.scaleVisibilitySuspended}get requiredFields(){return this._fieldsHelper?.requiredFields??[]}get maximumNumberOfFeatures(){const e=this.processor?.graphicsCore?.displayFeatureLimit;return e?.maximumNumberOfFeatures??0}set maximumNumberOfFeatures(e){null!=e?(this._override("maximumNumberOfFeatures",e),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)}get maximumNumberOfFeaturesExceeded(){return!this.suspended&&!!this._controller?.useMaximumNumberOfFeatures&&!this._controller.leavesReached}get _excludeObjectIds(){return new Set(this.layer.excludeObjectIds)}get lodFactor(){return"Labels"===this.layer.semantic?1:this.view.qualitySettings.sceneService.point.lodFactor}get hasM(){return!1}get hasZ(){return!0}get contentVisible(){return!this.suspended&&!!this._controller?.rootNodeVisible}get legendEnabled(){return this.contentVisible&&!0===this.i3slayer?.legendEnabled}get _graphicOrigin(){return new _(this.layer)}async whenGraphicAttributes(e,t){return K(this.layer,e,this._getObjectIdField(),t,()=>[...this.loadedGraphics.nodes()])}getHit(e){if(!this.loadedGraphics)return null;const t=S(this.loadedGraphics.find(t=>t.uid===e),this.layer),r=this._getObjectIdField();return t?.attributes?.[r]?(t.layer=this.layer,t.sourceLayer=this.layer,t.origin=this._graphicOrigin,{type:"graphic",graphic:t,layer:t.layer}):null}whenGraphicBounds(e,t){return this.processor.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.processor.computeAttachmentOrigin(e,t)}isUpdating(){return!!(this._controller?.updating||this.processor?.updating||this._fieldsHelper?.updating||this.layerFilterUpdating)}highlight(e,t){const r=le(t),s=this.layer.objectIdField,i=X(e);if(0===i.length)return ee;if(O(i[0])){const e=i;if(null!=J(this.layer.fieldsIndex,e[0].attributes,s)){const t=e.map(e=>J(this.layer.fieldsIndex,e.attributes,s));return this.processor.highlightByObjectIds(t,s,r)}return this.processor.highlightByGraphics(e,r)}return te(i[0])?this.processor.highlightByObjectIds(i,s,r):ee}get updatePolicy(){return this.processor.graphicsCore.effectiveUpdatePolicy}createInteractiveEditSession(e){return G(this._attributeEditingContext,e)}async _decompressBinaryPointData(e,t){const r={geometryBuffer:e.geometryBuffer};null==this._workerHandle&&(this._workerHandle=new ce(e=>this.view.resourceController.immediate.schedule(e)));const s=await this._workerHandle.invoke(r,t);if(null==s)throw new Error("Failed to decompress Draco point data");return{positionData:s.positions,featureIds:s.featureIds}}async addNode(e,r,s){if(!be(r)&&!function(e){return"pointData"in e}(r))throw new Error;if(this.loadedGraphics.hasNode(e.index))return void t.getLogger(this).error("I3S node "+e.id+" already added");const i=null!=this.layer.fullExtent?(l=.5,(n=this.layer.fullExtent.clone()).xmin-=l,n.ymin-=l,n.xmax+=l,n.ymax+=l,null!=n.zmin&&null!=n.zmax&&(n.zmin-=l,n.zmax+=l),null!=n.mmin&&null!=n.mmax&&(n.mmin-=l,n.mmax+=l),n):null,{featureIds:o,pointPositions:a}=be(r)?await this._extractBinaryPointPositions(e,r,s):this._extractLegacyPointPositions(r),p=new Array;var n,l;this._validatePositions(e,o,a,i,p);const m=this._controller.crsVertex,d=this.view.spatialReference;c(a,m,0,a,d,0,o.length);const u=be(r)?e.level:0,h=this._createGraphics(o,a,e.index,u),j=new ge(h,o,r.attributeDataInfo,e);if(await this._i3sOverrides.applyAttributeOverrides(j.featureIds,r.attributeDataInfo,s),e.numFeatures=j.graphics.length,this._updateNodeMemory(e),_e(j),p.length>0&&(this._computeObb(e,p,m),this._controller.updateVisibility(e.index)),!this._controller.isGeometryVisible(e))return void this._cacheNodeData(j);if(null!=this._verticalScale)for(const e of j.graphics)this._verticalScale(e.geometry);const g=this.view.stage.renderView.olidRenderHelper;if(g){const e=D(this.view,this.uid);for(let t=0;t<j.featureIds.length;t++){const r=j.featureIds[t];g.setUidToObjectAndLayerId(r,j.graphics[t].uid,this.layer.id,this.uid,this.layer.popupEnabled&&!e&&ne(this.layer,this.view.popup?.defaultPopupTemplateEnabled),j.node.resources.attributes,t)}}this.loadedGraphics.addNode(e.index,j),this._controller.updateLoadStatus(e.index,!0),this._filterNode(j),this._treeDebugger&&this._treeDebugger.update()}_computeObb(e,t,r){const s=this._controller.crsIndex,i=s.isGeographic?this.view.renderSpatialReference:s;c(t,r,0,t,i,0),e.serviceObbInIndexSR=oe(new ae(t,3)),s.isGeographic&&(h(e.serviceObbInIndexSR.center,i,we,s),e.serviceObbInIndexSR.center=we)}isNodeLoaded(e){return this.loadedGraphics.hasNode(e)}isNodeReloading(){return!1}updateNodeState(){}getNodeComponentHandle(){}async _extractBinaryPointPositions(e,t,r){const s=await this._decompressBinaryPointData(t,r),i=s.positionData,o=i.length/3,a=y(3*o),p=null!=e.serviceObbInIndexSR?e.serviceObbInIndexSR.center:u,n=Math.abs(p[2])*2**-20;for(let e=0;e<o;e++){const t=3*e;a[t]=i[t]+p[0],a[t+1]=i[t+1]+p[1],a[t+2]=i[t+2]+p[2],Math.abs(a[t+2])<n&&(a[t+2]=0)}return{featureIds:s.featureIds?f(s.featureIds):[],pointPositions:a}}_extractLegacyPointPositions(e){const t=e.pointData.length,r=y(3*t),s=new Array;for(let i=0;i<t;i++){const t=e.pointData[i],o=t.featureDataPosition,a=o.length,p=t.geometries?.[0]??ve[a],n=t.featureIds[0];if("Embedded"!==p.type||"points"!==p.params.type||a<2||a>3)continue;const l=p.params.vertexAttributes?.position??[0,0,0],m=3*s.length;r[m]=o[0]+l[0],r[m+1]=o[1]+l[1],r[m+2]=3===a?o[2]+l[2]:NaN,s.push(n)}return{featureIds:s,pointPositions:r}}_validatePositions(e,r,s,i,o){if(null==i&&e.serviceObbInIndexSR)return;const a=r.length;for(let r=0;r<a;r++){const a=3*r;m(we,s[a],s[a+1],s[a+2]);const p=!Number.isNaN(s[2]);null==i||(p?j(i,we):g(i,we))||(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&t.getLogger(this).error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&t.getLogger(this).error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++),e.serviceObbInIndexSR||o.push(we[0],we[1],we[2])}}_createGraphics(e,t,r,s){const i=e.length,o=this._getObjectIdField(),a=this.processor.graphicsCore,n=new Array,l=this.view.spatialReference;for(let m=0;m<i;m++){const i=e[m],d={};null!=i&&(d[o]=i);const u=i??p(),c=3*m,h=isNaN(t[c+2])?void 0:t[c+2],j=new I(l,t[c],t[c+1],h),g=this.loadedGraphics.get(u);if(null!=g)(null==g.level||g.level<s)&&(Ie.property="geometry",Ie.graphic=g,Ie.oldValue=g.geometry,Ie.newValue=j,g.geometry=j,g.level=s,a.graphicUpdateHandler(Ie),Se()),n.push(g);else{const e=p();n.push({objectId:u,uid:e,geometry:j,attributes:d,visible:!0,nodeIndex:r,level:s})}}return n}_updateNodeMemory(e){e.memory=4096+(e.numFeatures??0)*this.processor.graphicsCore.usedMemoryPerGraphic}_cacheNodeData(e){this._memCache.put(this._getMemCacheKey(e.node),e)}_getMemCacheKey(e){return`${e.index}`}_removeAllNodeData(){this.loadedGraphics.forEachNode((e,t)=>{if(e){const t=e.node;this._updateNodeMemory(t),this._cacheNodeData(e)}this._controller.updateLoadStatus(t,!1)}),this._treeDebugger&&this._treeDebugger.update(),this.loadedGraphics.clear()}removeNode(e){const t=this._removeNodeStageData(e);t&&(this._updateNodeMemory(t.node),this._cacheNodeData(t))}_removeNodeStageData(e){const t=this.loadedGraphics.getNode(e);return null==t?null:(this._controller.updateLoadStatus(e,!1),this.loadedGraphics.removeNode(e),this._treeDebugger&&this._treeDebugger.update(),t)}async loadCachedNodeData(e){return this._memCache?.pop(this._getMemCacheKey(e))}async addCachedNodeData(e,r,s,i){this.loadedGraphics.hasNode(e.index)?t.getLogger(this).error("I3S node "+e.id+" already added"):(await this._i3sOverrides.applyAttributeOverrides(r.featureIds,s,i),r.attributeInfo=s,this.loadedGraphics.addNode(e.index,r),this._controller.updateLoadStatus(e.index,!0),this._updateNodeMemory(e),_e(r),this._filterNode(r),this._treeDebugger&&this._treeDebugger.update())}getLoadedNodeIds(){const e=[];return this.loadedGraphics.forEachNode(t=>e.push(t.node.id)),e.sort()}getVisibleNodes(){const e=new Array;return this.loadedGraphics.forEachNode(t=>e.push(t.node)),e}getLoadedNodeIndices(e){this.loadedGraphics.forEachNode((t,r)=>e.push(r))}getLoadedAttributes(e){const t=this.loadedGraphics.getNode(e);if(null!=t?.attributeInfo)return t.attributeInfo.loadedAttributes}getAttributeData(e){const t=this.loadedGraphics.getNode(e);if(null!=t?.attributeInfo)return t.attributeInfo.attributeData}_setAttributeData(e,t){const r=this.loadedGraphics.getNode(e);null!=r?.attributeInfo&&(r.attributeInfo.attributeData=t,this._attributeValuesChanged(r))}async updateAttributes(e,t,r){const s=this.loadedGraphics.getNode(e);null!=s&&(await this._i3sOverrides.applyAttributeOverrides(s.featureIds,t,r),s.attributeInfo=t,this._attributeValuesChanged(s))}_attributeValuesChanged(e){_e(e),this._filterNode(e);const{processor:t}=this,{graphicsCore:r}=t;if(r.labelsEnabled){const t=e.node.index,s=new Array;e.graphics.forEach(e=>e.nodeIndex===t&&s.push(e.uid)),r.updateLabelingInfo(s)}t.refreshFilter()}_updateClippingExtent(e){return this._controller&&this._controller.updateClippingArea(e),!1}_getObjectIdField(){return this.layer.objectIdField||v}_getGlobalIdField(){return this.layer.globalIdField}async _rendererChange(e,t){const{layer:{fieldsIndex:r}}=this,s=new Set;let i,o;e?(await e.collectRequiredFields(s,r),i=Array.from(s).sort()):i=[],s.clear(),t?(await t.collectRequiredFields(s,r),o=Array.from(s).sort()):o=[],i.length===o.length&&i.every((e,t)=>i[t]===o[t])||this._reloadAllNodes()}_rangeInfosChanged(e){null!=e&&e.length>0&&t.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}_filterChange(){this.loadedGraphics.forEachNode(e=>this._filterNode(e))}_reloadAllNodes(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()}_filterNode(e){const t=this.parsedDefinitionExpression,r=this._excludeObjectIds,s=this._getObjectIdField();for(const i of e.graphics){const e=i.visible,o=this._evaluateClause(t,i),a=!r.has(i.attributes[s]);i.visible=o&&a,e!==i.visible&&(Ie.graphic=i,Ie.property="visible",Ie.oldValue=e,Ie.newValue=i.visible,this.processor.graphicsCore.graphicUpdateHandler(Ie),Se())}}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return this.filter?.createQuery(e)??new E(e)}queryFeatures(e,t){return this._queryEngine.executeQuery(this._ensureQuery(e),t?.signal)}queryObjectIds(e,t){return this._queryEngine.executeQueryForIds(this._ensureQuery(e),t?.signal)}queryFeatureCount(e,t){return this._queryEngine.executeQueryForCount(this._ensureQuery(e),t?.signal)}queryExtent(e,t){return this._queryEngine.executeQueryForExtent(this._ensureQuery(e),t?.signal)}_ensureQuery(e){return this._addDefinitionExpressionToQuery(null==e?this.createQuery():E.from(e))}_setupQueryEngine(){const{layer:e,view:t,hasM:r,hasZ:s}=this,{spatialReference:i,resourceController:o}=t,a=new P(i,e,o,()=>this.processor.featureStore,s,r);this._queryEngine=new M({context:a,priority:ue.FEATURE_QUERY_ENGINE})}get usedMemory(){return this.processor?.graphicsCore?.usedMemory??0}get unloadedMemory(){return.8*((this._controller?.unloadedMemoryEstimate??0)+(this.processor?.graphicsCore?.unprocessedMemoryEstimate??0))}get ignoresMemoryFactor(){return this._controller&&this._controller.fixedFeatureTarget}async _handleEdits(e){const t=this._attributeEditingContext,r=await R(t,e);T(t,r)}get _attributeEditingContext(){const e=this._getObjectIdField(),t=this._getGlobalIdField();return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:e,globalIdField:t,forEachNode:e=>this.loadedGraphics.forEachNode(t=>e(t.node,t.featureIds)),attributeStorageInfo:this.i3slayer.attributeStorageInfo??[],i3sOverrides:this._i3sOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(t,r,s)=>{this._setAttributeData(t,r);const i=this.loadedGraphics.getNode(t);if(null!=s){const t=this.loadedGraphics.get(s.attributes[e]);null!=t&&this.processor.graphicsCore.recreateGraphics([t])}else null!=i&&this.processor.graphicsCore.recreateGraphics(i.graphics)},clearMemCache:()=>{}}}get performanceInfo(){return new re(this.usedMemory,this.loadedGraphics.length,-1,this.maximumNumberOfFeatures,this.loadedGraphics.nodeCount,this.processor.graphicsCore.performanceInfo)}get test(){}};e([n()],ye.prototype,"processor",void 0),e([n({type:U})],ye.prototype,"filter",void 0),e([n()],ye.prototype,"loadedGraphics",void 0),e([n()],ye.prototype,"i3slayer",null),e([n()],ye.prototype,"layerViewUid",null),e([n()],ye.prototype,"_controller",void 0),e([n()],ye.prototype,"updating",void 0),e([n()],ye.prototype,"suspended",void 0),e([n(pe)],ye.prototype,"updatingProgress",void 0),e([n()],ye.prototype,"updatingProgressValue",null),e([n({readOnly:!0})],ye.prototype,"visibleAtCurrentScale",null),e([n(je.requiredFields)],ye.prototype,"requiredFields",null),e([n(je.availableFields)],ye.prototype,"availableFields",void 0),e([n()],ye.prototype,"_fieldsHelper",void 0),e([n({type:Number})],ye.prototype,"maximumNumberOfFeatures",null),e([n({readOnly:!0})],ye.prototype,"maximumNumberOfFeaturesExceeded",null),e([n()],ye.prototype,"_excludeObjectIds",null),e([n({readOnly:!0})],ye.prototype,"lodFactor",null),e([n({readOnly:!0})],ye.prototype,"hasM",null),e([n({readOnly:!0})],ye.prototype,"hasZ",null),e([n()],ye.prototype,"contentVisible",null),e([n({readOnly:!0})],ye.prototype,"legendEnabled",null),e([n()],ye.prototype,"_graphicOrigin",null),ye=e([l("esri.views.3d.layers.SceneLayerGraphicsView3D")],ye);const fe=ye;function be(e){return"geometryBuffer"in e&&null!==e.geometryBuffer}function _e(e){const t=e.attributeInfo;if(null==t?.loadedAttributes||null==t.attributeData)return;const r=e.node.index;for(let s=0;s<e.graphics.length;s++){const i=e.graphics[s];if(i.nodeIndex===r){i.attributes||(i.attributes={});for(const{name:e}of t.loadedAttributes)t.attributeData[e]&&(i.attributes[e]=H(t.attributeData[e],s))}}}const ve={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},we=d(),Ie={graphic:null,property:null,oldValue:null,newValue:null};function Se(){Ie.graphic=null,Ie.property=null,Ie.oldValue=null,Ie.newValue=null}export{fe as default};
