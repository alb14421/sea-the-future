/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{EventEmitter as t}from"../core/Evented.js";import{q as r,h as s}from"../core/lang.js";import{s as i,a}from"./MapUtils.js";import{c as n,f as o}from"./maybe.js";import{P as h}from"./PooledArray.js";import{watch as l,initial as c,on as u,syncAndInitial as d}from"../core/reactiveUtils.js";import{c as g}from"./SetUtils.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import{L as _}from"./Logger.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{A as f,v as x,m as v,i as b,p as w,F as y,l as T,c as C}from"./mat4.js";import{w as S,n as P,i as O,e as R,l as M,h as F,g as D,v as j,t as V,k as I}from"./vec3.js";import{f as L,c as q,o as z}from"./vec3f64.js";import{d as H}from"./debugFlags2.js";import{c as W,D as E,h as G}from"./aaBoundingRect.js";import{f as B,G as A}from"./GridLocalOriginFactory.js";import{j as U,N,ay as k,k as Q,R as X,au as Y,x as $,$ as J}from"./Matrix4PassUniform.js";import K from"../views/3d/webgl/RenderCamera.js";import{S as Z,N as ee,P as te}from"./CameraSpace.glsl.js";import{T as re,d as se,U as ie,F as ae,o as ne}from"./Emissions.glsl.js";import{g as oe}from"./glsl.js";import{S as he}from"./ShaderBuilder.js";import le from"../core/Accessor.js";import{s as ce,i as ue,a as de,l as ge,q as pe,d as _e,g as me,n as fe,e as xe,c as ve}from"./vec2.js";import{InternalRenderCategory as be}from"../views/3d/webgl.js";import we from"../views/3d/webgl/RenderNode.js";import{c as ye}from"./vec2f64.js";import{I as Te,F as Ce,S as Se,A as Pe}from"./SceneLighting.js";import{m as Oe,d as Re,u as Me}from"./renderState.js";import{b as Fe}from"./VertexAttributeLocations.js";import{i as De}from"./HighlightDefaults.js";import{V as je}from"./VertexArrayObject2.js";import{B as Ve}from"./BufferObject.js";import{a as Ie,D as Le,d as qe}from"./enums.js";import{a as ze,T as He}from"./Texture.js";import{V as We}from"./VertexBuffer.js";import{N as Ee}from"./NestedMap.js";import{D as Ge,T as Be,U as Ae,V as Ue}from"./BufferView.js";import{M as Ne}from"../core/scheduling.js";import{I as ke,c as Qe}from"./mat4f64.js";import{c as Xe,l as Ye,g as $e}from"./mathUtils.js";import{s as Je}from"./signal.js";import{e as Ke,h as Ze,a as et}from"./axisAngleDegrees.js";import{x as tt}from"./unitUtils.js";import{h as rt}from"./weather.js";import{c as st}from"./mat3f64.js";import{s as it,t as at}from"./vec4.js";import{c as nt}from"./vec4f64.js";import{T as ot,n as ht}from"./Scheduler.js";import{g as lt}from"./watch.js";import{N as ct,b as ut,g as dt}from"./sphere.js";import{m as gt}from"./mathUtils2.js";class pt{constructor(){this._extent=W(),this.resolution=0,this.renderLocalOrigin=B(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new _t}get extent(){return this._extent}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;const t=.001*e.range;if(this._extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];E(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];E(this._extent,-e.range,0,t)}}_setupGeometryView(){this.canvasGeometries.numViews=1,G(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}}class _t{constructor(){this.extents=[W(),W(),W()],this.numViews=0}}class mt{constructor(e,t,r){this._fbos=e,this._format=t,this._name=r}get valid(){return null!=this._handle?.getTexture()}dispose(){this._handle=n(this._handle)}get texture(){return this._handle?.getTexture()}ensureFramebuffer(e,t){this._handle&&this._handle.fbo?.width===e&&this._handle.fbo?.height===t||(this._handle?.release(),this._handle=this._fbos.acquire(e,t,this._name,this._format))}bind(e){e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}}class ft{constructor(e,t,r,s,i=1,a=6){this.output=r,this.content=s,this.redrawOnRequest=i,this.fbo=new mt(e,a,t)}handleRenderRequest(e){return 1===e||e===this.redrawOnRequest}get valid(){return this.fbo.valid}}class xt{constructor(e){this.targets=[new ft(e,"overlay color",0,0),new ft(e,"overlay IM color",0,1),new ft(e,"overlay highlight",8,2,1,3),new ft(e,"overlay water",3,3,0),new ft(e,"overlay occluded",0,4)],U()&&this.targets.push(new ft(e,"overlay olid",9,5,1,5))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(e){if(0!==e)for(const e of this.targets)e.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,t,r)=>t.valid?e|=1<<r:e,0)}}class vt extends N{constructor(){super(...arguments),this.color=L(1,1,1)}}const bt=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:vt,build:function(){const e=new he;return e.include(Z),e.fragment.uniforms.add(new re("tex",e=>e.texture),new se("uColor",e=>e.color)),e.fragment.main.add(oe`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),e}},Symbol.toStringTag,{value:"Module"})),wt={required:[]},yt={required:[2]};class Tt extends le{precompile(e){return!!this.acquireTechniques(e)}consumes(){return wt}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(e){}}class Ct extends Tt{}class St extends Tt{}class Pt extends ie{constructor(e,t){super(e,"ivec2",1,(r,s,i)=>r.setUniform2iv(e,t(s,i)))}}class Ot extends ie{constructor(e,t){super(e,"usampler2D",1,(r,s,i)=>r.bindTexture(e,t(s,i)))}}class Rt extends N{}const Mt=32,Ft=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:Rt,blurSize:.4,build:function(){const e=new he,{outputs:t,fragment:r}=e;return e.include(Z),r.uniforms.add(new Ot("highlightTexture",e=>e.highlightTexture)),r.constants.add("outlineWidth","int",Math.ceil(9)),r.constants.add("cellSize","int",Mt),t.add("fragGrid","uvec2"),r.main.add(oe`ivec2 inputTextureSize = textureSize(highlightTexture, 0);
ivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
texelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = outputValue;`),e},gridCellPixelSize:Mt,outlineSize:9},Symbol.toStringTag,{value:"Module"}));function Dt(e){const{vertex:t}=e;t.uniforms.add(new Ot("coverageTexture",e=>e.coverageTexture),new Pt("highlightRenderCellCount",e=>ce(jt,e.horizontalCellCount,e.verticalCellCount)),new Pt("highlightTextureResolution",({highlightTexture:e})=>ce(jt,e.descriptor.width,e.descriptor.height)),new Te("highlightLevel",e=>e.highlightLevel)).constants.add("cellSize","int",Mt),e.varyings.add("sUV","vec2"),e.varyings.add("vOutlinePossible","float"),t.code.add(oe`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),t.main.add(oe`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)}const jt=ye(),Vt=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new he;e.include(Dt);const{fragment:t}=e;return t.uniforms.add(new re("blurInput",e=>e.highlightBlurTexture),new Ce("blurSize",e=>e.blurSize),new Ot("highlightTexture",e=>e.highlightTexture),new re("highlightOptionsTexture",e=>e.highlightOptionsTexture),new Te("highlightLevel",e=>e.highlightLevel),new ae("occludedIntensityFactor",e=>e.occludedFactor)),t.constants.add("inner","float",1-8.6/9),e.include(k),t.main.add(oe`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
uvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),e}},Symbol.toStringTag,{value:"Module"}));class It extends Q{constructor(e,t){super(e,t,new X(Vt,()=>Promise.resolve().then(()=>Vt)),Fe(ee))}initializePipeline(){return Oe({blending:Me,colorWrite:Re})}}class Lt extends N{constructor(){super(...arguments),this.blurSize=ye()}}const qt=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:Lt,build:function(){const e=new he;return e.include(Dt),e.outputs.add("fragHighlight","vec2",0),e.fragment.uniforms.add(new Ce("blurSize",e=>e.blurSize),new ne("blurInput",e=>e.blurInput)).main.add(oe`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragHighlight = sum;
}`),e}},Symbol.toStringTag,{value:"Module"}));class zt extends Q{constructor(e,t){super(e,t,new X(qt,()=>Promise.resolve().then(()=>qt)),Fe(ee))}initializePipeline(){return Oe({colorWrite:Re})}}class Ht extends Q{constructor(e,t){super(e,t,new X(Ft,()=>Promise.resolve().then(()=>Ft)),te)}initializePipeline(){return Oe({colorWrite:Re})}}class Wt extends N{constructor(){super(...arguments),this.occludedFactor=De,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}}const Et=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new he;e.include(Dt),e.include(k);const{fragment:t}=e;return e.outputs.add("fragSingleHighlight","vec2",0),t.uniforms.add(new Ot("highlightTexture",e=>e.highlightTexture),new Te("highlightLevel",e=>e.highlightLevel)),t.main.add(oe`ivec2 iuv = ivec2(gl_FragCoord.xy);
uvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),e}},Symbol.toStringTag,{value:"Module"}));class Gt extends Q{constructor(e,t){super(e,t,new X(Et,()=>Promise.resolve().then(()=>Et)),Fe(ee))}initializePipeline(){return Oe({colorWrite:Re})}}let Bt=class extends we{constructor(){super(...arguments),this.produces=be.HIGHLIGHTS,this.consumes={required:[be.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new Rt,this._passParameters=new Wt,this._highlightBlurDrawParameters=new Lt,this._grid=new At}initialize(){this.addHandles([l(()=>this._updateOptionsTexture(),()=>{},c)])}destroy(){this._grid.coverage=n(this._grid.coverage),this._grid.vao=o(this._grid.vao),this._passParameters.highlightOptionsTexture=n(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(null==this._passParameters.highlightOptionsTexture){const e=new ze(16,2);e.internalFormat=6408,e.samplingMode=9728,this._passParameters.highlightOptionsTexture=new He(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(function(e){const t=new Uint8Array(128);let r=0;for(const s of e){const e=4*r,i=4*r+64;++r;const{color:a}=s,n=s.haloColor??a;t[e+0]=a.r,t[e+1]=a.g,t[e+2]=a.b,t[e+3]=s.fillOpacity*a.a*255,t[i+0]=n.r,t[i+1]=n.g,t[i+2]=n.b,t[i+3]=s.haloOpacity*n.a*255}return t}(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(Ht),this.techniques.precompile(Gt),this.techniques.precompile(zt),this.techniques.precompile(It)}render(e){const t=e.find(({name:e})=>e===be.HIGHLIGHTS),{techniques:r,bindParameters:s}=this;if(!s.decorations)return t;if(!r.get(Ht).compiled)return this.requestRender(1),t;const i=e.find(({name:e})=>"highlights"===e).getTexture();return this._renderHighlightPostprocess(i,t),t}_prepareAndDownSample(e){this._gridUpdateResources(e);const t=this.techniques.get(Ht),r=this._gridComputeCoverage(t,e),{horizontalCellCount:s,verticalCellCount:i}=r,a=this._passParameters;return a.horizontalCellCount=s,a.verticalCellCount=i,a.coverageTexture=r.coverage?.getTexture(),r}_renderGrid(e){const t=e.verticalCellCount*e.horizontalCellCount;this.renderingContext.bindVAO(e.vao),this.renderingContext.drawElementsInstanced(Ie.TRIANGLES,6,Le.UNSIGNED_BYTE,0,t)}_renderHighlightPostprocess(e,t){const{fboCache:r,techniques:s,bindParameters:i,_passParameters:a,renderingContext:n}=this,o=s.get(Gt),h=s.get(zt),l=s.get(It);if(!l.compiled||!h.compiled||!o.compiled)return void this.requestRender(1);a.highlightTexture=e;const c=this._prepareAndDownSample(e),{width:u,height:d}=e.descriptor;a.highlightTexture=e;const{camera:g}=i,{fullWidth:p,fullHeight:_,pixelRatio:m,fullViewport:f}=g,x=Math.ceil(p/m),v=Math.ceil(_/m),{_highlightBlurDrawParameters:b}=this,w=this.view.stage.renderView.renderer,{highlights:y}=i;for(let e=0;e<y.length;++e){const{name:s}=y[e];if(!w.hasHighlight(s))continue;a.highlightLevel=e,n.setClearColor(0,0,0,0);const g=r.acquire(u,d,"single highlight",2);n.bindFramebuffer(g.fbo),n.setViewport(0,0,u,d),n.clear(16384),n.bindTechnique(o,i,a),this._renderGrid(c),b.blurInput=g.getTexture(),ce(b.blurSize,1/x,0);const p=r.acquire(x,v,"single highlight blur h",2);n.unbindTexture(p.fbo?.colorTexture),n.bindFramebuffer(p.fbo),n.setViewport(0,0,x,v),n.clear(16384),n.bindTechnique(h,i,a,b),this._renderGrid(c),g.release(),ce(b.blurSize,0,1/v),a.highlightBlurTexture=p.getTexture(),n.bindFramebuffer(t.fbo),n.setViewport4fv(f),n.bindTechnique(l,i,a,b),this._renderGrid(c),p.release()}a.coverageTexture=a.highlightTexture=null}_gridUpdateResources(e){const t=this._grid,{width:r,height:s}=e.descriptor;if(t.horizontalCellCount=Math.ceil(r/Mt),t.verticalCellCount=Math.ceil(s/Mt),t.vao)return;const i=this.renderingContext,a=Ve.createIndex(i,35044,Nt);t.vao=new je(i,new We(i,ee),a)}_gridComputeCoverage(e,t){const r=this.renderingContext,s=this._grid,i=t.descriptor,a=Math.ceil(i.width/Mt),n=Math.ceil(i.height/Mt);this._downsampleDrawParameters.input=t;const{highlights:o}=this.bindParameters;s.coverage?.release();const h=this.fboCache.acquire(a,n,"highlight coverage",o.length>Qt?3:1);return s.coverage=h,r.bindFramebuffer(h.fbo),r.bindTechnique(e,this.bindParameters,this._passParameters,this._downsampleDrawParameters),r.setViewport(0,0,a,n),r.screen.draw(),s}get test(){}};e([p()],Bt.prototype,"produces",void 0),e([p()],Bt.prototype,"consumes",void 0),Bt=e([m("esri.views.3d.webgl-engine.effects.highlight.Highlight")],Bt);class At{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}}let Ut=0;const Nt=new Uint8Array([0,1,2,2,1,3]);function kt(e,t,r,s,i,a=0){const{highlights:n}=s,o=n.length>1?t.acquire(r.width,r.height,"highlight mix",n.length>Qt?3:1):null,{gl:h}=e;if(o){const t=e.getBoundFramebufferObject();e.bindFramebuffer(o.fbo),h.clearBufferuiv(h.COLOR,0,[0,0,0,0]),e.bindFramebuffer(t)}const l=o?.getTexture();s.highlightMixTexture=l,ce(s.highlightMixOrigin,a,0),n.forEach((t,n)=>{if(n>0){const t=He.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(l,t),e.setActiveTexture(t),h.copyTexSubImage2D(3553,0,0,0,a,0,r.width,r.height),e.bindTexture(null,t)}e.clear(256),s.highlightLevel=n,i()}),s.highlightLevel=null,s.highlightMixTexture=null,o?.release()}const Qt=4;class Xt{constructor(e,t,r,s){this.material=e,this.output=t,this.techniques=r,this.textures=s}}class Yt{constructor(e,t,r,s){this._textures=e,this._techniques=t,this.materialChanged=r,this.requestRender=s,this._id2glMaterialRef=new Ee}dispose(){this._textures.destroy()}acquire(e,t,r){this._ownMaterial(e);const s=e.produces.get(t);if(!s?.(r))return null;let i=this._id2glMaterialRef.get(r,e.id);if(null==i){const t=e.createGLMaterial(new Xt(e,r,this._techniques,this._textures));i=new $t(t),this._id2glMaterialRef.set(r,e.id,i)}return i.ref(),i.glMaterial}release(e,t){const r=this._id2glMaterialRef.get(t,e.id);null!=r&&(r.unref(),r.referenced||(o(r.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&_.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}class $t{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,Ge(this._refCnt>=0)}get referenced(){return this._refCnt>0}}class Jt{constructor(){this.startTime=0,this._data=Je(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new Kt,this.parallaxNew=new Kt,this._anchorPoint=q(),this._fadeState=Je(0),this._fadeFactor=Je(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,t,r){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=r?Xe((t-this.startTime)/(rr*r),0,1):1,1===this.fadeFactor&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(e,t){const r=e.relativeElevation,s=this._updateAnchorPoint(e);var i;(r>1.7*rt||r<-rt||s>ir)&&this.opacity>0?this._startFade(0,t):this.isFading||(r>rt||r<-.35*rt||s>sr*ir?this.opacity>0&&this._startFade(4,t):null==(i=this.data)||i.readyToRun||(0===this.opacity?this._startFade(1,t):2===this.data.state&&(2===this.fadeState?this._startFade(3,t):this._startFade(2,t))))}_updateParallax(e){const t=S(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-tt.radius*tt.radius,0))/Math.sqrt(t),Ze(Zt,this.parallax.anchorPoint,er),f(this.parallax.transform,ke,er[3],et(er)),Ze(Zt,this.parallaxNew.anchorPoint,er),f(this.parallaxNew.transform,ke,er[3],et(er))}_updateAnchorPoint(e){return P(this._anchorPoint,e.eye),O(this._anchorPoint,this._anchorPoint,tt.radius),0===this.fadeState&&2===this.data?.state?(R(this.parallax.anchorPoint,this._anchorPoint),0):M(F(tr,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,t){switch(this._fadeState.value=e,this.startTime=t,e){case 3:this.requestFade(),this._switchReadChannels(),R(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),R(this.parallax.anchorPoint,this._anchorPoint),R(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),R(this.parallax.anchorPoint,this._anchorPoint),R(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&2!==this.data.state&&(this.data.state=0),this.fadeState){case 3:R(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:r(this.fadeState)}}_switchReadChannels(){2===this.data?.state&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return 4===this.fadeState||1===this.fadeState||3===this.fadeState}}class Kt{constructor(){this.anchorPoint=q(),this.radiusCurvatureCorrection=0,this.transform=Qe()}}const Zt=L(0,0,1),er=Ke(),tr=q(),rr=1.25,sr=.5,ir=2e5;class ar{constructor(e,t){this.width=e,this.height=t}}class nr{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new K,this._inverseViewport=ye(),this._oldLighting=new Se,this._newLighting=new Se,this._fadedLighting=new Se,this._lighting=this._newLighting,this.ssr=new or,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=ye(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=!1,this.clouds=new Jt,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,r,s){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=r,this._newLighting.set(e),1===s&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return null==this.highlightLevel?null:this.highlights[this.highlightLevel]}}class or{constructor(){this.fadeFactor=1,this.reprojectionMatrix=Qe()}}class hr{constructor(e,t,r){this.rctx=e,this.techniques=r,this.lastFrameCamera=new K,this.output=0,this.renderOccludedMask=lr,this.time=Ne(0),this.bind=new nr(t),this.bind.alignPixelEnabled=!0}}const lr=13;let cr=class extends K{constructor(){super(...arguments),this._projectionMatrix=Qe()}get projectionMatrix(){return this._projectionMatrix}};e([p()],cr.prototype,"_projectionMatrix",void 0),e([p({readOnly:!0})],cr.prototype,"projectionMatrix",null),cr=e([m("esri.views.3d.webgl-engine.lib.CascadeCamera")],cr);class ur{constructor(){this.camera=new cr,this.lightMat=Qe()}}class dr{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class gr{constructor(e,t){this._fbos=e,this._viewingMode=t,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new dr,this._projectionView=Qe(),this._projectionViewInverse=Qe(),this._modelViewLight=Qe(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=nt(),this._cascades=[new ur,new ur,new ur,new ur],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(s("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(qe)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return it(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=n(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=Xe(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let e=0;e<this._numCascades;++e)Tr[e]=this._cascades[e];return Tr.length=this._numCascades,Tr}start(e,t,r,s,i){Ge(this.enabled);const{near:a,far:n}=function(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}(r);this._computeCascadeDistances(a,n,s),this._textureHeight=this._computeTextureHeight(e,i,s),this._setupMatrices(e,t);const{viewMatrix:o,projectionMatrix:h}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,h,o,t);this._lastOrigin=null,this.clear()}finish(){Ge(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!D(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||q(),R(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){x(Sr,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)Pr[16*t+e]=Sr[e]}}return Pr}moveSnapshot(e){Ge(this.enabled),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle?.setName(0===e?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(e){if(!this.enabled)return;const t=this._handle?.getTexture(qe)?.descriptor;if(!t)return;this._snapshots[e]?.release();const r=0===e?"shadow map highlight":"shadow map excluding highlight",s=this._acquireFBO(r);this._snapshots[e]=s;const i=this._handle?.fbo;if(!i||!s?.fbo)return void console.error("No FBO");const{rctx:a}=this._fbos;a.blitFramebuffer(i,s.fbo,256)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture(qe):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:e,fullWidth:t,fullHeight:r},s,i){const a=Math.min(window.devicePixelRatio,s)/e,n=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return Y(Math.max(t,r)*a*n,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(e){const t=this._fbos.acquire(this._textureWidth,this._textureHeight,e,10);return t.getTexture(qe)?.setShadowFiltering(!0),t}_discardSnapshot(e){this._snapshots[e]=n(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,r,s){const i=this._cascades[e],a=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],o=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),h=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]);Ge(o<h);for(let e=0;e<8;++e){it(_r,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?o:h,1);const t=mr[e];at(t,_r,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}j(yr,mr[0]),i.camera.viewMatrix=x(pr,this._modelViewLight,yr);for(let e=0;e<8;++e)V(mr[e],mr[e],i.camera.viewMatrix);let l=mr[0][2],c=mr[0][2];for(let e=1;e<8;++e)l=Math.min(l,mr[e][2]),c=Math.max(c,mr[e][2]);l-=200,c+=200,i.camera.near=-c,i.camera.far=-l,function(e,t,r,s,i){const a=1/mr[0][3],n=1/mr[4][3];Ge(a<n);let o=a+Math.sqrt(a*n);const h=Math.sin($e(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=h,function(e,t,r,s,i,a,n,o){ce(Or,0,0);for(let t=0;t<4;++t)ue(Or,Or,e[t]);de(Or,Or,.25),ce(Rr,0,0);for(let t=4;t<8;++t)ue(Rr,Rr,e[t]);de(Rr,Rr,.25),ge(Mr[0],e[4],e[5],.5),ge(Mr[1],e[5],e[6],.5),ge(Mr[2],e[6],e[7],.5),ge(Mr[3],e[7],e[4],.5);let h=0,l=pe(Mr[0],Or);for(let e=1;e<4;++e){const t=pe(Mr[e],Or);t<l&&(l=t,h=e)}_e(Fr,Mr[h],e[h+4]);const c=Fr[0];let u,d;Fr[0]=-Fr[1],Fr[1]=c,_e(Dr,Rr,Or),me(Dr,Fr)<0&&fe(Fr,Fr),ge(Fr,Fr,Dr,r),xe(Fr,Fr),u=d=me(_e(jr,e[0],Or),Fr);for(let t=1;t<8;++t){const r=me(_e(jr,e[t],Or),Fr);r<u?u=r:r>d&&(d=r)}ve(s,Or),de(jr,Fr,u-t),ue(s,s,jr);let g=-1,p=1,_=0,m=0;for(let t=0;t<8;++t){_e(Vr,e[t],s),xe(Vr,Vr);const r=Fr[0]*Vr[1]-Fr[1]*Vr[0];r>0?r>g&&(g=r,_=t):r<p&&(p=r,m=t)}Ae(g>0,"leftArea"),Ae(p<0,"rightArea"),de(Ir,Fr,u),ue(Ir,Ir,Or),de(Lr,Fr,d),ue(Lr,Lr,Or),qr[0]=-Fr[1],qr[1]=Fr[0];const f=Ue(s,e[m],Lr,ue(jr,Lr,qr),1,i),x=Ue(s,e[_],Lr,jr,1,a),v=Ue(s,e[_],Ir,ue(jr,Ir,qr),1,n),b=Ue(s,e[m],Ir,jr,1,o);Ae(f,"rayRay"),Ae(x,"rayRay"),Ae(v,"rayRay"),Ae(b,"rayRay")}(mr,o,h,fr,xr,vr,br,wr),function(e,t,r,s,i){_e(Er,r,s),de(Er,Er,.5),Gr[0]=Er[0],Gr[1]=Er[1],Gr[2]=0,Gr[3]=Er[1],Gr[4]=-Er[0],Gr[5]=0,Gr[6]=Er[0]*Er[0]+Er[1]*Er[1],Gr[7]=Er[0]*Er[1]-Er[1]*Er[0],Gr[8]=1,Gr[zr(0,2)]=-me(Wr(Gr,0),e),Gr[zr(1,2)]=-me(Wr(Gr,1),e);let a=me(Wr(Gr,0),r)+Gr[zr(0,2)],n=me(Wr(Gr,1),r)+Gr[zr(1,2)],o=me(Wr(Gr,0),s)+Gr[zr(0,2)],h=me(Wr(Gr,1),s)+Gr[zr(1,2)];a=-(a+o)/(n+h),Gr[zr(0,0)]+=Gr[zr(1,0)]*a,Gr[zr(0,1)]+=Gr[zr(1,1)]*a,Gr[zr(0,2)]+=Gr[zr(1,2)]*a,a=1/(me(Wr(Gr,0),r)+Gr[zr(0,2)]),n=1/(me(Wr(Gr,1),r)+Gr[zr(1,2)]),Gr[zr(0,0)]*=a,Gr[zr(0,1)]*=a,Gr[zr(0,2)]*=a,Gr[zr(1,0)]*=n,Gr[zr(1,1)]*=n,Gr[zr(1,2)]*=n,Gr[zr(2,0)]=Gr[zr(1,0)],Gr[zr(2,1)]=Gr[zr(1,1)],Gr[zr(2,2)]=Gr[zr(1,2)],Gr[zr(1,2)]+=1,a=me(Wr(Gr,1),t)+Gr[zr(1,2)],n=me(Wr(Gr,2),t)+Gr[zr(2,2)],o=me(Wr(Gr,1),r)+Gr[zr(1,2)],h=me(Wr(Gr,2),r)+Gr[zr(2,2)],a=-.5*(a/n+o/h),Gr[zr(1,0)]+=Gr[zr(2,0)]*a,Gr[zr(1,1)]+=Gr[zr(2,1)]*a,Gr[zr(1,2)]+=Gr[zr(2,2)]*a,a=me(Wr(Gr,1),t)+Gr[zr(1,2)],n=me(Wr(Gr,2),t)+Gr[zr(2,2)],o=-n/a,Gr[zr(1,0)]*=o,Gr[zr(1,1)]*=o,Gr[zr(1,2)]*=o,i[0]=Gr[0],i[1]=Gr[1],i[2]=0,i[3]=Gr[2],i[4]=Gr[3],i[5]=Gr[4],i[6]=0,i[7]=Gr[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=Gr[6],i[13]=Gr[7],i[14]=0,i[15]=Gr[8]}(fr,xr,br,wr,i.projectionMatrix),i.projectionMatrix[10]=2/(r-s),i.projectionMatrix[14]=-(r+s)/(r-s)}(r,s,l,c,i.camera),v(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const u=this._textureHeight;i.camera.viewport=[e*u,0,u,u]}_setupMatrices(e,t){v(this._projectionView,e.projectionMatrix,e.viewMatrix),b(this._projectionViewInverse,this._projectionView);const r=1===this._viewingMode?e.eye:I(yr,0,0,1);w(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],r)}_computeCascadeDistances(e,t,r){const s=r?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Be(t/e,4)),s);const i=(t-e)/this._numCascades,a=(t/e)**(1/this._numCascades);let n=e,o=e;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=Ye(n,o,this.settings.splitSchemeLambda),n*=a,o+=i}get test(){}}const pr=Qe(),_r=nt(),mr=[];for(let e=0;e<8;++e)mr.push(nt());const fr=ye(),xr=ye(),vr=ye(),br=ye(),wr=ye(),yr=q(),Tr=[];function Cr(){Tr.length=0}const Sr=Qe(),Pr=ke.concat(ke,ke,ke,ke),Or=ye(),Rr=ye(),Mr=[ye(),ye(),ye(),ye()],Fr=ye(),Dr=ye(),jr=ye(),Vr=ye(),Ir=ye(),Lr=ye(),qr=ye();function zr(e,t){return 3*t+e}const Hr=ye();function Wr(e,t){return ce(Hr,e[t],e[t+3]),Hr}const Er=ye(),Gr=st();class Br extends Q{constructor(e,t){super(e,t,new X(bt,()=>Promise.resolve().then(()=>bt)),te)}initializePipeline(e){return e.hasAlpha?Oe({blending:Me,colorWrite:Re}):Oe({colorWrite:Re})}}class Ar extends J{constructor(){super(...arguments),this.hasAlpha=!1}}e([$()],Ar.prototype,"hasAlpha",void 0);class Ur extends N{constructor(){super(...arguments),this.overlayIndex=0,this.opacity=1}}const Nr=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Ur,build:function(){const e=new he;return e.include(Z),e.fragment.uniforms.add(new re("tex",e=>e.texture)),e.fragment.uniforms.add(new Te("overlayIdx",e=>e.overlayIndex)),e.fragment.uniforms.add(new ae("opacity",e=>e.opacity)),e.fragment.main.add(oe`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),e}},Symbol.toStringTag,{value:"Module"}));class kr extends Q{constructor(e,t){super(e,t,new X(Nr,()=>Promise.resolve().then(()=>Nr)),te)}}let Qr=class extends Ct{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Ur,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new h,this._passParameters=new vt,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new K,this.events=new t,this.longitudeCyclical=null,this.produces=new Map([[18,e=>8!==e||this.hasHighlights],[19,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){const e=this._view,t=e.stage,r=t.renderer.fboCache,{waterTextures:s,techniques:i}=t.renderView;this._renderContext=new hr(this._rctx,new gr(r,e.state.viewingMode),i),this.addHandles([l(()=>s.updating,()=>this.events.emit("content-changed"),d),l(()=>this.spatialReference,e=>this._localOriginFactory=new A(e),d),u(()=>e.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),l(()=>function(e){let t=0;for(const r of e){const{name:e}=r;t+=e.length;const{color:s,fillOpacity:i,haloColor:a,haloOpacity:n}=r;t+=s.r+s.g+s.b+s.a+i,t+=a?a.r+a.g+a.b+a.a+n:0}const r=e.at(0);if(r){const{shadowOpacity:e,shadowDifference:s,shadowColor:i}=r;t+=e+s+i.r+i.g+i.b+i.a}return Ut+++(t>=0?0:1)}(e.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,c),l(()=>e.state.highlights,t=>{this._bindParameters.highlights=t,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap},c),e.resourceController.scheduler.registerTask(ot.OVERLAY_RENDERER,this)]);const{_bindParameters:a,_camera:n}=this;n.near=1,n.far=1e4,n.relativeElevation=null,a.slot=18,a.mainDepth=null,a.camera=n,a.oitPass=0,a.updateLighting([new Pe(z())],0,0,0)}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=o(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){const t=new Yt(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));this._pluginContext={...e,materials:t},this._techniques.precompile(kr)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||i(this._renderers,e=>e.updating||e.canCompact)}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMaterialRenderer(e){for(const t of this._renderers.values()){const r=t.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e)}registerDrapeSource(e,t){const r=this._renderers.get(e);null!=r&&r.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(l(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e)}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(e){this._renderTargets?.dispose(e)}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&g(e,e=>1===e.drapeTargetType)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=g(e,e=>1===e.drapeSourceType),this._hasDrapedRasterSource=g(e,e=>0===e.drapeSourceType),this._hasDrapedFlowSource=g(e,e=>2===e.drapeSourceType)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){null==this._overlays&&(this._renderTargets=new xt(this._stage.renderer.fboCache),this._overlays=[new pt,new pt]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets?.dispose(1),this._renderTargets=null,this.events.emit("textures-disposed")}_useOverlayColorInsteadOfColorNoRasterImage(e){return 1===e&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(e){return this._useOverlayColorInsteadOfColorNoRasterImage(e)?this._renderTargets?.getTexture(0):this._renderTargets?.getTexture(e)}get readyToRun(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=i(this._renderers,e=>e.hasOccluders)?Jr:1}_processDrapeSources(e,t){let r=!1;for(const[s,i]of this._renderers){if(e.done)break;(s.destroyed||t(s))&&i.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),r&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this._onMaterialOrContentChanged(),this.hasHighlights=i(this._renderers,e=>e.hasHighlights),this.events.emit("content-changed"))}compact(e){let t=!1;for(const r of this._renderers.values()){if(e.done)break;t=r.compact(e)||t}return t&&this.notifyChange("updating"),t}hasHighlight(e){return i(this._renderers,t=>t.hasHighlight(e))}processSyncDrapeSources(){this._processDrapeSources(ht,e=>1===e.updatePolicy)}get isEmpty(){return!H.OVERLAY_DRAW_DEBUG_TEXTURE&&a(this._renderers,e=>e.isEmpty)}get hasWater(){const e=i(this._renderers,({hasWater:e})=>e);return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}renders(e){if(H.OVERLAY_DRAW_DEBUG_TEXTURE&&4!==e&&2!==e)return!0;if(!this._overlays)return!1;const t=this._overlays[0];for(const e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;const r=this._renderContext.output;this._renderContext.output=this._renderTargets?.targets.find(t=>t.content===e)?.output??0,++this._techniques.precompiling;const s=this._sortedRenderers.some(({renderer:e})=>e.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.output=r,s}get mode(){return this.isEmpty?0:this.hasWater&&this.renders(3)?2:this._renderTargets?.getTexture(0)?1:0}updateAnimation(e){let t=!1;return this._renderers.forEach(r=>t=r.updateAnimation(e)||t),t&&this.parent.requestRender(0),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return!1;const t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const e of this._renderTargets.targets){if(1===e.content&&!this._needsColorWithoutRasterImage)continue;const r=e.output;this._renderContext.output=r,t.slot=3===r?19:18,8===r&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null);const s=this._renderContext.renderOccludedMask;4===e.content&&(this._renderContext.renderOccludedMask=Jr),this._sortedRenderers.forAll(({drapeSource:t,renderer:r})=>{1===e.content&&0===t.drapeSourceType||4===e.content&&r.hasOnlyOccluders||r.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=s,t.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(e,t){if(!this._overlays||!this._renderTargets)return;for(const e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;const r=this.allSourcesOccluders;for(const e of this._renderTargets.targets){if((0!==e.content||!this._hasDrapedFlowSource)&&!e.handleRenderRequest(t)||1===e.content&&!this._needsColorWithoutRasterImage||4===e.content&&r)continue;const s=this._drawTarget(0,e),i=this._drawTarget(1,e);(s||i)&&e.fbo.generateMipMap()}}_drawTarget(e,t){const r=this._overlays[e],s=r.canvasGeometries;if(0===s.numViews)return!1;const i=this._view.state.contentPixelRatio;this._screenToWorldRatio=i*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:a}=t;if(this.isEmpty||3===a&&!this.hasWater||!r.hasSomeSizedView())return!1;const{_rctx:n,_camera:o,_renderContext:h,_bindParameters:l}=this;if(o.pixelRatio=r.pixelRatio*i,h.output=a,l.screenToWorldRatio=this._screenToWorldRatio,l.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,l.slot=3===a?19:18,4===t.content&&(h.renderOccludedMask=Jr),!this.renders(t.content))return h.renderOccludedMask=lr,!1;const{resolution:c}=r,u=0===e,d=u?0:c;if(n.setViewport(d,0,c,c),this._bindTargetFBO(t),u)if(8!==t.output)n.setClearColor(0,0,0,0),n.clear(16384);else{const{gl:e}=n;e.clearBufferuiv(e.COLOR,0,[0,0,0,0])}if(H.OVERLAY_DRAW_DEBUG_TEXTURE&&4!==t.content&&2!==t.content){this._techniques.precompile(Br,Kr);const t=this._techniques.get(Br,Kr);for(let i=0;i<s.numViews;i++)this._setViewParameters(s.extents[i],r),this._ensureDebugPatternResources(r.resolution,Yr[e]),n.bindTechnique(t,l,this._passParameters),n.screen.draw()}if(8===t.output){const{fboCache:r}=this._stage.renderer,s=this._resolution;this._bindTargetFBO(t),kt(n,r,{width:s,height:s},l,()=>this._renderAllGeometry(e,t),d)}else this._renderAllGeometry(e,t);return n.bindFramebuffer(null),h.renderOccludedMask=lr,!0}get allSourcesOccluders(){return a(this._renderers,e=>e.hasOnlyOccluders)}_renderAllGeometry(e,t){const r=this._overlays[e],s=r.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:i,renderer:a})=>{if(1===t.content&&0===i.drapeSourceType)return;const{fullOpacity:n}=i,o=null!=n&&n<1&&0===t.output&&this._bindTemporaryFBO();for(let e=0;e<s.numViews;e++)this._setViewParameters(s.extents[e],r),a.render(this._renderContext);if(o){this._bindTargetFBO(t),this._overlayParameters.texture=o.getTexture(),this._overlayParameters.opacity=n,this._overlayParameters.overlayIndex=e;const r=this._techniques.get(kr);this._rctx.bindTechnique(r,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),o.release()}})}_bindTargetFBO(e){const t=this._resolution,r=2*t;e.fbo.ensureFramebuffer(r,t),e.fbo.bind(this._rctx)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,r=this._stage.renderer.fboCache,s=r.acquire(t,e,"overlay tmp");return r.rctx.bindFramebuffer(s.fbo),r.rctx.clear(16384),s}get _resolution(){return this._overlays?.[0].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,s){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(const{renderer:a}of this._sortedRenderers)i=a.intersect?.(e,t,r,s,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this._view.map.allLayers,t=e.length;this._renderers.forEach((r,s)=>{const i=e.indexOf(s.layer),a=i>=0,n=s.renderGroup??(a?0:1),o=s.drapeSourcePriorityOffset??0,h=t*n+(a?i:0)+o;this._sortedRenderers.push(new Xr(s,r,h))}),this._sortedRenderers.sort((e,t)=>e.index-t.index)}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],y(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),T(r.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if(I(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let s=0;for(let t=0;t<e;t++)for(let i=0;i<e;i++){const a=Math.floor(i/10),n=Math.floor(t/10);a<2||n<2||10*a>e-20||10*n>e-20?(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=255):(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=1&a&&1&n?1&i^1&t?0:255:1&a^1&n?0:128)}const i=new ze(e);i.samplingMode=9728,this._passParameters.texture=new He(this._rctx,i,r)}get test(){}};e([p()],Qr.prototype,"hasHighlights",void 0),e([p()],Qr.prototype,"renderOccludedFlags",void 0),e([p()],Qr.prototype,"_sortedDrapeSourceRenderersDirty",void 0),e([p({constructOnly:!0})],Qr.prototype,"parent",void 0),e([p({readOnly:!0})],Qr.prototype,"_techniques",null),e([p({type:Boolean,readOnly:!0})],Qr.prototype,"updating",null),e([p()],Qr.prototype,"isEmpty",null),Qr=e([m("esri.views.3d.terrain.OverlayRenderer")],Qr);class Xr{constructor(e,t,r){this.drapeSource=e,this.renderer=t,this.index=r}}const Yr=[[1,.5,.5],[.5,.5,1]],$r=-2,Jr=4,Kr=new Ar;Kr.hasAlpha=!0;class Zr{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=Qe(),this._shaderTransformation=null,this._boundingSphere=null,this.id=lt(),this.layerViewUid=t.layerViewUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){C(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){null==e?this._shaderTransformation=null:(this._shaderTransformation??=Qe(),v(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(null==this._boundingSphere&&(this._boundingSphere??=ut(),V(dt(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*gt(this.shaderTransformation)),this._boundingSphere):ct}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}export{St as A,nr as B,yt as C,Yt as G,Bt as H,Qr as O,Zr as R,Ct as S,Ot as T,ar as V,wt as a,gr as b,hr as c,$r as d,lr as e,Cr as f,Qt as m,Jr as o,kt as r};
