/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{h as t}from"../core/lang.js";import{L as s}from"./Logger.js";import{d as i}from"./maybe.js";import{initial as o,watch as r}from"../core/reactiveUtils.js";import{schedule as a}from"../core/scheduling.js";import{property as n}from"../core/accessorSupport/decorators/property.js";import{subclass as p}from"../core/accessorSupport/decorators/subclass.js";import{f as m,i as l}from"./mat3.js";import{c,I as d}from"./mat3f64.js";import{v as j,w as u}from"./mat4.js";import{c as h}from"./mat4f64.js";import{f as g}from"./quatf64.js";import{j as y,q as f}from"./vec3.js";import{a as b,c as w}from"./vec3f64.js";import{f as v}from"./vec4f64.js";import{S as _}from"./unitUtils.js";import{c as U}from"./computeTranslationToOriginAndRotation.js";import{L as C,l as M,O as S,T as x}from"./Transform.js";import{p as T}from"./projectVectorToVector.js";import{c as O}from"./aaBoundingRect.js";import{c as P,g as I,o as F,A as V,B as R,E as L,F as D,L as E,C as A,u as k}from"./BufferView.js";import B from"../layers/support/SceneModification.js";import{q as H}from"./elevationInfoUtils.js";import{t as G}from"./I3SMeshWorkerHandle.js";import{L as N}from"./LayerViewPerformanceInfo.js";import{L as W}from"./LayerView3D.js";import{a as z,r as q,g as Z}from"../widgets/Attribution/AttributionViewModel.js";import{a as Q}from"./enums.js";import $ from"../Graphic.js";import J from"../graphic/IntegratedMesh3DTilesGraphicOrigin.js";import{T as X}from"./intersectorUtilsConversions.js";import{I as Y}from"./HUDIntersectorResult.js";import{M as K}from"./VertexColor.glsl.js";import{E as ee,G as te,c as se}from"../views/SceneView.js";import{T as ie,t as oe}from"./TextureCompressionTracker.js";import{O as re,c as ae,A as ne}from"./orientedBoundingBox.js";import{g as pe,R as me}from"./EllipsoidMode.js";import{b as le}from"./Normals.js";import{Y as ce,Z as de,T as je}from"./Matrix4PassUniform.js";import ue from"../views/layers/LayerView.js";import{s as he,c as ge}from"./layerViewUtils.js";import{a as ye}from"./AlphaCutoff.js";import"../config.js";import"./object.js";import"./string.js";import"./events.js";import"./handleUtils.js";import"../core/promiseUtils.js";import"../core/Error.js";import"./watch.js";import"./ObjectPool.js";import"./SetUtils.js";import"./get.js";import"./utils.js";import"./Lifecycle.js";import"./tracking.js";import"./SimpleTrackingTarget.js";import"./nextTick.js";import"./PooledArray.js";import"./ensureType.js";import"./MapUtils.js";import"./metadata.js";import"./Warning.js";import"./common.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./persistableUrlUtils.js";import"./mathUtils.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"../core/Evented.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ObservableBase.js";import"./projectBoundingSphere.js";import"./sphere.js";import"./vec4.js";import"./ray.js";import"./vector.js";import"./vec2f64.js";import"./Intersector2.js";import"../views/3d/webgl/RenderCamera.js";import"./screenUtils.js";import"./vec2.js";import"./frustum.js";import"./plane.js";import"./mathUtils2.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./boundsUtils.js";import"../geometry/Polyline.js";import"./projectPointToVector.js";import"./projectionUtils.js";import"./SimpleObservable.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./dehydratedPoint.js";import"./persistable.js";import"./MD5.js";import"./multiOriginJSONSupportUtils.js";import"./uuid.js";import"./resourceExtension.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./WorkerHandle.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"./date.js";import"./locale.js";import"./constants.js";import"./datetime.js";import"./number.js";import"./substitute.js";import"./messages.js";import"./heightModelInfoUtils.js";import"../geometry/HeightModelInfo.js";import"./asyncUtils.js";import"../core/Collection.js";import"./shared.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./guards.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"./colorUtils.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../geometry/support/jsonUtils.js";import"./typeUtils.js";import"./createFeatureId.js";import"./typeUtils2.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils3.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils4.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./DoubleArray.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"./lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../graphic/GraphicOrigin.js";import"./isIntegratedMesh3DTilesGraphicOrigin.js";import"./Intersector.js";import"./glsl.js";import"./Emissions.glsl.js";import"../Camera.js";import"../CameraLayout.js";import"./Cyclical.js";import"../Viewpoint.js";import"./domUtils.js";import"./ReactiveSet.js";import"./PooledRBush.js";import"./quickselect.js";import"./GraphicsCollection.js";import"./spatialReferenceEllipsoidUtils.js";import"./projectBoundingRect.js";import"./coordinateSystem.js";import"./boundedPlane.js";import"./lineSegment.js";import"./scaleUtils.js";import"./layerUtils.js";import"../layers/catalog/catalogUtils.js";import"./TilemapCache.js";import"./LRUCache.js";import"./MemCache.js";import"./TileKey.js";import"./memoryEstimations.js";import"../views/View.js";import"../Map.js";import"../Basemap.js";import"./loadAll.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"./basemapDefinitions.js";import"../support/BasemapStyle.js";import"./writeUtils.js";import"../Ground.js";import"./groundInstanceUtils.js";import"./CollectionFlattener.js";import"../effects/FocusAreas.js";import"../effects/FocusArea.js";import"../effects/FocusAreaOutline.js";import"./PolygonCollection.js";import"./editableLayers.js";import"./basemapEnsureType.js";import"./basemapUtils.js";import"./utils5.js";import"./collectionUtils2.js";import"../support/LayersMixin.js";import"../layers/Layer.js";import"../time/TimeExtent.js";import"./timeUtils.js";import"../support/TablesMixin.js";import"./UpdatingHandles.js";import"./timeZoneUtils.js";import"../views/BasemapView.js";import"../views/Magnifier.js";import"./SelectionManager.js";import"./ReactiveMap.js";import"../rest/support/Query.js";import"./DataLayerSource.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"./selectionUtils.js";import"../views/Theme.js";import"./InputManager.js";import"./signal.js";import"./ViewEvents.js";import"./keybindings.js";import"./screenUtils2.js";import"./HighlightDefaults.js";import"../views/support/HighlightOptions.js";import"../views/input/Input.js";import"../views/input/gamepad/GamepadSettings.js";import"../views/input/gamepad/GamepadInputDevice.js";import"../views/navigation/Navigation.js";import"./a11yUtils.js";import"../views/navigation/NavigationActionMap.js";import"../views/navigation/gamepad/GamepadSettings.js";import"./projectionUtils2.js";import"./tagSymbols.js";import"../views/BreakpointsOwner.js";import"../views/DOMContainer.js";import"./projector.js";import"./sanitizerUtils.js";import"../views/GroundView.js";import"./cameraUtils.js";import"./projectVectorToPoint.js";import"../views/3d/webgl.js";import"./earthUtils.js";import"./ElevationProvider.js";import"./dehydratedFeatureUtils.js";import"./spatialReferenceSupport.js";import"../layers/support/ElevationSampler.js";import"./TerrainConst.js";import"../layers/support/LOD.js";import"../layers/support/TileInfo.js";import"./quat.js";import"../views/PopupView.js";import"../views/ViewAnimation.js";import"./ViewingMode.js";import"./vec3f32.js";import"./CameraSpace.glsl.js";import"./VertexAttributeLocations.js";import"./VertexElementDescriptor.js";import"./ShaderBuilder.js";import"./renderState.js";import"./FramebufferObject.js";import"./BufferObject.js";import"./Texture.js";import"./Scheduler.js";import"./debugFlags.js";import"./Indices.js";import"./InterleavedLayout.js";import"./types.js";import"../views/3d/webgl/RenderNode.js";import"./VertexArrayObject2.js";import"./VertexArrayObject.js";import"./VertexBuffer.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"./RenderGeometry.js";import"./debugFlags2.js";import"./GridLocalOriginFactory.js";import"./RibbonLineMaterial.js";import"./Octree.js";import"./sdfPrimitives.js";import"./floatRGBA.js";import"./SceneLighting.js";import"./NestedMap.js";import"./axisAngleDegrees.js";import"./sunUtils.js";import"./SunCalc.js";import"../views/3d/environment/SunLighting.js";import"../webscene/SunLighting.js";import"../views/3d/environment/VirtualLighting.js";import"../webscene/VirtualLighting.js";import"../webscene/Environment.js";import"./lightingTypes.js";import"../webscene/background/Background.js";import"../webscene/background/ColorBackground.js";import"./easing.js";import"./unitBezier.js";import"./Animation.js";import"./ray2.js";import"./viewpointUtils2.js";import"../views/ui/UI.js";import"./modeUtils.js";import"./widgetUtils.js";import"./unitFormatUtils.js";import"./quantityUtils.js";import"../widgets/Widget.js";import"./componentsUtils.js";import"./jsxWidgetSupport.js";import"./messageBundle.js";import"./jsxFactory.js";import"./ZoomMomentumEstimator.js";import"./HUDMaterial.js";import"./HUDVisibility.glsl.js";import"./BooleanBindUniform.js";import"./hydratedFeatures.js";import"./labelFormatUtils.js";import"./labelUtils.js";import"./ArcadeExpression.js";import"./TimeOnly.js";import"./enum.js";import"./UnknownTimeZone.js";import"../layers/support/FieldsIndex.js";import"./NormalUtils.glsl.js";import"./fontUtils.js";import"./DefaultMaterial.js";import"./Matrix4sPassUniform.js";import"./placementUtils.js";import"./hitTest.js";import"./LayerConstants.js";import"./hitTestSelectUtils.js";import"./RenderCoordsHelper.js";import"./terrainUtils.js";import"../views/3d/support/SceneViewPerformanceInfo.js";import"../views/3d/support/LayerPerformanceInfo.js";import"./DefaultLoadingContext.js";import"./wosrLoader.js";import"./Version.js";import"./requestImageUtils.js";import"./mapCollectionUtils.js";import"./ElevationQueryTileCache.js";import"./ElevationSamplerData.js";import"./TileStrategy.js";import"./TileKey2.js";import"./ScheduledQueueProcessor.js";import"./constants3.js";import"./mat3f32.js";import"./SymbolRepository.js";import"./config.js";import"./TiledDisplayObject.js";import"./DisplayObject.js";import"./definitions.js";import"./GeometryUtils.js";import"./RenderableTile.js";import"./resources.js";import"./colorUtils2.js";import"./graphicUtils.js";import"./meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../geometry/support/MeshLocalVertexSpace.js";import"./vec32.js";import"./vec33.js";import"./symbolColorUtils.js";import"./BlendColorsPremultiplied.glsl.js";import"./vec4f32.js";import"../views/3d/webgl/ManagedFBO.js";import"./testSVGPremultipliedAlpha.js";import"./RenderingContext.js";import"./ProgramCache.js";import"./Program.js";import"./capabilities2.js";import"./RenderingContextOptions.js";import"./ITexture.js";import"./screenshotUtils.js";import"./imageUtils.js";import"./edgePreprocessing.js";import"./drapedUtils.js";import"./makeScheduleFunction.js";import"./WebGLRequirements.js";import"../views/ui/DefaultUI.js";import"../widgets/Attribution.js";import"./globalCss.js";import"./accessibleHandler.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"./utils24.js";import"../widgets/support/GoTo.js";import"./goToUtils.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";import"./ElevationContext.js";import"./triangle.js";import"./vec2f32.js";import"./dehydratedFeatures.js";import"./quantizationUtils.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"./primitiveObjectSymbolUtils.js";import"./videoUtils.js";class fe extends N{constructor(e,t,s,i,o,r,a){super(e,0,0,0,t),this.nodesCached=s,this.vboMB=i,this.textureMB=o,this.vboMBCached=r,this.textureMBCached=a}}const be={Points:null,Lines:null,LineStrip:null,Triangles:Q.TRIANGLES,TriangleStrip:Q.TRIANGLE_STRIP,NotSet:null},we={Opaque:1,Mask:2,Blend:0},ve={Back:2,Front:1,None:0,NotSet:2},_e={WrapYBit:{s:33071,t:10497},WrapXBit:{s:10497,t:33071},WrapXy:{s:10497,t:10497},None:{s:33071,t:33071},NotSet:{s:33071,t:33071}},Ue={U8:1,I8:1,U16:2,I16:2,U32:4,I32:4,F32:4,F64:8,Utf8String:1,NotSet:1};class Ce{constructor(e){this.type=8,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerViewUid=e.uid,this._graphicOrigin=new J(this.layerView.layer)}intersect(e,t,s,i,o,r){if(e.options.filteredLayerViewUids.includes(this.layerView.uid))return;const a=e.results,n=2===e.options.store,p=this.layerView.view.stage.renderView.componentObjectCollection,m=new K(r,e.options.normalRequired);this.layerView.objects.forEach(o=>{o.visible&&o.intersectionGeometry&&p.intersect(o,s,i,e.tolerance,null,m,(o,r,p,m)=>{if(r>=0){if(null!=t&&!t(s,i,r))return;const o=e=>{const t=new X(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));e.set(this.type,t,r,p)};if(this.isGround&&(null==a.ground.distance||r<a.ground.distance)&&o(a.ground),e.options.isFiltered)return;if((null==a.min.distance||r<a.min.distance)&&o(a.min),(null==a.max.distance||r>a.max.distance)&&o(a.max),n){const t=new Y(e.ray);o(t),e.results.all.push(t)}}})})}_createTiles3DGraphic(e,t){return new $({layer:e,sourceLayer:e,origin:this._graphicOrigin,attributes:t})}}class Me{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.textureMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}get usedMemory(){return this.textureMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}get cachedMemory(){return this.usedMemory}}function Se(e){return Math.round(e/1048.576)/1e3}let xe=class extends(W(ue)){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._compressionTracker=new ie,this._modifications=new Array,this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=1,this._applySSAO=!t("disable-feature:im-ssao"),this._shadeNormals=!!t("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}get hasModifications(){return this._modifications&&this._modifications.length>0}initialize(){if(this._dbgFlags.add(3),this._dbg(2,"Tiles3DLayerView3D initialize() called"),this._updatingHandles.add(()=>this.layer.modifications,()=>this._loadModifications(),o),!this._canProjectWithoutEngine())throw he("layer",this.layer.spatialReference.wkid,this.view.renderSpatialReference?.wkid);const e=z(this).then(e=>{this._wasmLayerId=e,this._intersectionHandler=new Ce(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,e=>this._slicePlaneEnabledChange(e)),this._updatingHandles.add(()=>this._modifications,()=>this._modificationsChanged(),o),this._updatingHandles.add(()=>this.fullOpacity,e=>this._opacityChange(e)),this._updatingHandles.add(()=>this.view.clippingArea,()=>this._clippingAreaChanged(),o),this._elevationProvider=new C({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this);const t=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,e=>this._onRemoveFromCache(e));this._memCache=t,this.addHandles([r(()=>this.layer.elevationInfo,e=>this._elevationInfoChanged(e))]),this._suspendedHandle=r(()=>this.suspended,e=>this._wasm?.setEnabled(this,!e),o)});this.addResolvingPromise(e)}_opacityChange(e){this.objects.forEach(t=>{this._collection.getMaterial(t).objectOpacity=e})}destroy(){this._dbg(2,"Tiles3DLayerView3D destroy() called"),q(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(e=>this.freeObject(e)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=i(this._memCache),this._updatingHandles=i(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_modificationsChanged(){const e=this.layer.spatialReference,t=G(this._layerClippingArea,this._modifications,e);this._wasm?.setMeshModifications(this,t,e.wkid)}_clippingAreaChanged(){const e=this.layer.spatialReference,t=O();this._layerClippingArea=oe(this.view.clippingArea,t,e)?t:null,this._modificationsChanged()}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=a(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this.objects.forEach(t=>{const s=this._collection.getMaterial(t);s.commonMaterialParameters.hasSlicePlane=e,s.commonMaterialParameters.cullFace=e?0:this._initialCullFace.get(t)})}_elevationInfoChanged(e){this._wasm?.setLayerOffset(this,H(e))}get _obbs(){return this.objects.map(e=>this._collection.getComponentObb(e))}get _wasm(){return Z(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let e=0;return this._lyrHandleToObjects.forEach(t=>{t.isVisible&&(e+=t.usedMemory)}),e}get unloadedMemory(){return 0}get cachedMemory(){let e=0;return this._lyrHandleToObjects.forEach(t=>{t.isVisible||(e+=t.usedMemory)}),e}get visibleAtCurrentScale(){return ge(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let e=0,t=0,s=0,i=0,o=0,r=0;return this._lyrHandleToObjects.forEach(a=>{a.isVisible?(e+=a.textureMemoryUsage,t+=a.vboMemoryUsage,o++):(s+=a.textureMemoryUsage,i+=a.vboMemoryUsage,r++)}),new fe(this.usedMemory,o,r,Se(t),Se(e),Se(i),Se(s))}_canProjectWithoutEngine(){if(2===this.view.state.viewingMode){const e=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(3857!==e&&32662!==e)return!1}return!0}get _stage(){return this.view.stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return H(this.layer.elevationInfo)}get elevationRange(){const e=this.fullExtent;return e?.zmin&&e?.zmax?new ee(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((e,t)=>e.concat(t.components),new Array)}isUpdating(){const e=this._wasm;return!(this._wasmLayerId<0||null==e)&&(e.isUpdating(this._wasmLayerId)||this._compressionTracker.compressing)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){const t=e.meshData;if(null==t.data)throw new Error("meshData.data undefined");if(t.desc=JSON.parse(t.desc),null==t.desc)throw new Error("meshData.desc undefined");const s=b(t.desc.origin),i=new Array,o=new Map,r=new Me;r.handle=e.handle,this._lyrHandleToObjects.set(e.handle,r);const a=this.view.basemapTerrain.spatialReference;let n,p;if("global"===this.view.viewingMode){const e=h();U(_,s,e,a),n=m(c(),e),p=l(c(),n)}else n=d,p=d;const C=h();j(C,C,s);const O=u(w(),C);let I=null;const F=w();if(t.desc.obb){const e=t.desc.obb.quaternion;I=new re(t.desc.obb.center,t.desc.obb.halfSize,g(e[0],e[1],e[2],e[3]))}for(let e=0;e<t.desc.prims.length;e++){const m=t.desc.prims[e];if(this._dbg(2,JSON.stringify(m)),null==be[m.ptype]||null==t.data){this._dbg(2,"[Unsupported Feature] Unsupported primitive mode ("+m.ptype+"). Skipping primitive.");continue}const l=t.desc?.materials&&null!=m.materialId?t.desc.materials[m.materialId]:null,c=null!=l?l.lightingModel:"Unlit",{positionView:j,positionAttr:u,normalsView:h,normalsAttr:g,colorAttr:b,texCoord0Attr:_,indicesView:U}=this.getBufferViews(m,t.data.buffer,n);if(null==u||null==j||null==U)continue;const C=new te(null!=b,_?1:0,null!=h,this._shadeNormals,this._applySSAO),V=u.data.length/u.size,R=(e,t)=>!e||e.data.length/e.size===V||(this._dbg(3,`${t} !== numPos. Skipping primitive.`),!1);if(!R(_,"numTexcoord")||!R(b,"numColors")||!R(g,"normals"))continue;const L=se(C);if(null!=I?I=I.clone():(I=ae(u),y(F,I.center,s),I.center=F),n!==d)for(let e=0;e<j.count;e++)j.getVec(e,F),f(F,F,n),j.setVec(e,F);const D=L.createBuffer(u.data.length);if(ce("position",u,null,null,D,0),null!=_){const e=D.getField("uv0",P);de(_,e,0)}null!=b&&ce("color",u,null,null,D,0),null!=g&&ce("normalCompressed",g,null,null,D,0);const E=new Uint32Array([0,U.typedBuffer.length]),A={vertices:{data:D.buffer,count:D.byteLength/L.stride,layoutParameters:C},positionData:{positions:j.typedBuffer,indices:U.typedBuffer},indices:U.typedBuffer,componentOffsets:E};r.cpuMemoryUsage+=j.count,r.cpuMemoryUsage+=U.count;const k=this.view.renderSpatialReference,B=w(),H=[1,1,1];M(O,k,H,a)||this._dbg(3,"Unsupported coordinate system for IM overlay"),T(O,k,B,a);const G=this._collection.createObject(new S(v(B[0],B[1],H[0],H[1]),new x(O,p),I,A));l&&this._collection.updateMaterial(G,e=>{e.baseColor=l.baseColorFactor,e.usePBR="Pbr"===c,e.hasParametersFromSource=!1,e.baseColorTexture=this._getTexture(l.baseColorTex,t,o,r),e.usePBR&&(e.mrrFactors=[l.metallicFactor,l.roughnessFactor,0],e.emissiveBaseColor=l.emissiveFactor??[0,0,0],e.metallicRoughnessTexture=this._getTexture(l.metalTex,t,o,r),e.emissionTexture=this._getTexture(l.emissiveTex,t,o,r),e.occlusionTexture=this._getTexture(l.occlusionTex,t,o,r),e.normalTexture=this._getTexture(l.normalTex,t,o,r)),e.objectOpacity=0,e.alphaDiscardMode=2;const s=[];e.baseColorTexture&&s.push(e.baseColorTexture.loadPromise),e.usePBR&&e.metallicRoughnessTexture&&s.push(e.metallicRoughnessTexture.loadPromise),e.usePBR&&e.emissionTexture&&s.push(e.emissionTexture.loadPromise),e.usePBR&&e.occlusionTexture&&s.push(e.occlusionTexture.loadPromise),e.usePBR&&e.normalTexture&&s.push(e.normalTexture.loadPromise);const a=Promise.all(s);i.push(a),a.then(()=>{e.alphaDiscardMode=we[l.alphaMode],e.objectOpacity=this.fullOpacity,r.textureMemoryUsage+=e.baseColorTexture?.glTexture?.usedMemory||0,e.usePBR&&(r.textureMemoryUsage+=e.metallicRoughnessTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=e.emissionTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=e.occlusionTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=e.normalTexture?.glTexture?.usedMemory||0)}),e.commonMaterialParameters.doubleSided=l.isDoubleSided,e.commonMaterialParameters.cullFace=l.faceCulling?ve[l.faceCulling]:2,this._initialCullFace.set(G,e.commonMaterialParameters.cullFace),e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.componentParameters.castShadows=0,e.textureAlphaCutoff=l.alphaCutoff??ye,e.alphaDiscardMode=we[l.alphaMode],e.isIntegratedMesh=!0,e.polygonOffsetEnabled=!1,e.hasOccludees=!1,e.ellipsoidMode=pe(this.view.spatialReference)}),r.components.push(G),r.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(G)}if(await Promise.all(i),o.forEach(e=>{r.textures.push(e)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${r.handle}`,r),{memUsageBytes:r.usedMemory}}freeRenderable(e){const t=this._lyrHandleToObjects.get(e);t&&(this.freeObject(t),this._lyrHandleToObjects.delete(e))}freeObject(e){this._memCache&&this._memCache.pop(`${e.handle}`),e.components.forEach(t=>{e.textures.forEach(e=>{this._stage.removeTexture(e)}),this._collection.destroyObject(t),this._initialCullFace.delete(t)})}setRenderableVisibility(e,t,s){if(this._memCache){for(let i=0;i<s;++i){const s=e[i],o=t[i];if(!o)continue;const r=this._lyrHandleToObjects.get(s);r&&(this._visibleGeometryChanged(),r.isVisible=o,r.components.forEach(e=>{this._collection.setObjectVisibility(e,o),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))}),this._memCache.pop(`${s}`))}for(let i=0;i<s;++i){const s=e[i],o=t[i];if(o)continue;const r=this._lyrHandleToObjects.get(s);r&&(this._visibleGeometryChanged(),r.isVisible=o,r.components.forEach(e=>{this._collection.setObjectVisibility(e,o),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))}),this._memCache.put(`${s}`,r))}}}_getTexture(e,s,i,o){let r=null;if(e&&s.desc?.images&&s.data?.buffer){const a=s.desc.images[e?.imageId];if(r=i.get(a),!r&&a){const n=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,p=!!a.mipCount||n>1,m=_e[e.wrapMode??"None"];let l=a.alpha?4:3;const c=new Uint8Array(s.data.buffer,a.data.byteOffset,a.data.byteCount);let d=null,j=null,u=null;switch(a.format){case"Raw":"R8"===a.pixelFormat?(d=c,l=1,j=""):"Rgb8"===a.pixelFormat?(d=c,l=3,j=""):"Rgba8"===a.pixelFormat&&(d=c,l=4,j="");break;case"Dxt1":d=c,l=3,j="image/vnd-ms.dds";break;case"Dxt5":d=c,l=4,j="image/vnd-ms.dds";break;case"Basis":d=c,l=3,j="image/ktx2";break;case"Png":j="image/png",u=document.createElement("img");break;case"Jpeg":j="image/jpeg",u=document.createElement("img");break;case"Etc2":j="image/ktx",u=document.createElement("img");break;case"Astc":this._dbg(3,"Astc texture not supported");break;case"Pvrtc":this._dbg(3,"Pvrtc texture not supported")}if(u&&j){const e=new Blob([c],{type:j});u.src=URL.createObjectURL(e),d=u}if(d&&null!=j){const e=t("enable-feature:esri-compress-IM-textures")?{compressionTracker:this._compressionTracker,compressionCallback:e=>{e&&e>0&&(o.textureMemoryUsage-=e)}}:void 0;r=new je(d,{mipmap:p,maxAnisotropy:n,encoding:j,wrap:m,components:l,compressionOptions:e,noUnpackFlip:!0,width:a.mip0Width,height:a.mip0Height}),this._stage.addTexture(r),i.set(a,r)}}}return r?new me(this.view.stage.renderView.textures,r.id):null}getBufferViews(e,t,s){let i,o,r,a,n,p,m,l=null;for(let m=0;m<e.atrbs.length;m++){const c=e.atrbs[m],d=c.view,j=void 0,u=d.byteOffset+d.byteCount,h=d.byteCount/Ue[d.type],g=[...Array(h).keys()].map(e=>e);try{switch(c.sem){case"Position":3!==d.ncomp||"F32"!==d.type?this._dbg(3,"[Unsupported Feature] Unsupported view for Position ("+d+")"):(i=new R(t,d.byteOffset,j,u),o=new ne(i.typedBuffer,g,3));break;case"Normal":if(3!==d.ncomp||"F32"!==d.type)this._dbg(3,"[Unsupported Feature] Unsupported view for Normal ("+d+")");else{const e=new R(t,d.byteOffset,j,u),i=le(e.typedBuffer,s);n=new E(i),p=new ne(n.typedBuffer,g,2)}break;case"TexCoord":2!==d.ncomp||"F32"!==d.type?this._dbg(3,"[Unsupported Feature] Unsupported view for Texcoord ("+d+")"):void 0===a&&(a=new ne(new P(t,d.byteOffset,j,u).typedBuffer,g,2));break;case"Color":4===d.ncomp?("F32"===d.type&&(l=new I(t,d.byteOffset,j,u)),"U8"===d.type&&(l=new F(t,d.byteOffset,j,u)),"U16"===d.type&&(l=new V(t,d.byteOffset,j,u))):3===d.ncomp&&("F32"===d.type&&(l=new R(t,d.byteOffset,j,u)),"U8"===d.type&&(l=new L(t,d.byteOffset,j,u)),"U16"===d.type&&(l=new D(t,d.byteOffset,j,u))),null==l?this._dbg(2,"[Unsupported Feature] Unsupported view for Color ("+d+")"):r=new ne(l.typedBuffer,g,d.ncomp);break;case"FeatureIndex":break;default:this._dbg(2,"[Unsupported Feature] Unsupported semantic ("+c.sem+"). Skipping vertex attribute.")}}catch(e){this._dbg(2,"Error Creating buffer ("+e+"). Skipping vertex attribute.")}}if(e.index){const s=e.index.view,i=void 0,o=s.byteOffset+s.byteCount;switch(e.index.view.type){case"U16":m=new k(t,s.byteOffset,i,o);break;case"U32":m=new A(t,s.byteOffset,i,o);break;default:this._dbg(3,"[Unsupported Feature] index type not supported ("+s.type+").")}}if(null==m&&null!=i){const e=i.count;if(e<65535){const t=new Uint16Array(e);m=new k(t)}else{const t=new Uint32Array(e);m=new A(t)}for(let t=0;t<e;t++)m.set(t,t)}return{positionView:i,positionAttr:o,colorAttr:r,texCoord0Attr:a,indicesView:m,normalsView:n,normalsAttr:p}}_loadModifications(){if(this.removeHandles("modifications"),null==this.layer.modifications)return void(this._modifications=[]);const e=this.layer.modifications;this.addHandles(this._updatingHandles.addOnCollectionChange(()=>e,()=>this._modifications=e.toArray(),o),"modifications")}_onRemoveFromCache(e){this._wasm?.onRenderableEvicted(this,e.handle,e.usedMemory),this.freeRenderable(e.handle)}_dbg(e,t){this._dbgFlags.has(e)&&(3===e?s.getLogger(this).error(t):s.getLogger(this).warn(t))}};e([n({type:[B]})],xe.prototype,"_modifications",void 0),e([n()],xe.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),e([n()],xe.prototype,"layer",void 0),e([n({readOnly:!0})],xe.prototype,"visibleAtCurrentScale",null),e([n()],xe.prototype,"elevationOffset",null),xe=e([p("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],xe);const Te=xe;export{Te as default};
