/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Graphic.js";import r,{p as o}from"../request.js";import s from"../core/Error.js";import{Loadable as i}from"../core/Loadable.js";import{L as n}from"../chunks/Logger.js";import{M as a}from"../chunks/MultiOriginJSONSupport.js";import{isAbortError as l}from"../core/promiseUtils.js";import{urlToObject as p}from"../core/urlUtils.js";import{property as u}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import c from"../geometry/Extent.js";import d from"../geometry/SpatialReference.js";import{fromJSON as y}from"../geometry/support/jsonUtils.js";import{v as h,a as j,o as f,f as b,c as k,i as g,e as S}from"../chunks/EditBusLayer.js";import w from"./support/TopologyValidationJobInfo.js";import{q as I}from"../chunks/featureQueryAll.js";import{b as v,i as U}from"../chunks/layerUtils.js";import T from"../portal/PortalItem.js";import E from"../rest/support/FeatureSet.js";import{d as M}from"../chunks/guards.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/maybe.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../chunks/SetUtils.js";import"../chunks/SimpleTrackingTarget.js";import"../chunks/ensureType.js";import"../chunks/MapUtils.js";import"../chunks/object.js";import"../chunks/events.js";import"../config.js";import"../chunks/string.js";import"../chunks/Warning.js";import"../core/Collection.js";import"../core/Evented.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../chunks/jsonUtils.js";import"../core/JSONSupport.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../chunks/datetime.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"../chunks/jsonMap.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../chunks/enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/locale.js";import"../chunks/constants.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"../chunks/colorUtils.js";import"../chunks/mathUtils.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../core/reactiveUtils.js";import"../chunks/typeUtils.js";import"../geometry/Geometry.js";import"../chunks/unitUtils.js";import"../chunks/pe.js";import"../chunks/assets.js";import"../kernel.js";import"../chunks/persistableUrlUtils.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../geometry/Polyline.js";import"../chunks/createFeatureId.js";import"../chunks/typeUtils2.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../core/Promise.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils3.js";import"../symbols/edges/Edges3D.js";import"../chunks/screenUtils.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils4.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/vec3f64.js";import"../chunks/aaBoundingBox.js";import"../chunks/DoubleArray.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../chunks/lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../chunks/uuid.js";import"../rest/networks/support/ValidateNetworkTopologyResult.js";import"../rest/support/Query.js";import"../chunks/DataLayerSource.js";import"../layers/support/Field.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/fieldType.js";import"../chunks/FullTextSearch.js";import"../chunks/spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../time/TimeExtent.js";import"../chunks/timeUtils.js";import"../layers/catalog/catalogUtils.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";function D(e,t,r="from"){const{fromRuleElement:o,viaRuleElement:s,toRuleElement:i}=V(e),n=[];switch(e.ruleType){case 2:case 3:"from"===r&&C(t,o,!1)?n.push(i):"to"===r&&C(t,i,!1)&&n.push(o);break;case 4:case 1:C(t,o,!0)?n.push(i):C(t,i,!0)&&n.push(o);break;case 5:s&&(C(t,s,!0)?(n.push(o),n.push(i)):(C(t,o,!0)||C(t,i,!0))&&n.push(s));break;default:return[]}return n}function L(e,t,r){const{fromRuleElement:o,viaRuleElement:s,toRuleElement:i}=V(e);switch(e.ruleType){case 2:case 3:return N(t,r,o,i,!1,!1);case 4:case 1:return N(t,r,o,i,!0,!0);case 5:return N(t,r,o,s,!0,!0)||N(t,r,i,s,!0,!0);default:return!1}}function N(e,t,r,o,s,i){if(!r||!o)return!1;const n=C(e,r,i),a=C(t,o,i);if(s){const s=C(e,o,i),l=C(t,r,i);return n&&a||s&&l}return n&&a}function C(e,t,r){const{assetGroupCode:o,assetTypeCode:s}=e;return("layerId"in e?e.layerId===t.networkSource?.layerId:e.networkSourceId===t.networkSource?.sourceId)&&(null==o||o===t.assetGroup?.assetGroupCode)&&(null==s||s===t.assetType?.assetTypeCode)&&(!r||!("terminalId"in e)||function(e,t){const r=e.terminal?.terminalId,o=t.terminalId;return null==r&&null==o||(1===r?null==o||1===o:r===o)}(t,e))}function V(e){return{fromRuleElement:{networkSource:e.fromNetworkSource,assetGroup:e.fromAssetGroup,assetType:e.fromAssetType,terminal:e.fromTerminal},viaRuleElement:e.viaNetworkSource?{networkSource:e.viaNetworkSource,assetGroup:e.viaAssetGroup,assetType:e.viaAssetType,terminal:e.viaTerminal}:void 0,toRuleElement:{networkSource:e.toNetworkSource,assetGroup:e.toAssetGroup,assetType:e.toAssetType,terminal:e.toTerminal}}}function P(e){let t=null,r=null,o=null;if(M(e))t=R(e),[r,o]=function(e){const[t,r]=F(e.sourceLayer);return[t?e.attributes[t]:null,r?e.attributes[r]:null]}(e);else if(v(e)){t=e.parent?.layerId??null;const[o]=F(e);o===e.subtypeField&&(r=e.subtypeCode)}else t=e.layerId??null;return{layerId:t,assetGroupCode:r,assetTypeCode:o}}function R(e){const{sourceLayer:t}=e;let r;return U(t)?r=t.layerId:v(t)&&(r=t.parent?.layerId),r??null}function F(e){return e&&"fieldsIndex"in e?[e.fieldsIndex.normalizeFieldName("assetGroup")??null,e.fieldsIndex.normalizeFieldName("assetType")??null]:[null,null]}async function O(e,t){const r=e.layers,o=e.layerInfos,s=e.returnGeometry||!1,i=e.outSpatialReference;return await Promise.all(r.map(async e=>{await e.load()})),(await Promise.all(r.map(async e=>{const t=o.find(t=>t.layerUrl===e.parsedUrl?.path);if(!t?.objectIds?.length)return{layer:e,featureSet:void 0};const r=e.createQuery();r.returnGeometry=s,r.outFields=t.outFields||["*"],r.outSpatialReference=i,r.gdbVersion=e.gdbVersion,r.objectIds=t.objectIds;const n=E.fromJSON(await I(e,r));return n.features.forEach(t=>{t.layer=t.sourceLayer=e}),{layer:e,featureSet:n}}))).filter(e=>void 0!==e.featureSet)}async function _(e,t){if("Utility Network Layer"===e){const{default:e}=await import("./UtilityNetwork.js");return new e({layerUrl:t})}return null}let A=class extends(a(i)){static fromPortalItem(e){return async function(e){let t="portalItem"in e?e:{portalItem:e};!t.portalItem||t.portalItem instanceof T||(t={...t,portalItem:new T(t.portalItem)});const o=t.portalItem;if(await o.load(),"Feature Service"!==o.type)throw new s("portal:unknown-item-type","Unknown item type '${type}'",{type:o.type});const i=o.url,n=await r(i,{responseType:"json",query:{f:"json"}}),a="Network Layer";if(n.data.type?.includes(a))return _(n.data.type,i);if(n.data.layers){const e=n.data.layers.find(e=>e.type.includes(a));if(e){const t=`${i}/${e.id}`;return _(e.type,t)}}return null}(e)}constructor(e){super(e),this.id=null,this.title=null,this.layerUrl=null,this.dataElement=null,this.fullExtent=null,this.spatialReference=null,this.type=null,this.sourceJSON=null,this._historicMoment=null,this._gdbVersion=null,this._sourceIdByLayerId=new Map,this._layerIdBySourceId=new Map,this._applyEditsHandler=e=>{const{serviceUrl:t,gdbVersion:r,result:o}=e,s=t===this.featureServiceUrl,i=h(t,r,this.gdbVersion);s&&i&&o.then(e=>{j(t,r)&&(this.historicMoment=e.historicMoment)})},this._updateMomentHandler=e=>{const{serviceUrl:t,gdbVersion:r,moment:o}=e,s=t===this.featureServiceUrl,i=h(t,r,this.gdbVersion);s&&i&&(this.historicMoment=o)},this.when().then(()=>{this.addHandles([f(this._applyEditsHandler),b(this._updateMomentHandler)])},()=>{})}initialize(){this.when().catch(e=>{l(e)||n.getLogger(this).error("#load()",`Failed to load layer (title: '${this.title??"no title"}', id: '${this.id??"no id"}')`,{error:e})})}get loaded(){return super.loaded}get datasetName(){return this.dataElement?.name??null}get owner(){return this.dataElement?.userIdentity??null}get schemaGeneration(){return this.dataElement?.schemaGeneration??null}get parsedUrl(){return p(this.layerUrl)}get featureServiceUrl(){return o(this.parsedUrl.path).url.path}get networkServiceUrl(){return this.featureServiceUrl.replace(/\/FeatureServer/i,"/UtilityNetworkServer")}get layerId(){return o(this.parsedUrl.path).sublayer}get networkSystemLayers(){return null}get gdbVersion(){return this._gdbVersion}set gdbVersion(e){this._gdbVersion=e}get historicMoment(){return this._historicMoment}set historicMoment(e){this._historicMoment=e}async load(e){return this.addResolvingPromise(this._load(e)),this}async _load(e){await Promise.all([this._fetchDataElement(this.featureServiceUrl,this.layerId.toString(),e),this._fetchLayerMetaData(this.layerUrl,e)])}getLayerIdBySourceId(e){if(!this.dataElement)return null;const t=this._layerIdBySourceId.get(e);if(null!=t)return t;const r=this.dataElement.domainNetworks,o=this._traverseNetworkSources(r,this._layerIdBySourceId,"sourceId","layerId",e);return o>=0?o:null}getSourceIdByLayerId(e){if(!this.dataElement)return null;const t=this._sourceIdByLayerId.get(e);if(null!=t)return t;const r=this.dataElement.domainNetworks,o=this._traverseNetworkSources(r,this._sourceIdByLayerId,"layerId","sourceId",e);return o>=0?o:null}getObjectIdsFromElements(e){const t=[],r=new Map;for(const t of e){const e=this.getLayerIdBySourceId(t.networkSourceId);if(null==e)continue;let o=r.get(e);void 0===o&&(o=[]),o.push(t.objectId),r.set(e,o)}const o=this.featureServiceUrl;return r.forEach((e,r)=>t.push({layerUrl:`${o}/${r}`,objectIds:e})),t}async queryNamedTraceConfigurations(e,t){const[{queryNamedTraceConfigurations:r},{default:o}]=await Promise.all([import("../chunks/queryNamedTraceConfigurations.js"),import("../chunks/QueryNamedTraceConfigurationsParameters.js")]),s=this.networkServiceUrl,i=o.from(e);return(await r(s,i,{...t}))?.namedTraceConfigurations}async validateTopology(e,t){if(!e.validateArea)throw new s("network:undefined-validateArea","the network must have validateArea defined in the validate network topology parameters.");const[{validateNetworkTopology:r},{default:o}]=await Promise.all([import("../chunks/validateNetworkTopology.js"),import("../rest/networks/support/ValidateNetworkTopologyParameters.js")]),i=o.from(e);j(this.featureServiceUrl,this.gdbVersion||null)?(i.sessionID=k,await g(this.featureServiceUrl,this.gdbVersion,!0)):i.sessionID=null,i.gdbVersion=this.gdbVersion;const n=this.networkServiceUrl,a=this.featureServiceUrl,l=S(a,null,this.gdbVersion,!0),p=await r(n,i,{...t});if(p?.serviceEdits){const e=[];for(const t of p.serviceEdits){const{editedFeatures:r}=t,o=r?.spatialReference?new d(r.spatialReference):null;e.push({layerId:t.layerId,editedFeatures:{adds:r?.adds?.map(e=>x(e,o))||[],updates:r?.updates?.map(e=>({original:x(e[0],o),current:x(e[1],o)}))||[],deletes:r?.deletes?.map(e=>x(e,o))||[],spatialReference:o}})}l.resolve({edits:null,addedFeatures:[],updatedFeatures:[],deletedFeatures:[],addedAttachments:[],updatedAttachments:[],deletedAttachments:[],editedFeatures:e,exceededTransferLimit:!1,historicMoment:p.moment})}return p}async submitTopologyValidationJob(e,t){let o=null;if(!e.validateArea)throw new s("network:undefined-validateArea","the network must have validateArea defined in the validate network topology parameters.");if(!this.gdbVersion){const e=this.layerUrl.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");o=(await r(e,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}const[{submitValidateNetworkTopologyJob:i},{default:n}]=await Promise.all([import("../chunks/validateNetworkTopology.js"),import("../rest/networks/support/ValidateNetworkTopologyParameters.js")]),a=n.from(e);j(this.featureServiceUrl,this.gdbVersion||null)?(a.sessionID=k,await g(this.featureServiceUrl,this.gdbVersion,!0)):a.sessionID=null,a.gdbVersion=this.gdbVersion||o;const l=this.networkServiceUrl,p=this.featureServiceUrl?S(this.featureServiceUrl,null,this.gdbVersion,!0):void 0,u=await i(l,a,{...t});return new w({statusUrl:u,editsResolver:p})}getSourceTypeById(e){if(!this.dataElement)return null;for(const t of this.dataElement.domainNetworks)for(const r of[t.edgeSources??[],t.junctionSources??[]])for(const o of r)if(o.sourceId===e)return r===t.edgeSources?"edge":"junction";return null}_traverseNetworkSources(e,t,r,o,s){for(const i of e)for(const e of[i.edgeSources??[],i.junctionSources??[]])for(const i of e)if(i[r]===s)return t.set(s,i[o]),i[o];return-1}async _fetchLayerMetaData(e,t){const o=await r(e,{responseType:"json",query:{f:"json"},...t});this.sourceJSON=o.data,this.read(o.data,{origin:"service"})}async _fetchDataElement(e,t,o){if(this.dataElement)return;const s=await r(`${e}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...o}).then(e=>e.data.layerDataElements?.[0]);s&&this.read(s,{origin:"service"})}};function x(e,r){return new t({attributes:e.attributes,geometry:y({...e.geometry,spatialReference:r})})}e([u({type:String,nonNullable:!0,json:{origins:{"web-map":{read:!0,write:{isRequired:!0}},service:{read:!0}},read:!1}})],A.prototype,"id",void 0),e([u({type:String,nonNullable:!0,json:{origins:{"web-map":{read:!0,write:{isRequired:!0}},service:{read:{source:"name"}}},read:!1}})],A.prototype,"title",void 0),e([u({type:String,nonNullable:!0,json:{origins:{"web-map":{read:{source:"url"},write:{target:"url",isRequired:!0}}},read:!1}})],A.prototype,"layerUrl",void 0),e([u({type:Object,json:{origins:{service:{read:!0}},read:!1}})],A.prototype,"dataElement",void 0),e([u({type:c,json:{origins:{service:{read:{source:"extent"}}},read:!1}})],A.prototype,"fullExtent",void 0),e([u({type:d,json:{origins:{service:{read:{source:"extent.spatialReference"}}},read:!1}})],A.prototype,"spatialReference",void 0),e([u({type:["utility","trace"],readOnly:!0,json:{read:!1,write:!1}})],A.prototype,"type",void 0),e([u({readOnly:!0})],A.prototype,"datasetName",null),e([u({readOnly:!0})],A.prototype,"owner",null),e([u({readOnly:!0})],A.prototype,"schemaGeneration",null),e([u({readOnly:!0})],A.prototype,"parsedUrl",null),e([u({readOnly:!0})],A.prototype,"featureServiceUrl",null),e([u({readOnly:!0})],A.prototype,"networkServiceUrl",null),e([u({readOnly:!0})],A.prototype,"layerId",null),e([u()],A.prototype,"sourceJSON",void 0),e([u({readOnly:!0})],A.prototype,"networkSystemLayers",null),e([u({type:String})],A.prototype,"gdbVersion",null),e([u({type:Date})],A.prototype,"historicMoment",null),e([u()],A.prototype,"_historicMoment",void 0),e([u()],A.prototype,"_gdbVersion",void 0),A=e([m("esri.networks.Network")],A);const B=A;export{P as a,D as b,R as c,L as d,B as default,O as e,F as g};
