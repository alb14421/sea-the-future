/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as s}from"../chunks/tslib.es6.js";import{c as p}from"../chunks/asyncUtils.js";import t from"../core/Error.js";import{h as e}from"../core/lang.js";import{L as i}from"../chunks/Logger.js";import{throwIfAborted as o,wrapAbortWithTimeout as r,allSettledValues as n,createResolver as u}from"../core/promiseUtils.js";import{watch as a,syncAndInitial as c,whenOnce as h}from"../core/reactiveUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{V as d}from"../chunks/InputManager.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/maybe.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../chunks/SetUtils.js";import"../chunks/SimpleTrackingTarget.js";import"../chunks/object.js";import"../config.js";import"../chunks/string.js";import"../chunks/events.js";import"../chunks/ensureType.js";import"../chunks/MapUtils.js";import"../chunks/Warning.js";import"../chunks/Queue.js";import"../chunks/SimpleObservable.js";import"../chunks/signal.js";function j(s){return null!=s&&"open"in s&&"declaredClass"in s}function y(s){return null!=s&&"declaredClass"in s&&"dockOptions"in s}const f=u=>{const f=u;let g=class extends f{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([a(()=>[this.ui,this.popup],([s,p],t)=>{const e="popup";if(t){const[s,i]=t;s&&j(i)&&(i.view=null,y(i)&&(s.remove(i,e),i!==p&&p&&i.destroy()))}s&&j(p)&&(p.view=this,y(p)&&s.add(p,{key:e,position:"manual",internal:!0}))},c),this.on("click",s=>{this.popup&&this.popupEnabled&&("mouse"!==s.pointerType||0===s.button)&&(j(this.popup)?this.popup.viewModel.handleViewClick(s):s.defer(async()=>{await this.setupPopup(),j(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(s)}))},d.WIDGET)]),h(()=>this.ready&&this.popupEnabled&&!this.updating).then(()=>import("../widgets/Popup.js"))}destroy(){this.destroyed||this.closePopup()}async openPopup(s){if(j(this.popup))return this.popup.open(s);try{if(await this.setupPopup(),!this.popup)return void i.getLogger(this).error(new t("view:null-popup","Popup is null and can't be opened"));this.popup.open(s)}catch{}}closePopup(){this._popupSetupTask?.abort(),j(this.popup)&&this.popup.close()}async fetchPopupFeatures(s,p){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(s,p),p)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!j(this.popup))return this._popupSetupTask=p(async s=>{const{default:p}=await import("../widgets/Popup.js");if(o(s),!this.popup||j(this.popup))return;const t=this.popup;delete t.open,delete t.close,this.popup=new p(t)}),this._popupSetupTask.promise}async _popupHitsToFeatures({location:s,hits:p},t){const i=[],o=[];let u=!1;const a=r(t,e("popup-view-fetch-timeout")??w),c=s=>{const p=o.at(-1);return p&&p.layerView===s&&!u?p:(s=>{const p=new k(s);return o.push(p),i.push(p.promise),p})(s)};for(const s of p)"graphic"in s?(c(s.layerView).graphics.push(s.graphic),u=!1):(i.push(s.layerView.fetchPopupFeaturesAtLocation(s.mapPoint,a)),u=!0);o.forEach(s=>s.resolve(a));const h=n(i).then(s=>s.filter(s=>!!s).flat());return{pendingFeatures:i,allGraphicsPromise:h,location:s}}async _getPopupHits(s,p){const{hits:t,location:e}=await this.popupHitTest(s);o(p);const i=[];for(const s of t)if("graphic"in s){if(this._isValidPopupGraphic(s.graphic,p)){const p=this._isValidPopupGraphicsLayerView(s.layerView)?s.layerView:void 0;i.push({graphic:s.graphic,layerView:p})}}else this._isValidPopupLocationLayerView(s.layerView)&&i.push({mapPoint:s.mapPoint,layerView:s.layerView});return{hits:i,location:e}}_isValidPopupGraphic(s,p){return s&&!!s.getEffectivePopupTemplate(p?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(s){return!s||(!("layer"in s)||!s.suspended)&&"fetchPopupFeaturesFromGraphics"in s}_isValidPopupLocationLayerView(s){return(!("layer"in s)||!s.suspended)&&"fetchPopupFeaturesAtLocation"in s}};return s([l()],g.prototype,"popup",void 0),s([l()],g.prototype,"popupEnabled",void 0),g=s([m("esri.views.PopupView")],g),g};class k{constructor(s){this.layerView=s,this._resolver=u(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(s){const{layerView:p,graphics:t,_resolver:e}=this;if(!p)return e.resolve(t),e.promise;let i;return p.fetchPopupFeaturesFromGraphics(t,s).catch(s=>(i=s,null)).then(s=>{s?e.resolve(s):e.reject(i)}),e.promise}}const w=5e3;export{f as PopupView};
