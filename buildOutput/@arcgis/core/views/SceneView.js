/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Camera.js";import i from"../Viewpoint.js";import s from"../core/Collection.js";import{b as r}from"../chunks/domUtils.js";import n from"../core/Error.js";import{a}from"../chunks/events.js";import{m as o,d as l}from"../chunks/handleUtils.js";import{h,q as c,clone as d,b as u,D as p,a as m,V as g,e as _,t as f,p as y,Q as v,c as b,L as w,W as x}from"../core/lang.js";import{L as C}from"../chunks/Logger.js";import{r as T,d as S,a as P,f as M,b as R,c as O,g as D}from"../chunks/maybe.js";import{createAbortError as A,isAborted as E,onAbort as I,createResolver as L,c as k,throwIfAborted as V,isAbortError as F,throwIfAbortError as j,whenOrAbort as z,isPromiseLike as H,throwIfDestroyed as q}from"../core/promiseUtils.js";import{R as U}from"../chunks/ReactiveSet.js";import{watch as B,initial as N,syncAndInitial as G,sync as W,when as $,whenOnce as Q,on as Z}from"../core/reactiveUtils.js";import{schedule as Y,s as K,M as X,m as J,addFrameTask as ee,P as te,setFrameDuration as ie,cleanupScheduling as se}from"../core/scheduling.js";import{b as re,c as ne,s as ae,g as oe,e as le,f as he}from"../chunks/screenUtils.js";import{cleanupWhereClauseCache as ce}from"../core/sql.js";import{x as de,p as ue,a3 as pe,a4 as me,U as ge,a5 as _e,E as fe,a2 as ye,m as ve,y as be,z as we}from"../chunks/unitUtils.js";import{initialize as xe}from"../core/workers/workers.js";import{property as Ce}from"../core/accessorSupport/decorators/property.js";import{cast as Te}from"../core/accessorSupport/decorators/cast.js";import{subclass as Se}from"../core/accessorSupport/decorators/subclass.js";import{a as Pe,e as Me,b as Re}from"../chunks/ensureType.js";import Oe from"../core/Accessor.js";import{g as De}from"../chunks/utils.js";import{c as Ae,n as Ee,e as Ie}from"../chunks/watch.js";import{z as Le,c as ke,f as Ve,b as Fe,d as je,U as ze,e as He,a as qe,Z as Ue,u as Be,g as Ne}from"../chunks/vec3f64.js";import{c as Ge}from"../chunks/PooledRBush.js";import{o as We}from"../chunks/GraphicsCollection.js";import $e from"../geometry/Extent.js";import Qe from"../geometry/HeightModelInfo.js";import Ze from"../geometry/Point.js";import{isLoadedOrLoadFor as Ye,requiresLoad as Ke,projectWithoutEngine as Xe,project as Je,canProjectWithoutEngine as et}from"../chunks/projectionUtils.js";import tt from"../geometry/SpatialReference.js";import{S as it,a as st,c as rt}from"../chunks/spatialReferenceEllipsoidUtils.js";import{p as nt}from"../chunks/projectBoundingRect.js";import{p as at}from"../chunks/projectPointToVector.js";import{l as ot,c as lt,e as ht,h as ct,D as dt,w as ut,k as pt,a as mt,n as gt,m as _t,v as ft,d as yt,C as vt,b as bt,q as wt,j as xt,g as Ct,f as Tt,G as St,H as Pt,t as Mt}from"../chunks/aaBoundingRect.js";import{l as Rt,v as Ot,r as Dt}from"../chunks/coordinateSystem.js";import{e as At}from"../chunks/scaleUtils.js";import{t as Et,H as It,C as Lt,G as kt,I as Vt,J as Ft,K as jt,L as zt,M as Ht}from"../chunks/layerUtils.js";import{T as qt}from"../chunks/TilemapCache.js";import{c as Ut}from"../portal/Portal.js";import Bt,{A as Nt}from"./View.js";import{W as Gt}from"../chunks/tagSymbols.js";import{BreakpointsOwner as Wt}from"./BreakpointsOwner.js";import{DOMContainer as $t}from"./DOMContainer.js";import Qt from"./GroundView.js";import{PopupView as Zt}from"./PopupView.js";import Yt from"./ViewAnimation.js";import{v as Kt,s as Xt}from"../chunks/ViewingMode.js";import{c as Jt,f as ei,r as ti}from"../chunks/asyncUtils.js";import{InternalRenderCategory as ii,s as si,b as ri,e as ni,f as ai,toRenderCamera as oi,F as li,fromRenderCamera as hi,c as ci,a as di,RenderCategory as ui,D as pi,g as mi,h as gi,i as _i,j as fi,k as yi,l as vi,m as bi,n as wi}from"./3d/webgl.js";import{Clonable as xi}from"../core/Clonable.js";import{c as Ci,e as Ti,r as Si,l as Pi,g as Mi,h as Ri,n as Oi,x as Di,y as Ai,z as Ei}from"../chunks/mathUtils.js";import{f as Ii,b as Li,a as ki,g as Vi,m as Fi}from"../chunks/mathUtils2.js";import{EventedAccessor as ji,EventEmitter as zi}from"../core/Evented.js";import{J as Hi,k as qi,s as Ui,i as Bi,n as Ni,d as Gi,m as Wi,l as $i,D as Qi,e as Zi,h as Yi,j as Ki,x as Xi,y as Ji,t as es,w as ts,q as is,c as ss,u as rs,v as ns,g as as,z as os,b as ls,r as hs,K as cs}from"../chunks/vec3.js";import{s as ds}from"../chunks/signal.js";import{f as us,t as ps,b as ms,c as gs,r as _s,e as fs,s as ys,m as vs,i as bs,d as ws}from"../chunks/mat3.js";import{H as xs,a as Cs,e as Ts,A as Ss,m as Ps,v as Ms,b as Rs,l as Os,t as Ds,c as As,i as Es,q as Is,p as Ls,h as ks,o as Vs}from"../chunks/mat4.js";import{c as Fs,I as js,f as zs}from"../chunks/mat4f64.js";import{s as Hs,w as qs,c as Us,u as Bs,d as Ns}from"../chunks/vec2.js";import{c as Gs,f as Ws,a as $s,Z as Qs,z as Zs}from"../chunks/vec2f64.js";import{f as Ys,a as Ks}from"../chunks/vec3f32.js";import{c as Xs,a as Js}from"../chunks/mat3f64.js";import{S as er,F as tr,P as ir,b as sr,c as rr,d as nr,C as ar}from"../chunks/CameraSpace.glsl.js";import{U as or,F as lr,T as hr,d as cr,i as dr,q as ur,G as pr,e as mr,p as gr,o as _r,V as fr,j as yr,s as vr}from"../chunks/Emissions.glsl.js";import{g as br,I as wr}from"../chunks/glsl.js";import{N as xr,ah as Cr,k as Tr,R as Sr,x as Pr,$ as Mr,ak as Rr,E as Or,a3 as Dr,T as Ar,aN as Er,aO as Ir,au as Lr,aP as kr,as as Vr,C as Fr,H as jr,a as zr,d as Hr,S as qr,b as Ur,g as Br,ad as Nr,q as Gr,aQ as Wr,D as $r,i as Qr,at as Zr,c as Yr,_ as Kr,n as Xr,j as Jr,aR as en,t as tn,o as sn,af as rn,aS as nn,m as an,p as on,u as ln,v as hn,w as cn,ai as dn,F as un,aw as pn}from"../chunks/Matrix4PassUniform.js";import{S as mn}from"../chunks/ShaderBuilder.js";import{m as gn,d as _n,g as fn,h as yn,s as vn,p as bn,a as wn,i as xn,u as Cn,c as Tn,e as Sn}from"../chunks/renderState.js";import{F as Pn,e as Mn,a as Rn}from"../chunks/FramebufferObject.js";import{a as On,b as Dn,T as An,f as En,h as In,c as Ln}from"../chunks/Texture.js";import{T as kn,Y as Vn,m as Fn,I as jn,a as zn,n as Hn}from"../chunks/Scheduler.js";import{C as qn,a as Un,D as Bn,P as Nn,c as Gn,R as Wn,d as $n,i as Qn,S as Zn,e as Yn,j as Kn}from"../chunks/enums.js";import{g as Xn,b as Jn,p as ea}from"../chunks/Indices.js";import{n as ta,g as ia}from"../chunks/InterleavedLayout.js";import sa from"./3d/webgl/RenderNode.js";import{V as ra}from"../chunks/VertexArrayObject2.js";import{b as na,a as aa}from"../chunks/VertexAttributeLocations.js";import{V as oa}from"../chunks/VertexBuffer.js";import{h as la}from"../chunks/weather.js";import{S as ha,O as ca,B as da,T as ua,o as pa,C as ma,a as ga,R as _a,V as fa,b as ya,c as va,e as ba,m as wa,r as xa,G as Ca,H as Ta,f as Sa}from"../chunks/RenderGeometry.js";import{p as Pa}from"../chunks/earthUtils.js";import{C as Ma,a as Ra,b as Oa,d as Da}from"../chunks/sunUtils.js";import{M as Aa,A as Ea,b as Ia,I as La}from"../chunks/SceneLighting.js";import ka from"./3d/environment/SunLighting.js";import Va from"./3d/environment/VirtualLighting.js";import Fa from"../webscene/Environment.js";import ja from"../webscene/SunLighting.js";import za from"../webscene/VirtualLighting.js";import{w as Ha,c as qa}from"../chunks/ray.js";import{l as Ua,h as Ba,n as Na,k as Ga,t as Wa,b as $a,g as Qa,o as Za,c as Ya,a as Ka}from"../chunks/sphere.js";import{H as Xa,h as Ja,b as eo,I as to,J as io,k as so,m as ro,L as no,K as ao,T as oo,t as lo,E as ho,M as co}from"../chunks/TextureCompressionTracker.js";import{c as uo,E as po,b as mo}from"../chunks/easing.js";import{A as go,e as _o,k as fo,b as yo,i as vo,l as bo,o as wo,D as xo,h as Co,B as To,I as So,P as Po,S as Mo,d as Ro,f as Oo}from"../chunks/Animation.js";import Do from"./3d/webgl/RenderCamera.js";import{I as Ao,t as Eo,d as Io,b as Lo,g as ko}from"../chunks/Intersector2.js";import{a as Vo,C as Fo}from"../chunks/Cyclical.js";import{f as jo,a as zo,e as Ho,s as qo,d as Uo}from"../chunks/vector.js";import{c as Bo,y as No,i as Go,f as Wo,g as $o,s as Qo,v as Zo,o as Yo}from"../chunks/plane.js";import{c as Ko,f as Xo,d as Jo}from"../chunks/ray2.js";import{I as el,P as tl,a as il,V as sl}from"../chunks/InputManager.js";import{s as rl,t as nl,b as al,i as ol,c as ll,v as hl,l as cl,a as dl}from"../chunks/vec4.js";import{c as ul,f as pl,Z as ml,b as gl,a as _l}from"../chunks/vec4f64.js";import fl from"../geometry/Polygon.js";import{create as yl,fromCamera as vl,toCameraSync as bl}from"../chunks/viewpointUtils2.js";import{i as wl,t as xl,j as Cl,k as Tl,f as Sl,l as Pl,v as Ml,z as Rl,h as Ol,d as Dl}from"../chunks/cameraUtils.js";import{C as Al}from"./ui/UI.js";import{m as El,f as Il}from"../chunks/unitFormatUtils.js";import Ll from"../widgets/Widget.js";import{j as kl}from"../chunks/widgetUtils.js";import{m as Vl}from"../chunks/messageBundle.js";import{t as Fl}from"../chunks/jsxFactory.js";import jl from"../core/Handles.js";import{F as zl,M as Hl,Z as ql,R as Ul,P as Bl}from"../chunks/ZoomMomentumEstimator.js";import{h as Nl,c as Gl,a as Wl,t as $l,B as Ql,j as Zl}from"../chunks/boundedPlane.js";import{U as Yl}from"../chunks/UpdatingHandles.js";import{i as Kl,P as Xl}from"../chunks/PooledArray.js";import{d as Jl}from"../chunks/debugFlags2.js";import{H as eh,S as th,F as ih}from"../chunks/HUDMaterial.js";import{a as sh}from"../chunks/hydratedFeatures.js";import{c as rh}from"../chunks/labelFormatUtils.js";import{b as nh}from"../chunks/calloutUtils.js";import{c as ah,j as oh,o as lh,m as hh,O as ch,f as dh,s as uh}from"../chunks/aaBoundingBox.js";import{L as ph,T as mh,a as gh,b as _h,G as fh,W as yh,N as vh,C as bh}from"../chunks/NormalUtils.glsl.js";import{d as wh,e as xh,f as Ch,T as Th,t as Sh}from"../chunks/placementUtils.js";import{W as Ph,P as Mh,g as Rh,h as Oh}from"../chunks/RibbonLineMaterial.js";import{a as Dh,c as Ah,o as Eh}from"../chunks/layerViewUtils.js";import{m as Ih,d as Lh,f as kh,g as Vh,e as Fh}from"../chunks/HighlightDefaults.js";import{q as jh}from"../chunks/elevationInfoUtils.js";import{c as zh,t as Hh,h as qh}from"../chunks/hitTest.js";import{i as Uh,I as Bh}from"../chunks/HUDIntersectorResult.js";import{g as Nh}from"../chunks/ElevationProvider.js";import{h as Gh}from"../chunks/hitTestSelectUtils.js";import{R as Wh}from"../chunks/RenderCoordsHelper.js";import{M as $h,b as Qh,N as Zh}from"../chunks/MemCache.js";import Yh from"../request.js";import{D as Kh,h as Xh,m as Jh,B as ec,X as tc,o as ic}from"../chunks/BufferView.js";import{a as sc,b as rc,d as nc,e as ac,f as oc,n as lc,o as hc,h as cc,j as dc,k as uc,l as pc,r as mc,w as gc,m as _c,p as fc,i as yc,q as vc,s as bc,x as wc,y as xc,z as Cc,A as Tc,B as Sc,C as Pc,D as Mc,E as Rc,F as Oc,G as Dc,H as Ac,I as Ec,J as Ic,K as Lc,L as kc,M as Vc,N as Fc,O as jc,P as zc,Q as Hc,R as qc,S as Uc,c as Bc}from"../chunks/terrainUtils.js";import Nc from"./3d/support/SceneViewPerformanceInfo.js";import{D as Gc}from"../chunks/DefaultLoadingContext.js";import{l as Wc}from"../chunks/wosrLoader.js";import{isSVG as $c}from"../core/urlUtils.js";import Qc from"../Graphic.js";import"../geometry/Polyline.js";import Zc from"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3D.js";import"../symbols/LineSymbol3DLayer.js";import Yc from"../symbols/PointSymbol3D.js";import Kc from"../symbols/TextSymbol3DLayer.js";import{m as Xc}from"../chunks/mapCollectionUtils.js";import Jc from"../Color.js";import{C as ed}from"../chunks/CollectionFlattener.js";import{O as td}from"../chunks/ObjectPool.js";import{g as id}from"../chunks/projectBuffer.js";import{p as sd}from"../chunks/projectVectorToVector.js";import{b as rd,o as nd,e as ad,h as od}from"../chunks/frustum.js";import{E as ld}from"../chunks/ElevationQueryTileCache.js";import{E as hd}from"../chunks/ElevationSamplerData.js";import{e as cd,w as dd,a as ud,b as pd,c as md,p as gd,T as _d,m as fd,t as yd,d as vd,f as bd}from"../chunks/TerrainConst.js";import{y2lat as wd}from"../geometry/support/webMercatorUtils.js";import{f as xd,G as Cd}from"../chunks/GridLocalOriginFactory.js";import{g as Td,s as Sd,a as Pd}from"../chunks/MapUtils.js";import{O as Md}from"../chunks/intersectorUtilsConversions.js";import{N as Rd}from"../chunks/NestedMap.js";import{V as Od,c as Dd,d as Ad,t as Ed,N as Id,O as Ld,E as kd,l as Vd,n as Fd,p as jd,q as zd,T as Hd,r as qd,v as Ud,M as Bd,w as Nd,m as Gd,C as Wd,x as $d,S as Qd,a as Zd,y as Yd,z as Kd,A as Xd,B as Jd,h as eu,F as tu}from"../chunks/DefaultMaterial.js";import{d as iu,c as su}from"../chunks/Normals.js";import{B as ru}from"../chunks/BufferObject.js";import{h as nu,M as au,j as ou,T as lu,k as hu,e as cu,f as du,l as uu,m as pu,g as mu,n as gu,V as _u,o as fu}from"../chunks/VertexColor.glsl.js";import{n as yu}from"../chunks/DoubleArray.js";import{t as vu}from"../chunks/common.js";import"../chunks/TileStrategy.js";import{T as bu}from"../chunks/TileKey2.js";import{t as wu,a as xu,c as Cu}from"../chunks/constants3.js";import{c as Tu}from"../chunks/mat3f32.js";import{S as Su,a as Pu,C as Mu,w as Ru}from"../chunks/SymbolRepository.js";import{R as Ou}from"../chunks/RenderableTile.js";import{T as Du,l as Au}from"../chunks/resources.js";import{W as Eu}from"../chunks/WorkerHandle.js";import{V as Iu,a as Lu}from"../chunks/orientedBoundingBox.js";import{a as ku}from"../chunks/AlphaCutoff.js";import{p as Vu,a as Fu,u as ju}from"../chunks/floatRGBA.js";import{u as zu}from"../chunks/colorUtils2.js";import Hu from"../webscene/background/ColorBackground.js";import{R as qu}from"../chunks/sdfPrimitives.js";import{u as Uu}from"../chunks/graphicUtils.js";import{d as Bu}from"../chunks/vec32.js";import{c as Nu}from"../chunks/vec33.js";import{d as Gu}from"../chunks/symbolColorUtils.js";import{c as Wu}from"../chunks/quat.js";import{c as $u}from"../chunks/quatf64.js";import{a as Qu,C as Zu,b as Yu,c as Ku,B as Xu,p as Ju}from"../chunks/BlendColorsPremultiplied.glsl.js";import{r as ep}from"../chunks/requestImageUtils.js";import{f as tp,g as ip}from"../chunks/assets.js";import{Z as sp}from"../chunks/vec4f32.js";import rp,{M as np,a as ap}from"./3d/webgl/ManagedFBO.js";import{h as op}from"../chunks/testSVGPremultipliedAlpha.js";import{R as lp,A as hp}from"../chunks/RenderingContext.js";import{R as cp}from"../chunks/RenderingContextOptions.js";import{i as dp}from"../chunks/ITexture.js";import{resampleHermite as up}from"../chunks/screenshotUtils.js";import{c as pp}from"../chunks/imageUtils.js";import{c as mp}from"../chunks/edgePreprocessing.js";import{b as gp}from"../chunks/drapedUtils.js";import _p from"./support/HighlightOptions.js";import{i as fp,a as yp}from"../chunks/screenUtils2.js";import{i as vp}from"../chunks/spatialReferenceSupport.js";import{m as bp}from"../chunks/makeScheduleFunction.js";import{c as wp}from"../chunks/WebGLRequirements.js";import xp from"./ui/DefaultUI.js";import"../CameraLayout.js";import"../chunks/get.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/nextTick.js";import"../chunks/object.js";import"../chunks/SetUtils.js";import"../chunks/SimpleTrackingTarget.js";import"../config.js";import"../chunks/string.js";import"../chunks/Warning.js";import"../core/JSONSupport.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../geometry/Geometry.js";import"../chunks/jsonMap.js";import"../chunks/pe.js";import"../kernel.js";import"../chunks/jsonUtils.js";import"../chunks/persistableUrlUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../chunks/coordsUtils.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/typeUtils.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../core/workers/Connection.js";import"../chunks/Queue.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"../chunks/date.js";import"../chunks/locale.js";import"../chunks/constants.js";import"../chunks/datetime.js";import"../chunks/number.js";import"../chunks/substitute.js";import"../chunks/messages.js";import"../chunks/quickselect.js";import"../chunks/collectionUtils.js";import"../chunks/projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/geodesicConstants.js";import"../layers/catalog/catalogUtils.js";import"../chunks/LRUCache.js";import"../chunks/TileKey.js";import"../chunks/memoryEstimations.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../Map.js";import"../Basemap.js";import"../chunks/loadAll.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/basemapDefinitions.js";import"../support/BasemapStyle.js";import"../chunks/writeUtils.js";import"../Ground.js";import"../chunks/enumeration.js";import"../chunks/groundInstanceUtils.js";import"../chunks/opacityUtils.js";import"../chunks/colorUtils.js";import"../effects/FocusAreas.js";import"../effects/FocusArea.js";import"../chunks/uuid.js";import"../chunks/persistable.js";import"../chunks/MD5.js";import"../chunks/multiOriginJSONSupportUtils.js";import"../chunks/resourceExtension.js";import"../effects/FocusAreaOutline.js";import"../chunks/PolygonCollection.js";import"../chunks/editableLayers.js";import"../chunks/basemapEnsureType.js";import"../chunks/basemapUtils.js";import"../chunks/utils5.js";import"../chunks/collectionUtils2.js";import"../support/LayersMixin.js";import"../layers/Layer.js";import"../core/Identifiable.js";import"../time/TimeExtent.js";import"../chunks/timeUtils.js";import"../support/TablesMixin.js";import"../chunks/timeZoneUtils.js";import"./BasemapView.js";import"./Magnifier.js";import"../chunks/SelectionManager.js";import"../chunks/ReactiveMap.js";import"../rest/support/Query.js";import"../chunks/DataLayerSource.js";import"../layers/support/Field.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/fieldType.js";import"../chunks/FullTextSearch.js";import"../chunks/spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../chunks/selectionUtils.js";import"./Theme.js";import"../chunks/ViewEvents.js";import"../chunks/keybindings.js";import"./input/Input.js";import"./input/gamepad/GamepadSettings.js";import"./input/gamepad/GamepadInputDevice.js";import"./navigation/Navigation.js";import"../chunks/a11yUtils.js";import"./navigation/NavigationActionMap.js";import"./navigation/gamepad/GamepadSettings.js";import"../chunks/heightModelInfoUtils.js";import"../chunks/projectionUtils2.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"../chunks/guards.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../chunks/createFeatureId.js";import"../chunks/typeUtils2.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils3.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils4.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../symbols/LineStyleMarker3D.js";import"../chunks/lineMarkers.js";import"../symbols/Font.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../chunks/projector.js";import"../chunks/sanitizerUtils.js";import"../layers/support/ElevationSampler.js";import"../chunks/projectVectorToPoint.js";import"../chunks/dehydratedPoint.js";import"../chunks/computeTranslationToOriginAndRotation.js";import"../chunks/lineSegment.js";import"../chunks/dehydratedFeatureUtils.js";import"../layers/support/LOD.js";import"../layers/support/TileInfo.js";import"../chunks/VertexElementDescriptor.js";import"../chunks/triangle.js";import"../chunks/lengthUtils.js";import"../chunks/videoUtils.js";import"../chunks/debugFlags.js";import"../chunks/types.js";import"../chunks/VertexArrayObject.js";import"./3d/environment/CloudyWeather.js";import"./3d/environment/FoggyWeather.js";import"./3d/environment/RainyWeather.js";import"./3d/environment/SnowyWeather.js";import"./3d/environment/SunnyWeather.js";import"../chunks/axisAngleDegrees.js";import"../chunks/SunCalc.js";import"../chunks/lightingTypes.js";import"../webscene/background/Background.js";import"../chunks/ElevationContext.js";import"../chunks/unitConversionUtils.js";import"../chunks/vec2f32.js";import"../chunks/HUDVisibility.glsl.js";import"../chunks/BooleanBindUniform.js";import"../chunks/dehydratedFeatures.js";import"../chunks/quantizationUtils.js";import"../chunks/featureConversionUtils.js";import"../chunks/OptimizedFeature.js";import"../chunks/OptimizedGeometry.js";import"../chunks/OptimizedFeatureSet.js";import"../chunks/primitiveObjectSymbolUtils.js";import"../chunks/Intersector.js";import"../chunks/unitBezier.js";import"../chunks/modeUtils.js";import"../chunks/quantityUtils.js";import"../chunks/componentsUtils.js";import"../chunks/jsxWidgetSupport.js";import"../chunks/labelUtils.js";import"../chunks/ArcadeExpression.js";import"../chunks/TimeOnly.js";import"../chunks/enum.js";import"../chunks/UnknownTimeZone.js";import"../layers/support/FieldsIndex.js";import"../chunks/fontUtils.js";import"../chunks/Octree.js";import"../chunks/LayerConstants.js";import"../chunks/LayerViewPerformanceInfo.js";import"./3d/support/LayerPerformanceInfo.js";import"../chunks/Version.js";import"../chunks/Matrix4sPassUniform.js";import"../chunks/ScheduledQueueProcessor.js";import"../chunks/config.js";import"../chunks/TiledDisplayObject.js";import"../chunks/DisplayObject.js";import"../chunks/definitions.js";import"../chunks/GeometryUtils.js";import"../chunks/meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../geometry/support/MeshLocalVertexSpace.js";import"../chunks/ProgramCache.js";import"../chunks/Program.js";import"../chunks/capabilities2.js";import"../widgets/Attribution.js";import"../widgets/Attribution/AttributionViewModel.js";import"../chunks/globalCss.js";import"../chunks/accessibleHandler.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"../chunks/utils24.js";import"../widgets/support/GoTo.js";import"../chunks/goToUtils.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";function Cp(e,t){const i=De(e),s=De(t),r=i.store,n=s.store,a=s.metadata;for(const t in a){const i=a[t],s=r.originOf(t),o=n.originOf(t);if(!i.readOnly&&0!==o){if(0!==s){const e=r.get(t),i=n.get(t);e&&i&&i instanceof Oe&&e instanceof Oe&&e instanceof i.constructor&&Cp(e,i);continue}e.set(t,n.get(t))}}}const Tp=()=>import("../chunks/TileLayerView3D.js"),Sp=()=>import("../chunks/ElevationLayerView3D.js"),Pp={"base-dynamic":()=>import("../chunks/BaseDynamicLayerView3D.js"),"base-elevation":Sp,"base-tile":Tp,"bing-maps":Tp,"building-scene":()=>import("../chunks/BuildingSceneLayerView3D.js"),catalog:()=>import("../chunks/CatalogLayerView3D.js"),"catalog-dynamic-group":()=>import("../chunks/CatalogDynamicGroupLayerView3D.js"),"catalog-footprint":()=>import("../chunks/CatalogFootprintLayerView3D.js"),csv:()=>import("../chunks/CSVLayerView3D.js"),dimension:()=>import("../chunks/DimensionLayerView3D.js"),elevation:Sp,feature:()=>import("../chunks/FeatureLayerView3D.js"),"gaussian-splat":()=>import("../chunks/GaussianSplatLayerView3D.js"),geojson:()=>import("../chunks/GeoJSONLayerView3D.js"),graphics:()=>import("../chunks/GraphicsLayerView3D.js"),group:()=>import("../chunks/GroupLayerView3D.js"),imagery:()=>import("../chunks/ImageryLayerView3D.js"),"integrated-mesh":()=>import("../chunks/IntegratedMeshLayerView3D.js"),"integrated-mesh-3dtiles":()=>import("../chunks/IntegratedMesh3DTilesLayerView3D.js"),"line-of-sight":()=>import("../chunks/LineOfSightLayerView3D.js"),"map-image":()=>import("../chunks/MapImageLayerView3D.js"),media:()=>import("../chunks/MediaLayerView3D.js").then(e=>e.M),"ogc-feature":()=>import("../chunks/OGCFeatureLayerView3D.js"),"open-street-map":Tp,"oriented-imagery":()=>import("../chunks/FeatureLayerView3D.js"),"point-cloud":()=>import("../chunks/PointCloudLayerView3D.js"),viewshed:()=>import("../chunks/ViewshedLayerView3D.js"),voxel:()=>import("../chunks/VoxelLayerView3D.js"),route:()=>import("../chunks/RouteLayerView3D.js"),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?import("../chunks/SceneLayerView3D.js"):import("../chunks/SceneLayerGraphicsView3D.js"),stream:()=>import("../chunks/StreamLayerView3D.js"),tile:Tp,"imagery-tile":()=>import("../chunks/ImageryTileLayerView3D.js"),"vector-tile":()=>import("../chunks/VectorTileLayerView3D.js"),wcs:()=>import("../chunks/ImageryTileLayerView3D.js"),"web-tile":Tp,wfs:()=>import("../chunks/WFSLayerView3D.js"),wms:()=>import("../chunks/WMSLayerView3D.js"),wmts:()=>import("../chunks/WMTSLayerView3D.js"),"geo-rss":null,kml:null,"knowledge-graph-sublayer":null,"knowledge-graph":null,"link-chart":null,"map-notes":null,parquet:null,"subtype-group":null,unknown:null,unsupported:null,video:null},Mp="analyses-owner-handles";let Rp=class extends Oe{constructor(e){super(e),this._allAnalysisViews=new s,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=Op(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"elevation-profile":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null},"volume-measurement":{module:null}},this._emitOnView=(e,t)=>this.view.emit(e,t)}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(A("AnalysisViewManager was destroyed")),this._set("view",null)}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(A()),this._attachedToViewResolver=Op()}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(null==t||1===t.state.list)throw new n("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),Mp)}_disconnectOwners(){this.removeHandles(Mp),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const t of e)this._addAnalysis(t);const t=e.on("after-add",e=>this._addAnalysis(e.item)),i=e.on("after-remove",e=>this._removeAnalysis(e.item));return o(()=>{t.remove(),i.remove();for(const t of e)this._removeAnalysis(t)})}_addAnalysis(e){const t=this._items.get(e);if(null==t){const t={state:{view:0,list:0},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,t),t.createAnalysisViewTask=Jt(i=>this._createAnalysisViewPromise(t,i).then(t=>(this._emitOnView("analysis-view-create",{analysis:e,analysisView:t}),t),t=>{throw this._emitOnView("analysis-view-create-error",{analysis:e,error:t}),t}))}else t.state.list=0}_removeAnalysis(e){const t=this._items.get(e);null!=t?(t.state.list=1,this._scheduleUpdate()):C.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){null==this._scheduledUpdateHandle&&(this._scheduledUpdateHandle=Y(()=>this._update()))}_update(){this._scheduledUpdateHandle=T(this._scheduledUpdateHandle),this._items.forEach(e=>{if(1!==e.state.list)return;const{analysis:t,view:i}=e;switch(this._items.delete(t),e.state.view){case 0:e.createAnalysisViewTask=P(e.createAnalysisViewTask);break;case 1:null!=i&&(this._allAnalysisViews.remove(i),e.view=S(i),e.createAnalysisViewTask=null,this._emitOnView("analysis-view-destroy",{analysis:t,analysisView:i}))}})}async _createAnalysisViewPromise(e,t){const i=e.analysis,s=i.type,r=this._analysisModules[s];if(this._creatingViewCount+=1,null==r.module)try{r.module=await this._loadAnalysisModule(s)}catch(e){throw this._creatingViewCount-=1,e}if(E(t))throw this._creatingViewCount-=1,A("AnalysisView creation aborted");const n=new r.module.default({analysis:i,view:this.view});let a=!0;I(t,()=>{a&&this._destroyAnalysisView(i,n)});try{await n.when()}catch(e){throw a=!1,this._destroyAnalysisView(i,n),e}if(E(t))throw A();return a=!1,e.view=n,e.state.view=1,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_destroyAnalysisView(e,t){t.destroyed||(this._creatingViewCount-=1,t.destroy(),this._emitOnView("analysis-view-destroy",{analysis:e,analysisView:t}))}_loadAnalysisModule(e){switch(e){case"area-measurement":return import("./3d/analysis/AreaMeasurementAnalysisView3D.js");case"dimension":return import("./3d/analysis/DimensionAnalysisView3D.js");case"direct-line-measurement":return import("./3d/analysis/DirectLineMeasurementAnalysisView3D.js");case"elevation-profile":return import("./3d/analysis/ElevationProfileAnalysisView3D.js");case"line-of-sight":return import("./3d/analysis/LineOfSightAnalysisView3D.js");case"slice":return import("./3d/analysis/SliceAnalysisView3D.js");case"viewshed":return import("./3d/analysis/ViewshedAnalysisView3D.js");case"volume-measurement":return import("./3d/analysis/VolumeMeasurementAnalysisView3D.js")}}};function Op(){const e=L();return e.promise.catch(()=>{}),e}e([Ce()],Rp.prototype,"updating",null),e([Ce({constructOnly:!0})],Rp.prototype,"view",void 0),e([Ce()],Rp.prototype,"_allAnalysisViews",void 0),e([Ce()],Rp.prototype,"_creatingViewCount",void 0),Rp=e([Se("esri.views.3d.analysis.AnalysisViewManager3D")],Rp);const Dp=Rp;let Ap=class extends Oe{constructor(e){super(e),this.collision=new kp,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return 2===this.mode?null:this._get("altitude")||null}set altitude(e){2!==this.mode?this._set("altitude",e):C.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(e){return this.altitude?Ci(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return Ci(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return 2===this.mode?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=Lp)=>(i.min=Ip.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?Ii([[4e3,Ip.max],[1e4,Ti(88)],[6e6,Ti(88)]]):()=>Ip.max;return(t,i=Lp)=>(i.min=Ip.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?Ii([[4e3,Ip.max],[5e4,Ti(88)],[6e6,Ti(88)],[2e7,Ip.min]]):Ii([[3e5,Ip.max],[3e6,Ti(88)],[6e6,Ti(88)],[2e7,Ip.min]]);return(t,i=Lp)=>(i.min=Ip.min,i.max=e(t),i)}};e([Ce()],Ap.prototype,"altitude",null),e([Ce({readOnly:!0})],Ap.prototype,"collision",void 0),e([Ce()],Ap.prototype,"distance",void 0),e([Ce({readOnly:!0})],Ap.prototype,"minimumPoiDistance",void 0),e([Ce()],Ap.prototype,"tilt",void 0),e([Ce({constructOnly:!0})],Ap.prototype,"state",void 0),Ap=e([Se("esri.views.3d.state.Constraints")],Ap);const Ep={min:-2e5,max:4*de.radius},Ip={min:Ti(.5),max:Ti(179.5)},Lp={min:0,max:0};let kp=class extends Oe{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};e([Ce({type:Boolean})],kp.prototype,"enabled",void 0),e([Ce({type:Number})],kp.prototype,"elevationMargin",void 0),kp=e([Se("esri.views.3d.state.Constraints.CollisionConstraint")],kp);let Vp=class extends xi{constructor(){super(...arguments),this.min=Ep.min,this.max=Ep.max}};e([Ce({type:Number})],Vp.prototype,"min",void 0),e([Ce({type:Number})],Vp.prototype,"max",void 0),Vp=e([Se("esri.views.3d.constraints.AltitudeConstraint")],Vp);let Fp=class extends xi{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};e([Ce({type:Number,value:1e-8})],Fp.prototype,"near",null),e([Te("near")],Fp.prototype,"castNear",null),e([Ce({type:Number,value:1e-8})],Fp.prototype,"far",null),e([Te("far")],Fp.prototype,"castFar",null),e([Ce({type:["auto","manual"]})],Fp.prototype,"mode",void 0),Fp=e([Se("esri.views.3d.constraints.ClipDistanceConstraint")],Fp);const jp={min:Si(Ip.min),max:Si(Ip.max)};let zp=class extends xi{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return Ci(e,jp.min,jp.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};e([Ce({type:["auto","manual"]})],zp.prototype,"mode",void 0),e([Ce({type:Number,value:jp.max})],zp.prototype,"max",null),e([Te("max")],zp.prototype,"castMax",null),zp=e([Se("esri.views.3d.constraints.TiltConstraint")],zp);let Hp=class extends xi{constructor(e){super(e),this.tilt=new zp,this.altitude=new Vp,this.clipDistance=new Fp}};function qp(e){return ue(e,it)||pe(e)?{wkid:104971}:ue(e,st)||me(e)?{wkid:104903}:tt.WGS84}e([Ce({type:zp})],Hp.prototype,"tilt",void 0),e([Ce({type:Vp})],Hp.prototype,"altitude",void 0),e([Ce({type:Fp})],Hp.prototype,"clipDistance",void 0),Hp=e([Se("esri.views.3d.constraints.Constraints")],Hp);class Up{constructor(e,t,i,s,r,n,a,o,l=.5){this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=s,this.detailSize=r,this.smoothness=n,this.cloudHeight=a,this.raymarchingSteps=o,this.median=l}}const Bp={sunny:new Up([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],0),cloudy:new Up([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],2,.6),rainy:new Up([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],2,.4),snowy:new Up([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],1,.65),foggy:new Up([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],0)};Bp.default=Bp.sunny;const Np=h("esri-mobile")?64:128,Gp=Np/128,Wp=Math.ceil(Math.sqrt(Np)),$p=(Np+2)*Wp,Qp=128,Zp=$p/1560;class Yp extends or{constructor(e,t){super(e,"bool",1,(i,s,r)=>i.setUniform1b(e,t(s,r)))}}function Kp(e){e.code.add(br`vec2 sphereIntersect(vec3 start, vec3 dir, float distance) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * distance;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`)}class Xp extends xr{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.lastSlice=!1,this.viewMatrix=Xs()}}const Jp=h("esri-mobile")?1024:2048,em=Gs(),tm=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:Xp,build:function(e){const t=new mn;t.include(er,!1);const i=t.fragment;return i.include(Kp),i.uniforms.add(new lr("cloudRadius",e=>e.cloudRadius),new lr("power",e=>Pi(35,120,e.absorption)),new lr("sigmaE",e=>1+e.absorption),new lr("density",e=>Pi(0,.3,e.density)),new lr("cloudSize",e=>Pi(0,.02,Math.max(.01,1-e.cloudSize))),new lr("detailSize",e=>Pi(0,.2,Math.max(.01,1-e.detailSize))),new lr("smoothness",e=>Pi(0,.5,1-e.smoothness)),new lr("cloudHeight",e=>Pi(0,1500,e.cloudHeight)),new lr("coverage",e=>e.coverage),new Cr("view",e=>e.viewMatrix),new hr("cloudShapeTexture",e=>null!=e.noiseTexture?e.noiseTexture.textureAtlas:null),new tr("cloudVariables",e=>Hs(em,e.coverage,e.absorption)),new Yp("lastSlice",e=>e.lastSlice)),i.constants.add("halfCubeMapSize","float",.5*Jp),i.code.add(br`
    const int STEPS = ${0===e.steps?br`16`:1===e.steps?br`100`:br`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord;
      xy.x -= halfCubeMapSize;
      xy.y = lastSlice ? fragCoord.y - halfCubeMapSize : fragCoord.y;

      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),i.code.add(br`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${br.float($p)};
      const float dataWidth = ${br.float($p)};
      const float tileRows = ${br.float(Wp)};
      const vec3 atlasDimensions = vec3(${br.float(Np)}, ${br.float(Np)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${br.float(Gp)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${br.float(Zp)} * p) / ${br.float($p)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),i.code.add(br`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),i.code.add(br`float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}
float multipleOctaves(float extinction, float mu, float stepL) {
float attenuation = 1.0;
float contribution = 1.0;
float phaseAttenuation = 1.0;
float luminance = 0.0;
for (int i = 0; i < 4; i++) {
float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
attenuation *= 0.2;
contribution *= 0.6;
phaseAttenuation *= 0.5;
}
return luminance;
}`),i.code.add(br`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),i.code.add(br`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),i.main.add(br`if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
float cloudDistance = cloudRadius + cloudStart;
float rayStartDistance = dot(viewPos, viewPos) - (cloudDistance * cloudDistance);
vec2 rayStartIntersect = sphereIntersect(viewPos, rayDir, rayStartDistance);
float rayEndDistance = dot(viewPos, viewPos) - ((cloudDistance + cloudHeight) * (cloudDistance + cloudHeight));
vec2 rayEndIntersect = sphereIntersect(viewPos, rayDir, rayEndDistance);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);`),t},cubeMapSize:Jp},Symbol.toStringTag,{value:"Module"}));class im extends Tr{constructor(e,t){super(e,t,new Sr(tm,()=>Promise.resolve().then(()=>tm)),ir)}initializePipeline(e){return gn({blending:fn(32769,32770,32774,0===e.writeTextureChannels?[1,1,0,0]:[0,0,1,1]),depthTest:{func:515},colorWrite:_n})}}class sm extends Mr{constructor(){super(...arguments),this.steps=0,this.writeTextureChannels=0}}e([Pr({count:3})],sm.prototype,"steps",void 0),e([Pr({count:2})],sm.prototype,"writeTextureChannels",void 0);class rm extends xr{constructor(){super(...arguments),this.weatherTile=Ws(0,0)}}const nm=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:rm,build:function(e){const t=new mn;if(t.include(er,!1),t.fragment.code.add(br`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),0===e.mode){const e=2,i=8;t.fragment.code.add(br`float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),t.fragment.code.add(br`vec3 modulo(vec3 m, float n) {
return mod(mod(m, n) + n, n);
}
vec3 hash(vec3 p3, float frequency) {
p3 = modulo(p3, frequency);
p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yxz + 33.33);
return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
}`),t.fragment.code.add(br`vec3 fade(vec3 t) {
return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
}`),t.fragment.code.add(br`
    float gradientNoise(vec3 p, float frequency) {
      vec3 i = floor(p);
      vec3 f = fract(p);
      vec3 u = fade(f);
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequency = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequency;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${br.float(Wp)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${br.float(i)});

      float worley0 = worley(p, ${br.float(e)} * 2.0);
      float worley1 = worley(p, ${br.float(e)} * 8.0);
      float worley2 = worley(p, ${br.float(e)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${br.float(e)});
      float worley1 = worley(p, ${br.float(e)} * 2.0);
      float worley2 = worley(p, ${br.float(e)} * 4.0);
      float worley3 = worley(p, ${br.float(e)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)}return t.fragment.uniforms.add(new tr("weatherTile",e=>e.weatherTile)).code.add(br`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${br.float(Qp)});

      // Get global coordinates of p
      p += weatherTile * ${br.float(Qp)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${br.float(1e5)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),0===e.mode?t.fragment.main.add(br`
      float padWidth = 1.0;
      float paddedSize = ${br.float(Np)} + 2.0 * padWidth;
      float tileCount = ${br.float(Wp)} * ${br.float(Wp)};
      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

      bool padCell = false;
      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      bool startPadX = false;
      bool startPadY = false;
      bool endPadX = false;
      bool endPadY = false;

      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
        startPadX = true;
      }

      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
        startPadY = true;
      }

      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
        endPadX = true;
      }

      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
        endPadY = true;
      }

      vec2 padding = vec2(2.0 * padWidth) * tile;
      vec2 uv;

      if (padCell) {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;

        if (startPadX) {
          pixel.x += ${br.float(Np)};
        }

        if (startPadY) {
          pixel.y += ${br.float(Np)};
        }

        if (endPadX) {
          pixel.x -= ${br.float(Np)};
        }

        if (endPadY) {
          pixel.y -= ${br.float(Np)};
        }

        uv = vec2(pixel.xy / ${br.float(Np)});
      } else {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;
        uv = vec2(pixel.xy / ${br.float(Np)});
      }

      vec3 p_ = get3Dfrom2D(uv);
      vec3 p = p_;
      p.z /= (${br.float(Wp)} * ${br.float(Wp)});

      float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      float worleyNoise = getTextureForPointWorley(p);

      fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      p_ = mod(p_ + 1.0, ${br.float(Wp)} * ${br.float(Wp)});
      p = p_;
      p.z /= (${br.float(Wp)} * ${br.float(Wp)});

      worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      worleyNoise = getTextureForPointWorley(p);

      fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      vec2 mapUV = ${br.float(Qp)} * (gl_FragCoord.xy / ${br.float($p)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor.ba = vec2(0.0, map);
      `):t.fragment.main.add(br`
      vec2 mapUV = ${br.float(Qp)} * (gl_FragCoord.xy / ${br.float($p)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor = vec4(map);
    `),t}},Symbol.toStringTag,{value:"Module"}));class am extends Mr{constructor(){super(...arguments),this.mode=0}}e([Pr({count:2})],am.prototype,"mode",void 0);class om extends Tr{constructor(e,t){super(e,t,new Sr(nm,()=>Promise.resolve().then(()=>nm)),ir)}initializePipeline(e){return gn({blending:0===e.mode?yn:vn(0,1,1,0),depthTest:{func:519},colorWrite:_n})}}let lm=class extends Oe{constructor(e){super(e),this._needsRender=!0,this._passParameters=new rm,this._configuration=new am,this._fbo=new Pn(e.context.renderContext.rctx,new On($p)),e.context.techniques.precompile(om,new am);const t=new am;t.mode=1,e.context.techniques.precompile(om,t)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?1:0;const e=this.context.techniques.get(om,this._configuration);return e.compiled&&(this._texture=this._render(e)),this._texture}updateWeatherMap(e){qs(this._passParameters.weatherTile,e)||(Us(this._passParameters.weatherTile,e),this._needsRender=!0)}destroy(){this._fbo=M(this._fbo)}_render(e){if(!this._fbo)return null;const t=this.context.renderContext.rctx,i=t.getViewport();return t.setViewport(0,0,$p,$p),t.bindFramebuffer(this._fbo),t.bindTechnique(e,this.context.renderContext.bind,this._passParameters),t.screen.draw(),t.setViewport(i.x,i.y,i.width,i.height),this._needsRender=!1,this._fbo.colorTexture}};e([Ce({constructOnly:!0})],lm.prototype,"context",void 0),lm=e([Se("esri.views.3d.environment.NoiseTextureAtlas")],lm);let hm=class extends Oe{constructor(e){super(e),this._state=ds(0),this._passParameters=new Xp,this._weatherTileCount=128,this._sliceIndex=0,this._tileIndex=0,this._tilesPerSlice=1,this.coverage=Pi(Bp.default.coverage[0],Bp.default.coverage[1],.5),this.density=Pi(Bp.default.density[0],Bp.default.density[1],.5),this.absorption=Pi(Bp.default.absorption[0],Bp.default.absorption[1],.5),this.cloudSize=Pi(Bp.default.cloudSize[0],Bp.default.cloudSize[1],.5),this.detailSize=Pi(Bp.default.detailSize[0],Bp.default.detailSize[1],.5),this.smoothness=Pi(Bp.default.smoothness[0],Bp.default.smoothness[1],.5),this.cloudHeight=Pi(Bp.default.cloudHeight[0],Bp.default.cloudHeight[1],.5),this.raymarchingSteps=Bp.default.raymarchingSteps,this._viewMatrix=Fs(),this._dirty=!0,this.readyToRun=!0,this._configuration=new sm}initialize(){const e=ge(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius;const t=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(kn.CLOUDS_GENERATOR,this),B(()=>this.coverage,t,N),B(()=>this.density,t,N),B(()=>this.absorption,t,N),B(()=>this.cloudSize,t,N),B(()=>this.detailSize,t,N),B(()=>this.smoothness,t,N),B(()=>this.cloudHeight,t,N),B(()=>this.raymarchingSteps,t,N)]);const i=$s(this._computeWeatherTile());let s=0;this.addHandles(B(()=>{const e=this._computeWeatherTile();return qs(i,e)||(++s,Us(i,e)),s},t))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=S(this._passParameters.noiseTexture)}_precompile(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=0,this.context.techniques.precompile(im,this._configuration),this._configuration.writeTextureChannels=1,this.context.techniques.precompile(im,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case 0:this._tilesPerSlice=1;break;case 1:this._tilesPerSlice=4;break;case 3:case 2:this._tilesPerSlice=8;break;default:c(this.raymarchingSteps)}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.get(im,this._configuration)}_computeWeatherTile(){const{camera:e,environment:t}=this.view,{latitude:i,longitude:s}=e.position;if(null==i||null==s)return Qs;Hs(pm,(i+90)/180,(s+180)/360);const r=Math.floor(this._weatherTileCount*Math.abs(2*pm[0]-1));pm[0]=Math.floor(2*this._weatherTileCount*pm[0]),pm[1]=Math.floor(4*(this._weatherTileCount-r)*pm[1]);let n=0,a=0;if("virtual"!==t?.lighting?.type&&null!=t?.lighting?.date){const e=new Date(t.lighting.date);e.setUTCHours(t.lighting.date.getUTCHours()+(t.lighting.displayUTCOffset??0)),n=31*e.getUTCMonth()+e.getUTCDate(),a=e.getUTCFullYear()}return pm[0]=(pm[0]+n)%(2*this._weatherTileCount),pm[1]=(pm[1]+a%100)%(4*this._weatherTileCount),pm}get state(){return this._state.value}set state(e){this._state.value=e}get usedMemory(){return(this._fbo?.usedMemory??0)+(this._passParameters.noiseTexture?.textureAtlas?.usedMemory??0)}_ensureNoiseTexture(){return this._passParameters.noiseTexture??=new lm({context:this.context}),this._passParameters.noiseTexture}_ensureFrameBufferCube(e){const t=this.context.renderContext.rctx;if(null==this._fbo){const i=new On(e,e/2);i.target=35866,i.depth=6,i.wrapMode=33071,this._fbo=new Pn(t,i),this.parameters.data=this,this.parameters.absorption=this.absorption,this.parameters.coverage=this.coverage}return t.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=M(this._fbo),this.parameters.data=null}applyPreset(e,t){const i=e.median,s=e=>{const s=Pi(e[0],e[1],i);return t<.5?Pi(e[0],s,2*t):Pi(s,e[1],2*(t-.5))};this.coverage=s(e.coverage),this.density=s(e.density),this.absorption=s(e.absorption),this.cloudSize=s(e.cloudSize),this.detailSize=s(e.detailSize),this.smoothness=s(e.smoothness),this.cloudHeight=s(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps,this._precompile()}setDirty(){this._dirty=this.readyToRun=!0}runTask(e){if(3===this.state)return Vn;this._dirty&&(this._sliceIndex=this._tileIndex=0,this.state=1,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);const t=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!t.compiled)return Vn;const i=cm[this._sliceIndex],s=dm[this._sliceIndex];xs(this._viewMatrix,um,i,s),us(this._passParameters.viewMatrix,this._viewMatrix);const r=this.context.renderContext.rctx,n=r.getViewport(),a=Jp/this._tilesPerSlice,o=this._tileIndex*a;r.setViewport(0,o,Jp,a);const l=this._ensureFrameBufferCube(Jp);return r.bindFramebuffer(l),this._passParameters.lastSlice=5===this._sliceIndex,r.bindTechnique(t,this.context.renderContext.bind,this._passParameters),l.setColorTextureTarget(35866,qn,this._sliceIndex),r.screen.draw(),r.gl.flush(),r.setViewport(n.x,n.y,n.width,n.height),this.requestRender(),++this._tileIndex,5===this._sliceIndex&&this._tileIndex===this._tilesPerSlice?(this._sliceIndex=this._tileIndex=0,this.state=2,this.readyToRun=!1):this._tileIndex===this._tilesPerSlice&&(++this._sliceIndex,this._tileIndex=0),e.madeProgress(),Vn}};e([Ce({constructOnly:!0})],hm.prototype,"context",void 0),e([Ce({constructOnly:!0})],hm.prototype,"view",void 0),e([Ce({constructOnly:!0})],hm.prototype,"requestRender",void 0),e([Ce()],hm.prototype,"coverage",void 0),e([Ce()],hm.prototype,"density",void 0),e([Ce()],hm.prototype,"absorption",void 0),e([Ce()],hm.prototype,"cloudSize",void 0),e([Ce()],hm.prototype,"detailSize",void 0),e([Ce()],hm.prototype,"smoothness",void 0),e([Ce()],hm.prototype,"cloudHeight",void 0),e([Ce()],hm.prototype,"raymarchingSteps",void 0),e([Ce()],hm.prototype,"readyToRun",void 0),hm=e([Se("esri.views.3d.environment.CloudsRenderer")],hm);const cm=[Ys(1,0,0),Ys(-1,0,0),Ys(0,1,0),Ys(0,-1,0),Ys(0,0,1),Ys(0,0,1)],dm=[Ys(0,0,-1),Ys(0,0,-1),Ys(0,0,-1),Ys(0,0,-1),Ys(0,1,0),Ys(0,1,0)],um=Le(),pm=Zs(),mm=ke(),gm=ke(),_m=Ve(1,1,1),fm=Ve(.85,.85,.85),ym=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new mn;return t.attributes.add("position","vec3"),t.attributes.add("instanceFeatureAttribute","float"),t.vertex.uniforms.add(new Rr("cameraPosition",e=>e.camera.eye),new cr("offset",(e,t)=>function(e,t){const i=t.camera.eye,s=.5*e.width,r=1/e.width,n=Hi(mm,qi(mm,(i[0]+s)*r,(i[1]+s)*r,(i[2]+s)*r));return Ui(n,i,Bi(n,n,e.width))}(e,t)),new lr("width",e=>e.width),new lr("time",e=>e.time),new Or("proj",e=>e.camera.projectionMatrix),new Or("view",e=>e.camera.viewMatrix)),t.varyings.add("vUv","vec2"),t.vertex.code.add(br`vec3 hash31(float p){
vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yzx + 33.33);
return fract((p3.xxy + p3.yzz) * p3.zyx);
}
float hash11(float p){
p = fract(p * 0.1031);
p *= p + 33.33;
p *= p + p;
return fract(p);
}
vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
}`),t.vertex.main.add(br`
      vUv = position.xz;
      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundredths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${0===e.type?br`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:br`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
  `),t.fragment.uniforms.add(new lr("opacity",e=>e.opacity),new Rr("particleColor",t=>function(e,t){const i=0===t.type?fm:_m,s=Bi(mm,i,.7),r=e.camera.eye;Ni(gm,r);const n=Math.max(0,Gi(gm,e.lighting.mainLight.direction));return Wi(s,s,i,n)}(t,e))),t.fragment.main.add(br`
    float d = length(vUv - vec2(0.5));

    ${0===e.type?br`d = 0.35 * smoothstep(0.5, 0.0, d);`:br`d = smoothstep(0.5, 0.1, d);`}
    fragColor = opacity * vec4(particleColor * d, d);
  `),t}},Symbol.toStringTag,{value:"Module"}));class vm extends xr{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}}class bm extends Tr{constructor(e,t){super(e,t,new Sr(ym,()=>Promise.resolve().then(()=>ym)),new Map([["position",0],["instanceFeatureAttribute",1]]))}initializePipeline(){return gn({blending:bn,depthTest:{func:515},colorWrite:_n})}}class wm extends Mr{constructor(){super(...arguments),this.type=0}}e([Pr({count:2})],wm.prototype,"type",void 0);let xm=class extends sa{constructor(){super(...arguments),this.produces="disabled",this.consumes={required:[ii.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=ii.OPAQUE_ENVIRONMENT,this.requestRender(1)}_disable(){this.produces="disabled",this.requestRender(1)}};e([Ce()],xm.prototype,"produces",void 0),e([Ce()],xm.prototype,"consumes",void 0),xm=e([Se("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],xm);let Cm=class extends xm{constructor(){super(...arguments),this.consumes={required:[ii.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=ii.TRANSPARENT_ENVIRONMENT,this.requestRender(1)}};e([Ce()],Cm.prototype,"consumes",void 0),Cm=e([Se("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],Cm);let Tm=class extends Cm{constructor(e){super(e),this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new vm,this._configuration=new wm;const{view:t,type:i}=e;this._configuration.type="rainy"===i?0:1,t.stage.renderView.techniques.precompile(bm,this._configuration),this._passParameters.time=0,this._passParameters.radius=ge(t.spatialReference).radius,this.addHandles([B(()=>t.environment.weather,e=>{e.type===i&&this.addHandles(B(()=>e.precipitation,e=>this._adjustParticles(e),G))},G)]),this.addHandles(B(()=>t.stage?.renderer.renderContext.bind.clouds.fadeFactor??1,e=>{this._passParameters.opacity=e,1===e&&(this.removeHandles("opacity"),this.addHandles(B(()=>t.stage?.renderer.renderContext.bind.clouds.opacity??1,e=>this._passParameters.opacity=e,G),"opacity"))},W),"opacity")}initialize(){this.addHandles([B(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),G)])}_adjustParticles(e){const t=e<.5?Pi(0,.35,2*e):Pi(.35,1,2*(e-.5));this._numParticles=Sm*t}destroy(){this._numParticles=0,this._vao=M(this._vao),this._instanceIdBuffer=M(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles(B(()=>this.renderContext?.bind.clouds.fadeFactor??1,t=>{this._passParameters.opacity=1-t,1===t&&(this.removeAllHandles(),e())}),"opacity")}updateAnimation(e){const t=("rainy"===this.type?this._rainSpeed:this._snowSpeed)*K(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext,i=Math.round(this._numParticles*this._passParameters.opacity),s=e.find(({name:e})=>e===ii.TRANSPARENT_ENVIRONMENT);if(i<1)return s;const r=this.techniques.get(bm,this._configuration);if(!r.compiled)return this.requestRender(1),s;const n=t.bindTechnique(r,this.bindParameters,this._passParameters);return this._vao??=function(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new ra(e,new oa(e,ia(Pm),t))}(t),t.bindVAO(this._vao),this._bindInstanceIdBuffer(n.locations),n.assertCompatibleVertexAttributeLocations(this._vao,na(Mm)),t.drawArraysInstanced(Un.TRIANGLES,0,3,i),t.unbindBuffer(34962),s}_bindInstanceIdBuffer(e){const t=this.renderingContext;if(this._instanceIdBuffer)return void t.bindBuffer(this._instanceIdBuffer);const i=Xn(Sm);this._instanceIdBuffer=new oa(t,Mm,new Float32Array(i)),Dn(t,e,this._instanceIdBuffer,0)}};e([Ce({constructOnly:!0})],Tm.prototype,"type",void 0),Tm=e([Se("esri.views.3d.environment.Precipitation")],Tm);const Sm=25e4,Pm=ta().vec3f("position").freeze(),Mm=ia(ta().f32("instanceFeatureAttribute"),1);let Rm=class extends ha{constructor(e){super(e),this.produces=new Map([]),this._clouds=ds(null),this._incarnation=0,this._precipitation=null}initialize(){this.view.stage?.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?.stage?.removeRenderPlugin(this),this._set("view",null)}get updating(){return!!this._clouds.value?.readyToRun}get weatherAvailable(){return $i(this.view.state.camera.eye)-ge(this.view.spatialReference).radius<=la}get usedMemory(){return this._clouds.value?.usedMemory??0}_fadeOutPrecipitation(){this._precipitation&&(this._precipitationOutgoing?.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut(()=>{this._precipitationOutgoing=S(this._precipitationOutgoing)}),this._precipitation=null,++this._incarnation)}get weather(){return this.view?.environmentManager?.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;const t=this.view,i=()=>this._requestRender();this.addHandles([B(()=>this._precipitation,i,W),B(()=>this._clouds.value?.state,i,W),B(()=>t.state.mode,i,W),B(()=>this._updateClouds(),i,W),B(()=>this._updatePrecipitation(),i,W),B(()=>this.weather,e=>this._initWeather(e))])}uninitializeRenderContext(){this._context=null,this._clouds.value=S(this._clouds.value),this._precipitation=S(this._precipitation),this._precipitationOutgoing=S(this._precipitationOutgoing)}prepareRender(e){const{bind:t,time:i}=e;if("local"!==this.view.viewingMode&&t.clouds.data){t.clouds.fade(t.camera,i,this.view.qualitySettings.fadeDuration);const e=this._clouds.value;e&&0===e.state&&0===e.coverage&&!e.readyToRun&&e.destroyCubeMap()}}acquireTechniques(){return[]}render(){}_requestRender(){this._context?.requestRender()}_initWeather(e){const t=this._context;if(!e||!t)return void(this._clouds.value=S(this._clouds.value));if(this._clouds.value)return;const i=this.view;this._clouds.value=new hm({context:t,view:i,requestRender:()=>this._requestRender()})}_updateClouds(){const e=this.view.environment.weather;return null==e||null==this._clouds.value||this._clouds.value.applyPreset(Bp[e.type],function(e){switch(e.type){case"rainy":case"snowy":case"cloudy":case"sunny":return e.cloudCover;case"foggy":return e.fogStrength}}(e)),++this._incarnation}_updatePrecipitation(){const e=this.view.environment.weather;if(e.type===this._precipitation?.type)return this._incarnation;this._fadeOutPrecipitation();const t="rainy"===e.type||"snowy"===e.type,i=this._context;return t&&i&&(this._precipitation=new Tm({view:this.view,type:e.type}),++this._incarnation),this._incarnation}get test(){}hasHighlight(){return!1}};e([Ce({constructOnly:!0})],Rm.prototype,"view",void 0),e([Ce({type:Boolean,readOnly:!0})],Rm.prototype,"updating",null),e([Ce()],Rm.prototype,"weatherAvailable",null),e([Ce()],Rm.prototype,"_context",void 0),Rm=e([Se("esri.views.3d.environment.EnvironmentRenderer")],Rm);let Om=class extends ji{constructor(){super(),this._tmpLightParameters=new Ma,this._defaultLightParameters=new Ma,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new Aa,this._ambientLight=new Ea,this._moonLight=new Ia,this._disableWeather=!1,this._renderer=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!!this._renderer?.updating||!this._canProjectCameraPosition}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&1===this._view?.state?.viewingMode&&_e(this._view.spatialReference)}get _weatherAvailable(){return this.weatherEnabled&&this._renderer?.weatherAvailable}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){const e=this._view?.stateManager?.camera?.position?.spatialReference??tt.WGS84,t=qp(e);return Ye(e,t)}connectView(e){if(this._renderer)return;this._renderer=new Rm({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([B(()=>e.environment.lighting,e=>this._updateLightingHandler(e),W),B(()=>"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null,e=>this._lightingDateHandler(e),W),B(()=>e.environment.lighting.directShadowsEnabled,t,W),B(()=>e.qualitySettings.ambientOcclusion,t,W),B(()=>e.qualitySettings.reflections,t,W),B(()=>e.spatialReference,()=>this._resetReferencePosition(!0),W),B(()=>[e.environment.weather.type,this.weatherEnabled],()=>this._updateLighting(null,1),W),B(()=>"snowy"===e.environment.weather.type&&e.environment.weather.snowCover,t,W),B(()=>e.environment,e=>e.setComputeWeatherAvailable(()=>this._weatherAvailable),G),B(()=>e.viewingMode,()=>this._resetReferencePosition(!0),G),B(()=>"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled,e=>this._updateCameraTracking(e),G),B(()=>e.state.camera,i,G),$(()=>this._canProjectCameraPosition,i,W)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=S(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"virtual"!==e?.type&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if("virtual"!==t?.type){if(e){if(!t.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(e),null!=this._referencePositionGeographic)){const e=Pa(this._referencePositionGeographic,this._tmpTz);null!=e&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;if(!i)return;const{position:s}=i,r=qp(s.spatialReference??tt.WGS84);if(!at(s,Em,r)){if(null==this._referencePositionGeographic)return;return this._referencePositionGeographic=null,void this._updateLighting()}this._referencePositionGeographic?Qi(this._referencePositionGeographic,Em)||(Zi(this._referencePositionGeographic,Em),this.notifyChange("referencePositionGeographic")):this._referencePositionGeographic=Fe(Em),this._autoUpdateTimezone(this._referencePositionGeographic,e)||this._updateLighting(e)}_updateLighting(e,t=0){const i=this._view,{lighting:s}=i.environment,r="virtual"===s.type,n=this._referencePositionGeographic,a=null!=n?this._tmpLightParameters:this._defaultLightParameters;if(n){e??=r?null:s.date;const t=this._weatherAvailable?i.environment.weather.type:"disabled";Ra(e,n,i.state.viewingMode,t,i.state.camera,a)}else r&&Oa(i.state.camera,i.state.viewingMode,a.direct.directionToLightSource);const o=this._mainLight,l=a.direct;Bi(o.intensity,l.color,l.intensity*Math.PI),Zi(o.direction,l.directionToLightSource),o.specularStrength=a.specularStrength,o.environmentStrength=a.environmentStrength;const h=this._ambientLight;Bi(h.intensity,a.ambient.color,a.ambient.intensity);const c=this._moonLight;Wi(c.intensity,Dm,Am,a.globalFactor);const d=(1-.5*a.globalFactor)*(1-.4*a.noonFactor*(1-a.globalFactor));Bi(c.intensity,c.intensity,d),Zi(c.direction,l.directionToLightSource),this._view.stage?.renderer.updateLighting([o,h,c],a.noonFactor,a.globalFactor,this._weatherAvailable?t:0),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==e)return!1;const i=this._tmpDate;i.setTime((t||this._view.environment.lighting.date).getTime());const s=Pa(e,this._tmpTz);if(null==s)return!1;let r=this._view.environment.lighting.positionTimezoneInfo;if(r.autoUpdated){if(r.hours===s.hours&&r.minutes===s.minutes&&r.seconds===s.seconds)return!1}else r=s;const n=i.getUTCHours()-(s.hours-r.hours),a=i.getUTCMinutes()-(s.minutes-r.minutes),o=i.getUTCSeconds()-(s.seconds-r.seconds);return i.setUTCHours(n),i.setUTCMinutes(a),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,s)}_updateRenderParameters(){const e=this._view.stage;if(!e)return;const t=null==this._referencePositionGeographic||Da(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._weatherAvailable,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._referencePositionGeographic=null,e&&this._cameraHandler()}get test(){}};e([Ce({type:Boolean,readOnly:!0})],Om.prototype,"updating",null),e([Ce()],Om.prototype,"_disableWeather",void 0),e([Ce()],Om.prototype,"weatherEnabled",null),e([Ce()],Om.prototype,"_weatherAvailable",null),e([Ce()],Om.prototype,"referencePositionGeographic",null),e([Ce()],Om.prototype,"_referencePositionGeographic",void 0),e([Ce()],Om.prototype,"_renderer",void 0),e([Ce()],Om.prototype,"_canProjectCameraPosition",null),Om=e([Se("esri.views.3d.environment.EnvironmentManager")],Om);const Dm=Ve(.22,.22,.33),Am=Ve(.22,.22,.22),Em=ke(),Im={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:ka,virtual:Va}};var Lm;let km=class extends Fa{static{Lm=this}constructor(e){super(e),this.lighting=this.castLighting(),this._computeWeatherAvailable=void 0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new Lm({...t,lighting:t.lighting?"virtual"===t.lighting.type?Va.fromWebsceneLighting(t.lighting):ka.fromWebsceneLighting(t.lighting):void 0})}get weatherAvailable(){return this._computeWeatherAvailable?.()??!1}setComputeWeatherAvailable(e){this._computeWeatherAvailable=e}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){const t=this._convertLighting(e);return t!==e&&this.addHandles(l(t)),t}_convertLighting(e){return e?e instanceof ka||e instanceof Va?e:e instanceof ja?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new ka({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):e instanceof za?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new Va({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):Pe(Im,e):new ka}clone(){return new Lm({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:d(this.background)})}cloneWithWebsceneEnvironment(e){return new Lm({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:d(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):ka.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):Va.fromWebsceneLighting(e.lighting);default:return c(e.lighting),ka.fromWebsceneLighting(e.lighting)}}};e([Ce({nonNullable:!0})],km.prototype,"lighting",void 0),e([Ce()],km.prototype,"_computeWeatherAvailable",void 0),e([Ce({readOnly:!0})],km.prototype,"weatherAvailable",null),e([Te("lighting")],km.prototype,"castLighting",null),km=Lm=e([Se("esri.views.3d.environment.SceneViewEnvironment")],km);const Vm=km;class Fm{constructor(e=15,t=0,i=0,s=null,r=null,n=0){this.selection=e,this.interactionType=t,this.interactionFactor=i,this.interactionStartCamera=s,this.interactionDirection=r,this.tiltMode=n}}function jm(e,t){return 0!==(e&t)}function zm(e,t,i,s,r,n){0!==e&&(i?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):null!=s?(n.min-=Math.max(0,(t-n.min)*(1-s)),n.max+=Math.max(0,(t-n.max)*(1-s))):r&&(n.min-=Math.max(0,t-n.min-r),n.max+=Math.max(0,t-n.max-r)))}const Hm=new Fm(0);function qm(e,t,i,s){return t=t||e.viewForward,Zi(s,t),Bi(s,s,Math.sign(Gi(t,i))),s}function Um(e,t,i=Hm){if(!function(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i||2===t.interactionType&&jm(t.selection,1))}(e,i)||!e.state.constraints.altitude)return 0;const s=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,Bm);!function(e,t,i){const s=t.interactionType;if(0===s)return;const{min:r,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=2===s||1===s,h=Um(e,a),c=0===h?0:e.renderCoordsHelper.getAltitude(a.eye);i.min=r,i.max=n,zm(h,c,l,o,.05*c,i)}(e,i,s);const r=e.renderCoordsHelper.getAltitude(t.eye),n=Ci(r,s.min,s.max)-r;return Math.abs(n)<=1e-6?0:n}const Bm={min:0,max:0},Nm=ke(),Gm=ke(),Wm=ke(),$m=ke();function Qm(e,t,i=Hm){if(!e.state.isLocal)return 0;const s=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||s===1/0)return 0;Ym.min=0,Ym.max=s,function(e,t,i){const s=t.interactionType;if(0===s)return;const{min:r,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=1===s||4===s,h=Qm(e,a),c=0===h?0:Zm(e,a);i.min=r,i.max=n,zm(h,c,l,o,.05*c,i)}(e,i,Ym);const r=Zm(e,t),n=Ym.max-r;return n>=-1e-6?0:n}function Zm(e,t){const i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?Xi(t.eye,i.renderLocation):0}const Ym={min:0,max:0},Km=ke(),Xm=ke(),Jm=ke(),eg=ke(),tg=ke();function ig(e,t,i=0){const s=e.state.constraints;if(!s.collision.enabled)return!1;const r=si(e,t.eye),n=e.renderCoordsHelper.getAltitude(t.eye),a=r+s.collision.elevationMargin;if(n>=a)return!1;const o=$i(t.eye);if(Yi(sg,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(rg,a,t.eye),1===i)t.center=Ki(sg,t.eye,sg);else if(2===i){const e=(o-n+a)/o;t.center=Bi(sg,t.center,e)}return!0}const sg=ke(),rg=ke();function ng(e,t,i,s=Hm,r){if(!e.state.constraints.tilt)return 0;const n=Math.min(t.relativeElevation*mg,t.distance),a=e.state.constraints.tilt(n,gg);return function(e,t,i){if(0===t.interactionType)return;const{interactionStartCamera:s,interactionFactor:r}=t;if(!s)return;const{min:n,max:a}=i,o=ng(e,s,Hm,t),l=0===o?0:ri(e.renderCoordsHelper,s.center,s.eye);i.min=n,i.max=a,2===t.interactionType?(jm(t.selection,2)&&hg(e,s,i),zm(o,l,!0,r,pg,i)):zm(o,l,!1,r,pg,i)}(e,i,a),2===s.interactionType&&jm(s.selection,2)&&hg(e,s.interactionStartCamera,a),1===i.tiltMode||1===s.tiltMode?function(e,t,i,s){switch(s&&(s.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,s){const r=ag(e,t,_g),n=Ci(r.tiltAtCenter,i.min,i.max);if(!og(r.tiltAtCenter-n))return 0;let a,o;return r.centerIsOnSurface?(a=function(e){const{constraints:t,distance:i,tiltAtCenter:s}=e;let r=s,n=t.clampTilt(i,s);const a=lg(e,n);if(t.clampTilt(a,s)===n)return n;let o=0;for(;o<10&&og(n-r);){const i=(r+n)/2,s=lg(e,i);og(t.clampTilt(s,i)-i)?r=i:n=i,o++}return n}(r),o=function(e,t){const i=Ri(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),s=Ri(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-s:s-i}(r,a)):(a=r.constraints.clampTilt(r.distance,r.tiltAtCenter),s&&a<Math.PI/2&&(s.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(r,a)),s&&(s.eyeCenterDistance=lg(r,a)),o}(e,t,i,s);case"local":return function(e,t,i,s){const r=ri(e.renderCoordsHelper,t.center,t.eye),n=Ci(r,i.min,i.max),a=r-n;if(!og(a))return 0;if(s){const i=Math.abs(e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),r=e.renderCoordsHelper.getAltitude(t.eye)-i,a=Math.max(Math.cos(n),1e-4);Math.abs(a)>1e-4?s.eyeCenterDistance=r/a:s.eyeCenterDistance=t.distance}return a}(e,t,i,s)}}(e,t,a,r):function(e,t,i){const s=ri(e.renderCoordsHelper,t.center,t.eye),r=s-Ci(s,i.min,i.max);return og(r)?r:0}(e,t,a)}function ag(e,t,i){const s=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=s+ge(e.spatialReference).radius,n=e.renderCoordsHelper.intersectManifold(t.ray,s,ug);return i.distance=Math.min(t.relativeElevation*mg,t.distance),i.centerIsOnSurface=!1,null!=n?(i.distance=Math.min(t.relativeElevation*mg,Xi(t.eye,n)),i.tiltAtCenter=ri(e.renderCoordsHelper,n,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=ri(e.renderCoordsHelper,t.center,t.eye):(Na(Ga(Wa,r),t.ray,ug),i.distance=Math.min(t.relativeElevation*mg,Xi(t.eye,ug)),i.tiltAtCenter=Mi(-Gi(t.viewForward,Ni(ug,ug)))),i.radius=r,i.eyeRadius=$i(t.eye),i.constraints=e.state.constraints,i}function og(e){return Math.abs(e)>1e-9}function lg(e,t){if(!e.centerIsOnSurface)return e.distance;const i=Math.PI-Ci(t,0,Math.PI),s=Ri(e.radius/e.eyeRadius*Math.sin(i)),r=Math.PI-i-s,n=Math.sin(r)/Math.sin(i);if(e.eyeRadius<e.radius&&n>1){const t=Math.PI-s,r=Math.PI-i-t;return Math.sin(r)/Math.sin(i)*e.eyeRadius}return n*e.eyeRadius}function hg(e,t,i){const s=e.state.constraints;if(e.state.isLocal||!s.altitude||!t)return;const r=ts(t.center),n=Math.sqrt(r),a=t.distance,o=ge(e.spatialReference).radius,l=s.altitude.min+o,h=s.altitude.max+o,c=(l*l-a*a-r)/(-2*n*a),d=(h*h-a*a-r)/(-2*n*a);i.min=Math.max(i.min,Math.min(Math.PI-Mi(d),i.max)),i.max=Math.min(i.max,Math.PI-Mi(c))}const cg=ke(),dg=Fs(),ug=ke(),pg=Ti(5),mg=30,gg={min:0,max:0},_g={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,distance:0,tiltAtCenter:0},fg={eyeCenterDistance:0,requiresTwoSteps:!1};function yg(e,t,i=wg,s=t){s!==t&&s.copyFrom(t),s.computeUp(e.state.viewingMode);let r=!1;for(let t=0;t<xg;t++){let t=0;for(const n of bg)if(jm(i.selection,n.type)){const a=Math.abs(n.error(e,s,i));n.apply(e,s,i)&&(r=!0,t+=a)}if(0===t)break}const n=jm(i.selection,8),a=function(e,t){switch(e){case 4:return 1;case 5:return t.state.isGlobal?2:1;default:return 0}}(i.interactionType,e);return n&&ig(e,s,a)&&(r=!0),r&&s.computeUp(e.state.viewingMode),r}function vg(e){const t=Math.min(1,e/150);return uo(t)}const bg=[{type:1,error:function(e,t,i){return ng(e,t,i)*t.distance},apply:function e(t,i,s,r=!0){fg.eyeCenterDistance=0,fg.requiresTwoSteps=!1;const n=ng(t,i,s,Hm,fg);if(0===n)return!1;switch(Cs(dg,-n,i.viewRight),s.tiltMode){case 1:es(cg,i.viewForward,dg),Bi(cg,cg,fg.eyeCenterDistance),i.center=Ki(ug,i.eye,cg);break;case 0:Yi(cg,i.center,i.eye),es(cg,cg,dg),i.eye=Yi(ug,i.center,cg);break;default:c(s.tiltMode)}return i.up=es(ug,i.up,dg),!fg.requiresTwoSteps||!r||e(t,i,s,!1)}},{type:2,error:Um,apply:function(e,t,i=Hm){const s=Um(e,t,i);if(0===s)return!1;const r=e.renderCoordsHelper,n=r.getAltitude(t.eye)+s,a=qm(t,i.interactionDirection,function(e,t,i,s){return e.renderCoordsHelper.worldUpAtPosition(t.eye,s),Bi(s,s,i),s}(e,t,Math.sign(s),Gm),Nm),o=Zi(Wm,t.viewForward),l=r.intersectInfiniteManifold(Ha(t.eye,a),n,$m);return t.eye=null!=l?l:r.setAltitude($m,n,t.eye),t.center=Xa($m,t.eye,o,t.center),!0}},{type:4,error:Qm,apply:function(e,t,i=Hm){const s=Qm(e,t,i);if(0===s)return!1;const r=e.pointsOfInterest.surfaceOrigin;if(!r.renderLocation)return!1;const n=Zm(e,t)+s,a=Zi(Km,t.eye),o=qm(t,i.interactionDirection,function(e,t){return Ji(eg,e.eye,t)}(t,r.renderLocation),Jm);if(!Ua(Ba(r.renderLocation,n),Ha(t.eye,o),tg))return!1;t.eye=tg;const l=Yi(Xm,t.eye,a);t.center=Ki(tg,t.center,l);const h=e.renderCoordsHelper.getAltitude(t.center),c=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,h,tg);return null!=c&&(t.center=c),!0}}],wg=new Fm,xg=5;class Cg{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=ke(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=Fe(Ag),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotate(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(1===this.viewingMode){const i=($i(this.center)+$i(e.center))/2;t.pan=Li(this.center,e.center)*i}else t.pan=Xi(this.center,e.center);let i=Math.abs(e._yaw-this._yaw);i>=Math.PI&&(i=2*Math.PI-i);const s=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(i,s),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,t,i){1===this.viewingMode?ki(e.center,t.center,i.pan,this.center):Wi(this.center,e.center,t.center,i.pan),this._distance=isFinite(t.distance)?Pi(e.distance,t.distance+i.zoomOffset,i.zoom):e.distance,this._pitch=Pi(e.pitch,t.pitch,i.rotate);let s=e._yaw;const r=t._yaw;Math.abs(r-s)>=Math.PI&&(s+=2*(s<r?1:-1)*Math.PI),this._yaw=Pi(s,r,i.rotate),this._fov=Pi(e.fov,t.fov,i.fov)}copyFrom(e){Zi(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,Zi(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,Ig);Zi(this.center,e.center),Yi(Mg,e.center,e.eye),is(Mg,Mg,t),is(Rg,e.up,t),this._distance=$i(Mg),0!==this._distance&&(Mg[0]/=this._distance,Mg[1]/=this._distance,Mg[2]/=this._distance),this._pitch=function(e){return Math.PI-Li(Dg,e)}(Mg),this._yaw=function(e,t){const i=Og;return Math.abs(t[2])<.5?(Zi(i,t),e[2]>0&&Bi(i,i,-1)):Zi(i,e),ss(Sg,i,Dg),Ni(Sg,Sg),Li(Eg,Sg,Dg)}(Mg,Rg),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,Ig);ps(t,t),this._axisAngleVec3(Eg,this._pitch-Math.PI/2,Ag,Mg),this._axisAngleVec3(Dg,this._yaw,Mg,Mg),this._axisAngleVec3(Eg,this._pitch-Math.PI/2,Dg,Rg),this._axisAngleVec3(Dg,this._yaw,Rg,Rg),Bi(Mg,Mg,this._distance),is(Mg,Mg,t),is(Rg,Rg,t),e.center=this.center,e.eye=Yi(Mg,this.center,Mg),e.up=Rg,e.fov=this._fov}_axisAngleVec3(e,t,i,s){const r=Math.cos(t),n=Math.sin(t);return Bi(Tg,i,r),ss(Sg,e,i),Bi(Sg,Sg,n),Bi(Pg,e,(1-r)*Gi(e,i)),Ki(s,Ki(s,Tg,Sg),Pg)}_lookAtOrientation(e,t=Xs()){return this._upAtLookAt(e,Pg),ss(Tg,this.direction,Pg),Ni(Tg,Tg),0===Tg[0]&&0===Tg[1]&&0===Tg[2]&&Zi(Tg,Eg),ss(Sg,Pg,Tg),Ni(Sg,Sg),t[0]=Tg[0],t[1]=Sg[0],t[2]=Pg[0],t[3]=Tg[1],t[4]=Sg[1],t[5]=Pg[1],t[6]=Tg[2],t[7]=Sg[2],t[8]=Pg[2],t}_upAtLookAt(e,t){return 2===this.viewingMode?Zi(t,Dg):Ni(t,e)}}const Tg=ke(),Sg=ke(),Pg=ke(),Mg=ke(),Rg=ke(),Og=ke(),Dg=He,Ag=je,Eg=ze,Ig=Xs();class Lg{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=X(0),this._animation=new go(()=>new Cg(e)),this._current=new Cg(e)}update(e,t,i){const{source:s,target:r}=this._animation.definition,n=Yi(kg,t.center,e.center),a=$i(n);a>=1e-5?(n[0]/=a,n[1]/=a,n[2]/=a):(n[0]=0,n[1]=1,n[0]=0),Zi(s.direction,n),Zi(r.direction,n),s.copyFromRenderCamera(e),r.copyFromRenderCamera(t),this._current.copyFrom(s),this._animation.update(s,r,i),this.currentTime=X(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){this._animation.cameraAt(e,this._current),this._current.copyToRenderCamera(t)}step(e,t){this.finished||(this.currentTime=X(this.currentTime+J(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}const kg=ke();let Vg=class extends Oe{constructor(e){super(e),this.state=0}get running(){return 2===this.state}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=3,!0)}finishController(){this.state=4}get steppingFinished(){return!1}};e([Ce({constructOnly:!0})],Vg.prototype,"view",void 0),e([Ce({readOnly:!0})],Vg.prototype,"running",null),e([Ce()],Vg.prototype,"state",void 0),e([Ce({readOnly:!0})],Vg.prototype,"isInteractive",null),Vg=e([Se("esri.views.3d.state.controllers.CameraController")],Vg);let Fg=class extends Vg{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(A()),this._asyncResult=null),4===this.state||3===this.state?(R(e),4===this.state?e.resolve():e.reject(A())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=2,null!=this.viewAnimation&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!this.viewAnimation||0!==this.state&&2!==this.state||(this.viewAnimation.state===Yt.state.FINISHED?this.finish():this.viewAnimation.state===Yt.state.STOPPED&&(this.state=3))}onControllerEnd(e){null==this.viewAnimation||this.viewAnimation.done||(4===this.state?this.viewAnimation.finish():3===this.state&&this.viewAnimation.stop()),this._asyncResult&&(4===this.state?this._asyncResult.resolve():this._asyncResult.reject(A()))}finish(){this.finishController()}};Fg=e([Se("esri.views.3d.state.controllers.AnimationController")],Fg);let jg=class extends Fg{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.type="point-to-point",this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new Lg(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new Yt}get isInteractive(){return"interaction"===this.mode}begin(e,t){this._hasTarget=!0;const i=this.animationSettings(t);zg.copyFrom(this.view.state.camera);const s=new Ao(this.view.state.viewingMode);this._intersectionHelper.intersectRay(zg.ray,s,Hg)&&(zg.center=Hg),this.animation.update(zg,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?po[e.easing]:e.easing}}};e([Ce({constructOnly:!0})],jg.prototype,"mode",void 0),e([Ce({readOnly:!0})],jg.prototype,"isInteractive",null),jg=e([Se("esri.views.3d.state.controllers.PointToPointAnimationController")],jg);let zg=new Do;const Hg=ke();function qg(e){return null!=e&&"type"in e&&"point-to-point"===e.type}function Ug(e=Gg){return[e[0],e[1],e[2],e[3]]}function Bg(e,t){return function(e,t,i,s,r=Ug()){return r[0]=e,r[1]=t,r[2]=i,r[3]=s,r}(e[0],e[1],e[2],t,zo.get())}function Ng(e,t,i){return ss(i,e,t),Ni(i,i),i[3]=jo(e,t),i}const Gg=[0,0,1,0];function Wg(e,t,i,s){const r=Ko(t,i,$g);return Ua(e,r,s)}const $g=qa(),Qg=[1,3e8],Zg=[200,1508e5],Yg={exclude:new Set([Eo])};function Kg(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function Xg(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function Jg(e,t,i){const s=Cs(Ho.get(),i[3],i);null==s||Ts(s,js)||(Yi(B_,e.eye,t),es(B_,B_,s),e.eye=Ki(B_,B_,t),Yi(B_,e.center,t),es(B_,B_,s),e.center=Ki(B_,B_,t),e.up=es(B_,e.up,s))}function e_(e,t,i,s){return Go(e,Ko(t,i,Q_),s)}function t_(e,t,i,s){const r=qo.get();let n=1-i;Yi(r,t,e.eye);const a=$i(r);let o=a*(1-n);n>=0&&o<s&&(o=s,n=-(o-a)/a),Math.abs(a-o)<1e-6||(Bi(r,r,n),e.eye=Ki(B_,e.eye,r),e.center=Wi(B_,e.center,t,n))}function i_(e,t,i){t.getScreenCenter(s_),Wg(e,t,s_,B_)&&(t.center=B_);const s=t.distance,r=s*i;if(Math.abs(s-r)<1e-6)return;const n=Bi(qo.get(),t.viewForward,r);t.eye=Yi(B_,t.center,n)}const s_=re();function r_(e,t){qi(t,0,0,0);for(const i of e)Ki(t,t,i);Bi(t,t,1/e.length)}function n_(e,t,i,s){return Math.sin(e/$i(t))*(i+s.radius)}function a_(e,t,i,s){return n_(Math.PI/2,t,i,s)+(e-Math.PI/2)}const o_={Elevation:3e4,Angle:Ti(16)},l_=Ti(80);function h_(e,t,i,s,r,n){const a=ke(),o=$a();let l=!0,h=!0;return e.intersectScreen(i,a,n)?o[3]=$i(a):(h=!1,t.aboveGround&&0!==r?o[3]=Math.max($i(t.center),.9*s):o[3]=$i(t.eye)-t.relativeElevation,1===r?p_(o,t,i,a):l=Wg(o,t,i,a)),{sphere:o,scenePickPoint:l?a:null,hasGeometryIntersection:h}}function c_(e,t,i,s){const r=e.relativeElevation;if(r>o_.Elevation&&"global"===s)return 1;Ko(e,t,Z_);const n=Math.sign(r),a=i.worldUpAtPosition(e.eye,B_);return-n*Gi(a,Z_.direction)<Math.sin(o_.Angle)*$i(Z_.direction)?0:1}function d_(e,t,i){Yi(u_,i,t),e.eye=Yi(B_,e.eye,u_),e.center=Yi(B_,e.center,u_)}const u_=ke();function p_(e,t,i,s){const r=Ko(t,i,Q_);return!(null==r||(Na(e,r,m_),Ua(e,r,s)?rs(m_,r.origin)<rs(s,r.origin)&&(Zi(s,m_),1):(Yi(g_,t.eye,t.center),Ni(g_,g_),No(g_,-Gi(Ni(g_,g_),m_),__),Go(__,r,s),1)))}const m_=ke(),g_=ke(),__=Bo();function f_(e,t,i,s,r,n){let a=0;if(ss(W_,e,t),Yi(N_,e,t),$i(e)<=r||!s.aboveGround){ss(i,N_,s.eye);const o=Gi(e,t)/($i(e)*$i(t));if(o<.9999)a=Mi(o);else{const i=$i(ss(ke(),e,t))/($i(e)*$i(t));a=Ri(i)}const l=Math.cos(Ci(Vo.normalize(Ti(n)),0,l_));a=-a-Math.max(0,$i(t)-r)/(l*r)}else Yi(y_,s.eye,s.center),ss(i,N_,y_),a=-$i(N_)/r;return Ni(i,i),Bi(i,i,$i(W_)),a}const y_=ke();function v_(e,t,i,s){let r,n;const a=Math.cos(Ci(Vo.normalize(Ti(s)),0,l_));return r=t>i?-(t-i)/(a*i):t<-i?Math.PI-(t+i)/(a*i):Mi(t/i),n=e>i?-(e-i)/(a*i):e<-i?Math.PI-(e+i)/(a*i):Mi(e/i),(n-r)*i}function b_(e,t,i,s,r,n,a,o,l,h){ss(W_,e,t),Rt(n.up,n.eye,E_,I_,L_),Rt([0,0,1],n.eye,O_,D_,A_),Zi(i,D_),Zi(s,O_),Ni(i,i),Bi(i,i,$i(W_)),Ot(e,Ni(I_,I_),Ni(L_,L_),Ni(E_,E_),k_),Ot(t,I_,L_,E_,V_),function(e,t,i,s,r,n,a,o,l,h){const c=v_(e[2],t[2],n[3],o),d=l?v_(e[0],t[0],n[3],180):t[0]-e[0],u=Math.sin(a)*d-Math.cos(a)*c,p=Math.cos(a)*d+Math.sin(a)*c;Ni(B_,r);const m=l?u/Math.sqrt(Math.abs(n[3]**2-Gi(i,B_)**2)):u/n[3],g=p/Math.sqrt(Math.abs(n[3]**2-Gi(i,s)**2));Hs(h,m,g)}(k_,V_,e,O_,D_,a,o,l,h,r)}function w_(e,t,i,s,r,n,a){Cs(z_,r,s),Cs(H_,a,n),Ps(q_,z_,H_),Yi(t,e,i),es(t,t,q_),Ki(t,t,i)}function x_(e,t,i,s,r,n){Cs(z_,s,i),Cs(H_,n,r),Ps(q_,z_,H_),Yi(B_,e.eye,t),es(B_,B_,q_),e.eye=Ki(B_,B_,t),Yi(B_,e.center,t),es(B_,B_,q_),e.center=Ki(B_,B_,t),Yi(B_,e.up,t),es(B_,B_,q_),e.up=Ki(B_,B_,t)}const C_=Ti(18);let T_=!1;function S_(e,t,i,s,r,n){const a=Math.abs(s)>Math.PI-C_||Math.abs(s)<C_,o=(Math.abs(e[2])<.95*i||Math.abs(t)>i)&&n;return a&&o?!T_&&r<45-1e-7?T_=!0:T_&&r>45+1e-7&&(T_=!1):T_=!1,T_}function P_(e,t,i,s,r,n){if(n)Ng(i,s,j_),Jg(t,Qa(e),j_);else{const n=f_(i,s,$_,t,e[3],r);Jg(t,Qa(e),Bg($_,n))}}function M_(e,t,i,s,r,n,a){const o=a?20:1;let l,h;Zi(U_,s),G_.copyFrom(t);for(let s=0;s<o&&rs(i,U_)>1e-12&&(l=rs(i,U_),b_(i,U_,D_,O_,F_,G_,e,r,n,a),x_(G_,Qa(e),O_,F_[1],D_,F_[0]),w_(U_,U_,Qa(e),O_,F_[1],D_,F_[0]),h=rs(i,U_),h<l||0===s);s++)t.copyFrom(G_)}function R_(e,t,i=1/0){const s=Math.abs(Gi(e,t));return Math.min(i,1/s)}const O_=ke(),D_=ke(),A_=ke(),E_=ke(),I_=ke(),L_=ke(),k_=ke(),V_=ke(),F_=Gs(),j_=Ug(),z_=Fs(),H_=Fs(),q_=Fs(),U_=ke(),B_=ke(),N_=ke();let G_=new Do;const W_=ke(),$_=ke(),Q_={origin:ke(),direction:ke()},Z_={origin:ke(),direction:ke()};let Y_=class extends jg{constructor(){super(...arguments),this._zoomLocation=ke(),this._tmpCamera=new Do,this._tmpViewDir=ke(),this._tmpRayDir=qa(),this._targetOnSphere=ke(),this._tmpCenter=ke(),this._beginCamera=new Do,this._constraintOptions=new Fm(7,1,null,this._beginCamera),this._sphere=$a()}initialize(){this._intersector=new Ao(this.view.state.viewingMode)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let s=!1,r=!1;this._intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?Yg:{})&&(s=e>0,r=!0),this._tmpCamera.copyFrom(i.camera),s?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:Zi(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,t,r),this.begin(this._tmpCamera)}animationSettings(){return{duration:X(600),easing:mo}}_updateCamera(e,t,i,s){const r=c_(e,i,this.view.renderCoordsHelper,this.view.viewingMode),n=Math.abs(this.view.camera.position.z),a=this._zoomLocation;Ni(X_,e.eye),Bi(X_,X_,-1),Ko(e,i,this._tmpRayDir),Ni(this._tmpRayDir.direction,this._tmpRayDir.direction);const o=Ci(R_(X_,this._tmpRayDir.direction,8)*n,Zg[0],Zg[1]);if(1===r){let s=.6**t;this._sphere[3]=$i(a),Yi(this._tmpViewDir,e.center,e.eye);const r=Math.min($i(this._tmpViewDir),o);let n=r*s;if(s<=1&&n<4&&(n=4,s=n/r),Math.abs(r-n)<1e-6)return;const g=$i(e.center);if(this._sphere[3]!==g){const t=this._sphere[3]+s*(g-this._sphere[3]);e.center=Bi(K_,e.center,t/g)}Bi(this._tmpViewDir,this._tmpViewDir,-s),e.eye=Ki(K_,e.center,this._tmpViewDir),yg(this.view,e,this._constraintOptions),rs(a,e.center)>1e-12&&Wg(this._sphere,e,i,this._targetOnSphere)&&(l=this._sphere,h=e,c=a,d=this._targetOnSphere,u=this.view.camera.heading,p=this.view.camera.tilt,m=!0,S_(c,Gi(h.up,c),l[3],-Vo.normalize(Ti(u)),p,h.aboveGround)?M_(l,h,c,d,-Vo.normalize(Ti(u)),p,m):P_(l,h,c,d,p,m))}else{let r=.6**Math.abs(t);const n=t>0?1:-1;Yi(this._tmpViewDir,a,e.eye);const l=$i(this._tmpViewDir),h=this.view.stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,60);let c=null!=h?h:o;s&&t>0&&(c=Math.min(c,l)),Bi(this._tmpRayDir.direction,this._tmpRayDir.direction,c),Ki(a,this._tmpRayDir.origin,this._tmpRayDir.direction);let d=c*r;const u=Math.max(4,1.01*e.nearFar[0]);if(t>0&&d<u&&(d=u,r=d/c),Math.abs(c-d)<1e-6)return;Bi(this._tmpRayDir.direction,this._tmpRayDir.direction,n*(1-r)),e.eye=Ki(K_,e.eye,this._tmpRayDir.direction),e.center=Ki(K_,e.center,this._tmpRayDir.direction)}var l,h,c,d,u,p,m;ig(this.view,e)}};Y_=e([Se("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],Y_);const K_=ke(),X_=ke();let J_,ef=null;const tf=new Map;async function sf(e){null==ef&&(null==J_&&(J_=import("../chunks/VoxelWasmPerSceneView.js")),ef=await J_);const t=e.view;let i=tf.get(t);return i||(i=new ef.default({view:t}),tf.set(t,i)),i.addVoxelLayer(e)}function rf(e){return tf.get(e)}function nf(e){const t=e.view,i=tf.get(t);i&&i.removeVoxelLayer(e)<1&&(tf.delete(t),0===tf.size&&(J_=null,ef=null))}let af=class extends jg{constructor(){super(...arguments),this._zoomLocation=ke(),this._tmpCamera=new Do,this._tmpRayDir=ke(),this._tmpCenter=ke(),this._beginCamera=new Do,this._constraintOptions=new Fm(15,1,null,this._beginCamera)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const s=new Ao(this.view.state.viewingMode);let r=!1;e>0?(r=this._intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.basemapTerrain.invisible?Yg:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,s,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,s,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:Zi(this._zoomLocation,this._tmpCamera.center);const n=.6**e;let a=this.view.stage.renderView.getMinimalDepthForArea(rf(this.view),t[0],t[1],this.view.state.camera,60);Yi(hf,this._tmpCamera.eye,this._zoomLocation),Ni(hf,hf);const o=Math.abs(this.view.camera.position.z),l=Ci(R_(lf,hf,8)*o,Zg[0],Zg[1]);a=null!=a?a:l;const h=ke();Yi(h,this._zoomLocation,this._tmpCamera.eye),(a<$i(h)||!r)&&(Ni(h,h),Ki(this._zoomLocation,this._tmpCamera.eye,Bi(h,h,a))),this._updateCamera(this._tmpCamera,n,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:X(600),easing:mo}}_updateCamera(e,t,i){Yi(this._tmpRayDir,i,e.eye);const s=$i(this._tmpRayDir);let r=s*t;const n=t<=1,a=Math.max(4,1.01*e.nearFar[0]);0!==r&&(n&&r<a&&(r=a,t=r/s),Math.abs(s-r)<1e-6||(Bi(this._tmpRayDir,this._tmpRayDir,t),e.eye=Yi(of,i,this._tmpRayDir),e.center=Wi(of,e.center,i,1-t),yg(this.view,e,this._constraintOptions)))}};af=e([Se("esri.views.3d.state.controllers.ZoomStepControllerLocal")],af);const of=ke(),lf=Ve(0,0,1),hf=ke();class cf extends el{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,e=>this._handleDoubleClick(e))}_handleDoubleClick(e){const t=e.data;if(_o(t,"primary")){const i=this._view.state.isGlobal?new Y_({view:this._view,mode:"animation"}):new af({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.step(Math.log(.5)/Math.log(.6),re(t.x,t.y)),e.stopPropagation()}}}let df=class extends Oe{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;null!=e.spatialReference&&ni(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>ig(this.view,e,1))}};e([Ce({constructOnly:!0})],df.prototype,"view",void 0),df=e([Se("esri.views.3d.state.SurfaceCollisionConstraint")],df);let uf=class extends Oe{constructor(e){super(e),this.nearFarHeuristic=ai(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([B(()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far],()=>this._clipDistanceNearFarChanged()),B(()=>this.view.constraints?.clipDistance?.mode,()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",({camera:e,sceneDepthRange:t})=>this._updateCameraNearFar(e,t)),B(()=>this.view.stage.renderer.sceneDepthRange.value,()=>this._updateNearFar(),W),B(()=>this.view.renderDataExtent,()=>this._updateNearFar(),W),B(()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max],()=>this._updateAltitude(),W),B(()=>this.view.constraints?.tilt?.max,()=>this._updateTiltMax(),W),B(()=>this.view.constraints?.tilt?.mode,()=>this._updateTilt(),W),B(()=>this.view.state?.camera,()=>this._updateTiltAutoMax(),W),B(()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled],()=>this._updateCollision(),W)]),this.view.state.isLocal&&this.addHandles(B(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),N)),this._updateNearFar(),2!==this.view.state.viewingMode&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new df({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints?.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera(t=>pf(t,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e,t){const i=this.view.constraints?.clipDistance;"manual"===(i?i.mode:"auto")?pf(e,i):this._updateCameraNearFarAuto(e,i,t)}_updateCameraNearFarAuto(e,t,i){const s=si(this.view,e.eye),r=this.nearFarHeuristic.compute(e,this.view.renderDataExtent,i??this.view.stage.renderer.sceneDepthRange.value,s);e.near=r.near,e.far=r.far,t&&t.autoUpdate(e.near,e.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,t=!e||"stay-above"===e,i=this.view.state.constraints.collision;if(t!==i.enabled){i.enabled=t,t&&this._reapplyConstraints(8);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&2!==this.view.state.viewingMode?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Ti(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(Si(i))}}_updateLocalSurfaceDistance(e){if(null==e)return;let t=Math.max(e.width,e.height);if(t<=0)return;null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,s=3*t/Math.atan(i.camera.fov/2);s!==i.constraints.distance&&(i.constraints.distance=s)}_reapplyConstraints(e=15){this.view.state.updateCamera(t=>yg(this.view,t,new Fm(e,0,null)))}};function pf(e,t){t&&(e.near=t.near,e.far=t.far)}e([Ce({constructOnly:!0})],uf.prototype,"view",void 0),e([Ce({readOnly:!0})],uf.prototype,"surfaceCollisionConstraint",void 0),uf=e([Se("esri.views.3d.state.ConstraintsManager")],uf);let mf=class extends Vg{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=2,this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(null==e.spatialReference||ni(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),ig(this.view,e,1)||this.constraintEnabled||(this.state=3)})}};e([Ce({constructOnly:!0})],mf.prototype,"desiredCamera",null),mf=e([Se("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],mf);class gf{constructor(e,t,i){this._target=e,this._options=t,this.view=i,this.state="pending",this._animationController=null,this.promise=new Promise((e,t)=>{this._resolveCallback=e,this._rejectCallback=t;const i=new AbortController;null!=this._options.signal&&I(this._options.signal,()=>this.abort()),this._abortController=i,this._waitForReady()})}_resolve(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}_reject(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&null!=this._animationController&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject(A())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await Q(()=>this.view.ready,this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if("finished"!==this.state){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await yl(this.view,this._target,this._abortController.signal);if("finished"===this.state)return;const t=e?this._getCameraFromViewpoint(e):null;if(null==t)return;if(this._options.animate){if(null==this._animationController)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){const s=!!(this._target instanceof i&&this._target.camera||this._target instanceof t),r=e.camera;if(null==r)return null;if(!this.view.stateManager.isCompatible(r)){const e=r.position,t=e&&e.spatialReference,i=t?t.wkid:"none",s=this.view.spatialReference?.wkid;return this._reject(new n("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${i}, view: ${s})`,{camera:r})),null}const a=oi(this.view,r);return null==a?(this._reject(new n("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:a,isFullySpecified:s}}_startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(null==i)return void this._reject(new n("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.running||null==t.viewAnimation||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let s;e.isFullySpecified?(s=new mf({view:this.view,desiredCamera:e.camera}),ig(this.view,e.camera,1)):yg(this.view,e.camera),t.begin(e.camera,this._options);const r=e=>{if(null!=this.view.state)switch(t.state){case 4:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case 0:case 1:case 2:case 3:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(e)}}};i.when(()=>{const i=this.view.state.cameraController;s&&(i&&i.running?qg(i)&&null!=i.viewAnimation&&i.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=s):null!=t.viewAnimation&&t.viewAnimation.target===e.viewpoint&&4===t.state&&(this.view.state.cameraController=s))},e=>r(e)),t.asyncResult={resolve:()=>r(),reject:e=>r(e)}}_getAnimationController(){let e=null,t=null;const i=this.view.state.cameraController;return qg(i)&&(i.updateStateFromViewAnimation(),i.running&&(e=i,t=e.viewAnimation)),null==e&&(e=new jg({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e),1===e.state)?(t?.stop(),this._reject(new n("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):e}}let _f=class extends Oe{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=Pf,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return null!=this.renderState},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(e){this.viewStateManager._idleTimeout=e?Pf:0}},this._propertiesPool=new tl({frustum:li},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new ff}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([Z(()=>this.view.state.events,"before-camera-change",({camera:e})=>e&&this._updateElevation(e)),B(()=>this.view.state?.camera,(e,t)=>this._cameraChangedHandler(e,t),W)]),$(()=>this.view.state?.camera,e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([ee({prepare:()=>this._prepareFrame()}),B(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(Tf)}),Z(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=S(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=hi(this.view,this.view.state.camera,wf);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider?.enableCache(!0),this.setStateCamera(oi(this.view,e),{applyConstraints:!1})||C.getLogger(this).error("#camera=","Invalid camera",e),this.view.elevationProvider?.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=hi(this.view,this.view.state.contentCamera,wf);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=oi(this.view,e);this.view.state.contentCamera=null!=t?t:null}installContentCameraReset(e){if(this.removeHandles(Sf),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,s=qe(this.view.state.camera.center),r=e.sticky?this.contentCamera.clone():null;return this.addHandles([B(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles(Sf),this.test.contentCameraResetState.clear())}),B(()=>this.zoom,e=>{void 0!==e&&void 0!==t&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=r))}),B(()=>this.view.state.camera,e=>{const t=rs(s,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=r)})],Sf),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():C.getLogger(this).error("#center=","Invalid center",e):C.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):C.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){const e=this._get("extent");return e?fl.fromExtent(e):null}return wl(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=xl(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return null!=t?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||C.getLogger(this).error("#extent=","Invalid extent",e):C.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):C.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){const e=this.view.map;return e&&"initialViewProperties"in e?e.initialViewProperties?.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");const e=this.view.basemapTerrain.tilingScheme,t=this.view.pointsOfInterest.cameraOnSurface.scale;return e&&t?Cl(this.view,t,this.view.state.contentCamera,e):this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||C.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,s=this._get("padding"),r=Math.round(t[0]/i),n=Math.round(t[1]/i),a=Math.round(t[2]/i),o=Math.round(t[3]/i);return null!=s&&s.top===r&&s.right===n&&s.bottom===a&&s.left===o?s:{top:r,right:n,bottom:a,left:o}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,Cf),this.view.state.updateCamera(e=>e.padding=Cf))}_paddingToArray(e,t,i){e?rl(i,e.top||0,e.right||0,e.bottom||0,e.left||0):rl(i,0,0,0,0);for(let e=0;e<4;e++)i[e]=Math.round(i[e]*t)}get screenCenter(){const e=this.padding;return ne((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?vl(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e){if(!this.isCompatible(e)){const t=null!=e.camera?e.camera.position:e.targetGeometry,i=null!=t&&t.spatialReference;return void C.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||C.getLogger(this).error("#viewpoint=","Invalid viewpoint",e)}else C.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?Tl(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||C.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const i=this.view.stage.renderView.renderingContext?.parameters.maxTextureSize;return i&&Mn(this._tmpCanvasSize,i),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return null!=this._devicePixelRatioOverride?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?.stage?.renderer.isFeatureEnabled(8)??!1}get _usePhysicalPixelRenderingAny(){const e=this.view?.stage?.renderer;return e&&(e.isFeatureEnabled(8,2)||e.isFeatureEnabled(8,1)||e.isFeatureEnabled(8,0))}preinit(e){return!(this._isOverridden("center")&&!Ye(this.center.spatialReference,e)||this._isOverridden("camera")&&!Ye(this.camera.position.spatialReference,e)||this._isOverridden("extent")&&!Ye(this.extent.spatialReference,e)||!(!this._isOverridden("viewpoint")||Ye(this.viewpoint.targetGeometry?.spatialReference,e)&&Ye(this.viewpoint.camera?.position?.spatialReference,e)))}init(){this._constraintsManager=new uf({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const e=this._initialViewpoint||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):2===this.view.state.viewingMode&&this.addHandles($(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(Tf),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),Tf)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(Tf),this._constraintsManager=S(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},null!=this._gotoOperation&&this._gotoOperation.abort(t.animate),this._gotoOperation=new gf(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera(ci(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t?.cameraController;i&&(t.updateCamera(t=>i.stepController(e,t)),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){null!=this._gotoOperation&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:s}of vf){const r=e.has(i),n=this._isOverridden(i);!r&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(r||n)&&s.forEach(t=>e.add(t))}return t}_setInitialView(e){if(null==e||this._cameraSetByUser)return;if(e instanceof t)return void this.setStateCamera(oi(this.view,e),{applyConstraints:!1});if(e instanceof i){if(e.targetGeometry instanceof $e){const t=Sl(this.view,e.targetGeometry,0,.5,0);return void(null!=t&&this.setStateCamera(oi(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this._viewpointToCamera(e);return void this.setStateCamera(i,t)}const s=Sl(this.view,e,0,.5,0);null!=s&&this.setStateCamera(oi(this.view,s),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&yf.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return null!=e&&(e instanceof i?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof t?this.isCompatible(e.position):e.spatialReference&&!Ke(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=bf){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=xf){const{heading:s,tilt:r}=this._getPreservingHeadingTilt(),n=Pl(this.view,s,r,e,t,1);return null==n?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}_centerToCamera(e){let t;if(e.hasZ)t=this.view.state.camera.distance;else{const{centerOnContent:e}=this.view.pointsOfInterest;e.runTask(),t=e.distance}return this._centerPointAtDistanceToCamera(e,t)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),s=Sl(this.view,e,t,i,1,wf);return s?oi(this.view,s):null}_scaleToCamera(e){if(null==e)return null;const t=this.view,i=t.pointsOfInterest.centerOnContent;i.runTask();const s=i.renderLocation,r=t.pointsOfInterest.cameraOnSurface.renderLocation,n=Ml(t,e,t.state.contentCamera,s,r);return this._centerPointAtDistanceToCamera(s,n)}_zoomToCamera(e){return this._scaleToCamera(Rl(this.view,e))}_viewpointToCamera(e){return oi(this.view,bl(this.view,e))}setStateCamera(e,t){return!(null==e||!this.view.state.stopActiveCameraController()||(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up,i.fov=e.fov):i.copyFrom(e),t.applyConstraints&&yg(this.view,i)}),t.applyConstraints||(this.view.state.cameraController=new mf({view:this.view,desiredCamera:e})),0))}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._computeCanvasSize();if(0!==i.width&&0!==i.height&&(t.width===i.width&&t.height===i.height||(t.width=i.width,t.height=i.height),this.view.state)){const e=this.view.state.camera;e.fullWidth===i.width&&e.fullHeight===i.height&&e.pixelRatio===i.pixelRatio||(xf.copyFrom(e),xf.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,Cf),xf.padding=Cf),xf.fullWidth=i.width,xf.fullHeight=i.height,xf.pixelRatio=i.pixelRatio,this.view.state.camera=xf),this._updateViewState()}}_updateElevation(e){const t=this.view.basemapTerrain?.spatialReference,i=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,s=t?si(this.view,e.eye):0;e.relativeElevation=i-s}_updateViewState(){null!=this.test.renderState?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=0:this.view.interacting?this.view.state.mode=1:(0===this.view.state.mode&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=1:this.view.state.mode=2),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};e([Ce({type:t,dependsOn:["view.state.camera","ready"]})],_f.prototype,"camera",null),e([Ce({type:t,dependsOn:["view.state.contentCamera","ready"]})],_f.prototype,"contentCamera",null),e([Ce({type:Ze})],_f.prototype,"center",null),e([Ce()],_f.prototype,"visibleArea",null),e([Ce({type:$e})],_f.prototype,"extent",null),e([Ce({readOnly:!0})],_f.prototype,"frustum",null),e([Ce()],_f.prototype,"_constraintsManager",void 0),e([Ce({readOnly:!0})],_f.prototype,"constraintsManager",null),e([Ce()],_f.prototype,"_initialViewpoint",null),e([Ce({readOnly:!0})],_f.prototype,"hasInitialView",null),e([Ce({readOnly:!0,type:Boolean})],_f.prototype,"ready",void 0),e([Ce({type:Number})],_f.prototype,"scale",null),e([Ce()],_f.prototype,"padding",null),e([Ce({readOnly:!0})],_f.prototype,"screenCenter",null),e([Ce({constructOnly:!0})],_f.prototype,"view",void 0),e([Ce({type:i})],_f.prototype,"viewpoint",null),e([Ce({type:Number})],_f.prototype,"zoom",null),e([Ce({readOnly:!0})],_f.prototype,"_rasterPixelRatio",null),e([Ce({readOnly:!0})],_f.prototype,"_usePhysicalPixelRendering",null),e([Ce({readOnly:!0})],_f.prototype,"_usePhysicalPixelRenderingAny",null),e([Ce()],_f.prototype,"_windowDevicePixelRatio",void 0),e([Ce()],_f.prototype,"_devicePixelRatioOverride",void 0),_f=e([Se("esri.views.3d.state.ViewStateManager")],_f);class ff{constructor(){this.width=0,this.height=0,this.pixelRatio=1}}const yf=new Set(["camera","viewpoint","extent","scale","center","zoom"]),vf=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],bf={heading:0,tilt:0};let wf=new t,xf=new Do;const Cf=ul(),Tf="pending-initial-view",Sf="content-camera-reset",Pf=300;let Mf=class extends Vg{constructor(){super(...arguments),this.startCamera=new Do,this.currentCamera=new Do,this._isInteractive=!1,this._interactingTimeoutHandle=void 0}get isInteractive(){return this._isInteractive}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=2,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._isInteractive=!0,this._interactingTimeoutHandle?.remove(),this._interactingTimeoutHandle=k.setTimeout(()=>{this._isInteractive=!1,this._interactingTimeoutHandle=void 0},100),this.view.state.updateCamera(e=>this.stepController(0,e)),this.steppingFinished&&this.finishController()}};e([Ce({readOnly:!0})],Mf.prototype,"isInteractive",null),e([Ce()],Mf.prototype,"_isInteractive",void 0),Mf=e([Se("esri.views.3d.state.controllers.InteractiveController")],Mf);let Rf=class extends Mf{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=0,this._rotScale=0,this._lastPoint=Gs(),this._tmpWorldUp=ke(),this._tmpViewDir=ke(),this._tmpRotCurPoint=Gs(),this._tmpTransf=Fs(),this._tmpAxis=ke(),this._tmpPivotPoint=ke(),this._pivotPos=ke(),this._constraintOptions=new Fm(15,2,0,this.startCamera)}initialize(){this._rotScale=0===this.pivot?3:1.5}begin(e){if(this.running){switch(this.pivot){case 1:Zi(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=3,this._constraintOptions.tiltMode=1,this._constraintOptions.selection=0;break;case 0:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.basemapTerrain.invisible?Yg:{});t||Zi(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=2,this._constraintOptions.tiltMode=0,this._constraintOptions.selection=11;break}}Kg(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const i=this.startCamera,s=ke();Yi(s,this._pivotPos,i.eye);const r=$i(s),n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,Df);let a=Math.max(R_(Df,i.viewForward,5)*n,10);t&&(a=Math.min(r,a));const o=re(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),l=c_(this.startCamera,o,this.view.renderCoordsHelper,this.view.viewingMode);let h=this.view.stage.renderView.getMinimalDepthForArea(rf(this.view),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,225,90),c=this.view.stage.renderView.getMinimalDepthForArea(rf(this.view),e[0],e[1],i,90);null==h&&null==c||(h=h??c??0,c=null==c||1===l?h:c,a=h>c?c:h,a=t?Math.min(a,r):a),Ni(s,s),Zi(this._pivotPos,Ki(this._tmpPivotPoint,i.eye,Bi(this._tmpPivotPoint,s,a)))}update(e){if(this.running){switch(this.pivot){case 1:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case 0:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}yg(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(e,t,i,s){this.view.renderCoordsHelper.worldUpAtPosition(s,this._tmpWorldUp),Kg(e,t,this._tmpRotCurPoint);let r=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,n=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;Yi(this._tmpViewDir,i,s);const a=$i(this._tmpViewDir),o=Mi(Gi(this._tmpViewDir,this._tmpWorldUp)/a);if(1===this.pivot){r*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;r=e-Math.max(-t,Math.min(t,e+r))}return r=Ci(r+o,Ip.min,Ip.max)-o,ss(this._tmpAxis,e.up,this._tmpViewDir),0===this.pivot&&(n=-n),Cs(this._tmpTransf,n,this._tmpWorldUp),Ss(this._tmpTransf,this._tmpTransf,r,this._tmpAxis),es(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=es(Of,e.up,this._tmpTransf),Ki(Of,s,this._tmpViewDir),Us(this._lastPoint,this._tmpRotCurPoint),Of}};e([Ce()],Rf.prototype,"pivot",void 0),Rf=e([Se("esri.views.3d.state.controllers.RotateController")],Rf);const Of=ke(),Df=ke();class Af extends el{constructor(e,t,i,s){super(!0),this._view=e,this.pointerActions=t,this._pivot=i,this.registerIncoming("drag",s,e=>this._handleDrag(e))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!fo(e.data,this.pointerActions))return;const i=re(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Rf({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}const Ef="esri-fov-overlay",If={base:Ef,outer:`${Ef}-outer`,reset:`${Ef}-reset`,text:`${Ef}-text`};let Lf=class extends Ll{constructor(e){super(e),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return Fl("div",{class:If.outer},Fl("div",{class:If.base},Fl("p",{class:If.text},this._overlay),Fl("p",{class:If.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){const{fov:e,_messagesUnits:t}=this;if(!t||null==e)return"";const i=El(Si(e),"degrees","arithmetic","arithmetic",0),s=kf/(2*Math.tan(e/2));return`${i} | ${Il(t,s,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&null!=this.fov?"↺":""}};e([Ce()],Lf.prototype,"onReset",void 0),e([Ce(),Vl("esri/t9n/common")],Lf.prototype,"_messagesCommon",void 0),e([Ce(),Vl("esri/core/t9n/Units")],Lf.prototype,"_messagesUnits",void 0),e([Ce()],Lf.prototype,"fov",void 0),e([Ce()],Lf.prototype,"_overlay",null),e([Ce()],Lf.prototype,"_reset",null),Lf=e([Se("esri.widgets.FovOverlay")],Lf);const kf=Math.sqrt(1872);let Vf=class extends Mf{constructor(e){super(e),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov(Ff),this.updateTimeout()},this._center=ke(),this._viewForward=ke(),this._constraints=new Fm(15,1)}begin(e){!function(e){return!Array.isArray(e)}(e)?(this._lastDrag=e[1],this._startSize=null,this._ensureStartSize(this.view.state.camera)):this._showOverlay().fov=e.fov}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(e){if(null==this._lastDrag)return this._lastDrag=e[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);const t=-(this._lastDrag-e[1])/2;this._lastDrag=e[1],this.step(t)}step(e){if(!this.running)return void(this._startSize=this._lastDrag=null);const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),s=Si(i.fov)+e,r=Ti(Ci(s,jf,zf));r!==i.fov?this._setFov(r):this._showOverlay().fov=i.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(e){super.onControllerEnd(e),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new Al({id:"esri.FovOverlay",node:new Lf({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=S(this._overlay))}_setFov(e){const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),s=this._ensureStartSize(i)/Math.tan(e/2),r=Ki(Hf,this._center,Bi(Hf,this._viewForward,-s));i.eye=r,i.fov=e,this._constraints.interactionStartCamera=t.camera,this._constraints.interactionFactor=vg(this.currentCamera.height-t.camera.height),yg(this.view,this.currentCamera,this._constraints),this.begin(i),this.commitCamera()}_ensureStartSize(e){if(null==this._startSize){Zi(this._viewForward,e.viewForward);const t=this.view.stage.renderView.getMinimalDepthForArea(null,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,80),i=Xi(e.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),s=t??i;Ki(this._center,e.eye,Bi(Hf,this._viewForward,s)),this._startSize=s*Math.tan(e.fov/2)}return this._startSize}};e([Ce()],Vf.prototype,"onStop",void 0),Vf=e([Se("esri.views.3d.state.controllers.FovController")],Vf);const Ff=Ti((new t).fov),jf=10,zf=150,Hf=ke();let qf=class extends Mf{constructor(){super(...arguments),this._pickPoint=ke(),this._tmpP0=Gs(),this._panAxisAngle=Ug(),this._tmpRayDir=ke(),this._tmpRayDirPick=ke(),this._targetOnSphere=ke(),this._navigationMode=1,this._tmpRay={origin:ke(),direction:ke()},this.dragBeginPoint=re(),this._normalizedAnchorPoint=Gs(),this._constraintOptions=new Fm(7,1,0,this.startCamera),this._sphere=$a(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;Us(this.dragBeginPoint,e),Kg(this.startCamera,e,this._normalizedAnchorPoint);const t=ge(this.view.spatialReference),i=h_(this._intersectionHelper,this.startCamera,e,t.radius,0,this.view.basemapTerrain.invisible?Yg:{});if(this._navigationMode=c_(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),1===this._navigationMode)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let t;Ko(this.startCamera,e,this._tmpRay),Ni(this._tmpRay.direction,this._tmpRay.direction),null!=i.scenePickPoint&&(Yi(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),t=$i(this._tmpRayDirPick));const s=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,Bf);const r=Ci(R_(Bf,this._tmpRay.direction,30)*s,Qg[0],Qg[1]),n=this.view.stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,80);let a=null!=n?n:r;null!=t&&(a=Math.min(a,t)),this._hasPickPoint=!0,Bi(this._tmpRay.direction,this._tmpRay.direction,a),Ki(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,1===this._navigationMode){Yi(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=$i(this._tmpRayDir);Kg(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=t*2**i;const r=this.view.state.constraints.minimumPoiDistance;if(i<0&&s<r&&(s=r),Math.abs(t-s)<1e-6)return;if(this._hasPickPoint&&s<t){const e=1-(1-s/t)*(1-this._sphere[3]/$i(this.currentCamera.center));this.currentCamera.center=Bi(Uf,this.currentCamera.center,e)}Bi(this._tmpRayDir,this._tmpRayDir,-s/t),this.currentCamera.eye=Ki(Uf,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=vg(Bs(this.dragBeginPoint,e)),yg(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(p_(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),Ng(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Jg(this.currentCamera,Qa(this._sphere),this._panAxisAngle))}else{const t=$i(this._tmpRay.direction);Kg(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=t*2**i;const r=this.view.state.constraints.minimumPoiDistance;if(i<0&&s<r&&(s=r),Math.abs(t-s)<1e-6)return;Bi(this._tmpRayDir,this._tmpRay.direction,1-s/t),this.currentCamera.eye=Ki(Uf,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=Ki(Uf,this.currentCamera.center,this._tmpRayDir)}ig(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}};qf=e([Se("esri.views.3d.state.controllers.ZoomControllerGlobal")],qf);const Uf=ke(),Bf=ke();let Nf=class extends Mf{constructor(){super(...arguments),this._tmpP=ke(),this._tmpDir=ke(),this._tmpN=ke(),this._tmpP0=Gs(),this._tmpPoi=ke(),this._tmpRayDir=ke(),this.dragBeginPoint=re(),this._normalizedAnchorPoint=Gs(),this._constraintOptions=new Fm(15,1,0,this.startCamera,ke()),this._plane=Bo()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;Us(this.dragBeginPoint,e),Kg(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.basemapTerrain.invisible?Yg:{});Yi(this._tmpDir,this._tmpP,this.startCamera.eye);const i=$i(this._tmpDir);Ni(this._tmpDir,this._tmpDir);const s=Math.abs(this.view.camera.position.z),r=Ci(R_(Wf,this._tmpDir,30)*s,Qg[0],Qg[1]),n=this.view.stage.renderView.getMinimalDepthForArea(rf(this.view),e[0],e[1],this.view.state.camera,80);let a=null!=n?n:r;t&&(a=Math.min(a,i)),Bi(this._tmpDir,this._tmpDir,a),Ki(this._tmpP,this.startCamera.eye,this._tmpDir),Yi(this._tmpN,this.startCamera.eye,this.startCamera.center),Ni(this._tmpN,this._tmpN),this._tmpN[1]<0&&ns(this._tmpN,this._tmpN),Wo(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.running)return;(function(e,t,i,s){return Go(e,Xo(t,i,Q_),s)})(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||Zi(this._tmpPoi,this.currentCamera.center),Kg(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);Us(this._normalizedAnchorPoint,this._tmpP0),Yi(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=$i(this._tmpRayDir);let s=i*(1-t);this._constraintOptions.interactionDirection&&(Zi(this._constraintOptions.interactionDirection,this._tmpRayDir),Bi(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));const r=this.view.state.constraints.minimumPoiDistance;t>=0&&s<r&&(s=r,t=-(s-i)/i),Math.abs(i-s)<1e-6||(Bi(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=Ki(Gf,this.currentCamera.eye,this._tmpRayDir),Wi(Gf,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?Gf[2]=Math.max(this.startCamera.center[2],Gf[2]):Gf[2]=Math.min(this.startCamera.center[2],Gf[2]),this.currentCamera.center=Gf,this._constraintOptions.interactionFactor=vg(Bs(this.dragBeginPoint,e)),yg(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}};Nf=e([Se("esri.views.3d.state.controllers.ZoomControllerLocal")],Nf);const Gf=ke(),Wf=Ve(0,0,1);class $f extends el{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._fovModifier=i,this.registerIncoming("drag",[i],e=>this._handleZoom(e)),this.registerIncoming("drag",e=>this._handleZoom(e))}_handleZoom(e){const t=e.data;if(t.pointers.size>1)return;if(!fo(e.data,this.pointerActions))return;const i=re(t.center.x,t.center.y);switch(t.action){case"start":{this._cameraController?.finish();const t=this._view,s=e.modifiers.has(this._fovModifier);this._cameraController=s?new Vf({view:t,onStop:()=>this._stopController()}):t.state.isGlobal?new qf({view:t}):new Nf({view:t}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break}case"update":this._cameraController?.update(i);break;case"end":this._cameraController instanceof Vf?this._cameraController.updateTimeout():this._stopController()}e.stopPropagation()}_stopController(){this._cameraController?.finish(),this._cameraController=null}}let Qf=class extends Mf{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new Do,this._headingStart=0,this._constraintOptions=new Fm(15,0,0,new Do,null,1)}handleEventGamepad(e){const t=yo(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||vo(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,bo(this._keysButtonState,this._transformation)}directionActive(e){return 1===this._keysButtonState[e]}countActiveDirections(){return this._keysButtonState.reduce((e,t)=>t>0?e+1:e,0)}deactivateDirection(e){this._keysButtonState[e]=0;const t=bo(this._keysButtonState,this._transformation);vo(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,iy),this._applyDisabledMovementTypes(iy),this._applyPan(iy.pan),this._applyRotate(iy.rotate),this._applyZoom(iy.zoom),this._applyAscend(iy.ascend),this._constraintOptions.interactionType=0,this._constraintOptions.selection=8,yg(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;Yi(sy,t.center,t.eye),es(sy,sy,e.matrix),t.center=Ki(sy,sy,t.eye),t.up=es(sy,t.up,e.matrix),this._constraintOptions.interactionType=3,this._constraintOptions.selection=7,yg(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=es(sy,t.eye,e.matrix),t.center=es(sy,t.center,e.matrix),this.view.state.isGlobal&&(t.up=es(sy,t.up,e.matrix)),this._constraintOptions.interactionType=4,this._constraintOptions.selection=15,yg(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=Ki(sy,this.currentCamera.eye,Bi(qo.get(),t,e)),Zi(ry,t),ns(ry,ry),this._constraintOptions.interactionDirection=ry,this._constraintOptions.interactionType=1,this._constraintOptions.selection=7,yg(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,qo.get());if(this._constraintOptions.interactionDirection=Zi(ry,t),this.view.state.isGlobal){const t=$i(this.currentCamera.eye),i=(t+e)/t;this.currentCamera.eye=Bi(sy,this.currentCamera.eye,i),this.currentCamera.center=Bi(sy,this.currentCamera.center,i)}else{const i=Bi(qo.get(),t,e);this.currentCamera.eye=Ki(sy,this.currentCamera.eye,i),this.currentCamera.center=Ki(sy,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=5,this._constraintOptions.selection=8,yg(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=7,yg(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,Rs(e.pan.matrix),e.rotate.enabled=!1,Rs(e.rotate.matrix)}(i);const s=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(s,t,i):this._calculateControlTransformationGlobal(s,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,sy)}_calculateControlTransformationLocal(e,t,i){const{viewRight:s,viewForward:r}=t,n=this._transformation,a=this.view.navigation.gamepad,o=qi(qo.get(),r[0],r[1],0);Ni(o,o);const l=n.translation[0]*e.pan;if(0!==l){const e=Bi(qo.get(),s,l);Ms(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(a.mode){case"pan":{const t=-n.translation[1]*e.pan;if(0!==t){const e=Bi(qo.get(),o,t);Ms(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=n.zoom*e.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:c(a.mode)}const h=n.translation[2]*e.ascend;i.ascend=h;const d=-n.heading*e.rotate;0!==d&&(Ss(i.rotate.matrix,i.rotate.matrix,d,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,qo.get())),i.rotate.enabled=!0);const u=n.tilt*e.rotate,p=ri(this.view.renderCoordsHelper,t.center,t.eye),m=Ci(p+u,Ip.min,Ip.max)-p;m&&(Ss(i.rotate.matrix,i.rotate.matrix,m,s),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:s,viewRight:r}=t,n=this._transformation,a=this.view.navigation.gamepad,o=ss(qo.get(),r,s);Ni(o,o),ns(o,o),function(e,t,i,s,r,n,a,o,l){S_(e.center,Gi(e.up,e.center),$i(e.center),-Vo.normalize(Ti(n)),a,t.aboveGround)?function(e,t,i,s,r,n){const{eye:a}=e;Rt([0,0,1],a,O_,D_,A_);const o=t.translation[0]*i.pan,l="zoom"===r.mode?0:t.translation[1]*i.pan,h=Math.max(Math.sqrt(Math.abs(1-Gi(e.center,O_)**2/$i(e.center)**2)),.5),c=(Math.sin(n)*l+Math.cos(n)*o)/h,d=-Math.cos(n)*l+Math.sin(n)*o;switch(Ss(s.pan.matrix,s.pan.matrix,c,O_),s.pan.enabled=!0,r.mode){case"pan":Ss(s.pan.matrix,s.pan.matrix,d,D_),s.pan.enabled=!0;break;case"zoom":s.zoom=-t.translation[1]*i.zoom}}(t,i,s,o,l,-Vo.normalize(Ti(r))):function(e,t,i,s,r){const{eye:n,viewRight:a}=e,o=ss(qo.get(),a,n),l=t.translation[0]*i.pan;switch(0!==l&&(Ss(s.pan.matrix,s.pan.matrix,-l,o),s.pan.enabled=!0),r.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&(Ss(s.pan.matrix,s.pan.matrix,e,a),s.pan.enabled=!0);break}case"zoom":s.zoom=-t.translation[1]*i.zoom}}(t,i,s,o,l)}(this.startCamera,t,n,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,a),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(iy.pan,this._tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=n.translation[2]*e.ascend;i.ascend=h;const c=-n.heading*e.rotate;0!==c&&(Ss(i.rotate.matrix,i.rotate.matrix,c,this._tmpCamera.eye),i.rotate.enabled=!0);const d=n.tilt*e.rotate,u=this._clampTiltDeltaGlobalToValidRange(d,t.ray,l);0!==u&&(Ss(i.rotate.matrix,i.rotate.matrix,u,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const s=ge(this.view.spatialReference),r=n_(Ip.min,t.origin,i,s);let n=0,a=0;const o=qo.get();return this.view.renderCoordsHelper.intersectManifold(t,i,o)?(n=n_(ri(this.view.renderCoordsHelper,o,t.origin),t.origin,i,s),a=n_(Ip.max,t.origin,i,s)):(Na(Ga(Wa,i+s.radius),t,o),n=a_(Math.PI+jo(t.direction,o),t.origin,i,s),a=a_(Ip.max,t.origin,i,s)),Ci(n+e,r,a)-n}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:s}=this.view,r=s.getAltitude(e),n=t+Math.abs(r-t);return s.setAltitude(i,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:s}=this.view.state,{direction:r}=Ol(this.view,t,0,Yf,ny),n=i.intersectManifoldClosestSilhouette(Ha(t,r),e,qo.get()),a=Xi(t,n),o=i.intersectManifoldClosestSilhouette(Ha(t,Ji(qo.get(),t,s.center)),e,qo.get()),l=Xi(t,o);return Math.min(a,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:s,isGlobal:r}=i,n=t.intersectManifoldClosestSilhouette(s.ray,this._filteredSurfaceElevation,qo.get());if(r){const t=Yi(qo.get(),e,n),i=$i(t);Bi(t,t,1/i);const s=Ni(qo.get(),e),r=Mi(Gi(s,t));return i*Math.sin(Math.min(Kf,r))}{const i=Zi(qo.get(),e);return t.setAltitude(i,this._filteredSurfaceElevation),Xi(n,i)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:Jf}_computeVelocities(e){const t=this._filteredSurfaceElevation,i=t+ge(this.view.spatialReference).radius,{camera:s,isGlobal:r}=this.view.state,n=qo.get(),a=this._getPointAbsoluteSurfaceElevation(s.eye,t,n),o=this._clampedDistanceToSurface(t,n),l=s.width/2,h=Xf*s.width,c=Xf*s.width,d=o*Math.tan(.5*s.fovX)/l,u=d/i,p=d/this._computeHeadingRotateRadius(n),m=a-t;return{pan:(r?u:d)*h*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(h*e/l)*m-m),zoom:2**(h*e/l)*o-o,rotate:Ci(p*c,ey,ty)*e}}_applyDisabledMovementTypes(e){null==this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Rs(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Rs(e.rotate.matrix))}static activatesFor(e,t){const i=yo(t,e.navigation.gamepad,Zf);return!("end"===t.action||vo(i))}};e([Ce({constructOnly:!0})],Qf.prototype,"gamepadDevice",void 0),e([Ce({constructOnly:!0})],Qf.prototype,"disableMovements",void 0),Qf=e([Se("esri.views.3d.state.controllers.GamepadKeyboardController")],Qf);const Zf={translation:[0,0,0],heading:0,tilt:0,zoom:0},Yf=80,Kf=Ti(Yf),Xf=.75,Jf=5,ey=Ti(30),ty=Ti(80),iy={zoom:0,ascend:0,pan:{enabled:!1,matrix:Fs()},rotate:{enabled:!1,matrix:Fs()}},sy=ke(),ry=ke(),ny=di();class ay extends el{constructor(e){super(!0),this._view=e,this._watchHandles=new jl,this._handle=this.registerIncoming("gamepad",e=>this._handleEventGamepad(e)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([B(()=>this._view.navigation.gamepad.enabled,e=>{e?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},N),B(()=>this._view.navigation.gamepad.device,e=>{this._cameraControllerGamepad&&e&&this._cameraControllerGamepad.gamepadDevice!==e&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this._cameraControllerGamepad?.running;if(i||Qf.activatesFor(this._view,e.data)){if(!i){const t=new Qf({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(t),1!==t.state&&(this._cameraControllerGamepad=t)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}class oy extends el{constructor(e,t){super(!0),this._view=e,this._keyToDirection=new Map,this._keyToAction=new Map,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._addKeysMapping(t),this.registerIncoming("key-down",null,e=>this._handleKeyDown(e)),this.registerIncoming("key-up",null,e=>this._handleKeyUp(e)),this.registerIncoming("blur",null,()=>this._handleStop()),this._visibilityHandle=wo(e=>e?null:this._handleStop())}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}setStickyKeyDuration(e){this._stickyKeyDuration=e}_addKeysMapping(e){this._addKeyMapping(e.pan.left,0),this._addKeyMapping(e.pan.right,1),this._addKeyMapping(e.pan.forward,2),this._addKeyMapping(e.pan.backward,3),this._addKeyMapping(e.pan.up,4),this._addKeyMapping(e.pan.down,5),this._addKeyMapping(e.lookAround.headingLeft,6),this._addKeyMapping(e.lookAround.headingRight,7),this._addKeyMapping(e.lookAround.tiltUp,8),this._addKeyMapping(e.lookAround.tiltDown,9),this._addKeyMapping(e.zoom.zoomIn,10),this._addKeyMapping(e.zoom.zoomOut,11),this._addKeyAction(e.reset.heading,()=>this._resetHeading()),this._addKeyAction(e.reset.tilt,()=>this._resetTilt())}_addKeyMapping(e,t){for(const i of this._eachKey(e))this._keyToDirection.set(i,t)}*_eachKey(e){"string"==typeof e?yield e:yield*e}_addKeyAction(e,t){for(const i of this._eachKey(e))this._keyToAction.set(i,t)}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToAction.get(e.data.key);if(null!=t)return e.stopPropagation(),void t();const i=this._keyToDirection.get(e.data.key);if(null!=i&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new Qf({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(e.stopPropagation(),this._cameraControllerKeyboard.directionActive(i))return;if(this._cameraControllerKeyboard.activateDirection(i),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(i))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout(()=>{this._stickyKeyTimeoutHandle=void 0,null!=this._stickyDirection&&void 0!==this._stickyDirection&&(this._cameraControllerKeyboard?.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)},this._stickyKeyDuration))}}_handleStop(){this._cameraControllerKeyboard?.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey||!this._cameraControllerKeyboard?.running)return;const t=this._keyToDirection.get(e.data.key);if(null==t)return;e.stopPropagation();const i=void 0===this._stickyKeyTimeoutHandle;void 0===this._stickyKeyTimeoutHandle||1!==this._cameraControllerKeyboard?.countActiveDirections()?(this._cameraControllerKeyboard?.deactivateDirection(t),i&&(this._stickyDirection=void 0)):this._stickyDirection=t}_isPanning(e){return e<=3}_resetHeading(){this._view.goTo({heading:0}).catch(()=>{})}_resetTilt(){this._view.goTo({tilt:0}).catch(()=>{})}}class ly extends el{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",[t],e=>this._handleFov(e)),this.registerIncoming("mouse-wheel",e=>this._handleZoom(e))}_handleZoom(e){if(!this._mouseWheelZoomEnabled)return;const t=e.data;this._zoomController?.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new Y_({view:this._view,mode:"interaction"}):new af({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-t.deltaY/60,re(t.x,t.y)),e.preventDefault(),e.stopPropagation()}_handleFov(e){this._mouseWheelZoomEnabled&&(this._fovController?.running||(this._zoomController?.finish(),this._fovController?.hideOverlay(),this._fovController=new Vf({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),1!==this._fovController.state)?(this._fovController.updateTimeout(),this._fovController.step(e.data.deltaY/20),e.preventDefault(),e.stopPropagation()):this._stopFovController())}get _mouseWheelZoomEnabled(){return"zoom"===this._view.navigation.actionMap.mouseWheel}_stopFovController(){this._fovController?.finish(),this._fovController=null}}class hy{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let cy=class extends Fg{constructor(){super(...arguments),this._beginCamera=new Do,this._elapsedTimeSec=0,this.constraintOptions=new Fm(15,4,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new Yt}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),yg(this.view,t,this.constraintOptions)}};cy=e([Se("esri.views.3d.state.controllers.momentum.MomentumController")],cy);let dy=class extends cy{constructor(e){super(e),this.interactionType=4,this._tmpPan=ke()}momentumStep(e,t){const i=this.momentum.value(e);Bi(this._tmpPan,this.momentum.direction,i),t.eye=Yi(uy,t.eye,this._tmpPan),t.center=Yi(uy,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};e([Ce({constructOnly:!0})],dy.prototype,"momentum",void 0),dy=e([Se("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],dy);const uy=ke(),py=ke(),my=ke();let gy=class extends cy{constructor(e){super(e),this.interactionType=4}momentumStep(e,t){const i=this.momentum.value1(e),s=this.momentum.value2(e);Zi(my,t.eye),Ni(my,my),ss(this.momentum.axis2,my,this.momentum.axis1),x_(t,py,this.momentum.axis1,i,this.momentum.axis2,s)}};e([Ce({constructOnly:!0})],gy.prototype,"momentum",void 0),gy=e([Se("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],gy);let _y=class extends cy{set center(e){this._set("center",Fe(e))}set axis(e){this._set("axis",Fe(e))}constructor(e){super(e),this.interactionType=2}momentumStep(e,t){const i=this.momentum.value(e);Jg(t,this.center,Bg(this.axis,i))}};e([Ce({constructOnly:!0})],_y.prototype,"momentum",void 0),e([Ce({constructOnly:!0})],_y.prototype,"center",null),e([Ce({constructOnly:!0})],_y.prototype,"axis",null),_y=e([Se("esri.views.3d.state.controllers.momentum.RotationMomentumController")],_y);let fy=class extends cy{set zoomCenter(e){this._set("zoomCenter",Fe(e))}constructor(e){super(e),this.interactionType=1,this.constraintOptions.interactionDirection=ke()}momentumStep(e,t){const{interactionDirection:i}=this.constraintOptions;if(!i)return;Zi(i,t.eye);const s=this.momentum.valueDelta(0,e);t_(t,this.zoomCenter,s,this.view.state.constraints.minimumPoiDistance),Ji(i,t.eye,i)}};e([Ce({constructOnly:!0})],fy.prototype,"momentum",void 0),e([Ce({constructOnly:!0})],fy.prototype,"zoomCenter",null),fy=e([Se("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],fy);let yy=class extends cy{set screenCenter(e){this._set("screenCenter",re(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",Fe(e))}constructor(e){super(e),this.interactionType=1,this.radius=0,this._tmpSceneCenter=ke(),this._tmpZoomAxisAngle=Ug(),this._sphere=$a()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);i_(this._sphere,t,i),this.constraintOptions.interactionType=1,yg(this.view,t,this.constraintOptions),p_(this._sphere,t,this.screenCenter,this._tmpSceneCenter),Ng(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Jg(t,Qa(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=4}};e([Ce({constructOnly:!0})],yy.prototype,"momentum",void 0),e([Ce({constructOnly:!0})],yy.prototype,"screenCenter",null),e([Ce({constructOnly:!0})],yy.prototype,"sceneCenter",null),e([Ce({constructOnly:!0})],yy.prototype,"radius",void 0),yy=e([Se("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],yy);class vy{constructor(e){this._gain=e}update(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}const by=1e-5;class wy extends Hl{constructor(e,t,i,s,r,n=0,a){super(e,t,i),this._angularVelocity1=s,this.axis1=r,this.angularVelocity2=n,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class xy{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._tmpAxis1=ke(),this._tmpAxis2=ke(),this._tmpAngles=Gs(),this._time=new zl(.3),this._screen=[new zl(.4),new zl(.4)],this._angle1=new vy(.6),this._angle2=new vy(.6),this._axis1=ke(),this._axis2=ke(),this._lastScene=ke()}addMomentumDirectRotation(e,t,i,s,r,n){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let e=f_(this._lastScene,t,this._tmpAxis2,s,r,n);this._angle2.update(0),ts(this._tmpAxis2)<by?e=0:Ni(this._axis1,this._tmpAxis2),this._angle1.update(e),Zi(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,s,r,n,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;b_(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,s,r,n,a,!1),ts(this._tmpAxis2)<by?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),Ni(this._axis1,this._tmpAxis1),Ni(this._axis2,this._tmpAxis2)),Zi(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?null:Math.sqrt(e*e+t*t),s=this._time.filteredDelta,r=null==i||null==s?0:i/s;return Math.abs(r)<this._minimumInitialVelocity?null:this.createMomentum(r,this._stopVelocity,this._friction)}createMomentum(e,t,i){const s=this._time.filteredDelta,r=this._angle1.filteredValue,n=this._angle2.filteredValue,a=null==s||null==n?0:n/s;return new wy(e,t,i,null==s||null==r?0:r/s,this._axis1,a,this._axis2)}}let Cy=class extends Mf{constructor(){super(...arguments),this._smoothRotation=new hy(.05),this._rotationAxis=ke(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=Bo(),this._beginRadius=0,this._smoothScaling=new hy(.05),this._zoomCenterScreen=re(),this._zoomMomentumEstimator=new ql,this._rotationMomentumEstimator=new Ul,this._panSphericalMomentumEstimator=new xy,this._panPlanarMomentumEstimator=new Bl,this._adjustedSphere=$a(),this._tmp3d=ke(),this._tmpScreenPointArray=re(),this._beginScreenPoint=re(),this._beginScenePoint=ke(),this._screenPickPoint=re(),this._scenePickPoint=ke(),this._navMode=1,this._sphere=$a(),this._pointerCount=0,this._tmpInteractionDirection=ke(),this._beginCamera=new Do,this._constraintOptions=new Fm(15,0,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-Vo.normalize(Ti(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),ae(e.center,this._screenPickPoint),Us(this._beginScreenPoint,this._screenPickPoint);const t=h_(this._intersectionHelper,this.startCamera,this._screenPickPoint,ge(this.view.spatialReference).radius,1,this.view.basemapTerrain.invisible?Yg:{});null!=t.scenePickPoint&&(this._scenePickPoint=t.scenePickPoint,this._sphere=t.sphere,Zi(this._beginScenePoint,this._scenePickPoint),this._navMode=c_(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),0===this._navMode&&this._preparePlanarPanMode(e,t.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;1===this._navMode?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return 1===this._navMode?new yy({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new fy({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new _y({view:this.view,momentum:i,center:Qa(this._sphere),axis:this._rotationAxis});if(1===this._navMode){const e=this._panSphericalMomentumEstimator.evaluateMomentum();if(e)return new gy({view:this.view,momentum:e})}else{const e=this._panPlanarMomentumEstimator.evaluateMomentum();if(e)return new dy({view:this.view,momentum:e})}return null}_preparePlanarPanMode(e,t){const i=ns(this._tmp3d,this.startCamera.viewForward);Wo(this._scenePickPoint,i,this._panningPlane);const s=re(this._screenPickPoint[0],0),r=ke(),n=$i(this.startCamera.eye);this._adjustedSphere[3]=n<this._sphere[3]?n-100:this._sphere[3],p_(this._adjustedSphere,this.startCamera,s,r);const a=oe();this.startCamera.projectToRenderScreen(r,a);const o=ke(),l=ke(),h=ke();Yi(o,this._scenePickPoint,this.currentCamera.eye);const c=$i(o);Ni(o,o);const d=5*Math.max(Math.abs(this.view.camera.position.z),50),u=this.view.stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,80);let p=null!=u?u:d;t&&(p=Math.min(p,c)),Zi(h,Ki(l,this.currentCamera.eye,Bi(l,o,p))),this._panningPlane[3]=-Gi($o(this._panningPlane),h),this.startCamera.center=Ki(l,this.startCamera.eye,Bi(l,this.startCamera.viewForward,p));const m=ae(e.center,this._tmpScreenPointArray);e_(this._panningPlane,this.startCamera,m,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),i_(this._sphere,this.currentCamera,this._smoothScaling.value),ae(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=vg(e.radius-this._beginRadius),yg(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=ae(e.center,this._tmpScreenPointArray);p_(this._sphere,this.currentCamera,t,this._tmp3d),S_(this._beginScenePoint,Gi(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera.aboveGround)?(M_(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(P_(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=vg(Bs(this._screenPickPoint,t)),yg(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){Ni(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||ns(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,i=t+Xg(e.angle-t),s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(i);const r=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(r,.001*e.timestamp),Jg(this.currentCamera,Qa(this._sphere),Bg(this._rotationAxis,r)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=vg(e.radius*i),yg(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=ae(e.center,this._tmpScreenPointArray);e_(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(d_(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=vg(Bs(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),yg(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),t_(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=vg(e.radius-this._beginRadius),yg(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){Zi(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||ns(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let i=e.angle-t;i=Xg(i);const s=t+i,r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(s);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),Jg(this.currentCamera,Qa(this._sphere),Bg(this._rotationAxis,n)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=vg(e.radius*n),yg(this.view,this.currentCamera,this._constraintOptions)}};Cy=e([Se("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],Cy);const Ty=Ve(0,0,1);let Sy=class extends Mf{constructor(){super(...arguments),this._rotationValueSmooth=new hy(.05),this._scalingValueSmooth=new hy(.05),this._planeHorizontal=Bo(),this._planeVertical=Bo(),this._rotationMomentumEstimator=new Ul,this._panMomentumEstimator=new Bl(300,12,.9),this._zoomMomentumEstimator=new ql,this._beginRadius=0,this._beginCenter=ke(),this._beginAngle=0,this._tmpPoints=[],this._navMode=1,this._beginCenterScreen=re(),this._tmpCentroid3d=ke(),this._tmpCentroid2d=re(),this._tmp2d=re(),this._pointerCount=0,this._beginCamera=new Do,this._constraintOptions=new Fm(15,0,0,this._beginCamera)}begin(e){if(!this.running)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),ae(e.center,this._beginCenterScreen),No(Ty,0,this._planeHorizontal);const i=ke(),s=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.basemapTerrain.invisible?Yg:{}),r=ke();ns(r,this.startCamera.viewForward);const n=ke();Zi(n,Ty);const a=Gi(r,n);this._navMode=c_(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const o=R_(n,this.startCamera.viewForward,5)*Math.max(Math.abs(this.view.camera.position.z),50);Qo(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||Zo(this._planeHorizontal,this._planeHorizontal);const l=ke(),h=ke(),c=ke();Yi(l,i,this.currentCamera.eye);const d=$i(l);if(Ni(l,l),0===this._navMode){Bi(n,n,a),Yi($o(this._planeVertical),r,n),Ni($o(this._planeVertical),$o(this._planeVertical)),Qo(this._planeVertical,this._planeVertical,i);const t=this.view.stage.renderView.getMinimalDepthForArea(rf(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,80);let u=null!=t?t:o;s&&(u=Math.min(u,d)),Zi(c,Ki(h,this.currentCamera.eye,Bi(h,l,u))),this._planeVertical[3]=-Gi($o(this._planeVertical),c),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),r_(this._tmpPoints,this._beginCenter)}else{const t=s?d:o;Zi(c,Ki(h,this.currentCamera.eye,Bi(h,l,t))),this._planeHorizontal[3]=-Gi($o(this._planeHorizontal),c),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),r_(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=1===this._navMode?this._planeHorizontal:this._planeVertical,s=this._beginCenter;if(t){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=i,this._scalingValueSmooth.update(t),t_(this.currentCamera,s,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=vg(Math.abs(e.radius-this._beginRadius)),yg(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),r_(this._tmpPoints,this._tmpCentroid3d),ae(e.center,this._tmpCentroid2d),d_(this.currentCamera,s,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=vg(Bs(this._beginCenterScreen,this._tmpCentroid2d)),yg(this.view,this.currentCamera,this._constraintOptions),t){const t=s,i=this._rotationValueSmooth.value,r=i+Xg(e.angle-i),n=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=n,this._rotationValueSmooth.update(r);const a=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp);const o=$o(this._planeHorizontal);Jg(this.currentCamera,t,Bg(o,a)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=vg(Math.abs(e.radius*a)),yg(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new fy({view:this.view,momentum:t,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new _y({view:this.view,momentum:i,center:this._beginCenter,axis:$o(this._planeHorizontal)});const s=this._panMomentumEstimator.evaluateMomentum();return s?new dy({view:this.view,momentum:s}):null}_computePlanePoints(e,t,i,s){s.length=e.size;const r=this._tmp2d;let n=0;return e.forEach(e=>{r[0]=e.x,r[1]=e.y,void 0===s[n]&&(s[n]=ke()),e_(t,i,r,s[n]),n+=1}),s}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};Sy=e([Se("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],Sy);class Py extends el{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,e=>this._handleDrag(e))}_handleDrag(e){if("mouse"===e.data.pointerType&&!fo(e.data,this.pointerActions))return;const t=e.timestamp-this._lastEndTimestamp,i=this._momentum&&this._momentum.running&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this._controller&&this._controller.running?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller?.running){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);t&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new Cy({view:this._view}):new Sy({view:this._view})}}class My extends el{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,()=>this.view.state.stopActiveCameraController())}}class Ry extends el{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",e=>this._handleTwoFinger(e))}_handleTwoFinger(e){const t=this._invert?-1:1,i=re(0,e.data.delta*t);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new Rf({view:this._view,pivot:0}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController?.update(i);break;case"end":this._cameraController?.end(),this._cameraController=null}}}class Oy extends el{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new xo({start:(e,t)=>this._observeStart(e,t),update:(e,t,i)=>this._observeUpdate(e,t,i),end:(e,t)=>this._observeEnd(t)}),this.registerIncoming("drag",e=>this._dragEventSeparator.handle(e))}get failed(){return"failed"===this._state}_observeStart(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}_observeUpdate(e,t,i){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,s=1/0,r=-1/0,n=1/0;for(const{x:e,y:a}of t.pointers.values())i=Math.max(i,e),s=Math.min(s,e),r=Math.max(r,a),n=Math.min(n,a);let a=-1/0,o=1/0,l=-1/0,h=1/0;for(const{x:t,y:i}of e.pointers.values())a=Math.max(a,t),o=Math.min(o,t),l=Math.max(l,i),h=Math.min(h,i);const c=i-s,d=r-n,u=a-o,p=l-h;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(u-c)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((e,s)=>{const r=t.pointers.get(s);i=Math.min(i,Math.abs(e.y-r.y))}),i>=this._threshold}}let Dy=class extends Oe{constructor(){super(...arguments),this.mode="default",this._updateMode=({mode:e,dragPrimary:t,dragSecondary:i,dragTertiary:s})=>{"pro"===e&&(i="zoom",s="pan"===t?"rotate":"pan");const r={dragPrimary:t,dragSecondary:i,dragTertiary:s};this._modeDragPan&&(this._modeDragPan.pointerActions=Co("pan",r)),this._modeDragRotate&&(this._modeDragRotate.pointerActions=Co("rotate",r)),this._modeDragZoom&&(this._modeDragZoom.pointerActions=Co("zoom",r))}}destroy(){this.disconnect()}get primaryDragAction(){return this.view.navigation.actionMap.dragPrimary}set primaryDragAction(e){const{actionMap:t}=this.view.navigation;t.dragPrimary=e,t.dragSecondary="pan"===e?"rotate":"pan"}get updating(){return!!this._inputManager?.updating}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.removeAllHandles(),this.view.viewEvents.disconnect(),this._modeDragPan=null,this._modeDragRotate=null,this._modeDragZoom=null,this._modeKeyboardNavigation=null,this._inputManager=S(this._inputManager),this._source=S(this._source)}connect(){const e=this.view;this._source=new To(this.view.surface,e.input);const t=[new So,new Po,new Mo,new Ro(this.view.navigation),new Oy],i=new il({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new Oo],sl.INTERNAL);const s={fov:"Shift",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:["u","U"],down:["j","J"]},lookAround:{headingLeft:["a","A"],headingRight:["d","D"],tiltUp:["w","W"],tiltDown:["s","S"],modifier:"b"},zoom:{zoomIn:["+","="],zoomOut:["-","_"]},reset:{heading:["n","N"],tilt:["p","P"]}};this._modeDragPan=new Py(e,["primary"]),this._modeDragRotate=new Af(e,["secondary"],0),this._modeDragZoom=new $f(e,["tertiary"],s.fov),this._modeKeyboardNavigation=new oy(e,s),i.installHandlers("navigation",[new My(e),new cf(e),new ay(e),new ly(e,s.fov),new Af(e,["primary"],1,[s.lookAround.modifier]),new Af(e,["secondary"],0,[s.lookAround.modifier]),new Py(e,["tertiary"],[s.lookAround.modifier]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new Ry(e)],sl.INTERNAL),this.view.viewEvents.connect(i),this.addHandles([B(()=>this.view.navigation?.browserTouchPanEnabled,e=>{this._source.browserTouchPanningEnabled=!e},N),B(()=>{const{actionMap:e}=this.view.navigation,{dragPrimary:t,dragSecondary:i,dragTertiary:s}=e;return{mode:this.mode,dragPrimary:t,dragSecondary:i,dragTertiary:s}},this._updateMode,G)])}isModifierKeyDown(e){return this._inputManager?.isModifierKeyDown(e)??!1}get test(){}};e([Ce()],Dy.prototype,"view",void 0),e([Ce({type:["default","pro"]})],Dy.prototype,"mode",void 0),e([Ce({readOnly:!0})],Dy.prototype,"updating",null),e([Ce()],Dy.prototype,"latestPointerType",null),e([Ce()],Dy.prototype,"latestPointerLocation",null),e([Ce()],Dy.prototype,"multiTouchActive",null),e([Ce()],Dy.prototype,"_inputManager",void 0),Dy=e([Se("esri.views.3d.input.SceneInputManager")],Dy);const Ay=Dy;let Ey,Iy,Ly=!1,ky=!1,Vy=!1,Fy=!1,jy=null;function zy(){jy&&(jy(),jy=null)}function Hy(e,t,i,s,r){zy();const n=Ey.height,a=Iy;a.beginPath(),a.lineWidth=1,a.strokeStyle=r,a.moveTo(e,n-i),a.lineTo(t,n-i),a.stroke(),a.lineTo(t,n-s),a.stroke(),a.lineTo(e,n-s),a.stroke(),a.lineTo(e,n-i),a.stroke(),a.closePath()}function qy(e,t,i=!1){Ly&&(t&&Vy||!t&&Fy)&&Hy(e[0],e[2],e[1],e[3],i?t?"pink":"grey":t?"green":"red")}class Uy{constructor(e,t,i){this._setVisibility=e,this._canConflict=t,this._compare=i,this.done=!1,this._items=new Array,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null}destroy(){this._generator=null,this._accBins=null,this._items.length=0}reset(e,t){this._initBins(e,t),this._items.length=0,this.done=!1,this._generator=null}add(e){this._items.push(e)}run(e){this._generator??=this._run(e),this.done=!!this._generator.next(e).done}*_run(e){yield*this._sort(e),yield*this._deconflict(e),function(e){const t=ky?e():null;if(!t?.bins)return;zy();const i=Iy;let s=0;for(let e=0;e<t.numX;e++)for(let r=0;r<t.numY;r++){const n=t.bins[e][t.numY-1-r];s+=n.length;const a=e*t.sizeX,o=(e+1)*t.sizeX,l=r*t.sizeY,h=(r+1)*t.sizeY;i.fillText(n.length.toFixed(),a+5,l+15),Hy(a,o,l,h,"blue")}i.fillText("total totalShownLabels: "+s,70,40),i.fillText("total visible labels: "+t.numVisible,70,50),i.fillText("total numTests: "+t.numTests,70,30)}(()=>({bins:this._accBins,numX:this._accBinsNumX,numY:this._accBinsNumY,sizeX:this._accBinsSizeX,sizeY:this._accBinsSizeY,numTests:0,numVisible:this._items.length}))}*_sort(e){for(const t of Kl(this._items,0,this._items.length,this._compare))e.madeProgress(),e.done&&(e=yield)}_isConflicted(e){let t=!0;return this._forEachBin(e.aabr,i=>(t=!1,i.some(t=>this._canConflict(t,e)&&ot(t.aabr,e.aabr))))||t}*_deconflict(e){for(const t of this._items){e.done&&(e=yield);const i=!this._isConflicted(t);this._setVisibility(t,i),qy(t.aabr,i),i&&this._addToBins(t),e.madeProgress()}}_initBins(e,t){if(null==this._accBins){this._accBins=[];for(let e=0;e<this._accBinsNumX;e++){this._accBins.push([]);const e=this._accBins[this._accBins.length-1];for(let t=0;t<this._accBinsNumY;t++)e.push(new Xl)}}else for(let e=0;e<this._accBinsNumX;e++)for(let t=0;t<this._accBinsNumY;t++)this._accBins[e][t].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY}_addToBins(e){this._forEachBin(e.aabr,t=>t.push(e))}_forEachBin(e,t){if(!this._accBins)return!1;const i=Math.max(Math.floor(e[0]/this._accBinsSizeX),0),s=Math.max(Math.floor(e[1]/this._accBinsSizeY),0),r=Math.min(Math.floor(e[2]/this._accBinsSizeX),this._accBinsNumX-1),n=Math.min(Math.floor(e[3]/this._accBinsSizeY),this._accBinsNumY-1);for(let e=i;e<=r;e++)for(let i=s;i<=n;i++)if(t(this._accBins[e][i]))return!0;return!1}}class By{constructor(e){this._gl=e,this._sync=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0)}poll(){const e=this._gl,t=e.clientWaitSync(this._sync,e.SYNC_FLUSH_COMMANDS_BIT,0);if(t===e.WAIT_FAILED)throw new Error("clientWaitSync failed");return t!==e.TIMEOUT_EXPIRED}destroy(){this._gl.deleteSync(this._sync),this._sync=null}}let Ny=class extends sa{constructor(e){super(e),this.category=ui.COMPOSITE,this.readyToRun=!1,this.done=!0,this._origin=ke(),this._textureWidth=256,this._uploadBuffer=new Float32Array(3*this._textureWidth),this._counter=0,this._width=0,this._height=0,this._pipeline=gn({colorWrite:_n}),this._format=0}initialize(){this.view.resourceController.scheduler.registerTask(kn.GRAPHICS_CORE,this),this.produces="disabled",this.consumes.required=[this.category],this.formatOverride&&(this._format=this.formatOverride)}destroy(){this._program=M(this._program);const e=this.gl;this._sync=S(this._sync),this._pixelBuffer&&(e.deleteBuffer(this._pixelBuffer),this._pixelBuffer=null),this._texture=M(this._texture)}precompile(){this._ensureProgram(this.renderingContext)}render(e){const t=e.find(({name:e})=>e===this.category);if(this._sync)return t;this.produces="disabled";const i=this.renderingContext,s=this.gl,r=t.getTexture(s.DEPTH_STENCIL_ATTACHMENT);if(!r)return t;const n=this.view.stage.renderer.fboCache.acquire(this._width,this._height,"hud visibility",9);i.bindFramebuffer(n.fbo),i.setPipelineState(this._pipeline);const a=this._ensureProgram(i);return i.useProgram(a),i.bindTexture(r,0),a.setUniform1i("depthTex",0),i.bindTexture(this._texture,1),a.setUniform1i("positionTex",1),Ps(Qy,this.camera.viewMatrix,Os(Qy,this._origin)),a.setUniformMatrix4fv("view",Qy),a.setUniformMatrix4fv("proj",this.camera.projectionMatrix),a.setUniform1i("count",this._counter),i.screen.draw(),this._pixelBuffer||(this._pixelBuffer=s.createBuffer()),0===this._format&&(this._format=6403===s.getParameter(s.IMPLEMENTATION_COLOR_READ_FORMAT)&&s.getParameter(s.IMPLEMENTATION_COLOR_READ_TYPE)===Bn.FLOAT?6403:6408),s.bindBuffer(s.PIXEL_PACK_BUFFER,this._pixelBuffer),s.bufferData(s.PIXEL_PACK_BUFFER,this._width*this._height*(6403===this._format?4:16),s.STREAM_READ),s.readPixels(0,0,this._width,this._height,this._format,Bn.FLOAT,0),this._sync=new By(s),n.release(),setTimeout(()=>this.readyToRun=!0,0),t}runTask(){if(!this._sync)return void(this.readyToRun=!1);try{if(!this._sync.poll())return Vn}catch(e){return this.readyToRun=!1,void(this._sync=S(this._sync))}this.readyToRun=!1,this._sync=S(this._sync);const e=this.gl;e.bindBuffer(e.PIXEL_PACK_BUFFER,this._pixelBuffer),this._cpuBuffer=new Float32Array(this._width*this._height*(6403===this._format?1:4)),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,this._cpuBuffer),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),this.done=!0}init(e,t){const i=this._textureWidth;if(this._width=i,this._height=Math.ceil(e/i),this._counter=0,this._texture?.dispose(),0===this._height)return;const s=new On(this._width,this._height);s.pixelFormat=6407,s.dataType=Nn.FLOAT,s.samplingMode=9728,this._texture=new An(this.renderingContext,s),this.done=!1,qi(this._origin,Math.fround(t[0]),Math.fround(t[1]),Math.fround(t[2]))}addPosition(e){const t=this._width;if(this._counter>=t*this._height)return-1;const i=this._counter%t;return Ui($y,e,this._origin),this._uploadBuffer[3*i+0]=$y[0],this._uploadBuffer[3*i+1]=$y[1],this._uploadBuffer[3*i+2]=$y[2],i===t-1&&this._flush(),this._counter++}start(){if(0===this._width||0===this._height)return;const e=this._width;this._counter%e>0&&this._flush(),this.produces=this.category,this.requestRender(1)}getOcclusion(e){return this._cpuBuffer?.[6403===this._format?e:4*e]??-1}_flush(){const e=this._width,t=Math.floor(this._counter/e);this._texture?.updateData(0,0,t,e,1,this._uploadBuffer)}_ensureProgram(e){return this._program??=e.programCache.acquire(Gy,Wy,ir),this._program}};e([Ce()],Ny.prototype,"category",void 0),e([Ce()],Ny.prototype,"formatOverride",void 0),e([Ce()],Ny.prototype,"readyToRun",void 0),e([Ce()],Ny.prototype,"done",void 0),Ny=e([Se("esri.views.3d.webgl-engine.lib.GPUPointOcclusionQuery")],Ny);const Gy="#version 300 es\nprecision highp float;\nin vec2 position;\n\nvoid main() {\n    gl_Position = vec4(position, 0.0, 1.0);\n}",Wy="#version 300 es\nprecision highp float;\nout highp vec4 fragColor;\n\nuniform highp mat4 proj;\nuniform highp mat4 view;\n\nuniform highp int count;\n\nuniform highp sampler2D depthTex;\nuniform highp sampler2D positionTex;\n\nfloat linearizeDepth(float depth) {\n  float depthNdc = depth * 2.0 - 1.0;\n  float c1 = proj[3][2];\n  float c2 = proj[2][2];\n  return -c1 / (depthNdc + c2 + 1e-7);\n}\n\nvoid main() {\n  int u = int(floor(gl_FragCoord.x));\n  int v = int(floor(gl_FragCoord.y));\n  if (u + v * textureSize(positionTex, 0).x >= count) {\n    fragColor = vec4(-1);\n    return;\n  }\n  vec4 posWorld = vec4(texelFetch(positionTex, ivec2(u, v), 0).rgb, 1.0);\n\n  vec4 posView = view * posWorld;\n  vec4 projected = proj * posView;\n\n  vec3 clipPos = projected.xyz / projected.w;\n\n  if (clipPos.x < -1.0 || clipPos.x > 1.0 || clipPos.y < -1.0 || clipPos.y > 1.0) {\n    fragColor = vec4(-1);\n    return;\n  }\n\n  vec3 uvDepth = 0.5 * clipPos + vec3(0.5);\n\n  float depth = texture(depthTex, uvDepth.xy).r;\n\n  if (uvDepth.z <= depth) {\n    fragColor = vec4(0);\n    return;\n  }\n\n  fragColor = vec4(linearizeDepth(depth) - linearizeDepth(uvDepth.z));\n}\n",$y=ke(),Qy=Fs(),Zy=ke(),Yy=ke(),Ky=ul(),Xy=ul(),Jy=ke(),ev=Fs(),tv=$a(),iv=qa(),sv=ke(),rv=lt();class nv{constructor(e){this.id=e,this.aabr=lt(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.culled=!1,this.visible=!1,this.priority=0}}function av(e,t){const i=0!==e.distanceToOccluder&&e.distance>e.distanceToOccluder,s=0!==t.distanceToOccluder&&t.distance>t.distanceToOccluder;return i!==s?+i-+s:e.priority!==t.priority?t.priority-e.priority:e.distance!==t.distance?e.distance-t.distance:e.visible!==t.visible?+t.visible-+e.visible:e.id-t.id}class ov{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this._info=null,this._labelInfo=null}ensureInfo(e){let t=this.getInfo(e);return t||(t=new nv(this.graphics3DGraphic.graphic.uid),this._setInfo(e,t)),t}getInfo(e){return 16===e?this._labelInfo:this._info}removeInfo(e){this._setInfo(e,null)}_setInfo(e,t){16===e?this._labelInfo=t:this._info=t}}class lv{constructor(){this.camera=new Do,this.slicePlane=Gl(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),Wl(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let hv=class extends Oe{get dirty(){return this._dirty}get state(){return this._state}constructor(e){super(e),this._dirty=!1,this._viewState=new lv,this._state=0,this._checkOcclusion=new Map,this._active=new Map,this._checkOcclusionIterator=null,this._activeIterator=null,this._occlusionQueryUids=new Array,this._updatingHandles=new Yl,this._deconflictor=new Uy((e,t)=>{e.visible=t,this._setGraphicVisibility(this._active.get(e.id),t)},(e,t)=>e.id!==t.id,av),this._baseOccludedVisibility=10,this._altitudeFactor=2,this._minAltitudeDifference=100}initialize(){this._updatingHandles.add(()=>(this.view?.map?.ground?.opacity??0)>0,()=>this.setDirty()),this._updatingHandles.add(()=>this.view.ready,()=>this._occlusionQuery=null)}destroy(){this._occlusionQuery=null,this._updatingHandles.destroy(),this._deconflictor.destroy(),this._checkOcclusion.clear(),this._active.clear()}setDirty(){!this._dirty&&(this._active.size>0||this._checkOcclusion.size>0)&&(this._dirty=!0,this.notifyChange("updating"))}setPriority(e,t){const i=this._active.get(e.graphic.uid)?.getInfo(this.visibilityGroup);i&&(i.priority=t)}get updating(){return 0!==this._state||this._dirty||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;const e=this._state/5;return this._dirty?.5*e:e}get readyToRun(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case 0:this._startUpdate(),e.madeProgress();case 1:if(this._state=1,!this._processCheckOcclusion(e))return;case 2:if(this._state=2,this._occlusionQuery&&!this._occlusionQuery.done)return Vn;this._readOcclusionQueryResult(),e.madeProgress();case 3:if(this._state=3,!this._collectActiveGraphics(e))return;case 4:if(this._state=4,this._deconflictor.run(e),!this._deconflictor.done)return;default:this._state=0,this.notifyChange("updating")}}setGraphicsActive(e,t){t?e.forEach(e=>this.addToActiveGraphics(e)):e.forEach(e=>this.removeFromActiveGraphics(e))}layerSupportsDeconfliction(e){if(null==e||"object3d"!==e.type)return!1;const t=e.stageObject;if(1!==(t?.geometries.length??0))return!1;const i=t?.geometries[0],s=i?.material;return s instanceof eh}_startUpdate(){var e;e=this.view,Vy=Jl.DECONFLICTOR_SHOW_VISIBLE,Fy=Jl.DECONFLICTOR_SHOW_INVISIBLE,Ly=Vy||Fy,ky=Jl.DECONFLICTOR_SHOW_GRID,jy=null,Ly||ky?(Iy&&Ey&&Iy.clearRect(0,0,Ey.width,Ey.height),jy=()=>function(e){null==Ey&&(Ey=document.createElement("canvas"),Ey.setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(Ey),Ey.style.position="absolute",Ey.style.width="100%",Ey.style.height="100%",Ey.style.display="block",Ey.style.pointerEvents="none",Iy=Ey.getContext("2d"),Iy.font="12px Arial");const{width:t,height:i}=e.state.camera;Ey.width=t,Ey.height=i}(e)):Ey&&(Ey.parentElement.removeChild(Ey),Ey=null),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:t,fullHeight:i}=this._viewState.camera;this._deconflictor.reset(t,i),this._resetIterators(),this._occlusionQueryUids.length=0,this._checkOcclusion.size||(this._occlusionQuery=S(this._occlusionQuery))}addToActiveGraphics(e){e.ensureInfo(this.visibilityGroup),this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){!function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.setVisibilityFlag(t,8,!0)}(e,this.visibilityGroup),e.removeInfo(this.visibilityGroup),this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}addToCheckOcclusion(e){this._checkOcclusion.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromCheckOcclusion(e){this._checkOcclusion.delete(e.graphics3DGraphic.graphic.uid)}_processCheckOcclusion(e){if(0===this._checkOcclusion.size)return!0;const t=this._ensureCheckOcclusionIterator(),i=this._viewState.camera,s=Ds(ev,i.viewInverseTransposeMatrix),r=this.view.map.ground.opacity>0,n="global"===this.view.viewingMode&&r&&i.relativeElevation>0?tv:null;let a=0;null!=n&&(es(Qa(n),Ue,i.viewMatrix),n[3]=ge(this.view.spatialReference).radius,a=Za(n,Ue));const o=lt();for(;;){if(e.done)return!1;e.madeProgress();const r=t.next();if(!0===r.done)break;const l=r.value,h=l.graphics3DGraphic;if(h.destroyed)continue;if(!h.isVisible(1,8))continue;const c=uv(h,this.visibilityGroup);let d=null,u=!0;for(const e of c){if(!this.layerSupportsDeconfliction(e))continue;d=pv,this._projectHudLayer(e,i,d),ht(o);const t=e.stageObject.geometries[0].material;if(this._expandBoundingRect(o,i,e,t,d),d.isOutsideScreen){u=!1;break}if(this._isCulledBySlice(l,d.positionView)){u=!1;break}if(null!=n&&dv(d,n,a)){u=!1;break}es(Yy,d.positionView,s),d.altitude=this.view.renderCoordsHelper.getAltitude(Yy);const r=l.ensureInfo(this.visibilityGroup);if(r.altitude=d.altitude,r.distance=d.distance,r.distanceToOccluder=d.distanceToOccluder,r.culled=!1,ct(r.aabr,o),t.parameters.occlusionTest)break;this._ensureOcclusionQuery().addPosition(Yy)===this._occlusionQueryUids.length&&this._occlusionQueryUids.push(h.graphic.uid);break}if(this._active.has(h.graphic.uid)&&(!u||!d)){const e=l.ensureInfo(this.visibilityGroup);e.visible=!d,e.culled=!0}}return this._checkOcclusionIterator=null,this._occlusionQueryUids.length||(this._occlusionQuery=S(this._occlusionQuery)),this._occlusionQuery?.start(),!0}_readOcclusionQueryResult(){if(!this._occlusionQuery||!this._occlusionQueryUids.length)return;const e=this._viewState.camera,t=this.view.renderCoordsHelper.getAltitude(e.eye);for(let e=0;e<this._occlusionQueryUids.length;e++){const i=this._occlusionQueryUids[e],s=this._checkOcclusion.get(i);if(!s)continue;const r=this._occlusionQuery.getOcclusion(e)??-1,n=s.getInfo(this.visibilityGroup);n&&(n.distanceToOccluder=r>0?n.distance-r:0);const a=r<=0||this._occludedVisibility(n?.distanceToOccluder??0,n?.distance??r,n?.altitude??0,t);this._active.has(i)?n&&(n.culled=!a,n.visible=a):this._setGraphicVisibility(s,a)}this._occlusionQueryUids.length=0}_collectActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=16===this.visibilityGroup;for(;!e.done;){e.madeProgress();const s=t.next();if(!0===s.done)return this._activeIterator=null,!0;const r=s.value,n=r.getInfo(this.visibilityGroup);n&&(i&&!r.graphics3DGraphic.isVisible()||n.culled?(qy(n.aabr,!1,!0),this._setGraphicVisibility(r,n.visible)):this._deconflictor.add(n))}return!1}_occludedVisibility(e,t,i,s){const r=Math.max(this._minAltitudeDifference,Math.abs(i-s))-this._minAltitudeDifference;return 0===e||t-e<=this._baseOccludedVisibility+this._altitudeFactor*r}_resetIterators(){this._checkOcclusionIterator=null,this._activeIterator=null}_ensureCheckOcclusionIterator(){return this._checkOcclusionIterator??=this._checkOcclusion.values(),this._checkOcclusionIterator}_ensureActiveGraphicsIterator(){return this._activeIterator??=this._active.values(),this._activeIterator}_ensureOcclusionQuery(){return this._occlusionQuery??=new Ny({view:this.view}),this._occlusionQueryUids.length||this._occlusionQuery.init(this._checkOcclusion.size,this._viewState.camera.eye),this._occlusionQuery}_projectHudLayer(e,t,i){const s=e.stageObject,r=s.geometries[0],n=r.material,a=Qa(s.boundingVolumeWorldSpace.bounds);es(Zy,a,t.viewMatrix);const o=r.attributes,l=o.get("normal").data,h=o.get("centerOffsetAndDistance").data;n.applyShaderOffsetsView(Zy,l,s.transformation,h,t,i.scaleInfo,Zy),rl(Ky,Zy[0],Zy[1],Zy[2],1),nl(Xy,Ky,t.projectionMatrix),Bi(i.positionNDC,Xy,1/Xy[3]),n.applyShaderOffsetsNDC(i.positionNDC,h,t,i.positionNDC,Jy),i.distanceWithoutPolygonOffset=t.depthNDCToWorld(Jy[2]),i.distance=Jy[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:t.depthNDCToWorld(i.positionNDC[2]),rl(Xy,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),nl(Ky,Xy,t.inverseProjectionMatrix),al(Ky,Ky,1/Ky[3]),qi(i.positionView,Zy[0],Zy[1],Zy[2])}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&Nl(this._viewState.slicePlane,t)}_expandBoundingRect(e,t,i,s,{positionNDC:r,scaleInfo:n}){const a=i.getScreenSize(cv);Dr(a,n.factor,a),a[0]*=t.pixelRatio,a[1]*=t.pixelRatio;const o=dt(s.calculateRelativeScreenBounds(a,n.factorAlignment.scale*t.pixelRatio,rv),Pi(0,t.fullWidth,.5+.5*r[0]),Pi(0,t.fullHeight,.5+.5*r[1])),l=this.marginFactor;if(0!==l){const e=l*Math.min(ut(o),pt(o));o[0]-=e,o[1]-=e,o[2]+=e,o[3]+=e}mt(e,o,e)}_setGraphicVisibility(e,t){const i=e?.graphics3DGraphic;i&&!i.destroyed&&(i.setVisibilityFlag(this.visibilityGroup,8,t),16===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(i,t))}};e([Ce({constructOnly:!0})],hv.prototype,"view",void 0),e([Ce({type:Boolean,readOnly:!0})],hv.prototype,"updating",null),e([Ce({readOnly:!0})],hv.prototype,"_updatingHandles",void 0),hv=e([Se("esri.views.3d.layers.graphics.Deconflictor")],hv);const cv=Gs();function dv(e,t,i){return Zi(iv.direction,e.positionView),qi(iv.origin,0,0,0),!!Ua(t,iv,sv)&&e.distanceWithoutPolygonOffset>i}function uv(e,t){return 16===t?e.labelLayers:e.layers}const pv=new class{constructor(){this.positionView=ke(),this.positionNDC=ke(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new th}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1||e[2]>=1}};let mv=class extends hv{constructor(e){super(e),this.visibilityGroup=16,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.readyToRun)return Vn;const t=performance.now();if(2!==this.view.state.mode&&t-this._lastDeconfliction<2e3)return Vn;const i=super.runTask(e);return 0===this.state&&(this._lastDeconfliction=t),i}};e([Ce({constructOnly:!0})],mv.prototype,"parent",void 0),mv=e([Se("esri.views.3d.layers.graphics.LabelDeconflictor")],mv);let gv=class extends hv{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=1,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._updatingHandles.add(()=>this.view?.state?.camera,()=>{this._updateViewState(),this.setDirty()}),this._updatingHandles.add(()=>this.view?.slice?.plane,()=>{this._updateSlicePlane(),this._slicePlaneChanged()},N),this.addHandles(B(()=>this.view.basemapTerrain?.updating||this.view.graphicsView?.updating||this.view.allLayerViews.some(e=>e.updating),(e,t)=>{!e&&t&&this.setDirty()},W)),this._frameTask=this.view.resourceController.scheduler.registerTask(kn.GRAPHICS_DECONFLICTOR,this),this._labels=new mv({view:this.view,parent:this})}destroy(){this._labels=S(this._labels),this._frameTask=T(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){const t=super.runTask(e);return this.readyToRun||this._labels.setDirty(),t}_updateViewState(){this.view?.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?.slice?.plane;null!=e&&$l(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=null!=e}_slicePlaneChanged(){for(const e of this._contexts.keys())if(e.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labelsEnabledChanged(e,t),featureReductionChange:()=>this._enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(e=>this._removeGraphic(t,e.graphics3DGraphic)),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(e=>this._removeGraphic(t,e.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const s=i.graphic.uid,r=new ov(i,e.symbolCreationContext.slicePlaneEnabled);t.set(s,r),this.addToCheckOcclusion(r),_v(e)&&this.addToActiveGraphics(r),e.labelsEnabled&&(this._labels.addToCheckOcclusion(r),this._labels.addToActiveGraphics(r));const n=!this._graphicSupportsDeconfliction(i)||!_v(e);i.setVisibilityFlag(1,8,n)}_removeGraphic(e,t){const i=t.graphic.uid,s=e.get(i);s&&(this.removeFromActiveGraphics(s),this.removeFromCheckOcclusion(s),this._labels.removeFromActiveGraphics(s),this._labels.removeFromCheckOcclusion(s),e.delete(i),this.setDirty())}_enabledChanged(e,t){_v(e)?t.forEach(e=>this.addToActiveGraphics(e)):(t.forEach(e=>this.removeFromActiveGraphics(e)),function(e){const t=e.graphics3DGraphics;t&&t.forEach(e=>e.setVisibilityFlag(1,8,!0))}(e))}_labelsEnabledChanged(e,t){e.labelsEnabled?(t.forEach(e=>this._labels.addToCheckOcclusion(e)),t.forEach(e=>this._labels.addToActiveGraphics(e))):(t.forEach(e=>this._labels.removeFromCheckOcclusion(e)),t.forEach(e=>this._labels.removeFromActiveGraphics(e)))}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach(e=>e.slicePlaneEnabled=i),this.setDirty()}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!t?.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function _v(e){const t=e.layer;return!(!t?.featureReduction||"selection"!==t.featureReduction.type)}function fv(e){return e instanceof Ja?e.graphics3DSymbol:e instanceof eo?e:null}gv=e([Se("esri.views.3d.layers.graphics.GraphicsDeconflictor")],gv);const yv=()=>C.getLogger("esri.views.3d.layers.graphics.labelPlacement");class vv{constructor(e,t,i,s=null){this._graphic=e,this._symbol=t,this._class=i,this._disablePlacement=s}get placement(){const e=this._verticalOffsetPlacement;if(null==e)return null;const t=this._getPlacementInfo(e);if(null==t)return null;const i=t.anchor,s=!!e.hasLabelVerticalOffset,r=e.verticalOffset,n=new ph(r,i,s);return this._calculatePlacementOffsets(n,t)}get _verticalOffsetPlacement(){const e=this._class.labelPlacement,{_symbol:t,_graphic:i}=this,s=fv(i.graphics3DSymbol),r="point-3d"===s?.symbol.type?s.symbol:null,n=xv[e]||this._defaultPlacementInfo;return r?.supportsCallout()&&r.hasVisibleVerticalOffset()&&!i.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:r.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!t?.hasVisibleVerticalOffset()||null!=r&&r.supportsCallout()&&r.verticalOffset&&!i.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:n&&"above-center"===n.placement?{placement:"above-center",verticalOffset:t.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(yv().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}_getPlacementInfo(e){if(e.anchor)return e;const t=this._class.labelPlacement,i=xv[t],s=i||this._defaultPlacementInfo;return t&&!i&&yv().warnOnce(`the requested label placement '${t}' is currently unsupported in SceneView.`),this._validatePlacementInfo(s)}_calculatePlacementOffsets(e,t){const i=this._graphic.graphic.geometry;if(null==i)return null;switch(i.type){case"point":this._setPointSpecificPlacement(e,t);break;case"mesh":this._setMeshSpecificPlacement(e,t);break;case"polygon":this._setPolygonSpecificPlacement(e,t)}const s=to-wh;return e.screenOffset[0]+=s*t.normalizedOffset[0],e.screenOffset[1]+=s*t.normalizedOffset[1],e}get _defaultPlacementInfo(){const e=this._graphic.graphic.geometry;if(null==e)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:Ue,anchor:"center"};case"polygon":{const e=this._firstSymbolLayer;return"extrude"===e?.type?xv["above-center"]:{placement:"center-center",normalizedOffset:Ue,anchor:"center"}}case"point":case"mesh":return xv["above-center"];default:return}}_validatePlacementInfo(e){const t=this._graphic.graphic.geometry;if(null==t)return null;if(null!=this._disablePlacement){const t=this._class.labelPlacement;return t?(yv().warnOncePerTick(bv(t,this._disablePlacement.logEntityDescription)),this._defaultPlacementInfo):e}const i=t.type;switch(i){case"polyline":case"polygon":case"extent":case"multipoint":{const e=this._class.labelPlacement;if(e)return xv[e]&&yv().warnOnce(bv(e,`'${i}' geometries`)),this._defaultPlacementInfo;break}case"point":case"mesh":return e}return e}_setPointSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(null==i)return;const s=this._graphic.layers[0];switch(null!=s?s.getCenterObjectSpace(e.translation):qi(e.translation,0,0,0),i.type){case"icon":case"text":this._setHUDSpecificPlacement(e,t,s);break;case"object":wv(e,t,s)}}_setMeshSpecificPlacement(e,t){const i=this._firstSymbolLayer;null!=i&&"fill"===i.type&&wv(e,t,this._graphic.layers[0])}_setPolygonSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(null!=i)switch(i.type){case"extrude":{const i=this._graphic.layers[0];null!=i?(i.getBoundingBoxObjectSpace(Sv),oh(Sv,e.translation),e.translation[2]=lh(Sv)/2):qi(e.translation,0,0,0),wv(e,t,i);break}}}_setHUDSpecificPlacement(e,t,i){const{_graphic:s}=this,r=null!=i?i.getScreenSize():null;if(s.isDraped||null==r)e.hasLabelVerticalOffset||"center"===e.anchor||(xv[this._class.labelPlacement]&&yv().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const i=this._normalizedSymbolAnchorPos;e.screenOffset[0]=r[0]/2*(t.normalizedOffset[0]-i[0]);const s=r[1]/2*(t.normalizedOffset[1]-i[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=s,e.centerOffsetUnits="screen"):e.screenOffset[1]=s}}get _firstSymbolLayer(){const e=fv(this._graphic.graphics3DSymbol);return null!=e?e.symbol.symbolLayers.at(0):null}get _normalizedSymbolAnchorPos(){const e=this._graphic.layers[0],t=e?.stageObject.geometries[0].material??null;if(t&&t instanceof eh){const e=t.parameters.anchorPosition;Tv[0]=2*(e[0]-.5),Tv[1]=2*(e[1]-.5)}else Tv[0]=0,Tv[1]=0;return Tv}}function bv(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function wv(e,t,i){const s=null!=i?i.getBoundingBoxObjectSpace(Sv):Sv,r=Ve(s[3]-s[0],s[4]-s[1],s[5]-s[2]),n=Math.sqrt(r[0]*r[0]+r[1]*r[1]);e.centerOffset[0]=n/2*t.normalizedOffset[0];const a=e.translation[2],o=r[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=a+o;const l=$i(r);e.centerOffset[2]=l/2*t.normalizedOffset[2]}const xv={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Cv={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in Cv){const t=Cv[e],i=xv[e];t.forEach(e=>{xv[e]=i})}Object.freeze&&(Object.freeze(xv),Object.keys(xv).forEach(e=>{Object.freeze(xv[e]),Object.freeze(xv[e]?.normalizedOffset)}));const Tv=[0,0],Sv=ah();class Pv{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.textureAtlasHandles=[],this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class Mv{constructor(e,t,i,s,r){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=s,this.labelFunction=r,this.calloutSymbolLayerIndex=0,this.graphics=new Map,this.scaleVisibility=null}}class Rv{constructor(e,t,i,s,r,n,a,o){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=s,this.emptySymbolLabelSupported=r,this.elevationInfoOverride=n,this.disablePlacement=a,this.active=o,this.labelClassAbortController=new AbortController,this._labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new Ph(e,{pickable:!0},i.owner.layerViewUid)}destroy(){this.stageLayer.destroy()}get labelClassContexts(){return this._labelClassContexts}setLabelClassContext(e,t){this._labelClassContexts[e]=t}resetLabelClassContext(){this._labelClassContexts.length=0}}let Ov=class extends Oe{constructor(e){super(e),this._hudMaterials=new Map,this._calloutMaterials=new Map,this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([B(()=>this.view.state?.camera,()=>this.setDirty()),B(()=>this.view.state?.rasterPixelRatio,()=>this._resetAllLabels()),B(()=>this.view.focusAreasView?.polygons,()=>this._updateFocus()),this.view.resourceController.scheduler.registerTask(kn.LABELER,this)]),Dh()&&this.addHandles(B(()=>this.view.scale,()=>this._updateScaleVisibility())),this._textTextureAtlas=new mh({view:this.view})}dispose(){this.removeAllHandles(),this._textTextureAtlas=M(this._textTextureAtlas),this._hudMaterials.clear(),this._calloutMaterials.clear(),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),kv.graphic=null,kv.renderingInfo=null,kv.layer=null}_updateFocus(){this._labelingContexts.forEach(e=>{e.graphics.forEach(t=>{if(0===t.labelLayers.length)return;const i=so(t.graphic.geometry);if(null==i)return;const s=this.view.focusAreasView?.containsGeometry(i)??!0;t.labelLayers.forEach(i=>{i.stageObject.geometries.some(e=>e.material.parameters.isFocused!==s)&&(this._removeGraphic(e,t),this._addGraphic(e,t),this.setDirty())})})})}_activateLabelingContext(e){e.graphics.forEach((t,i)=>{const s=new Pv(e,t);this._labels.set(i,s),e.labelsToInitialize.set(i,s),t.setVisibilityFlag(16,1,!0)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((e,t)=>{e.setVisibilityFlag(16,1,!1),this.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),this._labels.delete(t)}),e.active=!1}_addLabelTextureToAtlas(e){if(this._textTextureAtlas)for(const t of e.graphics3DGraphic.labelLayers){if(!t.labelClass)continue;const i=e.textRenderers[t.labelClassContextIndex];i&&(e.textureAtlasHandles.push(this._textTextureAtlas.addText(i,e=>{return s=e,(i=t.stageObject).geometries[0].setAttributeData("uvi",s),void i.geometryVertexAttributeUpdated(i.geometries[0],"uvi",!0);var i,s})),Dv(t.stageObject,i))}}_removeLabelTextureFromAtlas(e){e.textureAtlasHandles.forEach(e=>e.remove()),e.textureAtlasHandles.length=0}get readyToRun(){return this.view.ready&&(this._dirty||this.deconflictor.readyToRun)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.readyToRun&&this.deconflictor.runTask(e),Vn}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(Av(t))this._dirty=!0;else if(Ev(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else for(const[i,s]of t.labelsToInitialize)if(this._ensureGraphics3DResources(s)&&(this._labels.set(i,s),this.deconflictor.setDirty(),e.madeProgress()),(s.visible&&s.textInitialized||!s.visible&&s.hasGraphics3DResources)&&(t.labelsToInitialize.delete(i),e.madeProgress()),e.done){this._dirty=!0;break}this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;e.layer.when&&await e.layer.when(),V(t),e.scaleVisibility?.updateScaleRangeActive();const i=e.graphics3DCore,s=i.layer,r=s.labelingInfo?.filter(e=>!!e.symbol);if(!r||0===r.length)return;let n=!1;await ei(r,async(s,r)=>{const a=s.symbol,o=fv(i.getOrCreateGraphics3DSymbol(a));if(null==o)return void C.getLogger(this).error("Failed to create Graphics3DSymbol for label");await o.load(),V(t);let l=null;nh(a)&&a.hasVisibleCallout()&&(l=ro(a,i.symbolCreationContext),await l.load(),V(t));const h=await ti(rh(s,e.layer.fieldsIndex,this.view.spatialReference));if(V(t),!0===h.ok){const i=await this._createTextRenderParameters(o.symbol);V(t);const n=new Mv(s,o,l,i,h.value);this._updateLabelClassContextVisibility(n),e.setLabelClassContext(r,n)}else C.getLogger(this).error(`Label expression failed to evaluate: ${h.error}`),n=!0}),V(t)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(F(t))throw t;e.resetLabelClassContext()}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==t?.type?null:gh.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,P(t),e.resetLabelClassContext(),e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,s,r,n){if(!this._textTextureAtlas)return null;const a=new _h(i,xh(i.anchor),Ch(i.anchor),e.text,Ws(e.displayWidth,e.displayHeight));return kv.graphic=t,kv.layer=s,kv.renderingInfo=null,r.createLabel(kv,a,this._hudMaterials,this._textTextureAtlas,()=>n.placement?.elevationOffset??null)}_createLineCalloutGraphic(e,t,i,s,r){kv.graphic=e,kv.layer=r;const n=s.screenOffset[0];return kv.renderingInfo=new no(null,t,s.translation,s.centerOffset,n,s.centerOffsetUnits,s.elevationOffset),i.createGraphics3DGraphic(kv,this._calloutMaterials)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,s=i.labelClassContexts;if(Ev(s)||!i.emptySymbolLabelSupported&&0===t.layers.length)return!1;let r=!1;const n=t.graphic,a=i.layer,o=Lv(i.layer);for(let l=0;l<s.length;l++){const h=e.textRenderers[l],c=e.textLabelPlacements[l];if(null==h||null==c)continue;const d=s[l],u=d.graphics3DSymbol,p=Iv(u),m=u.symbolLayers[0];if(!m)continue;m.setElevationInfoOverride(i.elevationInfoOverride);const g=new vv(t,p,d.labelClass),_=this._createTextSymbolGraphic(h,n,c,a,m,g);if(null==_)return!1;_.labelClass=d.labelClass,_.labelClassContextIndex=l,t.addLabelGraphic(_,i.stageLayer),this.deconflictor.setPriority(t,d.textRenderParameters?.definition.size??0),t.setVisibilityFlag(16,1,o),t.setVisibilityFlag(16,2,d.scaleVisibility??!0),t.setVisibilityFlag(16,8,!1),Dh()&&d.graphics.set(n.uid,t),r=!0;const f=d.graphics3DCalloutSymbolLayer;if(f&&c.hasLabelVerticalOffset){f.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(n,p,f,c,a);null!=e&&(d.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,i.stageLayer))}break}return r&&i.scaleVisibility?.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(null==i.labelClass)continue;const e=t[i.labelClassContextIndex].graphics3DSymbol.symbolLayers[0];e?.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(Ev(i))return;const s=e.graphics3DGraphic.graphic;for(let r=0;r<i.length;r++){const n=i[r];if(e.textRenderers[r]=null,e.textLabelPlacements[r]=null,null==n?.textRenderParameters)continue;const a=n.labelFunction;let o;if("arcade"===a.type)try{const e=a.needsHydrationToEvaluate()?sh(s,t.layer):s;o=a.evaluate(e)}catch(e){o=null}else o=a.evaluate(s);if(null==o||""===o||/^\s+$/.test(o))continue;const l=n.graphics3DSymbol;if(!l.symbolLayers[0])continue;const h=e.graphics3DGraphic,c="label-3d"===l.symbol?.type?l.symbol:null,d=n.labelClass,u=t.disablePlacement,p=new vv(h,c,d,u).placement;if(null==p)continue;const m=xh(p.anchor),g=Sh(m);e.textRenderers[r]=new Th(o,g,n.textRenderParameters,mh.maxSize),e.textLabelPlacements[r]=p}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const s=new Pv(e,t);this._labels.set(i,s),e.labelsToInitialize.set(i,s)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const i=t.graphic.uid,s=this._labels.get(i);if(!s)return!0;for(const i of s.graphics3DGraphic.labelLayers)if(null!=i.labelClass&&!e.labelClassContexts[i.labelClassContextIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(i,t.graphic.geometry))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const i=t.graphic.uid,s=this._labels.get(i);e.graphics.delete(i),e.labelClassContexts.forEach(e=>e.graphics.delete(i)),s&&(this._destroyGraphic(s,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.graphics.get(i);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const s=new Map;t.graphics.forEach(e=>s.set(e.graphic.uid,e));const r=e=>e.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,s,r),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,s,t)}}}_visibilityInfoChange(e){const t=Lv(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((t,i)=>{const s=this._labels.get(i);s&&(this._destroyGraphic(s,i),s.visible=!1,e.labelsToInitialize.set(i,s))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const s=i?.emptySymbolLabelSupported||!1,r=i?.elevationInfoOverride||null,n=i?.disablePlacement||null;if(this._findLabelingContext(e))return;const a=e.layer,o=new Rv(this.view.stage,a,e,t,s,r,n,Lv(a));return this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),updateGraphicGeometry:e=>this._updateGraphicGeometry(o,e),layerLabelsEnabled:()=>Lv(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach(e=>this._removeGraphic(t,e)),t.destroy(),this.setDirty()}_updateScaleVisibility(){for(const e of this._labelingContexts)if(e.active&&!Av(e))for(const t of e.labelClassContexts)this._updateLabelClassContextVisibility(t)}_updateLabelClassContextVisibility(e){if(!Dh())return;const{labelClass:t,graphics:i}=e,s={minScale:t.minScale,maxScale:t.maxScale},r=Ah(s,this.view.scale),n=null==e.scaleVisibility||e.scaleVisibility!==r;e.scaleVisibility=r,n&&i.size&&(i.forEach(e=>e.setVisibilityFlag(16,2,r)),this.deconflictor.setDirty(),this.setDirty())}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,s=this._labels.get(i);s&&s.visible!==t&&(t&&!s.textureAtlasHandles.length?(this._addLabelTextureToAtlas(s),s.textInitialized||s.labelingContext.labelsToInitialize.set(i,s)):!t&&s.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(s),s.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some(e=>Av(e))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((e,t)=>e+(Av(t)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get usedMemory(){return this._textTextureAtlas?.usedMemory??0}get test(){}};function Dv(e,t){e.geometries[0].setAttributeData("size",[t.displayWidth,t.displayHeight]),e.geometryVertexAttributeUpdated(e.geometries[0],"size")}function Av(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function Ev(e){return!e||0===e.length}function Iv(e){return"label-3d"===e.symbol?.type?e.symbol:null}function Lv(e){return!!e.labelsVisible&&!!e.labelingInfo?.some(e=>!!e.symbol)}e([Ce({constructOnly:!0})],Ov.prototype,"view",void 0),e([Ce({constructOnly:!0})],Ov.prototype,"deconflictor",void 0),e([Ce()],Ov.prototype,"_textTextureAtlas",void 0),e([Ce({type:Boolean,readOnly:!0})],Ov.prototype,"updating",null),Ov=e([Se("esri.views.3d.layers.graphics.Labeler")],Ov);const kv=new io(null,null,null);class Vv{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}destroy(){this._index=null,this._lodGlobalHandling=null,this._removeNodes=null}startNodeLoading(e,t,i){this._maxLodLevel=i.maxLodLevel,this._index=t,this._removeNodes=e}shouldLoadNode(e){if(null==e)return!1;const t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const t=this._layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));Fv.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1,!!this._layerView.nodeCrossfadingEnabled);const s=Fv.length;this._removeNodes(Fv,e);const r=Fv.length<s;return 0!==Fv.length&&(this._lodGlobalDirty=!0),Fv.clear(),r}_lodGlobalHandling(e,t,i,s){if(null==e)return!1;const r=e.index,n=this._index,a=this._layerView,o=n.nodeTraversalState(e),l=this._isChosenMaxLOD(o),h=e.resources.isEmpty;if(l&&h)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const c=a.isNodeLoaded(r);if(s&&c&&l){const t=!i&&this.hasNoVisibleChildren(e);a.fadeNode(r,0,!t)}const d=c&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(r));if(c&&(a.updateNodeState(r,l?1:0),l))return d&&this._removeChildrenRecursive(e),d;const u=e.childCount>0;let p=u;if(u)for(let a=0;a<e.childCount;a++){const e=n.getChildIndex(r,a),o=n.getNode(e);null!=o?!n.isGeometryVisible(e)||this._lodGlobalHandling(o,t,i||d,s)||(p=!1):n.isNodeVisible(e)&&(p=!1)}const m=c&&!l&&(p||Fv.length<t);m&&Fv.push(r),!s||m||!c||i||p||a.fadeNode(r,0,!1);const g=e.resources.isEmpty;return p||d&&!m||g}_removeChildrenRecursive(e){this._index.traverseDescendants(e,e=>((this._layerView.isNodeLoaded(e.index)||this._layerView.isNodeReloading(e.index))&&Fv.push(e.index),e.childrenLoaded>0))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseDescendants(e,e=>!(!t||!this._index.isNodeVisible(e.index))&&(this._layerView.isNodeLoaded(e.index)?(t=!1,!1):e.childrenLoaded>0)),t}_childrenRequireLoading(e){let t=!1,i=!0;return this._index.traverseDescendants(e,e=>{if(!i||!this._index.isNodeVisible(e.index))return!1;const s=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(s)&&this._index.isGeometryVisible(e.index)&&(t=!0),this._layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0}),i&&t}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}static cleanupI3SLodHandling(){Fv.prune()}}const Fv=new Xl({deallocator:null});let jv=class extends Oe{constructor(e){super(e),this._propertiesPool=new tl({camera:Do},this),this._lastSeenCameraProjectionValues=new Do,this.mode=0,this._cssCamera=new Do,this._camera=new Do,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new Ap({state:this}),this.events=new zi,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new tl({camera:Do},this)}destroy(){this.cameraController=null,this._propertiesPool?.destroy(),this._propertiesPool=null}createInitialCamera(){if(1===this.viewingMode){const e=ge(this.spatialReference).radius;this.camera=new Do({eye:Ve(4*e,0,0),center:Ve(e,0,0),up:Ve(0,0,1)})}else this.camera=new Do({eye:Ve(0,0,100),center:Ve(0,0,0),up:Ve(0,1,0)})}get animation(){return this.cameraController instanceof Fg&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:i,pixelRatio:s}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/s),e.width=Math.round(i/s),e}get camera(){return this._camera}set camera(e){e!==Hv&&Hv.copyFrom(e),Hv.computeUp(this.viewingMode),this.events.emit("before-camera-change",{camera:Hv});const t=this._camera;if(i=this._lastSeenCameraProjectionValues,s=Hv,(i.fov!==s.fov||i.fullViewport[0]!==s.fullViewport[0]||i.fullViewport[1]!==s.fullViewport[1]||i.fullViewport[2]!==s.fullViewport[2]||i.fullViewport[3]!==s.fullViewport[3]||i.padding[0]!==s.padding[0]||i.padding[1]!==s.padding[1]||i.padding[2]!==s.padding[2]||i.padding[3]!==s.padding[3])&&(this._lastSeenCameraProjectionValues.copyFrom(Hv),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(Hv)&&(this._camera=this._propertiesPool.get("camera").copyFrom(Hv),this._cameraChanged=!t.almostEquals(Hv),this._cameraChanged)){const e=Ae(()=>{this._cameraChanged=!1,e.remove()})}var i,s}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&2===this.mode}get updating(){return 2!==this.mode}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){if(null==e)return void(this._contentCamera=null);const t=e.clone();this.events.emit("before-camera-change",{camera:t,sceneDepthRange:pi.infinite}),this._contentCamera=t}get fixedContentCamera(){return null!=this._contentCamera}get isGlobal(){return 1===this.viewingMode}get isLocal(){return 2===this.viewingMode}get viewingMode(){return Kt(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){const e=this.view.highlights.items.slice(0,Ih);for(let t=0;t<e.length;){const i=e[t],s=e.findIndex(e=>e.name===i.name);s>=0&&t>s?e.splice(t,1):++t}return e}get highlightOrderMap(){const e=new Map;return this.highlights.forEach((t,i)=>e.set(t.name,i)),e}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.cameraController?.destroy(),e&&(this.removeHandles(qv),this.addHandles($(()=>4===e.state||3===e.state,()=>{this._set("cameraController",null),this.updateCamera(t=>e.onControllerEnd(t))},{sync:!0,once:!0}),qv),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=1)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Hv.copyFrom(this._get("camera")),e(Hv),this.camera=Hv,this._processingUpdates=!1,this._processUpdateQueue()}static cleanupViewstate(){Hv=new Do}};e([Ce({constructOnly:!0})],jv.prototype,"view",void 0),e([Ce()],jv.prototype,"mode",void 0),e([Ce({readOnly:!0,type:Yt})],jv.prototype,"animation",null),e([Ce({type:Do})],jv.prototype,"cssCamera",null),e([Ce()],jv.prototype,"_cssCamera",void 0),e([Ce({type:Do})],jv.prototype,"camera",null),e([Ce()],jv.prototype,"_camera",void 0),e([Ce({readOnly:!0})],jv.prototype,"pixelRatio",null),e([Ce()],jv.prototype,"rasterPixelRatio",void 0),e([Ce()],jv.prototype,"contentPixelRatio",void 0),e([Ce({readOnly:!0})],jv.prototype,"alignPixelEnabled",null),e([Ce({readOnly:!0})],jv.prototype,"updating",null),e([Ce({})],jv.prototype,"_contentCamera",void 0),e([Ce({type:Do})],jv.prototype,"contentCamera",null),e([Ce({readOnly:!0})],jv.prototype,"fixedContentCamera",null),e([Ce({readOnly:!0})],jv.prototype,"events",void 0),e([Ce({readOnly:!0})],jv.prototype,"isGlobal",null),e([Ce({readOnly:!0})],jv.prototype,"isLocal",null),e([Ce({readOnly:!0})],jv.prototype,"viewingMode",null),e([Ce({readOnly:!0})],jv.prototype,"highlights",null),e([Ce({readOnly:!0})],jv.prototype,"highlightOrderMap",null),e([Ce({readOnly:!0})],jv.prototype,"navigating",null),e([Ce({readOnly:!0})],jv.prototype,"stationary",null),e([Ce()],jv.prototype,"_cameraChanged",void 0),e([Ce()],jv.prototype,"cameraController",null),jv=e([Se("esri.views.3d.state.ViewState")],jv);const zv=jv;let Hv=new Do;const qv="ViewStateHandles";function Uv(e){return(t,i,s)=>!Nl(e,Wi(Bv,t,i,s))}const Bv=ke();class Nv{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new Xl,this._tolerance=Io,this._tmpRay=qa(),this._tmpRegion=lt(),this._validateHUDIntersector=new Ao(this.viewingMode),this._validateHUDIntersector.options.hud=!1}destroy(){this._externalIntersectionHandlers.prune()}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),Zv(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,Zv(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,s){return t.options.selectionMode=!1,t.options.store=0,this.computeIntersection(e,t,!1,s),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,s=.5){return e.getRenderCenter(eb,i,s),eb[0]+=.0466,eb[1]-=.0123,Jo(e,eb,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,!1,i)}intersectToolIntersectorScreen(e,t,i){const s=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(s,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,!1,i);const s=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||Uh(s)&&2!==s.intersector||(t.options.selectionMode=!1,this.computeIntersection(e,t,!1,i))}setTolerance(e=Io){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((e,t)=>2===e.type?1:2===t.type?-1:0)}removeIntersectionHandler(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort((e,t)=>2===e.type?1:2===t.type?-1:0)}_getPickRay(e,t){const i=this._view.state.camera;return Xo(i,e,t)}_intersectRayFreePointLocal(e,t){return 2!==this.viewingMode||null==e||Ki(t,e.origin,Ni(qo.get(),e.direction)),!1}intersectElevationFromScreen(e,t,i=0,s=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,i,s)}_intersectElevation(e,t,i=0,s=null){if(null==e)return null;const r=this._view,{renderCoordsHelper:n}=r,a=fe(r.spatialReference),o=null!=t?t.mode:"absolute-height",l=jh(t)/a,h=("on-the-ground"!==o?l+i:0)*a/n.unitInMeters,{camera:c}=r.state;if("absolute-height"===o){const t=n?.getAltitude(c.eye),i=Gi(Ni(Xv,e.direction),n.worldUpAtPosition(c.eye,Jv));if(t<h&&i<0||t>=h&&i>0)return null;if(n.intersectInfiniteManifold(e,h,Xv)){const e=zh(r,Xv);return e.z??=0,e.z-=l,e}return null}const d=le(qo.get());c.projectToRenderScreen(e.origin,d);const u=new Yv(null,this._forEachLayer),{slice:{plane:p}}=r,m=null!=p?Uv(p):null,g=new Ao(this.viewingMode);g.options.store=0,g.options.verticalOffset=h,g.options.normalRequired=!1;const _=e.origin,f=Ki(qo.get(),_,e.direction);g.reset(_,f,c),g.point=d;let y=null;if(s&&"type"in s&&"graphics"===s.type){const e=r.allLayerViews.find(e=>e.layer===s)?.uid;y=e?t=>t.layerViewUid===e:null}else s&&(y=e=>e.graphicUid!==s.uid);switch(o){case"relative-to-scene":{const e=e=>(!y||y(e))&&!!e.lastValidElevationBB;g.intersect(u.layers,d,this._tolerance,null,e),this._externalIntersectionHandlers.forAll(e=>{if(4===e.type||2===e.type||8===e.type){const t=e.slicePlaneEnabled?m:null;e.intersect(g,t,g.rayBegin,g.rayEnd,d,!1)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(e=>{if(e.isGround){const t=e.slicePlaneEnabled?m:null;e.intersect(g,t,g.rayBegin,g.rayEnd,d,!1)}})}if(g.results.min.getIntersectionPoint(Xv)){const e=zh(r,Xv);return e.z=i,e}return null}computeIntersection(e,t,i,s){if(null==e)return;const r=this._view.state.camera,n=le(qo.get());r.projectToRenderScreen(e.origin,n);const a=new Yv(s,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!s||!("include"in s||"exclude"in s);const o=e.origin,l=Ki(qo.get(),e.origin,e.direction);t.reset(o,l,r),t.intersect(a.layers,n,this._tolerance);const h=this._view.slice.plane,c=null!=h?Uv(h):null;t.intersect(a.sliceableLayers,n,this._tolerance,c);const d=s&&(s.requiresGroundFeedback||s.enableDraped);this._externalIntersectionHandlers.forAll(e=>{const s=e.layerViewUid,r=e.sublayerId,h=Array.isArray(s),u=h?s:[s];h&&(t.options.filteredLayerViewUids=[]);let p=!1;for(const e of u)a.filterLayerViewUid(e,r)?p=!0:h&&t.options.filteredLayerViewUids.push(e);if(t.options.isFiltered=!p,e.isGround&&d||!t.options.isFiltered){const s=e.slicePlaneEnabled?c:null;e.intersect(t,s,o,l,n,i)}});const u=qo.get(),p=this._view.basemapTerrain;if(s&&s.enableDraped&&null!=p.spatialReference&&t.results.ground.getIntersectionPoint(u)){const e=p.overlayManager.renderer,i=this._view.renderCoordsHelper.spatialReference,s=qo.get();this._view.renderCoordsHelper.fromRenderCoords(u,s,p.spatialReference),s[2]=this._view.elevationProvider?.getElevation(u[0],u[1],u[2],i,"ground")??0,e.intersect(t,s,t.results.ground,e=>a.filterRenderGeometry(e))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;ct(this._tmpRegion,gt);const i=this._view.state.camera,s=[],r=this._tmpRegion,n=e=>{const t=new $v(e),n=t.result.target.object.geometries.every(e=>e.material instanceof eh&&e.material.parameters.occlusionTest);s.push({item:t,occlusionTest:n}),n&&(i.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),_t(r,t.screenPoint))};e.sortResults(t.all),null!=t.min.distance&&n(t.min);for(const e of t.all)t.min.target.object!==e.target.object&&t.max.target.object!==e.target.object&&n(e);if(null!=t.max.distance&&t.max.target.object!==t.min.target.object&&n(t.max),!s.length)return;r[0]===r[2]&&(r[2]+=1),r[1]===r[3]&&(r[3]+=1);const a=i.fullWidth,o=i.fullHeight,l=Math.max(0,r[0]-Gv),h=Math.max(0,r[1]-Gv),c=Math.min(ut(r)+2*Gv,a-l),d=Math.min(pt(r)+2*Gv,o-h),u=c>0&&d>0?new Uint8Array(c*d*4):null;u&&this._view.stage.renderer.readHUDVisibility(l,h,c,d,u);let p=!0;const m=null==e.results.max.distance;let g=0;for(const{item:t,occlusionTest:i}of s){let s=!i;if(i&&u)for(const e of Wv){const i=4*(Math.min(t.screenPoint[0]+e[0],a)-r[0]+(Math.min(t.screenPoint[1]+e[1],o)-r[1])*c);if(i>=0&&i<u.length&&u[i]){s=!0;break}}s&&(p&&(e.results.min.copy(t.result),p=!1),m&&e.results.max.copy(t.result),2===e.options.store&&e.results.all.splice(g++,0,t.result))}}}const Gv=1,Wv=(()=>{const e=[],t=Gv;for(let i=-t;i<=t;i++)for(let s=-t;s<=t;s++)e.push([s+t,i+t]);return e})();class $v{constructor(e){this.result=e,this.screenPoint=oe()}}let Qv;function Zv(e){return Qv&&Qv.viewingMode===e||(Qv=new Ao(e)),Qv}class Yv{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t(e=>{e.pickable&&this.filterLayerViewUid(e.apiLayerViewUid)&&(e.sliceable?this.sliceableLayers:this.layers).push(e)})}filterLayerViewUid(e,t){const{include:i,exclude:s}=this;if(null==e)return null==i&&null==s;const r=i instanceof Map?i.get(e)??!1:i?.has(e),n=s instanceof Map?s.get(e)??!1:s?.has(e);return(null==r||("boolean"==typeof r?r:null!=t&&r.has(t)))&&(null==n||!("boolean"==typeof n?n:null!=t&&n.has(t)))}filterRenderGeometry(e){return this.filterLayerViewUid(e.layerViewUid)}}function Kv(e){return"object"==typeof e&&"intersect"in e}const Xv=ke(),Jv=ke(),eb=oe();class tb{constructor(e=1/0,t=-1/0){this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}}let ib=class extends ji{get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=S(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,i,s,r){if(this._cacheEnabled&&null!=this.lastElevationQuery){const n=this.lastElevationQuery;if(e===n.x&&t===n.y&&i===n.z&&ue(s,n.spatialReference)&&r===n.queryContext)return n.result}let n=null;return n=sb(n,this._im,e,t,i,s,r),null==n&&(n=sb(n,this._ground,e,t,i,s,r)),"scene"===r&&(n=sb(n,this._scene,e,t,i,s,r)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:s,queryContext:r,result:n}),n}getSphereElevationBounds(e,t,i){const s=new tb;function r(r){for(const n of r)if(n.getSphereElevationBounds){const r=n.getSphereElevationBounds(e,t,i);null!=r&&s.expandElevationRangeValues(r.elevationRangeMin,r.elevationRangeMax)}}return r(this._ground),r(this._im),"scene"===i&&r(this._scene),s}getRootElevationBounds(){const e=new tb;for(const t of[this._im,this._ground,this._scene])t.forEach(t=>{if(t.getRootElevationBounds){const i=t.getRootElevationBounds();null!=i&&e.expandElevationRangeValues(i.elevationRangeMin,i.elevationRangeMax)}});return e}async queryElevation(e,t,i,s,r,n=null,a=0){const o=this._getElevationQuery(s);try{const l=await o.queryElevation(e,t,n,a);return"scene"===r?sb(l,this._scene,e,t,i,s,r):l}catch(n){return j(n),this.getElevation(e,t,i,s,r)}}register(e,t){this.addHandles(t.on("elevation-change",e=>this.emit("elevation-change",e)),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(null!=t&&ue(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:i,wkt:s,wkt2:r,latestWkid:n}=e,a=new ao(this.view.resourceController.scheduler,new tt({wkid:i,wkt:s,wkt2:r,latestWkid:n}),()=>this.view.map?.ground,{maximumAutoTileRequests:4});return this._cachedQuery=a,a}};function sb(e,t,i,s,r,n,a){for(const o of t){const t=o.getElevation(i,s,r,n,a);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}e([Ce({constructOnly:!0})],ib.prototype,"view",void 0),e([Ce()],ib.prototype,"spatialReference",null),ib=e([Se("esri.views.3d.support.CombinedElevationProvider")],ib);class rb{static isValidProfile(e){return e in ab}static getDefaultProfile(){return h("esri-iPhone")?"low":"medium"}static apply(e,t){const i=ab[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods;const s=t.sceneService.object,r=i.sceneService.object;s.lodFactor=r.lodFactor,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=i.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.highResolutionAtmosphere=i.highResolutionAtmosphere,t.reflections=i.reflections,t.ambientOcclusion=i.ambientOcclusion,t.maxTexturePixels=i.maxTexturePixels,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}static{this.test={reset(){const e=ob();for(const t of Object.keys(e))ab[t]=e[t]}}}}const nb={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430},ab=ob();function ob(){const e=!!h("esri-mobile"),t=!!h("ios"),i=X(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5}},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:X(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:e?1048576:4194304,memoryLimit:200+nb.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!h("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:e?4194304:4096**2,memoryLimit:e?600+nb.GalaxyS20:750+nb.FullHD,additionalCacheMemory:e?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!h("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,maxTexturePixels:e?4096**2:1/0,memoryLimit:e?900+nb.SurfacePro7:1500+nb.FullHDRetina,additionalCacheMemory:e?-150:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}const lb={layerUids:new Set,layerViews:[]};let hb=class extends Oe{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};e([Ce()],hb.prototype,"minTotalNumberOfFeatures",void 0),e([Ce()],hb.prototype,"maxTotalNumberOfFeatures",void 0),e([Ce()],hb.prototype,"maxNumberOfDrawCalls",void 0),e([Ce()],hb.prototype,"maxTotalNumberOfVertices",void 0),e([Ce()],hb.prototype,"snapshotAvailable",void 0),e([Ce()],hb.prototype,"polygonLodFactor",void 0),e([Ce()],hb.prototype,"polylineLodFactor",void 0),e([Ce()],hb.prototype,"skipHighSymbolLods",void 0),hb=e([Se("esri.views.3d.support.QualitySettings.Graphics3DSettings")],hb);let cb=class extends Oe{constructor(){super(...arguments),this.lodFactor=1}};e([Ce()],cb.prototype,"lodFactor",void 0),cb=e([Se("esri.views.3d.support.QualitySettings.LoDFactorSettings")],cb);let db=class extends Oe{constructor(){super(...arguments),this.object=new cb,this.point=new cb,this.integratedMesh=new cb,this.pointCloud=new cb}};e([Ce({type:cb})],db.prototype,"object",void 0),e([Ce({type:cb})],db.prototype,"point",void 0),e([Ce({type:cb})],db.prototype,"integratedMesh",void 0),e([Ce({type:cb})],db.prototype,"pointCloud",void 0),db=e([Se("esri.views.3d.support.QualitySettings.SceneServiceSettings")],db);let ub=class extends Oe{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};e([Ce()],ub.prototype,"lodBias",void 0),e([Ce()],ub.prototype,"angledSplitBias",void 0),e([Ce()],ub.prototype,"vtlContentZoom",void 0),e([Ce()],ub.prototype,"elevationLevelDelta",void 0),e([Ce()],ub.prototype,"reduceTileLevelDifferences",void 0),ub=e([Se("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],ub);let pb=class extends Oe{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};e([Ce()],pb.prototype,"pixelRatio",void 0),e([Ce()],pb.prototype,"maxTotalNumberOfFeatures",void 0),pb=e([Se("esri.views.3d.support.QualitySettings.HeatmapSettings")],pb);let mb=class extends Oe{constructor(){super(...arguments),this.graphics3D=new hb,this.sceneService=new db,this.tiledSurface=new ub,this.heatmap=new pb,this.fadeDuration=X(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.bloom=!1,this.maxTexturePixels=1/0,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};e([Ce({type:hb})],mb.prototype,"graphics3D",void 0),e([Ce({type:db})],mb.prototype,"sceneService",void 0),e([Ce({type:ub})],mb.prototype,"tiledSurface",void 0),e([Ce({type:pb})],mb.prototype,"heatmap",void 0),e([Ce()],mb.prototype,"fadeDuration",void 0),e([Ce()],mb.prototype,"antialiasingEnabled",void 0),e([Ce()],mb.prototype,"physicallyBasedRenderingEnabled",void 0),e([Ce()],mb.prototype,"highQualityTransparency",void 0),e([Ce()],mb.prototype,"highResolutionAtmosphere",void 0),e([Ce()],mb.prototype,"reflections",void 0),e([Ce()],mb.prototype,"ambientOcclusion",void 0),e([Ce()],mb.prototype,"bloom",void 0),e([Ce()],mb.prototype,"maxTexturePixels",void 0),e([Ce()],mb.prototype,"memoryLimit",void 0),e([Ce()],mb.prototype,"additionalCacheMemory",void 0),e([Ce()],mb.prototype,"frameRate",void 0),e([Ce()],mb.prototype,"maximumPixelRatio",void 0),mb=e([Se("esri.views.3d.support.QualitySettings")],mb);const gb=mb,_b=(()=>{const e=new Array;return e[0]=10,e[1]=10,e[2]=10,e[3]=10,e[4]=5,e})(),fb=30,yb=.1,vb=!!h("esri-tests-disable-memory-pools");let bb=class extends Oe{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._predictedMemory=0,this._cacheStorage=new $h,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=vb?4096:750,this._additionalCacheMemory=vb?-4096:0,this.addHandles(ee({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||vb||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null==e||vb||(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t,i){return new Qh(e,this._cacheStorage,t,i)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._predictedMemory<=0&&!this._updating)return;let e=this._layersUpdating();if(this._predictedMemory<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e){if(this._predictedMemory>1.1||this._usedMemory>1)if(this._stableQuality>0)this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality);else if(this._quality>.1&&this._downscaleMemoryUsed<this._usedMemory){if(this._compactAndUpdate())return;this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1}}else if(this._downscaleMemoryUsed=0,this._usedMemory>1){if(this._compactAndUpdate())return;this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._predictedMemory}else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_compactAndUpdate(){const e=Fn(X(100)),t=this.view.stage.compact(e);return this.view.basemapTerrain.overlayManager.renderer.compact(e)||t}_updateQuality(e){return(e=Math.min(Math.max(e,.1),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){if(!this.view||this.view.destroyed||this.view.destroying)return;this.view.stage?.renderer?.tick();const e=this.view.stage?.renderer?.usedMemory;let t=(this.view.basemapTerrain?.usedMemory??0)+(e?e.fbos+e.edges+e.plugins:0)+this.view.labeler?.usedMemory,i=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(e=>{if("usedMemory"in(s=e)&&"unloadedMemory"in s&&"ignoresMemoryFactor"in s){const s=e.ignoresMemoryFactor?this._quality:1;t+=e.usedMemory*s,i+=e.unloadedMemory*s}var s});const s=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),r=1048576*this.maxMemory;if(t>r&&s){this._warnMemoryUsage=t;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",s=Math.round(100*this._quality);C.getLogger(this).warn(`Memory Limit exceeded! Limit: ${e(r)} Current: ${e(t)} Projected: ${e(t+i)} Quality: ${s}%`)}this._usedMemory=t/r,this._predictedMemory=(t+i)/r;const n=r-t;this._cacheStorage.maxSize=Math.max(0,n+1048576*this.additionalCacheMemory)}get test(){}};e([Ce({constructOnly:!0})],bb.prototype,"view",void 0),e([Ce()],bb.prototype,"maxMemory",null),e([Ce()],bb.prototype,"additionalCacheMemory",null),e([Ce({readOnly:!0})],bb.prototype,"memoryFactor",null),e([Ce({readOnly:!0})],bb.prototype,"updating",null),e([Ce({readOnly:!0})],bb.prototype,"usedMemory",null),e([Ce({readOnly:!0})],bb.prototype,"usedCacheMemory",null),e([Ce()],bb.prototype,"_quality",void 0),e([Ce()],bb.prototype,"_usedMemory",void 0),e([Ce()],bb.prototype,"_updating",void 0),e([Ce()],bb.prototype,"_stableQuality",void 0),e([Ce()],bb.prototype,"_maxMemory",void 0),e([Ce()],bb.prototype,"_additionalCacheMemory",void 0),bb=e([Se("esri.views.3d.support.MemoryController")],bb);class wb{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}class xb{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new Cb}}class Cb{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class Tb{constructor(e,t,i,s){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=s.map(e=>new xb(e))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(e,t)=>this._taskCallback(e,t))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,Kh(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(e,t)=>this._taskCallback(e,t)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}}class Sb{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque="image/jpeg"===t}}let Pb=class extends Oe{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new Tb((e,t)=>this._startLoading(e,t),(e,t)=>this._doneLoadingCB(e,t),e,t),i&&(this._frameTask=i.registerTask(kn.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=T(this._frameTask),this._tasks.forEach(e=>P(e.abortController)),this._loadQueue=S(this._loadQueue),this._onLoadQueue.length=0,this._onLoadQueue=null,this._doneQueue.length=0,this._doneQueue=null,this._tasks.forEach(e=>e.destroy()),this._tasks.clear(),this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i,s={}){const r=L();return r.__signal=null!=s?s.signal:null,this._createOrUpdateTask(e,t,i,s,r),r.promise}_createTask(e,t,i,s,r,n){const a=new Mb(e,t,i,s,r);return this._updateTask(a,n),this._tasks.set(r,a),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(a),a}_cancelRequest(e,t){const i=this._tasks.get(e);i&&(u(i.resolvers,t),t.reject(A()),0===i.resolvers.length&&(2===i.status&&this._loadQueue.cancel(i),i.status=4,this._removeTask(i)))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,s,r){const n=function(e,t,i){return`${e}:${t}:${i}`}(s?.uid||e,t,i);let a=this._tasks.get(n);a?this._updateTask(a,r):(a=this._createTask(e,s,t,i,n,r),a.abortHandle=I(s,()=>this._cancelRequest(n,r)))}_doneLoadingCB(e,t){this._loadQueue&&(Kh(2===e.status),e.status=3,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get readyToRun(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();V(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();3!==t.task.status&&(t.err=t.err||A()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!F(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=sc(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const s of e.resolvers)if(t)F(t)?s.reject(t):s.reject(new n("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const t=i>0?d(e.result):e.result;s.resolve(t)}this._removeTask(e)}_removeTask(e){this._tasks.delete(e.key),e.destroy(),0===this._tasks.size&&this._set("updating",!1)}_startLoading(e,t){if(4===e.status)return!1;let i,s;switch(e.startTime=performance.now(),e.status=2,e.docType){case 1:s="array-buffer",i=0;break;case 2:s="image";break;case 3:s="array-buffer";break;default:s="json"}e.abortController=new AbortController;const r=e.abortController.signal;e.request=Yh(e.url,{...e.options,responseType:s,timeout:i,signal:r});const n=i=>{e.duration=performance.now()-e.startTime,e.size=i instanceof ArrayBuffer?i.byteLength:e.size||0,e.result=i,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=i=>{2===e.status&&t(e,i)};return 3!==e.docType?(e.request.then(e=>n(e.data),a),!0):(e.request.then(t=>{const o=t.data,l=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(o);if(s="image",e.size=o.byteLength,"unknown"===l)return e.request=Yh(e.url,{responseType:s,timeout:i,signal:r}),void e.request.then(e=>n(e.data),a);const h=new Blob([o],{type:l}),c=window.URL.createObjectURL(h);e.request=Yh(c,{responseType:s,timeout:i,signal:r}),e.request.then(e=>n(new Sb(e.data,l)),a).finally(()=>window.URL.revokeObjectURL(c))},a),!0)}get test(){}};e([Ce({readOnly:!0})],Pb.prototype,"updating",void 0),Pb=e([Se("esri.views.3d.support.StreamDataLoader")],Pb);class Mb extends wb{constructor(e,t,i,s,r){super(s),this.url=e,this.options=t,this.docType=i,this.key=r,this.abortHandle=null,this.result=null,this.status=1,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=0}destroy(){this.result=null,this.request=null,this.abortController?.abort(),this.abortController=null,this.resolvers.length=0,this.options=null,this.abortHandle=T(this.abortHandle)}}class Rb{constructor(e,t){this._loader=e,this._clientType=t}request(e,t,i={}){return this._loader.request(e,t,this._clientType,i)}get busy(){return!this._loader.hasDownloadSlots(this._clientType)}}let Ob=class extends Oe{constructor(){super(...arguments),this.updating=!1}};e([Ce({readOnly:!0})],Ob.prototype,"updating",void 0),Ob=e([Se("esri.views.3d.support.ResourceController.ResourceControllerMain")],Ob);let Db=class extends Ob{constructor(){super(...arguments),this._immediateTask=jn,this._normalTask=jn,this._updatingObjects=ds([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){var e;this._scheduler=zn(),this._memoryController=(e=this.view,new bb({view:e})),this._streamDataLoader=new Pb,this._streamDataLoader.setup(30,_b,this._scheduler),this.addHandles([B(()=>this.view.state?.mode,e=>{null!=e&&(this._scheduler.state=e)},W),B(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=ee({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(kn.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(kn.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=T(this._frameTask),this._streamDataLoader=S(this._streamDataLoader),this._memoryController=S(this._memoryController),this._scheduler=S(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some(e=>e.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){return new Rb(this._streamDataLoader,e)}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],o(()=>{t.value=t.value.filter(t=>t!==e)})}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(K(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.frame(e))}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};e([Ce()],Db.prototype,"view",void 0),e([Ce()],Db.prototype,"_scheduler",void 0),e([Ce()],Db.prototype,"_memoryController",void 0),e([Ce()],Db.prototype,"_streamDataLoader",void 0),e([Ce()],Db.prototype,"_immediateTask",void 0),e([Ce()],Db.prototype,"_normalTask",void 0),e([Ce({readOnly:!0})],Db.prototype,"updating",null),Db=e([Se("esri.views.3d.support.ResourceController")],Db);class Ab{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",()=>{}),this._wosrMemCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,i){const s=i?`gltfPBR:${e}`:`gltf:${e}`,r=this._gltfMemCache.get(s);return null!=r?Promise.resolve(r):Eb(this._gltfLoading,this._gltfMemCache,s,async t=>{const{loadGLTF:s}=await import("../chunks/loader.js");return s(new Gc(t.streamDataRequester),e,t,i)},t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`,s=this._wosrMemCache.get(i);return null!=s?Promise.resolve(s):Eb(this._wosrLoading,this._wosrMemCache,i,t=>Wc(e,t),t)}}async function Eb(e,t,i,s,r){V(r);const n=I(r,()=>function(e,t){const i=e.get(t);null!=i&&--i.refCount>0||(e.delete(t),null!=i&&i.abortController.abort())}(e,i));let a=e.get(i);if(a)a.refCount++;else{const t=new AbortController;a={refCount:1,abortController:t,promise:s({...r,signal:t.signal})},e.set(i,a)}try{const s=await a.promise;return t.put(i,s),e.delete(i),V(r),s}finally{T(n)}}let Ib=class extends Oe{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=t?.registerTask(kn.TEXTURE_UNLOAD)??jn}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const i=this.makeUid(e);let s=this._textureRequests.get(i);if(!s){const e=new kb;e.texture=t(),this._stage&&(e.texture.load(this._stage.renderView.renderingContext),this._stage.addTexture(e.texture)),this._textureRequests.set(i,e),s=e}return s.referenceCount++,new Lb(i,s.texture,()=>this._release(i))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(t.texture?.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.texture?this._stage?.removeTexture(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return null!=t?`${e}.${t}px`:e}};e([Ce()],Ib.prototype,"_frameTask",void 0),e([Ce()],Ib.prototype,"updating",null),Ib=e([Se("esri.views.3d.support.TextureCollection")],Ib);class Lb{constructor(e,t,i){this.uid=e,this.texture=t,this.release=i}}class kb{constructor(){this.referenceCount=0}}class Vb extends Ib{constructor(e,t,i){super(t,i),this._streamDataRequester=e}async fromUrl(e,t,i){V(i);const s=i?.signal,r=this.makeUid(e,t);let n=this._textureRequests.get(r);if(!n){const i=new AbortController,s=this._streamDataRequester.request(e,2,{uid:r,signal:i.signal});n=new kb,n.abortController=i;const a=n;this._textureRequests.set(r,n),n.textureAsync=s.then(async i=>{const s=this._createTexture(e,i,t);return a.texture=s,a.abortController=null,await s.load(this._stage.renderView.renderingContext),this._stage.addTexture(s),new Lb(r,s,()=>this._release(r))},e=>{throw a.abortController=null,e})}n.referenceCount++;try{return await z(n.textureAsync,s)}catch(e){throw this._release(r),e}}_createTexture(e,t,i){const s={width:t.width,height:t.height,wrap:{s:33071,t:33071},preMultiplyAlpha:!0,reloadable:!0};if($c(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(s.preMultiplyAlpha=!1)}return new Ar(t,s)}}class Fb{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(4),this.objectResourceCache=new Ab((t,i)=>e.resourceController.memoryController.newCache(t,i)),this.textures=new Vb(this.streamDataRequester,e.view.stage,e.resourceController.scheduler);const t=ge(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=Er(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=Ir(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return o();this._graphicsOwners.push(e);const t=B(()=>e.layer?.screenSizePerspectiveEnabled,()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),o(()=>{t.remove(),u(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some(e=>!0===e.layer?.screenSizePerspectiveEnabled);if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new jl;const e=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([B(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,e,W),this._viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=S(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;jb.distance=e.centerOnSurfaceInfrequent.distance,jb.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(jb),this.screenSizePerspectiveSettingsLabels.update(jb),this._view.stage.renderView.requestRender()}get test(){}}const jb={distance:0,fovY:0};let zb=class extends Oe{constructor(){super(),this._propertiesPool=new tl({plane:Ql},this),this.isDecoration=!0,this.addHandles(l(this._propertiesPool))}set plane(e){if(!e)return void this._set("plane",e);const t=this._propertiesPool.get("plane");Wl(e,t),this._set("plane",t)}};e([Ce()],zb.prototype,"plane",null),e([Ce()],zb.prototype,"isDecoration",void 0),zb=e([Se("esri.views.3d.support.ViewSlice")],zb);class Hb{constructor(e){this.destination=e}hide(){null!=this.graphic&&(this.destination.remove(this.graphic),this.graphic=null)}}class qb extends Hb{constructor(e,t,i=""){super(e),this._symbol=new Yc({symbolLayers:new s([new Zc({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new Kc({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(!t)return;this.hide();const i=new Ze({x:e[0],y:e[1],z:e[2],spatialReference:t});this.graphic=new Qc({geometry:i,symbol:this._symbol}),this.destination.add(this.graphic)}}let Ub=class extends Oe{constructor(e){super(e)}};e([Ce({constructOnly:!0})],Ub.prototype,"renderCoordsHelper",void 0),e([Ce({constructOnly:!0})],Ub.prototype,"surface",void 0),e([Ce({constructOnly:!0})],Ub.prototype,"state",void 0),Ub=e([Se("esri.views.3d.support.pointsOfInterest.PointOfInterest")],Ub);const Bb=Array;let Nb=class extends Ub{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new tl({location:Ze,renderLocation:Bb},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=ke(),this._tmpPoint=new Ze}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles(Z(()=>this.map?.ground?.layers,"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=S(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=Xi(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return Dl(i,t)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get readyToRun(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),Vn;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>Wb&&1===this.renderCoordsHelper.viewingMode&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:t?$b:0}).then(e=>this._updateSurfaceAltitude(e.geometry.z??0)).catch(e=>{F(e)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null}),this._pendingElevationQueryController=i,Vn}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(Gb,this._estimatedSurfaceAltitude,this._camera.eye),as(this._get("renderLocation"),Gb)||(this._set("renderLocation",Zi(this._propertiesPool.get("renderLocation"),Gb)),this.notifyChange("renderLocation"))}};e([Ce({constructOnly:!0})],Nb.prototype,"scheduler",void 0),e([Ce({constructOnly:!0})],Nb.prototype,"cache",void 0),e([Ce({constructOnly:!0})],Nb.prototype,"task",void 0),e([Ce()],Nb.prototype,"location",null),e([Ce({constructOnly:!0})],Nb.prototype,"map",void 0),e([Ce()],Nb.prototype,"renderLocation",void 0),e([Ce()],Nb.prototype,"scale",null),e([Ce()],Nb.prototype,"updating",null),Nb=e([Se("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],Nb);const Gb=ke(),Wb=1e5,$b=1e6,Qb=Array;let Zb=class extends Ub{constructor(e){super(e),this._propertiesPool=new tl({location:Ze,renderLocation:Qb},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=ke(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=T(this._frameWorker),this._propertiesPool=S(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get readyToRun(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Vn}_updateRenderLocation(){const e=Kb;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const s=Xb;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,s)&&(Zi(e,s),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=Xi(this._camera.eye,e):(Bi(e,this._camera.viewForward,this._get("distance")),Ki(e,e,this._camera.eye)),as(this._get("renderLocation"),e)||this._set("renderLocation",Zi(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const s=ge(this.renderCoordsHelper.spatialReference).radius,r=s+e,n=ts(i.eye),a=n<r*r,o=Xi(i.eye,t);if(a&&o>s/4){const e=r-Math.sqrt(n);return Bi(t,i.viewForward,e),Ki(t,t,i.eye),!0}}else{const e=this.surface?.ready?this.surface.extent:null;null!=e&&nt(e,this.surface?.spatialReference,Jb,this.renderCoordsHelper.spatialReference)&&(t[0]=Ci(t[0],Jb[0],Jb[2]),t[1]=Ci(t[1],Jb[1],Jb[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(Jl.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,s=Xi(i,e),r=Xi(i,t);if(Math.abs(r-s)/s>Yb)return!0}return!1}};e([Ce({constructOnly:!0})],Zb.prototype,"scheduler",void 0),e([Ce({constructOnly:!0})],Zb.prototype,"task",void 0),e([Ce()],Zb.prototype,"distance",void 0),e([Ce({constructOnly:!0})],Zb.prototype,"estimateSurfaceAltitudeAtCenter",void 0),e([Ce({readOnly:!0})],Zb.prototype,"location",null),e([Ce({readOnly:!0})],Zb.prototype,"renderLocation",void 0),e([Ce()],Zb.prototype,"updating",void 0),Zb=e([Se("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],Zb);const Yb=.05,Kb=ke(),Xb=ke(),Jb=lt();class ew{constructor(e){this.events=new zi,this._handles=Xc(()=>e,e=>e.on("visible-geometry-changed",e=>this.events.emit("request-update",e)))}destroy(){this._handles.destroy()}}const tw=Array;let iw=class extends Ub{constructor(e){super(e),this._propertiesPool=new tl({location:Ze,renderLocation:tw},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([B(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),B(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.addHandles(this.scheduler.registerTask(kn.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=S(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get readyToRun(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,s=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,sw);const r=Math.max(0,(Math.acos(Gi(sw,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(r)){if(!e||!Qi(e,t)){const e=this._propertiesPool.get("renderLocation");Zi(e,t),this._set("renderLocation",e)}return Vn}const n=1-Ci(r/(.5*Math.PI),0,1),a=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(nw);const o=this._propertiesPool.get("renderLocation");return Wi(o,t,nw,a),e&&Qi(e,o)||this._set("renderLocation",o),Vn}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter(oe());if(i[1]=t.aboveGround?t.padding[2]:t.fullHeight-t.padding[0],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const s=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,rw)){Yi(rw,rw,t.eye);const i=Ni(rw,rw);if(this.renderCoordsHelper.intersectInfiniteManifold(Ha(t.eye,i),s,e))return e}return this.renderCoordsHelper.setAltitude(e,s,t.eye)}updateRenderLocation(){this._dirty=!0}};e([Ce()],iw.prototype,"_dirty",void 0),e([Ce({constructOnly:!0})],iw.prototype,"scheduler",void 0),e([Ce({constructOnly:!0})],iw.prototype,"centerOnSurface",void 0),e([Ce({constructOnly:!0})],iw.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),e([Ce()],iw.prototype,"updating",null),e([Ce()],iw.prototype,"location",null),e([Ce()],iw.prototype,"renderLocation",void 0),e([Ce()],iw.prototype,"worldUnitsPerContentPixel",null),iw=e([Se("esri.views.3d.support.pointsOfInterest.Focus")],iw);const sw=ke(),rw=ke(),nw=ke();let aw=class extends Oe{get surface(){return this.view.map?.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=ke();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([B(()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent],()=>this._update()),Z(()=>this.surface?.layers,"change",()=>this._update())]),this._update())}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),null==this.surfaceView?.extent||null==this.surfaceView.spatialReference)return void this._set("location",null);const e=ft(this.surfaceView.extent),t=new Ze({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(e=>{this._updateController=null,this._set("location",e.geometry)}).catch(e=>{})):this._set("location",t)}};e([Ce({constructOnly:!0})],aw.prototype,"view",void 0),e([Ce({constructOnly:!0})],aw.prototype,"cache",void 0),e([Ce()],aw.prototype,"surface",null),e([Ce()],aw.prototype,"surfaceView",null),e([Ce({readOnly:!0})],aw.prototype,"location",void 0),e([Ce({readOnly:!0})],aw.prototype,"renderLocation",null),aw=e([Se("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],aw);let ow=class extends Oe{constructor(e){super(e),this._tileGeometryUpdateExtent=ht(),this._tileGeometryUpdateSpatialReference=null,this.events=new zi,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(kn.SURFACE_GEOMETRY_UPDATES,this)])}get readyToRun(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",lw),ht(this._tileGeometryUpdateExtent),this._set("updating",!1),Vn):Vn}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,mt(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.contentCamera.eye,s=dw,r=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,hw,t),this.renderCoordsHelper.fromRenderCoords(r.renderLocation,cw,t),hw[0]<cw[0]?(s[0]=hw[0],s[2]=cw[0]):(s[0]=cw[0],s[2]=hw[0]),hw[1]<cw[1]?(s[1]=hw[1],s[3]=cw[1]):(s[1]=cw[1],s[3]=hw[1]),ot(s,e)}};e([Ce({constructOnly:!0})],ow.prototype,"state",void 0),e([Ce({constructOnly:!0})],ow.prototype,"centerOnSurfaces",void 0),e([Ce({constructOnly:!0})],ow.prototype,"renderCoordsHelper",void 0),e([Ce({constructOnly:!0})],ow.prototype,"scheduler",void 0),e([Ce({constructOnly:!0})],ow.prototype,"surface",void 0),e([Ce({readOnly:!0})],ow.prototype,"updating",void 0),ow=e([Se("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],ow);const lw={},hw=ke(),cw=ke(),dw=ht();let uw=class extends Oe{constructor(e){super(e),this.renderPointOfView=ke(),this._pois=new Array,this._updatingHandles=new Yl,this._debugCenters=null,this._tmpRay=qa(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new tl({renderPointOfView:pw},this),this._contentIntersector=new Ao(e.view.state.viewingMode),this._surfaceIntersector=new Ao(e.view.state.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=0}initialize(){const{state:e,basemapTerrain:t,renderCoordsHelper:i,map:s}=this.view,r=()=>this._estimateSurfaceAltitudeAtCenter(),n=this.view.resourceController.scheduler,a=t?.elevationQueryCache,o={state:e,scheduler:n,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new Zb({...o,task:kn.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:r})),this._set("centerOnSurfaceFrequent",new Zb({...o,task:kn.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:r})),this._set("centerOnContent",new Zb({...o,task:kn.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new Nb({...o,cache:a,task:kn.POINT_OF_INTEREST_INFREQUENT,map:s})),this._set("surfaceGeometryUpdates",new ow({...o,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new ew(this.view.allLayerViews)),this._set("surfaceOrigin",new aw({cache:a,view:this.view})),this._set("focus",new iw({state:e,scheduler:n,surface:t,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([B(()=>e.contentCamera,e=>this._cameraChanged(e),W),this._updatingHandles.add(()=>t.extent,()=>this._updateCenterPointsOfInterest()),this._updatingHandles.add(()=>this.view.map?.ground?.navigationConstraint?.type,e=>{this._surfaceIntersector.options.backfacesTerrain="none"===e},N),$(()=>!t.updating,()=>this._updateCenterPointsOfInterest(),W),Z(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),Z(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),this._updatingHandles.add(()=>Jl.SHOW_POI,e=>this._setDebug(e),N)]),this._cameraChanged(this.view.state.contentCamera);for(const e of this._pois)e.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this._pois.length=0,this.surfaceOrigin.destroy(),this._updatingHandles.destroy(),this._set("centerOnSurfaceInfrequent",null),this._set("centerOnSurfaceFrequent",null),this._set("centerOnContent",null),this._set("cameraOnSurface",null),this._set("surfaceGeometryUpdates",null),this._set("contentGeometryUpdates",null),this._set("surfaceOrigin",null),this._set("focus",null)}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some(e=>e.updating))||this._updatingHandles.updating}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return null==e||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,mw,_w)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(mw):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(null==e)return this._surfaceAltitudeAtCenter;const t=e.origin,i=Ki(mw,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(mw)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(mw)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const s=Jo(t,e,gw);if(null==s)return null;const r=s.origin,n=Ki(mw,s.origin,s.direction);return this._surfaceIntersector.resetWithRay(s,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,r,n),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;as(this.renderPointOfView,t)||this._set("renderPointOfView",Zi(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters?.forEach(e=>e.hide()),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;const e=this.view.graphics;this._debugCenters.set(this.centerOnContent,new qb(e,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new qb(e,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new qb(e,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new qb(e,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new qb(e,"green","Focus"))}for(const e of this._pois)this.addHandles(this._updatingHandles.add(()=>e.renderLocation,t=>this._debugCenters?.get(e)?.show(t,e.renderCoordsHelper.spatialReference),N),"debug")}get test(){}};e([Ce()],uw.prototype,"centerOnContent",void 0),e([Ce()],uw.prototype,"centerOnSurfaceFrequent",void 0),e([Ce()],uw.prototype,"centerOnSurfaceInfrequent",void 0),e([Ce()],uw.prototype,"cameraOnSurface",void 0),e([Ce()],uw.prototype,"focus",void 0),e([Ce()],uw.prototype,"renderPointOfView",void 0),e([Ce()],uw.prototype,"surfaceOrigin",void 0),e([Ce()],uw.prototype,"contentGeometryUpdates",void 0),e([Ce()],uw.prototype,"surfaceGeometryUpdates",void 0),e([Ce({constructOnly:!0})],uw.prototype,"view",void 0),e([Ce()],uw.prototype,"updating",null),uw=e([Se("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],uw);const pw=Array,mw=ke(),gw=qa(),_w={exclude:new Set([Eo])};class fw{constructor(e,t){this._cache=e(t,(e,t,i)=>{switch(t){case 0:return e.forEach(e=>e.dispose()),0;case 1:{const t=e.shift();return t?(i-=Math.round(t.cachedMemory),t.dispose()):i>0&&(C.getLogger("esri/core/MemCachePool").warn("Encountered empty MemCachePool with non-zero memory."),i=0),i}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const i=t.pop();return t.length>0?i&&(t.cachedMemory=this._cache.getSize(e)-Math.round(i.cachedMemory),this._cache.updateSize(e,t)):this._cache.pop(e),i}put(e,t,i=Zh){const s=this._cache.peek(e);if(!s){const s=new yw(t);return void this._cache.put(e,s,i)}s.push(t),s.cachedMemory=this._cache.getSize(e)+Math.round(t.cachedMemory),this._cache.updateSize(e,s)}}class yw extends Array{constructor(e){super(),this.item=e,this.cachedMemory=e.cachedMemory,this.push(e)}}const vw={value:.5,readOnly:!0},bw={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};class ww{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}class xw{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new hd(i,t)}computeMinMaxValue(e,t,i,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;const r=e-this.level;if(r<=0)return s;const n=2**r;if(Math.floor(t/n)!==this.i||Math.floor(i/n)!==this.j)return s;let a=1/0,o=-1/0;const l=this.samplerData.data.width,h=this.samplerData.data.values,c=.5*cd;let d=(l-1)/n,u=(i-this.j*n)*d,p=(t-this.i*n)*d;if(d<1){const e=Math.floor(u),t=Math.floor(p),i=e+t*l,r=h[i],n=h[i+1],a=h[i+l],o=h[i+l+1];if(r+n+a+o<c){const i=u-e,l=p-t,h=Vi(r,n,a,o,i,l),c=Vi(r,n,a,o,i+d,l),m=Vi(r,n,a,o,i,l+d),g=Vi(r,n,a,o,i+d,l+d);return s.min=Math.min(h,c,m,g),s.max=Math.max(h,c,m,g),s}u=e,p=t,d=1}else u=Math.floor(u),p=Math.floor(p),d=Math.ceil(d);for(let e=u;e<=u+d;e++)for(let t=p;t<=p+d;t++){const i=h[e+t*l];i<c?(a=Math.min(a,i),o=Math.max(o,i)):s.hasNoDataValues=!0}return s.min=a,s.max=o,s}}const Cw=.5*cd;function Tw(e,t,i){if(null==i)return null;for(const s of i){if(!s)continue;const i=s.safeWidth;let r=Ci(s.dy*(s.y1-t),0,i),n=Ci(s.dx*(e-s.x0),0,i);const a=Math.floor(r),o=Math.floor(n),l=s.data.width,h=a*l+o,c=s.data.values,d=c[h],u=c[h+1],p=h+l,m=c[p],g=c[p+1];if(d+m+u+g<Cw){r-=a,n-=o;const e=d+(u-d)*n;return e+(m+(g-m)*n-e)*r}}return null}let Sw=class extends Oe{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const i=t.layer;if("operationalLayerType"in i&&It(i.operationalLayerType)&&null!=this.viewSpatialReference){const t=Rw(i.fullExtent,this.viewSpatialReference);null!=t&&e.push(yt(t))}}),e}};e([Ce({readOnly:!0})],Sw.prototype,"layerViewsExtent",null),e([Ce({readOnly:!0})],Sw.prototype,"tiledLayersExtent",null),e([Ce({readOnly:!0})],Sw.prototype,"stencilEnabledExtents",null),e([Ce()],Sw.prototype,"viewSpatialReference",void 0),e([Ce()],Sw.prototype,"tilingScheme",void 0),e([Ce()],Sw.prototype,"defaultTiledLayersExtent",void 0),e([Ce({constructOnly:!0})],Sw.prototype,"layers",void 0),e([Ce({constructOnly:!0})],Sw.prototype,"layerViews",void 0),Sw=e([Se("esri.views.3d.terrain.ExtentHelper")],Sw);let Pw=class extends Sw{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?dd:ud}};Pw=e([Se("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],Pw);let Mw=class extends Sw{_computeLayerViewsExtent(){const e=ht(),t=this.viewSpatialReference;this.layerViews.forEach(i=>{const s=i.layer;if(i.isResolved()&&("graphics"!==s.type||!s.internal)){const s=Rw("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);mt(e,s,e)}});const i=vt(e)?e:null,s=this._get("layerViewsExtent");return bt(i,s)?s:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=ht();this.layers.forEach(s=>{if(s.loaded&&Lt(s)){const r=rc(s,t,2);if(null==r)return;const{tileInfo:n,fullExtent:a}=r,o="tilemapCache"in s?s.tilemapCache?.effectiveMaxLOD:void 0;null!=n&&null!=a&&(nc(s)||e.compatibleWith(n,o)&&a.spatialReference.equals(e.spatialReference))&&mt(i,a,i)}}),mt(i,this.defaultTiledLayersExtent,i);const s=vt(i)?i:null,r=this._get("tiledLayersExtent");return bt(s,r)?r:s}};function Rw(e,t){return null==e||e.spatialReference.equals(t)?e:Xe(e,e.spatialReference,t)}Mw=e([Se("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],Mw);const Ow=[0,1];class Dw{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}clear(){this.adds.length=0,this.removes.length=0,this.updates.length=0}prune(){this.clear()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}}class Aw{}class Ew{constructor(e){this.pending=e,this.adds=new Array,this.removes=new Array,this.updates=new Array}clearAddsAndRemoves(){this.adds.forEach(e=>u(this.pending.adds,e)),this.removes.forEach(e=>u(this.pending.removes,e)),this.adds.length=0,this.removes.length=0}clearUpdates(){this.updates.forEach(e=>u(this.pending.updates,e)),this.updates.length=0}clear(){this.clearUpdates(),this.clearAddsAndRemoves()}}function Iw(e){return e.geometry.indexCount>=1}class Lw{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}}function kw(e){if(e.length<2)return;const t=new Map;e.forAll(e=>t.set(e.from,e));let i=!0;for(;i;){i=!1;for(let s=0;s<e.length;++s){const r=e.data[s],n=t.get(r.to);n&&(r.to=n.to,t.delete(n.from),e.removeUnordered(n),i=!0)}}}class Vw extends Lw{constructor(e,t,i,s){super(t,i),this.geometry=e,this._highlightName=null,this.updateHighlightOptions(s)}updateHighlightOptions(e){const{geometry:t}=this;if(!t.hasHighlights)return void(this._highlightName=null);let i=-1,s=null;t.foreachHighlightOptions(t=>{const r=e.get(t)??-1;r>i&&(i=r,s=t)}),this._highlightName=s}get highlightName(){return this._highlightName}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}get hasOccludees(){return null!=this.geometry.occludees}}class Fw{constructor(){this.first=0,this.count=0}}class jw{constructor(){this._numElements=0,this._instances=new Map,this.holes=new Xl({allocator:e=>e||new Lw,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightNames=new Set,this.drawCommandsDefault=zw(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=zw(),this.drawCommandsShadowHighlightRest=zw()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightNames.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightNames.clear()}updateIfDrawCommandsDirty(e,t){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const e of this.instances.values())this.updateDrawState(e);this.updateDrawCommands(e,t)}}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,i){const s=this._instances.get(e);s&&(this._numElements-=s.numElements,s.from=t,s.to=i,this._numElements+=s.numElements)}updateDrawState(e){if(e.isVisible){const{highlightName:t}=e;t&&this.highlightNames.add(t),e.hasOccludees&&(this.hasOccludees=!0)}else this.hasHiddenInstances=!0}updateDrawCommands(e,t){if(this.drawCommandsDefault.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;const{sortedInstances:i}=this;if(this._updateHighlightDrawCommands(e,i),!this.needsMultipleCommands){const e=this.drawCommandsDefault.pushNew(),i=this.holes.front();return this.vao&&1===this.holes.length&&i.to===Math.floor(this.vao.getByteLength("geometry")/t)?(e.first=0,void(e.count=i.from)):(e.first=1/0,e.count=0,this._instances.forEach(t=>{e.first=Math.min(e.first,t.from),e.count=Math.max(e.count,t.to)}),void(e.count-=e.first))}for(const e of i)e.isVisible&&Hw(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e)}get sortedInstances(){return Array.from(this._instances.values()).sort((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from)}updateHighlights(e){this.highlightNames.clear();const t=this.sortedInstances;for(const i of t)i.updateHighlightOptions(e),i.isVisible&&i.highlightName&&this.highlightNames.add(i.highlightName);this._updateHighlightDrawCommands(e)}_updateHighlightDrawCommands(e,t=this.sortedInstances){const{drawCommandsHighlights:i,drawCommandsShadowHighlightRest:s}=this;i.clear(),s.clear();for(const r of t){if(r.updateHighlightOptions(e),!r.isVisible)continue;const{highlightName:t}=r;t&&(this.highlightNames.add(t),Hw(Td(i,t,zw),r)),t&&t===Lh||Hw(s,r)}}get needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function zw(){return new Xl({allocator:e=>e||new Fw,deallocator:e=>e})}function Hw(e,t){const i=e.back();if(null==i){const i=e.pushNew();return i.first=t.from,void(i.count=t.numElements)}if(r=t,(s=i).first+s.count>=r.from){const e=t.from-i.first+t.numElements;i.count=e}else{const i=e.pushNew();i.first=t.from,i.count=t.numElements}var s,r}class qw{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(t=>t.instances.has(e))}}let Uw=class extends Oe{constructor(e){super(e),this._vaoCache=null,this._bufferWriter=null,this._useMetalWorkaround=!1,this._hasOccludees=!1}destroy(){this.uninitializeRenderContext()}initializeRenderContext(e){this._useMetalWorkaround=e.renderContext.rctx.isAssumedMetalDriver,this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(ia(this._bufferWriter.layout))}uninitializeRenderContext(){this._useMetalWorkaround=!1,this._bufferWriter=null,this._vaoCache=null}get hasOccludees(){return this._hasOccludees}modify(e,t){this._applyUpdates(e,t),this._applyAddsAndRemoves(e),this._updateDrawCommands()}get canCompact(){for(const e of this.dataByOrigin.values())if(e.buffers.some(e=>e.holes.length>1))return!0;return!1}compact(e){if(!this.canCompact)return!1;let t=!1;for(const i of this.dataByOrigin.values()){const s=new Array;for(let t=0;t<i.buffers.length&&!e.done;){const r=i.buffers[t];r.holes.length<=1?++t:(r.instances.forEach(({geometry:e})=>s.push(e)),this._vaoCache.deleteVao(r.vao),i.buffers[t]=i.buffers[i.buffers.length-1],--i.buffers.length,e.madeProgress())}if(s.length>0){for(i.buffers.forEach(e=>this._applyAdds(e,s));s.length>0;)i.buffers.push(this._applyAndRebuild(new jw,s,null));t=!0}}return t}updateHighlights(e){this.highlightOrderMap=e,this.dataByOrigin.forEach(t=>t.buffers.forEach(t=>t.updateHighlights(e)))}_applyUpdates(e,t){const i=this._bufferWriter;if(null==i)return void e.clearUpdates();const s=i.layout.stride/4;for(const r of e.updates){if(t.done)return;const{renderGeometry:n,updateType:a}=r;u(e.pending.updates,r),t.madeProgress();const o=this.dataByOrigin.get(n.localOrigin.id),l=o?.findBuffer(n.id);if(null==l)return;const h=l.instances.get(n.id);if(6&a){const e=ex(i.elementCount(h.geometry.geometry.attributes)*s),t=i.layout.createView(e.buffer);this._writeGeometry(n,t,0),l.vao.buffer()?.setSubData(e,h.from*s,0,h.numElements*s)}25&a&&(l.drawCommandsDirty=!0)}}_computeDeltas(e,t){const i=new Rd;for(const t of e){const e=t.localOrigin;if(null==e)continue;let s=i.get(e.id,null);null==s&&(s=new Bw(e.vec3),i.set(e.id,null,s)),s.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const s=this.dataByOrigin.get(t.id),r=s?.findBuffer(e.id);if(null==r)continue;let n=i.get(t.id,r);null==n&&(n=new Bw(t.vec3),i.set(t.id,r,n)),n.changes.push(e)}return i}_applyAddsAndRemoves(e){const{_bufferWriter:t,dataByOrigin:i,_vaoCache:s}=this;if(null==t||null==s)return void e.clearAddsAndRemoves();const r=t.layout.stride/4,n=this._computeDeltas(e.adds,e.removes);n.forEach((e,a)=>{const o=e.get(null),l=o?.changes??[];n.delete(a,null);let h=i.get(a);if(e.forEach((e,o)=>{if(n.delete(a,o),null==o&&Kh(!1,"No VAO for removed geometries"),o.instances.size===e.changes.length)return s.deleteVao(o.vao),u(h.buffers,o),void(0===h.buffers.length&&0===l.length&&i.delete(a));const c=o.numElements,d=o.vao.getByteLength("geometry")/4,p=l.reduce((e,i)=>e+t.elementCount(i.geometry.attributes),0),m=e.changes.reduce((e,i)=>e+t.elementCount(i.geometry.attributes),0),g=Math.min((c+p-m)*r,Xw),_=g>d;g>Qw&&g<d/2?(e.changes.forEach(({id:e})=>o.deleteInstance(e)),o.instances.forEach(({geometry:e})=>l.push(e)),this._vaoCache.deleteVao(o.vao),u(h.buffers,o)):_?this._applyAndRebuild(o,l,e):this._applyRemoves(o,e)}),l.length>0)for(null==h&&(h=new qw(o.origin),i.set(a,h)),h.buffers.forEach(e=>this._applyAdds(e,l));l.length>0;)h.buffers.push(this._applyAndRebuild(new jw,l,null))}),e.clearAddsAndRemoves()}_updateDrawCommands(){this._hasOccludees=!1,this.dataByOrigin.forEach(e=>{e.buffers.forEach(e=>{e.updateIfDrawCommandsDirty(this.highlightOrderMap,this._bufferWriter.layout.stride),this._hasOccludees||=e.hasOccludees})})}_applyAndRebuild(e,t,i){if(i)for(const t of i.changes)e.deleteInstance(t.id);const s=this._bufferWriter,r=s.layout.stride,n=r/4,a=Math.floor(Xw/n);let o=e.numElements;for(;t.length>0;){const i=t.pop(),r=s.elementCount(i.geometry.attributes);if(o+r>a&&o>0){t.push(i);break}o+=r;const n=new Vw(i,0,0,this.highlightOrderMap);Kh(null==e.instances.get(i.id)),e.addInstance(i.id,n)}const l=o*n,h=ex(l),c=s.layout.createView(h.buffer);let d=0;e.resetInstanceSummary(),e.instances.forEach((t,i)=>{this._writeGeometry(t.geometry,c,d);const r=d;d+=s.elementCount(t.geometry.geometry.attributes),e.updateInstance(i,r,d),e.updateDrawState(t)}),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(tx(l)),e.vao.buffer()?.setSubData(h,0,0,d*n),e.holes.clear();const u=e.holes.pushNew();return u.from=d,u.to=Math.floor(e.vao.getByteLength("geometry")/r),e.updateDrawCommands(this.highlightOrderMap,r),e}_applyRemoves(e,t){if(0===t.changes.length||null==this._bufferWriter)return;let i=1/0,s=-1/0;for(const r of t.changes){const t=r.id,n=e.instances.get(t);if(!n)continue;e.deleteInstance(t),this._useMetalWorkaround&&(i=Math.min(i,n.from),s=Math.max(s,n.to));const a=$w.back();if(a){if(a.to===n.from){a.to=n.to;continue}if(a.from===n.to){a.from=n.from;continue}}const o=$w.pushNew();o.from=n.from,o.to=n.to}kw($w);const r=this._bufferWriter.layout.stride/4,n=e.vao.buffer();if(this._useMetalWorkaround){const t=(s-i)*r,a=ex(t),o=this._bufferWriter.layout.createView(a.buffer);a.fill(0,0,t),e.instances.forEach(e=>{if(!(e.from>=i&&e.to<=s))return;const t=e.from-i;this._writeGeometry(e.geometry,o,t)}),n?.setSubData(a,i*r,0,t)}else{const e=$w.reduce((e,t)=>Math.max(e,t.numElements),0)*r,t=ex(e);t.fill(0,0,e),$w.forAll(e=>n?.setSubData(t,e.from*r,0,e.numElements*r))}e.holes.pushArray($w.data,$w.length),$w.forAll((e,t)=>$w.data[t]=null),$w.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null==this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const i=this._bufferWriter,s=i.layout.stride/4,r=e.numElements,n=t.reduce((e,t)=>e+i.elementCount(t.geometry.attributes),0),a=Math.min((r+n)*s,Xw),o=4*a;if(e.vao.getByteLength("geometry")<tx(Xw-Qw)&&o>e.vao.getByteLength("geometry"))return void this._applyAndRebuild(e,t,null);kw(e.holes);const l=new Array;let h=1/0,c=-1/0;for(const s of t){const t=i.elementCount(s.geometry.attributes),r=Nw(e.holes,t);l.push(r),this._useMetalWorkaround&&null!=r&&(h=Math.min(r,h),c=Math.max(r+t,c))}const d=e.vao.buffer();let u=0,m=0,g=0;const _=this._useMetalWorkaround?ex((c-h)*s):ex(a),f=i.layout.createView(_.buffer);if(t.forEach((t,r)=>{const n=l[r];if(null==n)return;const a=i.elementCount(t.geometry.attributes);if(!this._useMetalWorkaround){if(g!==n){const e=g-m;e>0&&d?.setSubData(_,m*s,0,e*s),m=n,u=0}this._writeGeometry(t,f,u),u+=a,g=n+a}const o=new Vw(t,n,n+a,this.highlightOrderMap);Kh(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0}),this._useMetalWorkaround){const t=(c-h)*s;_.fill(0,0,t),e.instances.forEach(e=>{if(!(e.from>=h&&e.to<=c))return;const t=e.from-h;this._writeGeometry(e.geometry,f,t)}),m=h,g=c}const y=g-m;y>0&&d?.setSubData(_,m*s,0,y*s),p(t,(e,t)=>null==l[t])}_writeGeometry(e,t,i){null!=this._bufferWriter&&(As(Gw,e.transformation),Gw[12]-=e.localOrigin.vec3[0],Gw[13]-=e.localOrigin.vec3[1],Gw[14]-=e.localOrigin.vec3[2],Es(Ww,Gw),Ds(Ww,Ww),this._bufferWriter.write(Gw,Ww,e.geometry.attributes,e.geometry.olidColor,t,i))}static prune(){Jw=new Float32Array(Qw)}};e([Ce({constructOnly:!0})],Uw.prototype,"dataByOrigin",void 0),e([Ce({constructOnly:!0})],Uw.prototype,"material",void 0),e([Ce()],Uw.prototype,"highlightOrderMap",void 0),Uw=e([Se("esri.views.3d.webgl-engine.materials.renderers.MergedBuffer")],Uw);class Bw{constructor(e){this.origin=e,this.changes=new Array}}function Nw(e,t){const i=e.find(e=>e.numElements>=t);if(null==i)return null;const s=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),s}const Gw=Fs(),Ww=Fs(),$w=new Xl({allocator:e=>e||new Lw,deallocator:null}),Qw=65536,Zw=4*Qw,Yw=1024,Kw=16777216,Xw=Kw/4;let Jw=new Float32Array(Qw);function ex(e){return Jw.length<e&&(Jw=new Float32Array(e)),Jw}function tx(e){const t=4*e;return t<=Yw?Yw:t<Zw?Oi(t):Math.max(Math.min(Math.ceil(1.5*t/Zw)*Zw,Kw),t)}class ix extends Od{constructor(e=ke()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}}let sx=class extends Oe{constructor(e){super(e),this._glMaterials=null,this._drawParameters=new ix,this._highlightNames=new Set,this._produces=new Map}initialize(){this._updateProduces()}destroy(){this.uninitializeRenderContext()}get _hasHighlights(){return this._highlightNames.size>0}hasHighlight(e){return this._highlightNames.has(e)}get produces(){return this._produces}_updateProduces(){this.material.produces.forEach((e,t)=>{this._produces.set(t,t=>!(0===this.dataByOrigin.size||!(8!==t&&5!==t||this._hasHighlights))&&e(t))})}initializeRenderContext(e){this._glMaterials=new fh(this.material,e.materials)}uninitializeRenderContext(){this._glMaterials=M(this._glMaterials)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:i}=e,s=this.material.produces.get(i.slot);if(!s?.(t))return null;const{highlight:r,slot:n}=i,a=5===t,o=8===t,l=o||a,h=r?.name;if(l&&(0===this._highlightNames.size||o&&h&&!this._highlightNames.has(h)))return null;const c=e=>o&&!!h&&!e.has(h),d=6===t,u=!(l||d);for(const{buffers:s}of this.dataByOrigin.values())for(const r of s){if(c(r.highlightNames))continue;const s=a?r.drawCommandsHighlights.get(Lh):l?h?r.drawCommandsHighlights.get(h):r.drawCommandsHighlights.size>0:((d&&r.needsMultipleCommands?r.drawCommandsShadowHighlightRest:r.drawCommandsDefault)||null)?.length??!1,o=u&&r.drawCommandsOccludees||null;if(s||o?.length){const s=this._glMaterials.load(e.rctx,n,t),r=s?.beginSlot(i);if(r)return r}}return null}render(e,t){const{output:i,bind:s}=e,{slot:r,highlight:n}=s,a=8===i,o=n?.name??"";if(a&&!n)return;const l=5===i,h=a||l,c=6===i,d=!(h||c),u=10===r||11===r?r:null,{rctx:p}=e;p.runAppleAmdDriverHelper();const m=p.bindTechnique(t,s,this.material.parameters);for(const e of this.dataByOrigin.values())for(const i of e.buffers){if(a&&(!i.hasHighlights||!i.drawCommandsHighlights.has(o)))continue;if(l&&(!i.hasHighlights||!i.drawCommandsHighlights.has(Lh)))continue;const r=h&&!l?i.drawCommandsHighlights.get(o)??null:null,n=l?i.drawCommandsHighlights.get(Lh):h?r:c&&i.needsMultipleCommands?i.drawCommandsShadowHighlightRest:i.drawCommandsDefault,g=null!=n,_=d&&i.drawCommandsOccludees||null;if(g||_?.length){if(this._drawParameters.origin=e.origin,m.bindDraw(s,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(i.vao),p.bindVAO(i.vao),g)for(const e of n)p.setPipelineState(t.getPipeline(!1,u)),p.drawArrays(t.primitiveType,e.first,e.count);if(_?.length){p.setPipelineState(t.getPipeline(!0,u));for(const e of _)p.drawArrays(t.primitiveType,e.first,e.count)}}}}updateHighlights(){const{_highlightNames:e}=this;e.clear();for(const t of this.dataByOrigin.values())for(const i of t.buffers)for(const t of i.highlightNames)e.add(t);this._updateProduces()}get test(){}};e([Ce({constructOnly:!0})],sx.prototype,"material",void 0),e([Ce({constructOnly:!0})],sx.prototype,"dataByOrigin",void 0),sx=e([Se("esri.views.3d.webgl-engine.materials.renderers.VaoRenderer")],sx);let rx=class extends ha{constructor(e){super(e),this._dataByOrigin=new Map,this._buffer=null,this._renderer=null,this.drapedPriority=0}initialize(){this._buffer=new Uw({material:this.material,dataByOrigin:this._dataByOrigin,highlightOrderMap:this.highlightOrderMap}),this._renderer=new sx({material:this.material,dataByOrigin:this._dataByOrigin})}destroy(){for(const e of this._dataByOrigin.values())e.dispose();this._dataByOrigin.clear(),this._buffer.destroy(),this._renderer.destroy()}hasHighlight(e){return this._renderer.hasHighlight(e)}initializeRenderContext(e){this._buffer.initializeRenderContext(e),this._renderer.initializeRenderContext(e)}uninitializeRenderContext(){this._buffer.uninitializeRenderContext(),this._renderer.uninitializeRenderContext()}get produces(){return this._renderer.produces}get hasOccludees(){return this._buffer.hasOccludees}get hasOnlyOccluders(){return!!(-2&this.renderOccludedFlags)}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}get renderOccludedFlags(){return this.material.renderOccludedFlags}get numGeometries(){let e=0;return this._dataByOrigin.forEach(t=>e+=t.buffers.reduce((e,t)=>e+t.instances.size,0)),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach(t=>e+=t.buffers.reduce((e,t)=>e+t.vao.cachedMemory,0)),e}forEachGeometry(e){this._dataByOrigin.forEach(t=>t.buffers.forEach(t=>t.instances.forEach(({geometry:t})=>e(t))))}modify(e,t){this._buffer.modify(e,t),this._renderer.updateHighlights()}get canCompact(){return this._buffer.canCompact}compact(e){return this._buffer.compact(e)}updateHighlights(e){this.highlightOrderMap=e,this._buffer.updateHighlights(e),this._renderer.updateHighlights()}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){return this._renderer.acquireTechniques(e)}render(e,t){return this._renderer.render(e,t)}static prune(){Uw.prune()}get test(){}};e([Ce({constructOnly:!0})],rx.prototype,"material",void 0),e([Ce()],rx.prototype,"highlightOrderMap",void 0),rx=e([Se("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],rx);let nx=class extends Oe{constructor(e){super(e),this._renderers=new Map}destroy(){this._renderers.forEach(e=>!e.destroyed&&e.destroy()),this._renderers.clear()}initialize(){this.addHandles(B(()=>this.stage.view.state.highlights,()=>this.updateHighlights()))}getMaterialRenderer(e){return this._renderers.get(e)}updateHighlights(){this._renderers.forEach(e=>e.updateHighlights(this.stage.view.state.highlightOrderMap))}commit(e,t,i){const{adds:s,removes:r,updates:n}=e;if(0===s.length&&0===r.length&&0===n.length)return!1;const a=function(e){const t=new Map,i=i=>{let s=t.get(i);return s||(s=new Ew(e),t.set(i,s)),s};return e.removes.forEach(e=>{Iw(e)&&i(e.material).removes.push(e)}),e.adds.forEach(e=>{Iw(e)&&i(e.material).adds.push(e)}),e.updates.forEach(e=>{Iw(e.renderGeometry)&&i(e.renderGeometry.material).updates.push(e)}),t}(e);a.forEach((e,s)=>{if(t.done)return;let r=this._renderers.get(s);null==r&&e.adds.length>0&&(r=new rx({material:s,highlightOrderMap:this.stage.view.state.highlightOrderMap}),r.initializeRenderContext(i),this.rendererAdded(r),this._renderers.set(s,r)),r?(r.modify(e,t),r.updateHighlights(this.stage.view.state.highlightOrderMap),0===r.numGeometries&&(this._renderers.delete(r.material),this.rendererRemoved(r),r.destroy())):(e.clear(),t.madeProgress())});let o=0;for(const e of this._renderers.values())e.drapedPriority=o++;return!0}get canCompact(){for(const e of this._renderers.values())if(e.canCompact)return!0;return!1}compact(e){let t=!1;for(const i of this._renderers.values()){if(e.done)return t;t=i.compact(e)||t}return t}get renderers(){return this._renderers}};e([Ce({constructOnly:!0})],nx.prototype,"stage",void 0),nx=e([Se("esri.views.3d.webgl-engine.lib.RendererBase")],nx);let ax=class extends nx{constructor(e){super(e),this._pending=new ox,this._changes=new Dw,this._sortedRenderers=new Xl,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this.destroyed||(this._changes.prune(),this._sortedRenderers.prune(),this._geometries.clear(),this._pending.clear())}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}hasHighlight(e){return Sd(this.renderers,t=>t.hasHighlight(e))}get hasWater(){return this._hasWater}get hasOccluders(){return this.renderers&&Sd(this.renderers,e=>e.hasOnlyOccluders)}get hasOnlyOccluders(){return Pd(this.renderers,e=>e.hasOnlyOccluders)}get isEmpty(){return!this.updating&&0===this.renderers.size&&0===this._geometries.size}get sortedRenderers(){return this._sortedRenderers}commitChanges(){return!!this.updating&&(this._processAddsRemoves(),this.commit(this._changes,Hn,this.rendererContext.pluginContext)&&(this._updateSortedMaterialRenderers(),this._hasHighlights=Sd(this.renderers,e=>{const t=e.produces.get(18);return!!t&&t(8)}),this._hasWater=Sd(this.renderers,e=>{const t=e.produces.get(19);return!!t&&t(3)})),this.notifyChange("updating"),!0)}rendererAdded(){this._sortedRenderers.clear()}rendererRemoved(){this._sortedRenderers.clear()}addGeometries(e,t){if(0===e.length)return;const i=this._validateRenderGeometries(e);for(const e of i)this._geometries.set(e.id,e);const s=this._pending.empty;for(const e of i)this._pending.adds.add(e);switch(s&&this.notifyChange("updating"),t){case 0:this._notifyGraphicVisibilityChanged(e);break;case 1:this._notifyGraphicGeometryChanged(e)}}removeGeometries(e,t){if(this.destroyed)return;const i=this._pending.empty,s=this._pending.adds;for(const t of e)s.has(t)?(this._pending.removed.add(t),s.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t),this._geometries.delete(t.id);i&&!this._pending.empty&&this.notifyChange("updating"),1===t&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const i=0===this._changes.updates.length;for(const i of e){const e=new Aw;this._changes.updates.push(e),e.renderGeometry=this._ensureValidRenderGeometry(i),e.updateType=t}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case 4:case 2:return this._notifyGraphicGeometryChanged(e);case 1:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedRenderers.forAll(i=>t=!!i.updateAnimation&&i.updateAnimation(e)||t),t}precompile(e){return this._sortedRenderers.reduce((t,i)=>i.precompile(e)||t,!1)}render(e){this._sortedRenderers.forAll(t=>{const i=t.acquireTechniques(e);i&&t.render(e,i)})}intersect(e,t,i,s,r){for(const n of this._geometries.values()){if(!s(n))continue;this._intersectRenderGeometry(n,i,t,0,e,r);const a=this.rendererContext.longitudeCyclical;a&&(n.boundingSphere[0]-n.boundingSphere[3]<a.min&&this._intersectRenderGeometry(n,i,t,a.range,e,r),n.boundingSphere[0]+n.boundingSphere[3]>a.max&&this._intersectRenderGeometry(n,i,t,-a.range,e,r)),r++}return r}_updateSortedMaterialRenderers(){if(!(this._sortedRenderers.length>0)){for(const e of this.renderers.values())this._sortedRenderers.push(e);this._sortedRenderers.sort((e,t)=>t.material?.renderPriority===e.material?.renderPriority?e.drapedPriority-t.drapedPriority:(t.material?.renderPriority||0)-(e.material?.renderPriority||0))}}_processAddsRemoves(){this._changes.adds.length=0,this._changes.removes.length=0,m(this._changes.adds,Array.from(this._pending.adds)),m(this._changes.removes,Array.from(this._pending.removes)),p(this._changes.updates,({renderGeometry:e})=>!this._pending.has(e)),this._pending.clear()}_intersectRenderGeometry(e,t,i,s,r,n){if(!e.visible||!e.material.visible||!e.material.intersectDraped)return;let a=0;s+=e.transformation[12],a=e.transformation[13],lx[0]=i[0]-s,lx[1]=i[1]-a,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,r,lx,(i,s,a)=>{!function(e,t,i,s,r,n,a){const o=new Md(n,a,t),l=t=>{t.set(3,o,e.distance,e.normal,e.transformation,i,s)};if((null==r.results.min.drapedLayerOrder||i>=r.results.min.drapedLayerOrder)&&(null==r.results.min.distance||r.results.ground.distance<=r.results.min.distance)&&l(r.results.min),0!==r.options.store&&(null==r.results.max.drapedLayerOrder||i<r.results.max.drapedLayerOrder)&&(null==r.results.max.distance||r.results.ground.distance>r.results.max.distance)&&l(r.results.max),2===r.options.store){const e=new Bh(r.ray);l(e),r.results.all.push(e)}}(t,a,n,e.material.renderPriority,r,e.layerViewUid,e.graphicUid)},t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const{graphicUid:i}of e)null!=i&&i!==t&&(this.drapeSource.notifyGraphicGeometryChanged(i),t=i)}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const{graphicUid:i}of e)null!=i&&i!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(i),t=i)}_validateRenderGeometries(e){for(const t of e)this._ensureValidRenderGeometry(t);return e}_ensureValidRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin(Qa(e.boundingSphere))),e}get test(){}};e([Ce({constructOnly:!0})],ax.prototype,"drapeSource",void 0),e([Ce({constructOnly:!0})],ax.prototype,"rendererContext",void 0),e([Ce()],ax.prototype,"updating",null),e([Ce()],ax.prototype,"rctx",null),e([Ce()],ax.prototype,"_localOriginFactory",null),e([Ce({readOnly:!0})],ax.prototype,"isEmpty",null),e([Ce()],ax.prototype,"_geometries",void 0),ax=e([Se("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],ax);class ox{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const lx=Gs();function hx(){const e=globalThis.require?.modules;if(e){const t=Object.keys(e);for(const i of t)i.includes(".glsl")&&delete e[i]}}class cx{constructor(e,t){this.screen=e,this.olid=t}}const dx=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let ux,px=class extends Oe{constructor(e){super(e),this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._latestOriginId=0}initialize(){const e=this.view;this.renderer=new ca({parent:this}),e.stage.renderer.plugins.add(this.renderer);const t=()=>this.requestRender();this._groundIntersector=new Ao(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([B(()=>this.renderer.hasHighlights,t),this.renderer.events.on("has-water",()=>e.stage?.renderer.updateHasFlags()),this.renderer.events.on("content-changed",t),B(()=>e.state.camera.pixelRatio,t),B(()=>e.state.alignPixelEnabled,t),this.renderer.events.on("textures-disposed",()=>this.surface.requestRender()),B(()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location],()=>this.setPlacementDirty()),B(()=>[e.state?.pixelRatio,e.state?.contentPixelRatio],()=>this.setPlacementDirty(),W),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(kn.OVERLAY,this)]),e.stage.renderer.overlay=this}destroy(){this.view?.stage&&(this.view.stage.renderer.plugins.remove(this.renderer),this.view.stage.renderer.overlay=null,S(this.renderer)),ux&&(ux.hide(),ux=null),this.renderer=null}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.renderer.longitudeCyclical=null;const t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this.renderer.longitudeCyclical=e.isWebMercator?new Fo(-20037508.342787,20037508.342787):new Fo(-180,180))):this.renderer.disposeOverlays()}get readyToRun(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||Jl.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get worldToPCSRatio(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?ge(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return 1.3/this.view.resolutionScale}get _longitudeCyclical(){return this.renderer.longitudeCyclical}get suspended(){return this.surface.suspended}get updating(){return this.readyToRun||!!this.renderer?.updating||this._contentUpdated}render(){return this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.precompileShaders(this.view.state)?this._drawOverlays():null}get hasOverlays(){return this.renderer.hasOverlays}registerDrapeSource(e,t){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this.renderer.registerDrapeSource(e,t),this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("readyToRun")}registerGeometryDrapeSource(e){const t=new ax({stage:this.view.stage,drapeSource:e,rendererContext:this.renderer});return this.registerDrapeSource(e,t),t}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("readyToRun"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.requestRender()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this.updateOverlays(e,this.view.state.contentCamera,1)}updateOverlays(e,t,i){if(!this._spatialReference)return Vn;const s=this._computeOverlayHeight(t);this._computeOverlayExtents(t,s,_x),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,_x.stretch);const r=this._updateOverlay(0,_x.inner,s,1*_x.pixelRatioAdjustment,_x.mapUnitsPerPixel),n=ut(_x.inner)/ut(_x.outer),a=this._updateOverlay(1,_x.outer,s,n*_x.pixelRatioAdjustment,_x.mapUnitsPerPixel);1!==r&&1!==a||(this._drapeSources.forEach(e=>this._updateDrapeSourceExtent(e)),this.updateOverlayParameters(i)),0===r&&0===a||this.requestRender(),this._placementDirty=!1,e.madeProgress()}_computeOverlayHeight(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,i=e.fullWidth/e.pixelRatio*t,s=e.fullHeight/e.pixelRatio*t,r=Math.ceil(1.5*Math.max(i,s)),{maxPreferredTexturePixels:n,maxTextureSize:a}=this.view.stage.renderView.renderingContext.parameters,o=.5*a;return Lr(kr({width:r,height:r},{maxPreferredTexturePixels:2*n,maxTextureSize:o})[1],o)}_updateOverlay(e,t,i,s,r){if(0===this.renderer.overlays.length)return 0;const n=this.renderer.overlays[e],a=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=r,n.pixelRatio=s,function(e,t){const i=Jl.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=i&&Math.abs(t[1]-e[1])<=i&&Math.abs(t[2]-e[2])<=i&&Math.abs(t[3]-e[3])<=i}(t,n.extent)&&i===n.resolution)return a===r?0:2;ct(n.extent,t),n.resolution=i;const o=ft(n.extent);return n.renderLocalOrigin=xd(o[0],o[1],0,"OV_"+this._latestOriginId++),1}updateOverlayParameters(e){this.surface.allTiles.forAll(e=>this.updateTileOverlayParameters(e)),this.surface.requestRender(e)}updateTileOverlayParameters(e){if(!e.renderData)return;const t=e.renderData.overlay;if(0===this.renderer.overlays.length)this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t);else{const[i,s]=this.renderer.overlays,r=e.extent;this._rectInsideRect(i.extent,r)||this._rectanglesOverlap(r,i.extent)||this._rectanglesOverlap(r,s.extent)?(this._setTileOverlayData(r,0,t),this._setTileOverlayData(r,1,t)):(this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t))}}overlayPixelSizeInMapUnits(e,t){if(0===this.renderer.overlays.length)return t();const i=this.renderer.overlays[0],s=this.renderer.overlays[1],r=this._pointIsInExtent(e,i.extent)?i:s;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(0===this.renderer.overlays.length)return;const s=this.renderer.overlays[t].extent,r=ut(s),n=pt(s);let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(s[0],a);const t=this._longitudeCyclical.minimalMonotonic(s[0],e[2]);a>t&&(a=t-(e[2]-e[0]))}i.setScale(t,ut(e)/r,pt(e)/n),i.setOffset(t,(a-s[0])/r,(e[1]-s[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}reloadShaders(){hx(),this.requestRender(),this.runTask(Hn)}requestRender(e=1){this.renderer.hasOverlays?(1===e?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this._drawTexturesAnimateDirty=!0,this.view.stage.renderView.requestRender(e)):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,s,r){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,vx,t,i);if(null==n)return!1;const a=n.origin,o=Ki(gx,n.origin,n.direction);this._groundIntersector.reset(a,o,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,o);const l=this._groundIntersector.results.min;return l.getIntersectionPoint(r)&&l.withinDistance(s)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const s=.55,r=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,o=Ci(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:r+a,e.aboveGround?r-a:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=gx;Na(Ga(Wa,ge(this.view.spatialReference).radius+o),Ha(e.eye,e.viewForward),t),Yi(t,t,e.eye);const r=Vo.normalize(Uo(e.viewForward,t,e.viewRight))/e.fovY+.5,n=r<=0||r>=1?.5:s;i=l?n*r:r+n*(1-r)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),r=Math.tan(t),n=pl(0,r,1,0),a=nl(n,n,e.projectionMatrix)[1],o=Ci(.5+.5*a,0,1);i=1===o||0===o?.5:l?o*s:1-(1-o)*s}return this._intersectGroundFromView(e,.5,i,n.distance,t)}_computeOverlayExtents(e,t,i){const s=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,r=ke();this._findHorizonBasedPointOfInterest(e,r)||Zi(r,s),Jl.OVERLAY_SHOW_CENTER?(null==ux&&(ux=new qb(this.view.graphics,"red")),ux.show(r,this._renderSR)):null!=ux&&ux.hide();const n=Math.max(.1,Xi(e.eye,r)),a=ri(this.view.renderCoordsHelper,s,e.eye);this._overlaySREqualsRenderSR||sd(r,this._renderSR,r,this._spatialReference);const o=this.surface.extent,l=!this._isSpherical&&this._spatialReference?.isGeographic,h=l&&this._spatialReference?1/ge(this._spatialReference).metersPerDegree:1,c=this.view.state.contentPixelRatio,d=e.perScreenPixelRatio/c*n*h;i.mapUnitsPerPixel=d/this.worldToPCSRatio,i.stretch=this._overlayStretch;let u=t*d/2*i.stretch,p=!1,m=l?90:1/0;this._isSpherical&&o&&this._spatialReference&&(this._spatialReference.isWebMercator?(u/=Math.cos(wd(r[1])),m=o[3]):(p=!0,u/=ge(this._spatialReference).metersPerDegree,m=90),u>=m&&(u=m,r[1]=0,this._spatialReference.isWebMercator&&(r[0]=0)));let g=1;p&&(g=1/Math.max(.2,Math.cos(Math.abs(Ti(r[1])))),u*g>180&&(g=180/u),i.mapUnitsPerPixel*=g);const _=Math.log(2)/12;u=Math.exp(Math.round(Math.log(u)/_)*_);const f=u*g,y=.5*t/(32*f),v=.5*t/(32*u);r[0]=Math.round(r[0]*y)/y,r[1]=Math.round(r[1]*v)/v;const b=i.inner;b[0]=r[0]-f,b[1]=r[1]-u,b[2]=r[0]+f,b[3]=r[1]+u,this._isSpherical&&this._shiftExtentToFitBounds(b,1/0,m);const w=i.outer;if(6*f>ut(o))ct(w,o);else if(Math.PI/2-Math.abs(a-Math.PI/2)<=.25*Math.PI)w[0]=b[0]-f,w[1]=b[1]-u,w[2]=b[2]+f,w[3]=b[3]+u;else{sd(e.eye,this._renderSR,gx,this._spatialReference),Ns(mx,r,gx);let t=-Math.atan2(mx[1],mx[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));al(mx,dx[i],2*u),mx[0]*=g,mx[2]*=g,ol(w,b,mx)}if(this._isSpherical)w[0]=this._longitudeCyclical.clamp(w[0]),w[2]=this._longitudeCyclical.clamp(w[2]),w[1]=Math.max(w[1],-m),w[3]=Math.min(w[3],m);else{const e=wt(b,o,fx),t=wt(w,o,yx);xt(e,t)&&(w[2]=w[0],w[3]=w[1])}const x=Math.abs(b[2]-b[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,x),i.pixelRatioAdjustment=i.mapUnitsPerPixel/x}_drawOverlays(e=this.view.state){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const t=!this._drawTexturesDirty&&this._drawTexturesAnimateDirty?0:1;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const i=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(t),this.renderer.drawOverlays(e,t),i!==this.renderer.computeValidity()&&this.updateOverlayParameters(1),this.surface.requestRender(t),1===t&&this.surface.requestUpdate(),this.renderer}_rectanglesOverlap(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):ot(e,t))}_rectInsideRect(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:xt(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,s=e.y;return i>t[0]&&i<t[2]&&s>t[1]&&s<t[3]}_shiftExtentToFitBounds(e,t,i){let s=0,r=0;e[0]<-t?s=e[0]+t:e[2]>t&&(s=t-e[2]),e[1]<-i?r=e[1]+i:e[3]>i&&(r=i-e[3]),dt(e,s,r)}get test(){}};e([Ce()],px.prototype,"_spatialReference",void 0),e([Ce({readOnly:!0})],px.prototype,"readyToRun",null),e([Ce()],px.prototype,"_placementDirty",void 0),e([Ce()],px.prototype,"_contentUpdated",void 0),e([Ce()],px.prototype,"_isSpherical",null),e([Ce()],px.prototype,"worldToPCSRatio",null),e([Ce()],px.prototype,"renderer",void 0),e([Ce({constructOnly:!0})],px.prototype,"view",void 0),e([Ce({constructOnly:!0})],px.prototype,"surface",void 0),e([Ce()],px.prototype,"suspended",null),e([Ce()],px.prototype,"updating",null),px=e([Se("esri.views.3d.terrain.OverlayManager")],px);const mx=ul(),gx=ke(),_x=new class{constructor(){this.inner=lt(),this.outer=lt(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=1.3}},fx=lt(),yx=lt(),vx=qa();class bx{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}}class wx{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=hh(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=O(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,hh(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,i,s){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,s),t),Ki(t,t,i)}getEdgeNormal(e,t,i){const{typedBuffer:s,typedBufferStride:r}=this.vertexAttributes.normalCompressed;iu(t,s,this.getEdgeAttributeIndex(e,i),r)}setEdgeNormalFromValues(e,t,i,s,r){this._setNormal(this.getEdgeAttributeIndex(e,t),i,s,r)}setEdgeVertexFromValuesRawPositionUV(e,t,i,s,r,n,a){const o=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(o,i,s,r),this._setUV(o,n,a)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,i,s,r,n,a,o,l,h){const c=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(c,i,s,r),this._setUV(c,n,a),this._setNormal(c,o,l,h)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,i,s){const{typedBuffer:r,typedBufferStride:n}=this.vertexAttributes.normalCompressed;su(r,e,t,i,s,n)}_setUV(e,t,i){this.vertexAttributes.uv0.setValues(e,Math.round(t*g),Math.round(i*g))}getEdgeAttributeIndex(e,t){return ac(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}}class xx{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=S(this._current),this._next=S(this._next),this._waiting=S(this._waiting),this._delayed=S(this._delayed)}get current(){if(null==this._current)return null;if(!this._isFadingEnabled){let e=null;this._delayed?(e=this._delayed,this._delayed=null):this._waiting?(e=this._waiting,this._waiting=null):this._next&&(e=this._next,this._next=null),e&&(this.clear(),this._current=e)}let e=xx.test.fadeMoment;if(this._delayed&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null)),this._next){e=e||performance.now();const t=this._fadeDuration,i=null!=this._current&&this._next.texture===this._current.texture,s=0!==this._next.type,r=e-this._fadeStart>=t;(i||s||r)&&(S(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(null==this._next)return 1;const e=xx.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return null!=this._next||null!=this._delayed}push(e,t=0){this._delayed=S(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),null==this._current)return void(this._current=e);const i=xx.test.fadeMoment||performance.now();return 0!==t?(this._delayed=e,void(this._delayedTime=i+t)):null==this._next?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(null!=e&&(S(this._waiting),this._waiting=e))}get _fadeDuration(){const e=this._getFadeDuration();return this._waiting?.5*e:e}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}static{this.test={fadeMoment:0}}}class Cx{constructor(e,t,i,s,r,n){this.texture=e,this.type=t,this.offsetAndScale=i,e.retain(),this.opacities=Ve(s,r,n)}destroy(){this.texture.release()}}class Tx{constructor(){this._scales=pl(-1,-1,-1,-1),this._offsets=pl(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}class Sx{constructor(){this._queue=new Xl,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.leaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),null!=e&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){const e=this._last?.children;return e?.[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}}class Px{constructor(){this._q=new Xl}get done(){return 0===this._q.length}reset(e){if(this._q.clear(),null!=e){this._q.pushArray(e);for(let e=0;e<this._q.length;++e){const t=this._q.data[e];t.leaf||this._q.pushArray(t.children)}}}next(){return this._q.pop()}}function Mx(e,t){if(null==t||t.destroyed)return!1;const i=oc(s=t)?{fullExtent:s.fullExtent,minScale:s.layer.minScale,maxScale:s.layer.maxScale}:s.layer;var s;if(null==i?.fullExtent)return!1;const r=i.fullExtent,n=e.extent;if(r.xmin>n[2]||r.ymin>n[3]||r.xmax<n[0]||r.ymax<n[1])return!1;const a=e.surface.tilingScheme.levels[e.level].scale,o=i.minScale;if(o>0&&a>1.00000001*o)return!1;const l=i.maxScale;return!(l>0&&a<.99999999*l)}function Rx(e,t){const i=e.lij,s=t.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function Ox(e,t=null){null==t||0===t.length?e.sort(Dx):e.sort((e,i)=>function(e,t,i){return Ex(e,i)===Ex(t,i)?Ax(e,t):e?1:-1}(e,i,t))}function Dx(e,t){const i=e.screenDepth-t.screenDepth;if(0!==i)return i;const s=e.lij,r=t.lij;return s[0]-r[0]||s[1]-r[1]||s[2]-r[2]}function Ax(e,t){const i=e.screenDepth,s=t.screenDepth;return i<s?-1:i>s?1:Rx(e,t)}function Ex(e,t){for(const i of t)if(e.intersectsExtent(i))return!0;return!1}function Ix(e,t){const i=e.distanceToPOI-t.distanceToPOI;if(0!==i)return i;const s=e.lij,r=t.lij;return s[0]-r[0]||s[1]-r[1]||s[2]-r[2]}function Lx(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],s=i?e:t,r=i?t:e,n=1<<r[0]-s[0];return Math.floor(r[1]/n)===s[1]&&Math.floor(r[2]/n)===s[2]}class kx{constructor(){this.geometry=new wx,this.geometryState=null,this._texture=null,this._textureOpacity=1,this._textureRef=new xx(()=>this._tile.surface.fadeDuration),this.overlay=new Tx,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new bx,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),dc&&this.tile.intersectsClippingArea)for(let e=0;e<4;++e)ac(this.geometry.getEdgeCount(e)===this.geometryState.edgeResolutions[e]+1)}_calculateEdgeResolution(e,t){const i=this.tile,s=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const t=i.surface.extent;if(null!=t&&(0===e&&i.extent[3]>t[3]||1===e&&i.extent[2]>t[2]||2===e&&i.extent[1]<t[1]||3===e&&i.extent[0]<t[0]))return s}const r=i.level,n=lc[e];if(!t)return ac(null==i.surface?.rootTiles||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(n)),s;if(t.loaded){const i=t,n=i.renderData.geometryState,a=r-i.level;if(ac(a>=0),0===a){const e=n.numVerticesPerSide-1;return Math.max(e,s)}const o=2**a,l=n.edgeResolutions[(e+2)%4]/o;return Math.max(1,l)}ac(!t.leaf);let a=s;return t.forAllSubtreeOnSide(hc(n),e=>e===i||(e.loaded?(a=Math.max(a,2**(e.level-r)),!0):(ac(!e.leaf),!1))),a}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,i=t=>(t.loaded||t.level===e.level)&&t?.intersectsClippingArea,s=t.edgePeerNeighbors,r=t.edgePeerNeighborSamplerVersions;for(let n=0;n<4;++n){const a=e.findNeighborTile(lc[n],i),o=Nx(e,a),l=o?.renderData?.geometryState.samplerDataVersion??-1,h=s[n],c=o!==Nx(e,h),d=r[n]!==l;dc&&a&&(ac(e.level>=a.level),ac(e.level-a.level<=md)),s[n]=a,(c||d)&&(r[n]=l,this._markEdgeDirty(n));const u=t.edgeResolutions[n],p=this._calculateEdgeResolution(n,a);ac(Di(p)),ac(p>=1),t.edgeResolutions[n]=p,u!==p&&this._markEdgeResolutionDirty(n)}for(let r=0;r<4;++r){const n=e.findNeighborTile(cc[r],i);t.cornerPeerNeighbors[r]=n;const a=Nx(e,s[r]),o=Nx(e,s[(r+1)%4]),l=Nx(e,n);Bx[r]=l,Bx[(r+1)%4]=o,Bx[(r+2)%4]=e,Bx[(r+3)%4]=a,ac(Bx.some(t=>t?.loaded||t===e));const h=Bx.reduce((e,t)=>Math.min(e,t?.level??1/0),1/0);Bx.forEach((e,t)=>{e&&e?.level>h&&(Bx[t]=null)}),ac(Bx.some(t=>t?.loaded||t===e));const c=t.cornerNeighborCornerTiles,d=t.cornerNeighborCornerTileSamplerVersions;for(let e=0;e<4;++e){const t=Bx[e],i=t?.renderData.geometryState.samplerDataVersion??-1,s=4*r+e,n=c[s]!==t,a=!n&&d[s]!==i;(n||a)&&(c[s]=t,d[s]=i,this._markCornerDirty(r))}dc&&ac(Xx.some(t=>c[4*r+t]?.loaded||c[4*r+t]===e))}dc&&ac(this.geometryState.edgeResolutions.every(e=>e>0));for(let e=0;e<4;++e)Bx[e]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;dc&&ac(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every(e=>e>0)),this.intersectionData=null;const{tile:t,_vao:i,geometry:s,geometryState:r}=this,n=!i||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,a=0!==this.dirtyEdgeResolutions,o=r.edgeResolutions.reduce((e,t)=>e+t+1,0),l=n||a&&o>(s?.maxEdgeVertexCount??0),h=!l&&a,c=!h&&(0!==this.dirtyEdges||a),d=!c&&0!==this.dirtyCorners;l?(this.releaseGeometry(),this._createGeometry(e)):h?t.updateEdgeElevationsAndResolutions():c||d?t.updateEdgeElevations():d?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=M(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,i,s){const r=t?6408:6407;return null!=this._texture&&(0===i&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==e||this._texture.descriptor.pixelFormat!==r)&&this.releaseTexture(),null==this._texture&&(this._texture=s(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture&&(this._texture=O(this._texture),this.tile.setMemoryDirty())}reuseTexture(e,t){return!(!e||!this._texture||(e.setTextureReference(new Cx(this._texture,0,t,this._textureOpacity,0,1)),0))}get numVerticesPerSideChanged(){return 0!==(this._modifiedFlags&Gx)}get samplerDataChanged(){return 0!==(this._modifiedFlags&Wx)}get clippingAreaChanged(){return 0!==(this._modifiedFlags&$x)}get wireframeChanged(){return 0!==(this._modifiedFlags&Qx)}get dirtyEdges(){return this._modifiedFlags>>Zx&15}get dirtyCorners(){return this._modifiedFlags>>Yx&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>Kx&15}_markCornerDirty(e){const t=1<<e<<Yx;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<Zx;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<Kx;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<Yx|15<<Zx|15<<Kx}updateGeometryState(){const e=this._elevationInfo,t=this.tile,i=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.minimumVerticesPerSide,s=Math.max(i,5);let r=t.clippingArea;t.intersectsClippingArea&&!t.withinClippingArea||(r=null);const n=this.geometryState;let a=!1;n.numVerticesPerSide!==s&&(this._modifiedFlags|=1,n.numVerticesPerSide=s,n.samplerDataVersion++,a=!0),e.changed&&(this._modifiedFlags|=2,n.samplerData=e.samplerData,n.samplerDataVersion++,a=!0),_(n.clippingArea,r)||(this._modifiedFlags=4,n.clippingArea=r,a=!0);const o=t.surface.wireframe;return n.wireframe!==o&&(this._modifiedFlags=8,n.wireframe=o,a=!0),this._geometryStateChangedSinceLastUpdate||=a,a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const{vertexAttributes:t,indices:i}=this.geometry,s=e.gl;this._vao=new ra(e,new oa(e,ia(t.layout),t.buffer),ru.createIndex(e,s.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=0){e?.texture===this._texture?this._textureOpacity=e.opacities[0]:this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(e){return this._textureRef.current?.texture===e||this._textureRef.next?.texture===e&&this._textureRef.fadeFactor<1}get _elevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],i=t.length,s=new Array(i);let r=0,n=0,a=!1;for(let o=0;o<i;o++){const i=t[o],l=i.upsampleInfo?.tile;if(l){const t=l.layerInfo[0][o].data,i=t&&t.samplerData;e&&e[r]===i||(a=!0),s[r++]=i,n=Math.max(n,l.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(o,0);if(Mx(this.tile,t)){const t=i.data;e&&e[r]===t.samplerData||(a=!0),s[r++]=t.samplerData,n=this.tile.level}}}null!=e&&e.length!==r&&(a=!0);const o=r>0,l=o?s:null;return o&&(s.length=r),{changed:a,samplerData:l,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){const e=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!dc)return;const e=this.tile;if(!e.loaded||!e.intersectsClippingArea||0===e.level)return void ac(e?.loaded);const t=e.surface.extent;if(null!=t&&!e.intersectsExtent(t))return;const i=lc.map((i,s)=>null!=t&&(s<2?-1:1)*(e.extent[3-s]-t[3-s])<0),s=e.level;ac(0===this.dirtyCorners),ac(0===this.dirtyEdges),ac(0===this.dirtyEdgeResolutions),ac(!this.numVerticesPerSideChanged),ac(!this.samplerDataChanged),ac(!this.clippingAreaChanged),ac(!this.wireframeChanged);const r=cc.map(t=>e.findNeighborCornerTileExact(t,t=>!t.intersectsClippingArea||t.loaded||t.level===e.level)??null).map(e=>e?.intersectsClippingArea?e:null),n=this.geometryState;for(let t=0;t<4;++t){const i=n.cornerPeerNeighbors[t],s=r[t];ac(s===i,`Tile[${e.lij}].corner[${t}] out of date: cur=[${i?.lij}] exp=[${s?.lij}]`)}lc.forEach((t,r)=>{if(i[r])return;const n=e.findNeighborTile(t,e=>(e.level===s||e?.loaded)&&e?.intersectsClippingArea);if(!n){const i=!e.surface.updatingRootTiles&&null!=e.surface.rootTiles&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(t);return void ac(!i)}ac(n.loaded||n.level===e.level),ac(n===this.geometryState.edgePeerNeighbors[r]);const a=s-n.level;if(!n.loaded)return ac(!n.leaf),void ac(0===a);const o=n.renderData;ac(e.isEdgeNeighbor(n,t)),ac(a>=0);const l=2**a;if(a<0)return void ac(!1);const h=e.renderData,c=h.geometry,d=h.localOrigin,u=c.getEdgeCount(r),p=c.numVerticesPerSide-1,m=o.geometry;if(!m)return void ac(!1);const g=o.localOrigin,_=this.geometryState.edgePeerNeighbors[r];if(_?.loaded){const e=_.renderData;ac(h.geometryState.edgePeerNeighborSamplerVersions[r]===e.geometryState.samplerDataVersion),ac(this.geometryState.edgePeerNeighborSamplerVersions[r]===e.geometryState.samplerDataVersion)}const f=(r+2)%4,y=m.getEdgeCount(f),v=u-1,b=y-1;ac(v*l===b,`Tile[${e.lij}]:e${r},res=${v} edgeRes mismatch with Neighbor[${n.lij}]:e${f},res=${b} (expected:${v*l})`);const w=e.extent,x=0===t||4===t,C=y-1,T=C>>a,S=u-1;if(T<1)return void ac(1===S);ac(T===S),ac(Di(T));const P=m.numVerticesPerSide-1;ac(a>0||T===Math.max(P,p));const M=e.getNeighborEdgeStartVertexIndex(r,n);ac(0<=M&&M<l);const R=M*T;ac(0<=R&&R<=C-T);let O=0,D=R;c.getEdgeVertexPosition(r,Vx,d,0),c.getEdgeVertexPosition(r,Fx,d,u-1);const A=Xi(Vx,Fx),E=Math.max(Ux,1e-4*A);for(let i=0;i<=T;++i){c.getEdgeVertexPosition(r,Vx,d,O),m.getEdgeVertexPosition(f,Fx,g,D);const s=i/T,a=x?w[0]+s*(w[2]-w[0]):6===t?w[0]:w[2],l=x?4===t?w[1]:w[3]:w[1]+s*(w[3]-w[1]),p=e.surface.extent;if(null==p||Ct(p,a,l)){const t=os(Vx,Fx),i=ls(Vx)-de.radius,s=ls(Fx)-de.radius,_=t<E;if(!_){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${r}[${O}/${u}] and [${n.lij}].edge${f}[${D}/${y}]`),null!=p&&console.warn("  surface extent= ",p," x,y=",a,",",l);const v=ke();Yi(v,h.localOrigin,o.localOrigin),ls(v)>0&&console.warn(`   localOrigins: ${h.localOrigin} vs ${o.localOrigin} d=${ls(v)} [${v}]`),(()=>{const t=Fe(Vx),i=Fe(Fx);e.updateEdgeElevations(),n.updateEdgeElevations(),c.getEdgeVertexPosition(r,Vx,d,O),m.getEdgeVertexPosition(f,Fx,g,D);const s=ke();Ui(s,Vx,t),ls(s)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${t} vs ${Vx} d=${ls(s)} [${s}]`),Ui(s,Fx,i),ls(s)>0&&console.warn(`  XXX Neighbor[${n.lij}] edge out of date: ${i} vs ${Fx} d=${ls(s)} [${s}]`)})();const b=c.getEdgeCount(r),w=m.getEdgeCount(y);ac(_,`Mismatch in tile [${e.lij}].edge[${r}][${O}/${b}] vs neighbor [${n.lij}].edge[${f}][${D}/${w}] ${uc(Vx)} vs ${uc(Fx)}  dist=${t} h(t|n|d)=${i}|${s}|${s-i}`)}c.getEdgeNormal(r,jx,O),m.getEdgeNormal(f,zx,D),Ni(Hx,jx),Ni(qx,zx);const v=Gi(Hx,qx),b=1-v<.01||e===n;if(!b){const t=ke();Ui(t,jx,zx);const i=()=>`Mismatch in tile edge normal ${pc(e.lij)} (${O}/${u-1}) edge ${r} vs neighbor ${pc(n.lij)}  (${D}/${y-1}) nedge ${f} :${uc(jx)} vs ${uc(zx)}  dot = ${v} : ${uc(t)}`;console.warn("Mismatch in tile edge normal: ",i());{e.updateEdgeElevations(),n.updateEdgeElevations();const t=ke(),i=ke();c.getEdgeNormal(r,t,O),m.getEdgeNormal(f,i,D),Qi(jx,t)||console.warn("Missing update in tile normal: ",uc(jx)," => ",uc(t)),Qi(zx,i)||console.warn("Missing update in neighbor normal: ",uc(zx)," => ",uc(i))}ac(b,i())}}O+=1,D+=1}})}}const Vx=ke(),Fx=ke(),jx=ke(),zx=ke(),Hx=ke(),qx=ke(),Ux=1,Bx=[null,null,null,null];function Nx(e,t){return t?.loaded||t===e?t:null}const Gx=1,Wx=2,$x=4,Qx=8,Zx=4,Yx=8,Kx=12,Xx=[0,1,2,3];class Jx{get updating(){return!!this._tileRequested}init(e,t,i,s){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=s,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const r=this._findAncestorWithData();this._setUpsampleTile(r)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,0,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),{minLevel:s,maxLevel:r}=i.dataLevelRange,n=this._desiredMinLevelDelta,a=this._progressiveLevelModulo+n,o=this._scaleRangeEnabled?Mx:()=>!0;let l=this.tile;const h=l.level;let c;const d=this._tileLayerInfo.upsampleInfo,u=d?.tile?.level??-1,p=null!=d&&u-h>=n,m=function(e){return!oc(e)&&e.layer&&"tilemapCache"in e.layer?e.layer.tilemapCache:null}(i),g="vector-tile-3d"===i.type?i.schemaHelper:null;for(;l&&o(l,i)&&l.level>=s;){const i=l.level,o=h-i,d=l.layerInfo[t][e];if(d.data&&o>=n){(!p||i>u)&&this._setUpsampleTile(l),d.dataInvalidated&&(c=l);break}const _=g?.getLevelRowColumn(l.lij)??l.lij;if("unavailable"!==m?.getAvailability(_[0],_[1],_[2])&&i<=r&&!d.data&&!d.dataMissing&&((!c||l.level===s||i%gd===0||h-c.level<n)&&(c=l),o>=a))break;l=l.parent}if(null!=c&&h-c.level<n)if(d)c=null;else{const i=this._findAncestorWithData();null!=i&&(this._setUpsampleTile(i),c=i.layerInfo[t][e].dataInvalidated?i:null)}return c}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let i;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(e-s.level>=t)return s;i=s}return i}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,0,t)}get test(){}}const eC=new Error("Abstract method called on TileAgent"),tC=new class extends Jx{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw eC}get _progressiveLevelModulo(){throw eC}dispose(){}};class iC{constructor(){this.waitingAgents=new Xl,this.pendingUpdates=0}static acquire(e){const t=sC.acquire();return t._init(e),t}release(){this.dispose(),rC.delete(this),sC.release(this)}dispose(){this.loadingAgent=M(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=mc(this._data)}static prune(){sC.prune(0)}_init(e){this.waitingAgents.clear(),this._data=mc(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=P(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){this.upsampleInfo&&(this.upsampleInfo.tile?.unrefMapData(),this._pool.release(this.upsampleInfo),this.upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&null!=t){if(null==this.upsampleInfo)this.upsampleInfo=this._pool.acquire();else{if(this.upsampleInfo.tile===t)return;this.upsampleInfo.tile?.unrefMapData()}t.refMapData(),function(e,t,i){let s=1,r=0,n=0;for(;e!==t;)if(s*=.5,r*=.5,n*=.5,1&e.lij[2]&&(r+=.5),1&e.lij[1]||(n+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");i.init(t,r,n,s)}(e,t,this.upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){mc(this._data),this._data=e}}const sC=new td(iC,null,()=>{}),rC=new Map;class nC{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=lt(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=lt(),this.centerAtSeaLevel=ke(),this._center=[ke(),$a(),ke()],this.up=Be(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.onCompressionFinished=()=>{this.setPendingUpdate(16),this.setMemoryDirty()},this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=ke(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get spatialReference(){return this._surface.spatialReference??this._surface.tilingScheme.spatialReference}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){lC.prune(0),hC.prune(0),iC.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,t=e?.frustumVisibility??1;this._frustumVisibility=0===t?0:2===t?2:this._calculateFrustumVisibility(this.surface.frustum);const i=2!==this._frustumVisibility&&this._intersectsClippingArea;i!==this._visible&&(this._visible=i,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get _loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,i,s,r){this._lij[0]=e,this._lij[1]=t,this._lij[2]=i,this.ellipsoid=ge(r.tilingScheme.spatialReference),r.tilingScheme.getExtent(e,t,i,this.extent),r.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,r.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.elevationLevel=e,s&&!Number.isNaN(s.elevationBoundsMin)?(this._elevationBoundsMin=s.elevationBoundsMin,this._elevationBoundsMax=s.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=s,this.clearChildren(),this._surface=r,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const e of Ow){const t=r.numLayers(e),i=this.layerInfo[e];for(const e of i)e.release();i.length=t;for(let s=0;s<t;s++)i[s]=iC.acquire(this._surface.upsampleInfoPool),0===e&&this.findElevationBoundsForLayer(s,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(r.tilingScheme.pixelSize,pd)}dispose(){gc(!this.renderData,"tile.renderData was not unloaded"),this._surface?.upsampleMapCache.pop(this.key),this.layerInfo.forEach(e=>{e.forEach(e=>e.release()),e.length=0}),this._surface=this._parent=null,this.clearChildren(),this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){--this._mapDataRefCount,this._cached&&this.cachedMemory>0&&this._surface.upsampleMapCache.put(this.key,this)}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this._mapTileMemory)}get cachedMemory(){return this._ensureUsedMemory(),null==this._surface?this.usedMemory:this._cached?this._mapTileMemory:0}get _mapTileMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_ensureUsedMemory(){if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[1].reduce((e,{data:t})=>e+(_c(t)?t.usedMemoryPerReference:0),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(const{data:e}of this.layerInfo[1])_c(e)?this._vectorTileMemory+=e.usedMemoryPerReference:this._rasterTileMemory+=this.getTerrainDataMemory(e);for(const e of this.layerInfo[0])this._usedMemory+=e.data?this._cpuImageMemorySize:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=this.renderData.texture?.cachedMemory??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key,this),this._usedMemory}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];return i?.data?1===e?this._cached?0:this.getTerrainDataMemory(i.data):0===e?this._cpuImageMemorySize:0:0}getTerrainDataMemory(e){return fc(e)?e.texture.usedMemory:yc(e)?e.memoryUsage:_c(e)?e.usedMemoryPerReference:sc(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(e){const t=this._center[1],i=e,s=t[0],r=t[1],n=t[2],a=i[2]*s+i[6]*r+i[10]*n+i[14];this.screenDepth=a<0?0:a/(i[3]*s+i[7]*r+i[11]*n+i[15])}shouldSplit(e,t,i){if(!this.visible)return 0;if(e.frustum&&(!this._intersectsClippingArea||2===this._calculateFrustumVisibility(e.frustum)))return 0;const s=this.level;Yi(_C,Qa(this._center[1]),t);let r=ts(_C),n=_C,a=Qa(this._center[1]);Yi(fC,this._center[0],t);const o=ts(fC);o<r&&(r=o,n=fC,a=this._center[0]),Yi(yC,this._center[2],t);const l=ts(yC);if(l<r&&(r=l,n=yC,a=this._center[2]),this._edgeLen2>r&&s<e.maxLod)return 1;const h=Math.sqrt(r),c=e.fovX*h*2,d=this._edgeLen/c,u=()=>{if(s<e.maxLod)return this.elevationLevel=s,0;const t=s+Math.ceil(-Math.log2(e.relativeWidthLimit/d));return t!==this.elevationLevel?(this.elevationLevel=t,2):0},p=null!=i?i-s:1/0;if(p<=.5)return u();const m=Gi(this.up,_C),g=this._elevationBoundsMax-this._elevationBoundsMin,_=g/this.edgeLen;if(e.aboveGround&&m>0&&_<.001&&m/h-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-_>0)return 0;const f=null!=i?3-Math.min(p,2):1;if(d*f<e.relativeWidthLimit||s>=e.maxLod)return u();if(s<7)return 1;Bi(vC,this.up,m),Yi(vC,vC,n);const y=ts(vC);if(y<=this.radius*this.radius)return 1;Bi(vC,vC,this.radius/Math.sqrt(y)),Ki(vC,vC,a),Yi(vC,t,vC);const v=Math.min(1,(Math.abs(Gi(vC,this.up))+.5*g+this._curvatureHeight)/$i(vC)),b=.1/e.angledSplitBias,w=e.fovY*h*2;return v*(this._edgeLen/w*f)<b*e.relativeHeightLimit?0:1}createChildren(){const e=this._children,t=this.lij[0]+1,i=2*this.lij[1],s=2*this.lij[2];return e[0]=this.surface.createTile(t,i,s,this),e[1]=this.surface.createTile(t,i,s+1,this),e[2]=this.surface.createTile(t,i+1,s,this),e[3]=this.surface.createTile(t,i+1,s+1,this),e}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(const e of Ow)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(){this.renderData&&this.unrefMapData(),this.surface.renderer.unloadTile(this);for(const e of Ow){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==tC&&(oC(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(8),this.resetPendingUpdate(16),this.resetPendingUpdate(32)}unloadMapData(){const e=this.layerInfo[1];for(const t of e)t.loadingAgent&&t.loadingAgent!==tC&&(oC(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0,t.invalidateSourceData();this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(bt(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._withinClippingArea;null!=e?(this._intersectsClippingArea=this.intersectsExtent(e),this._withinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const s=i&&this._withinClippingArea,r=!(i||t||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||s||r||this.setPendingUpdate(8),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i?.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of Ow){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==tC&&e.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(1)||0!==e&&!this._loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,1===e||4===e?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const s=this.layerInfo[t][e];if(s.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e),!0;if(s.waitingAgents.push(i),s.data&&!s.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e);const r=_c(s.data);return i.dataArrived(this,r),!0}if(s.requestPromise)return!0;P(s.requestAbort),s.requestAbort=new AbortController;const r=this._surface.requestTileData(this,e,t,s.requestAbort);if(!r)return s.requestAbort=null,!1;const n=()=>{s.requestPromise===r&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=r,r.then(n,n),!0}get leaf(){return null==this._children[0]}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return ts(Yi(vC,Qa(this._center[1]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const i=this.extent;return e>=i[0]&&t>=i[1]&&e<=i[2]&&t<=i[3]}unrequestLayerData(e,t,i){const s=this.layerInfo[t][e],r=s.waitingAgents,n=null!=r.removeUnordered(i);gc(n,"agent has not requested this piece of map data"),r.length<1&&(s.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,i){const s=_c(i),r=this.layerInfo[t][e];r.data=i,r.dataInvalidated=!1,r.waitingAgents.forAll(e=>e.dataArrived(this,s)),r.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t){const i=this.layerInfo[t][e];i.dataMissing=!0,i.waitingAgents.forAll(e=>e.dataMissing()),i.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,i){switch(i&&this.forEachLoadedNeighbor(i=>i.updateRenderData(e,t)),e){case 1:return this._updateTexture(t);case 0:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(0===e?16:32),this.setPendingUpdate(0===e?32:16))}_updateGeometry(){this.setPendingUpdate(8);for(const e of this.layerInfo[0])e.pendingUpdates|=8}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let i=1/0,s=-1/0;const r=this.layerInfo[0];let n=!0;for(const e of r)null!=e.elevationBounds&&(i=Math.min(i,e.elevationBounds.min),s=Math.max(s,e.elevationBounds.max),e.elevationBounds.hasNoDataValues||(n=!1));n&&(i=Math.min(i,0),s=Math.max(s,0)),e===i&&t===s||(this._elevationBoundsMin=i,this._elevationBoundsMax=s,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,i=.5*(e+t),s=this._center;Bi(vC,this.up,i),Ki(Qa(s[1]),this.centerAtSeaLevel,vC),Bi(vC,this.up,e),Ki(s[0],this.centerAtSeaLevel,vC),Bi(vC,this.up,t),Ki(s[2],this.centerAtSeaLevel,vC)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[0][e],s=this.elevationLevelDelta,r=Math.max(this.elevationLevel-s,0),n=i.elevationBounds;if(null!=n&&n.level>=t&&n.level<=r)return;if(!Mx(this,this._surface.layerViewByIndex(e,0)))return;const a=cC;let o=!1;const l=i.data;if(l&&l.level<=r){const e=i.data;a.min=e.samplerData.data.minValue,a.max=e.samplerData.data.maxValue,a.hasNoDataValues=e.samplerData.data.hasNoDataValues,a.level=this.level,o=!0}else{let t,i,n=0;for(let a=this._parent;a&&(!i||n<s)&&(n=this.elevationLevel-a.level,t=i||t,i=a.layerInfo[0][e].data,!(!i&&t&&a.level<=r));a=a.parent);i=i||t,i&&(i.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],a),a.min!==1/0&&(a.level=i.level,o=!0))}o&&(null==i.elevationBounds&&(i.elevationBounds=new ww),i.elevationBounds.copyFrom(a))}modifyLayers(e,t,i){const s=this.layerInfo[i];for(const e of s)e.loadingAgent&&e.loadingAgent!==tC&&(oC(e.loadingAgent),e.loadingAgent=null),e.waitingAgents.clear();for(let t=0;t<s.length;++t)void 0===e[t]&&s[t].release();const r=new Array(...s),n=t.length;s.length=n;for(let e=0;e<n;e++){const i=t[e];s[e]=i>-1?r[i]:iC.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,0))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===tC&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of Ow){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==tC&&(i.loadingAgent.setSuspension(t),i.loadingAgent===tC&&this.updateRenderData(e,0))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==tC&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=tC,i.data||null!=i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return"normal"!==e.blendMode||kt(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,i){for(let s=e;s<t;++s){const e=this._surface.layerViewByIndex(s,i);if(vc(e)&&"normal"!==e?.layer?.blendMode||kt(e?.layer?.parent)&&this._hasBlendableAncestor(e?.layer?.parent))return!0}return!1}_createOrUpdateAgents(e,t){const i=this.layerInfo[t];if(0===i.length)return;const s=this._isSuspended(t);for(let r=e;r<i.length;++r){const n=i[r],a=this._surface.layerViewByIndex(r,t);let o=!1;if(n.loadingAgent?Mx(this,a)?(n.loadingAgent!==tC&&n.loadingAgent.setSuspension(s),n.loadingAgent!==tC&&(o=n.loadingAgent.update())):n.dispose():Mx(this,a)&&(n.loadingAgent=aC(this,r,t,s),o=n.loadingAgent.startLoading(),o?n.loadingAgent===tC&&this.setPendingUpdate(8):(oC(n.loadingAgent),n.loadingAgent=tC)),n.loadingAgent===tC&&this.updateRenderData(t,0),!a.destroyed&&!this._hasBlendModes(e,i.length,t)&&o&&a.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,i=Math.max(this.level-e,this.elevationLevelDelta-t),s=Ci(1+(this._maxTesselation>>i),2,this._maxTesselation+1),r=this.minimumVerticesPerSide;return Math.max(s,r)}_findLIJ(e,t){if(!e)return null;const i=this.surface.rootTiles;if(null!=i)for(const s of i)if(dC(s,e)){let i=s,r=e[0]-i.level-1;for(;r>=0&&!i.leaf&&!t(i);){const t=e[1]>>r&1,s=e[2]>>r&1;i=i.children[2*t+s],r--}return t(i)?i:null}return null}findNeighborTile(e,t){const i=this._lij,s=this._getNeighborLIJ(i,e);return s?uC(i,s)?t(this)?this:null:this._findLIJ(s,t):null}findCorner(e,t){const i=1===e?1:7===e?0:5===e?2:3;let s=this;for(;s.children[0]&&(!t||!t(s));)s=s.children[i];return s}findNeighborCornerTileExact(e,t){return this.findNeighborTile(e,e=>t(e)||e.level===this.level)?.findCorner(bc(e),t)||null}forAllSubtreeOnSide(e,t){const i=0===e?[0,1]:1===e?[1]:2===e?[1,3]:3===e?[3]:4===e?[2,3]:5===e?[2]:6===e?[0,2]:[0],s=e=>{const r=e.children;!t(e)&&r[0]&&i.forEach(e=>s(r[e]))};s(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const i=this.level-t.level;if(ac(!dc||i>=0),0===i)return 0;const s=2**i,r=!(1&~e),n=r?0:1,a=t.lij[n+1]*s,o=this._lij[n+1],l=o-a,h=r?s-1-l:l;return dc&&(ac(a<=o&&o<a+s),ac(0<=h&&h<s)),h}forEachLoadedNeighbor(e){const t=this.level,i=e=>e.level===t||e.loaded;lc.forEach(t=>{const s=this.findNeighborTile(t,i);null!=s&&s!==this&&s.forAllSubtreeOnSide(hc(t),i=>!!i.loaded&&(e(i,t),!0))}),cc.forEach(t=>{const s=this.findNeighborTile(t,i)?.findCorner(bc(t),e=>e.loaded);ac(!s||pC(this,s,t)),s?.loaded&&e(s,t)})}_getNeighborLIJ(e,t){const i=Cc(t)?-1:Tc(t)?1:0,s=Sc(t)?-1:Pc(t)?1:0,r=[e[0],e[1]+i,e[2]+s];return r[1]<0?null:this.surface.isGlobal?this._wrapLIJ(r):r[2]<0?null:r}_wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}isEdgeNeighbor(e,t){if(null==e)return!1;if(0===this.level&&0===e.level){if(this._eastEnd&&e._westEnd&&2===t)return!0;if(this._westEnd&&e._eastEnd&&6===t)return!0}const i=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(t){case 0:return wc(this.extent[3],e.extent[1],i);case 4:return wc(this.extent[1],e.extent[3],i);case 2:return wc(this.extent[2],e.extent[0],i)||wc(this.extent[2],-e.extent[0],i);case 6:return wc(this.extent[0],e.extent[2],i)||wc(this.extent[0],-e.extent[2],i)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return 0===this._lij[2]}checkGeometryWaterproofness(){xc&&(ac(this.loaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,i=this.surface.rootTilesExtent,s=.25*(t[2]-t[0]);if(Cc(e)&&t[3]+s>=i[3])return!1;if(Tc(e)&&t[1]-s<=i[1])return!1;const r=this.surface.isGlobal;return!(!r&&Sc(e)&&t[0]-s<=i[0]||!r&&Pc(e)&&t[2]+s>=i[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;Zi(this._lastPOI,e);const i=this._center[1],s=e[0]-i[0],r=e[1]-i[1],n=e[2]-i[2];this.distanceToPOI=s*s+r*r+n*n}}function aC(e,t,i,s){const r=0===i?hC.acquire():lC.acquire();return r.init(e,t,i,s),r}function oC(e){e.dispose(),function(e){return"elevation"===e.type}(e)?hC.release(e):function(e){return"map"===e.type}(e)&&lC.release(e)}const lC=new td(class extends Jx{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return gd}}),hC=new td(class extends Jx{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}),cC=new ww;function dC(e,t){const i=e.lij,s=t[0]-i[0];return!(s<0)&&t[1]>>s===i[1]&&t[2]>>s===i[2]}function uC(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function pC(e,t,i){return null!=e&&null!=t&&t!==e&&(e.level>=t.level?mC(e,t,i):mC(t,e,bc(i)))}function mC(e,t,i){ac(e.level>=t.level);const s=Mc(i),r=Rc(i),n=e.extent,a=t.extent,o=[s?n[0]:n[2],r?n[3]:n[1]],l=[s?a[2]:a[0],r?a[1]:a[3]],h=1e-5*(n[2]-n[0]),c=wc(o[0],l[0],h)||e.surface.isGlobal&&wc(o[0],-l[0],h),d=wc(o[1],l[1],h);if(c&&d)return!0;if(e.level===t.level)return ac(!1),!1;if(!c&&!d)return ac(!1),!1;const u=c?gC(a[1],a[3],n[1],n[3],h):gC(a[0],a[2],n[0],n[2],h);return ac(u),u}function gC(e,t,i,s,r){return e-r<=i&&i<=s&&s<=t+r}const _C=ke(),fC=ke(),yC=ke(),vC=ke();function bC(e){e.tile.intersectsClippingArea&&(xC(e),wC(e))}function wC(e,t=!1){const{geometry:i,geometryState:s,tile:r,localOrigin:n}=e,{level:a,extent:o,extentInRadians:l,ellipsoid:h}=r,c=h.radius,d=l[0],u=l[2],p=l[1],m=l[3],{samplerData:_}=s,f=o[0],y=o[2],v=o[1],b=o[3],w=TC(e),{boundingBox:x,vertexAttributes:C}=i,T=n[0],S=n[1],P=n[2],{position:M,uv0:R}=C,O=M.typedBuffer,D=M.typedBufferStride;for(let n=0;n<4;++n){const l=1===n||3===n,h=s.edgeResolutions[n];ac(Di(h));const C=h+1,M=Nx(r,s.edgePeerNeighbors[n]);if(NC(r,M,n)){LC(e,n,M);continue}const A=null!=M;ac(!A||M.level===r.level),ac(!A||Rx(r,M)<=0);const E=M?.renderData,I=E?.geometryState;if(dc){const e=r.surface;if(!M&&e&&!e.updatingRootTiles){const t=lc[n],i=r.findNeighborTile(t,e=>e.loaded||e.leaf||e.level===r.level);i?i.intersectsClippingArea&&(ac(!i.loaded),ac(!i.leaf),ac(i.level===a)):ac(null==e?.rootTiles||!r.shouldHaveNeighbor(t))}}const L=1===n?o[2]:o[0],k=M?.extent,V=k&&l?1===n?k[0]:k[2]:L,F=0===n?o[3]:o[1],j=1===n?1:0,z=0===n?1:0,H=1===n?u:d,q=0===n?m:p,U=Math.sin(H),B=Math.cos(H),N=Math.sin(q),G=Math.cos(q),W=I?.samplerData,$=A?(e,t,i)=>.5*(Tw(e,t,_)+Tw(i,t,W)):(e,t,i)=>Tw(e,t,_),Q=i.outerEdgesOffsetAndLength[2*n+0],Z=t&&C>3?C-3:1,Y=null!=_&&_.some(e=>null!=e),K=null!=W&&W.some(e=>null!=e),X=Y||K,J=1/h,ee=Q;ac(!k||wc(k[2]-k[0],o[2]-o[0])),(()=>{const e=1===n?-1:3===n?1:0,t=0===n?-1:2===n?1:0,s=(o[2]-o[0])*J,r=e*s,a=t*s,h=l?e*((u-d)*J):0,p=l?0:t*J,m=z,M=l?H+h:H,E=l?Math.sin(M):U,I=l?Math.cos(M):B,k=l?H-h:H,Q=l?Math.sin(k):U,Y=l?Math.cos(k):B,K=l?q:w(m+p),te=l?N:Math.sin(K),ie=l?G:Math.cos(K),se=l?q:w(m-p),re=l?N:Math.sin(se),ne=l?G:Math.cos(se);let ae=0,oe=0,le=0;{const e=0*J,t=l?L:f*(1-e)+y*e,i=l?V:t,s=l?v*(1-e)+b*e:F,r=l?H:d*(1-e)+u*e,n=l?U:Math.sin(r),a=l?B:Math.cos(r),o=l?w(e):q,h=l?Math.sin(o):N,p=l?Math.cos(o):G,m=c+$(t,s,i);ae=a*p*m,oe=n*p*m,le=h*m}let he=0,ce=0,de=0;{const e=1*J,t=l?L:f*(1-e)+y*e,i=l?V:t,s=l?v*(1-e)+b*e:F,r=l?H:d*(1-e)+u*e,n=l?U:Math.sin(r),a=l?B:Math.cos(r),o=l?w(e):q,h=l?Math.sin(o):N,p=l?Math.cos(o):G,m=c+$(t,s,i);he=a*p*m,ce=n*p*m,de=h*m}for(let e=1;e<C-1;e+=Z){let t=0,s=0,o=0;{const i=(e+1)*J,r=l?L:f*(1-i)+y*i,n=l?V:r,a=l?v*(1-i)+b*i:F,h=l?H:d*(1-i)+u*i,p=l?U:Math.sin(h),m=l?B:Math.cos(h),g=l?w(i):q,_=l?Math.sin(g):N,x=l?Math.cos(g):G,C=c+$(r,a,n);t=m*x*C,s=p*x*C,o=_*C}const h=t,p=s,m=o,C=he,M=ce,k=de;he=h,ce=p,de=m;{const t=ee+e,i=t*D,s=C-T,r=M-S,n=k-P;O[i]=s,O[i+1]=r,O[i+2]=n,$C(s,r,n,x);const a=e*J,o=l?j:a,h=l?a:z;R.setValues(t,Math.round(o*g),Math.round(h*g))}const Z=ae,K=oe,se=le;ae=C,oe=M,le=k;const ue=C,pe=M,me=k,ge=1/Math.sqrt(ue*ue+pe*pe+me*me),_e=me*ge;let fe=0,ye=0,ve=0;if(X&&_e*_e<.999){let t=0,i=0,s=0;{const e=0===n?-1:1;t=e*(h-Z),i=e*(p-K),s=e*(m-se)}{const o=e*J,h=l?L:f*(1-o)+y*o,p=l?V:h,m=l?v*(1-o)+b*o:F,g=l?H:d*(1-o)+u*o,x=l?U:Math.sin(g),C=l?B:Math.cos(g),T=l?w(o):q,S=l?Math.sin(T):N,P=l?Math.cos(T):G;let M=ue,R=pe,O=me;if(A){const e=c+Tw(p-r,m-a,W),t=l?P:ne;M=(l?Y:C)*t*e,R=(l?Q:x)*t*e,O=(l?S:re)*e}{const e=c+Tw(h+r,m+a,_),o=l?P:ie,d=(l?I:C)*o*e,u=(l?E:x)*o*e,p=(l?S:te)*e;A||(M=2*ue-d,R=2*pe-u,O=2*me-p);const g=3===n?-1:1,f=g*(M-d),y=g*(R-u),v=g*(O-p);fe=s*y-i*v,ye=t*v-s*f,ve=i*f-t*y;const b=1/Math.sqrt(fe*fe+ye*ye+ve*ve);fe*=b,ye*=b,ve*=b}}}else fe=ue*ge,ye=pe*ge,ve=me*ge;i.setEdgeNormalFromValues(n,e,fe,ye,ve)}})()}}function xC(e){kC(e)}function CC(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function TC(e){const{tile:t}=e;if(t.surface.isWebMercator){const e=t.extent,i=t.ellipsoid.radius,s=t=>function(e,t,i,s){return CC(e*(1-s)+t*s,i)}(e[1],e[3],i,t);return s}const i=t.extentInRadians;return e=>function(e,t,i){return e*(1-i)+t*i}(i[1],i[3],e)}function SC(e,t){e.tile.intersectsClippingArea&&(MC(e),PC(e,!1))}function PC(e,t){const{geometry:i,geometryState:s,localOrigin:r}=e,n=e.tile,{surface:a,extent:o}=n,{clippingArea:l,samplerData:h}=s,c=null!=l?l:UC,d=o[0],u=o[2],p=o[1],m=o[3],g=[m>c[3],u>c[2],p<c[1],d<c[0]],_=n.horizontalScale,f=RC(a.isWebMercatorOnPlateCarree,n.ellipsoid.radius,_),{minu:y,minv:v,maxu:b,maxv:w,boundingBox:x}=i,C=Math.max(d,c[0]),T=Math.min(u,c[2]),S=Math.max(p,c[1]),P=Math.min(m,c[3]),M=r[0],R=r[1],O=r[2];for(let r=0;r<4;++r){const o=1===r||3===r,l=s.edgeResolutions[r];ac(Di(l));const c=l+1,D=g[r],A=Nx(n,s.edgePeerNeighbors[r]);if(!D&&NC(n,A,r)){LC(e,r,A);continue}const E=null!=A&&!D,I=A?.renderData,L=I?.geometryState;if(dc&&(ac(!E||A.level===n.level),ac(!E||Rx(n,A)<=0),n&&!A&&!a.updatingRootTiles)){const e=lc[r],t=n.findNeighborTile(e,e=>e.loaded||e.leaf||e.level===n.level);a.updatingRootTiles||(t?t.intersectsClippingArea&&(ac(!t.loaded),ac(!t.leaf),ac(t.level===n.level)):ac(null==a?.rootTiles||!n.shouldHaveNeighbor(e)))}const k=Ci(1===r?u:d,C,T),V=Ci(0===r?m:p,S,P),F=L?.samplerData,j=t&&c>3?c-3:1,z=Ci(1===r?1:0,y,b),H=Ci(0===r?1:0,v,w),q=E?(e,t)=>.5*(Tw(e,t,F)+Tw(e,t,h)):(e,t)=>Tw(e,t,h),U=(u-d)/l,B=o?1===r?U:-U:0,N=o?0:0===r?U:-U,G=-B,W=-N;let $=0,Q=0,Z=0;{const e=0/l,t=o?k:Ci(d*(1-e)+u*e,C,T),i=o?Ci(p*(1-e)+m*e,S,P):V,s=q(t,i);$=t*_,Q=f(i),Z=s}let Y=0,K=0,X=0;{const e=1/l,t=o?k:Ci(d*(1-e)+u*e,C,T),i=o?Ci(p*(1-e)+m*e,S,P):V,s=q(t,i);Y=t*_,K=f(i),X=s}for(let e=1;e<c-1;e+=j){const t=e/l,s=Y,n=K,a=X;{const l=o?z:Ci(t,y,b),h=o?Ci(t,v,w):H,c=s-M,d=n-R,u=a-O;$C(s,d,u,x),i.setEdgeVertexFromValuesRawPositionUV(r,e,c,d,u,l,h)}{const t=(e+1)/l,i=o?k:Ci(d*(1-t)+u*t,C,T),s=o?Ci(p*(1-t)+m*t,S,P):V,r=q(i,s);Y=i*_,K=f(s),X=r}const c=Y,g=X,D=$,A=Q,I=Z;$=s,Q=n,Z=a;let L=0,j=0,U=0;if(o){const e=K-n,i=g-a,o=A-n,l=I-a,c=Ci(p*(1-t)+m*t,S,P),d=k+G,u=d*_-s,f=Tw(d,c,h)-a,y=3===r?-1:1;if(L=y*(-o+e)*f,j=y*u*(-l+i),U=-y*u*(-o+e),E){const t=k+B,r=t*_-s;L=(-o+e)*(f-(Tw(t,c,F)-a)),j=(u-r)*(-l+i),U=-(u-r)*(-o+e)}}else{const e=c-s,i=g-a,o=D-s,l=I-a,p=Ci(d*(1-t)+u*t,C,T),m=V+W,_=Tw(p,m,h)-a,y=f(m)-n,v=2===r?-1:1;if(L=v*y*(-l+i),j=v*(-o+e)*_,U=-v*y*(-o+e),E){const t=p,s=V+N,r=f(s)-n;L=(-y+r)*(-l+i),j=(-o+e)*(-_+(Tw(t,s,F)-a)),U=-(-y+r)*(-o+e)}}const J=1/Math.sqrt(L*L+j*j+U*U);i.setEdgeNormalFromValues(r,e,L*J,j*J,U*J)}}}function MC(e,t){kC(e)}function RC(e,t,i){return e?e=>function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t):e=>function(e,t){return e*t}(e,i)}function OC(e,t,i){const{numVerticesPerSide:s,vertexAttributes:r,maxEdgeVertexCount:n}=e,a=s-1,o=r.count,l=2*(s-3)*(s-3),h=4*(a+n-3),c=Xx.reduce((t,i)=>t+(a+e.getEdgeCount(i)-3),0),d=t.reduce((e,t)=>e+a*(2*(t.latitudeResolution-1)+1),0),u=3*(i?2:1),p=(l+h+d)*u,m=o>=65536?new Uint32Array(p):new Uint16Array(p);for(let e=0;e<p;++e)m[e]=0;e.indices=m,e.indexCount=(l+c+d)*u,e.poleIndicesStartIndex=l*u,e.edgeIndicesStartIndex=(l+d)*u,i?(function(e){const{indices:t,numVerticesPerSide:i,vertexAttributes:s}=e,{position:r}=s,{typedBuffer:n,typedBufferStride:a}=r,o=i-2;let l=0;for(let e=0;e<i-3;++e){const s=e*o;for(let r=0;r<i-3;++r){const i=e*o+r,h=i+1,c=h+o,d=c-1,u=s+r,p=u+1,m=p+o;ZC(u,p,m,m-1,a,n)?(YC(t,l,i,h,c),l+=6,YC(t,l,c,d,i)):(YC(t,l,i,h,d),l+=6,YC(t,l,d,c,h)),l+=6}}}(e),function(e,t){const{indices:i,numVerticesPerSide:s,poleIndicesStartIndex:r}=e,n=s-1;let a=r;for(const r of t){const t=r.connectedOuterEdgeOffset;let o=e.getEdgeVertexIndex(t,0),l=1;for(let e=0;e<r.latitudeResolution;++e){const t=0===e?r.rowOffset:o+s;for(let s=0;s<n;s++)YC(i,a,o,o+1,t+s),a+=6,e<r.latitudeResolution-1&&(YC(i,a,o+1,t+s+1,t+s),a+=6),o+=l;o=t,l=1}}}(e,t),AC(e)):(function(e){const{numVerticesPerSide:t,indices:i,vertexAttributes:s}=e,{position:r}=s,{typedBuffer:n,typedBufferStride:a}=r,o=t-2,l=t-3,h=t-3;let c=0;for(let e=0;e<l;++e){const t=e*o;for(let e=0;e<h;++e){const s=t+e,r=s+1,l=r+o,h=l-1;ZC(s,r,l,h,a,n)?(i[c]=s,i[c+1]=r,i[c+2]=l,i[c+3]=l,i[c+4]=h,i[c+5]=s):(i[c]=s,i[c+1]=r,i[c+2]=h,i[c+3]=h,i[c+4]=r,i[c+5]=l),c+=6}}}(e),function(e,t){const{numVerticesPerSide:i,indices:s,poleIndicesStartIndex:r}=e,n=i-1;let a=r;for(const r of t){const t=r.isNorth?1:2,o=r.isNorth?2:1,l=r.isNorth?3:4,h=r.isNorth?4:3;let c=e.getEdgeVertexIndex(r.connectedOuterEdgeOffset,0),d=1;for(let e=0;e<r.latitudeResolution;++e){const u=0===e?r.rowOffset:c+i;for(let i=0;i<n;i++){const n=u+i;s[a]=c,s[a+t]=c+1,s[a+o]=n,e<r.latitudeResolution-1?(s[a+l]=c+1,s[a+h]=n+1,s[a+5]=n,a+=6):a+=3,c+=d}c=u,d=1}}}(e,t),DC(e))}function DC(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:s}=e,r=i-1,n=r-2;let a=s;for(let i=0;i<4;++i){const s=WC[i];let o=0,l=0;const h=e.getEdgeCount(i),c=s.count;ac(c===r-1);const d=1===i||2===i,u=d?1:2,p=d?2:1,m=e.getEdgeFirstVertexIndex(i),g=1,_=s.vertex0Index,f=s.stride;for(;o<h-1||l<c-1;){const e=_+l*f,i=m+o*g,s=o<h-1,d=l<c-1,y=s&&(!d||(s?0+r*(o+.5)/(h-1):0)<=(d?1+n*(l+.5)/(c-1):0));y?++o:++l;const v=y?i+g:e+f;t[a]=e,t[a+u]=i,t[a+p]=v,a+=3}}e.indexCount=a}function AC(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:s}=e,r=i-1,n=r-2;let a=s;for(let i=0;i<4;++i){const s=WC[i];let o=0,l=0;const h=e.getEdgeCount(i),c=s.count;ac(c===r-1);const d=1===i||2===i,u=d?1:3,p=d?3:1,m=e.getEdgeFirstVertexIndex(i),g=1,_=s.vertex0Index,f=s.stride;for(;o<h-1||l<c-1;){const e=_+l*f,i=m+o*g,s=o<h-1,d=l<c-1,y=s&&(!d||(s?0+r*(o+.5)/(h-1):0)<=(d?1+n*(l+.5)/(c-1):0));y?++o:++l;const v=y?i+g:e+f;t[a]=e,t[a+u]=i,t[a+u+1]=i,t[a+p]=v,t[a+p+1]=v,t[a+5]=e,a+=6}}e.indexCount=a}function EC(e){const{geometry:t,geometryState:i}=e,{edgeResolutions:s}=i,{numVerticesPerSide:r,edgeVerticesStartIndex:n}=t,a=r-2;let o=n;for(let e=0;e<4;++e){{const t=0===e||2===e,i=(0===e?a-1:0)*a+(1===e?a-1:0),s=(t?0:1)*a+(t?1:0),r=WC[e];r.vertex0Index=i,r.stride=s,r.count=a}{const i=s[e]+1;t.outerEdgesOffsetAndLength[2*e+0]=o,t.outerEdgesOffsetAndLength[2*e+1]=i,o+=i}}}function IC(e){EC(e),e.geometryState.wireframe?AC(e.geometry):DC(e.geometry)}function LC(e,t,i){const{geometryState:s,geometry:r,tile:n,localOrigin:a}=e,o=1===t||3===t,l=s.edgeResolutions[t];ac(Di(l));const h=l+1,{boundingBox:c,minu:d,minv:u,maxu:p,maxv:m,vertexAttributes:_}=r,f=Ci(1===t?1:0,d,p),y=Ci(0===t?1:0,u,m),v=i.renderData,b=v.geometryState,w=v.geometry,x=(t+2)%4,C=w.getEdgeCount(x),T=n.getNeighborEdgeStartVertexIndex(t,i)*l,S=l*2**(n.level-i.level);ac(b.edgeResolutions[x]===S),ac(C-1===S);const P=v.localOrigin[0]-a[0],M=v.localOrigin[1]-a[1],R=v.localOrigin[2]-a[2],O=r.getEdgeFirstVertexIndex(t),{position:D,uv0:A}=_,E=D.typedBuffer,I=D.typedBufferStride,L=_.normalCompressed,k=L.typedBuffer,V=L.typedBufferStride,F=w.vertexAttributes,j=w.getEdgeFirstVertexIndex(x),z=F.position.typedBuffer,H=F.position.typedBufferStride,q=F.normalCompressed.typedBuffer,U=F.normalCompressed.typedBufferStride;for(let e=1;e<h-1;++e){const t=O+e,i=j+(T+e),s=t*I,r=i*H,n=z[r]+P,a=z[r+1]+M,h=z[r+2]+R;E[s]=n,E[s+1]=a,E[s+2]=h,$C(n,a,h,c);const _=t*V,v=i*U;k[_]=q[v],k[_+1]=q[v+1];const b=e/l,w=o?f:Ci(b,d,p),x=o?Ci(b,u,m):y;A.setValues(t,Math.round(w*g),Math.round(x*g))}}function kC(e){const{geometry:t,geometryState:i,localOrigin:s}=e,{clippingArea:r,samplerData:n}=i,{minu:a,minv:o,maxu:l,maxv:h,boundingBox:c,vertexAttributes:d}=t,u=e.tile,{surface:p,ellipsoid:m,extent:_,extentInRadians:f,horizontalScale:y}=u,v="local"===p.view?.viewingMode,b=m.radius;let w=0,x=0,C=0;const T=v?(()=>{const e=r,t=null!=e&&(_[3]>e[3]||_[2]>e[2]||_[1]<e[1]||_[0]<e[0]),i=RC(p.isWebMercatorOnPlateCarree,b,y);return(s,r,n)=>{const a=0===s?_[0]:_[2],o=0===r?_[1]:_[3],l=t?Ci(a,e[0],e[2]):a,h=t?Ci(o,e[1],e[3]):o,c=n;w=l*y,x=i(h),C=c}})():(e,t,i)=>{const s=f[0===t?1:3],r=f[0===e?0:2],n=Math.cos(s),a=Math.sin(s),o=Math.sin(r),l=Math.cos(r),h=b+i;w=l*n*h,x=o*n*h,C=a*h};let S=0,P=0,M=0,R=0,O=0,D=0,A=0,E=0,I=0;const L=v&&p.isWebMercatorOnPlateCarree,k=(e,t,i,s,r)=>{let n=0,a=0,o=0;if(v){const e=t*y,r=L?(Math.PI/2-2*Math.atan(Math.exp(-i/b)))*b:i*y;n=e-w,a=r-x,o=s-C}else{const r=TC(e),l=e.tile,h=l.extent,c=l.extentInRadians,d=(t-h[0])/(h[2]-h[0]),u=(i-h[1])/(h[3]-h[1]),p=c[0]*(1-d)+c[2]*d,m=r(u),g=Math.cos(m),_=Math.sin(m),f=Math.sin(p),y=Math.cos(p),v=b+s;n=y*g*v-w,a=f*g*v-x,o=_*v-C}switch(r){case 0:A+=n,E+=a,I+=o;break;case 1:R-=n,O-=a,D-=o;break;case 2:A-=n,E-=a,I-=o;break;case 3:R+=n,O+=a,D+=o}},V=r??UC,F=_[0],j=_[2],z=_[1],H=_[3],q=[H>V[3],j>V[2],z<V[1],F<V[0]],U=Math.max(F,V[0]),B=Math.min(j,V[2]),N=Math.max(z,V[1]),G=Math.min(H,V[3]),W=e=>Math.max(V[0],Math.min(V[2],e)),$=e=>Math.max(V[1],Math.min(V[3],e)),Q=e=>{const t=i.cornerNeighborCornerTiles;S=0,P=0,M=1,R=0,O=0,D=0,A=0,E=0,I=0;let s=1/0;for(let i=0;i<4;++i){const r=t[4*e+i];s=Math.min(s,r?.level??1/0)}for(let i=0;i<4;++i){const r=t[4*e+i];BC[i]=r?.level===s?r:null}let r=1,n=0;for(let e=0;e<4;++e){const t=BC[e];t&&(r=Math.max(r,t?.renderData.geometryState.numVerticesPerSide),n=t.extent[2]-t.extent[0])}const a=n,o=r;ac(o>1);const l=a/o;for(let e=0;e<4;++e){const t=BC[(e+3)%4],i=BC[e%4];if(!t&&!i)continue;const s=0===e?1:1===e?2:2===e?3:0,r=0===e?2:1===e?3:2===e?0:1;if(t&&i){const n=HC[e][0]*l,a=HC[e][1]*l,o=t.extent,h=W(o[0===s||1===s?2:0]+n),c=$(o[0===s||3===s?3:1]+a),d=i.extent,u=W(d[0===r||1===r?2:0]+n),p=$(d[0===r||3===r?3:1]+a),m=t.renderData,g=i.renderData,_=Tw(h,c,m.geometryState.samplerData),f=Tw(u,p,g.geometryState.samplerData);k(m,h,c,.5*(_+f),e)}else{const n=t??i,a=t?s:r,o=n.extent,h=HC[e],c=W(o[0===a||1===a?2:0]+h[0]*l),d=$(o[0===a||3===a?3:1]+h[1]*l),u=n.renderData,p=Tw(c,d,u.geometryState.samplerData);k(u,c,d,p,e)}}if(!v){const e=Math.sqrt(w*w+x*x+C*C);S=w/e,P=x/e,M=C/e}if(v||M*M<.999){const e=Math.sqrt(R*R+O*O+D*D);R/=e,O/=e,D/=e;const t=Math.sqrt(A*A+E*E+I*I);A/=t,E/=t,I/=t,S=D*E-O*I,P=R*I-D*A,M=O*A-R*E;const i=1/Math.sqrt(S*S+P*P+M*M);S*=i,P*=i,M*=i}},Z=i.cornerNeighborCornerTiles;for(let e=0;e<4;++e){const r=e,p=(e+1)%4,m=0===e||1===e?1:0,_=0===e||3===e?1:0,f=Ci(m,a,l),y=Ci(_,o,h),v=t.getEdgeFirstVertexIndex(r),b=t.getEdgeCount(r),R=0===e||3===e?b-1:0,O=t.getEdgeFirstVertexIndex(p),D=t.getEdgeCount(p),A=0===e||1===e?D-1:0;let E=-1;for(let t=0;t<4;++t){const i=Z[4*e+t],s=Z[4*e+E];i&&(-1===E||Rx(s,i)>0)&&(E=t)}const I=E,L=Z[4*e+I];if(L!==u){const t=u.level-L.level,r=2**t,n=[L.lij[0]+t,L.lij[1]*r,L.lij[2]*r],a=[n[1]+r===u.lij[1],0===e&&(1===I||0===I&&L!==Z[4*e+3])||1===e&&(0===I||1===I&&L!==Z[4*e+2]),n[1]===u.lij[1]+1,2===e&&(3===I||2===I&&L!==Z[4*e+1])||3===e&&(2===I||3===I&&L!==Z[4*e+0])],o=a.reduce((e,t)=>e+(t?1:0),0);ac(1===o||2===o);let l=-1,h=-1;const p=L.renderData;if(1===o){const t=a.findIndex(e=>e);ac(0<=t&&t<=3),l=(t+2)%4;const s=i.edgeResolutions[t];h=u.getNeighborEdgeStartVertexIndex(t,L)*s+s*(0===t&&0===e||1===t&&0===e||2===t&&1===e||3===t&&3===e?1:0)}else{ac(a[1]||a[3]),l=a[1]?3:1;const t=p.geometryState.edgeResolutions[l];h=0===e||3===e?0:t}const m=p.geometry;{const e=v+R,t=O+A,i=m.getEdgeFirstVertexIndex(l)+h,r=m.vertexAttributes,n=p.localOrigin,a=r.position,o=a.typedBuffer,u=i*a.typedBufferStride,_=o[u]+n[0]-s[0],b=o[u+1]+n[1]-s[1],w=o[u+2]+n[2]-s[2];$C(_,b,w,c);const x=d.position,C=x.typedBuffer,T=e*x.typedBufferStride;C[T]=_,C[T+1]=b,C[T+2]=w;const S=t*x.typedBufferStride;C[S]=_,C[S+1]=b,C[S+2]=w;const P=d.uv0;P.setValues(e,Math.round(f*g),Math.round(y*g)),P.setValues(t,Math.round(f*g),Math.round(y*g));{const s=r.normalCompressed.typedBuffer,n=i*r.normalCompressed.typedBufferStride,a=d.normalCompressed,o=a.typedBuffer;{const t=e*a.typedBufferStride;o[t]=s[n],o[t+1]=s[n+1]}{const e=t*a.typedBufferStride;o[e]=s[n],o[e+1]=s[n+1]}}}}else{let i;i=q[r]||q[p]?Tw(Ci(F*(1-m)+j*m,U,B),Ci(z*(1-_)+H*_,N,G),n):VC(Z,e),T(m,_,i),Q(e);const a=w-s[0],o=x-s[1],l=C-s[2];$C(a,o,l,c),t.setEdgeVertexFromValuesRawPositionUVNormal(r,R,a,o,l,f,y,S,P,M),t.setEdgeVertexFromValuesRawPositionUVNormal(p,A,a,o,l,f,y,S,P,M)}}for(let e=0;e<4;++e)BC[e]=null}function VC(e,t){const i=4*t,s=Xx.reduce((t,s)=>Math.min(t,e[i+s]?.level??1/0),1/0);dc&&(ac(!e[i+0]||!e[i+2]||pC(e[i+0],e[i+2],5)),ac(!e[i+1]||!e[i+3]||pC(e[i+1],e[i+3],7)));let r=0,n=0;for(let t=0;t<4;++t){const a=e[i+t];if(a&&a.level===s){const e=0===t||1===t,i=0===t||3===t,s=a.extent,o=s[e?0:2],l=s[i?1:3],h=a.renderData?.geometryState?.samplerData;n+=Tw(o,l,h),r++}}const a=r?n/r:0;return ac(null!=a),a}function FC(e){const{vao:t,geometry:i}=e,{vertexAttributes:s,edgeVerticesStartIndex:r}=i,n=s.position.typedBuffer;t.buffer()?.setSubData(n,r,r,n.length)}function jC(e){const{vao:t,geometry:i}=e,{indices:s,indexCount:r,edgeIndicesStartIndex:n}=i;t.indexBuffer.setSubData(s,n,n,r)}class zC{constructor(e,t,i,s,r){this.isNorth=e,this.connectedRowOffset=t,this.connectedOuterEdgeOffset=i,this.rowOffset=s,this.latitudeResolution=r}}const HC=[[0,1],[1,0],[0,-1],[-1,0]],qC=new class{constructor(){this.sinLonLUT=new Array(pd+1),this.cosLonLUT=new Array(pd+1),this.sinLatLUT=new Array(pd+1),this.cosLatLUT=new Array(pd+1)}update(e,t,i){const s=t[0],r=t[2];for(let t=0;t<=e;t++){const n=t/e,a=s*(1-n)+r*n;this.sinLonLUT[t]=Math.sin(a),this.cosLonLUT[t]=Math.cos(a);const o=i(n);this.sinLatLUT[t]=Math.sin(o),this.cosLatLUT[t]=Math.cos(o)}}},UC=Tt(-1/0,-1/0,1/0,1/0),BC=[null,null,null,null];function NC(e,t,i){if(!t)return!1;const s=Rx(e,t);return s>0||0===s&&i>=2}class GC{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return ac(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}const WC=[new GC,new GC,new GC,new GC];function $C(e,t,i,s){e<s[0]?s[0]=e:e>s[3]&&(s[3]=e),t<s[1]?s[1]=t:t>s[4]&&(s[4]=t),i<s[2]?s[2]=i:i>s[5]&&(s[5]=i)}function QC(e){const{edgeResolutions:t,numVerticesPerSide:i}=e,s=1+Math.max(...t);return Math.max(i,s)}function ZC(e,t,i,s,r,n){const a=e*r,o=n[a],l=n[a+1],h=n[a+2],c=t*r,d=n[c],u=n[c+1],p=n[c+2],m=i*r,g=n[m],_=n[m+1],f=n[m+2],y=s*r,v=n[y],b=n[y+1],w=n[y+2];return(d-v)*(d-v)+(u-b)*(u-b)+(p-w)*(p-w)>(o-g)*(o-g)+(l-_)*(l-_)+(h-f)*(h-f)}function YC(e,t,i,s,r){e[t]=i,e[t+1]=s,e[t+2]=s,e[t+3]=r,e[t+4]=r,e[t+5]=i}class KC extends nC{constructor(e,t,i,s,r){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=lt(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,i,s,r)}init(e,t,i,s,r){super.init(e,t,i,s,r);const n=r.view.renderSpatialReference,a=r.spatialReference,o=null!=n&&ye(n)&&null!=a&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;const{isWebMercatorOnPlateCarree:l}=r,h=this._extentInRenderSR,c=this.extent;if(l){const e=Ve(c[0],c[1],0);sd(e,tt.WebMercator,e,tt.PlateCarree);const t=Ve(c[2],c[3],0);sd(t,tt.WebMercator,t,tt.PlateCarree),h[0]=e[0],h[1]=e[1],h[2]=t[0],h[3]=t[1]}else for(let e=0;e<4;++e)h[e]=c[e]*o;this.centerAtSeaLevel[0]=.5*(h[0]+h[2]),this.centerAtSeaLevel[1]=.5*(h[1]+h[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(h[2]-h[0],h[3]-h[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),s=Math.sqrt(t*t+i*i),r=.5*(this.elevationBoundsMax-this.elevationBoundsMin),n=Math.max(s,r);this._center[1][3]=n}_calculateFrustumVisibility(e){const t=this._aabb(),i=t[0],s=t[1],r=t[2],n=t[3],a=t[4],o=t[5];let l=!0;for(let t=0;t<6;t++){const h=e[t],c=h[0],d=h[1],u=h[2],p=h[3];if(c*(c>0?i:n)+d*(d>0?s:a)+u*(u>0?r:o)+p>=0)return 2;l=l&&c*(c<0?i:n)+d*(d<0?s:a)+u*(u<0?r:o)+p<=0}return l?0:1}_aabb(){const e=this._extentInRenderSR;return ch(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,i,s){return XC[0]=1/t[0],XC[1]=1/t[1],XC[2]=1/t[2],nu(this._aabb(),e,XC,i,s)}createGeometry(){(function(e){const{tile:t,geometryState:i,geometry:s}=e,{extent:r,surface:n}=t,{wireframe:a}=i,o=r[0],l=r[1],h=r[2]-o,c=r[3]-l,{numVerticesPerSide:d,clippingArea:u}=i,p=null!=u?Math.max(0,(u[0]-o)/h):0,m=null!=u?Math.max(0,(u[1]-l)/c):0,_=null!=u?Math.min(1,(u[2]-o)/h):1,f=null!=u?Math.min(1,(u[3]-l)/c):1,y=(d-2)**2,v=QC(i),b=y+4*v,w=n.renderer.tileGeometryCache.acquire(b),{boundingBox:x}=s;hh(x),s.numVerticesPerSide=d,s.vertexAttributes=w,s.maxEdgeVertexCount=v,s.minu=p,s.minv=m,s.maxu=_,s.maxv=f,function(e){const t=e.tile;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:s,localOrigin:r}=e,{samplerData:n,clippingArea:a,numVerticesPerSide:o}=s,{surface:l,extent:h,ellipsoid:c}=t,{isWebMercatorOnPlateCarree:d}=l,u=null!=a?a:UC,p=h[0],m=h[1],_=h[2],f=h[3],y=Math.max(p,u[0]),v=Math.min(_,u[2]),b=Math.max(m,u[1]),w=Math.min(f,u[3]),x=c.radius,C=t.horizontalScale,T=o-1,S=o-2,{minu:P,minv:M,maxu:R,maxv:O,boundingBox:D,vertexAttributes:A}=i,{position:E,uv0:I}=A,{typedBuffer:L,typedBufferStride:k}=A.normalCompressed,V=r[0],F=r[1],j=r[2],z=E.typedBuffer,H=E.typedBufferStride;let q=0;const U=Ci(m,b,w),B=d?(Math.PI/2-2*Math.atan(Math.exp(-U/x)))*x:U*C,N=1/T,G=Ci(m*(1-N)+f*N,b,w);let W=B,$=d?(Math.PI/2-2*Math.atan(Math.exp(-G/x)))*x:G*C;for(let e=1;e<=S;e++){const t=e/T,i=Ci(m*(1-t)+f*t,b,w),s=Ci(t,M,O),r=$,a=(e-1)/T,o=Ci(m*(1-a)+f*a,b,w),l=W,h=(e+1)/T,c=Ci(m*(1-h)+f*h,b,w),u=d?(Math.PI/2-2*Math.atan(Math.exp(-c/x)))*x:c*C,A=Ci(h,M,O);W=$,$=u;const E=Ci(p,y,v);let U=E*C,B=Tw(E,i,n);const N=1/T,G=Ci(N,P,R),Q=Ci(p*(1-G)+_*G,y,v);let Z=G,Y=Q,K=Q*C,X=Tw(Q,i,n);if(1===e){const e=K-V,t=W-F,i=X-j,r=0*H;z[r]=e,z[r+1]=t,z[r+2]=i,$C(e,t,i,D);const n=Ci(N,P,R);I.setValues(q,Math.round(n*g),Math.round(s*g))}for(let t=1;t<=S;t++){const a=K,h=X,d=(t+1)/T,m=Ci(d,P,R),f=Ci(p*(1-d)+_*d,y,v),b=Y;Y=f;{const a=q+1,o=a*H;if(1===e||t===S){const l=f*C,h=Tw(f,i,n);if(1===e&&t<S){const e=l-V,t=r-F,i=h-j;z[o]=e,z[o+1]=t,z[o+2]=i,$C(e,t,i,D),I.setValues(a,Math.round(m*g),Math.round(s*g))}K=l,X=h}else K=z[o]+V,X=z[o+2]+j}const w=K,x=X,M=U,O=B;U=a,B=h;const E=(q-S)*H,N=1===e?Tw(b,o,n):z[E+2]+j,G=Tw(b,c,n);if(e<S){const e=q+S,t=e*H,i=a-V,s=u-F,r=G-j;z[t]=i,z[t+1]=s,z[t+2]=r,$C(i,s,r,D);const n=Z;Z=m,I.setValues(e,Math.round(n*g),Math.round(A*g))}{const e=w-M,t=l-u,i=t*(x-O),s=e*(N-G),r=-t*e,n=i*i+s*s+r*r;if(0===n)su(L,q,0,0,1,k);else{const e=1/Math.sqrt(n);su(L,q,i*e,s*e,r*e,k)}}++q}}}(e),s.edgeVerticesStartIndex=y,EC(e),SC(e),OC(s,[],a),e.intersectionData=null})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,i=this.renderData;let s=e,r=t;if(i){const e=i.geometry.boundingBox;s=e[2],r=e[5]}else if(!this.leaf){s=1/0,r=-1/0;for(const e of this.children){const t=e;s=Math.min(s,t._subtreeGeometryElevationBoundMin),r=Math.max(r,t._subtreeGeometryElevationBoundMax)}}if(s!==this._subtreeGeometryElevationBoundMin||r!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=s,this._subtreeGeometryElevationBoundMax=r;const e=this.parent;e?._updateSubtreeGeometryElevationsBounds()}}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){var e;e=this.renderData,this._horizontalScaleFactor,e.tile.intersectsClippingArea&&(MC(e),PC(e,!0),FC(e),e.intersectionData=null),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){var e;e=this.renderData,this._horizontalScaleFactor,e.tile.intersectsClippingArea&&(SC(e),FC(e),e.intersectionData=null),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){var e;e=this.renderData,this._horizontalScaleFactor,e.tile.intersectsClippingArea&&(IC(e),SC(e),FC(e),jC(e),e.intersectionData=null),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}}const XC=ke();class JC{constructor(){this.extent=ul(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let eT=class extends Oe{constructor(){super(...arguments),this._queries=new Xl({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new Xl({initialSize:30}),this._queryPool=new td(JC)}queryVisibleLevelRange(e,t,i,s){const r=this._queryPool.acquire();ll(r.extent,e),r.minLevel=t??-Number.MAX_VALUE,r.maxLevel=i??Number.MAX_VALUE,r.callback=s,this._queryQueue.push(r),this.notifyChange("updating")}get updating(){return 0!==this._queryQueue.length}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const s=this._queries.data[i],r=s.extent;t>=s.minLevel&&t<=s.maxLevel&&r[0]<=e.extent[2]&&r[2]>=e.extent[0]&&r[1]<=e.extent[3]&&r[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};e([Ce()],eT.prototype,"updating",null),eT=e([Se("esri.views.3d.terrain.ScaleRangeQueries")],eT);class tT extends nC{constructor(e,t,i,s,r){super(),this._convexHull=new Array(24),this._boundingSphere=$a(),this._baseUsedMemory=1816,this.init(e,t,i,s,r)}init(e,t,i,s,r){super.init(e,t,i,s,r);const n=this.ellipsoid.radius,a=this.extentInRadians[0],o=this.extentInRadians[1],l=this.extentInRadians[2],h=this.extentInRadians[3],c=Pi(o,h,.5),d=Pi(a,l,.5),u=0===e?0:Math.min(Math.abs(o),Math.abs(h));this._edgeLen=(l-a)*Math.cos(u)*n,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=n-Math.sqrt(n*n-this._edgeLen2/4),function(e,t,i,s){const r=Math.cos(i);e[0]=Math.cos(t)*r*s,e[1]=Math.sin(t)*r*s,e[2]=Math.sin(i)*s}(this.centerAtSeaLevel,d,c,this.ellipsoid.radius),Ni(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(0===this.lij[0])qi(Qa(e[1]),0,0,0),qi(e[0],0,0,0),qi(e[2],0,0,0),e[1][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[1],i=this.convexHull;let s=0;for(let e=0;e<8;++e)s=Math.max(s,sT(Qa(t),i,3*e));e[1][3]=Math.sqrt(s)}}_calculateFrustumVisibility(e){if(!rd(e,this._boundingSphere))return 2;if(this.lij[0]<10)return 1;const t=this.convexHull,i=this.surface.view.state.camera.near;let s=!0;for(let r=0;r<nd;r++){const n=4===r,a=e[r],o=a[0],l=a[1],h=a[2],c=a[3]-(n?i:0);let d=!1;for(let e=0;e<8;++e){const i=3*e;if(o*t[i]+l*t[i+1]+h*t[i+2]+c<0){if(d=!0,!s)break}else s=!1}if(!d)return 2}return s?0:1}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){(function(e,t){const{tile:i,geometry:s,geometryState:r}=e,{extentInRadians:n,surface:a}=i,{isWebMercator:o,renderer:l}=a,{numVerticesPerSide:h,wireframe:c}=r,d=h-1,u=(h-2)**2,p=o&&(2===t||3===t),m=o&&(1===t||3===t),_=6*((p?1:0)+(m?1:0))*h,f=QC(r),y=u+_+4*f,v=l.tileGeometryCache.acquire(y);s.numVerticesPerSide=h,s.vertexAttributes=v,s.maxEdgeVertexCount=f;const{boundingBox:b}=s;hh(b);const w=TC(e);qC.update(d,n,w),function(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:s,localOrigin:r}=e,{numVerticesPerSide:n,samplerData:a}=s,o=n-2,l=n-1,{vertexAttributes:h,boundingBox:c}=i,{position:d,uv0:u}=h,{typedBuffer:p,typedBufferStride:m}=h.normalCompressed,{extent:_}=t,f=_[0],y=_[2],v=_[1],b=_[3],w=t.ellipsoid.radius,x=r[0],C=r[1],T=r[2],S=d.typedBuffer,P=d.typedBufferStride,M=1/l;let R=0;if(1<=o){const e=M,t=v*(1-e)+b*e,i=qC.sinLatLUT[1],s=qC.cosLatLUT[1];for(let r=1;r<=o;r++){const n=r*M,o=f*(1-n)+y*n,l=qC.sinLonLUT[r],h=qC.cosLonLUT[r],d=w+Tw(o,t,a),p=d*h*s-x,m=d*l*s-C,_=d*i-T;$C(p,m,_,c);const v=(r-1)*P;S[v]=p,S[v+1]=m,S[v+2]=_,u.setValues(r-1,Math.round(n*g),Math.round(e*g))}}for(let e=1;e<=o;e++){const t=e*M,i=v*(1-t)+b*t,s=qC.sinLatLUT[e],r=qC.cosLatLUT[e],n=e+1,h=n*M,d=v*(1-h)+b*h,_=qC.sinLatLUT[n],O=qC.cosLatLUT[n],D=qC.sinLonLUT[0],A=qC.cosLonLUT[0],E=w+Tw(f,i,a);let I=A*r*E-x,L=D*r*E-C,k=s*E-T;const V=R*P;let F=S[V],j=S[V+1],z=S[V+2];for(let t=1;t<=o;t++){const n=t*M,b=f*(1-n)+y*n,D=qC.sinLonLUT[t],A=qC.cosLonLUT[t];let E=0,V=0,H=0;if(t<o){const e=(R+1)*P;E=S[e],V=S[e+1],H=S[e+2]}else{const e=qC.sinLonLUT[l],t=qC.cosLonLUT[l],n=w+Tw(y,i,a);E=t*r*n-x,V=e*r*n-C,H=s*n-T}const q=I,U=L,B=k;I=F,L=j,k=z,F=E,j=V,z=H;const N=E-q,G=V-U,W=H-B;let $=0,Q=0,Z=0;if(e>1){const e=(R-o)*P;$=S[e],Q=S[e+1],Z=S[e+2]}else{const e=qC.sinLatLUT[0],t=qC.cosLatLUT[0],i=w+Tw(b,v,a);$=A*t*i-x,Q=D*t*i-C,Z=e*i-T}const Y=w+Tw(b,d,a),K=A*O*Y-x,X=D*O*Y-C,J=_*Y-T;if(e<o){const e=R+o,t=e*P;S[t]=K,S[t+1]=X,S[t+2]=J,$C(K,X,J,c),u.setValues(e,Math.round(n*g),Math.round(h*g))}const ee=$-K,te=Q-X,ie=Z-J;let se=A*r,re=D*r,ne=s;ne*ne<.999&&(se=W*te-G*ie,re=N*ie-W*ee,ne=G*ee-N*te);const ae=1/Math.sqrt(se*se+re*re+ne*ne);su(p,R,se*ae,re*ae,ne*ae,m),++R}}}(e),s.poleVerticesStartIndex=u;const x=function(e,t,i){const{tile:s,localOrigin:r,geometry:n}=e,{extent:a,ellipsoid:o}=s,{boundingBox:l,numVerticesPerSide:h,vertexAttributes:c,poleVerticesStartIndex:d}=n,u=h-1,p=r[0],m=r[1],_=r[2],f=o.radius,y=a[1],v=a[3],b=[];let w=d;const x=(e,t)=>{const i=t*h;$C(-p,-m,e*f-_,l),b.push(new zC(1===e,i,1===e?0:2,w,6));const s=CC(-1===e?y:v,f),r=e*Math.PI/2-s,n=.99*(1===e?1:-1),a=f+0,{position:o,uv0:d}=c,{typedBuffer:x,typedBufferStride:C}=c.normalCompressed;for(let e=1;e<=6;++e){const t=s+r*(e/6),i=Math.cos(t),h=Math.sin(t);for(let e=0;e<=u;e++){const t=e/u,s=qC.sinLonLUT[e],r=qC.cosLonLUT[e]*i,c=s*i,f=h,y=r*a-p,v=c*a-m,b=f*a-_;$C(y,v,b,l),o.setValues(w,y,v,b),d.setValues(w,Math.round(t*g),Math.round(n*g)),su(x,w,r,c,f,C),++w}}};return t&&x(-1,0),i&&x(1,u),b}(e,p,m);s.edgeVerticesStartIndex=u+_,EC(e),bC(e),OC(s,x,c),e.intersectionData=null})(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),dc&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=Qa(e),i=this.elevationBoundsMin,s=this.elevationBoundsMax,r=this.ellipsoid.radius,n=s;if(0===this.level)qi(t,0,0,0),e[3]=r+n;else{const n=this.extentInRadians,a=.5*(n[0]+n[2]),o=n[1],l=n[3];nT(oT,a,o,r),nT(lT,a,l,r),Ki(t,oT,lT),Bi(t,t,(r+.5*(i+s))/ls(t));const h=this.convexHull;let c=0;const d=(e,t)=>{const i=e[0]-h[3*t],s=e[1]-h[3*t+1],r=e[2]-h[3*t+2];return Math.sqrt(i*i+s*s+r*r)};for(let e=0;e<8;++e){const i=d(t,e);c=Math.max(c,i)}const u=c;e[3]=u+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(0===this.level)return;const i=this.elevationBoundsMin,s=this.elevationBoundsMax,r=this._getPatchType(),n=this.surface.isWebMercator,a=n&&1===r,o=n&&2===r,l=o||a,h=Math.PI/2,c=e[0],d=e[2],u=o?-h:e[1],p=a?h:e[3],m=.5*(c+d),g=i,_=t+(l?Math.min(0,g-1):g),f=(e,t,i)=>nT(e,t,i,_),y=ke(),v=ke(),b=ke(),w=ke();f(y,c,u),f(v,c,p),f(b,d,p),f(w,d,u);const x=(e,t)=>{for(let i=0;i<3;++i)this._convexHull[3*t+i]=e[i]};x(y,0),x(v,1),x(b,2),x(w,3);const C=s,T=t+(l?Math.max(0,C+1):C),S=ke(),P=ke(),M=ke();nT(P,m,p,_),nT(M,m,u,_),Ki(S,P,M),Ni(S,S);const R=ke(),O=ke(),D=(e,t)=>{Ui(O,e,t),Ni(O,O);const i=-Gi(e,R)/Gi(O,R);ac(i>=0),Bi(O,O,i),Ki(e,e,O)};if(2**this.lij[0]>2*this.lij[1]){const e=M,t=ke();ss(t,aT,e),Ni(t,t),ss(R,e,t),Ni(R,R),ac(wc(Gi(R,e)/ls(e),0)),D(y,v),D(w,b),x(y,0),x(w,3)}else if(2**this.lij[0]!==2*this.lij[1]){const e=P,t=ke();ss(t,aT,e),Ni(t,t),ss(R,t,e),Ni(R,R),D(v,y),D(b,w),x(v,1),x(b,2)}const A=(e,t)=>{const i=T/Gi(t,S);for(let s=0;s<3;++s)this._convexHull[3*e+s]=t[s]*i};A(4,y),A(5,v),A(6,b),A(7,w)}_getPatchType(){const e=this.lij[1],t=0===e,i=e===(1<<this.level)-1;return t?i?3:1:i?2:0}intersectsRay(e,t,i,s){const r=this._boundingSphere,n=r[3]+i,a=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],o=r[0]-e[0],l=r[1]-e[1],h=r[2]-e[2],c=(o*t[0]+l*t[1]+h*t[2])/a,d=t[0]*c-o,u=t[1]*c-l,p=t[2]*c-h;return d*d+u*u+p*p<n*n}get minimumVerticesPerSide(){return this.level<iT.length?iT[this.level]+1:2}updateCornerElevations(){var e;(e=this.renderData).tile.intersectsClippingArea&&(xC(e),wC(e,!0),FC(e),e.intersectionData=null),this._updateBoundingVolumes()}updateEdgeElevations(){var e;(e=this.renderData).tile.intersectsClippingArea&&(bC(e),FC(e),e.intersectionData=null),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){var e;(e=this.renderData).tile.intersectsClippingArea&&(IC(e),bC(e),FC(e),jC(e),e.intersectionData=null),this._updateBoundingVolumes()}_checkBVs(){if(!dc)return;if(this.level<=2)return;const e=this._boundingSphere,t=e[3],i=Qa(e),s=ke(),r=this.ellipsoid.radius,n=this.elevationBoundsMin,a=this.elevationBoundsMax,o=r+n,l=this._center[1][3],h=this.convexHull,c=(e,t)=>{for(let i=0;i<3;++i)e[i]=h[3*t+i]};{const e=ke(),t=ke(),i=ke(),s=ke(),r=ke(),n=(n,a,o,l)=>{c(t,n),c(i,a),c(s,o),Ui(t,t,i),Ui(s,s,i),ss(e,t,s),Ni(e,e);const h=Gi(e,i);c(r,l);const d=Gi(e,r),u=Math.abs(d-h);ac(wc(u,0),`Non coplanar ${n},${a},${o},${l} diff = ${u}`)};n(0,1,2,3),n(4,5,6,7),n(0,1,4,5),n(1,2,5,6),n(2,3,6,7),n(3,0,7,4)}const d=yu(24),u=ke(),p=ke(),m=ke(),g=ke(),_=(e,t,i,s)=>{c(u,t),c(p,i),c(m,s),Ui(u,u,p),Ni(u,u),Ui(m,m,p),Ni(m,m),ss(g,u,m),Ni(g,g);const r=Gi(g,p);((e,t,i)=>{const s=4*e;for(let e=0;e<3;++e)d[s+e]=t[e];d[s+3]=i})(e,g,r)};_(0,0,1,2),_(1,1,0,4),_(2,1,5,2),_(3,3,2,6),_(4,4,0,3),_(5,4,6,5);const f=(e,t,i,s)=>{const r=4*e;return d[r]*t+d[r+1]*i+d[r+2]*s-d[r+3]},y=(e,t,i,s)=>f(e,t,i,s)>=-1,v=(e,t)=>y(e,t[0],t[1],t[2]),b=2**this.lij[0]>2*this.lij[1],w=(e,s,r)=>Math.sqrt(rT(e,s,r,i[0],i[1],i[2]))<t,x=e=>w(e[0],e[1],e[2]),C=(e,t)=>w(e[t],e[t+1],e[t+2]),T=this.extentInRadians,S=.5*(T[0]+T[2]),P=T[1],M=T[3],R=ke(),O=ke();nT(R,S,M,o),nT(O,S,P,o);const D=b?"Upper":"Lower";let A=!0;for(let e=0;e<6;++e){for(let t=0;t<8;++t){const i=3*t,s=y(e,h[i],h[i+1],h[i+2]);A&&=s,ac(s,`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}ac(v(e,O),`Tile[${this.lij}] (${D}) bottom mid outside of plane ${e}`),ac(v(e,R),`Tile[${this.lij}] (${D}) top mid outside of plane ${e}`)}ac(A,"Not all convex hull points are inside  convex hull polyhedron"),ac(x(O),`Tile[${this.lij}] (${D}) bottom mid outside of bounding sphere`),ac(x(R),`Tile[${this.lij}] (${D}) top mid outside of bounding sphere`);for(let e=0;e<8;++e){const t=C(h,3*e);ac(t,`Tile[${this.lij}] Convex hull point ${e} outside of bounding sphere`)}for(let e=0;e<6;++e)for(let t=0;t<8;++t){const i=3*t;y(e,h[i],h[i+1],h[i+2])||console.error(`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}const{extentInRadians:E}=this,I=Math.max(E[2]-E[0],E[3]-E[1]),L=Math.round(I*r),{renderData:k}=this;if(!k)return;const{geometry:V,geometryState:F,localOrigin:j}=k,z=V.vertexAttributes?.position;if(!z)return;const H=ke(),q=V.numVerticesPerSide-2,{indices:U,indexCount:B,edgeVerticesStartIndex:N,poleVerticesStartIndex:G}=V;if(!U)return;const W=new Set;for(let e=0;e<B;++e){const o=U[e];if(W.has(o))continue;W.add(o);const h=o<G,c=o>=N;let d=!1,u=-1;if(c){let e=N;for(let t=0;t<4;++t){const i=F.edgeResolutions[t];if(o===e||o===e+i-1){d=!0;break}if(e+=i,o<e){u=t;break}}}const p=c?F.edgePeerNeighbors[u]:null,m=c&&p&&Rx(this,p)>0;z.getVec(o,s),Ki(H,s,j);const g=ls(H)-r;let _=0,v=!1;const b=n-g,w=g-a,x=b>1,C=w>1,T=x||C,S=()=>{const e=h?"internal":c&&!d?"edge":d?"corner":"pole";return`Tile[${this.lij}].vertex[${o}]:${e}`+(x?"(below)":C?"(above)":"")+(m?"(Neighbor)":"")},P=os(H,i);if(P>=t+0){const e=P-t;T||(console.error(`${S()} is out of the bounding sphere by ${e.toFixed(0)} / ${t.toFixed(0)}[tol=0] h=${g.toFixed(0)} / [${n.toFixed(0)}..${a.toFixed(0)}] (${(e/t).toFixed(0)})`),v=!0)}for(let e=0;e<6;++e)if(!y(e,H[0],H[1],H[2])){const i=f(e,H[0],H[1],H[2]),s=o%q,r=(o-s)/q;0===e&&b||5===e&&w||(console.error(`${S()} (${s},${r})|${q}] is out of the bounding trapezoid plane ${e} h=${Math.round(g)} / [${Math.round(n)}..${Math.round(a)}] dist=${Math.round(i)} radii = ${Math.round(t)}/${Math.round(l)}} : maxL = ${L}`),++_)}if(v||_>0)break}}get convexHull(){return this._convexHull}}const iT=[128,64,64,32,16,8,8,4];function sT(e,t,i){return rT(e[0],e[1],e[2],t[i],t[i+1],t[i+2])}function rT(e,t,i,s,r,n){const a=s-e,o=r-t,l=n-i;return a*a+o*o+l*l}const nT=(e,t,i,s)=>{const r=Math.cos(t),n=Math.sin(t),a=Math.cos(i),o=Math.sin(i);e[0]=s*a*r,e[1]=s*a*n,e[2]=s*o},aT=[0,0,1],oT=ke(),lT=ke();let hT=class extends Oe{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};e([Ce()],hT.prototype,"fovX",void 0),e([Ce()],hT.prototype,"fovY",void 0),e([Ce()],hT.prototype,"relativeWidthLimit",void 0),e([Ce()],hT.prototype,"relativeHeightLimit",void 0),e([Ce()],hT.prototype,"maxLod",void 0),e([Ce()],hT.prototype,"angledSplitBias",void 0),e([Ce()],hT.prototype,"aboveGround",void 0),e([Ce()],hT.prototype,"frustum",void 0),hT=e([Se("esri.views.3d.terrain.SplitLimits")],hT);const cT=ta().vec3f("position").vec2u16("uv0",{glNormalized:!0}).vec2i16("normalCompressed",{glNormalized:!0});class dT{constructor(e){this._storage=new fw((t,i)=>e.newCache(t,i),"TileGeometry")}acquire(e){const t=4*Math.ceil(e/4),i=this._storage,s=function(e){return e.toString()}(t),r=i.pop(s);if(r)return r;const n=cT.createBuffer(t);return n.release=()=>i.put(s,n),n}clear(){this._storage.clear()}destroy(){this._storage.destroy()}}function uT(e){return Vt(e.layer)}class pT extends xr{constructor(){super(...arguments),this.scale=1,this.offset=Qs}}function mT(e){e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.uniforms.add(new lr("scale",e=>e.scale),new tr("offset",e=>e.offset)).main.add(br`gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;`)}function gT(e){e.code.add(br`
    float lineFactorAtPosition(float value) {
      float pos = value * ${br.float(257)};
      if(pos < 0.5 || pos > ${br.float(256.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}function _T(e,t){const i=t.blendMode;0!==i&&(30===i&&e.code.add(br`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),6!==i&&13!==i||e.code.add(br`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),9!==i&&13!==i||e.code.add(br`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),10===i&&e.code.add(br`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),12===i&&e.code.add(br`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),11===i&&e.code.add(br`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),13===i&&e.code.add(br`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),14!==i&&15!==i&&17!==i&&16!==i||(e.code.add(br`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),14!==i&&15!==i||e.code.add(br`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),e.code.add(br`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${8===i?br`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:1===i?br`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:2===i?br`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:7===i?br`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:3===i?br`return vec4(cl * ol + cb * ob, ol + ob);`:4===i?br`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:28===i?br`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:5===i?br`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:26===i?br`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:29===i?br`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:18===i?br`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:19===i?br`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:21===i?br`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:22===i?br`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:24===i?br`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:25===i?br`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:20===i?br`return vec4(cb * ob * ol, ol * ob);`:23===i?br`return vec4(cl * ol * ob, ol * ob);`:14===i?br`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:15===i?br`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:17===i?br`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:16===i?br`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:27===i?br`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:30===i?br`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:6===i?br`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:9===i?br`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:10===i?br`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:11===i?br`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:12===i?br`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:13===i?br`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:br``}
    }
  `))}function fT(e,t){const{output:i,blendMode:s,baseOpacityMode:r,premultipliedSource:n}=t,a=e.fragment,o=1===r;o&&a.uniforms.add(new lr("baseOpacity",e=>e.baseOpacity));const l=0!==s,h=!(l||1===n||(1!==i||o)&&4!==i);a.include(_T,t);let c="";switch(i){case 4:case 0:c=br`vec4(0.0)`;break;case 2:a.uniforms.add(new cr("backgroundColor",e=>e.backgroundColor)),c=br`vec4(backgroundColor, 1.0)`;break;case 3:a.include(gT),c=br`vec4(gridColor(uv), 1.0)`;break;case 1:a.uniforms.add(new hr("fboColor",e=>e.fboTexture)),c=br`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`}a.code.add(br`
    vec4 getBackground(vec2 uv) {
      return ${wr(o,br`baseOpacity *`)} ${c};
    }

    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {
      ${l?br`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec4 bgColor = getBackground(bgUV);
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:br`
          float composeAlpha = colorLayer.a * opacity;
          ${h?br`return colorLayer * opacity;`:br`
            vec4 bgColor = getBackground(bgUV);
            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}const yT=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new mn,i=t.fragment;if(t.include(mT),1===e.background){const s=2===e.output;return s?i.uniforms.add(new cr("backgroundColor",e=>e.backgroundColor)):i.include(gT),i.main.add(br`fragColor = vec4(${s?br`backgroundColor`:br`gridColor(uv)`}, 1.0);`),t}return t.include(fT,e),i.uniforms.add(new hr("tex",e=>e.texture),new lr("opacity",e=>e.opacity)),i.main.add(br`fragColor = blendLayers(uv, texture(tex, uv), opacity);`),t}},Symbol.toStringTag,{value:"Module"}));class vT extends pT{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=Ue}}class bT extends Tr{constructor(e,t){super(e,t,new Sr(yT,()=>Promise.resolve().then(()=>yT)),na(sr))}}const wT=Tu();class xT{constructor(){this._renderParams={reshuffleManager:new Du,context:null,drawPhase:1,state:new CT,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new Ou(new bu(0,0,0,0),0,0,0,xu,xu,wu,wu),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,i,s,r,n,a,o,l,h){const c=this._backgroundTile;this._updateRenderParameters(e,t,c,i,r,n,a,o,l,h),this._renderParams.stencilSymbols=!1,i.drawBackground(this._renderParams,c,s)}renderContent(e,t,i,s,r,n,a,o,l,h,c,d){this._declutter(i),s.forAll(({sourceLayerInfo:{data:e}})=>this._declutter(e));const u=s.length>0;u&&this._stencilSymbols(e,t,i,s,r,n,a,o,l,h,c,d);let p=1;i.stencilRef=u?p:0,e.setStencilFunction(514,i.stencilRef,255),this._render(e,t,i,r,n,a,o,l,h,c,d),s.forAll(({sourceLod:t,offset:i,sourceLayerInfo:{data:s}})=>{s.stencilRef=++p,this._renderSymbols(e,t,s,r,n,a,o,i,h,c,d)})}_stencilSymbols(e,t,i,s,r,n,a,o,l,h,c,d){let u=1;i.stencilRef=u,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,i.stencilRef,255),this._stencilTileSymbols(e,t,i,r,n,a,o,l,h,c,d),s.forAll(({sourceLod:t,offset:i,sourceLayerInfo:{data:s}})=>{s.stencilRef=++u,e.setStencilFunction(519,s.stencilRef,255),this._stencilTileSymbols(e,t,s,r,n,a,o,i,h,c,d)}),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,i,s,r,n,a,o,l,h,c){e.setStencilFunction(514,i.stencilRef,255),this._render(e,t,i,s,r,n,a,o,l,h,c,3)}_render(e,t,i,s,r,n,a,o,l,h,c,d){this._updateRenderParameters(e,t,i,s,n,a,o,l,h,c),this._renderParams.stencilSymbols=!1,s.drawTile(this._renderParams,i,r,d)}_stencilTileSymbols(e,t,i,s,r,n,a,o,l,h,c){this._updateRenderParameters(e,t,i,s,n,a,o,l,h,c),this._renderParams.stencilSymbols=!0,i.triangleCount=0,s.drawSymbols(this._renderParams,i,r)}_updateRenderParameters(e,t,i,s,r,n,a,o,l,h){"type"in i&&"vector-tile"===i.type&&!i.stage&&i.attachWithContext(e);const c=t[0]-r.getLevelShift(t[0]),d=this._renderParams;d.context=e,d.painter=s,d.glyphMosaic=s.glyphMosaic,d.spriteMosaic=s.spriteMosaic,d.pixelRatio=l*h,d.displayLevel=c,d.requiredLevel=c;const u=r.getScale(t[0]),[p,m]=r.getOffset(t,n*u),g=Cu*n*u/o,_=i.transforms.displayViewScreenMat3;_[0]=g,_[4]=-g,_[6]=-1-p-a[0]*n*2,_[7]=1+m+(1-a[1])*n*2-2;const f=d.state,y=o/h;f.size[0]=y,f.size[1]=y,f.pixelRatio=h,f.rotation=(360-this._heading)%360;const v=2/y;ys(f.displayViewMat3,v,0,0,0,-v,0,-1,1,1);const b=ms(f.displayMat3),w=vu(this._heading);gs(b,b,[y/2,y/2]),_s(b,b,w),gs(b,b,[-y/2,-y/2]),vs(b,f.displayViewMat3,b)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(function(e,t){const i=e.transforms.tileUnitsToPixels,s=vu(t),r=Math.cos(s),n=Math.sin(s),a=Math.ceil(512*(Math.abs(n)+Math.abs(r)));ms(wT),gs(wT,wT,[a/2,a/2]),_s(wT,wT,s),gs(wT,wT,[-256,-256]),fs(wT,wT,[1/8,1/8,1]),e.transforms.tileUnitsToPixels=wT;const o=[],l=new Su(wu,o),h=new Pu("vector-tile",o,l,null,(i,s,r)=>new Mu(i,s,r,e.styleRepository,e.key.level,t),(e,t)=>{Ru(e,t,!1)},()=>0,t=>{const i=e.styleRepository.getStyleLayerByUID(t).getLayoutProperty("visibility");return!i||1!==i.getValue()});o.push(e),l.registerVectorTile(e),h.setScreenSize(a,a),h.continue(1/0),l.unregisterVectorTile(e),e.transforms.tileUnitsToPixels=i}(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}}class CT{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=Xs(),this.displayViewMat3=Xs(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}}class TT extends Mr{constructor(){super(...arguments),this.blendMode=0}}e([Pr({count:31})],TT.prototype,"blendMode",void 0);class ST extends TT{constructor(){super(...arguments),this.output=1,this.baseOpacityMode=0,this.premultipliedSource=0}}e([Pr({count:5})],ST.prototype,"output",void 0),e([Pr({count:2})],ST.prototype,"baseOpacityMode",void 0),e([Pr({count:2})],ST.prototype,"premultipliedSource",void 0);class PT extends ST{constructor(){super(...arguments),this.background=0}}function MT(e){e.fragment.uniforms.add(new hr("u_colormap",e=>e.u_colormap),new lr("u_colormapOffset",e=>e.colormap.u_colormapOffset),new lr("u_colormapMaxIndex",e=>e.colormap.u_colormapMaxIndex),new lr("u_opacity",e=>e.common.u_opacity)),e.fragment.code.add(br`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}function RT(e){e.fragment.uniforms.add(new hr("u_transformGrid",e=>e.u_transformGrid),new tr("u_transformSpacing",e=>e.common.u_transformSpacing),new tr("u_targetImageSize",e=>e.common.u_targetImageSize)),e.fragment.code.add(br`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}e([Pr({count:2})],PT.prototype,"background",void 0);class OT extends pT{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}}function DT(e,t){e.include(RT),e.fragment.uniforms.add(new hr("u_image",e=>e.u_image),new Yp("u_flipY",e=>e.common.u_flipY),new Yp("u_applyTransform",e=>e.common.u_applyTransform));const{requireBilinearWithNN:i}=t;i&&e.fragment.uniforms.add(new tr("u_srcImageSize",e=>e.common.u_srcImageSize)),e.fragment.code.add(br`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),i?e.fragment.code.add(br`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):e.fragment.code.add(br`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}class AT extends OT{constructor(e,t,i,s,r,n){super(e,s,r),this.colormap=t,this.symbolizer=i,this.u_colormap=n,this.backgroundColor=Ue,this.fboTexture=null,this.baseOpacity=1}}const ET=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:class extends AT{},ColorizerStretchUniforms:class extends AT{},ColorizerUniforms:AT,build:function(e){const t=new mn;return t.include(mT),t.include(DT,e),t.include(MT,e),t.include(fT,e),t.fragment.code.add(br`vec4 applyBackgroundBlend(vec4 layerColor) {
return blendLayers(vuv, layerColor, u_opacity);
}`),0===e.colorizerType?function(e,t){e.fragment.uniforms.add(new La("u_bandCount",e=>e.symbolizer.u_bandCount),new Vr("u_minCutOff",e=>e.symbolizer.u_minCutOff,3),new Vr("u_maxCutOff",e=>e.symbolizer.u_maxCutOff,3),new Vr("u_factor",e=>e.symbolizer.u_factor,3),new lr("u_minOutput",e=>e.symbolizer.u_minOutput),new lr("u_maxOutput",e=>e.symbolizer.u_maxOutput),new Yp("u_useGamma",e=>e.symbolizer.u_useGamma),new Vr("u_gamma",e=>e.symbolizer.u_gamma,3),new Vr("u_gammaCorrection",e=>e.symbolizer.u_gammaCorrection,3),new lr("u_opacity",e=>e.common.u_opacity)),e.fragment.code.add(br`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?br`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:br`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;e.fragment.main.add(br`
    vec2 pixelLocation = getPixelLocation(uv);
    if (isOutside(pixelLocation)) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }

    vec4 currentPixel = getPixel(pixelLocation);
    ${0===t.stretchType?br`fragColor = applyBackgroundBlend(currentPixel);`:br`
    if (currentPixel.a == 0.0) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }
    if (u_bandCount == 1) {
      float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      ${i}
    } else {
      float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
      float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
      fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
    }`}`)}(t,e):1===e.colorizerType?function(e){e.fragment.main.add(br`vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));`)}(t):2===e.colorizerType&&function(e,t){const i=e.fragment;i.uniforms.add(new hr("u_image",e=>e.u_image),new La("u_hillshadeType",e=>e.symbolizer.u_hillshadeType),new Vr("u_sinZcosAs",e=>e.symbolizer.u_sinZcosAs,6),new Vr("u_sinZsinAs",e=>e.symbolizer.u_sinZsinAs,6),new Vr("u_cosZs",e=>e.symbolizer.u_cosZs,6),new Vr("u_weights",e=>e.symbolizer.u_weights,6),new tr("u_factor",e=>e.symbolizer.u_factor),new lr("u_minValue",e=>e.symbolizer.u_minValue),new lr("u_maxValue",e=>e.symbolizer.u_maxValue),new tr("u_srcImageSize",e=>e.common.u_srcImageSize)),i.include(Fr),i.code.add(br`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),i.code.add(br`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const s=t.applyColormap?br`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:br`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;i.main.add(br`
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${s}`)}(t,e),t}},Symbol.toStringTag,{value:"Module"}));class IT extends Tr{constructor(e,t){super(e,t,new Sr(ET,()=>Promise.resolve().then(()=>ET)),na(sr))}}class LT extends ST{constructor(){super(...arguments),this.colorizerType=0,this.stretchType=0,this.applyColormap=!0,this.requireBilinearWithNN=!1}}e([Pr({count:3})],LT.prototype,"colorizerType",void 0),e([Pr({count:2})],LT.prototype,"stretchType",void 0),e([Pr()],LT.prototype,"applyColormap",void 0),e([Pr()],LT.prototype,"requireBilinearWithNN",void 0);class kT{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const i=new Pn(this._rctx,new On(e),new Rn(Gn.DEPTH24_STENCIL8,e));return this._fbos.set(e,i),i}}function VT(e,t=0,i=-1,s=1){const r=1===t,n=r?Xh?new Float32Array([i,i,0,s,i,0,i,s,0,s,s,0]):new Float32Array([i,i,0,0,s,i,1,0,i,s,0,1,s,s,1,1]):new Float32Array([i,i,s,i,i,s,s,s]);if(r&&Xh){const e=Jh(n.buffer);e[10]=e[17]=e[22]=e[23]=1}return new ra(e,new oa(e,r?Xh?sr:rr:nr,n))}function FT(e){const t=new On(4);return t.samplingMode=9728,new An(e,t)}class jT{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new xT,this._bindParameters=new da(null),this._blendConfiguration=new PT,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vao=VT(this._rctx,1)}dispose(){this._fbos.forEach(M),this._fbos=null,this._vtFBO=M(this._vtFBO),this._vao=M(this._vao),this._vectorTileHelper=M(this._vectorTileHelper)}updateHeading(e){this._vectorTileHelper?.updateHeading(e)}_acquireBlendTechnique(e,t,i,s=0,r=0){return this._blendConfiguration.output=t,this._blendConfiguration.blendMode=e,this._blendConfiguration.baseOpacityMode=i,this._blendConfiguration.premultipliedSource=s,this._blendConfiguration.background=r,this._techniques.precompile(bT,this._blendConfiguration),this._techniques.get(bT,this._blendConfiguration)}drawBackground(e,t){const i=this._acquireBlendTechnique(0,t?2:3,0,0,1),s=this._rctx.bindTechnique(i,this._bindParameters,e);this._render(s)}_render(e){this._rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),this._rctx.drawArrays(Un.TRIANGLE_STRIP,0,this._vao.vertexCount("geometry"))}drawGroup(e,t,i,s,r=1){1===t&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture)),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const n=e.baseOpacity<1?1:0,a=this._acquireBlendTechnique(s,t,n,r),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawImageData(e,t,i,s,r=0){if(null==e.texture)return;const n=e.baseOpacity<1?1:0;e.fboTexture=4===t||0===s&&0===n&&0===r?null:this.switch(i).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture);const a=this._acquireBlendTechnique(s,t,n,r),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawRasterData(e,t,i,s,r){const n=r.sourceLayerInfo.data;if(!n.source)return;if(r.tile.surface.layerViewByIndex(r.layerIndex,1).ensureSymbolizerParameters(n),!n.bind(this._rctx))return;const a=e.baseOpacity<1?1:0;e.fboTexture=0===s&&0===a?null:this.switch(i).colorTexture;const o=this._acquireRasterTechnique(n,t,s,a);if(!o)return;n.opacity=e.opacity;const l=n.getUniforms(this._rctx);l.scale=r.scale,l.offset=r.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;const h=this._rctx.bindTechnique(o,this._bindParameters,l);this._render(h)}_acquireRasterTechnique(e,t,i,s){if(!this._rctx.capabilities.colorBufferFloat)return null;const r=e.symbolizerParameters,n=["stretch","lut","hillshade"].indexOf(r.type);return this._rasterConfiguration??=new LT,this._rasterConfiguration.output=t,this._rasterConfiguration.blendMode=i,this._rasterConfiguration.baseOpacityMode=s,this._rasterConfiguration.colorizerType=n,this._rasterConfiguration.applyColormap=!!r.colormap,this._rasterConfiguration.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterConfiguration.stretchType=e.hasStretchTypeNone()?0:1,this._techniques.precompile(IT,this._rasterConfiguration),this._techniques.get(IT,this._rasterConfiguration)}drawVectorData(e,t,i,s,r,n,a,o){const l=this._rctx,h=r.sourceLayerInfo.data,c=r.tile.surface.layerViewByIndex(r.layerIndex,1),d=e.baseOpacity<1?1:0,u=1===d||e.opacity<1||0!==s||1!==t,p=u?1:0,m=this._acquireBlendTechnique(s,t,d,p);l.setPipelineState(m.getPipeline());let g=null,_=null;u?(_=this.currentFBO(i),null==this._vtFBO&&(this._vtFBO=new kT(this._rctx)),g=this._vtFBO.get(i),l.bindFramebuffer(g),this._clearCurrentFBO()):o&&l.clear(256);try{this._vectorTileHelper.renderBackground(l,r.sourceLod,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/r.scale),r.offset,a,n,c.contentZoom),h&&this._vectorTileHelper.renderContent(l,r.sourceLod,h,r.vtlNeighborInfos,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/r.scale),r.offset,a,n,c.contentZoom)}catch(e){C.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",e)}return!g||(l.bindFramebuffer(_),e.texture=g.colorTexture,e.offset=Qs,e.scale=1,this.drawImageData(e,t,i,s,p),o)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,An.TEXTURE_UNIT_FOR_UPDATES),s=e.descriptor;t.gl.copyTexImage2D(3553,0,s.pixelFormat,0,0,s.width,s.height,0),e.generateMipmap(),t.bindTexture(i,An.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(17664)}_initFBO(e,t,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,i=!0){if(this._current=t,t>=this._fbos.length)for(let e=this._fbos.length;e<=t;e++)this._fbos.push(new kT(this._rctx));this._initFBO(this._fbos[t].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}}class zT{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}}class HT{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1,this._texture.descriptor.context.instanceCounter.increment(Wn.TileTexture,this)}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&(this._cache?(this._texture.abortCompression(),this._cache.put(qT(this.descriptor),this)):this.dispose())}dispose(){this._texture.descriptor.context.instanceCounter.decrement(Wn.TileTexture,this),this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get cachedMemory(){return this._texture.usedMemory}}function qT(e,t=En(e.internalFormat)){return`${e.width} ${e.pixelFormat} ${t}`}const UT={normal:0,average:1,lighten:2,lighter:3,screen:5,plus:4,"color-dodge":6,darken:7,multiply:8,"color-burn":9,overlay:10,"soft-light":11,"hard-light":12,"vivid-light":13,hue:14,saturation:15,luminosity:16,color:17,difference:26,exclusion:27,minus:28,invert:29,reflect:30,"destination-over":18,"destination-atop":19,"destination-in":20,"destination-out":21,"source-atop":22,"source-in":23,"source-out":24,xor:25};function BT(e){return 18===e||19===e||20===e||21===e||22===e||23===e||24===e||25===e}function NT(e,t){let i=t.width,s=t.height;return(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(i=e.width,s=e.height),(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof Uint8Array)&&(6408===t.pixelFormat||6407===t.pixelFormat)&&Di(i)&&Di(s)&&i>=16&&s>=16}class GT extends Eu{constructor(e){super("TextureCompressionWorker","compress",{compress:e=>[e.data]},e)}async destroyWorkerAndSelf(){await this.broadcast({},"destroy"),this.destroy()}isCompressible(e,t){return NT(e,t)}}class WT{constructor(e,t,i,s,r,n){this.start=e,this.end=t,this.blendMode=i,this.opacity=s,this.output=r,this.baseOpacity=n}}class $T{constructor(e,t,i,s,r){this._rctx=e,this.tileSize=t,this._techniques=i,this._cache=s,this._compressionTracker=r,this._passParameters=new vT,this._backgroundColor=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new jT(this._rctx,this._techniques)}dispose(){this._compositor=M(this._compositor),this._backgroundTexture=O(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,s=i.baseOpacity;let r=0,n=0,a=this.tileSize,o=!1,l=!1;const h=i.view.state.contentPixelRatio;let c=!1;XT.clear(),JT.length=0;const d=e.layerInfo[1];let u=0,p=null;for(;u<d.length;u++){const t=i.layerViewByIndex(u,1),m=t.layer,g=!Mx(e,t),_=m.opacity,f=t.fullOpacity;if(l=l||Ft(m),uT(t))continue;if(vc(t)){let e="normal"!==t.layer.blendMode;if(kt(m.parent)){const t=m.parent.uid;null!=t&&""!==t&&(e=YT(m.parent)||e)}e&&(c=e,o=!1)}if((g||0===_)&&!c){d[u].pendingUpdates&=-1;continue}++n;const y=Oc(t),v=QT(e,u,y);if(v){if(d[u].pendingUpdates&=-1,kt(m.parent)){const e=m.parent.uid;null!=e&&""!==e&&KT(m.parent,u)}y?a=Math.max(a,this.tileSize*h):1===s&&1===f&&(t.isOpaque||this._dataToTexture(v,jt(m))&&v.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++r,null===p&&(p=u)}}const m=a/this.tileSize;0!==r&&null!==p?1===r&&!c&&this._useLayerTexture(e,p)||this._composeLayers(e,t,u-1,l,a,m,!o||c,XT,c):this._useBackgroundTexture(e,n,0!==t)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundTexture&&this._drawBackgroundTexture(this._backgroundTexture))}_ensureBackgroundTexture(){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(this.tileSize,!1),this._drawBackgroundTexture(this._backgroundTexture)),this._backgroundTexture}_drawBackgroundTexture(e){this._compositor.bind(this.tileSize),this._passParameters.offset=Qs,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(e),this._compositor.unbind()}_useBackgroundTexture(e,t,i){const s=e.renderData,r=!i&&null!=s.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?5e3:0,n=this._ensureBackgroundTexture();s.setTextureReference(new Cx(n,0,tS,e.surface.baseOpacity,0,1),r)}_useLayerTexture(e,t){const i=e.surface.layerViewByIndex(t,1),s=Ft(i.layer),r=s?e.surface.baseOpacity:1,n=s?1:e.surface.baseOpacity,a=i.fullOpacity,o=QT(e,t,!1);return!!this._dataToTexture(o,jt(i.layer))&&(e.renderData.setTextureReference(new Cx(o.sourceLayerInfo.data,0,pl(o.offset[0],o.offset[1],o.scale,o.scale),r,n,a)),!0)}_composeLayers(e,t,i,s,r,n,a,o,l){this._compositor.ensureBuffer(r);const h=e.surface.baseOpacity;let c=!1,d=9987,u=!1,p=0;for(let t=i;t>=0;t--){const i=e.surface.layerViewByIndex(t,1),m=i.layer,g=Oc(i),_=QT(e,t,g),f=m.opacity,y=!Mx(e,i);if(!_||(0===f||y)&&!l)continue;if(uT(i))continue;const v=!Ft(m)&&!c;v&&(c=!0);let b=!1;o.forEach(e=>{e.start===t&&(e.output=s?1:a&&v?this.backgroundIsGrid?3:2:1,e.baseOpacity=v?h:1,JT.push(e),this._compositor.openGroup(r),b=!0)});const w=b?4:a&&0===p?this.backgroundIsGrid?3:2:1,x=UT[vc(i)?i.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=v&&!b&&h<1?h:1,this._passParameters.opacity=f,Dc(_)?u=this._compositor.drawVectorData(this._passParameters,w,r,x,_,n,this.tileSize,u):Ac(_)?(this._compositor.drawRasterData(this._passParameters,w,r,x,_),ZT(_)&&(d=9728)):this._dataToTexture(_,jt(m))&&(this._passParameters.texture=_.sourceLayerInfo.data.texture,this._passParameters.offset=_.offset,this._passParameters.scale=_.scale,this._compositor.drawImageData(this._passParameters,w,r,x));JT.length>0&&JT[JT.length-1].end===t;){const e=JT.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=Qs,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,e.output,r,UT[e.blendMode])}p++}const m=e.renderData,g=l||c&&h<1,_=m.ensureTexture(r,g,t,()=>this._buildTexture(r,g,d));this._compositor.copyFBOToTexture(_),this._compositor.unbind(),m.setTextureReference(new Cx(_,t,tS,c?1:h,0,1))}_dataToTexture(e,t){if(Ec(e)){const i=e.sourceLayerInfo,s=1===e.scale&&!t;i.data=this._buildTexture(i.data,!0,s,e.tile.onCompressionFinished),e.tile.setMemoryDirty()}return Ic(e)}_buildTexture(e,t,i=9987,s=()=>{}){if(null==e)return null;const r=new On;r.wrapMode=33071,r.samplingMode="boolean"==typeof i?9987:i,r.maxAnisotropy=this._maxAnisotropy,r.preMultiplyAlpha=!0,r.flipped=!0,r.hasMipmap=!0,t||(r.pixelFormat=6407);const n=this._rctx,a="boolean"==typeof i&&i;let o;if("number"==typeof e)r.width=r.height=e,o=this._buildTileTexture(r);else if(sc(e))r.isOpaque=e.isOpaque,r.isOpaque&&(r.pixelFormat=6407),r.width=e.element.width,r.height=e.element.height,o=this._buildTileTexture(r,a,s,e.element);else try{r.width=e.width,r.height=e.height,o=this._buildTileTexture(r,a,s,e)}catch(e){o=new HT(FT(n)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const l=n.bindTexture(o.texture,An.TEXTURE_UNIT_FOR_UPDATES);return o.generateMipmap(),n.bindTexture(l,An.TEXTURE_UNIT_FOR_UPDATES),o}_buildTileTexture(e,t=!1,i=()=>{},s){const r=this._cache.pop(qT(e,!1))??this._cache.pop(qT(e,!0));if(t&&=NT(s,e),r)return r.retain(),t?r.texture.enableCompression({compressionTracker:this._compressionTracker,compressionCallback:i}):r.texture.disableCompression(),r.texture.setData(s),r;e.compress=t?{compressionTracker:this._compressionTracker,compressionCallback:i}:void 0;const n=new An(this._rctx,e,s);return new HT(n,this._cache)}get test(){}}function QT(e,t,i){eS.layerIndex=t,eS.vtlNeighborInfos.clear();const s=e.layerInfo[1][t];if(Hs(eS.offset,0,0),eS.tile=e,eS.scale=1,eS.sourceLod=e.lij,eS.sourceLayerInfo=s,eS.isVTLBackground=i,s.data)return i&&e.forEachLoadedNeighbor((i,r)=>{if(i.level!==e.level)return;const n=i.layerInfo[1][t];if(!Lc(n)||s.data===n.data)return;const a=eS.vtlNeighborInfos.pushNew();a.offset=iS[r],a.sourceLod=i.lij,a.sourceLayerInfo=n}),eS;const r=s.upsampleInfo,n=r?.tile?.layerInfo[1][t];return n&&r.tile?(eS.tile=r.tile,Us(eS.offset,r.offset),eS.scale=r.scale,eS.sourceLod=r.tile.lij,eS.sourceLayerInfo=n,eS):i?eS:null}function ZT(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}function YT(e){let t="normal"!==e.blendMode;return kt(e.parent)&&(t=YT(e.parent)||t),t}function KT(e,t){kt(e.parent)&&KT(e.parent,t);const i=e.uid;if(null!=i&&""!==i){const s=XT.get(i);s?s.start=t:XT.set(i,new WT(t,t,e.blendMode,e.opacity,1,1))}}const XT=new Map,JT=new Array,eS=new class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new Xl({allocator:e=>e||new zT})}},tS=pl(0,0,1,1),iS=new Array;iS[0]=[0,-1],iS[1]=[-1,-1],iS[2]=[-1,0],iS[3]=[-1,1],iS[4]=[0,1],iS[5]=[1,1],iS[6]=[1,0],iS[7]=[1,-1];const sS=1e-6;class rS{constructor(e,t,i,s,r){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=s,this.rightStartIndex=r}}class nS{constructor(e,t,i,s){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=s,this._rayDirection=ke(),this._callback=dS,this._intersectionOptions=cS,this.bspNodeTree=new Array;const r=i-t,n=new(r<lS?Uint8Array:r<hS?Uint16Array:Uint32Array)(r);this.triangleIndexMap=n;for(let e=0;e<r;++e)n[e]=e;{const a=function(e,t,i,s,r){const n=i-t,a=new Float32Array(6*n);for(let i=0;i<n;++i){const n=3*(i+t),o=e[n]*r,l=e[n+1]*r,h=e[n+2]*r;for(let e=0;e<3;++e){const t=s[o+e],r=s[l+e],n=s[h+e];a[6*i+e]=Math.min(t,r,n),a[6*i+3+e]=Math.max(t,r,n)}}return a}(e,t,i,s.data,s.stride),o=Ci(Math.log2(r/40),2,10),l=(e,t,i)=>{const s=function(e,t,i,s){if(s<=i)return dh(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*e[i];for(let e=0;e<3;++e)aS[e]=t[s+0+e],oS[e]=t[s+3+e]}for(let r=i+1;r<s;++r){const i=6*e[r];for(let e=0;e<3;++e)aS[e]=Math.min(aS[e],t[i+0+e]),oS[e]=Math.max(oS[e],t[i+3+e])}return dh(aS[0],aS[1],aS[2],oS[0],oS[1],oS[2])}(n,a,e,t),r=t-e;if(r<=40){const i=new rS(s,void 0,0,e,t);return this.bspNodeTree.push(i),i}const{axis:h,midValue:c}=function(e){const t=e[3]-e[0],i=e[4]-e[1],s=e[5]-e[2],r=t>i?t>s?0:i>s?1:2:i>s?1:s>t?2:0;return{axis:r,midValue:(e[r]+e[r+3])/2}}(s),d=function(e,t,i,s,r,n){let a=i,o=s;for(;a<o;){const i=e[a];t[6*i+r+3]<=n?++a:(--o,e[a]=e[o],e[o]=i)}let l=a;for(o=s;l<o;){const i=e[o-1];t[6*i+r]>=n?--o:(e[o-1]=e[l],e[l]=i,++l)}return{next:a,mid:l}}(n,a,e,t,h,c),u=(e,t)=>{if(i>o)return;const s=t-e;return s<40||s>=.8*r?void 0:l(e,t,i+1)},p=new rS(s,h,c,d.next,d.mid);return this.bspNodeTree.push(p),p.leftNode=u(e,d.next),p.rightNode=u(d.mid,t),p};l(0,r,0)}}intersectRayTriangleRange(e,t){if(e>=t)return;const i=this.positions;ou(this._rayFrom,this._rayDirection,e,t,this.globalTriangleVertexIndices,i.data,i.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),nS.numFacesTested+=t-e}intersectRay(e,t,i,s){nS.numFacesTested=0;const r=e,n=t,a=n[0]-r[0],o=n[1]-r[1],l=n[2]-r[2];if(a*a+o*o+l*l<sS)return;this._rayFrom=r;const h=this._rayDirection;h[0]=a,h[1]=o,h[2]=l;const c=this.triangleIndexMap.length;this._callback=s,this._intersectionOptions=i,this.intersectRayBSP(this.bspNodeTree[0],0,c),this._callback=dS,this._intersectionOptions=cS}intersectRayBSP(e,t,i){const s=this._rayFrom,r=this._rayDirection;if(!function(e,t,i){const s=t,r=i;let n=0,a=1/0;for(let t=0;t<3;++t){{const i=e[t];if(s[t]<i){if(r[t]<=sS)return!1;const e=(i-s[t])/r[t];n=Math.max(n,e)}else if(r[t]<=-sS){const e=(i-s[t])/r[t];a=Math.min(a,e)}if(n>a)return!1}{const i=e[t+3];if(s[t]>i){if(r[t]>=-sS)return!1;const e=(i-s[t])/r[t];n=Math.max(n,e)}else if(r[t]>=sS){const e=(i-s[t])/r[t];a=Math.min(a,e)}if(n>a)return!1}}return!0}(e.aabb,s,r))return;const n=e.axis,a=e.d;if(s[n]<a||r[n]<0){const i=t,s=e.midStartIndex;if(i<s){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,i,s):this.intersectRayTriangleRange(i,s)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),s[n]>a||r[n]>0){const t=e.rightStartIndex,s=i;if(t<s){const i=e.rightNode;void 0!==i?this.intersectRayBSP(i,t,s):this.intersectRayTriangleRange(t,s)}}}static{this.numFacesTested=0}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}}const aS=[1/0,1/0,1/0],oS=[-1/0,-1/0,-1/0],lS=255,hS=65535,cS=new au,dS=()=>{};function uS(e,t){const{vertex:i,fragment:s}=e;i.uniforms.add(new ih("overlayTexOffset",(e,t)=>function(e,t){const i=t.overlay?.overlays[0]?.extent;St(i)&&(gS[0]=e.toMapSpace[0]/ut(i)-i[0]/ut(i),gS[1]=e.toMapSpace[1]/pt(i)-i[1]/pt(i));const s=t.overlay?.overlays[1]?.extent;return St(s)&&(gS[2]=e.toMapSpace[0]/ut(s)-s[0]/ut(s),gS[3]=e.toMapSpace[1]/pt(s)-s[1]/pt(s)),gS}(e,t)),new ih("overlayTexScale",(e,t)=>function(e,t){const i=t.overlay?.overlays[0]?.extent;St(i)&&(gS[0]=e.toMapSpace[2]/ut(i),gS[1]=e.toMapSpace[3]/pt(i));const s=t.overlay?.overlays[1]?.extent;return St(s)&&(gS[2]=e.toMapSpace[2]/ut(s),gS[3]=e.toMapSpace[3]/pt(s)),gS}(e,t))),s.constants.add("overlayOpacity","float",1),s.uniforms.add(new hr("ovColorTex",(e,t)=>function(e,t){return 0===e.identifier&&dr(e.output)?e.occludedGround?t.overlay?.allSourcesOccluders?t.overlay?.getTexture(1):t.overlay?.getTexture(4):t.overlay?.getTexture(1):0===e.identifier&&9===e.output?t.overlay?.getTexture(5):2===e.identifier?t.overlay?.getTexture(2):null}(e,t))),mS(e,t)}function pS(e,t){const{vertex:i,fragment:s}=e,{output:r}=t;i.uniforms.add(new _S("overlayTexOffset"),new _S("overlayTexScale")),s.uniforms.add(new lr("overlayOpacity",e=>e.overlayOpacity)),8!==r&&s.uniforms.add(new hr("ovColorTex",(e,t)=>t.overlay?.getTexture(e.overlayContent))),mS(e,t)}function mS(e,t){const i=3===t.pbrMode||4===t.pbrMode||6===t.pbrMode;i&&e.include(yh,t);const{vertex:s,fragment:r,varyings:n}=e;n.add("vtcOverlay","vec4");const{output:a}=t,o=8===a;s.code.add(br`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),r.code.add(br`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),o?r.uniforms.add(new ua("overlayHighlightTexture",(e,t)=>t.overlay?.getTexture(2))).code.add(br`uvec2 getAllOverlayHighlightValuesEncoded() {
vec4 texCoords = vtcOverlay;
vec2 uvInner = texCoords.xy;
vec2 uvOuter = texCoords.zw;
bool isValidInner = isValid(uvInner, fwidth(uvInner));
bool isValidOuter = isValid(uvOuter, vec2(0.0, 0.0));
vec2 texelCoordInner = uvInner * vec2(0.5, 1.0);
vec2 texelCoordOuter = uvOuter * vec2(0.5, 1.0) + vec2(0.5,0.0);
vec2 texDim =  vec2(textureSize(overlayHighlightTexture, 0));
uvec2 texelValueInner = texelFetch(overlayHighlightTexture, ivec2(texelCoordInner * texDim), 0).rg;
uvec2 texelValueOuter = texelFetch(overlayHighlightTexture, ivec2(texelCoordOuter * texDim), 0).rg;
return
isValidInner ? texelValueInner :
isValidOuter ? texelValueOuter :
uvec2(0);
}`):(r.code.add(br`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),r.code.add(br`vec4 getOverlayColorTexel() {
vec4 texCoords = vtcOverlay;
vec2 texDim =  vec2(textureSize(ovColorTex, 0));
vec4 color0 = texelFetch(ovColorTex, ivec2(vec2(texCoords.x * 0.5, texCoords.y) * texDim), 0);
vec4 color1 = texelFetch(ovColorTex, ivec2(vec2(texCoords.z * 0.5 + 0.5, texCoords.w) * texDim), 0);
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`)),i&&(Dd(r),Ad(r),r.code.add(br`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}const gS=ul();let _S=class extends or{constructor(e){super(e,"vec4")}};function fS(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add(br`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(br`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(br`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function yS(e,t){8===t.output&&(e.include(jr,t),e.fragment.code.add(br`
    void calculateOcclusionAndOutputHighlight(uvec2 highlightToAdd) {
      uint levelBits = readLevelBits(highlightToAdd, highlightLevel);
      if ((levelBits & 1u) == 0u) discard;
      outputHighlight(isHighlightOccluded());
    }
  `))}class vS extends Ed{constructor(){super(...arguments),this.overlayOpacity=1}}function bS(e,t){const{vertex:i,fragment:s,varyings:r}=e;r.add("vtc","vec2"),i.uniforms.add(new CS("texOffsetAndScale")),s.uniforms.add(new TS("tex")),s.uniforms.add(new xS("textureOpacities"));const n=t.textureFadingEnabled&&!t.renderOccluded;n&&(i.uniforms.add(new CS("nextTexOffsetAndScale")),r.add("nvtc","vec2"),s.uniforms.add(new TS("texNext")),s.uniforms.add(new xS("nextTexOpacities")),s.uniforms.add(new wS("fadeFactor")));const a=1===t.tileBlendInput,o=2===t.tileBlendInput;o&&s.include(gT),a&&s.uniforms.add(new xS("backgroundColor")),i.code.add(br`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = texOffsetAndScale.xy + uv * texOffsetAndScale.zw;
    ${wr(n,"nvtc = nextTexOffsetAndScale.xy + uv * nextTexOffsetAndScale.zw;")}
  }`),s.code.add(br`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${wr(o||a,br`if (opacities.y <= 0.0) {
           return color * opacities.z * opacities.x;
         }
         vec4 bg = vec4(${a?br`backgroundColor`:br`gridColor(uv)`} * opacities.y, opacities.y);
         vec4 layer = color * opacities.z;
         return (bg * (1.0 - layer.a) + layer) * opacities.x;`,"return color;")}
    }`),n?s.code.add(br`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):s.code.add(br`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}class wS extends or{constructor(e){super(e,"float")}}class xS extends or{constructor(e){super(e,"vec3")}}class CS extends or{constructor(e){super(e,"vec4")}}class TS extends or{constructor(e){super(e,"sampler2D")}}class SS extends vS{}const PS=Fs(),MS=ke(),RS=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:SS,build:function(e){const t=new mn,{attributes:i,vertex:s,fragment:r,varyings:n}=t;i.add("position","vec3"),t.include(Id,e),t.include(ur,e);const a=()=>{t.include(vh,e),s.code.add(br`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};zr(s,e),t.include(lu,e);const{output:o,pbrMode:l,overlayMode:h,tileBorders:c,spherical:d,transparencyMode:u,screenSizePerspective:p,overlayEnabled:m}=e,g=2===u||3===u,_=m&&g;switch(o){case 1:case 0:{t.include(bS,e),t.include(kd,e),m&&(e.pbrMode=5===l?6:3,t.include(pS,e),e.pbrMode=l);const i=2===h;i&&t.include(fS,e),n.add("vnormal","vec3"),n.add("vpos","vec3",{invariant:!0}),n.add("vup","vec3"),a(),p&&Hr(s),p&&(n.add("screenSizeDistanceToCamera","float"),n.add("screenSizeCosAngle","float")),s.main.add(br`
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);
          vnormal = getNormal();
          vup = getLocalUp(position, localOrigin);
          ${wr(i,br`forwardVertexTangent(vnormal);`)}

          forwardTextureCoordinatesWithTransform(uv0);
          ${wr(m,"setOverlayVTC(uv0);")}
          ${wr(c,"forwardTextureCoordinates();")}
          ${wr(p,br`vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
                 screenSizeDistanceToCamera = length(viewPos);
                 vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
                 screenSizeCosAngle = abs(viewSpaceNormal.z);`)}
          forwardLinearDepthToReadShadowMap();`),t.include(Vd,e),r.include(qr,e),t.include(kd,e),r.include(Fd,e),Ur(r,e),jd(r),zd(r),r.uniforms.add(s.uniforms.get("localOrigin"),new Rr("viewDirection",({camera:e})=>Ni(MS,qi(MS,e.viewMatrix[12],e.viewMatrix[13],e.viewMatrix[14])))),i&&r.uniforms.add(new Br("ovWaterTex",e=>e.overlay?.getTexture(3)),new Nr("view",({origin:e},{camera:t})=>Ms(PS,t.viewMatrix,e)));const o=.2;r.code.add(br`float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),Dd(r),Ad(r),r.main.add(br`
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = readShadow(additionalAmbientScale, vpos);
          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${wr(m,br`vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
                   vec4 overlayColor = overlayOpacity * overlayColorOpaque;
                   ${wr(g,`if (overlayColor.a < ${br.float(ku)}) { discard; }`)}
                   vec4 groundColor = tileColor;
                   tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`)}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a < ${br.float(ku)}) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= ${br.float(o)};
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${5===l||6===l?br`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:br`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${wr(i,br`vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
                   float waterNormalLength = length(overlayWaterMask);
                   if (waterNormalLength > 0.95) {
                     mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                     vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                     vec4 viewPosition = view*vec4(vpos, 1.0);
                     vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                     vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                     float opacity = sliced ? ${br.float(o)} : 1.0;
                     // un-gamma the ground color to mix in linear space
                     fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
                   }`)}
          ${wr(p,br`float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0));
                   if (perspectiveScale <= 0.25) {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
                   } else if (perspectiveScale <= 0.5) {
                     fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
                   } else if (perspectiveScale >= 0.99) {
                     fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
                   } else {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
                   }`)}
          ${wr(e.visualizeNormals,d?br`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`:br`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`)}
          ${wr(c,br`vec2 dVuv = fwidth(vuv0);
                 vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
                 float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
                 fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`)}
          fragColor = applySlice(fragColor, vpos);`)}break;case 2:_&&t.include(pS,e),s.main.add(br`
        ${wr(_,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),r.main.add(`${wr(_,`if (getCombinedOverlayColor().a < ${br.float(ku)}) discard;`)}`);break;case 4:case 5:case 6:case 7:t.include(Ld,e),hu(t),cu(t),s.main.add(br`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);`),r.main.add(br`outputDepth(linearDepth);`);break;case 3:_&&t.include(pS,e),n.add("vnormal","vec3"),Hr(s),a(),s.main.add(br`
        ${wr(_,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);
        vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);`),r.main.add(br`
        ${wr(_,`if (getCombinedOverlayColor().a < ${br.float(ku)}) discard;`)}
        vec3 normal = normalize(vnormal);
        if (gl_FrontFacing == false) {
          normal = -normal;
        }
        fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);`);break;case 8:m&&(t.include(pS,e),t.include(yS,e)),s.main.add(br`
        ${wr(m,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),t.include(jr,e),r.main.add(br`
        ${wr(m,br`
           calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,"calculateOcclusionAndOutputHighlight();")}
      `)}if(9===o)if(m)e.pbrMode=0,t.include(pS,e),e.pbrMode=l,s.main.add(br`gl_Position = transformPosition(proj, view, position);
setOverlayVTC(uv0);`),r.main.add(br`fragColor = getOverlayColorTexel();`);else{const e=0===u;s.main.add(br`${wr(e,"gl_Position = transformPosition(proj, view, position);")}`),r.main.add(br`fragColor = vec4(0.0);`)}return t}},Symbol.toStringTag,{value:"Module"}));class OS extends Tr{constructor(e,t){super(e,t,new Sr(RS,()=>Promise.resolve().then(()=>RS)),cT.locations),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(e){return this._stencilPipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}_createPipeline(e,t){const{renderOccluded:i,output:s}=e,r=e.backfaceCullingEnabled&&!i;return gn({blending:i?bn:null,culling:r?xn:null,depthTest:i?null:{func:513},depthWrite:i?null:wn,colorWrite:_n,stencilTest:t?Wr(1):null,drawBuffers:Gr(s)})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}}class DS extends $r{constructor(e){super(),this.spherical=e,this.overlayMode=0,this.tileBlendInput=0,this.transparencyMode=0,this.pbrMode=5,this.receiveShadows=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.normalType=1,this.textureCoordinateType=1,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.draped=!1}get overlayEnabled(){return 0!==this.overlayMode}}e([Pr({count:3})],DS.prototype,"overlayMode",void 0),e([Pr({count:3})],DS.prototype,"tileBlendInput",void 0),e([Pr({count:4})],DS.prototype,"transparencyMode",void 0),e([Pr({count:7})],DS.prototype,"pbrMode",void 0),e([Pr()],DS.prototype,"receiveShadows",void 0),e([Pr()],DS.prototype,"backfaceCullingEnabled",void 0),e([Pr()],DS.prototype,"textureFadingEnabled",void 0),e([Pr()],DS.prototype,"renderOccluded",void 0),e([Pr()],DS.prototype,"screenSpaceReflections",void 0),e([Pr()],DS.prototype,"cloudReflections",void 0),e([Pr()],DS.prototype,"screenSizePerspective",void 0),e([Pr()],DS.prototype,"receiveAmbientOcclusion",void 0),e([Pr()],DS.prototype,"tileBorders",void 0),e([Pr()],DS.prototype,"visualizeNormals",void 0);const AS=ah();let ES=class extends ha{get visibleTiles(){return Array.from(this._visiblePatchesByOrigin.values()).flat()}get _isGlobal(){return 1===this._stage.viewingMode}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,i,s,r,n){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=i,this._ellipsoidRadius=s,this._compressionTracker=r,this.type=2,this.isGround=!0,this._passParameters=new SS,this._drawParameters=new ix,this._renderDataPool=new td(kx),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new Sx,this._castShadows=!1,this._inViewshed=!1,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=1,this.produces=new Map([[1,()=>this._produces()&&0===this.transparency],[6,()=>this._produces()&&(1===this.transparency||2===this.transparency)],[9,()=>this._produces()&&this.renderOccludedFlags===pa]]),this._tileSize=256,this._configuration=new DS(1===t.viewingMode),this._tileTextureCache=new fw((e,t)=>n.newCache(e,t),"TileTexture"),this.tileGeometryCache=new dT(n)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(B(()=>this._overlayRenderer.renderOccludedFlags,e=>{this.renderOccludedFlags=e,this.setNeedsRender()},W))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy(),this._allTiles.prune(),this._tileRenderer=null}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?ma:ga}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){this._tileRenderer?.updateHeading(e)}set transparency(e){this._configuration.transparencyMode!==e&&(this._configuration.transparencyMode=e,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(e){this._configuration.tileBorders!==e&&(this._configuration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(e){this._configuration.visualizeNormals!==e&&(this._configuration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(e){this._configuration.backfaceCullingEnabled!==e&&(this._configuration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}get layerViewUid(){return Eo}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(e){this._configuration.hasSlicePlane!==e&&(this._configuration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._configuration.textureFadingEnabled!==e&&(this._configuration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._configuration.pbrMode!==e&&(this._configuration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._configuration.screenSizePerspective!==e&&(this._configuration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}set tileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._ensureRenderData(e),this.updateTileGeometryState(e),this.reuseTextureFromParent(e)||this.updateTileTexture(e,32)}reuseTextureFromParent(e){const t=e.parent;if(!t)return!1;const i=pl(1&e.lij[2]?.5:0,1&e.lij[1]?0:.5,.5,.5);return t.renderData?.reuseTexture(e.renderData,i)??!1}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,32===t?0:2),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const t of e.layerInfo[0])t.pendingUpdates&=-9;e.resetPendingUpdate(8);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.loaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return Ue;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=1){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=1){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=1){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new $T(this._rctx,this._tileSize,this._techniques,this._tileTextureCache,this._compressionTracker),this.updateTileBackground()}uninitializeRenderContext(){this._tileRenderer=M(this._tileRenderer)}intersect(e,t,i,s){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&0!==this.transparency)return;const r=IS,n=LS;Yi(r,s,i),qi(n,1/r[0],1/r[1],1/r[2]);const a=e.results.min,o=e.results.max,l=e.results.ground,h=0===e.options.store,c=!!e.results.ground.target,d=Lo(e.verticalOffset),u=e.tolerance;let p,m=h&&null!=a.distance?a.distance:1/0;const g=e.options,_=g.normalRequired||!g.backfacesTerrain,f=new au(!1,_),y=c=>{const y=c.renderData;if(!y?.vao)return;const v=y.geometry;uh(AS,v.boundingBox);const b=y.localOrigin;null!=d&&(d.localOrigin=b,d.applyToAabb(AS));const w=AS;if(kS[0]=i[0]-b[0],kS[1]=i[1]-b[1],kS[2]=i[2]-b[2],!nu(w,kS,n,u,m))return;const x=(e,t,i)=>{e.set(this.type,c,t,i),m=h&&null!=a.distance?a.distance:1/0},C=(n,h,c)=>{if((!_||null!=c)&&n>=0&&(g.backfacesTerrain||Gi(c,r)<0)&&(g.invisibleTerrain||!g.selectionMode||null==t||t(i,s,n))){if((null==l.distance||n<l.distance)&&x(l,n,c),g.isFiltered)return;2===g.store&&(null==p?(p=new Bh(e.ray),x(p,n,c),e.results.all.push(p)):n<p.distance&&x(p,n,c)),(null==a.distance||n<a.distance)&&x(a,n,c),0!==g.store&&(null==o.distance||n>o.distance)&&x(o,n,c)}},T=VS;Yi(T,s,b);const{indices:S,indexCount:P}=v,M=v.vertexAttributes,R=M.getField("position",ec),O=new Iu(R.typedBuffer,3,M.stride/4),D=P/3;if(!d&&D>200){const e=c.renderData;null==e.intersectionData&&(e.intersectionData=new nS(S,0,D,O)),e.intersectionData.intersectRay(kS,T,f,C)}else du(kS,T,0,D,S,O,d,f,C)},v=this._rootTiles;null!=v&&(()=>{const t=this._tileIterator;t.reset(v);const s=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||s&&e.intersectsClippingArea)||null==d&&!e.intersectsRay(i,r,u,m)||c&&this._useStencilForTile(e)?t.skipSubtree():y(e)})()}processScaleRangeQueries(e,t){if(!t.done&&e)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const i of t)null!=i.renderData?.textureReference&&e.queriesForTile(i);e.process(),t.madeProgress()}}acquireTechniques(e){const t=!!h("enable-feature:terrain-shadows")&&e.bind.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);const i=e.bind.viewshedEnabled;if(this._inViewshed!==i&&(this._inViewshed=i,this._patchesByOriginDirty=!0),9===e.bind.slot){if(0===(e.renderOccludedMask&pa))return null}else{const t=0===this.transparency?1:6;if(e.bind.slot!==t)return null}if(3===this.transparency)return null;const s=this._configuration;switch(s.screenSpaceReflections=s.cloudReflections=s.receiveShadows=s.receiveAmbientOcclusion=s.renderOccluded=s.hasHighlightMixTexture=!1,s.overlayMode=this._overlayRenderer.mode,e.output){case 0:case 1:{s.screenSpaceReflections=null!=e.bind.ssr.lastFrameColor,s.cloudReflections=null!=e.bind.clouds.data;const t=9===e.bind.slot;return s.receiveShadows=e.bind.shadowMap.ready&&!t,s.renderOccluded=t,s.receiveAmbientOcclusion=!t&&null!=e.bind.ssao,this._acquireTechnique(e.output)}case 4:case 6:return this._castShadows?this._acquireTechnique(4):null;case 7:return this._inViewshed?this._acquireTechnique(7):null;case 2:case 3:return this._acquireTechnique(e.output);case 9:return this._acquireTechnique(9);case 8:return s.hasHighlightMixTexture=null!=e.bind.highlightMixTexture,this._overlayRenderer.hasHighlights?this._acquireTechnique(8):null}return null}render(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,this._passParameters.overlayContent=function(e,t){switch(e){case 0:case 1:return 9!==t.slot||t.overlay?.allSourcesOccluders?0:4;case 2:case 3:return 0;case 8:return 2;case 4:case 6:case 7:return null;case 9:return 5}return null}(e.output,e.bind),e.output){case 0:case 1:this._renderMaterialPass(e,t);break;case 2:case 3:case 9:this._renderAuxiliaryPass(e,t,this._visiblePatchesByOrigin);break;case 8:{const i=e.bind.highlight?.name;i&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(2)&&this._overlayRenderer.hasHighlight(i)&&this._renderAuxiliaryPass(e,t,this._visiblePatchesByOrigin);break}case 4:case 6:case 7:this._renderAuxiliaryPass(e,t,this._allPatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=Jc.toUnitRGBA(e);i=Ve(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll(e=>t.updateTileTexture(e,0)),this._configuration.tileBlendInput=t.backgroundIsGrid?2:null!=t.backgroundColor?1:0,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const i of e)Ox(i,t);e.sort((e,t)=>Ax(e[0],t[0])),this._visiblePatchesByOrigin=new Map(e.map(e=>[e[0].renderData.localOrigin,e])),this.notifyChange("visibleTiles"),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),i=e.renderData;if(!i){this._numTilesCulled++;continue}const s=i.localOrigin;if(this._castShadows||this._inViewshed){let t=this._allPatchesByOrigin.get(s);t||(t=[],this._allPatchesByOrigin.set(s,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let r=this._visiblePatchesByOrigin.get(s);r||(r=[],this._visiblePatchesByOrigin.set(s,r)),r.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,i){const{rctx:s,bind:r}=e;s.bindTechnique(t,r,this._passParameters);const n=this._stencilEnabledLayerExtents.length>0;i.forEach(e=>{this._drawParameters.origin=e[0].renderData.localOrigin,t.program.bindDraw(r,this._passParameters,this._drawParameters);for(let i=0;i<e.length;i++)this._renderPatch(s,t,e[i],Un.TRIANGLES,n,null===this._passParameters.overlayContent)}),s.bindVAO(null)}_renderMaterialPass(e,t){const{rctx:i,bind:s}=e;i.bindTechnique(t,s,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const r=s.camera,n=t.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){const e=Er(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:r.fovY})}const a=this._stencilEnabledLayerExtents.length>0,o=9===s.slot;o&&(n.bindTexture("tex",i.emptyTexture),n.setUniform3fv("textureOpacities",Ue),n.setUniform4fv("texOffsetAndScale",ml));const l=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:Ue;1===this._configuration.tileBlendInput&&n.setUniform3fv("backgroundColor",l);const h=this.wireframe?Un.LINES:Un.TRIANGLES;this._configuration.textureFadingEnabled&&n.bindTexture("texNext",i.emptyTexture);const c=this._visiblePatchesByOrigin;for(const e of c.values()){const r=e[0].renderData.localOrigin;this._drawParameters.origin=r,t.program.bindDraw(s,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const s of e){const e=s.renderData,r=e.textureReference;if(null!=r){if(!o){n.setUniform4fv("texOffsetAndScale",r.offsetAndScale),n.bindTexture("tex",r.texture.texture);const t=e.textureFadeFactor,i=t<1?e.nextTextureReference:null;this._configuration.textureFadingEnabled&&i&&t<1?(n.setUniform1f("fadeFactor",t),n.setUniform4fv("nextTexOffsetAndScale",i.offsetAndScale),n.setUniform3fv("nextTexOpacities",i.opacities),n.bindTexture("texNext",i.texture.texture)):n.setUniform1f("fadeFactor",1),e.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",r.opacities)}this._renderPatch(i,t,s,h,a),s.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}i.bindVAO(null)}_renderPatch(e,t,i,s,r,n=!1){const a=i.renderData,o=a.vao,l=o?.indexBuffer;if(!o||null==l)return void(dc&&console.error("Rendered tile with no indices: ",i.lij," : ",a));const h=t.program;n||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,a.overlay),r&&(t.useStencil=this._useStencilForTile(i),e.setPipelineState(t.getPipeline()));const c=a.geometry.indexCount;e.bindVAO(o),h.assertCompatibleVertexAttributeLocations(o),e.drawElements(s,c,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_acquireTechnique(e){return this._configuration.output=e,this._techniques.get(OS,this._configuration)}get test(){}hasHighlight(e){return this._overlayRenderer.hasHighlight(e)}};e([Ce({readOnly:!0})],ES.prototype,"visibleTiles",null),e([Ce({readOnly:!0})],ES.prototype,"_isGlobal",null),e([Ce()],ES.prototype,"renderOccludedFlags",void 0),e([Ce({value:!1})],ES.prototype,"renderingDisabled",null),e([Ce({value:!0})],ES.prototype,"visible",null),e([Ce()],ES.prototype,"renderPatchBorders",null),e([Ce()],ES.prototype,"visualizeNormals",null),e([Ce()],ES.prototype,"cullBackFaces",null),e([Ce()],ES.prototype,"wireframe",null),ES=e([Se("esri.views.3d.terrain.TerrainRenderer")],ES);const IS=ke(),LS=ke(),kS=ke(),VS=ke();class FS{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}let jS=class extends Oe{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",()=>this._update()),B(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!Lt(t)||t.isRejected()||t.isFulfilled()&&!function(e,t,i){return null!=rc(e,t,i)}(t,this.viewSpatialReference,this.viewingMode)||(e=t,"vector-tile"===t?.type||nc(t)))),e)if(e.isResolved()){const t=rc(e,this.viewSpatialReference,this.viewingMode);if(null!=t){const e=new _d(t.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(1===this.viewingMode){const t=e.levels.length-1,i=e.spatialReference;i.isWebMercator?e=_d.makeWebMercatorAuxiliarySphere(t):kc(i)&&(e=_d.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(B(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(1===this.viewingMode){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=_d.WebMercatorAuxiliarySphere:Vc(e)&&(this.tilingScheme=_d.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;null==e||bt(e,this.extent)||(this.tilingScheme=_d.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}};e([Ce()],jS.prototype,"tilingScheme",void 0),e([Ce({readOnly:!0})],jS.prototype,"extent",void 0),e([Ce({value:!1})],jS.prototype,"tilingSchemeLocked",void 0),e([Ce({constructOnly:!0})],jS.prototype,"viewSpatialReference",void 0),e([Ce({constructOnly:!0})],jS.prototype,"layers",void 0),e([Ce({constructOnly:!0})],jS.prototype,"extentHelper",void 0),e([Ce({constructOnly:!0})],jS.prototype,"viewingMode",void 0),jS=e([Se("esri.views.3d.terrain.TilingSchemeLogic")],jS);class zS{constructor(){this._offset=Gs(),this.scale=0}get offset(){return this._offset}init(e,t,i,s){this.tile=e,this._offset[0]=t,this._offset[1]=i,this.scale=s}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}}var HS;let qS=class extends ji{static{HS=this}get allTiles(){return f(this._allTiles)}get demResolution(){const{_allTiles:e,tilingScheme:t}=this;if(0===e.length)return{min:1,max:1};const i=ve(t.spatialReference);let s=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;for(const n of e){const e=t.resolutionAtLevel(n.level)*i;s=Math.min(s,e),r=Math.max(r,e)}return{min:s,max:r}}constructor(e){super(e),this.terrainTextureCompressionTracker=new oo,this._iteratorPool=new td(Sx,e=>e.remove=()=>this._iteratorPool.release(e)),this._postorderIterator=new Px,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new FS,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=ke(),this._eyePosSurfaceSR=ke(),this._splitLimits=new hT,this._frustum=ad(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new Yl,this._frameTask=jn,this._allTiles=new Xl,this._upsampleInfoPool=new td(zS),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=lt(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=tt.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new ww(1/0,-1/0),this.rootTileElevationBounds=new ww(1/0,-1/0),this._projectorCache=new Map,this._radiusModifier=Math.cos(Math.PI/16/16),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this._enabled=!0;const t=e.view;this.overlayManager=new px({...e,surface:this}),this._isGlobal=!t.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?tT:KC,this._ellipsoid=ge(t.spatialReference),this._renderer=new ES(this.overlayManager.renderer,t.stage,this._allTiles,this._ellipsoid.radius,this.terrainTextureCompressionTracker,t.resourceController.memoryController),Dh()||(this._scaleRangeQueries=new eT)}initialize(){const e=this.view,t=e.resourceController,i=t.memoryController;this._tileCache=new fw((e,t)=>i.newCache(e,t),"terrain-tile"),this._upsampleMapCache=i.newCache("terrain-upsample",e=>e.unloadMapData()),this._elevationQueryCache=new ld(i.newCache("elevation-query"));const s=this.overlayManager;this.addHandles([B(()=>s.renderer.isEmpty,()=>this._evaluateTransparency()),B(()=>this.renderer.visible,e=>this.suspended=!e),B(()=>this.heading,e=>{this._renderer.updateHeading(e),this._updateTileTextures(0)}),B(()=>({heading:e.camera?.heading,state:e.state?.mode}),({heading:e,state:t})=>{if(null==e)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(e/90)%360);const i=Math.round(e)%360,s=Math.abs(i-this.heading);(2===t||Math.min(s,360-s)>=30)&&(this.heading=i)})],"overlayManager"),this.addHandles([B(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?1:2)},G),B(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?1:2),G),B(()=>this.backgroundColor,(e,t)=>{e?.equals(t)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(e))},W),B(()=>this.snapLevel,()=>this._viewChanged=!0,W),B(()=>this.view.pointsOfInterest,e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add(()=>e.focus?.renderLocation,()=>this._allTilesSorted=!1)}),B(()=>Jl.TERRAIN_TILE_TREE_SHOW_TILES,t=>{t&&!this._treeDebugger?import("../chunks/TerrainTileTree3DDebugger.js").then(({TerrainTileTree3DDebugger:t})=>{!this._treeDebugger&&Jl.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new t({view:e}))}):t||(this._treeDebugger=S(this._treeDebugger))},N)]);const{spatialReference:r}=e;var n,a;this._extentHelper=(n=this.viewingMode,a={layers:e.map.allLayers,layerViews:e.allLayerViews,viewSpatialReference:r},1===n?new Pw(a):new Mw(a));const o=new ed({getCollections:()=>e.defaultsFromMap?.mapCollections?.map(({layers:e})=>e),getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),l=new jS({layers:o,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:r});this._set("tilingSchemeLogic",l),this._updateTilingScheme(),this._elevationDataRequester=t.createStreamDataRequester(0),this._mapDataRequester=t.createStreamDataRequester(1);const h=t.scheduler;this._frameTask=h.registerTask(kn.TERRAIN_SURFACE,this),this.addHandles([B(()=>this._extentHelper.stencilEnabledExtents,e=>this._renderer.setStencilEnabledLayerExtents(e),N),B(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),W),B(()=>this.extent,()=>this._updateRootTiles(),N),e.on("resize",()=>this._viewChangeUpdate()),B(()=>{const t=e.state;return[this._lodBias,this.lodSnappingEnabled,e.quality,t.camera,t.contentCamera,t.fixedContentCamera]},()=>this._viewChangeUpdate(),G),B(()=>e.qualitySettings?.fadeDuration,e=>this._renderer.textureFadingEnabled=e>0,N),B(()=>e.qualitySettings?.physicallyBasedRenderingEnabled,e=>this._renderer.pbrMode=e?5:0,N),B(()=>e.qualitySettings?.tiledSurface.elevationLevelDelta,()=>this._updateAllTileGeometries()),B(()=>this._userClippingExtent,()=>this._updateClippingExtent(),W)]),this.addHandles(e.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}clearHandles(){this._watchUpdatingTracking?.removeAll(),this.removeAllHandles(),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._basemapLayerViewHandles.clear()}destroy(){this._frameTask.remove(),this._frameTask=jn,this._watchUpdatingTracking?.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",S(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._basemapLayerViewHandles.clear(),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",S(this.overlayManager)),this._tileCache=S(this._tileCache),this._allTiles.prune(),nC.prune(),this._treeDebugger=S(this._treeDebugger),this._renderer.destroyed||this._renderer.destroy(),this._renderer=null,this._iteratorPool=S(this._iteratorPool),this._upsampleMapCache=S(this._upsampleMapCache),this._elevationQueryCache=S(this._elevationQueryCache),this._set("view",null),this._extentHelper=S(this._extentHelper),this._upsampleInfoPool=S(this._upsampleInfoPool),rC.size>0&&(console.log(`${rC.size} live TilePerLayerInfo allocations:`),rC.forEach(e=>console.log(e,"\n"))),this._layerViews.forEach(e=>e.length=0),this._performanceInfo=null}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnappingEnabled){const{view:e,tilingScheme:t}=this,i=e.scale;if(t&&i){const s=t.levelAtScale(i)+e.qualitySettings.tiledSurface.lodBias,r=t.getMaxLod();return s<=0?null:Math.min(s,r||1/0)}}return null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){const{spatialReference:e}=this,t=this.view?.clippingArea;if(null==t||null==e)return null;const i=lt(),s=lo(t,i,e)?i:null,r=this._get("extent");return bt(s,r)?r:s}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=wt(this.groundExtent,this._userClippingExtent,lt()),t=this._get("extent");return bt(e,t)?t:e}get groundExtent(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.readyToRun||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating||this.terrainTextureCompressionTracker.compressing)}get readyToRun(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries?.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return null!=this._rootTiles}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return 0===this._renderer.transparency}get invisible(){return 3===this._renderer.transparency}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(e,t,i,s){this._renderer.intersect(e,t,i,s)}getElevationLevelDelta(e){return e<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(e,t,i,s){const r=this._rootTiles;if(!r?.length||!this._enabled)return null;if(0===r[0].layerInfo[0].length)return null;let n=this._elevationProjectorCache.get(s);if(void 0===n&&(n=id(s,this._spatialReference)??null,this._elevationProjectorCache.set(s,n)),null==n)return C.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const a=qi(BS,e,t,i);return n(a,0,a,0),ZS(r,a[0],a[1])}getElevations(e,t,i){const s=this._rootTiles,r=s?s[0].layerInfo[0].length:0;if(s?.length&&0!==r&&this._enabled)for(let r=0;r<t;++r){const t=3*r;i(r,ZS(s,e[t],e[t+1]))}else for(let e=0;e<t;++e)i(e,null)}getLayerIndexByUID(e,t){return this._layerIndexByUid[e].get(t)}getScale(e){if(!this.tilingScheme)return null;if(!at(e,BS,this.spatialReference))return C.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(null!=t)for(const e of t)if(e?.containsPoint(BS)){let t=e;for(;t.children[0]&&!t.rendered;){const e=t.children[0].extent;let i=0;BS[0]>e[2]&&(i+=1),BS[1]<e[1]&&(i+=2),t=t.children[i]}return this._getLodBiasCorrectedScale(t.level)}return 1/0}_ensureProjector(e){const t=this._projectorCache.get(e);if(t)return t;const i=id(e,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(e,i),i}getSphereElevationBounds(e,t){const i=this._ensureProjector(t);if(null==i)return C.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;Ya(e,NS);const s=Qa(NS);i(s,0,s,0);const r=new tb,n=this._rootTiles;if(null!=n){const e=[];for(const t of n)e.push(t);let t=0;for(;t<e.length;){const i=e[t];if(++t,!Pt(i.extent,NS))continue;const s=i.children;if(null==s[0]||i.rendered)r.expandElevationRangeValues(i.elevationBoundsMin,i.elevationBoundsMax);else for(const t of s)e.push(t)}}return r}getRootElevationBounds(){return new tb(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getLowerBoundRadius(){const e=(this._ellipsoid.radius+this.visibleElevationBounds.min)*this._radiusModifier;return Math.min(e,this._ellipsoid.radius)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!at(e,Qa(NS),this.spatialReference))return C.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;NS[3]=t;let i=null;const s=e=>{if(e&&Pt(e.extent,NS)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)s(e);else{const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}}},r=this._rootTiles;if(null!=r)for(const e of r)s(e);return i}queryVisibleScaleRange(e,t,i,s){if(!this._scaleRangeQueries)return;const r=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,r+a,n+a,s)}_evaluateTransparency(){const e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,s=this._isFullyTransparent?t?3:2:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?0:1;return this._renderer.transparency=s,i!==s}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;gc(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const t=e?.spatialReference??tt.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&ye(this.view?.renderSpatialReference),this._isGeographic=t?.isGeographic??!1,this._set("tilingScheme",e),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.tileSize=e.pixelSize,this.overlayManager.spatialReference=e.spatialReference,this._updateRootTiles())}static{this._tileMemcacheKey="TerrainTileMemcache"}_acquireTile(e,t,i,s){const r=this._tileCache.pop(HS._tileMemcacheKey);return r?(r.init(e,t,i,s,this),r):new this._tileConstructor(e,t,i,s,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=GS;let s=t.rootTilesInExtent(e,i,5*fd);if(null!=this._rootTiles){if(s.length>fd)return void C.getLogger(this).warn(yd);const e=this._rootTiles.map(e=>e.lij),t=y(e,s,uC);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter(e=>!(t.removed.findIndex(t=>uC(t,e.lij))>-1&&(this._purgeTile(e),1)));t.added.forEach(t=>e.push(this._newRootTile(t))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,s.length>fd&&(C.getLogger(this).warn(vd),s=t.rootTilesInExtent(e,i,fd)),this._setRootTiles(s.map(e=>this._newRootTile(e)));bt(i,this._rootTilesExtent)||(this._rootTilesExtent=lt(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter(e=>e.loaded&&e.intersectsClippingArea);e.sort(Rx),e.forEach(e=>this._renderer.updateTileGeometryState(e)),e.forEach(e=>e.renderData.updateNeighborData()),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(0===e.length)return;e.sort(Rx);const t=this.renderer;e.forEach(e=>t.updateGeometryIfNeeded(e)),e.forEach(e=>this._pendingTilesForElevationUpdateEvent.add(e))}_shouldSplit(e){return 1===e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(1),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles})}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(8)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(null==e)return;const t=function(e){for(let t=0;t<e.length;t++){const i=e[t],s=i.parent;if(s)for(let e=0;e<4;e++){const t=s.children[e];if(t&&t!==i)return!0}}return!1}(e),i=this.visibleElevationBounds;let s=t?i.min:1/0,r=t?i.max:-1/0;const n=this.extent,a=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(e);!o.done;){const e=o.next();e.updateClippingStatus(n)&&e.resetPendingUpdate(8)&&this._updateTileGeometryState(e),e.computeVisibility(),e.updateScreenDepth(a),e.renderData&&(s=Math.min(e.elevationBoundsMin,s),r=Math.max(e.elevationBoundsMax,r))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(s)&&isFinite(r)&&(i.min!==s||i.max!==r)&&(this.visibleElevationBounds=new ww(s,r))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;const i=this._rootTiles;null!=i&&i.forEach(({elevationBoundsMin:i,elevationBoundsMax:s})=>{e=Math.min(e,i),t=Math.max(t,s)});const s=this.rootTileElevationBounds;s.min===e&&s.max===t||(this.rootTileElevationBounds=new ww(e,t))}_updateViewDependentParameters(){const{camera:e,contentCamera:t}=this.view.state,i=Math.tan(.5*t.fovX),s=Math.tan(.5*t.fovY),r=this.tilingScheme.pixelSize,n=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=s,this._splitLimits.relativeWidthLimit=r/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=r/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=od(this._splitLimits.frustum??ad(),t.frustum):this._splitLimits.frustum=null,od(this._frustum,e.frustum),Zi(this._eyePosRenderSR,t.eye),sd(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor(e=>{this._layerViews[1].some(Oc)&&e.setPendingUpdate(32),this._pendingTilesToUpdate.add(e)})}_updateTileTexture(e,t){const i=e.resetPendingUpdate(32)?32:!!e.resetPendingUpdate(16)&&16;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const e=$S.extent;ht(e),this._pendingTilesForElevationUpdateEvent.forEach(t=>mt(e,t.extent,e)),this._pendingTilesForElevationUpdateEvent.clear(),$S.spatialReference=this.spatialReference,this.emit("elevation-change",$S),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),dc&&this._checkTileInvariant(),!e.hasProgressed)return Vn}_checkTileInvariant(){const e=new Map;this._allTiles.forAll(t=>e.set(t,new Set)),this._allTiles.forAll(t=>{if(gc(t.rendered===t.leaf,` rendered ${t.rendered} != ${t.leaf} leaf`),!t.leaf){const e=e=>0===e.unmergableChildCount&&0===e.maxLevelDeltaNeighborCount,i=t.children.reduce((t,i)=>t+(e(i)?0:1),0);if(gc(t.unmergableChildCount===i,` Tile[${t.lij.toString()}] unmergeable child count mismatch: actual ${t.unmergableChildCount} vs ${i}`),t.hasPendingUpdate(4)){gc(!t.hasPendingUpdate(1),"Tile can be both split and merge at the same time");for(const e of t.children)gc(e.leaf||e.hasPendingUpdate(4),"Child of tile to merge must also merge")}}for(let i=0;i<4;++i){if(t.rendered){const e=t.renderData?.geometryState.edgePeerNeighbors[i];if(null!=e){{const s=t.level-e.level<=md;s||(console.log(`tile level delta [${t.lij.toString()}] vs [${e.lij.toString()}] > ${md}  (edge[${i}])`),gc(s,`tile level delta [${t.level}] vs [${e.level}] > ${md}`))}gc(t.level-e.level<=md,`Max tile lod delta exceeded: [${t.lij.toString()}] vs [${e.lij.toString()}]`)}}const s=t.level-md,r=e=>e.leaf||e.level===t.level,n=t.findNeighborTile(lc[i],r);if(null!=n){if(t.leaf&&t.level>=md){let i=n;for(;t.level-i.level<md;)i=i.parent;if(!uC([s,t.lij[1]>>md,t.lij[2]>>md],i.lij)){const s=e.get(i);gc(!s.has(t),"Cannot already have neighbor"),s.add(t)}}gc(n.rendered||n.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),gc(t.level-n.level<=md,`Tile level delta [${t.level}] vs [${n.level}] > ${md}`)}}}),this._allTiles.forAll(t=>{const i=t.maxLevelDeltaNeighborCount,s=e.get(t);gc(i===s.size,`Tile[${t.lij.toString()}] merge-blocker mismatch: actual ${i} vs ${s.size}`)})}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=new YS(this._allTiles.length);t.pushAll(this._rootTiles);const i=this.snapLevel,s=this._splitLimits,r=this._eyePosRenderSR;this._allTiles.forAll(e=>{e.maxLevelDeltaNeighborCount=0,e.unmergableChildCount=0});const n=this.view.state.contentCamera.viewProjectionMatrix;for(;!t.empty;){const e=t.pop(),a=e.parent,o=null!=a&&a.hasPendingUpdate(4),l=o?4:e.shouldSplit(s,r,i),h=1===l;e.leaf?KS(e,h):t.pushAll(e.children),o?(e.resetPendingUpdate(1),e.leaf||e.setPendingUpdate(4),this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(n)):h?(e.resetPendingUpdate(4),e.leaf&&e.setPendingUpdate(1)):(e.resetPendingUpdate(1)&&e.updateAgentSuspension(),2===l&&e.updateAgents(0),e.leaf||(e.setPendingUpdate(4),e.resetPendingUpdate(1)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||!this.view.pointsOfInterest?.focus||(function(e,t){const i=e.length;for(let s=0;s<i;++s)e.at(s).updateDistanceToPOI(t);e.sort(Ix)}(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){ac(e.loaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){const e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter(e=>e.loaded&&e.intersectsClippingArea);if(0===t.length)return void e.clear();const i=(i,s)=>{!s?.loaded||!s.intersectsClippingArea||s.level<i.level||e.has(s)||(e.add(s),t.push(s),s.renderData.updateNeighborData())};t.sort(Rx);const s=t.length;for(let r=0;r<s;++r){const s=t[r];ac(s.loaded),ac(s.intersectsClippingArea);const n=s.renderData;n.updateNeighborData();const a=n.dirtyEdgeResolutions,o=n.geometryState,l=e=>{const t=cc[e];i(s,o.cornerPeerNeighbors[e]?.findCorner(bc(t),e=>e.loaded))};for(let t=0;t<4;++t)if(a&1<<t){const r=n.geometryState.edgePeerNeighbors[t];r&&r?.level>=s.level&&r.forAllSubtreeOnSide(hc(lc[t]),t=>!(!t.loaded||!t.intersectsClippingArea||(ac(e.has(t)||Rx(s,t)<0),i(s,t),0))),l((t+1)%4),l(t)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,dc&&xc&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const s=this.view.state.fixedContentCamera;let r=!1;for(;!e.done;){r=!0;let n=!1;const a=!this._allTiles.some(r=>{if(!i&&!s&&!r.visible)return e.done;let a=r;if(r.hasPendingUpdate(4)){if(!t||r.unmergableChildCount>0)return e.done;for(r.resetPendingUpdate(4);null!=a.parent&&0===a.parent.unmergableChildCount&&a.parent.resetPendingUpdate(4);)a=a.parent;this._mergeTile(a),n=!0,e.madeProgress()}else if(r.resetPendingUpdate(1)){let t=!0;const i=r.level;if(i>=md){const e=e=>e.leaf||i-e.level<md;for(let s=0;s<4;++s){const n=r.findNeighborTile(lc[s],e);null!=n&&i-n.level===md&&(t=!1,dc&&(ac(n.leaf),ac(n.hasPendingUpdate(1))))}}t?(this._splitTile(r),e.madeProgress(),n=!0):r.setPendingUpdate(1)}return e.done});if(n&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),a){if(!i){i=!0;continue}if(!n)break}else this._allTilesDirty=!0}r?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some(t=>(t.resetPendingUpdate(8)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done)),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some(t=>(this._updateTileTexture(t,e),e.done))}_updateClippingExtent(){this.spatialReference&&(this.overlayManager?.updateOverlayParameters(1),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*bd}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=Ci(e-this._lodBias,0,t.length-1),s=i-Math.floor(i);return t[Math.floor(i)].scale*(1-s)+t[Math.ceil(i)].scale*s}_removeAllTiles(){null!=this._rootTiles&&(this._rootTiles.forEach(e=>this._purgeTile(e)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles}),this.renderer.visible=!1}_purgeSubtree(e){const t=e.children;t[0]&&(this._purgeTile(t[0]),this._purgeTile(t[1]),this._purgeTile(t[2]),this._purgeTile(t[3]),e.clearChildren())}_purgeTile(e){e.leaf?JS(e):this._purgeSubtree(e),this._allTiles.removeUnordered(e),this._unloadTile(e),e.dispose(),this._tileCache.put(HS._tileMemcacheKey,e),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles})}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload()}_splitTile(e){gc(e.leaf,"Tile that is already split should not be split again!"),gc(e.rendered,"Tile marked to split is not rendered"),JS(e);const t=e.createChildren();this._allTiles.pushArray(t),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles}),e.updateAgentSuspension(),gc(e.rendered,"parent should be rendered"),t.forEach(e=>this._loadTile(e)),t.forEach(e=>this._pendingTilesToUpdate.add(e)),this._unloadTile(e),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),t.forEach(e=>KS(e,e.hasPendingUpdate(1))),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){QS.spatialReference=this.spatialReference,QS.extent=e.extent,QS.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",QS)}createTile(e,t,i,s){gc(!!s,"createTile sanity check");const r=this._acquireTile(e,t,i,s);return r.updateClippingStatus(this.extent),r.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(r)&&r.setPendingUpdate(1),r}get _shortBatches(){return 2!==this.view.state.mode}_mergeTile(e){gc(!e.hasPendingUpdate(1),"_mergeTile sanity check"),gc(!e.leaf,"Cannot merge a leaf"),e.leaf||(this._purgeSubtree(e),gc(!e.renderData,"Merging tile with existing render data?"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),KS(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager?.hasOverlays&&this.overlayManager.updateTileOverlayParameters(e)}_handleLayerViewChanges(e=Hn){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let s=-1;for(let e=this.view.allLayerViews.length-1;e>=0;e--){const r=this.view.allLayerViews.items[e];if(i.add(r.uid),Fc(r)||jc(r))if(this._basemapLayerViewHandles.has(r.uid)&&!jc(r)){const e=this._layerClassFromLayerView(r),i=this.getLayerIndexByUID(e,r.uid);null!=i&&((i<s||null==s)&&(t=!0),s=i)}else this._registerTiledLayerView(r),r.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach((e,s)=>{i.has(s)||(this._unregisterTiledLayerView(s),t=!0)}),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}get _isFullyTransparent(){if(this.view.map?.ground?.opacity>0)return!1;for(const e of this.view.allLayerViews.items)if(zc(e)&&!Ft(e.layer)&&0!==e.fullOpacity)return!1;return!0}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if((vc(e)||jc(e))&&BT(UT[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return Hc(e)?0:1}_registerTiledLayerView(e){const t=[];if((vc(e)||jc(e))&&t.push(B(()=>e.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(2)})),!jc(e)){const i=this._layerClassFromLayerView(e);t.push(B(()=>!e.destroyed&&e.suspended,()=>this._updateTiledLayers())),t.push(B(()=>!e.destroyed&&e.fullOpacity,()=>this._updateTileTextures(2)));const{layer:s}=e;"effectiveScaleRange"in s&&t.push(B(()=>!e.destroyed&&s.effectiveScaleRange,()=>this._restartAllAgents(i))),t.push(e.on("data-changed",()=>{const t=this.getLayerIndexByUID(i,e.uid);null!=t&&this._invalidateLayerData(t,i)}))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach(e=>{if(!e.layer||e.suspended||!Fc(e)||!e.fullExtent)return;const s=this._layerClassFromLayerView(e);if(1===s){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===i||t>i)&&(i=t)}t[s].push(e)});for(const e of Ow){const i=this._layerViews[e],s=t[e];s.reverse();const r=s.length;let n=i.length!==r;const a=new Array(r),o=new Array(i.length);this._layerIndexByUid[e].clear();for(let t=0;t<r;t++){const r=s[t].uid;this._layerIndexByUid[e].set(r,t);const l=i.indexOf(s[t]);a[t]=l,t!==l&&(n=!0),l>-1&&(o[l]=t)}if(n){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;)t.next().modifyLayers(o,a,e);this._layerViews[e]=s,this._restartAllAgents(e),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const i=t.next();i.restartAgents(e),0===e&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(t=>{t.updateAgents(1),1===e?this.renderer.updateTileTexture(t,16):t.updateRenderData(1,e)}),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll(i=>i.removeLayerAgent(e,t)),this._allTiles.forAll(i=>i.invalidateLayerData(e,t))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=1){this.renderer.setNeedsRender(e)}requestUpdate(){1===++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,s){const r=this.layerViewByIndex(t,i),n=r.layer;return!n.tilemapCache||Oc(r)?this._requestTileData(e,i,r,s):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.level,e.lij[1],e.lij[2],{...s,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(t=>{throw--this._asyncWorkItems,V(s),F(t)||this._dataMissing(e,i,r),t}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,i,r,s),s.signal)))}_requestTileData(e,t,i,s){if(this.destroying)return Promise.resolve();const r=0===t;return s.requester??=r?this._elevationDataRequester:this._mapDataRequester,r?Hc(i)?this._requestElevationTileData(e,i,s):Promise.reject():zc(i)?this._requestMapTileData(e,i,s):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const s=s=>{!E(i)&&s&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(e,t,s))};return t.fetchElevationTile(e,i).then(e=>this._frameTask.schedule(()=>s(e)),i=>{F(i)||(C.getLogger(this).error(`Tile ${e.lij.toString()} layer 0/${t.uid} error ${i}`),this._dataMissing(e,0,t),this.requestUpdate())}).finally(()=>--this._asyncWorkItems)}_elevationDataArrived(e,t,i){const s=this._layerIndexByUid[0].get(t.uid);if(null==s)return void C.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString());const r=new xw(e.lij,e.extent,i);e.dataArrived(s,0,r),this.emit("tile-data-changed",{tile:e,layerIndex:s,layerClass:0});const n=[e],a=e.level,o=this._iteratorPool.acquire();for(o.reset(n);!o.done;){const e=o.next();e.findElevationBoundsForLayer(s,a),e.computeElevationBounds()}0===a&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(n)}_requestMapTileData(e,t,i){++this._asyncWorkItems;const s=(s,r)=>{mc(r),E(i)||(console.error(`Tile ${e.lij.toString()} layer 1/${t.uid} error ${s}`),this._dataMissing(e,1,t),this.requestUpdate())},r=e=>t=>s(t,e);return t.fetchTile(e.lij,i).then(s=>this._frameTask.schedule(()=>{this.requestUpdate(),E(i)?mc(s):this._mapTileDataArrived(e,t,s)},i.signal,r(s)).catch(r(s)),(e,t=null)=>this._frameTask.schedule(()=>s(e,t))).finally(()=>--this._asyncWorkItems)}_mapTileDataArrived(e,t,i){const s=this.getLayerIndexByUID(1,t.uid);if(null==s)return mc(i),void C.getLogger(this).warn("TerrainSurface: received data from unknown layer");e.dataArrived(s,1,i),this.emit("tile-data-changed",{tile:e,layerIndex:s,layerClass:1})}_dataMissing(e,t,i){const s=this.getLayerIndexByUID(t,i.uid);null!=s?(e.dataMissing(s,t),this.emit("tile-data-changed",{tile:e,layerIndex:s,layerClass:t})):C.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(t=>{t.leaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce((e,t)=>e+t.usedMemory,0)):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),s=this.getLayerIndexByUID(i,e.uid);return null!=s&&this._allTiles.forAll(e=>t+=e.getUsedMemoryForLayer(i,s)),t}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){}checkAllTilesWaterproofness(){if(!xc)return;const e=this._rootTiles;if(null==e)return;const t=e=>e?.renderData?.geometry?.indices?.length>0,i=(e,i)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",i.lij,"] has geom")},s=e=>{if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometry&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!e.renderData?.geometry||(e.renderData.geometry.indices?.length??0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometry),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)i(t,e)}else if(e.leaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)s(t)},r=e=>{const t=e.parent?.visible??!0,i=e.visible;e.computeVisibility();const s=e.visible;if(i!==s&&t&&console.error(" Tile[",e.lij,"] has out of date visibility: ",i," instead of ",s),!e.leaf)for(const t of e.children)r(t)};for(const t of e)s(t),r(t)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&0===e[2]}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this._isGlobal)return null;const s=(i+(i<0?t:0))%t;return[e[0],e[1],s]}enableInternalChecks(e){qc(e)}enableWaterproofnessChecks(e){Uc(e)}static cleanupTerrainSurface(){WS.prune()}enable(e){e!==this._enabled&&(e?(this._updateRootTiles(),this.suspended=!1):(this.suspended=!0,this._removeAllTiles(),this._setRootTiles(null)),this._enabled=e)}};e([Ce()],qS.prototype,"_renderer",void 0),e([Ce({constructOnly:!0})],qS.prototype,"_scaleRangeQueries",void 0),e([Ce({constructOnly:!0})],qS.prototype,"view",void 0),e([Ce({constructOnly:!0})],qS.prototype,"overlayManager",void 0),e([Ce({constructOnly:!0})],qS.prototype,"terrainTextureCompressionTracker",void 0),e([Ce()],qS.prototype,"_hasPendingUpdates",void 0),e([Ce()],qS.prototype,"_asyncWorkItems",void 0),e([Ce()],qS.prototype,"_allTilesDirty",void 0),e([Ce()],qS.prototype,"_allTilesSorted",void 0),e([Ce()],qS.prototype,"_viewChanged",void 0),e([Ce({type:Number})],qS.prototype,"heading",void 0),e([Ce()],qS.prototype,"_splitLimits",void 0),e([Ce({readOnly:!0})],qS.prototype,"_watchUpdatingTracking",void 0),e([Ce()],qS.prototype,"_frameTask",void 0),e([Ce()],qS.prototype,"demResolution",null),e([Ce({readOnly:!0})],qS.prototype,"snapLevel",null),e([Ce({readOnly:!0})],qS.prototype,"lodSnappingEnabled",null),e([Ce()],qS.prototype,"_userClippingExtent",null),e([Ce()],qS.prototype,"_rootTilesExtent",void 0),e([Ce({readOnly:!0})],qS.prototype,"extent",null),e([Ce({readOnly:!0})],qS.prototype,"groundExtent",null),e([Ce({readOnly:!0})],qS.prototype,"_tilingSchemeExtent",null),e([Ce({readOnly:!0})],qS.prototype,"updating",null),e([Ce({readOnly:!0})],qS.prototype,"readyToRun",null),e([Ce(bw)],qS.prototype,"updatingProgress",void 0),e([Ce({readOnly:!0})],qS.prototype,"updatingProgressValue",null),e([Ce()],qS.prototype,"_maxNumUpdating",void 0),e([Ce()],qS.prototype,"baseOpacity",null),e([Ce()],qS.prototype,"hasCompositeBlendMode",void 0),e([Ce({readOnly:!0})],qS.prototype,"viewingMode",null),e([Ce()],qS.prototype,"maxTextureScale",void 0),e([Ce({readOnly:!0})],qS.prototype,"ready",null),e([Ce({readOnly:!0})],qS.prototype,"rootTiles",null),e([Ce()],qS.prototype,"_rootTiles",void 0),e([Ce({readOnly:!0})],qS.prototype,"spatialReference",null),e([Ce({type:Jc})],qS.prototype,"backgroundColor",null),e([Ce({value:!1})],qS.prototype,"slicePlaneEnabled",null),e([Ce({readOnly:!0})],qS.prototype,"tilingScheme",void 0),e([Ce({readOnly:!0})],qS.prototype,"tilingSchemeLocked",null),e([Ce({readOnly:!0})],qS.prototype,"tilingSchemeLogic",void 0),e([Ce()],qS.prototype,"wireframe",null),e([Ce({value:!1})],qS.prototype,"suspended",null),e([Ce()],qS.prototype,"fadeDuration",null),e([Ce()],qS.prototype,"visibleElevationBounds",void 0),e([Ce()],qS.prototype,"rootTileElevationBounds",void 0),e([Ce()],qS.prototype,"_layerViewsDirty",void 0),e([Ce()],qS.prototype,"renderPatchBorders",null),e([Ce()],qS.prototype,"visualizeNormals",null),e([Ce()],qS.prototype,"renderingDisabled",null),qS=HS=e([Se("esri.views.3d.terrain.TerrainSurface")],qS);const US=qS,BS=ke(),NS=$a(),GS=lt(),WS=new Xl,$S=new ho("ground"),QS={spatialReference:null,extent:null,scale:0};function ZS(e,t,i){for(const s of e){if(!s.containsPointXY(t,i))continue;let e=s;for(;e&&!e.renderData;){const s=(t>e.extentMidX?1:0)+(i<e.extentMidY?2:0);e=e.children[s]}return Tw(t,i,e?.renderData?.geometryState.samplerData??null)}return null}class YS{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(0===t)return;const i=this._tail;if(!(i+t<=this.capacity))throw new Error("Queue full");for(let s=0;s<t;++s)this._data[i+s]=e[s];this._tail=i+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function KS(e,t){!e.leaf||e.level<md||tP(e,e=>{t&&XS(e);const i=eP(e);if(e.maxLevelDeltaNeighborCount++,i){let t=e.parent;for(;t;){const e=eP(t);if(t.unmergableChildCount++,!e)break;t=t.parent}}})}function XS(e){if(e.hasPendingUpdate(1))return;let t=e.parent;for(;t?.resetPendingUpdate(4);)t=t.parent;e.resetPendingUpdate(4),e.leaf&&e.setPendingUpdate(1),e.level<md||tP(e,e=>{XS(e)})}function JS(e){e.level<md||tP(e,e=>{if(e.maxLevelDeltaNeighborCount--,0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount){let t=e.parent;for(;t&&(t.unmergableChildCount--,eP(t));)t=t.parent}})}function eP(e){return 0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount}function tP(e,t){if(e.level<md)return;const i=e.level-md,s=e.lij[1]>>md,r=e.lij[2]>>md,n=e=>e.leaf||e.level===i;for(let a=0;a<4;++a){const o=e.findNeighborTile(lc[a],n);if(!o||o.level!==i)continue;const l=o.lij;l[1]===s&&l[2]===r||t(o)}}class iP{constructor(e,t,i,s){this.operation=e,this.geometry=t,this.states=i,this.sync=s}}let sP=class extends Oe{constructor(e){super(e),this._residentGeomRecords=new Rd,this._dirtyGeomRecords=new Rd,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(e,t){const i=this._dirtyGeomRecords.getInner(e),s=this.model.getLayer(e);if(!i||!s)return;let r=0;i.forEach((i,n)=>{const a=this._ensureGeomRecord(e,n);this._dirtyGeomRecords.delete(e,n),r+=i.size,i.forEach(({geometry:e,operation:i,states:r},o)=>{let l=!1;if(1===i){const i=a.get(o);if(i){if(4&r){const t=s.getObject(n);this.model.updateRenderGeometryTransformation(t,e,i)&&(l=!0)}l||t.updates.push({renderGeometry:i,updateType:r})}else Kh(!1,"ModelDirtySet.commitLayer: invalid update")}if(2===i||l){const e=a.get(o);e?(t.removes.push(e),a.delete(o)):2===i&&Kh(!1,"ModelDirtySet.commitLayer: invalid remove")}if(0===i||l){const i=s.getObject(n);if(null!=i){const s=this.model.getRenderGeometry(i,e);t.adds.push(s),a.set(o,s)}}}),0===a.size&&this._residentGeomRecords.delete(e,n)}),this._dirtyRecordCount-=r}commitSyncUpdates(e,t){const i=this._dirtyGeomRecords.getInner(e),s=this.model.getLayer(e);i&&s&&i.forEach((i,r)=>{const n=this._ensureGeomRecord(e,r);i.forEach(({geometry:e,operation:i,states:a,sync:o},l)=>{let h=!1;if(1===i&&o){const i=n.get(l);if(i){if(4&a){const t=s.getObject(r);this.model.updateRenderGeometryTransformation(t,e,i)&&(h=!0)}h||t.updates.push({renderGeometry:i,updateType:a})}else Kh(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}})})}_objectStateChanged(e,t){for(const i of t.geometries)this._updateOrCreateDirtyRecord(t,i,1,e)}visibilityChanged(e){this._objectStateChanged(1,e)}highlightChanged(e){this._objectStateChanged(8,e)}occlusionChanged(e){this._objectStateChanged(16,e)}attributesChanged({object:e,geometry:t,sync:i}){this._updateOrCreateDirtyRecord(e,t,1,2,i)}layerAdded(e){e.objects.forEach(e=>this.layerObjectAdded(e))}layerRemoved(e){e.objects.forEach(e=>this.layerObjectRemoved(e))}layerObjectAdded(e){for(const t of e.geometries)this._geometryAdded(e,t)}layerObjectRemoved(e){for(const t of e.geometries)this._geometryRemoved(e,t)}layerObjectsAdded(e){for(const t of e)this.layerObjectAdded(t)}layerObjectsRemoved(e){for(const t of e)this.layerObjectRemoved(t)}transformationChanged(e){const t=this._getLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(({geometry:t})=>this._updateOrCreateDirtyRecord(e,t,1,4))}shaderTransformationChanged(e){const t=this._getLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(t=>t.objectShaderTransformationChanged(e.shaderTransformation))}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t){this._updateOrCreateDirtyRecord(e,t,0)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t){this._updateOrCreateDirtyRecord(e,t,2)}_updateOrCreateDirtyRecord(e,t,i,s=0,r=!1){const n=this._getLayerId(e),a=e.id,o=t.id,l=this._ensureDirtyRecord(n,a),h=l.get(o);if(h){const e=h.operation;2===e&&0===i&&0!==h.states?h.operation=1:2===e&&0===i||0===e&&2===i?(l.delete(o),this._dirtyRecordCount--):1!==e||2!==i&&1!==i?(Kh((2===e||0===e)&&1===i,"ModelDirtySet.objectGeometryAdded: inconsistent state"),h.states|=s):(h.operation=i,h.states|=s),h.sync=h.sync||r}else l.set(o,new iP(i,t,s,r)),this._dirtyRecordCount++}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e,t);return i||(i=new Map,this._residentGeomRecords.set(e,t,i)),i}assertLayerClean(e){Kh(null==this._dirtyGeomRecords.getInner(e),"Dirty geometry records for removed layer")}_ensureDirtyRecord(e,t){const i=this.model.getLayer(e);Kh(null!=i,"Updating geometry record for an unregistered layer");let s=this._dirtyGeomRecords.get(e,t);return s||(s=new Map,this._dirtyGeomRecords.set(e,t,s)),s}_getLayerId(e){return e.layer?.id??Ee}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forAll((i,s,r)=>{t.length>0&&(t+="\n"),t+=s+"."+r;const n=[];i.forEach(e=>{const t=e.operation;n[t]||(n[t]=[]),n[t].push(e.geometry.id)});for(let i=0;i<n.length;i++)if(n[i]){t+=" "+e[i-1]+": ";for(let e=0;e<n[i].length;e++)t+=n[i][e]+", "}}),t}get test(){}};e([Ce({constructOnly:!0})],sP.prototype,"model",void 0),e([Ce()],sP.prototype,"_dirtyRecordCount",void 0),sP=e([Se("esri.views.3d.webgl-engine.lib.ModelDirtySet")],sP);const rP=sP;let nP=class extends Oe{constructor(){super(...arguments),this.dirtySet=new rP({model:this}),this._originFactory=new Cd(null),this._textures=new Map,this._layers=new Map}hasTexture(e){return this._textures.has(e.id)}getTexture(e){return null==e?null:this._textures.get(e)}addTexture(e){const t=e.id;Kh(!this._textures.has(t),"Model/Stage already contains texture to be added"),this._textures.set(t,e)}removeTexture(e){return this._textures.delete(e.id)}addTextures(e){for(const t of e)t&&(Kh(!this._textures.has(t.id),"Model/Stage already contains object to be added"),this._textures.set(t.id,t))}removeTextures(e){for(const t of e)t&&(Kh(this._textures.has(t.id),"Model/Stage doesn't contain object to be removed"),this._textures.delete(t.id))}forEachTexture(e){this._textures.forEach(t=>e(t))}hasLayer(e){return this._layers.has(e.id)}getLayer(e){return null==e?null:this._layers.get(e)}addLayer(e){const t=e.id;Kh(!this._layers.has(t),"Model/Stage already contains layer to be added"),this._layers.set(t,e)}removeLayer(e){return this._layers.delete(e.id)}getRenderGeometry(e,t){const i=new _a(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation}),s=t.localOrigin;return i.transformation=e.getCombinedStaticTransformation(t,aP),i.localOrigin=s??this._originFactory.getOrigin(Qa(i.boundingSphere)),i}updateRenderGeometryTransformation(e,t,i){if(null==e)return!1;i.transformation=e.getCombinedStaticTransformation(t,aP);const s=this._originFactory.getOrigin(Qa(i.boundingSphere));return i.localOrigin!==s}get test(){}};e([Ce({constructOnly:!0})],nP.prototype,"dirtySet",void 0),nP=e([Se("esri.views.3d.webgl-engine.parts.Model")],nP);const aP=Fs();class oP extends xr{constructor(){super(...arguments),this.radii=Gs(),this.heightParameters=ul()}}function lP(e){e.uniforms.add(new tr("radii",e=>e.radii),new Qr("heightParameters",e=>e.heightParameters)),e.constants.add("scaleHeight","float",de.scaleHeight*de.atmosphereHeight),e.code.add(br`float chapmanApproximation(float thickness, float height, float cosZenith) {
float c = sqrt(thickness + height);
float cExpH = c * exp(-height);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (thickness + height);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(thickness - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),e.code.add(br`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),e.code.add(br`vec4 planetIntersect(vec3 cameraPos, vec3 rayDir) {
float reducedPlanetRadius = radii[0] - 20000.0;
float rayPlanetDistance = heightParameters[1] - reducedPlanetRadius * reducedPlanetRadius;
vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, rayPlanetDistance);
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, heightParameters[2]);
bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
bool insideAtmosphere = heightParameters[0] < radii[1];
if (!(hitsAtmosphere || insideAtmosphere)) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;
if (heightParameters[0] < reducedPlanetRadius) {
if (dot(rayDir, normalize(cameraPos)) < -0.025) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
start = rayPlanetIntersect.y;
}
float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
return vec4(0.0, hitsPlanet ? 1.0 : 0.0, start, end);
}`)}function hP(e,t){e.include(lP),e.uniforms.add(new Rr("cameraPosition",e=>e.camera.eye)),e.constants.add("betaRayleigh","vec3",mi),e.constants.add("betaCombined","vec3",gi),e.constants.add("betaMie","float",_i),e.code.add(br`
    vec3 raymarchAtmosphere(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      vec4 ray = planetIntersect(cameraPos, rayDir);
      if(ray.x == 1.0) {
        return vec3(0);
      }
      ${wr(t,"if (terrainDepth != -1.0) { ray.w = terrainDepth; }")}

      vec3 samplePoint = cameraPos + rayDir * ray.w;
      float multiplier = ray.y == 1.0 ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (ray.w - ray.z) / ${br.float(6)};

      for (int i = 0; i < ${br.int(6)}; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
          ${wr(!t,"scattering *= mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0))")};
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {
          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);
          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${wr(!t,"scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);")}
        }
        lastOpticalDepth = opticalDepth;
      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;
      ${t?"return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;":br`const float g = 0.8;
             const float gg = g * g;
             float phaseMie = 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg));
             phaseMie = clamp(phaseMie, 0.0, 128.0);
             return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }`)}function cP(e,t={needUVs:!0,needEyeDirection:!0}){e.attributes.add("position","vec2"),e.varyings.add("worldRay","vec3");const{needUVs:i,needEyeDirection:s}=t;i&&e.varyings.add("uv","vec2"),s&&e.varyings.add("eyeDir","vec3"),e.vertex.uniforms.add(new Or("inverseProjectionMatrix",e=>e.camera.inverseProjectionMatrix),new Or("inverseViewMatrix",e=>Is(dP,e.camera.viewMatrix))),e.vertex.main.add(br`
    vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
    ${wr(s,"eyeDir = posViewNear;")}
    worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
    ${wr(i,"uv = position * 0.5 + vec2(0.5);")}
    gl_Position = vec4(position, 1, 1);
  `)}const dP=Fs(),uP=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new mn;t.include(cP);const{reduced:i}=e,{fragment:s}=t;return Dd(s),s.include(pr),s.include(Kp),s.include(Hd),s.include(hP,!1),s.uniforms.add(new cr("backgroundColor",e=>e.backgroundColor),new lr("innerFadeDistance",e=>e.innerFadeDistance),new lr("altitudeFade",e=>e.altitudeFade),new Br("depthTexture",e=>e.mainDepth)).code.add(br`vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
float rayPlanetDistance = heightParameters[1] - radii[0] * radii[0];
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, rayPlanetDistance);
if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
return fragColor;
}
float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
if (relDist > 1.0) {
return surfaceColor;
}
return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
}
float getGlow(float dist, float radius, float intensity) {
return pow(radius / max(dist, 1e-6), intensity);
}
vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){
float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));
vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));
float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));
return normalize(sunTransmittance) * sunDisc;
}`).main.add(br`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${wr(!i,br`float depthSample = texture(depthTexture, uv).r;
             if (depthSample != 1.0) {
                fragColor = vec4(0);
                return;
             }`)}

      vec3 col = linearizeGamma(backgroundColor);
      col += raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      col += getSun(cameraPosition, rayDir, mainLightDirection);
      float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);
  `),t}},Symbol.toStringTag,{value:"Module"}));class pP extends oP{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=ke()}}class mP extends Tr{constructor(e,t){super(e,t,new Sr(uP,()=>Promise.resolve().then(()=>uP)),na(sr))}initializePipeline(e){return gn({blending:e.reduced?yn:fn(770,771),depthTest:{func:e.reduced?519:515},colorWrite:_n})}}class gP extends Mr{constructor(){super(...arguments),this.reduced=!1}}e([Pr()],gP.prototype,"reduced",void 0);class _P extends xr{}const fP=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:_P,build:function(){const e=new mn;return e.include(er),e.fragment.uniforms.add(new hr("colorTexture",e=>e.color),new Br("depthTexture",e=>e.mainDepth)),e.fragment.main.add(br`float depthSample = texture(depthTexture, uv).r;
if (depthSample != 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}},Symbol.toStringTag,{value:"Module"}));class yP extends Tr{constructor(e,t){super(e,t,new Sr(fP,()=>Promise.resolve().then(()=>fP)),ir)}initializePipeline(){return gn({blending:fn(770,771),depthTest:{func:519},colorWrite:_n})}}let vP=class extends xm{constructor(){super(...arguments),this.requireGeometryDepth=!0,this._compositingPassParameters=new _P,this._vao=null,this._passParameters=new pP,this._configuration=new gP}initialize(){this.techniques.precompile(mP,this._configuration),this.techniques.precompile(yP),this._configuration.reduced=!0,this.techniques.precompile(mP,this._configuration),this._configuration.reduced=!1,this.addHandles([B(()=>this.view.environment.background,e=>{const t=e instanceof Hu?zu(e.color):ml;qi(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])},G),B(()=>this.view.stage?.renderer?.fullResolutionAtmosphere,e=>this._configuration.reduced=!e,G),B(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),G)])}destroy(){this._vao=M(this._vao)}render(e){const t=e.find(({name:e})=>e===ii.OPAQUE_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??=VT(i,1);const s=t.getAttachment($n);this._update();const r=this.techniques.get(mP,this._configuration);if(!r.compiled)return this.requestRender(1),t;if(!this._configuration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Un.TRIANGLE_STRIP,0,4),t.attachDepth(s),t;const n=this.techniques.get(yP);if(!n.compiled)return this.requestRender(1),t;const a=i.getViewport(),o=this.bindParameters.camera,l=$i(o.eye)-de.radius;let h;const c=de.atmosphereHeight;if(l<c){const e=Math.min(1,Math.max(0,l/c));h=Pi(.2,.3,e)}else{const e=Math.min(1,Math.max(0,(l-c)/(15*c)));h=Pi(.3,.6,e)}const d=this.renderingContext.parameters.maxTextureSize,u=Lr(Math.round(h*o.fullViewport[2]),d),p=Lr(Math.round(h*o.fullViewport[3]),d);i.setViewport(0,0,u,p);const m=this.fboCache.acquire(u,p,"chapman",5);return i.bindFramebuffer(m.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Un.TRIANGLE_STRIP,0,4),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=m.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(s),m.release(),t}_update(){const e=this.bindParameters.camera,t=ts(e.eye),i=Math.sqrt(t),s=t-this._passParameters.radii[1]**2,r=Ci((i-this._passParameters.radii[0])/de.atmosphereHeight,0,1);rl(this._passParameters.heightParameters,i,t,s,r);const n=this.view.basemapTerrain?.getLowerBoundRadius()??0;Hs(this._passParameters.radii,n,n+de.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*n-fi)*fi),this._passParameters.altitudeFade=yi(i-n)}};vP=e([Se("esri.views.3d.environment.ChapmanAtmosphere")],vP);const bP=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new mn,{fragment:t}=e;return e.include(cP,{needUVs:!1,needEyeDirection:!1}),t.include(Fr),t.include(qu),e.include(qd,{pbrMode:0,lightingSphericalHarmonicsOrder:2}),t.include(Zr),t.include(pr),e.include(bh),t.uniforms.add(new Rr("cameraPosition",e=>e.camera.eye),new Yr("cloudsOpacity",e=>e.clouds.opacity)).main.add(br`vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4(cloudsOpacity * cloudsColor.rgb, cloudsColor.a);`),e}},Symbol.toStringTag,{value:"Module"}));class wP extends Tr{constructor(e,t){super(e,t,new Sr(bP,()=>Promise.resolve().then(()=>bP)),ir)}initializePipeline(){return gn({blending:vn(1,0,770,1),depthTest:{func:515},colorWrite:_n})}}let xP=class extends xm{constructor(e){super(e),this._planetRadius=ge(e.view.spatialReference).radius}initialize(){this.techniques.precompile(wP),this.addHandles([B(()=>null!=this.view.environment.weather&&this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),N)])}destroy(){this._vao=M(this._vao)}render(e){const t=e.find(({name:e})=>e===ii.OPAQUE_ENVIRONMENT),i=this.bindParameters.clouds;if(!i.data)return t;const s=this.techniques.get(wP);if(!s.compiled)return this.requestRender(1),t;const r=this.renderingContext;this._vao??=VT(r);const n=r.bindTechnique(s,this.bindParameters);return r.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Un.TRIANGLE_STRIP,0,4),i.isFading&&this.requestRender(1),t}};xP=e([Se("esri.views.3d.environment.CloudsComposition")],xP);class CP extends xr{constructor(){super(...arguments),this.color=ke(),this.strength=4e-6,this.atmosphereC=1,this.amount=0}}const TP=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:CP,build:function(){const e=new mn;e.include(cP,{needUVs:!0,needEyeDirection:!0});const t=e.fragment;return t.uniforms.add(new lr("atmosphereC",e=>e.atmosphereC),new Rr("cameraPosition",e=>e.camera.eye),new Br("depthTexture",e=>e.mainDepth),new lr("fogStrength",e=>e.strength),new lr("fogAmount",e=>e.amount),new cr("fogColor",e=>e.color)),t.include(pr),t.include(Kp),t.include(Hd),t.include(Kr),t.code.add(br`float getFogAmount(float dist, vec3 rayDir) {
if(dist == -1.0){
dist = 0.055 * sphereIntersect(cameraPosition, rayDir, atmosphereC).y;
}
return fogAmount * (1.0 - exp(-dist * fogStrength));
}`),t.main.add(br`vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = depthFromTexture(depthTexture, uv);
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linearizeDepth(depthSample);;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
float fogAmount = getFogAmount(terrainDepth, rayDir);
vec4 fog = vec4(fogColor, 1.0) * fogAmount;
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));`),e}},Symbol.toStringTag,{value:"Module"}));class SP extends Tr{constructor(e,t){super(e,t,new Sr(TP,()=>Promise.resolve().then(()=>TP)),ir)}initializePipeline(){return gn({blending:vn(770,0,771,1),colorWrite:_n})}}let PP=class extends Cm{constructor(e){super(e),this.requireGeometryDepth=!0,this._newParameters=new MP,this._oldParameters=new MP,this._fadedParameters=new MP,this._parameters=this._newParameters,this._passParameters=new CP;const t=ge(e.view.spatialReference);this._planetRadius=t.radius,this._atmosphereRadius=t.radius+t.atmosphereHeight,e.view.stage?.renderView.techniques.precompile(SP)}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([B(()=>this.view.environment.atmosphereEnabled,()=>this.toogle(),G),B(()=>this.view.environment.weather,()=>this.toogle(),G),B(()=>this._updateFogParameters(),()=>{},G)]),this.addHandles(B(()=>this._fadeFactor,e=>this._fade(e),G))}get _fadeFactor(){return this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1}_fade(e){const{_newParameters:t,_oldParameters:i}=this;e>=1?(this._parameters=t,this._oldParameters.copyFrom(this._newParameters)):e<=0?this._parameters=i:(this._fadedParameters.lerp(i,t,e),this._parameters=this._fadedParameters)}_updateFogParameters(){const e=this.view.environment.weather,t="foggy"===e.type||"snowy"===e.type||"rainy"===e.type;this._newParameters.strength="foggy"===e.type?Pi(3e-5,.005,e.fogStrength**3):"snowy"===e.type||"rainy"===e.type?Pi(4e-6,2e-4,(e.precipitation??0)**3):0,this._newParameters.amount=t?1:0,"foggy"!==e.type&&"snowy"!==e.type||Zi(this._newParameters.color,AP),"rainy"===e.type&&Zi(this._newParameters.color,DP),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(1)}render(e){const t=e.find(({name:e})=>e===ii.TRANSPARENT_ENVIRONMENT);if(0===this._parameters.amount)return t;if(this._update(),this._passParameters.amount<=0)return t;const i=this.techniques.get(SP);if(!i.compiled)return this.requestRender(1),t;const s=this.renderingContext,r=t.getAttachment($n);return t.attachDepth(null),s.bindFramebuffer(t.fbo),s.bindTechnique(i,this.bindParameters,this._passParameters),s.screen.draw(),t.attachDepth(r),t}_update(){const e=this.bindParameters.camera;Ni(RP,e.eye);const t=Math.max(0,Gi(RP,this.bindParameters.lighting.mainLight.direction)),i=this._parameters.color;Bi(OP,i,.1),Wi(this._passParameters.color,OP,i,t);const s=$i(e.eye);this._passParameters.atmosphereC=s**2-this._atmosphereRadius**2,this._passParameters.amount=(1-Ai(.95*la,1*la,Math.abs(s-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}};PP=e([Se("esri.views.3d.environment.Fog")],PP);class MP{constructor(){this.color=ke(),this.strength=0,this.amount=0}copyFrom(e){this.amount=e.amount,this.strength=e.strength,Zi(this.color,e.color)}lerp(e,t,i){this.amount=Pi(e.amount,t.amount,i),this.strength=Pi(e.strength,t.strength,i),Wi(this.color,e.color,t.color,i)}}const RP=ke(),OP=ke(),DP=Ve(.5,.5,.5),AP=Ve(1.5,1.5,1.5);class EP extends xr{constructor(){super(...arguments),this.texV=Gs(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new IP}}class IP{constructor(){this.center=ke(),this.v1=ke(),this.v2=ke()}}const LP=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:IP,SimpleAtmospherePassParameters:EP,build:function(e){const t=new mn,{vertex:i,fragment:s}=t;if(Dd(i),2===e.geometry)t.attributes.add("position","vec2"),t.varyings.add("color","vec4"),i.uniforms.add(new Rr("cameraPosition",e=>e.camera.eye),new lr("undergroundFadeAlpha",e=>e.undergroundFadeAlpha)),i.main.add(br`float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);`),s.main.add(br`fragColor = color;`);else{t.include(lu,e),t.attributes.add("position","vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const r=1===e.geometry;i.uniforms.add(new Or("proj",e=>e.camera.projectionMatrix),new Or("view",e=>e.camera.viewMatrix)),r||(t.varyings.add("innerFactor","float"),i.uniforms.add(new cr("silCircleCenter",e=>e.silhouette.center)),i.uniforms.add(new cr("silCircleV1",e=>e.silhouette.v1)),i.uniforms.add(new cr("silCircleV2",e=>e.silhouette.v2)),i.uniforms.add(new tr("texV",e=>e.texV)),i.uniforms.add(new lr("innerScale",e=>e.innerScale)));const n=6.2831853,a=1/128;i.main.add(br`
      ${r?br`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:br`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${br.float(n*a)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${br.float(a)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
	  `),s.uniforms.add(new hr("tex",e=>e.texture)),r||s.uniforms.add(new lr("altitudeFade",e=>e.altitudeFade)),s.main.add(br`
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${r?br`fragColor = atmosphereColor;`:br`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));`}`)}return t}},Symbol.toStringTag,{value:"Module"}));class kP extends Tr{constructor(e,t){super(e,t,new Sr(LP,()=>Promise.resolve().then(()=>LP)),VP.locations)}initializePipeline(e){const t=1===e.geometry;return gn({blending:Cn,culling:t?xn:void 0,depthTest:{func:515},colorWrite:_n})}}const VP=ta().vec3f("position").freeze();class FP extends $r{constructor(){super(...arguments),this.geometry=0}}e([Pr({count:3})],FP.prototype,"geometry",void 0);const jP=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);let zP=class extends xm{constructor(){super(...arguments),this._configuration=new FP,this._passParameters=new EP,this._vao=null,this._vaoCount=0}initialize(){this._configuration.geometry=1,this.addHandles([B(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),N)])}destroy(){this._passParameters.texture=M(this._passParameters.texture),this._vao=M(this._vao)}precompile(){this.techniques.precompile(kP,this._configuration)}render(e){const t=e.find(({name:e})=>e===ii.OPAQUE_ENVIRONMENT),i=this.techniques.get(kP,this._configuration);if(!i.compiled)return this.requestRender(1),t;const s=this.renderingContext;if(this._vao||(this._vao=function(e){const t=Uu(1,2,!1),{data:i,indices:s}=t[0][1],r=VP.createBuffer(s.length),n=r.position;for(let e=0;e<s.length;++e){const t=3*s[e%3==0?e+2:e%3==2?e-2:e];n.set(e,0,i[t]),n.set(e,1,i[t+1]),n.set(e,2,i[t+2])}return new ra(e,new oa(e,ia(VP),r.buffer))}(s),this._vaoCount=this._vao.vertexCount("geometry")),!this._passParameters.texture){const e=new On(1,512);e.wrapMode=33071,e.flipped=!0,this._passParameters.texture=new An(s,e,jP)}const r=s.bindTechnique(i,this.bindParameters,this._passParameters);var n,a;return n=HP,a=this.bindParameters.camera.viewMatrix,As(n,a),n[12]=0,n[13]=0,n[14]=0,n[15]=1,r.setUniformMatrix4fv("view",HP),s.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(Un.TRIANGLES,0,this._vaoCount),t}};zP=e([Se("esri.views.3d.environment.LocalAtmosphere")],zP);const HP=Fs(),qP=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),UP=-fi,BP=Ii([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let NP=class extends xm{constructor(e){super(e),this._passParameters=new EP,this._configuration=new FP,this._vao=null,this._fadeVao=null,this._texV1=1;const t=e.view,i=ge(t.spatialReference),{outerAtmosphereRimWidth:s,radius:r}=i;this._planetRadius=r,this._innerRimFactor=1+UP/r,this._middleRimFactor=1+0/r,this._outerRimFactor=1+s/r,this._texV0=0/s,this._texVScale=this._texV1-this._texV0;const n=t.stage.renderView.techniques;n.precompile(kP,this._configuration),this._configuration.geometry=2,n.precompile(kP,this._configuration)}initialize(){this.addHandles(B(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),N))}destroy(){this._passParameters.texture=M(this._passParameters.texture),this._fadeVao=M(this._fadeVao),this._vao=M(this._vao)}render(e){const t=e.find(({name:e})=>e===ii.OPAQUE_ENVIRONMENT);this._update();const i=this.renderingContext;if(!this._passParameters.texture){const e=new On(1,512);e.wrapMode=33071,e.flipped=!0,this._passParameters.texture=new An(i,e,qP)}if(this._passParameters.undergroundFadeAlpha<1){this._vao??=this._createRibbon(i),this._configuration.geometry=0;const e=this.techniques.get(kP,this._configuration);if(!e.compiled)return this.requestRender(1),t;i.bindTechnique(e,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Un.TRIANGLES,0,this._vao.vertexCount("geometry"))}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao??=VT(i),this._configuration.geometry=2;const e=this.techniques.get(kP,this._configuration);if(!e.compiled)return this.requestRender(1),t;i.bindTechnique(e,this.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays(Un.TRIANGLE_STRIP,0,this._fadeVao.vertexCount("geometry"))}return t}_update(){const e=this.bindParameters.camera,t=ke(),i=this._planetRadius,s=$i(e.eye),r=s-i;if(r<0){const e=Math.min(-r/5e3,1);this._passParameters.undergroundFadeAlpha=e}else this._passParameters.undergroundFadeAlpha=0;const n=Math.max(50,r),a=i+UP;var o,l,h;this._passParameters.innerScale=(l=i,h=a,(o=i+n)*o/(Math.sqrt(o*o-l*l)*Math.sqrt(o*o-h*h)+l*h)-1),this._passParameters.altitudeFade=yi(r),Bi(t,e.eye,(i+50)/s),GP(t,e.center,e.up,i,this._passParameters.silhouette);const c=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),d=1-511/512,u=BP(r);let p=this._texV0+d*this._texVScale,m=this._texV0+c*u*this._texVScale;if(r>50){GP(e.eye,e.center,e.up,i,this._passParameters.silhouette);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),s=Ci((t-1.5)/(c-1.5),0,1);p=this._texV0+s*d*this._texVScale,m=this._texV0+Pi(this._texV1,c*u,s)*this._texVScale}Hs(this._passParameters.texV,p,m)}_createRibbon(e){const t=Xr(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let e=0;e<128;e++){const s=9*e+3;t[s]=e,t[s+1]=this._innerRimFactor,t[s+2]=-1,t[s+3]=e,t[s+4]=this._middleRimFactor,t[s+5]=0,t[s+6]=e,t[s+7]=this._outerRimFactor,t[s+8]=1;const r=3*e+1,n=127===e?1:r+3,a=15*e;i[a]=r,i[a+1]=r+1,i[a+2]=n+1,i[a+3]=n+1,i[a+4]=n,i[a+5]=r,i[a+6]=r+1,i[a+7]=r+2,i[a+8]=n+2,i[a+9]=n+2,i[a+10]=n+1,i[a+11]=r+1,i[a+12]=r,i[a+13]=n,i[a+14]=0}const s=VP.createBuffer(i.length),r=s.position;for(let e=0;e<i.length;++e){const s=3*i[e];r.set(e,0,t[s]),r.set(e,1,t[s+1]),r.set(e,2,t[s+2])}return new ra(e,new oa(e,ia(VP),s.buffer))}_computeScreenRimWidth(e,t,i,s){return Ki($P,s.center,s.v2),Bi(QP,$P,this._outerRimFactor),Ls(WP,t,$P,i),tc($P,WP,e.projectionMatrix,e.viewport,$P),tc(QP,WP,e.projectionMatrix,e.viewport,QP),Xi($P,QP)/e.height}};function GP(e,t,i,s,r){const n=$i(e),a=s*Math.sqrt(n*n-s*s)/n,o=Math.sqrt(s*s-a*a),l=r.v1,h=r.v2;return Bi(r.center,e,o/n),ss(l,e,t),ts(l)<1&&ss(l,e,i),Bi(l,l,a/$i(l)),ss(h,l,e),Bi(h,h,a/$i(h)),a}NP=e([Se("esri.views.3d.environment.MarsAtmosphere")],NP);const WP=Fs(),$P=ke(),QP=ke();class ZP{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return 0===this._indexRanges.length}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;const t=this._indexRanges;let i=0,s=t.length/2;if(e<t[2*i]||e>t[2*s]+t[2*s+1])return!1;for(;s-i>0;){const r=Math.floor(.5*(i+s)),n=t[2*r];if(e<n){if(s-i===1)return!1;s=r}else{if(e<n+t[2*r+1])return!0;if(s-i===1)return!1;i=r+1}}return!1}get componentCount(){if(-1===this._componentCountCache){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];this._componentCountCache=t}return this._componentCountCache}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],s=1;for(let r=1;r<e.length;r++){const n=e[r];i+s===n?s+=1:(t.push(i),t.push(s),i=n,s=1)}return t.push(i),t.push(s),t}(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const s=t[i],r=s+t[i+1];for(let t=s;t<r;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const s=t[i];if(!e(s,s+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let s=0;s<i.length;s+=2){const r=i[s],n=r+i[s+1],a=e[r],o=e[n];t[s]=a,t[s+1]=o-a}return t}}let YP=class{constructor(e,t){this.offsets=t,this._highlightsInOrder=[],this.pickability=null,this.componentHighlights=new Map,this.verticalOffsets=null,this._cachedGeometryRanges=null,this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null;const i=this.count;this.visibility=new ZP(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let e=0;e<i;e++)this.materialDataIndices[e]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return null==this._cachedGeometryRanges&&(this._cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this._cachedGeometryRanges}get highlightRangesMap(){return 0===this.componentHighlights.size?null:(this._updateCachedHighlightRanges(),this._cachedHighlightRangesMap)}get shadowmapRanges(){return 0===this.componentHighlights.size?this.geometryRanges:(this._updateCachedHighlightRanges(),this._cachedShadowmapRanges)}markHighlightsDirty(){this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null}markVisibilityDirty(){this._cachedGeometryRanges=null,this.markHighlightsDirty()}updateHighlights(e){this._updateHighlightOrder(e)&&(this.markHighlightsDirty(),this._updateCachedHighlightRanges())}_updateHighlightOrder(e){const{_highlightsInOrder:t}=this;let i=t.length!==e.length;t.length=Math.min(e.length,8);for(let s=0;s<e.length;++s){const r=e.at(s).name;t.length<s?(i=!0,t.push(r)):t[s]!==r&&(t[s]=r,i=!0)}return i}_updateCachedHighlightRanges(){if(null==this._cachedHighlightRangesMap||null==this._cachedShadowmapRanges){const{highlightRangesMap:e,shadowmapRangesMap:t}=function(e,t,i,s){const r=new Map,n=[];if(e.size>0){let a=i.length;t.forEachComponent(t=>{let o=!1;for(let n=s.length-1;n>=0;--n){const a=s[n],l=e.get(a);if((l?.[t]??0)>0){const e=Td(r,a,()=>[]),s=i[t],n=i[t+1];e.push(s),e.push(n-s),o||=a===Lh;break}}return o||(a!==t-1&&(n.length>0&&n.push(i[a+1]-n[n.length-1]),n.push(i[t])),a=t),!0}),n.length>0&&n.push(i[a+1]-n[n.length-1])}return{highlightRangesMap:r,shadowmapRangesMap:n}}(this.componentHighlights,this.visibility,this.offsets,this._highlightsInOrder);this._cachedHighlightRangesMap=e,this._cachedShadowmapRanges=t}}};class KP{constructor(e,t,i,s,r,n){this.transform=e,this.toMapSpace=t,this.obb=i,this.componentData=s,this.renderable=r,this.intersectionGeometry=n,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=S(this.intersectionGeometry),this.renderable=S(this.renderable),this.componentData=S(this.componentData)}}class XP{constructor(e,t){this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=Ve(0,0,this.planetCenterZ),this.maxBspNodeDepth=t.maxBspNodeDepth??8,this.minElementCountForBVH=t.minElementCountForBVH??15,this.minBspNodeElementCount=t.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||0===this._bspNodes.length&&this._generateBsp()}intersectRay(e,t,i){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(i):this._intersectRayWithBVH(e,t,i))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,i){this._ensureBVH(),i?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],i=e[1];if(!this.localMode){const{geometryMinZ:s,planetCenterZ:r}=this,n=(s-r)/(e[2]-r);t=e[0]*n,i=e[1]*n}const{_bspNodes:s}=this;let r=0;for(;r>=0;){const e=s[r],{d:n,dim:a,minIndexIndex:o,minMidIndexIndex:l,maxMidIndexIndex:h,maxIndexIndex:c,aabb2D:d}=e;if(t<d[0]||t>d[2]||i<d[1]||i>d[3])break;if(-1===a||-1===e.child0&&-1===e.child1){this._intersectRange(o,c);break}{this._intersectRange(l,h);const s=(0===a?t:i)-n;if(s<0){if(-1===e.child0){this._intersectRange(o,l);break}r=e.child0}else{if(!(s>0))break;if(-1===e.child1){this._intersectRange(h,c);break}r=e.child1}}}}_intersectGeometryWithBVHGeneralRay(e,t){let i=e[0],s=e[1],r=t[0],n=t[1];const{geometryMinZ:a}=this;if(!this.localMode){let o=0,l=1;const h=Math.min(.5*this.planetCenterZ,a),c=e[2],d=t[2];if(c<h&&d<h)return;if(c<h&&(o=(h-c)/(d-c)),d<h&&(l=(h-c)/(d-c)),o>l)return;const u=(1-o)*e[0]+o*t[0],p=(1-o)*e[1]+o*t[1],m=(1-o)*e[2]+o*t[2],g=(1-l)*e[0]+l*t[0],_=(1-l)*e[1]+l*t[1],f=(1-l)*e[2]+l*t[2],{planetCenterZ:y}=this,v=a-y,b=v/(m-y);i=u*b,s=p*b;const w=v/(f-y);r=g*w,n=_*w}const o=r-i,l=n-s,h=this._bspNodes;let c=1;{const{aabb2D:e}=h[0],t=(e,t,i,s)=>{if(Math.abs(t)<1e-5*Math.max(s-i,1))return!1;const r=t>0,n=r?s:i,a=e+c*t;return(r?a<n:a>n)&&(c=Math.max((n-e)/t,c),!0)},r=()=>t(i,o,e[0],e[2]),n=()=>t(s,l,e[1],e[3]);Math.abs(o)>=Math.abs(l)?r()||n():n()||r()}const d=[0,0,c];let u=0;for(;u<d.length;){const e=d[u];let t=d[u+1],r=d[u+2];if(u+=3,t>r)continue;const n=h[e],{minIndexIndex:a,maxIndexIndex:p}=n,{child0:m,child1:g,minMidIndexIndex:_,maxMidIndexIndex:f,aabb2D:y,d:v,dim:b}=n;{const e=i+t*o,s=i+r*o,n=Math.min(e,s),a=Math.max(e,s),l=y[0],h=y[2];if(a<l||h<n)continue;if(n<l){const e=(l-i)/o;o>0?t=Math.max(t,e):r=Math.min(r,e)}if(h<a){const e=(h-i)/o;o>0?r=Math.min(r,e):t=Math.max(t,e)}}{const e=s+t*l,i=s+r*l,n=Math.min(e,i),a=Math.max(e,i),o=y[1],h=y[3];if(a<o||h<n)continue;if(n<o){const e=(o-s)/l;l>0?t=Math.max(t,e):r=Math.min(r,e)}if(h<a){const e=(h-s)/l;l>0?r=Math.min(r,e):t=Math.max(t,e)}}if(-1===m&&-1===g)this._intersectRange(a,p);else{const e=0===b?i:s,n=0===b?o:l,h=e+t*n,u=e+r*n,y=Math.min(h,u),w=Math.max(h,u),x=Ci((v-e)/n,0,c);a<_&&y<=v&&(-1!==m?(d.push(m),d.push(n>=0?t:Math.max(t,x)),d.push(n>=0?Math.min(r,x):r)):this._intersectRange(a,_)),this._intersectRange(_,f),f<p&&v<=w&&(-1!==g?(d.push(g),d.push(n>=0?Math.max(t,x):t),d.push(n>=0?r:Math.min(r,x))):this._intersectRange(f,p))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=new((i=e)<128?Uint8Array:i<32768?Uint16Array:i<1<<31?Uint32Array:Array)(e);var i;this._elementIndexMap=t;for(let i=0;i<e;++i)t[i]=i;const s=this.model.getAabbs2D();let r=0;const n=this._bspNodes;n.length=0;const{localMode:a}=this;let o=!1;if(!a){const{planetCenterZ:e,geometryMinZ:t}=this;o=e>=0||t<.5*e}const l=[],h=(e,t,i,s,r)=>{l.push(e),l.push(t),l.push(i),l.push(s<0?-1:(r?0:1)+2*s)},{maxBspNodeDepth:c,minBspNodeElementCount:d}=this,u=(e,i,r,l,u)=>{const p=n.length;if(p>0&&(o||r>=c||i-e<d))return;const m=lt();!function(e,t,i,s,r){let n=1/0,a=1/0,o=-1/0,l=-1/0;for(let e=t;e<i;++e){const t=4*s[e];n=Math.min(n,r[t+0]),a=Math.min(a,r[t+1]),o=Math.max(o,r[t+2]),l=Math.max(l,r[t+3])}e[0]=n,e[1]=a,e[2]=o,e[3]=l}(m,e,i,t,s);const{d:g,dim:_}=a?function(e){const t=e[0],i=e[1],s=e[2],r=e[3];let n,a;return s-t>=r-i?(a=.5*(t+s),n=0):(a=.5*(i+r),n=1),{d:a,dim:n}}(m):function(e){const t=e[0],i=e[1],s=e[2],r=e[3];let n,a;return s-t>=r-i?(n=0,a=.5*(t+s)):(n=1,a=.5*(i+r)),{dim:n,d:a}}(m),{rangeMidStart:f,rangeMidEnd:y}=function(e,t,i,s,r,n){let a=e;{let e=t;for(;a<e;){const t=r[a];JP(t,i,s,n)<0?++a:(--e,r[a]=r[e],r[e]=t)}}const o=a;let l=a,h=t;for(;l<h;){const e=r[h-1];JP(e,i,s,n)>0?--h:(r[h-1]=r[l],r[l]=e,++l)}return{rangeMidStart:o,rangeMidEnd:h}}(e,i,_,g,t,s),v=r===c-1,b=!v&&f>=e+d,w=!v&&i>=y+d;if(b||w||0===p){const t=new eM(e,f,y,i,_,g,m);if(b&&h(e,f,r+1,p,!0),w&&h(y,i,r+1,p,!1),n.push(t),-1!==l){const e=n[l];u?e.child0=p:e.child1=p}}};for(h(0,e,0,-1,!1);r<l.length;){const e=l[r],t=l[r+1],i=l[r+2],s=l[r+3];r+=4;const n=s>>1;u(e,t,i,n,s-(n<<1)==0)}this._generatedBVH=!0}}function JP(e,t,i,s){const r=4*e,n=s[r+0+t];return s[r+2+t]<i?-1:n>i?1:0}class eM{constructor(e,t,i,s,r,n,a){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=i,this.maxIndexIndex=s,this.dim=r,this.d=n,this.aabb2D=a,this.child0=-1,this.child1=-1}}class tM{constructor(e,t,i,s,r,n,a,o,l){this.componentIndex=e,this.vertexData=t,this.vertexStride=i,this.indexData=s,this.startTriangleNumber=r,this.endTriangleNumber=n,this.geometryMinZ=a,this.planetCenterZ=o,this.localMode=l,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=ke(),this.ray0=ke(),this.isVerticalRay=!1,this._triangleHitCallback=sM,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new XP(n-r,this)}getAabbs2D(){return this.localMode?function(e,t,i,s,r){const n=t-e,a=new Float64Array(4*n);for(let t=0;t<n;++t){const n=3*(t+e),o=r*i[n+0],l=s[o+0],h=s[o+1],c=r*i[n+1],d=s[c+0],u=s[c+1],p=r*i[n+2],m=s[p+0],g=s[p+1],_=4*t;a[_+0]=Math.min(l,d,m),a[_+1]=Math.min(h,u,g),a[_+2]=Math.max(l,d,m),a[_+3]=Math.max(h,u,g)}return a}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):function(e,t,i,s,r,n,a){const o=n-a,l=t-e,h=new Float64Array(4*l);for(let t=0;t<l;++t){const n=3*(t+e),l=r*i[n+0],c=s[l+0],d=s[l+1],u=o/(s[l+2]-a),p=c*u,m=d*u,g=r*i[n+1],_=s[g+0],f=s[g+1],y=o/(s[g+2]-a),v=_*y,b=f*y,w=r*i[n+2],x=s[w+0],C=s[w+1],T=o/(s[w+2]-a),S=x*T,P=C*T,M=4*t;h[M+0]=Math.min(p,v,S),h[M+1]=Math.min(m,b,P),h[M+2]=Math.max(p,v,S),h[M+3]=Math.max(m,b,P)}return h}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,t,i,s,r,n){Zi(this.ray0,e),Ui(this.rayDirection,t,e),this.isVerticalRay=i,this.totalElevationOffset=s,this.normalRequired=n,this._triangleHitCallback=r,this._bvh.intersectRay(e,t,i),this._triangleHitCallback=sM}intersectRange(e,t){const i=this._bvh.elementIndexMap;iM(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,i,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}}function iM(e,t,i,s,r,n,a,o,l,h,c,d=null,u=0){0!==o?uu(e,t,i,s,r,n,a,o,l,h,c,d,u):ou(e,t,i,s,r,n,a,h,c,d,u)}function sM(){}function rM(e,t,i){const s=e.count;if(t>=s)return;e.pickability??=new Uint32Array(0);let r=e.pickability;const n=aM(r),a=t/n|0,o=t-n*a,l=(s-1)/n|0,h=r;if(!(t<h.length*n||i)){const t=a+1,i=Math.ceil(h.length*v),s=l+1;let n=Math.max(t,i);n=Math.min(n,s),e.pickability=r=new Uint32Array(n),r.set(h)}a<r.length&&(r[a]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(r[a],o,!i))}function nM(e,t){if(null==e)return!0;const i=aM(e);return!(t<e.length*i)||function(e,t,i){const s=t/i|0,r=t-s*i;return!function(e,t){return!!(e&1<<t)}(e[s],r)}(e,t,i)}function aM(e){return 8*e.BYTES_PER_ELEMENT}class oM{constructor(e,t,i,s,r,n,a,o){this.vertexData=e,this.vertexStride=t,this.indexData=i,this._components=s,this._componentAabbs3D=r,this.geometryMinZ=n,this.planetCenterZ=a,this.localMode=o,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=dM,this._ray1=uM,this._invDir=ke(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=mM,this._callback=pM,this.rayDirectionC=ke(),this._componentIndexMap=null,this._bvh=new XP(s.count,this),this.componentIntersectionData=new Array(s.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:i}=this,s=yu(4*e),r=this._componentAabbs3D;for(let n=0;n<e;++n){const e=6*n,a=r[e+0],o=r[e+1],l=r[e+2],h=r[e+3],c=r[e+4],d=i/(l-t),u=i/(r[e+5]-t),p=Math.min(a*d,a*u),m=Math.min(o*d,o*u),g=Math.max(h*d,h*u),_=Math.max(c*d,c*u),f=4*n;s[f+0]=p,s[f+1]=m,s[f+2]=g,s[f+3]=_}return s}getAabbs2DLocal(){const{numComponents:e}=this,t=yu(4*e),i=this._componentAabbs3D;for(let s=0;s<e;++s){const e=6*s,r=i[e+0],n=i[e+1],a=i[e+3],o=i[e+4],l=4*s;t[l+0]=r,t[l+1]=n,t[l+2]=a,t[l+3]=o}return t}intersectRay(e,t,i,s,r,n,a){const{isVerticalRay:o}=a;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=i,this._verticalOffset=s,this._tolerance=n,this._intersectionOptions=a,this._componentIndexMap=this._bvh.elementIndexMap,pu(e,t,this._invDir),this._callback=r,this._bvh.intersectRay(e,t,o),this._callback=pM}intersectRange(e,t){const i=this._componentIndexMap,{pickability:s,visibility:r}=this._components;for(let n=e;n<t;++n){const e=i?i[n]:n;nM(s,e)&&r.isVisible(e)&&this._intersectComponent(e)}}getComponentTriangleCount(e){const t=this._components.offsets,i=t[e]/3;return t[e+1]/3-i}getComponentAabb3D(e,t){const i=this._componentAabbs3D,s=6*e;return t[0]=i[s],t[1]=i[s+1],t[2]=i[s+2],t[3]=i[s+3],t[4]=i[s+4],t[5]=i[s+5],t}_intersectComponent(e){const t=this.getComponentAabb3D(e,lM);let i=!1;const{localMode:s,_componentVerticalOffsets:r,_verticalOffset:n,_ray0:a,_ray1:o,_invDir:l,planetCenterZ:h,_tolerance:c,rayDirectionC:d,componentIntersectionData:u}=this,{isVerticalRay:p}=this._intersectionOptions,m=this._components.offsets,g=Zi(hM,a),_=Zi(cM,o),f=r?.[e]??0,y=f+(n?.offset??0);if(0!==y&&(s?(g[2]=a[2]-y,_[2]=o[2]-y,i=!0):null!=n&&(n.componentOffset=f)),null==n||i||0===y||n.applyToAabb(t),!mu(t,g,l,c))return;Ui(d,_,g);const v=m[e]/3,b=m[e+1]/3,w=b-v,x=(t,i,s)=>{this._callback(t,i,e,s)},{vertexData:C,vertexStride:T,indexData:S,_intersectionOptions:P}=this,{normalRequired:M}=P;if(w>gM){let t=u[e];null==t&&(t=new tM(e,C,T,S,v,b,this.geometryMinZ,h,s),u[e]=t),t.intersectRay(g,_,p,i?0:y,x,M)}else iM(g,d,v,b,S,C,T,i?0:y,h,M,x)}}const lM=ah(),hM=ke(),cM=ke(),dM=ke(),uM=ke(),pM=()=>{},mM=new au,gM=40;class _M{constructor(e,t,i){this.viewingMode=e,this.positionData=t,this._components=i,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=ke(),this._componentBvh=null,this._aabb=ah(),this._indices=t.indices?Jn(t.indices):Xn(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const i=this._ensureComponentAabbs(),s=6*e;return t[0]=i[s],t[1]=i[s+1],t[2]=i[s+2],t[3]=i[s+3],t[4]=i[s+4],t[5]=i[s+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,s,r,n,a,o){this.verticalOffset=s,this.componentVerticalOffsets=r;const{position:l}=n,h=Ui(fM,e,l),c=Ui(yM,t,l),d=bs(vM,n.rotationScale);is(h,h,d),is(c,c,d);const u=ps(wM,d);if(1===this.viewingMode){const e=this._planetCenter;ns(e,l),is(e,e,d)}this._intersectComponents(h,c,r,s,(e,t,i,s)=>{o(i,e,s?is(bM,s,u):null,t)},i,a)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),i=.5*(e[1]+e[4]),s=.5*(e[2]+e[5]),r=this._components.count,n=Xr(6*r),a=this._indices,o=this._positions,l=this._components.offsets;let h=0,c=1/0,d=1/0,u=1/0,p=-1/0,m=-1/0,g=-1/0;for(let e=0;e<r;e++){const r=l[e],_=l[e+1];let f=1/0,y=1/0,v=1/0,b=-1/0,w=-1/0,x=-1/0;if(r<_)for(let e=r;e<_;e++){const t=3*a[e],i=o[t],s=o[t+1],r=o[t+2];f=Math.min(f,i),y=Math.min(y,s),v=Math.min(v,r),b=Math.max(b,i),w=Math.max(w,s),x=Math.max(x,r)}else f=t,y=i,v=s,b=t,w=i,x=s;n[h++]=f,n[h++]=y,n[h++]=v,n[h++]=b,n[h++]=w,n[h++]=x,c=Math.min(c,f),d=Math.min(d,y),u=Math.min(u,v),p=Math.max(p,b),m=Math.max(m,w),g=Math.max(g,x)}return this._aabb[0]=c,this._aabb[1]=d,this._aabb[2]=u,this._aabb[3]=p,this._aabb[4]=m,this._aabb[5]=g,n}_intersectComponents(e,t,i,s,r,n,a){let o=this._componentBvh;null==o&&(o=new oM(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=o),o.intersectRay(e,t,i,s,r,n,a)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return 2===this.viewingMode}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}}const fM=ke(),yM=ke(),vM=Xs(),bM=ke(),wM=Xs();class xM{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}}class CM{constructor(e,t,i,s){this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=s}dispose(){this.vao.dispose()}}const TM=new Xl({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),SM=new pi,PM=ke(),MM=ke(),RM=new Xl({deallocator:null}),OM=new Xl({deallocator:null});function DM(e,t,i){i.length=0;const s=t.length-3;AM(PM,t,s);const r=Yo(e,PM);r<=0&&(i.push(PM[0]),i.push(PM[1]),i.push(PM[2]));let n=0,a=r;for(;n<s;n+=3){AM(MM,t,n);const s=Yo(e,MM);a*s<0&&(Wi(PM,MM,PM,s/(s-a)),EM(i,PM)),s<=0&&EM(i,MM),a=s,Zi(PM,MM)}a*r<0&&(AM(MM,t,s),Wi(PM,MM,PM,r/(r-a)),EM(i,PM))}function AM(e,t,i){return qi(e,t.data[i],t.data[i+1],t.data[i+2])}function EM(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function IM(e,t,i,s){Wu(VM,e.quaternion),Ui(FM,t,e.center),hs(FM,FM,VM);const r=e.halfSize,n=8*((FM[0]<-r[0]?-1:FM[0]>r[0]?1:0)+3*(FM[1]<-r[1]?-1:FM[1]>r[1]?1:0)+9*(FM[2]<-r[2]?-1:FM[2]>r[2]?1:0)+13),a=LM[n];if(0===a)return a;ws(kM,e.quaternion),fs(kM,kM,e.halfSize);const o=(t,i)=>{const s=LM[n+i+1];return qi(t,((1&s)<<1)-1,(2&s)-1,((4&s)>>1)-1),is(t,t,kM),Ki(t,e.center,t)};return i.length=0,EM(i,o(jM,0)),EM(i,o(zM,1)),EM(i,o(FM,2)),EM(i,o(HM,3)),s(i),1===a||(i.length=0,EM(i,jM),EM(i,HM),EM(i,o(FM,4)),EM(i,o(qM,5)),s(i),2===a||(i.length=0,EM(i,jM),EM(i,qM),EM(i,o(FM,6)),EM(i,zM),s(i))),a}const LM=(()=>{const e=new Array(216);let t=0;const i=i=>{for(let s=0;s<i.length;s++)e[t+s]=i[s];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),kM=Xs(),VM=$u(),FM=ke(),jM=ke(),zM=ke(),HM=ke(),qM=ke();class UM{constructor(e){this._objects=e}destroy(){this._objects=null}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll(i=>i.renderable.material.submit(e,t,i))}queryDepthRange(e){return this._objects.visibleObjects.length?function(e,t){const i=new pi,{eye:s,frustum:r,viewForward:n}=e;t.forAll(e=>{const t=null!=e.offsetObb?e.offsetObb:e.obb,a=Gi(Ui(FM,t.center,s),n),o=t.projectedRadius(n);if(i.within(a-o)&&i.within(a+o))return;const l=function(e,t){let i=0;for(let s=0;s<4;s++){const r=e.intersectPlane(t[s]);if(r>0)return-1;0===r&&(i|=1<<s)}return i}(t,r);if(-1===l)return;if(0===l)return SM.far=a+o,SM.near=a-o,void i.union(SM);const h=TM.pushNew();h.near=a-o,h.far=a+o,h.mask=l,h.object=e});for(let e=0;e<TM.length;e++){const t=TM.data[e];if(i.within(t.near)&&i.within(t.far))continue;SM.far=t.far,SM.near=1/0;const a=IM(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,s,RM,e=>{let i=OM;for(let s=0;s<4&&e.length>0;s++){if(!(t.mask&1<<s))continue;DM(r[s],e,i);const n=e;e=i,i=n}for(let t=0;t<e.length;t+=3){qi(PM,e.data[t],e.data[t+1],e.data[t+2]);const i=Gi(Ui(PM,PM,s),n);SM.near=Math.min(SM.near,i)}});0===a&&(SM.near=0),i.union(SM)}return TM.length=0,i}(e,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some(e=>e.renderable.material.hasEmissions)}hasHighlight(e){return this._objects.hasHighlight(e)}}class BM extends xr{constructor(e,t,i,s,r){super(),this.hasVertexColors=e,this.textureCoordinateType=t,this.hasNormals=i,this.shadeNormals=s,this.applySSAO=r}}function NM(e){const t=ta().vec3f("position");return e.hasNormals&&t.vec2i16("normalCompressed",{glNormalized:!0}),1===e.textureCoordinateType?t.vec2f("uv0"):2===e.textureCoordinateType&&(t.vec2f("uv0"),t.vec4u16("uvRegion",{glNormalized:!0})),e.hasVertexColors&&t.vec4u8("color",{glNormalized:!0}),t.freeze()}class GM{constructor(){this.externalColor=ul(),this.externalColorMixMode=1,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0,this.emissiveStrength=mr,this.emissiveSource=0}}function WM(e){e.vertex.code.add(br`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${br.int(1)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${br.int(3)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${br.int(4)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${br.int(1)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}class $M extends or{constructor(e,t){super(e,"int",2,(i,s,r)=>i.setUniform1i(e,t(s,r)))}}const QM=429496.7296;function ZM(e,t){Vu(e/QM*.5+.5,t)}const YM=1e6;function KM(e,t){Fu(e/YM*.5+.5,t)}function XM(){return 3+(Jr()?1:0)}function JM(e,t){switch(t.componentData){case 1:return function(e,t){const{vertex:i,fragment:s}=e;i.include(qu),i.uniforms.add(new _r("componentColorTex",e=>e.componentParameters.texture.texture)),e.attributes.add("componentIndex","float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4");const{output:r}=t,n=9===r;n&&e.varyings.add("vObjectAndLayerIdColor","vec4");const a=1===r;a&&(e.varyings.add("emissiveStrength","float"),e.varyings.add("emissiveSource","int",{flat:!0})),e.include(WM),i.constants.add("stride","float",XM()),i.code.add(br`vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
float index = componentIndex * stride + typeOffset;
float texSize = float(textureSize(componentColorTex, 0).x);
float coordX = mod(index, texSize);
float coordY = floor(index / texSize);
return vec2(coordX, coordY) + 0.5;
}`),i.code.add(br`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);
    return texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
   }

  float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);
    vec4 encodedElevation = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
    return uninterpolatedRGBAToFloat(encodedElevation) * ${br.float(QM)};
  }

  void forwardEmissiveStrength() {
    ${wr(a,br`vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);
           vec4 encodedEmissive = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
           emissiveStrength = uninterpolatedRGBToFloat(encodedEmissive.rgb) * ${br.float(YM)};
           emissiveSource = encodedEmissive.a == 0.0 ? 0 : 1;`)}
  }

  void forwardObjectAndLayerIdColor() {
    ${wr(n,br`vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 3.0);
           vObjectAndLayerIdColor = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);`)}
  }

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),s.code.add(br`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${n?br`fragColor = vObjectAndLayerIdColor;`:""}
  }
`)}(e,t);case 0:return function(e,t){const{vertex:i,fragment:s}=e;e.varyings.add("vExternalColor","vec4"),s.uniforms.add(new gr("emissiveStrength",e=>e.componentParameters.emissiveStrength)),i.uniforms.add(new ih("externalColor",e=>e.componentParameters.externalColor)).code.add(br`float readElevationOffset() {
return 0.0;
}
void forwardObjectAndLayerIdColor() {}
void forwardEmissiveStrength() {}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`);const r=9===t.output;s.uniforms.add(new $M("externalColorMixMode",e=>e.componentParameters.externalColorMixMode)).code.add(br`
    void readExternalColor(out vec4 color, out int colorMixMode) {
      color = vExternalColor;
      colorMixMode = externalColorMixMode;
    }

    void outputObjectAndLayerIdColor() {
      ${wr(r,"fragColor = vec4(0, 0, 0, 0);")}
    }
  `)}(e,t);case 2:return;default:c(t.componentData)}}function eR(e,t){const i=e.fragment;switch(t.doubleSidedMode){case 0:i.code.add(br`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case 1:e.include(gu,t),i.code.add(br`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case 2:i.code.add(br`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:c(t.doubleSidedMode);case 3:}switch(t.normalType){case 0:case 1:e.include(Ud,t),i.main.add(br`vec3 fragmentFaceNormal = _adjustDoublesided(normalize(vNormalWorld));
vec3 fragmentFaceNormalView = gl_FrontFacing ? normalize(vNormalView) : -normalize(vNormalView);`);break;case 2:e.include(gu,t),i.main.add(br`vec3 fragmentFaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
vec3 fragmentFaceNormalView = normalize(cross(dFdx(vPosition_view), dFdy(vPosition_view)));`)}t.shadeNormals?i.main.add(br`vec3 fragmentShadingNormal = fragmentFaceNormal;`):t.spherical?(e.include(gu,t),i.main.add(br`vec3 fragmentShadingNormal = normalize(positionWorld());`)):i.main.add(br`vec3 fragmentShadingNormal = vec3(0.0, 0.0, 1.0);`)}function tR(e,t){e.include(_u,t),e.fragment.include(Bd);const i=e.fragment;i.uniforms.add(new ih("baseColor",e=>e.baseColor)),i.uniforms.add(new gr("objectOpacity",e=>e.objectOpacity)),t.hasVertexColors?i.code.add(br`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):i.code.add(br`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),i.code.add(br`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function iR(e,t){const i=t.hasColorTexture&&(dr(t.output)||1!==t.alphaDiscardMode);i&&(e.include(fr,t),e.fragment.uniforms.add(new _r("baseColorTexture",e=>e.texture))),e.fragment.code.add(br`
    vec4 readBaseColorTexture() {
      return ${i?"textureLookup(baseColorTexture, vuv0)":"vec4(1.0)"};
    }
  `)}const sR=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new mn,{vertex:i,fragment:s}=t;t.include(gu,e),t.include(Ud,e),t.include(_u,e),t.include(ur,e),t.include(JM,e),t.include(Nd,e),s.include(en,e),t.include(iR,e),t.include(tn,e);const{output:r,pbrMode:n,hasNormalTexture:a,snowCover:o,receiveShadows:l,shadeNormals:h,spherical:c,ellipsoidMode:d,overlayEnabled:u,componentData:p,vertexDiscardMode:m,hasBloom:g,renderOccluded:_}=e,f=1===n||2===n;f&&(t.include(Gd,e),a&&t.include(Wd,e));const y=4===r||5===r||6===r,v=y&&1===p;if(u){t.include(kd,e),t.include(uS,e);const s=1===d,r=1===d?de.radius:s?be.radius:we.radius;i.code.add(`\n      ${wr(c,`const float invRadius = ${br.float(1/r)};`)}\n      vec2 projectOverlay(vec3 pos) { return pos.xy ${wr(c,"/ (1.0 + invRadius * pos.z);")}; }`)}const b=u&&dr(r)&&4===n;b&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3"));const w=0===m,x=2===m;if(t.include($d,e),t.include(fu,e),i.main.add(br`
    bool castShadows;
    vec4 externalColor = forwardExternalColor(castShadows);
    ${wr(v,"if(!castShadows) { gl_Position = vec4(vec3(1e38), 1.0); return; }")}

    ${wr(!w,`{ if (externalColor.a ${x?">":"<="} ${br.float(1-1/255)}) { gl_Position = vec4(vec3(1e38), 1.0); return; } }`)}

    ${wr(9===r,"externalColor.a = 1.0;")}

    forwardPosition(readElevationOffset());
    forwardViewPosDepth(vPosition_view);
    forwardNormal();
    forwardTextureCoordinates();
    forwardVertexColor();
    forwardLinearDepthToReadShadowMap();
    forwardLinearDepthToWriteShadowMap();
    forwardEmissiveStrength();
    forwardObjectAndLayerIdColor();
    ${wr(b,c?br`
            groundNormal = normalize(positionWorld());
            tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
            tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:br`
            groundNormal = vec3(0.0, 0.0, 1.0);
            tbnTangent = vec3(1.0, 0.0, 0.0);
            tbnBiTangent = vec3(0.0, 1.0, 0.0);`)}
    ${wr(u,"setOverlayVTC(projectOverlay(position));")}

    if (externalColor.a < ${br.float(ku)}) {
      // Discard this vertex
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
  `),dr(r))return t.include(tR,e),t.include(eR,e),t.include(kd,e),t.include(sn,e),s.include(Qd,e),s.code.add(br`
      float evaluateShadow() {
        return ${l?"readShadowMap(vPositionWorldCameraRelative, linearDepth)":"0.0"};
      }`),s.main.add(br`
      discardBySlice(vPositionWorldCameraRelative);
      discardByTerrainDepth();

      vec4 textureColor = readBaseColorTexture();
      discardOrAdjustAlpha(textureColor);

      /* When rendering the occluded overlay, we still need to read the base color texture
       * because we need to use the same discard logic. However after that to render only the
       * draped overlay, we simply set the base texture color to zero. */
      ${wr(_,br`textureColor = vec4(0);`)}

      ${wr(u,br`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`)}

      /* Early discard to only emit when we have overlay */
      ${wr(u&&_,br`if (overlayColor.a < ${br.float(ku)}) { discard; }`)}

      vec4 externalColor;
      int externalColorMixMode;
      readExternalColor(externalColor, externalColorMixMode);

      vec4 materialColor = computeMaterialColor(textureColor, externalColor, externalColorMixMode);
    `),f?(Ad(s),c&&zd(s),s.main.add(br`
        applyPBRFactors();
        ${wr(1===n,br`if (externalColorMixMode == 3) {
              mrr = vec3(0.0, 0.6, 0.2);
            }`)}
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
        ${wr(a,"mat3 tangentSpace = computeTangentSpace(fragmentFaceNormal, vPositionWorldCameraRelative, vuv0);")}
        vec3 shadingNormal = ${a?"computeTextureNormal(tangentSpace, vuv0)":"fragmentShadingNormal"};
        vec3 groundNormal = ${c?br`normalize(positionWorld())`:br`vec3(0.0, 0.0, 1.0)`};

        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();
        ${wr(o,br`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
                 materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                 ssao = mix(ssao, 0.5 * ssao, snow);
                 shadingNormal = mix(shadingNormal, fragmentFaceNormal, snow);`)}
        ${wr(u,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 emission = ${g?"vec4(0.0)":"getEmissions(materialColor.rgb)"};
        ${wr(c,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        ${c?br`float shadow = max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow());`:"float shadow = evaluateShadow();"}
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, shadow, ssao, additionalLight, viewDir, groundNormal, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(Dd(s),c&&zd(s),b&&s.uniforms.add(new Br("ovNormalTex",e=>e.overlay?.getTexture(3))),s.main.add(br`
        ${wr(c,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        float shadow = ${l?c?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow())":"evaluateShadow()":c?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        ${wr(l&&!h,br`
            float dotFL = dot(fragmentFaceNormal, mainLightDirection);
            if( dotFL <= 0.0) shadow = 1.0;
        `)}
        ${wr(o,br`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
               materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)}

        // At global scale we create some additional ambient light based on the main light to simulate global illumination
        float ssao = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());

        ${wr(u,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec4 shadedColor = vec4(evaluateSceneLighting(fragmentShadingNormal, materialColor.rgb, shadow, ssao, additionalLight), materialColor.a);
        ${wr(b,br`vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
                 float waterNormalLength = length(overlayWaterMask);
                 if (waterNormalLength > 0.95) {
                   mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                   vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                   vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                   // un-gamma the ground color to mix in linear space
                   shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
                 }`)}
      `)),s.main.add(`outputColorHighlightOID(shadedColor, vPositionWorldCameraRelative, materialColor.rgb ${wr(o,", snow")});`),t;const C=3===r,T=9===r,S=8===r,P=y||7===r;return P&&t.include(Ld,e),C&&t.include(eR,e),u&&t.include(yS,e),t.include(jr,e),s.main.add(br`
    discardBySlice(vPositionWorldCameraRelative);

    vec4 textureColor = readBaseColorTexture();
    discardOrAdjustAlpha(textureColor);

    ${wr(P,"outputDepth(linearDepth);")}
    ${wr(C,br`fragColor = vec4(vec3(0.5) + 0.5 * fragmentFaceNormalView, 1.0);`)}
    ${wr(T,u?"fragColor = getOverlayColorTexel();":"outputObjectAndLayerIdColor();")}
    ${wr(S,wr(u,br`calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,br`calculateOcclusionAndOutputHighlight();`))}`),t}},Symbol.toStringTag,{value:"Module"}));class rR extends Tr{constructor(e,t){super(e,t,new Sr(sR,()=>Promise.resolve().then(()=>sR)),aa([ia(NM(t)),nR]))}initializePipeline(e){const{integratedMeshMode:t,output:i,blendingEnabled:s,cullFace:r,hasOccludees:n,hasPolygonOffset:a,oitPass:o,renderOccluded:l}=e,h=0!==t,c=0===o,d=2===o;return gn({blending:l?bn:dr(i)&&s?hn(o):null,culling:Tn(r),depthTest:l?null:{func:ln(o)},depthWrite:l||!c&&!d?null:wn,drawBuffers:Gr(i,cn(o,i)),colorWrite:_n,stencilWrite:!l&&h||n?on:null,stencilTest:h?nn(1):n?an:null,polygonOffset:c||d?a?{factor:2,units:2}:null:rn})}}const nR=ia(ta().u16("componentIndex"));class aR extends Mr{constructor(e){super(),this.spherical=e,this.output=0,this.textureCoordinateType=0,this.componentData=0,this.cullFace=2,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.oitPass=0,this.ellipsoidMode=1,this.pbrMode=0,this.normalType=0,this.emissionSource=0,this.hasVertexColors=!1,this.hasNormals=!1,this.shadeNormals=!0,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.hasHighlightMixTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.screenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasNormalTextureTransform=!1,this.cloudReflections=!0,this.snowCover=!1,this.olidColor=!1,this.hasBloom=!1,this.renderOccluded=!1,this.discardInvisibleFragments=!1,this.occlusionPass=!1,this.bindType=2,this.useCustomDTRExponentForWater=!1,this.hasVertexTangents=!1,this.highStepCount=!1,this.instanced=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.useFillLights=!0,this.draped=!1}get overlayEnabled(){return(2===this.integratedMeshMode||3===this.integratedMeshMode)&&yr(this.output)}}e([Pr({count:10})],aR.prototype,"output",void 0),e([Pr({count:3})],aR.prototype,"textureCoordinateType",void 0),e([Pr({count:2})],aR.prototype,"componentData",void 0),e([Pr({count:3})],aR.prototype,"cullFace",void 0),e([Pr({count:3})],aR.prototype,"vertexDiscardMode",void 0),e([Pr({count:3})],aR.prototype,"doubleSidedMode",void 0),e([Pr({count:4})],aR.prototype,"alphaDiscardMode",void 0),e([Pr({count:4})],aR.prototype,"integratedMeshMode",void 0),e([Pr({count:3})],aR.prototype,"oitPass",void 0),e([Pr({count:4})],aR.prototype,"ellipsoidMode",void 0),e([Pr({count:7})],aR.prototype,"pbrMode",void 0),e([Pr({count:3})],aR.prototype,"normalType",void 0),e([Pr({count:8})],aR.prototype,"emissionSource",void 0),e([Pr()],aR.prototype,"hasVertexColors",void 0),e([Pr()],aR.prototype,"hasNormals",void 0),e([Pr()],aR.prototype,"shadeNormals",void 0),e([Pr()],aR.prototype,"hasSlicePlane",void 0),e([Pr()],aR.prototype,"hasColorTexture",void 0),e([Pr()],aR.prototype,"hasHighlightMixTexture",void 0),e([Pr()],aR.prototype,"receiveAmbientOcclusion",void 0),e([Pr()],aR.prototype,"receiveShadows",void 0),e([Pr()],aR.prototype,"blendingEnabled",void 0),e([Pr()],aR.prototype,"screenSpaceReflections",void 0),e([Pr()],aR.prototype,"hasPolygonOffset",void 0),e([Pr()],aR.prototype,"hasMetallicRoughnessTexture",void 0),e([Pr()],aR.prototype,"hasOcclusionTexture",void 0),e([Pr()],aR.prototype,"hasNormalTexture",void 0),e([Pr()],aR.prototype,"hasOccludees",void 0),e([Pr()],aR.prototype,"terrainDepthTest",void 0),e([Pr()],aR.prototype,"cullAboveTerrain",void 0),e([Pr()],aR.prototype,"hasNormalTextureTransform",void 0),e([Pr()],aR.prototype,"cloudReflections",void 0),e([Pr()],aR.prototype,"snowCover",void 0),e([Pr()],aR.prototype,"olidColor",void 0),e([Pr()],aR.prototype,"hasBloom",void 0),e([Pr()],aR.prototype,"renderOccluded",void 0);class oR extends xr{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}class lR{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function hR(e={}){return(t,i)=>{const s=t._parameterCount??0;if(t._parameterCount=s+1,e.vectorOps){const r=e.vectorOps;Object.defineProperty(t,i,{get(){return this[s]},set(e){const t=this[s];if(null==t)this[s]=[...e];else{if(r.equals(t,e))return;r.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[s]},set(t){this[s]!==t&&(e.dispose&&this[s]&&this[s].dispose(),this[s]=t,this._setDirty())}})}}function cR(){return(e,t)=>{const i=e._parameterCount??0;e._parameterCount=i+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(i),Object.defineProperty(e,t,{get(){return this[i]},set(e){this[i]!==e&&(this[i]=e,this._setDirty())}})}}class dR{constructor(e){this._low=ke(),this._high=ke(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){Zi(this._low,Zi(uR,e));const t=Ui(uR,e,this._low);Zi(this._high,t)}get(e){return Ki(e,this._low,this._high)}getLowScaled(e){return Bi(e,this._low,1)}}const uR=Ks();class pR extends oR{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=gl(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=Zd,this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.normalTexture=null,this.occlusionTexture=null,this.emissionTexture=null,this.emissiveBaseColor=Ne(0,0,0),this.emissiveStrength=0,this.commonMaterialParameters=new mR,this.componentParameters=new gR,this.objectOpacity=1,this.textureAlphaCutoff=ku,this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.hasOccludees=!1;const i=new dR(e.position),s=Js(e.rotationScale);bs(s,s),ps(s,s),this.transformNormalGlobalFromModel=s,this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get _hasEmissiveBase(){return null!=this.emissionTexture||!as(this.emissiveBaseColor,Ue)}get _hasEmissiveStrength(){return 2!==this.componentParameters.emissiveOverride}get hasEmissions(){return this._hasEmissiveStrength&&(this._hasEmissiveBase||2!==this.componentParameters.emissiveSourceOverride)}get texture(){return this.baseColorTexture?.glTexture}get textureMetallicRoughness(){return this.metallicRoughnessTexture?.glTexture}get textureEmissive(){return this.emissionTexture?.glTexture}get textureOcclusion(){return this.occlusionTexture?.glTexture}get textureNormal(){return this.normalTexture?.glTexture}acquireTechnique(e,t,i,s){const r=new aR(e.context.spherical);r.renderOccluded=9===i.slot,r.hasVertexColors=s.hasVertexColors,r.hasNormals=s.hasNormals,r.textureCoordinateType=s.textureCoordinateType,r.hasMetallicRoughnessTexture=null!=this.metallicRoughnessTexture,r.hasOcclusionTexture=null!=this.occlusionTexture,r.hasNormalTexture=null!=this.normalTexture,r.oitPass=0===t.identifier&&null!=i.oitPass?i.oitPass:0,r.terrainDepthTest=0===t.identifier&&i.terrainDepthTest,r.cullAboveTerrain=0===t.identifier&&i.cullAboveTerrain,r.ellipsoidMode=this.ellipsoidMode,r.componentData=this.componentParameters.type,r.cullFace=this.commonMaterialParameters.cullFace,r.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,r.hasColorTexture=null!=this.baseColorTexture;const n=this._computeWhichMaterialPass();r.blendingEnabled=1===n||2===n,r.alphaDiscardMode=this.alphaDiscardMode,r.integratedMeshMode=this.isIntegratedMesh?function(e){return null!=e.overlay?.getTexture(1)}(i)?function(e){return null!=e.overlay?.getTexture(3)}(i)?3:2:1:0,r.hasPolygonOffset=this.polygonOffsetEnabled,r.pbrMode=3===r.integratedMeshMode?4:this.usePBR?this.hasParametersFromSource?s.shadeNormals&&this.isIntegratedMesh?0:2:1:0;const a=1===this.componentParameters.emissiveSourceOverride,o=2===this.componentParameters.emissiveSourceOverride,l=null!=this.emissionTexture;if(r.emissionSource=this.hasEmissions?this._hasEmissiveBase&&1===r.pbrMode?o?l?4:2:a?l?5:7:6:a?7:6:0,r.shadeNormals=s.shadeNormals,r.normalType=r.hasNormals?1:2,r.hasSlicePlane=null!=i.slicePlane&&this.commonMaterialParameters.hasSlicePlane,r.receiveAmbientOcclusion=r.hasOccludees=r.receiveShadows=r.screenSpaceReflections=r.cloudReflections=r.hasHighlightMixTexture=!1,1===t.identifier)r.output=4,r.vertexDiscardMode=0;else if(3===t.identifier)r.output=7,r.vertexDiscardMode=0;else if(2===t.identifier)r.output=8,r.vertexDiscardMode=0,r.hasHighlightMixTexture=null!=i.highlightMixTexture;else{switch(r.vertexDiscardMode=2===n?t.transparent?2:1:0,r.hasBloom=vr(t.output),r.output=t.output,t.output){case 0:case 1:r.receiveAmbientOcclusion=s.applySSAO&&null!=i.ssao?.getTexture(),r.hasOccludees=i.hasOccludees,r.receiveShadows=i.shadowMap.ready,r.screenSpaceReflections=null!=i.ssr.lastFrameColor,r.cloudReflections=null!=i.clouds.data?.cubeMap?.colorTexture;break;case 9:r.olidColor=!0}r.snowCover=i.snowCover}const h=e.get(rR,r);return this._setClean(),h}submit(e,t,i){if(this.objectOpacity<=0)return;const{componentData:s,renderable:r}=i,{geometry:n}=r,a=r.meta.cameraDepthSquared;s.updateHighlights(t.highlights);const{geometryRanges:o,highlightRangesMap:l,shadowmapRanges:h}=s;switch(this._computeWhichMaterialPass()){case 0:e.opaque.submitDraw(this,n,o,a);break;case 1:e.transparent.submitDraw(this,n,o,a);break;case 2:e.opaque.submitDraw(this,n,o,a),e.transparent.submitDraw(this,n,o,a);break;case 3:e.integratedMesh.submitDraw(this,n,o,a),function(e){return null!=e.overlay?.getTexture(e.overlay?.allSourcesOccluders?1:4)}(t)&&e.occludedGround.submitDraw(this,n,o,a),function(e){return null!=e.overlay?.getTexture(2)}(t)&&e.highlightIntegratedMesh.submitDraw(this,n,o,a);break;case 4:e.transparentIntegratedMesh.submitDraw(this,n,o,a)}if(2!==this.componentParameters.castShadows){if(null!=l)for(const t of l)t[0]===Lh&&e.highlightShadowMap.submitDraw(this,n,t[1],a,t[0]);null!=h&&e.defaultShadowMap.submitDraw(this,n,h,a),e.shadowMap.submitDraw(this,n,o,a)}if(null!=l)for(const t of l)e.highlight.submitDraw(this,n,t[1],a,t[0]);t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,n,o,a)}_computeWhichMaterialPass(){if(this.isIntegratedMesh&&this.objectOpacity>=1)return 3;if(this.isIntegratedMesh&&this.objectOpacity<1)return 4;if(this.objectOpacity<1)return 1;if(0===this.componentParameters.opaqueOverride)return 0;if(this.baseColor[3]<1||0===this.alphaDiscardMode||3===this.alphaDiscardMode)return 1;switch(this.componentParameters.transparent){case 2:return 0;case 0:return 1;case 1:return 2}}}e([hR({vectorOps:hl})],pR.prototype,"baseColor",void 0),e([hR()],pR.prototype,"usePBR",void 0),e([hR()],pR.prototype,"hasParametersFromSource",void 0),e([hR({vectorOps:cs})],pR.prototype,"mrrFactors",void 0),e([hR({dispose:!0})],pR.prototype,"baseColorTexture",void 0),e([hR({dispose:!0})],pR.prototype,"metallicRoughnessTexture",void 0),e([hR({dispose:!0})],pR.prototype,"normalTexture",void 0),e([hR({dispose:!0})],pR.prototype,"occlusionTexture",void 0),e([hR({dispose:!0})],pR.prototype,"emissionTexture",void 0),e([hR({vectorOps:cs})],pR.prototype,"emissiveBaseColor",void 0),e([hR()],pR.prototype,"emissiveStrength",void 0),e([cR()],pR.prototype,"commonMaterialParameters",void 0),e([cR()],pR.prototype,"componentParameters",void 0),e([hR()],pR.prototype,"objectOpacity",void 0),e([hR()],pR.prototype,"textureAlphaCutoff",void 0),e([hR()],pR.prototype,"alphaDiscardMode",void 0),e([hR()],pR.prototype,"isIntegratedMesh",void 0),e([hR()],pR.prototype,"polygonOffsetEnabled",void 0),e([hR()],pR.prototype,"ellipsoidMode",void 0),e([hR()],pR.prototype,"hasOccludees",void 0);class mR extends lR{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.hasSlicePlane=!0}}e([hR()],mR.prototype,"doubleSided",void 0),e([hR()],mR.prototype,"cullFace",void 0),e([hR()],mR.prototype,"hasSlicePlane",void 0);class gR extends lR{constructor(){super(...arguments),this.externalColor=pl(1,1,1,1),this.externalColorMixMode=1,this.emissiveStrength=0,this.emissiveSource=0,this.castShadows=0}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return 3===this.externalColorMixMode&&1===this.externalColor[3]?0:2}get emissiveOverride(){return this.emissiveStrength>0?0:2}get emissiveSourceOverride(){return 1===this.emissiveSource?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}}e([hR({vectorOps:hl})],gR.prototype,"externalColor",void 0),e([hR()],gR.prototype,"externalColorMixMode",void 0),e([hR()],gR.prototype,"emissiveStrength",void 0),e([hR()],gR.prototype,"emissiveSource",void 0),e([hR()],gR.prototype,"castShadows",void 0);class _R extends lR{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.emissiveOverride=2,this.emissiveSourceOverride=2,this.castShadows=2}get type(){return 1}}e([hR()],_R.prototype,"texture",void 0),e([hR()],_R.prototype,"transparent",void 0),e([hR()],_R.prototype,"opaqueOverride",void 0),e([hR()],_R.prototype,"emissiveOverride",void 0),e([hR()],_R.prototype,"emissiveSourceOverride",void 0),e([hR()],_R.prototype,"castShadows",void 0);class fR{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}}class yR{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const i=new On(this.textureWidth,1);i.samplingMode=9728,i.wrapMode=33071,this._texture=new An(this._rctx,i),this._data=new ic(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,i,s,r,n){const a=e*this._fieldCount+t;this._dirty=!0,this._data.set(a,0,i),this._data.set(a,1,s),this._data.set(a,2,r),this._data.set(a,3,n)}setDataElement(e,t,i,s){const r=e*this._fieldCount+t;this._dirty=!0,this._data.set(r,i,s)}getDataElement(e,t,i){const s=e*this._fieldCount+t;return this._dirty=!0,this._data.get(s,i)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const e=Math.ceil(t/this.textureWidth)*this.textureWidth,i=new ic(new ArrayBuffer(4*e));i.typedBuffer.set(this._data.typedBuffer),this._data=i}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}}class vR{constructor(e,t=1){this.textureBuffer=new yR(e,t),this._indexManager=new fR(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}}class bR{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>0!==e.activeCount||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const t of this._buffers)if(t.availableCount>=e)return t;if(e>65536)return null;const t=new vR(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}}const wR=()=>C.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class xR{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._activeHighlightOptions=new Map,this._visible=new Xl,this._hidden=new Xl,this._renderSubmit=new UM(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new bR(e.rctx,XM())}destroy(){Kh(0===this._hidden.length&&0===this._visible.length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._componentBufferManager=null,this._visible.forAll(e=>e.destroy()),this._visible.prune(),this._hidden.forAll(e=>e.destroy()),this._hidden.prune(),this._renderSubmit.destroy()}createObject(e){const t=e.geometry,i=new YP(this._componentBufferManager,Jn(t.componentOffsets)),s=this._createRenderable(e,i),r=new _M(this._viewingMode,t.positionData,i),n=new KP(e.transform,e.toMapSpace,e.obb.clone(),i,s,r);return(n.visible?this._visible:this._hidden).push(n),n}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(t?(this._hidden.removeUnordered(i),this._visible.push(i)):(this._visible.removeUnordered(i),this._hidden.push(i)),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll(e=>e.renderable.meta.cameraDepthSquared=rs(t,e.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.componentData.visibility.reset(t),i.componentData.markVisibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.componentData.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.componentData.visibility.componentCount;return{visible:i,invisible:t.componentData.count-i}}setComponentData(e,t){const i=e,{renderable:s,componentData:r}=i,n=s.material,a=r.materialDataBuffer,o=r.materialDataIndices,l=new GM,h=a.textureBuffer,c=new Uint8Array(4),d=new Uint32Array(c.buffer);let u=0,p=0,m=0,g=0,_=0,f=r.verticalOffsets,y=1/0,v=-1/0,b=!1,w=!1,x=!1,C=0;for(let e=0;e<r.count;e++){t(e,l),u+=+(l.externalColor[3]<1),p+=+(3===l.externalColorMixMode&&1===l.externalColor[3]),g+=+(l.emissiveStrength>0),_+=+(1===l.emissiveSource),w||=1!==l.emissiveStrength,m+=+l.castShadows,Gu(l.externalColor,l.externalColorMixMode,c),c[2]=254&c[2]|+l.castShadows,h.setData(o[e],0,c[0],c[1],c[2],c[3]),b||=e>0&&C!==d[0],C=d[0],x||=0!==l.elevationOffset,x&&null==f&&(f=new Array(e).fill(0)),null!=f&&(f[e]=l.elevationOffset),y=Math.min(y,l.elevationOffset),v=Math.max(v,l.elevationOffset),ZM(l.elevationOffset,c),h.setData(o[e],1,c[0],c[1],c[2],c[3]),KM(l.emissiveStrength,c),h.setData(o[e],2,c[0],c[1],c[2],0===l.emissiveSource?0:255);const i=l.olidColor;null!=i&&h.setData(o[e],3,i[0],i[1],i[2],i[3]),l.pickable!==nM(r.pickability,e)&&rM(r,e,l.pickable)}r.verticalOffsets=x?f:null,i.offsetObb=x?Lu(i.obb,y,v,this._viewingMode,i.offsetObb??i.obb.clone()):null,b||x||Jr()||(w||_>0)&&g>0?(n.componentParameters=new _R,n.componentParameters.castShadows=CR(m,r.count),n.componentParameters.transparent=CR(u,r.count),n.componentParameters.opaqueOverride=CR(p,r.count),n.componentParameters.emissiveOverride=CR(g,r.count),n.componentParameters.emissiveSourceOverride=CR(_,r.count),n.componentParameters.texture=h,h.updateTexture()):(n.componentParameters=new gR,n.componentParameters.castShadows=l.castShadows?0:2,n.componentParameters.externalColor=l.externalColor,n.componentParameters.externalColorMixMode=l.externalColorMixMode,n.componentParameters.emissiveStrength=l.emissiveStrength,n.componentParameters.emissiveSource=l.emissiveSource),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,i,s=!1){e.intersectionGeometry.getComponentAabb(t,i);const r=e,n=r.componentData.verticalOffsets;if(s||null==n)return i;const a=n[t];if(2===this._viewingMode||0===a)return i[2]+=a,i[5]+=a,i;const o=ko(a);return o.localOrigin=r.transform.position,o.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}expandRangeWithComponentObjectElevationRange(e,t,i,s){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||s.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const r=e,n=r.componentData,a=n.count,o=n.verticalOffsets,l=r.intersectionGeometry,h=2===this._viewingMode,c=l.getComponentAabbs(),d=TR;let u=1/0,p=-1/0;for(let e=0;e<a;e++){const n=6*e,a=o?.[e]??0;let l=1/0,m=-1/0;if(h)l=c[n+2]+a+t,m=c[n+5]+a+t;else{if(d[0]=c[n],d[1]=c[n+1],d[2]=c[n+2],d[3]=c[n+3],d[4]=c[n+4],d[5]=c[n+5],0!==a){const e=ko(a);e.localOrigin=r.transform.position,e.applyToAabb(d)}const e=Math.max(Math.abs(d[3]),Math.abs(d[0])),o=Math.max(Math.abs(d[4]),Math.abs(d[1])),l=t+d[5]+i;s.expandElevationRangeValues(t+d[2],Math.sqrt(e*e+o*o+l*l)-i)}s.expandElevationRangeValues(l,m),u=Math.min(u,l),p=Math.max(p,m)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=u,this._elevationRangeCacheMax=p}intersect(e,t,i,s,r,n,a){const o=e,{transform:l,componentData:h,intersectionGeometry:c}=o;return null!=r&&(r.localOrigin=l.position),c.intersect(t,i,s,r,h.verticalOffsets,l,n,a)}addEdges(e,t,i,s,r){const n=e,{indices:a,positions:o}=n.intersectionGeometry,l=n.componentData.offsets;return t.addComponentObject(n,o,a,l,i,s,r)}async extractEdgeInformation(e,t,i){const s=e,r=s.componentData.visibility;if(r.allInvisible()){const{extractComponentsEdgeLocationsLayout:e}=await import("../chunks/edgeProcessing.js");return{buffer:e.createBuffer(0),origin:[0,0,0]}}const{indices:n,positions:a}=s.intersectionGeometry,o=s.componentData.offsets,{EdgeInputBufferLayout:l}=await import("../chunks/bufferLayouts.js"),h=l.createBuffer(a.length/3);Nu(h.position.typedBuffer,a,h.position.typedBufferStride,3),Bu(h.position,h.position,s.transform.rotationScale),this._setComponentIndices(h.componentIndex,n,o);const c=h.count,d=this._computeVisibilityIndices(n,r,o,c);return{origin:Fe(s.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:d,indicesLength:d.length,skipDeduplicate:!0,data:h,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,t,i){let s=0;for(let r=0;r<i.length-1;r++){const n=i[r],a=i[r+1];for(let i=n;i<a;i++){const r=t?t[i]:i;e.set(r,s)}s++}}_computeVisibilityIndices(e,t,i,s){if(e&&t.allVisible())return e;let r=0;t.forEachComponentRange((e,t)=>(r+=i[t]-i[e],!0));const n=b(e)?2===e?.BYTES_PER_ELEMENT||s<=65536?new Uint16Array(r):new Uint32Array(r):new Array(r);let a=0;return t.forEachComponentRange((t,s)=>{const r=i[t],o=i[s];for(let t=r;t<o;t++)n[a++]=e?e[t]:t;return!0}),n}addComponentHighlight(e,t,i){const s=e.componentData,r=Td(s.componentHighlights,i,()=>new Uint32Array(s.count+1));{const e=this._activeHighlightOptions.get(i)??0;this._activeHighlightOptions.set(i,e+1)}0===r[t]++&&(s.markHighlightsDirty(),this._notifyDirty()),r[s.count]++}removeComponentHighlight(e,t,i){const{componentData:s}=e,r=s.componentHighlights.get(i);if(void 0===r)return void wR().warn("Removing non-existing highlight.");const n=r[t];if(0===n)return void wR().warn("Removing non-existing highlight.");this._removeActiveHighlight(i);const a=r[s.count];if(n>1)return r[t]=n-1,void(r[s.count]=a-1);r[t]=0,1===a?s.componentHighlights.delete(i):r[s.count]=a-1,s.markHighlightsDirty(),this._notifyDirty()}_removeActiveHighlight(e,t=1){const i=this._activeHighlightOptions.get(e);if(void 0===i)wR().warn("Removing non-existing highlight.");else{const s=i-t;s<0&&wR().warn("Removing non-existing highlight."),s<=0?this._activeHighlightOptions.delete(e):this._activeHighlightOptions.set(e,s)}}clearHighlights(e){const{componentData:t}=e,{componentHighlights:i}=t;if(i.size>0){for(const e of i)this._removeActiveHighlight(e[0],e[1][t.count]);i.clear(),t.markHighlightsDirty(),this._notifyDirty()}}hasHighlight(e){return this._activeHighlightOptions.has(e)}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const i=this._renderManager.rctx,s=e.geometry,r=s.vertices.layoutParameters,n=ia(NM(r)),a=new oa(i,n,s.vertices.data),o=s.indices?ru.createIndex(i,35044,s.indices):null,l=new Uint16Array(s.vertices.count);for(let e=0;e<t.count;e++){const i=t.offsets[e],r=t.offsets[e+1],n=t.materialDataIndices[e];if(null!=s.indices)for(let e=i;e<r;e++)l[s.indices[e]]=n;else for(let e=i;e<r;e++)l[e]=n}const h=new oa(i,nR,l.buffer),c=new pR(e.transform,e.toMapSpace),d=new ra(i,new Map([["geometry",a],["componentIndices",h]]),o),u=new CM(d,Un.TRIANGLES,r,null!=o),p={cameraDepthSquared:.5,gpuMemoryEstimate:a.usedMemory+h.usedMemory+(null!=o?o.usedMemory:0)};return new xM(c,u,p)}_notifyDirty(){this._renderManager.notifyDirty()}}function CR(e,t){return e===t?0:0===e?2:1}const TR=ah();class SR{constructor(e,t,i,s,r){this.rctx=e,this.viewingMode=t,this.stippleTextures=i,this.waterTextures=s,this.markerTextures=r}get spherical(){return 1===this.viewingMode}}class PR{constructor(e){this._context=e,this._debug=!1,this._precompiling=this._debug?0:1,this._cache=new Rd}get context(){return this._context}get precompiling(){return this._precompiling}set precompiling(e){this._precompiling=e,0===e&&this.context.rctx.gl.flush()}get viewingMode(){return this.context.viewingMode}destroy(){this._cache.forAll(e=>e.destroy()),this._cache.clear(),this._context=null}precompile(e,t=MR){++this.precompiling,this.get(e,t),--this.precompiling}get(e,t=MR){const i=t.key.code;let s=this._cache.get(e,i);if(null==s){if(0===this._precompiling){let i=`Uncached shader compile in ${(new Error).stack}\n  for configuration\n${t.decode()}`;const s=this._cache.getInner(e);throw s?.size&&(i+="\n\n  cached configurations:\n",i+=Array.from(s.values()).map(e=>t.decode(e.key)).sort().join("\n\n")),console.log(i),new n("shader:uncached-compile",i)}s=new e(this.context,t),this._cache.set(e,i,s)}return s}async reloadAll(){const e=new Array;this._cache.forEach(t=>e.push(async function(e){let t=!0;e.forEach(async e=>{await e.reload(t),t=!1})}(t))),await Promise.all(e)}}const MR=new Mr,RR={sunny:.0022,cloudy:.0022,rainy:.0022,snowy:.0022,foggy:.0022};class OR{constructor(e,t){this.near=e,this.far=t,this.near=AR(e),this.far=AR(t)}}const DR={sunny:new OR([1,.15,.05,.01,0,0],[2.1,.8,.6,.4,.2,.1]),cloudy:new OR([1,.15,.05,.01,0,0],[1,.8,.6,.4,.2,.1]),rainy:new OR([1,.15,.05,.01,0,0],[1,.8,.6,.4,.2,.1]),snowy:new OR([1,.15,.05,.01,0,0],[1,.8,.6,.4,.2,.1]),foggy:new OR([1,.15,.05,.01,0,0],[1,.8,.6,.4,.2,.1])};function AR(e,t=1){const i=e[0]+e[1]+e[2]+e[3]+e[4]+e[5];return i<t?e:[e[0]/i,e[1]/i,e[2]/i,e[3]/i,e[4]/i,e[5]/i]}class ER extends xr{constructor(){super(...arguments),this.blurRadius=RR.sunny}}const IR=Object.freeze(Object.defineProperty({__proto__:null,BloomBlurPassParameters:ER,build:function(e){const t=new mn,i=t.fragment;t.include(er),i.include(pr),i.uniforms.add(new hr("colorTexture",e=>e.color),new lr("blurRadius",e=>e.blurRadius));let s="";for(let e=0;e<15;e++)s+=`locations1D[${e}] = ${(e/14*2-1).toFixed(3).toString()};`;let r="";for(let e=0;e<15;e++)r+=`locations1DWeights[${e}] = ${Ei(e-Math.floor(7.5),2).toFixed(7).toString()};`;const n=0===e.bloomStage;return i.code.add(br`
    float locations1D[${br.int(15)}];
    float locations1DWeights[${br.int(15)}];

    vec4 blurUniformSamples(sampler2D toBlur) {
      vec4 res = vec4(0.0);
      vec2 size = vec2(textureSize(toBlur, 0));
      vec2 aspectCorrection = vec2(1.0, size.x / size.y);
      vec2 uvInPixel = uv * size;

      ${s}
      ${r}
      vec2 pixelCenterShift = 0.5 / size;

      for(int i=0;i < ${br.int(15)}; i++) {
        float uv1D = locations1D[i] + ${n?"pixelCenterShift.x":"pixelCenterShift.y"};
        vec2 uvOffset = ${n?"vec2(uv1D, 0.0)":"vec2(0.0, uv1D)"};

        vec2 uvDistorted = uv + uvOffset * blurRadius * aspectCorrection;
        vec4 sampleColor = texture(toBlur, uvDistorted);
        res += sampleColor * locations1DWeights[i];
      }
      res.a = clamp(res.a, 0.0, 1.0);
      return res;
    }
  `).main.add(br`fragColor = blurUniformSamples(colorTexture);`),t}},Symbol.toStringTag,{value:"Module"}));class LR extends Tr{constructor(e,t){super(e,t,new Sr(IR,()=>Promise.resolve().then(()=>IR)),ir)}initializePipeline(){return gn({colorWrite:_n})}}class kR extends Mr{constructor(){super(...arguments),this.bloomStage=0}}e([Pr({count:2})],kR.prototype,"bloomStage",void 0);class VR extends xr{constructor(e=2.6,t=DR.sunny.far,i=DR.sunny.near){super(),this.exposure=e,this.lodFactors=t,this.lodFactorsFront=i}}const FR=new VR;class jR extends VR{constructor(){super(...arguments),this.bloomLod=-1}}const zR=Object.freeze(Object.defineProperty({__proto__:null,BloomCompositionPassParameters:jR,build:function(){const e=new mn,t=e.fragment;return e.include(er),t.include(pr),t.include(Kr),t.include(Hd),t.uniforms.add(new hr("colorTexture",e=>e.color),new hr("emissionTexture",e=>e.emission),new hr("bloomTexture0",e=>e.bloomTexture0),new hr("bloomTexture1",e=>e.bloomTexture1),new hr("bloomTexture2",e=>e.bloomTexture2),new hr("bloomTexture3",e=>e.bloomTexture3),new hr("bloomTexture4",e=>e.bloomTexture4),new lr("exposure",e=>e.exposure),new La("bloomLod",e=>e.bloomLod),new Vr("lodFactors",e=>e.lodFactors,6),new Vr("lodFactorsFront",e=>e.lodFactorsFront,6)).main.add(br`vec4 color = texture(colorTexture, uv);
color = vec4(linearizeGamma(color.rgb), color.a);
vec4 lod0 = texture(emissionTexture, uv);
vec4 lod1 = texture(bloomTexture0, uv);
vec4 lod2 = texture(bloomTexture1, uv);
vec4 lod3 = texture(bloomTexture2, uv);
vec4 lod4 = texture(bloomTexture3, uv);
vec4 lod5 = texture(bloomTexture4, uv);
vec4 emission = lodFactors[0] * lod0;
emission += lodFactors[1] * lod1;
emission += lodFactors[2] * lod2;
emission += lodFactors[3] * lod3;
emission += lodFactors[4] * lod4;
emission += lodFactors[5] * lod5;
emission = bloomLod == 0 ? lodFactors[0] * lod0 : bloomLod == 1 ? lodFactors[1] * lod1 : bloomLod == 2 ? lodFactors[2] * lod2 : bloomLod == 3 ? lodFactors[3] * lod3 : bloomLod == 4 ? lodFactors[4] * lod4 : bloomLod == 5 ? lodFactors[5] * lod5 : emission;
emission = vec4(tonemapACES(emission.rgb), emission.a);
fragColor = emission + color;
fragColor = delinearizeGamma(fragColor);`),e},defaultCompositionParameters:FR},Symbol.toStringTag,{value:"Module"}));class HR extends Tr{constructor(e,t){super(e,t,new Sr(zR,()=>Promise.resolve().then(()=>zR)),ir)}initializePipeline(){return gn({colorWrite:_n})}}let qR=class extends Cm{constructor(e){super(e),this.consumes={required:[ii.TRANSPARENT_ENVIRONMENT,"emissive"]},this._blurHorizontalConfiguration=new kR,this._blurVerticalConfiguration=new kR,this._compositionParameters=new jR,this._blurParameters=new ER,this._blurScale=3.06,this._bloomResults=new Array}initialize(){this.addHandles([B(()=>this._updateFogParameters(),()=>{},G),B(()=>this.view.qualitySettings.bloom,e=>{e?(this._enable(),this.precompile()):this._disable()},G)])}_updateFogParameters(){const e=this.view.environment.weather;if("sunny"===e.type||"cloudy"===e.type)this._blurParameters.blurRadius=RR[e.type];else{const t="foggy"===e.type?e.fogStrength:e.precipitation;this._blurParameters.blurRadius=Pi(RR.cloudy,RR[e.type],t)}this._compositionParameters.lodFactors=DR[e.type].far,this._compositionParameters.lodFactorsFront=DR[e.type].near,this.requestRender(1)}precompile(){this.techniques.precompile(LR,this._blurHorizontalConfiguration),this._blurVerticalConfiguration.bloomStage=1,this.techniques.precompile(LR,this._blurVerticalConfiguration),this.techniques.precompile(HR)}render(e){const t=e.find(({name:e})=>e===ii.TRANSPARENT_ENVIRONMENT),i=t.getAttachment(Qn)?.attachment;if(!i)return t;const s=this.techniques.get(LR,this._blurHorizontalConfiguration),r=this.techniques.get(LR,this._blurVerticalConfiguration),n=this.techniques.get(HR);if(!s.compiled||!r.compiled||!n.compiled)return this.requestRender(1),t;const a=t.getTexture(),o=this.fboCache,{fullWidth:l,fullHeight:h}=this.bindParameters.camera,c=this.renderingContext;let d=i,u=Math.ceil(l/2),p=Math.ceil(h/2);const m=this._blurParameters.blurRadius;for(let e=0;e<5;e++){const t=o.acquire(u,p,"bloomHorizontal",8);this._blurParameters.color=d,this._prepareFBO(t,u,p),c.bindTechnique(s,this.bindParameters,this._blurParameters),c.screen.draw();const i=o.acquire(u,p,"bloomVertical",8);this._blurParameters.color=t.getTexture(),this._prepareFBO(i,u,p),c.bindTechnique(r,this.bindParameters,this._blurParameters),c.screen.draw(),t.release(),this._bloomResults[e]=i,u=Math.ceil(u/2),p=Math.ceil(p/2),d=this._bloomResults[e].getTexture(),this._blurParameters.blurRadius*=this._blurScale}this._blurParameters.blurRadius=m,this._compositionParameters.color=a,this._compositionParameters.emission=i,this._compositionParameters.bloomTexture0=this._bloomResults[0].getTexture(),this._compositionParameters.bloomTexture1=this._bloomResults[1].getTexture(),this._compositionParameters.bloomTexture2=this._bloomResults[2].getTexture(),this._compositionParameters.bloomTexture3=this._bloomResults[3].getTexture(),this._compositionParameters.bloomTexture4=this._bloomResults[4].getTexture();const g=o.acquire(a.descriptor.width,a.descriptor.height,this.produces);return this._prepareFBO(g,l,h),c.bindTechnique(n,this.bindParameters,this._compositionParameters),c.screen.draw(),this._bloomResults.forEach(e=>e.release()),g.attachDepth(t.getAttachment($n)),g.attachColor(t.getAttachment(Qn),Qn),g}_prepareFBO(e,t,i){const s=this.renderingContext;s.bindFramebuffer(e.fbo),s.setViewport(0,0,t,i),s.setClearColor(0,0,0,0),s.clear(16384)}get test(){return{compositionParameters:this._compositionParameters,blurParameters:this._blurParameters,setLodFactors:e=>{this._compositionParameters.lodFactors=AR(e)}}}};e([Ce()],qR.prototype,"consumes",void 0),qR=e([Se("esri.views.3d.webgl-engine.effects.bloom.BloomRenderNode")],qR);let UR=class extends sa{constructor(e){super(e),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(e){const t=e.find(({name:e})=>"olid"===e),i=this.renderingContext;return i.bindFramebuffer(t.fbo),i.clearFramebuffer(ml,!0,!0),this.view.stage.renderer.renderAllGeometry(9),i.clear(1280),this.view.stage.renderer.renderHUD(1),t}};e([Ce()],UR.prototype,"consumes",void 0),e([Ce()],UR.prototype,"produces",void 0),UR=e([Se("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],UR);let BR=class extends sa{constructor(e){super(e),this.consumes={required:[ii.OCCLUDED]},this.produces=ii.OCCLUDED,this._blit=new Qu(e.view.stage.renderView.techniques,2)}precompile(){const e=this.view.stage.renderer;e.plugins.plugins.forEach(t=>{e.precompileSlots(t,9,11),t.material&&e.precompileOccludedSlots(t,GR)})}render(e){const t=e.find(({name:e})=>e===this.produces);return this._renderOccludedAndTransparentStencil(t),this._renderOccludedComposite(t),t}_renderOccludedAndTransparentStencil(e){const t=this.view.stage.renderer,i=NR;i.clear();for(const e of t.plugins.plugins)8&e.renderOccludedFlags&&i.push(e);0!==i.length&&(t.renderSlots(i,10),this._renderAndComposite(e,e.getAttachment($n),.5,()=>t.renderSlots(i,11),!1,!1),i.clear())}_renderOccludedComposite(e){const t=this.view.stage.renderer,i=NR;i.clear();let s=0;for(const e of t.plugins.plugins){const t=e.renderOccludedFlags&WR;s|=t,t&&i.push(e)}if(!s)return void i.clear();const r=this._getDepthStencilAttachment(e);let n=r.clearStencil;for(const a of GR)s&a&&(this._renderAndComposite(e,r.depth,16===a?1:.5,()=>t.renderOccludedSlots(i,a),!0,n),n=!1);r.release(),i.clear()}_renderAndComposite(e,t,i,s,r,n){const a=this.renderingContext,{width:o,height:l}=e.fbo,h=this.fboCache.acquire(o,l,"tmp color");h.attachDepth(t),a.bindFramebuffer(h.fbo),a.clearFramebuffer(ml,r,n),s(),h.detachDepth(),this._blit.blend(a,h,e,this.bindParameters,i),h.release()}_getDepthStencilAttachment(e){const{width:t,height:i}=e.fbo;if(!this.view.stage.renderer.occludedRequiresIntegratedMeshStencil){const e=this.fboCache.acquireDepth(11,t,i,"retained stencil");return{depth:e,release:()=>e.release(),clearStencil:!0}}const s=this.fboCache.acquire(t,i,"retained stencil",11);return this.renderingContext.blitFramebuffer(e.fbo,s.fbo,1024),{depth:s.getAttachment($n),release:()=>s.release(),clearStencil:!1}}};e([Ce()],BR.prototype,"consumes",void 0),e([Ce()],BR.prototype,"produces",void 0),BR=e([Se("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],BR);const NR=new Xl,GR=[4,2,16],WR=GR.reduce((e,t)=>e|t,0);class $R extends xr{}const QR=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:$R,build:function(){const e=new mn;return e.include(er),e.fragment.uniforms.add(new hr("colorTexture",e=>e.color),new Br("depthTexture",e=>e.mainDepth)),e.fragment.main.add(br`float depthSample = texture(depthTexture, uv).r;
if (depthSample == 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}},Symbol.toStringTag,{value:"Module"}));class ZR extends Tr{constructor(e,t){super(e,t,new Sr(QR,()=>Promise.resolve().then(()=>QR)),ir)}initializePipeline(){return gn({blending:vn(1,0,769,1),depthTest:{func:519},colorWrite:_n})}}const YR=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new mn,{fragment:i}=t;t.include(cP),Dd(i),i.include(pr),i.include(Kr),i.include(Kp),i.include(Hd),i.include(hP,!0),i.uniforms.add(new Br("depthTexture",e=>e.mainDepth),new lr("hazeStrength",e=>e.hazeStrength));const{reduced:s}=e;return s&&i.code.add(br`float getDepth(vec2 uv){
return linearDepthFromTexture(depthTexture, uv);
}
float textureBilinear(vec2 uv) {
vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
vec2 texelSize = 1.0 / depthTextureSize;
vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);
vec2 f = fract(depthUV);
vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;
float d0 = getDepth(snapUV);
float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
float d3 = getDepth(snapUV + texelSize);
return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
}`),i.main.add(br`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture(depthTexture, uv).r;
      if (depthSample != 1.0) {
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;

        cameraSpaceRay *= ${wr(s,"-textureBilinear(uv)","-linearDepthFromTexture(depthTexture, uv)")};
        terrainDepth = max(0.0, length(cameraSpaceRay));
      } else {
        discard;
      }

      // Alpha is ignored for haze blending
      vec3 col = vec3(0);
      float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
      if(depthSample != 1.0){
        col = (1.0 - fadeOut) * hazeStrength * raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      }
      float alpha = 1.0;

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
  `),t}},Symbol.toStringTag,{value:"Module"}));class KR extends oP{constructor(){super(...arguments),this.hazeStrength=1}}class XR extends Tr{constructor(e,t){super(e,t,new Sr(YR,()=>Promise.resolve().then(()=>YR)),na(sr))}initializePipeline(e){return e.reduced?gn({blending:yn,depthTest:{func:519},colorWrite:_n}):gn({blending:vn(1,0,769,1),colorWrite:_n})}}class JR extends Mr{constructor(){super(...arguments),this.reduced=!1}}e([Pr()],JR.prototype,"reduced",void 0);let eO=class extends Cm{constructor(e){super(e),this._compositingPassParameters=new $R,this._passParameters=new KR,this._hazeConfiguration=new JR,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;const t=e.view.stage.renderView.techniques;t.precompile(XR,new JR);const i=new JR;i.reduced=!0,t.precompile(XR,i),t.precompile(ZR)}initialize(){this.addHandles([B(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),G),B(()=>this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1,e=>this._fade(e),G),B(()=>this.view.environment.weather.type,e=>this._newAmount="rainy"===e?0:1,G),B(()=>this.view.stage.renderer?.fullResolutionAtmosphere,e=>this._hazeConfiguration.reduced=!e,G)])}_fade(e){e>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=e<=0?this._oldAmount:Pi(this._oldAmount,this._newAmount,e)}destroy(){this._vao=M(this._vao)}render(e){const t=e.find(({name:e})=>e===ii.TRANSPARENT_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext,s=this.techniques.get(XR,this._hazeConfiguration);if(!s.compiled)return t;const r=t.getAttachment($n);if(this._update(),!this._hazeConfiguration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(s,this.bindParameters,this._passParameters),this._renderCommon(i),t.attachDepth(r),t;const n=this.techniques.get(ZR);if(!n.compiled)return t;const a=i.getViewport(),o=this.camera,l=$i(o.eye)-de.radius;let h;const c=de.atmosphereHeight;if(l<c){const e=Math.min(1,Math.max(0,l/c));h=Pi(.4,.5,e)}else{const e=Math.min(1,Math.max(0,(l-c)/(15*c)));h=Pi(.5,1,e)}const d=this.renderingContext.parameters.maxTextureSize,u=Lr(Math.round(h*o.fullViewport[2]),d),p=Lr(Math.round(h*o.fullViewport[3]),d);i.setViewport(0,0,u,p);const m=this.fboCache.acquire(u,p,"haze",5);return i.bindFramebuffer(m.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(s,this.bindParameters,this._passParameters),this._renderCommon(i),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=m.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(r),m.release(),t}_renderCommon(e){this._vao??=VT(e,1),e.bindVAO(this._vao),e.drawArrays(Un.TRIANGLE_STRIP,0,4)}_update(){const e=this.bindParameters.camera,t=ts(e.eye),i=Math.sqrt(t),s=t-this._passParameters.radii[1]*this._passParameters.radii[1],r=Ci((i-this._passParameters.radii[0])/de.atmosphereHeight,0,1);rl(this._passParameters.heightParameters,i,t,s,r);const n=this.view.basemapTerrain?.getLowerBoundRadius()??0;Hs(this._passParameters.radii,n,n+de.atmosphereHeight),this._passParameters.hazeStrength=Pi(Pi(.6,1,Ai(9500,10500,i-de.radius)),1,this._amount)}};function tO(e){const t=e.fragment;e.include(ar),t.include(Kr),t.code.add(br`vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
float leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);
float rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);
float bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);
float topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`)}function iO(e){e.include(Yd),function(e){e.fragment.include(Kr),e.include(ar),e.fragment.uniforms.add(new Or("inverseViewMatrix",({camera:e})=>Es(sO,Ms(sO,e.viewMatrix,e.center)))).code.add(br`vec3 calculateUVZShadowAndPixelPosFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap,
out vec4 currentPixelPos
) {
float depth = depthFromTexture(_depthMap, _uv);
if (depth >= 1.0 || depth <= 0.0) {
return invalidShadowmapUVZ;
}
float currentPixelDepth = linearizeDepth(depth);
currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
float linearDepth = -currentPixelDepth;
return calculateUVZShadow(worldSpacePos.xyz, linearDepth, shadowMapSize);
}
vec3 calculateUVZShadowFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap
) {
vec4 currentPixelPos;
return calculateUVZShadowAndPixelPosFromDepth(_uv, shadowMapSize, _depthMap, currentPixelPos);
}`)}(e)}eO=e([Se("esri.views.3d.webgl-engine.effects.haze.Haze")],eO);const sO=Fs(),rO=ke(),nO=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new mn;e.include(iO),e.include(Kd),e.include(er),e.include(tO);const t=e.fragment;return t.include(qu),t.uniforms.add(new Xd("shadowMapExcludingHighlight",e=>e.shadowMap.getSnapshot(1)),new Xd("shadowMapHighlight",e=>e.shadowMap.getSnapshot(0)),new Br("depthMap",e=>e.depth?.attachment),new ua("highlightTexture",e=>e.highlightTexture),new Qr("uColor",e=>e.shadowColor),new lr("opacity",e=>e.shadowOpacity),new lr("occludedOpacity",e=>e.occludedShadowOpacity),new lr("terminationFactor",e=>e.opacityElevation*e.dayNightTerminator),new Rr("lightingMainDirectionView",({lighting:e,camera:t})=>Ni(rO,es(rO,e.mainLight.direction,t.viewInverseTransposeMatrix)))),t.main.add(br`
    ivec2 highlightTextureSize = textureSize(highlightTexture, 0);
    ivec2 highlightIUV = ivec2(uv * vec2(highlightTextureSize));
    uvec2 highlightInfo = texelFetch(highlightTexture, highlightIUV, 0).rg;

    fragColor = vec4(0.0);

    // Calculate bit mask to check if pixel is highlit unoccluded at any level
    uint ored = (highlightInfo.r << 0) | (highlightInfo.g << 8);

    bool visiblyHighlighted = ((ored & ~(ored >> 1)) & (1u+4u+16u+64u)) != 0u;
    if (visiblyHighlighted) {
      return;
    }

    vec4 currentPixelPos;
    vec3 uvzShadow = calculateUVZShadowAndPixelPosFromDepth(uv, textureSize(shadowMapHighlight,0), depthMap, currentPixelPos);
    if (uvzShadow.z < 0.0) {
      return;
    }

    float shadowHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapHighlight);
    if (shadowHighlightFactor == 0.0) {
      return;
    }

    float shadowExcludingHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapExcludingHighlight);

    vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);
    bool shaded = dot(normal, lightingMainDirectionView) < ${br.float(.025)};

    float occludedFactor = max(shadowExcludingHighlightFactor, shaded ? 1.0 : 0.0);
    float fragOpacity = mix(opacity, occludedOpacity, occludedFactor);
    fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
  `),e}},Symbol.toStringTag,{value:"Module"}));class aO extends Ed{constructor(){super(...arguments),this.shadowColor=pl(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class oO extends Tr{constructor(e,t){super(e,t,new Sr(nO,()=>Promise.resolve().then(()=>nO)),ir),this.primitiveType=Un.TRIANGLE_STRIP}initializePipeline(){return gn({blending:Cn,colorWrite:_n,depthTest:null,depthWrite:null})}}const lO=1/512;let hO=class extends sa{constructor(e){super(e),this.produces=ui.COMPOSITE,this.consumes={required:[ui.COMPOSITE,"highlights"]},this._passParameters=new aO,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([B(()=>this.view.highlightOptions.shadowOpacity,e=>{this._passParameters.shadowOpacity=e??kh,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},G),B(()=>this.view.highlightOptions.shadowDifference,e=>{this._shadowDifference=e??Vh,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},G),B(()=>this.view.highlightOptions.shadowColor,e=>{this._passParameters.shadowColor=zu(e??Fh),this._ensureMaxOpacity()},G)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(1)}precompile(){this.techniques.precompile(oO)}render(e){const t=e.find(({name:e})=>e===ui.COMPOSITE),i=this.bindParameters;if(!i.shadowHighlightsVisible||!i.depth||!this._ensureIfVisible(i.camera,i.lighting.mainLight.direction))return t;const s=this.techniques.get(oO);if(!s.compiled)return this.requestRender(1),t;this._passParameters.highlightTexture=e.find(({name:e})=>"highlights"===e)?.getTexture(),this._passParameters.origin=i.camera.center;const r=this.renderingContext;return r.bindFramebuffer(t.fbo),r.bindTechnique(s,i,this._passParameters),r.screen.draw(),t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-Ai(4e4,5e4,e.relativeElevation);const i=1===this.viewingMode?Ni(cO,e.center):qi(cO,0,0,1),s=Gi(i,t);return this._passParameters.dayNightTerminator=Ai(0,1,Ci(30*s,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=lO}};e([Ce()],hO.prototype,"produces",void 0),e([Ce()],hO.prototype,"consumes",void 0),e([Ce({constructOnly:!0})],hO.prototype,"viewingMode",void 0),hO=e([Se("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],hO);const cO=ke();class dO extends xr{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}}const uO=re(),pO=he(),mO=ul(),gO=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:dO,build:function(){const e=new mn;return e.attributes.add("position","vec2"),e.vertex.uniforms.add(new Qr("drawPosition",(e,t)=>function(e,t){const i=t.camera.pixelRatio,s=e.magnifier.offset.x*i,r=e.magnifier.offset.y*i;ae(e.magnifier.position,uO);const n=t.camera.screenToRender(uO,pO),a=Math.ceil(i*e.magnifier.size),{fullWidth:o,fullHeight:l}=t.camera;return rl(mO,(n[0]+s)/o*2-1,(n[1]-r)/l*2-1,a/o*2,a/l*2)}(e,t))),e.varyings.add("vUV","vec2"),e.vertex.main.add(br`vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);`),e.fragment.uniforms.add(new hr("textureInput",e=>e.input)),e.fragment.uniforms.add(new hr("textureMask",e=>e.mask)),e.fragment.uniforms.add(new hr("textureOverlay",e=>e.overlay)),e.fragment.uniforms.add(new Yp("maskEnabled",e=>e.magnifier.maskEnabled)),e.fragment.uniforms.add(new Yp("overlayEnabled",e=>e.magnifier.overlayEnabled)),e.fragment.code.add(br`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}`),e.fragment.main.add(br`float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;`),e}},Symbol.toStringTag,{value:"Module"}));class _O extends Tr{constructor(e,t){super(e,t,new Sr(gO,()=>Promise.resolve().then(()=>gO)),ir)}initializePipeline(){return gn({blending:bn,depthTest:null,depthWrite:null,colorWrite:_n})}}let fO=class extends sa{constructor(){super(...arguments),this.produces=ii.MAGNIFIER,this.consumes={required:[ii.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new dO,this._magnifier=null,this._tmpScreenPoint=re(),this._tmpRenderPoint=he()}initialize(){this.addHandles([B(()=>this.view.magnifier,e=>this._update(e),G)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const e=this._validMagnifier;e?(this._loadResources(e),this.produces=ii.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles(B(()=>this._magnifier?.version,t)),t()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=M(this._vao)}_disposeTextures(){this._passParameters.mask=M(this._passParameters.mask),this._passParameters.overlay=M(this._passParameters.overlay),this._passParameters.input=M(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(_O)}render(e){const t=this._validMagnifier,i=e.find(({name:e})=>e===ii.MAGNIFIER);if(null==t)return i;if(null==this._imageSources)return this.requestRender(1),i;const s=this.renderingContext,r=this.camera.pixelRatio,n=Math.ceil(r*t.size);this._vao??=VT(s,0,0,1);const a=this.techniques.get(_O);if(this._ensureTextureResources(s,n),!a.compiled||!this._passParameters.input)return this.requestRender(1),i;const o=Math.ceil(1/this._factor*n),l=this._passParameters.input;l.resize(o,o),ae(t.position,this._tmpScreenPoint);const h=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),c=this.camera.fullWidth,d=this.camera.fullHeight,u=.5*o,p=.5*o;h[0]=Ci(h[0],u,c-u-1),h[1]=Ci(h[1],p,d-p-1);const m=Math.floor(h[0]-u),g=Math.floor(h[1]-p);return s.bindFramebuffer(i.fbo),a.program.bindTexture("textureInput",l),s.gl.copyTexImage2D(l.descriptor.target,0,l.descriptor.pixelFormat,m,g,o,o,0),this._passParameters.magnifier=t,s.bindTechnique(a,this.bindParameters,this._passParameters),s.bindVAO(this._vao),s.drawArrays(Un.TRIANGLE_STRIP,0,4),i}_loadResources(e){const{maskUrl:t,overlayUrl:i}=e;this._imageLoadTask?.maskUrl===t&&this._imageLoadTask?.overlayUrl===i||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:Jt(async e=>{const s=null==t||null==i?Au(e):null,r=null!=t?ep(t,{signal:e}):s.then(e=>e.mask),n=null!=i?ep(i,{signal:e}):s.then(e=>e.overlay);this._imageSources={mask:await r,overlay:await n}})})}_ensureTextureResources(e,t){null==this._imageSources||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay||(this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t,this._passParameters.overlay=new An(e,this._createTextureDescriptor(t,6408,this._imageSources.overlay),this._imageSources.overlay),this._passParameters.mask=new An(e,this._createTextureDescriptor(t,6406,this._imageSources.mask),this._imageSources.mask),this._passParameters.input=new An(e,this._createTextureDescriptor(t,6408,null)))}_createTextureDescriptor(e,t,i){const s=this.renderingContext,r=new On(e);return r.pixelFormat=r.internalFormat=t,r.wrapMode=33071,r.flipped=!!i,r.preMultiplyAlpha=!(6408!==t||!i||$c(i.src)&&s.driverTest.svgPremultipliesAlpha.result),r}};e([Ce()],fO.prototype,"produces",void 0),e([Ce()],fO.prototype,"consumes",void 0),e([Ce()],fO.prototype,"_imageSources",void 0),e([Ce()],fO.prototype,"_imageLoadTask",void 0),fO=e([Se("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],fO);const yO=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new mn;return e.include(er),e.fragment.uniforms.add(new hr("edgesTexture",e=>e.inputTexture),new hr("areaTexture",e=>e.areaTexture),new hr("searchTexture",e=>e.searchTexture)),e.fragment.constants.add("smaaAreaTexPixelSize","vec2",[1/160,1/560]),e.fragment.code.add(br`
    vec4 sampleLevelZeroOffset(vec2 coord, vec2 offset, vec2 resolution) {
      return texture(edgesTexture, coord + offset.x * resolution);
    }

    float searchLength(vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture(searchTexture, e).r;
    }

    float searchLeft(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${br.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x > end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${br.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x < end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength(e, 0.5, 0.5);
      return texcoord.x;
    }

    float searchUp(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${br.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y > end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength(e.gr, 0.0, 0.5);
      return texcoord.y;
    }

    float searchDown(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${br.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y < end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength(e.gr, 0.5, 0.5);
      return texcoord.y;
    }

    vec2 getArea(sampler2D areaTex, vec2 dist, float e1, float e2, float offset) {
      vec2 texcoord = float(${br.int(16)}) * round(4.0 * vec2(e1, e2)) + dist;
      texcoord = smaaAreaTexPixelSize * texcoord + (0.5 * smaaAreaTexPixelSize);
      texcoord.y += ${br.float(1/7)} * offset;
      return texture(areaTex, texcoord).rg;
    }`),e.fragment.main.add(br`
    vec2 size = vec2(textureSize(edgesTexture, 0));
    vec2 resolution = 1.0 / size;
    vec2 pixelCoord = uv * size;
    vec4 offsets[2];
    offsets[0] = uv.xyxy + resolution.xyxy * vec4(-0.25, 0.125, 1.25, 0.125);
    offsets[1] = uv.xyxy + resolution.xyxy * vec4(-0.125, 0.25, -0.125, -1.25);
    vec4 maxOffset = vec4(offsets[0].xz, offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * resolution.xxyy * float(${br.int(8)});
    ivec4 subsampleIndices = ivec4(0.0);
    vec4 weights = vec4(0.0);
    vec2 e = texture(edgesTexture, uv).rg;
    if (e.r > 0.0) {
      vec2 d;
      vec2 coords;
      coords.y = searchUp(offsets[1].xy, maxOffset.z, resolution);
      coords.x = offsets[0].x;
      d.x = coords.y;
      float e1 = texture(edgesTexture, coords).g;
      coords.y = searchDown(offsets[1].zw, maxOffset.w, resolution);
      d.y = coords.y;
      d = d * size.y - pixelCoord.y;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(0.0, 1.0), resolution).g;
      weights.ba = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.x));
      // for some reason the following lines are necessary to prevent
      // texture lookup precision issues on some Intel integrated graphics chips
      vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
      weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
    }
    if (e.g > 0.0) {
      vec2 d;
      vec2 coords;
      coords.x = searchLeft(offsets[0].xy, maxOffset.x, resolution);
      coords.y = offsets[1].y;
      d.x = coords.x;
      float e1 = texture(edgesTexture, coords).r;
      coords.x = searchRight(offsets[0].zw, maxOffset.y, resolution);
      d.y = coords.x;
      d = d * size.x - pixelCoord.x;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(1.0, 0.0), resolution).r;
      weights.rg = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.y));
    }
    fragColor = weights;
  `),e}},Symbol.toStringTag,{value:"Module"}));class vO extends Tr{constructor(e,t){super(e,t,new Sr(yO,()=>Promise.resolve().then(()=>yO)),ir)}initializePipeline(){return gn({colorWrite:_n})}}const bO=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new mn;return e.include(er),e.fragment.uniforms.add(new hr("blendWeightsTexture",e=>e.inputTexture),new hr("colorTexture",e=>e.color)),e.fragment.main.add(br`vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}`),e}},Symbol.toStringTag,{value:"Module"}));class wO extends Tr{constructor(e,t){super(e,t,new Sr(bO,()=>Promise.resolve().then(()=>bO)),ir)}initializePipeline(){return gn({colorWrite:_n})}}const xO=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new mn;return e.include(er),e.outputs.add("fragEdges","vec2"),e.fragment.code.add(br`float absMax3(vec3 v) {
vec3 t = abs(v);
return max(max(t.r, t.g), t.b);
}`),e.fragment.uniforms.add(new hr("colorTexture",e=>e.color)).main.add(br`
    vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
    vec4 offsets[3];
    offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
    offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
    offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

    // Calculate color deltas:
    vec3 C = texture(colorTexture, uv).rgb;
    vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
    vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
    vec2 delta = vec2(absMax3(C - Cleft), absMax3(C - Ctop));
    vec2 edges = step(vec2(${br.float(.05)}), delta);

    // discard if there is no edge:
    if (dot(edges, vec2(1.0)) == 0.0) {
      fragEdges = vec2(0.0);
    }
    else {
      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      float horizontal = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      float vertical = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), horizontal), vertical);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      horizontal = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      vertical = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, horizontal), vertical);

      // Local contrast adaptation in action:
      fragEdges = edges * step(maxDelta, float(${br.float(2)}) * delta);
    }
  `),e}},Symbol.toStringTag,{value:"Module"}));class CO extends Tr{constructor(e,t){super(e,t,new Sr(xO,()=>Promise.resolve().then(()=>xO)),ir)}initializePipeline(){return gn({colorWrite:_n})}}class TO extends xr{}let SO=class extends sa{constructor(e){super(e),this.produces="disabled",this.consumes={required:[ii.ANTIALIASING],optional:[ui.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new TO}initialize(){this.addHandles([B(()=>this.isEnabled(),e=>e?this.enable():this.disable(),G)])}async enable(){if(this.produces=ii.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await import("../chunks/SMAAData.js");await this._loadTextures(t,e),this.requestRender(1)}catch{}this._abortController=null}async _loadTextures(e,t){V(t);const[i,s]=await Promise.allSettled([ep(e.areaTexture,{signal:t}),ep(e.searchTexure,{signal:t})]);if(V(t),"fulfilled"!==i.status||"fulfilled"!==s.status)return;const r=this.renderingContext;this._areaTexture=PO(r,9729,6407,i.value),this._searchTexture=PO(r,9728,6409,s.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=M(this._searchTexture),this._areaTexture=M(this._areaTexture)}precompile(){this.techniques.precompile(CO),this.techniques.precompile(vO),this.techniques.precompile(wO)}render(e){const t=e.find(({name:e})=>e===ii.ANTIALIASING);if(!this._areaTexture||!this._searchTexture)return this.requestRender(1),t;const i=this.techniques.get(CO),s=this.techniques.get(vO),r=this.techniques.get(wO);if(!i.compiled||!s.compiled||!r.compiled)return this.requestRender(1),t;const n=e.find(({name:e})=>e===ui.COMPOSITE);if(!n)return t;const a=n.fbo.width,o=n.fbo.height,l=this.renderingContext;l.setViewport(0,0,a,o);const h=this.fboCache.acquire(a,o,"smaa edges",2);l.bindFramebuffer(h.fbo),l.setClearColor(0,0,0,1),l.clear(16384),this._smaaParameters.color=n.getTexture();const c=this.bindParameters;l.bindTechnique(i,c,this._smaaParameters),l.screen.draw();const d=this.fboCache.acquire(a,o,"smaa blend");return l.bindFramebuffer(d.fbo),l.setClearColor(0,0,1,1),l.clear(16384),this._smaaParameters.inputTexture=h.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(s,c,this._smaaParameters),l.screen.draw(),h.release(),l.bindFramebuffer(t.fbo),l.setClearColor(0,1,0,1),l.clear(16384),this._smaaParameters.inputTexture=d.getTexture(),l.bindTechnique(r,c,this._smaaParameters),l.screen.draw(),d.release(),t}};function PO(e,t,i,s){const r=new On(s.width,s.height);return r.pixelFormat=i,r.wrapMode=33071,r.samplingMode=t,new An(e,r,s)}e([Ce()],SO.prototype,"produces",void 0),e([Ce()],SO.prototype,"consumes",void 0),e([Ce({constructOnly:!0})],SO.prototype,"isEnabled",void 0),e([Ce()],SO.prototype,"_abortController",void 0),SO=e([Se("esri.views.3d.webgl-engine.effects.smaa.SMAA")],SO);const MO=Fs(),RO=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new mn;return e.attributes.add("position","vec3"),e.attributes.add("color","vec4"),e.attributes.add("size","float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add(new dn("transform",(e,t)=>function(e,t){const i=24e-8;return As(MO,t.camera.projectionMatrix),MO[10]=i-1,MO[11]=-1,MO[14]=(i-2)*t.camera.near,Ps(MO,MO,t.camera.viewMatrix),Ps(MO,MO,e.modelMatrix)}(e,t)),new un("viewport",e=>e.camera.fullViewport),new Yr("pixelRatio",e=>e.camera.pixelRatio)),e.vertex.main.add(br`gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;`),e.fragment.main.add(br`float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);`),e}},Symbol.toStringTag,{value:"Module"}));class OO extends xr{constructor(){super(...arguments),this.modelMatrix=Fs()}}class DO extends Tr{constructor(e,t){super(e,t,new Sr(RO,()=>Promise.resolve().then(()=>RO)),AO.locations)}initializePipeline(){return gn({blending:Cn,depthTest:{func:515},colorWrite:_n})}}const AO=ta().vec3f("position").vec4u8("color").f32("size").freeze();let EO=class extends xm{constructor(){super(...arguments),this._numPoints=0,this._passParameters=new OO}initialize(){this.addHandles([B(()=>this.view.environment.starsEnabled,e=>e?this._enable():this._disable(),N),B(()=>"virtual"===this.view.environment.lighting.type?null:this.view.environment.lighting.date,e=>this._update(e),G)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=P(this._loadDataTask),this._numPoints=0,this._vao=M(this._vao),this._starData=null}precompile(){this.techniques.precompile(DO)}render(e){const t=e.find(({name:e})=>e===ii.OPAQUE_ENVIRONMENT),i=this.renderingContext;if(this.loading)return this.requestRender(1),t;if(!this._starData)return t;this._vao??=this._ensureResources(this._starData,i);const s=this.techniques.get(DO);return s.compiled?(i.bindTechnique(s,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Un.POINTS,0,this._numPoints),t):(this.requestRender(1),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/jO,function(e,t,i,s){const r=AO.createBuffer(s),n=r.position,a=r.color,o=r.size;for(let e=0;e<s;e++){const s=t[2*e],r=t[2*e+1];n.set(e,0,-Math.cos(s)*Math.sin(r)),n.set(e,1,-Math.sin(s)*Math.sin(r)),n.set(e,2,-Math.cos(r));const l=LO(i[e]),h=IO(kO[l[1]]);a.set(e,0,255*h[0]),a.set(e,1,255*h[1]),a.set(e,2,255*h[2]),a.set(e,3,255),o.set(e,l[0])}return new ra(e,new oa(e,ia(AO),r.buffer))}(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*function(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}(e),s=As(this._passParameters.modelMatrix,FO);ks(s,s,-i*Math.PI),Ps(s,VO,s),ks(s,s,-t*Math.PI),this.requestRender(1)}_createLoadDataTask(){if(this._starData)return null;const e=Jt(async e=>{const{data:t}=await tp("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});!function(e){if(!e)throw new n("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/jO;if(t%1!=0||t>5e4||t<5e3)throw new n("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}(t),this._starData=t});return e.promise.catch(e=>{F(e)||C.getLogger(this).error(e)}).then(()=>{this.destroyed||this.requestRender(1)}),e}};function IO(e){return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)]}function LO(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}EO=e([Se("esri.views.3d.webgl-engine.effects.stars.Stars")],EO);const kO=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],VO=zs(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),FO=zs(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),jO=9;class zO extends xr{}const HO=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:zO,build:function(){const e=new mn;return e.include(er),e.fragment.uniforms.add(new hr("tex",e=>e.texture)),e.fragment.main.add(br`fragColor = vec4(1.0 - texture(tex, uv).a);`),e}},Symbol.toStringTag,{value:"Module"}));class qO extends Tr{constructor(e,t){super(e,t,new Sr(HO,()=>Promise.resolve().then(()=>HO)),ir)}initializePipeline(){return gn({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}class UO{constructor(e,t){this._rctx=e,this._techniques=t,this._configuration=new Zu,this._passParameters=new Yu,this._hudParameters=new zO,this._configuration.blitMode=2,this._techniques.precompile(Ku,this._configuration),this._configuration.hasOpacityFactor=!0,this._techniques.precompile(Ku,this._configuration),this._configuration.hasOpacityFactor=!1,this._configuration.blitMode=1,this._techniques.precompile(Ku,this._configuration),this._configuration.blitMode=3,this._techniques.precompile(Ku,this._configuration),this._techniques.precompile(qO)}compositeHUD(e,t){this._hudParameters.texture=t;const i=this._techniques.get(qO);this._rctx.bindTechnique(i,e,this._hudParameters),this._rctx.screen.draw()}compositePreMultipliedAlpha(e,t,i=1){this._composite(e,t,2,i)}composite(e,t){this._composite(e,t,1,1)}blitDepthToLinearDepth(e,t){this._composite(e,t,3,1)}_composite(e,t,i,s){this._configuration.blitMode=i,this._configuration.hasOpacityFactor=1!==s,this._passParameters.texture=t,this._passParameters.opacity=s;const r=this._techniques.get(Ku,this._configuration);this._rctx.bindTechnique(r,e,this._passParameters),this._rctx.screen.draw()}}class BO{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new ic(new ArrayBuffer(4)),this._layerToOidToColor=new Rd,this._colorToUID=new Map,this._layerViewUidToGraphicsUidToObjectId=new Rd,this._layerViewUidToLayerId=new Map,this._layerViewUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,i,s,r,n=null,a=null,o=null){e&&t&&i&&s&&(this._layerViewUidToLayerId.set(s,i),this._layerViewUidToPopupEnabled.set(s,r),r&&this._layerViewUidToGraphicsUidToObjectId.set(s,t,{objectId:e,attributeNodeId:n,attributeIndex:a,subLayerId:o}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return pl(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerViewUid||!e.graphicUid)return this.colorZero;const t=this._layerViewUidToPopupEnabled.get(e.layerViewUid);if(void 0===t)return this.colorZero;if(!1===t)return this.colorZero;const i=this._layerViewUidToGraphicsUidToObjectId.get(e.layerViewUid,e.graphicUid)?.objectId;if(!i)return this.colorZero;let s=this._layerToOidToColor.get(e.layerViewUid,i);if(!s){if(h("enable-feature:objectAndLayerId-screenshot-testing"))s=i;else for(;!s;){const e=Math.floor(16777214*Math.random())+1;this._colorToUID.has(e)||(s=e)}if(s>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerViewUid,i,s),this._colorToUID.set(s,e)}const r=new ArrayBuffer(4);return new DataView(r).setUint32(0,s,!1),new ic(r)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,i]of this._colorToUID.entries()){const s=this._layerViewUidToGraphicsUidToObjectId.get(i.layerViewUid,i.graphicUid),r=this._layerViewUidToLayerId.get(i.layerViewUid);s&&r&&e.set(t,s.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:s.objectId,lid:r,attrId:s.attributeNodeId,attrIdx:s.attributeIndex,subLayerId:s.subLayerId}:{type:"object-and-layer-id",olid:s.objectId,lid:r})}return e}}class NO extends np{constructor(e,t,i){super(e,t,i),this.attachment=t,this.type=2}}function GO(e){return e>=10}const WO=new On;WO.pixelFormat=6403,WO.internalFormat=Zn.R8,WO.wrapMode=33071;const $O=new On;$O.pixelFormat=36244,$O.internalFormat=Zn.R8UI,$O.wrapMode=33071,$O.samplingMode=9728;const QO=new On;QO.pixelFormat=33319,QO.internalFormat=Zn.RG8,QO.wrapMode=33071;const ZO=new On;ZO.pixelFormat=33320,ZO.internalFormat=Zn.RG8UI,ZO.wrapMode=33071,ZO.samplingMode=9728;const YO=new On;YO.internalFormat=Zn.RGBA4,YO.dataType=Nn.UNSIGNED_SHORT_4_4_4_4,YO.wrapMode=33071;const KO=new On;KO.wrapMode=33071;const XO=new On;XO.wrapMode=33071,XO.samplingMode=9987,XO.hasMipmap=!0,XO.maxAnisotropy=8;const JO=new On;JO.pixelFormat=6403,JO.dataType=Nn.HALF_FLOAT,JO.internalFormat=Zn.R16F,JO.samplingMode=9728;const eD=new On;eD.dataType=Nn.HALF_FLOAT,eD.internalFormat=Zn.RGBA16F,eD.wrapMode=33071;const tD=new On;tD.pixelFormat=6403,tD.dataType=Nn.FLOAT,tD.internalFormat=Zn.R32F,tD.samplingMode=9728;const iD={0:WO,1:$O,2:QO,3:ZO,4:YO,5:KO,6:XO,7:JO,8:eD,9:tD,10:null},sD={[Yn.DEPTH_COMPONENT16]:Nn.UNSIGNED_SHORT,[Yn.DEPTH_COMPONENT24]:Nn.UNSIGNED_INT,[Yn.DEPTH_COMPONENT32F]:Nn.FLOAT,[Gn.DEPTH24_STENCIL8]:Nn.UNSIGNED_INT_24_8,[Gn.DEPTH32F_STENCIL8]:Nn.FLOAT_32_UNSIGNED_INT_24_8_REV},rD={11:nD(Gn.DEPTH24_STENCIL8),10:nD(Yn.DEPTH_COMPONENT16)};function nD(e){const t=new On;return t.pixelFormat=In(e)?6402:34041,t.dataType=sD[e],t.samplingMode=9728,t.wrapMode=33071,t.internalFormat=e,t.hasMipmap=!1,t.isImmutable=!0,t}class aD{constructor(e,t){this._last=new Xl,this._incarnation=0,this._cache=new fw(e,t)}destroy(){this._last?.forAll(e=>e.dispose()),this._last?.prune(),this._last=null,this._cache.destroy()}set interactive(e){e&&!this._last?this._last=new Xl:e||(this._last?.forAll(e=>e.dispose()),this._last=null)}clean(){this._last?.filterInPlace(e=>!(e.incarnation<this._incarnation&&(this._cache.put(e.key,e),1)))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find(t=>t.key===e);if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){return this._last?.reduce((e,t)=>e+t.cachedMemory,0)??0}}class oD{constructor(e){this.rctx=e,this._interactive=!1,this._acquired=new Set,this._cache=new aD(e.newCache,"FBOCache"),this._depthCache=new aD(e.newCache,"DepthAttachmentCache"),this._colorCache=new aD(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.()}frameEnd(){const{debugCallback:e}=this;e&&this._acquired.forEach(t=>e(t.name,t.fbo))}get usedMemory(){return Array.from(this._acquired.values()).reduce((e,t)=>e+t.cachedMemory,this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e,this._interactive=e}get interactive(){return this._interactive}acquire(e,t,i,s=5){const r=dD(s,e,t);let a=this._cache.pop(r);const{rctx:o}=this;if(a){a.retain(),a.setName(i);const e=a.getAttachment($n);e&&(e.name=hD(i));const t=a.getAttachment(qn);t&&(t.name=lD(i,0));const{fbo:s}=a;if(!s)throw new n("renderer","attempt to use a none existing framebuffer");o.temporaryBindFramebufferObject(s,()=>{o.setDrawBuffers([qn]),o.unbindTexture(s.colorTexture)})}else{const n=new Pn(o),l=(i,s,r)=>{s??=5;const n=this._acquireColor(s,e,t,r??lD(a.name,i-qn));return this.rctx.unbindTexture(n.attachment),a.attachColor(n,i),n.release(),a},h=i=>{i??=11;const s=this.acquireDepth(i,e,t,hD(a.name));return a.attachDepth(s),s.release(),a},c=()=>{if(!a)return;this.debugCallback?.(a.name,a.fbo),this._acquired.delete(a);const e=GO(s);e&&null!=a.getAttachment($n)||!e&&null!=a.getAttachment(qn)?(e?(a.fbo?.invalidateAttachments([$n]),a.detachAllColors()):(a.fbo?.invalidateAttachments([qn]),a.detachAllButColor0()),this._cache.put(a)):a.dispose()};a=new rp(r,i,n,l,h,c),GO(s)?a.acquireDepth(s):a.acquireColor(qn,s,i)}return this._trackHandle(a)}acquireDepth(e,t,i,s){const r=dD(e,t,i);let n=this._depthCache.pop(r);if(n)n.retain(),n.attachment.setShadowFiltering(!1);else{const s=new An(this.rctx,{...rD[e],width:t,height:i});n=new ap(r,s,()=>this._depthCache.put(n))}return n.name=s,n}_acquireColor(e,t,i,s){const r=dD(e,t,i);let n=this._colorCache.pop(r);if(n)n.retain();else{const s=new An(this.rctx,{...iD[e],width:t,height:i});n=new NO(r,s,()=>this._colorCache.put(n))}return n.name=s,n}_trackHandle(e){return this._acquired.add(e),e}}function lD(e,t=0){return`${e}.color${t}`}function hD(e){return`${e}.depth`}const cD=new rp("default","default",null,()=>cD,()=>cD,()=>{});function dD(e,t,i){return`${t}x${i}:${e}`}cD.release=()=>!1;class uD{constructor(e,t,i=0){this._rctx=e,this._techniques=t,this._sorting=i,this._draws=new Xl({allocator:e=>e??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,s,r){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=i,n.material=e,n.depthSquaredHint=s,n.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,n.highlightName=r}acquire(e,t){return this._draws.map(i=>i.material.acquireTechnique(this._techniques,e,t,i.geometry.parameters))}dispatch(e,t,i){const s=this._rctx;this._previouslyBoundDraw.clear();let r=null;const n=this._draws.length,a=t.highlight?.name;for(let o=0;o<n;o++){const n=this._draws.data[o];if(2===e.identifier){const e=n.highlightName;if(e){if(e!==a)continue}else if(!a||!t.overlay?.hasHighlight(a))continue}const l=i[o];l===r&&0===t.oitPass||(s.bindTechnique(l,t,e),r=l);const{geometryRanges:h,indexType:c,geometry:d,material:u}=n;s.bindVAO(d.vao),this._previouslyBoundDraw.get(l)!==u&&(l.program.bindDraw(t,e,u),this._previouslyBoundDraw.set(l,u));const p=h.length,{primitiveType:m}=d;for(let e=0;e<p;e+=2){const t=h[e],i=h[e+1];if(0!==c){const e=pD.get(c);s.drawElements(m,i,c,t*e)}else s.drawArrays(m,t,i)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort((t,i)=>e*(t.depthSquaredHint-i.depthSquaredHint)||t.geometry.vao.usedMemory-i.geometry.vao.usedMemory)}get count(){return this._draws.length}}const pD=new Map;pD.set(Bn.UNSIGNED_BYTE,1),pD.set(Bn.UNSIGNED_SHORT,2),pD.set(Bn.UNSIGNED_INT,4);class mD{constructor(e){const t=e.renderContext.rctx,i=e.techniques;this.opaque=new uD(t,i),this.transparent=new uD(t,i,1),this.integratedMesh=new uD(t,i),this.transparentIntegratedMesh=new uD(t,i),this.occludedGround=new uD(t,i),this.shadowMap=new uD(t,i),this.highlight=new uD(t,i),this.highlightIntegratedMesh=new uD(t,i),this.highlightShadowMap=new uD(t,i),this.viewshedShadowMap=new uD(t,i),this.defaultShadowMap=new uD(t,i)}}class gD extends Jd{constructor(){super(...arguments),this.slicePlaneLocalOrigin=ke(),this.origin=this.slicePlaneLocalOrigin}}class _D extends gD{constructor(){super(...arguments),this.identifier=0,this.output=0,this.transparent=!1,this.occludedGround=!1}}class fD extends gD{constructor(){super(...arguments),this.identifier=1}}class yD extends gD{constructor(){super(...arguments),this.identifier=2}}class vD extends gD{constructor(){super(...arguments),this.identifier=3}}let bD=class extends ha{constructor(){super({}),this.produces=new Map([[2,e=>this._produces(e,2)],[4,e=>this._produces(e,4)],[0,e=>this._produces(e,0)],[7,e=>this._produces(e,7)],[9,e=>this._produces(e,9)]]),this._materialPassParameters=new _D,this._shadowPassParameters=new fD,this._highlightPassParameters=new yD,this._viewshedPassParameters=new vD,this._systems=new Set}initializeRenderContext(e){this._context=e,this._passes=new mD(e)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear(),this._passes=null}register(e){this._systems.add(e)}_produces(e,t){return!!this._invoke(e,t,e=>e.count>0)}prepareRender(e){const{_systems:t,_passes:i}=this;if(0!==t.size&&null!=i){for(const e of Object.values(i))e.prepareSubmit();t.forEach(t=>t.submit(i,e.bind));for(const e of Object.values(i))e.finishSubmit()}}acquireTechniques(e){if(0===this._systems.size)return null;const t=4===e.output||5===e.output||6===e.output?this._shadowPassParameters:7===e.output?this._viewshedPassParameters:8===e.output?this._highlightPassParameters:this._materialPassParameters,i=e.bind;return this._updateParameters(i.camera,t,i.slot),this._materialPassParameters.output=e.output,this._invoke(e.output,e.bind.slot,(t,i)=>t.acquire(i,e.bind))}render(e,t){this._invoke(e.output,e.bind.slot,(i,s)=>i.dispatch(s,e.bind,t))}_invoke(e,t,i){if(null==this._passes)return null;switch(t){case 2:switch(e){case 0:case 1:case 2:case 3:case 9:return i(this._passes.opaque,this._materialPassParameters);case 8:return i(this._passes.highlight,this._highlightPassParameters);case 4:return i(this._passes.shadowMap,this._shadowPassParameters);case 5:return i(this._passes.highlightShadowMap,this._shadowPassParameters);case 6:return i(this._passes.defaultShadowMap,this._shadowPassParameters);case 7:return i(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case 4:switch(e){case 0:case 1:case 2:case 3:case 9:return i(this._passes.transparent,this._materialPassParameters)}break;case 0:switch(e){case 0:case 1:case 2:case 3:case 9:return i(this._passes.integratedMesh,this._materialPassParameters);case 8:return i(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}break;case 7:switch(e){case 0:case 1:return i(this._passes.transparentIntegratedMesh,this._materialPassParameters)}break;case 9:switch(e){case 0:case 1:case 2:case 3:case 9:return i(this._passes.occludedGround,this._materialPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new pi;return this._systems.forEach(i=>t.union(i.queryDepthRange(e))),t}get hasEmissions(){let e=!1;return this._systems.forEach(t=>e=t.hasEmissions||e),e}_updateParameters(e,t,i){const s=e.viewInverseTransposeMatrix,r=4===i,n=9===i;qi(wD,s[3],s[7],s[11]),CD.set(wD),Zi(t.transformWorldFromViewTH,CD.high),Zi(t.transformWorldFromViewTL,CD.low),Zi(t.slicePlaneLocalOrigin,wD),us(t.transformViewFromCameraRelativeRS,e.viewMatrix),As(t.transformProjFromView,e.projectionMatrix),0===t.identifier&&(this._materialPassParameters.transparent=r,this._materialPassParameters.occludedGround=n,ps(xD,t.transformViewFromCameraRelativeRS),bs(t.transformNormalViewFromGlobal,xD))}hasHighlight(e){for(const t of this._systems)if(t.hasHighlight(e))return!0;return!1}};bD=e([Se("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],bD);const wD=ke(),xD=Xs(),CD=new dR;class TD{constructor(e){this._context=e,this._nodes=new Xl}destroy(){this._nodes.forEach(e=>e.destroy()),this._nodes.prune()}add(e){this._nodes.push(e)}remove(e){this._nodes.remove(e)}produces(e){return this._nodes.some(({produces:t})=>t===e)}require(e,...t){const i=this._nodes,s=t=>i.reduce((i,{consumes:s,produces:r})=>i+(!s.required.includes(e)||null!=t&&r!==t?0:1),0);return 0===t.length?s():t.reduce((e,t)=>e+s(t),0)}optional(e,...t){const i=this._nodes,s=t=>i.reduce((i,{consumes:s,produces:r})=>i+(!s.optional?.includes(e)||null!=t&&r!==t?0:1),0);return 0===t.length?s():t.reduce((e,t)=>e+s(t),0)}updateAnimation(e){return this._nodes.reduce((t,i)=>i.updateAnimation(e)||t,!1)}precompile(...e){++this._context.techniques.precompiling;for(const t of e)this._nodes.forEach(e=>{e.produces===t&&e.precompile()});--this._context.techniques.precompiling}render(e,t,i=()=>{}){return this._render(e,t,i)??(e.name?e:cD)}produce(e,t,i=()=>{}){return this._render(e,t,i)}_render(e,t,i=()=>{}){const s="string"==typeof e?e:e.name,r=this._nodes.filter(({produces:e})=>e===s);if(0===r.length)return;let n="string"==typeof e?null:e;return r.some(e=>{const r=n?[n]:[],a=null==n;for(const n of e.consumes.required){if(n===s){if(a)return!1;continue}const e=t.get(n);if(e)r.push(e);else if("emissive"!==n||!t.get(s)?.hasAttachment(n))return i?.(r),!1}if(e.consumes.optional)for(const i of e.consumes.optional){if(i===s)continue;const e=t.get(i);e&&r.push(e)}try{const i=e.doRender(r);i&&i!==n&&(s!==i.name&&(C.getLogger(e).errorOnce(`RenderNode produced ${i.name}, expected ${s}`),i.setName(s)),n?.release(),n=i,t.set(s,n))}catch(t){C.getLogger(e).errorOnce(t)}return i?.(r),a&&null!=n}),this._context.rctx.enforceState(),n}requireGeometryDepth(){return this._nodes.some(e=>"disabled"!==e.produces&&e.requireGeometryDepth)}get test(){return{nodes:this._nodes}}}class SD{constructor(e){this.context=e,this._renderPlugins=new Array,this._slots=new Array,this._version=ds(0);for(let e=0;e<21;++e)this._slots[e]=[]}destroy(){this._renderPlugins.forEach(e=>e.destroy()),this._renderPlugins.length=0}get plugins(){return this._renderPlugins}add(e,t){const i=()=>{if(t?.aborted)throw e.uninitializeRenderContext(),A();this._renderPlugins.push(e),e.produces.forEach((t,i)=>this._slots[i].push(e)),this.context.requestRender(),this._version.value++},s=e.initializeRenderContext(this.context,t);if(H(s))return s.then(i);i()}remove(e){u(this._renderPlugins,e),e.uninitializeRenderContext();for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter(t=>t!==e);this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forEach(e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)})}updateAnimation(e){let t=!1;return this._renderPlugins.forEach(i=>t=i.updateAnimation?.(e)||t),t}precompile(...e){++this.context.techniques.precompiling;const t=this.context.renderContext.bind.slot;for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender(()=>{});this.context.renderContext.bind.slot=t,--this.context.techniques.precompiling}render(...e){for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender((e,t)=>e.render(this.context.renderContext,t))}_forEachRender(e){const t=this.context.renderContext.bind.slot,i=this.context.renderContext.output;this._slots[t].forEach(s=>{const r=s.produces.get(t);if(!r?.(i)||s.isDecoration&&!this.context.renderContext.bind.decorations)return;const n=s.acquireTechniques(this.context.renderContext);n&&e(s,n)})}queryDepthRange(e){const t=new pi;return this._renderPlugins.forEach(i=>{const s=i.queryDepthRange?.(e);t.union(s)}),t}get updating(){return this._version.value>=0&&this._renderPlugins.some(e=>e.readyToRun)}produces(e,...t){return t.some(t=>this._slots[t].some(i=>{const s=i.produces.get(t);return!!s&&s(e)}))}consumes(e){return this._renderPlugins.some(t=>t.consumes().required.includes(e))}hasHighlight(e){return PD.some(t=>this._slots[t].some(t=>t.hasHighlight(e)))}get hasDecorations(){return this._renderPlugins.some(e=>e.isDecoration)}get hasOccludees(){return this._renderPlugins.some(e=>e.hasOccludees)}get hasEmissions(){return this._renderPlugins.some(e=>e.hasEmissions)}get renderOccludedFlags(){return this._renderPlugins.reduce((e,t)=>e|(t.renderOccludedFlags??0),0)}get usedMemory(){return this._renderPlugins.reduce((e,t)=>t.material?e:e+(t.usedMemory??0),0)}get test(){}}const PD=[2,4,18,13,14];class MD extends xr{}const RD=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:MD,build:function(e){const t=new mn;t.include(er);const i=e.hasEmission,s=t.fragment;return s.uniforms.add(new hr("colorTexture",e=>e.colorTexture),new hr("alphaTexture",e=>e.alphaTexture),new hr("frontFaceTexture",e=>e.frontFaceTexture)),t.outputs.add("fragColor","vec4",0),i&&(t.outputs.add("fragEmission","vec4",1),s.uniforms.add(new hr("emissionTexture",e=>e.emissionTexture)),s.uniforms.add(new hr("emissionFrontFaceTexture",e=>e.emissionFrontFaceTexture))),s.main.add(br`
      float srcAlpha = texture(alphaTexture, uv).r;
      if(srcAlpha == 0.0){
        fragColor = vec4(0.0);
        ${wr(i,"fragEmission = vec4(0.0);")}
        return;
      }

      vec4 srcColor = texture(colorTexture, uv);
      vec4 frontFace = texture(frontFaceTexture, uv);

      vec4 transparentColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);
      fragColor = transparentColor;

      ${wr(i,"vec4 emission = texture(emissionTexture, uv);\n         vec4 emissionFrontFace = texture(emissionFrontFaceTexture, uv);\n        fragEmission = vec4(mix(emission.rgb / srcAlpha, emissionFrontFace.rgb, emissionFrontFace.a), emissionFrontFace.a);")}
    `),t}},Symbol.toStringTag,{value:"Module"}));class OD extends Tr{constructor(e,t){super(e,t,new Sr(RD,()=>Promise.resolve().then(()=>RD)),ir)}initializePipeline(e){return gn({blending:Cn,colorWrite:_n,drawBuffers:e.hasEmission?{buffers:[qn,Qn]}:{buffers:[qn]}})}}class DD extends Mr{constructor(){super(...arguments),this.hasEmission=!1}}e([Pr()],DD.prototype,"hasEmission",void 0);class AD{constructor(e){this._techniques=e,this._parameters=new MD,this._configuration=new DD,e.precompile(OD,this._configuration),this._configuration.hasEmission=!0,e.precompile(OD,this._configuration)}blend(e,t,i,s,r){this._parameters.colorTexture=t.getTexture(),r&&(this._parameters.emissionTexture=t.getTexture(Qn),this._parameters.emissionFrontFaceTexture=i.getTexture(Qn)),this._parameters.alphaTexture=t.getTexture(r?Kn:Qn),this._parameters.frontFaceTexture=i.getTexture(),this._configuration.hasEmission=r;const n=this._techniques.get(OD,this._configuration);e.bindTechnique(n,s,this._parameters),e.screen.draw()}}class ED{constructor(e,t){this._camera=e,this._dt=X(0),this._time=X(0),this._lastUpdate=X(0),this._lastUpdate=t,this._time=t}advance(e,t,i){const s=X(t-this._lastUpdate);this._dt=X(s/i),this._time=X(this._time+s),this._lastUpdate=t,this._camera=e}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}}class ID{constructor(){this._step=zD,this._dilation=1,this._firstIdleTime=X(0)}frame(e,t){if(t?0===this._firstIdleTime&&(this._firstIdleTime=X(performance.now())):this._firstIdleTime=X(0),h("disable-feature:high-quality-idle"))this._dilation=1;else{const e=t?performance.now()-this._firstIdleTime:0;if(e>=kD+VD)return this._step=X(1/0),void(this._dilation=1);this._dilation=e>=kD?FD:1}const i=Ci(e/LD,zD,HD);this._step===1/0?this._step=X(i):this._step=X(this._step*jD+i*(1-jD))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=X(0)}}const LD=.5,kD=X(12e4),VD=X(1e4),FD=10,jD=.9,zD=X(1e3),HD=X(1e3/30);function qD(e,t,i,s){let r=0;if(!t.some(e=>!!e.material&&(r+=e.numGeometries,r>=1e4)))return JD.compute(e,t,s);const n=new pi;return i.forEach(t=>n.union(function(e,t){if(!t.visible)return;const i=new pi,s=t.getSpatialQueryAccelerator();return s?function(e,t,i){const{eye:s,viewForward:r,frustum:n}=t,a=e=>e.visible,o=i.objectCount;if(o<500)KD.set(t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(s,r,1,KD,(i,s)=>{UD(e,t,i),KD.far=e.near,s.setRange(KD)},n,a),KD.set(Math.max(e.far,t.near),t.far),i.forEachInDepthRange(s,r,-1,KD,(i,s)=>{UD(e,t,i),KD.near=e.far,s.setRange(KD)},n,a);else{const s=Math.max(Math.min(o,500),Math.ceil(.1*o)),l=i.findClosest(r,1,n,a,s),h=i.findClosest(r,-1,n,a,s);l&&h&&(ND(e,t,l.boundingVolumeWorldSpace.bounds),ND(e,t,h.boundingVolumeWorldSpace.bounds))}}(i,e,s):function(e,t,i){XD.clear(),i.forEach(e=>{e.visible&&0!==e.geometries.length&&XD.add(e)}),XD.empty||(XD.sort(t),KD.set(t.near,Math.min(e.near,t.far)),XD.forEachInDepthRange(KD,1,(i,s)=>{s<e.near&&UD(e,t,i)}),KD.set(Math.max(e.far,t.near),t.far),XD.forEachInDepthRange(KD,-1,(t,i,s)=>{e.far=Math.max(e.far,s)}))}(i,e,t.objects),i}(e,t))),n}function UD(e,t,i){if(!i.visible)return;if(!rd(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const s=i.transformation,r=YD;i.geometries.forEach(i=>{Ps(r,s,i.transformation);const n=Fi(r);BD(e,t,i.boundingInfo,r,n)})}function BD(e,t,i,s,r){if(null==i)return;es(Qa(ZD),i.center,s);const{eye:n,viewForward:a}=t,o=a[0]*(ZD[0]-n[0])+a[1]*(ZD[1]-n[1])+a[2]*(ZD[2]-n[2]);if(ZD[3]=i.radius*r,!(o-ZD[3]>e.near&&o+ZD[3]<e.far)&&rd(t.frustum,ZD))if(i.radius>100&&i.getChildren())for(const n of i.getChildren())BD(e,t,n,s,r);else eA.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,s,i.bbMin,i.bbMax)}function ND(e,t,i){const s=t.eye,r=t.viewForward,n=(i[0]-s[0])*r[0]+(i[1]-s[1])*r[1]+(i[2]-s[2])*r[2];e.near=Math.min(e.near,n-i[3]),e.far=Math.max(e.far,n+i[3])}function GD(e,t,i){let s=[e,t,i];for(let e=0;e<4;++e){const t=s;s=[];for(let i=0;i<t.length;++i){const r=t[i],n=t[(i+1)%t.length];WD(n,e)?(WD(r,e)||s.push($D(r,n,e)),s.push(n)):WD(r,e)&&s.push($D(r,n,e))}}return s}function WD(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void Kh(!1)}function $D(e,t,i){let s=0;return 0===i?s=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?s=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?s=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(s=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),cl(ul(),e,t,s)}const QD=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],ZD=$a(),YD=Fs(),KD=new pi,XD=new class{constructor(){this._items=new Xl({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll(e=>{const s=e.object.boundingVolumeWorldSpace.bounds,r=(s[0]-t[0])*i[0]+(s[1]-t[1])*i[1]+(s[2]-t[2])*i[2];e.distance=r,e.near=r-s[3],e.far=r+s[3]}),this._items.sort((e,t)=>e.distance-t.distance)}forEachInDepthRange(e,t,i){if(1===t)for(let t=0;t<this._items.length;++t){const s=this._items.data[t];s.far<e.near||s.near>e.far||i(s.object,s.near,s.far)}else for(let t=this._items.length-1;t>=0;--t){const s=this._items.data[t];s.far<e.near||s.near>e.far||i(s.object,s.near,s.far)}}},JD=new class{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new pi(0,0)}compute(e,t,i){this._reset();const{viewMatrix:s}=e;t.forEach(e=>{e.forEachGeometry(e=>{if(!e.visible||0===i&&!e.castShadow)return;const t=e.boundingSphere,r=s[2]*t[0]+s[6]*t[1]+s[10]*t[2]+s[14],n=r-t[3],a=r+t[3];this._geometries.push(e),this._near.push(-a),this._far.push(-n)})});const r=new pi;if(0===this._geometries.length)return r;for(let e=0;e<this._geometries.length;++e)this._near[e]>r.far&&(r.far=this._near[e]),this._near[e]>2&&this._far[e]<r.near&&(r.near=this._far[e]);const n=this._looseRange;n.near=Math.max(.5*r.near,2),n.far=2*r.far;let a=0,o=0;for(let e=0;e<this._geometries.length;++e)this._near[e]<r.near&&(this._near[e]>=n.near?r.near=this._near[e]:this._nearCandidates[a++]=e),this._far[e]>r.far&&(this._far[e]<=n.far?r.far=this._far[e]:this._farCandidates[o++]=e);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return r;this._nearCandidates.sort((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0),this._farCandidates.sort((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0);for(let t=0;t<this._nearCandidates.length;++t){const i=this._nearCandidates[t];if(this._near[i]<r.near){const t=this._geometries[i],{boundingInfo:s,shaderTransformation:n}=t;this._includeNearBoundingInfoRec(e,s,n,r)}}for(let t=0;t<this._farCandidates.length;++t){const i=this._farCandidates[t];if(this._far[i]>r.far){const t=this._geometries[i],{boundingInfo:s,shaderTransformation:n}=t;this._includeFarBoundingInfoRec(e,s,n,r)}}return this._reset(),r}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(e,t){const i=Qa(e),s=Ka(e);return t[0][0]*i[0]+t[0][1]*i[1]+t[0][2]*i[2]+t[0][3]>s||t[1][0]*i[0]+t[1][1]*i[1]+t[1][2]*i[2]+t[1][3]>s||t[2][0]*i[0]+t[2][1]*i[1]+t[2][2]*i[2]+t[2][3]>s||t[3][0]*i[0]+t[3][1]*i[1]+t[3][2]*i[2]+t[3][3]>s}_includeNearBoundingInfoRec(e,t,i,s){if(null==t)return;const r=t.center;es(Qa(ZD),r,i),ZD[3]=t.radius*Fi(i);const{frustum:n}=e;if(this._isOutsideSidePlanes(ZD,n))return;const a=ZD[0],o=ZD[1],l=ZD[2],h=ZD[3],{viewMatrix:c}=e,d=c[2]*a+c[6]*o+c[10]*l+c[14],u=d+h;if(!(-(d-h)<2||-u>=s.near))if(-u>this._looseRange.near)s.near=-u;else{if(h>100){const r=t.getChildren();if(void 0!==r){for(const t of r)this._includeNearBoundingInfoRec(e,t,i,s);return}}eA.unionDepthRangeWithAABB(s,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(e,t,i,s){if(null==t)return;const r=t.center;es(Qa(ZD),r,i),ZD[3]=t.radius*Fi(i);const{frustum:n}=e;if(this._isOutsideSidePlanes(ZD,n))return;const[a,o,l,h]=ZD,{viewMatrix:c}=e,d=c[2]*a+c[6]*o+c[10]*l+c[14]-h;if(!(-d<=s.far))if(-d<this._looseRange.far)s.far=-d;else{if(h>100){const r=t.getChildren();if(void 0!==r){for(const t of r)this._includeFarBoundingInfoRec(e,t,i,s);return}}eA.unionDepthRangeWithAABB(s,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}},eA=new class{constructor(){this._modelViewProj=Fs(),this._clipPosition=[ul(),ul(),ul(),ul(),ul(),ul(),ul(),ul()]}unionDepthRangeWithAABB(e,t,i,s,r){const n=this._modelViewProj;Ps(n,t,i);let a=!1;for(let e=0;e<8;++e){const t=this._clipPosition[e],i=0===e||3===e||4===e||7===e?s[0]:r[0],a=0===e||1===e||4===e||5===e?s[1]:r[1],o=e<4?s[2]:r[2];t[0]=n[0]*i+n[4]*a+n[8]*o+n[12],t[1]=n[1]*i+n[5]*a+n[9]*o+n[13],t[2]=n[2]*i+n[6]*a+n[10]*o+n[14],t[3]=n[3]*i+n[7]*a+n[11]*o+n[15]}for(let t=0;t<12;++t){const i=GD(this._clipPosition[QD[t][0]],this._clipPosition[QD[t][1]],this._clipPosition[QD[t][2]]);let s=!0;for(let e=0;e<i.length;++e)if(i[e][3]>=2){s=!1;break}if(!s){a=!0;for(let t=0;t<i.length;++t){const s=i[t][3];Number.isFinite(s)&&(e.near=Math.min(s,e.near),e.far=Math.max(s,e.far))}}}return a}},tA={idleOpacity:.8,navigatingOpacity:.4,maxDelta:.1,tiltFadeStart:20,tiltFadeEnd:30,altitudeStart:1e4,altitudeEnd:2e4};class iA{constructor(e){this._fbos=e,this._requiresEmission=!1,this._size=new fa(0,0),this._clearColor=ul()}dispose(){this._color=O(this._color),this.releaseDepth()}initialize(e,t,i,s){this._size.width=e,this._size.height=t,Mn(this._size,this._fbos.rctx.parameters.maxTextureSize);const r=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=s,ll(this._clearColor,i),r}releaseDepth(){this._color?.detachDepth(),this._depth=O(this._depth)}update(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}bind(){const{rctx:e}=this._fbos,t=null==this._color;this.color.attachDepth(this.depth),e.bindFramebuffer(this.color.fbo),t&&(e.setClearStencil(0),e.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),e.clear(17664),this._requiresEmission&&e.clearBuffer(1,sp))}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"acquired-color").acquireColor(Qn,8,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"acquired-color")}_acquireDepth(){return this._fbos.acquireDepth(11,this._size.width,this._size.height,"depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??=this._acquireDepth(),this._depth}_ensureColor(){return this._color??=this._acquireColor(),this._color}}function sA(e=!h("disable-feature:high-quality-idle"),t=null){const i=new Rd;return e?(i.set(2,0,"low"!==t),i.set(2,3,"low"!==t),i.set(2,1,!0),i.set(2,4,!0),i.set(2,5,!0),i.set(2,8,!0)):(i.set(0,6,!0),i.set(0,7,!0),i.set(1,6,!0),i.set(1,7,!0)),i.set(2,6,!0),i.set(2,7,!0),i.set(2,2,!0),i}class rA{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){this._inputs.get(e)?.release()&&this._inputs.delete(e)}}const nA=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:255,build:function(e){const t=new mn,{fragment:i}=t;t.include(er),t.include(iO),t.include(Kd),i.uniforms.add(new Xd("shadowMap",e=>e.shadowMap.depthTexture),new Br("depthMap",e=>e.depth?.attachment)),i.constants.add("sampleValue","float",.00392156862745098);const s=1===e.index?"vec2":"float";return t.outputs.add("sampleCount",s),i.main.add(br`
    sampleCount = ${s}(0.0);

    vec3 uvzShadow = calculateUVZShadowFromDepth(uv, textureSize(shadowMap,0), depthMap);
    if (uvzShadow.z < 0.0) {
      return;
    }

    // The shadow map sampler returns a value between 0 and 1, we take the midpoint as we count discrete samples
    bool shadow = readShadowMapUVZ(uvzShadow, shadowMap) > 0.5;

    if (shadow) {
      sampleCount = ${s}(sampleValue); // Add 1 to the sample count
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class aA extends xr{constructor(e){super(),this._data=e,this.sampleScale=Gs(),this.opacityFromElevation=1,this.gradientColor=_l(lA),this.thresholdColor=_l(hA),this.bandedGradientColor=_l(cA),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}}const oA=50/255,lA=pl(0,0,1,.7),hA=pl(1,0,0,.7),cA=pl(oA,oA,oA,.7),dA=ul(),uA=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:aA,build:function(e){const t=new mn,i=t.fragment;t.include(ar),t.include(er);const{visualization:s}=e;i.constants.add("inverseSampleValue","float",255),i.uniforms.add(new hr("shadowCastMap",e=>e.shadowCastMap),new tr("sampleScale",e=>e.sampleScale),new lr("opacityFromElevation",e=>e.opacityFromElevation));const r=2===s,n=3===s,a=1===s;switch(n&&i.include(Xu),s){case 0:i.uniforms.add(new Qr("uColor",e=>Ju(dA,e.gradientColor)));break;case 1:i.uniforms.add(new Qr("uColor",e=>Ju(dA,e.bandedGradientColor)),new lr("bandSize",e=>e.bandSize));break;case 3:i.uniforms.add(new Qr("uColor",e=>Ju(dA,e.thresholdColor)),new Qr("gradientColor",e=>Ju(dA,e.gradientColor)),new lr("threshold",e=>e.threshold));break;case 2:i.uniforms.add(new Qr("uColor",e=>Ju(dA,e.thresholdColor)),new lr("threshold",e=>e.threshold))}const{type:o,selector:l,thresholdStrengthSelector:h}=n?{type:"vec2",selector:"rg",thresholdStrengthSelector:"strength.x"}:{type:"float",selector:"r",thresholdStrengthSelector:"strength"};return i.main.add(br`
    ${o} numSamples = texture(shadowCastMap, uv).${l} * inverseSampleValue;

    fragColor = vec4(0.0);

    // early out if we do not have any samples in one or more channels
    if (dot(numSamples, ${o}(1)) < 1.0) {
      return;
    }

    // sampleScale is the number of total samples taken, so this brings strength to a 0-1 range.
    // note that sampleScale is always a vec2 even if we have only the primary channel.
    ${o} strength = numSamples * sampleScale.${l};

    // in threshold mode, step the strength to 0 if we are at or below the threshold, 1 otherwise.
    ${wr(r||n,br`
      ${h} = 1.0 - step(${h}, threshold);
    `)}

    // bail out if we are below the threshold
    ${wr(r,br`if (${h} == 0.0) { return; }`)}

    ${wr(a,br`strength = ceil(strength / bandSize) * bandSize;`)}

    ${o} attenuation = opacityFromElevation * strength;

    // in ThresholdAndGradient mode we blend the threshold color on top of the gradient color
    fragColor = ${wr(n,br`blendColorsPremultiplied(uColor * attenuation.r, gradientColor * attenuation.g)`,br`uColor * attenuation`)};
  `),t}},Symbol.toStringTag,{value:"Module"}));class pA extends Tr{constructor(e,t){super(e,t,new Sr(uA,()=>Promise.resolve().then(()=>uA)),ir),this.primitiveType=Un.TRIANGLE_STRIP}initializePipeline(){return gn({blending:bn,colorWrite:_n,depthTest:null,depthWrite:null})}}class mA extends Mr{constructor(){super(...arguments),this.visualization=0}}e([Pr({count:4})],mA.prototype,"visualization",void 0);const gA=1/512;let _A=class extends Oe{constructor(e,t,i,s){super({}),this._techniques=e,this._rctx=t,this._data=i,this._requestRender=s,this._passParameters=new aA(this._data),this._configuration=new mA,this._enabled=!1,this._vao=VT(t)}dispose(){this._stop(),this._vao=M(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile(pA,this._configuration)}render(e){if(!this._showVisualization)return;const[t,i]=this._data.computedSamples;this._passParameters.sampleScale=[t?1/t:0,i?1/i:0];const s=this._techniques.get(pA,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(s,e,this._passParameters),this._rctx.drawArrays(s.primitiveType,0,this._vao.vertexCount("geometry"))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.thresholdColor&&this._setThresholdColor(e.thresholdColor),void 0!==e.gradientColor&&this._setGradientColor(e.gradientColor),void 0!==e.bandedGradientColor&&this._setBandedGradientColor(e.bandedGradientColor),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&(this._data.computedSamples[0]>0||this._data.computedSamples[1]>0)&&this.opacityFromElevation>gA}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(e){e!==this._visualization&&(this._configuration.visualization=e,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfEnabled())}_setThresholdColor(e){const t=this._passParameters.thresholdColor;dl(e,t)||(ll(this._passParameters.thresholdColor,e),this._requestRenderIfEnabled())}_setGradientColor(e){const t=this._passParameters.gradientColor;dl(e,t)||(ll(this._passParameters.gradientColor,e),this._requestRenderIfEnabled())}_setBandedGradientColor(e){const t=this._passParameters.bandedGradientColor;dl(e,t)||(ll(this._passParameters.bandedGradientColor,e),this._requestRenderIfEnabled())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};e([Ce()],_A.prototype,"opacityFromElevation",null),_A=e([Se("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],_A);class fA extends Tr{constructor(e,t){super(e,t,new Sr(nA,()=>Promise.resolve().then(()=>nA)),ir),this.primitiveType=Un.TRIANGLE_STRIP}initializePipeline(e){const t={r:0===e.index,g:1===e.index,b:!1,a:!1};return gn({blending:Sn,colorWrite:t,depthTest:null,depthWrite:null})}}class yA extends Mr{constructor(e){super(),this.index=0,this.index=e}}e([Pr({count:2})],yA.prototype,"index",void 0);const vA=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new mn,{fragment:i}=t;t.include(er);const s=1===e.index?"vec2":"float",r="value";return t.outputs.add(r,s),i.main.add(br`${r} = ${s}(0.0);`),t}},Symbol.toStringTag,{value:"Module"}));class bA extends Tr{constructor(e,t){super(e,t,new Sr(vA,()=>Promise.resolve().then(()=>vA)),ir),this.primitiveType=Un.TRIANGLE_STRIP}initializePipeline(e){const t={r:0===e.index,g:1===e.index,b:!1,a:!1};return gn({blending:null,colorWrite:t,depthTest:null,depthWrite:null})}}let wA=class extends Oe{updateDepthRange(e){this._depthRange.equals(e)||(this._depthRange=e)}constructor(e,t,i,s,r,n){super({}),this.fbos=e,this._techniques=t,this._stage=i,this._prepareForShadowMapPass=s,this._renderToShadowMap=r,this._requestRender=n,this._primarySet=new TA(new yA(0),()=>this._requestRenderIfEnabled()),this._contextSet=new TA(new yA(1),()=>this._requestRenderIfEnabled()),this._passParameters=new Ed,this._depthRange=pi.zero,this._previewing=!1,this._shadowAccumulatorKey=Symbol("shadowAccumulator"),this._rctx=e.rctx,this._bindParameters=new da(new ya(e,i.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=VT(this._rctx),this._accumulationRenderer=new _A(t,this._rctx,this,n);const a=this._stage.view.resourceController.scheduler;this.addHandles([a.registerTask(kn.SHADOW_ACCUMULATOR,this),B(()=>this._previewing,()=>this._requestRenderIfEnabled(),W),B(()=>2===this._numActive,()=>this._numActiveChanged(),W),B(()=>this._depthRange,()=>this._invalidateAccumulationSets(),W)],this._shadowAccumulatorKey);for(const e of this._accumulationSets())e.precompile(t)}*_accumulationSets(){yield this._primarySet,yield this._contextSet}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=M(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=M(this._fbo),this._vao=M(this._vao);for(const e of this._accumulationSets())e.destroy();this._contextSet=null,this._primarySet=null,this._bindParameters.destroy()}get computedSamples(){return[this._primarySet.progress,this._contextSet.progress]}get shadowCastTexture(){return this._fbo?.colorTexture}get accumulating(){return this.active&&this._previewing||this._refining}get _refining(){return this.active&&!this._doneAccumulating&&!this._previewing}get active(){return null!=this._fbo&&[...this._accumulationSets()].some(e=>e.active)}get canAccumulate(){return null!=this._bindParameters.depth&&this._depthRange!==pi.zero&&this._opacityFromElevation>gA}get _doneAccumulating(){return[...this._accumulationSets()].every(e=>e.doneAccumulating)}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get _numActive(){return[...this._accumulationSets()].reduce((e,t)=>e+(t.active?1:0),0)}get _pixelFormat(){return 2===this._numActive?{pixelFormat:33319,internalFormat:Zn.RG8}:{pixelFormat:6403,internalFormat:Zn.R8}}get readyToRun(){return this._refining&&this.canAccumulate&&[...this._accumulationSets()].some(e=>e.running)}runTask(e){this._clearBuffersOnAccumulationStart(),this._prepareForShadowMapPass(this._bindParameters);let t=!1;for(const i of this._accumulationSets())this._runTaskForSet(i,e)&&(t=!0);t&&this._requestRender()}_runTaskForSet(e,t){let i=!1;for(;!t.done&&!e.doneAccumulating;)this._accumulateShadow(e),t.madeProgress(),i=!0;return i}renderAccumulation(e,t,i,s){return this._updateCamera(t),this._bindParameters.contentCamera=i,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!(!this.accumulating||!this.canAccumulate)&&(this._previewing||s?(this._clearFramebuffer(),this._reset()):this._clearBuffersOnAccumulationStart(),this._accumulateSetsForRenderFrame(s))}_clearBuffersOnAccumulationStart(){if([...this._accumulationSets()].every(e=>0===e.progress))this._clearFramebuffer();else for(const e of this._accumulationSets())0===e.progress&&this._clearFramebufferForSet(this._fbo,e)}_accumulateSetsForRenderFrame(e){let t=!1;for(const i of this._accumulationSets())this._accumulateSetForRenderFrame(i,e)&&(t=!0);return t&&this._requestRender(),t}_accumulateSetForRenderFrame(e,t){let i=t?e.sampleCount:Math.min(xA,e.sampleCount);i-=e.progress;for(let t=0;t<i;++t)this._accumulateShadow(e);return i>0}precompile(){this._accumulationRenderer.precompile()}render(e){this._accumulationRenderer.render(e)}setOptions(e){void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._primarySet.lightDirections=e.lightDirections),void 0!==e.lightDirectionsContext&&(this._contextSet.lightDirections=e.lightDirectionsContext),!0===e.enabled?this._enable():!1===e.enabled&&this._disable(),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){const i=this._primarySet.progress;return!this.active||!this._fbo||i<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,6408,Nn.UNSIGNED_BYTE,CA),CA[0]/i)}_numActiveChanged(){if(!this._fbo)return;const e=2===this._numActive,t=this._createFBO();t.resize(this._fbo.width,this._fbo.height),e&&(this._clearFramebuffer(t),this._contextSet.reset()),this._fbo.width&&this._fbo.height&&this._rctx.blitFramebuffer(this._fbo,t),this._fbo.dispose(),this._fbo=t,this._requestRender()}_enable(){this._fbo||(this._fbo=this._createFBO(),this._invalidateAccumulationSets())}_createFBO(){const{pixelFormat:e,internalFormat:t}=this._pixelFormat,i=new On;return i.pixelFormat=e,i.internalFormat=t,i.wrapMode=33071,new Pn(this._rctx,i)}_invalidateAccumulationSets(){for(const e of this._accumulationSets())e.reset();this._requestRenderIfEnabled()}_disable(){this._fbo&&(this._fbo=M(this._fbo),this._requestRender())}_reset(){for(const e of this._accumulationSets())e.reset()}_clearFramebuffer(e=this._fbo){e&&e.width&&e.height&&(this._rctx.bindFramebuffer(e),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(16384))}_clearFramebufferForSet(e,t){if(!e)return;const i=this._techniques.get(bA,t.configuration);this._rctx.bindFramebuffer(e),this._rctx.bindTechnique(i,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,this._vao.vertexCount("geometry"))}_accumulateShadow(e){this._renderToShadowMap(this._bindParameters,e.lightDirections[e.progress++],this._depthRange);const t=this._techniques.get(fA,e.configuration);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(t,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,this._vao.vertexCount("geometry"))}_updateCamera(e){const t=this._fbo;if(null==t)return;const i=this._bindParameters.camera;e.equals(i)||i.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-Ai(4e4,5e4,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};e([Ce()],wA.prototype,"_fbo",void 0),e([Ce()],wA.prototype,"_depthRange",void 0),e([Ce()],wA.prototype,"_previewing",void 0),e([Ce()],wA.prototype,"_accumulationRenderer",void 0),e([Ce()],wA.prototype,"_refining",null),e([Ce()],wA.prototype,"active",null),e([Ce()],wA.prototype,"canAccumulate",null),e([Ce()],wA.prototype,"_doneAccumulating",null),e([Ce()],wA.prototype,"_opacityFromElevation",null),e([Ce()],wA.prototype,"_numActive",null),e([Ce()],wA.prototype,"_pixelFormat",null),e([Ce()],wA.prototype,"readyToRun",null),wA=e([Se("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],wA);const xA=6,CA=new Uint8Array(4);class TA{constructor(e,t){this.configuration=e,this._notifyChange=t,this._cachedLightDirections=[],this._progress=ds(0),this._sampleCount=ds(0)}get progress(){return this._progress.value}set progress(e){this._progress.value=e}get sampleCount(){return this._sampleCount.value}get doneAccumulating(){return this.progress>=this.sampleCount}get running(){return this.progress>0}get active(){return this.sampleCount>0}get lightDirections(){return this._cachedLightDirections}set lightDirections(e){const t=this._cachedLightDirections,i=Math.min(255,e.length);if(!w(t,0,t.length,e,0,i,Qi)){t.length=i,this._sampleCount.value=i;for(let s=0;s<i;++s)t[s]=Zi(t[s]??ke(),e[s]);this.reset(),this._notifyChange()}}destroy(){this._cachedLightDirections.length=0,this._sampleCount.value=0}reset(){this.progress=0}precompile(e){e.precompile(fA,this.configuration),e.precompile(bA,this.configuration)}}const SA=Gl();class PA{constructor(){this._plane=Gl(),this._isDecoration=!0}get plane(){return this._plane}get isDecoration(){return this._isDecoration}update({plane:e,isDecoration:t}){let i=!1;return this._isDecoration!==t&&(this._isDecoration=t,i=!0),e??=SA,Zl(e,this._plane)?i:(Wl(e,this._plane),!0)}}class MA{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach(e=>{const t=this._timer.createQuery(),i=this._timer.createQuery();this._queryPool.push(t,i),this._queryResults.set(e,null)})}start(){op||(this._currentQuery=this._queryPool.pop(),null!=this._currentQuery&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||null==this._currentQuery||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(null==t)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){null!=this._currentQuery&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){null!=this._currentQuery&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{null!=e&&this._timer.deleteQuery(e)})}}const RA={OVERLAY:"overlay",PREPARE:"prepare",SHADOW_MAP:"shadow map",DEPTH:"depth",ACCUMULATED_SHADOWS:"accumulated shadows",APPLY_ACCUMULATED_SHADOWS:"apply accumulated shadows",OBJECT_AND_LAYER_ID_COLOR:"object/layer id color",NORMALS:"normals",SSAO:"SSAO",HIGHLIGHTS:"highlights",OPAQUE_EDGES:"opaque edges",VOXEL:"voxel",TRANSPARENT:"transparent",TRANSPARENT_EDGES:"transparent edges",HUD_VISIBILITY:"HUD visibility",TRANSPARENT_TERRAIN:"transparent terrain",TRANSPARENT_MATERIAL_WITHOUT_DEPTH:"transparent material without depth",OPAQUE_ENVIRONMENT:"opaque environment",TRANSPARENT_ENVIRONMENT:"transparent environment",OCCLUDED:"occluded",HUD:"HUD",HUD_OCCLUDED:"HUD occluded",FINISH:"finish",FOCUS_AREA_MASK:"focus area mask"},OA=Object.values(ui).concat(Object.values(ii)).concat(Object.values(RA)),DA="Total";class AA{constructor(e){this._rctx=e,this._startTimeStampCPU=X(0),this._lastTimeStampCPU=X(0),this._totalCPUTime=new te(DA),this._cpuTimeSamplers=new Map(OA.map(e=>[e,new te(e)])),this._enableGPUTimer=0,this._totalGPUTime=new te("GPU"),this._gpuTimeSamplers=new Map(OA.map(e=>[e,new te(e)])),this._totalTime=X(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return null!=this._gpuTimerPool}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return X(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(null==this._gpuTimerPool){const e=[...OA,DA];this._gpuTimerPool=function(e,t){const i=e.capabilities.disjointTimerQuery;return null==i?null:new MA(i,t)}(this._rctx,e)}if(null==this._gpuTimerPool)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,0===this._enableGPUTimer&&(this._gpuTimerPool=M(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=X(performance.now()),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach(e=>e.push(0)),this._gpuTimerPool.start())}advance(e){const t=X(performance.now());if(this._cpuTimeSamplers.get(e).push(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const t=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).set(t),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const e=this._gpuTimerPool.stop(RA.FINISH);this._gpuTimeSamplers.get(RA.FINISH).set(e),this._rctx.gl.flush()}const e=X(performance.now()-this._startTimeStampCPU);this._totalTime=X(this._totalTime+e),this._totalCPUTime.push(e),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce((e,t)=>e+(t.last||0),0)),++this._totalFrameCount}}let EA=class extends nx{constructor(e,t,i,s,r,n){super({stage:e}),this._techniques=i,this._rctx=s,this._compositingHelper=r,this._requestRender=n,this._pluginsHas={hudElements:!1,water:!1},this.renderPassManager=new bD,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=pl(0,0,0,1),this._sliceHelper=new PA,this._blit=null,this._oitblend=null,this.sceneDepthRange=ds(pi.infinite),this._state=ds(2),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new ID,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=ds(0),this._lastFrameTime=X(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new rA,this._releaseNormals=e=>{e.some(({name:e})=>"normals"===e)&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this._fboCache=new oD(s),this._renderStateFeatures=ds(sA(!h("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new iA(this.fboCache),this._performanceInfo=new AA(this._rctx),this._shadowMap=new ya(this.fboCache,e.viewingMode),this._shadowAccumulator=new wA(this.fboCache,i,e,e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=t},(t,i,s)=>{const r=e.view.qualitySettings.maximumPixelRatio;t.shadowMap.start(t.camera,i,s,!0,r),this._renderShadowCascades(4,t.shadowMap),t.shadowMap.finish(),t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.contentCamera)},n),this._renderContext=new va(this._rctx,this._shadowMap,i),this._nodes=new TD(this._renderContext),this._plugins=new SD({renderContext:this._renderContext,techniques:i,materials:t,requestRender:n,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this._plugins.add(this.renderPassManager),this.addHandles([B(()=>e.view.state.camera,()=>n(),G),B(()=>Jl.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(0):()=>{},n()},N),B(()=>e.view.environment.background?.color,e=>{const t=e?zu(e):ml;rl(this._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),n()},G),B(()=>e.view.state.camera.relativeElevation,e=>this._inGlobeView=(e??1/0)>=eu,G),B(()=>this._bindParameters.clouds.fadeFactor,()=>this._bindParameters.fadeLighting(),W),B(()=>this._bindParameters.clouds.data?.state,()=>n(),W),B(()=>e.view.state.highlights,e=>{this._bindParameters.highlights=e,n()},N)])}destroy(){this._gpuTimerHandle=T(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._shadowAccumulator=null,this._loadEdgeViewTask=P(this._loadEdgeViewTask),this._edgeView=S(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this._fboCache.destroy(),this._fboCache=null,this._plugins.destroy(),this._plugins=null,this._pluginInput=null,this._blit=null,this._oitblend=null,this._compositingHelper=null,this._nodes=null,this._framebuffer=null,this._shadowMap=null,this._renderContext=null,this._performanceInfo=null,pn.prune(),rx.prune(),ea()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}get performanceInfo(){return this._performanceInfo}updateRenderFeatures(e=null,t=!h("disable-feature:high-quality-idle")){this._renderStateFeatures.value=sA(t,e),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,i){this._renderStateFeatures.mutate(s=>s.set(t,e,i)),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(1)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(5))}get _hasHighlights(){return this._plugins.produces(8,2,4,18,13,14)}hasHighlight(e){return this._plugins.hasHighlight(e)}get _hasHUDHighlights(){return this._plugins.produces(8,13,14)}get hasSSAO(){return(this.stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(4))&&!this._inGlobeView}get hasSMAA(){return this.stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(0)}get fullResolutionAtmosphere(){return this.stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(3)}get fboCache(){return this._fboCache}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=O(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=O(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=O(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=O(this._bindParameters.depth),this._bindParameters.hudVisibility=O(this._bindParameters.hudVisibility)}get updating(){return this._loadEdgeViewTask&&!this._loadEdgeViewTask.finished||this._edgeView?.updating||this._shadowAccumulator.readyToRun||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=Jt(async e=>{const{EdgeView:t}=await import("../chunks/EdgeView.js");V(e);const i=this._edgeView=new t({rctx:this._rctx,renderSR:this.stage.view.renderSpatialReference,viewingMode:this.stage.view.stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:(s=this.stage.view.resourceController,e=>s.immediate.schedule(e))});var s;return this.addHandles(B(()=>i.updating,()=>this._requestRender(),W)),this._requestRender(),this._edgeViewCallbacks.forEach(e=>e(i)),this._edgeViewCallbacks.length=0,i})),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),null==this._edgeView?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&Vs(this._bindParameters.ssr.reprojectionMatrix,js)}set _reprojectionMatrix(e){x(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:t,_bindParameters:i}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){if(null!=e.environment.weather){const t=e.environment.weather;this._bindParameters.weather=t,this._bindParameters.snowCover=!!e.weatherVisible&&null!=t&&"snowy"===t.type&&"enabled"===t.snowCover}const t="virtual"!==e.environment.lighting.type;i.enableFillLights!==t&&(i.enableFillLights=t,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.shadowCast&&this._shadowAccumulator.setOptions(e.shadowCast)}set slice(e){this._sliceHelper.update(e)&&this._requestRender()}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}commit(e,t){return this._isRendering&&console.warn("Renderer.modify called while rendering"),!!super.commit(e,t,this._plugins.context)&&(this.updateHasFlags(),!0)}rendererAdded(e){this._plugins.add(e)}rendererRemoved(e){this._plugins.remove(e)}get occludedRequiresStencil(){return this.occludedRequiresOccludeeStencil||this.occludedRequiresIntegratedMeshStencil}get occludedRequiresOccludeeStencil(){return this._bindParameters.hasOccludees&&!!(8&this.plugins.renderOccludedFlags)}get occludedRequiresIntegratedMeshStencil(){return this._plugins.produces(0,0)&&this._plugins.produces(0,9)}updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(0,...jA),e.water=this._plugins.produces(3,19),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,t){this._animationTimer??=new ED(e.camera,t),this._animationTimer.advance(e.camera,t,this._animationTimeDilation);const i=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==i&&(this._gpuTimerHandle=i?T(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,i,s=!1){try{return this._isRendering=!0,this._render(e,t,i,s)}catch(e){console.error(`Exception during rendering: ${e}`)}finally{this._isRendering=!1}return new cx(this._pluginInput.get(ui.FINAL),null)}_updateHUDOccludedFragmentOpacity(e,t){const{idleOpacity:i,navigatingOpacity:s,maxDelta:r,tiltFadeStart:n,tiltFadeEnd:a,altitudeStart:o,altitudeEnd:l}=tA,h=this.stage.view,c=h.stateManager.camera,d=h.qualitySettings.fadeDuration,u=2===e?i:s,p=Ci((c.tilt-n)/(a-n),0,1),m=Ci(((c.position.z??0)-o)/(l-o),0,1),g=Pi(Pi(1,u,p),1,m),_=this._bindParameters.hudOccludedFragmentOpacity;if(d<=0||_===g||0===this._lastFrameTime||this._lastFrameTime>t)return this._bindParameters.hudOccludedFragmentOpacity=g,void(this._lastFrameTime=t);const f=t-this._lastFrameTime;this._lastFrameTime=t;const y=Math.max(1-i,Math.abs(i-s)),v=Math.min(y*f/d,r);v>=Math.abs(g-_)?this._bindParameters.hudOccludedFragmentOpacity=g:(this._bindParameters.hudOccludedFragmentOpacity=_+Math.sign(g-_)*v,this._requestRender())}_render(e,t,i,s){const r=0===i;this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=r,this._disposeBindBuffers();const{camera:n,contentCamera:a,mode:o,alignPixelEnabled:l}=e;this._state.value=o;const h=this._nodes.produces("magnifier-color"),c=this._nodes.produces(ui.FINAL),d=this._nodes.require("emissive",ii.TRANSPARENT_ENVIRONMENT,ui.COMPOSITE,ui.FINAL)>0&&this._plugins.hasEmissions,u=d?1:0;this._renderContext.time=t,this._renderContext.output=u,this._bindParameters.oitPass=0,this._bindParameters.alignPixelEnabled=l,this._bindParameters.decorations=!s,this._bindParameters.mainDepth=null;const p=!s||!this._sliceHelper.isDecoration;this._bindParameters.slicePlane=p?this._sliceHelper.plane:null,this._bindParameters.viewshedEnabled=this._nodes.produces(ii.VIEWSHED),this._renderOverlay(),n.setGLViewport(this._rctx);const m=this._framebuffer,g=m.initialize(n.fullWidth,n.fullHeight,this._backgroundColor,d);this.hasReflections?(g?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=g):g?.release(),this._ensureBindParametersCamera(n,a),this._updateHUDOccludedFragmentOpacity(o,t),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!s;const _=this._highQualityTransparency&&this._hasTransparentTerrain,f=this._plugins.produces(0,...VA);this._precompilePrepasses(),this.performanceInfo.advance(RA.PREPARE);const y=this._computeShadowDepthRange(n);this._renderShadowMap(n,this._bindParameters.lighting.mainLight.direction,y),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(y,n,a,!r),this._ensureBindParametersSSR(t),this._precompileShaders(_,f,u),this._renderContext.output=u,m.bind(),this._bindParameters.mainDepth=m.depth.attachment,this._renderOpaque(_),this._renderTransparent(f,_,u),this._shadowMap.disposeMainBuffer(),this._pluginInput.set(ii.FOCUSAREA,this._renderFocusAreaGeometry()),m.update(e=>this._renderNodes(ii.TRANSPARENT_ENVIRONMENT,e)),m.update(e=>this._renderNodes(ii.VIEWSHED,e)),m.update(e=>this._renderNodes(ii.LASERLINES,e)),m.update(e=>this._renderNodes(ii.FOCUSAREA_COLOR,e)),this._pluginInput.release(ii.FOCUSAREA),m.update(e=>this._renderNodes(ii.OCCLUDED,e)),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._renderHighlightShadowMap(n,this._bindParameters.lighting.mainLight.direction,y);const v=2===i?this._renderObjectAndLayerIdColor():null;m.update(e=>this._renderNodes(ui.COMPOSITE,e)),this._shadowMap.disposeOffscreenBuffers();const b=r&&!c&&!(h&&!s),w=this._pluginInput.get(ui.COMPOSITE),x=b?cD:this.fboCache.acquire(w.fbo.width,w.fbo.height,ii.ANTIALIASING),C=this._nodes.produces(ii.ANTIALIASING)?this._renderNodes(ii.ANTIALIASING,x):this._blitFBO(w,x,!1);let T;this._pluginInput.set(ii.ANTIALIASING,C),this._hasHUDHighlights?(this._renderHUD(1,C,u),T=this._renderNodes(ii.HIGHLIGHTS,C)):(T=this._renderNodes(ii.HIGHLIGHTS,C),this._renderHUD(1,T,u));const S=this._renderNodes(ii.MAGNIFIER,T);return r&&h&&!s&&!c&&this._blitFBO(S),c?(S.attachDepth(m.depth),this._blitFBO(this._renderNodes(ui.FINAL,S)),S.detachDepth()):this._pluginInput.set(ui.FINAL,S),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),m.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),r||(this._releaseFBOs(),this._disposeOffscreenBuffers()),new cx(this._pluginInput.get(ui.FINAL),v)}_precompileShaders(e,t,i){++this._plugins.context.techniques.precompiling,this._renderContext.output=i,this._precompileOpaqueGeometry(),this._nodes.precompile(ii.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,this._renderContext.output=2,this._plugins.precompile(6),this._plugins.precompile(7),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=i,this._plugins.precompile(6),this._plugins.precompile(7),t&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=e)),this._nodes.precompile(ii.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(12),this._plugins.precompile(15),this._precompileHUD(0),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(ii.VIEWSHED,ii.LASERLINES,ii.FOCUSAREA_COLOR,ii.OCCLUDED,ii.ANTIALIASING,ii.HIGHLIGHTS);const s=this._bindParameters;s.highlightMixTexture=s.highlights.length>1?this._rctx.emptyTexture:null,this._precompileHUD(1),this._hasHighlights&&(s.highlights.forEach((e,t)=>{s.highlightLevel=t,this._precompileAllGeometry(8)}),s.highlightLevel=null),s.highlightMixTexture=null,this._nodes.precompile(ui.COMPOSITE,ii.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(8),--this._plugins.context.techniques.precompiling}_renderFocusAreaGeometry(){const e=this._nodes.produce(ii.FOCUSAREA,this._pluginInput);return e&&this.performanceInfo.advance(RA.FOCUS_AREA_MASK),e}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;const e=this._renderContext.output;++this._techniques.precompiling;const t=this._framebufferSize;let i=this.fboCache.acquire(t.width,t.height,"olid");return i.acquireDepth(11),i=this._nodes.render(i,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(RA.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=e,i}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,i=0===e;if(i||t){const e=i?this.performanceInfo.elapsedTime:0;let s=0;t?s=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const r=Math.max(e,s);this._animationTimestep.frame(r,i)}}readMainDepth(e,t){const{mainDepth:i,camera:s}=this._bindParameters;if(!i)return;const r=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(r.fbo),s.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(ml),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,i),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),r.fbo?.readPixels(e[0],e[1],e[2],e[3],6408,Nn.UNSIGNED_BYTE,t),r.release()}readHUDVisibility(e,t,i,s,r){this._bindParameters.hudVisibility?.fbo?.readPixels(e,t,i,s,6408,Nn.UNSIGNED_BYTE,r)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_renderEdges(e){const t=this._edgeView;if(!t?.shouldRender())return;const i=this._framebufferSize,s=this.fboCache.acquire(i.width,i.height,"edges"),r=this._bindParameters.geometryDepth;this.renderToTargets(()=>t.render(this._bindParameters,e),s,r??this._framebuffer.depth,ml),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,s.getTexture()),s.release(),this.performanceInfo.advance(1===e?RA.OPAQUE_EDGES:RA.TRANSPARENT_EDGES)}_renderOverlay(){this._bindParameters.overlay=this.overlay?.render(),this._bindParameters.overlay&&this.performanceInfo.advance(RA.OVERLAY)}_renderShadowMap(e,t,i){if(!this.shadowsEnabled)return;const{contentCamera:s}=this._bindParameters,r=this._shadowMap;r.start(e,t,i,this.isFeatureEnabled(6),this.stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(6,this._shadowMap),r.copySnapshot(1),this._renderShadowCascades(5,this._shadowMap)):this._renderShadowCascades(4),r.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,s),this.performanceInfo.advance(RA.SHADOW_MAP)}_renderHighlightShadowMap(e,t,i){if(!this.shadowsEnabled||!this._needsShadowHighlight)return;const{contentCamera:s}=this._bindParameters,r=this._shadowMap;r.start(e,t,i,this.isFeatureEnabled(6),this.stage.view.qualitySettings.maximumPixelRatio),this._renderShadowCascades(5,this._shadowMap),r.moveSnapshot(0),r.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,s),this.performanceInfo.advance(RA.SHADOW_MAP)}_precompileShadowCascades(e){for(const t of this._shadowMap.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e,t=this._shadowMap){t.bindFbo();for(const i of t.cascades)i.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(i.camera,i.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(2)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._shadowAccumulator.active||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const e=this._pluginInput.get("normals");e?(this._pluginInput.set(ii.SSAO,this._renderSSAO()),this._needsDepth?(this._rctx.bindFramebuffer(e.fbo),this._rctx.clear(1024),this._renderGeometryWithoutNormals(2),O(this._bindParameters.depth),this._bindParameters.depth=e.obtainDepthTexture(),this.performanceInfo.advance(RA.DEPTH)):(e.detachDepth(),this._bindParameters.depth=O(this._bindParameters.depth)),this.hasSSAO&&this._pluginInput.release("normals")):this._renderAllGeometryDepth()}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=O(this._bindParameters.depth));const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"depth",11);this._rctx.bindFramebuffer(t.fbo),this._rctx.clear(1280),this.renderAllGeometry(2),O(this._bindParameters.depth),this._bindParameters.depth=t.obtainDepthTexture(),t.release(),this.performanceInfo.advance(RA.DEPTH)}_renderTerrainDepth(e){if(this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,!e)return void(this._bindParameters.terrainDepth=O(this._bindParameters.terrainDepth));const t=this._renderContext.output;this._renderContext.output=2;const i=this._framebufferSize,s=this.fboCache.acquire(i.width,i.height,"terrain depth",11);this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(1280),this._renderTransparentTerrain(),O(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=s.obtainDepthTexture(),this._renderContext.output=t,s.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=O(this._bindParameters.geometryDepth));const t=this._renderContext.output,{width:i,height:s}=this._framebufferSize,r=this.fboCache.acquire(i,s,"geometry depth",11);this._rctx.bindFramebuffer(r.fbo),this._rctx.clear(1280),this._renderOpaqueAndTransparentGeometry(2),this._renderContext.output=t,O(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=r.obtainDepthTexture(),r.release()}get _needsShadowDepthRange(){return this._shadowMap.enabled||this._shadowAccumulator.active}_computeShadowDepthRange(e){if(!this._needsShadowDepthRange)return pi.zero;const t=qD(e,this._plugins.plugins,this.stage.layers,0);return t.union(this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}updateSceneDepthRange(e){if(!this.stage.view.state.isGlobal)return void(this.sceneDepthRange.value=pi.infinite);if((this.stage.view.renderCoordsHelper?.getAltitude(e.eye)??0)<vi)return void(this.sceneDepthRange.value=pi.infinite);const t=e.clone();t.near=bi,t.far=1e10;const i=qD(t,this._plugins.plugins,this.stage.layers,1);i.union(this._plugins.queryDepthRange(t)),this.sceneDepthRange.value.far===i.far&&this.sceneDepthRange.value.near===i.near||(this.sceneDepthRange.value=i)}get _normalsRequired(){const e=this._nodes.require("normals",ui.FINAL,ui.COMPOSITE,ui.OPAQUE,ui.TRANSPARENT,ii.VIEWSHED,ii.LASERLINES);return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(3),this._needsDepth&&this._precompileAllGeometry(2),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(5),this._precompileShadowCascades(6),this._precompileShadowCascades(5)):this._precompileShadowCascades(4)),this._shadowAccumulator.active&&this._precompileAllGeometry(4)}_renderNormals(){const e=this._normalsRequired;if(0===e)return;const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"normals",5);i.acquireDepth(11),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer(ml,!0,!0),this._renderGeometryWithNormals(3);const s=this._nodes.optional("normals",ui.FINAL,ui.COMPOSITE,ui.OPAQUE,ui.TRANSPARENT,ii.VIEWSHED);return i.retain(e+s-1),this.performanceInfo.advance(RA.NORMALS),i}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return;const t=this._nodes.produce(ii.SSAO,this._pluginInput);return this._bindParameters.ssao=t,t&&this.performanceInfo.advance(RA.SSAO),t}_precompileAllGeometry(e){const t=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(6),this._plugins.precompile(7),this._renderContext.output=t}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e,...t){for(const i of t)this._bindParameters.slot=i,e.precompile(this._renderContext)}precompileOccludedSlots(e,t){for(const i of t)this._renderContext.renderOccludedMask=i,this.precompileSlots(e,...FA);this._renderContext.renderOccludedMask=ba}renderSlots(e,...t){for(const i of t)this._bindParameters.slot=i,e.forAll(e=>{const t=e.acquireTechniques(this._renderContext);t&&e.render(this._renderContext,t)})}renderOccludedSlots(e,t){this._renderContext.renderOccludedMask=t,this.plugins.renderOccludedFlags>1&&this._plugins.render(9),this.renderSlots(e,...FA),this._renderContext.renderOccludedMask=ba}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(13)}precompileViewshedShadowMap(){this._precompileAllGeometry(7)}renderViewshedShadowMap(e){const{camera:t,contentCamera:i}=this._bindParameters,s=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(7),this._ensureBindParametersCamera(t,i),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=s}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(...IA),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(...LA)}_precompileOpaqueGeometry(){this._plugins.precompile(...kA)}_renderOpaqueGeometry(){this._plugins.render(...kA)}_renderTransparentGeometry(){this._plugins.render(...VA)}get _hasTransparentTerrain(){return this._plugins.produces(0,6)}get _hasTransparentIntegratedMesh(){return this._plugins.produces(this._renderContext.output,7)}_renderTransparentTerrain(){const e=()=>this._plugins.render(6);if(!dr(this._renderContext.output))return void e();const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"transparent terrain");return this.renderToTargets(e,i,this._framebuffer.depth,ml),i}_renderTransparentIntegratedMesh(){const e=()=>this._plugins.render(7);if(!dr(this._renderContext.output))return void e();const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"transparent integrated mesh");return this.renderToTargets(e,i,this._framebuffer.depth,ml),i}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,12)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=O(this._bindParameters.hudVisibility));const{width:e,height:t}=this._framebufferSize;let i=this._bindParameters.hudVisibility;i?.fbo?.width===e&&i?.fbo?.height===t||(i?.release(),i=this.fboCache.acquire(e,t,"hud visibility",4),this._bindParameters.hudVisibility=i);const s=this._bindParameters.geometryDepth;i.attachDepth(s||this._framebuffer.depth),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(12),i.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(RA.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,0===e){const e=()=>this._plugins.render(15),t=this._framebufferSize,i=this.fboCache.acquireDepth(10,t.width,t.height,"line callouts");this.renderToTargets(e,this._framebuffer.color,i,void 0,!0,!0),i.release()}else this._plugins.render(15)}_precompileHUD(e){if(this._precompileHUDOutput(e),this._hasHighlights){const t=this._renderContext.output;this._renderContext.output=8,this._precompileHUDOutput(e),this._renderContext.output=t}}_precompileHUDOutput(e){const t=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=e,this._oitEnabled&&dr(this._renderContext.output)?(this._bindParameters.oitPass=1,this._plugins.precompile(...jA),this._bindParameters.oitPass=2,this._plugins.precompile(...jA),this._bindParameters.oitPass=0):this._plugins.precompile(...jA),this._bindParameters.hudRenderStyle=t}_renderHUD(e,t,i){if(this._pluginsHas.hudElements){if(this._oitEnabled){const s=this._renderOIT(1,i,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,s.getTexture()),s.release()}else if(this._renderContext.output=i,0===e){const t=()=>this._renderHUDElements(e),i=this._framebufferSize,s=this.fboCache.acquireDepth(10,i.width,i.height,"hud");this.renderToTargets(t,this._framebuffer.color,s,void 0,!0,!0),s.release()}else t.acquireDepth(10),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(0===e?RA.HUD_OCCLUDED:RA.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(...jA)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(5,2)}_renderHighlightPrepass(){if(!this._hasHighlights)return;const{fboCache:e,_rctx:t,_bindParameters:i}=this,s=this._framebufferSize,{highlights:r}=i,n=e.acquire(s.width,s.height,"highlights",r.length>wa?3:1);n.acquireDepth(11),t.bindFramebuffer(n.fbo);const{gl:a}=t;return a.clearBufferuiv(a.COLOR,0,[0,0,0,0]),this._renderContext.output=8,t.bindFramebuffer(n.fbo),xa(t,e,s,i,()=>this._renderHighlightGeometries()),this.performanceInfo.advance(RA.HIGHLIGHTS),n}_renderHighlightGeometries(){this._plugins.render(...zA),this._rctx.clear(256),this._renderHUDElements(2)}_renderShadowAccumulation(e,t,i,s){this._shadowAccumulator.updateDepthRange(e),this._shadowAccumulator.accumulating&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,t,i,s)&&this.performanceInfo.advance(RA.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&dr(this._renderContext.output)?(this._bindParameters.oitPass=1,this._plugins.precompile(...VA),this._bindParameters.oitPass=2,this._plugins.precompile(...VA),this._bindParameters.oitPass=0):this._plugins.precompile(...VA)}_renderOIT(e,t,i=2){const s=1===e,r=this._framebufferSize,n=s?this.fboCache.acquire(r.width,r.height,"oit hud composite"):null,a=s?()=>this._renderHUDElements(i):()=>this._renderTransparentGeometry(),o=this._bindParameters,l=this._renderContext.output;this._renderContext.output=t,o.oitPass=1;const h=n?"oit hud color+alpha":"oit color+alpha",c=this.fboCache.acquire(r.width,r.height,h,8),d=1===t;d&&c.acquireColor(Qn,8,"oit emissive"),c.acquireColor(d?Kn:Qn,7),n||c.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(c.fbo),this._rctx.clearFramebuffer([0,0,0,1]),d&&this._rctx.clearBuffer(1,sp),a(),c.detachDepth(),o.oitPass=2;const u=this.fboCache.acquire(r.width,r.height,n?"oit hud front":"oit front");return d&&u.acquireColor(Qn,8,"oit emissive front"),n?u.acquireDepth(10):u.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(u.fbo),this._rctx.clearFramebuffer(ml,!!n),a(),u.detachDepth(),o.oitPass=0,n?(this._rctx.bindFramebuffer(n.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(16384)):this._framebuffer.bind(),this._oitblend??=new AD(this._techniques),this._oitblend.blend(this._rctx,c,u,o,d),n?.detachDepth(),u.release(),c.release(),this._renderContext.output=l,n}_renderOpaque(e){const t=this.plugins.produces(0,...kA);if(t){this._plugins.render(0,1);const e=this._framebuffer;e.update(e=>this._renderNodes(ii.OPAQUE_TERRAIN,e)),e.bind(),this._plugins.render(2,3)}const i=this._framebuffer;i.update(e=>this._renderNodes(ui.OPAQUE,e,t)),this.fboCache.debugCallback?.(ui.OPAQUE,i.color.fbo),i.update(e=>this._renderNodes(ii.OPAQUE_ENVIRONMENT,e)),this.fboCache.debugCallback?.(ii.OPAQUE_ENVIRONMENT,i.color.fbo),this._renderTerrainDepth(e),this._renderEdges(1)}_renderTransparent(e,t,i){const s=this._framebuffer;s.bind(),this._renderPlugins(20,RA.VOXEL),this._renderHiddenTransparentEdges(),e&&(this._oitEnabled?this._renderOIT(0,i):this._renderTransparentGeometry()),s.update(t=>this._renderNodes(ui.TRANSPARENT,t,e)),this.fboCache.debugCallback?.(ui.TRANSPARENT,s.color.fbo),this._renderGeometryDepth(t),this._renderHUDVisibility(),t||this._plugins.render(15),this._renderEdges(0);const r=this._hasTransparentTerrain?this._renderTransparentTerrain():null;r&&(this.performanceInfo.advance(RA.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(t?this._renderLineCallouts(0):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,r.getTexture())),this._renderHUD(0,s.color,i))),this._bindParameters.cullAboveTerrain=!1,r&&(s.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,r.getTexture()),r.release(),t&&(this._renderEdges(1),e&&(this._oitEnabled?this._renderOIT(0,i):this._renderTransparentGeometry(),this.performanceInfo.advance(RA.TRANSPARENT)),this._renderEdges(0)));const n=this._hasTransparentIntegratedMesh?this._renderTransparentIntegratedMesh():null;n&&(s.bind(),this._compositingHelper.composite(this._bindParameters,n.getTexture()),n.release()),this._bindParameters.ssao=O(this._bindParameters.ssao),t&&this._renderLineCallouts(1),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment()}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(RA.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(8),this.performanceInfo.advance(RA.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(e),this.performanceInfo.advance(t))}_renderNodes(e,t,i=!1){if(t.setName(e),this._pluginInput.set(e,t),!this._nodes.produces(e))return i&&this.performanceInfo.advance(e),t;const s=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),s}_blitFBO(e,t=cD,i=!0){return this._blit??=new Qu(this._techniques),this._blit.blit(this._rctx,e,t,this._bindParameters),this._pluginInput.set(e.name,t),i&&e.release(),t}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=js:(Es(qA,this._bindParameters.camera.viewMatrix),Es(HA,this._bindParameters.camera.projectionMatrix),Ps(UA,qA,HA),Ps(UA,this._renderContext.lastFrameCamera.viewMatrix,UA),Ps(UA,this._renderContext.lastFrameCamera.projectionMatrix,UA),this._reprojectionMatrix=UA);const t=this.stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=js,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,t,i,s){this._bindParameters.updateLighting(e,t,i,s),this._requestRender(1)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(e,t,i,s,r=!1,n=!1){t.attachDepth(i),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(s,r,n),e(),t.detachDepth()}get test(){}};e([Ce({readOnly:!0})],EA.prototype,"fullResolutionAtmosphere",null),e([Ce()],EA.prototype,"_edgeView",void 0),e([Ce()],EA.prototype,"updating",null),EA=e([Se("esri.views.3d.webgl-engine.lib.Renderer")],EA);const IA=[0,1,2,4],LA=[3,5],kA=[0,1,2,3],VA=[4,5],FA=[2,4,8],jA=[16,13,14],zA=[4,5,2,3,6,0,1],HA=Fs(),qA=Fs(),UA=Fs();class BA{constructor(e){this._rctx=e,this._vao=function(e){const t=new Float32Array([-1,-1,3,-1,-1,3]);return new ra(e,new oa(e,nr,t))}(e)}destroy(){this._vao=M(this._vao)}draw(){null!=this._vao&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(Un.TRIANGLES,0,3))}get test(){}}class NA{constructor(e,t){this._rctx=e,this._layout=t,this._cache=new fw(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let i=this._cache.pop(t);return i||(i=new ra(this._rctx,new oa(this._rctx,this._layout)),i.buffer()?.setSize(e),i)}deleteVao(e){if(null==e)return;const t=e.getByteLength("geometry").toString();this._cache.put(t,e)}}class GA extends lp{constructor(e,t){super(e,t),this.emptyTexture=FT(this),this._vaoCaches=new Map,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=t.newCache,this._screen=new BA(this)}configure(e){super.configure(e),this._newCache=e.newCache}destroy(){this._vaoCaches.forEach(e=>e.dispose()),this._vaoCaches.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}get refCount(){return this._refCount}dispose(){this.emptyTexture.dispose(),this._screen.destroy(),this._screen=null,super.dispose(),this._appleAmdDriverHelper?.dispose(),this._vaoCaches.forEach(e=>e.dispose()),this._vaoCaches.clear()}get newCache(){return this._newCache}get screen(){return this._screen}getVaoCache(e){const t=JSON.stringify(e),i=this._vaoCaches.get(t);if(i)return i;const s=new NA(this,e);return this._vaoCaches.set(t,s),s}bindTechnique(e,t,i,s){return this.useProgram(e.program),this.setPipelineState(e.getPipeline()),e.program.bind(t),i&&(e.program.bindPass(i,t),s&&e.program.bindDraw(t,i,s)),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??=new hp(this),this._appleAmdDriverHelper.run())}get isAssumedMetalDriver(){if(null==this._isAssumedMetalDriver&&(this._isAssumedMetalDriver=!!h("ios")||!!h("safari"),!this._isAssumedMetalDriver&&h("mac")&&h("chrome"))){const e=this.capabilities.rendererInfo?.getUnmaskedRenderer().toLowerCase(),t=e?.includes("apple")&&e?.includes("angle")&&e?.includes("metal");this._isAssumedMetalDriver=t??!0}return this._isAssumedMetalDriver}get test(){}}class WA extends cp{constructor(e){super(e.options.deactivatedWebGLExtensions||{},e.options.debugWebGLExtensions||{},8,e.view.qualitySettings.maxTexturePixels),this.newCache=(t,i)=>e.view.resourceController.memoryController.newCache(t,i)}}class $A{constructor(){this._updating=new Map}destroy(){this._updating.clear()}add(e){this._updating.set(e.id,new QA(e))}remove(e){this._updating.delete(e.id)}run(){let e=!1;return this._updating.forEach(t=>{const i=t.texture.update(t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)}),e}}class QA{constructor(e){this.texture=e,this.previousToken=-1}}let ZA=class extends Oe{constructor(e){super({}),this._stage=e,this._textures=new Map,this._loadingCount=0,this.events=new zi,this.updater=new $A,this._frameTask=e.view.resourceController.scheduler.registerTask(kn.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this.updater.destroy(),this._textures.forEach(e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}acquire(e){const t=this._textures.get(e);return t?(t.ref(),t.loadingPromise??t):this._createNewRef(e)}update(){this.updater.run()&&this.events.emit("changed",0)}_createNewRef(e){const t=this._stage.getTexture(e);if(null==t)return null;const i=t.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(t)}),s=new YA(t,()=>{this._frameTask.schedule(()=>{s.isUnreferenced&&t.unload()})});return this._textures.set(e,s),s.ref(),t.loaded?(this._updateGLTexture(s,t.glTexture),dp(t)&&this.updater.add(t),s):(this._loadingCount++,s.loadingPromise=this._stage.schedule(()=>{const e=t.load(this._stage.renderView.renderingContext),i=e=>(this._loadingCount--,s.loadingPromise=null,this._updateGLTexture(s,e),dp(t)&&this.updater.add(t),s);return H(e)?e.then(i,e=>(t.unload(),this._loadingCount--,s.loadingPromise=null,F(e)||C.getLogger(this).error(e),null)):i(e)}),s.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",1)}_onTextureUnloaded(e){this._textures.delete(e.id),this.updater.remove(e)}};e([Ce()],ZA.prototype,"_loadingCount",void 0),e([Ce()],ZA.prototype,"_frameTask",void 0),e([Ce()],ZA.prototype,"updating",null),ZA=e([Se("esri.views.3d.webgl-engine.lib.TextureRepository")],ZA);class YA{constructor(e,t){this._texture=e,this._release=t,this._refCount=0}get id(){return this._texture.id}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(C.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}unload(){this._texture.unload()}}let KA=class extends Oe{constructor(){super(...arguments),this._passParameters=new XA,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=P(this._resourcesTask),this._passParameters.waveNormal=M(this._passParameters.waveNormal),this._passParameters.wavePerturbation=M(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=Jt(async t=>{await Promise.allSettled([this._loadImageResource(e,ip("esri/images/materials/water/normals.jpg"),e=>this._passParameters.waveNormal=e,t),this._loadImageResource(e,ip("esri/images/materials/water/perturbation.jpg"),e=>this._passParameters.wavePerturbation=e,t)])})),this._resourcesTask.finished?2:1}async _loadImageResource(e,t,i,s){try{const r=await ep(t,{signal:s});V(s);const n=new On(r.width,r.height);n.pixelFormat=6407,n.samplingMode=9987,n.hasMipmap=!0,n.maxAnisotropy=8,i(new An(e,n,r))}catch(e){C.getLogger(this).error("Failed to load water material normal texture.",e)}}};e([Ce()],KA.prototype,"_resourcesTask",void 0),e([Ce({type:Boolean,readOnly:!0})],KA.prototype,"updating",null),KA=e([Se("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],KA);class XA extends xr{}class JA{constructor(e,t){this.parameters=e,this.fbos=t}}class eE{constructor(e,t,i){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=i,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(0);const t=L();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const i of this._screenshotQueue){if(null==this._rctx){i.resolver.reject();continue}const s={...i.settings,pixelRatio:i.settings.pixelRatio*e.parameters.camera.pixelRatio},r=this._renderScreenshot(e,s,t);i.resolver(r)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){e.width=t.width,e.height=t.height;const s=e.getContext("2d",{willReadFrequently:!0}),r=i.pixelRatio;return s.save(),s.translate(0,t.height),s.scale(1,-1),i.region&&s.translate(-i.region.x,-i.region.y),s.scale(r,r),t=this._renderFunctions.renderOverlay(e,i.disableDecorations,t),s.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:s,region:r,resample:n}=e,a=this._ensureScreenshotEncodeCanvas();let o=pp(i,s,a);this._rctx.gl.readPixels(0,0,i,s,6408,Bn.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),t(),o=this._renderScreenshotOverlay(a,o,{...e,region:void 0});const l=pp(r.width,r.height,a);return up(o,l,!0,n.region.x,s-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:s}=e,r=this._ensureScreenshotEncodeCanvas(),n=pp(s.width,s.height,r);return this._rctx.gl.readPixels(s.x,i-(s.y+s.height),s.width,s.height,6408,Bn.UNSIGNED_BYTE,new Uint8Array(n.data.buffer)),t(),this._renderScreenshotOverlay(r,n,e)}_renderScreenshot(e,t,i){const s=e.parameters.camera,{framebufferWidth:r,framebufferHeight:n,ignorePadding:a,pixelRatio:o,disableDecorations:l,olidColor:h}=t,c={width:r,height:n};Mn(c,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let d=!1;const u=c.width!==s.fullWidth||c.height!==s.fullHeight,p=a&&s.pixelRatio!==o,m=u||l||p||h;let g=null,_=null;if(m){const e=s.clone();if(a){const t=_l(e.padding);for(let i=0;i<4;i++)t[i]=Math.round(t[i]/e.pixelRatio*o);e.padding=t}e.fullWidth=c.width,e.fullHeight=c.height,e.pixelRatio=o;const t=s.fovX-e.fovX,r=s.fovY-e.fovY;t<0&&t<r?e.fovX=s.fovX:r<0&&r<t&&(e.fovY=s.fovY);const n={camera:e,contentCamera:e,mode:2,alignPixelEnabled:!0,contentPixelRatio:e.pixelRatio};this._forceCameraHook(n),d=!0;const u=this._renderFunctions.renderScene(n,i,h?2:1,l);_=u.screen,g=u.olid}this._rctx.bindFramebuffer(_?.fbo);const f=this._readbackScreenshot(t,()=>{this._rctx.bindFramebuffer(null),_?.release()});let y=null;if(h){const e=()=>{this._rctx.bindFramebuffer(null),g?.release()};this._rctx.bindFramebuffer(g?.fbo),y=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null)}if(m&&!this._rctx.contextAttributes.alpha)for(let e=3;e<f.data.length;e+=4)f.data[e]=255;if(y&&!this._rctx.contextAttributes.alpha)for(let e=3;e<y.data.length;e+=4)y.data[e]=255;return d&&this._forceCameraHook(e.parameters),[f,y]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??=document.createElement("canvas"),this._screenshotEncodeCanvas}}let tE=class extends Oe{constructor(e){super(e),this._waterTextures=new KA,this.olidRenderHelper=Jr()?new BO:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this.bloom=null,this.test=null;const t=e.stage;try{this._initializeContext(t)}catch(e){return void console.error("Failed to initialize context",e)}const{memoryController:i}=t.view.resourceController;this._stippleTextures=Oh(this._rctx,i),this.notifyChange("stippleTextures"),this._markerTextures=function(e,t){return new Mh(t=>Rh(t,e),e=>e,t)}(this._rctx,i),this.notifyChange("markerTextures"),this._techniques=new PR(new SR(this._rctx,t.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new ZA(t),this.addHandles(this._textures.events.on("changed",e=>this.requestRender(e)));const s=new Ca(this._textures,this._techniques,()=>this.requestRender(),()=>this.requestRender());this._compositingHelper=new UO(this._rctx,this._techniques),this._renderer=new EA(t,s,this._techniques,this._rctx,this._compositingHelper,e=>this.requestRender(e)),this.notifyChange("renderer"),this.addHandles([B(()=>t.view.ready,e=>{e&&this._createRenderNodes()},N),B(()=>this.waterTextures?.updating,()=>this.requestRender(),N),B(()=>t.view.qualityProfile,e=>this.renderer?.updateRenderFeatures(e),G)]);const r={renderScene:(e,t,i,s)=>this.renderer.render(e,t,i,s),requestRenderScene:e=>this.requestRender(e),prepareOverlay:()=>t.options.screenshot.prepareOverlay(),renderOverlay:(e,i,s)=>t.options.screenshot.renderOverlay(e,i,s)};this._screenshotManager=new eE(this._rctx,r,e=>t.view.basemapTerrain.overlayManager.updateOverlays(Hn,e.camera,0)),this._registerFrameTask(t)}destroy(){const e=this.stage?.container;e?.contains(this._canvas)&&e.removeChild(this._canvas),this._frameTask=T(this._frameTask),this._techniques=S(this._techniques),this._componentObjectCollection=S(this._componentObjectCollection),this._set("componentObjectCollection",null),this._screenshotManager=S(this._screenshotManager),S(this.renderer),this._textures=S(this._textures),S(this.waterTextures),S(this.markerTextures),S(this.stippleTextures),this._waterTextures=null,this._markerTextures=null,this._stippleTextures=null,this._canvas=null,this._rctx=S(this._rctx),this._compositingHelper=null,this._renderer=null,this._set("renderer",null),this.test?.destroy()}_createRenderNodes(){const{view:e,viewingMode:t}=this.stage;new EO({view:e}),me(e.spatialReference)||(2===t?(new zP({view:e}),this.bloom=new qR({view:e})):pe(e.spatialReference)?(new NP({view:e}),this.bloom=new qR({view:e})):(new vP({view:e}),new xP({view:e}),this.bloom=new qR({view:e}),new eO({view:e}),new PP({view:e}))),new tu({view:e,isEnabled:()=>this.renderer.hasSSAO}),new SO({view:e,isEnabled:()=>this.renderer.hasSMAA}),new fO({view:e}),new Ta({view:e}),new hO({view:e,viewingMode:t}),new BR({view:e}),Jr()&&new UR({view:e})}requestRender(e=1){this._needsRender=!0,1===e&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(f(e))}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,i,s,r,n=r){const a=s.constrainWindowSize(t,i,r*s.pixelRatio,n*s.pixelRatio),o=this._ensureLinearDepthArrayBuffer(a);this.renderer.readMainDepth(a,o);const l=(e,t,i)=>ju(t,e)*(i[1]-i[0])+i[0];let h=Number.MAX_VALUE;for(let e=0;e<a[2]*a[3];e++){const t=l(4*e,o,s.nearFar);h>t&&t!==s.nearFar[0]&&t!==s.nearFar[1]&&(h=t)}if(e){const r=e.pickDepth(t*s.pixelRatio,i*s.pixelRatio,s);null!=r&&h>r&&r!==s.nearFar[0]&&r!==s.nearFar[1]&&(h=r)}return h===Number.MAX_VALUE?void 0:h}_ensureLinearDepthArrayBuffer(e){const t=4*e[2]*e[3];return(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){hx(),await this._techniques.reloadAll(),this.renderer.overlay?.reloadShaders(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let i=!1,s=0,r=!1;const n={preRender:({time:r})=>{i=this.updating,s=this._needsUpdate?1:0,this._needsRender&&this.renderer.updateSceneDepthRange(t.camera),e.commitSyncLayers(),r=this.test?.time??r,(X(r-this._lastAnimationUpdate)>this.renderer.animationTimestep||i||this._needsRender)&&(this.renderer.updateAnimation(t,r)&&this.requestRender(0),this._lastAnimationUpdate=r)},render:({time:e})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const i=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,e=this.test?.time??e,this.renderer.render(t,e,0),r=!0,i&&this.renderer.hasReflections&&(this.requestRender(0),this._needsWaterReflectionUpdate=!0)}},update:({time:e})=>{this._textures.update();const i=new JA(t,this.renderer.fboCache);e=this.test?.time??e,this._screenshotManager.update(i,e)},finish:()=>{r&&(this.renderer.finish(2===t.mode?s:1),r=!1)}};this._frameTask=ee(n)}_initializeContext(e){const{options:t}=e,i=t.canvas??document.createElement("canvas");i.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=i;const s={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},r=i.getContext("webgl2",s);if(null==r)return void C.getLogger(this).error("A WebGL2 context could not be created.");Ln(r,!0),this._rctx=function(e,t){const i=new WA(t);return new GA(e,i)}(r,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&C.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");const{container:n}=e;!this._rctx.contextAttributes.alpha&&h("safari")>=11&&(n.style.backgroundColor="black"),n.contains(i)||n.appendChild(i)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}get stippleTextures(){return this._stippleTextures}get markerTextures(){return this._markerTextures}get waterTextures(){return this._waterTextures}getObjectAndLayerIdColor(e){return this.olidRenderHelper?.getObjectAndLayerIdColor(e)}get renderer(){return this._renderer}get componentObjectCollection(){return null==this._componentObjectCollection&&(this._componentObjectCollection=new xR(this.renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}updateQualitySettings(e){null!=this.test?.time&&(this.test.savedFadeDuration=e.fadeDuration,e.fadeDuration=X(0)),this._rctx.updateOptions({maxPreferredTexturePixels:this.stage.view.qualitySettings.maxTexturePixels})}};e([Ce({type:Boolean,readOnly:!0})],tE.prototype,"updating",null),e([Ce({constructOnly:!0})],tE.prototype,"stage",void 0),e([Ce({readOnly:!0})],tE.prototype,"stippleTextures",null),e([Ce({readOnly:!0})],tE.prototype,"markerTextures",null),e([Ce({readOnly:!0})],tE.prototype,"waterTextures",null),e([Ce({readOnly:!0})],tE.prototype,"olidRenderHelper",void 0),e([Ce()],tE.prototype,"_textures",void 0),e([Ce({readOnly:!0})],tE.prototype,"renderer",null),e([Ce()],tE.prototype,"_screenshotManager",void 0),e([Ce()],tE.prototype,"componentObjectCollection",null),e([Ce()],tE.prototype,"_componentObjectCollection",void 0),e([Ce()],tE.prototype,"_needsUpdate",void 0),e([Ce()],tE.prototype,"_needsWaterReflectionUpdate",void 0),tE=e([Se("esri.views.3d.webgl-engine.parts.RenderView")],tE);let iE=class extends Oe{constructor(e){super(e),this._model=new nP,this._canCompact=ds(!1),this._layers=new Array,this._asyncChangeSet=new Dw,this._syncChangeSet=new Dw,this._layerSyncSet=new Set,this._textures=new Ib(this,e.view.resourceController.scheduler),this._frameTask=e.view.resourceController.scheduler.registerTask(kn.STAGE,this),this.addHandles(this._frameTask)}initialize(){this._renderView=new tE({stage:this})}destroy(){this.removeAllHandles(),this._textures.destroy(),this._set("textures",null),this._renderView=S(this._renderView),this._set("renderView",null),this._layers.length=0,this._model=null,this._set("renderer",null),this.options.canvas=null,this._set("options",null)}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.readyToRun||this.renderView.updating||this._frameTask.updating||this.textures.updating}get renderView(){return this._renderView}get renderer(){return this.renderView?.renderer}get textures(){return this._textures}addTexture(e){this._model.addTexture(e),this.renderView.requestRender()}removeTexture(e){null!=e&&!this.destroyed&&this._model.hasTexture(e)&&(this._model.removeTexture(e),this.renderView.requestRender())}addTextures(e){null!=e&&(this._model.addTextures(e),this.renderView.requestRender())}removeTextures(e){null!=e&&(this._model?.removeTextures(e),this.renderView.requestRender())}forEachTexture(e){this._model.forEachTexture(e)}getTexture(e){return this._model.getTexture(e)}addLayer(e){this._layers.includes(e)||(this._model.addLayer(e),this._layers.push(e),this._model.dirtySet.layerAdded(e),this.renderView.requestRender())}removeLayer(e){null!=e&&!this.destroyed&&this._model.hasLayer(f(e))&&(this._model.dirtySet.layerRemoved(e),this._commitLayer(e),u(this._layers,e),this._model.dirtySet.assertLayerClean(e.id),this._model.removeLayer(e),this.renderView.requestRender())}getLayer(e){return this._model.getLayer(e)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get readyToRun(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty||this._canCompact.value}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),this.renderer.compact(e),this._canCompact.value=this.renderer.canCompact,!e.hasProgressed)return Vn}compact(e){return this._canCompact.value=!1,this.renderer.compact(e)}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forEach(i=>{if(e.done)return;const s=this._layerSyncSet.has(i.id)||1===i.updatePolicy,r=s?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(i.id,r),this._layerSyncSet.delete(i.id),r.empty||(this.renderer.commit(r,s?Hn:e),this.renderView.requestRender(),e.madeProgress())}),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,Hn),this.renderView.requestRender(),e.madeProgress()),this._layers.forEach(i=>{e.done||this._layerSyncSet.has(i.id)||0!==i.updatePolicy||(t.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("readyToRun")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forEach(t=>{this._layerSyncSet.has(t.id)||1===t.updatePolicy?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)});for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,Hn),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,Hn),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}get layers(){return this._layers}addRenderPlugin(e,t){const i=this.renderer.plugins.add(e,t),s=()=>{Kv(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if(H(i))return i.then(s);s()}removeRenderPlugin(e){this.destroyed||(Kv(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get test(){}};e([Ce({constructOnly:!0})],iE.prototype,"view",void 0),e([Ce({constructOnly:!0})],iE.prototype,"options",void 0),e([Ce({readOnly:!0})],iE.prototype,"viewingMode",null),e([Ce({constructOnly:!0})],iE.prototype,"container",void 0),e([Ce({readOnly:!0})],iE.prototype,"updating",null),e([Ce({readOnly:!0})],iE.prototype,"renderView",null),e([Ce({readOnly:!0})],iE.prototype,"renderer",null),e([Ce({readOnly:!0})],iE.prototype,"textures",null),e([Ce({readOnly:!0})],iE.prototype,"readyToRun",null),iE=e([Se("esri.views.3d.webgl-engine.Stage")],iE);const sE=new Set,rE=()=>C.getLogger("esri/views/support/TextureCompressionHelper");let nE=class extends xp{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};e([Ce()],nE.prototype,"components",void 0),nE=e([Se("esri.views.ui.3d.DefaultUI3D")],nE);const aE=nE,oE=Symbol(),lE=Symbol();let hE=class extends(Wt(Zt($t(Bt)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._resolveWhenReady=[],this._resourceController=new Db({view:this}),this.deconflictor=new gv({view:this}),this.labeler=new Ov({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new Nt,this.basemapTerrain=null,this.elevationProvider=null,this._canvas=null,this.constraints=new Hp,this.environment=new Vm,this.environmentManager=new Om,this.floors=new s,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new Dp({view:this}),this.groundView=null,this.map=null,this._featureTileTreeClients=new U,this._featureTiles=null,this._featureTreeDebugger=null,this.screenSizePerspectiveEnabled=!0,this.state=new zv({view:this}),this.slice=new zb,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new aE,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this._importControllers=new Map,xe();const t=(e=null)=>{null!=e&&4===e.type||(this._updatingChanged(),this.map?.allLayers.forEach(async e=>{try{await e.when()}catch(e){}this._updatingChanged()}))};this.addHandles([Z(()=>this.map?.allLayers,"after-changes",e=>t(e),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",e=>this._updateUpdatingMonitors(e)),B(()=>this.scene,e=>e?.load().catch(()=>{}))]),this.inputManager=new Ay({view:this}),this.stateManager=new _f({view:this})}initialize(){if(h("enable-feature:esri-compress-textures")&&h("wasm-simd")){const t=(e=this.resourceController,An.compressionWorkerHandle??=new GT(bp(e)),sE.has(this)?rE().warn("Repeated texture compression worker initialization by the same view."):sE.add(this),An.compressionWorkerHandle);this.addResolvingPromise(t.promise)}var e;this.groundView=new Qt({view:this}),this._updateUpdatingMonitors(),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},N),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},N),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>ie(e>0?1e3/Math.ceil(e):0),N),this.addHandles([B(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),W),B(()=>({plane:this.slice.plane,isDecoration:this.slice.isDecoration}),()=>this._updateSlice(),W)])}destroy(){this.destroyed||(function(e){const t=An.compressionWorkerHandle;t&&(sE.delete(e)||rE().warn("Unknown view attempted to destroy the texture compression worker."),sE.size||(t.destroyWorkerAndSelf(),An.compressionWorkerHandle=null))}(this),this.updatingHandles.removeAll(),this.basemapTerrain?.clearHandles(),this.ui.removeAllHandles(),this.layerViewManager.clearHandles(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._set("analysisViewManager",S(this.analysisViewManager)),this._exitSurface(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this.sharedSymbolResources=S(this.sharedSymbolResources),this._set("labeler",S(this.labeler)),this._set("deconflictor",S(this.deconflictor)),this._resourceController=S(this._resourceController),this._set("stateManager",S(this.stateManager)),this._set("inputManager",S(this.inputManager)),this.state.destroy(),this.highlights.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",S(this.environmentManager)),this._set("environment",S(this.environment)),this.groundView=S(this.groundView),this.slice.destroy(),this._updatingObjectsWithProgress.length=0,this._updatingObjects.length=0,this.ui?.destroy(),this._set("ui",null),this._set("renderCanvas",null),this._set("canvas",null),this._canvas=null)}get stage(){return this._stage}get renderSpatialReference(){return this.renderCoordsHelper?.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get canvas(){return this._canvas}get center(){return this.stateManager?.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if("global"===this.viewingMode)return null;const e=this.map;let t=this._userClippingArea||D(e,"clippingArea");return!this._userClippingArea&&!D(e,"clippingEnabled")||null==t?(this._clippingArea=null,null):t instanceof $e?this.spatialReference&&(t=cE(t,this.spatialReference),null==t)?(C.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),null==t.intersection(this._groundAndLayersExtent)&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(C.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&null!=e?C.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(1===this.state.viewingMode)return null;const e=this.renderSpatialReference,t=this.dataExtent;return null==t||null==e||t.spatialReference.equals(e)?t:cE(t,e)}get tileInfo(){return this.basemapTerrain?.tilingScheme?.toTileInfo()}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||tt.WGS84,i=cE(this.clippingArea,t);null!=i&&(e=null!=e?e.intersection(i):i);const s=this._get("dataExtent");return null!=e&&e.equals(s)?s:e}get _groundAndLayersExtent(){const e=this.spatialReference||tt.WGS84;let t;const i=i=>{const s=cE(i,e);null!=s&&(null!=t?t.union(s):t=s.clone())},{basemapTerrain:s}=this;if(s?.spatialReference){const e=s.groundExtent;i(new $e({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:s.spatialReference}))}if(this.map?.allLayers.forEach(e=>(e=>{null==e.fullExtent||"graphics"===e.type&&e.internal||i(e.fullExtent)})(e)),null==t)return null;t.hasZ?(t.zmin=Math.min(0,t.zmin??0),t.zmax=Math.max(0,t.zmax??0)):(t.zmin=0,t.zmax=0);const r=this._get("_groundAndLayersExtent");return t.equals(r)?r:t}castEnvironment(e){return e?e instanceof Vm?e:e instanceof Fa?this.environment?.cloneWithWebsceneEnvironment(e)??Vm.fromWebsceneEnvironment(e):Me(Vm,e):new Vm}get extent(){return this.stateManager?.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state?.stationary??!0)}get navigating(){return this.state?.navigating??!1}get scene(){return this.map&&Gt in this.map?this.map:null}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}get featureTiles(){return this._featureTiles}set qualityProfile(e){rb.isValidProfile(e)&&(rb.apply(e,this.qualitySettings),this.stage?.renderView.updateQualitySettings(this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||rb.getDefaultProfile()}_updateSlice(){null!=this.stage&&(this.stage.renderer.slice=this.slice)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&!!this.stateManager?.preinit(this.spatialReference)}get resolution(){return null!=this.spatialReference?At(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?Qe.deriveUnitFromSR(e,this.spatialReference):null}get updating(){if(this.destroying||this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,i=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(s=>{if(s.isFulfilled()){if(s.updating){if(t=!0,s.suspended||Fc(s))return;++i,e+=s.updatingProgress}}else++i});for(const t of this._updatingObjects)if(null!=t&&t.updating){const t=.1;i+=t,e+=.5*t}for(const t of this._updatingObjectsWithProgress)null!=t&&t.updating&&(++i,e+=t.updatingProgress);const s=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(t=!!(t||i>0||this.updatingHandles.updating||!this.ready||!this.stationary||s||this._importControllers.size>0||this.inputManager?.updating||this.map?.allLayers?.some(e=>!e.isFulfilled())),t?(this._numUpdating=Math.max(i,this._numUpdating),e+=this._numUpdating-i):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const i=performance.now();if(e<1){const t=Math.min((i-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-t)+e*t}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?i:0}return t}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this.stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){const e=this._predeterminedViewingMode;if(null!=e)return Xt(e);const t=this.spatialReference;return t?null!=this.defaultsFromMap?.viewingMode&&t.equals(this.defaultsFromMap.spatialReference)?Xt(this.defaultsFromMap.viewingMode):vp(t,1)?"global":"local":"global"}set viewingMode(e){this.ready?C.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get visibleArea(){return this.stateManager?.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get highlightOptions(){return this.highlights.find(({name:e})=>e===Lh)??new _p}set highlightOptions(e){for(let t=0;t<this.highlights.length;++t)if(this.highlights.at(t).name===Lh)return void this.highlights.items[t].assignFrom(e)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new Nc(this)}on(e,t,i,s){return this.viewEvents.on(e,t,i,s)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return C.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const i=fp(e)?yp(this,e):e;return Hh(this,i,t,this._defaultToMapOptions)}toScreen(e){if(!this.ready)return C.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=(null==e.z?Nh(this.elevationProvider,e):null)??0;return at(e,dE,this.renderSpatialReference,t),this.state.camera.projectToScreen(dE,uE),ne(uE[0],uE[1])}pixelSizeAt(e,t){if(!this.ready)return C.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!e)return 0;const i=this.renderSpatialReference;at(e,dE,i);const s=this.state.camera.computeScreenPixelSizeAt(dE);return t&&i!==t?s*ve(i)/ve(t):s}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e,()=>this.pixelSizeAt(e)):1}hitTest(e,t){if(!this.ready)return C.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=fp(e)?yp(this,e):e;return qh(this,i,t,this._defaultHitTestOptions)}async popupHitTest(e){return async function(e,t){const{results:i,ground:s}=await Gh(e,t),r=(!s.layer||!Et(s.layer.type))&&s.mapPoint,n=[],a=function(e){const t=new Map;for(const i of e.allLayerViews){const e=i.layer.uid;t.set(e,i)}return t}(e),o=r?function(e,t){const i=new Set,s=new Set;for(let t=e.basemapTerrain.numLayers(1)-1;t>=0;t--){const r=e.basemapTerrain.layerViewByIndex(t,1);i.add(r.layer.uid),s.add(r)}const r=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:e}of r){const r=t.get(e);r&&(i.add(e),s.add(r))}return{layerUids:i,layerViews:Array.from(s).reverse()}}(e,a):lb;let l=0,h=0;const c=()=>{const e=o.layerViews[h];r&&e&&"fetchPopupFeaturesAtLocation"in e&&n.push({mapPoint:s.mapPoint,layerView:e}),++h};let d=null;for(;l<i.length||h<o.layerViews.length;){const t=i[l];if(t&&"graphic"!==t.type)++l;else if("scene"!==t?.layer?.type||t?.layer?.parent!==e?.map?.basemap)if(t){const e=t.layer?.uid,i=o.layerUids.has(e)&&t.distance===s.distance,r=a.get(t.layer?.uid);if(d??=t.mapPoint,h<o.layerViews.length&&(i||(t.distance??0)>s.distance)&&o.layerViews[h]!==r){c();continue}n.push({graphic:t.graphic,layerView:r}),++l}else c();else++l}return d??=s.mapPoint,{hits:n,location:d}}(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(null==e.parent)throw new n("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=await this._completeSettings(e);await this.whenReady();const i=(await this.stage.renderView.takeScreenshot(t))[0];return(await import("../chunks/screenshotUtils.js")).encode(i,t,this._pixelFormat())}async _takeScreenshot(e){const t=await this._completeSettings(e);await this.whenReady();const i=(await this.stage.renderView.takeScreenshot(t))[0];return(await import("../chunks/screenshotUtils.js")).encodeData(i,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(e){const t=await this._completeSettings(e);t.olidColor=!0,await this.whenReady();const i=await this.stage.renderView.takeScreenshot(t),{encodeData:s}=await import("../chunks/screenshotUtils.js");return[s(i[0],this._pixelFormat()),s(i[1],this._pixelFormat())]}async _completeSettings(e){const{toRenderSettings:t,screenshotSuperSampleSettings:i}=await import("../chunks/screenshotUtils.js"),s=t(e,this);return s.pixelRatio/=this.state.pixelRatio,i(s,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this.stage?.renderView.getAlpha()??!1}}get test(){}async takeScreenshotWithObjectAndLayerId(e){if(!Jr())throw new n("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");const{encode:t}=await import("../chunks/screenshotUtils.js"),i=await this._completeSettings(e);i.olidColor=!0,await this.whenReady();const s=await this.stage.renderView.takeScreenshot(i),r=t(s[0],i,this._pixelFormat()),a=await this._completeSettings(e);return a.format="png",[r,t(s[1],a,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){const e=this.stage.renderView.olidRenderHelper;if(e)return e.getColorToObjectAndLayerIdMapping();throw new n("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return(e=>{const t=Pp[e.type];if(null==t)throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new n(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)})(e)}hasLayerViewModule(e){return(e=>null!=Pp[e.type])(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.scene?.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let e=wp(this.type);const t=h("safari");if(t&&t<9&&(e=new n("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),null!=e)throw C.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){const e=this._isOverridden("viewingMode")?this._get("viewingMode"):this.scene?.initialViewProperties?.viewingMode;return null!=e?Kt(e):null}getSpatialReferenceSupport(e,t){const i=this._predeterminedViewingMode;if(null!=i)return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const s=this._validateSpatialReferenceForViewingMode(e,t,2),r=this._validateSpatialReferenceForViewingMode(e,t,1);return s||r?s&&r?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:s?{constraints:this._makeSpatialReferenceConstraints(e,t,2)}:{constraints:this._makeSpatialReferenceConstraints(e,t,1)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!(!vp(e,i)||null!=t&&!zt(t)&&(Lt(t)&&null==rc(t,e,i)||Ht(t)&&1===i))}_makeSpatialReferenceConstraints(e,t,i){if(null==t)return[{spatialReference:e,viewingMode:i}];const{isWebMercator:s,isWGS84:r}=e;return zt(t)&&(s||r)?r&&2!==i&&null!==Bc(t.tileInfo,t.fullExtent,e,1)?[{spatialReference:s?tt.WGS84:tt.WebMercator,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:tt.WebMercator,viewingMode:i}]:Lt(t)||Ht(t)||!s&&!r?Lt(t)&&s&&1!==i?[{spatialReference:e,viewingMode:i},{spatialReference:tt.WGS84,viewingMode:2}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:s?tt.WGS84:tt.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=null!=this.getSpatialReferenceSupport(e),i=this._predeterminedViewingMode;return t||(null!=i?C.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${Xt(i)} viewing mode.`):e.isGeographic&&C.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise(e=>{this.ready?e(this):this._resolveWhenReady.push(e)})}trackGraphicState(e){if(!e.graphic)return C.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,s=!1;const r=t=>{!s&&null!=t&&"processor"in t&&"graphics-3d"===t.processor?.type&&t.processor.graphicsCore&&(i=t.processor.graphicsCore.trackGraphicState(e))};return null!=t?r(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then(e=>r(e),()=>{}).catch(()=>{}),o(()=>{s=!0,null!=i&&(i.remove(),i=null)})}maskOccludee(e){if(!e)return C.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,s=!1;const r=t=>{!s&&null!=t&&Eh(t)&&(i=t.maskOccludee(e))};return null!=t?r(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then(e=>r(e),()=>{}).catch(()=>{}),o(()=>{s=!0,null!=i&&(i.remove(),i=null)})}getViewForGraphic(e){return e.layer===this?this.graphicsView:e.layer?this.allLayerViews.filter(e=>"media-3d"!==e.type).find(t=>t.layer===e.layer):null}graphicChanged(e){null!=this.graphicsView&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){return e.layer===this?(await Q(()=>this.graphicsView),this.graphicsView):e.layer&&this.map?t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise((t,i)=>{const s=this.map.allLayers.on("change",r=>{r.added.includes(e.layer)&&(s.remove(),this.whenLayerView(e.layer).then(t,i))})}):this.whenLayerView(e.layer):null}enableFeatureTiles(){const e=Symbol();return this._featureTileTreeClients.add(e),o(()=>this._featureTileTreeClients.delete(e))}async _importModule(e,t){const i=new AbortController;this._importControllers.set(e,i),this._updatingChanged();try{const s=await mE[e]();if(t&&(q(this),V(i.signal),await t(i.signal)),this.destroyed)throw A();return V(i.signal),s}catch{return null}finally{this._importControllers.delete(e),this._updatingChanged()}}_abortImport(e){this._importControllers.get(e)?.abort(),this._importControllers.delete(e),this._updatingChanged()}_initBasemapTerrain(){this._set("basemapTerrain",new US({view:this})),this._set("elevationProvider",new ib({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){const{basemapTerrain:e,elevationProvider:t}=this;e&&(this._set("basemapTerrain",null),this._set("elevationProvider",null),t.unregister(e),t.destroy(),e.destroy())}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new uw({view:this})),this.addHandles([this.updatingHandles.add(()=>Jl.FEATURE_TILE_TREE_SHOW_TILES,e=>{e&&!this._featureTreeDebugger?this.updatingHandles.addPromise(import("../chunks/FeatureTileTree3DDebugger.js")).then(({FeatureTileTree3DDebugger:e})=>{!this._featureTreeDebugger&&Jl.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new e({view:this}))}):e||(this._featureTreeDebugger=S(this._featureTreeDebugger))},G),this.updatingHandles.add(()=>({basemapExtent:this.basemapTerrain?.extent,basemapSpatialReference:this.basemapTerrain?.spatialReference,clippingArea:this.clippingArea,featureTiles:this._featureTiles}),({basemapExtent:e,basemapSpatialReference:t,clippingArea:i,featureTiles:s})=>{if(!s)return;const r=!!e;if(i||r)if(r&&t){const r=e&&t?Je(Mt(e,t),this.spatialReference):null;s.filterExtent=i?i.intersection(r):r}else s.filterExtent=i;else s.filterExtent=null},G),this.updatingHandles.add(()=>this._featureTileTreeClients.size>0,e=>{e?this._ensureFeatureTileTree():this._featureTiles=S(this._featureTiles)},W)],oE),this.stateManager.init()}async _ensureFeatureTileTree(){if(this._featureTiles||this._importControllers.has("FeatureTileTree3D"))return;const e=(await this.updatingHandles.addPromise(this._importModule("FeatureTileTree3D")))?.FeatureTileTree3D;e&&(this._featureTiles=new e({renderCoordsHelper:this.renderCoordsHelper,pointsOfInterest:this.pointsOfInterest,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}),this._updatingChanged())}_exitTerrain(){this.stateManager.exit(),this.removeHandles(lE),this.removeHandles(oE),this._featureTiles=S(this.featureTiles),this._set("pointsOfInterest",S(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem()}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference,t=this.state.isGlobal,i=Dt(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",Wh.create(this.state.viewingMode,i)),t||this.addHandles(B(()=>this.basemapTerrain?.extent,e=>{const t=this.renderCoordsHelper.spatialReference;null==e||0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!nt(e,this.basemapTerrain.spatialReference,pE,t)||(this.renderCoordsHelper.extent=pE)},W),lE),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Io/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles(lE),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){null!=e&&4===e.type||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.addHandles(B(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),W),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,i){if(!this.overlay||!this.overlay.hasVisibleItems)return i;const s=e.getContext("2d",{willReadFrequently:!0});return s.putImageData(i,0,0),this.overlay.renderCanvas(e,{disableDecorations:t}),s.getImageData(0,0,i.width,i.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(e,t,i)=>this._renderScreenshotOverlay(e,t,i)}},t=new Nv(this.state.viewingMode,e=>this.stage.layers.forEach(e),this);this._set("sceneIntersectionHelper",t);const i=r(this.surface);this._stage=new iE({view:this,options:e,container:i}),this.notifyChange("stage"),this._updateSlice(),this.addHandles([this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,e=>this.stage.renderer.setParameters({highQualityTransparency:e}),N),this.on("pointer-move",()=>this.stage?.renderer.resetAnimation()),a(this.stage.renderView.canvas,"webglcontextlost",e=>{this.fatalError=new n("webgl-context-lost",e.statusMessage)})],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Io/this.renderCoordsHelper.unitInMeters),this._set("canvas",this.stage.renderView.canvas)}_exitStage(){this.sceneIntersectionHelper?.destroy(),this._set("sceneIntersectionHelper",null),this._stage=S(this.stage),this._set("stage",null),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new Fb({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitTerrain(),this._exitStage())}async _ensureGraphicsView(){if(this.graphicsView||this._importControllers.has("GraphicsView3D")||0===this.graphics.length)return;this.removeHandles("GraphicsView3D");const e=(await this.updatingHandles.addPromise(this._importModule("GraphicsView3D",e=>Q(()=>this.basemapTerrain?.ready,e))))?.default;e&&this._set("graphicsView",new e({view:this,getGraphics:()=>this.graphics})),this._updatingChanged()}_disposeGraphicsView(){this._abortImport("GraphicsView3D"),this.removeHandles("GraphicsView3D"),this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_disposeFocusAreasView(){this._abortImport("FocusAreasView"),this.removeHandles("FocusAreasView"),this.focusAreasView=S(this.focusAreasView)}async _ensureFocusAreasView(e){if(this.focusAreasView||this._importControllers.has("FocusAreasView")||0===e)return;this.removeHandles("FocusAreasView");const t=(await this.updatingHandles.addPromise(this._importModule("FocusAreasView")))?.FocusAreasView;t&&(this.focusAreasView=new t({view:this})),this._updatingChanged()}_startup(){const e=Kt(this.viewingMode);1===e&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.addHandles(Z(()=>this.graphics,"after-changes",()=>this._ensureGraphicsView()),"GraphicsView3D"),this._ensureGraphicsView(),this.addHandles(B(()=>this.map?.focusAreas?.areas.length??0,e=>this._ensureFocusAreasView(e),{initial:!0}),"FocusAreasView");const t=this.scene?.initialViewProperties??null,i=t?.environment;i&&(this._overrideDefaultEnvironmentOnly?Cp(this.environment,i):this.environment=this.environment.cloneWithWebsceneEnvironment(i)),this.timeExtent=t?.timeExtent,t?.analyses.applyTo(this),this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const s=this._resolveWhenReady;this._resolveWhenReady=[],s.forEach(e=>e(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this._exitSurface(),this._set("ready",!1)}get _defaultToMapOptions(){const e={include:new Set};if(!this.map)return e;this.map.ground&&e.include.add(Eo);for(const t of this.allLayerViews)Et(t.layer.type)&&e.include.add(t.uid);return e}get _defaultHitTestOptions(){const e={exclude:new Set};if(!this.map)return e;this.map.ground&&this.map.ground.opacity<1&&e.exclude.add(Eo);for(const t of this.allLayerViews)Et(t.layer.type)&&t.layer.opacity<1&&e.exclude.add(t.uid);return e}static{this.type="3d"}static clearStatics(){kl(),Ie(),ce(),mp(),wf=new t,xf=new Do,wi(),co(),rt(),gp(),Ut(),eS.sourceLayerInfo=null,eS.tile=null,eS.vtlNeighborInfos.prune(),Sa(),zg=new Do,G_=new Do,Ge(),se(),NR.prune(),sC.prune(),rC.clear(),Vv.cleanupI3SLodHandling(),qt.cleanupTilemapCache(),zv.cleanupViewstate(),US.cleanupTerrainSurface()}};function cE(e,t){return null!=e&&et(e.spatialReference,t)?Je(e,t):null}e([Ce()],hE.prototype,"_userClippingArea",void 0),e([Ce()],hE.prototype,"_resourceController",void 0),e([Ce()],hE.prototype,"stage",null),e([Ce({readOnly:!0})],hE.prototype,"deconflictor",void 0),e([Ce({readOnly:!0})],hE.prototype,"labeler",void 0),e([Ce(We(Nt,"analyses"))],hE.prototype,"analyses",void 0),e([Ce({type:Yt,readOnly:!0})],hE.prototype,"animation",null),e([Ce({readOnly:!0})],hE.prototype,"basemapTerrain",void 0),e([Ce({readOnly:!0})],hE.prototype,"elevationProvider",void 0),e([Ce()],hE.prototype,"camera",null),e([Ce({type:t})],hE.prototype,"contentCamera",null),e([Ce({readOnly:!0})],hE.prototype,"canvas",null),e([Ce({type:Ze})],hE.prototype,"center",null),e([Ce({type:$e})],hE.prototype,"clippingArea",null),e([Ce({type:Hp})],hE.prototype,"constraints",void 0),e([Ce({type:$e,readOnly:!0})],hE.prototype,"renderDataExtent",null),e([Ce({readOnly:!0})],hE.prototype,"tileInfo",null),e([Ce({type:$e,readOnly:!0})],hE.prototype,"dataExtent",null),e([Ce({type:$e,readOnly:!0})],hE.prototype,"_groundAndLayersExtent",null),e([Ce({type:Vm})],hE.prototype,"environment",void 0),e([Te("environment")],hE.prototype,"castEnvironment",null),e([Ce({readOnly:!0})],hE.prototype,"environmentManager",void 0),e([Ce({type:$e})],hE.prototype,"extent",null),e([Ce({type:s})],hE.prototype,"floors",void 0),e([Ce()],hE.prototype,"screenCenter",null),e([Ce()],hE.prototype,"frustum",null),e([Ce({type:Number,readOnly:!0})],hE.prototype,"fullOpacity",void 0),e([Ce({readOnly:!0})],hE.prototype,"graphicsView",void 0),e([Ce({})],hE.prototype,"analysisViewManager",void 0),e([Ce()],hE.prototype,"groundView",void 0),e([Ce({type:Boolean})],hE.prototype,"initialExtentRequired",null),e([Ce()],hE.prototype,"defaultsFromMapSettings",null),e([Ce()],hE.prototype,"interacting",null),e([Ce()],hE.prototype,"stationary",null),e([Ce()],hE.prototype,"navigating",null),e([Ce()],hE.prototype,"map",void 0),e([Ce()],hE.prototype,"padding",null),e([Ce({type:uw,readOnly:!0})],hE.prototype,"pointsOfInterest",void 0),e([Ce()],hE.prototype,"_featureTiles",void 0),e([Ce()],hE.prototype,"featureTiles",null),e([Ce()],hE.prototype,"_featureTreeDebugger",void 0),e([Ce({type:Boolean})],hE.prototype,"screenSizePerspectiveEnabled",void 0),e([Ce({constructOnly:!0})],hE.prototype,"deactivatedWebGLExtensions",void 0),e([Ce({constructOnly:!0})],hE.prototype,"debugWebGLExtensions",void 0),e([Ce({constructOnly:!0})],hE.prototype,"renderCanvas",void 0),e([Ce({constructOnly:!0})],hE.prototype,"state",void 0),e([Ce({readOnly:!0})],hE.prototype,"inputManager",void 0),e([Ce({readOnly:!0})],hE.prototype,"stateManager",void 0),e([Ce({type:["low","medium","high"]})],hE.prototype,"qualityProfile",null),e([Ce({type:gb,get(){let e=this._get("qualitySettings");return e||(e=new gb,rb.apply(this.qualityProfile,e)),e}})],hE.prototype,"qualitySettings",void 0),e([Ce()],hE.prototype,"slice",void 0),e([Ce({readOnly:!0})],hE.prototype,"typeSpecificPreconditionsReady",null),e([Ce({readOnly:!0})],hE.prototype,"renderCoordsHelper",void 0),e([Ce({readOnly:!0})],hE.prototype,"sceneIntersectionHelper",void 0),e([Ce({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],hE.prototype,"resolution",null),e([Ce({type:Number})],hE.prototype,"scale",null),e([Ce()],hE.prototype,"heightModelInfo",null),e([Ce()],hE.prototype,"spatialReference",void 0),e([Ce({type:Boolean,constructOnly:!0})],hE.prototype,"alphaCompositingEnabled",void 0),e([Ce({constructOnly:!0})],hE.prototype,"preserveDrawingBufferEnabled",void 0),e([Ce({type:Boolean})],hE.prototype,"supersampleScreenshotsEnabled",void 0),e([Ce({readOnly:!0})],hE.prototype,"type",void 0),e([Ce(),Te(e=>e instanceof xp?e:Re(aE,e))],hE.prototype,"ui",void 0),e([Ce({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],hE.prototype,"updating",null),e([Ce()],hE.prototype,"_updatingObjects",null),e([Ce()],hE.prototype,"_updatingObjectsWithProgress",null),e([Ce({type:Number,readOnly:!0,dependsOn:["updating"]})],hE.prototype,"updatingProgress",void 0),e([Ce({type:["global","local"]})],hE.prototype,"viewingMode",null),e([Ce({type:i})],hE.prototype,"viewpoint",null),e([Ce({readOnly:!0})],hE.prototype,"visibleArea",null),e([Ce({type:Number})],hE.prototype,"zoom",null),e([Ce({type:_p})],hE.prototype,"highlightOptions",null),e([Ce({readOnly:!0})],hE.prototype,"quality",null),e([Ce({readOnly:!0})],hE.prototype,"resolutionScale",null),e([Ce()],hE.prototype,"focusAreasView",void 0),e([Ce()],hE.prototype,"_defaultToMapOptions",null),e([Ce()],hE.prototype,"_defaultHitTestOptions",null),hE=e([Se("esri.views.SceneView")],hE);const dE=ke(),uE=re(),pE=lt(),mE={GraphicsView3D:()=>import("../chunks/GraphicsView3D.js"),FocusAreasView:()=>import("../chunks/FocusAreasView.js"),FeatureTileTree3D:()=>import("../chunks/FeatureTileTree3D.js")},gE=hE;export{bR as B,AT as C,ix as D,tb as E,BM as G,Vv as I,ax as S,dR as T,vw as a,sf as b,NM as c,yb as d,gE as default,Lv as e,VT as f,rf as g,QM as h,ZM as i,fb as m,nf as r,Lx as t,bw as u};
