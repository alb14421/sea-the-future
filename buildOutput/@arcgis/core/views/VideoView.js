/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import s from"../Color.js";import i from"../Viewpoint.js";import e from"../core/Accessor.js";import{EventedMixin as o}from"../core/Evented.js";import{d as r}from"../chunks/maybe.js";import{EsriPromiseMixin as n}from"../core/Promise.js";import{watch as a,initial as p,whenOnce as m,syncAndInitial as c}from"../core/reactiveUtils.js";import{property as h}from"../core/accessorSupport/decorators/property.js";import{cast as u}from"../core/accessorSupport/decorators/cast.js";import"../core/lang.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import{b as j}from"../chunks/ensureType.js";import d from"../geometry/Extent.js";import k from"../geometry/Point.js";import y from"../geometry/SpatialReference.js";import{load as g,execute as f}from"../geometry/operators/projectOperator.js";import v from"../layers/support/ExtentAndRotationGeoreference.js";import{M as w}from"../chunks/MediaElementView.js";import b from"../layers/support/TileInfo.js";import S from"../layers/support/VideoElement.js";import{DOMContainer as _}from"./DOMContainer.js";import{a as C,V as U,b as V,M,c as x,A as D}from"../chunks/ManagedCanvas.js";import"../core/Error.js";import"../core/scheduling.js";import"../chunks/Logger.js";import"../chunks/mathUtils.js";import"../config.js";import"../chunks/floatRGBA.js";import"../geometry/Geometry.js";import"../geometry/Multipoint.js";import"../geometry/Polygon.js";import"../geometry/Polyline.js";import"../symbols/Font.js";import"../chunks/ObjectPool.js";import"../chunks/unitUtils.js";import"../chunks/CIMSymbolHelper.js";import"../chunks/vec2f32.js";import"../chunks/defaults.js";import"../chunks/OverrideHelper.js";import{C as z}from"../chunks/Container.js";import"../chunks/vec4f32.js";import"../chunks/WGLContainer.js";import"../chunks/Program.js";import"../chunks/Texture.js";import"../chunks/TiledDisplayObject.js";import"../chunks/BufferObject.js";import"../chunks/utils30.js";import"../chunks/util.js";import{M as T}from"../chunks/GridShader.js";import"../request.js";import"../core/urlUtils.js";import"../chunks/pbf.js";import"../chunks/FramebufferObject.js";import"../chunks/FeatureCommandQueue.js";import"../chunks/UpdateTracking2D.js";import"../chunks/TexturedLineMeshWriter.js";import"../chunks/aaBoundingBox.js";import"../chunks/UnknownTimeZone.js";import"../chunks/locale.js";import"../layers/support/fieldUtils.js";import"../chunks/constants.js";import"../chunks/renderState.js";import"../chunks/glsl.js";import"../chunks/testSVGPremultipliedAlpha.js";import"../chunks/DisplayObject.js";import"../chunks/GraphicsView2D.js";import"../chunks/earcut.js";import"../chunks/vec3f32.js";import"../chunks/normalizeUtilsCommon.js";import"../kernel.js";import"../chunks/asyncUtils.js";import"../chunks/UpdatingHandles.js";import"../chunks/pe.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import{O}from"../chunks/Overlay.js";import{O as R}from"../chunks/OverlayContainer.js";import E from"./navigation/Navigation.js";import P from"./ui/DefaultUI.js";import"../chunks/colorUtils.js";import"../chunks/object.js";import"../chunks/string.js";import"../chunks/MapUtils.js";import"../Camera.js";import"../CameraLayout.js";import"../core/Clonable.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../core/Handles.js";import"../chunks/get.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../chunks/SetUtils.js";import"../chunks/SimpleTrackingTarget.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../core/promiseUtils.js";import"../chunks/events.js";import"../chunks/Warning.js";import"../chunks/Cyclical.js";import"../core/JSONSupport.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../chunks/jsonMap.js";import"../chunks/assets.js";import"../chunks/jsonUtils.js";import"../chunks/persistableUrlUtils.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/support/jsonUtils.js";import"../chunks/zmUtils.js";import"../chunks/coordsUtils.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/typeUtils.js";import"../chunks/SimpleGeometryCursor.js";import"../chunks/screenUtils.js";import"../chunks/common.js";import"../chunks/projectionUtils.js";import"../chunks/SimpleObservable.js";import"../chunks/vec3f64.js";import"../chunks/projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/GeoreferenceBase.js";import"../chunks/normalizeUtilsSync.js";import"../layers/support/LOD.js";import"../chunks/TileKey.js";import"../chunks/sanitizerUtils.js";import"../layers/support/MediaElementBase.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../chunks/MultiOriginJSONSupport.js";import"../layers/support/ControlPointsGeoreference.js";import"../chunks/perspectiveUtils.js";import"../chunks/mat3.js";import"../chunks/mat3f64.js";import"../chunks/vec2.js";import"../chunks/vec3.js";import"../chunks/vec2f64.js";import"../layers/support/CornersGeoreference.js";import"../chunks/videoUtils.js";import"../chunks/mediaLayerUtils2.js";import"../chunks/domUtils.js";import"../core/Collection.js";import"../chunks/shared.js";import"../chunks/projector.js";import"../chunks/Scheduler.js";import"../chunks/signal.js";import"../chunks/debugFlags.js";import"../chunks/viewpointUtils.js";import"../chunks/mat2d.js";import"../chunks/mat2df64.js";import"../geometry/support/normalizeUtils.js";import"../chunks/simplify.js";import"../chunks/utils9.js";import"../chunks/utils10.js";import"../chunks/ViewEvents.js";import"../chunks/InputManager.js";import"../chunks/Queue.js";import"../chunks/a11yUtils.js";import"./ViewAnimation.js";import"../chunks/Animation.js";import"./input/gamepad/GamepadInputDevice.js";import"../chunks/screenUtils2.js";import"../chunks/easing.js";import"../chunks/unitBezier.js";import"./2d/ViewState.js";import"../chunks/mat2df32.js";import"../chunks/mat3f32.js";import"../chunks/BidiEngine.js";import"../chunks/labelPoint.js";import"../chunks/OptimizedGeometry.js";import"../chunks/memoryEstimations.js";import"../chunks/GeometryUtils.js";import"../chunks/utils6.js";import"../chunks/defaultCIMValues.js";import"../chunks/fontUtils.js";import"../chunks/rasterizingUtils.js";import"../chunks/definitions.js";import"../chunks/shapingUtils.js";import"../chunks/Rect.js";import"../chunks/BoundingBox.js";import"../symbols/SimpleFillSymbol.js";import"../chunks/enumeration.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/Symbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/TextSymbol.js";import"../chunks/defaultsJSON.js";import"../chunks/colorUtils2.js";import"../chunks/vec4.js";import"../chunks/vec4f64.js";import"../layers/support/FieldsIndex.js";import"../chunks/timeZoneUtils.js";import"../chunks/datetime.js";import"../core/sql.js";import"../chunks/guards.js";import"../chunks/ArcadeExpression.js";import"../chunks/TimeOnly.js";import"../chunks/enum.js";import"../chunks/callExpressionWithFeature.js";import"../chunks/quantizationUtils.js";import"../chunks/EffectView.js";import"../chunks/parser.js";import"../chunks/utils5.js";import"../chunks/mat4.js";import"../chunks/WGLBrushVTLSymbol.js";import"../chunks/enums.js";import"../chunks/VertexArrayObject.js";import"../chunks/VertexAttributeLocations.js";import"../chunks/VertexBuffer.js";import"../chunks/config.js";import"../chunks/ShaderCompiler.js";import"../chunks/ProgramTemplate.js";import"../chunks/featureConversionUtils.js";import"../chunks/OptimizedFeature.js";import"../chunks/OptimizedFeatureSet.js";import"../chunks/createFeatureId.js";import"../chunks/clippingUtils.js";import"../chunks/VertexElementDescriptor.js";import"../chunks/TileKey2.js";import"./support/HighlightOptions.js";import"../chunks/HighlightDefaults.js";import"../chunks/GraphShaderModule.js";import"../chunks/ShaderBuilder.js";import"../chunks/utils26.js";import"../chunks/constants4.js";import"../chunks/CircularArray.js";import"../chunks/SymbolFader.js";import"../chunks/SymbolRepository.js";import"../chunks/constants3.js";import"../chunks/TileStrategy.js";import"../chunks/ScheduledQueueProcessor.js";import"../chunks/ReactiveMap.js";import"../widgets/Compass/CompassViewModel.js";import"../chunks/utils24.js";import"../widgets/support/GoTo.js";import"../chunks/goToUtils.js";import"../chunks/ZoomMomentumEstimator.js";import"../chunks/heatmapTextureUtils.js";import"../chunks/lengthUtils.js";import"../chunks/streamLayerUtils.js";import"../chunks/capabilities2.js";import"../chunks/QueueProcessor.js";import"../chunks/libtess.js";import"../chunks/TurboLine.js";import"../chunks/DoubleArray.js";import"../chunks/ComputedAttributeStorage.js";import"../chunks/diffUtils.js";import"../chunks/queryUtils.js";import"../chunks/projectionSupport.js";import"../chunks/json.js";import"../chunks/timeSupport.js";import"../rest/support/Query.js";import"../chunks/DataLayerSource.js";import"../layers/support/Field.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/fieldType.js";import"../chunks/FullTextSearch.js";import"../chunks/spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../time/TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/date.js";import"../chunks/FeatureMetadata.js";import"../chunks/labelFormatUtils.js";import"../chunks/number.js";import"../chunks/labelUtils.js";import"../chunks/rbush.js";import"../chunks/quickselect.js";import"../chunks/ellipticArc7Utils.js";import"../chunks/dehydratedFeatures.js";import"../chunks/utils25.js";import"../chunks/grouping.js";import"../chunks/utils27.js";import"./navigation/NavigationActionMap.js";import"./navigation/gamepad/GamepadSettings.js";import"./ui/UI.js";import"../intl.js";import"../chunks/substitute.js";import"../chunks/messages.js";import"../chunks/modeUtils.js";import"../chunks/widgetUtils.js";import"../widgets/Attribution.js";import"../widgets/Widget.js";import"../chunks/uuid.js";import"../chunks/componentsUtils.js";import"../chunks/jsxWidgetSupport.js";import"../widgets/Attribution/AttributionViewModel.js";import"../chunks/globalCss.js";import"../chunks/accessibleHandler.js";import"../chunks/messageBundle.js";import"../chunks/jsxFactory.js";import"../widgets/Compass.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";let G=class extends P{constructor(t){super(t),this.components=["zoom"]}};t([h()],G.prototype,"components",void 0),G=t([l("esri.views.ui.video.DefaultUIVideo")],G);const A=G,F=new s("#000");let L;const B=.01,H=["feature","geojson","csv","stream","ogc-feature","catalog","wfs","parquet","graphics","group"];let I=class extends e{};I=t([l("esri.views.VideoView.Base")],I);let Z=class extends(C(U(_(o(n(I)))))){constructor(t){super(t),this._isValid=!1,this._prevZoomEnabled=!1,this._prevRotationEnabled=!1,this.stage=null,this.childStage=null,this._operationalDataView=null,this.operationalDataVisible=!1,this.layer=null,this.map=null,this.navigation=new E,this.ready=!1,this.spatialReference=new y({wkid:0}),this.stateManager=new V({constraints:new M({view:this,minScale:1,maxScale:B})}),this.type="2d",this.ui=new A,this.view2dType="video",this.addHandles([a(()=>this.preconditionsReady,t=>t?this._startup():this._teardown()),a(()=>this.layer,()=>this.addResolvingPromise(m(()=>this.ready)),p),a(()=>this.videoSize,([t,s])=>{this._extent&&t&&s&&(this._extent.xmax=t,this._extent.ymax=s)}),a(()=>this.size,t=>{this._operationalDataView&&this._operationalDataView.stateManager.resize(t[0],t[1])}),a(()=>[this.layer?.frameEffect,this._effectsContainer],()=>{this._effectsContainer&&(this._effectsContainer.effect=this.layer?.frameEffect??null)},c)])}initialize(){this._prevZoomEnabled="zoom"===this.navigation.actionMap.mouseWheel&&this.ui.components.includes("zoom"),this._prevRotationEnabled="rotate"===this.navigation.actionMap.dragSecondary&&this.ui.components.includes("compass"),this.addHandles([a(()=>[this.operationalDataVisible,this.childStage],()=>{this.childStage&&(this.childStage.videoScreenRenderer.visible=this.operationalDataVisible),this.operationalDataVisible&&(this.scale=1,this.rotation=0),this.navigation&&(this._prevZoomEnabled&&(this.navigation.actionMap.mouseWheel=this.operationalDataVisible?"none":"zoom",this.navigation.actionMap.dragPrimary=this.operationalDataVisible?"none":"pan",this.ui.components&&(this.ui.components=this.operationalDataVisible?this.ui.components.filter(t=>"zoom"!==t):[...new Set([...this.ui.components,"zoom"])])),this._prevRotationEnabled&&(this.navigation.actionMap.dragSecondary=this.operationalDataVisible?"none":"rotate",this.ui.components&&(this.ui.components=this.operationalDataVisible?this.ui.components.filter(t=>"compass"!==t):[...new Set([...this.ui.components,"compass"])])))},c)]),this.addResolvingPromise(async function(){const[,{ParentStage:t}]=await Promise.all([import("../chunks/webglDeps.js"),import("../chunks/mapViewDeps.js")]);L=t}().then(()=>(this._isValid=!0,m(()=>this.ready))))}destroy(){this._teardown(),this.removeAllHandles(),this._set("preconditionsReady",!1),this.frameTask=r(this.frameTask),this.goToManager.destroy(),this.inputManager.destroy(),this._set("inputManager",null)}get constraintsInfo(){return{lods:null,spatialReference:this.spatialReference}}get preconditionsReady(){return!(!this._isValid||0===this.width||0===this.height||0===this.videoSize[0]||0===this.videoSize[1])}get rendering(){return this.stage?.renderRequested??!1}get scale(){return this.stateManager?.scale??0}set scale(t){this.stateManager&&(this.stateManager.scale=t)}get videoSize(){if(!this.layer?.videoWidth||!this.layer?.videoHeight)return[0,0];const[t,s]=this.size,i=(this.layer?.videoWidth||0)/(this.layer?.videoHeight||0),e=s*i,o=t/i;return t/s>=1?i>=1?e<=t?[e,s]:[t,o]:o<=s?[t,o]:[e,s]:i>=1?o<=s?[t,o]:[e,s]:e<=t?[e,s]:[t,o]}async hitTest(t,s){return this._operationalDataView&&this._operationalDataView.ready?this._operationalDataView.hitTest(t,s):{screenPoint:t,results:[]}}_startup(){if(!this.layer)return;const t=this._getViewpoint();this.stateManager.startup(t,this.size,t.targetGeometry.spatialReference);const s={renderingOptions:this.renderingOptions,backgroundColor:F,groundControlPoints:()=>this.layer?.groundControlPoints,getSize:()=>this.videoSize},i=new L(this.surface,s,new x(this.surface));this.stage=i,this._prepareStage(this.stage),this.childStage=i.childStage,this._prepareChildStage(this.childStage);const e=new D({view:this});this._set("animationManager",e);const o=new T({view:this,animationManager:e});this._set("mapViewNavigation",o),this._updateConstraints(),this.frameTask.start(),this._set("ready",!0)}_teardown(){this.stage.destroy(),this.stage=null,this._videoElementView=null,this._overlayContainer.removeAllChildren(),this._overlayContainer=null,this.removeHandles("video-view"),this._set("ready",!1),this.stateManager.teardown(),this.frameTask.stop(),this.stationaryManager.clear()}_getViewpoint(){return new i({targetGeometry:new k({x:this.videoSize[0]/2,y:this.videoSize[1]/2,spatialReference:this.spatialReference}),scale:1})}_prepareStage(t){this.addHandles([a(()=>this.stationary,s=>t.stationary=s,c),a(()=>this.state.id,()=>t.state=this.state,c),a(()=>this.renderingOptions,s=>t.renderingOptions=s,c)],"video-view"),this._extent=new d({xmin:0,ymin:0,xmax:this.videoSize[0],ymax:this.videoSize[1],spatialReference:{wkid:0}}),this._videoElementView=new w({element:new S({video:this.layer?.videoElement,georeference:new v({extent:this._extent}),autoplay:!1}),spatialReference:this.spatialReference});const s=new O(this._videoElementView);this._overlayContainer=new R,this._overlayContainer.addChild(s),this._effectsContainer=new z,this._effectsContainer.addChild(this._overlayContainer),this.stage.addChild(this._effectsContainer);const i=document.createElement("div");i.classList.add("esri-video-poster"),this.container?.classList.add("esri-video-view"),this.container?.appendChild(i)}_prepareChildStage(t){this.addHandles([a(()=>this.map,async s=>{if(!s)return;const{default:i}=await import("../chunks/VideoOperationalDataView.js");this._operationalDataView=new i({stage:t,layerViewFilter:t=>new Set(H).has(t.type),width:this.size[0],height:this.size[1],map:s}),m(()=>this._operationalDataView?.ready).then(()=>{t.videoScreenRenderer.visible=this.operationalDataVisible})},c),a(()=>this.layer?.groundControlPoints,async()=>{if(!this.layer?.groundControlPoints||!t.state)return;const s=this.layer.groundControlPoints,i=s?.length;if(!i)return;await g();const e=new Array(i),o=t.state.spatialReference;for(let t=0;t<i;t++){const{lat:i,lon:r}=s[t];e[t]=f(new k(r,i),o)}let r=1/0,n=1/0,a=-1/0,p=-1/0;for(const t of e)r=Math.min(r,t.x),n=Math.min(n,t.y),a=Math.max(a,t.x),p=Math.max(p,t.y);const m=d.fromJSON({xmin:r,ymin:n,xmax:a,ymax:p,spatialReference:o});await(this._operationalDataView?.goTo(m,{animate:!1}).catch(()=>{}))},c)])}_updateConstraints(){this._updateZoomConstraints(),this._updatePanConstraints()}_updateZoomConstraints(){const t=this.videoSize,s=Math.max(t[0]/this.size[0],t[1]/this.size[1]),i=[];for(let t=s;t>B;t/=2)i.push(t);i.push(B);const{lods:e}=b.create({scales:i});this.constraints.set({lods:e,minScale:s})}_updatePanConstraints(){const t=t=>{if(!t.targetGeometry)return t;const[s,i]=this.videoSize,e=s*t.scale/2,o=i*t.scale/2,r=t.targetGeometry.clone();return r.x=Math.max(e,Math.min(s-e,r.x)),r.y=Math.max(o,Math.min(i-o,r.y)),t.targetGeometry=r,t};this.constraints.customConstraints.add({constrain:t,applyPanConstraint:t})}};t([h()],Z.prototype,"_overlayContainer",void 0),t([h()],Z.prototype,"_isValid",void 0),t([h()],Z.prototype,"_effectsContainer",void 0),t([h()],Z.prototype,"constraintsInfo",null),t([h()],Z.prototype,"operationalDataVisible",void 0),t([h()],Z.prototype,"layer",void 0),t([h()],Z.prototype,"map",void 0),t([h({type:E,nonNullable:!0})],Z.prototype,"navigation",void 0),t([h({readOnly:!0})],Z.prototype,"preconditionsReady",null),t([h({readOnly:!0})],Z.prototype,"ready",void 0),t([h({readOnly:!0})],Z.prototype,"rendering",null),t([h()],Z.prototype,"scale",null),t([h()],Z.prototype,"spatialReference",void 0),t([h()],Z.prototype,"stateManager",void 0),t([h()],Z.prototype,"type",void 0),t([h(),u(t=>t instanceof P?t:j(A,t))],Z.prototype,"ui",void 0),t([h({readOnly:!0})],Z.prototype,"videoSize",null),t([h({readOnly:!0})],Z.prototype,"view2dType",void 0),Z=t([l("esri.views.VideoView")],Z);const N=Z;export{N as default};
