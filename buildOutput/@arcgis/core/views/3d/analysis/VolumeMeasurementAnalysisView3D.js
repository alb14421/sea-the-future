/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import e from"../../../core/Accessor.js";import{d as s}from"../../../chunks/maybe.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/lang.js";import{L as i}from"../../../chunks/Logger.js";import{subclass as r}from"../../../core/accessorSupport/decorators/subclass.js";import{A as n}from"../../../chunks/AnalysisView3D.js";import{syncAndInitial as p,watch as a,initial as l}from"../../../core/reactiveUtils.js";import{U as m}from"../../../chunks/UpdatingHandles.js";import{projectOrLoad as c}from"../../../chunks/projectionUtils.js";import{p as u}from"../../../chunks/projectBoundingRect.js";import{c as h,w as j,k as y,a as d,e as g,d as k,l as b}from"../../../chunks/aaBoundingRect.js";import{l as f,L as v}from"../../../chunks/LineVisualElement.js";import{k as C}from"../../../chunks/vec3.js";import{c as w}from"../../../chunks/vec3f64.js";import{v as S}from"../../../chunks/coordinateSystem.js";import{g as _}from"../../../chunks/ElevationProvider.js";import V from"../../../Color.js";import{O as G}from"../../../chunks/OutlineVisualElement.js";import{G as D}from"../../../chunks/Segment.js";import{c as P}from"../../../chunks/lineStippleUtils.js";import"../../../core/Handles.js";import"../../../chunks/get.js";import"../../../chunks/utils.js";import"../../../chunks/handleUtils.js";import"../../../chunks/Lifecycle.js";import"../../../chunks/metadata.js";import"../../../chunks/ObjectPool.js";import"../../../chunks/ObservableBase.js";import"../../../chunks/tracking.js";import"../../../chunks/watch.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../chunks/PooledArray.js";import"../../../core/promiseUtils.js";import"../../../core/Error.js";import"../../../chunks/object.js";import"../../../config.js";import"../../../chunks/string.js";import"../../../chunks/events.js";import"../../../chunks/SetUtils.js";import"../../../chunks/SimpleTrackingTarget.js";import"../../../chunks/ensureType.js";import"../../../chunks/MapUtils.js";import"../../../chunks/Warning.js";import"../../../core/Promise.js";import"../../../chunks/SimpleObservable.js";import"../../../geometry/support/webMercatorUtils.js";import"../../../geometry/SpatialReference.js";import"../../../core/JSONSupport.js";import"../../../chunks/unitUtils.js";import"../../../chunks/jsonMap.js";import"../../../chunks/pe.js";import"../../../chunks/assets.js";import"../../../request.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../chunks/jsonUtils.js";import"../../../chunks/persistableUrlUtils.js";import"../../../chunks/writer.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../chunks/reader.js";import"../../../geometry/Point.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polygon.js";import"../../../chunks/coordsUtils.js";import"../../../chunks/extentUtils.js";import"../../../chunks/boundsUtils.js";import"../../../chunks/mathUtils.js";import"../../../geometry/Polyline.js";import"../../../chunks/projectBuffer.js";import"../../../chunks/geodesicConstants.js";import"../../../chunks/projectXYZToVector.js";import"../../../geometry/support/GeographicTransformation.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../chunks/zscale.js";import"../../../chunks/mat4.js";import"../../../chunks/common.js";import"../../../chunks/mat4f64.js";import"../../../chunks/vec4f64.js";import"../../../chunks/VisualElement.js";import"../../../chunks/RibbonLineMaterial.js";import"../../../chunks/sphere.js";import"../../../chunks/vec4.js";import"../../../chunks/ray.js";import"../../../chunks/mat3.js";import"../../../chunks/mat3f64.js";import"../../../chunks/vector.js";import"../../../chunks/quatf64.js";import"../../../chunks/vec2f64.js";import"../../../chunks/mathUtils2.js";import"../../../chunks/Matrix4PassUniform.js";import"../../../chunks/Indices.js";import"../../../chunks/BufferView.js";import"../../../chunks/vec2.js";import"../../../chunks/triangle.js";import"../../../chunks/lineSegment.js";import"../../../chunks/Texture.js";import"../../../chunks/enums.js";import"../../../chunks/boundedPlane.js";import"../../../chunks/plane.js";import"../../../chunks/Emissions.glsl.js";import"../../../chunks/glsl.js";import"../../../chunks/colorUtils.js";import"../../../chunks/lengthUtils.js";import"../../../chunks/guards.js";import"../../../chunks/debugFlags2.js";import"../../../core/Evented.js";import"../../../chunks/videoUtils.js";import"../../../chunks/requestImageUtils.js";import"../../../chunks/AlphaCutoff.js";import"../../../chunks/renderState.js";import"../../../chunks/Octree.js";import"../../../chunks/frustum.js";import"../../../chunks/screenUtils.js";import"../../../chunks/sdfPrimitives.js";import"../../../chunks/floatRGBA.js";import"../../../chunks/ShaderBuilder.js";import"../../../chunks/InterleavedLayout.js";import"../../../chunks/types.js";import"../../../chunks/VertexElementDescriptor.js";import"../../../chunks/VertexAttributeLocations.js";import"../../../chunks/line.js";import"../../../chunks/DoubleArray.js";import"../../../chunks/orientedBoundingBox.js";import"../../../chunks/quat.js";import"../../../chunks/spatialReferenceEllipsoidUtils.js";import"../../../chunks/computeTranslationToOriginAndRotation.js";import"../../../chunks/dehydratedFeatureUtils.js";import"../../../chunks/aaBoundingBox.js";import"../../../chunks/dehydratedPoint.js";import"../../../chunks/elevationInfoUtils.js";import"../../../chunks/unitConversionUtils.js";import"../../../symbols/support/ElevationInfo.js";import"../../../core/Clonable.js";import"../../../symbols/support/FeatureExpressionInfo.js";import"../../../layers/support/fieldUtils.js";import"../../../core/sql.js";import"../../../chunks/datetime.js";import"../../../chunks/EngineVisualElement.js";import"../../../core/Identifiable.js";import"../../../chunks/LaserlineVisualElement.js";import"../webgl.js";import"../../../Camera.js";import"../../../CameraLayout.js";import"../../../chunks/Cyclical.js";import"../../../chunks/projectPointToVector.js";import"../../../chunks/projectVectorToVector.js";import"../webgl/RenderCamera.js";import"../../../chunks/Intersector2.js";import"../../../chunks/HUDIntersectorResult.js";import"../../../chunks/earthUtils.js";import"../webgl/RenderNode.js";import"../../../chunks/BlendColorsPremultiplied.glsl.js";import"../../../chunks/CameraSpace.glsl.js";import"../../../chunks/VertexArrayObject2.js";import"../../../chunks/VertexArrayObject.js";import"../../../chunks/memoryEstimations.js";import"../../../chunks/VertexBuffer.js";import"../../../chunks/BufferObject.js";import"../../../chunks/ElevationContext.js";import"../../../chunks/hydratedFeatures.js";import"../../../Graphic.js";import"../../../PopupTemplate.js";import"../../../core/Collection.js";import"../../../chunks/shared.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/support/AttachmentsOrderByInfo.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../chunks/enumeration.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../chunks/date.js";import"../../../chunks/locale.js";import"../../../chunks/constants.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/content/UtilityNetworkAssociationsContent.js";import"../../../popup/support/UtilityNetworkAssociationType.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../../geometry/support/jsonUtils.js";import"../../../chunks/typeUtils.js";import"../../../chunks/createFeatureId.js";import"../../../chunks/typeUtils2.js";import"../../../symbols/CIMSymbol.js";import"../../../symbols/Symbol.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../portal/Portal.js";import"../../../core/Loadable.js";import"../../../portal/PortalGroup.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils3.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/materialUtils.js";import"../../../chunks/opacityUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils4.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/Font.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/SimpleLineSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/SimpleFillSymbol.js";import"../../../symbols/SimpleMarkerSymbol.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../../chunks/line2.js";import"../../../chunks/triangulationUtils.js";import"../../../chunks/earcut.js";import"../../../chunks/deduplicate.js";import"../../../chunks/RenderGeometry.js";import"../../../chunks/GridLocalOriginFactory.js";import"../../../chunks/SceneLighting.js";import"../../../chunks/HighlightDefaults.js";import"../../../chunks/NestedMap.js";import"../../../chunks/signal.js";import"../../../chunks/axisAngleDegrees.js";import"../../../chunks/weather.js";import"../environment/CloudyWeather.js";import"../environment/FoggyWeather.js";import"../environment/RainyWeather.js";import"../environment/SnowyWeather.js";import"../environment/SunnyWeather.js";import"../../../chunks/Scheduler.js";import"../../../chunks/debugFlags.js";let x=class extends e{constructor(t){super(t)}get cameraPositionRenderSpace(){const{extent:t,renderCoordsHelper:e}=this,s=w();return e.toRenderCoords(t.center,s),e.setAltitude(s,A),s}get cameraDimensions(){const{extent:t}=this,e=h();return this._expandBoundingRect(t.xmin,t.ymin,e),this._expandBoundingRect(t.xmax,t.ymin,e),this._expandBoundingRect(t.xmin,t.ymax,e),this._expandBoundingRect(t.xmax,t.ymax,e),{width:j(e),height:y(e)}}get cameraNearFar(){return{near:R,far:E}}get upVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,2,w())}get northVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,1,w())}get eastVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,0,w())}_expandBoundingRect(t,e,s){const{extent:o,eastVector:i,northVector:r,upVector:n,renderCoordsHelper:p}=this,a=o.center.z??0;C(L,t,e,a),p.toRenderCoords(L,o.spatialReference,L),S(L,i,r,n,U),d(s,U,s)}};t([o()],x.prototype,"renderCoordsHelper",void 0),t([o()],x.prototype,"extent",void 0),t([o()],x.prototype,"cameraPositionRenderSpace",null),t([o()],x.prototype,"cameraDimensions",null),t([o()],x.prototype,"upVector",null),t([o()],x.prototype,"northVector",null),t([o()],x.prototype,"eastVector",null),x=t([r("esri.views.3d.analysis.VolumeMeasurement.CutFillVolumeMeasurementComputation")],x);const L=w(),U=w(),A=9e3,R=0,E=2e4;let M=class extends e{constructor(t){super(t),this._updatingHandles=new m,this._computation=null}initialize(){this._updatingHandles.add(()=>({geometry:this.analysis.geometry,projectedGeometry:c(this.analysis.geometry,this.view.spatialReference)}),({geometry:t,projectedGeometry:e})=>{null==e.pending?this._onGeometryChange(t,e.geometry):this._updatingHandles.addPromise(e.pending)},p),this.addHandles([this._createElevationUpdateHandle(),a(()=>[this.analysis.measureType,this.analysisViewData.elevationAlignedGeometry,this.analysisViewData.effectiveTargetElevation],()=>this._updateTargetGeometry()),a(()=>this.analysisViewData.elevationAlignedGeometry?.extent,t=>{t?this._updateComputation(t):this._removeComputation()},l)])}destroy(){this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}_createComputation(t){const{renderCoordsHelper:e}=this.view;this._computation=new x({extent:t,renderCoordsHelper:e})}_updateComputation(t){this._computation?this._computation.extent=t:this._createComputation(t)}_removeComputation(){this._computation=null}_createElevationUpdateHandle(){const t=e=>{const s=this.analysis.geometry;if(null==s)return;const o=c(s,this.view.spatialReference);if(null!=o.pending)return this._updatingHandles.addPromise(o.pending),void o.pending.finally(()=>t(e));const i=o.geometry;null!=i&&null!=i.extent&&(u(e.extent,e.spatialReference,O,this.view.spatialReference),k(i.extent,I),b(O,I)&&this._onGeometryChange(s,i))};return this.view.elevationProvider.on("elevation-change",e=>t(e))}_onGeometryChange(t,e){const{elevationProvider:s}=this.view,{valid:o}=this.analysis;if(null==t||!o)return void(this.analysisViewData.elevationAlignedGeometry=null);if(null==e)return f(this.analysis,t.spatialReference,i.getLogger(this)),void(this.analysisViewData.elevationAlignedGeometry=null);const r=e.clone();!function(t,e){e.rings[0].forEach(e=>{e[2]=_(t,e,"ground")??0})}(s,r),this.analysisViewData.elevationAlignedGeometry=r}_updateTargetGeometry(){const{measureType:t}=this.analysis,{elevationAlignedGeometry:e,effectiveTargetElevation:s}=this.analysisViewData;if(!e)return void(this.analysisViewData.targetGeometry=null);if("stockpile"===t||!s)return void(this.analysisViewData.targetGeometry=e);const o=e.clone();o.rings[0].forEach(t=>{t[2]=s}),this.analysisViewData.targetGeometry=o}};t([o({constructOnly:!0})],M.prototype,"analysis",void 0),t([o({constructOnly:!0})],M.prototype,"analysisViewData",void 0),t([o({constructOnly:!0})],M.prototype,"view",void 0),t([o()],M.prototype,"updating",null),t([o({readOnly:!0})],M.prototype,"_updatingHandles",void 0),t([o()],M.prototype,"_computation",void 0),M=t([r("esri.views.3d.analysis.VolumeMeasurement.CutFillVolumeMeasurementController")],M);const O=g(),I=g(),B=new V("black"),T=new class{constructor(){this.geometryOutlineWidth=1.5,this.targetGeometryOutlineColor=new V("grey"),this.cutColor=new V([153,198,111,.9]),this.fillColor=new V([200,200,230,.8]),this.cutProjectionLineColor=V.blendColors(this.cutColor,B,.4),this.fillProjectionLineColor=V.blendColors(this.fillColor,B,.4),this.projectionLineWidth=2,this.projectionLineStippleSize=4}};let F=class extends e{get visible(){return this.analysisViewData.visible&&null!=this.analysisViewData.elevationAlignedGeometry&&null!=this.analysisViewData.targetGeometry}constructor(t){super(t)}initialize(){const{accentColor:t}=this.view.effectiveTheme,e={view:this.view,isDecoration:!0},s=T,o={...e,width:s.geometryOutlineWidth},i=V.toUnitRGBA(t),r=V.toUnitRGBA(s.targetGeometryOutlineColor);this._elevationAlignedGeometry=new G({...o,isDraped:!0,color:i}),this._targetGeometry=new G({...o,color:r});const n={...e,attached:!0,width:s.projectionLineWidth,stipplePattern:P(s.projectionLineStippleSize),renderOccluded:4},p=V.toUnitRGBA(s.cutProjectionLineColor),l=V.toUnitRGBA(s.fillProjectionLineColor);this._cutProjectionLines=new v({...n,color:p}),this._fillProjectionLines=new v({...n,color:l}),this.addHandles([a(()=>[this.analysisViewData.elevationAlignedGeometry,this.analysisViewData.targetGeometry,this.visible],()=>this._updateVisualElements()),a(()=>this.view.effectiveTheme.accentColor,t=>{this._elevationAlignedGeometry.color=V.toUnitRGBA(t)})])}destroy(){this._elevationAlignedGeometry=s(this._elevationAlignedGeometry),this._targetGeometry=s(this._targetGeometry),this._cutProjectionLines=s(this._cutProjectionLines),this._fillProjectionLines=s(this._fillProjectionLines)}_updateVisualElements(){this._updateGeometries(),this._updateProjectionLines()}_updateGeometries(){const t=this.visible,{elevationAlignedGeometry:e,targetGeometry:s}=this.analysisViewData;this._elevationAlignedGeometry.geometry=e,this._elevationAlignedGeometry.visible=t,this._targetGeometry.geometry=s,this._targetGeometry.visible=t}_updateProjectionLines(){const t=this.visible,{elevationAlignedGeometry:e,targetGeometry:s}=this.analysisViewData;if(this._cutProjectionLines.visible=t,this._fillProjectionLines.visible=t,!e||!s)return;const{renderCoordsHelper:o}=this.view,i=o.spatialReference,r=[],n=[],p=e.spatialReference;for(let t=0;t<e.rings[0].length;++t){const a=e.rings[0][t],l=C(H,a[0],a[1],a[2]);o.toRenderCoords(l,p,l);const m=s.rings[0][t],c=C(z,m[0],m[1],m[2]);o.toRenderCoords(c,p,c);const u=new D(l,c,i);l[2]>c[2]?r.push(u):n.push(u)}this._cutProjectionLines.setGeometryFromSegments(r),this._fillProjectionLines.setGeometryFromSegments(n)}};t([o({constructOnly:!0})],F.prototype,"view",void 0),t([o({constructOnly:!0})],F.prototype,"analysisViewData",void 0),t([o({readOnly:!0})],F.prototype,"visible",null),F=t([r("esri.views.3d.analysis.VolumeMeasurement.CutFillVolumeMeasurementVisualization")],F);const H=w(),z=w();let W=class extends(n(e)){constructor(t){super(t),this.type="volume-measurement-view-3d",this.analysis=null,this.elevationAlignedGeometry=null,this.targetGeometry=null,this.tool=null}initialize(){const{analysis:t,view:e}=this;this._analysisController=new M({view:e,analysis:t,analysisViewData:this}),this._analysisVisualization=new F({view:e,analysisViewData:this})}destroy(){this._analysisController=s(this._analysisController),this._analysisVisualization=s(this._analysisVisualization)}get result(){return null}get effectiveTargetElevation(){const{targetElevation:t}=this.analysis.cutFillOptions;if(null!=t)return t;const e=this.elevationAlignedGeometry?.extent;return e&&e.zmin&&e.zmax?(e.zmax+e.zmin)/2:null}get updating(){return null!=this._analysisController&&this._analysisController.updating}};t([o({readOnly:!0})],W.prototype,"type",void 0),t([o({constructOnly:!0,nonNullable:!0})],W.prototype,"analysis",void 0),t([o()],W.prototype,"result",null),t([o()],W.prototype,"elevationAlignedGeometry",void 0),t([o({type:Number})],W.prototype,"effectiveTargetElevation",null),t([o()],W.prototype,"targetGeometry",void 0),t([o()],W.prototype,"updating",null),W=t([r("esri.views.3d.analysis.VolumeMeasurementAnalysisView3D")],W);const N=W;export{N as default};
