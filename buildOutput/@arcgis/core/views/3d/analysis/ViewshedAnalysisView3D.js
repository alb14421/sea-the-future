/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import{g as t,u as i}from"../../../chunks/featureReferenceUtils.js";import s from"../../../core/Accessor.js";import{i as o,equals as r,h as a}from"../../../core/lang.js";import{L as n}from"../../../chunks/Logger.js";import{m as l}from"../../../chunks/mapCollectionUtils.js";import{d as c,a as h,c as d,f as p}from"../../../chunks/maybe.js";import{watch as u,initial as m,syncAndInitial as v,when as w,sync as f}from"../../../core/reactiveUtils.js";import{property as g}from"../../../core/accessorSupport/decorators/property.js";import{subclass as _}from"../../../core/accessorSupport/decorators/subclass.js";import{n as b,e as V,f as y,d as j,s as M,j as S,i as D,t as k,k as O,b as T,a as x,v as C,c as R,x as P,g as F}from"../../../chunks/vec3.js";import{c as A,f as E,b as U,a as H,z}from"../../../chunks/vec3f64.js";import{tryProjectWithZConversion as L,canProjectWithoutEngine as I,isLoaded as B,projectOrLoad as W}from"../../../chunks/projectionUtils.js";import{p as N}from"../../../chunks/projectBoundingRect.js";import{e as G,A as q}from"../../../chunks/aaBoundingRect.js";import{A as Q}from"../../../chunks/AnalysisView3D.js";import{O as X,L as K,l as Y}from"../../../chunks/LineVisualElement.js";import{h as J,m as Z,d as $}from"../../../chunks/handleUtils.js";import ee from"../../../Color.js";import{e as te,r as ie,c as se}from"../../../chunks/mathUtils.js";import{a as oe,E as re,z as ae,x as ne,B as le,m as ce,l as he,y as de,v as pe,q as ue,k as me}from"../../../chunks/mat4.js";import{c as ve,I as we}from"../../../chunks/mat4f64.js";import fe from"../../../analysis/Viewshed.js";import ge from"../../../geometry/Point.js";import{g as _e,f as be,c as Ve,p as ye}from"../../../chunks/plane.js";import{c as je}from"../../../chunks/asyncUtils.js";import{c as Me,C as Se}from"../../../chunks/Cyclical.js";import{after as De,throwIfAborted as ke}from"../../../core/promiseUtils.js";import{v as Oe}from"../../../chunks/ViewingMode.js";import Te from"../../../core/Handles.js";import{f as xe}from"../../../chunks/boundedPlane.js";import{c as Ce,a as Re,R as Pe,M as Fe,b as Ae}from"../../../chunks/RenderObject.js";import{s as Ee,d as Ue}from"../../../chunks/dragEventPipeline3D.js";import{h as He}from"../../../chunks/cameraUtils.js";import{a as ze,InternalRenderCategory as Le}from"../webgl.js";import{I as Ie,d as Be,a as We,M as Ne}from"../../../chunks/MoveManipulation.js";import{c as Ge,p as qe,o as Qe,b as Xe}from"../../../chunks/graphicUtils.js";import{D as Ke}from"../../../chunks/BufferView.js";import{R as Ye}from"../../../chunks/RibbonLineMaterial.js";import{c as Je,b as Ze,g as $e,d as et}from"../../../chunks/dragEventPipeline.js";import{b as tt}from"../../../chunks/ray.js";import{m as it}from"../../../chunks/sliceToolConfig.js";import{C as st}from"../../../chunks/ColorMaterial.js";import"../../../chunks/Warning.js";import"../../../core/Error.js";import{E as ot}from"../../../chunks/EditGeometryOperations.js";import{S as rt}from"../../../chunks/settings2.js";import{E as at}from"../../../chunks/ExtendedLineVisualElement.js";import{L as nt}from"../../../chunks/LaserlineVisualElement.js";import{t as lt}from"../../../chunks/intersectorUtilsConversions.js";import{A as ct,c as ht,r as dt,s as pt}from"../../../chunks/analysisViewUtils.js";import{s as ut}from"../../../chunks/keybindings.js";import{n as mt}from"../../../chunks/ToolIntersector.js";import{b as vt}from"../../../chunks/screenUtils2.js";import{P as wt}from"../../../chunks/PointVisualElement.js";import{A as ft}from"../../../chunks/orientedBoundingBox.js";import{G as gt,au as _t,N as bt,ai as Vt,_ as yt,at as jt,g as Mt,E as St,as as Dt,k as kt,R as Ot}from"../../../chunks/Matrix4PassUniform.js";import{c as Tt}from"../../../chunks/lineStippleUtils.js";import{I as xt}from"../../../chunks/Intersector2.js";import Ct from"../../../core/Collection.js";import{h as Rt}from"../../../chunks/sphere.js";import Pt from"../webgl/RenderNode.js";import{c as Ft,d as At}from"../../../chunks/vec4f64.js";import Et from"../webgl/RenderCamera.js";import{d as Ut,e as Ht}from"../../../chunks/enums.js";import{i as zt}from"../../../chunks/Texture.js";import{C as Lt,S as It,F as Bt,P as Wt}from"../../../chunks/CameraSpace.glsl.js";import{g as Nt}from"../../../chunks/glsl.js";import{d as Gt,F as qt,T as Qt}from"../../../chunks/Emissions.glsl.js";import{I as Xt}from"../../../chunks/SceneLighting.js";import{M as Kt}from"../../../chunks/Matrix4sPassUniform.js";import{S as Yt}from"../../../chunks/ShaderBuilder.js";import{m as Jt,u as Zt,d as $t}from"../../../chunks/renderState.js";import"../../../chunks/get.js";import"../../../chunks/utils.js";import"../../../chunks/Lifecycle.js";import"../../../chunks/metadata.js";import"../../../chunks/ObjectPool.js";import"../../../chunks/ObservableBase.js";import"../../../chunks/tracking.js";import"../../../chunks/watch.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../chunks/PooledArray.js";import"../../../config.js";import"../../../chunks/object.js";import"../../../chunks/string.js";import"../../../chunks/events.js";import"../../../chunks/SetUtils.js";import"../../../chunks/SimpleTrackingTarget.js";import"../../../chunks/ensureType.js";import"../../../chunks/MapUtils.js";import"../../../chunks/common.js";import"../../../chunks/SimpleObservable.js";import"../../../geometry/support/webMercatorUtils.js";import"../../../geometry/SpatialReference.js";import"../../../core/JSONSupport.js";import"../../../chunks/unitUtils.js";import"../../../chunks/jsonMap.js";import"../../../chunks/pe.js";import"../../../chunks/assets.js";import"../../../request.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../chunks/jsonUtils.js";import"../../../chunks/persistableUrlUtils.js";import"../../../chunks/writer.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../chunks/reader.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polygon.js";import"../../../chunks/coordsUtils.js";import"../../../chunks/extentUtils.js";import"../../../chunks/boundsUtils.js";import"../../../geometry/Polyline.js";import"../../../chunks/projectBuffer.js";import"../../../chunks/geodesicConstants.js";import"../../../chunks/projectXYZToVector.js";import"../../../geometry/support/GeographicTransformation.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../chunks/zscale.js";import"../../../core/Promise.js";import"../../../chunks/ElevationProvider.js";import"../../../chunks/dehydratedFeatureUtils.js";import"../../../chunks/VisualElement.js";import"../../../chunks/line.js";import"../../../chunks/vec2.js";import"../../../chunks/vec2f64.js";import"../../../chunks/DoubleArray.js";import"../../../chunks/Indices.js";import"../../../chunks/colorUtils.js";import"../../../core/Clonable.js";import"../../../chunks/mat3.js";import"../../../chunks/mat3f64.js";import"../../../chunks/vector.js";import"../../../chunks/quatf64.js";import"../../../chunks/aaBoundingBox.js";import"../../../chunks/vec4.js";import"../../../chunks/HUDIntersectorResult.js";import"../../../chunks/Intersector.js";import"../../../chunks/mathUtils2.js";import"../../../chunks/lineSegment.js";import"../../../core/Evented.js";import"../../../chunks/screenUtils.js";import"../../../chunks/computeTranslationToOriginAndRotation.js";import"../../../chunks/hydratedFeatures.js";import"../../../Graphic.js";import"../../../PopupTemplate.js";import"../../../layers/support/fieldUtils.js";import"../../../core/sql.js";import"../../../chunks/guards.js";import"../../../chunks/datetime.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/support/AttachmentsOrderByInfo.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../chunks/enumeration.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../chunks/date.js";import"../../../chunks/locale.js";import"../../../chunks/constants.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/content/UtilityNetworkAssociationsContent.js";import"../../../popup/support/UtilityNetworkAssociationType.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../core/Identifiable.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../../chunks/shared.js";import"../../../geometry/support/jsonUtils.js";import"../../../chunks/typeUtils.js";import"../../../chunks/createFeatureId.js";import"../../../chunks/typeUtils2.js";import"../../../symbols/CIMSymbol.js";import"../../../symbols/Symbol.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../portal/Portal.js";import"../../../core/Loadable.js";import"../../../portal/PortalGroup.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils3.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/materialUtils.js";import"../../../chunks/opacityUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils4.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/Font.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/SimpleLineSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/SimpleFillSymbol.js";import"../../../symbols/SimpleMarkerSymbol.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../../chunks/dehydratedPoint.js";import"../../../chunks/elevationInfoUtils.js";import"../../../chunks/unitConversionUtils.js";import"../../../chunks/lengthUtils.js";import"../../../chunks/ray2.js";import"../../../chunks/colorUtils2.js";import"../../../chunks/VertexColor.glsl.js";import"../../../chunks/InterleavedLayout.js";import"../../../chunks/types.js";import"../../../chunks/VertexElementDescriptor.js";import"../../../chunks/VertexAttributeLocations.js";import"../../../chunks/AlphaCutoff.js";import"../../../Camera.js";import"../../../CameraLayout.js";import"../../../chunks/projectPointToVector.js";import"../../../chunks/projectVectorToPoint.js";import"../../../chunks/projectVectorToVector.js";import"../../../chunks/earthUtils.js";import"../../../chunks/spatialReferenceSupport.js";import"../../../chunks/frustum.js";import"../../../chunks/quat.js";import"../../../chunks/spatialReferenceEllipsoidUtils.js";import"../../../chunks/vec3f32.js";import"../../../chunks/meshVertexSpaceUtils.js";import"../../../geometry/support/MeshGeoreferencedVertexSpace.js";import"../../../geometry/support/MeshLocalVertexSpace.js";import"../../../chunks/Octree.js";import"../../../chunks/sdfPrimitives.js";import"../../../chunks/floatRGBA.js";import"../../../chunks/TriangleMaterial.js";import"../../../chunks/debugFlags2.js";import"../../../chunks/ellipticArc7Utils.js";import"../../../chunks/geometry2dUtils.js";import"../../../chunks/EngineVisualElement.js";import"../../../chunks/RenderGeometry.js";import"../../../chunks/GridLocalOriginFactory.js";import"../../../chunks/HighlightDefaults.js";import"../../../chunks/VertexArrayObject2.js";import"../../../chunks/VertexArrayObject.js";import"../../../chunks/memoryEstimations.js";import"../../../chunks/BufferObject.js";import"../../../chunks/VertexBuffer.js";import"../../../chunks/NestedMap.js";import"../../../chunks/signal.js";import"../../../chunks/axisAngleDegrees.js";import"../../../chunks/weather.js";import"../environment/CloudyWeather.js";import"../environment/FoggyWeather.js";import"../environment/RainyWeather.js";import"../environment/SnowyWeather.js";import"../environment/SunnyWeather.js";import"../../../chunks/Scheduler.js";import"../../../chunks/debugFlags.js";import"../../../chunks/BlendColorsPremultiplied.glsl.js";import"../../../chunks/InteractiveToolBase.js";import"../../../chunks/InputManager.js";import"../../../chunks/Queue.js";import"../../../chunks/ElevationContext.js";import"../../../chunks/HUDMaterial.js";import"../../../chunks/HUDVisibility.glsl.js";import"../../../chunks/BooleanBindUniform.js";import"../../../chunks/triangle.js";import"../../../chunks/videoUtils.js";import"../../../chunks/requestImageUtils.js";const ei=te(2),ti=new class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=4,this.fovFocusedArcWidth=2*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=2/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}},ii=new class{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new ee([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:ee.toUnitRGBA(new ee([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:1,cullFace:2,writeDepth:!1}}};function si({tiltedUpVector:e,rightVector:t,observerRenderSpace:i},s){const o=Re(e,t,i,s);return o[12]=0,o[13]=0,o[14]=0,o}function oi(e,t,i,s){const o=A(),r=_e(i.plane),a=function(e,t){const i=ai;e.renderCoordsHelper.toRenderCoords(e.camera.position,i);const s=He(e,i,e.camera.heading,e.camera.tilt,ze()).direction;return ie(y(s,t))-90}(t,r);let n;if(Math.abs(a)>ti.viewAngleThreshold)n=e.next(Ee(t,i.plane));else{const o=be(s.targetRenderSpace,i.basis1,Ve()),r=b(ai,i.basis1),a=b(ni,i.basis2);n=e.next(Ee(t,o)).next(e=>{const t=e=>{const t=j(M(li,e,i.origin),a),o=Math.acos(se(t/s.farDistanceRenderSpace,-1,1)),n=Math.sin(o)*s.farDistanceRenderSpace;return S(A(),i.origin,S(A(),D(li,r,n),D(ci,a,t)))},o=t(e.renderStart),n=t(e.renderEnd);return{...e,renderStart:o,renderEnd:n}})}return n.next(e=>{"start"===e.action&&V(o,e.renderStart);const t=ie(Ce(o,e.renderEnd,i.origin,r));return{...e,deltaAngle:t}})}function ri(e,t,i,s){return oe(hi,i,s),k(e,t,hi)}const ai=A(),ni=A(),li=A(),ci=A(),hi=ve();class di extends Ie{constructor(e){super(),this._handles=new Te,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles=c(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,t){const i=Object.values(this._manipulators);return J(i.map(({manipulator:i,side:s})=>Je(i,(i,o,r,a,n)=>{const l=function(e,{observerRenderSpace:t,targetRenderSpace:i,tiltedUpVector:s,rightVector:o,farDistanceRenderSpace:r}){const a=M(vi,i,t),n=pi(e)?o:s,l=D(wi,n,r);return xe(t,a,l)}(s,t),c=oi(o.next(e=>({...e,manipulatorType:2,side:s})),this._view,l,t);e(i,c,r)})))}updateManipulatorsTransform(e){e.arcCentersPoints(fi),this._forEachManipulatorInfo(t=>this._updateArcManipulatorTransform(t,e,fi[t.side]))}updateManipulatorVisuals(e){this._forEachManipulatorInfo(t=>this._updateArcManipulatorVisuals(t,e))}_updateArcManipulatorVisuals({manipulator:e,side:t},i){const s=[];if(null!=i){const[o,r]=function(e,t,i){const{horizontalFieldOfView:s,verticalFieldOfView:o}=t,r=pi(e),a=te(se((r?o:s)/2,0,15)),n=function(e,t,i,s=10){Ke(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const o=t-e;if(o<=0||i<=0){const e=.01;return[E(0,0,e),E(0,0,-e)]}const r=[],a=o/s;for(let o=0;o<s;o++){let n=e+o*a;o===s-1&&(n=t);const l=Math.cos(n)*i,c=Math.sin(n)*i,h=E(l-i,0,c);r.push(h)}return r}(-a/2,a/2,r?1:Math.max(Math.sin(te(90-o/2)),.1));return[Ge(i,n),n]}(t,i,this._unfocusedArcMaterial);s.push(new Pe(o,1),new Pe(o.instantiate({material:this._focusedArcMaterial}),2)),e.collisionType={type:"line",paths:[r]}}e.renderObjects=s,e.radius=ti.collisionRadius}_updateArcManipulatorTransform({manipulator:e,side:t},i,s){const o=i.horizontalFieldOfView,r=te(i.verticalFieldOfView/2),a=te(o/2),n=pi(t);e.renderLocation=s;const l=ve(),c=e=>{ce(l,e,l)};c(re(mi,te(-90))),n||c(ae(mi,r));const h=i.farDistanceRenderSpace;let d,p;c(ne(mi,O(vi,h,h,h))),c(le(mi,function(e){return function(e){switch(e){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}(e)*ui}(t))),c(si(i,mi)),n?(d=a,p=i.tiltedUpVector):(p=i.rightVector,d=r),d*="right"===t||"bottom"===t?-1:1;const u=oe(mi,d,p);null!=u&&c(u),e.modelTransform=l}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),i=this._createArcManipulator("top"),s=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:i,bottom:s},[[s.manipulator,i.manipulator],[e.manipulator,t.manipulator]].forEach(([e,t])=>{e.metadata={pairedManipulator:t},t.metadata={pairedManipulator:e}})}_createArcManipulator(e){const t=new Fe({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),i={manipulator:t,side:e};return this._updateArcManipulatorVisuals(i),this._handles.add(t.events.on("focus-changed",e=>{const i=t.metadata?.pairedManipulator;null!=i&&(i.hovering!==t.hovering&&(i.hovering=t.hovering),i.grabbing!==t.grabbing&&(i.grabbing=t.grabbing))})),i}_createArcMaterial(e){const t=ti.getFovArcWidth(e),i=new Ye({renderOccluded:4,isDecoration:!0,width:t});return this._handles.add(u(()=>ee.toUnitRGBA(this._view.effectiveTheme.accentColor),e=>i.setParameters({color:e}),m)),i}forEachManipulator(e){Object.values(this._manipulators).forEach(({manipulator:t})=>e(t,2))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach(t=>e(t))}get test(){return{manipulators:this._manipulators}}}function pi(e){return"left"===e||"right"===e}const ui=Math.PI/2,mi=ve(),vi=A(),wi=A(),fi={top:A(),bottom:A(),left:A(),right:A()};class gi extends Fe{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:ti.collisionRadius}),this._handles=new Te,this._setupManipulatorVisual(t)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){const t=this._createMaterial(),i=[E(0,0,0),E(0,0,1)],s=qe(t,i,e,16,!1),o=qe(t,i,e*it,16,!1),r=_i(!1,t,e),a=_i(!0,t,e),n=ve();he(n,i[i.length-1]),de(n,n,ae(bi,Math.PI/2)),de(n,n,re(bi,Math.PI/2)),r.transformation=n,a.transformation=n,this.renderObjects=[new Pe(s,1),new Pe(o,2),new Pe(r,1),new Pe(a,2)];const l=E(0,ti.getScaleOrientArrowTipLength(!0),0),c=k(l,l,n),h=[...i,c];this.collisionType={type:"line",paths:[h]}}_createMaterial(){const e=new st({cullFace:2,renderOccluded:4,isDecoration:!0});return this._handles.add(u(()=>ee.toUnitRGBA(this.view.effectiveTheme.accentColor),t=>e.setParameters({color:t}),m)),e}}function _i(e,t,i){const s=ti.getScaleOrientArrowTipLength(e);let o=2*i;e&&(o*=it);const r=s/2;return Qe(t,s,r,r,o,0)}const bi=ve();class Vi extends Ie{constructor(e){super(),this._handles=new Te,this._tool=e.tool,this._view=e.view;const t=ti.scaleOrientHandleRadius;this._manipulatorHeading=new gi(this._view,t),this._manipulatorTilt=new gi(this._view,t),this._manipulatorDistance=new gi(this._view,t),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return Je(this._manipulatorHeading,(i,s,o,r,a)=>{const n=this._view,{tiltParallelToSurface:l,farDistanceRenderSpace:c,upVector:h,observerRenderSpace:d,targetRenderSpace:p,rightVector:u}=t,m=Math.sin(te(l))*c,v=S(Mi,d,D(Si,h,m)),w=M(Si,p,v),f=D(Di,u,T(w)),g=oi(s,n,xe(v,w,f),t).next(e=>({...e,manipulatorType:3}));e(i,g,o)})}createTiltDragPipeline(e,t){return Je(this._manipulatorTilt,(i,s,o,r,a)=>{const{observerRenderSpace:n,farDistanceRenderSpace:l,upVector:c,targetDirection:h}=t,d=j(h,c),p=x(Mi,h,c,-d);D(p,b(p,p),l);const u=D(Si,c,l),m=xe(n,p,u),v=oi(s,this._view,m,t).next(e=>({...e,manipulatorType:3}));e(i,v,o)})}createDistanceDragPipeline(e,t){return Je(this._manipulatorDistance,(i,s,o,r,a)=>{const n=tt(t.observerRenderSpace,t.targetDirection),l=s.next(Ze(this._view,i.location)).next(Ue(this._view,n)).next(e=>({...e,manipulatorType:2}));e(i,l,o)})}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const i=ve(),s=e=>{ce(i,e,i)},o=ti.scaleOrientSize*(Be/We);s(ne(yi,O(Mi,o,o,o))),s(si(e,yi));const r=ti.scaleOrientHandleRadius*it*o,a=D(Mi,e.targetDirection,r);s(he(yi,a));const n=le(yi,-ki);de(n,n,re(ji,-ki)),this._manipulatorHeading.modelTransform=de(ve(),i,n);const l=re(yi,ki);de(l,l,le(ji,Math.PI)),this._manipulatorTilt.modelTransform=ce(ve(),i,l),this._manipulatorDistance.modelTransform=i}forEachManipulator(e){e(this._manipulatorHeading,3),e(this._manipulatorTilt,3),e(this._manipulatorDistance,2)}}const yi=ve(),ji=ve(),Mi=A(),Si=A(),Di=A(),ki=Math.PI/2;class Oi extends Fe{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:ti.observerSize,interactive:!1}),this._handles=new Te;const i=Ae(this._color);this.renderObjects=[new Pe(Xe(i,ti.observerSize,32,32))],t.manipulators.add(this),this._handles.add([u(()=>this._color,e=>{i.setParameters({color:e})},m)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return ee.toUnitRGBA(this.view.effectiveTheme.accentColor)}}e([g()],Oi.prototype,"_color",null);const Ti=Symbol("dragHandles"),xi=Symbol("hideManipulators"),Ci=Symbol("hideFoVManipulators"),Ri=Symbol("hideObserverManipulator");let Pi=class extends s{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new di({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Vi({view:this.view,tool:this.parentTool}),this._observerManipulator=new Oi(this.view,this.parentTool),this.addHandles([u(()=>this.viewshedComputedData?.observerRenderSpace,e=>{null!=e&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)},v),u(()=>this.viewshedComputedData?.heading,e=>{e&&(this._moveManipulation.angle=te(90-e))},m),u(()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}},({viewshedComputedData:e,observer:t},i)=>{this._grabbing&&t!==i?.observer||(this.removeHandles(Ti),e?.valid&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(o),Ti))},m),u(()=>{const e=this.viewshedComputedData;return e?.valid?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},m),u(()=>{const e=this.viewshedComputedData;return e?.valid?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},m),u(()=>{const e=this.analysisViewData.visible&&(this.viewshedComputedData?.valid??!1),t=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||t)}},({fovManipulationAvailable:e,nonFOVManipulationAvailable:t})=>{this._moveManipulation.available=t,this._scaleOrientManipulation.available=t,this._observerManipulator.available=t,this._fieldOfViewManipulation.available=e},m),u(()=>{const e=this.viewshedComputedData;if(!e?.valid)return null;const{observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:o}=e;return{viewshedCompData:e,observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:o}},e=>{null!=e&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},m)]),this._forEachManipulator(e=>{const t=this.analysisViewData;this.addHandles([e.events.on("focus-changed",()=>{const e=this._someManipulatorHovering();e&&this.parentTool.subToolHandles.forEach(({subTool:e})=>{e._resetHoveringTask()}),this._someManipulatorSelected()||e||(this._forceHoveringTask=je(async e=>{await(this._forceHoveringTestPromise??De(ti.hoverTimeoutMilliseconds,e)),ke(e),this._forceHoveringTask=null,this._updateManipulatorVisibility()}))}),e.events.on("grab-changed",i=>{this._grabbing="start"===i.action,"end"===i.action&&t.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach(({subTool:e})=>{e!==this&&e._setInteractive(!this._grabbing)}),this._setInteractive(t=>t.hasManipulator(e)||!this._grabbing)}),e.events.on("drag",e=>{"start"===e.action&&t.tool?.updateInteractionVisualsVisibility()})])})}destroy(){this._forceHoveringTask=h(this._forceHoveringTask),this._moveManipulation=c(this._moveManipulation),this._fieldOfViewManipulation=c(this._fieldOfViewManipulation),this._scaleOrientManipulation=c(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=c(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(e){const t=this.viewshed;null!=t&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:e,grabbing:t}=this._moveManipulation;return{dragging:e,grabbing:t}}get scaleOrientInteractionState(){const{dragging:e,grabbing:t}=this._scaleOrientManipulation;return{dragging:e,grabbing:t}}_setInteractive(e){const t="boolean"==typeof e;this._forEachManipulation(i=>i.interactive=t?e:e(i))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),this._someManipulatorSelected()||(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(e){let t=!1;return this._forEachManipulator(i=>{t=t||i===e}),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new Ne({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:Be})}_buildObserverDragPipeline(e){const t=e.observer;if(null==t)return null;const i=this.view.spatialReference;return this._moveManipulation.createDragPipeline((e,s,o,r,a)=>{r=r.next($e(this,["observer"]));const n=L(t,i);if(null==n)return{steps:o,cancel:r};const l=ot.fromGeometry(n,Oe(this.view.viewingMode));return{steps:o.next(et({operations:l})).next(e=>(this.observer=l.data.geometry,e)),cancel:r}},{mode:"absolute-height",offset:0},i,void 0)}_buildFOVDragPipeline(e){let t=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((s,o,r)=>{if(null==e)return{steps:o,cancel:r};const a=e.viewshed;let n=null;r=r.next($e(a,["horizontalFieldOfView","verticalFieldOfView"]));const l=o.next(s=>{"start"===s.action&&(n=null,t=e.horizontalFieldOfView,i=e.verticalFieldOfView);const o=s.deltaAngle;if(null==n&&0!==o){const e="bottom"===s.side||"left"===s.side?o>0:o<0;n=pi(s.side)?0===t&&e||360===t&&!e:0===i&&e}const r=n?function(e){return"left"===e?"right":"right"===e?"left":"top"===e?"bottom":"top"}(s.side):s.side;let l=0;switch(r){case"left":l=t/2-o;break;case"right":l=t/2+o;break;case"top":l=i+2*o;break;case"bottom":l=i-2*o}return pi(r)?(l=Me.normalize(l),l=l>270?0:l>180?180:l,a.horizontalFieldOfView=2*l):a.verticalFieldOfView=l,s});return{steps:l,cancel:r}},e)}_buildScaleOrientDragPipeline(e){let t=0,i=0;const s=(t,i)=>(s,o,r)=>{if(null==e)return{steps:o,cancel:r};const a=e.viewshed;return r=r.next($e(a,[t])),{steps:o=o.next(i(a,e)),cancel:r}};return J([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",(t,s)=>s=>("start"===s.action&&(i=e.heading),t.heading=Me.normalize(i+s.deltaAngle),s)),e),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",(i,s)=>s=>{"start"===s.action&&(t=e.tilt);let o=t+s.deltaAngle;return o<-90?o=180:o>270&&(o=0),i.tilt=Ai.clamp(o),s}),e),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",(e,t)=>i=>{const s=M(Fi,i.renderEnd,t.observerRenderSpace),o=T(s)*t.metersPerUnit,r=j(s,t.targetDirection)<0?ti.scaleOrientMinDistance:o;return e.farDistance=r,i}),e)])}_updateManipulatorVisibility(){const e=this._someManipulatorSelected(),t=null!=this._forceHoveringTask||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating;let o=[];const r=e=>{o.push(e.disableDisplay())};e||!s&&t?this.removeHandles(xi):(this._scaleOrientManipulation.forEachManipulator(r),this._moveManipulation.forEachManipulator(r),this.addHandles(o,xi),o=[]),e||!s&&t||s&&i?this.removeHandles(Ci):(this._fieldOfViewManipulation.forEachManipulator(r),this.addHandles(o,Ci)),e||!s?this.removeHandles(Ri):this.addHandles(this._observerManipulator.disableDisplay(),Ri)}_resetHoveringTask(){this._forceHoveringTask=h(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(e){this._forEachManipulation(t=>{t.forEachManipulator(e)}),e(this._observerManipulator)}_forEachManipulation(e){e(this._moveManipulation),e(this._fieldOfViewManipulation),e(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:e=>{this._forceHoveringTestPromise=e}}}};e([g({constructOnly:!0})],Pi.prototype,"analysis",void 0),e([g({constructOnly:!0})],Pi.prototype,"analysisViewData",void 0),e([g({constructOnly:!0})],Pi.prototype,"parentTool",void 0),e([g({constructOnly:!0,nonNullable:!0})],Pi.prototype,"view",void 0),e([g()],Pi.prototype,"viewshed",null),e([g()],Pi.prototype,"_grabbing",void 0),e([g()],Pi.prototype,"grabbing",null),e([g()],Pi.prototype,"viewshedComputedData",void 0),e([g()],Pi.prototype,"observer",null),Pi=e([_("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],Pi);const Fi=A(),Ai=new Se(0,180),Ei=Symbol("interactionVisuals");let Ui=class extends ct{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=Gi,this._creationState=!1,this._interactionVisualElements=null,this._settings=new rt({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=mt(this.view.state.viewingMode),this._createInteractionVisuals();const e=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=l(()=>e,({viewshedComputedData:e})=>{const t=new Pi({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:t,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),t.destroy()}}}),this.addHandles([w(()=>this._valid,()=>this.finishToolCreation(),v),u(()=>this._stagedViewshed,e=>{const t=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=null!=e&&null!=t?this._findSubTool(e)?.viewshedComputedData:null},v),this.analysis.viewsheds.on("after-remove",e=>{const t=this._stagedViewshed;null!=t&&e.item===t&&this.analysis.viewsheds.add(t)}),u(()=>this.firstGrabbedManipulator,e=>{if(null!=e){const t=this._findSubTool(e)?.viewshed;this.selectedViewshed=t,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()},f),u(()=>this.view.activeTool,e=>{e!==this&&null!=e&&(this.selectedViewshed=null)}),w(()=>{const e=this.selectedViewshedComputedData;return null==e?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}},e=>{const{subTool:t,observer:i,target:s}=e;t?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(i,!0):t?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(s,!1)},m),u(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),u(()=>this.selectedViewshed,e=>{const t=this._selectedManipulator,i=this._selectedSubTool;null==e?this._selectManipulator(null):null!=t&&i.hasManipulator(t)||this._selectManipulator(i.discManipulator)},m)])}destroy(){this.subToolHandles=c(this.subToolHandles),this.removeHandles(Ei)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){return this.analysisViewData.viewshedComputedDataHandles?.some(e=>e.viewshedComputedData.valid)??!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(e){const t=this._selectedManipulator;t!==e&&(this._selectedManipulator=e,null!=t&&(t.selected=!1),null!=e&&(e.selected=!0),this._findSubTool(t)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(e){this.analysisViewData.selectedViewshed=e}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:e})=>e.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return"placing-target"===this._creationState}place(e){this.selectedViewshed=null,this._placementMode=e,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach(e=>e.subTool.onManipulatorSelectionChanged())}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":ut.cancel===e.key?this._cancelKeyHandler(e):ut.delete.includes(e.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickPlacementHandler(e)}onActivate(){this._placementMode=Gi}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(e,Ni);if(null!=t){if("placing-observer"===this._creationState){t.mapPoint.z=(t.mapPoint.z??0)+1.5;const e=new fe({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if("placing-target"===this._creationState){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._stagedViewshed=null,"multiple"===this._placementMode?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=e}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating)return;const t=this._intersectScreen(e,Ni);null!=t&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(e){this.creating?this._onCancelWhileCreating(e):this.grabbing||(this.selectedViewshed=null,e.stopPropagation())}_onCancelWhileCreating(e){const t=this.removeStaged();this._finishToolCreationIfValid(),t?(this._creationState="placing-observer",this.selectedViewshed=null,"multiple"===this._placementMode&&e.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(null==t||null==i)return;const{heading:s,tilt:o,farDistance:r}=function(e,t,i){const s=t.observerRenderSpace,o=M(Hi,i,s),r=T(o)*t.metersPerUnit,a=e.renderCoordsHelper.basisMatrixAtPosition(s,Bi),n=O(zi,a[8],a[9],a[10]),l=be(s,n,Wi),c=ye(l,i,Li),h=M(c,c,s),d=(T(h)<1e-4?90:ie(y(o,h)))*(j(n,o)<0?-1:1)+90,p=O(Ii,a[4],a[5],a[6]),u=ie(y(p,h)),m=O(Ii,a[0],a[1],a[2]);return{heading:j(h,m)<0?360-u:u,tilt:d,farDistance:r}}(this.view,i,e);t.farDistance=r,t.tilt=o,t.heading=s}removeStaged(){const e=this._stagedViewshed;return null!=e&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(e),!0)}_intersectScreen(e,t){const i=vt(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,o=t.scenePoint;if(!s.getIntersectionPoint(o))return null;const r=t.mapPoint;return r.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(o,r),null==r?null:(t.feature=lt(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(Ei);const e=this._settings.visualElements,t=new nt({view:this.view,attached:!1,style:{glowWidth:e.heightPlane.glowWidth,innerWidth:e.heightPlane.innerWidth},isDecoration:!0}),i=new at({view:this.view,extensionType:e.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:i},this.addHandles([u(()=>e.zVerticalLine,e=>e.apply(i),v),u(()=>e.heightPlane,e=>e.apply(t),v),Z(()=>{t.destroy(),i.destroy(),this._interactionVisualElements=null})],Ei)}updateInteractionVisualsVisibility(e=!1){const t=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,o=this.selectedViewshedComputedData,r=(e,t)=>{const i=this._interactionVisualElements;null!=i&&(i.verticalLine.attached=t,i.laserline.attached=e)};if(t)return void r(i,!1);if(null==s||null==o)return void r(!1,!1);const a=s.moveInteractionState,n=e?a.grabbing:a.dragging,l=s.scaleOrientInteractionState,c=e?l.grabbing:l.dragging,h=i&&(n||c);if(r(h,n),h){const e=n?o.observerRenderSpace:o.targetRenderSpace;this._updateInteractionVisualsLocation(e,n)}}_updateInteractionVisualsLocation(e,t){const i=this._interactionVisualElements;if(null==i)return;const{laserline:s,verticalLine:o}=i;s.heightManifoldTarget=e,s.intersectsWorldUpAtLocation=t?e:null,null!=e&&o.setStartEndFromWorldDownAtLocation(e)}_findSubTool(e){if(null==e)return null;const t=e instanceof Fe?t=>t.subTool.hasManipulator(e):t=>t.subTool.viewshed===e;return this.subToolHandles?.find(t)?.subTool}get test(){}};e([g({constructOnly:!0})],Ui.prototype,"view",void 0),e([g()],Ui.prototype,"analysisViewData",void 0),e([g()],Ui.prototype,"removeIncompleteOnCancel",void 0),e([g()],Ui.prototype,"automaticManipulatorSelection",void 0),e([g({constructOnly:!0})],Ui.prototype,"analysis",void 0),e([g()],Ui.prototype,"subToolHandles",void 0),e([g()],Ui.prototype,"_stagedViewshed",void 0),e([g()],Ui.prototype,"_stagedViewshedComputedData",void 0),e([g()],Ui.prototype,"_placementMode",void 0),e([g()],Ui.prototype,"_creationState",void 0),e([g()],Ui.prototype,"_valid",null),e([g({readOnly:!0})],Ui.prototype,"cursor",null),e([g()],Ui.prototype,"_selectedManipulator",void 0),e([g()],Ui.prototype,"_selectedSubTool",null),e([g()],Ui.prototype,"selectedViewshed",null),e([g()],Ui.prototype,"selectedViewshedComputedData",null),e([g()],Ui.prototype,"stagedViewshed",null),e([g()],Ui.prototype,"grabbing",null),e([g()],Ui.prototype,"creating",null),e([g()],Ui.prototype,"isPlacingTarget",null),Ui=e([_("esri.views.3d.analysis.Viewshed.ViewshedTool")],Ui);const Hi=A(),zi=A(),Li=A(),Ii=A(),Bi=ve(),Wi=Ve(),Ni={mapPoint:new ge,scenePoint:A(),feature:null},Gi="multiple",qi=Ui;class Qi extends X{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new st({...ii.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(null==e)return;const t=ve(),i=e.farDistanceRenderSpace;ne(t,E(i,i,i)),si(e,$i),de(t,$i,t),he($i,this._viewshedComputedData.observerRenderSpace),de(t,$i,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachMaterial(e){e(this._material)}createGeometries(e){const{_material:t,viewshedComputedData:i}=this;if(null==i||null==t||!i.valid)return;const s=function(e,t){const{horizontalFieldOfView:i,verticalFieldOfView:s}=t,o=O(Ki,0,0,1),r=O(Yi,0,1,0),a=O(Ji,1,0,0);ri(o,o,te(s/2),r),ri(o,o,te(i/2),a);const n=e=>Math.ceil(Math.abs(e)/ei)+1,l=te(i),c=V(Zi,a),h=n(l),d=Xi(-l/(h-1)),p=oe($i,d,c),u=te(-s),m=n(u),v=Xi(u/(m-1)),w=V(Yi,r),f=oe(es,te(i)/2,a);k(w,w,f);const g=es,_=[],b=V(Ji,o);for(let e=0;e<h;e++){oe(g,v,w);for(let t=0;t<m;t++){const i=3*(t*h+e);_[i]=b[0],_[i+1]=b[1],_[i+2]=b[2],k(b,b,g)}k(w,w,p),k(o,o,p),V(b,o)}const y=h*m;_[3*y]=0,_[3*y+1]=0,_[3*y+2]=0;const j=[];for(let e=0;e<h-1;e++)for(let t=0;t<m-1;t++){const i=6*(t*(h-1)+e);j[i]=t*h+e,j[i+1]=(t+1)*h+e,j[i+2]=t*h+e+1,j[i+3]=t*h+e+1,j[i+4]=(t+1)*h+e,j[i+5]=(t+1)*h+e+1}const M=[j];if(360!==i&&0!==s){const e=[],t=[];for(let i=0;i<m-1;i++){const s=3*i;e[s]=y,e[s+1]=(i+1)*h,e[s+2]=i*h,t[s]=y,t[s+1]=i*h+h-1,t[s+2]=(i+1)*h+h-1}M.push(e,t)}if(180!==s&&0!==i){const e=[],t=[];for(let i=0;i<h-1;i++){const s=3*i;e[s]=y,e[s+1]=i,e[s+2]=i+1,t[s]=y,t[s+1]=i+(m-1)*h+1,t[s+2]=i+(m-1)*h}M.push(e,t)}return M.map(t=>{const i=[["position",new ft(_,t,3,!0)]];return new gt(e,i)})}(t,i);s.forEach(t=>e.addGeometry(t))}}function Xi(e){return isNaN(e)?1:e}const Ki=A(),Yi=A(),Ji=A(),Zi=A(),$i=ve(),es=ve();let ts=class extends s{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:A(),topRight:A(),bottomLeft:A(),bottomRight:A()},this._arcCenterPoints={top:A(),bottom:A(),left:A(),right:A()},this._parallelCenters={top:A(),bottom:A()}}initialize(){const e={view:this.view,isDecoration:!0},t={...e,color:this._color,renderOccluded:4},i={...t,stipplePattern:Tt(2)};this._observerVisualElement=new wt({...e,...ii.observerPointConfiguration}),this._shapeVisualElement=new Qi({...e,isDecoration:this.isDecoration}),this._frameLinesVisualElement=new K(t),this._leftArcVisualElement=new K(t),this._rightArcVisualElement=new K(t),this._topArcVisualElement=new K(t),this._bottomArcVisualElement=new K(t),this._centralLongitude=new K(i),this._centralLatitude=new K(i),this.addHandles([u(()=>{const e=this.viewshedComputedData;if(!e?.valid)return null;const t=this._viewshedCorners,i=this._arcCenterPoints,s=this._parallelCenters;return e.cornerPoints(t),e.arcCentersPoints(i),e.parallelCenterPoints(s),{viewshedComputedData:e,corners:t,arcCenters:i,parallelCenters:s,interactive:this.analysisViewData.interactive,selected:this._selected}},e=>{const t=null!=e;this._forEachVisualElement(e=>e.attached=t),t&&this._updateVisualElements(e)},{initial:!0,equals:r}),u(()=>{const{viewshedComputedData:e}=this,{horizontalFieldOfView:t,verticalFieldOfView:i}=e??{};return{viewshedComputedData:e,horizontalFieldOfView:t,verticalFieldOfView:i}},({viewshedComputedData:e})=>{const{_shapeVisualElement:t}=this;e!==t.viewshedComputedData&&(t.viewshedComputedData=e),this._shapeVisualElement.recreateGeometry()},m),u(()=>{const{interactive:e}=this.analysisViewData;return{visible:this.visible,selected:e&&this._selected,staged:e&&this._staged,horFovNot360:360!==this.viewshedComputedData?.horizontalFieldOfView}},({visible:e,selected:t,staged:i,horFovNot360:s})=>{const o=t||i;this._shapeVisualElement.visible=e,this._topArcVisualElement.visible=e,this._bottomArcVisualElement.visible=e,this._frameLinesVisualElement.visible=e&&s;const r=e&&(t||s);this._leftArcVisualElement.visible=r,this._rightArcVisualElement.visible=r,this._forEachLineVisualElement(e=>{e.width=o?ii.frameWidthSelected:ii.frameWidthNotSelected,e.renderOccluded=t?4:1}),[this._centralLatitude,this._centralLongitude].forEach(i=>{i.width=2*(o?ii.frameWidthSelected:ii.frameWidthNotSelected),i.visible=e&&t})},m),u(()=>{const{analysisViewData:{interactive:e,tool:t},_selected:i,visible:s}=this,o=this.view.activeTool,r=!t?.active&&o instanceof qi&&o.creating;return{observerVisible:s&&!i&&(!e||(t?.creating??!1)||r),color:this._color}},({observerVisible:e,color:t})=>{this._observerVisualElement.visible=e,this._forEachLineVisualElement(e=>e.color=t)},m)])}get _color(){const{viewshedComputedData:e,_selected:t,analysisViewData:i}=this;if(null==e)return ee.toUnitRGBA(ii.frameColor);const s=i.tool?.active||i.interactive,o=e.viewshed===i.tool?.stagedViewshed,r=s&&(t||o)?this.view.effectiveTheme.accentColor:ii.frameColor;return ee.toUnitRGBA(r)}get _selected(){const{viewshedComputedData:e,analysisViewData:{selectedViewshedComputedData:t}}=this;return null!=e&&e===t}get _staged(){const{analysisViewData:{tool:e},viewshedComputedData:t}=this;return null!=e&&e.creating&&e.stagedViewshed===t?.viewshed}destroy(){this._observerVisualElement=c(this._observerVisualElement),this._shapeVisualElement=c(this._shapeVisualElement),this._frameLinesVisualElement=c(this._frameLinesVisualElement),this._leftArcVisualElement=c(this._leftArcVisualElement),this._rightArcVisualElement=c(this._rightArcVisualElement),this._topArcVisualElement=c(this._topArcVisualElement),this._bottomArcVisualElement=c(this._bottomArcVisualElement),this._centralLongitude=c(this._centralLongitude),this._centralLatitude=c(this._centralLatitude)}_forEachLineVisualElement(e){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_forEachVisualElement(e){this._forEachLineVisualElement(e),e(this._observerVisualElement),e(this._shapeVisualElement)}_updateVisualElements(e){const{viewshedComputedData:t,corners:i,arcCenters:s,parallelCenters:o}=e,r=U(t.observerRenderSpace);this._observerVisualElement.geometry=t.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(r,i),this._updateFrameArcs(t,i,o),this._updateCentralHelperArcs(t,s)}_updateFrameLines(e,t){this._frameLinesVisualElement.geometry=[[e,t.topLeft],[e,t.topRight],[e,t.bottomLeft],[e,t.bottomRight]]}_updateFrameArcs(e,t,i){const{observerRenderSpace:s,rightVector:o,horizontalFieldOfView:r,tiltedUpVector:a}=e,n=te(r),l=A(),c=ve();oe(c,n/2,a),k(l,o,c),is(this._leftArcVisualElement,s,t.bottomLeft,t.topLeft,"forward",l),oe(c,-n/2,a),O(l,0,0,0),k(l,o,c),is(this._rightArcVisualElement,s,t.bottomRight,t.topRight,"forward",l);const h=r>180?"backward":"forward";is(this._topArcVisualElement,i.top,t.topRight,t.topLeft,h,a),is(this._bottomArcVisualElement,i.bottom,t.bottomRight,t.bottomLeft,h,a)}_updateCentralHelperArcs(e,t){const i=e.observerRenderSpace,s=e.horizontalFieldOfView>=180?"backward":"forward";is(this._centralLatitude,i,t.right,t.left,s,e.tiltedUpVector),is(this._centralLongitude,i,t.top,t.bottom,"forward",e.leftVector)}get test(){}};function is(e,t,i,s,o,r,a=ei){const n=A();M(n,i,t);const l=T(n),c=A();M(c,s,t),b(c,c),D(c,c,l);let h=y(n,c);const d=U(r);"backward"===o&&(C(d,d),h=-(2*Math.PI-h));const p=[],u=Math.ceil(Math.abs(h)/a),m=ve();oe(m,h/u,d);const v=A();V(v,n);const w=A();V(w,i);for(let e=0;e<u;e++){const e=A();V(e,w),k(v,v,m),S(w,t,v);const i=A();V(i,w),p.push([e,i])}e.geometry=p}e([g()],ts.prototype,"view",void 0),e([g({constructOnly:!0})],ts.prototype,"isDecoration",void 0),e([g()],ts.prototype,"analysisViewData",void 0),e([g()],ts.prototype,"viewshedComputedData",void 0),e([g()],ts.prototype,"visible",void 0),e([g()],ts.prototype,"_color",null),e([g()],ts.prototype,"_selected",null),e([g()],ts.prototype,"_staged",null),ts=e([_("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],ts);const ss=ts;let os=class extends s{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,t=l(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:t})=>{const i=new ss({view:this.view,viewshedComputedData:t,analysisViewData:e,isDecoration:this.isDecoration});return{visualization:i,remove:()=>i.destroy()}});this._viewshedVisualizations=t,this.addHandles([$(t),u(()=>this.visible,e=>this._viewshedVisualizations.forEach(({visualization:t})=>t.visible=e),m)])}get test(){}};var rs;e([g({constructOnly:!0})],os.prototype,"analysisViewData",void 0),e([g({constructOnly:!0,nonNullable:!0})],os.prototype,"view",void 0),e([g({constructOnly:!0})],os.prototype,"isDecoration",void 0),e([g()],os.prototype,"visible",null),os=e([_("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],os);let as=rs=class extends s{constructor(e){super(e),this.observerRenderSpaceOverride=null,this.needUpdateByFeature=!1}get observer(){return this.viewshed.observer??new ge}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,A())}get target(){const e=this.targetRenderSpace;return this.renderSpaceToPoint(e,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const e=M(A(),this.targetRenderSpace,this.observerRenderSpace);return b(e,e)}get tiltedUpVector(){const e=ri(A(),this.upVector,-te(this.tiltParallelToSurface),this.leftVector);return b(e,e)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,ve())}get upVector(){const e=this._basis;return E(e[8],e[9],e[10])}get northVector(){const e=this._basis;return E(e[4],e[5],e[6])}get leftVector(){const e=this.upVector,t=ri(A(),this.northVector,-te(this.heading),e);return R(t,e,t)}get rightVector(){return C(A(),this.leftVector)}clone(){return new rs({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}get valid(){return this.viewshed.valid}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(e,t,i){const{observerRenderSpace:s,targetRenderSpace:o}=this,r=M(ns,o,s);return ri(r,r,-te(t),this.leftVector),ri(r,r,-te(e),this.tiltedUpVector),S(i,r,s)}cornerPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-t,i,e.topLeft),this.pointOnSphere(t,i,e.topRight),this.pointOnSphere(-t,-i,e.bottomLeft),this.pointOnSphere(t,-i,e.bottomRight)}arcCentersPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,e.top),this.pointOnSphere(0,-i,e.bottom),this.pointOnSphere(-t,0,e.left),this.pointOnSphere(t,0,e.right)}parallelCenterPoints(e){const t=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin(te(this.verticalFieldOfView/2)),s=D(ns,this.tiltedUpVector,i);S(e.top,t,s),M(e.bottom,t,s)}renderSpaceToPoint(e,t){const i=ns;return this.renderCoordsHelper.fromRenderCoords(e,i,t),new ge(i[0],i[1],i[2],t)}_pointToRenderSpace(e,t){const i=H(e.toArray());return this.renderCoordsHelper.toRenderCoords(i,e.spatialReference,t),t}_computeTargetRenderSpace(e){const{leftVector:t,northVector:i,upVector:s}=this,o=this.farDistanceRenderSpace,r=A();return D(r,i,o),ri(r,r,-te(this.heading),s),ri(r,r,-te(this.tiltParallelToSurface),t),S(r,e,r),r}};e([g()],as.prototype,"renderCoordsHelper",void 0),e([g()],as.prototype,"viewshed",void 0),e([g()],as.prototype,"observerRenderSpaceOverride",void 0),e([g()],as.prototype,"needUpdateByFeature",void 0),e([g()],as.prototype,"observer",null),e([g()],as.prototype,"effectiveObserverRenderSpace",null),e([g()],as.prototype,"effectiveObserver",null),e([g()],as.prototype,"effectiveTargetRenderSpace",null),e([g()],as.prototype,"farDistance",null),e([g()],as.prototype,"farDistanceRenderSpace",null),e([g()],as.prototype,"heading",null),e([g()],as.prototype,"tilt",null),e([g()],as.prototype,"feature",null),e([g()],as.prototype,"tiltParallelToSurface",null),e([g()],as.prototype,"horizontalFieldOfView",null),e([g()],as.prototype,"verticalFieldOfView",null),e([g()],as.prototype,"observerRenderSpace",null),e([g()],as.prototype,"target",null),e([g()],as.prototype,"targetRenderSpace",null),e([g()],as.prototype,"targetDirection",null),e([g()],as.prototype,"tiltedUpVector",null),e([g()],as.prototype,"_basis",null),e([g()],as.prototype,"upVector",null),e([g()],as.prototype,"northVector",null),e([g()],as.prototype,"leftVector",null),e([g()],as.prototype,"rightVector",null),e([g()],as.prototype,"valid",null),e([g()],as.prototype,"metersPerUnit",null),as=rs=e([_("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],as);const ns=A();let ls=class extends Et{constructor(){super(...arguments),this.sectionAngles=Ft()}get sectionAnglesDeg(){return At(this.sectionAngles.map(e=>ie(e)))}set sectionAnglesDeg(e){this.sectionAngles=At(e.map(e=>te(e)))}get projectionMatrix(){return de(ve(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];Ke(e<=t),Ke(i<=s);const o=2*Math.tan(this.fovX/2),r=2*Math.tan(this.fovY/2),a=Math.tan(e),n=Math.tan(t),l=Math.tan(i),c=n-a,h=Math.tan(s)-l,d=o/c,p=r/h,u=-(a+c/2)/o*2,m=-(l+h/2)/r*2,v=ve();he(v,[u,m,0]);const w=ve();ne(w,[d,p,1]);const f=ve();return de(f,w,v)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/i)}setViewport(e,t){const i=t*this._sectionRatioX;return this.viewport=[e[0],e[1],i,t],i}};e([g()],ls.prototype,"sectionAngles",void 0),e([g()],ls.prototype,"sectionAnglesDeg",null),e([g()],ls.prototype,"projectionMatrix",null),e([g()],ls.prototype,"sectionMatrix",null),e([g()],ls.prototype,"_sectionRatioX",null),ls=e([_("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],ls);class cs{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){const t=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*t}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}const hs=["front","left","right","back","top","bottom"];class ds{constructor(e){this._fbos=e,this._faces={},this._width=0,this._height=0,this.settings=new cs,this._maxTextureSize=Math.min(a("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture(Ut)}get ready(){return null!=this.depthTexture&&0!==this._width&&0!==this._height}get nearFar(){const e=this.faces;return 0===e.length?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach(i=>{e[i]&&(t+=1)}),t}get faces(){const e=this._faces,t=[];for(const i of hs){const s=e[i];s&&t.push(s)}return t}get atlasRegions(){return this.faces.map(e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(e=>e.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(e=>e.viewMatrix)}_setupFaceCamera(e,t,i,s){const{effectiveObserverRenderSpace:o,tiltedUpVector:r,targetRenderSpace:a,farDistanceRenderSpace:n,horizontalFieldOfView:l,verticalFieldOfView:c}=t,h=A();M(h,a,o);const d=A(),p=A(),u=(e,t)=>{const i=A(),s=ve();return oe(s,e,t),k(i,h,s),S(i,o,i),i};let m,v=r;const w=Math.min(90,l),f=Math.min(90,Math.max(0,(l-90)/2));let g=-45,_=45,b=-45,V=45;if(!["top","bottom"].includes(e)){const e=e=>se(e,-45,45);b=e(-c/2)-this.settings.toleranceBottomTop,V=e(+c/2)+this.settings.toleranceBottomTop}switch(e){case"front":m=a,g=-w/2,_=w/2;break;case"left":m=u(Math.PI/2,r),g=45-f;break;case"right":m=u(-Math.PI/2,r),_=-45+f;break;case"top":m=S(d,o,r),v=C(p,h);break;case"bottom":m=M(d,o,r),v=h;break;case"back":m=u(Math.PI,r)}const y=new ls({center:m,eye:o,up:v,far:n});y.sectionAnglesDeg=[g-this.settings.toleranceSides,_+this.settings.toleranceSides,b,V],y.fovY=Math.PI/2;const j=y.setViewport(i,s);return this._faces[e]=y,j}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:i,verticalFieldOfView:s}=e,o=-s/2,r=s/2;return 0===i||0===s||(o<=45&&r>=-45&&t.add("front"),i>90&&(t.add("left"),t.add("right")),i>270&&t.add("back"),r>45-this.settings.toleranceBottomTop&&t.add("top"),o<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize({pixelRatio:e,fullWidth:t,fullHeight:i},s,o,r){const a=s/e,n=this.settings.textureSizeModifier(o);return _t(Math.max(t,i)*a*n,this._maxTextureSize/r)}_ensureFBO(e){const t=this._width,i=this._height,s=this._handle?.fbo;s&&s.width===t&&s.height===i&&e===zt(s.depthStencilTexture?.descriptor?.internalFormat??Ht.DEPTH_COMPONENT16)||(this._handle?.release(),this._handle=this._allocateFBO(e))}_allocateFBO(e){const{_width:t,_height:i}=this,s=e?11:10,o=this._fbos.acquire(t,i,"viewshed shadow map",s);return o.getTexture(Ut)?.setShadowFiltering(!1),o}clearFBO(e){const t=this._fbos.rctx;this._ensureFBO(e),t.bindFramebuffer(this._handle?.fbo),t.setClearColor(1,1,1,1),t.clear(16640)}dispose(){this._debugFBO||(this._handle=d(this._handle))}start(e,t,i,s,o=!1){this._faces={};const r=this._computeActiveFaces(t),a=r.size;if(0===a)return!1;const n=this._computeBaseTextureSize(e,s,i,a);let l=0,c=0,h=0;return hs.filter(e=>r.has(e)).forEach(e=>{const i=function(e,t){if(t<4)return 0;const i="front"===e||"left"===e;return 4===t?i?0:1:i||"right"===e?0:1}(e,a);i>c&&(h=Math.max(h,l),l=0),c=i;const s=i*n;l+=this._setupFaceCamera(e,t,[l,s],n)}),h=Math.max(h,l),this._width=this.settings.textureResizeModulo(h),this._height=(a<4?1:2)*n,this.clearFBO(o),!0}finish(){}get test(){}}class ps extends bt{constructor(){super(...arguments),this.localOrigin=z()}}function us(e){e.include(Lt),e.fragment.uniforms.add(new Vt("inverseViewMatrix",(e,t)=>{const i=pe(ve(),t.camera.viewMatrix,e.localOrigin);return ue(i,i)})).code.add(Nt`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}class ms extends ps{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=we.flat(),this.viewMatrices=we.flat(),this.volumeOffset=0}}const vs=ve(),ws=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:ms,build:function(){const e=new Yt,t=e.fragment;return e.include(It),e.include(us),t.include(yt),t.include(jt),t.uniforms.add(new Mt("depthTexture",e=>e.depth?.attachment),new St("inverseProjectionMatrix",e=>e.camera.inverseProjectionMatrix),new St("inverseViewNormalMatrix",({camera:e})=>ue(vs,e.viewInverseTransposeMatrix)),new Gt("viewshedObserverOffset",e=>e.observerOffset),new Gt("viewshedTargetVector",e=>e.targetVector),new Gt("viewshedUpVector",e=>e.upVector),new Bt("viewshedFOVs",e=>e.fovs),new Bt("viewshedHeadingAndTilt",e=>e.headingAndTilt),new Bt("viewshedNearFar",e=>e.shadowMap.nearFar??[1,100]),new qt("viewshedVolumeOffset",e=>e.volumeOffset),new Qt("viewshedShadowMap",e=>e.shadowMap.depthTexture),new Kt("viewshedProjectionMatrices",e=>e.projectionMatrices,6),new Kt("viewshedViewMatrices",e=>e.viewMatrices,6),new Xt("viewshedNumFaces",e=>e.shadowMap.numActiveFaces),new Dt("viewshedAtlasRegions",e=>e.shadowMap.atlasRegions.flat(),24),new Qt("normalMap",e=>e.normals)),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(Nt`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float viewshedReadShadowMapDepth(sampler2D _viewshedShadowmap, ivec2 uv) {
return texelFetch(_viewshedShadowmap, uv, 0).r;
}
float viewshedFilterShadow(sampler2D _viewshedShadowmap, vec2 uv) {
vec2 uvScaled = uv * vec2(textureSize(_viewshedShadowmap, 0));
vec2 st    = fract(uvScaled);
ivec2 base = ivec2(uvScaled);
float s00 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y    ));
float s10 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y    ));
float s11 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y + 1));
float s01 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y + 1));
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float viewshedTextureAtlasLookup(sampler2D _viewshedShadowmap, vec2 uv, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(uv) * atlasScale + atlasRegion.xy;
return viewshedFilterShadow(_viewshedShadowmap, uvAtlas);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return viewshedTextureAtlasLookup(viewshedShadowMap, uv, atlasRegion);
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = normalize(normal4.xyz * 2.0 - 1.0);
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),t.main.add(Nt`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),e}},Symbol.toStringTag,{value:"Module"}));class fs extends kt{constructor(e,t){super(e,t,new Ot(ws,()=>Promise.resolve().then(()=>ws)),Wt)}initializePipeline(){return Jt({colorWrite:$t,blending:Zt})}}let gs=class extends Pt{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(e=>function(e,t){const i=Rt(t.observerRenderSpace,t.farDistanceRenderSpace);return!!e.ready&&e.frustum.intersectsSphere(i)}(this.view,e))}constructor(e){super(e),this.isDecoration=!1,this._passParameters=new ms,this._viewsheds=new Ct,this._shadowMap=null,this.consumes={required:[Le.VIEWSHED,"normals"]},this.produces=Le.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new ds(this.fboCache),this.addHandles([u(()=>this.view.resolutionScale,e=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=e)},m),w(()=>!this.hasViewsheds,()=>this._shadowMap?.dispose()),u(()=>this._viewshedsInView.map(e=>[e.observerRenderSpace,e.heading,e.tilt,e.farDistance,e.horizontalFieldOfView,e.verticalFieldOfView]),()=>this.requestRender(1),f)])}destroy(){this._shadowMap=p(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(fs);for(const e of this._viewshedsInView)if(this._shadowMap?.isActive(e))return void this.view.stage.renderer.precompileViewshedShadowMap()}}render(e){const t=this.bindParameters,i=this.renderingContext,s=e.find(({name:e})=>e===Le.VIEWSHED);if(!this.hasViewsheds||!t.depth||this.isDecoration&&!t.decorations)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=e.find(({name:e})=>"normals"===e)?.getTexture();const o=this.techniques.get(fs);if(!o?.compiled)return this.requestRender(1),s;const r=this.view.stage.renderer.isFeatureEnabled(7);for(const e of this._viewshedsInView){if(!this._renderShadowCubeMap(t,e,r)||!this._shadowMap?.ready)continue;const a=this._setupViewshedParameters(e,t.camera);i.bindTechnique(o,t,a),i.bindFramebuffer(s.fbo),i.screen.draw()}return this.shadowMap?.dispose(),s}updateViewsheds(e){const t=this._viewsheds,{removes:i,adds:s}=e;if(i&&(Array.isArray(i)?t.removeMany(i):t.remove(i)),s)if(Array.isArray(s)){const e=s.filter(e=>!t.includes(e));t.addMany(e)}else t.includes(s)||t.add(s)}_renderShadowCubeMap(e,t,i){const s=this._shadowMap;if(!s)return!1;const o=this.view.basemapTerrain.hasStencilEnabledExtents,r=s.start(e.camera,t,i,this._contentPixelRatio,o);return r&&s.faces.forEach(e=>this.view.stage.renderer.renderViewshedShadowMap(e)),s.finish(),r}_setupViewshedParameters(e,t){const i=this._shadowMap;if(!i)return this._passParameters;const s=this._passParameters,o=e.effectiveObserverRenderSpace;s.localOrigin=o,s.observerOffset=M(bs,e.observerRenderSpace,e.effectiveObserverRenderSpace),s.fovs=[te(e.horizontalFieldOfView),te(e.verticalFieldOfView)],s.headingAndTilt=[te(e.heading),te(e.tiltParallelToSurface)],s.upVector=e.tiltedUpVector;const r=function(e,t){const i=A();return M(i,e,t)}(e.targetRenderSpace,o);s.targetVector=r;const a=new Array,n=new Array;for(let e=0;e<i.numActiveFaces;e++)pe(Vs,i.viewshedViewMatrices[e],o),a.push(...Vs),_s(i.viewshedProjectionMatrices[e],Vs,ys),n.push(...ys);return s.viewMatrices=a,s.projectionMatrices=n,s.volumeOffset=this.selectedViewshed?.()===e.viewshed?function(e,t,i){if(null==e)return 0;const{observerRenderSpace:s,targetRenderSpace:o}=e,r=P(i,s)>P(i,o)?e.observer:e.target;return t.pixelSizeAt(r)}(e,this.view,t.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function _s(e,t,i){const s=E(.5,.5,.5);return he(i,s),me(i,i,s),de(i,i,e),de(i,i,t),i}e([g()],gs.prototype,"selectedViewshed",void 0),e([g()],gs.prototype,"isDecoration",void 0),e([g()],gs.prototype,"shadowMap",null),e([g()],gs.prototype,"hasViewsheds",null),e([g()],gs.prototype,"_contentPixelRatio",null),e([g()],gs.prototype,"_viewshedsInView",null),e([g()],gs.prototype,"consumes",void 0),e([g()],gs.prototype,"produces",void 0),gs=e([_("esri.views.3d.webgl-engine.lib.Viewshed")],gs);const bs=A(),Vs=ve(),ys=ve();let js=class extends(Q(s)){constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderNode=null,this._intersector=null}get visible(){return super.visible}set visible(e){super.visible=e}get interactive(){return super.interactive}set interactive(e){super.interactive=e}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(e){this._unselectOtherViewsheds(e),this._selectedViewshed=e}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const e=this.view;this._viewshedRenderNode=new gs({view:e,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed,isDecoration:this._isDecoration}),this._intersector=new xt(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0,this.viewshedComputedDataHandles=l(()=>this.analysis.viewsheds,t=>{const i=new as({renderCoordsHelper:e.renderCoordsHelper,viewshed:t}),s=Symbol();return this.addHandles([u(()=>({valid:i.valid,canProject:I(i.observer?.spatialReference,this.view.spatialReference)||B()}),({valid:e,canProject:t},s)=>{this.visible&&(e&&t?this._addViewshedsToRenderer(i):s?.valid&&s?.canProject&&this._removeViewshedsFromRenderer(i),t||Y(this.analysis,i.observer.spatialReference,n.getLogger(this)))},m),...this._createFeatureReferenceHandles(i)],s),{viewshedComputedData:i,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(i),i.destroy()}}}),this._analysisVisualization=new os({view:e,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([u(()=>this.visible,e=>{const t=this.viewshedComputedDataHandles;if(null==t)return;e||(this.selectedViewshed=null);const i=t.map(e=>e.viewshedComputedData).filter(e=>e.valid).toArray();e?this._addViewshedsToRenderer(i):this._removeViewshedsFromRenderer(i)}),u(()=>e.renderCoordsHelper,e=>{this.viewshedComputedDataHandles?.forEach(({viewshedComputedData:t})=>t.renderCoordsHelper=e)}),ht(this,qi),w(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},v)])}destroy(){this.userOperation=h(this.userOperation),dt(this),this._analysisVisualization=c(this._analysisVisualization);const e=this.viewshedComputedDataHandles;null!=e&&this._removeViewshedsFromRenderer(e.map(e=>e.viewshedComputedData).toArray())}_createFeatureReferenceHandles(e){const{view:t}=this;return[u(()=>[t.state.camera,t.slice.plane,e.viewshed.observer,e.targetRenderSpace,e.verticalFieldOfView,e.horizontalFieldOfView,e.feature],()=>{this._updateObserverFromFeature(t,e)},m),this._createElevationUpdateHandle(e),w(()=>e.needUpdateByFeature,()=>{this._updateObserverFromFeature(t,e),e.needUpdateByFeature=!1})]}_createElevationUpdateHandle(e){const t=(i,s)=>{const{view:o}=this,{observer:r}=e;if(null==r)return;const a=W(r,o.spatialReference);if(null!=a.pending)return void a.pending.finally(()=>t(i,s));const n=a.geometry;null!=n&&(N(i,s,Ss,o.spatialReference),q(Ss,[n.x,n.y])&&(e.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",({extent:e,spatialReference:i})=>t(e,i))}async createViewsheds(e){await pt(this,{placementOptions:e,onToolActivated:e=>e.place("multiple")})}place(e){return pt(this,{placementOptions:e,onToolActivated:e=>e.place("single")})}_addViewshedsToRenderer(e){this._viewshedRenderNode.updateViewsheds({adds:e})}_removeViewshedsFromRenderer(e){this._viewshedRenderNode.updateViewsheds({removes:e})}_updateObserverFromFeature(e,s){const o=s.observerRenderSpace,r=s.targetRenderSpace,a=V(A(),o),n={observer:o,observerSurfaceNormal:null,observerAdjusted:a,observerFeatureId:t(s.feature),target:r,targetSurfaceNormal:null,targetAdjusted:V(A(),r),targetFeatureId:null};i(e,this._intersector,n,e=>Math.min(e,.05*s.farDistanceRenderSpace)),s.observerRenderSpaceOverride=F(a,o)?null:a}_unselectOtherViewsheds(e){if(null!=e)for(const e of this.view.tools.items)e!==this.tool&&e instanceof qi&&(e.analysisViewData.selectedViewshed=null)}get test(){}};e([g({readOnly:!0})],js.prototype,"type",void 0),e([g({constructOnly:!0,nonNullable:!0})],js.prototype,"analysis",void 0),e([g()],js.prototype,"tool",void 0),e([g()],js.prototype,"_selectedViewshed",void 0),e([g()],js.prototype,"selectedViewshed",null),e([g()],js.prototype,"selectedViewshedComputedData",null),e([g()],js.prototype,"viewshedComputedDataHandles",void 0),e([g()],js.prototype,"userOperation",void 0),e([g()],js.prototype,"_analysisVisualization",void 0),e([g()],js.prototype,"_viewshedRenderNode",void 0),js=e([_("esri.views.3d.analysis.ViewshedAnalysisView3D")],js);const Ms=js,Ss=G();export{Ms as default};
