/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Map.js";import{c as i}from"../chunks/asyncUtils.js";import r from"../core/Collection.js";import{C as s}from"../chunks/CollectionFlattener.js";import{r as o}from"../chunks/collectionUtils.js";import a from"../core/Error.js";import{EventedMixin as n}from"../core/Evented.js";import l,{f as p}from"../core/Handles.js";import{m as h}from"../chunks/handleUtils.js";import{h as u}from"../core/lang.js";import{isLoadable as c}from"../core/Loadable.js";import{L as d}from"../chunks/Logger.js";import{r as m,a as y,d as g}from"../chunks/maybe.js";import{EsriPromise as f}from"../core/Promise.js";import{c as _,isAborted as w,isAbortError as v,createResolver as j,onAbort as k,throwIfAborted as b,createAbortError as M,after as T}from"../core/promiseUtils.js";import{watch as S,on as V,syncAndInitial as R,sync as I,whenOnce as E,when as C}from"../core/reactiveUtils.js";import{property as L}from"../core/accessorSupport/decorators/property.js";import{subclass as x}from"../core/accessorSupport/decorators/subclass.js";import{O as P,G as F,o as O}from"../chunks/GraphicsCollection.js";import{U as D}from"../chunks/UpdatingHandles.js";import U from"../geometry/Extent.js";import A from"../geometry/HeightModelInfo.js";import H from"../geometry/SpatialReference.js";import{p as q}from"../chunks/unitUtils.js";import{s as W}from"../chunks/constants.js";import N from"../time/TimeExtent.js";import{i as z}from"../chunks/timeZoneUtils.js";import G from"./BasemapView.js";import Z from"./Magnifier.js";import{S as B}from"../chunks/SelectionManager.js";import K from"./Theme.js";import $ from"../core/Accessor.js";import{V as Q}from"../chunks/InputManager.js";import{e as J,V as X}from"../chunks/ViewEvents.js";import{i as Y}from"../chunks/keybindings.js";import{c as ee}from"../chunks/mathUtils.js";import{c as te}from"../chunks/screenUtils.js";import{c as ie}from"../chunks/screenUtils2.js";import{d as re,h as se,t as oe}from"../chunks/HighlightDefaults.js";import ae from"./support/HighlightOptions.js";import ne from"./input/Input.js";import le from"./navigation/Navigation.js";import{d as pe,s as he}from"../chunks/heightModelInfoUtils.js";import{p as ue}from"../chunks/projectionUtils2.js";import{s as ce}from"../chunks/MapUtils.js";import{schedule as de}from"../core/scheduling.js";import{g as me}from"../chunks/get.js";import{d as ye}from"../chunks/collectionUtils2.js";import ge from"../layers/Layer.js";import"../Basemap.js";import"../config.js";import"../chunks/object.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/jsonUtils.js";import"../chunks/string.js";import"../chunks/persistableUrlUtils.js";import"../chunks/events.js";import"../core/JSONSupport.js";import"../chunks/utils.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/ensureType.js";import"../chunks/watch.js";import"../chunks/SetUtils.js";import"../chunks/SimpleTrackingTarget.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../chunks/Warning.js";import"../chunks/loadAll.js";import"../chunks/writer.js";import"../portal/Portal.js";import"../chunks/reader.js";import"../chunks/locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../chunks/jsonMap.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/pe.js";import"../chunks/assets.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/basemapDefinitions.js";import"../chunks/messages.js";import"../support/BasemapStyle.js";import"../intl.js";import"../chunks/date.js";import"../chunks/datetime.js";import"../chunks/number.js";import"../chunks/substitute.js";import"../chunks/writeUtils.js";import"../chunks/layerUtils.js";import"../layers/catalog/catalogUtils.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../Ground.js";import"../Color.js";import"../chunks/colorUtils.js";import"../chunks/enumeration.js";import"../chunks/groundInstanceUtils.js";import"../chunks/opacityUtils.js";import"../effects/FocusAreas.js";import"../core/Clonable.js";import"../effects/FocusArea.js";import"../chunks/uuid.js";import"../chunks/persistable.js";import"../chunks/MD5.js";import"../chunks/multiOriginJSONSupportUtils.js";import"../chunks/resourceExtension.js";import"../effects/FocusAreaOutline.js";import"../chunks/PolygonCollection.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/zmUtils.js";import"../chunks/projectionUtils.js";import"../chunks/vec3f64.js";import"../geometry/Multipoint.js";import"../geometry/Polyline.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../chunks/projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/editableLayers.js";import"../chunks/basemapEnsureType.js";import"../chunks/basemapUtils.js";import"../chunks/utils5.js";import"../chunks/mat4.js";import"../chunks/common.js";import"../support/LayersMixin.js";import"../core/Identifiable.js";import"../chunks/timeUtils.js";import"../support/TablesMixin.js";import"../Graphic.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../chunks/guards.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../geometry/support/jsonUtils.js";import"../chunks/typeUtils.js";import"../chunks/createFeatureId.js";import"../chunks/typeUtils2.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils3.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils4.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../chunks/DoubleArray.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../chunks/lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../chunks/ReactiveMap.js";import"../rest/support/Query.js";import"../chunks/DataLayerSource.js";import"../layers/support/Field.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/fieldType.js";import"../chunks/FullTextSearch.js";import"../chunks/spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../chunks/selectionUtils.js";import"../chunks/Queue.js";import"../chunks/signal.js";import"./input/gamepad/GamepadSettings.js";import"./input/gamepad/GamepadInputDevice.js";import"../chunks/a11yUtils.js";import"./navigation/NavigationActionMap.js";import"./navigation/gamepad/GamepadSettings.js";let fe=class extends P{constructor(e){super(e),this.addHandles(this.on("before-add",e=>{null!=e.item&&e.item.parent===this.owner&&(d.getLogger(this).warn("Analysis inside the collection must be unique. Not adding this element again."),e.preventDefault())}))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};function _e(e){return e.visible&&null!=e.getEditableFlag&&e.getEditableFlag(0)&&e.getEditableFlag(1)}fe=e([x("esri.support.AnalysesCollection")],fe);class we{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._externallyDragging=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(e,t){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":ke(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0?this._stopDrag=!0:"start"===e.action?this._externallyDragging=!0:"end"===e.action&&(this._externallyDragging=!1),this._stopDrag&&(i(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!be(e))break;const r=ie(e),s=je(r,e.pointerType,t.forEachTool);if(null==s)break;const o=s.manipulator,a=s.tool;null==o||null==a||!o.interactive||o.grabbable&&o.grabbableForEvent(e)||!o.grabbing||o.dragging||this._releaseManipulatorBeforeDragging(o,e,t),null!=o&&null!=a&&o.interactive&&o.grabbable&&o.grabbableForEvent(e)&&!o.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:o,tool:a,start:r,pointerType:e.pointerType}),1===this._grabbedManipulators.size&&null==t.activeTool&&(this._revertToNullActiveTool=!0,t.setActiveTool(s.tool)),o.grabbing=!0,o.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:r}),i());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!be(e))break;const r=this._grabbedManipulators.get(e.pointerId),s=r?.manipulator,o=r?.tool;if(null==s||null==o)break;const a=ie(e);a.x=ee(a.x,0,t.view.width),a.y=ee(a.y,0,t.view.height);const n=r.start,l=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":"update"!==e.action&&1!==this._grabbedManipulators.size||(s.dragging=!0,l?s.events.emit("drag",{action:"update",start:n,screenPoint:a}):s.events.emit("drag",{action:"start",start:n,screenPoint:a,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:o,manipulator:s,start:n}));break;case"end":s.dragging=!1,l&&s.events.emit("drag",{action:"end",start:n,screenPoint:a}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}i();break}case"immediate-click":{const r=ie(e),s=je(r,e.pointerType,t.forEachTool);if(e.native.shiftKey||t.forEachTool(e=>{if((null==s||s.tool!==e||e.automaticManipulatorSelection)&&e.manipulators){let t=!1;e.manipulators.forEach(({manipulator:e})=>{e.selected&&(e.selected=!1,t=!0)}),t&&e.onManipulatorSelectionChanged&&e.onManipulatorSelectionChanged()}}),null==s)break;const{manipulator:o,tool:a}=s;if(!o.interactive)break;o.selectable&&a.automaticManipulatorSelection&&(o.selected=!o.selected,a.onManipulatorSelectionChanged&&a.onManipulatorSelectionChanged());const n=e.native.shiftKey;o.events.emit("immediate-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:n,stopPropagation:i}),Me(o,i);break}case"click":{const r=ie(e),s=je(r,e.pointerType,t.forEachTool),o=s?.manipulator;if(null==o||!o.interactive)break;const a=e.native.shiftKey;o.events.emit(e.type,{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a}),i();break}case"double-click":{const r=ie(e),s=je(r,e.pointerType,t.forEachTool),o=null!=s?s.manipulator:null;if(null==o||!o.interactive)break;const a=e.native.shiftKey;o.events.emit("double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),Me(o,i);break}case"immediate-double-click":{const r=ie(e),s=je(r,e.pointerType,t.forEachTool),o=null!=s?s.manipulator:null;if(null==o||!o.interactive)break;const a=e.native.shiftKey;o.events.emit("immediate-double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),"mouse"===e.pointerType&&Me(o,i);break}}this._onFocusChange(t.forEachTool)}_releaseManipulatorBeforeDragging(e,t,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:ie(t)}),this._grabbedManipulators.forEach(({manipulator:t},i)=>{t===e&&this._grabbedManipulators.delete(i)}),this._afterManipulatorRelease(i.setActiveTool)}_handlePointerEnd(e,t){const i=this._grabbedManipulators.get(e.pointerId)?.manipulator;null!=i&&i.grabbing&&(i.grabbing=!1,i.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:ie(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorRelease(t.setActiveTool))}_onFocusChange(e){this._updateCursor(),this._updateFocusedManipulatorTools(e)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=ve(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=ve(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(e){const t=new Set,i=new Set;this._grabbedManipulators.forEach(({tool:e})=>{t.add(e)}),this._hoveredManipulators.forEach(({tool:e})=>{i.add(e)}),e(e=>{e.hasGrabbedManipulators=t.has(e),e.hasHoveredManipulators=i.has(e);const r=this._grabbedManipulators.values(),s=p(r,({tool:t})=>t===e);e.firstGrabbedManipulator=null!=s?s.manipulator:null})}clearPointers(e,{forEachTool:t,setActiveTool:i},r=!0,s){const o=(t,i)=>t===e&&(null==s||s===i);this._grabbedManipulators.forEach(({tool:e,manipulator:t,pointerType:i},r)=>{o(e,t)&&(this._grabbedManipulators.delete(r),t.grabbing=!1,t.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:i}))}),this._draggedManipulators.forEach(({tool:e,manipulator:t},i)=>{o(e,t)&&(this._draggedManipulators.delete(i),t.dragging=!1,t.events.emit("drag",{action:"cancel"}))}),r&&this._hoveredManipulators.forEach(({tool:e,manipulator:t},i)=>{o(e,t)&&(this._hoveredManipulators.delete(i),t.hovering=!1)}),this._afterManipulatorRelease(i),this._onFocusChange(t)}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach((t,i)=>{this._updateHoveredStateForPointerAtScreenPosition(te(t.x,t.y),i,t.pointerType,e)})}handleHoverEvent(e,t){const i=e.type;"pointer-up"!==i&&"immediate-click"!==i&&"pointer-move"!==i||!ke(e.pointerType)||("pointer-up"!==i&&this._externallyDragging?this._clearHoveredManipulatorStates(e.pointerId):this._updateHoveredStateForPointerAtScreenPosition(ie(e),e.pointerId,e.pointerType,t))}_updateHoveredStateForPointerAtScreenPosition(e,t,i,r){let s=je(e,i,r);const o=this._hoveredManipulators.get(t)?.manipulator;null==s||s.manipulator.interactive||(s=null),null!=s&&o===s.manipulator||(null!=o&&(o.hovering=!1),null!=s?(s.manipulator.hovering=!0,this._hoveredManipulators.set(t,s)):this._hoveredManipulators.delete(t),this._onFocusChange(r))}_afterManipulatorRelease(e){0===this._grabbedManipulators.size&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}_clearHoveredManipulatorStates(e){this._hoveredManipulators.forEach(({manipulator:t},i)=>{e===i&&(this._hoveredManipulators.delete(e),t.hovering=!1)})}}function ve(e){for(const{manipulator:t}of e.values())if(null!=t&&t.interactive){if(t.grabbing&&t.grabCursor)return t.grabCursor;if(t.cursor)return t.cursor}return null}function je(e,t,i){let r=null;return i(i=>{if(null==i.manipulators||!_e(i))return!1;const s=i.manipulators.intersect(e,t);return null!=s&&(r={tool:i,manipulator:s},!0)}),r}function ke(e){return"mouse"===e}function be(e){return"mouse"!==e.pointerType||0===e.button}function Me(e,t){e?.consumesClicks&&t()}const Te="attached",Se="tools";let Ve=class extends ${constructor(e){super(e),this._updatingHandles=new D,this._clock=_,this._manipulatorState=new we,this.tools=new r,this.cursor=null,this._interacting=!1,this._interactingTimeout=1e3,this._interactingTimeoutHandle=null,this._forEachTool=e=>{for(const t of this.tools.items)if(e(t))return}}initialize(){var e;this.addHandles([this.view.on(J,e=>{this._handleInputEvent(e)},Q.TOOL),...(e=this.tools,[e.on("before-add",t=>{const i=t.item;if(null==i||e.includes(i))return d.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault();i.onAdd()}),e.on("after-remove",e=>{const t=e.item;t.active&&(t.view.activeTool=null),t.destroy()})]),this.tools.on("before-add",({item:e})=>{this._updateToolEditableFlag(e)}),this.tools.on("before-remove",({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this.activeTool=null,this.tools.drain(e=>e.destroy()),this._clearInteractingTimeout(),this._interacting=!1,this._updatingHandles.destroy()}get _manipulatorStateEventArgs(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(null!=e&&!this.view.ready)return void d.getLogger(this).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const t=this.activeTool;this._set("activeTool",e),null!=t&&t.deactivate(),null!=e&&e.activate(),this._removeIncompleteTools(e);for(const e of this.tools){this._updateToolEditableFlag(e);const t=_e(e);null!=this.activeTool&&t||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!t)}this._updateCursor()}get updating(){return this._updatingHandles.updating||this.tools.some(e=>e.updating)}get interacting(){return this._interacting}_clearInteractingTimeout(){this._interactingTimeoutHandle=m(this._interactingTimeoutHandle)}_startInteractingTimeout(){this._clearInteractingTimeout(),this._interactingTimeoutHandle=this._clock.setTimeout(()=>this._interacting=!1,this._interactingTimeout)}attach(){"3d"===this.view.type?this.addHandles([S(()=>{const{state:e}=this.view;return"camera"in e&&e.camera},()=>this._forEachManipulator(e=>e.onViewChange())),this.view.elevationProvider?.on("elevation-change",e=>this._forEachManipulator(t=>t.onElevationChange(e)))],Te):this.addHandles(S(()=>this.view.extent,()=>this._forEachManipulator(e=>e.onViewChange())))}detach(){this.activeTool=null,this.tools.removeAll(),this.removeHandles(Te),this._clearInteractingTimeout(),this._interacting=!1}_forEachManipulator(e){this._forEachTool(t=>{t.manipulators&&t.manipulators.forEach(({manipulator:i})=>e(i,t))})}_handleInputEvent(e){let t=!1;const i={...e,stopPropagation:()=>{t=!0,e.stopPropagation()}};null!=this.activeTool?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool(e=>{!t&&e.visible&&e.handleInputEvent(i)}),!t&&function(e){return"key-down"===e.type&&e.key===Y.cancel}(e)&&this.activeTool&&(e.stopPropagation(),e.preventDefault(),this.activeTool.cancel(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),t||null==this.activeTool||this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor(),"pointer-move"===e.type&&(this._manipulatorState.hasFocusedManipulators()||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())}_refreshToolWatchers(){this.removeHandles(Se),this._forEachTool(e=>{if(e instanceof $){const t=S(()=>[e.cursor,e.visible,e.editable],()=>{_e(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()});this.addHandles(t,Se)}e.manipulators&&this.addHandles([e.manipulators.on("after-remove",t=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,t.item.manipulator)}),e.manipulators.on("change",()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})],Se)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateToolEditableFlag(e){e.setEditableFlag?.(1,null==this.activeTool||e===this.activeTool)}_updateCursor(){let e=this._manipulatorState.cursor;null==e&&this._forEachTool(t=>!(null==t.cursor||!t.visible||(e=t.cursor,0))),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter(t=>(null==e||t!==e)&&!t.created&&t.removeIncompleteOnCancel).forEach(e=>{this.tools.remove(e)})}get test(){}};e([L({constructOnly:!0,nonNullable:!0})],Ve.prototype,"view",void 0),e([L({value:null})],Ve.prototype,"activeTool",null),e([L({readOnly:!0,type:r})],Ve.prototype,"tools",void 0),e([L({readOnly:!0})],Ve.prototype,"cursor",void 0),e([L({readOnly:!0})],Ve.prototype,"updating",null),e([L()],Ve.prototype,"_interacting",void 0),e([L({readOnly:!0})],Ve.prototype,"interacting",null),Ve=e([x("esri.views.ToolViewManager")],Ve);let Re=class extends ${constructor(e){super(e),this.required={extent:!1,heightModelInfo:!1,tileInfo:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=y(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return this.userSpatialReference??this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return null==this.userSpatialReference||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){const e=this.map?.(),t=[];return null!=this.priorityCollection&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};let e;if(this._collectLayers(this.mapCollections,t=>{const i=this._getSupportedSpatialReferences(t);if(i.length>0){const t=this._narrowDownSpatialReferenceCandidates(e,i);null!=t&&(e=t)}return 1===e?.length})&&1!==e?.length)return{updating:!0};const t=this._pickSpatialReferenceCandidate(e);return{spatialReference:t?.spatialReference??null,viewingMode:t?.viewingMode??null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};const e=this.map?.(),t=this.spatialReference;if(!t)return{updating:this._spatialReferenceTask.updating};let i;const r=this._collectLayers([{parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers}],e=>!(!("tileInfo"in e)||!e.tileInfo?.spatialReference.equals(t)||(i=e,0)),e=>"tileInfo"in e);return i?{tileInfo:i.tileInfo,updating:!1}:{updating:r}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};let e={};const t=this._collectLayers(this.mapCollections,t=>{const i=pe(t);return!!i&&(e={heightModelInfo:i,vcsWkid:t.spatialReference?.vcsWkid,latestVcsWkid:t.spatialReference?.latestVcsWkid},!0)},e=>he(e));return{...e,updating:t}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=[],t=this._collectLayers(this.mapCollections,t=>{const i="fullExtents"in t&&t.fullExtents||(null!=t.fullExtent?[t.fullExtent]:[]),r=this.requiresExtentInSpatialReference?null:i[0],s=i.find(e=>e.spatialReference.equals(this.spatialReference))??r;if(s)return e.push({extent:s,layer:t}),!0;if(this._getSupportedSpatialReferences(t).length>0)for(const r of i)e.push({extent:r,layer:t});return!1});return{candidates:e,updating:t}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(null==e||0===e.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const r=this._pickExtentCandidate(e),s=this.spatialReference;return r.extent.equals(this._projectExtentTask.input)&&s.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:null!=this._projectExtentTask.task&&!this._projectExtentTask.task.finished}:(null!=this._projectExtentTask.task&&(this._projectExtentTask.task=y(this._projectExtentTask.task)),this._projectExtentTask={input:r.extent.clone(),output:null,spatialReference:s.clone(),task:i(async e=>{try{const t=await ue(r.extent,s,"portalItem"in r.layer?r.layer.portalItem:void 0,e);this._projectExtentTask={...this._projectExtentTask,task:null,output:t}}catch(t){if(w(e))return;this._projectExtentTask={...this._projectExtentTask,task:null}}})},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(null==e)return t;const i=new Array;for(const r of e)for(const e of t){if(!r.spatialReference.equals(e.spatialReference))continue;const t=Ee(r.viewingMode,e.viewingMode);if(!1!==t){i.push({spatialReference:r.spatialReference,viewingMode:t});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return null==e||e.length<1?t?{spatialReference:t,viewingMode:null}:null:(null!=t&&e.length>1&&e.some(({spatialReference:e})=>e.equals(t))&&(e=e.filter(({spatialReference:e})=>e.equals(t))),e.length>1&&e.some(({viewingMode:e})=>2!==e)&&(e=e.filter(({viewingMode:e})=>2!==e)),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const i=[];for(const r of t){const t=this.getSpatialReferenceSupport(r,e);if(null!=t){const e=t.constraints??[{spatialReference:r,viewingMode:null}];for(const{spatialReference:t,viewingMode:r}of e)this.requiresExtentInSpatialReference&&null!=this.userSpatialReference&&!t.equals(this.userSpatialReference)||i.push({spatialReference:t,viewingMode:r})}}return i}_pickExtentCandidate(e){const t=this.spatialReference;return e.find(({extent:e})=>t.equals(e.spatialReference))||e[0]}_collectLayers(e,t,i=()=>!0){switch(this._loadMaybe(this.map?.())){case"loading":return!0;case"failed":return!1}const r=new Ie(i,t);for(const t of e)if(this._collectCollection(t,r),r.done||r.preloading===this.sourcePreloadCount)break;return r.updating}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const i of e.layers)if(t.layerFilter(i)){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":if(t.updating||(t.done=t.pushLayer(i)),t.done||t.preloading===this.sourcePreloadCount)break;"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.done||t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&null!=e.loadStatus?"not-loaded"===e.loadStatus?(e.load().catch(e=>{v(e)}),"loading"):e.loadStatus:"loaded"}};e([L()],Re.prototype,"required",void 0),e([L({constructOnly:!0})],Re.prototype,"map",void 0),e([L({constructOnly:!0})],Re.prototype,"getSpatialReferenceSupport",void 0),e([L()],Re.prototype,"defaultSpatialReference",void 0),e([L()],Re.prototype,"userSpatialReference",void 0),e([L()],Re.prototype,"sourcePreloadCount",void 0),e([L()],Re.prototype,"priorityCollection",void 0),e([L()],Re.prototype,"requiresExtentInSpatialReference",void 0),e([L()],Re.prototype,"suspended",void 0),e([L({readOnly:!0})],Re.prototype,"ready",null),e([L({readOnly:!0})],Re.prototype,"heightModelInfoReady",null),e([L({readOnly:!0})],Re.prototype,"spatialReference",null),e([L({readOnly:!0})],Re.prototype,"extent",null),e([L({readOnly:!0})],Re.prototype,"heightModelInfo",null),e([L({readOnly:!0})],Re.prototype,"vcsWkid",null),e([L({readOnly:!0})],Re.prototype,"latestVcsWkid",null),e([L({readOnly:!0})],Re.prototype,"viewingMode",null),e([L({readOnly:!0})],Re.prototype,"tileInfo",null),e([L({readOnly:!0})],Re.prototype,"mapCollections",null),e([L({readOnly:!0})],Re.prototype,"_spatialReferenceTask",null),e([L({readOnly:!0})],Re.prototype,"_tileInfoTask",null),e([L({readOnly:!0})],Re.prototype,"_heightModelInfoTask",null),e([L({readOnly:!0})],Re.prototype,"_extentCandidatesTask",null),e([L()],Re.prototype,"_extentTask",null),e([L()],Re.prototype,"_projectExtentTask",void 0),Re=e([x("esri.views.support.DefaultsFromMap")],Re);class Ie{constructor(e,t){this.layerFilter=e,this.pushLayer=t,this.preloading=-1,this.updating=!1,this.done=!1}}function Ee(e,t){return null!=e?null!=t?e===t&&e:e:t}class Ce{constructor(e,t,i){this.layer=e,this.view=t,this.layerViewImporter=i,this._controller=new AbortController,this._deferred=j(),this._started=!1,this.done=!1,this.promise=this._deferred.promise,k(this._controller.signal,()=>{this._recycleController?.abort();const t=new a("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(t)})}tryRecycle(e){if(!this.done||!this.layerView||!("tryRecycleWith"in this.layerView))return null;this._recycleController?.abort(),this._recycleController=new AbortController;const t=this.layer.type,i=this._recycleController.signal;for(let r=0;r<e.length;r++){const s=e[r];if(s.type!==t)continue;const o=this.layerView.tryRecycleWith(s,{signal:i});if(o){e.splice(r,1),this.layer=s;const t=this.layerView,a=t.view;return this.promise=o.then(()=>(b(i),s.emit("layerview-destroy",{view:a,layerView:t}),a.emit("layerview-destroy",{view:a,layerView:t}),s.emit("layerview-create",{view:a,layerView:t}),a.emit("layerview-create",{view:a,layerView:t}),t)),this.promise}}return null}destroy(){this._controller.abort();const{layerView:e}=this;if(e){const{layer:t,view:i}=this;t.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:t,layerView:e})}this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null,this._map=null}async start(){const{view:e}=this;if(this._started||!e.map)return;this._started=!0;const{_controller:{signal:t},layer:i}=this;this._map=e.map;try{let r,s;if(await i.load({signal:t}),i.prefetchResources&&await i.prefetchResources({signal:t}),function(e){return e.createLayerView!==ge.prototype.createLayerView}(i))r=await i.createLayerView(e,{signal:t});else{if(!this.layerViewImporter.hasLayerViewModule(i))throw new a("layer:view-not-supported","No layerview implementation was found");const s=await this.layerViewImporter.importLayerView(i);b(t),r="default"in s?new s.default({layer:i,view:e}):new s({layer:i,view:e})}const o=()=>{s=m(s),r.destroyed||r.destroy(),this.done=!0};s=k(t,o),b(t);try{await r.when()}catch(e){throw o(),e}const n=this._map?.allLayers?.includes(i);if(!n)return o(),void this._deferred.reject(new a("view:no-layerview-for-layer","The layer has been removed from the map",{layer:i}));this.layerView=r,i.emit("layerview-create",{view:e,layerView:r}),e.emit("layerview-create",{layer:i,layerView:r}),this.done=!0,this._deferred.resolve(r)}catch(t){i.emit("layerview-create-error",{view:e,error:t}),e.emit("layerview-create-error",{layer:i,error:t}),this.done=!0,this._deferred.reject(new a("layerview:create-error","layerview creation failed",{layer:i,error:t}))}}}function Le(e){return null!=e&&"object"==typeof e&&"layerViews"in e}let xe=class extends ${constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new D,this.supportsGround=!0,this._preloadLayerViewModules=()=>{const e=this.view.map?.allLayers;if(e)for(const t of e)!1!==this.layerViewFilter?.(t)&&this.layerViewImporter.hasLayerViewModule(t)&&this.layerViewImporter.importLayerView(t)},this._reschedule=()=>this.destroyed?Promise.reject():(null==this._workPromise&&(this._workPromise=j(),this._workPromise.promise.catch(()=>{})),this.removeHandles("reschedule"),this.addHandles(de(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{if(this.destroyed)return;const{map:e}=this.view;if(!e)return void this.clear();if(this._map!==e&&(this.clear(),this._map=e),null==this._workPromise)return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");const t=new Set,i=[],r=this.view.ready,s=e=>{if(null!=e)for(const o of e)if(o){if(!1===this.layerViewFilter?.(o))continue;t.add(o);const e=this._layerLayerViewInfoMap.get(o);e&&r?e.start():e||this._recyclingInfoMap.has(o)||i.push(o),"layers"in o&&o.layers&&s(o.layers)}};for(const e of this._rootCollectionNames)s(me(this,e));const o=new Array,a=e=>{const t=e.tryRecycle(i);t?(this._recyclingInfoMap.set(e.layer,e),this.notifyChange("updating"),t.then(()=>{this._recyclingInfoMap.delete(e.layer),this._layerLayerViewInfoMap.set(e.layer,e),this._reschedule(),this.notifyChange("updating")}).catch(t=>{v(t)||(this._recyclingInfoMap.delete(e.layer),e.destroy(),this._reschedule(),this.notifyChange("updating"))})):o.push(e)};for(const e of this._layerLayerViewInfoMap.values())t.has(e.layer)||(this._layerLayerViewInfoMap.delete(e.layer),a(e));for(const e of this._recyclingInfoMap.values())t.has(e.layer)||(this._recyclingInfoMap.delete(e.layer),a(e));for(const e of i)this._createLayerView(e);this._refreshCollections(),o.forEach(e=>e.destroy());const n=[e?.ground?.layers,e?.basemap?.baseLayers,e?.basemap?.referenceLayers,e?.layers].filter(e=>!!e);t.forEach(e=>"layers"in e&&n.push(e.layers)),this.addHandles(n.map(e=>this._watchUpdatingTracking.addOnCollectionChange(()=>e,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.addHandles([V(()=>this.view?.map?.allLayers,"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),S(()=>{const e=this.view,t=e?.map;return[t?.basemap,t?.ground,t?.layers,e?.ready]},()=>this._reschedule(),R)]),this._preloadLayerViewModules(),this._reschedule()}clearHandles(){this._watchUpdatingTracking.removeAll()}destroy(){this.clear(),ye(this._recyclingInfoMap),ye(this._layerLayerViewInfoMap),this._watchUpdatingTracking.destroy(),this._map=null,null!=this._workPromise&&(this._workPromise.reject(M()),this._workPromise=null)}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return null!=this._workPromise||this._watchUpdatingTracking.updating||ce(this._layerLayerViewInfoMap,e=>!e.done)||this._recyclingInfoMap.size>0}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){this.destroyed||(this._clearCollections(),ye(this._layerLayerViewInfoMap))}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e)){if(this._recyclingInfoMap.has(e))return this._recyclingInfoMap.get(e).promise;throw new a("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e})}return this._layerLayerViewInfoMap.get(e).promise}isCreatingLayerViewsForLayer(e,t){this.commitProperty("updatingRemaining");const i=this._layerLayerViewInfoMap.get(e);if(!i?.done)return!0;const r=i.layerView;return!(!r||!t||r.parent===t)||!!(i.done&&r&&"layers"in e&&e.layers?.length)&&e.layers.some(e=>this.isCreatingLayerViewsForLayer(e,r))}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(me(this,e),me(this,t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_clearCollections(){for(const e of this._layersToLayerViews.values())me(this,e)?.removeAll()}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void t?.removeAll();let r=0;for(const s of e){const e=this._layerLayerViewInfoMap.get(s);if(!e?.layerView)continue;const o=e.layerView;o.layer=s,o.parent=i,t.at(r)!==o&&t.splice(r,0,o),"layers"in s&&Le(o)&&this._populateLayerViewsOwners(s.layers,o.layerViews,o),r+=1}r<t.length&&t.splice(r)}_createLayerView(e){e.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new Ce(e,this.view,this.layerViewImporter);t.promise.then(()=>this._refreshCollections(),t=>{t&&(v(t)||"cancelled:layerview-create"===t.name)||d.getLogger(this).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:t}),this._refreshCollections()}),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};e([L()],xe.prototype,"_workPromise",void 0),e([L({readOnly:!0})],xe.prototype,"_watchUpdatingTracking",void 0),e([L({readOnly:!0})],xe.prototype,"_layersToLayerViews",null),e([L({readOnly:!0})],xe.prototype,"_rootCollectionNames",null),e([L({constructOnly:!0})],xe.prototype,"layerViewFilter",void 0),e([L()],xe.prototype,"layerViewImporter",void 0),e([L()],xe.prototype,"supportsGround",void 0),e([L({readOnly:!0})],xe.prototype,"updating",null),e([L({readOnly:!0})],xe.prototype,"updatingRemaining",null),e([L({constructOnly:!0})],xe.prototype,"view",void 0),xe=e([x("esri.views.support.LayerViewManager")],xe);const Pe=xe;let Fe=class extends ${constructor(e){super(e),this.featureTitleFields=!1,this.utilityNetworkFields=!1,this.globalIdField=!1}};e([L()],Fe.prototype,"featureTitleFields",void 0),e([L()],Fe.prototype,"utilityNetworkFields",void 0),e([L()],Fe.prototype,"globalIdField",void 0),Fe=e([x("esri.views.support.RequiredFieldsOptions")],Fe);const Oe=Fe;var De;let Ue=class extends(n(f)){static{De=this}constructor(e){super(e),this._userSpatialReference=null,this.handles=new l,this.updatingHandles=new D,this.allLayerViews=new s({getCollections:()=>[this.basemapView?.baseLayerViews,this.groundView?.layerViews,this.layerViews,this.basemapView?.referenceLayerViews],getChildrenFunction:qe}),this.analyses=new fe,this.basemapView=null,this.displayFilterEnabled=!0,this.fatalError=null,this.graphics=new F,this.groundView=null,this.typeSpecificPreconditionsReady=!0,this.layerViews=new r,this.magnifier=new Z,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this._readyStateWaitingTask=null,this.supportsGround=!0,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this._lowPriorityCursorHandles=new r,this._highPriorityCursorHandles=new r,this.input=new ne,this.navigation=new le,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new X(this),this.persistableViewModels=new r,this.requiredFieldsOptions=new Oe,this._isValid=!1,this._readyCycleForced=!1,this._lockedSpatialReference=null,this._userTimeZone=null,this._lockedTimeZone=null,this._userTimeExtent=null,this._lockedTimeExtent=null,this.theme=null,this.handles.add(S(()=>this.preconditionsReady,e=>{const t=this.ready;if(e?(this._lockedSpatialReference=this.spatialReference,this._lockedTimeZone=this.timeZone,this._lockedTimeExtent=this.timeExtent,De.views.add(this)):(this._lockedSpatialReference=null,De.views.remove(this)),this.notifyChange("spatialReference"),!e&&t)this.toolViewManager?.detach(),null!=this.analysisViewManager&&this.analysisViewManager.detach(),this.layerViewManager?.clear(),this._teardown();else if(e&&!t){try{this._startup()}catch(e){return void queueMicrotask(()=>{this.fatalError=new a("view:startup-error","View._startup failed",e)})}null!=this.analysisViewManager&&this.analysisViewManager.attach(),this.toolViewManager.attach()}},I))}initialize(){this.addResolvingPromise(Promise.all([this.loadAsyncDependencies(),this.validate()]).then(()=>(this._isValid=!0,E(()=>this.ready)))),this.basemapView=new G({view:this}),this.layerViewManager=new Pe({view:this,layerViewFilter:e=>this.layerViewFilter?.(e)??!0,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new Ve({view:this}),this.selectionManager=new B({view:this}),this.addHandles([C(()=>"map-content-error"===this.readyState&&!this.spatialReference,()=>{d.getLogger(this).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),S(()=>this.initialExtentRequired,e=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:e},R),S(()=>this.ready,e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)},I),S(()=>this._userSpatialReference,e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)},R)])}destroy(){this.destroyed||(De.views.remove(this),this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=g(this.graphics),this.analyses=g(this.analyses),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),g(this.analysisViewManager),this.toolViewManager=g(this.toolViewManager),this.layerViewManager=g(this.layerViewManager),this.selectionManager=g(this.selectionManager),this.basemapView=g(this.basemapView),this.groundView?.destroy(),this.layerViews?.forEach(e=>e.destroy()),this.layerViews.length=0,this.invalidate(),this.handles.destroy(),this.map=g(this.map),this.updatingHandles.destroy())}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return d.getLogger(this).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){return this.toolViewManager?.activeTool}set activeTool(e){this.toolViewManager&&(this.toolViewManager.activeTool=e)}get animation(){return this._get("animation")}set animation(e){this._set("animation",e)}get center(){return null}get defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new Re({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:(e,t)=>this.getSpatialReferenceSupport(e,t),...this.defaultsFromMapSettings})}get extent(){return this._get("extent")}set extent(e){this._set("extent",e)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get highlights(){return this._get("highlights")??new(r.ofType(ae))([new ae({name:re}),new ae({name:oe,color:se})])}set highlights(e){this._set("highlights",o(e,this._get("highlights"),r.ofType(ae)))}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){return!this.destroying&&!this.destroyed&&!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||c(this.map)&&!this.map.loaded||0===this.width||0===this.height||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._lockedSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(e){e!==this._get("map")&&(e?.destroyed&&(d.getLogger(this).warn("#map","The provided map is already destroyed",{map:e}),e=null),c(e)&&e.load().catch(()=>{}),this.constructed&&!this.destroyed&&(this.forceReadyCycle(),this._lockedSpatialReference=null),this._set("map",e))}get readyState(){if(this.destroyed)return this._get("readyState");if(!this.map)return"missing-map";if("container"in this&&!this.container)return"missing-container";if(this.fatalError)return"rendering-error";if(this.defaultsFromMap?.ready&&!this.spatialReference){const e=!("loaded"in this.map)||this.map.loaded,t=this.map.ground.loaded,r=this.map.basemap?.loaded??!0;return e&&r&&t&&!this.map?.allLayers.length?"empty-map":(this._readyStateWaitingTask||(this._readyStateWaitingTask=i(e=>T(u("view-readyState-waiting-delay"),null,e)),this.addHandles(this._readyStateWaitingTask),this.addHandles(this._readyStateWaitingTask,"ready-state-task")),this._readyStateWaitingTask?.finished?"map-content-error":"loading")}return this._readyStateWaitingTask=y(this._readyStateWaitingTask),this.removeHandles("ready-state-task"),this.ready?"ready":"loading"}get spatialReference(){const e=this._userSpatialReference||this._lockedSpatialReference||this.getDefaultSpatialReference()||null;if(e&&this.defaultsFromMap?.required?.heightModelInfo){const t=e.clone();return t.vcsWkid=this.defaultsFromMap.vcsWkid,t.latestVcsWkid=this.defaultsFromMap.latestVcsWkid,t}return e}set spatialReference(e){const t=!q(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get timeExtent(){return this._userTimeExtent??this._lockedTimeExtent??this.getDefaultTimeExtent()??null}set timeExtent(e){this._userTimeExtent=e}get timeZone(){return this._userTimeZone??this._lockedTimeZone??this.getDefaultTimeZone()??W}set timeZone(e){this._userTimeZone=e,z(e)||d.getLogger(this).warn("#timeZone",`the parsed value '${e}' may not be a valid IANA time zone`)}get tools(){return this.toolViewManager?.tools}get initialExtent(){return this.defaultsFromMap?.extent}get cursor(){return this.toolViewManager?.cursor??this._highPriorityCursorHandles.at(-1)?.cursor??this._lowPriorityCursorHandles.at(-1)?.cursor??"default"}acquireCursor(e,t="low"){const i="high"===t?this._highPriorityCursorHandles:this._lowPriorityCursorHandles,r={cursor:e},s=h(()=>i.remove(r));return i.add(r),this.addHandles(s),s}get size(){return[this.width,this.height]}get effectiveTheme(){return this.theme??new K}whenLayerView(e){return this.layerViewManager?.whenLayerView(e)??Promise.reject()}getDefaultSpatialReference(){return this.defaultsFromMap?.spatialReference}getDefaultHeightModelInfo(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null}getDefaultTimeZone(){return null}getDefaultTimeExtent(){return null}importLayerView(e){throw new a("view:importLayerView-missing","importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}async loadAsyncDependencies(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(e){return null!=this.getSpatialReferenceSupport(e)}when(e,t){return this.isResolved()&&!this.ready&&d.getLogger(this).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&(C(()=>this.destroyed||!1===this.preconditionsReady,()=>this._readyCycleForced=!1,{once:!0}),this._readyCycleForced=!0)}on(e,t){return super.on(e,t)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}static{this.views=new r}};e([L()],Ue.prototype,"_userSpatialReference",void 0),e([L()],Ue.prototype,"activeTool",null),e([L({readOnly:!0})],Ue.prototype,"allLayerViews",void 0),e([L(O(fe,"analyses"))],Ue.prototype,"analyses",void 0),e([L()],Ue.prototype,"animation",null),e([L()],Ue.prototype,"basemapView",void 0),e([L()],Ue.prototype,"center",null),e([L()],Ue.prototype,"defaultsFromMapSettings",null),e([L()],Ue.prototype,"defaultsFromMap",null),e([L()],Ue.prototype,"displayFilterEnabled",void 0),e([L({type:U})],Ue.prototype,"extent",null),e([L()],Ue.prototype,"fatalError",void 0),e([L(O(F,"graphics"))],Ue.prototype,"graphics",void 0),e([L()],Ue.prototype,"groundView",void 0),e([L({readOnly:!0,type:A})],Ue.prototype,"heightModelInfo",null),e([L({type:r.ofType(ae)})],Ue.prototype,"highlights",null),e([L({readOnly:!0})],Ue.prototype,"interacting",null),e([L({constructOnly:!0})],Ue.prototype,"layerViewFilter",void 0),e([L({readOnly:!0})],Ue.prototype,"navigating",null),e([L({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_lockedSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],Ue.prototype,"preconditionsReady",null),e([L({readOnly:!0})],Ue.prototype,"typeSpecificPreconditionsReady",void 0),e([L({type:r,readOnly:!0})],Ue.prototype,"layerViews",void 0),e([L()],Ue.prototype,"resolution",null),e([L({type:Z})],Ue.prototype,"magnifier",void 0),e([L({value:null,type:t})],Ue.prototype,"map",null),e([L()],Ue.prototype,"padding",void 0),e([L({readOnly:!0})],Ue.prototype,"ready",void 0),e([L()],Ue.prototype,"_readyStateWaitingTask",void 0),e([L({readOnly:!0})],Ue.prototype,"readyState",null),e([L({type:H})],Ue.prototype,"spatialReference",null),e([L()],Ue.prototype,"stationary",null),e([L({readOnly:!0})],Ue.prototype,"supportsGround",void 0),e([L({type:N})],Ue.prototype,"timeExtent",null),e([L({type:String,nonNullable:!0})],Ue.prototype,"timeZone",null),e([L()],Ue.prototype,"tools",null),e([L()],Ue.prototype,"toolViewManager",void 0),e([L({readOnly:!0})],Ue.prototype,"type",void 0),e([L({type:Number})],Ue.prototype,"scale",void 0),e([L({readOnly:!0})],Ue.prototype,"updating",void 0),e([L({readOnly:!0})],Ue.prototype,"initialExtentRequired",void 0),e([L({readOnly:!0})],Ue.prototype,"initialExtent",null),e([L()],Ue.prototype,"cursor",null),e([L({readOnly:!0})],Ue.prototype,"input",void 0),e([L({type:le,nonNullable:!0})],Ue.prototype,"navigation",void 0),e([L()],Ue.prototype,"layerViewManager",void 0),e([L()],Ue.prototype,"analysisViewManager",void 0),e([L()],Ue.prototype,"selectionManager",void 0),e([L()],Ue.prototype,"width",void 0),e([L()],Ue.prototype,"height",void 0),e([L({readOnly:!0})],Ue.prototype,"resizing",void 0),e([L({value:null,readOnly:!0})],Ue.prototype,"size",null),e([L({readOnly:!0})],Ue.prototype,"suspended",void 0),e([L({readOnly:!0})],Ue.prototype,"viewEvents",void 0),e([L({readOnly:!0})],Ue.prototype,"persistableViewModels",void 0),e([L()],Ue.prototype,"_isValid",void 0),e([L()],Ue.prototype,"_readyCycleForced",void 0),e([L()],Ue.prototype,"_lockedSpatialReference",void 0),e([L()],Ue.prototype,"_userTimeZone",void 0),e([L()],Ue.prototype,"_lockedTimeZone",void 0),e([L()],Ue.prototype,"_userTimeExtent",void 0),e([L()],Ue.prototype,"_lockedTimeExtent",void 0),e([L({type:K})],Ue.prototype,"theme",void 0),e([L({readOnly:!0,type:K})],Ue.prototype,"effectiveTheme",null),Ue=De=e([x("esri.views.View")],Ue);const Ae=globalThis.$arcgis;Ae&&!Ae.views&&Object.defineProperty(Ae,"views",{configurable:!1,enumerable:!0,writable:!1,value:Ue.views});const He=Ue;function qe(e){return e.layerViews}export{fe as A,He as default};
