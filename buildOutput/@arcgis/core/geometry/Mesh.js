/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import{Clonable as t,ClonableMixin as r}from"../core/Clonable.js";import s from"../core/Error.js";import{LoadableMixin as o}from"../core/Loadable.js";import{L as n}from"../chunks/Logger.js";import{EsriPromiseMixin as i}from"../core/Promise.js";import{whenOrAbort as a,throwIfAborted as c,allSettledValues as l,isAborted as u,createAbortError as p}from"../core/promiseUtils.js";import{on as m,watch as f}from"../core/reactiveUtils.js";import{property as h}from"../core/accessorSupport/decorators/property.js";import{q as d}from"../core/lang.js";import{subclass as g}from"../core/accessorSupport/decorators/subclass.js";import{c as x,f as y,Z as v,O as j}from"../chunks/vec3f64.js";import w from"./Geometry.js";import b from"./Point.js";import k from"./Polygon.js";import{C as A,t as S,v as R,c as M,D as F}from"../chunks/aaBoundingBox.js";import{c as U,a as L,d as O,e as C,g as T}from"../chunks/axisAngleDegrees.js";import _ from"./support/MeshComponent.js";import P from"./support/MeshGeoreferencedVertexSpace.js";import D from"./support/MeshLocalVertexSpace.js";import E from"./support/MeshTransform.js";import{M as z}from"../chunks/MeshVertexAttributes.js";import{i as B,s as G,a as I,b as V}from"../chunks/meshVertexSpaceUtils.js";import{t as q}from"../chunks/triangulationUtils.js";import{h as N,j as $,q as W,n as Z,k as H,I as J,t as K,i as X}from"../chunks/vec3.js";import{p as Y}from"../chunks/projectPointToVector.js";import{a as Q}from"../core/Accessor.js";import{l as ee,a as te,c as re,g as se,p as oe,b as ne,d as ie,e as ae,f as ce,h as le,i as ue}from"../chunks/vertexSpaceConversion.js";import{c as pe}from"../chunks/mat4f64.js";import me from"./Extent.js";import{canProjectWithoutEngine as fe}from"../chunks/projectionUtils.js";import{g as he}from"../chunks/spatialReferenceEllipsoidUtils.js";import{c as de}from"../chunks/computeTranslationToOriginAndRotation.js";import{p as ge}from"../chunks/projectBuffer.js";import{n as xe}from"../chunks/DoubleArray.js";import{b as ye,a as ve}from"../chunks/vec32.js";import{removeFile as je,makeRelative as we}from"../core/urlUtils.js";import{d as be,a as ke,e as Ae}from"../chunks/meshCloneUtils.js";import Se from"../core/Collection.js";import{d as Re,f as Me,e as Fe}from"../chunks/External.js";import{c as Ue}from"../chunks/mat3f64.js";import{f as Le}from"../chunks/mat3.js";import{C as Oe,m as Ce,u as Te,k as _e,w as Pe,a as De}from"../chunks/mat4.js";import{s as Ee}from"../chunks/quat.js";import{c as ze,I as Be}from"../chunks/quatf64.js";import"../chunks/maybe.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../core/Handles.js";import"../chunks/get.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/ensureType.js";import"../chunks/MapUtils.js";import"../chunks/object.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../config.js";import"../chunks/string.js";import"../chunks/events.js";import"../chunks/SetUtils.js";import"../chunks/SimpleTrackingTarget.js";import"../chunks/Warning.js";import"../core/JSONSupport.js";import"../chunks/reader.js";import"./SpatialReference.js";import"../chunks/unitUtils.js";import"../chunks/jsonMap.js";import"../chunks/pe.js";import"../chunks/assets.js";import"../request.js";import"../kernel.js";import"../chunks/jsonUtils.js";import"../chunks/persistableUrlUtils.js";import"../chunks/writer.js";import"../core/accessorSupport/decorators/cast.js";import"./support/webMercatorUtils.js";import"../chunks/coordsUtils.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../chunks/zmUtils.js";import"./support/MeshMaterial.js";import"../Color.js";import"../chunks/colorUtils.js";import"./support/MeshTexture.js";import"../chunks/imageUtils.js";import"./support/MeshTextureTransform.js";import"./support/MeshMaterialMetallicRoughness.js";import"../chunks/meshProperties.js";import"../chunks/enumeration.js";import"../chunks/common.js";import"../chunks/vec4.js";import"../chunks/earcut.js";import"../chunks/Indices.js";import"../chunks/plane.js";import"../chunks/vector.js";import"../chunks/vec2f64.js";import"../chunks/vec4f64.js";import"../chunks/mathUtils2.js";import"../chunks/deduplicate.js";import"../chunks/BufferView.js";import"../chunks/vec2.js";import"../chunks/vec42.js";import"../chunks/SimpleObservable.js";import"./Multipoint.js";import"./Polyline.js";import"../chunks/projectXYZToVector.js";import"./support/GeographicTransformation.js";import"./support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/geodesicConstants.js";import"../core/Evented.js";import"../chunks/shared.js";import"../chunks/infoFor3D.js";const Ge="Expected location to be a Point instance";class Ie extends s{constructor(){super("invalid-input:location",Ge)}}function Ve(e,t){return e.isGeographic||e.isWebMercator&&(t??!0)}function qe(e,t,r,s){if(void 0!==s){Q(e(),"option: geographic",{replacement:"Use mesh `vertexSpace` and spatial reference to control how operations are performed instead.",version:"4.30",warnOnce:!0});const o="local"===t.type;if(!B(t)||s===o)return r.isGeographic||r.isWebMercator&&s;e().warnOnce(`Specifying the 'geographic' parameter (${s}) for a Mesh vertex space of type "${t.type}" is not supported. This parameter will be ignored.`)}switch(t.type){case"georeferenced":return r.isGeographic;case"local":return r.isGeographic||r.isWebMercator}}const Ne=()=>n.getLogger("esri.geometry.support.meshUtils.centerAt"),$e=x(),We=x(),Ze=x(),He=pe(),Je=xe(24);function Ke(e){const t=je(e.url);return r=>{const s=we(r,t,t),o=s?s.replace(/^ *\.\//,""):null;return(o?e.files.get(o):null)??r}}function Xe(e){return ot.fromBlob(e,nt(e.name,e.type))}const Ye=/^model\/gltf\+json$/,Qe=/^model\/gltf-binary$/,et=/\.gltf$/i,tt=/\.glb$/i;function rt({mimeType:e,source:t,name:r}){return Ye.test(e)||et.test(r)?{url:t.url,type:"gltf"}:Qe.test(e)||tt.test(r)?{url:t.url,type:"glb"}:null}function st(e){const t=new Map;let r=null,o=null;for(const s of e){const{source:e,name:n}=s;r??=rt(s),"ESRI3DO_NORM.glb"===n&&(o=rt(s)),t.set(n,e.url),e.files.forEach((e,r)=>t.set(r,e))}const n=o??r;if(null==n)throw new s("mesh-load-external:missing-files","Missing files to load external mesh source");return new ot(n.url,()=>e.forEach(({source:e})=>e.dispose()),t,n.type)}class ot{constructor(e,t=()=>{},r=new Map,s){this.url=e,this.dispose=t,this.files=r,this.type=s}static fromBlob(e,t){const r=URL.createObjectURL(e);return new ot(r,()=>URL.revokeObjectURL(r),void 0,t)}}function nt(e,t){return Ye.test(t)||et.test(e)?"gltf":Qe.test(t)||et.test(e)?"glb":void 0}let it=class extends t{constructor(e){super(e),this.externalSources=new Se,this._explicitDisplaySource=null,this.georeferenced=!1,this.addHandles(m(()=>this.externalSources,"after-remove",({item:e})=>{e===this._explicitDisplaySource&&(this._explicitDisplaySource=null)},{sync:!0,onListenerRemove:()=>this._explicitDisplaySource=null}))}get displaySource(){return this._explicitDisplaySource??this._implicitDisplaySource}set displaySource(e){if(null!=e&&!Re(e))throw new Error("Cannot use this source for display: it is not in a supported format.");this._explicitDisplaySource=e,e&&this.externalSources.every(t=>!Me(t,e))&&this.externalSources.add(e)}clearSources(){this.externalSources.removeAll()}getExternalSourcesOnService(e){return this.externalSources.items.filter(t=>Fe(t,e))}get _implicitDisplaySource(){return this.externalSources.find(Re)}};e([h()],it.prototype,"externalSources",void 0),e([h()],it.prototype,"displaySource",null),e([h()],it.prototype,"_implicitDisplaySource",null),e([h()],it.prototype,"_explicitDisplaySource",void 0),e([h()],it.prototype,"georeferenced",void 0),it=e([g("esri.geometry.support.meshUtils.Metadata")],it);const at={position:[-.5,-.5,0,.5,-.5,0,.5,.5,0,-.5,.5,0],normal:[0,0,1,0,0,1,0,0,1,0,0,1],uv:[0,1,1,1,1,0,0,0],faces:[0,1,2,0,2,3],facingAxisOrderSwap:{east:[3,1,2],west:[-3,-1,2],north:[-1,3,2],south:[1,-3,2],up:[1,2,3],down:[1,-2,-3]}};function ct(e,t,r){e.isPlane||function(e){for(let t=0;t<e.position.length;t+=3)e.position[t+2]+=.5}(e),function(e,t){if(null!=t){mt[0]=t[0],mt[4]=t[1],mt[8]=t[2];for(let t=0;t<e.position.length;t+=3){for(let r=0;r<3;r++)pt[r]=e.position[t+r];W(pt,pt,mt);for(let r=0;r<3;r++)e.position[t+r]=pt[r]}if(t[0]!==t[1]||t[1]!==t[2]){mt[0]=1/t[0],mt[4]=1/t[1],mt[8]=1/t[2];for(let t=0;t<e.normal.length;t+=3){for(let r=0;r<3;r++)pt[r]=e.normal[t+r];W(pt,pt,mt),Z(pt,pt);for(let r=0;r<3;r++)e.normal[t+r]=pt[r]}}}}(e,function(e,t,r){const s=se(t,r);if(null==e&&1===s)return null;if(null==e)return[s,s,s];if("number"==typeof e){const t=e*s;return[t,t,t]}return[null!=e.width?e.width*s:s,null!=e.depth?e.depth*s:s,null!=e.height?e.height*s:s]}(r?.size,r?.unit,t.spatialReference));const s=G(t,r),o=t.spatialReference.isGeographic?G(t):s,n=re({vertexAttributes:e,vertexSpace:o,spatialReference:t.spatialReference},s,{allowBufferReuse:!0});return{vertexAttributes:new z({...n,uv:e.uv}),vertexSpace:s,components:[new _({faces:e.faces,material:r?.material||null})],spatialReference:t.spatialReference}}const lt={faceDescriptions:[{axis:[0,-1,0],uvOrigin:[0,.625],corners:[[-1,-1],[1,-1],[1,1],[-1,1]]},{axis:[1,0,0],uvOrigin:[.25,.625],corners:[[-1,-1],[1,-1],[1,1],[-1,1]]},{axis:[0,1,0],uvOrigin:[.5,.625],corners:[[1,-1],[-1,-1],[-1,1],[1,1]]},{axis:[-1,0,0],uvOrigin:[.75,.625],corners:[[1,-1],[-1,-1],[-1,1],[1,1]]},{axis:[0,0,1],uvOrigin:[0,.375],corners:[[-1,-1],[1,-1],[1,1],[-1,1]]},{axis:[0,0,-1],uvOrigin:[0,.875],corners:[[-1,1],[1,1],[1,-1],[-1,-1]]}],uvScales:[[0,0],[1,0],[1,1],[0,1]],faceVertexOffsets:[0,1,2,0,2,3]},ut={south:0,east:1,north:2,west:3,up:4,down:5},pt=x(),mt=Ue(),ft=()=>n.getLogger("esri.geometry.support.meshUtils.rotate");function ht(e,t,r,s=v){if(null!=e){De(yt,U(t),L(t));for(let t=0;t<e.length;t+=r){for(let r=0;r<3;r++)dt[r]=e[t+r]-s[r];K(dt,dt,yt);for(let r=0;r<3;r++)e[t+r]=dt[r]+s[r]}}}const dt=x(),gt=pe(),xt=C(),yt=pe(),vt=Ue(),jt=x(),wt=ze(),bt=()=>n.getLogger("esri.geometry.support.meshUtils.scale");function kt(e,t,r=v){if(e)for(let s=0;s<e.length;s+=3){for(let t=0;t<3;t++)At[t]=e[s+t]-r[t];X(At,At,t);for(let t=0;t<3;t++)e[s+t]=At[t]+r[t]}}const At=x(),St=x(),Rt=pe(),Mt=x();var Ft;const Ut={base:null,key:"type",defaultKeyValue:"georeferenced",typeMap:{georeferenced:P,local:D}};let Lt=Ft=class extends(r(o(i(w)))){constructor(e){super(e),this.components=null,this.vertexSpace=new P,this.transform=null,this.metadata=new it,this.hasZ=!0,this.hasM=!1,this.vertexAttributes=new z,this.type="mesh"}initialize(){(0===this.metadata.externalSources.length||this.vertexAttributes.position.length)&&(this.loadStatus="loaded"),this.when(()=>{this.addHandles(f(()=>({vertexAttributes:this.vertexAttributes,components:this.components?.map(e=>e.clone())}),()=>this._clearSources(),{once:!0,sync:!0}))})}get hasExtent(){return this.loaded?this.vertexAttributes.position.length>0&&(!this.components||this.components.length>0):null!=this.metadata.displaySource?.extent}get _transformedExtent(){const{spatialReference:e,vertexSpace:t}=this,r=this;return function(e){const{spatialReference:t,vertexSpace:r,untransformedBounds:s}=e,o=A(s,Je);if(B(r)&&e.transform&&ye(o,o,e.transform.localMatrix),"georeferenced"===r.type){const e=r.origin;return e&&ve(o,o,e),S(R(o),t)}const n=he(t),i=r.origin;if(!fe(n,t)){const[e,r,s]=i;return new me({xmin:e,ymin:r,zmin:s,xmax:e,ymax:r,zmax:s,spatialReference:t})}return de(t,i,He,n),ye(o,o,He),ge(o,n,0,o,t,0),S(R(o),t)}({get transform(){return r.transform},vertexSpace:t,spatialReference:e,untransformedBounds:this._untransformedBounds})}get _untransformedBounds(){const{vertexAttributes:{position:e},components:t}=this;return 0===e.length||0===t?.length?M(F):R(e)}get origin(){const e=V(this.vertexSpace,this.spatialReference);if(null!=e)return e;const{center:t,zmin:r}=this._transformedExtent;return new b({x:t.x,y:t.y,z:r,spatialReference:this.spatialReference})}get extent(){return this.loaded||null==this.metadata?.displaySource?.extent?this._transformedExtent:this.metadata.displaySource.extent.clone()}addComponent(e){this._checkIfLoaded("addComponent()")&&(this.components||(this.components=[]),this.components.push(_.from(e)),this.notifyChange("components"))}removeComponent(e){if(this._checkIfLoaded("removeComponent()")){if(this.components){const t=this.components.indexOf(e);if(-1!==t)return this.components.splice(t,1),void this.notifyChange("components")}n.getLogger(this).error("removeComponent()","Provided component is not part of the list of components")}}rotate(e,t,r,s){return T(e,t,r,Ot),function(e,t,r){if(!e.vertexAttributes?.position||0===t[3])return;const{spatialReference:s,vertexSpace:o}=e,n=r?.origin??e.origin,i=r?.geographic,a=qe(ft,o,s,i);I(e)?function(e,t,r){e.transform??=new E;const{vertexSpace:s,transform:o,spatialReference:n}=e,[i,a,c]=s.origin,l=new b({x:i,y:a,z:c,spatialReference:n}),u=dt;if(l.equals(r))H(u,0,0,0);else if(!oe(u,r,e))return void ee(ft(),r.spatialReference,n,te);Ee(wt,L(t),U(t));const p=Oe(gt,wt,v,j,u),{localMatrix:m}=o,f=Ce(gt,p,m);o.scale=Te(x(),f),_e(f,f,J(dt,o.scale));const h=o.rotationAxis;o.rotation=O(f),0===o.rotationAngle&&(o.rotationAxis=h),o.translation=Pe(x(),f)}(e,t,n):a?function(e,t,r){const s=e.spatialReference,o=he(s),n=jt;if(!Y(r,n,o)&&(ee(ft(),r.spatialReference,o,"Falling back to mesh origin"),!Y(e.origin,n,o)))return void ee(ft(),e.origin.spatialReference,o);const i=e.vertexAttributes.position,a=e.vertexAttributes.normal,c=e.vertexAttributes.tangent,l=new Float64Array(i.length),u=null!=a?new Float32Array(a.length):null,p=null!=c?new Float32Array(c.length):null;de(o,n,yt,o),Le(vt,yt);const m=xt;W(L(xt),L(t),vt),m[3]=t[3],!ne(i,s,l,o)||null!=a&&null!=u&&!ie(a,i,s,l,o,u)||null!=c&&null!=p&&!ae(c,i,s,l,o,p)?ee(ft(),s,o):(ht(l,m,3,n),!ce(l,o,i,s)||null!=a&&null!=u&&(ht(u,m,3),!le(u,i,s,l,o,a))||null!=c&&null!=p&&(ht(p,m,4),!ue(p,i,s,l,o,c))?ee(ft(),o,s):e.vertexAttributesChanged())}(e,t,n):function(e,t,r){const s=jt;if(!Y(r,s,e.spatialReference)){const t=e.origin;return s[0]=t.x,s[1]=t.y,s[2]=t.z,void ee(ft(),r.spatialReference,e.spatialReference,te)}ht(e.vertexAttributes.position,t,3,s),ht(e.vertexAttributes.normal,t,3),ht(e.vertexAttributes.tangent,t,4),e.vertexAttributesChanged()}(e,t,n)}(this,Ot,s),this}offset(e,t,r){if(!this._checkIfLoaded("offset()"))return this;const{vertexSpace:s,vertexAttributes:o}=this,n=o?.position;if(!n)return this;if(B(s)){const[o,n,i]=s.origin;s.origin=y(o+e,n+t,i+r)}else{for(let s=0;s<n.length;s+=3)n[s]+=e,n[s+1]+=t,n[s+2]+=r;this.vertexAttributesChanged()}return this}scale(e,t){return this._checkIfLoaded("scale()")?(function(e,t,r){if(!e.vertexAttributes?.position)return;const{vertexSpace:s,spatialReference:o}=e,n=r?.origin??e.origin,i=r?.geographic,a=qe(bt,s,o,i);I(e)?function(e,t,r){e.transform??=new E;const{vertexSpace:s,transform:o,spatialReference:n}=e,[i,a,c]=s.origin,l=new b({x:i,y:a,z:c,spatialReference:n}),u=At;if(l.equals(r))H(u,0,0,0);else if(!oe(u,r,e))return void ee(bt(),r.spatialReference,n,te);const p=H(St,t,t,t),m=Oe(Rt,Be,v,p,u),{localMatrix:f}=o,h=Ce(Rt,m,f);o.scale=Te(x(),h),_e(h,h,J(At,o.scale));const d=o.rotationAxis;o.rotation=O(h),0===o.rotationAngle&&(o.rotationAxis=d),o.translation=Pe(x(),h)}(e,t,n):a?function(e,t,r){const s=e.spatialReference,o=he(s),n=Mt;if(!Y(r,n,o)&&(ee(bt(),r.spatialReference,o,"Falling back to mesh origin"),!Y(e.origin,n,o)))return void ee(bt(),e.origin.spatialReference,o);const i=e.vertexAttributes.position,a=e.vertexAttributes.normal,c=e.vertexAttributes.tangent,l=new Float64Array(i.length),u=null!=a?new Float32Array(a.length):null,p=null!=c?new Float32Array(c.length):null;!ne(i,s,l,o)||null!=a&&null!=u&&!ie(a,i,s,l,o,u)||null!=c&&null!=p&&!ae(c,i,s,l,o,p)?ee(bt(),s,o):(kt(l,t,n),!ce(l,o,i,s)||null!=a&&null!=u&&!le(u,i,s,l,o,a)||null!=c&&null!=p&&!ue(p,i,s,l,o,c)?ee(bt(),o,s):e.vertexAttributesChanged())}(e,t,n):function(e,t,r){const s=Mt;if(!Y(r,s,e.spatialReference)){const t=e.origin;return s[0]=t.x,s[1]=t.y,s[2]=t.z,void ee(bt(),r.spatialReference,e.spatialReference,te)}kt(e.vertexAttributes.position,t,s),e.vertexAttributesChanged()}(e,t,n)}(this,e,t),this):this}centerAt(e,t){return this._checkIfLoaded("centerAt()")?(function(e,t,r){if(!e.vertexAttributes?.position)return;const{vertexSpace:s}=e,o=r?.origin??e.origin,n=qe(Ne,s,o.spatialReference,r?.geographic);B(s)?function(e,t,r){const{vertexSpace:s}=e;if(!B(s))return;const o=We,n=$e;if(!Y(t,n,e.spatialReference))return void ee(Ne(),t.spatialReference,e.spatialReference,te);if(!Y(r,o,e.spatialReference)){const t=e.origin;return o[0]=t.x,o[1]=t.y,o[2]=t.z,void ee(Ne(),r.spatialReference,e.spatialReference,te)}const i=N(Ze,n,o);s.origin=$(x(),s.origin,i)}(e,t,o):n?function(e,t,r){const s=y(r.x,r.y,r.z??0),o=re(e,new D({origin:s}));if(!o)return;const n=y(t.x,t.y,t.z??0),i=re({vertexAttributes:o,spatialReference:e.spatialReference,vertexSpace:new D({origin:n})},P.absolute);if(!i)return;const{position:a,normal:c,tangent:l}=i;e.vertexAttributes.position=a,e.vertexAttributes.normal=c,e.vertexAttributes.tangent=l,e.vertexAttributesChanged()}(e,t,o):function(e,t,r){const s=We,o=$e;if(Y(t,o,e.spatialReference)){if(!Y(r,s,e.spatialReference)){const t=e.origin;return s[0]=t.x,s[1]=t.y,s[2]=t.z,void ee(Ne(),r.spatialReference,e.spatialReference,te)}(function(e,t,r){if(e)for(let s=0;s<e.length;s+=3)for(let o=0;o<3;o++)e[s+o]+=t[o]-r[o]})(e.vertexAttributes.position,o,s),e.vertexAttributesChanged()}else ee(Ne(),t.spatialReference,e.spatialReference,te)}(e,t,o)}(this,e,t),this):this}load(e){const{metadata:{displaySource:t}}=this;return t&&this.addResolvingPromise(async function(e,t,r){switch(t.source.type){case"client":case"service":return async function(e,t,r){const{source:o}=t,{loadGLTFMesh:n}=await a(import("../chunks/loadGLTFMesh.js"),r),i=await async function(e,t){switch(e.type){case"client":return Array.isArray(e.files)?function(e){if(!e.length)throw new s("mesh-load-external:missing-assets","There must be at least one file to load");return st(e.map(e=>({name:e.name,mimeType:e.type,source:Xe(e)})))}(e.files):Xe(e.files);case"service":return async function(e,t){if(!e.length)throw new s("mesh-load-external:missing-assets","There must be at least one file to load");const r=await l(e.map(async e=>{const r=await async function(e,t){const{parts:r,assetMimeType:s,assetName:o}=e;if(1===r.length)return new ot(r[0].partUrl);const n=await e.toBlob(t);return c(t),ot.fromBlob(n,nt(o,s))}(e);return c(t),{name:e.assetName,mimeType:e.assetMimeType,source:r}}));if(u(t))throw r.forEach(e=>e.source.dispose()),p();return st(r)}(e.assets,t);default:throw new s("mesh-load-external:invalid-source","Invalid source type")}}(o,r);c(r);const m=n(new b({x:0,y:0,z:0,spatialReference:e.spatialReference}),i.url,{resolveFile:Ke(i),signal:r?.signal,expectedType:i.type,unitConversionDisabled:t.unitConversionDisabled});m.then(()=>i.dispose(),()=>i.dispose());const{vertexAttributes:f,components:h}=await m;e.vertexAttributes=f,e.components=h}(e,t,r);case"loadable":return t.source.load(e,r);default:d(t.source)}}(this,t,e)),Promise.resolve(this)}addExternalSources(e){this.metadata.externalSources.addMany(e)}updateDisplaySource(e){this.metadata.displaySource=e}clone(e){return super.clone(be(ke(e)))}cloneShallow(){return new Ft({components:this.components,spatialReference:this.spatialReference,vertexAttributes:this.vertexAttributes,vertexSpace:this.vertexSpace.clone(),transform:this.transform,metadata:this.metadata})}vertexAttributesChanged(){this.notifyChange("vertexAttributes")}async toBinaryGLTF(e){const[{toBinaryGLTF:t}]=await Promise.all([import("../chunks/gltfexport.js"),this.load(e)]);return c(e),await t(this,e)}get usedMemory(){return this.components?this.components.reduce((e,t)=>e+t.memoryUsage,this.vertexAttributes.usedMemory):this.vertexAttributes.usedMemory}_clearSources(){this.metadata.clearSources()}_checkIfLoaded(e){return!!this.loaded||(n.getLogger(this).error(e,"Mesh must be loaded before applying operations"),!1)}static createBox(e,t){if(!(e instanceof b))return n.getLogger(this.prototype).error(".createBox()",Ge),null;const r=new Ft(ct(function(){const{faceDescriptions:e,faceVertexOffsets:t,uvScales:r}=lt,s=4*e.length,o=new Float64Array(3*s),n=new Float32Array(3*s),i=new Float32Array(2*s),a=new Uint32Array(2*e.length*3);let c=0,l=0,u=0,p=0;for(let s=0;s<e.length;s++){const m=e[s],f=c/3;for(const e of t)a[p++]=f+e;const h=m.corners;for(let e=0;e<4;e++){const t=h[e];let s=0;i[u++]=.25*r[e][0]+m.uvOrigin[0],i[u++]=m.uvOrigin[1]-.25*r[e][1];for(let e=0;e<3;e++)0!==m.axis[e]?(o[c++]=.5*m.axis[e],n[l++]=m.axis[e]):(o[c++]=.5*t[s++],n[l++]=0)}}return{position:o,normal:n,uv:i,faces:a}}(),e,t));return t?.imageFace&&"all"!==t.imageFace?function(e,t){const r=e.components[0],s=r.faces,o=ut[t],n=6*o,i=new Array(6),a=new Array(s.length-6);let c=0,l=0;for(let e=0;e<s.length;e++)e>=n&&e<n+6?i[c++]=s[e]:a[l++]=s[e];if(null!=e.vertexAttributes.uv){const t=new Float32Array(e.vertexAttributes.uv),r=4*o*2,s=[0,1,1,1,1,0,0,0];for(let e=0;e<s.length;e++)t[r+e]=s[e];e.vertexAttributes.uv=t}return e.components=[new _({faces:i,material:r.material}),new _({faces:a})],e}(r,t.imageFace):r}static createSphere(e,t){return e instanceof b?new Ft(ct(function(e=0){const t=Math.round(8*2**e),r=2*t,s=(t-1)*(r+1)+2*r,o=new Float64Array(3*s),n=new Float32Array(3*s),i=new Float32Array(2*s),a=new Uint32Array((t-1)*r*2*3);let c=0,l=0,u=0,p=0;for(let e=0;e<=t;e++){const s=e/t*Math.PI+.5*Math.PI,m=Math.cos(s),f=Math.sin(s);pt[2]=f;const h=0===e||e===t,d=h?r-1:r;for(let s=0;s<=d;s++){const f=s/d*2*Math.PI;pt[0]=-Math.sin(f)*m,pt[1]=Math.cos(f)*m;for(let e=0;e<3;e++)o[c]=.5*pt[e],n[c]=pt[e],++c;i[l++]=(s+(h?.5:0))/r,i[l++]=e/t,0!==e&&s!==r&&(e!==t&&(a[u++]=p,a[u++]=p+1,a[u++]=p-r),1!==e&&(a[u++]=p,a[u++]=p-r,a[u++]=p-r-1)),p++}}return{position:o,normal:n,uv:i,faces:a}}(t?.densificationFactor||0),e,t)):(n.getLogger(this.prototype).error(".createSphere()",Ge),null)}static createCylinder(e,t){return e instanceof b?new Ft(ct(function(e=0){const t=Math.round(16*2**e),r=4*(t+1)+2*t,s=new Float64Array(3*r),o=new Float32Array(3*r),n=new Float32Array(2*r),i=new Uint32Array(4*t*3);let a=0,c=0,l=0,u=0,p=0;for(let e=0;e<=5;e++){const r=0===e||5===e,m=e<=1||e>=4,f=2===e||4===e,h=r?t-1:t;for(let d=0;d<=h;d++){const g=d/h*2*Math.PI,x=r?0:.5;pt[0]=x*Math.sin(g),pt[1]=x*-Math.cos(g),pt[2]=e<=2?.5:-.5;for(let t=0;t<3;t++)s[a++]=pt[t],o[c++]=m?2===t?e<=1?1:-1:0:2===t?0:pt[t]/x;n[l++]=(d+(r?.5:0))/t,n[l++]=e<=1?1*e/3:e<=3?1*(e-2)/3+1/3:1*(e-4)/3+2/3,f||0===e||d===t||(5!==e&&(i[u++]=p,i[u++]=p+1,i[u++]=p-t),1!==e&&(i[u++]=p,i[u++]=p-t,i[u++]=p-t-1)),p++}}return{position:s,normal:o,uv:n,faces:i}}(t?.densificationFactor||0),e,t)):(n.getLogger(this.prototype).error(".createCylinder()",Ge),null)}static createPlane(e,t){if(!(e instanceof b))return n.getLogger(this.prototype).error(".createPlane()",Ge),null;const r=t?.facing??"up",s=function(e,t){const r="number"==typeof t?t:null!=t?t.width:1,s="number"==typeof t?t:null!=t?t.height:1;switch(e){case"up":case"down":return{width:r,depth:s};case"north":case"south":return{width:r,height:s};case"east":case"west":return{depth:r,height:s}}}(r,t?.size);return new Ft(ct(function(e){const t=at.facingAxisOrderSwap[e],r=at.position,s=at.normal,o=new Float64Array(r.length),n=new Float32Array(s.length);let i=0;for(let e=0;e<4;e++){const e=i;for(let a=0;a<3;a++){const c=t[a],l=Math.abs(c)-1,u=c>=0?1:-1;o[i]=r[e+l]*u,n[i]=s[e+l]*u,i++}}return{position:o,normal:n,uv:new Float32Array(at.uv),faces:new Uint32Array(at.faces),isPlane:!0}}(r),e,{...t,size:s}))}static createFromPolygon(e,t){if(!(e instanceof k))return n.getLogger(this.prototype).error(".createFromPolygon()","Expected polygon to be a Polygon instance"),null;const r=q(e);return new Ft({vertexAttributes:new z({position:r.position}),components:[new _({faces:r.faces,shading:"flat",material:t?.material??null})],spatialReference:e.spatialReference,vertexSpace:new P})}static async createFromGLTF(e,t,r){if(!(e instanceof b)){const e=new Ie;throw n.getLogger(this.prototype).error(".createfromGLTF()",e.message),e}const{loadGLTFMesh:s}=await a(import("../chunks/loadGLTFMesh.js"),r);return new Ft(await s(e,t,r))}static createWithExternalSource(e,t,r){const s=r?.extent??null,{spatialReference:o}=e,n=r?.transform?.clone()??new E,i=G(e,r),a=r?.unitConversionDisabled,c={source:t,extent:s,unitConversionDisabled:a},l=new it;return l.externalSources.push(c),new Ft({metadata:l,transform:n,vertexSpace:i,spatialReference:o})}static createIncomplete(e,t){const{spatialReference:r}=e,o=t?.transform?.clone()??new E,n=G(e,t),i=new Ft({transform:o,vertexSpace:n,spatialReference:r});return i.addResolvingPromise(Promise.reject(new s("mesh-incomplete","Mesh resources are not complete"))),i}};e([h({type:[_],json:{write:!0}})],Lt.prototype,"components",void 0),e([h({nonNullable:!0,types:Ut,constructOnly:!0,json:{write:!0},clonable:(e,t)=>Ae(t)?.vertexSpace??e.clone(t)})],Lt.prototype,"vertexSpace",void 0),e([h({type:E,clonable:(e,t)=>{const r=Ae(t);return r&&"transform"in r?r.transform:e?.clone()??e},json:{write:!0}})],Lt.prototype,"transform",void 0),e([h({constructOnly:!0,type:it,clonable:(e,t)=>Ae(t)?.metadata??e.clone()})],Lt.prototype,"metadata",void 0),e([h()],Lt.prototype,"hasExtent",null),e([h()],Lt.prototype,"_transformedExtent",null),e([h()],Lt.prototype,"_untransformedBounds",null),e([h()],Lt.prototype,"origin",null),e([h({readOnly:!0,json:{read:!1}})],Lt.prototype,"extent",null),e([h({readOnly:!0,json:{read:!1,write:!0,default:!0}})],Lt.prototype,"hasZ",void 0),e([h({readOnly:!0,json:{read:!1,write:!0,default:!1}})],Lt.prototype,"hasM",void 0),e([h({type:z,nonNullable:!0,json:{write:!0},clonable:(e,t)=>Ae(t)?.vertexAttributes??e.clone(t)})],Lt.prototype,"vertexAttributes",void 0),Lt=Ft=e([g("esri.geometry.Mesh")],Lt);const Ot=C(),Ct=Object.freeze(Object.defineProperty({__proto__:null,default:Lt},Symbol.toStringTag,{value:"Module"}));export{it as M,Ct as a,Lt as default,Ve as i};
