/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{ClonableMixin as e}from"../../core/Clonable.js";import"../../core/lang.js";import{w as r}from"../../chunks/imageUtils.js";import{JSONSupport as s}from"../../core/JSONSupport.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import{b as n}from"../../chunks/ensureType.js";import{r as o}from"../../chunks/reader.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import{w as c}from"../../chunks/writer.js";import{b as l}from"../../chunks/meshCloneUtils.js";import{a as p,w as m}from"../../chunks/persistableUrlUtils.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/maybe.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/Lifecycle.js";import"../../chunks/metadata.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../core/promiseUtils.js";import"../../core/Error.js";import"../../chunks/events.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/MapUtils.js";import"../../chunks/Warning.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/jsonUtils.js";var u;const h=new WeakMap;let d=0,g=class extends(e(s)){static{u=this}constructor(t){super(t),this.wrap="repeat"}get url(){return this._get("url")||null}set url(t){this._set("url",t),t&&this._set("data",null)}get data(){return this._get("data")||null}set data(t){this._set("data",t),t&&this._set("url",null)}writeData(t,e,r,s){if(t instanceof HTMLImageElement){const a={type:"image-element",src:p(t.src,s),crossOrigin:t.crossOrigin};e[r]=a}else if(t instanceof HTMLCanvasElement){const s={type:"canvas-element",imageData:f(t.getContext("2d").getImageData(0,0,t.width,t.height))};e[r]=s}else if(t instanceof HTMLVideoElement){const a={type:"video-element",src:p(t.src,s),autoplay:t.autoplay,loop:t.loop,muted:t.muted,crossOrigin:t.crossOrigin,preload:t.preload};e[r]=a}else if(t instanceof ImageData){const s={type:"image-data",imageData:f(t)};e[r]=s}}readData(t){switch(t.type){case"image-element":{const e=new Image;return e.src=t.src,e.crossOrigin=t.crossOrigin,e}case"canvas-element":{const e=j(t.imageData),r=document.createElement("canvas");return r.width=e.width,r.height=e.height,r.getContext("2d").putImageData(e,0,0),r}case"image-data":return j(t.imageData);case"video-element":{const e=document.createElement("video");return e.src=t.src,e.crossOrigin=t.crossOrigin,e.autoplay=t.autoplay,e.loop=t.loop,e.muted=t.muted,e.preload=t.preload,e}default:return}}get transparent(){const{data:t,url:e}=this,r=t=>t?.toLowerCase().endsWith(".png")||t?.toLocaleLowerCase().startsWith("data:image/png;");return t instanceof HTMLCanvasElement?w(t.getContext("2d").getImageData(0,0,t.width,t.height)):t instanceof ImageData?w(t):!(!e||!r(e))||!!(t instanceof HTMLImageElement&&r(t.src))}set transparent(t){this._overrideIfSome("transparent",t)}get contentHash(){const t="string"==typeof this.wrap?this.wrap:"object"==typeof this.wrap?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",e=(e="")=>`d:${e},t:${this.transparent},w:${t}`;return null!=this.url?e(this.url):null!=this.data?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?e(this.data.src):(h.has(this.data)||h.set(this.data,++d),e(h.get(this.data))):e()}get memoryUsage(){let t=0;if(t+=null!=this.url?this.url.length:0,null!=this.data){const e=this.data;"data"in e?t+=e.data.byteLength:e instanceof HTMLImageElement?t+=e.naturalWidth*e.naturalHeight*3:e instanceof HTMLCanvasElement&&(t+=e.width*e.height*3)}return t}clone(t){const e=l(t),r=e?.textureMap?.get(this);if(r)return r;const s=super.clone(t);return e?.textureMap?.set(this,s),s}static from(t){return"string"==typeof t?new u({url:t}):t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData||t instanceof HTMLVideoElement?new u({data:t}):n(u,t)}};function f(t){let e="";for(let r=0;r<t.data.length;r++)e+=String.fromCharCode(t.data[r]);return{data:btoa(e),width:t.width,height:t.height}}function j(t){const e=atob(t.data),s=new Uint8ClampedArray(e.length);for(let t=0;t<e.length;t++)s[t]=e.charCodeAt(t);return r(s,t.width,t.height)}function w(t){for(let e=3;e<t.data.length;e+=4)if(255!==t.data[e])return!0;return!1}t([a({type:String,json:{write:m}})],g.prototype,"url",null),t([a({clonable:"reference",json:{write:{overridePolicy(){return{enabled:!this.url}}}}})],g.prototype,"data",null),t([c("data")],g.prototype,"writeData",null),t([o("data")],g.prototype,"readData",null),t([a({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],g.prototype,"transparent",null),t([a({json:{write:!0}})],g.prototype,"wrap",void 0),t([a({readOnly:!0})],g.prototype,"contentHash",null),g=u=t([i("esri.geometry.support.MeshTexture")],g);export{g as default};
