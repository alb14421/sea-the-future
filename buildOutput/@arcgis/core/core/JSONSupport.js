/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as r}from"../chunks/tslib.es6.js";import e,{h as t,n as s}from"./Accessor.js";import{clone as i,e as n}from"./lang.js";import{v as o,e as a,g as u}from"../chunks/get.js";import{g as l,m as c}from"../chunks/utils.js";import{o as p,a as f,b as g,subclass as h}from"./accessorSupport/decorators/subclass.js";import m from"./Error.js";import{L as d}from"../chunks/Logger.js";import"./Handles.js";import"../chunks/maybe.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/handleUtils.js";import"../chunks/tracking.js";import"./accessorSupport/decorators/property.js";import"../chunks/ensureType.js";import"../chunks/MapUtils.js";import"../config.js";import"../chunks/object.js";import"../chunks/string.js";import"../chunks/watch.js";import"./scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"./promiseUtils.js";import"../chunks/events.js";import"../chunks/SetUtils.js";import"../chunks/SimpleTrackingTarget.js";import"../chunks/Warning.js";class O{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(r){const e=new O;return this._values.forEach((t,s)=>{r&&r.has(s)||e.set(s,i(t.value),t.origin)}),e}get(r,e){e=this._normalizeOrigin(e);const t=this._values.get(r);return null==e||t?.origin===e?t?.value:void 0}originOf(r){return this._values.get(r)?.origin??7}keys(r){r=this._normalizeOrigin(r);const e=[...this._values.keys()];return null==r?e:e.filter(e=>this._values.get(e)?.origin===r)}set(r,e,t){if(0===(t=this._normalizeOrigin(t))){const e=this._values.get(r);if(null!=e?.origin&&e.origin>t)return}this._values.set(r,new y(e,t))}delete(r,e){null!=(e=this._normalizeOrigin(e))&&this._values.get(r)?.origin!==e||this._values.delete(r)}has(r,e){return null!=(e=this._normalizeOrigin(e))?this._values.get(r)?.origin===e:this._values.has(r)}isAtOrigin(r,e){return e=this._normalizeOrigin(e),this.has(r,e)&&this.originOf(r)===e}isBelowOrigin(r,e){return e=this._normalizeOrigin(e),!this.has(r)||this.originOf(r)<e}forEach(r){this._values.forEach(({value:e},t)=>r(e,t))}_normalizeOrigin(r){if(null!=r)return 0===r?r:7}}class y{constructor(r,e){this.value=r,this.origin=e}}function j(r,e,t){e.keys().forEach(r=>{t.set(r,e.get(r),0)});const s=r.metadata;Object.keys(s).forEach(e=>{r.internalGet(e)&&t.set(e,r.internalGet(e),0)})}function w(r,e,t){if(!r?.read||!1===r.read.enabled||!r.read.source)return!1;const s=r.read.source;if("string"==typeof s){if(s===e)return!0;if(s.includes(".")&&s.startsWith(e)&&a(s,t))return!0}else for(const r of s){if(r===e)return!0;if(r.includes(".")&&r.startsWith(e)&&a(r,t))return!0}return!1}function v(r,e,t,s,i){let n=p(e[t],i);(function(r){return r&&(!r.read||!1!==r.read.enabled&&!r.read.source)})(n)&&(r[t]=!0);for(const o of Object.getOwnPropertyNames(e))n=p(e[o],i),w(n,t,s)&&(r[o]=!0)}function k(r,e,t,s){const i=t.metadata,n=f(i[e],s),o=n?.default;if(void 0===o)return;const a="function"==typeof o?o.call(r,e,s):o;void 0!==a&&t.set(e,a)}const N={origin:"service"};function _(r,e,t=N){if(!e||"object"!=typeof e)return;const s=l(r),i=s.metadata,n={};for(const r of Object.getOwnPropertyNames(e))v(n,i,r,e,t);s.setDefaultOrigin(t.origin);for(const a of Object.getOwnPropertyNames(n)){const n=p(i[a],t).read,u=n?.source;let l;l=u&&"string"==typeof u?o(e,u):e[a],n?.reader&&(l=n.reader.call(r,l,e,t)),void 0!==l&&s.set(a,l)}if(!t||!t.ignoreDefaults){s.setDefaultOrigin("defaults");for(const e of Object.getOwnPropertyNames(i))n[e]||k(r,e,s,t)}s.setDefaultOrigin("user")}function b(r,e,t,s=N){const i={...s,messages:[]};t(i),i.messages?.forEach(e=>{"warning"!==e.type||r.loaded?s?.messages&&s.messages.push(e):r.loadWarnings.push(e)})}function S(r,e,t,s,i){const n={};return e.write?.writer?.call(r,s,n,t,i),n}function E(r,e,t,i,o,a){if(!i?.write)return!1;const l=u(r,t);if(!o&&i.write.overridePolicy){const e=i.write.overridePolicy.call(r,l,t,a??void 0);void 0!==e&&(o=e)}if(o||(o=i.write),!o||!1===o.enabled)return!1;if(o.layerContainerTypes&&a?.layerContainerType&&!o.layerContainerTypes.includes(a.layerContainerType))return!1;if((null===l&&!o.allowNull&&!o.writerEnsuresNonNull||void 0===l)&&o.isRequired){const e=new m("web-document-write:property-required",`Missing value for required property '${t}' on '${r.declaredClass}'`,{propertyName:t,target:r});return e&&a?.messages?a.messages.push(e):e&&!a&&d.getLogger("esri.core.accessorSupport.write").error(e.name,e.message),!1}return!(void 0===l||null===l&&!o.allowNull&&!o.writerEnsuresNonNull||!(o.alwaysWriteDefaults||e.store.multipleOriginsSupported&&0!==e.store.originOf(t))&&function(r,e,t,s,i){const o=s.default;if(void 0===o)return!1;if(null!=s.defaultEquals)return s.defaultEquals(i);if("function"==typeof o){if(Array.isArray(i)){const s=o.call(r,e,t??void 0);return n(s,i)}return!1}return o===i}(r,t,a,i,l)||!o.ignoreOrigin&&a?.origin&&e.store.multipleOriginsSupported&&e.store.originOf(t)<s(a.origin))}function P(r,e,t,s){const i=l(r),n=i.metadata,o=g(n[e],s);return!!o&&E(r,i,e,o,t,s)}function J(r,e,s){if(r&&"function"==typeof r.toJSON&&(!r.toJSON.isDefaultToJSON||!r.write))return c(e,r.toJSON(s));const i=l(r),n=i.metadata;for(const o in n){const a=g(n[o],s);if(!E(r,i,o,a,void 0,s))continue;const l=u(r,o),p=S(r,a,a.write&&"string"==typeof a.write.target?a.write.target:o,l,s);Object.keys(p).length>0&&(e=c(e,p),s?.resources?.pendingOperations?.length&&s.resources.pendingOperations.push(Promise.all(s.resources.pendingOperations).then(()=>c(e,p,()=>"replace-arrays"))),s?.writtenProperties&&s.writtenProperties.push({target:r,propName:o,oldOrigin:t(i.store.originOf(o)),newOrigin:s.origin}))}return e}const T=e=>{const t=e;let s=class extends t{constructor(...r){super(...r);const e=l(this),t=e.store,s=new O;e.store=s,j(e,t,s)}read(r,e){_(this,r,e)}write(r,e){return J(this,r??{},e)}toJSON(r){return this.write({},r)}static fromJSON(r,e){return z.call(this,r,e)}};return s=r([h("esri.core.JSONSupport")],s),s.prototype.toJSON.isDefaultToJSON=!0,s};function z(r,e){if(!r)return null;if(r.declaredClass)throw new Error("JSON object is already hydrated");const t=new this;return t.read(r,e),t}const D=T(e);export{D as JSONSupport,T as JSONSupportMixin,_ as a,J as b,b as r,j as s,P as w};
