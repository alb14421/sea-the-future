/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import"../../lang.js";import{L as e}from"../../../chunks/Logger.js";import{L as t}from"../../../chunks/Lifecycle.js";import{a as r}from"../../../chunks/metadata.js";import{t as n}from"../../../chunks/tracking.js";import{k as o}from"../../../chunks/ensureType.js";import{s as i}from"../../../chunks/object.js";import{W as s}from"../../../chunks/Warning.js";import a from"../../Error.js";import"../../../config.js";import"../../../chunks/string.js";import"../../../chunks/utils.js";import"../../../chunks/handleUtils.js";import"../../../chunks/MapUtils.js";const c=Symbol("Accessor-beforeDestroy");function u(e){return!!e&&e.prototype?.declaredClass&&0===e.prototype.declaredClass.indexOf("esri.core.Collection")}const p=()=>e.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function f(e,t,r){e&&(!r&&!t.read||t.read?.reader||!1===t.read?.enabled||function(e){return"types"in e?j(e.types):b(e.type)}(e)&&i("read.reader",y(e),t))}function y(e){const t=e.ndimArray??0;if(t>1)return function(e){const t=l(e),r=d.bind(null,t),n=e.ndimArray??0;return(e,t,o)=>{if(null==e)return e;e=r(e,o,n);let i=n,s=e;for(;i>0&&Array.isArray(s);)i--,s=s[0];if(void 0!==s)for(let t=0;t<i;t++)e=[e];return e}}(e);if(1===t)return g(e);if("type"in e&&m(e.type)){const t=e.type.prototype?.itemType?.Type,r=g("function"==typeof t?{type:t}:{types:t});return(t,n,o)=>{const i=r(t,n,o);return i?new e.type(i):i}}return l(e)}function l(e){return"type"in e?function(e){return e.prototype.read?(t,r,n)=>{if(null==t)return t;const o=typeof t;if("object"!==o)return void p().error(`Expected JSON value of type 'object' to deserialize type '${e.prototype.declaredClass}', but got '${o}'`);const i=new e;return i.read(t,n),i}:e.fromJSON}(e.type):function(e){let t=null;const n=e.errorContext??"type",o=e.validate;return(i,a,c)=>{if(null==i)return i;const u=typeof i;if("object"!==u)return void p().error(`Expected JSON value of type 'object' to deserialize, but got '${u}'`);t||(t=function(e){const t={};for(const n in e.typeMap){const o=e.typeMap[n],i=r(o.prototype);if("function"==typeof e.key)continue;const s=i[e.key];if(!s)continue;if(s.json?.type&&Array.isArray(s.json.type)&&1===s.json.type.length&&"string"==typeof s.json.type[0]){t[s.json.type[0]]=o;continue}const a=s.json?.write;if(!a?.writer){t[n]=o;continue}const c=a.target,u="string"==typeof c?c:e.key,p={};a.writer(n,p,u),p[u]&&(t[p[u]]=o)}return t}(e));const f=e.key;if("string"!=typeof f)return;const y=i[f],l=y?t[y]:e.defaultKeyValue?e.typeMap[e.defaultKeyValue]:void 0;if(!l){const e=`Type '${y||"unknown"}' is not supported`;return c?.messages&&i&&c.messages.push(new s(`${n}:unsupported`,e,{definition:i,context:c})),void p().error(e)}const d=new l;return d.read(i,c),o?o(d):d}}(e.types)}function d(e,t,r,n){return 0!==n&&Array.isArray(t)?t.map(t=>d(e,t,r,n-1)):e(t,void 0,r)}function g(e){const t=l(e);return(e,r,n)=>{if(null==e)return e;if(Array.isArray(e)){const r=[];for(const o of e){const e=t(o,void 0,n);void 0!==e&&r.push(e)}return r}const o=t(e,void 0,n);return void 0!==o?[o]:void 0}}function m(e){if(!u(e))return!1;const t=e.prototype.itemType;return!(!t||!t.Type)&&("function"==typeof t.Type?b(t.Type):j(t.Type))}function b(e){return!Array.isArray(e)&&!!e&&e.prototype&&("read"in e.prototype||"fromJSON"in e||m(e))}function j(e){for(const t in e.typeMap)if(!b(e.typeMap[t]))return!1;return!0}function w(e){e.name&&(e.read&&"object"==typeof e.read?void 0===e.read.source&&(e.read.source=e.name):e.read={source:e.name},e.write&&"object"==typeof e.write?void 0===e.write.target&&(e.write.target=e.name):e.write={target:e.name})}function h(e){"boolean"==typeof e.read?e.read={enabled:e.read}:"function"==typeof e.read?e.read={enabled:!0,reader:e.read}:e.read&&"object"==typeof e.read&&void 0===e.read.enabled&&(e.read.enabled=!0)}function A(e){"boolean"==typeof e.write?e.write={enabled:e.write}:"function"==typeof e.write?e.write={enabled:!0,writer:e.write}:e.write&&"object"==typeof e.write&&void 0===e.write.enabled&&(e.write.enabled=!0)}function v(e,t){if(!t.write||t.write.writer||!1===t.write.enabled&&!t.write.overridePolicy)return;const r=e?.ndimArray??0;var n,o;e&&(1===r||"type"in e&&u(e.type))?t.write.writer=S:r>1?t.write.writer=(o=r,(e,t,r,n)=>{let s;if(null===e)s=null;else{s=P(e,n,o);let t=o,r=s;for(;t>0&&Array.isArray(r);)t--,r=r[0];if(void 0!==r)for(let e=0;e<t;e++)s=[s]}i(r,s,t)}):t.types?Array.isArray(t.types)?t.write.writer=(n=t.types[0],(e,t,r,o)=>e&&Array.isArray(e)?k(e.filter(e=>O(e,n,o)),t,r,o):k(e,t,r,o)):t.write.writer=function(e){return(t,r,n,o)=>t?O(t,e,o)?k(t,r,n,o):void 0:k(t,r,n,o)}(t.types):t.write.writer=k}function O(t,r,n){for(const e in r.typeMap)if(t instanceof r.typeMap[e])return!0;if(n?.messages){const o=r.errorContext??"type",i=`Values of type '${("function"!=typeof r.key?t[r.key]:t.declaredClass)??"Unknown"}' cannot be written`;n&&n.messages&&t&&n.messages.push(new a(`${o}:unsupported`,i,{definition:t,context:n})),e.getLogger("esri.core.accessorSupport.extensions.serializableProperty.writer").error(i)}return!1}function k(e,t,r,n){i(r,_(e,n),t)}function _(e,t){return e&&"function"==typeof e.write?e.write({},t):e&&"function"==typeof e.toJSON?e.toJSON():"number"==typeof e?N(e):e}function N(e){return e===-1/0?-Number.MAX_VALUE:e===1/0?Number.MAX_VALUE:isNaN(e)?null:e}function S(e,t,r,n){let o;null===e?o=null:e&&"function"==typeof e.map?(o=e.map(e=>_(e,n)),"function"==typeof o.toArray&&(o=o.toArray())):o=[_(e,n)],i(r,o,t)}function P(e,t,r){return 0!==r&&Array.isArray(e)?e.map(e=>P(e,t,r-1)):_(e,t)}function C(e,t){return M(e,"any",t?.origin)}function T(e,t){return M(e,"read",t?.origin)}function x(e,t){return M(e,"write",t?.origin)}function M(e,t,r){let n=e?.json;if(n?.origins&&r){let e;e="link-chart"===r?n.origins[r]&&("any"===t||t in n.origins[r])?n.origins[r]:n.origins["web-map"]:n.origins[r],e&&("any"===t||t in e)&&(n=e)}return n}function z(e){return e.type?L(e):$(e)}function L(e){if(!e.type)return;let t=0,r=e.type;for(;Array.isArray(r)&&!o(r);)r=r[0],t++;return{type:r,ndimArray:t}}function $(e){if(!e.types)return;let t=0,r=e.types;for(;Array.isArray(r);)r=r[0],t++;return{types:r,ndimArray:t}}function E(e){(function(e){if(e.json||(e.json={}),h(e.json),A(e.json),w(e.json),e.json.origins)for(const t in e.json.origins)h(e.json.origins[t]),A(e.json.origins[t]),w(e.json.origins[t]);return!0})(e)&&(function(e){if(e.json&&e.json.origins){const t=e.json.origins,r={"web-document":["web-scene","web-map"]};for(const e in r)if(t[e]){const n=t[e];r[e].forEach(e=>{t[e]=n}),delete t[e]}}}(e),function(e){const t=(r=e).json.types?$(r.json):r.type?L(r):$(r);var r;if(e.json.origins)for(const r in e.json.origins){const n=e.json.origins[r],o=n.types?z(n):t;f(o,n,!1),n.types&&!n.write&&e.json.write?.enabled&&(n.write={...e.json.write}),v(o,n)}f(t,e.json,!0),v(t,e.json)}(e))}const J=new Set,U=new Set;function V(e){return n=>{e??="esri.core.Accessor",n.prototype.declaredClass=e,B(n);const o=[],i=[];let s=n.prototype;for(;s;)s.hasOwnProperty("initialize")&&!J.has(s.initialize)&&(J.add(s.initialize),o.push(s.initialize)),s.hasOwnProperty("destroy")&&!U.has(s.destroy)&&(U.add(s.destroy),i.push(s.destroy)),s=Object.getPrototypeOf(s);J.clear(),U.clear();const a=class extends n{constructor(...e){if(super(...e),this.constructor===a&&"function"==typeof this.postscript){if(o.length&&Object.defineProperty(this,"initialize",{enumerable:!1,configurable:!0,value(){for(let e=o.length-1;e>=0;e--)o[e].call(this)}}),i.length){let e=!1;const r=this[c];Object.defineProperty(this,"destroy",{enumerable:!1,configurable:!0,value(){if(!e){this.__accessor__.lifecycle=t.DESTROYING,e=!0,r.call(this);for(let e=0;e<i.length;e++)i[e].call(this)}}})}Object.defineProperty(this,Symbol.dispose,{enumerable:!1,configurable:!0,value(){this.destroy()}}),this.postscript()}}};a.__accessorMetadata__=r(n.prototype),a.prototype.declaredClass=e;const u=(e||"AccessorSubclass").split(".").slice(-1)[0];return Object.defineProperty(a,"name",{value:u,configurable:!0}),a}}function D(e,t){return null==t.get?function(){const t=this.__accessor__,r=t.propertiesByName.get(e);if(void 0===r)return;t.mutable&&n(r);const o=t.store;return o.has(e)?o.get(e):r.metadata.value}:function(){const t=this.__accessor__,r=t.propertiesByName.get(e);if(void 0!==r)return r.getComputed(t)}}function B(e){const n=e.prototype,o=r(n),i={};for(const e of Object.getOwnPropertyNames(o)){const r=o[e];E(r),i[e]={enumerable:!0,configurable:!0,get:D(e,r),set(n){const o=this.__accessor__;if(void 0!==o){if(o.mutable)return o.initialized&&r.readOnly?K("read-only",e):o.lifecycle===t.CONSTRUCTED&&r.constructOnly?K("construct-only",e):void o.set(e,n)}else Object.defineProperty(this,e,{enumerable:!0,configurable:!0,writable:!0,value:n})}}}Object.defineProperties(e.prototype,i)}const K=(t,r)=>{e.getLogger("esri.core.Accessor").error(`cannot assign to ${t} property '${r}'`)};export{C as a,x as b,y as c,c as d,B as finalizeClass,N as n,T as o,V as subclass};
