/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{n as e}from"../chunks/nextTick.js";import{P as s}from"../chunks/PooledArray.js";import{createResolver as t,isAborted as n,createAbortError as r}from"./promiseUtils.js";import"./lang.js";import"../chunks/handleUtils.js";import"./Error.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/object.js";import"../chunks/string.js";import"../chunks/events.js";import"../chunks/maybe.js";class o{constructor(e,s=30){this.name=e,this._counter=0,this._samples=new Array(s)}push(e){null!=e&&(this._samples[++this._counter%this._samples.length]=e)}set(e){null!=e&&(this._samples[this._counter%this._samples.length]=e)}get median(){return this._samples.slice().sort((e,s)=>e-s)[Math.floor(this._samples.length/2)]}get average(){return this._samples.reduce((e,s)=>e+s,0)/this._samples.length}get last(){return this._samples[this._counter%this._samples.length]}}function a(e){return e}function i(e){return 1e3*e}function c(e){return e}function u(e){return.001*e}class m{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}}class l{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}}let h=0,p=0;const f={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},d=["prepare","preRender","render","postRender","update","finish"],k=[],w=new s;class _{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1,g()}}function g(){null==F&&(h=performance.now(),F=requestAnimationFrame(x))}const v={frameTasks:w,willDispatch:!1,clearFrameTasks:function(e=!1){w.forAll(e=>{e.removed=!0}),e&&b()},dispatch:M,executeFrameTasks:function(e){const s=e-h;h=e;const t=p>0?p:1e3/60,n=Math.max(0,s-t);f.time=e,f.frameDuration=t-n;for(let t=0;t<d.length;t++){const n=performance.now(),r=d[t];w.forAll(n=>{n.paused||n.removed||(0===t&&n.ticks++,n.phases[r]&&(f.elapsedFrameTime=performance.now()-e,f.deltaTime=0===n.ticks?0:s,n.phases[r]?.call(n,f)))}),E[t].push(performance.now()-n)}b(),L.push(performance.now()-e)},reschedule:function(){null!=F&&(cancelAnimationFrame(F),F=requestAnimationFrame(x))}};function j(s){const t=new l(s);return k.push(t),v.willDispatch||(v.willDispatch=!0,e(M)),t}function A(e){const s=new m(e);return w.push(s),g(),new _(s)}let F=null;function T(e){p=Math.max(0,e)}function x(){const e=performance.now();F=null;const s=w.some(e=>!e.paused&&!e.removed);F=s?requestAnimationFrame(x):null,v.executeFrameTasks(e)}const D=new s;function b(){w.forAll(e=>{e.removed&&D.push(e)}),w.removeUnorderedMany(D.data,D.length),D.clear()}function y(){w.prune(),D.prune()}function M(){for(;k.length;){const e=k.shift();e.isActive&&e.callback()}v.willDispatch=!1}function q(s=1,o){const a=t(),i=()=>{n(o)?a.reject(r()):0===s?a():(--s,e(()=>i()))};return i(),a.promise}function P(e){return q(1,e)}function R(){const e=t(),s=A({postRender:()=>{s.remove(),j(e)}});return e.promise}async function U(e){await P(e),await new Promise(s=>requestAnimationFrame(()=>{e?.aborted||s()}))}const E=d.map(e=>new o(e)),L=new o("total");export{_ as FrameTaskHandle,a as M,o as P,c as S,A as addFrameTask,y as cleanupScheduling,v as debug,i as m,E as performanceInfo,L as performanceTotal,u as s,j as schedule,T as setFrameDuration,U as waitAnimationFrame,R as waitRender,P as waitTick,q as waitTicks};
