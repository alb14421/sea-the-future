/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./chunks/tslib.es6.js";import t from"./config.js";import r from"./request.js";import s from"./core/Collection.js";import{r as o}from"./chunks/collectionUtils.js";import{JSONSupportMixin as a}from"./core/JSONSupport.js";import{isClonable as i,clone as n}from"./core/lang.js";import{Loadable as l}from"./core/Loadable.js";import{l as p}from"./chunks/loadAll.js";import{L as c}from"./chunks/Logger.js";import{d as m}from"./chunks/maybe.js";import{throwIfAborted as h}from"./core/promiseUtils.js";import{isProtocolRelative as u,urlToObject as y}from"./core/urlUtils.js";import{property as d}from"./core/accessorSupport/decorators/property.js";import{subclass as f}from"./core/accessorSupport/decorators/subclass.js";import{w as j}from"./chunks/writer.js";import b from"./geometry/SpatialReference.js";import g from"./portal/Portal.js";import w from"./portal/PortalItem.js";import{g as L,e as k}from"./chunks/basemapDefinitions.js";import I from"./support/BasemapStyle.js";import{g as S}from"./chunks/writeUtils.js";import"./chunks/object.js";import"./kernel.js";import"./core/Error.js";import"./chunks/MapUtils.js";import"./chunks/persistableUrlUtils.js";import"./chunks/watch.js";import"./chunks/ObjectPool.js";import"./chunks/handleUtils.js";import"./core/scheduling.js";import"./chunks/nextTick.js";import"./chunks/PooledArray.js";import"./chunks/SetUtils.js";import"./chunks/get.js";import"./chunks/utils.js";import"./chunks/Lifecycle.js";import"./chunks/tracking.js";import"./chunks/SimpleTrackingTarget.js";import"./core/Evented.js";import"./core/Accessor.js";import"./core/Handles.js";import"./chunks/metadata.js";import"./chunks/ObservableBase.js";import"./chunks/string.js";import"./chunks/ensureType.js";import"./chunks/Warning.js";import"./chunks/events.js";import"./chunks/shared.js";import"./chunks/SimpleObservable.js";import"./chunks/jsonUtils.js";import"./core/Promise.js";import"./chunks/asyncUtils.js";import"./chunks/unitUtils.js";import"./chunks/jsonMap.js";import"./chunks/pe.js";import"./chunks/assets.js";import"./chunks/reader.js";import"./geometry/Extent.js";import"./geometry/Geometry.js";import"./geometry/Point.js";import"./core/accessorSupport/decorators/cast.js";import"./geometry/support/webMercatorUtils.js";import"./chunks/locale.js";import"./portal/PortalGroup.js";import"./portal/PortalQueryParams.js";import"./portal/PortalQueryResult.js";import"./portal/PortalUser.js";import"./portal/PortalFolder.js";import"./portal/PortalItemResource.js";import"./portal/PortalRating.js";import"./chunks/messages.js";import"./intl.js";import"./chunks/date.js";import"./chunks/constants.js";import"./chunks/datetime.js";import"./chunks/number.js";import"./chunks/substitute.js";import"./chunks/layerUtils.js";import"./layers/catalog/catalogUtils.js";import"./core/reactiveUtils.js";var U;let v=0,_=U=class extends(a(l)){constructor(e){super(e),this.id=null,this.portalItem=null,this.spatialReference=null,this.style=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+v++,this.baseLayers=new s,this.referenceLayers=new s;const t=e=>{e.parent&&e.parent!==this&&"remove"in e.parent&&e.parent.remove(e),e.parent=this,"elevation"===e.type&&c.getLogger(this).error(`Layer '${e.title}, id:${e.id}' of type '${e.type}' is not supported as a basemap layer and will therefore be ignored.`)},r=e=>{e.parent=null};this.addHandles([this.baseLayers.on("after-add",e=>t(e.item)),this.referenceLayers.on("after-add",e=>t(e.item)),this.baseLayers.on("after-remove",e=>r(e.item)),this.referenceLayers.on("after-remove",e=>r(e.item))])}initialize(){this.when().catch(e=>{c.getLogger(this).error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.baseLayers.toArray();for(const t of e)t.destroyed||t.destroy();const t=this.referenceLayers.toArray();for(const e of t)e.destroyed||e.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),this.portalItem=m(this.portalItem)}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e}set baseLayers(e){this._set("baseLayers",o(e,this._get("baseLayers")))}_writeBaseLayers(e,t,r){const s=[];e?(r={...r,layerContainerType:"basemap"},this.baseLayers.forEach(e=>{const t=S(e,r.webmap?r.webmap.getLayerJSONFromResourceInfo(e):null,r);null!=t&&s.push(t)}),this.referenceLayers.forEach(e=>{const t=S(e,r.webmap?r.webmap.getLayerJSONFromResourceInfo(e):null,r);null!=t&&("scene"!==e.type&&(t.isReference=!0),s.push(t))}),t.baseMapLayers=s):t.baseMapLayers=s}get loaded(){return super.loaded}set referenceLayers(e){this._set("referenceLayers",o(e,this._get("referenceLayers")))}writeTitle(e,t){t.title=e||"Basemap"}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return p(this,e=>{e(this.baseLayers,this.referenceLayers)})}clone(){const e={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.map(e=>i(e)?e.clone():e),referenceLayers:this.referenceLayers.map(e=>i(e)?e.clone():e)};return this.loaded&&(e.loadStatus="loaded"),new U({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}write(e,t){return e=e||{},t?.origin||(t={origin:"web-map",...t}),super.write(e,t),!this.loaded&&this.resourceInfo?.data.baseMapLayers&&(e.baseMapLayers=this.resourceInfo.data.baseMapLayers.map(e=>{const t=n(e);return t.url&&u(t.url)&&(t.url=`https:${t.url}`),t.templateUrl&&u(t.templateUrl)&&(t.templateUrl=`https:${t.templateUrl}`),t})),e}async _loadFromSource(e){const{resourceInfo:t,portalItem:r,style:s}=this;h(e);const o=[];if(t){const r=t.context?t.context.url:null;if(o.push(this._loadLayersFromJSON(t.data,r,e)),t.data.id&&!t.data.title){const e=t.data.id;o.push(L(e).then(e=>{e&&this.read({title:e},t.context)}))}}else r?o.push(this._loadFromItem(r,e)):s&&o.push(this._loadFromStylesService(s,e));await Promise.all(o)}async _loadLayersFromJSON(e,t,r){const s=this.resourceInfo?.context,o=this.portalItem?.portal||s?.portal||null,a=x[s?.origin||""]??"web-map",{populateOperationalLayers:i}=await import("./chunks/layersCreator.js"),n=[];if(h(r),e.baseMapLayers&&Array.isArray(e.baseMapLayers)){const r={context:{...s,origin:a,url:t,portal:o,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},l=e=>"web-scene"===a&&"ArcGISSceneServiceLayer"===e.layerType||e.isReference,p=i(this.baseLayers,e.baseMapLayers.filter(e=>!l(e)),r);n.push(p);const c=i(this.referenceLayers,e.baseMapLayers.filter(l),r);n.push(c)}await Promise.allSettled(n)}async _loadFromItem(e,t){const r=await e.load(t),s=await r.fetchData("json",t),o=y(e.itemUrl??"");return this._set("resourceInfo",{data:s.baseMap??{},context:{origin:P[e.type||""]??"web-map",portal:e.portal||g.getDefault(),url:o}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:s.spatialReference},this.resourceInfo.context),this.read({title:e.title,thumbnailUrl:e.thumbnailUrl},{origin:"portal-item",portal:e.portal||g.getDefault(),url:o}),this._loadLayersFromJSON(this.resourceInfo.data,o,t)}async _loadFromStylesService(e,s){const o=e.serviceUrl.endsWith("/webmaps")?e.serviceUrl.slice(0,-8):e.serviceUrl,a=`${o}/styles/${e.id}/self`,i=`${o}/webmaps/${e.id}`,n=e.apiKey??t.apiKeys.basemapStyles,[l,p]=await Promise.all([(await r(a,{query:{token:n},signal:s?.signal})).data,(await r(i,{query:{language:e.languageParameter,places:e.places,worldview:e.worldview,token:n},signal:s?.signal})).data]);this.thumbnailUrl??=l.thumbnailUrl;const c=y(i);if(this._set("resourceInfo",{data:p.baseMap??{},context:{origin:"web-map",url:c}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:p.spatialReference},this.resourceInfo.context),await this._loadLayersFromJSON(this.resourceInfo.data,c,s),n)for(const e of[...this.baseLayers,...this.referenceLayers])"apiKey"in e&&(e.apiKey=n)}static fromId(e){const t=k[e];return t?t.itemId?new U({portalItem:{id:t.itemId,portal:{url:"https://www.arcgis.com"}}}):U.fromJSON(t,t.is3d?{origin:"web-scene",portal:new g({url:"https://www.arcgis.com"})}:{origin:"web-map"}):null}};e([d({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(e,t,r,s){this._writeBaseLayers(e,t,s)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:s}},writer(e,t,r,s){this._writeBaseLayers(e,t,s)}}}}}})],_.prototype,"baseLayers",null),e([d({type:String,json:{origins:{"web-scene":{write:!0}}}})],_.prototype,"id",void 0),e([d({type:w})],_.prototype,"portalItem",void 0),e([d()],_.prototype,"referenceLayers",null),e([d({readOnly:!0})],_.prototype,"resourceInfo",void 0),e([d({type:b})],_.prototype,"spatialReference",void 0),e([d({type:I})],_.prototype,"style",void 0),e([d()],_.prototype,"thumbnailUrl",void 0),e([d({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],_.prototype,"title",void 0),e([j("title")],_.prototype,"writeTitle",null),_=U=e([f("esri.Basemap")],_);const P={"Web Scene":"web-scene","Web Map":"web-map","Link Chart":"link-chart"},x={"web-scene":"web-scene","web-map":"web-map","link-chart":"link-chart"},M=_;export{M as default};
