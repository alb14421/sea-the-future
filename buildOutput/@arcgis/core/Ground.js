/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as r}from"./chunks/tslib.es6.js";import e from"./Color.js";import s from"./core/Collection.js";import{r as t}from"./chunks/collectionUtils.js";import{y as o,clone as i}from"./core/lang.js";import a from"./core/Error.js";import{JSONSupport as n,JSONSupportMixin as l}from"./core/JSONSupport.js";import{Loadable as c}from"./core/Loadable.js";import{l as p}from"./chunks/loadAll.js";import{L as u}from"./chunks/Logger.js";import{d as m}from"./chunks/maybe.js";import{isAbortError as y,throwIfAborted as h}from"./core/promiseUtils.js";import{property as d}from"./core/accessorSupport/decorators/property.js";import{I as j}from"./chunks/ensureType.js";import{subclass as f}from"./core/accessorSupport/decorators/subclass.js";import{w as g}from"./chunks/writer.js";import{e as k}from"./chunks/enumeration.js";import{G as v}from"./chunks/groundInstanceUtils.js";import{t as w,o as S}from"./chunks/opacityUtils.js";import"./chunks/colorUtils.js";import"./chunks/mathUtils.js";import"./config.js";import"./chunks/object.js";import"./chunks/string.js";import"./chunks/MapUtils.js";import"./chunks/watch.js";import"./chunks/ObjectPool.js";import"./chunks/handleUtils.js";import"./core/scheduling.js";import"./chunks/nextTick.js";import"./chunks/PooledArray.js";import"./chunks/SetUtils.js";import"./chunks/get.js";import"./chunks/utils.js";import"./chunks/Lifecycle.js";import"./chunks/tracking.js";import"./chunks/SimpleTrackingTarget.js";import"./core/Evented.js";import"./core/Accessor.js";import"./core/Handles.js";import"./chunks/metadata.js";import"./chunks/ObservableBase.js";import"./chunks/Warning.js";import"./chunks/events.js";import"./chunks/shared.js";import"./chunks/SimpleObservable.js";import"./chunks/jsonUtils.js";import"./core/Promise.js";import"./chunks/asyncUtils.js";import"./chunks/jsonMap.js";var b;let C=b=class extends n{constructor(r){super(r),this.type="none"}clone(){return new b({type:this.type})}};var I,L;r([k({none:"none",stayAbove:"stay-above"}),d({json:{write:{isRequired:!0}}})],C.prototype,"type",void 0),C=b=r([f("esri.ground.NavigationConstraint")],C);let A=L=class extends(l(c)){static{I=v}constructor(r){super(r),this[I]=!0,this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new s;const e=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,"elevation"!==r.type&&"base-elevation"!==r.type&&u.getLogger(this).error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)};this.addHandles([this.layers.on("after-add",r=>e(r.item)),this.layers.on("after-remove",r=>{r.item.parent=null})])}initialize(){this.when().catch(r=>{y(r)||u.getLogger(this).error("#load()","Failed to load ground",r)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const r=this.layers.removeAll();for(const e of r)m(e);this.layers.destroy()}normalizeCtorArgs(r){return r&&"resourceInfo"in r&&(this._set("resourceInfo",r.resourceInfo),delete(r={...r}).resourceInfo),r}get loaded(){return super.loaded}get layers(){return this._get("layers")}set layers(r){this._set("layers",t(r,this._get("layers")))}writeLayers(r,e,s,t){const i=[];r?(t={...t,layerContainerType:"ground"},r.forEach(r=>{if("write"in r){const e={};o(r)().write(e,t)&&i.push(e)}else t?.messages&&t.messages.push(new a("layer:unsupported",`Layers (${r.title}, ${r.id}) of type '${r.declaredClass}' cannot be persisted in the ground`,{layer:r}))}),e.layers=i):e.layers=i}load(r){return this.addResolvingPromise(this._loadFromSource(r)),Promise.resolve(this)}loadAll(){return p(this,r=>{r(this.layers)})}async queryElevation(r,e){await this.load({signal:e?.signal});const{ElevationQuery:s}=await import("./chunks/ElevationQuery.js");h(e);const t=new s,o=this.layers.filter(E).toArray();return t.queryAll(o,r,e)}async createElevationSampler(r,e){await this.load({signal:e?.signal});const{ElevationQuery:s}=await import("./chunks/ElevationQuery.js");h(e);const t=new s,o=this.layers.filter(E).toArray();return t.createSamplerAll(o,r,e)}clone(){const r={opacity:this.opacity,surfaceColor:i(this.surfaceColor),navigationConstraint:i(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(r.loadStatus="loaded"),new L({resourceInfo:this.resourceInfo}).set(r)}read(r,e){this.resourceInfo||this._set("resourceInfo",{data:r,context:e}),super.read(r,e)}_loadFromSource(r){const e=this.resourceInfo;return e?this._loadLayersFromJSON(e.data,e.context,r):Promise.resolve()}async _loadLayersFromJSON(r,e,s){const t=e?.origin||"web-scene",o=e?.portal||null,i=e?.url||null,{populateOperationalLayers:a}=await import("./chunks/layersCreator.js");h(s);const n=[];if(r.layers&&Array.isArray(r.layers)){const e={context:{origin:t,url:i,portal:o,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};n.push(a(this.layers,r.layers,e))}await Promise.allSettled(n)}};function E(r){return"elevation"===r.type||function(r){return r&&"createElevationSampler"in r}(r)}r([d({json:{read:!1,write:{isRequired:!0}}})],A.prototype,"layers",null),r([g("layers")],A.prototype,"writeLayers",null),r([d({readOnly:!0})],A.prototype,"resourceInfo",void 0),r([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:j,read:{reader:w,source:"transparency"},write:{writer:(r,e)=>{e.transparency=S(r)},target:"transparency"}}})],A.prototype,"opacity",void 0),r([d({type:e,json:{type:[j],write:(r,e)=>{e.surfaceColor=r.toJSON().slice(0,3)}}})],A.prototype,"surfaceColor",void 0),r([d({type:C,json:{write:!0}})],A.prototype,"navigationConstraint",void 0),A=L=r([f("esri.Ground")],A);const U=A;export{U as default};
