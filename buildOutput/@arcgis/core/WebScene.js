/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"./chunks/tslib.es6.js";import{version as t}from"./kernel.js";import r from"./Map.js";import i from"./core/Collection.js";import s from"./core/Error.js";import{clone as o}from"./core/lang.js";import{LoadableMixin as a}from"./core/Loadable.js";import{l as n}from"./chunks/loadAll.js";import{L as p}from"./chunks/Logger.js";import{d as l}from"./chunks/maybe.js";import{M as c,a as m}from"./chunks/MultiOriginJSONSupport.js";import{EsriPromiseMixin as h}from"./core/Promise.js";import{debounce as u}from"./core/promiseUtils.js";import{on as d,watch as y}from"./core/reactiveUtils.js";import{urlToObject as g,addQueryParameter as w}from"./core/urlUtils.js";import{W as f}from"./chunks/Warning.js";import{property as j}from"./core/accessorSupport/decorators/property.js";import{r as b}from"./chunks/reader.js";import{subclass as v}from"./core/accessorSupport/decorators/subclass.js";import{w as S}from"./chunks/writer.js";import{u as k}from"./chunks/originUtils.js";import{JSONSupport as _,r as I}from"./core/JSONSupport.js";import A from"./geometry/Extent.js";import L from"./geometry/HeightModelInfo.js";import{canProjectWithoutEngine as P}from"./chunks/projectionUtils.js";import U from"./geometry/SpatialReference.js";import{v as R}from"./chunks/heightModelInfoUtils.js";import{fromJSON as O}from"./geometry/support/jsonUtils.js";import{a5 as M}from"./chunks/unitUtils.js";import V from"./portal/Portal.js";import E from"./portal/PortalItem.js";import{c as C}from"./chunks/jsonContext.js";import{b as T,t as F}from"./chunks/portalItemUtils.js";import{h as x}from"./chunks/basemapUtils.js";import N from"./support/MapFloorInfo.js";import{W as G}from"./chunks/tagSymbols.js";import{i as W}from"./chunks/spatialReferenceSupport.js";import{a as B}from"./chunks/Widgets.js";import{u as J,s as q}from"./chunks/resourceUtils2.js";import{e as $}from"./chunks/saveUtils.js";import{g as D}from"./chunks/thumbnailUtils.js";import{isCopyAllowed as H,initializeNewItem as z}from"./chunks/webdocSaveUtils.js";import K from"./webscene/ApplicationProperties.js";import Q from"./webscene/Environment.js";import X from"./webscene/InitialViewProperties.js";import Y from"./webscene/Presentation.js";import{V as Z}from"./chunks/Version.js";import{a as ee}from"./chunks/AlphaCutoff.js";import"./config.js";import"./chunks/object.js";import"./chunks/string.js";import"./chunks/jsonUtils.js";import"./Basemap.js";import"./request.js";import"./chunks/MapUtils.js";import"./chunks/persistableUrlUtils.js";import"./chunks/collectionUtils.js";import"./chunks/basemapDefinitions.js";import"./chunks/assets.js";import"./chunks/messages.js";import"./chunks/handleUtils.js";import"./chunks/locale.js";import"./support/BasemapStyle.js";import"./intl.js";import"./chunks/date.js";import"./chunks/jsonMap.js";import"./chunks/constants.js";import"./chunks/datetime.js";import"./chunks/number.js";import"./chunks/substitute.js";import"./chunks/events.js";import"./core/Accessor.js";import"./core/Handles.js";import"./chunks/get.js";import"./chunks/utils.js";import"./chunks/Lifecycle.js";import"./chunks/metadata.js";import"./chunks/ObjectPool.js";import"./chunks/ObservableBase.js";import"./chunks/tracking.js";import"./chunks/watch.js";import"./core/scheduling.js";import"./chunks/nextTick.js";import"./chunks/PooledArray.js";import"./chunks/SetUtils.js";import"./chunks/SimpleTrackingTarget.js";import"./chunks/ensureType.js";import"./chunks/writeUtils.js";import"./chunks/layerUtils.js";import"./layers/catalog/catalogUtils.js";import"./core/Evented.js";import"./chunks/shared.js";import"./chunks/SimpleObservable.js";import"./chunks/asyncUtils.js";import"./chunks/pe.js";import"./geometry/Geometry.js";import"./geometry/Point.js";import"./core/accessorSupport/decorators/cast.js";import"./geometry/support/webMercatorUtils.js";import"./portal/PortalGroup.js";import"./portal/PortalQueryParams.js";import"./portal/PortalQueryResult.js";import"./portal/PortalUser.js";import"./portal/PortalFolder.js";import"./portal/PortalItemResource.js";import"./portal/PortalRating.js";import"./Ground.js";import"./Color.js";import"./chunks/colorUtils.js";import"./chunks/mathUtils.js";import"./chunks/enumeration.js";import"./chunks/groundInstanceUtils.js";import"./chunks/opacityUtils.js";import"./chunks/CollectionFlattener.js";import"./effects/FocusAreas.js";import"./core/Clonable.js";import"./effects/FocusArea.js";import"./chunks/uuid.js";import"./chunks/persistable.js";import"./chunks/MD5.js";import"./chunks/multiOriginJSONSupportUtils.js";import"./chunks/resourceExtension.js";import"./effects/FocusAreaOutline.js";import"./chunks/PolygonCollection.js";import"./geometry/Polygon.js";import"./chunks/coordsUtils.js";import"./chunks/extentUtils.js";import"./chunks/boundsUtils.js";import"./chunks/aaBoundingRect.js";import"./chunks/zmUtils.js";import"./chunks/vec3f64.js";import"./geometry/Multipoint.js";import"./geometry/Polyline.js";import"./chunks/projectBuffer.js";import"./chunks/geodesicConstants.js";import"./chunks/projectXYZToVector.js";import"./geometry/support/GeographicTransformation.js";import"./geometry/support/GeographicTransformationStep.js";import"./chunks/zscale.js";import"./chunks/editableLayers.js";import"./chunks/basemapEnsureType.js";import"./chunks/collectionUtils2.js";import"./support/LayersMixin.js";import"./layers/Layer.js";import"./core/Identifiable.js";import"./time/TimeExtent.js";import"./chunks/timeUtils.js";import"./support/TablesMixin.js";import"./chunks/utils5.js";import"./chunks/screenUtils.js";import"./chunks/mat4.js";import"./chunks/common.js";import"./layers/support/FacilityLayerInfo.js";import"./layers/support/LevelLayerInfo.js";import"./layers/support/SiteLayerInfo.js";import"./webdoc/widgets/TimeSlider.js";import"./time/TimeInterval.js";import"./chunks/resourceUtils.js";import"./chunks/project.js";import"./chunks/utils9.js";import"./chunks/utils10.js";import"./rest/support/ProjectParameters.js";import"./webdoc/applicationProperties/Viewing.js";import"./webdoc/applicationProperties/Search.js";import"./webdoc/applicationProperties/SearchLayer.js";import"./webdoc/applicationProperties/SearchLayerField.js";import"./chunks/fieldType.js";import"./webdoc/applicationProperties/SearchTable.js";import"./webdoc/applicationProperties/SearchTableField.js";import"./views/3d/environment/SunnyWeather.js";import"./chunks/weather.js";import"./views/3d/environment/CloudyWeather.js";import"./views/3d/environment/FoggyWeather.js";import"./views/3d/environment/RainyWeather.js";import"./views/3d/environment/SnowyWeather.js";import"./chunks/lightingTypes.js";import"./webscene/SunLighting.js";import"./webscene/VirtualLighting.js";import"./webscene/background/Background.js";import"./webscene/background/ColorBackground.js";import"./chunks/materialUtils.js";import"./Viewpoint.js";import"./Camera.js";import"./CameraLayout.js";import"./chunks/Cyclical.js";import"./chunks/typeUtils.js";import"./chunks/timeProperties.js";import"./chunks/analysisUtils.js";import"./analysis/support/AnalysisOriginWebScene.js";import"./webscene/Slide.js";import"./chunks/vec3.js";import"./chunks/Scheduler.js";import"./chunks/signal.js";import"./chunks/debugFlags.js";import"./chunks/SlideThumbnail.js";import"./webscene/support/SlideElements.js";import"./webscene/SlideLegendInfo.js";import"./webscene/support/SlidePopupInfo.js";import"./webscene/support/FeatureReference.js";import"./webscene/support/FeatureReferenceObjectId.js";import"./webscene/support/FeatureReferenceId.js";import"./webscene/support/FeatureReferenceGlobalId.js";import"./webscene/support/LayerReference.js";var te;let re=te=class extends _{constructor(e){super(e)}clone(){return new te({name:this.name,path:this.path,title:this.title})}};e([j({type:String,json:{write:{isRequired:!0}}})],re.prototype,"name",void 0),e([j({type:String,json:{write:{isRequired:!0}}})],re.prototype,"path",void 0),e([j({type:String,json:{write:{isRequired:!0}}})],re.prototype,"title",void 0),re=te=e([v("esri.webscene.TransportationNetwork")],re);const ie=re;class se extends Z{constructor(e,t){super(e,t,"webscene")}get supportsGround(){return this.greaterEqual(1,8)}get supportsVisibleElevationLayersInSlides(){return this.lessThan(1,8)}}var oe;const ae=new se(1,38),ne="Web Scene";let pe=class extends(a(h(c(r)))){static{oe=G}constructor(e){super(e),this[oe]=!0,this._layersIdGCTimeoutId=void 0,this._updateFromPromise=null,this._afterLoadHooks=[],this.applicationProperties=null,this.clippingArea=null,this.clippingEnabled=!1,this.floorInfo=null,this.heightModelInfo=void 0,this.sourceVersion=null,this.transportationNetworks=null,this.presentation=new Y,this.initialViewProperties=new X,this.portalItem=null,this.resourceInfo=null,this.widgets=null,this._debouncedSaveOperations=u(async(e,t,r)=>{switch(e){case 0:return this._saveImpl(t);case 1:return this._saveAsImpl(r,t)}}),this._loadContext={origin:"web-scene",initiator:this,hooks:{onAfterLoad:e=>this._afterLoadHooks.push(e)}},this._resourceReferences={portalItem:null,paths:[]},this.authoringApp=null,this.authoringAppVersion=null,this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1}initialize(){if(this.when().catch(e=>{p.getLogger(this).error("#load()","Failed to load web scene",e)}),this.resourceInfo){let e;try{e=this._validateJSON(this.resourceInfo)}catch(e){return void this.addResolvingPromise(Promise.reject(e))}this.read(e),this.addResolvingPromise(this._validateSpatialReference()),this.addResolvingPromise(this._validateHeightModelInfo())}this.addHandles(d(()=>this.allLayers,"change",()=>this._scheduleLayersIdGC()))}destroy(){this._unscheduleLayersIdGC(),this.presentation&&this.presentation.destroy(),this.portalItem=l(this.portalItem)}writeClippingArea(e,t){t.clippingArea||(t.clippingArea={}),t.clippingArea.geometry=e.toJSON()}readClippingEnabled(e,t){return!!t.clippingArea&&!!t.clippingArea.clip}writeClippingEnabled(e,t){this.clippingArea&&(t.clippingArea||(t.clippingArea={}),t.clippingArea.clip=e)}writeLayers(e,t,r,i){t[r]=this._layersToJSON(e,"operational-layers",i)}get loaded(){return super.loaded}readSourceVersion(e,t){const[r,i]=t.version.split(".");return new se(parseInt(r,10),parseInt(i,10))}writeSourceVersion(e,t,r){t[r]=`${ae.major}.${ae.minor}`}writeTables(e,t,r,i){const s=this._layersToJSON(e,"tables",i);s.length&&(t[r]=s)}get thumbnailUrl(){return this.portalItem?.thumbnailUrl??null}set thumbnailUrl(e){e?this._override("thumbnailUrl",e):(this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp="ArcGIS API for JavaScript"}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}writeAuthoringAppVersion(e,r){e&&this._isAuthoringAppVersionSetByUser?r.authoringAppVersion=e:r.authoringAppVersion=t}writeGround(e,t,r,i){t[r]=e?e.write({},i):{transparency:0,layers:[]}}readInitialViewProperties(e,t,r){const{viewingMode:i,spatialReference:s}=t,o=new X,a={...t.initialState};return void 0!==s&&(a.spatialReference=s),void 0!==i&&(a.viewingMode=i),o.read(a,r),o}get spatialReference(){return this.initialViewProperties?.spatialReference??U.WebMercator}get viewingMode(){return this.initialViewProperties?.viewingMode??"global"}load(e){const t=this.ground;return this.addResolvingPromise(this._loadFromSource().then(()=>{t&&t!==this.ground&&t.destroy(),this._validateFeatureLayerSymbolVisibility()})),Promise.resolve(this)}loadAll(){return n(this,e=>{const t=this.presentation&&this.presentation.slides;e(this.ground,this.basemap,this.layers,t&&t.map(e=>e.basemap),this.tables)})}read(e,t){t??=this._loadContext,t.origin="web-scene";const r=this._isAuthoringAppVersionSetByUser,i=this._isAuthoringAppSetByUser;if(I(this,e,t=>super.read(e,t),t),i||(this._isAuthoringAppSetByUser=!1),r||(this._isAuthoringAppVersionSetByUser=!1),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)&&this.sourceVersion?.supportsVisibleElevationLayersInSlides){const t=e.baseMap.elevationLayers.map(e=>({id:e.id})),r=this.presentation.slides,i=t.filter(e=>!r.some(t=>t.visibleLayers.some(t=>t.id===e.id)));r.forEach(e=>e.visibleLayers.addMany(i))}}_writeBasemapElevationLayers(e){const t=e.ground?.layers;!e.baseMap&&t?.length&&(e.baseMap={title:"Basemap",baseMapLayers:[]}),e.baseMap&&(e.baseMap.elevationLayers=o(t))}_layersToJSON(e,t,r){const i={...r,layerContainerType:t};return e.map(e=>this._verifyWritableLayer(e,r)?e.write({},i):null).filter(e=>!!e).toArray()}_verifyWritableLayer(e,t){return!!e.persistenceEnabled&&("write"in e||(t?.messages&&t.messages.push(new s("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in web scenes`,{layer:e})),!1))}write(e,t){if("loaded"!==this.loadStatus){const e=new s("webscene:not-loaded","Web scene must be loaded before it can be serialized");throw p.getLogger(this).error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus),e}this._runLayersIdGC();const r=!t?.messages;t={messages:[],...t,origin:"web-scene"};const i=super.write(e,t);if(r){const e=t.messages?.filter(e=>"web-document-write:property-required"===e.name)??[];if(e.length){const t=new s("web-document:property-required","One or more properties that are required in the webscene JSON are missing, see details for the specific errors",{errors:e});throw p.getLogger(this).error("#toJSON()","One or more properties that are required in the webscene JSON are missing",e),t}}return this._writeBasemapElevationLayers(i),i}async save(e){return this._debouncedSaveOperations(0,e)}async _saveImpl(e){if(!this.portalItem)throw new s("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene");if(this.portalItem?.type!==ne)throw new s("webscene:portal-item-wrong-type",`Portal item needs to have type "${ne}"`);const t=this._updateFromPromise;await this._ensureLoadBeforeSave();const r=this._enableVerifyItemRelativeUrls(C(this.portalItem,"web-scene",!0)),i=this.write({},r);return await Promise.all(r.resources.pendingOperations),await this._verifySave(i,r,0,e),this._updateTypeKeywords(this.portalItem),await J(this.portalItem,i,this._resourceReferences,r),k(r),t&&await t,await this._saveThumbnail(),this.portalItem}async saveAs(e,t){return this._debouncedSaveOperations(1,t,e)}async _saveAsImpl(e,t){let r=E.from(e);if(!r)throw new s("webscene:portal-item-required","saveAs requires a portal item to save to");r.id&&(r=r.clone(),r.id=null);const i=r.portal||V.getDefault();await this._ensureLoadBeforeSave(),r.type=ne,r.portal=i;const o=this._enableVerifyItemRelativeUrls(C(r,"web-scene",!0)),a=this.write({},o);await Promise.all(o.resources.pendingOperations),await this._verifySaveAs(a,o,t);const n=this.thumbnailUrl,p=!this._isOverridden("thumbnailUrl");this._updateTypeKeywords(r),await i.signIn();const l=this.portalItem,c={item:l,authenticated:!(!l?.id||!l.portal.user)},{copyAllowed:h,itemReloaded:u}=await H(c,i);if(c.authenticated||=u,!h)throw new s(`${o.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const d={...t,copyAllResources:!0};return await z(r,c,a,d)&&(this._resourceReferences.portalItem=r),await q(this._resourceReferences,o),this.portalItem=r,m.prototype.read.call(this,{version:a.version,authoringApp:a.authoringApp,authoringAppVersion:a.authoringAppVersion},{name:"web-scene",ignoreDefaults:!0,url:r.itemUrl?g(r.itemUrl):void 0}),k(o),n&&(this.thumbnailUrl=p?w(n,"w","8192"):n),o.portalItem=r,await this._saveThumbnail(),r}async _saveThumbnail(){this._isOverridden("thumbnailUrl")&&(await(this.portalItem?.updateThumbnail({thumbnail:this.thumbnailUrl})),this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}async _verifySave(e,t,r,i){if(!M(this.spatialReference))throw new s("webscene:unsupported-spatial-reference","Webscenes using spatial reference systems from Mars or Moon can not be saved currently.");const{ignoreUnsupported:o,requiredPropertyChecksDisabled:a,strictSchemaValidationEnabled:n}=i||{};$(t,{errorName:"webscene:save"},{ignoreUnsupported:o,supplementalUnsupportedErrors:["scenemodification:unsupported"],requiredPropertyChecksDisabled:a})}_verifySaveAs(e,t,r){return this._verifySave(e,t,1,r)}verifySaveAs(e){const t=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),r=this.write({},t);return this._verifySaveAs(r,t,e)}canNotSaveAs(){return!1}async updateFrom(e,t={}){const r=this._updateFrom(e,t);this._updateFromPromise=r,await r,this._updateFromPromise===r&&(this._updateFromPromise=null)}async _updateFrom(e,t={}){if(await e.whenReady(),!t.environmentExcluded&&e.environment&&(this.initialViewProperties.environment=Q.prototype.clone.apply(e.environment)),!t.viewpointExcluded&&e.viewpoint&&(this.initialViewProperties.viewpoint=e.viewpoint.clone()),this.initialViewProperties.spatialReference=e.spatialReference.clone(),this.initialViewProperties.viewingMode=e.viewingMode,this.initialViewProperties.timeExtent=e.timeExtent?.clone()??null,this.initialViewProperties.analyses.updateFrom(e),null!=e.clippingArea?e.clippingArea!==this.clippingArea&&(this.clippingArea=e.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,e.heightModelInfo&&(this.heightModelInfo=e.heightModelInfo.clone()),e.map===this)for(const t of e.allLayerViews){const e="visible";e in t&&e in t.layer&&t._isOverridden(e)&&(t.layer[e]=t[e])}if(!t.widgetsExcluded)for(const t of e.persistableViewModels)t.updateWebDocument(this);(!1===t.thumbnailExcluded||null==t.thumbnailExcluded&&!t.viewpointExcluded)&&await this.updateThumbnail(e,{size:t.thumbnailSize})}async updateThumbnail(e,t){const r=D(e,t?.size),i=await e.takeScreenshot({format:"jpg",width:r.width,height:r.height,disableDecorations:!0});this.thumbnailUrl=i.dataUrl}async _loadFromSource(){this.resourceInfo?await this._loadFromJSON(this.resourceInfo):this.portalItem?.id?await this._loadFromItem(this.portalItem):await this._loadObjectsWithLayers(),await this._afterLoad()}async _afterLoad(){for(;this._afterLoadHooks.length;){const e=this._afterLoadHooks.slice();this._afterLoadHooks.length=0,await Promise.allSettled(e.map(e=>e(this._loadContext)))}}_readAndLoadFromJSON(e){const t=this._loadContext,r=this._validateJSON(e);return this.read(r,t),this._loadFromJSON(r)}_extractOperationalLayers(e){const t=[];if(!this.sourceVersion?.supportsGround&&e.baseMap&&Array.isArray(e.baseMap.elevationLayers))for(const r of e.baseMap.elevationLayers)t.push(r);const r=[],i=e=>(e.layers&&(e.layers=e.layers.filter(i)),"ArcGISTiledElevationServiceLayer"!==e.layerType||(this.sourceVersion?.supportsGround||r.push(e),!1));return{operationalLayers:e.operationalLayers?e.operationalLayers.filter(i):[],operationalElevationLayers:r,basemapElevationLayers:t}}async _loadFromJSON(e){const t=new i;await this._validateSpatialReference(),await this._validateHeightModelInfo();const{populateOperationalLayers:r}=await import("./chunks/layersCreator.js"),{operationalLayers:s,operationalElevationLayers:o,basemapElevationLayers:a}=this._extractOperationalLayers(e),n=[],p={context:{...this._loadContext,layerContainerType:"operational-layers"}};if(this.portalItem&&(p.context.portal=this.portalItem.portal||V.getDefault()),a.length>0){const e={...p,context:{...p.context,layerContainerType:"ground"}};e.defaultLayerType="ArcGISTiledElevationServiceLayer",n.push(r(this.ground.layers,a,e))}if(o.length>0){const e={...p,context:{...p.context,layerContainerType:"ground"}};e.defaultLayerType="ArcGISTiledElevationServiceLayer",n.push(r(t,o,e))}s&&s.length>0&&n.push(r(this.layers,s,p)),e.tables?.length&&n.push(r(this.tables,e.tables,{...p,context:{...p.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"})),await Promise.allSettled(n),await this._loadObjectsWithLayers(),this.ground.layers.addMany(t.filter(e=>"base-elevation"===e.type||"elevation"===e.type))}async _ensureLoadBeforeSave(){await this.load(),await this._loadObjectsWithLayers();const e=[],t=[...this.allLayers.items];for(const{basemap:e}of this.presentation.slides.items)e&&(t.push(...e.baseLayers.items),t.push(...e.referenceLayers.items));for(const r of t)if("beforeSave"in r&&"function"==typeof r.beforeSave){const t=r.beforeSave();t&&e.push(t)}await Promise.allSettled(e)}async _loadObjectsWithLayers(){const e=[];this.ground&&e.push(this.ground.load()),this.basemap&&e.push(this.basemap.load()),this.presentation.slides.forEach(t=>{t.basemap&&e.push(t.basemap.load())}),await Promise.allSettled(e)}async _loadFromItem(e){if(await e.load().catch(e=>{throw new s("webscene:load-portal-item","Failed to load portal item",{error:e})}),"Web Scene"!==e.type)throw new s("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:e.type});const t=await e.fetchData();this.resourceInfo=t;const r=this._loadContext;r.url=g(e.itemUrl),r.portal=e.portal||V.getDefault(),r.portalItem=e,r.readResourcePaths=[],await this._readAndLoadFromJSON(t),this._resourceReferences={portalItem:e,paths:r.readResourcePaths??[]}}_validateSpatialReference(){const e=this.initialViewProperties,t=this._sceneSpatialReference;let r;if("local"!==e.viewingMode){if(!W(t,1))return Promise.reject(new s("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator, WGS84 GCS or CGCS2000 are supported",{spatialReference:t,viewingMode:e.viewingMode}));r=e=>!e||P(e,t)}else{if(!W(t,2))return Promise.reject(new s("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:t,viewingMode:e.viewingMode}));r=e=>!e||e.equals(t)}const i=e=>e?.camera?.position.spatialReference??e?.targetGeometry?.spatialReference,o=e.viewpoint,a=i(o);if(a&&!r(a))return Promise.reject(new s("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:a,sceneSpatialReference:t,viewingMode:e.viewingMode}));const n=this.presentation.slides.find(e=>!r(i(e.viewpoint)));if(n){const r=i(n.viewpoint);return Promise.reject(new s("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:r,sceneSpatialReference:t,viewingMode:e.viewingMode}))}return Promise.resolve()}_validateHeightModelInfo(){const e=this._sceneSpatialReference,t=R(this.heightModelInfo,e);return t?Promise.reject(t):Promise.resolve()}_validateFeatureLayerSymbolVisibility(){this.sourceVersion?.greaterEqual(1,35)||this.layers.forEach(e=>{"feature"===e.type&&e.addHandles(y(()=>e.loaded,()=>{"on-the-ground"===e.elevationInfo?.mode&&"simple"===e.renderer?.type&&"polygon-3d"===e.renderer.symbol?.type&&e.renderer.symbol.symbolLayers.some(t=>"fill"===t.type&&null!=t.material&&(!t.material.color||t.material.color.a*e.opacity<ee)&&(e.loadWarnings.push(new f("feature-layer:invisible-draped-symbols","FeatureLayer has fully transparent symbols which will no longer render or highlight",{layer:e})),!0))},{once:!0,sync:!0}))})}_validateJSON(e){const t=se.parse(e.version||"","webscene");return ae.validate(t),e.version=`${t.major}.${t.minor}`,1===t.major&&t.minor<=2&&(e.spatialReference=U.WebMercator.toJSON()),e}_updateTypeKeywords(e){T(e,F.LOCAL_SCENE,"local"===this.initialViewProperties.viewingMode),T(e,F.DEVELOPER_BASEMAP,x(this.basemap)||this.presentation.slides.some(({basemap:e})=>!!e&&x(e))),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((e,t,r)=>r.indexOf(e)===t))}get _sceneSpatialReference(){return this.initialViewProperties.spatialReference||U.WebMercator}get _verifyItemRelativeRootPath(){return this.portalItem?.itemUrl?g(this.portalItem.itemUrl).path:null}_enableVerifyItemRelativeUrls(e){const t=this._verifyItemRelativeRootPath;return t&&(e.verifyItemRelativeUrls={rootPath:t,writtenUrls:[]}),e}_unscheduleLayersIdGC(){this._layersIdGCTimeoutId&&(clearTimeout(this._layersIdGCTimeoutId),this._layersIdGCTimeoutId=0)}_scheduleLayersIdGC(){this._unscheduleLayersIdGC(),this._layersIdGCTimeoutId=setTimeout(()=>{this._layersIdGCTimeoutId=0,this._runLayersIdGC()},3e3)}_runLayersIdGC(){this._unscheduleLayersIdGC();const e=this.applicationProperties?.viewing?.search,t=e=>this.allLayers.some(t=>t.id===e&&t.persistenceEnabled);e?.layers&&(e.layers=e.layers.filter(e=>t(e.id)));const r=this.presentation&&this.presentation.slides;r&&r.forEach(e=>{e.visibleLayers&&(e.visibleLayers=e.visibleLayers.filter(e=>t(e.id)))})}static fromJSON(e){if(!e)throw new s("webscene:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:e})}static{this.version=`${ae.major}.${ae.minor}`}};e([j({type:K,json:{write:!0}})],pe.prototype,"applicationProperties",void 0),e([j({type:A,json:{read:{source:"clippingArea.geometry",reader:O},write:{target:"clippingArea.geometry"}}})],pe.prototype,"clippingArea",void 0),e([S("clippingArea")],pe.prototype,"writeClippingArea",null),e([j({type:Boolean,json:{write:{target:"clippingArea.clip"}}})],pe.prototype,"clippingEnabled",void 0),e([b("clippingEnabled",["clippingArea"])],pe.prototype,"readClippingEnabled",null),e([S("clippingEnabled")],pe.prototype,"writeClippingEnabled",null),e([j({type:N,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],pe.prototype,"floorInfo",void 0),e([j({type:L,json:{write:!0}})],pe.prototype,"heightModelInfo",void 0),e([j({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],pe.prototype,"layers",void 0),e([S("layers")],pe.prototype,"writeLayers",null),e([j({readOnly:!0,type:se,json:{type:(()=>{const e=[],t=ae.major;for(let r=8;r<=ae.minor;r++)e.push(`${t}.${r}`);return e})(),write:{ignoreOrigin:!0,target:"version",isRequired:!0,overridePolicy:()=>({enabled:!0,allowNull:!0,ignoreOrigin:!0})}}})],pe.prototype,"sourceVersion",void 0),e([b("sourceVersion",["version"])],pe.prototype,"readSourceVersion",null),e([S("sourceVersion")],pe.prototype,"writeSourceVersion",null),e([j({json:{read:!1,write:{enabled:!0,ignoreOrigin:!0}}})],pe.prototype,"tables",void 0),e([S("tables")],pe.prototype,"writeTables",null),e([j()],pe.prototype,"thumbnailUrl",null),e([j({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],pe.prototype,"authoringApp",null),e([S("authoringApp")],pe.prototype,"writeAuthoringApp",null),e([j({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],pe.prototype,"authoringAppVersion",null),e([S("authoringAppVersion")],pe.prototype,"writeAuthoringAppVersion",null),e([j({json:{write:{isRequired:!0,allowNull:!0,ignoreOrigin:!0,enabled:!0}}})],pe.prototype,"ground",void 0),e([S("ground")],pe.prototype,"writeGround",null),e([j({type:i.ofType(ie),json:{write:!0}})],pe.prototype,"transportationNetworks",void 0),e([j({type:Y,nonNullable:!0,json:{write:{ignoreOrigin:!0,writer:(e,t,r,i)=>{if(e.slides&&e.slides.length>0){const r={...i,isPresentation:!0};t.presentation=e.write({},r)}}}}})],pe.prototype,"presentation",void 0),e([j({type:X,nonNullable:!0,json:{write:{target:"initialState",isRequired:!0,ignoreOrigin:!0},default:()=>new X({viewingMode:"global",spatialReference:U.WebMercator})}})],pe.prototype,"initialViewProperties",void 0),e([b("initialViewProperties",["initialState","spatialReference","viewingMode"])],pe.prototype,"readInitialViewProperties",null),e([j({type:U,json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],pe.prototype,"spatialReference",null),e([j({type:["local","global"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],pe.prototype,"viewingMode",null),e([j({type:E})],pe.prototype,"portalItem",void 0),e([j()],pe.prototype,"resourceInfo",void 0),e([j({type:B,json:{write:!0}})],pe.prototype,"widgets",void 0),pe=e([v("esri.WebScene")],pe);const le=pe;export{le as default};
