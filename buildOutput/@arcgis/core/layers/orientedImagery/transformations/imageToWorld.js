/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{l as s}from"../../../core/lang.js";import{e as t}from"../../../chunks/mathUtils.js";import{c as r,b as e,z as o}from"../../../chunks/vec3f64.js";import{s as i}from"../../../chunks/vec3.js";import p from"../../../geometry/Point.js";import{a as m}from"../../../chunks/utils15.js";import{d as n}from"../../../chunks/deepClone.js";import"../../../core/Error.js";import"../../../chunks/Logger.js";import a from"../../../geometry/Polygon.js";import{r as l,t as u,l as c}from"../../../chunks/plane.js";import{i as j,u as h,b as k,d as y,e as d,g as f,p as b,o as g,worldToImagePanoramic as I,n as S,worldToImage as R,h as U,j as P,k as x,l as M,r as v,v as C,m as w,q as T,s as L,t as A,w as V,x as F,y as D,z as E,A as O}from"./worldToImage.js";import"../../../chunks/common.js";import"../../../chunks/tslib.es6.js";import"../../../core/Accessor.js";import"../../../core/Handles.js";import"../../../chunks/maybe.js";import"../../../core/accessorSupport/decorators/subclass.js";import"../../../chunks/Lifecycle.js";import"../../../chunks/metadata.js";import"../../../chunks/utils.js";import"../../../chunks/handleUtils.js";import"../../../chunks/tracking.js";import"../../../chunks/ensureType.js";import"../../../chunks/MapUtils.js";import"../../../chunks/object.js";import"../../../chunks/Warning.js";import"../../../chunks/get.js";import"../../../chunks/ObjectPool.js";import"../../../chunks/ObservableBase.js";import"../../../core/accessorSupport/decorators/property.js";import"../../../config.js";import"../../../chunks/string.js";import"../../../chunks/watch.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../chunks/PooledArray.js";import"../../../core/promiseUtils.js";import"../../../chunks/events.js";import"../../../chunks/SetUtils.js";import"../../../chunks/SimpleTrackingTarget.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../chunks/reader.js";import"../../../chunks/writer.js";import"../../../geometry/Geometry.js";import"../../../core/JSONSupport.js";import"../../../geometry/SpatialReference.js";import"../../../chunks/unitUtils.js";import"../../../chunks/jsonMap.js";import"../../../chunks/pe.js";import"../../../chunks/assets.js";import"../../../request.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../chunks/jsonUtils.js";import"../../../chunks/persistableUrlUtils.js";import"../../../geometry/support/webMercatorUtils.js";import"../../../core/Clonable.js";import"../../../chunks/languageUtils.js";import"../../../chunks/TimeOnly.js";import"../../../chunks/enum.js";import"../../../chunks/UnknownTimeZone.js";import"../../../chunks/datetime.js";import"../../../chunks/locale.js";import"../../../geometry/Extent.js";import"../../../chunks/ImmutableArray.js";import"../../../chunks/shared2.js";import"../../support/Field.js";import"../../../chunks/enumeration.js";import"../../../chunks/domains.js";import"../../support/CodedValueDomain.js";import"../../support/Domain.js";import"../../support/InheritedDomain.js";import"../../support/RangeDomain.js";import"../../../chunks/fieldType.js";import"../../../chunks/number2.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polyline.js";import"../../../chunks/extentUtils.js";import"../../../chunks/boundsUtils.js";import"../../../chunks/aaBoundingRect.js";import"../../../chunks/coordsUtils.js";import"../../../geometry/support/jsonUtils.js";import"../../../chunks/guards.js";import"../../../chunks/vector.js";import"../../../chunks/mat3f64.js";import"../../../chunks/mat4f64.js";import"../../../chunks/quatf64.js";import"../../../chunks/vec2f64.js";import"../../../chunks/vec4f64.js";import"../../../chunks/mathUtils2.js";import"../../../chunks/mat3.js";import"../../../chunks/mat4.js";import"../../../chunks/projectionUtils.js";import"../../../chunks/SimpleObservable.js";import"../../../chunks/projectBuffer.js";import"../../../chunks/geodesicConstants.js";import"../../../chunks/projectXYZToVector.js";import"../../../geometry/support/GeographicTransformation.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../chunks/zscale.js";import"../../../chunks/vec32.js";import"../../../chunks/colorUtils.js";import"../../../geometry/operators/projectOperator.js";import"../../../chunks/SimpleGeometryCursor.js";import"../../ElevationLayer.js";import"../../../chunks/MultiOriginJSONSupport.js";import"../../../geometry/HeightModelInfo.js";import"../../Layer.js";import"../../../core/Evented.js";import"../../../core/Identifiable.js";import"../../../core/Loadable.js";import"../../../core/Promise.js";import"../../../time/TimeExtent.js";import"../../../chunks/timeUtils.js";import"../../../chunks/date.js";import"../../../chunks/constants.js";import"../../mixins/ArcGISCachedService.js";import"../../support/TileInfo.js";import"../../support/LOD.js";import"../../../chunks/TileKey.js";import"../../../chunks/TileInfoTilemapCache.js";import"../../../chunks/TilemapCache.js";import"../../../chunks/LRUCache.js";import"../../../chunks/MemCache.js";import"../../../core/reactiveUtils.js";import"../../../chunks/memoryEstimations.js";import"../../../chunks/ArcGISService.js";import"../../mixins/OperationalLayer.js";import"../../../chunks/layerContainerType.js";import"../../../chunks/commonProperties.js";import"../../../symbols/support/ElevationInfo.js";import"../../../symbols/support/FeatureExpressionInfo.js";import"../../support/fieldUtils.js";import"../../../core/sql.js";import"../../../chunks/unitConversionUtils.js";import"../../../chunks/lengthUtils.js";import"../../../tables/AttributeTableTemplate.js";import"../../../tables/elements/AttributeTableGroupElement.js";import"../../../tables/elements/AttributeTableAttachmentElement.js";import"../../../tables/elements/AttributeTableElement.js";import"../../../tables/elements/AttributeTableFieldElement.js";import"../../../tables/elements/AttributeTableRelationshipElement.js";import"../../../chunks/opacityUtils.js";import"../../mixins/PortalLayer.js";import"../../../chunks/asyncUtils.js";import"../../../chunks/layerUtils.js";import"../../../core/Collection.js";import"../../../chunks/shared.js";import"../../catalog/catalogUtils.js";import"../../../portal/Portal.js";import"../../../portal/PortalGroup.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../portal/PortalItem.js";import"../../../portal/PortalItemResource.js";import"../../../portal/PortalRating.js";import"../../../chunks/portalItemUtils.js";import"../../../chunks/LercDecoder.js";import"../../../chunks/WorkerHandle.js";import"../../../core/workers/workers.js";import"../../../core/workers/Connection.js";import"../../../chunks/Queue.js";import"../../../core/workers/RemoteClient.js";import"../../../intl.js";import"../../../chunks/number.js";import"../../../chunks/substitute.js";import"../../../chunks/messages.js";import"../../ImageryLayer.js";import"../../../PopupTemplate.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/support/AttachmentsOrderByInfo.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../Color.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/content/UtilityNetworkAssociationsContent.js";import"../../../popup/support/UtilityNetworkAssociationType.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../mixins/ArcGISImageService.js";import"../../../Graphic.js";import"../../../chunks/typeUtils.js";import"../../../chunks/createFeatureId.js";import"../../../chunks/typeUtils2.js";import"../../../symbols/CIMSymbol.js";import"../../../symbols/Symbol.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils3.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/screenUtils.js";import"../../../chunks/materialUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils4.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../chunks/aaBoundingBox.js";import"../../../chunks/DoubleArray.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/Font.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/SimpleLineSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/SimpleFillSymbol.js";import"../../../symbols/SimpleMarkerSymbol.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../support/DimensionalDefinition.js";import"../../support/RasterFunction.js";import"../../../chunks/rasterEnums.js";import"../../../chunks/pixelRangeUtils.js";import"../../../chunks/colorRampUtils.js";import"../../../chunks/colorUtils2.js";import"../../../chunks/vec4.js";import"../../../chunks/stretchRendererUtils.js";import"../../../renderers/visualVariables/SizeVariable.js";import"../../../renderers/visualVariables/VisualVariable.js";import"../../../renderers/visualVariables/support/SizeStop.js";import"../../../chunks/visualVariableUtils.js";import"../../support/MosaicRule.js";import"../../support/FieldsIndex.js";import"../../../chunks/timeZoneUtils.js";import"../../../chunks/imageBitmapUtils.js";import"../../support/MultidimensionalSubset.js";import"../../support/PixelBlock.js";import"../../../chunks/rasterFieldUtils.js";import"../../support/RasterInfo.js";import"../../support/RasterBandInfo.js";import"../../support/RasterSensorInfo.js";import"../../../chunks/multidimensionalUtils.js";import"../../../chunks/RasterSymbolizer.js";import"../../../chunks/_commonjsHelpers.js";import"../../../chunks/vectorFieldUtils.js";import"../../../chunks/rasterRendererChecks.js";import"../../../chunks/rasterRendererHelper.js";import"../../../chunks/datasetUtils.js";import"../../../renderers/ClassBreaksRenderer.js";import"../../../renderers/Renderer.js";import"../../../renderers/support/AuthoringInfo.js";import"../../../renderers/support/AuthoringInfoVisualVariable.js";import"../../../chunks/colorRamps.js";import"../../../rest/support/AlgorithmicColorRamp.js";import"../../../rest/support/ColorRamp.js";import"../../../rest/support/MultipartColorRamp.js";import"../../../renderers/mixins/VisualVariablesMixin.js";import"../../../renderers/visualVariables/ColorVariable.js";import"../../../renderers/visualVariables/support/ColorStop.js";import"../../../renderers/visualVariables/OpacityVariable.js";import"../../../renderers/visualVariables/support/OpacityStop.js";import"../../../renderers/visualVariables/RotationVariable.js";import"../../../renderers/support/ClassBreakInfo.js";import"../../../chunks/commonProperties2.js";import"../../../symbols/support/jsonUtils.js";import"../../../chunks/defaults.js";import"../../../chunks/defaultsJSON.js";import"../../../chunks/RendererLegendOptions.js";import"../../../renderers/FlowRenderer.js";import"../../../renderers/RasterColormapRenderer.js";import"../../../renderers/support/ColormapInfo.js";import"../../../renderers/RasterShadedReliefRenderer.js";import"../../../renderers/RasterStretchRenderer.js";import"../../../renderers/UniqueValueRenderer.js";import"../../../chunks/diffUtils.js";import"../../../renderers/support/UniqueValue.js";import"../../../renderers/support/UniqueValueClass.js";import"../../../renderers/support/UniqueValueGroup.js";import"../../../renderers/support/UniqueValueInfo.js";import"../../../chunks/styleUtils.js";import"../../../renderers/VectorFieldRenderer.js";import"../../../geometry/support/normalizeUtils.js";import"../../../chunks/normalizeUtilsCommon.js";import"../../../chunks/simplify.js";import"../../../chunks/utils9.js";import"../../../chunks/utils10.js";import"../../../chunks/utils8.js";import"../../../chunks/jsonUtils2.js";import"../../../chunks/parser.js";import"../../../chunks/utils5.js";import"../../../symbols/support/cimSymbolUtils.js";import"../../../chunks/utils6.js";import"../../../chunks/defaultCIMValues.js";import"../../../chunks/gfxUtils.js";import"../../../chunks/generateRendererUtils.js";import"../../../chunks/rasterTypeUtils.js";import"../../../rest/imageService.js";import"../../../rest/support/FindImagesParameters.js";import"../../../rest/support/FindImagesResult.js";import"../../../rest/support/ImageInspectionInfo.js";import"../../../rest/support/CameraInfoMixin.js";import"../../../rest/support/ImageAngleParameters.js";import"../../../rest/support/ImageAngleResult.js";import"../../../rest/support/ImageAreaParameters.js";import"../../../rest/support/BaseImageMeasureParameters.js";import"../../../chunks/imageMeasureUtils.js";import"../../../rest/support/ImageAreaResult.js";import"../../../rest/support/BaseImageMeasureResult.js";import"../../../rest/support/ImageBoundaryParameters.js";import"../../../rest/support/ImageBoundaryResult.js";import"../../../rest/support/ImageDistanceParameters.js";import"../../../rest/support/ImageDistanceResult.js";import"../../../rest/support/ImageGPSInfoParameters.js";import"../../../chunks/spatialRelationships.js";import"../../../rest/support/ImageGPSInfoResult.js";import"../../../rest/support/CameraInfo.js";import"../../../rest/support/ImageGPSInfo.js";import"../../../rest/support/ImageHeightParameters.js";import"../../../rest/support/ImageHeightResult.js";import"../../../rest/support/ImageHistogramParameters.js";import"../../../rest/support/ImageIdentifyParameters.js";import"../../../rest/support/ImageIdentifyResult.js";import"../../../rest/support/FeatureSet.js";import"../../../rest/support/ImagePixelLocationParameters.js";import"../../../rest/support/ImagePixelLocationResult.js";import"../../../rest/support/ImagePointParameters.js";import"../../../rest/support/ImagePointResult.js";import"../../../rest/support/ImageSampleParameters.js";import"../../../rest/support/ImageSampleResult.js";import"../../../rest/support/ImageSample.js";import"../../../rest/support/ImageToMapMultirayParameters.js";import"../../../rest/support/ImageToMapParameters.js";import"../../../rest/support/ImageUrlParameters.js";import"../../../rest/support/ImageUrlResult.js";import"../../../rest/support/ImageVolumeParameters.js";import"../../../rest/support/ImageVolumeResult.js";import"../../../rest/support/ImageVolume.js";import"../../../rest/support/MapToImageParameters.js";import"../../../rest/support/MeasureAreaFromImageResult.js";import"../../../rest/support/MeasureFromImageParameters.js";import"../../../rest/support/MeasureLengthFromImageResult.js";import"../../../chunks/fetchRasterInfo.js";import"../../../chunks/executeForIds.js";import"../../../chunks/query.js";import"../../../chunks/pbfQueryUtils.js";import"../../../chunks/pbf.js";import"../../../chunks/OptimizedGeometry.js";import"../../../chunks/OptimizedFeature.js";import"../../../chunks/OptimizedFeatureSet.js";import"../../../chunks/queryZScale.js";import"../../../rest/support/Query.js";import"../../../chunks/DataLayerSource.js";import"../../../chunks/FullTextSearch.js";import"../../../rest/support/StatisticDefinition.js";import"../../../chunks/executeQueryJSON.js";import"../../mixins/BlendLayer.js";import"../../mixins/CustomParametersMixin.js";import"../../../chunks/RasterJobHandlerMixin.js";import"../../../chunks/dataUtils.js";import"../../mixins/RasterPresetRendererMixin.js";import"../../../renderers/support/RasterPresetRenderer.js";import"../../mixins/RefreshableLayer.js";import"../../mixins/ScaleRangeLayer.js";import"../../mixins/TemporalLayer.js";import"../../support/TimeInfo.js";import"../../../time/TimeInterval.js";import"../../../chunks/versionUtils.js";import"../../../chunks/elevationInfoUtils.js";import"../../../support/popupUtils.js";import"../../ImageryTileLayer.js";import"../../mixins/ImageryTileMixin.js";import"../../../chunks/QueueProcessor.js";import"../../../chunks/ReactiveMap.js";import"../../../chunks/signal.js";import"../../../chunks/RawBlockCache.js";import"../../../chunks/rasterProjectionHelper.js";import"../../../chunks/clipUtils.js";import"../../../chunks/rasterFunctionHelper.js";import"../../support/rasterFunctionConstants.js";import"../../../chunks/focalStatUtils.js";import"../../../chunks/xmlUtilities.js";import"../../../chunks/GCSShiftTransform.js";import"../../support/ElevationSampler.js";import"../../../chunks/ElevationTile.js";import"../../../chunks/ElevationSamplerData.js";import"../../../chunks/requestPresets.js";async function B(s,t,r){const e=Array.isArray(s)?s:[s];let o;if(j(t))o=await h(e,t.elevationSample,r);else if(k(t)){const{elevationSource:s,extent:i}=t,{url:p,lod:m,rasterFunction:n}=s;o=await y(e,{url:p,lod:m,rasterFunction:n,extent:i},r)}else o="averageGroundElevation"in t?d(e,t):await f(e,t.elevationSource.constantElevation,r);return Array.isArray(s)?o:o[0]}async function G(s,t,e,o=H){const{cameraLocation:i,farPlaneVertices:m}=e,n=b(i),a=new Array;await Z(m,e,a);let l=c(a[0],a[1],a[2]),j=s.clone();for(let m=0;m<o;m++){const o=r();if(!u(l,n,b(s),o))break;let m=0,h=null;if(({error:m,imagePoint:h,pointWithZ:j}=await Q(t,new p(o,i.spatialReference),e)),m<=1)break;const[k,y]=W(i.spatialReference,a);if(g(k<=1,y<=1))break;a.splice(0,a.length,...await K(k,y,new p(o,i.spatialReference),e)),l=c(a[0],a[1],a[2])}return b(j)}async function q(s,t,e,o=H){const{cameraLocation:i,farPlaneVertices:m}=e,n=b(i),a=new Array;await Z(m,e,a);const c=[0,0,0,0];let j=l(c,a.flat(),!1),h=s.clone();for(let m=0;m<o;m++){const o=r();if(!u(c,n,b(s),o)||!j)break;let m,k=0;if(({error:k,imagePoint:m,pointWithZ:h}=await N(t,new p(o,i.spatialReference),e)),k<=1)break;const[y,d]=W(i.spatialReference,a);if(g(y<=1,d<=1))break;a.splice(0,a.length,...await K(y,d,new p(o,i.spatialReference),e)),j=l(c,a.flat(),!1)}return b(h)}const H=10,z=10;function W(s,t){const r=new a({spatialReference:s});return r.addRing(t),[r.extent?.width?r.extent.width/z:1,r.extent?.height?r.extent.height/z:1]}async function Z(s,t,r){const e=n(s),o=await B(e,t);r.push(...o.map(b))}async function Q(s,t,r){const e=await B(t,r),o=R(e,r);return{error:J(o,s),imagePoint:o,pointWithZ:e}}async function N(s,t,r){const e=await B(t,r),o=I(e,r),i=S(o.heading+r.cameraHeading);return{error:Math.abs(i-s.heading)+Math.abs(o.pitch-s.pitch),imagePoint:o,pointWithZ:e}}const J=(s,t)=>Math.abs(s.x-t.x)+Math.abs(s.y-t.y);async function K(s,t,r,e){return B([[-s,-t],[s,-t],[s,t],[-s,t]].map(([s,t])=>new p([r.x+s,r.y+t],r.spatialReference)),e).then(s=>s.map(s=>s.toArray()))}async function X(s,t,r){const{verticalFieldOfView:e,imageBoundaries:o,scalingFactor:i,farPlaneVertices:p,cameraLocation:m,pixelsToTransform:n,vecToPoint:a}=ts(s,t),l=new Array;return await async function(s,t,r,e,o,i,p,m,n,a){let l=o.averageElevation;for(const u of s){const s=_(t,r,u,e,o);a&&g(M(a.elevationSample),k(a))&&(l=(await G(e(s),{x:u[0],y:u[1]},{...o,...a,farPlaneVertices:t.map(e)}))[2]),i.push(e(Y(s,p,m,l,o.cameraPitch,n)))}}(n,p,o,a,t,l,m,i,e,r),Array.isArray(s)?l:l[0]}function Y(s,t,r,p,m,n){let a=e(s);const l=Math.sqrt((s[2]-t[2])**2+(Math.sqrt((s[0]-t[0])**2+(s[1]-t[1])**2)/r)**2)*r,u=V(i(o(),s,t),1/l,1/r);if(function(s,t,r,e){return s<t||r+e/2<E}(s[2],p,m,n)){const s=Math.abs((t[2]-p)/-u[2])*r;a=F(t,u,s,r)}else a[2]=p;return a}function _(s,t,r,e,o){let i,p=null,m=0,n=s,a=t;for(;m<=9;){const s=ss(r,a,n,o);if(i=s.error,p=s.transformedPoint,g(i<=1,9===m))break;n=D(n,i,r,t),a=$(n,e,o),m++}return p}function $(s,t,r){return R(s.map(t),r).map(({x:s,y:t})=>[s,t,1])}function ss(s,t,r,e){const{cameraLocation:o}=e,i=O(s,t,r),{x:m,y:n}=R(new p(i,o.spatialReference),e);var a,l;return{transformedPoint:i,error:(a=s,l=[m,n,1],Math.abs(a[0]-l[0])+Math.abs(a[1]-l[1]))}}function ts(t,r){const e=s(t)||"items"in t?t:[t],{cameraLocation:o,rotationMatrix:i}=r;if(C(e,o),w(i),9!==i?.length)throw new Error("Rotation matrix is not provided or is not a valid 3x3 matrix");const m=U(o.y,o.spatialReference),n=T({...r,scalingFactor:m}),a=R(n.map(s=>new p(s,o.spatialReference)),r),{vfov:l}=L(r.horizontalFieldOfView,r.verticalFieldOfView,r.cameraRoll);return{cameraLocation:o.toArray(),imageBoundaries:a.map(({x:s,y:t})=>[s,t,1]),verticalFieldOfView:l,farPlaneVertices:n,scalingFactor:m,pixelsToTransform:e.map(s=>[s.x,s.y,1]),vecToPoint:A(o.spatialReference)}}async function rs(s,r,e){const{cameraHeading:o,cameraLocation:i,farDistance:n,imageHeight:a,imageWidth:l,verticalFieldOfView:u}=r,c=U(i.y,i.spatialReference),j=n*c,h=new Array,[k,y,d]=i.toArray(),f=Array.isArray(s)?s:[s];for(const s of f){let f,b;if(P(s))f=s.heading,b=s.pitch;else{const t=x({x:s.x,y:s.y},l,a);f=t.heading,b=t.pitch}f=(f+o)%360;const g=[k+Math.sin(t(f))*Math.sin(t(b))*j,y+Math.cos(t(f))*Math.sin(t(b))*j,d+-Math.cos(t(b))*n];let I=r.averageElevation;e&&(m(e)||M(e.elevationSample))&&(I=(await q(new p(g,i.spatialReference),{heading:f,pitch:b},{...r,...e,farPlaneVertices:v(n,n).map(([s,t])=>new p([i.x+s,i.y+t],i.spatialReference))}))[2]),h.push(new p(Y(g,i.toArray(),c,I,b,u),i.spatialReference))}return Array.isArray(s)?h:h[0]}export{X as imageToWorld,rs as imageToWorldPanoramic,B as u};
