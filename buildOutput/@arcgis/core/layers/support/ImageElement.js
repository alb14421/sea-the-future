/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../request.js";import s from"../../core/Error.js";import{g as o}from"../../chunks/imageUtils.js";import{isAbsolute as r,isDataProtocol as i,isBlobProtocol as n,dataToBlob as m,join as c}from"../../core/urlUtils.js";import{g as p}from"../../chunks/uuid.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/Logger.js";import{r as u}from"../../chunks/reader.js";import{subclass as l}from"../../core/accessorSupport/decorators/subclass.js";import{w as h}from"../../chunks/writer.js";import j,{m as g,a as d}from"./MediaElementBase.js";import{g as k}from"../../chunks/resourceExtension.js";import{I as f}from"../../chunks/mediaLayerUtils2.js";import{f as y,a as v,i as b}from"../../chunks/persistableUrlUtils.js";import"../../config.js";import"../../chunks/object.js";import"../../kernel.js";import"../../chunks/MapUtils.js";import"../../core/promiseUtils.js";import"../../chunks/handleUtils.js";import"../../chunks/events.js";import"../../chunks/maybe.js";import"../../chunks/jsonUtils.js";import"../../chunks/ensureType.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/metadata.js";import"../../chunks/string.js";import"../../chunks/Lifecycle.js";import"../../chunks/tracking.js";import"../../chunks/Warning.js";import"../../core/Identifiable.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../core/JSONSupport.js";import"./ControlPointsGeoreference.js";import"../../core/Clonable.js";import"../../chunks/perspectiveUtils.js";import"../../chunks/mat3.js";import"../../chunks/mat3f64.js";import"../../chunks/vec2.js";import"../../chunks/common.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/screenUtils.js";import"../../chunks/vec2f64.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Polygon.js";import"../../geometry/Extent.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/zmUtils.js";import"../../chunks/projectionUtils.js";import"../../chunks/SimpleObservable.js";import"../../geometry/Multipoint.js";import"../../geometry/Polyline.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/GeoreferenceBase.js";import"./CornersGeoreference.js";import"./ExtentAndRotationGeoreference.js";var U;let I=class extends j{static{U=f}constructor(t){super(t),this.animationOptions=null,this.content=null,this.image=null,this.type="image",this[U]=!0,this.image=null}load(){const t=this.image;if("string"==typeof t){const e=o(t).then(t=>{this._set("content",t)});this.addResolvingPromise(e)}else if(t instanceof HTMLImageElement){const e=t.decode().then(()=>{this._set("content",t)});this.addResolvingPromise(e)}else t?this._set("content",t):this.addResolvingPromise(Promise.reject(new s("image-element:invalid-image-type","Invalid image type",{image:t})));return Promise.resolve(this)}get contentWidth(){return null==this.content?0:this.content instanceof HTMLImageElement?this.content.naturalWidth:this.content.width}get contentHeight(){return null==this.content?0:this.content instanceof HTMLImageElement?this.content.naturalHeight:this.content.height}readImage(t,e,s){return y(e.url,s)}writeImage(t,s,o,a){if(null==t)return;const u=a?.portalItem,l=a?.resources;if(!u||!l)return void("string"==typeof t&&(s[o]=v(t,a)));const h=function(t){return"string"==typeof t&&!i(t)&&!n(t)}(t)?t:null;if(h){if(null==b(h))return void(s[o]=h);const t=v(h,{...a,verifyItemRelativeUrls:a?.verifyItemRelativeUrls?{writtenUrls:a.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},1);if(u&&t&&!r(t))return l.toKeep.push({resource:u.resourceFromPath(t),compress:!1}),void(s[o]=t)}s[o]="<pending>",l.pendingOperations.push(async function(t){return"string"==typeof t?i(t)?m(t):(await e(t,{responseType:"blob"})).data:new Promise(e=>function(t){if(t instanceof HTMLCanvasElement)return t;const e=t instanceof HTMLImageElement?t.naturalWidth:t.width,s=t instanceof HTMLImageElement?t.naturalHeight:t.height,o=document.createElement("canvas"),r=o.getContext("2d");return o.width=e,o.height=s,t instanceof HTMLImageElement?r.drawImage(t,0,0,t.width,t.height):t instanceof ImageData&&r.putImageData(t,0,0),o}(t).toBlob(e))}(t).then(t=>{const e=function(t,e){const s=p(),o=`${c("media",s)}.${k({type:"blob",blob:t})}`;return e.resourceFromPath(o)}(t,u);s[o]=e.itemRelativeUrl,l.toAdd.push({resource:e,content:{type:"blob",blob:t},compress:!1,finish:t=>{this.image=t.url}})}))}};t([a()],I.prototype,"animationOptions",void 0),t([a({readOnly:!0})],I.prototype,"content",void 0),t([a({readOnly:!0})],I.prototype,"contentWidth",null),t([a({readOnly:!0})],I.prototype,"contentHeight",null),t([a(g)],I.prototype,"image",void 0),t([u("image",["url"])],I.prototype,"readImage",null),t([h("image")],I.prototype,"writeImage",null),t([a(d)],I.prototype,"type",void 0),I=t([l("esri.layers.support.ImageElement")],I);export{I as default};
