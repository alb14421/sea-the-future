/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../request.js";import s from"../../core/Error.js";import{L as o}from"../../chunks/Logger.js";import{c as r}from"../../chunks/mathUtils.js";import{r as i}from"../../chunks/sanitizerUtils.js";import{makeAbsolute as n,isAbsolute as c,getProxyRule as p,addProxy as m,isBlobProtocol as a,isDataProtocol as u}from"../../core/urlUtils.js";import{property as l}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import{subclass as h}from"../../core/accessorSupport/decorators/subclass.js";import{w as d}from"../../chunks/writer.js";import j,{m as k,a as y}from"./MediaElementBase.js";import{w as g}from"../../chunks/videoUtils.js";import{V as v}from"../../chunks/mediaLayerUtils2.js";import{i as f}from"../../chunks/persistableUrlUtils.js";import"../../config.js";import"../../chunks/object.js";import"../../kernel.js";import"../../chunks/MapUtils.js";import"../../core/promiseUtils.js";import"../../chunks/handleUtils.js";import"../../chunks/events.js";import"../../chunks/maybe.js";import"../../chunks/string.js";import"../../chunks/jsonUtils.js";import"../../chunks/ensureType.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/metadata.js";import"../../chunks/Lifecycle.js";import"../../chunks/tracking.js";import"../../chunks/Warning.js";import"../../core/Identifiable.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../core/JSONSupport.js";import"../../chunks/reader.js";import"./ControlPointsGeoreference.js";import"../../core/Clonable.js";import"../../chunks/perspectiveUtils.js";import"../../chunks/mat3.js";import"../../chunks/mat3f64.js";import"../../chunks/vec2.js";import"../../chunks/common.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/screenUtils.js";import"../../chunks/vec2f64.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Polygon.js";import"../../geometry/Extent.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/zmUtils.js";import"../../chunks/projectionUtils.js";import"../../chunks/SimpleObservable.js";import"../../geometry/Multipoint.js";import"../../geometry/Polyline.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/GeoreferenceBase.js";import"./CornersGeoreference.js";import"./ExtentAndRotationGeoreference.js";var U;const b=Symbol("canplay");let S=class extends j{static{U=v}constructor(t){super(t),this.autoplay=!0,this.content=null,this.type="video",this[U]=!0}load(){const t=this.video;return"string"==typeof t?this.addResolvingPromise(this._preProcessVideoUrl(t).then(async t=>{const e=document.createElement("video");return e.src=i.sanitizeUrl(n(t)),e.crossOrigin="anonymous",e.autoplay=this.autoplay,e.muted=!0,e.loop=!0,e.playsInline=!0,this._loadVideo(e).then(()=>{this._set("content",e)})})):t instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(t).then(()=>{this._set("content",t)})):this.addResolvingPromise(Promise.reject(new s("video-element:invalid-video-type","Invalid video type",{video:t}))),Promise.resolve(this)}get contentWidth(){return this.content?.videoWidth??0}get contentHeight(){return this.content?.videoHeight??0}get currentTime(){return this.content?.currentTime}set currentTime(t){if(!this.content)return;const e=r(t,0,this.content.duration);"fastSeek"in this.content?this.content.fastSeek(e):this.content.currentTime=e,this.content.play().then(()=>{this.content?.pause()}).catch(()=>{})}get duration(){return this.content?.duration}set video(t){"not-loaded"===this.loadStatus?this._set("video",t):o.getLogger(this).error("#video","video cannot be changed after the element is loaded.")}writeVideo(t,e,o,r){if(!t)return void(r?.messages&&r.messages.push(new s("video-element:unsupported-video","video source is missing")));const i=function(t){return"string"==typeof t&&!u(t)&&!a(t)}(t)?t:null;if(!i)return void(r?.messages&&r.messages.push(new s("video-element:unsupported-video","video source must be an absolute url")));!c(i)&&r?.blockedRelativeUrls&&r.blockedRelativeUrls.push(i);const p=n(i);f(p)?r?.messages&&r.messages.push(new s("video-element:unsupported-video","video source cannot be an item resource")):e[o]=p}async _preProcessVideoUrl(t){if(p(t))return m(t);try{return await e(t,{method:"head"}),t}catch{try{return m(t,!0)}catch{return t}}}async _loadVideo(t){"anonymous"!==t.crossOrigin&&(t.crossOrigin="anonymous",a(t.src)||(t.src=t.src));try{await g(t,t=>this.addHandles(t,b)),this.autoplay&&await t.play().catch(t=>{throw console.error(t),t})}finally{this.removeHandles(b)}}};t([l()],S.prototype,"autoplay",void 0),t([l({readOnly:!0})],S.prototype,"content",void 0),t([l({readOnly:!0})],S.prototype,"contentWidth",null),t([l({readOnly:!0})],S.prototype,"contentHeight",null),t([l({type:Number})],S.prototype,"currentTime",null),t([l({type:Number})],S.prototype,"duration",null),t([l(k)],S.prototype,"video",null),t([d("video")],S.prototype,"writeVideo",null),t([l(y)],S.prototype,"type",void 0),S=t([h("esri.layers.support.VideoElement")],S);export{S as default};
