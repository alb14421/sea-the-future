/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import e from"../config.js";import r from"../Graphic.js";import s from"../PopupTemplate.js";import o,{k as i}from"../request.js";import n from"../core/Collection.js";import{C as a}from"../chunks/CollectionFlattener.js";import l from"../core/Error.js";import{J as p}from"../chunks/jsonMap.js";import{i as m,clone as u}from"../core/lang.js";import{M as c}from"../chunks/MultiOriginJSONSupport.js";import{throwIfAbortError as y}from"../core/promiseUtils.js";import{on as f,watch as d,sync as h}from"../core/reactiveUtils.js";import{r as j}from"../chunks/sanitizerUtils.js";import{urlToObject as b,addQueryParameters as g,addProxy as x,makeAbsolute as S,Url as k}from"../core/urlUtils.js";import{property as I}from"../core/accessorSupport/decorators/property.js";import{I as w}from"../chunks/ensureType.js";import{r as v}from"../chunks/reader.js";import{subclass as F}from"../core/accessorSupport/decorators/subclass.js";import{w as E}from"../chunks/writer.js";import{w as U}from"../core/JSONSupport.js";import L from"../geometry/Extent.js";import N from"../geometry/SpatialReference.js";import{g as M}from"../chunks/scaleUtils.js";import{p as C}from"../chunks/unitUtils.js";import A from"./Layer.js";import{BlendLayer as P}from"./mixins/BlendLayer.js";import{OperationalLayer as R}from"./mixins/OperationalLayer.js";import{PortalLayer as T}from"./mixins/PortalLayer.js";import{RefreshableLayer as O}from"./mixins/RefreshableLayer.js";import{ScaleRangeLayer as D}from"./mixins/ScaleRangeLayer.js";import{TemporalLayer as _}from"./mixins/TemporalLayer.js";import{i as B}from"../chunks/crsUtils.js";import{a as V,u as W}from"../chunks/commonProperties.js";import{E as q}from"../chunks/ExportWMSImageParameters.js";import{a as $}from"../chunks/imageBitmapUtils.js";import G from"./support/WMSSublayer.js";import{D as X,F as H}from"../chunks/datetime.js";import"../chunks/object.js";import"../core/Clonable.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/Logger.js";import"../chunks/string.js";import"../chunks/maybe.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../chunks/SetUtils.js";import"../chunks/SimpleTrackingTarget.js";import"../chunks/MapUtils.js";import"../chunks/events.js";import"../chunks/Warning.js";import"../chunks/jsonUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry/Geometry.js";import"../chunks/pe.js";import"../chunks/assets.js";import"../kernel.js";import"../chunks/persistableUrlUtils.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../chunks/createFeatureId.js";import"../chunks/typeUtils2.js";import"../symbols/CIMSymbol.js";import"../chunks/enumeration.js";import"./support/fieldUtils.js";import"../core/sql.js";import"../chunks/guards.js";import"../symbols/Symbol.js";import"../Color.js";import"../chunks/colorUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../chunks/locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils3.js";import"../symbols/edges/Edges3D.js";import"../chunks/screenUtils.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils4.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/vec3f64.js";import"../chunks/aaBoundingBox.js";import"../chunks/DoubleArray.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../chunks/lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../core/Evented.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/constants.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../time/TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/layerContainerType.js";import"../chunks/jsonUtils2.js";import"../chunks/parser.js";import"../chunks/utils5.js";import"../chunks/mat4.js";import"../chunks/common.js";import"../symbols/support/ElevationInfo.js";import"../symbols/support/FeatureExpressionInfo.js";import"../chunks/unitConversionUtils.js";import"../chunks/lengthUtils.js";import"../tables/AttributeTableTemplate.js";import"../tables/elements/AttributeTableGroupElement.js";import"../tables/elements/AttributeTableAttachmentElement.js";import"../tables/elements/AttributeTableElement.js";import"../tables/elements/AttributeTableFieldElement.js";import"../tables/elements/AttributeTableRelationshipElement.js";import"../chunks/asyncUtils.js";import"../chunks/layerUtils.js";import"./catalog/catalogUtils.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../chunks/projectionUtils.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../chunks/projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"./support/TimeInfo.js";import"../time/TimeInterval.js";import"../chunks/timeZoneUtils.js";const z={84:4326,83:4269,27:4267};function J(t){if(!t)return null;const e={idCounter:-1};"string"==typeof t&&(t=(new DOMParser).parseFromString(t,"text/xml"));const r=t.documentElement;if("ServiceExceptionReport"===r.nodeName){const t=Array.prototype.slice.call(r.childNodes).map(t=>t.textContent).join("\r\n");throw new l("wmslayer:wms-capabilities-xml-is-not-valid","The server returned errors when the WMS capabilities were requested.",t)}const s=K("Capability",r),o=K("Service",r),i=s&&K("Request",s);if(!s||!o||!i)return null;const n=K("Layer",s);if(!n)return null;const a="WMS_Capabilities"===r.nodeName||"WMT_MS_Capabilities"===r.nodeName?r.getAttribute("version"):"1.3.0",p=et("Title",o,"")||et("Name",o,""),u=et("AccessConstraints",o,""),c=/^none$/i.test(u)?"":u,y=et("Abstract",o,""),f=parseInt(et("MaxWidth",o,"5000"),10),d=parseInt(et("MaxHeight",o,"5000"),10),h=ot(i,"GetMap"),j=st(i,"GetMap"),b=nt(n,a,e);if(!b)return null;let g,x=0;const S=Array.prototype.slice.call(s.childNodes),k=b.sublayers??[],I=t=>{null!=t&&k.push(t)};S.forEach(t=>{"Layer"===t.nodeName&&(0===x?g=t:1===x?(b.name&&(b.name="",I(nt(g,a,e))),I(nt(t,a,e))):I(nt(t,a,e)),x++)});const w=b.sublayers??[],v=b.fullExtents??[];0===w.length&&w.push(b),b.extent??=w[0].extent;const F=b.spatialReferences.length>0?b.spatialReferences:Z(b),E=st(i,"GetFeatureInfo"),U=E?ot(i,"GetFeatureInfo"):null,L=Q(w),N=b.minScale||0,M=b.maxScale||0,C=b.dimensions??[],A=L.reduce((t,e)=>t.concat(e.dimensions??[]),[]),P=C.concat(A).filter(lt);let R=null;if(P.length){const t=P.map(t=>{const{extent:e}=t;return r=e,Array.isArray(r)&&r.length>0&&r[0]instanceof Date?e.map(t=>t.getTime()):e?.map(t=>[t.min.getTime(),t.max.getTime()]);var r}).flat(2).filter(m),{start:e,end:r}=t.reduce((t,e)=>({start:Math.min(t.start,e),end:Math.max(t.end,e)}),{start:1/0,end:-1/0});R={startTimeField:null,endTimeField:null,trackIdField:void 0,timeExtent:[e,r]}}return{copyright:c,description:y,dimensions:C,extent:b.extent,fullExtents:v,featureInfoFormats:U,featureInfoUrl:E,mapUrl:j,maxWidth:f,maxHeight:d,maxScale:M,minScale:N,layers:L,spatialReferences:F,supportedImageFormatTypes:h,timeInfo:R,title:p,version:a}}function Z(t){if(t.spatialReferences.length>0)return t.spatialReferences;if(t.sublayers)for(const e of t.sublayers){const t=Z(e);if(t.length>0)return t}return[]}function Q(t){let e=[];for(const r of t)e.push(r),r.sublayers?.length&&(e=e.concat(Q(r.sublayers)),delete r.sublayers);return e}function Y(t,e,r){return e.getAttribute(t)??r}function K(t,e){for(let r=0;r<e.childNodes.length;r++){const s=e.childNodes[r];if(at(s)&&s.nodeName===t)return s}return null}function tt(t,e){if(null==e)return[];const r=[];for(let s=0;s<e.childNodes.length;s++){const o=e.childNodes[s];at(o)&&o.nodeName===t&&r.push(o)}return r}function et(t,e,r){return K(t,e)?.textContent??r}function rt(t,e,r){const s=parseFloat(t.getAttribute("minx")??"0"),o=parseFloat(t.getAttribute("miny")??"0"),i=parseFloat(t.getAttribute("maxx")??"0"),n=parseFloat(t.getAttribute("maxy")??"0");return{xmin:r?isNaN(o)?-Number.MAX_VALUE:o:isNaN(s)?-Number.MAX_VALUE:s,ymin:r?isNaN(s)?-Number.MAX_VALUE:s:isNaN(o)?-Number.MAX_VALUE:o,xmax:r?isNaN(n)?Number.MAX_VALUE:n:isNaN(i)?Number.MAX_VALUE:i,ymax:r?isNaN(i)?Number.MAX_VALUE:i:isNaN(n)?Number.MAX_VALUE:n,spatialReference:{wkid:e}}}function st(t,e){const r=K(e,t);if(r){const t=K("DCPType",r);if(t){const e=K("HTTP",t);if(e){const t=K("Get",e);if(t){let e=function(t,e,r){const s=K("OnlineResource",r);return s?Y("xlink:href",s,null):null}(0,0,t);if(e){const t=e.indexOf("&");return-1!==t&&t===e.length-1&&(e=e.slice(0,-1)),function(t,e){const r=[],s=b(t);for(const t in s.query)s.query.hasOwnProperty(t)&&(e.includes(t.toLowerCase())||r.push(t+"="+s.query[t]));return s.path+(r.length?"?"+r.join("&"):"")}(e,["service","request"])}}}}}return null}function ot(t,e){const r=tt("Operation",t);if(!r.length)return tt("Format",K(e,t)).map(({textContent:t})=>t).filter(m);const s=[];for(const t of r)if(t.getAttribute("name")===e){const e=tt("Format",t);for(const{textContent:t}of e)null!=t&&s.push(t)}return s}function it(t,e,r){const s=K(e,t);if(!s)return r;const{textContent:o}=s;if(null==o||""===o)return r;const i=Number(o);return isNaN(i)?r:i}function nt(t,e,r){if(!t)return null;const s=t.getAttribute("queryable")?.toLowerCase(),o="1"===s||"true"===s,i={id:r.idCounter++,fullExtents:[],parentLayerId:null,queryable:o,spatialReferences:[],sublayers:null},n=K("LatLonBoundingBox",t),a=K("EX_GeographicBoundingBox",t),l=n?rt(n,4326):a?{xmin:parseFloat(et("westBoundLongitude",a,"0")),ymin:parseFloat(et("southBoundLatitude",a,"0")),xmax:parseFloat(et("eastBoundLongitude",a,"0")),ymax:parseFloat(et("northBoundLatitude",a,"0")),spatialReference:{wkid:4326}}:{xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:{wkid:4326}};i.minScale=it(t,"MaxScaleDenominator",0),i.maxScale=it(t,"MinScaleDenominator",0);const p=["1.0.0","1.1.0","1.1.1"].includes(e)?"SRS":"CRS";return Array.prototype.slice.call(t.childNodes).forEach(t=>{if("Name"===t.nodeName)i.name=t.textContent||"";else if("Title"===t.nodeName)i.title=t.textContent||"";else if("Abstract"===t.nodeName)i.description=t.textContent||"";else if("BoundingBox"===t.nodeName){const r=t.getAttribute(p),s=r?.indexOf(":");if(s&&s>-1){let o=parseInt(r.slice(s+1),10);0===o||isNaN(o)||(o=z[o]??o);const n="1.3.0"===e?rt(t,o,B(o)):rt(t,o);n&&i.fullExtents&&i.fullExtents.push(n)}}else if(t.nodeName===p)(t.textContent?.split(" ")??[]).forEach(t=>{let e=NaN;if(t.includes(":")){const[r,s]=t.toUpperCase().split(":");"CRS"!==r&&"EPSG"!==r||(e=parseInt(s,10))}else e=parseInt(t,10);if(0!==e&&!isNaN(e)){const t=z[e]??e;i.spatialReferences.includes(t)||i.spatialReferences.push(t)}});else if("Style"!==t.nodeName||i.legendUrl){if("Layer"===t.nodeName){const s=nt(t,e,r);s&&(s.parentLayerId=i.id,i.sublayers||(i.sublayers=[]),i.sublayers.push(s))}}else{const e=K("LegendURL",t);if(e){const t=K("OnlineResource",e);t&&(i.legendUrl=t.getAttribute("xlink:href"))}}}),i.extent=l,i.dimensions=tt("Dimension",t).filter(t=>t.getAttribute("name")&&t.getAttribute("units")&&t.textContent).map(t=>{const e=t.getAttribute("name"),r=t.getAttribute("units"),s=t.textContent,o=t.getAttribute("unitSymbol")??void 0,i=t.getAttribute("default")??void 0,n="0"!==Y("default",t,"0"),a="0"!==Y("nearestValue",t,"0"),l="0"!==Y("current",t,"0");return lt({name:e,units:r})?{name:"time",units:"ISO8601",extent:ut(s),default:ut(i),multipleValues:n,nearestValue:a,current:l}:/^elevation$/i.test((p={name:e,units:r}).name)&&/^(epsg|crs):\d+$/i.test(p.units)?{name:"elevation",units:r,extent:pt(s),unitSymbol:o,default:pt(i),multipleValues:n,nearestValue:a}:{name:e,units:r,extent:mt(s),unitSymbol:o,default:mt(i),multipleValues:n,nearestValue:a};var p}),i}function at(t){return t.nodeType===Node.ELEMENT_NODE}function lt(t){return/^time$/i.test(t.name)&&/^iso8601$/i.test(t.units)}function pt(t){if(!t)return;const e=t.includes("/"),r=t.split(",");return e?r.map(t=>{const e=t.split("/");return e.length<2?null:{min:parseFloat(e[0]),max:parseFloat(e[1]),resolution:e.length>=3&&"0"!==e[2]?parseFloat(e[2]):void 0}}).filter(m):r.map(t=>parseFloat(t))}function mt(t){if(!t)return;const e=t.includes("/"),r=t.split(",");return e?r.map(t=>{const e=t.split("/");return e.length<2?null:{min:e[0],max:e[1],resolution:e.length>=3&&"0"!==e[2]?e[2]:void 0}}).filter(m):r}function ut(t){if(!t)return;const e=t.includes("/"),r=t.split(",");return e?r.map(t=>{const e=t.split("/");return e.length<2?null:{min:ct(e[0]),max:ct(e[1]),resolution:e.length>=3&&"0"!==e[2]?function(t){const e=t.match(/(?:p(\d+y|\d+(?:\.|,)\d+y)?(\d+m|\d+(?:\.|,)\d+m)?(\d+d|\d+(?:\.|,)\d+d)?)?(?:t(\d+h|\d+(?:\.|,)\d+h)?(\d+m|\d+(?:\.|,)\d+m)?(\d+s|\d+(?:\.|,)\d+s)?)?/i);return e?{years:yt(e[1]),months:yt(e[2]),days:yt(e[3]),hours:yt(e[4]),minutes:yt(e[5]),seconds:yt(e[6])}:null}(e[2]):void 0}}).filter(m):r.map(t=>ct(t))}function ct(t){return X.fromISO(t,{zone:H.utcInstance}).toJSDate()}function yt(t){if(!t)return 0;const e=t.match(/(?:\d+(?:\.|,)\d+|\d+)/);if(!e)return 0;const r=e[0].replace(",",".");return Number(r)}function ft(t){return t.toISOString().replace(/\.[0-9]{3}/,"")}function dt(t){if(!t||t.isAllTime||t.isEmpty)return;const{start:e,end:r}=t;return e&&r&&e.getTime()===r.getTime()?`${ft(e)}`:`${e?ft(e):"0000-01-01T00:00:00Z"}/${r?ft(r):"9999-12-31T23:59:59Z"}`}const ht=new Set([102100,3857,102113,900913]),jt=new Set([3395,54004]),bt=new p({bmp:"image/bmp",gif:"image/gif",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml"},{ignoreUnknown:!1});function gt(t){return"text/html"===t}function xt(t){return"text/plain"===t}let St=class extends(P(_(O(D(R(T(c(A)))))))){constructor(...t){super(...t),this.allSublayers=new a({getCollections:()=>[this.sublayers],getChildrenFunction:t=>t.sublayers}),this.customParameters=null,this.customLayerParameters=null,this.copyright=null,this.description=null,this.dimensions=null,this.fullExtent=null,this.fullExtents=null,this.featureInfoFormats=null,this.featureInfoUrl=null,this.fetchFeatureInfoFunction=null,this.imageFormat=null,this.imageMaxHeight=2048,this.imageMaxWidth=2048,this.imageTransparency=!0,this.legendEnabled=!0,this.mapUrl=null,this.isReference=null,this.operationalLayerType="WMS",this.spatialReference=null,this.spatialReferences=null,this.sublayers=null,this.type="wms",this.version=null,this.addHandles([f(()=>this.sublayers,"after-add",({item:t})=>{t.parent=t.layer=this},h),f(()=>this.sublayers,"after-remove",({item:t})=>{t.layer=t.parent=null},h),d(()=>this.sublayers,(t,e)=>{if(e)for(const t of e)t.layer=t.parent=null;if(t)for(const e of t)e.parent=e.layer=this},h)])}normalizeCtorArgs(t,e){return"string"==typeof t?{url:t,...e}:t}destroy(){this.allSublayers.destroy()}load(t){const e=null!=t?t.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMS"]},t).catch(y).then(()=>this._fetchService(e)).then(()=>this._checkLayerValidity())),Promise.resolve(this)}set timeInfo(t){super.timeInfo=t}readFullExtentFromItemOrMap(t,e){const r=e.extent;return r?new L({xmin:r[0][0],ymin:r[0][1],xmax:r[1][0],ymax:r[1][1]}):null}writeFullExtent(t,e){e.extent=[[t.xmin,t.ymin],[t.xmax,t.ymax]]}get featureInfoFormat(){return null==this.featureInfoFormats?null:this.featureInfoFormats.find(gt)??this.featureInfoFormats.find(xt)??null}set featureInfoFormat(t){null==t?(this.revert("featureInfoFormat","service"),this._clearOverride("featureInfoFormat")):(gt(t)||xt(t))&&this._override("featureInfoFormat",t)}readImageFormat(t,e){const r=e.supportedImageFormatTypes;return r&&r.includes("image/png")?"image/png":r&&r[0]}readSpatialReferenceFromItemOrDocument(t,e){return new N(e.spatialReferences[0])}writeSpatialReferences(t,e){const r=this.spatialReference?.wkid;t&&r?(e.spatialReferences=t.filter(t=>t!==r),e.spatialReferences.unshift(r)):e.spatialReferences=t}readSublayersFromItemOrMap(t,e,r){return kt(e.layers,r,e.visibleLayers)}readSublayers(t,e,r){return kt(e.layers,r)}writeSublayers(t,e,r,s){e.layers=[];const o=new Map,i=t.flatten(({sublayers:t})=>t??[]);for(const t of i)if("number"==typeof t.parent?.id){const e=o.get(t.parent.id);null!=e?e.push(t.id):o.set(t.parent.id,[t.id])}for(const t of i){const r={sublayer:t,...s},i=t.write({parentLayerId:"number"==typeof t.parent?.id?t.parent.id:-1},r);if(o.has(t.id)&&(i.sublayerIds=o.get(t.id)),!t.sublayers&&t.name){const s=t.write({},r);delete s.id,e.layers.push(s)}}e.visibleLayers=i.filter(({visible:t,sublayers:e})=>t&&!e).map(({name:t})=>t).toArray()}set url(t){if(!t)return void this._set("url",t);const{path:e,query:r}=b(t);for(const t in r)/^(request|service)$/i.test(t)&&delete r[t];const s=g(e,r??{});this._set("url",s)}createExportImageParameters(t,e,r,s){const o=s?.pixelRatio??1,i=M({extent:t,width:e})*o,n=new q({layer:this,scale:i}),{xmin:a,ymin:l,xmax:p,ymax:m,spatialReference:u}=t,c=function(t,e){let r=t.wkid;return null==e?r:(null!=r&&e.includes(r)||!t.latestWkid||(r=t.latestWkid),null!=r&&ht.has(r)?e.find(t=>ht.has(t))||e.find(t=>jt.has(t))||102100:r)}(u,this.spatialReferences),y="1.3.0"===this.version&&B(c)?`${l},${a},${m},${p}`:`${a},${l},${p},${m}`,f=n.toJSON(),d="1.3.0"===this.version?"crs":"srs";return{bbox:y,[d]:null==c||isNaN(c)?void 0:"EPSG:"+c,...f}}async fetchImage(t,e,r,s){const i=this.mapUrl,n=this.createExportImageParameters(t,e,r,s);if(!n.layers){const t=document.createElement("canvas");return t.width=e,t.height=r,t}const a=dt(s?.timeExtent),l={responseType:"image",query:this._mixCustomParameters({width:e,height:r,...n,time:a,...this.refreshParameters}),signal:s?.signal};return o(i??"",l).then(t=>t.data)}async fetchImageBitmap(t,e,r,s){const i=this.mapUrl??"",n=this.createExportImageParameters(t,e,r,s);if(!n.layers){const t=document.createElement("canvas");return t.width=e,t.height=r,t}const a=dt(s?.timeExtent),l={responseType:"blob",query:this._mixCustomParameters({width:e,height:r,...n,time:a,...this.refreshParameters}),signal:s?.signal},{data:p}=await o(i,l);return $(p,i,s?.signal)}fetchFeatureInfo(t,e,r,s,o){const i=M({extent:t,width:e}),n=function(t){const e=t.filter(t=>t.popupEnabled&&t.name&&t.queryable);return e.length?e.map(({name:t})=>t).join():null}(new q({layer:this,scale:i}).visibleSublayers);if(null==this.featureInfoUrl||null==n)return Promise.resolve([]);if(null==this.fetchFeatureInfoFunction&&null==this.featureInfoFormat)return Promise.resolve([]);const a="1.3.0"===this.version?{I:s,J:o}:{x:s,y:o},l={query_layers:n,request:"GetFeatureInfo",info_format:this.featureInfoFormat,feature_count:25,width:e,height:r,...a},p={...this.createExportImageParameters(t,e,r),...l},m=this._mixCustomParameters(p);return null!=this.fetchFeatureInfoFunction?this.fetchFeatureInfoFunction(m):this._defaultFetchFeatureInfoFunction(g(this.featureInfoUrl,m))}findSublayerById(t){return this.allSublayers.find(e=>e.id===t)}findSublayerByName(t){return this.allSublayers.find(e=>e.name===t)}serviceSupportsSpatialReference(t){return i(this.url)||null!=this.spatialReferences&&this.spatialReferences.some(e=>{const r=900913===e?N.WebMercator:new N({wkid:e});return C(r,t)})}_defaultFetchFeatureInfoFunction(t){const e=document.createElement("iframe");e.src=x(j.sanitizeUrl(S(t))),e.style.border="none",e.style.margin="0",e.style.width="100%",e.setAttribute("sandbox","");const o=new s({title:this.title,content:e}),i=new r({sourceLayer:this,popupTemplate:o});return Promise.resolve([i])}async _fetchService(t){if(!this.resourceInfo&&this.parsedUrl?.path){const{path:e,query:r}=this.parsedUrl,{data:s}=await o(e,{query:{SERVICE:"WMS",REQUEST:"GetCapabilities",...r,...this.customParameters},responseType:"xml",signal:t});this.resourceInfo=J(s)}if(this.parsedUrl){const t=new k(this.parsedUrl.path),{httpsDomains:r}=e.request;"https"!==t.scheme||t.port&&"443"!==t.port||!t.host||r.includes(t.host)||r.push(t.host)}this.read(this.resourceInfo,{origin:"service"})}_checkLayerValidity(){if(!this.allSublayers.length)throw new l("wmslayer:empty-layer","The layer doesn't have any sublayer")}_mixCustomParameters(t){if(!this.customLayerParameters&&!this.customParameters)return t;const e={...this.customParameters,...this.customLayerParameters};for(const r in e)t[r.toLowerCase()]=e[r];return t}};function kt(t,e,r){t=t??[];const s=new Map;t.every(t=>null==t.id)&&(t=u(t)).forEach((t,e)=>t.id=e);for(const o of t){const t=new G;t.read(o,e),r&&!r.includes(t.name)&&(t.visible=!1),s.set(t.id,t)}const o=[];for(const e of t){const t=null!=e.id?s.get(e.id):null;if(t)if(null!=e.parentLayerId&&e.parentLayerId>=0){const r=s.get(e.parentLayerId);if(!r)continue;r.sublayers||(r.sublayers=new n),r.sublayers.push(t)}else o.push(t)}return o}t([I({readOnly:!0})],St.prototype,"allSublayers",void 0),t([I({json:{type:Object,write:!0}})],St.prototype,"customParameters",void 0),t([I({json:{type:Object,write:!0}})],St.prototype,"customLayerParameters",void 0),t([I({type:String,json:{write:!0}})],St.prototype,"copyright",void 0),t([I()],St.prototype,"description",void 0),t([I({readOnly:!0})],St.prototype,"dimensions",void 0),t([I({json:{type:[[Number]],read:{source:"extent"},write:{target:"extent"},origins:{"web-document":{write:{ignoreOrigin:!0}},"portal-item":{write:{ignoreOrigin:!0}}}}})],St.prototype,"fullExtent",void 0),t([v(["web-document","portal-item"],"fullExtent",["extent"])],St.prototype,"readFullExtentFromItemOrMap",null),t([E(["web-document","portal-item"],"fullExtent",{extent:{type:[[Number]]}})],St.prototype,"writeFullExtent",null),t([I({type:[L]})],St.prototype,"fullExtents",void 0),t([I({type:String,json:{write:{ignoreOrigin:!0}}})],St.prototype,"featureInfoFormat",null),t([I({type:[String],readOnly:!0})],St.prototype,"featureInfoFormats",void 0),t([I({type:String,json:{write:{ignoreOrigin:!0}}})],St.prototype,"featureInfoUrl",void 0),t([I()],St.prototype,"fetchFeatureInfoFunction",void 0),t([I({type:String,json:{origins:{"web-document":{default:"image/png",type:bt.jsonValues,read:{reader:bt.read,source:"format"},write:{writer:bt.write,target:"format"}}}}})],St.prototype,"imageFormat",void 0),t([v("imageFormat",["supportedImageFormatTypes"])],St.prototype,"readImageFormat",null),t([I({type:Number,json:{read:{source:"maxHeight"},write:{target:"maxHeight"}}})],St.prototype,"imageMaxHeight",void 0),t([I({type:Number,json:{read:{source:"maxWidth"},write:{target:"maxWidth"}}})],St.prototype,"imageMaxWidth",void 0),t([I()],St.prototype,"imageTransparency",void 0),t([I(V)],St.prototype,"legendEnabled",void 0),t([I({type:["show","hide","hide-children"]})],St.prototype,"listMode",void 0),t([I({type:String,json:{write:{ignoreOrigin:!0}}})],St.prototype,"mapUrl",void 0),t([I({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],St.prototype,"isReference",void 0),t([I({type:["WMS"]})],St.prototype,"operationalLayerType",void 0),t([I()],St.prototype,"resourceInfo",void 0),t([I({type:N,json:{origins:{service:{read:{source:"extent.spatialReference"}}},write:!1}})],St.prototype,"spatialReference",void 0),t([v(["web-document","portal-item"],"spatialReference",["spatialReferences"])],St.prototype,"readSpatialReferenceFromItemOrDocument",null),t([I({type:[w],json:{read:!1,origins:{service:{read:!0},"web-document":{read:!1,write:{ignoreOrigin:!0}},"portal-item":{read:!1,write:{ignoreOrigin:!0}}}}})],St.prototype,"spatialReferences",void 0),t([E(["web-document","portal-item"],"spatialReferences")],St.prototype,"writeSpatialReferences",null),t([I({type:n.ofType(G),json:{write:{target:"layers",overridePolicy(t,e,r){if(function(t,e){return t.some(t=>{for(const r in t)if(U(t,r,null,e))return!0;return!1})}(this.allSublayers,r))return{ignoreOrigin:!0}}}}})],St.prototype,"sublayers",void 0),t([v(["web-document","portal-item"],"sublayers",["layers","visibleLayers"])],St.prototype,"readSublayersFromItemOrMap",null),t([v("service","sublayers",["layers"])],St.prototype,"readSublayers",null),t([E("sublayers",{layers:{type:[G]},visibleLayers:{type:[String]}})],St.prototype,"writeSublayers",null),t([I({json:{read:!1},readOnly:!0,value:"wms"})],St.prototype,"type",void 0),t([I(W)],St.prototype,"url",null),t([I({type:String,json:{write:{ignoreOrigin:!0}}})],St.prototype,"version",void 0),St=t([F("esri.layers.WMSLayer")],St);const It=St;export{It as default};
