/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../../request.js";import t from"../../core/Error.js";import{isAbortError as n}from"../../core/promiseUtils.js";import s from"../../geometry/Extent.js";import{g as i,a as o,b as r,c as a,d as l,i as u,e as c}from"../../chunks/xmlUtilities.js";import p from"../../geometry/Polygon.js";import{i as m}from"../../chunks/crsUtils.js";import d from"../support/RasterInfo.js";import{e as f,j as g}from"../../chunks/multidimensionalUtils.js";import"../../config.js";import"../../core/lang.js";import"../../chunks/object.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/jsonUtils.js";import"../../chunks/MapUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/handleUtils.js";import"../../chunks/events.js";import"../../chunks/maybe.js";import"../../chunks/tslib.es6.js";import"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/metadata.js";import"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/Lifecycle.js";import"../../chunks/tracking.js";import"../../chunks/Warning.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/zmUtils.js";import"../support/RasterBandInfo.js";import"../../chunks/rasterEnums.js";import"../support/RasterSensorInfo.js";import"../support/DimensionalDefinition.js";function h(e){return e.endsWith("?")?e.slice(0,-1):e}function v(e){return e.filter(({coverageSubType:e})=>null==e||""===e||/^rectified(grid|dataset)/i.test(e))}function b(e){const t={};for(let n=0;n<e.childNodes.length;n++){const i=e.childNodes[n];if(1!==i.nodeType)continue;const r=c(i).toLowerCase();switch(r){case"title":case"abstract":t[r]=o(i);break;case"identifier":t.id=o(i);break;case"wgs84boundingbox":{const e=l(i,"LowerCorner"),n=l(i,"UpperCorner");t.lonLatEnvelope=new s({xmin:e[0],ymin:e[1],xmax:n[0],ymax:n[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":t.coverageSummaries=t.coverageSummaries||[],t.coverageSummaries.push(b(i))}}return t}function x(e,t){if(e.coverageSummaries)for(let n=0;n<e.coverageSummaries.length;n++)e.coverageSummaries[n].abstract=e.coverageSummaries[n].abstract||e.abstract,e.coverageSummaries[n].lonLatEnvelope=e.coverageSummaries[n].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[n].title=e.coverageSummaries[n].title||e.title,x(e.coverageSummaries[n],t);null!=e.id&&t.push(e)}function y(e){const t=i(e.querySelector("Operation[name=GetCapabilities]"),"Get")?.getAttribute("xlink:href")||"",n=i(e.querySelector("Operation[name=DescribeCoverage]"),"Get")?.getAttribute("xlink:href")||"",s=i(e.querySelector("Operation[name=GetCoverage]"),"Get")?.getAttribute("xlink:href")||"";return{getCapabilities:h(t),describeCoverage:h(n),getCoverage:h(s)}}function S(e){e.variables.forEach(e=>e.dimensions.forEach(e=>e.values??=g(e)))}function w(e){return{requestResponseCRSs:r(e,"requestResponseCRSs").map(e=>e.split(":")[1]),nativeCRSs:r(e,"nativeCRSs").map(e=>e.split(":")[1])}}function C(e,t){const n=r(e,"1.0.0"===t?"interpolationMethod":"InterpolationMethod"),s="1.0.0"===t?e.getAttribute("default"):o(e,"InterpolationMethods/Default");return null!=s?[s].concat(n.filter(e=>e.toLowerCase()!==s.toLowerCase())):n}function j(e){return null==e?["nearest"]:e.map(e=>{const t=e.toLowerCase();return t.includes("nearest")?"nearest":t.includes("linear")?"bilinear":t.includes("cubic")?"cubic":null}).filter(e=>!!e)}function D(e){const t=a(e,"pos"),n=l(t[0]),i=l(t[1]);return new s({xmin:n[0],ymin:n[1],xmax:i[0],ymax:i[1],spatialReference:{wkid:4326}})}function k(e,t){const n=r(e,t);return n?.length&&""!==n[0]&&!isNaN(Number(n[0]))?n.map(e=>Number(e)):null}function I(e){const t=l(e,"MinimumValue"),n=l(e,"MaximumValue");return t.length&&n.length?t.map((e,t)=>({min:e,max:n[t],avg:-1,stddev:-1})):null}function L(e){return null==e?null:e.every(t=>t===e[0])?e[0]:e}function T(e){const t=[],n=a(e,"RangeSet");let s=[];for(let e=0;e<n.length;e++){const i=o(n[e],"name"),l=o(n[e],"label"),u=[],c=k(n[e],"nullValues/singleValue"),p=a(n[e],"AxisDescription");for(let e=0;e<p.length;e++){const t=o(p[e],"name"),n=o(p[e],"label"),i=r(p[e],"singleValue");if(0===i.length){const t=o(p[e],"min"),n=o(p[e],"max"),s=Number(o(p[e],"res"))||1;if(null!==t&&null!==n)for(let e=parseInt(t,10);e<=parseInt(n,10);e+=s)i.push(e.toString())}"band"===t.toLowerCase()&&(s=i),u.push({name:t,label:n,values:i})}t.push({name:i,label:l,nullValues:c,axis:u})}return{rangeSet:t,bandNames:s}}function R(e){const t=a(e,"timeposition");if(t.length>0){const e=[];for(let n=0;n<t.length;n++)e.push(new Date(o(t[n])));return{begin:e[0],end:e[e.length-1],values:e}}const n=i(e,"timePeriod")||i(e,"TimePeriod");return n?{begin:new Date(o(n,"beginPosition")||o(n,"BeginPosition")),end:new Date(o(n,"endPosition")||o(n,"EndPosition")),...function(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const n=["Years","Months","Days","Hours","Minutes","Seconds"];let s,i,o;return t.includes("PT")?(t=t.slice(2),o=["H","M","S"].findIndex(e=>t.includes(e)),s=n[3+o],i=parseFloat(t.slice(0,-1))):(t=t.slice(1),o=["Y","M","D"].findIndex(e=>t.includes(e)),o>-1&&(s=n[o]),i=parseFloat(t.slice(0,-1))),{resolution:i,units:s}}(o(n,"timeResolution")||o(n,"TimeResolution"))}:null}function M(e){const t=i(e,"spatialDomain"),n=i(t,"Envelope")||i(t,"EnvelopeWithTimePeriod"),r=n.getAttribute("srsName").split(":"),u=r[r.length-1],c=a(n,"pos"),p=l(c[0]),m=l(c[1]),d=parseInt(u,10),f=isNaN(d)?null:{wkid:d},g=new s({xmin:p[0],ymin:p[1],xmax:m[0],ymax:m[1],spatialReference:f}),h=i(t,"RectifiedGrid"),v=o(h,"low").split(" "),b=o(h,"high").split(" "),x=parseInt(b[0],10)-parseInt(v[0],10)+1,y=parseInt(b[1],10)-parseInt(v[1],10)+1,S=l(t,"origin/pos"),w=a(t,"offsetVector"),C={envelope:g,columns:x,rows:y,offset:{x:parseFloat(o(w[0]).split(" ")[0]),y:parseFloat(o(w[1]).split(" ")[1])},origin:{x:S[0],y:S[1]}},j=i(e,"temporalDomain")||i(e,"TemporalDomain");return{spatialDomain:C,temporalDomain:j?R(j):null}}function E(e,t){const n=[],s=a(e,"Field");let l,u=[];for(let e=0;e<s.length;e++){const c=o(s[e],"Identifier"),p=o(s[e],"Description"),m=o(s[e],"Definition"),d=o(s[e],"Abstract"),f=o(s[e],"Title"),g=k(s[e],"NullValue"),h=i(s[e],"AllowedValues"),v=h?I(h):null,b=C(s[e],"1.1.0"),x=[],y=a(s[e],"Axis");for(let e=0;e<y.length;e++){const n=y[e].getAttribute("identifier"),s=o(y[e],"UOM"),i=o(y[e],"DataType"),a=r(y[e],"Key");t&&!n.toLowerCase().includes("band")||(u=a,l=g),x.push({identifier:n,uom:s,dataType:i,values:a,bandNoDataValues:l})}n.push({identifier:c,description:p,definition:m,abstract:d,title:f,supportedInterpolations:b,axis:x,nullValues:g,statistics:v})}return{rangeSet:n,bandNames:u,bandNoDataValues:l,statistics:n[0].statistics}}function N(e){const t=i(e,"SpatialDomain"),n=i(t,"GridCRS"),r=o(n,"GridBaseCRS"),u=o(n,"GridOrigin"),c=u?.split(" ").map(e=>parseFloat(e))??[0,0],p=l(n,"GridOffsets"),d=a(t,"BoundingBox");let f,g,h,v;for(let e=0;e<d.length;e++){const t=d[e].getAttribute("crs")?.toLowerCase();if(null!=t)if(t.includes("imagecrs")){const t=l(d[e],"LowerCorner"),n=l(d[e],"UpperCorner");f=n[0]-t[0]+1,g=n[1]-t[1]+1}else if(t.indexOf("epsg")>0){const n=t.split(":");h=parseInt(n[n.length-1],10);const i=l(d[e],"LowerCorner"),o=l(d[e],"UpperCorner");v=new s({xmin:i[0],ymin:i[1],xmax:o[0],ymax:o[1],spatialReference:{wkid:h}})}}const b=f>g,x=v.xmax-v.xmin>v.ymax-v.ymin;let y=!1;m(h)&&(b===x?y=!1:(y=!0,v=new s({xmin:v.ymin,ymin:v.xmin,xmax:v.ymax,ymax:v.xmax,spatialReference:{wkid:h}})));const S={columns:f,rows:g,origin:{x:c[0],y:c[1]},offset:{x:p[0],y:p[p.length-1]},gridBaseCRS:r,envelope:v,useEPSGAxis:y},w=i(e,"temporalDomain")||i(e,"TemporalDomain");return{spatialDomain:S,temporalDomain:w?R(w):null}}function P(e){const t=i(e,"Envelope")||i(e,"EnvelopeWithTimePeriod"),n=t.getAttribute("srsName"),r=n.slice(n.lastIndexOf("/")+1),a=t.getAttribute("axisLabels").split(" ").map(e=>e.trim()).filter(e=>""!==e.trim()),c=l(t,"lowerCorner"),p=l(t,"upperCorner"),m=!["y","lat","latitude","north","nor","n","b"].includes(a[0].toLowerCase());let d;const f=parseInt(r,10),g=isNaN(f)?null:{wkid:f};d=new s(m?{xmin:c[0],ymin:c[1],xmax:p[0],ymax:p[1],spatialReference:g}:{xmin:c[1],ymin:c[0],xmax:p[1],ymax:p[0],spatialReference:g});const h={mins:c,maxs:p},v=t.getAttribute("uomLabels").trim().split(" ");let b,x;if(u(t,"EnvelopeWithTimePeriod")){b=new Date(o(e,"beginPosition")||o(e,"BeginPosition")),x=new Date(o(e,"endPosition")||o(e,"EndPosition"));const t=v?.findIndex(e=>"oledatetime"===e?.toLowerCase());t>-1&&(v[t]="ISO8601")}return{envelope:d,axisLabels:a,uomLabels:v.length?v:null,envelopeAllDims:h,beginPosition:b,endPosition:x,isEastFirst:m}}function A(e,t){const n=[],s=a(e,"DataRecord"),r=[];let u,c=[];for(let e=0;e<s.length;e++){const p=a(s[e],"field"),m=[];for(let e=0;e<p.length;e++){const n=p[e].getAttribute("name"),s=o(p[e],"description")||"",a=i(p[e],"uom")?.getAttribute("code")||"",d=l(p[e],"interval"),f=k(p[e],"nilValue")?.[0];t&&!n.toLowerCase().includes("band")||(r.push(n),d?.length&&(u=u||[],u.push({min:d[0],max:d[1],avg:-1,stddev:-1})),c.push(f)),m.push({name:n,description:s,uom:a,allowedValues:d,nilValue:f})}n.push(m)}return c.some(e=>null!=e)||(c=null),{rangeType:n,bandNames:r,bandStats:u,bandNoDataValues:c}}function O(e){let t=1,n="";return Math.abs(e-1/24)<1/24*.01?n="Hours":Math.abs(e-1)<.01?n="Days":e<1?(t=Math.round(24*e),n="Hours"):e>27.99&&e<31.01||Math.round(e/30)<12?n="Months":e>364.99&&e<366.01&&(n="Years"),{interval:t,intervalUnit:n}}function V(e,t){const n=i(e,"RectifiedGrid"),s=l(n,"low"),r=l(n,"high"),u=[];for(let e=0;e<s.length;e++)u.push(r[e]-s[e]+1);const c=o(n,"axisLabels").split(" "),p=l(n,"origin/pos"),m=a(n,"offsetVector"),d=[];for(let e=0;e<m.length;e++){const t=l(m[e]),n=t.findIndex(e=>0!==e);d[n]=t[n]}let f,g,h,v=!1;return t?.length&&c?.length&&(v=[...t].sort((e,t)=>e<t?-1:1).join(",")===[...c].sort((e,t)=>e<t?-1:1).join(",")),["y","lat","latitude","north","nor","n","b"].includes((v?c:t)[0].toLowerCase())?(f=u[1],g=u[0],h={y:Math.abs(d[0]),x:Math.abs(d[1])}):(f=u[0],g=u[1],h={x:Math.abs(d[0]),y:Math.abs(d[1])}),{columns:f,rows:g,origin:p,offset:d,resolution:h,gridSamples:u,axisLabels:c,hasSameAxisLabelsAsBoundedBy:v}}function U(e){const t=i(e,"EarthObservation");if(!t)return null;const n=i(t,"phenomenonTime"),s=n?R(n):null,r=i(t,"phenomenonTime"),a=r?R(r):null,l=o(t,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let u=null;if(l){const e=l.split(" ").map(e=>e.trim()).filter(e=>null!=e&&""!==e).map(Number);if(e.length){const t=[];for(let n=0;n<e.length/2;n+=2)t.push(e[n],e[n+1]);u=new p({rings:[[t]]})}}return{observation:{phenomenonTime:s,resultTime:a,footprint:u,identifier:o(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:o(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:o(e,"metaDataProperty/EarthObservationMetaData/status")}}}async function F(c,p){const{version:m,customParameters:d,signal:f}=p??{},g=m?.startsWith("1.0")?"version":"acceptVersions",S={service:"WCS",request:"GetCapabilities",[g]:m,...d};try{let{data:n}=await e(c,{query:S,responseType:"xml",signal:f});return p?.version||function(e){let t=null;t="string"==typeof e?(new DOMParser).parseFromString(e,"text/xml"):e;const n=t.documentElement.getAttribute("version"),s=n?.slice(0,3);return null!=s&&s<"2.1"}(n)||(S[g]="2.0.1",({data:n}=await e(c,{query:S,responseType:"xml",signal:f}))),function(e,n=null){let c=null;c="string"==typeof e?(new DOMParser).parseFromString(e,"text/xml"):e;let p=c.documentElement.getAttribute("version");"1.0"===p?p="1.0.0":"1.1"===p&&(p="1.1.0");const m=p||n||"1.0.0",d=m.slice(0,3);let f;if("2.0"===d)f=function(e){const t=i(e,"ServiceIdentification"),n=o(t,"Title"),u=r(t,"ServiceTypeVersion"),c=r(t,"Profile"),p=y(i(e,"OperationsMetadata")),m=a(e,"Contents/CoverageSummary"),d=[];for(let e=0;e<m.length;e++){const t=m[e],n=o(t,"CoverageId"),r=i(t,"WGS84BoundingBox");let a;if(r){const e=l(r,"LowerCorner"),t=l(r,"UpperCorner");a=new s({xmin:e[0],ymin:e[1],xmax:t[0],ymax:t[1],spatialReference:{wkid:4326}})}const u=o(t,"CoverageSubtype")||"RectifiedGridCoverage";d.push({id:n,lonLatEnvelope:a,coverageSubType:u})}const f=i(e,"ServiceMetadata");return{name:n,supportedVersions:u,supportedFormats:r(f,"formatSupported"),supportedInterpolations:r(f,"interpolationSupported").concat(r(f,"InterpolationSupported")),onlineResources:p,profiles:c,coverages:d,gridCoverages:v(d),version:"2.0.1"}}(c);else if("1.1"===d)f=function(e){const t=o(e,"ServiceIdentification/Title"),n=r(e,"ServiceIdentification/ServiceTypeVersion"),s=y(i(e,"OperationsMetadata")),a=[],l=i(e,"Contents");for(let e=0;e<l.childNodes.length;e++){const t=l.childNodes[e];1===t.nodeType&&u(t,"CoverageSummary")&&x(b(t),a)}const c=r(l,"SupportedFormat");return{name:t,onlineResources:s,coverages:a,gridCoverages:v(a),supportedVersions:n,supportedFormats:c,version:"1.1.0"}}(c);else{if("1.0"!==d)throw new t("wcsraster:parsecapabilities","the capabilities version is not supported");f=function(e){const t=o(e,"Service/name"),n=i(e,"Capability"),r=i(n,"GetCapabilities/Get/OnlineResource")?.getAttribute("xlink:href")??"",u=i(n,"DescribeCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",c=i(n,"GetCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",p={getCapabilities:h(r),describeCoverage:h(u),getCoverage:h(c)},m=a(e,"CoverageOfferingBrief"),d=[];for(let e=0;e<m.length;e++){const t=m[e],n=o(t,"name"),i=a(t,"pos"),r=l(i[0]),u=l(i[1]),c=new s({xmin:r[0],ymin:r[1],xmax:u[0],ymax:u[1],spatialReference:{wkid:4326}});d.push({id:n,lonLatEnvelope:c})}return{name:t,onlineResources:p,coverages:d,gridCoverages:v(d),supportedVersions:["1.0.0"],version:"1.0.0"}}(c)}return f.version=m,f}(n)}catch(e){if(!n(e))throw new t("wcslayer:open","wcs capabilities is not valid or supported");throw e}}async function G(s,l){const{coverageIds:p,version:m,customParameters:g,signal:h}=l,v=m.slice(0,3),b="1.0"===v?"coverage":"1.1"===v?"identifiers":"coverageId",x={service:"WCS",request:"DescribeCoverage",version:m,[b]:p.join(","),...g};try{const{data:t}=await e(s,{query:x,responseType:"xml",signal:h});return function(e,t){let n=null;if(n="string"==typeof e?(new DOMParser).parseFromString(e,"text/xml"):e,"1.0.0"===t)return a(n,"CoverageOffering").map(e=>function(e){const t={version:"1.0"};let n,s=[];for(let i=0;i<e.childNodes.length;i++){const a=e.childNodes[i];if(1===a.nodeType)if(u(a,"description"))t.description=o(a);else if(u(a,"name"))t.name=o(a);else if(u(a,"label"))t.label=o(a);else if(u(a,"supportedFormats"))t.supportedFormats=r(a,"formats");else if(u(a,"supportedCRSs"))t.supportedCRSs=w(a);else if(u(a,"supportedInterpolations"))t.supportedInterpolations=C(a,"1.0.0");else if(u(a,"lonLatEnvelope"))t.lonLatEnvelope=D(a);else if(u(a,"rangeSet")){const e=T(a);t.rangeSet=e.rangeSet,s=e.bandNames;const i=e.rangeSet[0].nullValues;i?.length&&(n=L(i))}else u(a,"domainSet")&&(t.domainSet=M(a))}const i=j(t.supportedInterpolations),{name:a,description:l,label:c,lonLatEnvelope:p,supportedFormats:m}=t,{spatialDomain:f}=t.domainSet,g={x:Math.abs(f.offset.x),y:Math.abs(f.offset.y)},h=function(e){if(!e.temporalDomain)return null;const{begin:t,end:n,values:s,units:i,resolution:o}=e.temporalDomain,r={variables:[{name:"default",description:"",dimensions:[{name:"StdTime",description:"",unit:"ISO8601",values:s?.map(e=>e.getTime()),hasRegularIntervals:!s,interval:o,intervalUnit:i,extent:[t.getTime(),n.getTime()]}]}]};return S(r),r}(t.domainSet),v=new d({width:f.columns,height:f.rows,pixelSize:g,pixelType:"unknown",extent:f.envelope,spatialReference:f.envelope.spatialReference,bandCount:s.length||1,noDataValue:n,multidimensionalInfo:h});return{id:a,title:t.name,description:l||c,lonLatEnvelope:p,rasterInfo:v,bandNames:s,supportedFormats:m,supportedInterpolations:i,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}(e));const s=a(n,"CoverageDescription");return"1.1.0"===t||"1.1.1"===t||"1.1.2"===t?s.map(e=>function(e,t){const n=[],s=[],i={supportedFormats:n,supportedCRSs:s,version:"1.1"};let r,a,l=[];for(let t=0;t<e.childNodes.length;t++){const u=e.childNodes[t];if(1!==u.nodeType)continue;const p=c(u).toLowerCase();switch(p){case"title":case"abstract":case"identifier":i[p]=o(u);break;case"supportedformat":{const e=o(u);n.includes(e)||n.push(e)}break;case"supportedcrs":{const e=o(u);s.includes(e)||s.push(e)}break;case"range":{const e=E(u,!!i.domain?.temporalDomain);i.range=e.rangeSet,l=e.bandNames;const{bandNoDataValues:t}=e;t?.length&&(r=L(t)),a=e.statistics}break;case"domain":i.domain=N(u)}}const u=j(i.range[0].supportedInterpolations),{identifier:p,abstract:m,title:f,domain:g,range:h}=i,v={x:Math.abs(g.spatialDomain.offset.x),y:Math.abs(g.spatialDomain.offset.y)},b=function(e,t){if(!t.temporalDomain)return null;const n=e.filter(e=>!e.identifier.toLowerCase().includes("field_1")&&!e.axis.some(e=>e.identifier.includes("band"))),s=[];if(n.length&&n.forEach(e=>{const t=e.axis.map(e=>{const t=e.values.map(t=>"ISO8601"===e.uom?(t=t.trim()).toLowerCase().includes("z")?new Date(t).getTime():new Date(t+"Z").getTime():parseFloat(t.trim())),n=[Math.min.apply(null,t),Math.max.apply(null,t)];return{name:e.identifier.trim(),description:"",field:e.identifier.trim(),unit:e.uom?e.uom.trim():"",hasRegularIntervals:!1,values:t,extent:n}});s.push({name:e.identifier.trim(),description:e.description?.trim()??"",unit:"",dimensions:t,statistics:e.statistics})}),t.temporalDomain){const{begin:e,end:n,values:i,units:o,resolution:r}=t.temporalDomain;s.some(e=>e.dimensions.some(e=>"stdtime"===e.name.toLowerCase()))||s.forEach(t=>{t.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:i?.map(e=>e.getTime()),hasRegularIntervals:!i,interval:r,intervalUnit:o,extent:[e.getTime(),n.getTime()]})})}if(s.length){const e={variables:s};return S(e),e}return null}(h,g);b&&(r=h[0].nullValues,1===r?.length&&(r=r[0]));const x=new d({width:g.spatialDomain.columns,height:g.spatialDomain.rows,pixelSize:v,pixelType:"unknown",extent:g.spatialDomain.envelope,spatialReference:g.spatialDomain.envelope.spatialReference,bandCount:l.length||1,noDataValue:r,statistics:a,multidimensionalInfo:b});return{id:p,title:i.title,description:m||f,bandNames:l,rasterInfo:x,supportedFormats:n,supportedInterpolations:u,coverageDescription:i,version:t,useEPSGAxis:g.spatialDomain.useEPSGAxis}}(e,t)):s.map(e=>function(e){const t={version:"2.0"};let n,s,a=[];for(let l=0;l<e.childNodes.length;l++){const c=e.childNodes[l];if(1===c.nodeType)if(u(c,"coverageId"))t.coverageId=o(c);else if(u(c,"ServiceParameters"))t.serviceParameters={supportedFormats:r(c,"nativeFormat")};else if(u(c,"boundedBy"))t.boundedBy=P(c);else if(u(c,"rangeType")){const e=A(c,t.boundedBy?.axisLabels.length>2||t.domainSet?.axisLabels.length>2);t.rangeType=e.rangeType,a=e.bandNames,n=e.bandStats;const{bandNoDataValues:i}=e;i?.length&&(s=L(i))}else if(u(c,"domainSet"))t.domainSet=V(c,t.boundedBy?.axisLabels);else if(u(c,"metadata")){const e=i(c,"EOMetadata");t.eoMetadata=e?U(e):null}}const{coverageId:l,boundedBy:c,domainSet:p,rangeType:m,serviceParameters:g}=t,h=function(e,t,n){if(n.axisLabels.length<=2)return null;const s=[];for(let t=0;t<e.length;t++){const n=e[t];for(let e=0;e<n.length;e++)n[e].name.toLowerCase().includes("band")||s.push(n[e])}const i=[];if(s.length){const e=[];for(let s=2;s<n.axisLabels.length;s++){const i=t.uomLabels?.[s]?.trim()??"",o=n.axisLabels[s].toLowerCase().includes("time")||"iso8601"===i.toLowerCase()||"oledatetime"===i.toLowerCase();let r,a;if(o){const e=O(n.offset[s]);r=e.interval,a=e.intervalUnit}else r=n.offset[s],a=i;const l=[];o?(l.push(f(t.envelopeAllDims.mins[s])),l.push(f(t.envelopeAllDims.maxs[s]))):(l.push(t.envelopeAllDims.mins[s]),l.push(t.envelopeAllDims.maxs[s])),e.push({name:n.axisLabels[s].trim(),description:n.axisLabels[s].trim(),unit:o?"ISO8601":i,hasRegularIntervals:!0,extent:l,interval:r,intervalUnit:a})}if(s.forEach(t=>{const{allowedValues:n}=t,s=2===n?.length?[{min:n[0],max:n[1],avg:-1,stddev:-1}]:null;i.push({name:t.name.trim(),description:t.description?.trim()??"",unit:t.uom.trim(),statistics:s,dimensions:[...e]})}),i.length){const e={variables:i};return S(e),e}}return null}(m,c,p);return!n&&h&&(n=h?.variables[0].statistics),null!=h&&(s=m[0][0].nilValue),{id:l,title:l,description:l,bandNames:a,rasterInfo:new d({width:p.columns,height:p.rows,pixelSize:p.resolution,pixelType:"unknown",extent:c.envelope,spatialReference:c.envelope.spatialReference,bandCount:a.length||1,statistics:n,noDataValue:s,multidimensionalInfo:h}),supportedFormats:g.supportedFormats,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}(e))}(t,m)}catch(e){if(!n(e))throw new t("wcslayer:open","wcs coverage description is not valid or supported");throw e}}export{G as describeCoverage,F as getCapabilities,j as s};
