/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../request.js";import{i as r,clone as i}from"../core/lang.js";import s from"../core/Collection.js";import o from"../core/Error.js";import{M as a}from"../chunks/MultiOriginJSONSupport.js";import{g as n}from"../chunks/object.js";import{throwIfAbortError as l}from"../core/promiseUtils.js";import{watch as c,on as p,sync as m}from"../core/reactiveUtils.js";import{urlToObject as u,objectToQuery as d}from"../core/urlUtils.js";import{property as h}from"../core/accessorSupport/decorators/property.js";import"../chunks/Logger.js";import{r as f}from"../chunks/reader.js";import{subclass as y}from"../core/accessorSupport/decorators/subclass.js";import{w as g}from"../chunks/writer.js";import j from"../geometry/Extent.js";import w from"./Layer.js";import v,{W as x}from"./WebTileLayer.js";import{BlendLayer as T}from"./mixins/BlendLayer.js";import{OperationalLayer as M}from"./mixins/OperationalLayer.js";import{PortalLayer as S}from"./mixins/PortalLayer.js";import{RefreshableLayer as b}from"./mixins/RefreshableLayer.js";import{ScaleRangeLayer as I}from"./mixins/ScaleRangeLayer.js";import{c as L}from"../chunks/imageBitmapUtils.js";import k from"./support/TileInfo.js";import{T as P}from"../chunks/TileInfoTilemapCache.js";import C from"./support/WMTSSublayer.js";import{Q as U,a6 as E}from"../chunks/unitUtils.js";import A from"../geometry/Point.js";import{i as R}from"../chunks/crsUtils.js";import{v as V}from"../chunks/xmlUtils.js";import O from"./support/LOD.js";import"../config.js";import"../kernel.js";import"../chunks/string.js";import"../chunks/jsonUtils.js";import"../chunks/MapUtils.js";import"../chunks/persistableUrlUtils.js";import"../chunks/watch.js";import"../chunks/ObjectPool.js";import"../chunks/handleUtils.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../chunks/SetUtils.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/Lifecycle.js";import"../chunks/tracking.js";import"../chunks/SimpleTrackingTarget.js";import"../core/Evented.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/maybe.js";import"../chunks/metadata.js";import"../chunks/ObservableBase.js";import"../chunks/ensureType.js";import"../chunks/Warning.js";import"../chunks/events.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../core/JSONSupport.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"../chunks/jsonMap.js";import"../chunks/pe.js";import"../chunks/assets.js";import"../geometry/support/webMercatorUtils.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"../time/TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/date.js";import"../chunks/locale.js";import"../chunks/constants.js";import"../chunks/datetime.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/layerContainerType.js";import"../chunks/jsonUtils2.js";import"../chunks/parser.js";import"../chunks/colorUtils.js";import"../chunks/utils5.js";import"../chunks/screenUtils.js";import"../chunks/mat4.js";import"../chunks/common.js";import"../chunks/commonProperties.js";import"../symbols/support/ElevationInfo.js";import"../core/Clonable.js";import"../symbols/support/FeatureExpressionInfo.js";import"./support/fieldUtils.js";import"../core/sql.js";import"../chunks/guards.js";import"../chunks/unitConversionUtils.js";import"../chunks/lengthUtils.js";import"../tables/AttributeTableTemplate.js";import"../tables/elements/AttributeTableGroupElement.js";import"../tables/elements/AttributeTableAttachmentElement.js";import"../tables/elements/AttributeTableElement.js";import"../tables/elements/AttributeTableFieldElement.js";import"../tables/elements/AttributeTableRelationshipElement.js";import"../chunks/opacityUtils.js";import"../chunks/asyncUtils.js";import"../chunks/layerUtils.js";import"./catalog/catalogUtils.js";import"../portal/Portal.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../chunks/projectionUtils.js";import"../chunks/vec3f64.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../geometry/Polyline.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../chunks/projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/TileKey.js";import"./support/TileMatrixSet.js";import"./support/WMTSStyle.js";const F=90.71428571428571;function _(e){const t=e.replaceAll(/ows:/gi,"");return(new DOMParser).parseFromString(t,"text/xml")}function N(e){if(!B("Contents",e.documentElement))throw new o("wmtslayer:wmts-capabilities-xml-is-not-valid","the wmts get capabilities response is not compliant")}function W(e){return e.nodeType===Node.ELEMENT_NODE}function B(e,t){for(let r=0;r<t.childNodes.length;r++){const i=t.childNodes[r];if(W(i)&&i.nodeName===e)return i}return null}function K(e,t){const r=[];for(let i=0;i<t.childNodes.length;i++){const s=t.childNodes[i];W(s)&&s.nodeName===e&&r.push(s)}return r}function D(e,t){const i=[];for(let r=0;r<t.childNodes.length;r++){const s=t.childNodes[r];W(s)&&s.nodeName===e&&i.push(s)}return i.map(e=>e.textContent).filter(r)}function G(e,t){return e.split(">").forEach(e=>{t&&(t=B(e,t))}),t&&t.textContent}function $(e,t,r,i){let s;return Array.prototype.slice.call(i.childNodes).some(i=>{if(i.nodeName.includes(e)){const e=B(t,i),o=e?.textContent;if(o===r||r.split(":")&&r.split(":")[1]===o)return s=i,!0}return!1}),s}function q(e,t){const r=[],i=e.layerMap?.get(t);if(!i)return null;const s=K("ResourceURL",i),o=K("Dimension",i);let a,n,l,c;return o.length&&(a=G("Identifier",o[0]),n=D("Default",o[0])||D("Value",o[0])),o.length>1&&(l=G("Identifier",o[1]),c=D("Default",o[1])||D("Value",o[1])),e.dimensionMap.set(t,{dimensions:n,dimensions2:c}),s.forEach(e=>{let t=e.getAttribute("template");if("tile"===e.getAttribute("resourceType")){if(a&&n.length)if(t.includes("{"+a+"}"))t=t.replace("{"+a+"}","{dimensionValue}");else{const e=t.toLowerCase().indexOf("{"+a.toLowerCase()+"}");e>-1&&(t=t.slice(0,e)+"{dimensionValue}"+t.slice(e+a.length+2))}if(l&&c.length)if(t.includes("{"+l+"}"))t=t.replace("{"+l+"}","{dimensionValue2}");else{const e=t.toLowerCase().indexOf("{"+l.toLowerCase()+"}");e>-1&&(t=t.slice(0,e)+"{dimensionValue2}"+t.slice(e+l.length+2))}r.push({template:t,format:e.getAttribute("format"),resourceType:"tile"})}}),r}function H(e){e=e.toLowerCase();let t=parseInt(e.split(":").pop(),10);900913!==t&&3857!==t||(t=102100);const r=function(e){return e.includes("crs84")||e.includes("crs:84")?4326:e.includes("crs83")||e.includes("crs:83")?4269:e.includes("crs27")||e.includes("crs:27")?4267:null}(e);return null!=r&&(t=r),{wkid:t}}function J(e,t){const r=H(t),[i,s]=G("TopLeftCorner",e).split(" ").map(e=>parseFloat(e)),o=t.includes("epsg")&&R(r.wkid);return new A(o?{x:s,y:i,spatialReference:r}:{x:i,y:s,spatialReference:r})}function z(e,t,r,i,s){const o=H(t),a=G("Identifier",e);let n=parseFloat(G("ScaleDenominator",e));const l=Q(o.wkid,n,i);n*=96/F;const c=+G("MatrixWidth",e),p=+G("MatrixHeight",e),{maxCol:m=c-1,maxRow:u=p-1,minCol:d=0,minRow:h=0}=s.get(a)??{},{x:f,y}=J(e,t);return new O({cols:[d,m],level:r,levelValue:a,origin:[f,y],scale:n,resolution:l,rows:[h,u]})}function Q(e,t,r){let i;return i=U.hasOwnProperty(""+e)?U.values[U[e]]:"default028mm"===r?6370997*Math.PI/180:E(e).metersPerDegree,7*t/25e3/i}var X;const Y={"image/png":".png","image/png8":".png","image/png24":".png","image/png32":".png","image/jpg":".jpg","image/jpeg":".jpeg","image/gif":".gif","image/bmp":".bmp","image/tiff":".tif","image/jpgpng":"","image/jpegpng":"","image/unknown":""},Z=new Set(["version","service","request","layer","style","format","tilematrixset","tilematrix","tilerow","tilecol"]);let ee=X=class extends(T(b(I(M(S(a(w))))))){constructor(...e){super(...e),this.activeLayer=null,this.copyright="",this.customParameters=null,this.customLayerParameters=null,this.fullExtent=null,this.operationalLayerType="WebTiledLayer",this.resourceInfo=null,this.serviceMode="RESTful",this.sublayers=null,this.type="wmts",this.version="1.0.0",this.addHandles([c(()=>this.activeLayer,(e,t)=>{t&&!this.sublayers?.includes(t)&&(t.layer=null,t.parent=null),e&&(e.layer=this,e.parent=this)},m),p(()=>this.sublayers,"after-add",({item:e})=>{e.layer=this,e.parent=this},m),p(()=>this.sublayers,"after-remove",({item:e})=>{e.layer=null,e.parent=null},m),c(()=>this.sublayers,(e,t)=>{if(t)for(const e of t)e.layer=null,e.parent=null;if(e)for(const t of e)t.layer=this,t.parent=this},m)])}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMTS"]},e).catch(l).then(()=>this._fetchService(e)).catch(e=>{throw l(e),new o("wmtslayer:unsupported-service-data","Invalid response from the WMTS service.",{error:e})})),Promise.resolve(this)}readActiveLayerFromService(e,t,r){this.activeLayer||(this.activeLayer=new C);let i=t.layers.find(e=>e.id===this.activeLayer.id);return i||(i=t.layers[0]),this.activeLayer.read(i,r),this.activeLayer}readActiveLayerFromItemOrWebDoc(e,t){const{templateUrl:r,wmtsInfo:i}=t,s=r?this._getLowerCasedUrlParams(r):null,o=i?.layerIdentifier;let a=null;const n=i?.tileMatrixSet;n&&(Array.isArray(n)?n.length&&(a=n[0]):a=n);const l=s?.format,c=s?.style;return new C({id:o,imageFormat:l,styleId:c,tileMatrixSetId:a})}writeActiveLayer(e,t,r,i){const s=this.activeLayer;t.templateUrl=this.getUrlTemplate(s.id,s.tileMatrixSetId,s.imageFormat,s.styleId);const o=n("tileMatrixSet.tileInfo",s);t.tileInfo=o?o.toJSON(i):null,t.wmtsInfo={...t.wmtsInfo,layerIdentifier:s.id,tileMatrixSet:s.tileMatrixSetId}}readCustomParameters(e,t){const r=t.wmtsInfo;return r?this._mergeParams(r.customParameters,r.url):null}get fullExtents(){return this.activeLayer.fullExtents}readServiceMode(e,t){return t.templateUrl.includes("?")?"KVP":"RESTful"}readSublayersFromService(e,t,r){const i=function(e,t){return e.map(e=>{const r=new C;return r.read(e,t),r})}(t.layers,r);return i}get supportedSpatialReferences(){return this.activeLayer.tileMatrixSets?.map(e=>e.tileInfo?.spatialReference).toArray().filter(r)??[]}get tilemapCache(){const e=this.activeLayer?.tileMatrixSet?.tileInfo;return e?new P(e):void 0}get title(){return this.activeLayer?.title??"Layer"}set title(e){this._overrideIfSome("title",e)}get url(){return this._get("url")}set url(e){e&&e.endsWith("/")?this._set("url",e.slice(0,-1)):this._set("url",e)}createWebTileLayer(e){const t=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId),r=this._getTileMatrixSetById(e.tileMatrixSetId),i=r?.tileInfo,s=e.fullExtent,o=new x({layerIdentifier:e.id,tileMatrixSet:e.tileMatrixSetId,url:this.url});return this.customLayerParameters&&(o.customLayerParameters=this.customLayerParameters),this.customParameters&&(o.customParameters=this.customParameters),new v({fullExtent:s,urlTemplate:t,tileInfo:i,wmtsInfo:o})}async fetchTile(e,r,i,s={}){const{signal:o}=s,a=this.getTileUrl(e,r,i),{data:n}=await t(a,{responseType:"image",signal:o});return n}async fetchImageBitmapTile(e,r,i,s={}){const{signal:o}=s;if(this.fetchTile!==X.prototype.fetchTile){const t=await this.fetchTile(e,r,i,s);return L(t,e,r,i,o)}const a=this.getTileUrl(e,r,i),{data:n}=await t(a,{responseType:"blob",signal:o});return L(n,e,r,i,o)}findSublayerById(e){return this.sublayers?.find(t=>t.id===e)}getTileUrl(e,t,r){const i=this._getTileMatrixSetById(this.activeLayer.tileMatrixSetId),s=i?.tileInfo?.lods[e],o=s?s.levelValue||`${s.level}`:`${e}`;let a=this.resourceInfo?"":function(e,t,r,i,s,o,a,n){const l=function(e,t,r){const i=q(e,t),s=i?.filter(e=>e.format===r);return(s?.length?s:i)??[]}(e,t,i);if(!(l?.length>0))return"";const{dimensionMap:c}=e,p=c.get(t).dimensions?.[0],m=c.get(t).dimensions2?.[0];return l[a%l.length].template.replaceAll(/\{Style\}/gi,s??"").replaceAll(/\{TileMatrixSet\}/gi,r??"").replaceAll(/\{TileMatrix\}/gi,o).replaceAll(/\{TileRow\}/gi,""+a).replaceAll(/\{TileCol\}/gi,""+n).replaceAll(/\{dimensionValue\}/gi,p).replaceAll(/\{dimensionValue2\}/gi,m)}({dimensionMap:this.dimensionMap,layerMap:this.layerMap},this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId,o,t,r);return a||(a=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId).replaceAll(/\{level\}/gi,o).replaceAll(/\{row\}/gi,`${t}`).replaceAll(/\{col\}/gi,`${r}`)),a=this._appendCustomLayerParameters(a),a}getUrlTemplate(e,t,r,i){if(!this.resourceInfo){const r=function(e,t,r,i){const{dimensionMap:s}=e,o=q(e,t);let a="";if(o&&o.length>0){const e=s.get(t).dimensions?.[0],n=s.get(t).dimensions2?.[0];a=o[0].template,a.endsWith(".xxx")&&(a=a.slice(0,-4)),a=a.replaceAll(/\{Style\}/gi,i),a=a.replaceAll(/\{TileMatrixSet\}/gi,r),a=a.replaceAll(/\{TileMatrix\}/gi,"{level}"),a=a.replaceAll(/\{TileRow\}/gi,"{row}"),a=a.replaceAll(/\{TileCol\}/gi,"{col}"),a=a.replaceAll(/\{dimensionValue\}/gi,e),a=a.replaceAll(/\{dimensionValue2\}/gi,n)}return a}({dimensionMap:this.dimensionMap,layerMap:this.layerMap},e,t,i);if(r)return r}if("KVP"===this.serviceMode)return this.url+"?SERVICE=WMTS&VERSION="+this.version+"&REQUEST=GetTile&LAYER="+e+"&STYLE="+i+"&FORMAT="+r+"&TILEMATRIXSET="+t+"&TILEMATRIX={level}&TILEROW={row}&TILECOL={col}";if("RESTful"===this.serviceMode){let s="";return Y[r.toLowerCase()]&&(s=Y[r.toLowerCase()]),this.url+e+"/"+i+"/"+t+"/{level}/{row}/{col}"+s}return""}async _fetchService(e){if(this.resourceInfo)return"KVP"!==this.resourceInfo.serviceMode||this.url.includes("?")||(this.url+="?"),function(e){for(const t of e.layers)for(const e of t.tileMatrixSets??[]){const{tileInfo:t}=e;if(t&&96!==t.dpi){for(const r of t.lods??[])r.scale=96*r.scale/t.dpi,r.resolution=Q(t.spatialReference?.wkid,r.scale*F/96,e.id);t.dpi=96}}}(this.resourceInfo),void this.read(this.resourceInfo,{origin:"service"});let t=null;try{const{data:r}=await this._getCapabilities(this.serviceMode,e);t=_(r),N(t)}catch{const r="KVP"===this.serviceMode?"RESTful":"KVP";try{const{data:i}=await this._getCapabilities(r,e);t=_(i),N(t),this.serviceMode=r}catch(e){throw new o("wmtslayer:unsupported-service-data","Services does not support RESTful or KVP service modes.",{error:e})}}const{serviceMode:r,url:i}=this,s=function(e,t){const r=e.documentElement,i=new Map,s=new Map,a=B("Contents",r);if(!a)throw new o("wmtslayer:wmts-capabilities-xml-is-not-valid","Can't retrieve xml capabilities element");const n=B("OperationsMetadata",r),l=n?.querySelector("[name='GetTile']"),c=l?.getElementsByTagName("Get"),p=c&&Array.prototype.slice.call(c),m=t.url?.indexOf("https"),u=void 0!==m&&m>-1;let d,h,f=t.serviceMode,y=t?.url;if(p?.length&&p.some(e=>{const t=B("Constraint",e);return!t||$("AllowedValues","Value",f,t)?(y=e.attributes[0].nodeValue,!0):(!t||$("AllowedValues","Value","RESTful",t)||$("AllowedValues","Value","REST",t)?h=e.attributes[0].nodeValue:t&&!$("AllowedValues","Value","KVP",t)||(d=e.attributes[0].nodeValue),!1)}),!y)if(h)y=h,f="RESTful";else if(d)y=d,f="KVP";else{const e=B("ServiceMetadataURL",r);y=e?.getAttribute("xlink:href")}const g=y.indexOf("1.0.0/");-1===g&&"RESTful"===f?y+="/":g>-1&&(y=y.slice(0,g)),"KVP"===f&&(y+=g>-1?"":"?"),u&&(y=y.replace(/^http:/i,"https:"));const w=G("ServiceIdentification>ServiceTypeVersion",r),v=G("ServiceIdentification>AccessConstraints",r),x=v&&/^none$/i.test(v)?null:v,T=K("Layer",a),M=K("TileMatrixSet",a),S=T.map(e=>{const t=G("Identifier",e);return i.set(t,e),function(e,t,r,i,s){const o=G("Abstract",t),a=D("Format",t),n=function(e){const t=B("WGS84BoundingBox",e),r=t?G("LowerCorner",t).split(" "):["-180","-90"],i=t?G("UpperCorner",t).split(" "):["180","90"];return{xmin:parseFloat(r[0]),ymin:parseFloat(r[1]),xmax:parseFloat(i[0]),ymax:parseFloat(i[1]),spatialReference:{wkid:4326}}}(t),l=function(e){const t=[];return V(e,{BoundingBox:e=>{if(!e.getAttribute("crs"))return;const r=e.getAttribute("crs").toLowerCase(),i=H(r),s=r.includes("epsg")&&R(i.wkid);let o,a,n,l;V(e,{LowerCorner:e=>{[o,a]=e.textContent.split(" ").map(e=>Number.parseFloat(e)),s&&([o,a]=[a,o])},UpperCorner:e=>{[n,l]=e.textContent.split(" ").map(e=>Number.parseFloat(e)),s&&([n,l]=[l,n])}}),t.push({xmin:o,ymin:a,xmax:n,ymax:l,spatialReference:i})}}),t}(t),c=function(e,t){return K("Style",e).map(e=>{const r=B("LegendURL",e),i=B("Keywords",e),s=i?D("Keyword",i):[];let o=r?.getAttribute("xlink:href");return t&&(o=o?.replace(/^http:/i,"https:")),{abstract:G("Abstract",e),id:G("Identifier",e),isDefault:"true"===e.getAttribute("isDefault"),keywords:s,legendUrl:o,title:G("Title",e)}})}(t,i),p=G("Title",t),m=function(e,t,r){return K("TileMatrixSetLink",t).map(t=>function(e,t,r){const i=B("TileMatrixSet",t).textContent,s=D("TileMatrix",t),o=r.find(e=>{const t=B("Identifier",e),r=t?.textContent;return!!(r===i||i.split(":")&&i.split(":")[1]===r)}),a=B("TileMatrixSetLimits",t),n=a&&K("TileMatrixLimits",a),l=new Map;if(n?.length)for(const e of n){const t=B("TileMatrix",e).textContent,r=+B("MinTileRow",e).textContent,i=+B("MaxTileRow",e).textContent,s=+B("MinTileCol",e).textContent,o=+B("MaxTileCol",e).textContent;l.set(t,{minCol:s,maxCol:o,minRow:r,maxRow:i})}const c=G("SupportedCRS",o).toLowerCase(),p=function(e,t){return J(B("TileMatrix",e),t)}(o,c),m=p.spatialReference,u=B("TileMatrix",o),d=[parseInt(G("TileWidth",u),10),parseInt(G("TileHeight",u),10)],h=[];s.length?s.forEach((e,t)=>{const r=$("TileMatrix","Identifier",e,o);h.push(z(r,c,t,i,l))}):K("TileMatrix",o).forEach((e,t)=>{h.push(z(e,c,t,i,l))});const f=function(e,t,r,i,s){const o=B("BoundingBox",t);let a,n,l,c,p,m;if(o&&(a=G("LowerCorner",o).split(" "),n=G("UpperCorner",o).split(" ")),a&&a.length>1&&n&&n.length>1)l=parseFloat(a[0]),p=parseFloat(a[1]),c=parseFloat(n[0]),m=parseFloat(n[1]);else{const e=B("TileMatrix",t),o=parseInt(G("MatrixWidth",e),10),a=parseInt(G("MatrixHeight",e),10);l=r.x,m=r.y,c=l+o*i[0]*s.resolution,p=m-a*i[1]*s.resolution}return function(e,t,r){return"1.0.0"===e&&R(t.wkid)&&!(r.spatialReference.isGeographic&&r.x<-90&&r.y>=-90)}(e,r.spatialReference,r)?new j(p,l,m,c,r.spatialReference):new j(l,p,c,m,r.spatialReference)}(e,o,p,d,h[0]).toJSON(),y=new k({dpi:96,spatialReference:m,size:d,origin:p,lods:h}).toJSON();return{id:i,fullExtent:f,tileInfo:y}}(e,t,r))}(s,t,r);return{id:e,fullExtent:n,fullExtents:l,description:o,formats:a,styles:c,title:p,tileMatrixSets:m}}(t,e,M,u,w)});return{copyright:x,dimensionMap:s,layerMap:i,layers:S,serviceMode:f,tileUrl:y}}(t,{serviceMode:r,url:i});this.read(s,{origin:"service"})}async _getCapabilities(e,r){const i=this._getCapabilitiesUrl(e);return await t(i,{...r,responseType:"text"})}_getTileMatrixSetById(e){const t=this.findSublayerById(this.activeLayer.id);return t?.tileMatrixSets?.find(({id:t})=>t===e)}_appendCustomParameters(e){return this._appendParameters(e,this.customParameters)}_appendCustomLayerParameters(e){return this._appendParameters(e,{...i(this.customParameters),...this.customLayerParameters})}_appendParameters(e,t){const r=u(e),i={...r.query,...t},s=d(i);return""===s?r.path:`${r.path}?${s}`}_getCapabilitiesUrl(e){this.url=u(this.url).path;let t=this.url;switch(e){case"KVP":t+=`?request=GetCapabilities&service=WMTS&version=${this.version}`;break;case"RESTful":{const e=`/${this.version}/WMTSCapabilities.xml`,r=new RegExp(e,"i");t=t.replace(r,""),t+=e;break}}return this._appendCustomParameters(t)}_getLowerCasedUrlParams(e){if(!e)return null;const t=u(e).query;if(!t)return null;const r={};return Object.keys(t).forEach(e=>{r[e.toLowerCase()]=t[e]}),r}_mergeParams(e,t){const r=this._getLowerCasedUrlParams(t);if(r){const t=Object.keys(r);t.length&&(e=e?i(e):{},t.forEach(t=>{e.hasOwnProperty(t)||Z.has(t)||(e[t]=r[t])}))}return e}};e([h()],ee.prototype,"dimensionMap",void 0),e([h()],ee.prototype,"layerMap",void 0),e([h({type:C,json:{origins:{"web-document":{write:{ignoreOrigin:!0}}}}})],ee.prototype,"activeLayer",void 0),e([f("service","activeLayer",["layers"])],ee.prototype,"readActiveLayerFromService",null),e([f(["web-document","portal-item"],"activeLayer",["wmtsInfo"])],ee.prototype,"readActiveLayerFromItemOrWebDoc",null),e([g(["web-document","portal-item"],"activeLayer",{templateUrl:{type:String},tileInfo:{type:k},"wmtsInfo.layerIdentifier":{type:String},"wmtsInfo.tileMatrixSet":{type:String}})],ee.prototype,"writeActiveLayer",null),e([h({type:String,value:"",json:{write:!0}})],ee.prototype,"copyright",void 0),e([h({type:["show","hide"]})],ee.prototype,"listMode",void 0),e([h({json:{read:!0,write:!0}})],ee.prototype,"blendMode",void 0),e([h({json:{origins:{"web-document":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}},"portal-item":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}}}}})],ee.prototype,"customParameters",void 0),e([f(["portal-item","web-document"],"customParameters")],ee.prototype,"readCustomParameters",null),e([h({json:{origins:{"web-document":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}},"portal-item":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}}}}})],ee.prototype,"customLayerParameters",void 0),e([h({type:j,json:{write:{ignoreOrigin:!0},origins:{"web-document":{read:{source:"fullExtent"}},"portal-item":{read:{source:"fullExtent"}}}}})],ee.prototype,"fullExtent",void 0),e([h({readOnly:!0})],ee.prototype,"fullExtents",null),e([h({type:["WebTiledLayer"]})],ee.prototype,"operationalLayerType",void 0),e([h()],ee.prototype,"resourceInfo",void 0),e([h()],ee.prototype,"serviceMode",void 0),e([f(["portal-item","web-document"],"serviceMode",["templateUrl"])],ee.prototype,"readServiceMode",null),e([h({type:s.ofType(C)})],ee.prototype,"sublayers",void 0),e([f("service","sublayers",["layers"])],ee.prototype,"readSublayersFromService",null),e([h({readOnly:!0})],ee.prototype,"supportedSpatialReferences",null),e([h({readOnly:!0})],ee.prototype,"tilemapCache",null),e([h({json:{read:{source:"title"}}})],ee.prototype,"title",null),e([h({json:{read:!1},readOnly:!0,value:"wmts"})],ee.prototype,"type",void 0),e([h({json:{origins:{service:{read:{source:"tileUrl"}},"web-document":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}},"portal-item":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}}}}})],ee.prototype,"url",null),e([h()],ee.prototype,"version",void 0),ee=X=e([y("esri.layers.WMTSLayer")],ee);const te=ee;export{te as default};
