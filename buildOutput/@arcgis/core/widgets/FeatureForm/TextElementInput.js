/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import s from"../../core/Collection.js";import{R as e}from"../../chunks/ReactiveMap.js";import{R as r}from"../../chunks/ReactiveSet.js";import{r as i}from"../../chunks/sanitizerUtils.js";import{g as o}from"../../chunks/watch.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/Logger.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import{U as m}from"../../chunks/UpdatingHandles.js";import{extractSubstitutionTemplatesFromString as a}from"../../layers/support/fieldUtils.js";import{x as l,y as u,z as c,A as h,B as j}from"../../chunks/featureFormUtils.js";import d from"./InputBase.js";import"../../core/Evented.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/maybe.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/Lifecycle.js";import"../../chunks/metadata.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../chunks/Warning.js";import"../../core/Error.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../core/promiseUtils.js";import"../../chunks/events.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/jsonUtils.js";import"../../core/reactiveUtils.js";import"../../core/sql.js";import"../../chunks/guards.js";import"../../chunks/datetime.js";import"../../intl.js";import"../../chunks/date.js";import"../../chunks/jsonMap.js";import"../../chunks/locale.js";import"../../chunks/constants.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/assets.js";import"../../chunks/formUtils.js";import"../../form/elements/AttachmentElement.js";import"../../form/elements/Element.js";import"../../core/JSONSupport.js";import"../../form/elements/inputs/attachments/AttachmentInput.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../chunks/Input.js";import"../../core/Clonable.js";import"../../form/elements/inputs/attachments/AudioInput.js";import"../../chunks/utils2.js";import"../../form/elements/inputs/attachments/DocumentInput.js";import"../../form/elements/inputs/attachments/ImageInput.js";import"../../form/elements/inputs/attachments/SignatureInput.js";import"../../form/elements/inputs/attachments/VideoInput.js";import"../../form/elements/FieldElement.js";import"../../form/elements/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../chunks/enumeration.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/elements/RelationshipElement.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../form/elements/TextElement.js";import"../../form/elements/UtilityNetworkAssociationsElement.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../chunks/layerUtils.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/utils7.js";import"../../chunks/basemapUtils.js";import"../../chunks/utils5.js";import"../../chunks/colorUtils.js";import"../../chunks/screenUtils.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../chunks/basemapDefinitions.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/dateUtils.js";import"../../chunks/mathUtils.js";import"../../chunks/formUtils2.js";let f;const k=["blockquote","html","hr","checkbox","table","tablerow","tablecell","image"];let x=class extends d{constructor(t){super(t),this.group=null,this.id=`TextElementInput-${o()}`,this.type="text",this._expressionReferences=new e,this._expressionsUsed=new r,this._fieldsUsed=new r,this._literalParts=new s,this._templateParts=new s,this._updatingHandles=new m}initialize(){const{rawText:t}=this;t?"markdown"===this.textFormat?this._updatingHandles.addPromise(async function(t){return f||await async function(){const{Marked:t}=await import("../../chunks/marked.esm.js"),s=()=>"",e={};for(const t of k)e[t]=s;f=new t({renderer:{del:function({text:t}){return`<span style="text-decoration:line-through;">${t}</span>`},link:function({href:t,text:s,title:e}){return`<a${null!=t?` href="${t}"`:""}${null!=e?` title="${e}"`:""} target="_blank">${s??""}</a>`},...e}})}(),f.parse(t)}(t).then(t=>this._initializeTextParts(t))):this._initializeTextParts(t):this._literalParts.push("")}get expressionsUsed(){return Array.from(this._expressionsUsed)}get fieldsIndex(){return this.layer.fieldsIndex}set fieldsIndex(t){this._overrideIfSome("fieldsIndex",t)}get fieldsUsed(){return Array.from(this._fieldsUsed)}get rawText(){return this.element.text}get text(){const t=this._templateParts.map(t=>`${this._expressionReferences.get(t)?.lastEvaluatedValue??""}`);return i.sanitize((s=this._literalParts,t.reduce((t,e,r)=>t.concat(s.at(r),e),"").concat(s.at(-1))));var s}get textFormat(){return this.element.textFormat}get updating(){return this._updatingHandles.updating||Array.from(this._expressionReferences.values()).some(t=>t?.updating)}setExpressionExecutor(t,s){this._expressionReferences.set(l(t),s)}setFieldExecutor(t,s){this._expressionReferences.set(u(t),s)}_initializeTextParts(t){const{fieldsIndex:s}=this,{literals:e,templates:r}=function(t){const s=[...t.matchAll(/{[^{]+?}/g)];let e=0;const r=[],i=[];for(const o of s){const s=o[0];r.push(t.slice(e,o.index)),i.push(s),e=o.index+s.length}return r.push(t.slice(e)),{literals:r,templates:i}}(t),i=[],o=[];for(let t=0;t<r.length;t++){const n=e[t],p=a(r[t])[0];if(c(p))this._expressionsUsed.add(h(p)),this._expressionReferences.set(p,null),i.push(n),o.push(p);else if(j(p)){this._expressionsUsed.add(p);const t=l(p);this._expressionReferences.set(t,null),i.push(n),o.push(t)}else if(s?.has(p)){const t=s.normalizeFieldName(p);this._fieldsUsed.add(t);const e=u(t);this._expressionReferences.set(e,null),i.push(n),o.push(e)}else e[t+1]=n.concat(p,e[t+1])}i.push(e.at(-1)),this._literalParts.addMany(i),this._templateParts.addMany(o)}};t([n()],x.prototype,"expressionsUsed",null),t([n()],x.prototype,"fieldsIndex",null),t([n()],x.prototype,"fieldsUsed",null),t([n()],x.prototype,"group",void 0),t([n()],x.prototype,"id",void 0),t([n()],x.prototype,"rawText",null),t([n()],x.prototype,"text",null),t([n()],x.prototype,"textFormat",null),t([n()],x.prototype,"type",void 0),t([n()],x.prototype,"updating",null),x=t([p("esri.widgets.FeatureForm.TextElementInput")],x);const g=x;export{g as default};
