/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{R as e}from"../../chunks/ReactiveMap.js";import{r as s}from"../../chunks/sanitizerUtils.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/Logger.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import{i,a as r}from"../../chunks/attachmentUtils.js";import a,{c}from"./Grid/Column.js";import"../../chunks/tracking.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/SimpleObservable.js";import"../../chunks/ObservableBase.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../chunks/get.js";import"../../chunks/metadata.js";import"../../core/Error.js";import"../../chunks/object.js";import"../../config.js";import"../../chunks/string.js";import"../../chunks/Lifecycle.js";import"../../chunks/Warning.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/jsonUtils.js";import"../../core/promiseUtils.js";import"../../chunks/events.js";import"../../chunks/maybe.js";import"../../chunks/persistableUrlUtils.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/ObjectPool.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../core/reactiveUtils.js";import"../../chunks/tableUtils.js";import"../../chunks/layerUtils.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/columnUtils.js";import"../../chunks/componentsUtils.js";import"../../chunks/uriUtils.js";import"../../chunks/widgetUtils.js";const l="esri-attachments-column",h={contentContainer:`${l}__content`,showAttachmentsButton:`${l}__button`};let m=class extends a{constructor(t){super(t),this._buttonElements=new e,this._thumbnailElements=new e,this.attachmentsViewEnabled=!0,this.cellValueFormatFunction=({root:t,rowData:e})=>{const{_showAttachmentsViewEnabled:s,formatFunction:n}=this,o=this.getCellValue(e);if(n&&e){const{index:s,item:{attachments:i,feature:r,relatedRecords:a}}=e;return n({attachments:i,column:this,feature:r,index:s,relatedRecords:a,value:o,virtualIndex:this.getVirtualRowIndex(t),field:void 0})}if(!e)return o;const{index:i,item:{attachments:r,objectId:a}}=e,c=`(${o})`;if(!this.thumbnailsEnabled&&!s)return o;const l=document.createElement("span");l.textContent=l.title=c;let m=null;if(this.thumbnailsEnabled&&(m=this._createOrSyncThumbnails(a,r??[])),this._showAttachmentsViewEnabled){const t=document.createElement("div");m&&t.appendChild(m),t.appendChild(l);const e=this._createOrSyncShowAttachmentsButton(a,i);return e.appendChild(t),e}const u=document.createElement("div");return u.classList.add(h.contentContainer),m&&u.appendChild(m),u.appendChild(l),u},this.icon="attachment",this.layer=null,this.onShowAttachments=null,this.sortable=!1,this.store=null,this.textAlign="center",this.thumbnailAppearance="image",this.thumbnailCount=8,this.thumbnailIconScale="m",this.thumbnailsEnabled=!0}get _showAttachmentsViewEnabled(){return!(!this.attachmentsViewEnabled||!this.onShowAttachments)}get _supportsResize(){return!!this.store?.supportsResizeAttachments}get effectiveLabel(){return s.sanitize(this.label??(this.messages?.attachments||this.fieldName))}getCellValue(t){return t?.item?.attachments?.length??0}_createOrSyncThumbnails(t,e){const s=document.createElement("div"),n=this._thumbnailElements.get(t);return n?.length&&n.length===e.length?n.forEach(t=>s.appendChild(t)):this._thumbnailElements.set(t,this._createThumbnailElements(e,s)),s}_createOrSyncShowAttachmentsButton(t,e){const s=this._buttonElements.get(t);if(s)return s.textContent="",s.onclick=s=>this._onShowAttachmentsClick({index:e,objectId:t,event:s}),s;const n=this.createCalciteButton({alignment:"icon-end-space-between",className:`${h.showAttachmentsButton} ${c.contentFull}`,iconEnd:"chevron-right",iconFlipRtl:"both",scale:this.thumbnailIconScale,textContent:"",title:this.messages?.viewAttachments,width:"full",onclick:s=>this._onShowAttachmentsClick({index:e,objectId:t,event:s})});return this._buttonElements.set(t,n),n}_createThumbnailAnchor({name:t,url:e},s){const n=document.createElement("a");return n.href=`${e}`,n.download=t,n.rel="noreferrer",n.target="_blank",n.appendChild(s),n}_createThumbnailElements(t,e){const{thumbnailAppearance:s,thumbnailCount:n,thumbnailIconScale:o}=this,a=[],c=Math.min(n,t.length),l=!this.onShowAttachments,h="image"===s&&!!this.store?.supportsResizeAttachments;for(let s=0;s<c;s++){const n=t[s],{name:c,contentType:m}=n,u=i(m)&&h?this._createThumbnailImage(n):this.createCalciteIcon({icon:r(m),scale:o,textLabel:c}),p=l?this._createThumbnailAnchor(n,u):u;e&&e.appendChild(p),a.push(p)}return a}_createThumbnailImage(t){const{name:e,size:s,url:n}=t,o=document.createElement("img"),i=`${n}${n?.includes("?")?"&":"?"}${this._supportsResize?"w=24":""}&fs=${s}`;return o.alt=this.messages?.attachmentThumbnail??e,o.src=i,o.title=e,o}_onShowAttachmentsClick({index:t,objectId:e,event:s}){s.preventDefault(),s.stopPropagation(),this.onShowAttachments?.({index:t,objectId:e})}};t([n()],m.prototype,"_showAttachmentsViewEnabled",null),t([n()],m.prototype,"_buttonElements",void 0),t([n()],m.prototype,"_supportsResize",null),t([n()],m.prototype,"_thumbnailElements",void 0),t([n()],m.prototype,"attachmentsViewEnabled",void 0),t([n()],m.prototype,"cellValueFormatFunction",void 0),t([n()],m.prototype,"effectiveLabel",null),t([n()],m.prototype,"icon",void 0),t([n()],m.prototype,"layer",void 0),t([n()],m.prototype,"onShowAttachments",void 0),t([n({readOnly:!0})],m.prototype,"sortable",void 0),t([n()],m.prototype,"store",void 0),t([n()],m.prototype,"textAlign",void 0),t([n()],m.prototype,"thumbnailAppearance",void 0),t([n()],m.prototype,"thumbnailCount",void 0),t([n()],m.prototype,"thumbnailIconScale",void 0),t([n()],m.prototype,"thumbnailsEnabled",void 0),m=t([o("esri.widgets.FeatureTable.AttachmentsColumn")],m);const u=m;export{u as default};
