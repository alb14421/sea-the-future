/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{c as t}from"../../chunks/asyncUtils.js";import s from"../../core/Collection.js";import r from"../../core/Error.js";import{EventedAccessor as o}from"../../core/Evented.js";import{L as i}from"../../chunks/Logger.js";import{a as n}from"../../chunks/maybe.js";import{whenOrAbort as a,throwIfAborted as p}from"../../core/promiseUtils.js";import{R as l}from"../../chunks/ReactiveMap.js";import{on as u,watch as m,sync as c,whenOnce as d}from"../../core/reactiveUtils.js";import{property as h}from"../../core/accessorSupport/decorators/property.js";import{q as f,i as y,N as j}from"../../core/lang.js";import{subclass as g}from"../../core/accessorSupport/decorators/subclass.js";import{U as b}from"../../chunks/UpdatingHandles.js";import x from"../../geometry/SpatialReference.js";import{u as v,s as k}from"../../chunks/constants.js";import"../../intl.js";import F from"../../core/Accessor.js";import{g as w}from"../../chunks/MapUtils.js";import{t as E}from"../../chunks/tracking.js";import{S as I}from"../../chunks/SimpleObservable.js";import{f as S,b as M,s as _,c as C,n as T}from"../../chunks/formUtils2.js";import{a as A}from"../../chunks/dateUtils.js";import{s as L}from"../../chunks/substitute.js";import{createArcadeProfile as V,createArcadeExecutor as U}from"../../arcade.js";import{T as P,D as R}from"../../chunks/TimeOnly.js";import{m as D,a as $,i as B}from"../../chunks/inputUtils.js";import{Q as O}from"../../chunks/Queue.js";import{b as H,l as G}from"../../chunks/SetUtils.js";import N from"./inputs/BatchFormInputs.js";import Z from"./inputs/FieldInput.js";import W from"./inputs/GroupInput.js";import{L as q}from"../../chunks/LayerContingentValuesCache.js";import{b as z,a as Q}from"../../chunks/layerUtils.js";import J from"../../form/ExpressionInfo.js";import{c as K,a as X}from"../../chunks/formUtils.js";import{getLowerCaseEditTrackingFields as Y,isFieldVisibleByDefault as ee}from"../../layers/support/fieldUtils.js";import{Clonable as te}from"../../core/Clonable.js";import{n as se}from"../../chunks/string.js";import"../../chunks/watch.js";import"../../chunks/ObjectPool.js";import"../../chunks/handleUtils.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/events.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/Lifecycle.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/ensureType.js";import"../../chunks/shared.js";import"../../chunks/jsonUtils.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/ObservableBase.js";import"../../chunks/Warning.js";import"../../core/JSONSupport.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/writer.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/datetime.js";import"../../chunks/number.js";import"../../chunks/messages.js";import"../../chunks/mathUtils.js";import"../../chunks/guards.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/support/AttachmentsOrderByInfo.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../core/sql.js";import"../../geometry/support/jsonUtils.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/Point.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/createFeatureId.js";import"../../chunks/typeUtils2.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils3.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils4.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/vec3f64.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/DoubleArray.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../chunks/lineMarkers.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/Font.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/arcadeEnvironment.js";import"../../chunks/enum.js";import"../../chunks/ImmutableArray.js";import"../../layers/FeatureLayer.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/layerContainerType.js";import"../../form/FormTemplate.js";import"../../form/elements/GroupElement.js";import"../../form/elements/Element.js";import"../../form/elements/AttachmentElement.js";import"../../form/elements/inputs/attachments/AttachmentInput.js";import"../../chunks/Input.js";import"../../form/elements/inputs/attachments/AudioInput.js";import"../../chunks/utils2.js";import"../../form/elements/inputs/attachments/DocumentInput.js";import"../../form/elements/inputs/attachments/ImageInput.js";import"../../form/elements/inputs/attachments/SignatureInput.js";import"../../form/elements/inputs/attachments/VideoInput.js";import"../../form/elements/FieldElement.js";import"../../form/elements/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/elements/RelationshipElement.js";import"../../form/elements/TextElement.js";import"../../form/elements/UtilityNetworkAssociationsElement.js";import"../../graphic/FeatureGraphicOrigin.js";import"../../graphic/GraphicOrigin.js";import"../../chunks/isFeatureGraphicOrigin.js";import"../../layers/Layer.js";import"../../time/TimeExtent.js";import"../../chunks/timeUtils.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../core/workers/RemoteClient.js";import"../../chunks/editsZScale.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils2.js";import"../../chunks/parser.js";import"../../chunks/utils5.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../layers/mixins/DisplayFilteredLayer.js";import"../../layers/support/DisplayFilterInfo.js";import"../../chunks/scaleUtils.js";import"../../layers/support/DisplayFilter.js";import"../../chunks/uuid.js";import"../../chunks/displayFilterUtils.js";import"../../chunks/EditBusLayer.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/ElevationInfo.js";import"../../symbols/support/FeatureExpressionInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../tables/AttributeTableTemplate.js";import"../../tables/elements/AttributeTableGroupElement.js";import"../../tables/elements/AttributeTableAttachmentElement.js";import"../../tables/elements/AttributeTableElement.js";import"../../tables/elements/AttributeTableFieldElement.js";import"../../tables/elements/AttributeTableRelationshipElement.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/featureQueryAll.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/commonProperties2.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../layers/catalog/catalogUtils.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../chunks/RendererLegendOptions.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/NormalizationBinParametersMixin.js";import"../../rest/support/RelationshipQuery.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../chunks/multiLayerServiceUtils.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../chunks/infoFor3D.js";import"../../layers/support/Subtype.js";import"../../chunks/portalItemUtils.js";import"../../chunks/projectionUtils.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/typeUtils3.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/support/ClassBreakInfo.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/DictionaryScriptEvaluator.js";import"../../chunks/Version.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/ArcadeExpression.js";import"../../chunks/utils6.js";import"../../chunks/defaultCIMValues.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../renderers/PieChartRenderer.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../layers/support/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../layers/support/TimeInfo.js";import"../../time/TimeInterval.js";import"../../layers/mixins/TrackableLayer.js";import"../../layers/support/TrackInfo.js";import"../../layers/support/TrackPartInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/TitleCreator.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/utils7.js";import"../../chunks/basemapUtils.js";import"../../chunks/basemapDefinitions.js";import"./inputs/EditableInput.js";import"./inputs/InputBase.js";import"../../chunks/featureFormUtils.js";const re=new WeakMap;class oe{constructor(){this._observables=new Map}get(e,t,s){const r=w(this._observables,t,()=>new I);return E(r),Reflect.get(e,t)}set(e,t,s,r){return Reflect.set(e,t,s),this._observables.get(t)?.notify(),!0}}let ie=class extends F{constructor(e){super(e),this.userChangesHaveMadeInvalid=!1,this.original=e.source.clone();const t=e.source.attributes??{},s=!(r={...t})||"__accessor__"in r?r:w(re,r,()=>new Proxy(r,new oe));var r;this.attributes=s;const o=e.source.cloneShallow();o.attributes=s,this.plainGraphic=o}get geometry(){return this.plainGraphic.geometry}set geometry(e){this.plainGraphic.geometry=e}get layer(){return this.source.sourceLayer??this.source.layer}attributeHasChanged(e){return!S(this.attributes[e],this.original.attributes?.[e])}getAttribute(e){return this.attributes[e]??null}setAttribute(e,t){this.attributes[e]=t}};e([h()],ie.prototype,"attributes",void 0),e([h()],ie.prototype,"geometry",null),e([h()],ie.prototype,"plainGraphic",void 0),e([h()],ie.prototype,"layer",null),e([h({constructOnly:!0})],ie.prototype,"original",void 0),e([h({constructOnly:!0})],ie.prototype,"source",void 0),e([h()],ie.prototype,"userChangesHaveMadeInvalid",void 0),ie=e([g("esri.widgets.BatchAttributeForm.ReactiveGraphic")],ie);const ne=(e,t)=>null!=e&&e.input?.type===t;function ae(e){return new ie({source:e})}function pe(e,t,s,r){const{dataType:o,minLength:i}=e,n=s?.validationErrors;if(!n||!t)return null;if("batch-attribute-form-validation::features-have-different-errors"===t)return n.invalidBatchFormType;if("input-validation-error::cannot-be-empty"===t)return n.cannotBeNull;if("domain-validation-error::value-out-of-range"===t||"numeric-range-validation-error::out-of-range"===t){const{field:t,range:s}=e,i={type:"date",intlOptions:{timeZone:"date"===t.type&&r?r:void 0,...A(t)}},a=M(s,n);return L(a,s,{format:{max:"date"===o?i:null!=s.max&&_(s.max)?C:T,min:"date"===o?i:null!=s.min&&_(s.min)?C:T}})}return"domain-validation-error::invalid-coded-value"===t?n.invalidCodedValue:"type-validation-error::invalid-type"===t?n.invalidType:"length-validation-error::too-short"===t?L(n.tooShort,{min:i}):null}function le(e,t,s){const r=s?.validationErrors;if(!r)return null;let o=null;for(const s of e.invalidHiddenInputs)switch(s.effectiveVisibilityCode){case"hidden:visibility-expression:all-features":case"hidden:group-visibility-expression:all-features":case"hidden:field-definition":return"single"===t?r.nonVisibleError_changeValues:r.nonVisibleError_checkIndividualFeatures;case"hidden:no-domain-in-common":case"hidden:visibility-expression:some-features":case"hidden:group-visibility-expression:some-features":case"hidden:not-in-all-layers":o=r.nonVisibleError_checkIndividualFeatures;break;case"visible":continue;default:f(s.effectiveVisibilityCode)}return o}const ue=V("form-calculation");class me{constructor(){this._executors=new Map,this._executorPromises=new Map}async getArcadeExecutor(e){return this._executors.has(e)?this._executors.get(e):this._executorPromises.has(e)?this._executorPromises.get(e):this._createExecutor(e)}async _createExecutor(e){try{const t=U(e,ue);this._executorPromises.set(e,t);const s=await t;return this._executors.set(e,s),s}finally{this._executorPromises.delete(e)}}}function ce(e){return"field"===e.type}function de(e){return"group"===e.type}let he=null,fe=class extends F{constructor(e){super(e),this.calculating=!1,this.arcadeContext=null,this._abortController=new AbortController,this.layerExpressionsModelMap=new Map,this.evaluatedExpressions=new l,this.expressionEvaluationFailed=!1}abort(){this._abortController.abort()}async runAllExpressions(e,t=!1){return this._evaluateSpecifiedComponentsForEachFeature(e,ge,t)}async runGeometryDependentExpressions(e,t=!1){return this._evaluateSpecifiedComponentsForEachFeature(e,be,t)}async valueChanged(e,t,s=!0){try{this.calculating=!0;const r=t.map(t=>this.evaluateValueChangedForFeature(e,t,s));await Promise.all(r)}catch(e){i.getLogger(this).error(e),this.expressionEvaluationFailed=!0}finally{this.calculating=!1}}async evaluateValueChangedForFeature(e,t,s){if(this._abortController.signal.aborted)return;const r=this.layerExpressionsModelMap.get(t.layer);if(!r||0===r.components.length)return;const o=new Set,i=new Set([e]),n=new Set;for(;i.size>0;){const[e]=i;if(i.delete(e),o.has(e))continue;o.add(e);const a=r.fieldReferencesMap.get(e.toLowerCase());if(!a)continue;for(const e of a)n.has(e)&&a.delete(e);if(0===a.size)continue;const p=new Set;await this.evaluateAffectedComponents([...a],t,r,s,p);for(const e of a)n.add(e);for(const e of p)o.has(e)||i.add(e)}}async evaluateAffectedComponents(e,t,s,r,o){const i=new Map;for(const r of e)i.has(r)||i.set(r,this.createSccEvaluator(r,t,i,s));if(0===i.size)return;const n=[...i.values()].map(e=>e.evaluate(r,o));await Promise.all(n)}createSccEvaluator(e,t,s,r){const o=new ye(e,t,this.arcadeContext,r,this.evaluatedExpressions,this._abortController);for(const i of e.adjacencyList)o.dependentEvaluators.push(w(s,i,()=>this.createSccEvaluator(i,t,s,r)));return o}async _evaluateSpecifiedComponentsForEachFeature(e,t,s=!1){this.calculating=!0;try{const r=[];for(const o of e){const e=this.layerExpressionsModelMap.get(o.layer);if(!e||0===e.components.length)continue;const i=new Set;r.push(this.evaluateAffectedComponents(t(e),o,e,s,i))}await a(Promise.all(r),this._abortController)}catch(e){i.getLogger(this).error(e),this.expressionEvaluationFailed=!0}finally{this.calculating=!1}}};e([h()],fe.prototype,"calculating",void 0),e([h({constructOnly:!0})],fe.prototype,"arcadeContext",void 0),e([h()],fe.prototype,"_abortController",void 0),e([h()],fe.prototype,"layerExpressionsModelMap",void 0),e([h()],fe.prototype,"evaluatedExpressions",void 0),e([h()],fe.prototype,"expressionEvaluationFailed",void 0),fe=e([g("esri.widgets.BatchAttributeForm.expressions.ExpressionsManager")],fe);class ye{constructor(e,t,s,r,o,i){this.scc=e,this.feature=t,this.arcadeContextInfo=s,this.expressionsModel=r,this.evaluatedExpressions=o,this._abortController=i,this.dependentEvaluators=[],this._evaluatorPromise=null}get baseContext(){const{editType:e,map:t,spatialReference:s,timeZone:r}=this.arcadeContextInfo,o=this.feature.layer,i="scene"===o?.type&&null!=o.associatedLayer?o.associatedLayer:o;return{variables:{$originalfeature:this.feature.original,$editcontext:{editType:e},$layer:i,$featureset:i,$datastore:i?.url,$feature:this.feature.plainGraphic,$map:t},executeContext:{rawOutput:!0,spatialReference:s??void 0,timeZone:r,abortSignal:this._abortController.signal}}}evaluate(e,t){return null==this._evaluatorPromise&&(this._evaluatorPromise=this._evaluate(e,t)),this._evaluatorPromise}async _evaluate(e,t){null===he&&(he=await import("../../chunks/languageUtils.js").then(e=>e.aa));const s=this.dependentEvaluators.map(s=>s.evaluate(e,t));await a(Promise.all(s),this._abortController);for(const s of this.scc.executors){const o=this.baseContext;if(this._abortController.signal.aborted)break;const i=this.expressionsModel.arcadeExecutorUses.get(s)??[],n=w(this.evaluatedExpressions,this.feature,()=>new l);let a=null,p=null;try{a=s.isAsync?await s.executeAsync(o.variables,o.executeContext):s.execute(o.variables,o.executeContext),p={result:a,status:"success"}}catch(e){p={error:e,status:"error"}}for(const s of i){const r=this.expressionsModel.elementTemplateMap.get(s.elementId);switch(s.executorPurpose){case"editable":case"required":n.set(D(s.elementId,s.executorPurpose),p);break;case"value":{if("error"===p?.status)continue;const e=r.getExpressionExecutorsForLayer(this.feature.layer);let s=!0;if(e?.editableExpression&&(s=!1===n.get(D(r.elementId,"editable"))?.result),s){const e=this.feature.getAttribute(r.fieldName)??null,s=je(p.result,this.feature,r.fieldName,this.arcadeContextInfo.timeZone);s!==e&&(this.feature.setAttribute(r.fieldName,s),t.add(r.fieldName))}}break;case"visibility":if(n.set(D(s.elementId,s.executorPurpose),p),!this.expressionsModel.preserveFieldValuesWhenHidden&&!1===p.result&&e)if(de(r))for(const e of r.elements)ce(e)&&(null!==this.feature.getAttribute(e.fieldName)&&t.add(e.fieldName),this.feature.setAttribute(e.fieldName,null));else ce(r)&&(null!==this.feature.getAttribute(r.fieldName)&&t.add(r.fieldName),this.feature.setAttribute(r.fieldName,null))}}if("error"===p?.status){const e=new Set;for(const t of i){const s=this.expressionsModel.elementTemplateMap.get(t.elementId);if(s)switch(t.executorPurpose){case"editable":e.add(s.label+" - Editable expression");break;case"required":e.add(s.label+" - Required expression");break;case"value":e.add(s.label+" - Value expression");break;case"visibility":e.add(s.label+" - Visibility expression")}}if(e.size>0)throw new r("expression-evaluation-failed","Arcade evaluation failed ("+[...e].join(",")+")");throw new r("expression-evaluation-failed","Arcade evaluation failed ")}}}}function je(e,t,s,o){if(null===e)return null;const i=t.layer.fieldsIndex.get(s);if(!i)throw new r("field-not-found","Unable set field value as the field cannot be found. ("+s+")");switch(i.type){case"big-integer":case"integer":case"long":case"oid":case"small-integer":case"single":case"double":return he.toNumber(e);case"global-id":case"guid":case"string":return he.toString(e);case"date":{if(he.isDate(e))return e.getTime();const t=he.toDate(e,o);if(!t)throw new r("unsupported-value-type","Arcade return type is not a supported field type. ("+s+")");return t.getTime()}case"date-only":{if(he.isDateOnly(e))return e.toStorageFormat();if(he.isDate(e))return R.fromDateTime(e.toDateTime()).toStorageFormat();const t=R.fromString(he.toString(e));if(!t)throw new r("unsupported-value-type","Arcade return type is not a supported field type.");return t.toStorageFormat()}case"time-only":{if(he.isTime(e))return e.toStorageString();if(he.isDate(e))return P.fromDateTime(e.toDateTime()).toStorageString();const t=P.fromString(he.toString(e));if(!t)throw new r("unsupported-value-type","Arcade return type is not a supported field type.");return t.toStorageString()}case"timestamp-offset":{if(he.isDate(e))return e.toISOString(!1);const t=he.toDate(e,o);if(!t)throw new r("unsupported-value-type","Arcade return type is not a supported field type. ("+s+")");return t.toISOString(!1)}}throw new r("unsupported-value-type","Arcade return type is not a supported field type. ("+s+")")}function ge(e){return e.components}function be(e){return Array.from(e.geometryReferences)}let xe=0;class ve{constructor(e){this.arcadeExecutorUses=new Map,this.components=[],this.preserveFieldValuesWhenHidden=!1,this.executorMap=e.executorMap,this.preserveFieldValuesWhenHidden=!0===e.preserveFieldValuesWhenHidden,this.elementTemplateMap=new Map;for(const e of this.executorMap.keys())this.elementTemplateMap.set(e.elementId,e);this._buildDependencyGraph()}_buildDependencyGraph(){const e=function(e){const t=Array.from(e.values()).filter(y),s=new Set(t.flatMap(e=>Array.from(Object.values(e)))),r=Array.from(s).map(e=>({component:null,crossLinkNeighbors:new Set,executor:e,index:-1,lowlink:-1,onStack:!1}));return new Map(r.map(e=>[e.executor,e]))}(this.executorMap),t={components:[],arcadeExecutorUses:this.arcadeExecutorUses,elementTemplatesById:new Map([...this.executorMap.keys()].map(e=>[e.elementId,e])),executorMap:this.executorMap,fieldElementTemplateMap:we(this.executorMap),fieldReferencesMap:new Map,geometryReferences:new Set,nextIndex:0,nodeInfoMap:e,nodeStack:new O(G),shouldConsiderVisibility:!this.preserveFieldValuesWhenHidden};for(const e of this.executorMap.keys()){const t=this.executorMap.get(e);t.editableExpression&&w(this.arcadeExecutorUses,t.editableExpression,()=>[]).push({elementId:e.elementId,executorPurpose:"editable"}),t.valueExpression&&w(this.arcadeExecutorUses,t.valueExpression,()=>[]).push({elementId:e.elementId,executorPurpose:"value"}),t?.visibilityExpression&&w(this.arcadeExecutorUses,t.visibilityExpression,()=>[]).push({elementId:e.elementId,executorPurpose:"visibility"}),t?.requiredExpression&&w(this.arcadeExecutorUses,t.requiredExpression,()=>[]).push({elementId:e.elementId,executorPurpose:"required"})}for(const e of this.arcadeExecutorUses.values())e.sort(e=>"editable"===e.executorPurpose?-1:1);for(const s of e.values())-1===s.index&&ke(s,t);this.dependencyGraphComponents=function(e){return new Map([...e.values()].map(({component:e,executor:t})=>[t,e]))}(t.nodeInfoMap),this.fieldReferencesMap=function({fieldReferencesMap:e,nodeInfoMap:t}){const s=new Map;for(const[r,o]of e.entries())s.set(r,Ee(o,t));return s}(t),this.geometryReferences=function({geometryReferences:e,nodeInfoMap:t}){return Ee(e,t)}(t),this.components=t.components}}function ke(e,t){e.index=e.lowlink=t.nextIndex++,t.nodeStack.push(e);for(const s of function({executor:e},t){const s=new Set;for(const r of e.fieldsUsed){const o=r.toLowerCase();w(t.fieldReferencesMap,o,()=>new Set).add(e),H(s,Fe(o,t))}e.geometryUsed&&t.geometryReferences.add(e);const r=t.arcadeExecutorUses.get(e)?.filter(e=>"value"===e.executorPurpose)??[];for(const o of r){const r=t.executorMap.get(t.elementTemplatesById.get(o.elementId));r?.editableExpression&&r.editableExpression!==e&&s.add(r.editableExpression)}return Array.from(s).map(e=>t.nodeInfoMap.get(e)).filter(y)}(e,t))-1===s.index?(ke(s,t),e.lowlink=Math.min(e.lowlink,s.lowlink)):s.index<e.index&&t.nodeStack.contains(s)&&(e.lowlink=Math.min(e.lowlink,s.index)),t.nodeStack.contains(s)||e.crossLinkNeighbors.add(s);if(e.lowlink===e.index){const s=function(){xe++;const e=xe.toString();return{executors:new Set,adjacencyList:new Set,componentId:e}}();for(t.components.push(s);Ie(t.nodeStack)>=e.index;){const e=t.nodeStack.pop();if(null!=e){e.component=s,s.executors.add(e.executor);for(const t of e.crossLinkNeighbors)null!=t.component&&s.adjacencyList.add(t.component)}}}}function Fe(e,{executorMap:t,fieldElementTemplateMap:s,shouldConsiderVisibility:r}){const o=[],i=s.get(e);if(null==i)return o;const n=t.get(i);if(null==n)return o;if(j(o,n.editableExpression),j(o,n.valueExpression),r){j(o,n?.visibilityExpression);const{group:e}=i;if(null!=e){const s=t.get(e)?.visibilityExpression;j(o,s)}}return o}function we(e){const t=new Map;for(const s of e.keys())ce(s)&&t.set(s.fieldName.toLowerCase(),s);return t}function Ee(e,t){const s=new Set;for(const r of e){const e=t.get(r);e?.component&&s.add(e.component)}return s}function Ie(e){return e.peek()?.index??-1}function Se(e,t,s){const r=e.elements.map(e=>Me(e,t,s));return new N({inputs:r,template:e})}function Me(e,t,s){const o=new Set(e.layers),i=t.filter(e=>o.has(e.layer)),n=i.length===t.length;if(ce(e))return new Z({existsInAllLayers:n,features:i,template:e,expressionsManager:s});if(de(e)){const r=e.elements.map(e=>Me(e,t,s));return new W({existsInAllLayers:n,features:i,inputs:r,template:e,expressionsManager:s})}throw new r("batch-attribute-form:unsupported-element-template","The type of form element template provided is not supported")}let _e=class extends F{constructor(e){super(e),this.description=null,this.preserveFieldValuesWhenHidden=!1,this.title=null}get elementsFlat(){const e=[];for(const t of this.elements)if(e.push(t),de(t))for(const s of t.elements)e.push(s);return e}get elementsInCommon(){const e=this.layers.length;return this.elements.filter(t=>t.layers.length===e)}get layers(){const e=new Set(this.elements.flatMap(e=>e.layers));return Array.from(e)}getExpressionExecutorsForLayer(e){const t=new Map;for(const s of this.elementsFlat)s.layers.includes(e)&&t.set(s,s.getExpressionExecutorsForLayer(e));return t}};e([h()],_e.prototype,"description",void 0),e([h()],_e.prototype,"elements",void 0),e([h()],_e.prototype,"elementsFlat",null),e([h()],_e.prototype,"elementsInCommon",null),e([h()],_e.prototype,"layers",null),e([h()],_e.prototype,"preserveFieldValuesWhenHidden",void 0),e([h()],_e.prototype,"title",void 0),_e=e([g("esri.widgets.BatchAttributeForm.templates.BatchFormTemplate")],_e);const Ce=_e,Te=new Map;async function Ae(e){if(!(e=z(e)?e.parent:"feature"===e?.type?e:null))return null;const t=w(Te,e,()=>{const t=q.createLoadedLayerContingentValuesCache(e);return e.addHandles({remove(){Te.delete(e)}}),t});return await t??null}async function Le({element:e,expressionInfos:t,provider:s}){const r={};if(e.visibilityExpression){const o=t.get(e.visibilityExpression);r.visibilityExpression=o?await s.getArcadeExecutor(o.expression):void 0}if("editableExpression"in e&&e.editableExpression){const o=t.get(e.editableExpression);r.editableExpression=o?await s.getArcadeExecutor(o.expression):void 0}if("requiredExpression"in e&&e.requiredExpression){const o=t.get(e.requiredExpression);r.requiredExpression=o?await s.getArcadeExecutor(o.expression):void 0}if("valueExpression"in e&&e.valueExpression){const o=t.get(e.valueExpression);r.valueExpression=o?await s.getArcadeExecutor(o.expression):void 0}return r}const Ve="";function Ue(e){return ce(e)?se((s=e,`${Pe(s)}.${function(e){const t=e.name,s=e.alias??Ve;return`${t}.${s===t?Ve:s}.${e.nullable}.${e.type}.${e.length??Ve}.${e.defaultValue??Ve}.${e.description??Ve}.${e.editable}.${e.visible}`}(s.field)}.${t=s.domain,t?"coded-value"===t.type?function(e){const{type:t}=e;return`${t}.${e.codedValues.map(({code:e,name:t})=>`${De(e)}.${t}`).sort().join(".")}`}(t):"range"===t.type?function(e){const{maxValue:t,minValue:s,type:r}=e;return`${r}.${s}.${t}`}(t):JSON.stringify(t):Ve}.${s.hint??Ve}.${function(e){if(!e)return Ve;const{type:t}=e;if(function(e){return"barcode-scanner"===e.type}(e))return t??Ve;if(function(e){return"combo-box"===e.type}(e)||function(e){return"radio-buttons"===e.type}(e)){const{showNoValueOption:s}=e;return`${t}.${s}.${e.noValueOptionLabel??Ve}`}if(function(e){return"date-picker"===e.type}(e))return`${t}.${Re(e)}`;if(function(e){return"datetime-picker"===e.type}(e)){const s=e.min?.getTime(),r=e.max?.getTime(),{includeTime:o}=e;return`${t}.${s}.${r}.${o}`}if(function(e){return"datetimeoffset-picker"===e.type}(e)){const s=Re(e),{includeTimeOffset:r,timeResolution:o}=e;return`${t}.${s}.${r}.${o}`}if(function(e){return"switch"===e.type}(e)){const{offValue:s,onValue:r}=e;return`${t}.${De(s)}.${De(r)}`}if(function(e){return"text-area"===e.type}(e)||function(e){return"text-box"===e.type}(e))return`${t}.${e.minLength?.toString()??Ve}.${e.maxLength?.toString()??Ve}`;if(function(e){return"time-picker"===e.type}(e)){const s=Re(e),{timeResolution:r}=e;return`${t}.${s}.${r}`}return JSON.stringify(e)}(s.input)}.${s.layerTimeZone??""}`)).toString():de(e)?se(function(e){const t=Pe(e)+`.${e.initialState}`;let s=Ve;for(const t of e.elements)s+="."+Ue(t).toString();return`${t}${s}`}(e)).toString():se(JSON.stringify(e)).toString();var t,s}function Pe(e){return`${e.label??Ve}.${e.description??Ve}`}function Re(e){return`${e.min??Ve}.${e.max??Ve}`}function De(e){return"number"==typeof e?`num:${e}`:e}let $e=class extends te{constructor(e){super(e),this.description=null,this.label=null,this._expressionExecutorsByLayer=new l}get elementId(){return Ue(this)}get layers(){return Array.from(this._expressionExecutorsByLayer.keys())}addLayer(e,t=null){this._expressionExecutorsByLayer.set(e,t)}foldIn(e){for(const t of e.layers)this.addLayer(t,e.getExpressionExecutorsForLayer(t))}getExpressionExecutorsForLayer(e){return this._expressionExecutorsByLayer.get(e)??null}};e([h()],$e.prototype,"description",void 0),e([h({readOnly:!0})],$e.prototype,"elementId",null),e([h()],$e.prototype,"label",void 0),e([h({readOnly:!0})],$e.prototype,"layers",null),e([h({readOnly:!0})],$e.prototype,"type",void 0),e([h({clonable:e=>new l(Array.from(e))})],$e.prototype,"_expressionExecutorsByLayer",void 0),$e=e([g("esri.widgets.BatchAttributeForm.templates.ElementTemplateBase")],$e);let Be=class extends $e{constructor(e){super(e),this.domain=null,this.group=null,this.hint=null,this.input=null,this.type="field",this.layerTimeZone=null,this.formTimeZone=null}get fieldName(){return this.field.name}get hasValueCalculations(){for(const e of this.layers){const t=this.getExpressionExecutorsForLayer(e);if(t?.valueExpression)return!0}return!1}};e([h({clonable:"reference"})],Be.prototype,"domain",void 0),e([h({clonable:"reference",constructOnly:!0})],Be.prototype,"field",void 0),e([h()],Be.prototype,"fieldName",null),e([h({clonable:!1})],Be.prototype,"group",void 0),e([h()],Be.prototype,"hint",void 0),e([h()],Be.prototype,"input",void 0),e([h()],Be.prototype,"type",void 0),e([h()],Be.prototype,"layerTimeZone",void 0),e([h()],Be.prototype,"formTimeZone",void 0),e([h()],Be.prototype,"hasValueCalculations",null),Be=e([g("esri.widgets.BatchAttributeForm.templates.FieldElementTemplate")],Be);let Oe=class extends $e{constructor(e){super(e),this.initialState="expanded",this.type="group"}initialize(){for(const e of this.elements)e.group=this}foldIn(e){const{elements:t}=this,s=e.elements;if(t.length!==s.length)throw new r("unable-to-fold-in","Unable to fold in the given GroupElementTemplate because it has a different number of child elements");for(const r of e.layers){this.addLayer(r,e.getExpressionExecutorsForLayer(r));for(let e=0;e<t.length;e++)t.at(e).foldIn(s.at(e))}}};e([h()],Oe.prototype,"initialState",void 0),e([h({constructOnly:!0})],Oe.prototype,"elements",void 0),e([h()],Oe.prototype,"type",void 0),Oe=e([g("esri.widgets.BatchAttributeForm.templates.GroupElementTemplate")],Oe);const He="expression/dea57012-47ca4b55a000-8df62742ed0c",Ge=()=>i.getLogger("esri.widgets.BatchAttributeForm.templates.templateUtils");async function Ne(e,t){return e.formTemplate?.elements&&e.formTemplate?.elements.length>0?async function(e,t){const s=e.formTemplate;if(!s)return Ze(e,t);let r=null;We(s.elements??[],e)&&(r=new J({title:"",name:He,expression:"false"}));const o=function(e){return new Map(e?.map(e=>[e.name,e]))}(r?[...s.expressionInfos??[],r]:s.expressionInfos),i={description:s.description,elements:new Array,title:s.title,preserveFieldValuesWhenHidden:s.preserveFieldValuesWhenHidden},{elements:n}=s;if(!n)return new Ce(i);const{arcadeExecutorProvider:a,formTimeZone:p}=t;for(const t of n){const s=await qe(t,{arcadeExecutorProvider:a,expressionInfos:o,layer:e,formTimeZone:p});s&&i.elements.push(s)}return new Ce(i)}(e,t):Ze(e,t)}async function Ze(e,{arcadeExecutorProvider:t,formTimeZone:s}){const r=new Set(Y(e)),o={arcadeExecutorProvider:t,formTimeZone:s,layer:e},i=[];for(const t of e.fields)Qe(t,e,r)&&i.push(ze(t,o));const n=await Promise.all(i);return new Ce({elements:n,preserveFieldValuesWhenHidden:!0})}function We(e,t){for(const s of e??[])if("group"!==s.type){if("field"===s.type){if(!1===s.editable&&!s.editableExpression)return!0;if(t.subtypeField&&(z(t)||Q(t))&&s.fieldName?.toLowerCase()===t.subtypeField.toLowerCase())return!0}}else if(We(s.elements??[],t))return!0;return!1}async function qe(e,t){return K(e)?async function(e,{arcadeExecutorProvider:t,expressionInfos:s,layer:o,formTimeZone:i}){const{fieldsIndex:n}=o,{description:a,domain:p,fieldName:l,hint:u,input:m,label:c}=e;if(null==l||!n.has(l))return Ge().warn(new r("batch-attribute-form:invalid-form-element-field",`Field element with label '${c}' does not refer to a valid field`)),null;const d={description:a,domain:p,field:n.get(l),hint:u,input:m,formTimeZone:i,layerTimeZone:Je(o),label:c};!1!==e.editable||e.editableExpression||((e=e.clone()).editableExpression=He),o.subtypeField&&(z(o)||Q(o))&&e.fieldName?.toLowerCase()===o.subtypeField.toLowerCase()&&((e=e.clone()).editableExpression=He);const h=new Be(d),f=await Le({element:e,expressionInfos:s,provider:t});return h.addLayer(o,f),h}(e,t):X(e)?async function(e,t){const{arcadeExecutorProvider:s,expressionInfos:r,layer:o}=t,{description:i,label:n,initialState:a}=e,p={description:i,elements:[],label:n,initialState:a??"expanded"};for(const s of e.elements){const e=await qe(s,t);e&&p.elements.push(e)}const l=new Oe(p),u=await Le({element:e,expressionInfos:r,provider:s});return l.addLayer(o,u),l}(e,t):(Ge().warn(new r("batch-attribute-form:unsupported-element-type",`Form elements of type ${e.type} are not supported`)),null)}async function ze(e,{arcadeExecutorProvider:t,layer:s,formTimeZone:r}){const o=new Be({field:e,label:e.alias??e.name,formTimeZone:r,layerTimeZone:Je(s)}),i={},n=(Q(s)||z(s))&&s.subtypeField&&s.subtypeField.toLowerCase()===e.name.toLowerCase();return!n&&e.editable&&s.userHasUpdateItemPrivileges&&(i.editableExpression=await t.getArcadeExecutor("true")),n&&(i.editableExpression=await t.getArcadeExecutor("false")),o.addLayer(s,i),o}function Qe(e,t,s){return!s.has(e.name.toLowerCase())&&ee(e,t)}function Je(e){return z(e)&&e.parent&&(e=e.parent),e&&"datesInUnknownTimezone"in e&&e.datesInUnknownTimezone?v:e&&"preferredTimeZone"in e&&e.preferredTimeZone?e.preferredTimeZone:null}let Ke=class extends o{constructor(e){super(e),this.activeFeatureIndex=-1,this.disabled=!1,this.editType="NA",this.features=new s,this._hasAsyncArcadeExpressions=!1,this.maximumFeatureCountWithComplexForms=50,this.maximumFeatureCount=2e3,this.map=null,this.readOnly=!1,this.spatialReference=null,this.submitHasBeenAttempted=!1,this.timeZone=null,this.userHasChangedValues=!1,this._arcadeExecutorProvider=new me,this._activeFormInputsByElementId=new Map,this._emptyForm=new N({inputs:[]}),this._emptyFormTemplate=new Ce({elements:[]}),this._featureFormMap=new Map,this._prepareTask=null,this._reactiveGraphicLookup=new l,this._updatingHandles=new b,this._layerTemplateMap=new l,this._layerContingentValuesMap=new l,this._workingFeatures=new s,this._expressionsManager=new fe({arcadeContext:{editType:"NA",spatialReference:null,map:null,timeZone:k}}),this.sharedForm=this._emptyForm,this.sharedFormTemplate=this._emptyFormTemplate}initialize(){this.addHandles([u(()=>this.features,"after-changes",()=>this._prepare(),{sync:!0}),m(()=>[this.features,this.map,this.timeZone,this.editType],()=>this._prepare(),c),m(()=>this.activeForm,()=>this._activeFormInputsByElementId.clear(),c)]),this._prepare()}destroy(){this._prepareTask=n(this._prepareTask),this._workingFeatures.destroyAll(),this._expressionsManager&&this._expressionsManager.abort(),this._reactiveGraphicLookup=new l,this._emptyForm.destroy(),this._emptyFormTemplate.destroy()}get _effectiveTimeZone(){return this.timeZone??"system"}get activeFeature(){const e=this.activeFeatureIndex;return e<0?null:this.features.at(e)}get activeForm(){if("batch"===this.mode)return this.sharedForm;const e=this._workingFeatures.at(this.activeFeatureIndex);if(!e)return this._emptyForm;const t=this._featureFormMap.get(e);if(t)return t;const s=this._makeBatchFormInputsForFeature(e);return s!==this._emptyForm&&this._featureFormMap.set(e,s),s}get calculating(){return this._expressionsManager.calculating}get expressionEvaluationFailed(){return this._expressionsManager.expressionEvaluationFailed}get hasNonActiveInvalidFeatures(){if("batch"===this.mode)return!1;const{activeFeature:e}=this;return this.invalidFeatures.some(t=>t!==e)}get hasAsyncArcadeExpressions(){return this._hasAsyncArcadeExpressions}get hasTooManyFeatures(){return this._workingFeatures.length>this.maximumFeatureCount}get hasTooManyComplexFeatures(){return this._workingFeatures.length>this.maximumFeatureCountWithComplexForms&&this.hasAsyncArcadeExpressions}get invalidFeatures(){return this.sharedForm.invalidFeatures}get hasVisibleInputs(){return this.visibleInputs.length>0}get hasLayersWithContingentValues(){for(const e of this.layers){const t=this._layerContingentValuesMap.get(e);if(t&&t.size>0)return!0}return!1}get visibleInputs(){return this.activeForm.inputs.filter(e=>e.visible)}get noVisibleElementsReason(){if(this.hasVisibleInputs)return null;if(0===this.activeForm.inputs.length)return"noElements";const e=new Set;for(const t of this.activeForm.inputs)switch(t.visibilityCode){case"hidden:not-in-all-layers":case"hidden:no-domain-in-common":e.add("noElementsInCommon");break;case"hidden:field-definition":case"hidden:group-visibility-expression:all-features":case"hidden:visibility-expression:all-features":e.add("allElementsHidden");break;case"hidden:group-visibility-expression:some-features":case"hidden:visibility-expression:some-features":return"elementsHiddenInSome"}return e.has("allElementsHidden")?"allElementsHidden":"noElementsInCommon"}get status(){const e=this._prepareTask;return null==e?"not-loaded":e.finished?null!=e.error?"failed":"loaded":"loading"}get submittable(){return this.valid,!0}get updating(){return this._updatingHandles.updating||this.calculating}get valid(){return this.sharedForm.valid}get layers(){const e=new Set;return this.features.forEach(t=>{const s=t.sourceLayer??t.layer;e.add(s)}),Array.from(e)}get mode(){return this.activeFeatureIndex>-1?"single":"batch"}submit(){this.submitHasBeenAttempted=!0,this.emit("submit",{name:"submit",results:this._makeSubmitResults(),valid:this.valid})}findFieldInput(e){if(null==e)return;const t=this._activeFormInputsByElementId;if(t.has(e))return t.get(e);const s=this.activeForm.allFieldInputs.find(t=>t.template.elementId===e);return void 0!==s?(t.set(e,s),s):void 0}getFirstVisibleInvalidFieldInput(){if(this.hasVisibleInputs&&!this.activeForm.valid)for(const e of this.visibleInputs){if($(e)){const t=e.inputs.find(e=>!e.valid);if(t)return{input:t,groupInput:e}}if(B(e)&&!e.valid)return{input:e}}}getFieldInputValue(e){return this.findFieldInput(e)?.value}getValues(e){const t=this._reactiveGraphicLookup.get(e);if(!t)throw new r("feature-not-found","The given feature is not present in the BatchAttributeForm");return{...t.attributes}}notifyGeometriesChanged(e){const t=[];for(const s of e){const e=this._reactiveGraphicLookup.get(s);e&&(t.push(e),e.geometry=s.geometry)}this._expressionsManager.runGeometryDependentExpressions(t)}async setFieldInputValue(e,t){const s=new Set(this.invalidFeatures);await e.setValueFromUser(t),this.userHasChangedValues=!0,this._trackValidityChange(s),this.emit("value-change",{features:e.features.toArray().map(e=>e.source),fieldName:e.fieldName,name:"value-change",value:t})}async setValue(e,t){const s=this.findFieldInput(e);if(null==s)throw new r("no-FieldInput-found",`Cannot set the value of FieldInput with ID: ${e} because none was found in the active form`);await this.setFieldInputValue(s,t)}userChangesHaveMadeFeatureInvalid(e){return!!this._reactiveGraphicLookup.get(e)?.userChangesHaveMadeInvalid}async _trackValidityChange(e){await d(()=>!1===this.calculating);const t=this.invalidFeatures;for(const s of t)!1===e.has(s)&&this._reactiveGraphicLookup.has(s)&&(this._reactiveGraphicLookup.get(s).userChangesHaveMadeInvalid=!0)}validate(){return!1}_makeBatchFormInputsForFeature(e){const t=this._layerTemplateMap.get(e.layer);return t?Se(t,new s([e]),this._expressionsManager):this._emptyForm}_makeSubmitResults(){const e=new Map;for(const[t,s]of this._reactiveGraphicLookup)e.set(t,{feature:t,values:{...s.attributes},invalidFields:[]});for(const t of this.sharedForm.allFieldInputs)for(const s of t.invalidFeatures)e.get(s)?.invalidFields.push(t.fieldName);return Array.from(e.values())}_prepare(){this._hasAsyncArcadeExpressions=!1,this._prepareTask=n(this._prepareTask),this._updateWorkingFeatures(),n(this._expressionsManager),this.userHasChangedValues=!1,this._expressionsManager=new fe({arcadeContext:{editType:this.editType,spatialReference:this.spatialReference??x.WebMercator,map:this.map,timeZone:this._effectiveTimeZone}});const{layers:e}=this;if(0===e.length)return;const s=t(async t=>{try{p(t);const s=new Map;for(const t of e){const e=await Ae(t);if(e){const s=e.fieldGroups.flatMap(e=>e.fields);this._layerContingentValuesMap.set(t,new Set(s))}else this._layerContingentValuesMap.set(t,new Set);const r=await Ne(t,{arcadeExecutorProvider:this._arcadeExecutorProvider,formTimeZone:this._effectiveTimeZone});this._layerTemplateMap.set(t,r);const o=r.getExpressionExecutorsForLayer(t);if(this._expressionsManager.layerExpressionsModelMap.set(t,new ve({preserveFieldValuesWhenHidden:r.preserveFieldValuesWhenHidden,executorMap:o})),!this._hasAsyncArcadeExpressions)for(const e of o.keys()){const t=o.get(e);if(this._hasAsyncArcadeExpressions=!0===(t.editableExpression?.isAsync||t.requiredExpression?.isAsync||t.valueExpression?.isAsync||t.visibilityExpression?.isAsync),this._hasAsyncArcadeExpressions)break}for(const e of r.elements){const{elementId:t}=e;s.has(t)?s.get(t).foldIn(e):s.set(t,e.clone())}}if(this.hasTooManyComplexFeatures)throw new r("too-many-features-with-complex-forms","There are too many features to load into the form with the configured complexity");if(this.hasTooManyFeatures)throw new r("too-many-features","There are too many features to load into the form.");const o=new Ce({elements:Array.from(s.values())});this.sharedFormTemplate=o,this.sharedForm=Se(o,this._workingFeatures,this._expressionsManager),await this._expressionsManager.runAllExpressions(this._workingFeatures.toArray())}catch(e){throw i.getLogger(this).error("Failed preparing form",e),e}});this._updatingHandles.addPromise(s.promise),this._prepareTask=s}_updateWorkingFeatures(){this._workingFeatures.destroyAll();const{features:e}=this;if(this._reactiveGraphicLookup=new l,0!==e.length){this._workingFeatures.addMany(e.map(ae));for(const e of this._workingFeatures)this._reactiveGraphicLookup.set(e.source,e)}}};e([h()],Ke.prototype,"_effectiveTimeZone",null),e([h({readOnly:!0})],Ke.prototype,"activeFeature",null),e([h()],Ke.prototype,"activeFeatureIndex",void 0),e([h({readOnly:!0})],Ke.prototype,"activeForm",null),e([h()],Ke.prototype,"disabled",void 0),e([h()],Ke.prototype,"calculating",null),e([h()],Ke.prototype,"editType",void 0),e([h()],Ke.prototype,"features",void 0),e([h()],Ke.prototype,"expressionEvaluationFailed",null),e([h()],Ke.prototype,"hasNonActiveInvalidFeatures",null),e([h()],Ke.prototype,"hasAsyncArcadeExpressions",null),e([h()],Ke.prototype,"_hasAsyncArcadeExpressions",void 0),e([h()],Ke.prototype,"invalidFeatures",null),e([h()],Ke.prototype,"hasVisibleInputs",null),e([h()],Ke.prototype,"hasLayersWithContingentValues",null),e([h()],Ke.prototype,"maximumFeatureCountWithComplexForms",void 0),e([h()],Ke.prototype,"maximumFeatureCount",void 0),e([h()],Ke.prototype,"visibleInputs",null),e([h()],Ke.prototype,"map",void 0),e([h()],Ke.prototype,"noVisibleElementsReason",null),e([h()],Ke.prototype,"readOnly",void 0),e([h()],Ke.prototype,"spatialReference",void 0),e([h()],Ke.prototype,"submitHasBeenAttempted",void 0),e([h()],Ke.prototype,"timeZone",void 0),e([h()],Ke.prototype,"updating",null),e([h()],Ke.prototype,"valid",null),e([h()],Ke.prototype,"layers",null),e([h()],Ke.prototype,"mode",null),e([h()],Ke.prototype,"sharedForm",void 0),e([h()],Ke.prototype,"sharedFormTemplate",void 0),e([h()],Ke.prototype,"userHasChangedValues",void 0),e([h()],Ke.prototype,"_arcadeExecutorProvider",void 0),e([h()],Ke.prototype,"_prepareTask",void 0),e([h()],Ke.prototype,"_reactiveGraphicLookup",void 0),e([h()],Ke.prototype,"_layerTemplateMap",void 0),e([h()],Ke.prototype,"_layerContingentValuesMap",void 0),e([h()],Ke.prototype,"_workingFeatures",void 0),e([h()],Ke.prototype,"_expressionsManager",void 0),Ke=e([g("esri.widgets.BatchAttributeForm.BatchAttributeFormViewModel")],Ke);const Xe=Ke;export{pe as a,Xe as default,le as g,ne as i};
