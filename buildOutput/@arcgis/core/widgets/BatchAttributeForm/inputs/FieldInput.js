/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import{i as t}from"../../../core/lang.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import"../../../chunks/Logger.js";import{subclass as s}from"../../../core/accessorSupport/decorators/subclass.js";import r,{C as n}from"../../../layers/support/CodedValueDomain.js";import"../../../layers/support/Domain.js";import"../../../layers/support/InheritedDomain.js";import o from"../../../layers/support/RangeDomain.js";import{isNumericField as a,isStringField as l,isTimeOnlyField as u,g as m,getFieldRange as p,f as d,i as c,isDateOnlyField as h,isTimestampOffsetField as f}from"../../../layers/support/fieldUtils.js";import{i as g}from"../../../chunks/utils7.js";import{a as y}from"../../../chunks/guards.js";import{u as j,a as b}from"../../../chunks/constants.js";import x from"./EditableInput.js";import{v as k,b as v,d as V}from"../../../chunks/inputUtils.js";import{g as _,a as E,i as T,d as F,v as w}from"../../../chunks/formUtils2.js";import"../../../chunks/ensureType.js";import"../../../chunks/MapUtils.js";import"../../../chunks/get.js";import"../../../chunks/utils.js";import"../../../chunks/handleUtils.js";import"../../../chunks/metadata.js";import"../../../core/Error.js";import"../../../chunks/object.js";import"../../../config.js";import"../../../chunks/string.js";import"../../../chunks/Lifecycle.js";import"../../../chunks/tracking.js";import"../../../chunks/Warning.js";import"../../../chunks/enumeration.js";import"../../../chunks/jsonMap.js";import"../../../core/JSONSupport.js";import"../../../core/Accessor.js";import"../../../core/Handles.js";import"../../../chunks/maybe.js";import"../../../chunks/ObjectPool.js";import"../../../chunks/ObservableBase.js";import"../../../chunks/watch.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../chunks/PooledArray.js";import"../../../core/promiseUtils.js";import"../../../chunks/events.js";import"../../../chunks/SetUtils.js";import"../../../chunks/SimpleTrackingTarget.js";import"../../../core/sql.js";import"../../../chunks/datetime.js";import"../../../chunks/date.js";import"../../../chunks/locale.js";import"../../../chunks/basemapUtils.js";import"../../../core/Collection.js";import"../../../core/Evented.js";import"../../../chunks/shared.js";import"../../../chunks/SimpleObservable.js";import"../../../chunks/jsonUtils.js";import"../../../core/urlUtils.js";import"../../../chunks/utils5.js";import"../../../chunks/colorUtils.js";import"../../../chunks/screenUtils.js";import"../../../chunks/mat4.js";import"../../../chunks/common.js";import"../../../chunks/basemapDefinitions.js";import"../../../chunks/assets.js";import"../../../request.js";import"../../../kernel.js";import"../../../chunks/persistableUrlUtils.js";import"../../../chunks/messages.js";import"../../../chunks/timeZoneUtils.js";import"./InputBase.js";import"../../../chunks/formUtils.js";import"../../../form/elements/AttachmentElement.js";import"../../../form/elements/Element.js";import"../../../form/elements/inputs/attachments/AttachmentInput.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../chunks/reader.js";import"../../../chunks/writer.js";import"../../../chunks/Input.js";import"../../../core/Clonable.js";import"../../../form/elements/inputs/attachments/AudioInput.js";import"../../../chunks/utils2.js";import"../../../form/elements/inputs/attachments/DocumentInput.js";import"../../../form/elements/inputs/attachments/ImageInput.js";import"../../../form/elements/inputs/attachments/SignatureInput.js";import"../../../form/elements/inputs/attachments/VideoInput.js";import"../../../form/elements/FieldElement.js";import"../../../form/elements/inputs.js";import"../../../form/elements/inputs/BarcodeScannerInput.js";import"../../../form/elements/inputs/TextInput.js";import"../../../form/elements/inputs/Input.js";import"../../../form/elements/inputs/ComboBoxInput.js";import"../../../form/elements/inputs/DatePickerInput.js";import"../../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../../form/elements/inputs/DateTimePickerInput.js";import"../../../form/elements/inputs/RadioButtonsInput.js";import"../../../form/elements/inputs/SwitchInput.js";import"../../../form/elements/inputs/TextAreaInput.js";import"../../../form/elements/inputs/TextBoxInput.js";import"../../../form/elements/inputs/TimePickerInput.js";import"../../../chunks/domains.js";import"../../../form/elements/RelationshipElement.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../form/elements/TextElement.js";import"../../../form/elements/UtilityNetworkAssociationsElement.js";import"../../../popup/support/UtilityNetworkAssociationType.js";import"../../../chunks/dateUtils.js";import"../../../intl.js";import"../../../chunks/number.js";import"../../../chunks/substitute.js";import"../../../chunks/mathUtils.js";let D=class extends x{constructor(e){super(e),this.group=null,this.type="field",this.userHasChangedValue=!1,this._hasIntersectionWithElementFieldDomain=!1}get compositeError(){if(this.valid)return null;const{errors:e}=this;if(e.length<this.features.length)return"batch-attribute-form-validation::features-have-different-errors";const t=e[0];for(const i of e)if(i.error!==t.error)return"batch-attribute-form-validation::features-have-different-errors";return t.error}get dataType(){const{field:e}=this;return a(e)?"number":l(e)?"text":g(e)||u(e)?"date":"unsupported"}get domain(){const e=this._allDomains.toArray();return this.calculateDomain(e)}get distinctValues(){if(this.featuresHaveSameValue)return[this.value];const e=new Set;for(const t of this.features)e.add(t.getAttribute(this.fieldName));return Array.from(e)}get editable(){return!!this.field.editable&&(this._evaluatedEditableExpression??!0)}get effectiveVisible(){return k(this.effectiveVisibilityCode)}get effectiveVisibilityCode(){const{visibilityCode:e}=this;if("visible"!==e)return e;const{group:t}=this;if(null==t)return e;const i=t.visibilityCode;return"hidden:visibility-expression:all-features"===i?"hidden:group-visibility-expression:all-features":"hidden:visibility-expression:some-features"===i?"hidden:group-visibility-expression:some-features":e}get errors(){return this._validate()}get featuresHaveSameValue(){const{fieldName:e}=this,t=this.features.at(0)?.getAttribute(e);return this.features.every(i=>i.getAttribute(e)===t)}get field(){return this.template.field}get fieldName(){return this.field.name}get invalidFeatures(){return this.errors.map(e=>e.feature)}get isSubtypeField(){return this.layers.some(e=>{if(e&&"subtypeField"in e){const{subtypeField:t,fieldsIndex:i}=e;return(i.get(t)?.name??t)===this.fieldName}return!1})}get showNoValueOptionEnabled(){const{input:e}=this.template;return!(this.required||v(e)&&!0!==e?.showNoValueOption)}get showNoValueLabel(){const{input:e}=this.template;return v(e)?e?.noValueOptionLabel:null}get includeTime(){const{template:e,field:t}=this;return"date"===this.dataType&&("time-only"===t.type||"date-only"!==t.type&&("datetime-picker"!==e.input?.type||e.input.includeTime))}get includeTimeOffset(){if("timestamp-offset"!==this.field.type)return!1;const e=this.template.input;return!e||"datetimeoffset-picker"===e.type&&e.includeTimeOffset}get maxLength(){return _({dataType:this.dataType,field:this.field,input:this.template.input})}get minLength(){return E({dataType:this.dataType,field:this.field,input:this.template.input})}get range(){if("date"===this.dataType)return this._dateRange;const{domain:e,field:t}=this;if(e){const i=m(t,e);return{max:i?.max,min:i?.min}}const i=this._allDomains.toArray().every(e=>!e)?p(t):null;return{max:i?.max===Number.MAX_VALUE?null:i?.max??null,min:i?.min===-Number.MAX_VALUE?null:i?.min??null}}get required(){if(!this.editable)return!1;if(!this.field.nullable||this.isSubtypeField)return!0;const e=this.visible&&!1!==this.group?.visible,t=this._evaluatedRequiredExpression;return!(!e||null==t)&&t}get submittable(){return!(this.required&&this.distinctValues.some(e=>T(e))||!this.valid)}get valid(){return 0===this.errors.length}get value(){return this.featuresHaveSameValue?this.features.at(0)?.getAttribute(this.fieldName)??null:V}get visibilityCode(){return this.field.visible?this._fieldShouldHaveDomain&&null==this.domain?"hidden:no-domain-in-common":this._baseVisibilityCode:"hidden:field-definition"}get effectiveTimeZone(){const e=this.template;let t=e.formTimeZone??"system";return e.layerTimeZone?e.layerTimeZone===j?t=b:e.formTimeZone===j&&(t=e.layerTimeZone):e.formTimeZone===j&&(t=b),t}get codedValueDomainOptions(){return"coded-value"===this.domain?.type?this.domain.codedValues.map(({name:e,code:t})=>({name:e,value:t})):[]}get codedValueOptions(){const e=this.codedValueDomainOptions,{value:t}=this,i=null==t||t===V||e.some(e=>e.value===t)?[]:[{name:`${t}`,value:t}];return[e,i]}get _evaluatedRequiredExpression(){let e=!1,t=!0;const i=this.template;for(const s of this.features){if(null==i.getExpressionExecutorsForLayer(s.layer)?.requiredExpression)continue;t=!1;const r=this._lookupEvaluatedExpression(s,"required");e="success"!==r?.status||e||!0===r.result}return t?null:e}get _allDomains(){const e=this.template.domain;return this.features.map(t=>{const i=t.layer.getFieldDomain(this.fieldName,{feature:t.plainGraphic});return"range"===i?.type||"range"===e?.type?i??this.template.domain:i})}get _fieldShouldHaveDomain(){return!!this._hasIntersectionWithElementFieldDomain||this._allDomains.some(t)}get _dateFormRange(){if("date"!==this.dataType)return{};const e=this.template.input;if(!e)return{};const{type:t}=e;let i={};if("date-picker"!==t&&"time-picker"!==t&&"datetimeoffset-picker"!==t||(i=d(this.field,e.max,e.min)),"datetime-picker"===t){const{max:t,min:s}=e;i={max:null!=t&&F(t)?t.getTime():null,min:null!=s&&F(s)?s.getTime():null}}return{min:i.min,max:i.max,rawMax:i?.rawMax??null,rawMin:i?.rawMin??null}}get _dateRange(){const{_dateFormRange:e,template:t,field:i,domain:s}=this;if("date"!==this.dataType)return{};if(!s)return this._fieldShouldHaveDomain?{}:e;const r=m(i,s);if(!r)return e;const{max:n,min:o,rawMax:a,rawMin:l}=e,{type:u}=t.field;if("date"===u){const{max:e,min:t}=r;return{max:y(n)&&(null===e||null!=e&&n<=e)?n:e??null,min:y(o)&&(null===t||null!=t&&o>=t)?o:t??null}}if("date-only"===u||"time-only"===u||"timestamp-offset"===u){const{max:e,min:t,rawMax:i,rawMin:s}=r,u=y(n)&&a&&(null==e||n<e),m=y(o)&&l&&(null==t||o>t);return{max:u?n:e,min:m?o:t,rawMax:u?a:i,rawMin:m?l:s}}return{}}async setValueFromUser(e){this.userHasChangedValue=!0;const t=[],i=this.fieldName;for(const s of this.features)s.getAttribute(i)!==e&&t.push(s);this._setValue(e),await this.expressionsManager.valueChanged(i,t)}_setValue(e){const{fieldName:t}=this;for(const i of this.features)i.setAttribute(t,e)}_validate(){const{dataType:e,fieldName:t,maxLength:i,minLength:s,range:r}=this,n=[];for(const o of this.features){const{layer:a}=o,l=a.getField(t)??this.field,u=a.getFieldDomain(t,{feature:o.plainGraphic}),m=this.calculateDomain([u]),p=this._requiredForFeature(o),d=o.getAttribute(t),c=w(d,{dataType:e,domain:m,field:l,maxLength:i,minLength:s,range:r,required:p});c&&n.push({error:c,feature:o.source})}return n}_editableForFeature(e){if(!this.field.editable)return!1;if(null==this.template.getExpressionExecutorsForLayer(e.layer)?.editableExpression)return!0;const t=this._lookupEvaluatedExpression(e,"editable");return"success"===t?.status&&!0===t.result}_effectiveVisibleFeature(e){if(this.group&&!this.group.visibleForFeature(e))return!1;if(null==this.template.getExpressionExecutorsForLayer(e.layer)?.visibilityExpression)return!0;const t=this._lookupEvaluatedExpression(e,"visibility");return"success"===t?.status&&!0===t.result}_requiredForFeature(e){if(!this._editableForFeature(e))return!1;if(!this.field.nullable||this.isSubtypeField)return!0;const t=this._effectiveVisibleFeature(e);if(null==this.template.getExpressionExecutorsForLayer(e.layer)?.requiredExpression)return!1;const i=this._lookupEvaluatedExpression(e,"required");return"success"!==i?.status?t:t&&!0===i.result}calculateDomain(e){const t=e.find(e=>null!=e),i=this.template.domain;if(!t)return i&&c(this.field,i)?i:null;switch(t.type){case"coded-value":if(e.some(e=>!e)){if(!i)return null;e=e.filter(e=>null!==e)}break;case"range":e=e.filter(e=>null!==e)}if(!e.every(e=>e?.type===t?.type))return null;let s=null;switch(t?.type){case"range":s=this._intersectRangeDomains(e);break;case"coded-value":s=this._intersectCodedValueDomains(e)}return s}_intersectCodedValueDomains(e){if(!e.length)return null;const t=new Map(e[0].codedValues.map(({code:e,name:t})=>[e,t])),i=this.template.domain?new Map(this.template.domain.codedValues.map(({code:e,name:t})=>[e,t])):null;for(const i of e)for(const[e,s]of t)i.codedValues.some(t=>t.code===e&&t.name===s)||t.delete(e);let s=t;if(i){s=new Map;for(const[e,r]of i)t.has(e)&&s.set(e,r)}const o=Array.from(s.entries()).map(([e,t])=>new n({code:e,name:t}));return o.length?new r({codedValues:o}):null}_intersectRangeDomains(e){if(!e.length)return null;let t=e[0];for(let i=1;i<e.length;i++){if(!t)return null;t=this._findMinMaxValuesBetweenTwoDomains(t,e[i])}if(t&&!c(this.field,t))return null;const{domain:i}=this.template;if(t&&i&&i instanceof o){const e=this._findMinMaxValuesBetweenTwoDomains(t,i);return this._hasIntersectionWithElementFieldDomain=!!e,e}return t}_getMinMaxFromRangeDomain(e){const t=e.minValue,i=e.maxValue,{field:s}=this;return h(s)||u(s)||f(s)?d(s,i,t):{min:null!=t&&"number"==typeof t?t:null,max:null!=i&&"number"==typeof i?i:null}}_findMinMaxValuesBetweenTwoDomains(e,t){const i=new o,s=this._getMinMaxFromRangeDomain(e),r=this._getMinMaxFromRangeDomain(t),{field:n}=this,a=this._getValidRangeValue(s.min,-1/0),l=this._getValidRangeValue(s.max,1/0),m=this._getValidRangeValue(r.min,-1/0),p=this._getValidRangeValue(r.max,1/0);return i.minValue=Math.max(a,m),i.maxValue=Math.min(l,p),i.minValue===-1/0||i.maxValue===1/0||i.minValue>i.maxValue?null:((h(n)||u(n)||f(n))&&(i.minValue=Number(s.min)>Number(r.min)?s.rawMin:r.rawMin,i.maxValue=Number(s.max)<Number(r.max)?s.rawMax:r.rawMax),i.name="intersection",i)}_getValidRangeValue(e,t){return y(e)?e:t}};e([i()],D.prototype,"dataType",null),e([i()],D.prototype,"domain",null),e([i()],D.prototype,"distinctValues",null),e([i()],D.prototype,"editable",null),e([i()],D.prototype,"effectiveVisible",null),e([i()],D.prototype,"effectiveVisibilityCode",null),e([i()],D.prototype,"errors",null),e([i()],D.prototype,"featuresHaveSameValue",null),e([i()],D.prototype,"field",null),e([i()],D.prototype,"fieldName",null),e([i()],D.prototype,"group",void 0),e([i()],D.prototype,"invalidFeatures",null),e([i()],D.prototype,"isSubtypeField",null),e([i()],D.prototype,"showNoValueOptionEnabled",null),e([i()],D.prototype,"showNoValueLabel",null),e([i()],D.prototype,"includeTime",null),e([i()],D.prototype,"includeTimeOffset",null),e([i()],D.prototype,"maxLength",null),e([i()],D.prototype,"minLength",null),e([i()],D.prototype,"range",null),e([i()],D.prototype,"required",null),e([i()],D.prototype,"submittable",null),e([i({readOnly:!0})],D.prototype,"type",void 0),e([i()],D.prototype,"userHasChangedValue",void 0),e([i()],D.prototype,"valid",null),e([i()],D.prototype,"value",null),e([i()],D.prototype,"visibilityCode",null),e([i()],D.prototype,"effectiveTimeZone",null),e([i()],D.prototype,"_evaluatedRequiredExpression",null),e([i()],D.prototype,"_hasIntersectionWithElementFieldDomain",void 0),e([i()],D.prototype,"_allDomains",null),e([i()],D.prototype,"_fieldShouldHaveDomain",null),e([i()],D.prototype,"_dateFormRange",null),e([i()],D.prototype,"_dateRange",null),D=e([s("esri.widgets.BatchAttributeForm.inputs.FieldInput")],D);const M=D;export{M as default};
