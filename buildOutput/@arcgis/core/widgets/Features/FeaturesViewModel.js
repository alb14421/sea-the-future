/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import{i as s}from"../../core/lang.js";import r from"../../core/Error.js";import{L as i}from"../../chunks/Logger.js";import{isAbortError as o,throwIfNotAbortError as n,debounce as a}from"../../core/promiseUtils.js";import{R as l}from"../../chunks/ReactiveSet.js";import{watch as p,when as u,sync as m}from"../../core/reactiveUtils.js";import{property as c}from"../../core/accessorSupport/decorators/property.js";import{subclass as h}from"../../core/accessorSupport/decorators/subclass.js";import d from"../../geometry/Point.js";import{project as j,initializeProjection as y}from"../../chunks/projectionUtils.js";import g from"../../geometry/SpatialReference.js";import{g as f}from"../../chunks/geometryUtils2.js";import{geographicToWebMercator as b}from"../../geometry/support/webMercatorUtils.js";import{f as k}from"../../chunks/LayerConstants.js";import w from"../../symbols/SimpleFillSymbol.js";import{getDisplayedSymbol as F}from"../../symbols/support/symbolUtils.js";import{s as v}from"../../chunks/constants.js";import{h as C}from"../../chunks/layerViewUtils.js";import P from"../Feature/FeatureViewModel.js";import{z as I,a as _,b as S,r as U,A as L}from"../../chunks/actions.js";import{A as x}from"../../chunks/AnchorElementViewModel.js";import{GoTo as M}from"../support/GoTo.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/maybe.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/Lifecycle.js";import"../../chunks/metadata.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../chunks/object.js";import"../../chunks/events.js";import"../../config.js";import"../../chunks/string.js";import"../../chunks/Warning.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/jsonUtils.js";import"../../core/JSONSupport.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../chunks/guards.js";import"../../chunks/datetime.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/support/AttachmentsOrderByInfo.js";import"../../chunks/jsonMap.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/mathUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../geometry/support/jsonUtils.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/unitUtils.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/createFeatureId.js";import"../../chunks/typeUtils2.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils3.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils4.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/vec3f64.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/DoubleArray.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../chunks/lineMarkers.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/Font.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/scaleUtils.js";import"../../chunks/layerUtils.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/gfxUtils.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils6.js";import"../../chunks/defaultCIMValues.js";import"../../chunks/renderUtils.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4.js";import"../../chunks/common.js";import"../../chunks/vec4f64.js";import"../../chunks/projector.js";import"../../chunks/sanitizerUtils.js";import"../../chunks/svgUtils.js";import"../../chunks/mat2df32.js";import"../../chunks/mat2d.js";import"../../chunks/widgetUtils.js";import"../../chunks/jsxFactory.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/utils8.js";import"../../chunks/asyncUtils.js";import"../../chunks/jsonUtils2.js";import"../../chunks/parser.js";import"../../chunks/utils5.js";import"../../chunks/mat4.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../chunks/styleUtils.js";import"../../chunks/throttle.js";import"../Attachments/AttachmentsViewModel.js";import"../../rest/query/support/AttachmentInfo.js";import"../../rest/support/AttachmentQuery.js";import"../../chunks/featureUtils.js";import"../../chunks/number.js";import"../../chunks/utils7.js";import"../../chunks/basemapUtils.js";import"../../chunks/basemapDefinitions.js";import"../../chunks/messages.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/executeQueryJSON.js";import"../../chunks/utils9.js";import"../../chunks/query.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils10.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/pbf.js";import"../../chunks/memoryEstimations.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/queryZScale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../time/TimeExtent.js";import"../../chunks/timeUtils.js";import"../../rest/support/RelationshipQuery.js";import"../../chunks/arcadeFeatureUtils.js";import"../../chunks/shared2.js";import"../../chunks/TimeOnly.js";import"../../chunks/enum.js";import"../../chunks/UnknownTimeZone.js";import"../../layers/FeatureLayer.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/layerContainerType.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/Element.js";import"../../chunks/formUtils.js";import"../../form/elements/AttachmentElement.js";import"../../form/elements/inputs/attachments/AttachmentInput.js";import"../../chunks/Input.js";import"../../form/elements/inputs/attachments/AudioInput.js";import"../../chunks/utils2.js";import"../../form/elements/inputs/attachments/DocumentInput.js";import"../../form/elements/inputs/attachments/ImageInput.js";import"../../form/elements/inputs/attachments/SignatureInput.js";import"../../form/elements/inputs/attachments/VideoInput.js";import"../../form/elements/FieldElement.js";import"../../form/elements/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../form/elements/RelationshipElement.js";import"../../form/elements/TextElement.js";import"../../form/elements/UtilityNetworkAssociationsElement.js";import"../../graphic/FeatureGraphicOrigin.js";import"../../graphic/GraphicOrigin.js";import"../../chunks/isFeatureGraphicOrigin.js";import"../../layers/Layer.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../intl.js";import"../../chunks/substitute.js";import"../../chunks/editsZScale.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/BlendLayer.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../layers/mixins/DisplayFilteredLayer.js";import"../../layers/support/DisplayFilterInfo.js";import"../../layers/support/DisplayFilter.js";import"../../chunks/uuid.js";import"../../chunks/displayFilterUtils.js";import"../../chunks/EditBusLayer.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/ElevationInfo.js";import"../../symbols/support/FeatureExpressionInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../tables/AttributeTableTemplate.js";import"../../tables/elements/AttributeTableGroupElement.js";import"../../tables/elements/AttributeTableAttachmentElement.js";import"../../tables/elements/AttributeTableElement.js";import"../../tables/elements/AttributeTableFieldElement.js";import"../../tables/elements/AttributeTableRelationshipElement.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/featureQueryAll.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/commonProperties2.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../chunks/RendererLegendOptions.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../rest/support/NormalizationBinParametersMixin.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../chunks/multiLayerServiceUtils.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../chunks/infoFor3D.js";import"../../layers/support/Subtype.js";import"../../chunks/portalItemUtils.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/typeUtils3.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/support/ClassBreakInfo.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/DictionaryScriptEvaluator.js";import"../../chunks/Version.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/ArcadeExpression.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../renderers/PieChartRenderer.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../layers/support/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../layers/support/TimeInfo.js";import"../../time/TimeInterval.js";import"../../layers/mixins/TrackableLayer.js";import"../../layers/support/TrackInfo.js";import"../../layers/support/TrackPartInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/TitleCreator.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/streamLayerUtils.js";import"../../chunks/FeatureRelationshipViewModel.js";import"../../chunks/featureFormUtils.js";import"../../chunks/dateUtils.js";import"../../chunks/formUtils2.js";import"../../chunks/FeatureUtilityNetworkAssociationsViewModel.js";import"../../chunks/ReactiveMap.js";import"../../rest/networks/support/NetworkElement.js";import"../../chunks/getFeatureTitle.js";import"../../chunks/legacyIcon.js";import"../../chunks/goToUtils.js";const E=()=>i.getLogger("esri.widgets.Popup.PopupViewModel");function V(e){const{selectedFeature:t,location:s,view:r}=e;return r?t??s??null:null}function T(e){return!!e&&e.isAggregate&&"cluster"===e.sourceLayer?.featureReduction?.type}async function A(e,t){const{location:s,selectedFeature:i,view:n,zoomFactor:a}=e;await(t?.viewModel?.updateGeometry());const l=t?.graphic,p=l?.geometry?l:V(e);if(!n||!p){const e=new r("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:p,view:n});throw E().error(e),e}const u=n.scale/a,m=l?.geometry??e.selectedFeature?.geometry??s,c=null!=m&&"point"===m.type&&await async function(e,t){if("3d"!==t?.type||!e||"esri.Graphic"!==e.declaredClass)return!0;const s=t.getViewForGraphic(e);if(s&&"whenGraphicBounds"in s){let t=null;try{t=await s.whenGraphicBounds(e,{useViewElevation:!0})}catch(e){}return!t||!t.boundingBox||t.boundingBox[0]===t.boundingBox[3]&&t.boundingBox[1]===t.boundingBox[4]&&t.boundingBox[2]===t.boundingBox[5]}return!0}(l??i,n);I.active=!0,I.disabled=!0;try{await e.zoomTo({target:{target:p,scale:c?u:void 0}})}catch(e){if(o(e))return;const t=new r("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:l??i});E().error(t)}finally{I.active=!1,I.disabled=!1,e.zoomToLocation=null,c&&(e.location=m)}}async function R(e,t){const s=await e.whenLayerView(t.sourceLayer),r=s.createQuery(),i=t.getObjectId();return r.aggregateIds=null!=i?[i]:[],[s,r]}const O="location-scale-handle";let D=null,B=class extends(M(x)){constructor(e){super(e),this._pendingPromises=new l,this._fetchFeaturesController=null,this._highlightPromises={"highlight-active-feature":null,"highlight-selected-feature":null},this._selectedClusterFeature=null,this.actions=new L,this.activeFeature=null,this.autoCloseEnabled=!1,this.browseClusterEnabled=!1,this.content=null,this.defaultPopupTemplateEnabled=!1,this.featurePage=null,this.featuresPerPage=20,this.featureMenuOpen=!1,this.featureMenuTitle=null,this.featureViewModelAbilities=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.initialDisplayMode="feature",this.selectedClusterBoundaryFeature=new t({symbol:new w({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null,this._debouncedLocationUpdate=a(async e=>{const{spatialReference:t}=this,s=this.selectedFeature?.geometry?.type,r=this.location??e;if(s&&"mesh"!==s&&t&&r&&this.selectedFeature)if("point"!==s)try{const e=this.selectedFeature;let s=e.geometry;const i=this._getHighlightLayer(e),o=e.getObjectId();if(!i||!this.view)return;if(o){const e=this.view?.allLayerViews.find(e=>e.layer.uid===i.uid);if(!e||!("queryFeatures"in e))return;const r=e.createQuery();r.outSpatialReference=t,r.objectIds=[o],r.returnGeometry=!0;const{features:n}=await e.queryFeatures(r);s=n[0]?.geometry}if(!s||"mesh"===s.type)return;s=j(s,t),D||(D=await Promise.all([await import("../../geometry/operators/intersectsOperator.js").then(e=>e.i),await import("../../geometry/operators/proximityOperator.js").then(e=>e.p)]));const[n,a]=D;if(!n.execute(s,r)){const t=a.getNearestCoordinate(s,r).coordinate??r;this.selectedFeature===e&&(this.location=t)}}catch(e){o(e)||i.getLogger(this).error(e)}else this.location=f(this.selectedFeature.geometry)??r})}initialize(){this.addHandles([this.on("view-change",()=>this._autoClose()),p(()=>[this.highlightEnabled,this.selectedFeature,this.visible,this.view],()=>this._highlightSelectedFeature()),p(()=>[this.highlightEnabled,this.activeFeature,this.visible,this.view],()=>this._highlightActiveFeature()),p(()=>this.view?.animation?.state,e=>this._animationStateChange(e)),p(()=>this.location,e=>this._locationChange(e)),p(()=>this.selectedFeature,e=>this._selectedFeatureChange(e)),p(()=>[this.selectedFeatureIndex,this.featureCount,this.featuresPerPage],()=>this._selectedFeatureIndexChange()),p(()=>[this.featurePage,this.selectedFeatureIndex,this.featureCount,this.featuresPerPage,this.featureViewModels],()=>this._setGraphicOnFeatureViewModels()),p(()=>this.featureViewModels,()=>this._featureViewModelsChange()),this.on("trigger-action",e=>(e=>{const{event:t,view:s,viewModel:i}=e,{action:o}=t;if(!o)return Promise.reject(new r("trigger-action:missing-arguments","Event has no action"));const{disabled:a,id:l}=o;if(!l)return Promise.reject(new r("trigger-action:invalid-action","action.id is missing"));if(a)return Promise.reject(new r("trigger-action:invalid-action","Action is disabled"));if(l===I.id)return A(i).catch(n);if(l===_.id)return async function(e){const{selectedFeature:t,view:s}=e;if("2d"!==s?.type){const e=new r("zoomToCluster:invalid-view","View must be 2d MapView.",{view:s});throw E().error(e),e}if(!t||!T(t)){const e=new r("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:t});throw E().error(e),e}const[i,o]=await R(s,t);_.active=!0,_.disabled=!0;const{extent:n}=await i.queryExtent(o);n&&await e.zoomTo({target:n}),_.active=!1,_.disabled=!1}(i);if(l===S.id)return i.browseClusterEnabled=!i.browseClusterEnabled,i.featureMenuOpen=i.browseClusterEnabled,Promise.resolve();if(l===U.id){i.visible=!1;const{selectedFeature:e}=i;if(!e)return Promise.reject(new r(`trigger-action:${U.id}`,"selectedFeature is required",{selectedFeature:e}));const{sourceLayer:t}=e;return t?t.remove(e):s?.graphics.remove(e),Promise.resolve()}return Promise.resolve()})({event:e,viewModel:this,view:this.view})),u(()=>!this.waitingForResult,()=>this._waitingForResultChange(),m),p(()=>[this.features,this.map,this.spatialReference,this.timeZone],()=>this._updateFeatureVMs()),p(()=>this.view?.scale,()=>this._viewScaleChange()),u(()=>!this.visible,()=>this.browseClusterEnabled=!1),p(()=>this.browseClusterEnabled,e=>e?this.enableClusterBrowsing():this.disableClusterBrowsing())])}destroy(){this._cancelFetchingFeatures(),this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null,this.map=null,this.spatialReference=null,this.timeZone=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new L;e.removeAll();const{actions:t,defaultActions:s,defaultPopupTemplateEnabled:r,includeDefaultActions:i,selectedFeature:o}=this,n=i?s.concat(t):t,a=o&&("function"==typeof o.getEffectivePopupTemplate&&o.getEffectivePopupTemplate(r)||o.popupTemplate),l=a?.actions,p=a?.overwriteActions?l:l?.concat(n)??n;return p?.filter(Boolean).forEach(t=>e.add(t)),e}get defaultActions(){const e=this._get("defaultActions")||new L;return e.removeAll(),e.addMany(T(this.selectedFeature)?[_.clone(),S.clone()]:[I.clone()]),e}get featureCount(){return this.features.length}set features(e){const t=e||[];this._set("features",t);const{pendingPromisesCount:s,promiseCount:r,selectedFeatureIndex:i}=this,o=r&&t.length;"list"!==this.initialDisplayMode?o&&s&&-1===i?this.selectedFeatureIndex=0:o&&-1!==i||(this.selectedFeatureIndex=t.length?0:-1):(!o||o&&s===r)&&(this.selectedFeatureIndex=-1)}set location(e){let t=e;const s=this.spatialReference?.isWebMercator,r=e?.spatialReference?.isWGS84;r&&s&&(t=b(e)),this._set("location",t)}get map(){return this.view?.map??null}set map(e){this._override("map",e)}get pendingPromisesCount(){return this._pendingPromises.size}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){this._pendingPromises.clear(),this.features=[],Array.isArray(e)&&e.length?(this._set("promises",e),(e=e.slice()).forEach(e=>this._pendingPromises.add(e)),e.reduce((e,t)=>e.finally(()=>t.then(e=>{this._pendingPromises.has(t)&&this._updateFeatures(e)}).finally(()=>this._pendingPromises.delete(t)).catch(()=>{})),Promise.resolve())):this._set("promises",[])}get screenLocation(){return super.screenLocation}get selectedFeature(){const{features:e,selectedFeatureIndex:t}=this;return-1===t?null:e[t]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return"number"==typeof e?e:-1}set selectedFeatureIndex(e){const{featureCount:t}=this;(isNaN(e)||e<0||!t)&&(e=-1),this.activeFeature=null,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){const{view:e,map:t}=this;return e?e.ready?"ready":"disabled":t?"ready":"disabled"}get timeZone(){return this.view?.timeZone??v}set timeZone(e){this._overrideIfSome("timeZone",e)}get waitingForContents(){return this.featureViewModels.some(e=>e.waitingForContent)}get waitingForResult(){return!(!(this._fetchFeaturesController||this.pendingPromisesCount>0)||0!==this.featureCount)}centerAtLocation(){const{view:e}=this,t=V(this);return t&&e?this.callGoTo({target:{target:t,scale:e.scale}}):Promise.reject(new r("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:t,view:e}))}zoomTo(e){return this.callGoTo(e)}clear(){this.set({promises:[],features:[],content:null,title:null,location:null,activeFeature:null})}fetchFeatures(e,t){const{view:s}=this;if(!s||!e)throw new r("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:s});return s.fetchPopupFeatures(e,{pointerType:t?.event?.pointerType,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:t?.signal})}open(e){const t={updateLocationEnabled:!1,promises:[],fetchFeatures:!1,...e,visible:!0},{fetchFeatures:s}=t;delete t.fetchFeatures,s&&this._setFetchFeaturesPromises(t.location);const r=["actionsMenuOpen","collapsed"];for(const e of r)delete t[e];this.set(t)}triggerAction(e){const t=this.allActions.at(e);t&&!t.disabled&&this.emit("trigger-action",{action:t})}next(){return this.selectedFeatureIndex=this._getRoundRobinIndex(this.selectedFeatureIndex+1,this.featureCount),this}previous(){return this.selectedFeatureIndex=this._getRoundRobinIndex(this.selectedFeatureIndex-1,this.featureCount),this}disableClusterBrowsing(){!function(e){S.value=!1;const t=e.features.filter(e=>T(e));t.length&&(e.features=t)}(this),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){const{view:e,selectedFeature:t}=this;"2d"===e?.type?T(t)?(await async function(e){const{view:t,selectedFeature:s}=e;if(!t||!s)return;const[r,i]=await R(t,s),{extent:o}=await r.queryExtent(i);e.selectedClusterBoundaryFeature.geometry=o,t.graphics.add(e.selectedClusterBoundaryFeature)}(this),await async function(e){const{selectedFeature:t,view:s}=e;if(!s||!t)return;const[r,i]=await R(s,t);S.active=!0,S.disabled=!0;const{features:o}=await r.queryFeatures(i);S.active=!1,S.disabled=!1,S.value=!0;const n={features:[t].concat(o)};"feature"===e?.initialDisplayMode&&(n.featureMenuOpen=!0),e?.open(n)}(this)):i.getLogger(this).warn("enableClusterBrowsing:invalid-selectedFeature: Selected feature must represent an aggregate/cluster graphic.",t):i.getLogger(this).warn("enableClusterBrowsing:invalid-view: View must be 2d MapView.",t)}handleViewClick(e){this._fetchFeaturesAndOpen(e)}_getRoundRobinIndex(e,t){return(e+t)%t}_animationStateChange(e){this.zoomToLocation||(I.disabled="waiting-for-target"===e)}_clearBrowsedClusterGraphics(){const e=[this.selectedClusterBoundaryFeature,this._selectedClusterFeature].filter(s);this.view?.graphics?.removeMany(e),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){if(T(this.selectedFeature))return this.browseClusterEnabled=!1,this.visible=!1,void this.clear();this.browseClusterEnabled&&(this.features=this.selectedFeature?[this.selectedFeature]:[])}_locationChange(e){const{selectedFeature:t,updateLocationEnabled:s,view:r}=this;r&&s&&e&&(!t||t.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>0?Math.floor(this.selectedFeatureIndex/this.featuresPerPage)+1:null}_featureViewModelsChange(){this.featurePage=this.featureCount>0?1:null}_setGraphicOnFeatureViewModels(){const{features:e,featureCount:t,featurePage:s,featuresPerPage:r,featureViewModels:i}=this;if(null==s)return;const o=((s-1)*r+t)%t,n=o+r;i.slice(o,n).forEach((t,s)=>{t&&(t.graphic??=e[o+s])})}async _selectedFeatureChange(e){const{location:t,updateLocationEnabled:s,view:r}=this;if(!e||!r)return;if(this.browseClusterEnabled){if(this._selectedClusterFeature&&(r.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),T(e))return;return e.symbol=await F(e),this._selectedClusterFeature=e,void r.graphics.add(this._selectedClusterFeature)}const i=e.sourceLayer?.type;if("map-image"!==i&&"imagery"!==i&&"imagery-tile"!==i||(e.symbol=await F(e)),!s&&t||!e.geometry){if(s&&!e.geometry){await this.centerAtLocation();const e=r.center?.clone();e&&(this.location=e)}}else this.location=f(e.geometry)}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}async _setFetchFeaturesPromises(e){const{pendingFeatures:t}=await this._fetchFeaturesWithController({mapPoint:e});this.promises=t}_destroyFeatureVMs(){this.featureViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:e,features:t,featureViewModels:s,view:r,spatialReference:i,map:o,timeZone:n,location:a}=this;if(T(t[0])||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!t?.length)return;const l=s.slice(),p=[];t.forEach((t,s)=>{if(!t)return;let u=null;if(l.some((e,s)=>(e&&e.graphic===t&&(u=e,l.splice(s,1)),!!u)),u)p[s]=u;else{const l=new P({abilities:this.featureViewModelAbilities,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:i,graphic:t===e?t:null,location:a,map:o,view:r,timeZone:n});p[s]=l}}),l.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("featureViewModels",p)}async _getScreenPoint(e,t){const{spatialReference:s,view:r}=this;if(!r)return null;await(r?.when());const i=e?.spatialReference;return i&&s?(await y(i,s,null,t),r.toScreen(e)):null}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null}async _projectScreenPointAndFetchFeatures({mapPoint:e,screenPoint:t,event:s,signal:r}){return this.fetchFeatures(t??await this._getScreenPoint(e??this.location,{signal:r}),{signal:r,event:s})}_fetchFeaturesWithController({mapPoint:e,screenPoint:t,event:s}){this._cancelFetchingFeatures();const r=new AbortController,{signal:i}=r;this._fetchFeaturesController=r;const o=this._projectScreenPointAndFetchFeatures({mapPoint:e,screenPoint:t,signal:i,event:s});return o.catch(()=>{}).then(()=>{this._fetchFeaturesController=null}),o}async _fetchFeaturesAndOpen(e){const{mapPoint:t,screenPoint:s}=e,{view:r}=this;this.removeHandles(O),this.addHandles([p(()=>this.view?.scale,()=>this._debouncedLocationUpdate(t).catch(e=>{o(e)||i.getLogger(this).error(e)})),u(()=>!this.visible,()=>{this.removeHandles(O)},{once:!0})],O);const{pendingFeatures:n}=await this._fetchFeaturesWithController({mapPoint:t,screenPoint:s,event:e});r?.popup&&"open"in r.popup&&r.popup.open({location:t??void 0,promises:n})}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}async _getLayerView(e,t){return await e.when(),e.whenLayerView(t)}_getHighlightLayer(e){const{layer:t,sourceLayer:s}=e;return s&&"layer"in s&&s.layer?s.layer:"map-notes"===s?.type||"subtype-group"===s?.type?s:t??s}_getHighlightLayerView(e,t){return"subtype-sublayer"===t.type&&t.parent&&this._mapIncludesLayer(t.parent)?this._getLayerView(e,t.parent):t&&this._mapIncludesLayer(t)?this._getLayerView(e,t):null}_getHighlightTarget(e,t,s){if(function(e,t){return"building-scene"===e||"map-image"===e||"tile"===e||"imagery"===e||"2d"===t&&"imagery-tile"===e}(t.type,s))return e;const r=e.getObjectId();if(null!=r)return r;const i="imagery"===t.type?void 0:"objectIdField"in t?t.objectIdField||k:null,o=e.attributes;return o&&i&&o[i]||e}_mapIncludesLayer(e){return!!this.map?.allLayers?.includes(e)}async _highlightFeature(e,t){this.removeHandles(e);const s=this[t];if(!s)return;const{highlightEnabled:r,view:i,visible:o}=this;if(!i||!r||!o)return;const n=this._getHighlightLayer(s);if(!n)return;const a=this._getHighlightLayerView(i,n);if(!a)return;this._highlightPromises[e]=a;const l=await a;if(!(l&&C(l)&&this._highlightPromises[e]===a&&this[t]&&this.highlightEnabled))return;const p=l.highlight(this._getHighlightTarget(s,n,i.type));this.addHandles(p,e)}async _highlightActiveFeature(){return this._highlightFeature("highlight-active-feature","activeFeature")}async _highlightSelectedFeature(){return this._highlightFeature("highlight-selected-feature","selectedFeature")}_updateFeatures(e){const{features:t}=this,s=e.filter(e=>!t.includes(e));s?.length&&(this.features=t.concat(s))}};e([c()],B.prototype,"_fetchFeaturesController",void 0),e([c({type:L})],B.prototype,"actions",void 0),e([c({readOnly:!0})],B.prototype,"active",null),e([c()],B.prototype,"activeFeature",void 0),e([c({readOnly:!0})],B.prototype,"allActions",null),e([c()],B.prototype,"autoCloseEnabled",void 0),e([c()],B.prototype,"browseClusterEnabled",void 0),e([c()],B.prototype,"content",void 0),e([c({type:L,readOnly:!0})],B.prototype,"defaultActions",null),e([c({type:Boolean})],B.prototype,"defaultPopupTemplateEnabled",void 0),e([c({readOnly:!0})],B.prototype,"featureCount",null),e([c()],B.prototype,"featurePage",void 0),e([c({value:[]})],B.prototype,"features",null),e([c()],B.prototype,"featuresPerPage",void 0),e([c()],B.prototype,"featureMenuOpen",void 0),e([c()],B.prototype,"featureMenuTitle",void 0),e([c()],B.prototype,"featureViewModelAbilities",void 0),e([c({readOnly:!0})],B.prototype,"featureViewModels",void 0),e([c()],B.prototype,"highlightEnabled",void 0),e([c()],B.prototype,"includeDefaultActions",void 0),e([c()],B.prototype,"initialDisplayMode",void 0),e([c({type:d})],B.prototype,"location",null),e([c()],B.prototype,"map",null),e([c({readOnly:!0})],B.prototype,"pendingPromisesCount",null),e([c({readOnly:!0})],B.prototype,"promiseCount",null),e([c()],B.prototype,"promises",null),e([c({readOnly:!0})],B.prototype,"selectedClusterBoundaryFeature",void 0),e([c({value:null,readOnly:!0})],B.prototype,"selectedFeature",null),e([c({value:-1})],B.prototype,"selectedFeatureIndex",null),e([c({readOnly:!0})],B.prototype,"selectedFeatureViewModel",null),e([c({type:g})],B.prototype,"spatialReference",null),e([c({readOnly:!0})],B.prototype,"state",null),e([c()],B.prototype,"timeZone",null),e([c()],B.prototype,"title",void 0),e([c()],B.prototype,"updateLocationEnabled",void 0),e([c()],B.prototype,"view",void 0),e([c()],B.prototype,"visible",void 0),e([c({readOnly:!0})],B.prototype,"waitingForContents",null),e([c({readOnly:!0})],B.prototype,"waitingForResult",null),e([c()],B.prototype,"zoomFactor",void 0),e([c()],B.prototype,"zoomToLocation",void 0),e([c()],B.prototype,"centerAtLocation",null),B=e([h("esri.widgets.Features.FeaturesViewModel")],B);export{B as default,A as z};
