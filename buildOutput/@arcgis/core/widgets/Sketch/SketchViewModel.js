/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../core/Collection.js";import o from"../../core/Error.js";import{EventedAccessor as i}from"../../core/Evented.js";import{b as s}from"../../chunks/handleUtils.js";import{q as a}from"../../core/lang.js";import{L as r}from"../../chunks/Logger.js";import{d as n,a as p}from"../../chunks/maybe.js";import{createAbortError as l,whenOrAbort as c,ignoreAbortErrors as h}from"../../core/promiseUtils.js";import{on as d,watch as u,syncAndInitial as m,when as y,whenOnce as g}from"../../core/reactiveUtils.js";import{property as v}from"../../core/accessorSupport/decorators/property.js";import{subclass as f}from"../../core/accessorSupport/decorators/subclass.js";import{U as b}from"../../chunks/UpdatingHandles.js";import{p as j,U as _}from"../../chunks/unitUtils.js";import{canProjectWithoutEngine as k,isLoaded as w,load as G,project as T}from"../../chunks/projectionUtils.js";import{g as O}from"../../chunks/coordsUtils.js";import S from"../../layers/GraphicsLayer.js";import{t as E}from"../../chunks/layerUtils.js";import M from"../../symbols/FillSymbol3DLayer.js";import C from"../../symbols/MeshSymbol3D.js";import A from"../../symbols/SimpleFillSymbol.js";import U from"../../symbols/SimpleLineSymbol.js";import H from"../../symbols/SimpleMarkerSymbol.js";import{a as D}from"../../chunks/typeUtils2.js";import{i as I}from"../../chunks/isSupportedObject.js";import{k as R,p as P,t as x}from"../../chunks/elevationInfoUtils.js";import{a as L}from"../../chunks/layerUtils2.js";import{V as F}from"../../chunks/InputManager.js";import{s as V}from"../../chunks/keybindings.js";import K from"../../views/interactive/sketch/SketchLabelOptions.js";import{S as W}from"../../chunks/SketchOptions.js";import q from"../../views/interactive/sketch/SketchTooltipOptions.js";import Z from"../../views/interactive/sketch/SketchValueOptions.js";import{S as B}from"../../chunks/SnappingManager.js";import N from"../../views/interactive/snapping/SnappingOptions.js";import{a as z}from"../../chunks/constraints.js";import{l as Q}from"../../chunks/automaticAreaMeasurementUtils.js";import{l as $}from"../../chunks/automaticLengthMeasurementUtils.js";import{d as Y}from"../../chunks/HighlightDefaults.js";import{a as J}from"../../chunks/hitTestSelectUtils.js";import{c as X}from"../../chunks/screenUtils2.js";import{g as tt,a as et}from"../../chunks/sketchUtils.js";import"../../chunks/watch.js";import"../../chunks/ObjectPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/events.js";import"../../chunks/SetUtils.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/Lifecycle.js";import"../../chunks/tracking.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/ObservableBase.js";import"../../chunks/jsonUtils.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/Warning.js";import"../../chunks/jsonMap.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/vec3f64.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/SpatialReference.js";import"../../core/JSONSupport.js";import"../../chunks/writer.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../geometry/Polyline.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/GraphicsCollection.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../chunks/guards.js";import"../../chunks/datetime.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/support/AttachmentsOrderByInfo.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/constants.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../geometry/support/jsonUtils.js";import"../../chunks/typeUtils.js";import"../../chunks/createFeatureId.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils3.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/colors.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../chunks/lineMarkers.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../chunks/utils4.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/DoubleArray.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/Font.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../layers/Layer.js";import"../../time/TimeExtent.js";import"../../chunks/timeUtils.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/layerContainerType.js";import"../../chunks/jsonUtils2.js";import"../../chunks/parser.js";import"../../chunks/utils5.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../symbols/support/ElevationInfo.js";import"../../symbols/support/FeatureExpressionInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/editableLayers.js";import"../../chunks/Queue.js";import"../../chunks/signal.js";import"../../chunks/SketchTooltipVisibleElements.js";import"../../chunks/asyncUtils.js";import"../../chunks/normalizedPoint.js";import"../../chunks/dehydratedPoint.js";import"../../chunks/Settings.js";import"../../chunks/RightAngleSnappingHint.js";import"../../chunks/vec3.js";import"../../chunks/vec2.js";import"../../chunks/geodesicLengthMeasurementUtils.js";import"../../chunks/quantityUtils.js";import"../../chunks/projectVectorToVector.js";import"../../chunks/projectPointToVector.js";import"../../chunks/spatialReferenceEllipsoidUtils.js";import"../../geometry/operators/geodeticLengthOperator.js";import"../../chunks/geodeticCurveType.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/geodesicMeasurementUtils.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../chunks/utils11.js";import"../../chunks/Version2.js";import"../../chunks/Version.js";import"../../chunks/vec2f64.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/plane.js";import"../../chunks/vector.js";import"../../chunks/mat3f64.js";import"../../chunks/mat4f64.js";import"../../chunks/quatf64.js";import"../../chunks/mathUtils2.js";import"../../chunks/sphere.js";import"../../chunks/ray.js";import"../../chunks/mat3.js";import"../../chunks/geometry2dUtils.js";import"../../chunks/geodesicAreaMeasurementUtils.js";import"../../chunks/earcut.js";import"../../chunks/triangle.js";import"../../chunks/lineSegment.js";function ot(t){switch(t){case 0:break;case 1:return"not owned by a graphics layer";case 2:return"no geometry";case 3:return"the geometry type is not supported";case 4:return"the elevation mode is not supported";case 5:return"the symbol type is not supported"}return""}let it=class extends i{constructor(t){super(t),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw-2d":case"draw-3d":return this.activeComponent.geometryType;default:a(this.activeComponent)}return null}addToHistory(t){this.history.redo=[],this.history.undo.push(t)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this._reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}_reset(){this.activeComponent?.reset()}refreshComponent(){const t=this.activeComponent;t&&("box"!==t.type&&"reshape"!==t.type&&"graphic-mover"!==t.type||t.refresh())}set undo(t){this._set("undo",()=>{this.canUndo()&&t()})}set redo(t){this._set("redo",()=>{this.canRedo()&&t()})}};t([v()],it.prototype,"activeComponent",void 0),t([v()],it.prototype,"cancelled",void 0),t([v()],it.prototype,"history",void 0),t([v()],it.prototype,"tool",null),t([v()],it.prototype,"type",void 0),t([v()],it.prototype,"canUndo",null),t([v()],it.prototype,"canRedo",null),t([v()],it.prototype,"onEnd",void 0),t([v()],it.prototype,"undo",null),t([v()],it.prototype,"redo",null),t([v()],it.prototype,"toggleTool",void 0),t([v()],it.prototype,"addToSelection",void 0),t([v()],it.prototype,"removeFromSelection",void 0),it=t([f("esri.widgets.Sketch.support.OperationHandle")],it);let st=class extends it{};t([v()],st.prototype,"activeComponent",void 0),st=t([f("esri.widgets.Sketch.support.OperationHandle.CreateOperationHandle")],st);let at=class extends it{};t([v()],at.prototype,"activeComponent",void 0),at=t([f("esri.widgets.Sketch.support.OperationHandle.UpdateOperationHandle")],at);const rt={defaultZ:0},nt={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,highlightOptions:{enabled:!0,name:Y},tool:"transform"},pt=Symbol();let lt=class extends i{constructor(t){super(t),this._defaultSnappingManager=null,this._updatingHandles=new b,this._internalGraphicsLayer=new S({listMode:"hide",internal:!0,title:"SVM Internal"}),this._operationHandle=null,this._viewHandlesKey="viewHandles",this.activeFillSymbol=null,this.activeLineSymbol=null,this.activeVertexSymbol=null,this.allowDeleteKey=!0,this.layer=null,this.pointSymbol=new H({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new A({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new U({color:[130,130,130,1],width:2}),this.meshSymbol=new C({symbolLayers:new e([new M])}),this.updateGraphics=new e,this.updateOnGraphicClick=!0,this.creationMode="single",this.vertexSymbol=new H({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.sketchOptions=new W,this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._sketchContinuationFlag=!1,this._originalPopupEnabled=null,this.defaultCreateOptions=rt,this.defaultUpdateOptions=nt,this.snappingOptions=t?.snappingManager?.options??t?.snappingOptions??new N}initialize(){this.addHandles([d(()=>this.view?.map?.layers,"change",t=>{t.removed.includes(this.layer)&&this.cancel()}),d(()=>this.layer?.graphics,"change",t=>{if(null!=this._operationHandle)for(const e of t.removed)this.updateGraphics.includes(e)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(e):this._operationHandle.cancel())}),u(()=>this.layer?.elevationInfo??null,t=>{t!==this._internalGraphicsLayer.elevationInfo&&(this.cancel(),this._internalGraphicsLayer.elevationInfo=t)},m),u(()=>this.view,t=>{this._defaultSnappingManager=n(this._defaultSnappingManager),t&&(this.snappingManager||(this._defaultSnappingManager=new B({view:t,options:this.snappingOptions})),"2d"===t.type?import("../../chunks/editingTools.js"):"3d"===t.type&&(import("../../chunks/editingTools2.js"),import("../../chunks/GraphicsLayerView3D.js")))},m),u(()=>this.view?.spatialReference,(t,e)=>{t&&e&&!t.equals(e)&&this.cancel()})]),z(this)}destroy(){this.cancel(),this._removeDefaultLayer(),this._defaultSnappingManager=n(this._defaultSnappingManager),this._set("snappingManager",null),this._set("view",null),this._updatingHandles.destroy(),this.emit("destroy")}get updating(){return this._updatingHandles.updating||null!=this.snappingManager&&this.snappingManager.updating}get activeTool(){return this._operationHandle?.tool??null}get activeCreateToolDrawMode(){return"create"===this._operationHandle?.type&&this._operationHandle.activeComponent&&"mode"in this._operationHandle.activeComponent?this._operationHandle.activeComponent.mode:null}get activeTooltip(){const{activeComponent:t,destroyed:e}=this,o=!e&&t&&"tooltip"in t?t.tooltip:null;return o?.visible?o:null}get activeComponent(){return this._operationHandle?.activeComponent??null}get createGraphic(){return null==this.activeComponent||"draw-3d"!==this.activeComponent.type&&"draw-2d"!==this.activeComponent.type?this._get("createGraphic"):this.activeComponent.graphic}get defaultCreateOptions(){return this._get("defaultCreateOptions")}set defaultCreateOptions(t){this._set("defaultCreateOptions",{...rt,...t})}get defaultUpdateOptions(){return this._get("defaultUpdateOptions")}set defaultUpdateOptions(t){this._set("defaultUpdateOptions",{...nt,...t,reshapeOptions:{...nt.reshapeOptions,...t?.reshapeOptions},highlightOptions:{...nt.highlightOptions,...t?.highlightOptions}})}get labelOptions(){return this.sketchOptions.labels}set labelOptions(t){this.sketchOptions.labels=t}get snappingOptions(){return this.snappingManager?.options??this._get("snappingOptions")}set snappingOptions(t){null!=this._defaultSnappingManager&&(this._defaultSnappingManager.options=t),this._set("snappingOptions",t)}get snappingManager(){return this._isOverridden("snappingManager")&&this._get("snappingManager"),this._defaultSnappingManager}set snappingManager(t){if(t)this._isOverridden("snappingManager")||(this._defaultSnappingManager=n(this._defaultSnappingManager)),this._override("snappingManager",t);else{const{view:t}=this;!this._defaultSnappingManager&&t&&(this._defaultSnappingManager=new B({options:this.snappingOptions,view:t})),this._clearOverride("snappingManager")}}get state(){const t=!(!this.view?.ready||!this.layer),e=this._operationHandle;return t&&e?"active":t?"ready":"disabled"}get tooltipOptions(){return this.sketchOptions.tooltips}set tooltipOptions(t){this.sketchOptions.tooltips=t}get valueOptions(){return this.sketchOptions.values}set valueOptions(t){this.sketchOptions.values=t}get view(){return this._get("view")}set view(t){const e=this._get("view");if(e){const{container:t,map:o}=e;t&&this._clearCursor(),o?.remove(this._internalGraphicsLayer),this.removeHandles(this._viewHandlesKey),this.cancel()}const o="view-ready";this.removeHandles(o),t&&this.addHandles(y(()=>t.ready,e=>{this.removeHandles(this._viewHandlesKey),e&&this.addHandles(this._generateViewHandles(t),this._viewHandlesKey)},m),o),this._set("view",t)}cancel(){this._moduleLoaderAbortController=p(this._moduleLoaderAbortController),this._viewReadyAbortController=p(this._viewReadyAbortController),this._sketchContinuationFlag=!0,this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:t,updateGraphics:e}=this;if("active"===t&&e.length){const{activeTool:t,layer:o}=this,i=e.toArray();o.removeMany(i),this.cancel(),this._emitDeleteEvent({graphics:i,tool:t})}}duplicate(){if("active"===this.state&&this.updateGraphics.length){const t=this.updateGraphics.map(t=>t.clone()).toArray();return this.layer.addMany(t),this.emit("duplicate",{graphics:t,type:"duplicate"}),t}return[]}async create(t,e){this.cancel(),await this._waitViewReady();const{view:o,layer:i}=this;if(!o||"disabled"===this.state)throw i||this._logMissingLayer(),l();if(null!=o.activeTool&&(o.activeTool=null),!t)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");L(o,this._internalGraphicsLayer);const s=await this._updatingHandles.addPromise(this._setupCreateOperation(t,e));null==s||this.destroyed?o.map.remove(this._internalGraphicsLayer):(s.on("complete",()=>{if(s===this._operationHandle){const o=this.createGraphic,a=this._operationHandle.cancelled;if(this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view?.map&&this.view.map.remove(this._internalGraphicsLayer),s.cancelled||null==o||i.add(o),this._sketchContinuationFlag=!1,this.emit("create",{graphic:o,state:a?"cancel":"complete",tool:t,toolEventInfo:null,type:"create"}),a||this._sketchContinuationFlag)return;const{creationMode:r}=this;if("continuous"===r){if(e?.geometryToPlace)return;this._updatingHandles.addPromise(h(this.create(t,e)))}else"update"===r&&o&&this._updatingHandles.addPromise(h(this.update([o])))}}),this._operationHandle=s,o.ready&&o.focus())}async place(t,e){return this.create("mesh",{mode:"click",hasZ:t.hasZ,geometryToPlace:t,...e})}async update(t,e){this.cancel(),await this._waitViewReady();const{layer:o,view:i,state:s}=this;if(!i||"disabled"===s)throw o||this._logMissingLayer(),l();null!=i.activeTool&&(i.activeTool=null);const a=Array.isArray(t)?t:[t];if(null==t||!a?.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(a.some(t=>t.layer!==o?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):null==t.geometry&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0)))return;const r=await this._updatingHandles.addPromise(this._setupUpdateOperation(a,e));this.destroyed||null==r||ft(r)||(L(i,this._internalGraphicsLayer),this._setUpdateOperationHandle(r,e),this.emit("update",{graphics:a,state:"start",aborted:!1,tool:r.tool,toolEventInfo:null,type:"update"}))}async _updateSpatialReference(t){const e=this.view;if(e){t=Array.isArray(t)?t:[t];for(const o of t)null==o.geometry||"mesh"===o.geometry.type||j(o.geometry.spatialReference,e.spatialReference)||(k(o.geometry.spatialReference,e.spatialReference)||w()||await G(),o.geometry=T(o.geometry,e.spatialReference))}else this._logMissingView()}undo(){this.canUndo()&&this._operationHandle?.undo()}redo(){this.canRedo()&&this._operationHandle?.redo()}canUndo(){return!!this._operationHandle?.canUndo()}canRedo(){return!!this._operationHandle?.canRedo()}toggleUpdateTool(){this._operationHandle?.toggleTool()}async _getFirstHit(t){const e=this.view;if(!e)return this._logMissingView(),null;if("2d"===e.type){const o=[];e.map.allLayers.forEach(t=>{"vector-tile"!==t.type&&"imagery"!==t.type||o.push(t)});const i=await e.hitTest(t,{exclude:o});return J(i.results)}const o=[e.map.ground];e.map.allLayers.forEach(t=>{E(t.type)&&o.push(t)});const i=await e.hitTest(t,{exclude:o});if(i.results.length>0){const t=i.results[0];if(null!=t&&"graphic"===t.type&&t.graphic&&(!i.ground.mapPoint||e.map.ground.opacity<1||i.ground.distance-(t.distance??0)>-Math.min(3*i.ground.distance,"global"===e.viewingMode?_(e.renderCoordsHelper.spatialReference).radius/e.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY)))return t}return null}_generateViewHandles(t){return[t.on("immediate-click",async t=>{const e="active"===this.state&&"create"===this._operationHandle?.type;"disabled"!==this.state&&!e&&this.updateOnGraphicClick&&await this._updatingHandles.addPromise(this._handleImmediateClick(t))},F.WIDGET)]}async _handleImmediateClick(t){const e=await t.defer(()=>this._getFirstHit(X(t)));let o=null;if(null!=e){const i=e.graphic;this.updateGraphics.includes(i)||i.layer===this.layer?(t.stopPropagation(),o=i):"2d"!==this.view?.type||this._isComponentGraphic(i)||"active"!==this.state||this.cancel()}else"active"===this.state&&this.cancel();null==o||this.updateGraphics.includes(o)||await this.update([o],{...this.defaultUpdateOptions,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions}})}async _setupCreateOperation(t,e){const o=this.view;if(!o)return this._logMissingView(),null;const i={hasZ:"3d"===o.type,...this.defaultCreateOptions,...e},s=await this._setupDrawGraphicTool(t,o,i);return null==s?null:(o.tools.add(s),o.activeTool=s,this._setupCreateOperationHandle(s))}async _setupDrawGraphicTool(t,e,o){if("multipoint"===t&&"3d"===e.type)return this._logError("sketch:create","Multipoint geometries are not supported in SceneView."),null;if(!e)return this._logMissingView(),null;const{cursor:i,defaultZ:s,hasZ:a,geometryToPlace:r,graphicProperties:n,mode:p,preserveAspectRatio:l}=o,c=tt(p,t),h=et(t),d=o?.optionsPerTool?.has(t)?o.optionsPerTool.get(t):{},u=d?.preserveAspectRatio??l??"rectangle"!==t,m={centered:"rectangle"!==t&&!("circle"===t&&!u),cursor:i,defaultZ:s,forceUniformSize:u,graphicProperties:{...n,attributes:{...n?.attributes}},geometryToPlace:r,geometryType:h,mode:c,graphicSymbol:this._getGraphicSymbolFromTool(t),hasZ:a,snappingManager:this.snappingManager,snapToScene:!1,view:e,...d};return"2d"===e.type?this._makeDrawGraphicTool2D(m):this._makeDrawGraphicTool3D(m)}async _makeDrawGraphicTool2D(t){const[e,o,i]=await Promise.all([this._requireModule(import("../../chunks/editingTools.js")),Q(),$()]);return ft(e)||this.destroyed?null:new e.module.DrawGraphicTool2D({...t,activeVertexSymbol:this.activeVertexSymbol,regularVerticesSymbol:this.vertexSymbol,activeLineSymbol:this.activeLineSymbol,activeFillSymbol:(s=t.geometryType,"polygon"===s||"rectangle"===s||"circle"===s?this.activeFillSymbol:null),sketchOptions:this.sketchOptions,automaticAreaMeasurementUtils:o,automaticLengthMeasurementUtils:i});var s}async _makeDrawGraphicTool3D(t){const[e,o,i]=await Promise.all([this._requireModule(import("../../chunks/editingTools2.js")),Q(),$()]);if(ft(e)||this.destroyed)return null;const{elevationInfo:s}=this.layer;return new e.module.DrawGraphicTool3D({...t,elevationInfo:s,snapToScene:!0,sketchOptions:this.sketchOptions,automaticAreaMeasurementUtils:o,automaticLengthMeasurementUtils:i})}_setupCreateOperationHandle(t){const e=this.view;if(!e)return this._logMissingView(),null;let o=null;const i=t.forceUniformSize,a=t.centered,r=[e.on("key-down",e=>{if(e.key===V.pan)e.stopPropagation(),e.repeat||(t.enabled=!1);else if(e.key===V.complete)e.stopPropagation(),t.completeCreateOperation();else if(e.key!==V.vertexAdd||e.repeat)e.key===V.undo?(e.stopPropagation(),n.undo()):e.key===V.redo?(e.stopPropagation(),n.redo()):e.key!==V.constraint||"rectangle"!==t.geometryType&&"circle"!==t.geometryType||e.repeat?e.key===V.center&&(e.repeat||(t.centered=!a,e.stopPropagation())):(t.forceUniformSize=!i,e.stopPropagation());else{const o=t.drawOperation.geometryType;"polyline"!==o&&"polygon"!==o&&"multipoint"!==o||(e.stopPropagation(),t.drawOperation.commitStagedVertex())}},F.WIDGET),e.on("key-up",e=>{e.key===V.pan?t.enabled=!0:e.key!==V.constraint||"rectangle"!==t.geometryType&&"circle"!==t.geometryType?e.key===V.center&&(t.centered=a,e.stopPropagation()):(t.forceUniformSize=i,e.stopPropagation())},F.WIDGET),t.on("vertex-add",e=>{switch(o=null==o?"start":"active",e.operation){case"apply":this.emit("create",{graphic:t.graphic,state:o,tool:this.activeTool,toolEventInfo:e,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[t.graphic],tool:t.geometryType});break;case"redo":this._emitRedoEvent({graphics:[t.graphic],tool:t.geometryType})}}),t.on("cursor-update",e=>{t.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:t.graphic,state:"active",tool:this.activeTool,toolEventInfo:{coordinates:e.vertices[0].coordinates,type:"cursor-update"},type:"create"})}),t.on("vertex-remove",e=>{switch(e.operation){case"apply":this.emit("create",{graphic:t.graphic,state:"active",tool:this.activeTool,toolEventInfo:e,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[t.graphic],tool:t.geometryType});break;case"redo":this._emitRedoEvent({graphics:[t.graphic],tool:t.geometryType})}}),t.on("complete",t=>{this._set("createGraphic",t.graphic),o="complete",t.aborted?n&&n.cancel():n&&n.complete()}),u(()=>this._getGraphicSymbolFromTool(t.geometryType),e=>{t.graphicSymbol=e})],n=new st({activeComponent:t,tool:t.geometryType,type:"create",onEnd:()=>{s(r),e.tools?.remove(t)},undo:()=>{t.canUndo&&t.undo()},redo:()=>{t.canRedo&&t.redo()},canUndo:()=>t.canUndo,canRedo:()=>t.canRedo});return n}_getGraphicSymbolFromTool(t){switch(t){case"point":case"multipoint":return this.pointSymbol;case"polyline":case"freehandPolyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":case"freehandPolygon":return this.polygonSymbol;case"mesh":return this.meshSymbol}}async _setupUpdateOperation(t,e){const{layer:o,view:i}=this;if(!i)return this._logMissingView(),null;const s={...this.defaultUpdateOptions,...e,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...e?.reshapeOptions},highlightOptions:{...this.defaultUpdateOptions.highlightOptions,...e?.highlightOptions}};let a=s.tool??nt.tool;for(const e of t)o.remove(e),o.add(e);if("3d"===i.type){if(0===t.length)return null;switch(a){case"move":return this._setupMove3DOperation(t,s,i,a);case"reshape":return t.length>1?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null):this._setupReshape3DOperation(t[0],s,i);case"transform":return this._setupGraphicTransform3DOperation(t,s,i)}}switch(a){case"move":return this._setupMove2DOperation(t,s,i);case"reshape":return t.length>1?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null):this._setupTransformOrReshape2DOperation(t,a,s,i);case"transform":if(1===t.length){const e=t[0].geometry?.type;"point"!==e&&"multipoint"!==e||(a="reshape")}return this._setupTransformOrReshape2DOperation(t,a,s,i)}}async _setupMove3DOperation(t,e,o,i,a=!1){const[r,n]=await Promise.all([this._requireModule(import("../../chunks/editingTools2.js")),$()]);if(ft(r))return r;const{ManipulatedObject3DGraphic:p,MoveTool3D:l}=r.module,c=new Map,h=()=>{c.forEach(t=>t.destroy()),c.clear()};for(const e of t){const t=new p({view:o,graphic:e}),i=I(t);if(0!==i)return h(),this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${ot(i)}).`),null;c.set(e,t)}const d=new l({view:o,enableZ:e.enableZ,snappingManager:this.snappingManager,sketchOptions:this.sketchOptions,autoLengthMeasurementUtils:n});o.tools.add(d),d.objects.addMany(Array.from(c.values())),a||this.updateGraphics.addMany(t);const u=[],m=new at({activeComponent:d,tool:i,type:"update",onEnd:()=>{s(u),vt(o,d),h()},undo:()=>{yt(this.view,d),dt(m,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{ut(m,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:t=>{this.updateGraphics.push(t);const e=new p({view:o,graphic:t});c.set(t,e),d.objects.push(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:t=>{const e=this.updateGraphics.indexOf(t);if(m.history.undo.forEach(t=>t.updates.splice(e,1)),m.history.redo.forEach(t=>t.updates.splice(e,1)),this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),0===this.updateGraphics.length)return void m.complete();const o=c.get(t);o&&(d.objects.remove(o),o.destroy(),c.delete(t))},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===e.toggleToolOnClick)return;if("transform"!==i)return;const t=this.updateGraphics.at(0),s=await this._setupReshape3DOperation(t,e,o,!0);s&&!ft(s)&&(m.onEnd(),m.destroy(),this._setUpdateOperationHandle(s,e))}});return u.push(...this._getHandlesForComponent(m,e),o.on("immediate-click",t=>this._getCommonUpdateOperationClickHandlers(m,t,e),F.WIDGET),o.on("key-down",t=>{this._getCommonUpdateOperationKeyDownHandlers(m,t)},F.WIDGET)),m}_setupGraphicTransform3DOperation(t,e,o,i=!1){if(1===t.length&&0===function(t){if("graphics"!==t.layer?.type)return 1;if(null==t.geometry)return 2;switch(t.geometry.type){case"point":break;case"polygon":case"polyline":case"multipoint":case"extent":case"mesh":return 0;default:return 3}const e=null!=t.symbol&&"point-3d"===t.symbol.type&&t.symbol.symbolLayers;return e&&e.some(t=>"object"===t.type)?"on-the-ground"!==P(t)&&x(t)?4:0:5}(t[0])){const s=t[0],a=s.geometry;if(null!=a&&("point"===a.type||"mesh"===a.type))return this._setupPointTransform3DOperation(s,e,o);if(null!=a&&("polygon"===a.type||"polyline"===a.type))return this._setupPolyTransform3DOperation(s,e,o,i)}return this._setupMove3DOperation(t,e,o,"transform",i)}async _setupPointTransform3DOperation(t,e,o){const i="transform",{enableRotation:a,enableScaling:r,enableZ:n}=e,p=await this._requireModule(import("../../chunks/editingTools2.js"));if(ft(p))return p;const{TransformTool3D:l,ManipulatedObject3DGraphic:c}=p.module,h=new c({graphic:t,view:o}),d=new l({object:h,view:o,enableRotation:a,enableScaling:r,enableZ:n,snappingManager:this.snappingManager,sketchOptions:this.sketchOptions});o.tools.add(d),this.updateGraphics.add(t);const u=[],m=new at({activeComponent:d,tool:i,type:"update",onEnd:()=>{s(u),vt(o,d),h.destroy()},undo:()=>{yt(this.view,d),dt(m,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{ut(m,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:async t=>{this.updateGraphics.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"}),m.onEnd(),m.destroy();const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),e,o,"transform",!0);ft(i)||this._setUpdateOperationHandle(i,e)},removeFromSelection:t=>{this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),m.complete()},toggleTool:()=>{}});return u.push(...this._getHandlesForComponent(m,e),o.on("immediate-click",t=>this._getCommonUpdateOperationClickHandlers(m,t,e),F.WIDGET),o.on("key-down",t=>{this._getCommonUpdateOperationKeyDownHandlers(m,t)},F.WIDGET)),m}async _setupPolyTransform3DOperation(t,e,o,i=!1){const a="transform",{enableRotation:r,enableScaling:n,enableZ:p,preserveAspectRatio:l}=e,[c,h]=await Promise.all([this._requireModule(import("../../chunks/editingTools2.js")),$()]);if(ft(c))return c;const{ManipulatedObject3DGraphic:d,ExtentTransformTool:u}=c.module,m=this.view?.inputManager?.isModifierKeyDown(V.constraint),y=new d({view:o,graphic:t}),g=new u({object:y,view:o,enableRotation:r,enableScaling:n,enableZ:p,preserveAspectRatio:!!l!=!!m,sketchOptions:this.sketchOptions,automaticLengthMeasurementUtils:h});o.tools.add(g),i||this.updateGraphics.add(t);const v=[],f=new at({activeComponent:g,tool:a,type:"update",onEnd:()=>{s(v),vt(o,g),y.destroy()},canUndo:()=>!g.destroyed&&g.canUndo,undo:()=>{g.destroyed||(g.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},canRedo:()=>!g.destroyed&&g.canRedo,redo:()=>{g.destroyed||(g.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},addToSelection:async t=>{this.updateGraphics.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"}),f.onEnd(),f.destroy();const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),e,o,"transform",!0);ft(i)||this._setUpdateOperationHandle(i,e)},removeFromSelection:t=>{this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),f.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===e.toggleToolOnClick)return;const i=await this._setupReshape3DOperation(t,e,o,!0);i&&!ft(i)&&(f.onEnd(),f.destroy(),this._setUpdateOperationHandle(i,e))}});return v.push(...this._getHandlesForComponent(f,e),o.on("immediate-click",t=>this._getCommonUpdateOperationClickHandlers(f,t,e),F.WIDGET),o.on("key-down",t=>this._getCommonUpdateOperationKeyDownHandlers(f,t),F.WIDGET),o.on("key-down",t=>{t.key!==V.constraint||t.repeat||(g.preserveAspectRatio=!g.preserveAspectRatio,t.stopPropagation())},F.WIDGET),o.on("key-up",t=>{t.key===V.constraint&&(g.preserveAspectRatio=!g.preserveAspectRatio,t.stopPropagation())},F.WIDGET)),f}async _setupMove2DOperation(t,e,o){const i="move";this.updateGraphics.addMany(t),await this._updatingHandles.addPromise(this._updateSpatialReference(t));const a=await this._getGraphicMover(t,e,o);if(ft(a))return a;const r=new at({activeComponent:a,tool:i,type:"update",onEnd:()=>{this._clearCursor(),s(l),s(p),a.destroy(),this._internalGraphicsLayer?.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const t=this.updateGraphics.toArray();dt(r,t),r.refreshComponent(),this._emitUndoEvent({graphics:t,tool:i})},redo:()=>{const t=this.updateGraphics.toArray();ut(r,t),r.refreshComponent(),this._emitRedoEvent({graphics:t,tool:i})},addToSelection:async t=>{await this._updatingHandles.addPromise(this._updateSpatialReference(t)),this.updateGraphics.push(t),a.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:t=>{const e=this.updateGraphics.indexOf(t);r.history.undo.forEach(t=>t.updates.splice(e,1)),r.history.redo.forEach(t=>t.updates.splice(e,1)),this.updateGraphics.remove(t);const o=this.updateGraphics.toArray();this.emit("update",{graphics:o,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?a.graphics=o:r.complete()}});let n=!1;const p=[o.on("immediate-click",t=>this._getCommonUpdateOperationClickHandlers(r,t,e),F.WIDGET),o.on("key-down",t=>{this._getCommonUpdateOperationKeyDownHandlers(r,t),t.key!==V.constraint||t.repeat||(n=!0,a.enableMoveAllGraphics=!a.enableMoveAllGraphics)},F.WIDGET),o.on("key-up",t=>{t.key===V.constraint&&n&&(n=!1,a.enableMoveAllGraphics=!a.enableMoveAllGraphics)},F.WIDGET)],l=this._getHandlesForComponent(r,e);return r}async _setupReshape3DOperation(t,e,o,i=!1){const a="reshape",[r,n,p]=await Promise.all([this._requireModule(import("../../chunks/editingTools2.js")),Q(),$()]);if(ft(r))return r;const{ManipulatedObject3DGraphic:l,ReshapeTool3D:c}=r.module,h=new l({view:o,graphic:t}),d=function(t){return function(t){if(t.graphic&&"graphics"!==t.graphic.layer?.type)return{result:1};if(!t.operations)return{result:2};if(R(t.elevationInfo))return{result:4};const e=t.operations.data.type,o=t.operations.data.geometry;return"point"===e||"mesh"===e||"polyline"===e||"polygon"===e?{result:0,geometry:o}:{result:3}}(t).result}(h);if(0!==d)return h.destroy(),this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${ot(d)}).`),null;const u=e.reshapeOptions,m=new c({view:o,object:h,enableZVertex:e.enableZ&&"move"===u?.vertexOperation,enableZShape:e.enableZ&&"move"===u?.shapeOperation,enableMoveObject:"move"===u?.shapeOperation||"move-xy"===u?.shapeOperation,enableMidpoints:"split"===u?.edgeOperation,enableEdgeOffset:"offset"===u?.edgeOperation,snappingManager:this.snappingManager,sketchOptions:this.sketchOptions,automaticAreaMeasurementUtils:n,automaticLengthMeasurementUtils:p});o.tools.add(m),i||this.updateGraphics.add(h.graphic);const y=[],g=new at({activeComponent:m,tool:a,type:"update",onEnd:()=>{s(y),vt(o,m),h.destroy()},canUndo:()=>!m.destroyed&&m.canUndo,undo:()=>{m.destroyed||(m.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},canRedo:()=>!m.destroyed&&m.canRedo,redo:()=>{m.destroyed||(m.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},addToSelection:async t=>{this.updateGraphics.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"}),g.onEnd(),g.destroy();const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),e,o,"transform",!0);ft(i)||this._setUpdateOperationHandle(i,e)},removeFromSelection:t=>{this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),g.complete()},toggleTool:async()=>{if(!1===e.toggleToolOnClick)return;g.onEnd(),g.destroy();const t=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),e,o,!0);ft(t)||this._setUpdateOperationHandle(t,e)}});return y.push(...this._getHandlesForComponent(g,e),o.on("immediate-click",t=>this._getCommonUpdateOperationClickHandlers(g,t,e),F.WIDGET),o.on("key-down",t=>{this._getCommonUpdateOperationKeyDownHandlers(g,t)},F.WIDGET)),g}async _setupTransformOrReshape2DOperation(t,e,o,i){this.updateGraphics.addMany(t),await this._updatingHandles.addPromise(this._updateSpatialReference(t));const a="transform"===e?await this._getBox(t,o,i):await this._getReshape(t,o,i);if(ft(a))return a;const r=new at({activeComponent:a,type:"update",onEnd:()=>{s(p),s(n),r.activeComponent&&!r.activeComponent.destroyed&&r.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{dt(r,this.updateGraphics.toArray()),r.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:r.tool})},redo:()=>{ut(r,this.updateGraphics.toArray()),r.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:r.tool})},addToSelection:async t=>{let e=r.activeComponent;if("reshape"===e?.type){const e=[...this.updateGraphics,t];this.updateGraphics.removeAll(),r.onEnd(),r.destroy();const s=await this._setupTransformOrReshape2DOperation(e,"transform",o,i);if(ft(s))return;this._setUpdateOperationHandle(s,o)}else this.updateGraphics.add(t),e.graphics=this.updateGraphics.toArray(),e.refresh(),r.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:t=>{const e=this.updateGraphics.indexOf(t);r.history.undo.forEach(t=>t.updates.splice(e,1)),r.history.redo.forEach(t=>t.updates.splice(e,1)),this.updateGraphics.remove(t);const o=this.updateGraphics.toArray();if(0===o.length)r.complete();else{const t=o[0].geometry;1!==o.length||null==t||"point"!==t.type&&"multipoint"!==t.type?r.activeComponent.graphics=o:r.toggleTool()}this.emit("update",{graphics:o,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"})},toggleTool:async()=>{if(this.updateGraphics.length>1)return;const t=this.updateGraphics.at(0),e=t.geometry;if(null!=e&&("reshape"===r.tool&&("point"===e.type||"multipoint"===e.type)||"transform"===r.tool&&"extent"===e.type))return;let a=null;"transform"===r.tool?a=await this._getReshape([t],o,i):"reshape"===r.tool&&(a=await this._getBox([t],o,i)),ft(a)||(r.activeComponent?.destroy(),r.activeComponent=a,r.activeComponent&&(s(p),p=this._getHandlesForComponent(r,o)))}}),n=[i.on("immediate-click",t=>this._getCommonUpdateOperationClickHandlers(r,t,o),F.WIDGET),i.on("key-down",t=>{if(this._getCommonUpdateOperationKeyDownHandlers(r,t),t.key===V.constraint&&!t.repeat&&r){const t=r.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}},F.WIDGET),i.on("key-up",t=>{if(t.key===V.constraint&&r){const t=r.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}},F.WIDGET)];let p=this._getHandlesForComponent(r,o);return r}async _getGraphicMover(t,e,o){const{enableMoveAllGraphics:i,highlightOptions:s}=e,a=await this._requireModule(import("../../chunks/GraphicMover.js"));return ft(a)?a:new a.module.default({enableMoveAllGraphics:i,highlightName:s?.name,highlightsEnabled:!!s?.enabled,indicatorsEnabled:!1,graphics:t,view:o,callbacks:{onGraphicMoveStart:({dx:t,dy:e,graphic:o})=>{this._displayCursor("grabbing"),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:"move-start"},type:"update"})},onGraphicMove:({dx:t,dy:e,graphic:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:"move"},type:"update"}),onGraphicMoveStop:({dx:t,dy:e,graphic:o})=>{this._displayCursor("pointer"),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayCursor("move"),onGraphicPointerOut:()=>this._clearCursor()}})}async _getBox(t,e,o){const{enableRotation:i,enableScaling:s,highlightOptions:a,preserveAspectRatio:r}=e,[n,p]=await Promise.all([this._requireModule(import("../../chunks/Box.js")),$()]);if(ft(n))return n;const l=this.view?.inputManager?.isModifierKeyDown(V.constraint);return new n.module.default({graphics:t,enableRotation:i,enableScaling:s,highlightName:a?.name,highlightsEnabled:!!a?.enabled,preserveAspectRatio:!!r!=!!l,layer:this._internalGraphicsLayer,view:o,sketchOptions:this.sketchOptions,automaticLengthMeasurementUtils:p,callbacks:{onMoveStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onMove:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onMoveStop:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onScaleStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onScale:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onScaleStop:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onRotateStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onRotate:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onRotateStop:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"})}})}async _getReshape(t,e,o){const{highlightOptions:i,reshapeOptions:s}=e,a="split"===s?.edgeOperation,r="move"===s?.shapeOperation,[n,p,l]=await Promise.all([this._requireModule(import("../../chunks/Reshape.js")),Q(),$()]);return ft(n)?n:new n.module.default({enableMidpoints:a,enableMovement:r,graphic:t[0],highlightName:i?.name,highlightsEnabled:!!i?.enabled,layer:this._internalGraphicsLayer,snappingManager:this.snappingManager,sketchOptions:this.sketchOptions,automaticAreaMeasurementUtils:p,automaticLengthMeasurementUtils:l,view:o,callbacks:{onReshapeStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onReshape:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onReshapeStop:({mover:t,type:e})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t,type:e},type:"update"}),onMoveStart:({dx:t,dy:e,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:i},type:"update"}),onMove:({dx:t,dy:e,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:i},type:"update"}),onMoveStop:({dx:t,dy:e,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:i},type:"update"}),onVertexAdd:({added:t,type:e,vertices:o})=>{const i=t.map(t=>O(t.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:i,vertices:o,type:e},type:"update"})},onVertexRemove:({removed:t,type:e,vertices:o})=>{const i=t.map(t=>O(t.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:i,vertices:o,type:e},type:"update"})}}})}_getHandlesForComponent(t,e){const o=t.activeComponent;if(!o)return[];switch(o.type){case"graphic-mover":return[o.on("graphic-click",({graphic:o,viewEvent:i})=>{i.native?.shiftKey&&e.multipleSelectionEnabled&&(i.stopPropagation(),t.removeFromSelection(o))}),o.on("graphic-move-start",e=>t.addToHistory(gt(e.allGraphics)))];case"box":return[o.on("graphic-click",o=>this._onTransformOrReshape2DGraphicClick(t,e,o)),o.on("move-start",e=>t.addToHistory(gt(e.graphics))),o.on("rotate-start",e=>t.addToHistory(gt(e.graphics))),o.on("scale-start",e=>t.addToHistory(gt(e.graphics)))];case"reshape":return[o.on("graphic-click",o=>this._onTransformOrReshape2DGraphicClick(t,e,o)),o.on("move-start",e=>t.addToHistory(gt([e.mover]))),o.on("reshape-start",e=>t.addToHistory(gt([e.graphic]))),o.on("vertex-add",e=>t.addToHistory(gt([e.oldGraphic]))),o.on("vertex-remove",e=>t.addToHistory(gt([e.oldGraphic])))];case"move-3d":return[o.events.on("record-undo",({updates:e})=>{t.addToHistory({updates:e})}),o.events.on("move-start",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.objects.length>0?t.objects[0].graphic:null,type:"move-start"},type:"update"})}),o.events.on("move",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t.dx,dy:t.dy,mover:t.objects.length>0?t.objects[0].graphic:null,type:"move"},type:"update"})}),o.events.on("move-stop",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.objects.length>0?t.objects[0].graphic:null,type:"move-stop"},type:"update"})}),o.events.on("immediate-click",o=>{o.shiftKey?this._toggleSelection([o.object.graphic],t,e):t.toggleTool()})];case"transform-3d":return[o.events.on("record-undo",({updates:e})=>{t.addToHistory({updates:e})}),o.events.on("translate-start",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.object.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-start"},type:"update"})}),o.events.on("translate-stop",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.object.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-stop"},type:"update"})}),o.events.on("rotate-start",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.object.graphic,angle:t.angle,type:"rotate-start"},type:"update"})}),o.events.on("rotate-stop",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.object.graphic,angle:t.angle,type:"rotate-stop"},type:"update"})}),o.events.on("scale-start",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.object.graphic,xScale:t.xScale,yScale:t.yScale,type:"scale-start"},type:"update"})}),o.events.on("scale-stop",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.object.graphic,xScale:t.xScale,yScale:t.yScale,type:"scale-stop"},type:"update"})}),o.events.on("translate",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.object.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move"},type:"update"})}),o.events.on("rotate",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.object.graphic,angle:t.angle,type:"rotate"},type:"update"})}),o.events.on("scale",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.object.graphic,xScale:t.xScale,yScale:t.yScale,type:"scale"},type:"update"})}),o.events.on("immediate-click",o=>{o.shiftKey?this._toggleSelection([o.object.graphic],t,e):t.toggleTool()})];case"reshape-3d":return[o.events.on("reshape",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t,mover:t.object.graphic},type:"update"})}),o.events.on("move",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t,mover:t.object.graphic},type:"update"})}),o.events.on("vertex-add",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})}),o.events.on("vertex-remove",t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})}),o.events.on("immediate-click",o=>{o.shiftKey?this._toggleSelection([o.object.graphic],t,e):t.toggleTool()})]}}_onTransformOrReshape2DGraphicClick(t,e,o){const{graphic:i,viewEvent:s}=o;return s.native?.shiftKey&&i.layer===this.layer?(s.stopPropagation(),t.removeFromSelection(i)):e.toggleToolOnClick?(s.stopPropagation(),t.toggleTool()):void 0}_setUpdateOperationHandle(t,e){this._operationHandle=t;const o=this.view?.map;this._disablePopup(e),t.on("complete",()=>{if(t===this._operationHandle){const i=this.updateGraphics.toArray(),s=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),o&&o.remove(this._internalGraphicsLayer),this._restorePopup(e),this.emit("update",{graphics:i,state:"complete",aborted:t.cancelled,tool:s,toolEventInfo:null,type:"update"})}})}async _getCommonUpdateOperationClickHandlers(t,e,o){const i=X(e),s=await e.defer(()=>this._getFirstHit(i));null!=s&&(e.native.shiftKey&&this._toggleSelection([s.graphic],t,o)||this.updateGraphics.includes(s.graphic))?e.stopPropagation():t.complete()}_toggleSelection(t,e,o){const i=!!o.multipleSelectionEnabled;return t.some(t=>!(null==t||!i||t.layer!==this.layer||(this.updateGraphics.includes(t)?e.removeFromSelection(t):e.addToSelection(t),0)))}_getCommonUpdateOperationKeyDownHandlers(t,e){if(!t)return;const o=e.key;o===V.undo&&t.canUndo()?(e.stopPropagation(),t.undo()):o===V.redo&&t.canRedo()?(e.stopPropagation(),t.redo()):o===V.cancel?(e.stopPropagation(),t.cancel()):this.allowDeleteKey&&V.delete.includes(o)&&this._onDeleteKey(e)}_onDeleteKey(t){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const e=this.activeComponent,o=this.updateGraphics.toArray();null!=e&&("reshape"!==e.type||1===o.length&&"point"===o[0].geometry?.type)&&(t.stopPropagation(),this.delete())}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view?.map?.remove(this._internalGraphicsLayer),this._internalGraphicsLayer=n(this._internalGraphicsLayer))}_isComponentGraphic(t){const{activeComponent:e}=this;return!(!t||null==e)&&(t.attributes?.esriSketchTool||"draw-2d"===e.type&&e.graphic===t||("box"===e.type||"reshape"===e.type)&&e.isUIGraphic(t))}_clearCursor(){this.removeHandles(pt)}_displayCursor(t){this.removeHandles(pt),this.view?.container&&null!=t&&this.addHandles(this.view.acquireCursor(t,"high"),pt)}_logError(t,e,i){r.getLogger(this).error(new o(t,e,i))}async _requireModule(t){const e=new AbortController;this._moduleLoaderAbortController=e;const o=await t;return this._moduleLoaderAbortController!==e||e.signal.aborted?{requireError:"aborted"}:{module:o}}_emitUndoEvent(t){this.emit("undo",{...t,type:"undo"})}_emitRedoEvent(t){this.emit("redo",{...t,type:"redo"})}_emitDeleteEvent(t){this.emit("delete",{...t,type:"delete"})}get test(){}wait(){return g(()=>!this.updating)}_disablePopupEnabled(t){return"3d"!==this.view?.type||this.updateOnGraphicClick||(t?.toggleToolOnClick??!1)}_disablePopup(t){this._disablePopupEnabled(t)&&this.view&&null==this._originalPopupEnabled&&(this._originalPopupEnabled=this.view.popupEnabled,this.view.popupEnabled=!1)}_restorePopup(t){this._disablePopupEnabled(t)&&this.view&&null!=this._originalPopupEnabled&&(this.view.popupEnabled=this._originalPopupEnabled,this._originalPopupEnabled=null)}async _waitViewReady(){const t=this.view;t?(p(this._viewReadyAbortController),this._viewReadyAbortController=new AbortController,await c(g(()=>t?.ready),this._viewReadyAbortController.signal)):this._logMissingView()}_logMissingView(){this._logError("sketch:missing-property",ht("view"))}_logMissingLayer(){this._logError(ct,ht("layer"))}};t([v()],lt.prototype,"_defaultSnappingManager",void 0),t([v()],lt.prototype,"updating",null),t([v({readOnly:!0})],lt.prototype,"_updatingHandles",void 0),t([v()],lt.prototype,"_operationHandle",void 0),t([v({readOnly:!0})],lt.prototype,"activeTool",null),t([v({readOnly:!0})],lt.prototype,"activeCreateToolDrawMode",null),t([v()],lt.prototype,"activeTooltip",null),t([v({types:D})],lt.prototype,"activeFillSymbol",void 0),t([v()],lt.prototype,"activeLineSymbol",void 0),t([v()],lt.prototype,"activeVertexSymbol",void 0),t([v()],lt.prototype,"allowDeleteKey",void 0),t([v({readOnly:!0})],lt.prototype,"createGraphic",null),t([v()],lt.prototype,"defaultCreateOptions",null),t([v()],lt.prototype,"defaultUpdateOptions",null),t([v({type:K,nonNullable:!0})],lt.prototype,"labelOptions",null),t([v()],lt.prototype,"layer",void 0),t([v({types:D})],lt.prototype,"pointSymbol",void 0),t([v({types:D})],lt.prototype,"polygonSymbol",void 0),t([v({types:D})],lt.prototype,"polylineSymbol",void 0),t([v()],lt.prototype,"meshSymbol",void 0),t([v({type:N,nonNullable:!0})],lt.prototype,"snappingOptions",null),t([v()],lt.prototype,"snappingManager",null),t([v({readOnly:!0})],lt.prototype,"state",null),t([v({type:q,nonNullable:!0})],lt.prototype,"tooltipOptions",null),t([v({readOnly:!0})],lt.prototype,"updateGraphics",void 0),t([v()],lt.prototype,"updateOnGraphicClick",void 0),t([v()],lt.prototype,"creationMode",void 0),t([v({type:Z,nonNullable:!0})],lt.prototype,"valueOptions",null),t([v({types:D})],lt.prototype,"vertexSymbol",void 0),t([v({value:null})],lt.prototype,"view",null),t([v({constructOnly:!0,type:W})],lt.prototype,"sketchOptions",void 0),lt=t([f("esri.widgets.Sketch.SketchViewModel")],lt);const ct="sketch:missing-property",ht=t=>`Property '${t}' is missing on SketchViewModel.`;function dt(t,e){mt("undo",t.history.undo,t.history.redo,e)}function ut(t,e){mt("redo",t.history.redo,t.history.undo,e)}function mt(t,e,o,i){const s=e.pop();if(!s)return;const a=s.updates,r=[];i.forEach((e,o)=>{const i=a[o];null!=i&&("geometry"in i&&null!=i.geometry&&(r.push({geometry:e.geometry}),e.geometry=i.geometry),"symbol"in i&&null!=i.symbol&&(r.push({symbol:e.symbol}),e.symbol=i.symbol),"undo"in i&&(r.push(i),i[t](e)))}),o.push({updates:r})}function yt(t,e){null!=t&&e.hasGrabbedManipulators&&(t.activeTool=null)}function gt(t){return{updates:t.map(({geometry:t})=>"mesh"===t?.type?{geometry:t.cloneShallow()}:{geometry:t})}}function vt(t,e){t.tools?.remove(e),e.destroyed||e.destroy()}function ft(t){return"requireError"in t&&"aborted"===t.requireError}export{lt as default};
