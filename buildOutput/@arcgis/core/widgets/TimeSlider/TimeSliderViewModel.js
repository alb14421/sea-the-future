/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../core/Collection.js";import{EventedAccessor as i}from"../../core/Evented.js";import{L as s}from"../../chunks/Logger.js";import{after as n,isAbortError as r}from"../../core/promiseUtils.js";import{watch as o,initial as l,syncAndInitial as a,whenOnce as m}from"../../core/reactiveUtils.js";import{o as u}from"../../chunks/timeUtils.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import{e as h}from"../../chunks/ensureType.js";import"../../core/lang.js";import{subclass as c}from"../../core/accessorSupport/decorators/subclass.js";import d from"../../time/TimeExtent.js";import f from"../../time/TimeInterval.js";import{a as g}from"../../chunks/Widgets.js";import w from"../../webdoc/widgets/TimeSlider.js";import"../../chunks/watch.js";import"../../chunks/ObjectPool.js";import"../../chunks/handleUtils.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/SetUtils.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/Lifecycle.js";import"../../chunks/tracking.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/ObservableBase.js";import"../../chunks/jsonUtils.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/maybe.js";import"../../chunks/metadata.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../core/Error.js";import"../../chunks/events.js";import"../../chunks/MapUtils.js";import"../../chunks/Warning.js";import"../../chunks/date.js";import"../../chunks/jsonMap.js";import"../../chunks/locale.js";import"../../chunks/constants.js";import"../../chunks/datetime.js";import"../../core/JSONSupport.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../core/Clonable.js";import"../../chunks/enumeration.js";function v(t){return null!=t&&void 0!==t.count}function T(t){return null!=t&&void 0!==t.interval}function j(t){return null!=t&&void 0!==t.dates}let x=class extends i{constructor(t){super(t),this._animationController=null,this._isViewTimeExtentInitialized=!1,this._timerId=null,this.actions=new e,this.fullTimeExtent=null,this.loop=!1,this.mode="time-window",this.stops={count:10},this.timeExtent=null,this.view=null}initialize(){this.addHandles([o(()=>this.effectiveStops,()=>{this.timeExtent??=this._getDefaultTimeExtent()},l),o(()=>this.view,(t,e)=>{this._unregisterWidget(e),this._registerWidget(t)},a),o(()=>this.timeExtent,t=>{if(!this.view)return;const e=this.view.timeExtent;(t&&!t.isAllTime||e&&!e.isAllTime)&&(t&&e&&t.equals(e)||(this.view.timeExtent=t))},l),o(()=>this.view?.timeExtent,t=>{this._isViewTimeExtentInitialized?(t&&!t.isAllTime||this.timeExtent&&!this.timeExtent.isAllTime)&&(t&&this.timeExtent&&t.equals(this.timeExtent)||(this.timeExtent=t)):this._isViewTimeExtentInitialized=!0})])}destroy(){null!=this._timerId&&(clearInterval(this._timerId),this._timerId=null),this._unregisterWidget(this.view),this.view=null,this._animationController&&(this._animationController.abort(),this._animationController=null)}get effectiveStops(){const{fullTimeExtent:t,stops:e}=this;if(j(e)){const{dates:i}=e;if(!i?.length)return null;const s=i.sort((t,e)=>t.getTime()-e.getTime());if(!t)return s;const{start:n,end:r}=t;return n&&r?s.filter(t=>!(t.getTime()<n.getTime()||t.getTime()>r.getTime())):s}if(v(e)){const i=e.timeExtent??t;return this._divideTimeExtentByCount(i,e.count)}if(T(e)){const i=e.timeExtent??t;return this._divideTimeExtentByInterval(i,e.interval)}return[]}set playRate(t){t<=0||t>36e5||("playing"===this.state&&this._startAnimation(),this._set("playRate",t))}get state(){return this.fullTimeExtent?this._animationController?"playing":"ready":"disabled"}get timeExtentValues(){const{mode:t,timeExtent:e}=this;if(!e||e.isAllTime||e.isEmpty)return null;const{start:i,end:s}=e;switch(t){case"cumulative-from-end":case"instant":return i?[i.getTime()]:null;case"cumulative-from-start":return s?[s.getTime()]:null;case"time-window":return i&&s?[i.getTime(),s.getTime()]:null}}next(){this._step({forward:!0,allowRestart:!1})}play(){this._startAnimation()}previous(){this._step({forward:!1,allowRestart:!1})}stop(){this._stopAnimation()}triggerAction(t){this.emit("trigger-action",{action:t})}updateWebDocument(t){const e=new w({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:v(this.stops)?this.stops.count:null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:T(this.stops)?this.stops.interval:null,stops:j(this.stops)?this.stops.dates:null});t.widgets?t.widgets.timeSlider=e:t.widgets=new g({timeSlider:e})}valuesToTimeExtent(t){if(!t)return null;const e=t.sort((t,e)=>t-e).map(t=>new Date(t)),i=e.length>0?e[0]:null,s=e.length>1?e[1]:null;switch(this.mode){case"time-window":return new d({start:i,end:s});case"instant":return new d({start:i,end:i});case"cumulative-from-start":return new d({start:null,end:i});case"cumulative-from-end":return new d({start:i,end:null});default:return d.allTime}}async _animate(){try{const t=this.view,e=this._animationController?.signal;await Promise.all([n(this.playRate,null,e),t&&m(()=>!t.updating,e)])}catch(t){return r(t)||s.getLogger(this).error(t),void(this._animationController=null)}this._step({forward:!0,allowRestart:!1}),this._animationController&&this._animate()}_divideTimeExtentByCount(t,e=10){if(!t||!e)return[];const{start:i,end:s}=t;if(!i||!s)return[];if(e>1e4)return this._divideTimeExtentByCount(t);const n=[],r=i.getTime(),o=s.getTime()-r;for(let t=0;t<=e;t++)n.push(new Date(r+t/e*o));return n}_divideTimeExtentByInterval(t,e,i=1e4){if(!t||!e)return[];const{start:s,end:n}=t;if(!s||!n)return[];const r=n.getTime()-s.getTime(),o=e.toMilliseconds();if(o<=0||r/o>i)return this._divideTimeExtentByCount(t);const l=[],{value:a,unit:m}=e;let p=s;for(;p.getTime()<=n.getTime();)l.push(new Date(p.getTime())),p=u(p,a,m);return l}_getDefaultTimeExtent(){const{effectiveStops:t,mode:e}=this;if(!t||!e)return null;switch(e){case"time-window":return t.length>1?new d({start:t[0],end:t[1]}):null;case"cumulative-from-start":return t.length>0?new d({start:null,end:t[0]}):null;case"cumulative-from-end":return t.length>0?new d({start:t[0],end:null}):null;case"instant":return t.length>0?new d({start:t[0],end:t[0]}):null;default:return null}}_registerWidget(t){t&&(t.persistableViewModels.includes(this)||t.persistableViewModels.add(this))}_startAnimation(){this._stopAnimation(),this._animationController=new AbortController,this._step({forward:!0,allowRestart:!0}),this._animate()}_step(t){const{forward:e,allowRestart:i}=t,{effectiveStops:s}=this;if(!this.timeExtentValues||!s)return;const n=s.map(t=>t.getTime()),r=this.timeExtentValues.map(t=>{const e=n.indexOf(t);if(-1!==e)return e;const i=n.reduce((e,i)=>Math.abs(i-t)<Math.abs(e-t)?i:e);return n.indexOf(i)}),o=r.map(t=>t+(e?1:-1)),l=o.some(t=>t<0||t>n.length-1),{loop:a,state:m}=this;if(l)if(a||i){const t=Math.min(...r),i=Math.max(...r),s=(e?r.map(e=>e-t):r.map(t=>t+(n.length-1-i))).map(t=>n[t]);this.timeExtent=this.valuesToTimeExtent(s)}else"playing"===m&&this.stop();else{const t=o.map(t=>n[t]);this.timeExtent=this.valuesToTimeExtent(t)}}_stopAnimation(){null!=this._animationController&&(this._animationController.abort(),this._animationController=null)}_unregisterWidget(t){null!=t&&t.persistableViewModels.remove(this)}};t([p()],x.prototype,"_animationController",void 0),t([p({type:e})],x.prototype,"actions",void 0),t([p({readOnly:!0})],x.prototype,"effectiveStops",null),t([p({type:d})],x.prototype,"fullTimeExtent",void 0),t([p({nonNullable:!0})],x.prototype,"loop",void 0),t([p({nonNullable:!0})],x.prototype,"mode",void 0),t([p({nonNullable:!0,value:1e3})],x.prototype,"playRate",null),t([p({readOnly:!0})],x.prototype,"state",null),t([p({cast:t=>t?(T(t)&&(t.interval=h(f,t.interval)),(T(t)||v(t))&&(t.timeExtent=h(d,t.timeExtent)),t):null})],x.prototype,"stops",void 0),t([p({type:d})],x.prototype,"timeExtent",void 0),t([p({readOnly:!0})],x.prototype,"timeExtentValues",null),t([p()],x.prototype,"view",void 0),t([p()],x.prototype,"next",null),t([p()],x.prototype,"play",null),t([p()],x.prototype,"previous",null),t([p()],x.prototype,"stop",null),t([p()],x.prototype,"updateWebDocument",null),x=t([c("esri.widgets.TimeSlider.TimeSliderViewModel")],x);const y=x;export{y as default};
