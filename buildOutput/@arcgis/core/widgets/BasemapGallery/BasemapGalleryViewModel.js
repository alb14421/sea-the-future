/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Basemap.js";import s from"../../core/Collection.js";import{Loadable as i,isLoadable as r}from"../../core/Loadable.js";import{watch as o,on as a,when as n}from"../../core/reactiveUtils.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import{cast as c}from"../../core/accessorSupport/decorators/cast.js";import{i as m}from"../../core/lang.js";import{subclass as l}from"../../core/accessorSupport/decorators/subclass.js";import{canProjectWithoutEngine as u,isLoaded as h,load as j}from"../../chunks/projectionUtils.js";import{p as f}from"../../chunks/unitUtils.js";import{i as d}from"../../chunks/utils23.js";import{b as y}from"../../chunks/basemapEnsureType.js";import{e as b}from"../../chunks/basemapUtils.js";import k from"../../core/Error.js";import{throwIfAborted as g}from"../../core/promiseUtils.js";import{C as w,D as v,E as B}from"../../chunks/layerUtils.js";import{s as U}from"../../chunks/ViewingMode.js";import{g as R,c as P}from"../../chunks/terrainUtils.js";import{T as L}from"../../chunks/TerrainConst.js";import{i as I}from"../../chunks/spatialReferenceSupport.js";import S from"./support/BasemapGalleryItem.js";import _ from"./support/LocalBasemapsSource.js";import T from"./support/PortalBasemapsSource.js";import"../../config.js";import"../../chunks/object.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/jsonUtils.js";import"../../chunks/MapUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/collectionUtils.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/maybe.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/Lifecycle.js";import"../../chunks/metadata.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/loadAll.js";import"../../chunks/asyncUtils.js";import"../../chunks/writer.js";import"../../geometry/SpatialReference.js";import"../../chunks/ensureType.js";import"../../chunks/events.js";import"../../chunks/jsonMap.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../chunks/Warning.js";import"../../portal/Portal.js";import"../../chunks/reader.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/Point.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/locale.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../core/Promise.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/basemapDefinitions.js";import"../../chunks/messages.js";import"../../support/BasemapStyle.js";import"../../intl.js";import"../../chunks/date.js";import"../../chunks/constants.js";import"../../chunks/datetime.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/writeUtils.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/vec3f64.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../geometry/Polyline.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/utils5.js";import"../../chunks/colorUtils.js";import"../../chunks/screenUtils.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../layers/support/LOD.js";import"../../layers/support/TileInfo.js";import"../../chunks/TileKey.js";import"../../core/Identifiable.js";async function E(e,t={}){const{basemap:s,view:i}=e;await s.load(t),function(e){if(0===e.baseLayers.length&&0===e.referenceLayers.length)return;const t=e.baseLayers.concat(e.referenceLayers).toArray().filter(e=>!v(e)).map(e=>function(e){return new k("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})}(e));if(t.length)throw t[0]}(s),await async function(e,t,s){if(0===e.baseLayers.length)return;const i=e.baseLayers.at(0);if(B(i)){try{await i.load(s)}catch(e){const t="basemap-compatibility:unknown-error",s="Unknown basemap compatibility error",{name:i=t,message:r=s,details:o}=e;throw new k(i,r,o)}!function(e,t){const s=t.state.viewingMode;if(!s)return;let i,r;if("wmts"===e?.type){const o=R(e,t.spatialReference,s);if(null==o.tileInfo)throw new k("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");i=o.tileInfo,r=o.fullExtent}else i=e.tileInfo,r=e.fullExtent;if(null==i)return;if(!I(i.spatialReference,s))throw new k(`basemapgalleryitem:spatial-reference-unsupported-${U(s)}`,`Basemap spatial reference is unsupported in ${U(s)} mode`);const o="vector-tile"===e?.type?i.getCompatibleForVTL(256):null;if(1===s){let t=P(i,r,null,s);if(t&&"vector-tile"===e?.type&&null!=r&&o&&!P(o,r,null,s)&&(t=null),t){const e=i.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new k(`basemapgalleryitem:tiling-scheme-unsupported-${e}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(L.checkUnsupported(i))throw new k("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const a=t.basemapTerrain?.tilingScheme;if(a&&!a.compatibleWith(i)&&("vector-tile"!==e?.type||!o||!a.compatibleWith(o)))throw new k("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}(i,t)}}(s,i,t),g(t)}async function x(e,t={}){const{basemap:s,view:i}=e;g(t);const r=s.baseLayers.find(e=>"unknown"===e.type)?.loadError;if(null!=r)throw r;if(!i||"spatialReferenceLocked"in i&&!i.spatialReferenceLocked)return;if(await s.load(t),g(t),0===s.baseLayers.length)return;const o=s.baseLayers.at(0);if(!w(o))return;if(s.spatialReference){if(i.spatialReference.equals(s.spatialReference))return;A()}await o.load(t),g(t);const a=(("supportedSpatialReferences"in o?o.supportedSpatialReferences:null)||["tileInfo"in o?o.tileInfo?.spatialReference:null]).filter(m);0!==a.length&&a.every(e=>!i.spatialReference.equals(e))&&A()}function A(){throw new k("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}const O=s.ofType(S);let F=class extends i{constructor(e){super(e),this._loadingProjectionEngine=!1,this.items=new O,this.source=new T,this.view=null}initialize(){const e=()=>this._recreateItems();this.addHandles([o(()=>"ready"===this.state?this.compatibilityFunction:null,()=>this._updateItems()),a(()=>this.source?.basemaps,"change",e,{onListenerAdd:e}),n(()=>this.view,()=>{this.source instanceof T&&(this.source.viewType=this.view?.type)},{once:!0})])}destroy(){const e=this.source.basemaps.find(e=>e===this.activeBasemap);e&&this.source.basemaps.remove(e),this.source?.destroy()}get activeBasemap(){return this.view?.map?.basemap??null}set activeBasemap(e){const t=this.view;if(!t?.map)return;if(!e||!t.ready)return t.map.basemap=e,void this._clearOverride("activeBasemap");const s=e.spatialReference||this.items?.find(t=>this.basemapEquals(e,t.basemap))?.spatialReference;if(s&&"spatialReferenceLocked"in t&&!t.spatialReferenceLocked){const i=t.spatialReference;if(null!=s&&!f(i,s)&&!u(t.spatialReference,s)&&!h())return this._override("activeBasemap",e),this._loadingProjectionEngine=!0,void j().then(()=>{this._get("activeBasemap")===e&&(t.map.basemap=e,t.spatialReference=s,this._clearOverride("activeBasemap"))},()=>{}).then(()=>{this._loadingProjectionEngine=!1});t.map.basemap=e,this._clearOverride("activeBasemap"),null==s||f(t.spatialReference,s)||(t.spatialReference=s)}else t.map.basemap=e,this._clearOverride("activeBasemap")}castActiveBasemap(e){return y(e)}get activeBasemapIndex(){const{state:e,activeBasemap:t}=this;return"ready"!==e?-1:this._findBasemapIndex(t)}get compatibilityFunction(){return"3d"===this.view?.type?E:x}set compatibilityFunction(e){this._overrideIfSome("compatibilityFunction",e)}castSource(e){return Array.isArray(e)||s.isCollection(e)?new _({basemaps:Array.isArray(e)?new s(e):e}):function(e){return e&&"esri.portal.Portal"===e.declaredClass}(e)?new T({portal:e}):function(e){return e&&!(e instanceof T)&&(!!e.portal||!!e.query)}(e)?new T(e):function(e){return e&&"basemaps"in e&&"state"in e&&"refresh"in e}(e)?e:null}get state(){return this.view?.ready&&this.source?d(this.view)&&!this.view.inGeographicLayout?"unsupported":this._loadingProjectionEngine?"loading":"ready":"disabled"}basemapEquals(e,t){return b(e,t)}refresh(){this._recreateItems()}load(){return this.loadSource()}loadSource(e){return this.addResolvingPromise(r(this.source)?this.source.load(e):null),Promise.resolve(this)}_findBasemapIndex(e){const{items:t}=this,s=t.findIndex(t=>t.basemap===e);return-1===s?t.findIndex(t=>this.basemapEquals(t.basemap,e)):s}_recreateItems(){const e=this.source?.basemaps??[],{view:t,compatibilityFunction:s}=this,i=new Map(this.items.map(e=>[e.basemap,e])),r=e.map(e=>{const r=i.get(e);return r?(i.delete(e),r):new S({basemap:e,compatibilityFunction:s,view:t})});this.items.removeAll(),this.items.addMany(r),i.forEach(e=>e.destroy())}_updateItems(){for(const e of this.items)e.compatibilityFunction=this.compatibilityFunction,e.view=this.view}};e([p()],F.prototype,"_loadingProjectionEngine",void 0),e([p({type:t})],F.prototype,"activeBasemap",null),e([c("activeBasemap")],F.prototype,"castActiveBasemap",null),e([p({readOnly:!0})],F.prototype,"activeBasemapIndex",null),e([p()],F.prototype,"compatibilityFunction",null),e([p({readOnly:!0,type:O})],F.prototype,"items",void 0),e([p()],F.prototype,"source",void 0),e([c("source")],F.prototype,"castSource",null),e([p({readOnly:!0})],F.prototype,"state",null),e([p()],F.prototype,"view",void 0),F=e([l("esri.widgets.BasemapGallery.BasemapGalleryViewModel")],F);const M=F;export{M as default};
