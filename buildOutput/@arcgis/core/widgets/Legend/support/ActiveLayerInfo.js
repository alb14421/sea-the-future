/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../Color.js";import"../../../intl.js";import{addTokenParameter as s}from"../../../kernel.js";import i from"../../../request.js";import r from"../../../core/Accessor.js";import{i as l,h as n}from"../../../core/lang.js";import o from"../../../core/Collection.js";import{J as a}from"../../../chunks/jsonMap.js";import{L as u}from"../../../chunks/Logger.js";import{c}from"../../../chunks/mathUtils.js";import{debounce as p}from"../../../core/promiseUtils.js";import{on as m,watch as d,initial as h,whenOnce as y}from"../../../core/reactiveUtils.js";import{a as f}from"../../../chunks/screenUtils.js";import{parseWhereClause as b}from"../../../core/sql.js";import{addQueryParameters as g}from"../../../core/urlUtils.js";import{property as S}from"../../../core/accessorSupport/decorators/property.js";import{subclass as j}from"../../../core/accessorSupport/decorators/subclass.js";import{E as v}from"../../../chunks/EffectView.js";import{e as w}from"../../../chunks/jsonUtils2.js";import{g as _}from"../../../chunks/displayFilterUtils.js";import{E as L}from"../../../chunks/ExportImageParameters.js";import{collectFields as k,collectArcadeFieldNames as C}from"../../../layers/support/fieldUtils.js";import{i as E}from"../../../chunks/layerUtils.js";import{a as I}from"../../../chunks/pixelRangeUtils.js";import{fromJSON as F}from"../../../renderers/support/jsonUtils.js";import{i as R}from"../../../chunks/rendererConversion.js";import V,{S as D}from"../../../renderers/visualVariables/SizeVariable.js";import{u as x}from"../../../chunks/referenceSizeUtils.js";import U from"../../../symbols/SimpleFillSymbol.js";import z from"../../../symbols/SimpleMarkerSymbol.js";import{applyCIMSymbolColor as T}from"../../../symbols/support/cimSymbolUtils.js";import{r as M}from"../../../chunks/renderUtils.js";import{renderColorRampPreviewHTML as P,renderDotDensityPreviewHTML as O,renderPieChartPreviewHTML as A,g as B,a as q,renderPreviewHTML as N}from"../../../symbols/support/symbolUtils.js";import{i as H}from"../../../chunks/utils8.js";import{getColorFromPointCloudStops as W,getRampStopsForPointCloud as $,getStretchRampStops as G,getRampStops as J}from"../../../chunks/colorRampUtils2.js";import{g as Q}from"../../../renderers/support/utils.js";import{getRampStops as Z,realWorldMaxSize as K,realWorldMinSize as X}from"../../../chunks/sizeRampUtils.js";import{specialCharsLessThan as Y,specialCharsGreaterThan as ee,getAuthoringInfoVisualVariableByTheme as te,getSymbolForFlowRenderer as se,getMedianColor as ie,rgbImgSource as re,getDateFormatOptions as le}from"../../../chunks/utils17.js";import{formatNumberLabel as ne}from"../../smartMapping/support/utils.js";import{f as oe}from"../../../chunks/messages.js";import{s as ae}from"../../../chunks/substitute.js";import"../../../chunks/colorUtils.js";import"../../../chunks/ensureType.js";import"../../../chunks/MapUtils.js";import"../../../config.js";import"../../../chunks/object.js";import"../../../chunks/string.js";import"../../../chunks/date.js";import"../../../chunks/locale.js";import"../../../chunks/handleUtils.js";import"../../../chunks/constants.js";import"../../../chunks/datetime.js";import"../../../chunks/number.js";import"../../../core/Error.js";import"../../../chunks/assets.js";import"../../../chunks/events.js";import"../../../chunks/maybe.js";import"../../../chunks/jsonUtils.js";import"../../../chunks/persistableUrlUtils.js";import"../../../core/Handles.js";import"../../../chunks/get.js";import"../../../chunks/utils.js";import"../../../chunks/Lifecycle.js";import"../../../chunks/metadata.js";import"../../../chunks/ObjectPool.js";import"../../../chunks/ObservableBase.js";import"../../../chunks/tracking.js";import"../../../chunks/watch.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../chunks/PooledArray.js";import"../../../chunks/SetUtils.js";import"../../../chunks/SimpleTrackingTarget.js";import"../../../core/Evented.js";import"../../../chunks/Warning.js";import"../../../chunks/shared.js";import"../../../chunks/SimpleObservable.js";import"../../../chunks/parser.js";import"../../../chunks/utils5.js";import"../../../chunks/mat4.js";import"../../../chunks/common.js";import"../../../chunks/scaleUtils.js";import"../../../chunks/unitUtils.js";import"../../../chunks/pe.js";import"../../../chunks/floorFilterUtils.js";import"../../../chunks/sublayerUtils.js";import"../../../chunks/guards.js";import"../../../layers/catalog/catalogUtils.js";import"../../../chunks/typeUtils3.js";import"../../../renderers/ClassBreaksRenderer.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../chunks/enumeration.js";import"../../../chunks/reader.js";import"../../../chunks/writer.js";import"../../../renderers/Renderer.js";import"../../../core/JSONSupport.js";import"../../../renderers/support/AuthoringInfo.js";import"../../../renderers/support/AuthoringInfoVisualVariable.js";import"../../../chunks/colorRamps.js";import"../../../rest/support/AlgorithmicColorRamp.js";import"../../../rest/support/ColorRamp.js";import"../../../rest/support/MultipartColorRamp.js";import"../../../renderers/mixins/VisualVariablesMixin.js";import"../../../renderers/visualVariables/ColorVariable.js";import"../../../renderers/visualVariables/VisualVariable.js";import"../../../core/Clonable.js";import"../../../renderers/visualVariables/support/ColorStop.js";import"../../../renderers/visualVariables/OpacityVariable.js";import"../../../renderers/visualVariables/support/OpacityStop.js";import"../../../chunks/opacityUtils.js";import"../../../renderers/visualVariables/RotationVariable.js";import"../../../renderers/visualVariables/support/SizeStop.js";import"../../../chunks/visualVariableUtils.js";import"../../../Graphic.js";import"../../../PopupTemplate.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/support/AttachmentsOrderByInfo.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/content/UtilityNetworkAssociationsContent.js";import"../../../popup/support/UtilityNetworkAssociationType.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../core/Identifiable.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../../geometry/support/jsonUtils.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../geometry/SpatialReference.js";import"../../../geometry/Point.js";import"../../../geometry/support/webMercatorUtils.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polygon.js";import"../../../chunks/coordsUtils.js";import"../../../chunks/extentUtils.js";import"../../../chunks/boundsUtils.js";import"../../../chunks/aaBoundingRect.js";import"../../../geometry/Polyline.js";import"../../../chunks/typeUtils.js";import"../../../chunks/createFeatureId.js";import"../../../chunks/typeUtils2.js";import"../../../symbols/CIMSymbol.js";import"../../../symbols/Symbol.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../portal/Portal.js";import"../../../core/Loadable.js";import"../../../core/Promise.js";import"../../../portal/PortalGroup.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils3.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/materialUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils4.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../chunks/vec3f64.js";import"../../../chunks/aaBoundingBox.js";import"../../../chunks/DoubleArray.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/Font.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/SimpleLineSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../../chunks/lengthUtils.js";import"../../../renderers/support/ClassBreakInfo.js";import"../../../chunks/commonProperties2.js";import"../../../symbols/support/jsonUtils.js";import"../../../chunks/defaults.js";import"../../../chunks/defaultsJSON.js";import"../../../chunks/RendererLegendOptions.js";import"../../../renderers/DictionaryRenderer.js";import"../../../chunks/LRUCache.js";import"../../../chunks/MemCache.js";import"../../../chunks/DictionaryScriptEvaluator.js";import"../../../chunks/Version.js";import"../../../layers/support/FieldsIndex.js";import"../../../chunks/UnknownTimeZone.js";import"../../../chunks/timeZoneUtils.js";import"../../../chunks/ArcadeExpression.js";import"../../../chunks/TimeOnly.js";import"../../../chunks/enum.js";import"../../../chunks/utils6.js";import"../../../chunks/defaultCIMValues.js";import"../../../renderers/DotDensityRenderer.js";import"../../../renderers/support/AttributeColorInfo.js";import"../../../renderers/HeatmapRenderer.js";import"../../../renderers/support/HeatmapColorStop.js";import"../../../chunks/heatmapUtils.js";import"../../../chunks/vec4.js";import"../../../chunks/vec4f64.js";import"../../../renderers/PieChartRenderer.js";import"../../../renderers/SimpleRenderer.js";import"../../../renderers/UniqueValueRenderer.js";import"../../../chunks/diffUtils.js";import"../../../renderers/support/UniqueValue.js";import"../../../renderers/support/UniqueValueClass.js";import"../../../renderers/support/UniqueValueGroup.js";import"../../../renderers/support/UniqueValueInfo.js";import"../../../chunks/styleUtils.js";import"../../../chunks/colorUtils2.js";import"../../../chunks/projector.js";import"../../../chunks/sanitizerUtils.js";import"../../../chunks/svgUtils.js";import"../../../chunks/mat2df32.js";import"../../../chunks/mat2d.js";import"../../../chunks/gfxUtils.js";import"../../../chunks/widgetUtils.js";import"../../../chunks/jsxFactory.js";import"../../../chunks/jsxWidgetSupport.js";import"../../../chunks/webStyleSymbolUtils.js";import"../../../chunks/devEnvironmentUtils.js";import"../../../chunks/asyncUtils.js";import"../../../chunks/timeUtils.js";import"../../../chunks/numberUtils.js";import"../../../chunks/utils7.js";import"../../../chunks/basemapUtils.js";import"../../../chunks/basemapDefinitions.js";import"../../../smartMapping/renderers/support/spikeUtils.js";import"../../../chunks/previewCIMSymbol.js";import"../../../chunks/CIMSymbolHelper.js";import"../../../chunks/BidiEngine.js";import"../../../chunks/labelPoint.js";import"../../../chunks/OptimizedGeometry.js";import"../../../chunks/memoryEstimations.js";import"../../../chunks/GeometryUtils.js";import"../../../chunks/fontUtils.js";import"../../../chunks/rasterizingUtils.js";import"../../../chunks/floatRGBA.js";import"../../../chunks/definitions.js";import"../../../chunks/shapingUtils.js";import"../../../chunks/vec2.js";import"../../../chunks/vec2f32.js";import"../../../chunks/Rect.js";import"../../../chunks/BoundingBox.js";import"../../../chunks/CIMSymbolRasterizer.js";import"../../../chunks/CIMResourceManager.js";import"../../../chunks/imageUtils.js";import"../../../chunks/OverrideHelper.js";import"../../../chunks/callExpressionWithFeature.js";import"../../../chunks/quantizationUtils.js";import"../../../chunks/modeUtils.js";const ue=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,ce=new a({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),pe=new z({size:6,outline:{color:[128,128,128,.5],width:.5}}),me=new U({style:"solid"});function de(e){return"flow"===e.type}function he(e){return"vector-field"===e.type}function ye(e){return"raster-colormap"===e.type}function fe(e){return"raster-stretch"===e.type}function be(e){return"raster-shaded-relief"===e.type}function ge(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function Se(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function je(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function ve(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function we(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function _e(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function Le(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function ke(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function Ce(e){return"esri.renderers.PieChartRenderer"===e.declaredClass}function Ee(e){return"esri.layers.SubtypeGroupLayer"===e.declaredClass}function Ie(e){return"esri.layers.MapImageLayer"===e.declaredClass}function Fe(e){return"esri.layers.TileLayer"===e.declaredClass}function Re(e){return"esri.layers.ImageryLayer"===e.declaredClass}function Ve(e){return"esri.layers.ImageryTileLayer"===e.declaredClass}function De(e){return"sublayers"in e}function xe(e){return e&&"symbol"in e}async function Ue(e,t){const s=await oe("esri/widgets/Legend/t9n/Legend");return"previewTemplateAriaLabel"!==e||t||(e="previewAriaLabel"),ae(s[e],{label:t})}const ze=new z({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let Te={},Me=class extends r{constructor(e){super(e),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this._layerDefinitionExpression=null,this._layerDefinitionExpressionClause=null,this._layerDisplayFilterId=null,this._layerDisplayFilterClause=null,this.children=new o,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this.addHandles([m(()=>this.children,"change",t=>{const{added:s,removed:i}=t;s.forEach(t=>{const s=`activeLayerInfo-ready-watcher-${t.layer.uid}`;this.addHandles(d(()=>t.ready,e,h),s)}),i.forEach(e=>this.removeHandles(e.layer.uid)),e()})]),this.keepCacheOnDestroy||(Te={})}destroy(){this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(Te=null),this._layerDefinitionExpressionClause=null}get effectList(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new v,t.effect=e.effect,t.endTransition(),t.scale=this.scale),t}get opacity(){const e=this.layer.opacity,t=this.parent?.opacity,s=this.layer.parent,i=s&&"uid"in s?this._getParentLayerOpacity(s):null;return null!=t?t*e:null!=i?i*e:e}get ready(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view?.scale??0}get isScaleDriven(){const e=this.layer;if(null===e)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction){if("cluster"===e.featureReduction.type)return!0;if("binning"===e.featureReduction.type&&"renderer"in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return"renderer"in e&&e.renderer?!!("displayFilterInfo"in e&&e.displayFilterInfo&&je(e.renderer))||this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(this.hideLayersNotInCurrentView&&!await this._isLayerInCurrentView())return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,e=>{if(E(e))return this._getRendererLegendElements(e.renderer,{title:e.title});if(e.featureSet?.features.length){const t=e.layerDefinition,s=t?.drawingInfo,i=s&&F(s.renderer),r=ce.read(t.geometryType);return i?this._getRendererLegendElements(i,{title:e.name,geometryType:r}):(u.getLogger(this).warn("drawingInfo not available!"),null)}return null});try{const e=[],s=await Promise.allSettled(t);for(const t of s)if("fulfilled"===t.status)for(const s of t.value??[])e.push(s);this.legendElements=e,this.notifyChange("ready")}catch(e){u.getLogger(this).warn("error while building legend for layer!",e)}}async buildLegendElementsForRenderer(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(e){u.getLogger(this).warn("error while building legend for layer!",e)}}async buildLegendElementsForFeatureReduction(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getLegendElementsForFeatureReduction(e):[],this.notifyChange("ready")}catch(e){u.getLogger(this).warn("error while building legend for layer!",e)}}async buildLegendElementsForTools(){const e=this.layer;if(function(e){return"esri.layers.VoxelLayer"===e.declaredClass}(e))await this._constructLegendElementsForVoxelLayer();else if(function(e){return"esri.layers.WMTSLayer"===e.declaredClass}(e))this._constructLegendElementsForWMTSlayer();else if(function(e){return"esri.layers.WMSLayer"===e.declaredClass}(e))await this._constructLegendElementsForWMSSublayers();else if(function(e){return"esri.layers.BuildingSceneLayer"===e.declaredClass}(e))await this._constructLegendElementsForBuildingSceneLayer();else if(Ie(e)||Fe(e)||Ee(e))await this._constructLegendElementsForSublayers();else{this.removeHandles("imageryLayers-watcher");let t="default";if(Re(e)){const s=e;t=(s?.rasterFunction?.functionName||"default")+"_"+(e.bandIds?.length?e.bandIds.join(""):"###")}if(Ve(e)||"link-chart"===e.type)return;await this._getLegendLayers(`${e.uid}-${t}`).then(async t=>{this.legendElements=[],this.notifyChange("ready");const s=t.map(async t=>{if(Re(e)){const t=d(()=>[e.rasterFunction,e.bandIds],()=>p(async()=>{Te.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()})());this.addHandles(t,"imageryLayers-watcher")}const s=this._generateSymbolTableElementForLegendLayer(t);s?.infos.length&&(Re(e)&&(s.title=e.title),this.legendElements.push(s)),this.notifyChange("ready")});await Promise.allSettled(s)}).catch(e=>{u.getLogger(this).warn("Request to server for legend has failed!",e)})}}async _isLayerInCurrentView(){const e=this.layer,t=this.layerView,s=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!(s||t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;await y(()=>!t.updating);const i=s?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();return!i||(i.geometry=this.view.extent,0!==(s?"queryFeatureCount"in t&&await t.queryFeatureCount(i):"queryFeatureCount"in e&&await e.queryFeatureCount(i)))}_getParentLayerOpacity(e){let t=1;const s=e.parent;return s&&"uid"in s&&(t=this._getParentLayerOpacity(s)),e.opacity*t}_isGroupActive(){return this.children.some(e=>e.ready)}_isRendererScaleDriven(e){if("dot-density"===e.type)return!0;const t="valueExpression"in e?e.valueExpression:null;if(ue.test(t))return!0;const s="visualVariables"in e?e.visualVariables:null;return!!s?.some(e=>this._isScaleDrivenSizeVariable(e))||this._hasScaleDrivenSymbols(e)}_hasScaleDrivenSymbols(e){switch(e.type){case"simple":return this._isScaleDrivenSymbol(e.symbol);case"class-breaks":return this._isScaleDrivenSymbol(e.defaultSymbol)||e.classBreakInfos.some(e=>this._isScaleDrivenSymbol(e.symbol));case"unique-value":return this._isScaleDrivenSymbol(e.defaultSymbol)||!!e.uniqueValueInfos?.some(e=>this._isScaleDrivenSymbol(e.symbol))}return!1}_isScaleDrivenSymbol(e){if("cim"===e?.type){const{primitiveOverrides:t,minScale:s,maxScale:i}=e.data,r=t?.some(e=>(e.valueExpressionInfo?.expression||"").includes("$view.scale"))??!1;return null!=s||null!=i||r}return!1}_isScaleDrivenSizeVariable(e){if(e&&"size"!==e.type)return!1;const t=e,s=t.minSize,i=t.maxSize;return!("object"!=typeof s||!s||!this._isScaleDrivenSizeVariable(s))||!("object"!=typeof i||!i||!this._isScaleDrivenSizeVariable(i))||ue.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some(e=>this._isLayerScaleDriven(e));const t=e.parent;if(!1===e.loaded&&t&&Ie(t)&&"source"in e&&e.source&&"map-layer"===e.source.type)for(const s of t.sourceJSON.layers??[])if(s.id===e.source.mapLayerId&&(s.minScale>0||s.maxScale>0))return!0;return!1}async _constructLegendElementsForVoxelLayer(){this.legendElements=[],this.removeHandles("voxel-style-watcher"),this.removeHandles("voxel-current-variable");const e=this.layer;this.addHandles(d(()=>e.currentVariableId,()=>this._constructLegendElementsForVoxelLayer()),"voxel-current-variable"),this.addHandles(d(()=>e.getVariableStyles(),()=>this._constructLegendElementsForVoxelLayer()),"voxel-style-watcher");const t=e.getVariableStyle(null),s=[];if(t)if(t.uniqueValues?.length){const e=[];t.uniqueValues.forEach(t=>{t.enabled&&e.push({label:t.label||`${t.value}`,value:t.value,symbol:new U({color:t.color,outline:null})})}),e.length&&s.push({type:"symbol-table",title:t.label,infos:e})}else if(t.transferFunction){const{colorStops:e,stretchRange:i}=t.transferFunction,r=e.toArray().reverse(),l=i.map((e,t)=>`${0===t?Y:ee} ${ne(e)}`).reverse(),n=r.map(e=>({color:e.color,value:null,label:null}));n[0].label=l[0],n[n.length-1].label=l[1],s.push({type:"color-ramp",title:t.label,infos:n,preview:P(r.map(e=>e.color),{ariaLabel:await Ue("previewColorRampAriaLabel")})})}await this._generatePreviewsForLegendElements(s,{opacity:e.opacity}),this.legendElements=s,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this.removeHandles("wmts-activeLayer-watcher");const e=this.layer.activeLayer;this.addHandles(d(()=>{const{layer:e}=this;return e&&"activeLayer"in e&&e.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");const t=e.styleId?e.styles?.find(({id:t})=>t===e.styleId)?.legendUrl:void 0;t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}]),this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this.removeHandles("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this.addHandles(d(()=>{const{layer:e}=this;return e&&"sublayers"in e&&e.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const s=this.layer,i=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");const r=this.sublayerIds?.map(e=>s.findSublayerById(e))?.filter(l)??[],n=r.length?r:e.toArray();for(const e of n){const s=d(()=>[e.title,e.visible,e.legendEnabled],()=>this._constructLegendElementsForWMSSublayers());if(this.addHandles(s,"wms-sublayers-watcher"),!this.respectLayerVisibility||e.visible&&e.legendEnabled){const s=await this._generateSymbolTableElementForWMSSublayer(e,t);s?.infos.length&&i.unshift(s)}}return i}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const s=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter(e=>e);return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){let s=e.legendUrl;if(!s)return;const r={type:"symbol-table",title:e.title||e.name||String(e.id??""),infos:[]};t&&(s=g(s,t));let l=null;const n=e.layer?.opacity;try{l=(await i(s,{responseType:"image"})).data,l&&(l.style.opacity=n)}catch{}return r.infos.push({src:s,preview:l,opacity:n}),r}_getLegendLayers(e,t){const s=Te&&Te[e];return s?Promise.resolve(s):this._legendRequest(t).then(t=>{const s=t.layers;return Te[e]=s,s})}_legendRequest(e){const t=this.layer;let s={f:"json",dynamicLayers:e};if(Re(t)){const e=t.exportImageServiceParameters.rasterFunction;if(e&&(s.renderingRule=JSON.stringify(e.functionDefinition?.toJSON()||e.toJSON())),t.bandIds&&(s.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:e,viewId:i,customParameters:r}=t;s={raster:e,viewId:i,...s,...r}}}let r=t.url.replace(/(\/)+$/,"");if("version"in t&&+t.version>=10.01){const e=r.indexOf("?");e>-1?r=r.slice(0,e)+"/legend"+r.slice(e):r+="/legend"}else{const e=r.toLowerCase().indexOf("/rest/"),t=-1===e?r:r.slice(0,e)+r.slice(e+5);r="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+encodeURI(t)+"&returnbytes=true"}return i(r,{query:s}).then(e=>e.data)}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this.removeHandles("sublayers-watcher");const e=this.layer;this.addHandles(d(()=>e.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(e){u.getLogger(this).warn("Request to server for legend has failed!",e)}}async _generateLegendElementsForBuildingSublayers(e,t){let s=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");const i=e.toArray();for(const e of i){const i=d(()=>["renderer"in e&&e.renderer,e.opacity,e.title,e.visible],()=>this._constructLegendElementsForBuildingSceneLayer());if(this.addHandles(i,"sublayers-watcher"),!this.respectLayerVisibility||e.visible){const i=null!=e?.opacity?e.opacity:null,r=null!=i?i*t:t;if("building-group"===e.type){const t={type:"symbol-table",title:e.title,infos:[]},i=await this._generateLegendElementsForBuildingSublayers(e.sublayers,r);t.infos.push(...i),s=[t,...s]}else e.renderer&&(s=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:r,sublayer:e}),...s])}}return s.filter(e=>!!e&&(!("infos"in e)||!e.infos||e.infos.length>0))}async _constructLegendElementsForSublayers(){this.legendElements=[],this.removeHandles("sublayers-watcher");const e=this.layer;if(Ie(e)||Fe(e)||Ee(e)){this.addHandles(d(()=>e.sublayers,()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(e){u.getLogger(this).warn("Request to server for legend has failed!",e)}}}async _generateLegendElementsForSublayers(e,t,s){const i=this.layer;let r=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");let n=e.toArray();!s&&this.sublayerIds&&this.sublayerIds.length&&(n=Ee(i)?this.sublayerIds.map(e=>i.findSublayerForSubtypeCode(e)).filter(l):this.sublayerIds.map(e=>i.findSublayerById(e)).filter(l));for(const e of n){const i=d(()=>[e.renderer,e.opacity,e.title,e.visible,e.legendEnabled],()=>this._constructLegendElementsForSublayers());if(this.addHandles(i,"sublayers-watcher"),!this.respectLayerVisibility||e.visible&&e.legendEnabled&&this._isSublayerInScale(e)){const i=null!=e?.opacity?e.opacity:null,l=null!=i?i*t:t,n=!De(e)||e.originIdOf("renderer")>2&&!e.sublayers;if(e.renderer&&n)await e.load(),r=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:l,sublayer:e}),...r];else if(De(e)){const t=await this._generateSymbolTableElementForSublayer(e,l,s);t&&r.unshift(t)}}}return r.filter(e=>!!e&&(!("infos"in e)||!e.infos||e.infos.length>0))}async _generateSymbolTableElementForSublayer(e,t,s){if(!s){s=new Map;const t=this.layer,i=e.source;let r=null;if(i&&("map-layer"!==i.type||i.mapLayerId!==e.id||i.gdbVersion&&i.gdbVersion!==("gdbVersion"in t&&t.gdbVersion))||e.originIdOf("renderer")>2||e.originIdOf("labelingInfo")>2||e.originIdOf("labelsVisible")>2){const e=new L({layer:this.layer});r=e.hasDynamicLayers?e.dynamicLayers:null,e.destroy()}const l=r||`${t.uid}-default`;(await this._getLegendLayers(l,r)).forEach(e=>s.set(e.layerId,e))}const i=s.get(e.id);if((!i||i?.subLayerIds&&i.defaultVisibility)&&e.sublayers){const i=await this._generateLegendElementsForSublayers(e.sublayers,t,s);return{type:"symbol-table",title:e.title,infos:i}}return this._generateSymbolTableElementForLegendLayer(i,e,t)}_generateSymbolTableElementForLegendLayer(e,t,s){if(!e?.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const i=t?.renderer;let r=t?.title||e.layerName;if(i&&(!t||t?.originIdOf("renderer")>2)){const e=t?.title||this._getRendererTitle(i,t);e&&(r&&"string"!=typeof e&&"title"in e&&(e.title=r),r=e)}const l={type:"symbol-table",title:r,legendType:e.legendType||null,infos:[]},n=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return e.legendGroups&&e.legendGroups.length>0?e.legendGroups.forEach(t=>{const i={type:"symbol-table",title:t.heading,legendType:e.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(n.filter(e=>e.groupId===t.id),e.layerId,s)};i.infos?.length>0&&l.infos.push(i)}):l.infos=this._generateSymbolTableElementInfosForLegendLayer(n,e.layerId,s),l.infos.length>0?l:null}_generateSymbolTableElementInfosForLegendLayer(e,t,i){return e.map(e=>{let r=e.url;if(e.imageData&&e.imageData.length>0)r=`data:image/png;base64,${e.imageData}`;else{if(r.startsWith("http"))return null;r=s(`${this.layer.url}/${t}/images/${r}`)}return{label:e.label,src:r,opacity:i??this.opacity,width:e.width,height:e.height}}).filter(l)}_isSublayerInScale(e){const t=e.minScale||0,s=e.maxScale||0;return!(t>0&&t<this.scale||s>this.scale)}_isLegendLayerInScale(e,t){const s=t||this.layer;let i=null,r=null,l=!0;return!s.minScale&&0!==s.minScale||!s.maxScale&&0!==s.maxScale?(0===e.minScale&&s.tileInfo&&(i=s.tileInfo.lods[0].scale),0===e.maxScale&&s.tileInfo&&(r=s.tileInfo.lods[s.tileInfo.lods.length-1].scale)):(i=Math.min(s.minScale,e.minScale)||s.minScale||e.minScale,r=Math.max(s.maxScale,e.maxScale)),(i>0&&i<this.scale||r>this.scale)&&(l=!1),l}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&+this.layer.version<10.1||0===e.length)return e;const s=t.renderer,i=e.some(e=>e.values);let r=0,l=null;return i&&e.some((e,t)=>(e.values||(r=t,l=e,l.label||(l.label="others")),null!=l)),s?"unique-value"===s.type?l&&(e.splice(r,1),e.push(l)):"class-breaks"===s.type&&(l&&e.splice(r,1),s.legendOptions?.order||e.reverse(),l&&e.push(l)):l&&(e.splice(r,1),e.push(l)),e}async _getRendererLegendElements(e,t={}){if(!function(e,t){return ge(e)||Se(e)||je(e)||ve(e)||ke(e)||Ce(e)?"2d"===t.type||R(e):fe(e)||ye(e)||be(e)||we(e)||_e(e)||Le(e)||he(e)||de(e)}(e,this.view))return u.getLogger(this).warn(`Renderer of type '${e.type}' not supported!`),[];if(function(e){return we(e)||_e(e)||Le(e)||function(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}(e)}(e))return this._constructPointCloudRendererLegendElements(e,t);if(ke(e))return this._constructDotDensityRendererLegendElements(e);const s=await this._loadRenderer(e);return Ce(s)?this._constructPieChartRendererLegendElements(s):this._constructRendererLegendElements(s,t)}async _getLegendElementsForFeatureReduction(e){let t=null;return"binning"===e.type?t=e.renderer:"cluster"===e.type&&(t=this._getClusterRenderer(e)),t?this._getRendererLegendElements(t):[]}_getPointCloudRendererTitle(e){return(e.legendOptions?.title||e.field)??""}async _constructPointCloudRendererLegendElements(e,t={}){const s=t.title,i=[];let r=null,l=null;if(we(e))r={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(e=>{r.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(pe,e.color)})});else if(_e(e)){const t=e.stops;let i=null;if(t?.length&&(1===t.length&&(i=t[0].color),!i)){const e=t[0].value,s=t[t.length-1].value;null!=e&&null!=s&&(i=W(e+(s-e)/2,t))}r={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(pe,i||pe.color)}]};const n=$(e.stops??[])??[];l={type:"color-ramp",title:s||this._getPointCloudRendererTitle(e),infos:n,preview:P(n.map(e=>e.color),{ariaLabel:await Ue("previewColorRampAriaLabel")})}}else Le(e)&&(r={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos?.forEach(e=>{r.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:this._getAppliedCloneSymbol(pe,e.color)})}));return r?.infos.length&&i.push(r),l?.infos.length&&i.push(l),await this._generatePreviewsForLegendElements(i,{opacity:this.opacity,symbolConfig:{applyColorModulation:!!e.colorModulation}}),i}async _getElementInfoForDotDensity(e,t){const{color:s,label:i,valueExpressionTitle:r}=t,{backgroundColor:l,outline:n,dotSize:o}=e,a=this.effectList,u=a?.effects.map(e=>e.toJSON()),c=w(u),p=await Ue("previewTemplateAriaLabel",i||r),m=o+"-"+s+"-"+l+"-"+(n&&JSON.stringify(n.toJSON()))+"-"+c,d=this._dotDensityUrlCache,h=d.has(m)?d.get(m):O(e,s,{ariaLabel:p});d.set(m,h);const y={shape:{type:"image",x:0,y:0,width:h.width,height:h.height,src:h.src},fill:null,stroke:null,offset:[0,0]},f=M([[y]],[h.width,h.height],{effectView:this.effectList,ariaLabel:p});return{opacity:1,src:h.src,preview:f,width:h.width,height:h.height}}async _constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),s=e.legendOptions?.unit,i={type:"symbol-table",title:{value:t&&Math.round(t),unit:s||""},infos:[]};for(const t of e.attributes){const s=await this._getElementInfoForDotDensity(e,t);s.label=t.label||t.valueExpressionTitle||t.field,i.infos.push(s)}return[i]}async _constructPieChartRendererLegendElements(e){const t=[];let s=null;const i=e.outline;e.attributes.forEach(e=>{const s=new z({color:e.color,outline:i}),r=e.label||e.valueExpressionTitle||e.field;t.push({label:r,symbol:s})});const r=t.length?[...t]:[];if(e.othersCategory?.color&&0!==e.othersCategory?.threshold){const r=new z({color:e.othersCategory.color,outline:i});s=e.othersCategory.label||"Other",t.push({label:s,symbol:r})}if(e.defaultColor?.a){const s=new z({color:e.defaultColor,outline:i});t.push({label:e.defaultLabel,symbol:s})}const l=await this._getVisualVariableLegendElements(e,this.layer)||[];if(t.length){l.unshift({type:"symbol-table",title:null,infos:t});const n=r.filter(e=>e.label!==s).map(e=>e.symbol.color).filter(Boolean),o=A(n,{holePercentage:e.holePercentage,backgroundColor:e.backgroundFillSymbol?.color,effectList:this.effectList,outline:i,ariaLabel:await Ue("previewPieChartAriaLabel")});l.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(e,this.layer),infos:t,preview:o})}return await this._generatePreviewsForLegendElements(l,{opacity:this.layer.opacity,effectView:this.effectList}),l}async _getWhereClause(e,t,s){const i=await b(e,s),r=new Set,{field:l,field2:n,field3:o}=t;k(r,s,[l,n,o]),await C(r,s,t.valueExpression);const a=new Set(Array.from(r,e=>e.toLowerCase())),u=i?.fieldNames.map(e=>e.toLowerCase());return u?.some(e=>!a.has(e))?null:i}async _processDefinitionExpression(e,t){if(!("definitionExpression"in e))return;const s=e.definitionExpression;s&&this.respectLayerDefinitionExpression?this._layerDefinitionExpression!==s&&(this._layerDefinitionExpressionClause=await this._getWhereClause(s,t,e.fieldsIndex)):this._layerDefinitionExpressionClause=null,this._layerDefinitionExpression=s}async _processDisplayFilter(e,t){if(!("displayFilterInfo"in e))return;const s=e.displayFilterInfo?_(e.displayFilterInfo,this.view):null;return s?.where?this._layerDisplayFilterId!==s?.id&&(this._layerDisplayFilterClause=await this._getWhereClause(s.where,t,e.fieldsIndex)):this._layerDisplayFilterClause=null,this._layerDisplayFilterId=s?.id,s}async _constructRendererLegendElements(e,t={}){const{title:s,sublayer:i}=t,r=i||this.layer,l=te(e,"reference-size"),n=te(e,"spike");let o=null;je(e)&&(await this._processDefinitionExpression(r,e),o=await this._processDisplayFilter(r,e)),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const a=await this._getVisualVariableLegendElements(e,r)||[],u={type:"symbol-table",title:s||this._getRendererTitle(e,r),infos:[]};let c=null,p=!1;const m=new Set;if(de(e)&&!this._hasSizeRamp){const t=await se(e);u.infos.push({label:null,symbol:t})}else if(function(e){const t="authoringInfo"in e?e?.authoringInfo:null;return"univariate-color-size"===t?.type}(e)){let t=s;const i=function(e){const t="authoringInfo"in e?e?.authoringInfo:null;return"univariate-color-size"===t?.type&&"above-and-below"===t?.univariateTheme}(e)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",r=a.findIndex(e=>"color-ramp"===e.type),l=-1!==r?a.splice(r,1)[0]:null,n=a.findIndex(e=>"size-ramp"===e.type),o=-1!==n?a.splice(n,1)[0]:null,u=[];l&&(t=l.title,u.push(l)),o&&(t=o.title,u.push(o)),u.length>0&&a.push({type:i,title:t,infos:u})}else if(ve(e)){const t=Q(e);a.push({type:"heatmap-ramp",title:s||this._getRendererTitle(e,r),infos:t,preview:P(t.map(e=>e.color),{effectList:this.effectList,ariaLabel:await Ue("previewColorRampAriaLabel")})})}else if(je(e)){const t=e.authoringInfo;if(t&&"relationship"===t.type){const{numClasses:s,field1:i,field2:l}=t,n=t.focus;if(s&&i&&l){const t=[i,l];let o=B(n)||0;for(const e of t){const{field:t,normalizationField:s,label:i}=e,l=i||{field:this._getFieldAlias(t,r),normField:s&&this._getFieldAlias(s,r)},n=ze.clone();n.angle=o,u.infos.push({label:l,symbol:n}),m.add(n),o+=90}const c=q({focus:n,numClasses:s,infos:e.uniqueValueInfos??[]});a.unshift(c)}}else if(Re(this.layer)||Ve(this.layer))e.uniqueValueInfos?.forEach(t=>{t.symbol&&this._checkClausesForUVR(e,t.value)&&u.infos.push({label:t.label||t.value,value:t.value,symbol:t.symbol})});else{const{field:t,field2:i,field3:n,fieldDelimiter:a,valueExpression:c,defaultSymbol:m}=e,d=!(!t&&!c||!i&&!n),h=this._layerDisplayFilterClause?o?.title:null,y=[];if(e.uniqueValueGroups?.forEach(s=>{const o={type:"symbol-table",title:h||s.heading,infos:[]};s.classes?.forEach(s=>{const{symbol:u,values:p}=s;if(u){const m=[],h=[];for(const e of p??[]){const{value:s,value2:l,value3:o}=e,u=[],p=[];(t||c)&&(u.push(s),p.push(this._getDomainName(t,s,r))),i&&(u.push(l),p.push(this._getDomainName(i,l,r))),n&&(u.push(o),p.push(this._getDomainName(n,o,r))),m.push(d?u.join(a||""):u[0]),h.push(p.join(" - "))}const y=m.join(", ");let f=s.label;if(!f){const e=h.filter(Boolean);f=e.length?e.join(", "):y}const b=u.clone();"cim"===b.type&&l&&x(b,{innerDotSize:8,outerRingSize:16}),m.some(t=>this._checkClausesForUVR(e,t))&&o.infos.push({label:f,value:y,symbol:b})}}),o.infos.length&&y.push(o)}),y.length){const t=y[0];if(1===y.length&&"title"in t&&!t.title){const e=t.infos?.filter(xe)??[];u.infos.push(...e)}else m&&(y.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:m}]}),p=!0),u.infos.push(...y);s||e.legendOptions?.title||e.valueExpressionTitle||(u.title=null)}}e.defaultSymbol&&!p&&(u.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),p=!0)}else if(Se(e)){if(!l&&!n){if(c=this._isUnclassedRenderer(e),!c||!this._hasSizeRamp){const t=e.classBreakInfos.filter(({symbol:e})=>e),s="ascending-values"===e.legendOptions?.order;for(const{label:e,minValue:i,maxValue:r,symbol:l}of t){const t={label:e||(c?null:`${i} - ${r}`),value:[i,r],symbol:l};s?u.infos.push(t):u.infos.unshift(t)}c&&(u.title=null),this._updateInfosForClassedSizeRenderer(e,u.infos)}e.defaultSymbol&&!c&&(u.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),p=!0)}}else if(fe(e))if(Ve(this.layer)||function(e){return"esri.layers.WCSLayer"===e.declaredClass}(this.layer)){const t=await this._constructTileImageryStretchRendererElements(e);"stretch-ramp"===t.type?a.push(t):u.infos=t}else{const t=this.layer;let s,i;e.customStatistics?.length&&({min:s,max:i}=e.customStatistics[0]);let r=[],l=t.serviceRasterInfo;if(t.rasterFunction)try{l=await t.generateRasterInfo(t.rasterFunction)}catch{}const n=I(l.pixelType);if(1===l.bandCount){const r=t.bandIds?.[0]||0;s=null!=s?s:l.statistics?l.statistics[r].min:n[0],i=null!=i?i:l.statistics?l.statistics[r].max:n[1],s||i?a.push(await this._getStretchLegendElements(e,{min:s,max:i})):this._getServerSideLegend()}else if(t.bandIds&&1===t.bandIds.length)s=null!=s?s:l.statistics?l.statistics[t.bandIds[0]].min:n[0],i=null!=i?i:l.statistics?l.statistics[t.bandIds[0]].max:n[1],s||i?a.push(await this._getStretchLegendElements(e,{min:s,max:i})):this._getServerSideLegend();else if(l.bandCount>=3){const{bandInfos:e}=l,{bandIds:s}=t;e.length>=l.bandCount?3===s?.length?(r=s.map(t=>e[t].name),u.infos=this._createSymbolTableElementMultiBand(r)):"lerc"===t.format?(r=[0,1,2].map(t=>e[t].name),u.infos=this._createSymbolTableElementMultiBand(r)):this._getServerSideLegend():"lerc"===t.format?(r=["band1","band2","band3"],u.infos=this._createSymbolTableElementMultiBand(r)):this._getServerSideLegend()}else this._getServerSideLegend()}else if(ye(e))e.colormapInfos.forEach(e=>{u.infos.push({label:e.label,value:e.value,symbol:this._getAppliedCloneSymbol(me,e.color)})});else if(ge(e)){let s=e.symbol;switch(t.geometryType){case"point":s="pointSymbol"in r?r.pointSymbol:null;break;case"polyline":s="lineSymbol"in r?r.lineSymbol:null;break;case"polygon":s="polygonSymbol"in r?r.polygonSymbol:null}const i=this._hasClusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;e.symbol&&i&&u.infos.push({label:e.label,symbol:s})}else if(he(e)){e.outputUnit&&(this.title="("+e.toJSON().outputUnit+")"),u.title=e.attributeField;const t=e.getClassBreakInfos();t?.length?t.forEach(e=>{u.infos.push({label:e.minValue+" - "+e.maxValue,symbol:e.symbol})}):u.infos.push({label:e.attributeField,symbol:e.getDefaultSymbol()})}else be(e)&&a.push(await this._getStretchLegendElements(e,{min:0,max:255}));const d=e.defaultSymbol;!d||p||ge(e)||c&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||a.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:d}]}),u.infos.length&&a.unshift(u);const h=null==t.opacity?this.opacity:t.opacity,y=this._isTallSymbol("visualVariables"in e?e.visualVariables:null),f=Re(this.layer)||Ve(this.layer);return await this._generatePreviewsForLegendElements(a,{opacity:h,symbolConfig:{isTall:y,isSquareFill:f},effectView:this.effectList},{defaultSymbol:d,arrowMarkerSymbols:m}),e=null,a}_checkClausesForUVR(e,t){const s=function(e,t){const{field:s,field2:i,field3:r,fieldDelimiter:l,valueExpression:n}=e;if(!s)return null;const o=(s||n)&&(i||r)?t?.toString().split(l||""):[t],a=s?{[s]:o?.[0]}:null;return a&&(i&&(a[i]=o?.[1]),r&&(a[r]=o?.[2])),a}(e,t);return!s||(!this._layerDefinitionExpressionClause||this._layerDefinitionExpressionClause.testFeature(s))&&(!this._layerDisplayFilterClause||this._layerDisplayFilterClause.testFeature(s))}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){const t=e?.infos;return t?t.reduce((e,t)=>e.concat(this._getAllInfos(t)),[]):[e]}async _constructTileImageryStretchRendererElements(e){const t=this.layer,s=t.symbolizer.rasterInfo??t.raster.rasterInfo;let i,r;const l=e?.customStatistics?.length?e.customStatistics:s?.statistics;if(l)({min:i,max:r}=l[0]);else{const e=I(s.pixelType);i=e[0],r=e[1]}if(t.hasStandardTime()&&(i=t.getStandardTimeValue(i),r=t.getStandardTimeValue(r)),1===s.bandCount||1===t.bandIds?.length)return this._getStretchLegendElements(e,{min:i,max:r});const n=(t?.bandIds?.length?t.bandIds:Array.from(Array(Math.min(s.bandCount,3)).keys())).map(e=>s.bandInfos[e].name);return n.length<3?n.push(n[1]):n.length>3&&n.splice(3),this._createSymbolTableElementMultiBand(n)}async _getStretchLegendElements(e,t){const s=e.colorRamp,i=G(s,t);return{type:"stretch-ramp",title:"",infos:i,preview:P(i.map(e=>e.color),{ariaLabel:await Ue("previewColorRampAriaLabel")})}}_getClusterSymbol(){const e=this.layer,t="featureReduction"in e&&e.featureReduction,s=t&&"symbol"in t&&t.renderer;return s&&!0!==s?.authoringInfo?.isAutoGenerated?null:t&&"symbol"in t?t.symbol:null}async _getSizeLegendElement(e,t,s,i){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:await Z(s,t,await ie(s),this.scale,this.view,i,this._hasClusterSizeVariable?this._getClusterSymbol():null)}}_createSymbolTableElementMultiBand(e){const t=[],s=["red","green","blue"];return e.forEach((e,i)=>{t.push({label:{colorName:s[i],bandName:e},src:re[i],opacity:this.opacity??1})}),t}_updateInfosForClassedSizeRenderer(e,t){const s=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,i=e.classBreakInfos.some(e=>H(e.symbol));if(s&&i){const s=K,i=X,r=e.classBreakInfos.length,l=(s-i)/(r>1?r-1:r);t.forEach((e,t)=>{e.size=s-l*t})}}_isTallSymbol(e){let t=!1,s=!1;if(e)for(let i=0;i<e.length&&(!t||!s);i++){const r=e[i];"size"===r.type&&("height"===r.axis&&(t=!0),"width-and-depth"===r.axis&&(s=!0))}return t&&s}async _generatePreviewsForLegendElements(e,t,s){const i=[];for(const r of e)for(const e of r.infos??[])if("infos"in e&&e.infos&&i.push(this._generatePreviewsForLegendElements([e],t,s)),xe(e)&&e.symbol&&!e.preview){let l=!0;if("cim"===e.symbol.type){const{minScale:t,maxScale:s}=e.symbol.data;(t&&t<this.scale||s&&s>this.scale)&&(l=!1)}l&&i.push(this._generateSymbolPreviewForInfo(e,{...t,clipBloomEffect:"theme"in r&&"spike"===r.theme,effectView:s?.arrowMarkerSymbols?.has(e.symbol)?null:t.effectView},s?{isDefault:e.symbol===s.defaultSymbol,applyScaleDrivenSize:!s.arrowMarkerSymbols?.has(e.symbol)}:void 0))}await Promise.all(i)}async _generateSymbolPreviewForInfo(e,t,s){try{let i=!s?.isDefault&&null==e.size&&this._hasSizeRamp?f(22):e.size;if(this._scaleDrivenSizeVariable&&s?.applyScaleDrivenSize){const{getSize:t}=await import("../../../chunks/visualVariableUtils.js").then(e=>e.l);i=t(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===e.symbol.type?e.symbol.style:null})}const r="cim"===e.symbol.type?{style:"legend",cimOptions:{allowScalingUp:!s?.isDefault&&this._hasSizeRamp||!(!this._scaleDrivenSizeVariable||!s?.applyScaleDrivenSize),viewParams:this.isScaleDriven?{viewingMode:"2d"===this.view?.type?"map":this.view?.viewingMode,scale:this.view?.scale}:null}}:{},l=e.label&&"string"!=typeof e.label?null:await Ue("previewTemplateAriaLabel",e.label);e.preview=await N(e.symbol,{size:i,scale:!1,ariaLabel:l,...t,...r})}catch{e.preview=null,u.getLogger(this).warn(`Generating symbol preview failed for symbol type: ${e.symbol?.type}`)}}_getClusterRenderer(e){this._hasClusterSizeVariable=!1;const t="renderer"in this.layer?this.layer.renderer:null,s=e.renderer?.clone()||t?.clone(),i=function(e,t,s){const i=e.effectiveClusterRenderer;if(!i||!("visualVariables"in i)||!i.visualVariables)return null;const r=i.visualVariables.find(e=>"size"===e.type);if(!("stops"in r)||!r.stops)return null;const l=r.stops.find(e=>e.useMinValue),n=r.stops.find(e=>e.useMaxValue);if(null==l||null==n)return null;const o=s.featuresTilingScheme.getClosestInfoForScale(s.scale).level,a=r.field,u=t.getDisplayStatistics(o,a);return u?new V({field:r.field,minSize:e.clusterMinSize,minDataValue:u.minValue,maxSize:e.clusterMaxSize,maxDataValue:u.maxValue}):null}(e,this.layerView,this.view);if(i&&null!=s&&"visualVariables"in s){const t=s.visualVariables?.some(e=>"size"===e.type&&"outline"!==e.target&&!ue.test(e.valueExpression));if(!t){if("clusterMinSize"in e&&"clusterMaxSize"in e){const{clusterMinSize:t,clusterMaxSize:s}=e;i.legendOptions=new D({showLegend:t!==s})}const t=s.visualVariables||[];s.visualVariables=t.concat([i]),this._hasClusterSizeVariable=!0}}return s}async _loadRenderer(e){const t=[],s=e.clone(),i=await ie(s);if(Se(s)||je(s)){const e=(s.classBreakInfos||s.uniqueValueInfos).map(e=>this._fetchSymbol(e.symbol,i).then(t=>{e.symbol=t}).catch(()=>{e.symbol=null}));Array.prototype.push.apply(t,e)}return t.push(this._fetchSymbol(s.symbol||s.defaultSymbol,s.defaultSymbol?null:i).then(e=>{this._applySymbolToRenderer(s,e,ge(s))}).catch(()=>{this._applySymbolToRenderer(s,null,ge(s))})),await Promise.allSettled(t),s}_applySymbolToRenderer(e,t,s){s?e.symbol=t:e.defaultSymbol=t}async _fetchSymbol(e,t){if(!e)throw new Error;if("web-style"===e.type){const s=this._webStyleSymbolCache;try{const i=await e.fetchSymbol({cache:s});return this._getAppliedCloneSymbol(i,t)}catch{throw u.getLogger(this).warn("Fetching web-style failed!"),new Error}}return this._getAppliedCloneSymbol(e,t)}_getAppliedCloneSymbol(e,s){if(!e||!s)return e;const i=e.clone(),r=s&&s.toRgba();return i.type.includes("3d")?this._applyColorTo3dSymbol(i,r):"cim"===i.type?T(i,s):i.color&&(i.color=new t(r||i.color)),i}_applyColorTo3dSymbol(e,s){s&&e.symbolLayers.forEach(e=>{e&&(e.material||(e.material={}),e.material.color=new t(s))})}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||"vector-field"===e.type)return null;const s=e.visualVariables??[],i=[],r=[],n=[],o=te(e,"reference-size")??te(e,"spike");let a;if(2===o?.sizeStops?.length&&(Se(e)||je(e))){const[e,t]=o.sizeStops;a=new V({field:o.field??void 0,normalizationField:o.normalizationField,minSize:c(e.size,10,100),maxSize:c(t.size,50,150),minDataValue:e.value,maxDataValue:t.value}),r.push(a)}for(const e of s)"color"===e.type?i.push(e):"size"===e.type?r.push(e):"opacity"===e.type&&n.push(e);const u=[...i,...r,...n];let p,m;if(0===i.length&&Se(e)&&e.classBreakInfos&&1===e.classBreakInfos.length){const t=e.classBreakInfos[0];p=t&&t.symbol}if(0===i.length&&ge(e)&&(p=e.symbol),p)if(p.type.includes("3d")){const e=p.symbolLayers.at(0);"water"===e.type?null!=e.color&&(m=e.color):null!=e.material?.color&&(m=e.material.color)}else p.url||(m=p.color);const d=this.effectList;return(await Promise.all(u.map(async s=>{if(!s.legendOptions||!1!==s.legendOptions.showLegend){const i=de(e)?s.field:this._getRampTitle(s,t);let r=null;const l=le(t,s,this.view.timeZone);if("color"===s.type){const e=await J(s,null,l)??[];r={type:"color-ramp",title:i,infos:e,preview:P(e.map(e=>e.color),{effectList:d,ariaLabel:await Ue("previewColorRampAriaLabel")})},this._hasColorRamp||(this._hasColorRamp=e.length>0)}else if("size"===s.type&&"outline"!==s.target)ue.test(s.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=s):(r=await this._getSizeLegendElement(i,s,e,l),a===s&&"spike"===o?.theme&&(r.theme=o.theme),this._hasSizeRamp||(this._hasSizeRamp=!(null==r.infos||!r.infos.length)));else if("opacity"===s.type){const e=await J(s,m,l)??[];r={type:"opacity-ramp",title:i,infos:e,preview:P(e.map(e=>e.color),{effectList:d,ariaLabel:await Ue("previewColorRampAriaLabel")})},this._hasOpacityRamp||(this._hasOpacityRamp=e.length>0)}return r?.infos?r:null}}))).filter(l)}_getDomainName(e,t,s){if(e&&"function"!=typeof e){const i="getField"in s&&s.getField?.(e),r=i&&"getFieldDomain"in s&&s.getFieldDomain?s.getFieldDomain(i.name,{excludeImpliedDomains:n("esri-widget-legacy-field-domain-calculation")}):null;return"coded-value"===r?.type?r.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,s=e.field;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type){const e=t.featureReduction,i="popupTemplate"in e&&e.popupTemplate,r=i&&i.fieldInfos;if(r)for(const e of r)if(e.fieldName===s)return"cluster_count"===s?e.label||{showCount:!0}:e.label}return{showCount:!0}}_getRampTitle(e,t){let s=e.field,i=e.normalizationField,r=!1,l=!1,n=!1,o=null;s="function"==typeof s?null:s,i="function"==typeof i?null:i;const a=e.legendOptions?.title;if(null!=a)o=a;else if(e.valueExpressionTitle)o=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo?.visualVariables){const e=t.renderer.authoringInfo.visualVariables;for(let t=0;t<e.length;t++){const s=e[t];if("color"===s.type){if("ratio"===s.style){r=!0;break}if("percent"===s.style){l=!0;break}if("percent-of-total"===s.style){n=!0;break}}}}o={field:s&&this._getFieldAlias(s,t),normField:i&&this._getFieldAlias(i,t),ratio:r,ratioPercent:l,ratioPercentTotal:n}}return o}_getRendererTitle(e,t){const s=e;if(s.legendOptions?.title)return s.legendOptions.title;if(s.valueExpressionTitle)return s.valueExpressionTitle;let i=s.field,r=null,l=null;if(Se(s)&&(r=s.normalizationField,l="percent-of-total"===s.normalizationType),i="function"==typeof i?null:i,r="function"==typeof r?null:r,je(s)){const{field2:e,field3:r,fieldDelimiter:l}=s;let n=i&&this._getFieldAlias(i,t);return e&&(n=`<${n}>${l}<${this._getFieldAlias(e,t)}>`,r&&(n=`${n}${l}<${this._getFieldAlias(r,t)}>`)),n}let n=null;return(i||r)&&(n={field:i&&this._getFieldAlias(i,t),normField:r&&this._getFieldAlias(r,t),normByPct:l}),n}_getFieldAlias(e,t){const s="popupTemplate"in t?t.popupTemplate:null,i=s?.fieldInfos;let r=i?.find(t=>e===t.fieldName),l=null;"getField"in t&&t.getField?l=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(l=t.fieldsIndex.get(e));let n=null;const o="featureReduction"in t&&t.featureReduction;o&&(r??="popupTemplate"in o?o.popupTemplate?.fieldInfos?.find(t=>e?.toLowerCase()===t.fieldName?.toLowerCase()):void 0,"fields"in o&&o.fields&&(n=o.fields.find(t=>t.name?.toLowerCase()===e?.toLowerCase())));const a=r||l||n;let u=null;return a&&(u=r?.label||l?.alias||n?.alias||"name"in a&&a.name||"fieldName"in a&&a.fieldName||null),u}_isUnclassedRenderer(e){const t=e.visualVariables;let s=!1;return Se(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&t&&(s=e.field?t.some(t=>!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField)):!!t.length),s}};e([S()],Me.prototype,"children",void 0),e([S({readOnly:!0})],Me.prototype,"effectList",null),e([S()],Me.prototype,"layerView",void 0),e([S()],Me.prototype,"layer",void 0),e([S()],Me.prototype,"legendElements",void 0),e([S({readOnly:!0})],Me.prototype,"opacity",null),e([S()],Me.prototype,"parent",void 0),e([S({readOnly:!0,dependsOn:[]})],Me.prototype,"ready",null),e([S()],Me.prototype,"hideLayersNotInCurrentView",void 0),e([S()],Me.prototype,"keepCacheOnDestroy",void 0),e([S()],Me.prototype,"respectLayerDefinitionExpression",void 0),e([S()],Me.prototype,"respectLayerVisibility",void 0),e([S({readOnly:!0})],Me.prototype,"scale",null),e([S()],Me.prototype,"sublayerIds",void 0),e([S({readOnly:!0})],Me.prototype,"isScaleDriven",null),e([S()],Me.prototype,"title",void 0),e([S({readOnly:!0,dependsOn:["ready"],value:0})],Me.prototype,"version",null),e([S()],Me.prototype,"view",void 0),Me=e([j("esri.widgets.Legend.support.ActiveLayerInfo")],Me);export{Me as default};
