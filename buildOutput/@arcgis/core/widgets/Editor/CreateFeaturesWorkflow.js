/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import s from"../../core/Error.js";import{m as r,h as i,a as o}from"../../chunks/handleUtils.js";import"../../core/lang.js";import{L as a}from"../../chunks/Logger.js";import{r as n,d as p}from"../../chunks/maybe.js";import{throwIfAborted as l,isPromiseLike as m,debounce as u}from"../../core/promiseUtils.js";import{watch as c,when as d,initial as h,whenOnce as j,syncAndInitial as y}from"../../core/reactiveUtils.js";import{a as f}from"../../chunks/uuid.js";import{property as g}from"../../core/accessorSupport/decorators/property.js";import{subclass as k}from"../../core/accessorSupport/decorators/subclass.js";import{b,h as w,a as F}from"../../chunks/templateUtils2.js";import v from"../../layers/GraphicsLayer.js";import{F as I}from"../../chunks/layerUtils.js";import{a as S}from"../../chunks/guards.js";import{getDisplayedSymbol as M}from"../../symbols/support/symbolUtils.js";import{g as _}from"../../chunks/helpMessageUtils.js";import U from"../../views/draw/support/HighlightHelper.js";import{S as V}from"../../chunks/SketchOptions.js";import C from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{t as T}from"../../chunks/HighlightDefaults.js";import P from"./CreateFeaturesWorkflowData.js";import{s as A,c as E,a as L,b as x,o as D,d as R,e as O,h as H,i as z,u as G,j as B,k as W,l as N,m as q,n as Z,p as Q,q as K,r as J,t as X,v as Y,w as $}from"../../chunks/workflowUtils.js";import ee from"./Workflow.js";import te from"../FeatureForm/FeatureFormViewModel.js";import se from"../Sketch/SketchViewModel.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/Lifecycle.js";import"../../chunks/metadata.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../chunks/object.js";import"../../chunks/events.js";import"../../config.js";import"../../chunks/string.js";import"../../chunks/Warning.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/jsonUtils.js";import"../../core/JSONSupport.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../chunks/datetime.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/support/AttachmentsOrderByInfo.js";import"../../chunks/jsonMap.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/constants.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/mathUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../geometry/support/jsonUtils.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../geometry/Point.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/createFeatureId.js";import"../../chunks/typeUtils2.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils3.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils4.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/vec3f64.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/DoubleArray.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../chunks/lineMarkers.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/Font.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../editing/sharedTemplates/SharedTemplateMetadata.js";import"../../chunks/ReactiveMap.js";import"../../chunks/UpdatingHandles.js";import"../../chunks/utils12.js";import"../../rest/featureService/FeatureService.js";import"../../chunks/applyEditsUtils.js";import"../../chunks/projectionUtils.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../geometry/support/MeshTransform.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../chunks/mat4f64.js";import"../../chunks/quat.js";import"../../chunks/vec3.js";import"../../chunks/vec4.js";import"../../chunks/quatf64.js";import"../../chunks/axisAngleDegrees.js";import"../../chunks/editingSupport.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils9.js";import"../../chunks/utils10.js";import"../../chunks/EditBusLayer.js";import"../../chunks/infoFor3D.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/asyncUtils.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../chunks/featureQueryAll.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../time/TimeExtent.js";import"../../chunks/timeUtils.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/commonProperties2.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../chunks/RendererLegendOptions.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/NormalizationBinParametersMixin.js";import"../../rest/support/RelationshipQuery.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/portalItemUtils.js";import"../../chunks/editsZScale.js";import"../../chunks/GraphicsCollection.js";import"../../layers/Layer.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/layerContainerType.js";import"../../chunks/jsonUtils2.js";import"../../chunks/parser.js";import"../../chunks/utils5.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../symbols/support/ElevationInfo.js";import"../../symbols/support/FeatureExpressionInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/gfxUtils.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils6.js";import"../../chunks/defaultCIMValues.js";import"../../chunks/renderUtils.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4f64.js";import"../../chunks/projector.js";import"../../chunks/sanitizerUtils.js";import"../../chunks/svgUtils.js";import"../../chunks/mat2df32.js";import"../../chunks/mat2d.js";import"../../chunks/widgetUtils.js";import"../../chunks/jsxFactory.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/utils8.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/layerUtils2.js";import"../../chunks/editableLayers.js";import"../../chunks/layerViewUtils.js";import"../../views/interactive/sketch/SketchLabelOptions.js";import"../../views/interactive/sketch/SketchTooltipOptions.js";import"../../chunks/SketchTooltipVisibleElements.js";import"../../views/interactive/sketch/SketchValueOptions.js";import"./Edits.js";import"../../chunks/formUtils2.js";import"../../chunks/formUtils.js";import"../../form/elements/AttachmentElement.js";import"../../form/elements/Element.js";import"../../form/elements/inputs/attachments/AttachmentInput.js";import"../../chunks/Input.js";import"../../form/elements/inputs/attachments/AudioInput.js";import"../../chunks/utils2.js";import"../../form/elements/inputs/attachments/DocumentInput.js";import"../../form/elements/inputs/attachments/ImageInput.js";import"../../form/elements/inputs/attachments/SignatureInput.js";import"../../form/elements/inputs/attachments/VideoInput.js";import"../../form/elements/FieldElement.js";import"../../form/elements/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../form/elements/RelationshipElement.js";import"../../form/elements/TextElement.js";import"../../form/elements/UtilityNetworkAssociationsElement.js";import"../../chunks/dateUtils.js";import"../../intl.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../chunks/SharedTemplateProvider.js";import"../../chunks/utils11.js";import"../../chunks/Version2.js";import"../../chunks/Version.js";import"../../chunks/drapedUtils.js";import"../../chunks/typeUtils3.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/support/ClassBreakInfo.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/DictionaryScriptEvaluator.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/ArcadeExpression.js";import"../../chunks/TimeOnly.js";import"../../chunks/enum.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../renderers/PieChartRenderer.js";import"../../chunks/GraphicState.js";import"../../chunks/DrawingMode.js";import"../../chunks/hitTestSelectUtils.js";import"../../chunks/sketchUtils.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../chunks/LayerContingentValuesCache.js";import"../../layers/support/Subtype.js";import"../../chunks/featureFormUtils.js";import"../../chunks/utils7.js";import"../../chunks/basemapUtils.js";import"../../chunks/basemapDefinitions.js";import"../FeatureForm/FieldInput.js";import"../../chunks/featureUtils.js";import"../FeatureForm/EditableInput.js";import"../FeatureForm/InputBase.js";import"../FeatureForm/GroupInput.js";import"../FeatureForm/RelationshipInput.js";import"../../chunks/FeatureRelationshipViewModel.js";import"../FeatureForm/TextElementInput.js";import"../../chunks/ReactiveSet.js";import"../../arcade.js";import"../../chunks/arcadeEnvironment.js";import"../../chunks/ImmutableArray.js";import"../../layers/FeatureLayer.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../graphic/FeatureGraphicOrigin.js";import"../../graphic/GraphicOrigin.js";import"../../chunks/isFeatureGraphicOrigin.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../chunks/queryZScale.js";import"../../rest/support/FeatureSet.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../layers/mixins/DisplayFilteredLayer.js";import"../../layers/support/DisplayFilterInfo.js";import"../../chunks/scaleUtils.js";import"../../layers/support/DisplayFilter.js";import"../../chunks/displayFilterUtils.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties.js";import"../../tables/AttributeTableTemplate.js";import"../../tables/elements/AttributeTableGroupElement.js";import"../../tables/elements/AttributeTableAttachmentElement.js";import"../../tables/elements/AttributeTableElement.js";import"../../tables/elements/AttributeTableFieldElement.js";import"../../tables/elements/AttributeTableRelationshipElement.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../chunks/multiLayerServiceUtils.js";import"../../layers/support/Relationship.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../renderers/support/jsonUtils.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../layers/support/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../layers/support/TimeInfo.js";import"../../time/TimeInterval.js";import"../../layers/mixins/TrackableLayer.js";import"../../layers/support/TrackInfo.js";import"../../layers/support/TrackPartInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/TitleCreator.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/isSupportedObject.js";import"../../chunks/elevationInfoUtils.js";import"../../chunks/InputManager.js";import"../../chunks/signal.js";import"../../chunks/keybindings.js";import"../../chunks/SnappingManager.js";import"../../chunks/normalizedPoint.js";import"../../chunks/dehydratedPoint.js";import"../../chunks/Settings.js";import"../../views/interactive/snapping/SnappingOptions.js";import"../../chunks/constraints.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/plane.js";import"../../chunks/vector.js";import"../../chunks/mat3f64.js";import"../../chunks/mathUtils2.js";import"../../chunks/sphere.js";import"../../chunks/ray.js";import"../../chunks/mat3.js";import"../../chunks/geometry2dUtils.js";import"../../chunks/RightAngleSnappingHint.js";import"../../chunks/geodesicLengthMeasurementUtils.js";import"../../chunks/quantityUtils.js";import"../../chunks/projectVectorToVector.js";import"../../chunks/projectPointToVector.js";import"../../chunks/spatialReferenceEllipsoidUtils.js";import"../../geometry/operators/geodeticLengthOperator.js";import"../../chunks/geodeticCurveType.js";import"../../chunks/geodesicMeasurementUtils.js";import"../../chunks/automaticAreaMeasurementUtils.js";import"../../chunks/geodesicAreaMeasurementUtils.js";import"../../chunks/earcut.js";import"../../chunks/triangle.js";import"../../chunks/lineSegment.js";import"../../chunks/automaticLengthMeasurementUtils.js";import"../../chunks/screenUtils2.js";function re(e){const t=e?.layer;return"scene"===t?.type}var ie;const oe=Symbol(),ae=Symbol(),ne=Symbol(),pe=Symbol(),le={point:["point"],multipoint:["multipoint"],polygon:["polygon","freehandPolygon","rectangle","circle"],polyline:["polyline","freehandPolyline"],mesh:[],multipatch:[]};let me=ie=class extends ee{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this.data=void 0,this.isNested=!1,this._getDrawMeshHelpMessage=void 0,this._webStyleCache=new Map,this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._featureFormViewModel=new te,this._sketchViewModel=null,this._attachmentFileInfos=new Map,this._isActive=!0}initialize(){this.isNested&&(this._isActive=!1),this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){if(this.pendingFeatures.some(e=>!!this.data.getEditsForPendingFeature(e)?.modified))return!0;const{creationInfo:e,upload:t}=this.data,s=this._sketchViewModel,{activeComponent:r}=s,i=s.createGraphic?.geometry?.type;return!("polyline"!==i&&"polygon"!==i&&"multipoint"!==i||"draw-2d"!==r?.type&&"draw-3d"!==r?.type)&&r.drawOperation.committedVertices.length>0||!(!t||"pending"!==t.state&&"success"!==t.state)||!!e?.geometryToPlace}get hasPreviousStep(){return this._stepIndex>0||"update-pending"===this.createFeatureState&&!!this.data.selectedPendingFeature&&!this.parent&&!re(this.data.creationInfo)}get helpMessage(){const{creationInfo:e,viewModel:t}=this.data;if("creating-features"!==this.stepId||!e)return;const s=e.layer.geometryType,r=this._sketchViewModel.createGraphic;if("mesh"===s){this._getDrawMeshHelpMessage||import("../../chunks/helpMessageUtils3d.js").then(e=>{this._getDrawMeshHelpMessage=e.getDrawMeshHelpMessage});const{view:e}=t;return"3d"===e?.type?this._getDrawMeshHelpMessage?.(r,e):void 0}const i=this._sketchViewModel.activeCreateToolDrawMode,o=this._sketchViewModel.activeTool;return _("rectangle"===o?"rectangle":"circle"===o?"circle":s,r?.geometry,i)}get layer(){return this.data.creationInfo?.layer}get numPendingFeatures(){return this.pendingFeatures.length}get numPendingFeaturesExcludingHidden(){return this.pendingFeatures.filter(e=>this.data.isDisplayable(e)).length}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){return this.data.editorItem?.capabilities.create.reliesOnOwnerAdminPrivileges??!1}get shouldShowAttachments(){return(this.data.selectedPendingFeature&&this.data.editorItem?.capabilities.create.attachments.enabled)??!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){}get availableCreateTools(){const e=this.data.creationInfo?.layer.geometryType,t=this.data.viewModel.view;if(!e)return[];if(this.data.creationInfo?.maxFeatures&&this.data.creationInfo.maxFeatures<=this.numPendingFeatures)return[];if(b(this.data.fullTemplate)){const{tool:t}=E(e,this.data.fullTemplate);return[t]}return"2d"!==t?.type&&"multipoint"===e?[]:[...le[e]]}get _attachmentsActive(){const e=this.data.viewModel.attachmentsViewModel.mode,t=this.stepId;return this.shouldShowAttachments&&("add"===e||"edit"===e||"adding-attachment"===t||"editing-attachment"===t)}async enter(){this._isActive=!0,"awaiting-feature-creation-info"!==this.stepId&&await this._updatingHandles.addPromise(this._setUpCreatingFeaturesStep())}exit(){this._isActive=!1,this.removeHandles([ne])}async updatePendingFeature(e){if(e!==this.data.selectedPendingFeature)return this._sketchViewModel.cancel(),this._startUpdating({feature:e})}async start(){return await super.start(),I(this.data.creationInfo?.layer)?null:{enter:async()=>{},exit:async()=>{},viewModel:this._sketchViewModel}}async save(){const{featureFormViewModel:e}=this;if(e.pendingSubtypeChoice)return;e.submit(),this._stashValidationState();const t=this.data.selectedPendingFeature,s=this._hasValidationErrors(t)?t:this.data.pendingFeatures.find(e=>this._hasValidationErrors(e));return s?(await this._startUpdating({feature:s}),void e?.submit()):super.save()}back(e){return"update-pending"!==this.createFeatureState||!this.data.selectedPendingFeature||re(this.data.creationInfo)||this._attachmentsActive||this.parent?super.back(e):this._clearSelectedFeature()}previous(e){return"update-pending"!==this.createFeatureState||!this.data.selectedPendingFeature||re(this.data.creationInfo)||this._attachmentsActive?super.previous(e):this._clearSelectedFeature()}cancelFeature(e){this.data.isSharedTemplateWorkflow?a.getLogger(this).warn("Cannot cancel individual features created by shared templates."):(this.data.removePendingFeature(e),this.sketchViewModel.layer.graphics.remove(e))}static create(e){const{addAttachmentsCallback:t,applyEditsCallback:s,applyEditsFeatureServiceCallback:r,isNested:i,creationInfo:o,parent:a,snappingManager:n,startAt:p,viewModel:l}=e,m=e.sketchOptions??new V,u=o?.layer,c=u?l.findEditorItemForLayer(u):void 0,d=new ie({data:new P({creationInfo:o,editorItem:c,parent:a,sketchOptions:m,snappingManager:n,viewModel:l}),isNested:i,onCommit:async e=>{const{creationInfo:i}=e;if(!i)return;d._sketchViewModel.cancel();const o=e.pendingFeatures.toArray(),{layer:a}=i,n=a.capabilities?.editing.supportsGlobalId&&"globalIdField"in a,p=d._attachmentFileInfos,{fullTemplate:m}=e,u=L(d.data),c=w(m)&&u;if(n){if(function(e){for(const t of e){const{sourceLayer:e}=t;e&&"globalIdField"in e&&null!=e.globalIdField&&(t.attributes[e.globalIdField]??=f())}}(o),c){let t=function(e,t){return e.map(e=>{const{addFeatures:s}=e;if(!s||0===s.length)return e;const r=[];for(const e of s){const s=t.get(e);if(s)for(const{file:t}of s)r.push({feature:e,attachment:{globalId:f(),data:t}})}return r.length?{...e,addAttachments:r}:e})}(u,p);const s=await x(a,l.view);s&&(t=D({edits:t,serviceInfo:s,view:l.view,findOriginalFeature:t=>e.getEditsForPendingFeature(t)?.initialFeature??t})),await r(m.featureService,t,{globalIdUsed:!0,gdbVersion:m.layer.gdbVersion??void 0})}else{const e=function(e,t){const s=[];if(!t||0===t.size)return{addFeatures:e};for(const[e,r]of t)for(const{file:t}of r)s.push({feature:e,attachment:{globalId:f(),data:t}});return s.length?{addFeatures:e,addAttachments:s}:{addFeatures:e}}(o,p);await s(a,e,{globalIdUsed:!0})}return}const h=c?await r(m.featureService,u,{gdbVersion:m.layer.gdbVersion??void 0}):[await s(a,{addFeatures:o})];h&&p.size>0&&await Promise.all(h.map(e=>{if(e?.addFeatureResults)return t(a,function(e,t,s,r){const i=[];return t.forEach((t,o)=>{if(!t.error){const a=e[o],n=r.get(a)||[];a.attributes[s.objectIdField]=t.objectId,n.forEach(({form:e})=>i.push({feature:a,attachment:e}))}}),i}(o,e.addFeatureResults,a,p))}))}});return d._set("steps",this._createWorkflowSteps(d,p)),d}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",r(()=>e.effect=t)}const t=e.opacity;return e.opacity=.7,r(()=>e.opacity=t)}async _initializeFullTemplateAndExecutorInfo(e){const{creationInfo:t}=e,{view:s}=e.viewModel;if(!t||!s)return null;const r=await R(t,s);if(e.fullTemplate=r,r&&w(r)){const{createTemplateExecutor:i}=await import("../../chunks/createTemplateExecutor.js").then(e=>e.e),o={completionResults:[],executor:await i(r),serviceLayersById:await O(t.layer,s)};e.templateExecutorInfo=o}return r}async _startCreating(){this.removeHandles(ae);const{data:e}=this;if(!e.creationInfo)return;const t=this.data.creationInfo?.maxFeatures;if(t&&this.numPendingFeatures>=t)return this.sketchViewModel.cancel(),void(this.numPendingFeatures&&await this._startUpdating({feature:this.pendingFeatures.at(-1)}));this.createFeatureState="create-new",await H(this._sketchViewModel,e,this._webStyleCache)}async _clearSelectedFeature(){const e=this._featureFormViewModel.pendingSubtypeChoice;e&&(e.resolve("undo"),await e.promise),this._stashValidationState(),this.sketchViewModel.cancel(),this.data.selectedPendingFeature=null,this._featureFormHandle=n(this._featureFormHandle),this._featureFormViewModel.feature=null;const t=this.data.viewModel.attachmentsViewModel;"add"!==t.mode&&"edit"!==t.mode||await(this.data.viewModel.activeWorkflow?.previous())}_stashValidationState(){const e=this._featureFormViewModel.feature,t=e&&this.data.getEditsForPendingFeature(e);t&&(t.submittable=this._featureFormViewModel.submittable)}async _selectFeatureForUpdate({feature:e,initialFeature:t=e}){this._stashValidationState();const{data:s,pendingFeatures:r,_webStyleCache:o}=this;r.includes(e)||s.addPendingFeature(e,t),s.selectedPendingFeature=e;const{_featureFormViewModel:a,_sketchViewModel:p}=this,{creationInfo:l,viewModel:m}=s,{attachmentsViewModel:u,layerInfos:d,view:h}=m;if(!h||!l)return;n(this._featureFormHandle);const j=e.sourceLayer,y=z(d,j),f=y?.formTemplate,g=h.spatialReference;a.set({editType:"INSERT",feature:e,formTemplate:f,spatialReference:g,map:h.map}),"add"!==u.mode&&"edit"!==u.mode||await(m.activeWorkflow?.previous()),u.graphic=e,u.fileInfos.removeAll(),u.mode="view",(this._attachmentFileInfos.get(e)||[]).forEach(({file:e,form:t})=>u.addFile(e,t)),await G(e,o,"2d"===h.type?h.scale:null);const k=s.getEditsForPendingFeature(e);this._featureFormHandle=i([a.on("value-change",async({fieldName:t,value:s})=>{if(k?.updateAttributes(a.getValues()),S(s)){const e=this._visualVariableAttributes;e.size&&!e.size.isUpdatingInteractively&&t===e.size.field&&e.size.setInitialValue(s),e.rotation&&!e.rotation.isUpdatingInteractively&&t===e.rotation.field&&e.rotation.setInitialValue(s)}await G(e,o,"2d"===h.type?h.scale:null)}),p.on(["update","undo","redo"],e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&null!=e.toolEventInfo&&B(e.toolEventInfo.type))&&a.notifyFeatureGeometryChanged()}),c(()=>a.feature?.sourceLayer,t=>e.sourceLayer=t),c(()=>[a.feature,a.submittable],()=>this._stashValidationState())]),this.createFeatureState="update-pending"}async _startUpdating({feature:e,initialFeature:t=e}){await this._selectFeatureForUpdate({feature:e,initialFeature:t});const{_sketchViewModel:s,data:r}=this,{creationInfo:i,viewModel:o}=r,{view:a}=o;if(!a||!i)return;const n=e.sourceLayer??i.layer;return I(n)?void 0:(this._visualVariableAttributes=W(e),N({graphic:e,sketchViewModel:s,sourceLayer:n,visualVariables:this._visualVariableAttributes,webStyleCache:this._webStyleCache}))}static _createWorkflowSteps(e,s="awaiting-feature-creation-info"){const{data:o}=e,a={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const{creationInfo:s,viewModel:a}=o,{view:n}=a;n&&(re(s)?e.addHandles(await async function({view:e,data:s,signal:o,next:a,cancel:n}){const{creationInfo:p}=s;if(!p)return r();if(!re(p))return r();const{layer:m}=p,u=null!=p.geometryToPlace;if(p.geometryToPlace=null,u)return n(),r();const{Upload:d}=await import("../../chunks/Upload.js");l(o);const h=new d;s.upload=h;let j=null;const y=()=>j?.remove(),f=i([c(()=>h.state,s=>{switch(s){case"default":case"error":y();break;case"pending":y(),j=A(e);break;case"success":{p.maxFeatures=1;const{result:e}=h;"georeferenced"===e?.type||"georeferenced-reprojected"===e?.type?(p.geometryToPlace=e.mesh,p.initialFeature=new t({geometry:e.mesh,sourceLayer:m})):p.geometryToPlace=e?.mesh,y(),a();break}}}),r(()=>{h.cancel(),y()})]);return h.uploadTo(m),f}({view:n,data:o,next:()=>e.next(),cancel:()=>a.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(o.parent&&s&&e.addHandles(a.restrictFeatureTemplatesViewModelToLayer(s.layer),this.id),e.addHandles(a.featureTemplatesViewModel.on("select",({item:t})=>{t&&(o.creationInfo={...o.creationInfo,layer:t.layer,template:t.template},e.next())}),this.id)))},async tearDown(){e.removeHandles(this.id)}}),"creating-features":()=>({id:"creating-features",async setUp(){e._isActive&&await e._setUpCreatingFeaturesStep()},async tearDown(t){const{viewModel:s}=o;t.canceled&&(e.removeHandles([ne,oe,ae,pe]),s.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=o.viewModel,{graphic:s,fileInfos:r}=t;e._attachmentFileInfos.set(s,r.toArray()),t.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=o.viewModel,{graphic:s,fileInfos:r}=t;e._attachmentFileInfos.set(s,r.toArray()),t.mode="view"}})},n=q(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],s,a);return Z(o,n)}static _configureSketchViewModel(e){const{data:t}=e,s=e._webStyleCache,{creationInfo:o,viewModel:a}=t,{view:n}=a,l=e._sketchViewModel,m=[];if(!n)return r();if("2d"===n.type){o&&m.push(e._fadeExistingFeatures(o.layer));const t=u((e,t)=>Promise.all(e.map(e=>G(e,s,t))));m.push(c(()=>n.scale,e=>t(l.layer.graphics,e)))}const h=Q(t.fullTemplate,o?.attributeOverrides),j=c(()=>l.createGraphic,r=>{r&&!e.hasHandles(ae)&&e._updatingHandles.addPromise($({creationAttributes:h,data:t,sketchViewModel:l,view:n,webStyleCache:s}).then(t=>e.addHandles(t,ae)))});m.push(j,l.on("create",t=>e._updatingHandles.addPromise((async t=>{if("cancel"!==t.state&&"complete"!==t.state||e.removeHandles(ae),"cancel"===t.state&&null!==n.activeTool&&n.activeTool!==e.sketchViewModel.activeComponent&&(await e._waitForActiveToolCleared(),await e._startCreating()),"complete"===t.state&&t.graphic){const s=await e._processEdits(t.graphic,{scale:"2d"===n.type?n.scale:null,useSourceLayer:!0,webStyleCache:e._webStyleCache});s&&(await e._waitForActiveToolCleared(),await e._startUpdating({feature:s}))}})(t))),l.on("update",s=>e._updatingHandles.addPromise((async s=>{const{attachmentsViewModel:r}=a,{_featureFormViewModel:i}=e;if(s.graphics.length>1)return void await e._clearSelectedFeature();const p=s.graphics[0];if("complete"===s.state){const{submittable:t}=i;if(e.numPendingFeatures!==o?.maxFeatures&&t||i.submit(),await e._clearSelectedFeature(),"add"!==r.mode&&"edit"!==r.mode||await(a.activeWorkflow?.previous()),!s.aborted&&n.activeTool===e.sketchViewModel.activeComponent&&(await e.sketchViewModel.wait(),"ready"===e.sketchViewModel.state&&"mesh"!==e.data.creationInfo?.layer.geometryType))return e._startCreating()}else{if("start"===s.state)return p.sourceLayer??=t.creationInfo?.layer,await X({sketchViewModel:l,graphic:p,visualVariables:e._visualVariableAttributes,webStyleCache:e._webStyleCache,sourceLayer:p.sourceLayer}),e._selectFeatureForUpdate({feature:p});if("active"===s.state){await e.updatePendingFeature(p);const t=e._visualVariableAttributes;Y(n,p,s,t)&&await G(p,e._webStyleCache,"2d"===n.type?n.scale:null);const r=p.attributes,{rotation:o,size:a}=t;if(null!=o){const{field:e}=o;i.setValue(e,r[e])}if(null!=a){const{field:e}=a;i.setValue(e,r[e])}}}})(s))),l.on("delete",s=>e._updatingHandles.addPromise((async s=>{if(s.graphics.forEach(e=>{t.removePendingFeature(e)}),!re(t.creationInfo))return e._startCreating()})(s))),d(()=>!e.numPendingFeatures,()=>e._updatingHandles.addPromise((async()=>{if(re(t.creationInfo))try{await e.data.viewModel.back()}catch{}return e._startCreating()})())),r(()=>{l.cancel()}),function(e,t){let s=null;const o=()=>e.snappingOptions.featureSources,a=()=>{null!=s&&(o().remove(s),s=p(s))};return i([c(()=>{const e=t.creationInfo?.layer,s=o().find(t=>t.layer===e);return{hasFeatureLayerSource:!!s,enabled:s?.enabled??!1}},({hasFeatureLayerSource:t,enabled:r})=>{if(!t)return a();s??=(s=new C({layer:e.layer}),o().add(s),s),s.enabled=r},y),r(a)])}(l,t),...function(e){const t=e.viewModel.view;if(!t)return[];const s=[];if("3d"===t.type){const i=new U({view:t});s.push(c(()=>e.selectedPendingFeature,(e,t)=>{i.remove(e),i.add(t)}),r(()=>i.destroy()))}const i=new U({view:t,highlightName:T});return s.push(c(()=>e.temporaryHighlightFeature,e=>{i.removeAll(),i.add(e)}),r(()=>i.destroy())),s}(t));const f=i(m);return l.addHandles(f),f}_initializeSketchViewModel(){const{data:e}=this,{view:t}=e.viewModel,s=new v({elevationInfo:e.creationInfo?.layer.elevationInfo,internal:!0,listMode:"hide",title:"createFeaturesWorkflow-internal"}),i=new se({layer:s,creationMode:"single",sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,defaultUpdateOptions:{multipleSelectionEnabled:!1},view:t});this._sketchViewModel=i,t?.map.add(s),this.addHandles([r(()=>{t?.destroyed||t?.map.remove(s),s.destroy()}),c(()=>this.numPendingFeatures>0,e=>this._sketchViewModel.updateOnGraphicClick=e,h)])}_hasValidationErrors(e){return!(!e||this.data.isSubmittable(e)&&!this._featureFormViewModel.validateContingencyConstraints(e.attributes,{includeIncompleteViolations:!0})?.length)}async _processEdits(e,t){const{data:s,_featureFormViewModel:r}=this,{layerInfos:i,view:o}=s.viewModel;r.editType="INSERT",r.map=o?.map,r.spatialReference=o?.spatialReference;const{templateExecutorInfo:a}=s;if(!a){const t=e.clone();return t.geometry=null,await this._addAndInitializeEdits(e,t),e}const n=this.sketchViewModel.layer;n.remove(e);const{executor:p}=a,l=p(e.geometry,"completion"),u=m(l)?await l:l;a.completionResults.push(u),K(u.relationships),r.editType="INSERT",r.map=o?.map,r.spatialReference=o?.spatialReference,u.primary&&s.creationInfo?.attributeOverrides&&(u.primary.graphic.attributes={...u.primary.graphic.attributes,...s.creationInfo.attributeOverrides});for(const e of u.edits){let s=null;if(e.addFeatures)for(const r of e.addFeatures){const e=r.clone();e.geometry=null,null!=r.geometry&&(r.symbol=await M(r,t),n.add(r)),r.sourceLayer!==s?.layer&&(s=z(i,r.sourceLayer));const o=!!u.associationGraphics?.has(r);await this._addAndInitializeEdits(r,e,s,o)}}return r.feature=null,await j(()=>!r.updating),u.edits.reduce((e,t)=>e+(t.addFeatures?.length??0),0)>1?null:u.primary?.graphic}async _addAndInitializeEdits(e,t,s,r=!1){const{data:i,_featureFormViewModel:o}=this,{layerInfos:a}=i.viewModel,n=i.addPendingFeature(e,t,{isAssociation:r});s??=z(a,e.sourceLayer),o.feature=e,o.formTemplate=s?.formTemplate,await j(()=>!o.updating),n.submittable=o.submittable}async _setUpCreatingFeaturesStep(){if(this.hasHandles(ne))return;const{data:e,sketchViewModel:o}=this,{creationInfo:a,viewModel:p}=e,{attachmentsViewModel:l,view:m}=p;if(!m||!a?.layer)throw new s("missing-parameters","CreateFeaturesWorkflow requires a view and creationInfo.");const{initialFeature:u,layer:d}=a,j=[],y=[];this._featureFormHandle=n(this._featureFormHandle),this._visualVariableAttributes={rotation:null,size:null},e.editorItem=p.findEditorItemForLayer(a.layer),a.template&&(null==e.fullTemplate&&await this._initializeFullTemplateAndExecutorInfo(e),y.push(r(()=>{e.templateExecutorInfo&&(e.templateExecutorInfo.completionResults=[])}))),o.allowDeleteKey=!e.isSharedTemplateWorkflow,J(l),j.push(c(()=>l.mode,e=>{switch(e){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}));const f=A(m);j.push(f);const g=I(a.layer),{template:k}=a,w=!k||F(k)||b(k)&&"feature"===k.type,v=g&&w;try{if(v){const s=u??new t({attributes:Q(e.fullTemplate,a.attributeOverrides),sourceLayer:d}),r=await this._processEdits(s);r&&await this._startUpdating({feature:r})}else j.push(ie._configureSketchViewModel(this)),u?(re(a)&&a.geometryToPlace&&(u.attributes=Q(e.fullTemplate,a.attributeOverrides)),o.layer.add(u),await this._startUpdating({feature:u})):await this._startCreating()}finally{f.remove()}const S=r(()=>{for(const t of e.pendingFeatures)o.layer.remove(t),e.removePendingFeature(t)}),M=c(()=>m?.timeZone,e=>{this._featureFormViewModel.timeZone=e,this.data.timeZone=e},h),_=r(()=>{re(a)&&p.cancelWorkflow({warnIfNoWorkflow:!1})});this._featureFormHandle&&j.push(this._featureFormHandle),this.addHandles(j,this._handleKeys.beforeCommit),this.addHandles(y,this._handleKeys.afterCommit),this.addHandles([r(()=>l.fileInfos.removeAll()),i(j),i(y),_,S,M],ne)}async _waitForActiveToolCleared(){const e=this.data.viewModel.view;if(null==e?.activeTool)return;const t=new AbortController;this.addHandles(o(t),pe),await j(()=>null==e?.activeTool,t.signal),t.abort()}};e([g()],me.prototype,"createFeatureState",void 0),e([g()],me.prototype,"data",void 0),e([g({constructOnly:!0})],me.prototype,"isNested",void 0),e([g()],me.prototype,"featureFormViewModel",null),e([g()],me.prototype,"hasPendingEdits",null),e([g()],me.prototype,"hasPreviousStep",null),e([g()],me.prototype,"_getDrawMeshHelpMessage",void 0),e([g()],me.prototype,"helpMessage",null),e([g()],me.prototype,"layer",null),e([g()],me.prototype,"parent",null),e([g()],me.prototype,"parentLayer",null),e([g()],me.prototype,"keyboardCancellationEnabled",null),e([g()],me.prototype,"reliesOnOwnerAdminPrivileges",null),e([g()],me.prototype,"shouldShowAttachments",null),e([g()],me.prototype,"shouldAllowAttachmentEditing",null),e([g()],me.prototype,"sketchViewModel",null),e([g()],me.prototype,"availableCreateTools",null),e([g()],me.prototype,"_attachmentsActive",null),me=ie=e([k("esri.widgets.Editor.CreateFeaturesWorkflow")],me);const ue=me;export{ue as default,re as i};
