/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{i as s,u as e}from"../../core/lang.js";import r from"../../core/Collection.js";import i from"../../core/Error.js";import{L as o}from"../../chunks/Logger.js";import{d as p}from"../../chunks/maybe.js";import{whenOnce as n,watch as a}from"../../core/reactiveUtils.js";import{property as m}from"../../core/accessorSupport/decorators/property.js";import{subclass as l}from"../../core/accessorSupport/decorators/subclass.js";import{F as u}from"../../chunks/layerUtils.js";import{k as c}from"../../chunks/elevationInfoUtils.js";import j from"../BatchAttributeForm/BatchAttributeFormViewModel.js";import h from"./UpdateFeaturesWorkflowData.js";import d from"./Workflow.js";import{x as y,u as k,t as f,y as g,v as b,z as w,A as S,B as v,C as U}from"../../chunks/workflowUtils.js";import F from"../../core/Accessor.js";import{a as I}from"../../chunks/handleUtils.js";import{debounce as M}from"../../core/promiseUtils.js";import{U as L}from"../../chunks/UpdatingHandles.js";import C from"../../layers/GraphicsLayer.js";import{S as V}from"../../chunks/SketchOptions.js";import _ from"../Sketch/SketchViewModel.js";import"../../chunks/watch.js";import"../../chunks/ObjectPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/SetUtils.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/Lifecycle.js";import"../../chunks/tracking.js";import"../../chunks/SimpleTrackingTarget.js";import"../../core/Evented.js";import"../../core/Handles.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../chunks/Warning.js";import"../../chunks/ObservableBase.js";import"../../chunks/events.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/jsonUtils.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../request.js";import"../../chunks/persistableUrlUtils.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/asyncUtils.js";import"../../chunks/ReactiveMap.js";import"../../geometry/SpatialReference.js";import"../../core/JSONSupport.js";import"../../chunks/writer.js";import"../../chunks/constants.js";import"../../intl.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/datetime.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../chunks/formUtils2.js";import"../../chunks/formUtils.js";import"../../form/elements/AttachmentElement.js";import"../../form/elements/Element.js";import"../../form/elements/inputs/attachments/AttachmentInput.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../chunks/Input.js";import"../../core/Clonable.js";import"../../form/elements/inputs/attachments/AudioInput.js";import"../../chunks/utils2.js";import"../../form/elements/inputs/attachments/DocumentInput.js";import"../../form/elements/inputs/attachments/ImageInput.js";import"../../form/elements/inputs/attachments/SignatureInput.js";import"../../form/elements/inputs/attachments/VideoInput.js";import"../../form/elements/FieldElement.js";import"../../form/elements/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../chunks/enumeration.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/elements/RelationshipElement.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../form/elements/TextElement.js";import"../../form/elements/UtilityNetworkAssociationsElement.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../chunks/guards.js";import"../../chunks/dateUtils.js";import"../../chunks/mathUtils.js";import"../../arcade.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/support/AttachmentsOrderByInfo.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../geometry/support/jsonUtils.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/Point.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/createFeatureId.js";import"../../chunks/typeUtils2.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils3.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils4.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/vec3f64.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/DoubleArray.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../chunks/lineMarkers.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/Font.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/TimeOnly.js";import"../../chunks/enum.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/arcadeEnvironment.js";import"../../chunks/ImmutableArray.js";import"../../layers/FeatureLayer.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/layerContainerType.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../graphic/FeatureGraphicOrigin.js";import"../../graphic/GraphicOrigin.js";import"../../chunks/isFeatureGraphicOrigin.js";import"../../layers/Layer.js";import"../../time/TimeExtent.js";import"../../chunks/timeUtils.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../chunks/editsZScale.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils2.js";import"../../chunks/parser.js";import"../../chunks/utils5.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../layers/mixins/DisplayFilteredLayer.js";import"../../layers/support/DisplayFilterInfo.js";import"../../chunks/scaleUtils.js";import"../../layers/support/DisplayFilter.js";import"../../chunks/uuid.js";import"../../chunks/displayFilterUtils.js";import"../../chunks/EditBusLayer.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/ElevationInfo.js";import"../../symbols/support/FeatureExpressionInfo.js";import"../../tables/AttributeTableTemplate.js";import"../../tables/elements/AttributeTableGroupElement.js";import"../../tables/elements/AttributeTableAttachmentElement.js";import"../../tables/elements/AttributeTableElement.js";import"../../tables/elements/AttributeTableFieldElement.js";import"../../tables/elements/AttributeTableRelationshipElement.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/featureQueryAll.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/commonProperties2.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../chunks/RendererLegendOptions.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/NormalizationBinParametersMixin.js";import"../../rest/support/RelationshipQuery.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../chunks/multiLayerServiceUtils.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../chunks/infoFor3D.js";import"../../layers/support/Subtype.js";import"../../chunks/portalItemUtils.js";import"../../chunks/projectionUtils.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/typeUtils3.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/support/ClassBreakInfo.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/DictionaryScriptEvaluator.js";import"../../chunks/Version.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/ArcadeExpression.js";import"../../chunks/utils6.js";import"../../chunks/defaultCIMValues.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../renderers/PieChartRenderer.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../layers/support/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../layers/support/TimeInfo.js";import"../../time/TimeInterval.js";import"../../layers/mixins/TrackableLayer.js";import"../../layers/support/TrackInfo.js";import"../../layers/support/TrackPartInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/TitleCreator.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/inputUtils.js";import"../BatchAttributeForm/inputs/BatchFormInputs.js";import"../BatchAttributeForm/inputs/FieldInput.js";import"../../chunks/utils7.js";import"../../chunks/basemapUtils.js";import"../../chunks/basemapDefinitions.js";import"../BatchAttributeForm/inputs/EditableInput.js";import"../BatchAttributeForm/inputs/InputBase.js";import"../BatchAttributeForm/inputs/GroupInput.js";import"../../chunks/LayerContingentValuesCache.js";import"../../chunks/featureFormUtils.js";import"./Edits.js";import"../../chunks/templateUtils2.js";import"../../editing/sharedTemplates/SharedTemplateMetadata.js";import"../../chunks/utils12.js";import"../../rest/featureService/FeatureService.js";import"../../chunks/applyEditsUtils.js";import"../../geometry/support/MeshTransform.js";import"../../chunks/mat4f64.js";import"../../chunks/quat.js";import"../../chunks/vec3.js";import"../../chunks/quatf64.js";import"../../chunks/axisAngleDegrees.js";import"../../chunks/editingSupport.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils9.js";import"../../chunks/utils10.js";import"../../chunks/SharedTemplateProvider.js";import"../../chunks/utils11.js";import"../../chunks/Version2.js";import"../../chunks/GraphicsCollection.js";import"../../chunks/drapedUtils.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/gfxUtils.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/renderUtils.js";import"../../chunks/colorUtils2.js";import"../../chunks/projector.js";import"../../chunks/sanitizerUtils.js";import"../../chunks/svgUtils.js";import"../../chunks/mat2df32.js";import"../../chunks/mat2d.js";import"../../chunks/widgetUtils.js";import"../../chunks/jsxFactory.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/utils8.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/GraphicState.js";import"../../chunks/DrawingMode.js";import"../../chunks/hitTestSelectUtils.js";import"../../chunks/sketchUtils.js";import"../../views/interactive/sketch/SketchLabelOptions.js";import"../../views/interactive/sketch/SketchTooltipOptions.js";import"../../chunks/SketchTooltipVisibleElements.js";import"../../views/interactive/sketch/SketchValueOptions.js";import"../../chunks/isSupportedObject.js";import"../../chunks/layerUtils2.js";import"../../chunks/editableLayers.js";import"../../chunks/InputManager.js";import"../../chunks/signal.js";import"../../chunks/keybindings.js";import"../../chunks/SnappingManager.js";import"../../chunks/normalizedPoint.js";import"../../chunks/dehydratedPoint.js";import"../../chunks/Settings.js";import"../../views/interactive/snapping/SnappingOptions.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import"../../chunks/constraints.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/plane.js";import"../../chunks/vector.js";import"../../chunks/mat3f64.js";import"../../chunks/mathUtils2.js";import"../../chunks/sphere.js";import"../../chunks/ray.js";import"../../chunks/mat3.js";import"../../chunks/geometry2dUtils.js";import"../../chunks/RightAngleSnappingHint.js";import"../../chunks/geodesicLengthMeasurementUtils.js";import"../../chunks/quantityUtils.js";import"../../chunks/projectVectorToVector.js";import"../../chunks/projectPointToVector.js";import"../../chunks/spatialReferenceEllipsoidUtils.js";import"../../geometry/operators/geodeticLengthOperator.js";import"../../chunks/geodeticCurveType.js";import"../../chunks/geodesicMeasurementUtils.js";import"../../chunks/automaticAreaMeasurementUtils.js";import"../../chunks/geodesicAreaMeasurementUtils.js";import"../../chunks/earcut.js";import"../../chunks/triangle.js";import"../../chunks/lineSegment.js";import"../../chunks/automaticLengthMeasurementUtils.js";import"../../chunks/HighlightDefaults.js";import"../../chunks/screenUtils2.js";const A=Symbol();let E=class extends F{constructor(t){super(t),this.features=[],this.sketchOptions=new V,this.snappingManager=null,this.sourceLayer=null,this.view=null,this.viewModel=null,this._sketchGraphics=new Map,this._sketchLayer=null,this._updatingHandles=new L,this._visualVariableAttributes=new Map,this._visualVariablesForLayer=null,this._webStyleCache=new Map}async initialize(){this._visualVariablesForLayer=y(this.sourceLayer),this._initializeSketchGraphics(),this._initializeSketchLayer(),await this._updatingHandles.addPromise(this._initializeSketchViewModel())}destroy(){const{_sketchLayer:t,view:s}=this;s?.destroyed||s?.map.remove(t),t.destroy(),this.viewModel.destroy()}get updating(){return this._updatingHandles.updating}async enter(){throw new Error("enter() not implemented")}async exit(){throw new Error("exit() not implemented")}notifyAttributesChanged({features:t,fieldName:s}){const e=this._webStyleCache,r=this.view.scale,i=this._updatingHandles;for(const o of t){const t=this._sketchGraphics.get(o),p=o.getAttribute(s);if(!t||t.getAttribute(s)===p)continue;t.setAttribute(s,p);const n=this._visualVariableAttributes.get(o);null==n?.size||n.size.isUpdatingInteractively||n.size.field!==s||n.size.setInitialValue(p),null==n?.rotation||n.rotation.isUpdatingInteractively||n.rotation.field!==s||n.rotation.setInitialValue(p),i.addPromise(k(t,e,r))}}async startUpdatingFeatures(t,e,r){const{_sketchGraphics:i,sourceLayer:o,view:p,viewModel:a,_webStyleCache:m}=this,l=t.map(t=>i.get(t)).filter(s),u={};this.removeHandles(A),a.complete();let c=null;if(1===t.length){const s=t[0],e=this._visualVariableAttributes.get(s);(e?.rotation||e?.size)&&(await f({sketchViewModel:a,graphic:l[0],sourceLayer:o,visualVariables:e,webStyleCache:m}),"point"===o.geometryType&&(u.enableRotation=null!=e.rotation,u.enableScaling=null!=e.size,c=async t=>{const i=t.graphics[0];b(p,i,t,e)&&(r?.([{feature:s,attributes:i.attributes}],t),this._updatingHandles.addPromise(k(i,m,"2d"===p.type?p.scale:null)))}))}else u.tool="move";const j=()=>a.update(l,u),h=a.on("update",r=>{if("complete"===r.state){if(null===p.activeTool)return void j();const t=new AbortController,s=I(t);return this.addHandles(s,A),void this._updatingHandles.addPromise(n(()=>null===p.activeTool,t.signal).then(async()=>{t.signal.aborted||(t.abort(),await j())}))}const o=t.map(t=>{const s=i.get(t);return s?{feature:t,geometry:s.geometry}:null}).filter(s);e(o,r),c?.(r)});await j(),this.addHandles(h,A),a.addHandles(h)}_initializeSketchGraphics(){const{features:t,_sketchGraphics:s,sourceLayer:e,_visualVariableAttributes:r}=this,i=this._visualVariablesForLayer,o=i.rotation?.field,p=i.size?.field,n={rotation:o?e.getField(o):null,size:p?e.getField(p):null},a=!(!n.rotation&&!n.size);for(const e of t)s.set(e,e.clone()),a&&r.set(e,P(i,n))}_initializeSketchLayer(){const{view:t}=this,s=new C({elevationInfo:this.sourceLayer.elevationInfo,internal:!0,listMode:"hide",title:"SketchController layer"});this._sketchLayer=s,t.map.add(s),this._updatingHandles.addPromise(t.whenLayerView(s))}async _initializeSketchViewModel(){const{_sketchGraphics:t,view:s,_webStyleCache:e}=this,r=Array.from(t.entries()),i=new _({allowDeleteKey:!1,defaultUpdateOptions:{multipleSelectionEnabled:!1},layer:this._sketchLayer,sketchOptions:this.sketchOptions,snappingManager:this.snappingManager,updateOnGraphicClick:!1,view:this.view});this.viewModel=i;const o=M(t=>Promise.all(r.map(([,s])=>k(s,e,t))));await o("2d"===s.type?s.scale:null),"2d"===s.type&&this.addHandles(a(()=>s.scale,t=>o(t))),this.addHandles(await Promise.all(r.map(([t,s])=>g(i,t,s))))}};function P({rotation:t,size:s},e){return{rotation:t?S(t,e.rotation):null,size:s?w(s,e.size):null}}var T;t([m()],E.prototype,"features",void 0),t([m()],E.prototype,"sketchOptions",void 0),t([m()],E.prototype,"snappingManager",void 0),t([m()],E.prototype,"sourceLayer",void 0),t([m()],E.prototype,"updating",null),t([m()],E.prototype,"view",void 0),t([m()],E.prototype,"viewModel",void 0),t([m()],E.prototype,"_sketchGraphics",void 0),t([m()],E.prototype,"_sketchLayer",void 0),t([m()],E.prototype,"_visualVariablesForLayer",void 0),E=t([l("esri.widgets.Editor.support.SketchController")],E);const x=()=>o.getLogger("esri.widgets.Editor.UpdateFeaturesWorkflow");let D=T=class extends d{constructor(t){super(t),this.type="update-features",this._formViewModel=null,this._sketchController=null}async initialize(){this._initializeFormViewModel();try{await this._updatingHandles.addPromise((async()=>{const{fullFeatures:t}=await this.data.when();this._formViewModel.features=new r(t),await this._initializeVisuals(t)})())}catch(t){this.cancel({force:!0,error:new i("update-features-workflow:initialize","Failed to initialize the workflow data.",t)})}}destroy(){this._sketchController=p(this._sketchController),this._formViewModel.destroy()}get features(){return this.data.features}get formViewModel(){return this._formViewModel}get hasPendingEdits(){const{data:t}=this;return t.features.some(s=>!!t.getPendingEditsForFeature(s)?.modified)}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get selectedFeature(){return this.data.selectedFeature}get sketchViewModel(){return this._sketchController?.viewModel}get updating(){return this._updatingHandles.updating||this._formViewModel.updating||!!this._sketchController?.updating}async commit(){const{data:t,_formViewModel:s}=this;for(const e of t.fullFeatures)B(t.getPendingEditsForFeature(e),s.getValues(e));await super.commit()}static create(t){const{applyEdits:r,applyEditsFeatureService:i,...o}=t,p=e(t.features.map(t=>t.sourceLayer??t.layer)).map(s=>t.viewModel.editorItems.find(t=>t.layer===s)).filter(s),n=new T({data:new h({...o,editorItems:p}),onCommit:z(t.applyEdits)});return n._set("steps",[{id:"editing-features",async setUp(){},async tearDown(){}}]),n}async deleteAndCommit(){return this.data.stageDelete(),this.commit()}enter(){throw new Error("Method not implemented.")}exit(t){throw new Error("Method not implemented.")}async reset(){}async save(){const{formViewModel:t}=this;t.submit(),t.valid&&await super.save()}async start(){await super.start(),await n(()=>!this.updating)}_initializeFormViewModel(){const{data:t}=this,s=t.viewModel.view,e=t.getEditorItemForLayer(O(t)),r=new j({editType:"UPDATE",map:s?.map,readOnly:!1===e?.capabilities.update.attributes,spatialReference:s?.spatialReference,timeZone:t.timeZone});this._formViewModel=r,this.addHandles(r.on("value-change",s=>{for(const e of s.features)t.getPendingEditsForFeature(e)?.setAttribute(s.fieldName,s.value);this._sketchController?.notifyAttributesChanged(s)}))}async _initializeHighlights(t,s,e){const r=await v(e,s);this.addHandles(r.highlight(t))}async _initializeSketchController(t,s,e){const r=new E({sourceLayer:s,view:e,features:t});this._sketchController=r,await n(()=>!r.updating);const{data:i}=this;await r.startUpdatingFeatures(t,t=>{const s=[];for(const{feature:e,geometry:r}of t)i.getPendingEditsForFeature(e)?.updateGeometry(r),s.push(e);this._formViewModel.notifyGeometriesChanged(s)},()=>{x().warnOnce("editor:batch-update-visual-variables","UpdateFeaturesWorkflow does not currently support modifying visual variables through the scale and rotate tools.")})}async _initializeVisuals(t){const{data:s}=this,{view:e}=s.viewModel;if(!e)return;const r=O(s);if(u(r))return;const i=s.getEditorItemForLayer(r);return!i?.capabilities.update.geometry||"3d"===e?.type&&c(r.elevationInfo)?this._initializeHighlights(t,r,e):this._initializeSketchController(t,r,e)}};t([m()],D.prototype,"features",null),t([m()],D.prototype,"formViewModel",null),t([m()],D.prototype,"hasPendingEdits",null),t([m()],D.prototype,"parent",null),t([m()],D.prototype,"parentLayer",null),t([m()],D.prototype,"selectedFeature",null),t([m()],D.prototype,"sketchViewModel",null),t([m()],D.prototype,"type",void 0),t([m()],D.prototype,"updating",null),t([m()],D.prototype,"_formViewModel",void 0),t([m()],D.prototype,"_sketchController",void 0),D=T=t([l("esri.widgets.Editor.UpdateFeaturesWorkflow")],D);const R=D;function z(t){return async s=>{const e=O(s),r=[],i=[];for(const t of s.fullFeatures){const e=s.getPendingEditsForFeature(t),o=e?.stagedForDelete;if(!e?.modified&&!o)continue;const p=t.clone();if(!e?.attributesModified||o){const s=t.sourceLayer;if(!s){x().warn("Feature has no sourceLayer. It will not be included in any applyEdits payload.");continue}const e=s.objectIdField;if(p.attributes={[e]:t.getAttribute(e)},"scene"===s.type&&null!=s.infoFor3D){const e=s.associatedLayer?.globalIdField;null!=e&&p.setAttribute(e,t.getAttribute(e))}}e?.geometryModified&&!o||(p.geometry=null),o?i.push(p):r.push(p)}if(r.length+i.length===0)return void x().warn("No edits to apply. Workflow will finish without sending an applyEdits request.");const o={updateFeatures:r.length>0?r:void 0,deleteFeatures:i.length>0?i:void 0};await t(e,o)}}function O(t){if(t.layers.length>1)throw U();return t.layers[0]}function B(t,s){if(!t||!t.feature)return;const{attributes:e}=t.feature;Object.keys(s).some(t=>s[t]!==e[t])&&t.updateAttributes(s)}export{R as default};
