/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{i as t,I as s,a as r,u as i}from"../../core/lang.js";import{c as o}from"../../chunks/asyncUtils.js";import a from"../../core/Collection.js";import n,{b as l}from"../../core/Accessor.js";import p from"../../core/Error.js";import{EventedAccessor as c}from"../../core/Evented.js";import{m as u}from"../../chunks/handleUtils.js";import{L as m}from"../../chunks/Logger.js";import{r as h,a as d,d as y}from"../../chunks/maybe.js";import{ignoreAbortErrors as f,debounce as j,whenOrTimeout as g,throwIfAborted as k,createResolver as w}from"../../core/promiseUtils.js";import{watch as v,on as b,whenOnce as I,when as _,syncAndInitial as S,initial as M,sync as F}from"../../core/reactiveUtils.js";import{property as C}from"../../core/accessorSupport/decorators/property.js";import{subclass as L}from"../../core/accessorSupport/decorators/subclass.js";import{U as T}from"../../chunks/UpdatingHandles.js";import{j as U}from"../../chunks/templateUtils2.js";import E from"../../layers/GraphicsLayer.js";import{i as V}from"../../chunks/editableLayers.js";import{a as A,b as W,i as x,h as O}from"../../chunks/layerUtils.js";import{p as P}from"../../core/urlUtils.js";import{S as R}from"../../chunks/SelectionManager.js";import{S as D}from"../../chunks/SketchOptions.js";import{S as H}from"../../chunks/SnappingManager.js";import B from"../../views/interactive/snapping/SnappingOptions.js";import{i as G}from"../../chunks/selectionUtils.js";import q from"../Attachments/AttachmentsViewModel.js";import N from"./CreateFeaturesWorkflow.js";import z from"./UpdateFeaturesWorkflow.js";import Q from"./UpdateWorkflow.js";import{I as Z,J as $,G as J,K,L as X,C as Y,B as ee}from"../../chunks/workflowUtils.js";import te from"./support/EditorItem.js";import se,{m as re}from"../FeatureTemplates/FeatureTemplatesViewModel.js";import ie from"../Sketch/SketchViewModel.js";import{S as oe}from"../../chunks/SpinnerViewModel.js";import{g as ae}from"../../chunks/goToUtils.js";import{g as ne}from"../../chunks/iconUtils.js";import{R as le}from"../../chunks/ReactiveMap.js";import{f as pe}from"../../chunks/symbolPreviewUtils.js";import{getSuggestedQueryOutFields as ce}from"../support/Selector2D/selectorUtils.js";import ue from"../support/SelectionToolbar/SelectionToolbarViewModel.js";import"../../chunks/watch.js";import"../../chunks/ObjectPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/events.js";import"../../chunks/SetUtils.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/Lifecycle.js";import"../../chunks/tracking.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/ObservableBase.js";import"../../chunks/jsonUtils.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/Warning.js";import"../../request.js";import"../../kernel.js";import"../../chunks/persistableUrlUtils.js";import"../../editing/sharedTemplates/SharedTemplateMetadata.js";import"../../core/JSONSupport.js";import"../../chunks/reader.js";import"../../chunks/jsonMap.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/Portal.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/locale.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../chunks/utils12.js";import"../../rest/featureService/FeatureService.js";import"../../core/Identifiable.js";import"../../chunks/applyEditsUtils.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../chunks/guards.js";import"../../chunks/datetime.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/support/AttachmentsOrderByInfo.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/constants.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/mathUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../geometry/support/jsonUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/createFeatureId.js";import"../../chunks/typeUtils2.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils3.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils4.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/vec3f64.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/DoubleArray.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../chunks/lineMarkers.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/Font.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/projectionUtils.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../geometry/support/MeshTransform.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../chunks/mat4f64.js";import"../../chunks/quat.js";import"../../chunks/vec3.js";import"../../chunks/vec4.js";import"../../chunks/quatf64.js";import"../../chunks/axisAngleDegrees.js";import"../../chunks/editingSupport.js";import"../../chunks/uuid.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils9.js";import"../../chunks/utils10.js";import"../../chunks/EditBusLayer.js";import"../../chunks/infoFor3D.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/featureLayerUtils.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../chunks/featureQueryAll.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../time/TimeExtent.js";import"../../chunks/timeUtils.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/commonProperties2.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../chunks/RendererLegendOptions.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/NormalizationBinParametersMixin.js";import"../../rest/support/RelationshipQuery.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/portalItemUtils.js";import"../../chunks/editsZScale.js";import"../../chunks/GraphicsCollection.js";import"../../layers/Layer.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/layerContainerType.js";import"../../chunks/jsonUtils2.js";import"../../chunks/parser.js";import"../../chunks/utils5.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../symbols/support/ElevationInfo.js";import"../../symbols/support/FeatureExpressionInfo.js";import"../../chunks/unitConversionUtils.js";import"../../views/interactive/sketch/SketchLabelOptions.js";import"../../views/interactive/sketch/SketchTooltipOptions.js";import"../../chunks/SketchTooltipVisibleElements.js";import"../../views/interactive/sketch/SketchValueOptions.js";import"../../chunks/elevationInfoUtils.js";import"../../chunks/normalizedPoint.js";import"../../chunks/dehydratedPoint.js";import"../../chunks/Settings.js";import"../../chunks/constraints.js";import"../../chunks/InputManager.js";import"../../chunks/Queue.js";import"../../chunks/signal.js";import"../../chunks/keybindings.js";import"../../chunks/utils11.js";import"../../chunks/Version2.js";import"../../chunks/Version.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../chunks/vec4f64.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/plane.js";import"../../chunks/vector.js";import"../../chunks/mat3f64.js";import"../../chunks/mathUtils2.js";import"../../chunks/sphere.js";import"../../chunks/ray.js";import"../../chunks/mat3.js";import"../../chunks/geometry2dUtils.js";import"../../chunks/RightAngleSnappingHint.js";import"../../chunks/geodesicLengthMeasurementUtils.js";import"../../chunks/quantityUtils.js";import"../../chunks/projectVectorToVector.js";import"../../chunks/projectPointToVector.js";import"../../chunks/spatialReferenceEllipsoidUtils.js";import"../../geometry/operators/geodeticLengthOperator.js";import"../../chunks/geodeticCurveType.js";import"../../chunks/geodesicMeasurementUtils.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import"../../rest/query/support/AttachmentInfo.js";import"../../chunks/featureUtils.js";import"../../chunks/number.js";import"../../chunks/utils7.js";import"../../chunks/basemapUtils.js";import"../../chunks/basemapDefinitions.js";import"../../chunks/messages.js";import"../../chunks/timeZoneUtils.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/gfxUtils.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils6.js";import"../../chunks/defaultCIMValues.js";import"../../chunks/renderUtils.js";import"../../chunks/colorUtils2.js";import"../../chunks/projector.js";import"../../chunks/sanitizerUtils.js";import"../../chunks/svgUtils.js";import"../../chunks/mat2df32.js";import"../../chunks/mat2d.js";import"../../chunks/widgetUtils.js";import"../../chunks/jsxFactory.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/utils8.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/helpMessageUtils.js";import"../../views/draw/support/HighlightHelper.js";import"../../chunks/layerUtils2.js";import"../../chunks/HighlightDefaults.js";import"../../chunks/layerViewUtils.js";import"./CreateFeaturesWorkflowData.js";import"./Edits.js";import"../../chunks/formUtils2.js";import"../../chunks/formUtils.js";import"../../form/elements/AttachmentElement.js";import"../../form/elements/Element.js";import"../../form/elements/inputs/attachments/AttachmentInput.js";import"../../chunks/Input.js";import"../../form/elements/inputs/attachments/AudioInput.js";import"../../chunks/utils2.js";import"../../form/elements/inputs/attachments/DocumentInput.js";import"../../form/elements/inputs/attachments/ImageInput.js";import"../../form/elements/inputs/attachments/SignatureInput.js";import"../../form/elements/inputs/attachments/VideoInput.js";import"../../form/elements/FieldElement.js";import"../../form/elements/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../form/elements/RelationshipElement.js";import"../../form/elements/TextElement.js";import"../../form/elements/UtilityNetworkAssociationsElement.js";import"../../chunks/dateUtils.js";import"../../intl.js";import"../../chunks/substitute.js";import"./Workflow.js";import"../FeatureForm/FeatureFormViewModel.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../chunks/LayerContingentValuesCache.js";import"../../layers/support/Subtype.js";import"../../chunks/featureFormUtils.js";import"../FeatureForm/FieldInput.js";import"../FeatureForm/EditableInput.js";import"../FeatureForm/InputBase.js";import"../FeatureForm/GroupInput.js";import"../FeatureForm/RelationshipInput.js";import"../../chunks/FeatureRelationshipViewModel.js";import"../FeatureForm/TextElementInput.js";import"../../chunks/ReactiveSet.js";import"../../arcade.js";import"../../chunks/TimeOnly.js";import"../../chunks/enum.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/arcadeEnvironment.js";import"../../chunks/ImmutableArray.js";import"../../layers/FeatureLayer.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../graphic/FeatureGraphicOrigin.js";import"../../graphic/GraphicOrigin.js";import"../../chunks/isFeatureGraphicOrigin.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../core/workers/RemoteClient.js";import"../../chunks/queryZScale.js";import"../../rest/support/FeatureSet.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../layers/mixins/DisplayFilteredLayer.js";import"../../layers/support/DisplayFilterInfo.js";import"../../chunks/scaleUtils.js";import"../../layers/support/DisplayFilter.js";import"../../chunks/displayFilterUtils.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties.js";import"../../tables/AttributeTableTemplate.js";import"../../tables/elements/AttributeTableGroupElement.js";import"../../tables/elements/AttributeTableAttachmentElement.js";import"../../tables/elements/AttributeTableElement.js";import"../../tables/elements/AttributeTableFieldElement.js";import"../../tables/elements/AttributeTableRelationshipElement.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../chunks/multiLayerServiceUtils.js";import"../../layers/support/Relationship.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/typeUtils3.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/support/ClassBreakInfo.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/DictionaryScriptEvaluator.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/ArcadeExpression.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../renderers/PieChartRenderer.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../layers/support/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../layers/support/TimeInfo.js";import"../../time/TimeInterval.js";import"../../layers/mixins/TrackableLayer.js";import"../../layers/support/TrackInfo.js";import"../../layers/support/TrackPartInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/TitleCreator.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/SharedTemplateProvider.js";import"../../chunks/drapedUtils.js";import"../../chunks/GraphicState.js";import"../../chunks/DrawingMode.js";import"../../chunks/hitTestSelectUtils.js";import"../../chunks/sketchUtils.js";import"../../chunks/isSupportedObject.js";import"../../chunks/automaticAreaMeasurementUtils.js";import"../../chunks/geodesicAreaMeasurementUtils.js";import"../../chunks/earcut.js";import"../../chunks/triangle.js";import"../../chunks/lineSegment.js";import"../../chunks/automaticLengthMeasurementUtils.js";import"../../chunks/screenUtils2.js";import"../BatchAttributeForm/BatchAttributeFormViewModel.js";import"../../chunks/inputUtils.js";import"../BatchAttributeForm/inputs/BatchFormInputs.js";import"../BatchAttributeForm/inputs/FieldInput.js";import"../BatchAttributeForm/inputs/EditableInput.js";import"../BatchAttributeForm/inputs/InputBase.js";import"../BatchAttributeForm/inputs/GroupInput.js";import"./UpdateFeaturesWorkflowData.js";import"../../rest/featureService/utils.js";import"./UpdateWorkflowData.js";import"../FeatureTemplates/TemplateItem.js";import"../FeatureTemplates/TemplateItemGroup.js";import"../../chunks/AnchorElementViewModel.js";import"../../chunks/SelectionOperation.js";function me(e){return e.flatMap(e=>ye(e)?e.featureItems:de(e)?e.items.flatMap(e=>me([e])):e).filter(t)}function he(e){let t=0;for(const s of e)ye(s)&&(t+=s.total),de(s)&&(t+=he(s.items));return t}function de(e){return null!=e&&"object"==typeof e&&"items"in e}function ye(e){return null!=e&&"object"==typeof e&&"featureItems"in e}function fe(e){return null!=e&&"object"==typeof e&&"graphic"in e}let je=class extends n{constructor(e){super(e),this.layer=null,this.viewModel=null}get iconName(){return ne(this.layer)}get key(){return this.layer.id}get layerView(){return this.viewModel.layerViewMap.get(this.layer.id)}get title(){return this.layer.title}get view(){return this.viewModel.view}};e([C()],je.prototype,"iconName",null),e([C()],je.prototype,"key",null),e([C()],je.prototype,"layer",void 0),e([C()],je.prototype,"layerView",null),e([C()],je.prototype,"title",null),e([C()],je.prototype,"view",null),e([C()],je.prototype,"viewModel",void 0),je=e([L("esri.widgets.support.SelectionList.ItemBase")],je);const ge=je;let ke=class extends ge{constructor(e){super(e),this.items=[],this.layer=null}get layers(){const{layer:e}=this;return"group"===e.type?e.layers.toArray().reverse():"subtype-group"===e.type?e.sublayers.toArray().reverse():[]}get maxVisibleFeatureCountExceeded(){return this.items.some(e=>e.maxVisibleFeatureCountExceeded)}get total(){return this.items.reduce((e,t)=>e+t.total,0)}get visible(){return this.items.some(e=>e.visible)}get visibleTotal(){return this.items.reduce((e,t)=>e+t.visibleTotal,0)}reset(){this.items.forEach(e=>e.reset())}async sync({controller:e,promises:t}){const{layers:s,viewModel:r}=this;this.items=r.layersToItems({controller:e,groupLayerItem:this,layers:s,promises:t})}};e([C()],ke.prototype,"items",void 0),e([C()],ke.prototype,"layer",void 0),e([C()],ke.prototype,"layers",null),e([C()],ke.prototype,"maxVisibleFeatureCountExceeded",null),e([C()],ke.prototype,"total",null),e([C()],ke.prototype,"visible",null),e([C()],ke.prototype,"visibleTotal",null),ke=e([L("esri.widgets.support.SelectionList.GroupLayerItem")],ke);const we=ke;let ve=class extends ge{constructor(e){super(e),this._thumbnail=null,this.graphic=null,this.layer=null,this.layerItem=null,this.thumbnailSize=24}get _filterTerms(){return[this.title,this.layerItem.title,this.layerItem.groupLayerItem?.title].filter(t)}get key(){return`${this.layer.id}:${this.objectId??this.graphic.uid}`}get objectId(){return this.graphic.getObjectId()}get title(){const{objectId:e}=this;if(null!=e)return this.layerItem.featureTitleMap.get(e)||`${e}`}get thumbnail(){return this._thumbnail??void 0}get thumbnailKey(){return`${this.key}-${this.graphic.uid}`}get visible(){const{_filterTerms:e,viewModel:{activeLayerItem:t,filterText:s}}=this;if(t&&t.layer!==this.layer)return!1;if(null==s||""===s||!e.length)return!0;const r=new RegExp(s,"iu");return e.some(e=>r.test(e))}async fetchThumbnail(e){return this._thumbnail=await pe(this.graphic,this.layer,{maxSize:this.thumbnailSize,ariaLabel:e?.ariaLabel})}};e([C()],ve.prototype,"_filterTerms",null),e([C()],ve.prototype,"_thumbnail",void 0),e([C()],ve.prototype,"graphic",void 0),e([C()],ve.prototype,"key",null),e([C()],ve.prototype,"layer",void 0),e([C()],ve.prototype,"layerItem",void 0),e([C()],ve.prototype,"objectId",null),e([C()],ve.prototype,"title",null),e([C()],ve.prototype,"thumbnail",null),e([C()],ve.prototype,"thumbnailKey",null),e([C()],ve.prototype,"thumbnailSize",void 0),e([C()],ve.prototype,"visible",null),ve=e([L("esri.widgets.support.SelectionList.FeatureItem")],ve);const be=ve;let Ie=class extends ge{constructor(e){super(e),this._onChangeController=null,this.featureItems=[],this.featureTitleMap=new le,this.groupLayerItem=null,this.layer=null}get effectiveObjectIds(){return this.objectIds.slice(0,this.maxVisibleFeatureCountPerLayer)}get maxVisibleFeatureCountExceeded(){const{viewModel:e}=this;return this.objectIds.length>e.maxVisibleFeatureCountPerLayer&&this.visibleTotal===e.maxVisibleFeatureCountPerLayer}get maxVisibleFeatureCountPerLayer(){return this.viewModel.maxVisibleFeatureCountPerLayer}get objectIds(){return this.viewModel.effectiveSelectionManager?.getSelection(this.layer)??[]}get total(){return this.objectIds.length}get visible(){return this.featureItems.some(e=>e.visible)}get visibleTotal(){return s(this.featureItems,e=>e.visible)}cancel(){this._onChangeController?.abort()}reset(){this.featureItems.forEach(e=>e.destroy()),this.featureItems=[]}async sync({controller:e,promises:s}){this.cancel();const i=new Map(this.featureItems.map(e=>[e.objectId,e])),o=new Map,a=[],n=[];for(const e of this.effectiveObjectIds){const t=i.get(e);t?o.set(e,t):(a.push(e),o.set(e,null))}if(this._onChangeController=e,a.length>0){const t=await this._createFeatureItems(a,e);r(n,t);for(const e of n)null!=e.objectId&&o.set(e.objectId,e)}e.signal.aborted||(this.featureItems=Array.from(o.values()).filter(t),s.push(this.syncTitles(n)))}async syncTitles(e=this.featureItems){const{layer:t}=this,s=e.map(e=>e.graphic);"getFeatureTitles"in t&&t.getFeatureTitles&&(await t.getFeatureTitles(s,{fetchMissingFields:!0})).forEach((e,t)=>this.featureTitleMap.set(t,e))}async _createFeatureItems(e,t){const{layer:s,layerView:r,viewModel:i}=this,o=new Map;if(r){const s=r.createQuery();s.objectIds=e,s.outFields=["*"],s.returnGeometry=!0;const i=await r.queryFeatures(s,t);for(const e of i.features){const t=e.getObjectId();null!=t&&o.set(t,e)}}if(t.signal.aborted)return[];const a=e.filter(e=>!o.has(e));if(a.length){const{view:e}=this,r=s.createQuery();r.objectIds=a,r.outSpatialReference=e?.spatialReference,r.outFields=e?ce(s,e,!0):["*"],r.returnGeometry=!0;const i=await s.queryFeatures(r,t);for(const e of i.features){const t=e.getObjectId();null!=t&&o.set(t,e)}}return Array.from(o.values()).map(e=>new be({graphic:e,layer:s,layerItem:this,viewModel:i}))}};e([C()],Ie.prototype,"_onChangeController",void 0),e([C()],Ie.prototype,"effectiveObjectIds",null),e([C()],Ie.prototype,"featureItems",void 0),e([C()],Ie.prototype,"featureTitleMap",void 0),e([C()],Ie.prototype,"groupLayerItem",void 0),e([C()],Ie.prototype,"layer",void 0),e([C()],Ie.prototype,"maxVisibleFeatureCountExceeded",null),e([C()],Ie.prototype,"maxVisibleFeatureCountPerLayer",null),e([C()],Ie.prototype,"objectIds",null),e([C()],Ie.prototype,"total",null),e([C()],Ie.prototype,"visible",null),e([C()],Ie.prototype,"visibleTotal",null),Ie=e([L("esri.widgets.support.SelectionList.LayerItem")],Ie);const _e=Ie;let Se=class extends n{constructor(e){super(e),this._allLayerItems=null,this._groupItemCache=new Map,this._hoverHighlightHandle=null,this._layerEditAbortControllers=new Map,this._layerEditHandles=new a,this._layerItemCache=new Map,this._onChangeAbortController=null,this._updatingHandles=new T,this.filterText=void 0,this.layer=null,this.maxVisibleFeatureCountPerLayer=500,this.selectionManager=null,this._onSelectionChangeController=async()=>{this._cancelOnSelectionChange();const e=new AbortController;this._onChangeAbortController=e,await this._updatingHandles.addPromise(f(this._generateListItems(e))),this._onChangeAbortController===e&&(this._onChangeAbortController=null);const t=this.layer&&this.effectiveSelectionManager?.getSelection(this.layer);t?.length||(this.layer=null)},this._cancelOnSelectionChange=()=>this._onChangeAbortController?.abort(),this._onSelectionChangeDebounced=j(this._onSelectionChangeController,100),this._cancelOnLayerEdit=e=>this._layerEditAbortControllers.get(e)?.abort()}initialize(){this.addHandles([v(()=>[this.view,this.effectiveSelectionManager,...this._sources],()=>{this._onSelectionChange(),this._refreshLayerEditHandles()}),b(()=>this.effectiveSelectionManager?.sources,"change",()=>{this._onSelectionChange(),this._refreshLayerEditHandles()}),b(()=>this.effectiveSelectionManager,"selection-change",()=>this._onSelectionChange())])}destroy(){this._cancelOnSelectionChange(),this.removeTemporaryHighlight(),this._updatingHandles.destroy(),this._layerEditHandles.drain(h),this._layerEditAbortControllers.forEach(d)}get _sources(){return this.effectiveSelectionManager?.sources.toArray()??[]}get activeLayerItem(){const{layer:e}=this;return e&&this.layerItems.find(t=>t.layer===e)}get allLayerItems(){return this._allLayerItems??[]}get effectiveCount(){return he(this.allLayerItems)}get effectiveSelectionManager(){return this.selectionManager??this.view?.selectionManager}get isUpdating(){return!(!this._onChangeAbortController&&!this._updatingHandles.updating)}get layerItems(){return this.allLayerItems.flatMap(e=>de(e)?e.items.filter(e=>ye(e)):ye(e)&&e.total?e:null).filter(t)}get layerViewMap(){const e=new Map,{view:t}=this;if(!t)return e;for(const s of t.allLayerViews)if(e.set(s.layer.id,s),A(s.layer))for(const t of s.layer.sublayers)e.set(t.id,s);return e}get maxVisibleFeatureCountExceeded(){return this.allLayerItems.some(e=>e.maxVisibleFeatureCountExceeded)}get state(){const{view:e}=this;return e?e.ready?this.effectiveSelectionManager?"ready":"error":"loading":"disabled"}get viewLayersAndTables(){const{view:e}=this;return e?.map?[...e.map.layers.toArray().reverse(),...e.map.tables.toArray().reverse()]:[]}get visibleFeatureCount(){return this.activeLayerItem?.visibleTotal??this.visibleFeatureItems.length}get visibleFeatureItems(){return this.layerItems.flatMap(e=>e.featureItems.filter(e=>e.visible))}get visibleLayerCount(){const{effectiveSelectionManager:e}=this;return e&&0!==e.count?1===e.count||this.activeLayerItem?1:this.layerItems.filter(e=>e.visible).length:0}addTemporaryHighlight({graphic:e,layerView:t}){this.removeTemporaryHighlight(),t&&e&&(this._hoverHighlightHandle=t.highlight(e,{name:"temporary"}))}clear(){this.effectiveSelectionManager?.clear()}deselectFeatureItem(e){const t=e.graphic.getObjectId();null!=t&&this.effectiveSelectionManager?.removeFromSelection(e.layer,[t])}deselectGroupItem(e){e.items.forEach(e=>{ye(e)?this.deselectLayerItem(e):this.deselectGroupItem(e)})}deselectLayerItem(e){this.effectiveSelectionManager?.setSelection(e.layer,[])}deselectItem(e){de(e)?this.deselectGroupItem(e):ye(e)?this.deselectLayerItem(e):this.deselectFeatureItem(e)}goToItem(e){ye(e)||de(e)?this._goTo(me([e]).map(e=>e.graphic)):this._goTo(e.graphic)}layersToItems(e){const{controller:t,groupLayerItem:s,layers:r,promises:i}=e,{_groupItemCache:o,_layerItemCache:a,effectiveSelectionManager:n,viewLayersAndTables:l}=this,p=r??l;if(!n||0===n.count)return[];const c=[];for(const e of p)switch(e.type){case"subtype-group":case"group":{const s=o.get(e),r=s??new we({layer:e,viewModel:this});s||o.set(e,r),i.push(r.sync({controller:t,promises:i})),c.push(r)}break;default:if(G(e)||W(e)){const r=e,o=n.getSelection(r);if(!o?.length)continue;const l=a.get(r),p=l??new _e({groupLayerItem:s,layer:r,viewModel:this});l||a.set(r,p),i.push(p.sync({controller:t,promises:i})),c.push(p)}}return c}removeFromSelection(e){this.effectiveSelectionManager?.removeFromSelection(e.layer,e.objectIds)}removeTemporaryHighlight(){this._hoverHighlightHandle=h(this._hoverHighlightHandle)}selectSingleFeatureItem(e){const t=e.objectId;if(null!=t&&this.effectiveSelectionManager)for(const{layer:s}of this.effectiveSelectionManager.selections)this.setSelection({layer:s,objectIds:s===e.layer?[t]:[]})}selectSingleGroupItem(e){if(this.effectiveSelectionManager)for(const{layer:t,selection:s}of this.effectiveSelectionManager.selections)this.setSelection({layer:t,objectIds:t.parent===e.layer?s:[]})}selectSingleItem(e){de(e)?this.selectSingleGroupItem(e):ye(e)?this.selectSingleLayerItem(e):this.selectSingleFeatureItem(e)}selectSingleLayerItem(e){if(this.effectiveSelectionManager)for(const{layer:t,selection:s}of this.effectiveSelectionManager.selections)this.setSelection({layer:t,objectIds:t===e.layer?s:[]})}setSelection(e){this.effectiveSelectionManager?.setSelection(e.layer,e.objectIds)}async _goTo(e){const{view:t}=this;if(t)try{await ae(t,e)}catch(e){"AbortError"!==e.name&&m.getLogger(this).warn("Failed to go to feature(s)",e)}}async _generateListItems(e){try{this.removeTemporaryHighlight();const t=[],s=this.layersToItems({controller:e,promises:t});t.length>0&&await Promise.all(t),this._onChangeAbortController===e&&(this._allLayerItems=s)}catch(e){m.getLogger(this).warn("Failed updating selection",e)}}_onSelectionChange(){f(this._onSelectionChangeDebounced())}_refreshLayerEditHandles(){const{effectiveSelectionManager:e}=this;if(this._layerEditHandles.drain(h),!e?.sources.length)return;const t=new Set(e.sources.map(e=>W(e)?e.parent:e));for(const e of t)G(e)&&"on"in e&&this._layerEditHandles.push(e.on("edits",t=>{this._onLayerEdit(t,e)}))}async _onLayerEdit(e,t){try{if(this.removeTemporaryHighlight(),this._cancelOnLayerEdit(t),!e.updatedFeatures.some(e=>null!=e.objectId&&!e.error))return;const s=new AbortController;this._layerEditAbortControllers.set(t,s);const r="subtype-group"===t.type?this.allLayerItems.find(e=>e.layer===t):this.layerItems.find(e=>e.layer===t);if(r?.layerView){const e=r.layerView;if(await this._onLayerViewUpdate(e),s.signal.aborted)return;r.reset(),this._onSelectionChange()}this._layerEditAbortControllers.get(t)===s&&this._layerEditAbortControllers.delete(t)}catch(e){m.getLogger(this).warn("Failed updating selected features",e)}}async _onLayerViewUpdate(e){await g(I(()=>e.updating),2e3),await I(()=>!e.updating)}};e([C()],Se.prototype,"_allLayerItems",void 0),e([C()],Se.prototype,"_groupItemCache",void 0),e([C()],Se.prototype,"_hoverHighlightHandle",void 0),e([C()],Se.prototype,"_layerEditAbortControllers",void 0),e([C()],Se.prototype,"_layerEditHandles",void 0),e([C()],Se.prototype,"_layerItemCache",void 0),e([C()],Se.prototype,"_onChangeAbortController",void 0),e([C()],Se.prototype,"_sources",null),e([C()],Se.prototype,"_updatingHandles",void 0),e([C()],Se.prototype,"activeLayerItem",null),e([C()],Se.prototype,"allLayerItems",null),e([C()],Se.prototype,"effectiveCount",null),e([C()],Se.prototype,"effectiveSelectionManager",null),e([C()],Se.prototype,"filterText",void 0),e([C()],Se.prototype,"isUpdating",null),e([C()],Se.prototype,"layer",void 0),e([C()],Se.prototype,"layerItems",null),e([C()],Se.prototype,"layerViewMap",null),e([C()],Se.prototype,"maxVisibleFeatureCountExceeded",null),e([C()],Se.prototype,"maxVisibleFeatureCountPerLayer",void 0),e([C()],Se.prototype,"selectionManager",void 0),e([C()],Se.prototype,"state",null),e([C()],Se.prototype,"view",void 0),e([C()],Se.prototype,"viewLayersAndTables",null),e([C()],Se.prototype,"visibleFeatureCount",null),e([C()],Se.prototype,"visibleFeatureItems",null),e([C()],Se.prototype,"visibleLayerCount",null),Se=e([L("esri.widgets.support.SelectionList.SelectionListViewModel")],Se);const Me=Se;function Fe(e,t){return e?.find(e=>e.layer===t)}let Ce=class extends c{constructor(e){super(e),this._queuedSelectionTool=null,this._sketchEventListenerHandle=null,this._sketchGraphicsLayer=new E({listMode:"hide",internal:!0,title:"Editor sketch layer"}),this._snappingManager=null,this._templatesByLayer=new Map,this._updateItemsTask=null,this._updateTemplatesTask=null,this._updatingHandles=new T,this._featureTemplatesViewModelIsRestricted=!1,this.activeWorkflow=null,this._activityQueue=new a,this.editorItems=new a,this.failures=[],this.hideTemplatesForInactiveLayers=!1,this.attachmentsViewModel=new q({capabilities:{editing:!0}}),this.featureTemplatesViewModel=new se({disabledItemFunction:({layer:e})=>this._itemIsSuspended(e)}),this.layerInfos=null,this.ownSketchViewModel=new ie({layer:this._sketchGraphicsLayer}),this.selectionListViewModel=new Me,this.selectionManager=new R,this.selectionToolbarViewModel=new ue({continuousSelectionEnabled:!0,defaultOperationType:"replace",persistSelection:!1,returnGeometry:!1}),this.sketchOptions=new D,this.snappingOptions=new B({attributeRulesEnabled:!0}),this.spinnerViewModel=new oe,this.pageStack=[],this.showDiscardEditsPrompt=()=>Promise.resolve(!0),this._candidateCommitted=!1,this.back=async()=>{if("viewing-selection-list"===this.state)return this.selectionListViewModel.filterText=void 0,void this.effectiveSelectionManager.clear();this.canGoBack&&(this.activeWorkflow?.hasPreviousStep?await this.activeWorkflow.back(this.showDiscardEditsPrompt):await this._cancelWorkflow({force:!this.hasPendingEdits}))},this.saveWorkflow=async()=>await(this.activeWorkflow?.save()),this.selectFeature=(e,t=!1)=>{const s=this.activeWorkflow;this._candidateCommitted||"update"!==s?.type||(s.data.rootFeature=e,t&&(s.next(),this._candidateCommitted=!0))}}initialize(){this.addHandles([v(()=>{const e=this.view,t=e?.map?.editableLayers.toArray(),s=e?.allLayerViews,r=s?.filter(e=>!!t?.includes(e.layer));return[t,r,this.layerInfos]},()=>this._updateEditorItems(),S),v(()=>this.hideTemplatesForInactiveLayers,()=>this.syncFeatureTemplates()),v(()=>this._selectionSources,()=>this._syncSelectionSources(),M),b(()=>this.activeWorkflow,"cancel",()=>this.emit("workflow-cancel")),b(()=>this.activeWorkflow,"commit",()=>this.emit("workflow-commit")),b(()=>this.activeWorkflow,"complete",()=>{this.emit("workflow-commit"),this._set("activeWorkflow",null)}),_(()=>!this.activeWorkflow&&this._queuedSelectionTool,()=>this._queuedSelectionTool&&this.selectionToolbarViewModel.activateTool(this._queuedSelectionTool)),v(()=>this.activeWorkflow,e=>this.selectionManager.showHighlight=!e),_(()=>this.view?.map,e=>e.add(this._sketchGraphicsLayer),M),b(()=>this.editorItems,"change",()=>this._afterEditorItemsChange()),v(()=>[this.canCreate,this.canUpdateVisible],()=>this._afterEditorItemsChange()),v(()=>this.page,(e,t)=>{const s=[...this.pageStack];if(-1===s.indexOf(e))s.push(e);else for(;s.length&&s.at(-1)!==e;)s.pop();this.pageStack=s},S),_(()=>"awaiting-update-feature-candidate"===this.state,()=>this._candidateCommitted=!1),b(()=>this.featureTemplatesViewModel,"select",async({item:e,oldItem:t})=>{const{activeWorkflow:s}=this;if(s){if("update"===s.type&&"awaiting-feature-creation-info"===s.activeWorkflow?.stepId)return;try{await this.cancelWorkflow({force:!this.hasPendingEdits})}catch{return void this.featureTemplatesViewModel.select(t,{emit:!1})}}if(!e)return;const r={layer:e.layer,template:e.template};if(e.supportsUpload)return this.featureTemplatesViewModel.select(t,{emit:!1}),this.startCreateFeaturesWorkflow(r);await this.startCreateFeaturesWorkflowAtFeatureCreation(r)}),v(()=>[this.view,this.featureTemplatesViewModel],([e,t])=>{t.view=e},S),b(()=>this.view,"key-down",e=>{"Escape"===e.key&&this.activeWorkflow?.keyboardCancellationEnabled&&(e.stopPropagation(),this.back())}),b(()=>this.sketchViewModel,["create","delete","update"],e=>{const{activeWorkflow:t}=this,s="update"===t?.type,r=Z(t),i=s?t?.activeWorkflow?.parentLayer??void 0:void 0,o=`sketch-${e.type}`;this.emit(o,{type:o,detail:e,layer:r[0],layers:r,parentLayer:i})},F),v(()=>this.view,e=>{if(this._snappingManager=y(this._snappingManager),!e)return;const t=this.snappingOptions;this._snappingManager=new H({view:e,options:t}),this.ownSketchViewModel.snappingManager=this._snappingManager},S),v(()=>this.snappingOptions,e=>{this._snappingManager&&(this._snappingManager.options=e)},S),b(()=>this.selectionToolbarViewModel,"complete",e=>this._onSelectionComplete(e)),v(()=>({view:this.view,selectionManager:this.effectiveSelectionManager,selectionListViewModel:this.selectionListViewModel,selectionToolbarViewModel:this.selectionToolbarViewModel}),({view:e,selectionManager:t,selectionListViewModel:s,selectionToolbarViewModel:r})=>{t.view=e,s.view=e,r.view=e},S),v(()=>this.effectiveSelectionManager,e=>{this.selectionListViewModel.selectionManager=e,this.selectionToolbarViewModel.selectionManager=e},S)])}destroy(){this._cancelWorkflow({warnIfNoWorkflow:!1}).then(()=>{this.view?.map?.remove(this._sketchGraphicsLayer),this.view=null}),this._updateItemsTask=d(this._updateItemsTask),this._updatingHandles.destroy(),this._sketchEventListenerHandle=h(this._sketchEventListenerHandle),this.selectionListViewModel?.destroy(),this.selectionToolbarViewModel?.destroy(),this.selectionManager.destroy()}get _featureTemplatesLayersAndTables(){const e=new a;for(const t of this.editorItems){const s=this.hideTemplatesForInactiveLayers&&!t.visible;t.supportsCreateFeaturesWorkflow&&!s&&e.push(t.layer)}return e}get _selectionSources(){const e=new a;for(const t of this.editorItems)G(t.layer)&&t.supportsUpdateWorkflow&&t.visible&&e.push(t.layer);return e}get activeFeatureCount(){const e=this.activeLeafWorkflow;return $(e)?e.pendingFeatures.length:J(e)&&e.data.edits.feature?1:K(e)?e.data.features.length:0}get activeLeafWorkflow(){const e=this.activeWorkflow;return e&&X(e)?e.activeWorkflow??e:e}get canCreate(){return this.editorItems.some(e=>e.supportsCreateFeaturesWorkflow)}get canCreateVisible(){return!!this.featureTemplatesLayers.length}get canUpdate(){return this.editorItems.some(e=>e.supportsUpdateWorkflow)}get canUpdateVisible(){return this.editorItems.some(e=>e.supportsUpdateWorkflow&&e.visible)}get featureTemplatesLayers(){return this._featureTemplatesLayersAndTables.filter(e=>"scene"===e.type||!e.isTable)}get effectiveSelectionManager(){return this.selectionManager}get featureFormViewModel(){const{activeWorkflow:e}=this;return"update"===e?.type?e.activeFeatureFormViewModel:"create-features"===e?.type?e.featureFormViewModel:null}get formViewModel(){const{activeWorkflow:e}=this;return"update"===e?.type?e.activeFeatureFormViewModel:"create-features"===e?.type?e.featureFormViewModel:"update-features"===e?.type?e.formViewModel:null}get utilityNetworkAssociationAddAssociationViewModel(){const{activeWorkflow:e}=this;return"update"===e?.type?e.activeUtilityNetworkAssociationAddAssociationViewModel:null}get labelOptions(){return this.sketchOptions.labels}set labelOptions(e){this.sketchOptions.labels=e}get sketchViewModel(){const{activeWorkflow:e}=this;return"update"===e?.type?e.activeSketchViewModel:"create-features"===e?.type||"update-features"===e?.type?e.sketchViewModel:this.ownSketchViewModel}get state(){if(!this.view?.ready)return"disabled";const e=this.attachmentsViewModel.mode;if("add"===e)return"adding-attachment";if("edit"===e)return"editing-attachment";const{activeWorkflow:t}=this,s=!t?.stepId;return this.effectiveSelectionManager.count&&s?"viewing-selection-list":s?"ready":"update"===t.type&&t.activeWorkflow?.stepId?t.activeWorkflow.stepId:t.stepId}get syncing(){return this._activityQueue.length>0}get updating(){return this._updatingHandles.updating||!0===this.activeWorkflow?.updating}get tooltipOptions(){return this.sketchOptions.tooltips}set tooltipOptions(e){this.sketchOptions.tooltips=e}get valueOptions(){return this.sketchOptions.values}set valueOptions(e){this.sketchOptions.values=e}set view(e){this.ownSketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}get canZoomTo(){const e=this.sketchViewModel,t=e?.createGraphic?.geometry?.type;return!(!e?.updateGraphics?.length&&"multipoint"!==t)}get page(){const{activeWorkflow:e,state:t}=this;if("update"===e?.type&&null!=e?.activeWorkflow?.featureFormViewModel?.associatedLayer)return"viewing-associated-features";if("update"===e?.type&&null!=e?.activeWorkflow?.featureFormViewModel?.associationId)return"viewing-associated-layers";if("update"===e?.type&&"awaiting-feature-to-update"===e.stepId)return"ready";if("create-features"===e?.type&&0===e.numPendingFeatures){const t=e.data.upload;if(t)return"default"===t.state?"ready":"creating-features-upload-details"}return t??"disabled"}get featureFormDisabled(){const{activeLeafWorkflow:e}=this;if(J(e))return!1===e.data.editorItem?.capabilities.update.attributes||!0===e.featureFormViewModel.disabled;if(K(e)){const{formViewModel:t}=e;return t.disabled||t.readOnly}return!1}get featureFormHasAssociation(){return!!this.featureFormViewModel?.activeAssociation}get canGoBack(){return null!=this.activeWorkflow&&!this.syncing}get shouldShowDeleteButton(){const{activeLeafWorkflow:e}=this;if(J(e)){const{data:t}=e;return t.editorItem?.capabilities.delete.enabled&&!t.readOnly}return!!K(e)&&e.data.editorItems.every(e=>e.capabilities.delete.enabled)}get hasPendingEdits(){return this.activeWorkflow?.hasPendingEdits??!1}get snappingManager(){return this._snappingManager}getTemplatesForLayer(e){return this._templatesByLayer.get(e)??[]}async startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.startCreateFeaturesWorkflow()}async startCreateFeaturesWorkflowAtFeatureCreation(e){return this.startCreateFeaturesWorkflow(e,"creating-features")}async startCreateFeaturesWorkflow(e,t="awaiting-feature-creation-info"){if(await I(()=>!this.updating),!this.canCreate)throw new p("editing:unsupported-workflow","Creating features is unsupported or disabled.");const s=this._createUpdatingResolver();try{await this._cancelWorkflow();const s=this._createCreateFeaturesWorkflow(e,t);this._set("activeWorkflow",s),await s.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{s.resolve()}}async startCreateFeaturesWorkflowAtFeatureEdit(e){await I(()=>!this.updating);const t=this._createUpdatingResolver();try{const{initialFeature:t}=e,s=t.sourceLayer=t.layer,r=s?this.findEditorItemForLayer(s):void 0;if(!r?.supportsCreateFeaturesWorkflow)throw new p("editing:unsupported-workflow","Creating features is unsupported or disabled for this layer.");await this._cancelWorkflow();const i=this._createCreateFeaturesWorkflow({initialFeature:t,layer:r.layer,maxFeatures:1},"creating-features");this._set("activeWorkflow",i),await i.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{t.resolve()}}async startUpdateFeaturesWorkflow(e){if(await I(()=>!this.updating),!this.canUpdate)return void this._logError("editing:unsupported-workflow","Update features workflow is unsupported or disabled.");if(i(e.map(e=>e.sourceLayer??e.layer)).length>1)throw Y();const t=this._createUpdatingResolver();try{await this._cancelWorkflow();const t=this._createUpdateFeaturesWorkflow(e);this._set("activeWorkflow",t),await t.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{t.resolve()}}async startUpdateWorkflowAtFeatureSelection(){if(await I(()=>!this.updating),!this.canUpdate)return void this._logError("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const e=this._createUpdatingResolver();try{await this._cancelWorkflow();const e=this._createUpdateWorkflow();this._set("activeWorkflow",e),await e.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{e.resolve()}}async startUpdateWorkflowAtMultipleFeatureSelection(e){if(await I(()=>!this.updating),!this.canUpdate)return void this._logError("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const t=this._createUpdatingResolver();try{await this._cancelWorkflow();const t=this._createUpdateWorkflow("awaiting-update-feature-candidate");t.data.candidates=e,this._set("activeWorkflow",t),await t.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{t.resolve()}}async startUpdateWorkflowAtFeatureEdit(e){if(await I(()=>!this.updating),!this.canUpdate)return void this._logError("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const t=this._createUpdatingResolver();try{await this._cancelWorkflow();const t=this._createUpdateWorkflow("editing-existing-feature");t.data.rootFeature=e,t.addHandles(b(()=>t,"commit",()=>{t.destroy(),this.activeWorkflow===t&&this._set("activeWorkflow",null)})),this._set("activeWorkflow",t),await t.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{t.resolve()}}async startUpdateWorkflowWithActiveSelection(){const{selectionListViewModel:e}=this;if(!e.visibleFeatureCount)throw new p("editing:missing-selection","Unable to determine visible selection.");if(e.visibleLayerCount>1)throw new p("editing:features-different-layers","Cannot start workflow with features from different layers.");const t=e.visibleFeatureItems.map(e=>e.graphic);1===t.length?await this.startUpdateWorkflowAtFeatureEdit(t[0]):await this.startUpdateFeaturesWorkflow(t)}async deleteFeatureFromWorkflow(){l(m.getLogger(this),"EditorViewModel.deleteFeatureFromWorkflow is deprecated. Use EditorViewModel.deleteFeatures instead.",{version:"4.33",replacement:"EditorViewModel.deleteFeatures",warnOnce:!0}),await this.deleteFeatures()}async deleteFeatures(){const e=this.activeWorkflow;return X(e)?e.deleteActiveFeature():K(e)?e.deleteAndCommit():void this._logError("editing:unsupported-workflow","Deleting features requires an active update workflow.")}async deleteAssociationFromWorkflow(){const{activeWorkflow:e}=this;e&&"update"===e.type?await e.deleteActiveAssociation():this._logError("editing:unsupported-workflow","Deleting an association requires an active update workflow.")}async cancelWorkflow(e){return this._cancelWorkflow({warnIfNoWorkflow:!0,...e})}findEditorItemForLayer(e){return this.editorItems.find(t=>t.layer===e)}itemHasInvalidFormTemplate(e){return null!=e&&!0===this.findEditorItemForLayer(e.layer)?.hasInvalidFormTemplate}syncFeatureTemplates(){this._featureTemplatesViewModelIsRestricted||this._updateTemplates()}zoomTo(e){const{view:s,sketchViewModel:r}=this;if(!s)return;const i=e??r?.createGraphic;if(i)"mesh"===i.geometry?.type?ae(s,i.geometry):ae(s,i);else{const e=r?.updateGraphics?.toArray();"3d"===s.type&&e?.some(e=>"mesh"===e.geometry?.type)?ae(s,e.map(e=>e.geometry).filter(t)):e&&ae(s,e)}}async toggleUpdateWorkflow(){this.canUpdate&&(this.hasPendingEdits&&!await this.showDiscardEditsPrompt()||(this.activeWorkflow&&"awaiting-feature-to-update"===this.state?await this.cancelWorkflow({force:!0}):await this.startUpdateWorkflowAtFeatureSelection()))}async onSelectionListItemSelect(e){fe(e)&&await this.startUpdateWorkflowAtFeatureEdit(e.graphic)}async onSelectionListMenuItemSelect(e){if(fe(e))await this.startUpdateWorkflowAtFeatureEdit(e.graphic);else if(ye(e)){const t=e.featureItems.filter(e=>e.visible).map(e=>e.graphic);1===t.length?await this.startUpdateWorkflowAtFeatureEdit(t[0]):await this.startUpdateFeaturesWorkflow(t)}}restrictFeatureTemplatesViewModelToLayer(e){return this._featureTemplatesViewModelIsRestricted=!0,this._setFeatureTemplatesViewModelLayers([e]),u(()=>{this._featureTemplatesViewModelIsRestricted=!1,this._setFeatureTemplatesViewModelLayers(this.featureTemplatesLayers)})}async _getEditorItemCandidates(e){const{view:t}=this;if(!t?.map)return[];const{map:s}=t,r=s.editableLayers.toArray(),i=s.allTables.toArray().filter(e=>x(e)||A(e));return await Promise.allSettled([...r.flatMap(e=>this._getLayerLoadPromise(e)),...i.flatMap(e=>this._getLayerLoadPromise(e))]),k(e),[...r.reverse(),...i.reverse()].filter(e=>V(e)&&("mesh"!==e.geometryType||"3d"===t.type)).flatMap(e=>"subtype-group"===e.type?e.sublayers.toArray():e)}_getLayerLoadPromise(e){return A(e)?e.loadAll():e.load()}_drainEditorItems(){this.editorItems.drain(e=>e.destroy())}_updateEditorItems(){d(this._updateItemsTask);const{view:e}=this,t=o(async t=>{if(!e?.map||!e?.allLayerViews)return;const s=await this._getEditorItemCandidates(t);if(!s.length)return void this._drainEditorItems();const r=[],i=[],o=[],{layerInfos:a}=this;for(const t of s){const s=Fe(a,t),n=await ee(e,t).catch(()=>null);(s?r:n?i:o).push(new te({layer:t,layerInfo:s,layerView:n}))}a?.length&&r.sort((e,t)=>a.findIndex(({layer:t})=>t===e.layer)-a.findIndex(({layer:e})=>e===t.layer));const n=[...r,...i,...o];t.aborted||(this._drainEditorItems(),this.editorItems.addMany(n))});this._updatingHandles.addPromise(t.promise),this._updateItemsTask=t}_updateTemplates(){d(this._updateTemplatesTask);const e=o(async e=>{const t=this._templatesByLayer,s=this._featureTemplatesLayersAndTables.filter(e=>!t.has(e));if(s.length>0){const r=await U(s.toArray(),this.view,e);for(const{layer:e,templates:s}of r)t.set(e,s)}this._setFeatureTemplatesViewModelLayers(this.featureTemplatesLayers)});this._updatingHandles.addPromise(e.promise),this._updateTemplatesTask=e}_setFeatureTemplatesViewModelLayers(e){const t=this._templatesByLayer,s=[];for(const r of e){const e=t.get(r);e&&e.length>0&&s.push(re(r,e))}this.featureTemplatesViewModel.templateInfos=s}_afterEditorItemsChange(){const{activeWorkflow:e}=this;if(this.syncFeatureTemplates(),!e)return;const{stepId:t}=e;"create-features"!==e.type?"update"===e.type&&("awaiting-feature-to-update"===t&&!this.canUpdateVisible||"awaiting-update-feature-candidate"===t&&!e.hasUpdatableCandidates)&&this._cancelWorkflow():"awaiting-feature-creation-info"!==t||this.canCreate||this._cancelWorkflow()}async _cancelWorkflow(e){const t=this.activeWorkflow;if(t)if(e&&!1===e.force)try{await t.cancel(e),this._set("activeWorkflow",null),t.destroy()}catch(e){}else{this.emit("workflow-cancel"),this._set("activeWorkflow",null);try{await t.cancel(e)}finally{t.destroy()}}else e?.warnIfNoWorkflow&&this._logError("editing:no-active-workflow","There is no active workflow to cancel.")}_createCreateFeaturesWorkflow(e,t){return N.create({viewModel:this,creationInfo:e,sketchOptions:this.sketchOptions,snappingManager:this._snappingManager,startAt:t,applyEditsCallback:(e,t,s)=>this._applyEdits(e,t,s),applyEditsFeatureServiceCallback:(e,t,s)=>this._applyEditsFeatureService(e,t,s),addAttachmentsCallback:(e,t)=>this._addAttachments(e,t)})}_createUpdateFeaturesWorkflow(e){const t=z.create({viewModel:this,sketchOptions:this.sketchOptions,snappingManager:this._snappingManager,features:e,applyEdits:(e,t,s)=>this._applyEdits(e,t,s),applyEditsFeatureService:(e,t,s)=>this._applyEditsFeatureService(e,t,s)});return t.addHandles(b(()=>t,"commit",()=>{t.destroy(),this.activeWorkflow===t&&this._set("activeWorkflow",null)})),t}_createUpdateWorkflow(e){return Q.create({viewModel:this,sketchOptions:this.sketchOptions,snappingManager:this._snappingManager,startAt:e,applyEditsCallback:(e,t,s)=>this._applyEdits(e,t,s),applyEditsFeatureServiceCallback:(e,t,s)=>this._applyEditsFeatureService(e,t,s),addAttachmentsCallback:(e,t)=>this._addAttachments(e,t)})}_addAttachments(e,t){const s=t.map(t=>this._addAttachment(e,t.feature,t.attachment))??[];return Promise.all(s)}async _addAttachment(e,t,s){let r=null;if(!("addAttachment"in e)||null==e.capabilities?.attachment)throw new p("editor:attachments-not-supported","Adding attachments is not supported for this layer type");return await this._queueOperation(async()=>(r=await(e.addAttachment?.(t,s).catch(e=>{throw e?.error||e}))??null,r)),r}async _applyEdits(e,t,s){let r=null;const i=e.url?await O(e.url):null,o={returnServiceEditsOption:i&&P(i)||RegExp("/hosted/","i").test(e.url)?void 0:"original-and-current-features",...s};return await this._queueOperation(async()=>{const{view:s}=this;if(!s)return null;const i=await ee(s,e).catch(()=>null);return r=await e.applyEdits(t,o),i&&await I(()=>!i.updating),r}),r}async _applyEditsFeatureService(e,t,s){let r=null;return await this._queueOperation(async()=>r=await e.applyEdits(t,s)),r}_queueOperation(e){this._activityQueue.push(e);const t=(e,t)=>{const s=t.indexOf(e);s>-1&&t.splice(s,1)};return e().then(e=>(Array.isArray(e)?e.forEach(e=>this._handleEditsResultError(e)):this._handleEditsResultError(e),e)).catch(s=>{this._logError("editing:operation-error","An error occurred.",{error:s});const r={error:s,retry:()=>(t(r,this.failures),this._queueOperation(e)),cancel:()=>{t(r,this.failures)}};this._set("failures",[...this.failures,r])}).then(()=>{t(e,this._activityQueue)})}_handleEditsResultError(e){if(null!=e&&"error"in e&&null!=e.error)throw e.error;if(null!=e&&"addFeatureResults"in e){const{addFeatureResults:t,deleteFeatureResults:s,updateFeatureResults:r}=e,i=t.find(e=>!!e.error)||r.find(e=>!!e.error)||s.find(e=>!!e.error);if(i)throw i.error}}_createUpdatingResolver(){const e=w();return this._updatingHandles.addPromise(e.promise),e}_logErrorAndCancelWorkflow(e){const{name:t,message:s,details:r}=e;this._logError(t??"editing:workflow-start-failed",s??void 0,r??e),this._cancelWorkflow({force:!0})}_itemIsSuspended(e){const t=this.findEditorItemForLayer(e);return null!=t&&(!t.visible||t.disabled)}_logError(e,t,s){m.getLogger(this).error(new p(e,t,s))}_syncSelectionSources(){this.selectionManager.sources.items=this._selectionSources.toArray()}async _onSelectionComplete(e){if(e.aborted)return;const{operationType:t,selection:s}=e,{effectiveSelectionManager:r}=this,i="ready"===this.state,o=1===s.length;if(this._queuedSelectionTool=void 0,i&&o&&(0===r.count&&"add"===t||"replace"===t))return this._queuedSelectionTool=e.toolName,this.startUpdateWorkflowAtFeatureEdit(s[0]);switch(t){case"remove":r.updateSelection({current:[],added:[],removed:s});break;case"replace":r.clear(),r.updateSelection({current:s,added:[],removed:[]});break;case"add":r.updateSelection({current:s,added:[],removed:[]})}}};e([C()],Ce.prototype,"_featureTemplatesLayersAndTables",null),e([C()],Ce.prototype,"_queuedSelectionTool",void 0),e([C()],Ce.prototype,"_snappingManager",void 0),e([C()],Ce.prototype,"_selectionSources",null),e([C()],Ce.prototype,"activeFeatureCount",null),e([C({readOnly:!0})],Ce.prototype,"activeWorkflow",void 0),e([C()],Ce.prototype,"activeLeafWorkflow",null),e([C({readOnly:!0})],Ce.prototype,"_activityQueue",void 0),e([C({readOnly:!0})],Ce.prototype,"canCreate",null),e([C()],Ce.prototype,"canCreateVisible",null),e([C({readOnly:!0})],Ce.prototype,"canUpdate",null),e([C()],Ce.prototype,"canUpdateVisible",null),e([C()],Ce.prototype,"featureTemplatesLayers",null),e([C()],Ce.prototype,"editorItems",void 0),e([C()],Ce.prototype,"effectiveSelectionManager",null),e([C({readOnly:!0})],Ce.prototype,"failures",void 0),e([C()],Ce.prototype,"hideTemplatesForInactiveLayers",void 0),e([C({type:q})],Ce.prototype,"attachmentsViewModel",void 0),e([C()],Ce.prototype,"featureFormViewModel",null),e([C()],Ce.prototype,"formViewModel",null),e([C()],Ce.prototype,"utilityNetworkAssociationAddAssociationViewModel",null),e([C({type:se})],Ce.prototype,"featureTemplatesViewModel",void 0),e([C()],Ce.prototype,"labelOptions",null),e([C()],Ce.prototype,"layerInfos",void 0),e([C()],Ce.prototype,"ownSketchViewModel",void 0),e([C()],Ce.prototype,"selectionListViewModel",void 0),e([C()],Ce.prototype,"selectionManager",void 0),e([C()],Ce.prototype,"selectionToolbarViewModel",void 0),e([C()],Ce.prototype,"sketchOptions",void 0),e([C()],Ce.prototype,"sketchViewModel",null),e([C({type:B,nonNullable:!0})],Ce.prototype,"snappingOptions",void 0),e([C()],Ce.prototype,"spinnerViewModel",void 0),e([C()],Ce.prototype,"state",null),e([C({readOnly:!0})],Ce.prototype,"syncing",null),e([C()],Ce.prototype,"updating",null),e([C()],Ce.prototype,"tooltipOptions",null),e([C()],Ce.prototype,"valueOptions",null),e([C()],Ce.prototype,"view",null),e([C()],Ce.prototype,"canZoomTo",null),e([C()],Ce.prototype,"pageStack",void 0),e([C()],Ce.prototype,"showDiscardEditsPrompt",void 0),e([C()],Ce.prototype,"_candidateCommitted",void 0),e([C()],Ce.prototype,"page",null),e([C()],Ce.prototype,"featureFormDisabled",null),e([C()],Ce.prototype,"featureFormHasAssociation",null),e([C()],Ce.prototype,"canGoBack",null),e([C()],Ce.prototype,"shouldShowDeleteButton",null),e([C()],Ce.prototype,"hasPendingEdits",null),e([C()],Ce.prototype,"snappingManager",null),Ce=e([L("esri.widgets.Editor.EditorViewModel")],Ce);const Le=Ce;export{Me as S,ye as a,fe as b,Le as default,de as i};
