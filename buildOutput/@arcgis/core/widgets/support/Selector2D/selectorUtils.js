/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{a as e}from"../../../core/lang.js";import{ignoreAbortErrors as s,whenOrAbort as r}from"../../../core/promiseUtils.js";import{getDisplayFieldName as t}from"../../../layers/support/fieldUtils.js";import{i,a as o,b as a,c as n,d as c,e as l,f as p}from"../../../chunks/layerUtils.js";import{c as u,a as m}from"../../../chunks/drapedUtils.js";import{i as d}from"../../../chunks/layerViewUtils.js";import"../../../chunks/handleUtils.js";import"../../../core/Error.js";import"../../../chunks/Logger.js";import"../../../config.js";import"../../../chunks/object.js";import"../../../chunks/string.js";import"../../../chunks/events.js";import"../../../chunks/maybe.js";import"../../../chunks/SetUtils.js";import"../../../core/sql.js";import"../../../chunks/guards.js";import"../../../chunks/datetime.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../chunks/jsonUtils.js";import"../../../request.js";import"../../../chunks/MapUtils.js";import"../../../chunks/persistableUrlUtils.js";import"../../../core/Collection.js";import"../../../chunks/tslib.es6.js";import"../../../chunks/watch.js";import"../../../chunks/ObjectPool.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../chunks/PooledArray.js";import"../../../chunks/get.js";import"../../../chunks/utils.js";import"../../../chunks/Lifecycle.js";import"../../../chunks/tracking.js";import"../../../chunks/SimpleTrackingTarget.js";import"../../../core/Evented.js";import"../../../core/Accessor.js";import"../../../core/Handles.js";import"../../../core/accessorSupport/decorators/subclass.js";import"../../../chunks/metadata.js";import"../../../chunks/ensureType.js";import"../../../chunks/Warning.js";import"../../../chunks/ObservableBase.js";import"../../../core/accessorSupport/decorators/property.js";import"../../../chunks/shared.js";import"../../../chunks/SimpleObservable.js";import"../../../layers/catalog/catalogUtils.js";import"../../../core/reactiveUtils.js";import"../../../chunks/unitUtils.js";import"../../../chunks/jsonMap.js";import"../../../chunks/pe.js";import"../../../chunks/assets.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../core/JSONSupport.js";import"../../../chunks/reader.js";import"../../../geometry/SpatialReference.js";import"../../../chunks/writer.js";import"../../../geometry/Point.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../geometry/support/webMercatorUtils.js";async function y(e){const{returnFeatureTitleFields:t,returnGeometry:u,selector:m,signal:y,sources:g,view:f}=e;if(!g?.length)return[];const{layers:w,layerViews:F,graphicsLayers:b}=function(e){const s=[],r=[],t=[];return e.forEach(e=>{i(e)||o(e)||a(e)?s.push(e):(n(e)||c(e))&&e.layers?.length?s.push(...e.layers.toArray()):l(e)&&e.sublayers?.length?t.push(...e.sublayers.toArray()):p(e)?t.push(e):d(e)&&r.push(e)}),{layers:s,layerViews:r,graphicsLayers:t}}(g),U=[];return await s(r(Promise.all([j({candidates:U,layers:w,returnFeatureTitleFields:t,returnGeometry:u,selector:m,signal:y,view:f}),h({candidates:U,layerViews:F,returnGeometry:u,selector:m,signal:y,view:f}),k({candidates:U,graphicsLayers:b,selector:m})]),y)),U}async function h(s){const{candidates:t,layerViews:i,returnGeometry:o,selector:a,signal:n,view:c}=s;"point"!==a.type?await r(Promise.allSettled(i.map(async s=>{const r=function(e,s,r,t=!0){const i=e.createQuery();return i.outFields=["*"],i.geometry=g(s,e.layer,r),i.returnGeometry=t,i.outSpatialReference=r.spatialReference,i}(s,a,c,o),i=await s.queryFeatures(r,{signal:n});e(t,i.features)})),n):await async function({candidates:e,layerViews:s,selector:r,view:t}){const i=t.toScreen(r);if(!i)return;const o=s.map(e=>e.layer),{results:a}=await t.hitTest(i,{include:o});a.forEach(s=>{"graphic"in s&&s.graphic&&e.push(s.graphic)})}({candidates:t,layerViews:i,selector:a,view:c})}async function j(s){const{candidates:t,layers:i,returnFeatureTitleFields:o,returnGeometry:a,selector:n,signal:c,view:l}=s;await r(Promise.allSettled(i.map(async s=>{if("isTable"in s&&s.isTable)return;const r=function(e,s,r,t=!1,i=!0){const o=e.createQuery();return o.outFields=f(e,r,t),o.geometry=g(s,e,r),o.returnGeometry=i,o.outSpatialReference=r.spatialReference,o}(s,n,l,o,a),i=await s.queryFeatures(r,{signal:c});e(t,i.features)})),c)}function g(e,s,r){return"point"===e.type?u(e,"renderer"in s?m({renderer:s.renderer}):0,r):e}function f(e,s,r){const{fields:i,fieldsIndex:o}=e,a=new Set([e.objectIdField]);"globalIdField"in e&&null!=e.globalIdField&&o.has(e.globalIdField)&&a.add(o.get(e.globalIdField).name);const n="displayField"in e?e.displayField:null,c=t({displayField:n,fields:i});if(null!=c&&o.has(c)&&a.add(c),"subtypeField"in e&&null!=e.subtypeField){const r=o.get(e.subtypeField)?.name;if(null!=r&&a.add(r),"utilityNetworks"in s.map&&s.map.utilityNetworks?.length){const e=o.get("assetgroup");e?.name&&a.add(e.name);const s=o.get("assettype");s?.name&&a.add(s.name)}}return(r||s.requiredFieldsOptions.featureTitleFields)&&"featureTitleFields"in e&&e.featureTitleFields&&e.featureTitleFields.forEach(e=>a.add(e)),Array.from(a.values())}async function k(e){const{candidates:s,graphicsLayers:r,selector:t}=e,i=r.flatMap(e=>e.graphics.toArray())??[];if(!i?.length||!t)return;const o=await import("../../../geometry/operators/intersectsOperator.js").then(e=>e.i);o.accelerateGeometry(t),i.forEach(e=>{e.geometry&&"mesh"!==e.geometry.type&&o.execute(t,e.geometry)&&s.push(e)})}export{h as collectSelectionFromFeatureLayerViews,j as collectSelectionFromFeatureLayers,k as collectSelectionFromGraphicsLayers,y as getSelectionFromGeometry,g as getSuggestedQueryGeometry,f as getSuggestedQueryOutFields};
