/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import s from"../../../Color.js";import{EventedAccessor as i}from"../../../core/Evented.js";import{L as e}from"../../../chunks/Logger.js";import{q as r,r as o}from"../../../chunks/mathUtils.js";import{d as n}from"../../../chunks/maybe.js";import{when as p,watch as a}from"../../../core/reactiveUtils.js";import{c as l}from"../../../chunks/unitUtils.js";import{property as m}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/lang.js";import{subclass as c}from"../../../core/accessorSupport/decorators/subclass.js";import h from"../../../geometry/Point.js";import{isLoadedOrLoadFor as u,project as d}from"../../../chunks/projectionUtils.js";import{e as j}from"../../../chunks/scaleUtils.js";import{JSONSupport as y}from"../../../core/JSONSupport.js";import{e as g}from"../../../chunks/enumeration.js";import{m as k}from"../../../chunks/dehydratedPoint.js";import{d as v}from"../../../chunks/defaultUnit.js";import S from"../../../symbols/SimpleLineSymbol.js";import b from"../../../symbols/SimpleMarkerSymbol.js";import{a as f,g as _,s as w,m as C}from"../../../chunks/gridUtils.js";import{DrawGraphicTool2D as U}from"../../../chunks/editingTools.js";import{V as P}from"../../../chunks/InputManager.js";import{K as x,s as M}from"../../../chunks/keybindings.js";import L from"../../../views/interactive/snapping/SnappingOptions.js";import{g as T}from"../../../chunks/constraints.js";import I from"../../../core/Accessor.js";import"../../../chunks/widgetUtils.js";import{t as D}from"../../../chunks/jsxFactory.js";import{T as O}from"../../../chunks/TextOverlayItem.js";import{l as G}from"../../../chunks/automaticAreaMeasurementUtils.js";import{l as R}from"../../../chunks/automaticLengthMeasurementUtils.js";import{d as V}from"../../../chunks/formatUtils.js";import"../../../chunks/colorUtils.js";import"../../../chunks/ensureType.js";import"../../../chunks/MapUtils.js";import"../../../config.js";import"../../../chunks/object.js";import"../../../chunks/string.js";import"../../../chunks/handleUtils.js";import"../../../core/Handles.js";import"../../../chunks/Lifecycle.js";import"../../../chunks/metadata.js";import"../../../chunks/utils.js";import"../../../chunks/tracking.js";import"../../../chunks/Warning.js";import"../../../core/Error.js";import"../../../chunks/get.js";import"../../../chunks/ObjectPool.js";import"../../../chunks/ObservableBase.js";import"../../../chunks/watch.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../chunks/PooledArray.js";import"../../../core/promiseUtils.js";import"../../../chunks/events.js";import"../../../chunks/SetUtils.js";import"../../../chunks/SimpleTrackingTarget.js";import"../../../chunks/jsonMap.js";import"../../../chunks/pe.js";import"../../../chunks/assets.js";import"../../../request.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../chunks/jsonUtils.js";import"../../../chunks/persistableUrlUtils.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../chunks/reader.js";import"../../../chunks/writer.js";import"../../../geometry/Geometry.js";import"../../../geometry/SpatialReference.js";import"../../../geometry/support/webMercatorUtils.js";import"../../../chunks/SimpleObservable.js";import"../../../chunks/vec3f64.js";import"../../../geometry/Extent.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polygon.js";import"../../../chunks/coordsUtils.js";import"../../../chunks/extentUtils.js";import"../../../chunks/boundsUtils.js";import"../../../chunks/aaBoundingRect.js";import"../../../geometry/Polyline.js";import"../../../chunks/projectBuffer.js";import"../../../chunks/geodesicConstants.js";import"../../../chunks/projectXYZToVector.js";import"../../../geometry/support/GeographicTransformation.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../chunks/zscale.js";import"../../../chunks/getDefaultUnitForView.js";import"../../../portal/Portal.js";import"../../../core/Loadable.js";import"../../../core/Promise.js";import"../../../chunks/locale.js";import"../../../portal/PortalGroup.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../chunks/screenUtils.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/Symbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/MarkerSymbol.js";import"../../../geometry/support/geodesicUtils.js";import"../../../geometry/support/normalizeUtils.js";import"../../../chunks/normalizeUtilsCommon.js";import"../../../geometry/support/jsonUtils.js";import"../../../chunks/simplify.js";import"../../../chunks/utils9.js";import"../../../chunks/utils10.js";import"../../../Graphic.js";import"../../../PopupTemplate.js";import"../../../core/Clonable.js";import"../../../core/Collection.js";import"../../../chunks/shared.js";import"../../../layers/support/fieldUtils.js";import"../../../core/sql.js";import"../../../chunks/guards.js";import"../../../chunks/datetime.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/support/AttachmentsOrderByInfo.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../chunks/date.js";import"../../../chunks/constants.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/content/UtilityNetworkAssociationsContent.js";import"../../../popup/support/UtilityNetworkAssociationType.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../core/Identifiable.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../../chunks/typeUtils.js";import"../../../chunks/createFeatureId.js";import"../../../chunks/typeUtils2.js";import"../../../symbols/CIMSymbol.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils3.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/materialUtils.js";import"../../../chunks/opacityUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils4.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../chunks/aaBoundingBox.js";import"../../../chunks/DoubleArray.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/Font.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../symbols/FillSymbol.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/SimpleFillSymbol.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../../chunks/SnappingVisualizer2D.js";import"../../../chunks/vec2.js";import"../../../chunks/common.js";import"../../../chunks/vec2f64.js";import"../../../chunks/normalizedPoint.js";import"../../../chunks/elevationInfoUtils.js";import"../../../chunks/unitConversionUtils.js";import"../../../chunks/lengthUtils.js";import"../../../chunks/Settings.js";import"../../../chunks/SnappingVisualizer.js";import"../../../chunks/RightAngleSnappingHint.js";import"../../../chunks/vec3.js";import"../../../chunks/PointSnappingHint.js";import"../../../chunks/editPlaneUtils.js";import"../../../chunks/UpdatingHandles.js";import"../../../chunks/asyncUtils.js";import"../../../geometry/coordinateFormatter.js";import"../../../chunks/number.js";import"../../../layers/GraphicsLayer.js";import"../../../chunks/GraphicsCollection.js";import"../../../layers/Layer.js";import"../../../time/TimeExtent.js";import"../../../chunks/timeUtils.js";import"../../../layers/mixins/BlendLayer.js";import"../../../chunks/layerContainerType.js";import"../../../chunks/jsonUtils2.js";import"../../../chunks/parser.js";import"../../../chunks/utils5.js";import"../../../chunks/mat4.js";import"../../../layers/mixins/ScaleRangeLayer.js";import"../../../symbols/support/ElevationInfo.js";import"../../../symbols/support/FeatureExpressionInfo.js";import"../../../chunks/dehydratedFeatureComparison.js";import"../../../chunks/createUtils.js";import"../../../geometry/Circle.js";import"../../../geometry/operators/distanceOperator.js";import"../../../chunks/Point2D.js";import"../../../chunks/Distance2DCalculator-CXhBP-8I.js";import"../../../chunks/ProjectionTransformation.js";import"../../../chunks/Envelope2D.js";import"../../../chunks/Envelope.js";import"../../../chunks/Transformation2D.js";import"../../../chunks/SimpleGeometryCursor.js";import"../../../chunks/OperatorDefinitions.js";import"../../../chunks/apiConverter.js";import"../../../chunks/jsonConverter.js";import"../../../geometry/operators/simplifyOperator.js";import"../../../chunks/operatorSimplify.js";import"../../../chunks/surfaceCoordinateSystems.js";import"../../../chunks/mat2d.js";import"../../../chunks/mat2df64.js";import"../../../chunks/quat.js";import"../../../chunks/vec4.js";import"../../../chunks/quatf64.js";import"../../../chunks/quantityUtils.js";import"../../../chunks/helpMessageUtils.js";import"../../../chunks/helpMessageUtils3d.js";import"../../../chunks/drawSurfaces.js";import"../../../chunks/memoize.js";import"../../../chunks/ReactiveSet.js";import"../../../chunks/diffUtils.js";import"../../../chunks/DrawingMode.js";import"../../../chunks/EditGeometryOperations.js";import"../../../chunks/ellipticArc7Utils.js";import"../../../chunks/mat3.js";import"../../../chunks/mat3f64.js";import"../../../chunks/vec4f64.js";import"../../../chunks/plane.js";import"../../../chunks/vector.js";import"../../../chunks/mat4f64.js";import"../../../chunks/mathUtils2.js";import"../../../chunks/geometry2dUtils.js";import"../../../chunks/dragEventPipeline.js";import"../../../chunks/meshVertexSpaceUtils.js";import"../../../geometry/support/MeshGeoreferencedVertexSpace.js";import"../../../geometry/support/MeshLocalVertexSpace.js";import"../../../chunks/hydratedFeatures.js";import"../../../chunks/projectVectorToVector.js";import"../../../chunks/projectPointToVector.js";import"../../../chunks/angularMeasurementUtils.js";import"../../../chunks/Cyclical.js";import"../../../views/interactive/sketch/SketchLabelOptions.js";import"../../../chunks/SnappingContext.js";import"../../../chunks/SnappingDragPipelineStep.js";import"../../../chunks/Scheduler.js";import"../../../chunks/signal.js";import"../../../chunks/debugFlags.js";import"../../../chunks/SnappingOperation.js";import"../../../chunks/SketchTooltipInfo.js";import"../../../geometry/support/MeshTransform.js";import"../../../chunks/axisAngleDegrees.js";import"../../../views/interactive/Tooltip.js";import"../../../chunks/modeUtils.js";import"../../Widget.js";import"../../../intl.js";import"../../../chunks/substitute.js";import"../../../chunks/messages.js";import"../../../chunks/domUtils.js";import"../../../chunks/uuid.js";import"../../../chunks/projector.js";import"../../../chunks/sanitizerUtils.js";import"../../../chunks/componentsUtils.js";import"../../../chunks/jsxWidgetSupport.js";import"../../../chunks/a11yUtils.js";import"../../../chunks/unitFormatUtils.js";import"../../../chunks/quantityFormatUtils.js";import"../../../chunks/messageBundle.js";import"../../../chunks/directionModeIcons.js";import"../../../chunks/TooltipInfoWithCoordinates.js";import"../../../chunks/geodesicMeasurementUtils.js";import"../../../chunks/geodesicLengthMeasurementUtils.js";import"../../../chunks/spatialReferenceEllipsoidUtils.js";import"../../../geometry/operators/geodeticLengthOperator.js";import"../../../chunks/geodeticCurveType.js";import"../../../chunks/InteractiveToolBase.js";import"../../../chunks/SketchOptions.js";import"../../../views/interactive/sketch/SketchTooltipOptions.js";import"../../../chunks/SketchTooltipVisibleElements.js";import"../../../views/interactive/sketch/SketchValueOptions.js";import"../../../chunks/boundedPlane.js";import"../../../chunks/ray.js";import"../../../chunks/lineSegment.js";import"../../../symbols/support/cimSymbolUtils.js";import"../../../chunks/utils6.js";import"../../../chunks/defaultCIMValues.js";import"../../../chunks/GraphicManipulator.js";import"../../../chunks/defaults.js";import"../../../chunks/defaultsJSON.js";import"../../../chunks/drapedUtils.js";import"../../../chunks/colorUtils2.js";import"../../../chunks/drawUtils.js";import"../../../chunks/hitTestSelectUtils.js";import"../../../chunks/screenUtils2.js";import"../../../chunks/Queue.js";import"../../../views/interactive/snapping/FeatureSnappingLayerSource.js";import"../../../rest/support/Query.js";import"../../../chunks/DataLayerSource.js";import"../../../layers/support/Field.js";import"../../../chunks/domains.js";import"../../../layers/support/CodedValueDomain.js";import"../../../layers/support/Domain.js";import"../../../layers/support/InheritedDomain.js";import"../../../layers/support/RangeDomain.js";import"../../../chunks/fieldType.js";import"../../../chunks/FullTextSearch.js";import"../../../chunks/spatialRelationships.js";import"../../../rest/support/StatisticDefinition.js";import"../../../chunks/utils11.js";import"../../../chunks/Version2.js";import"../../../chunks/Version.js";import"../../../chunks/sphere.js";import"../../../chunks/geodesicAreaMeasurementUtils.js";import"../../../chunks/earcut.js";import"../../../chunks/triangle.js";import"../../../chunks/number2.js";import"../../CoordinateConversion/support/Format.js";let E=class extends y{constructor(t){super(t),this.center=new h,this.dynamicScaling=!0,this.majorLineColor=s.fromArray([115,115,115,1]),this.majorLineInterval=10,this.minorLineColor=s.fromArray([165,165,165,1]),this.rotateWithMap=!1,this.rotation=0,this.spacing=1,this.type="measured",this.units="miles"}};t([m()],E.prototype,"center",void 0),t([m()],E.prototype,"dynamicScaling",void 0),t([m()],E.prototype,"majorLineColor",void 0),t([m()],E.prototype,"majorLineInterval",void 0),t([m()],E.prototype,"minorLineColor",void 0),t([m()],E.prototype,"rotateWithMap",void 0),t([m()],E.prototype,"rotation",void 0),t([m()],E.prototype,"spacing",void 0),t([g({measured:"measured"})],E.prototype,"type",void 0),t([m()],E.prototype,"units",void 0),E=t([c("esri.grids.MeasuredGrid")],E);let A=class extends I{constructor(t){super(t),this.color=new s([255,127,0,1]),this.isDecoration=!0,this.length=34,this.rotation=0,this.thickness=2,this.visible=!0}get _strokeStyle(){return this.color.toCss(!0)}render(){const{x:t,y:s,length:i,thickness:e,rotation:r}=this,o=i/2,n=`0 0 ${i} ${i}`,p=`M${o} 0 V${i} M0 ${o} H${i}`;return D("div",{classes:{"esri-box-overlay-item":!0},dir:"ltr",styles:{left:(t??0)-o+"px",top:(s??0)-o+"px",width:`${i}px`,height:`${i}px`,transform:`rotate(${r}deg)`,visibility:this.visible?"visible":"hidden"}},D("svg",{styles:{overflow:"visible"},viewbox:n},D("path",{d:p,stroke:this._strokeStyle,"stroke-width":e})))}renderCanvas(){}};t([m()],A.prototype,"color",void 0),t([m()],A.prototype,"isDecoration",void 0),t([m()],A.prototype,"length",void 0),t([m()],A.prototype,"rotation",void 0),t([m()],A.prototype,"thickness",void 0),t([m()],A.prototype,"visible",void 0),t([m()],A.prototype,"x",void 0),t([m()],A.prototype,"y",void 0),t([m({readOnly:!0})],A.prototype,"_strokeStyle",null),A=t([c("esri.views.overlay.CrosshairOverlayItem")],A);const F=t=>{if(null==t||isNaN(t))return 0;const s=t+180;return Math.trunc(r(s,360))},W=t=>{let s=t;return null==s?0:("string"==typeof s&&(s=parseInt(s,10)),isNaN(s)?0:r(Math.trunc(s),360)-180)},B=(t,i)=>{if(!t||i.length<3)return;const[e,r,o,n]=i,[p,a]=void 0===n?[1,.25]:[n,.25*n];t.majorLineColor=s.fromArray([e,r,o,p]),t.minorLineColor=s.fromArray([e,r,o,a])},z=Symbol("grid-interactivity");let $=class extends i{constructor(t){super(t),this._drawGraphicTool=null,this._keybindings=null,this._crosshairLabel=null,this._crosshairItem=null,this.snappingManager=null,this.snappingOptions=null,this.view=null,this.placementDisabled=!1,this._mostRecentlyShownGrid=null,this._sketchedVertexCount=0}initialize(){this.addHandles([p(()=>!this.displayEnabled,()=>{this.interactivePlacementState=null}),a(()=>this.view?.viewpoint,()=>{this._renderOverlays()}),a(()=>this.snappingOptions?.gridEnabled,t=>{null!=t&&this.trySetDisplayEnabled(t)}),a(()=>this.view?.grid,(t,s)=>{this._mostRecentlyShownGrid=!t&&s?s:null})])}destroy(){this._resetGridPlacementState(),this._crosshairItem&&(this.view?.overlay?.removeItem(this._crosshairItem),this._crosshairItem=n(this._crosshairItem)),this._crosshairLabel&&(this.view?.overlay?.removeItem(this._crosshairLabel),this._crosshairLabel=n(this._crosshairLabel))}get displayEnabled(){return!!this.view?.grid}get dynamicScaling(){return this.grid?.dynamicScaling??!1}set dynamicScaling(t){this.grid&&(this.grid.dynamicScaling=t)}get grid(){return this.view?.grid??this._mostRecentlyShownGrid}set gridColor(t){if(t?.equals(this.grid?.majorLineColor))return;if(!t)return;const[s,i,e,r]=t.toArray();B(this.grid,[s,i,e,r/255])}get gridColor(){return this.grid?.majorLineColor}get gridControlsEnabled(){return this.displayEnabled&&!this.interactivePlacementState}set interactivePlacementState(t){this._set("interactivePlacementState",t),this._resetGridPlacementState(),t&&this._startGridManipulation(t)}get majorLineInterval(){return this.grid?.majorLineInterval??10}set majorLineInterval(t){this.grid&&(this.grid.majorLineInterval=t<1?1:t>15?15:t)}get rotateWithMap(){return this.grid?.rotateWithMap??!1}set rotateWithMap(t){this.grid&&(this.grid.rotateWithMap=t)}get rotation(){return this.grid?.rotation??-180}set rotation(t){this.grid&&(this.grid.rotation=t)}get snappingEnabled(){return(this.grid&&this.snappingOptions?.gridEnabled)??!1}set snappingEnabled(t){const{snappingOptions:s}=this;s&&(s.gridEnabled=t)}get spacing(){return this.grid?.spacing??1}set spacing(t){this.grid&&t>0&&(this.grid.spacing=t)}get unit(){return this.grid?.units}set unit(t){this.grid&&(this.grid.units=t)}get gridOutOfScale(){return!this.dynamicScaling&&null!=this._pixelsPerStride&&this._pixelsPerStride<f}get effectiveSpacingAfterDynamicScaling(){return this.majorLineInterval<1||!this.dynamicScaling||!this.view||null==this._pixelsPerStride||!this.grid?.spacing?null:this.grid.spacing*_(this.majorLineInterval,this._pixelsPerStride,this.dynamicScaling)}get numericSpacingInputShouldBeVisible(){return!!this.view?.spatialReference&&w(this.view.spatialReference)}get _metersPerSRUnit(){if(!(this.view&&this.displayEnabled&&this.grid&&u(this.grid.center.spatialReference,this.view.spatialReference)))return null;const t=d(this.grid.center,this.view.spatialReference);return C(t)}get _pixelsPerStride(){if(!this.view?.scale||!this.displayEnabled||!this.grid||null==this._metersPerSRUnit)return null;const t=this.grid,{scale:s,spatialReference:i}=this.view;return l(t.spacing,t.units,"meters")/(this._metersPerSRUnit*j(s,i))}get _isPlacing(){if(!this._drawGraphicTool)return!1;const t=this.interactivePlacementState;return"place"===t||"interactive"===t&&0===this._sketchedVertexCount}get _isRotating(){if(!this._drawGraphicTool)return!1;const t=this.interactivePlacementState;return"rotate"===t||"interactive"===t&&1===this._sketchedVertexCount}get _isScaling(){return!!this._drawGraphicTool&&"interactive"===this.interactivePlacementState&&1===this._sketchedVertexCount}togglePlacementState(t){this.interactivePlacementState=this.interactivePlacementState===t?null:t}trySetDisplayEnabled(t){const{view:s}=this;if(s?.ready)if(!s.grid&&t)if(this._mostRecentlyShownGrid)s.grid=this._mostRecentlyShownGrid;else{const t="imperial"===this.defaultUnit?"feet":"meters";s.grid=new E({units:t,center:s.center??new h,rotateWithMap:!0}),B(this.grid,[115,115,115])}else t||(s.grid=null);else e.getLogger(this).warn("Attempting to enable grid display while view is not ready")}async startPlacement(t){const{view:s,snappingManager:i}=this;if(!s)return;this._set("interactivePlacementState",t),this._sketchedVertexCount=0;const e=new U({view:s,graphicProperties:{attributes:{[T]:T}},sketchOptions:{tooltips:{enabled:!0,visibleElements:{direction:!1,rotation:!1,totalLength:!1,elevation:!1,distance:!1,area:!1}}},geometryType:"polyline",mode:"click",snapToScene:!1,snappingManager:i,forceUniformSize:!0,centered:!1,cursor:"interactive"===this.interactivePlacementState||"place"===this.interactivePlacementState?"none":null,regularVerticesSymbol:void 0,activeVertexSymbol:H,activeLineSymbol:q,graphicSymbol:q,automaticAreaMeasurementUtils:await G(),automaticLengthMeasurementUtils:await R()});if(this._drawGraphicTool=e,s.addAndActivateTool(e),this._renderOverlays(),!this._keybindings){const t=new x;t.add(M.complete,()=>this._onDrawComplete()),t.add(M.vertexAdd,()=>this._drawGraphicTool?.drawOperation.commitStagedVertex()),this._keybindings=t}this.addHandles([e.on("cursor-update",t=>this._onCursorUpdate(t)),e.on("complete",()=>this._onDrawComplete()),e.on("vertex-add",s=>this._onVertexAdd(s,t)),this._keybindings.register(s,P.WIDGET)],z)}async _startGridManipulation(t){const{view:s}=this;if(!s)return void(this.interactivePlacementState=null);const i=new CustomEvent("before-placement",{cancelable:!0});this.emit("before-placement",i),i.defaultPrevented||await this.startPlacement(t)}_onCursorUpdate(t){try{if(this._isPlacing){const s=t.vertices[0].coordinates;return void this._handlePlace(s)}if(this._drawGraphicTool.cursor=null,this._isRotating&&this._handleRotate(t.vertices[0].coordinates),this._isScaling){const t=this._drawGraphicTool?.drawOperation.cursorVertex;this._handleScale(t)}}finally{this._renderOverlays()}}_onDrawComplete(){this._drawGraphicTool.cursor=null,this.interactivePlacementState=null}_onVertexAdd(t,s){const i=t.vertices[0].coordinates;this._isPlacing&&this._handlePlace(i),this._isRotating&&this._sketchedVertexCount>0&&this._handleRotate(i),this._isScaling&&this._sketchedVertexCount>0&&this._handleScale(k(i[0],i[1],void 0,this.view.spatialReference)),this._sketchedVertexCount++,this._drawGraphicTool.cursor=null,2!==this._sketchedVertexCount&&"interactive"===s||(this.interactivePlacementState=null),this._renderOverlays()}_handlePlace(t){const{grid:s,view:i}=this;s&&i&&(s.center=new h({x:t[0],y:t[1],spatialReference:i.spatialReference}))}_handleRotate(t){const{grid:s,view:i}=this;if(!s||!i)return;this._drawGraphicTool?.sketchOptions.tooltips.set("enabled",!1);const{x:e,y:r}=s.center,[n,p]=t,a=i.toScreen(s.center,{pickClosestTarget:!0}),l=a&&i.toMap(a),m=i.toScreen(k(n,p,void 0,i.spatialReference),{pickClosestTarget:!0}),c=m&&i.toMap(m),h=l?l.x:e,u=l?l.y:r,d=h-(c?c.x:n),j=u-(c?c.y:p);if(0===d&&0===j)return;const y=Math.atan2(j,d),g=o(y),v=s.rotateWithMap,S=i.viewpoint.rotation??0,b=v?g:g-S;s.rotation=Math.fround(b)%360}_handleScale(t){const{view:s,grid:i,_drawGraphicTool:e,interactivePlacementState:r,_metersPerSRUnit:o}=this;if(!(t&&s&&i&&e&&o))return;e.sketchOptions.tooltips.enabled=!1;const n="interactive"===r?i.center:e.drawOperation.firstVertex;if(!n||!t)return;const p=s?.toScreen(n),a=p&&s.toMap(p),m=s?.toScreen(t),c=a??n,h=(m&&s.toMap(m))??t,u=Math.sqrt((c.x-h.x)**2+(c.y-h.y)**2),d=l(u*o,"meters",i.units);this.spacing=d}_renderOverlays(){this._renderCrosshairOverlay(),this._renderTextOverlay()}_renderTextOverlay(){const{grid:t,view:s,_drawGraphicTool:i}=this,e=this._getCrosshairLabel();if(!(t&&s?.overlay&&i&&e))return;const r=s.toScreen(t.center,{pickClosestTarget:!0});r&&(e.position=[r.x+12,r.y+12]),this._isRotating?(e.text=`${F(t.rotation)}${V}`,e.visible=!0):e.visible=!1}_renderCrosshairOverlay(){const{grid:t,view:s,_drawGraphicTool:i}=this;if(!t||!s?.overlay||!i)return;const e=this._getCrosshair();if(!e)return;const r=s.toScreen(t.center);r&&(e.x=r.x,e.y=r.y,e.rotation=t.rotateWithMap?s.viewpoint.rotation-t.rotation:-t.rotation,e.visible=!!i)}_getCrosshairLabel(){if(this._crosshairLabel)return this._crosshairLabel;const{grid:t,view:i,_drawGraphicTool:e}=this;if(!t||!i?.overlay||!e)return null;const r=new O({anchor:"top-left",fontSize:10,textColor:new s([21,21,21]),backgroundColor:new s([248,248,248]),padding:8,borderRadius:20});return i.overlay.addItem(r),this._crosshairLabel=r,r}_getCrosshair(){const{_crosshairItem:t,view:s}=this;return s?.overlay?t&&s.overlay.items.includes(t)?t:(this._crosshairItem=new A({color:s.effectiveTheme.accentColor,thickness:4,length:36,visible:!0}),s.overlay?.addItem(this._crosshairItem),this._crosshairItem):null}_resetGridPlacementState(){this.removeHandles(z),this._crosshairItem&&(this._crosshairItem.visible=!1),this._crosshairLabel&&(this._crosshairLabel.visible=!1),this._drawGraphicTool&&(this.view?.activeTool===this._drawGraphicTool&&(this.view.activeTool=null),this.view?.tools.remove(this._drawGraphicTool)),this._drawGraphicTool=n(this._drawGraphicTool)}};t([m(v)],$.prototype,"defaultUnit",void 0),t([m({readOnly:!0})],$.prototype,"displayEnabled",null),t([m()],$.prototype,"dynamicScaling",null),t([m()],$.prototype,"grid",null),t([m()],$.prototype,"gridColor",null),t([m({readOnly:!0})],$.prototype,"gridControlsEnabled",null),t([m()],$.prototype,"interactivePlacementState",null),t([m()],$.prototype,"majorLineInterval",null),t([m()],$.prototype,"rotateWithMap",null),t([m()],$.prototype,"rotation",null),t([m()],$.prototype,"snappingEnabled",null),t([m()],$.prototype,"snappingManager",void 0),t([m({type:L})],$.prototype,"snappingOptions",void 0),t([m()],$.prototype,"spacing",null),t([m()],$.prototype,"unit",null),t([m()],$.prototype,"view",void 0),t([m({readOnly:!0})],$.prototype,"gridOutOfScale",null),t([m({readOnly:!0})],$.prototype,"effectiveSpacingAfterDynamicScaling",null),t([m({readOnly:!0})],$.prototype,"numericSpacingInputShouldBeVisible",null),t([m()],$.prototype,"placementDisabled",void 0),t([m()],$.prototype,"_metersPerSRUnit",null),t([m()],$.prototype,"_pixelsPerStride",null),t([m()],$.prototype,"_isPlacing",null),t([m()],$.prototype,"_isRotating",null),t([m()],$.prototype,"_isScaling",null),t([m()],$.prototype,"_mostRecentlyShownGrid",void 0),t([m()],$.prototype,"_sketchedVertexCount",void 0),$=t([c("esri.widgets.support.GridControls.GridControlsViewModel")],$);const q=new S({width:0}),H=new b({color:s.fromArray([0,0,0,0]),outline:new S({color:s.fromArray([0,0,0,0])})});export{$ as default,F as g,W as u};
