/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{clone as e,i as o}from"../../core/lang.js";import s from"../../core/Collection.js";import i from"../../core/Error.js";import{EventedAccessor as r}from"../../core/Evented.js";import{LoadableMixin as a}from"../../core/Loadable.js";import{EsriPromiseMixin as l}from"../../core/Promise.js";import{R as p}from"../../chunks/ReactiveMap.js";import{watch as n,initial as m}from"../../core/reactiveUtils.js";import{c as u}from"../../chunks/screenUtils.js";import{u as h,c,m as d,J as y}from"../../chunks/unitUtils.js";import{property as f}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/Logger.js";import{subclass as j}from"../../core/accessorSupport/decorators/subclass.js";import v from"../../geometry/Extent.js";import k from"../../geometry/SpatialReference.js";import{f as T,c as b}from"../../chunks/date.js";import{g}from"../../chunks/locale.js";import w from"../../portal/Portal.js";import _ from"../../portal/PortalQueryParams.js";import{r as I}from"../../core/urlUtils.js";import{execute as x,getTaskInfo as S,a as O,f as U}from"../../rest/print.js";import L from"../../rest/support/PrintParameters.js";import C from"../../rest/support/PrintTemplate.js";import{d as P}from"../../chunks/viewpointUtils.js";import{V as E}from"../../chunks/InputManager.js";import D from"../../core/Accessor.js";import"../../chunks/widgetUtils.js";import{t as F}from"../../chunks/jsxFactory.js";import M,{f as H,v as $}from"./CustomTemplate.js";import W from"./TemplateOptions.js";import"../../chunks/watch.js";import"../../chunks/ObjectPool.js";import"../../chunks/handleUtils.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../core/promiseUtils.js";import"../../chunks/events.js";import"../../chunks/maybe.js";import"../../chunks/object.js";import"../../config.js";import"../../chunks/string.js";import"../../chunks/SetUtils.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/Lifecycle.js";import"../../chunks/tracking.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/ObservableBase.js";import"../../chunks/jsonUtils.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/Warning.js";import"../../chunks/jsonMap.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../chunks/persistableUrlUtils.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/constants.js";import"../../chunks/datetime.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/zmUtils.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../chunks/guards.js";import"../../chunks/floorFilterUtils.js";import"../../chunks/visualVariableUtils.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/support/AttachmentsOrderByInfo.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../geometry/support/jsonUtils.js";import"../../geometry/Multipoint.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/createFeatureId.js";import"../../chunks/typeUtils2.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils3.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils4.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/vec3f64.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/DoubleArray.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../chunks/lineMarkers.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/Font.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/lengthUtils.js";import"../../chunks/utils9.js";import"../../rest/geoprocessor.js";import"../../rest/geoprocessor/GPOptions.js";import"../../rest/support/JobInfo.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils10.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../layers/support/MapImage.js";import"../../rest/support/ArealUnit.js";import"../../chunks/networkEnums.js";import"../../rest/support/DataFile.js";import"../../rest/support/FeatureSet.js";import"../../rest/support/LinearUnit.js";import"../../rest/support/ParameterValue.js";import"../../rest/support/RasterData.js";import"../../rest/support/GPMessage.js";import"../../chunks/submitJob.js";import"../../chunks/layerViewUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../Viewpoint.js";import"../../Camera.js";import"../../CameraLayout.js";import"../../chunks/Cyclical.js";import"../../chunks/common.js";import"../../chunks/mat2d.js";import"../../chunks/mat2df64.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../chunks/projectionUtils.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/Queue.js";import"../../chunks/signal.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/MD5.js";let A=class extends D{constructor(t){super(t),this.strokeDash=[],this.strokeWidth=2,this.strokeColor=[0,0,0,1],this.strokeBackgroundColor=[0,0,0,0],this.fillColor=[0,0,0,0],this.backgroundFillColor=[0,0,0,.5],this.visible=!0,this.isDecoration=!1,this.boxWidth=0,this.boxHeight=0,this.backgroundWidth=0,this.backgroundHeight=0,this.padding={left:0,top:0,right:0,bottom:0}}get _strokeStyle(){return`rgba(${this.strokeColor.join()})`}get _strokeBackgroundStyle(){return`rgba(${this.strokeBackgroundColor.join()})`}get _fillStyle(){return`rgba(${this.fillColor.join()})`}get _backgroundFillStyle(){return`rgba(${this.backgroundFillColor.join()})`}render(){const{backgroundWidth:t,backgroundHeight:e,boxWidth:o,boxHeight:s,padding:i}=this,r=i.left,a=i.top,l=this.x??r+t/2-o/2,p=this.y??a+e/2-s/2,n=l+o,m=p+s;return F("div",{classes:{"esri-box-overlay-item":!0},styles:{left:"0px",top:"0px",width:"100%",height:"100%",visibility:this.visible?"visible":"hidden"}},F("svg",{styles:{width:"100%",height:"100%"}},F("path",{d:`M ${r} ${a} L ${t+r} ${a} L ${t+r} ${e+a} L ${r} ${e+a} Z M ${l} ${p} L ${l} ${m} L ${n} ${m} L ${n} ${p} Z`,fill:this._backgroundFillStyle,stroke:this._strokeBackgroundStyle,"stroke-width":this.strokeWidth}),F("rect",{fill:this._fillStyle,height:s,stroke:this._strokeStyle,"stroke-dasharray":this.strokeDash.join(" ")||void 0,"stroke-width":this.strokeWidth,width:o,x:l,y:p})))}renderCanvas(){}};t([f()],A.prototype,"strokeDash",void 0),t([f()],A.prototype,"strokeWidth",void 0),t([f()],A.prototype,"strokeColor",void 0),t([f()],A.prototype,"strokeBackgroundColor",void 0),t([f()],A.prototype,"fillColor",void 0),t([f()],A.prototype,"backgroundFillColor",void 0),t([f()],A.prototype,"visible",void 0),t([f()],A.prototype,"isDecoration",void 0),t([f()],A.prototype,"boxWidth",void 0),t([f()],A.prototype,"boxHeight",void 0),t([f()],A.prototype,"backgroundWidth",void 0),t([f()],A.prototype,"backgroundHeight",void 0),t([f()],A.prototype,"x",void 0),t([f()],A.prototype,"y",void 0),t([f()],A.prototype,"padding",void 0),t([f({readOnly:!0})],A.prototype,"_strokeStyle",null),t([f({readOnly:!0})],A.prototype,"_strokeBackgroundStyle",null),t([f({readOnly:!0})],A.prototype,"_fillStyle",null),t([f({readOnly:!0})],A.prototype,"_backgroundFillStyle",null),A=t([j("esri.views.overlay.BoxOverlayItem")],A);const R=A;let B=class extends D{constructor(t){super(t),this.state="pending",this.url=""}initialize(){this.addHandles(n(()=>[this.extension,this.name],()=>this._setFormattedFileName(),m))}_setFormattedFileName(){this.name&&this.extension&&(this.formattedName=this.count?`${this.name}(${this.count}).${this.extension}`:`${this.name}.${this.extension}`)}};t([f()],B.prototype,"count",void 0),t([f()],B.prototype,"error",void 0),t([f()],B.prototype,"extension",void 0),t([f()],B.prototype,"formattedName",void 0),t([f()],B.prototype,"name",void 0),t([f()],B.prototype,"portalItem",void 0),t([f()],B.prototype,"state",void 0),t([f()],B.prototype,"url",void 0),B=t([j("esri.widgets.Print.FileLink")],B);const N=B,V=[30,144,255,255],G=[237,211,23,255],z=[216,48,32,255],q=new Set(["GISProfessionalStdUT","GISProfessionalAdvUT"]),J=/(\/GPServer\/).+/i,Q=s.ofType(M),Z=s.ofType(N);function X(t,e,o){e&&e.visible!==o&&t.layoutOptions&&(t.layoutOptions.elementOverrides?t.layoutOptions.elementOverrides[e.name]={visible:o}:t.layoutOptions.elementOverrides={[e.name]:{visible:o}})}let Y=class extends(a(l(r))){constructor(t){super(t),this._serviceTemplateCustomTextElements=null,this._templateIdToCustomTemplate=new p,this._isFreeHand=!1,this._freeHandWidth=0,this._freehandHeight=0,this._asyncPrintTaskUrl=null,this._layoutInfoTaskUrl=null,this._portalLayoutInfoTaskUrl=null,this._customLayoutOptions=null,this._exportedFileNameMap={},this._layoutTemplateInfosCache=new Map,this._tasksInfoCache=new Map,this.allowedFormats="all",this.allowedLayouts="all",this.browseTemplates=new Q,this.defaultTemplates=new Q,this.error=null,this.exportedLinks=new Z,this.extraParameters=null,this.includeDefaultTemplates=!0,this.outSpatialReference=null,this.portal=w.getDefault(),this.portalTemplateIds=[],this.printServiceTemplates=new Q,this.defaultTemplate=null,this.showPrintAreaEnabled=!1,this.printServiceUrl=null,this.printTimeout=12e4,this.saveExportEnabled=!1,this.templatesInfo=null,this.updateDelay=1e3,this.view=null,this.templateCustomTextElements=null,this.templateOptions=new W}initialize(){this.addHandles([n(()=>[this.showPrintAreaEnabled,this.view],()=>{this.showPrintAreaEnabled?this._enablePrintPreview():(this.removeHandles("overlay-handler"),this.view?.overlay?.removeItem(this._getOverlayItem()))}),n(()=>[this.templateOptions.layout,this.templateOptions.layoutItem],()=>{this.loaded&&this._processTemplateOptions()}),n(()=>[this.allowedFormats,this.allowedLayouts],()=>{this.loaded&&this._loadTemplateInfos()}),n(()=>this.exportedLinks,()=>{for(const{name:t,extension:e}of this.exportedLinks)t&&e&&this._updateExportedFileNameMap(`${t}${e}`)},m)])}destroy(){this.removeHandles("overlay-handler"),this.view&&(this._overlayItem&&(this.view.overlay?.removeItem(this._overlayItem),this._overlayItem.destroy(),this._overlayItem=null),this.view=null)}get effectivePrintServiceUrl(){return this.printServiceUrl??null}get effectiveTemplateCustomTextElements(){if(!this._serviceTemplateCustomTextElements)return{};const t=e(this._serviceTemplateCustomTextElements);return this.templateCustomTextElements&&Object.keys(this.templateCustomTextElements).forEach(e=>{const o=t[e];if(o){const t=this.templateCustomTextElements?.[e];o.forEach(e=>{const[o]=Object.entries(e)[0];t?.forEach(t=>{const[s,i]=Object.entries(t)[0];o===s&&(e[o]=i)})})}}),Object.freeze(t)}get state(){return"loading"===this.loadStatus?"initializing":"failed"===this.loadStatus||this.error?"error":"loaded"===this.loadStatus&&this.view?.ready?"ready":"disabled"}async load(t){return this.addResolvingPromise(this._loadResources(t).catch(t=>this.error=t)),this}async print(t){const{view:e,extraParameters:o,updateDelay:s,outSpatialReference:r}=this;if(!e)throw new i("print:view-required","view is not set");!function(t){if(t.layoutOptions??={},t.layoutOptions.customTextElements??=[],!t.layoutOptions.customTextElements.find(t=>"date"in t)){const{customTextElements:e}=t.layoutOptions;let o=T(Date.now(),b("short-date"));"ar"===g()&&(o="â€"+o),e.push({date:o})}}(t);const a=this._getOverlayItem(),l=t.scalePreserved||!this.showPrintAreaEnabled?void 0:P(new v,e.viewpoint,"map-only"===t.layout?[t.exportOptions.width,t.exportOptions.height]:[a.boxWidth,a.boxHeight]),p=new L({view:e,template:t,extent:l,extraParameters:o,updateDelay:s,outSpatialReference:r});try{const e=!!t.layoutItem?.id&&(this.portalTemplateIds.includes(t.layoutItem.id)||this.browseTemplates.some(e=>e.layoutItem?.id===t.layoutItem?.id));return await x(e&&this._asyncPrintTaskUrl?this._asyncPrintTaskUrl:this.effectivePrintServiceUrl,p,{timeout:this.printTimeout})}catch(t){throw new i("print:export-error","An error occurred while exporting the web map.",{error:t})}}toPrintTemplate({attributionEnabled:t,author:e,copyright:o,customTextElements:s,dpi:r,forceFeatureAttributes:a,format:l,height:p,id:n,includeTables:m,layout:u,layoutItem:h,legendEnabled:c,northArrowEnabled:d,scale:y,scaleBarEnabled:f,scaleEnabled:j,title:v,width:k}){if(!u&&!h)throw new i("print:layout-required","layout is not set");const T=new C({attributionVisible:t,forceFeatureAttributes:a,format:l,includeTables:m,layout:u,layoutItem:h,layoutOptions:{authorText:e||"",copyrightText:o||"",customTextElements:s,titleText:v||""},outScale:y??0,scalePreserved:j});if(k&&(T.exportOptions.width=k),p&&(T.exportOptions.height=p),r&&(T.exportOptions.dpi=r),T.layoutOptions){c||(T.layoutOptions.legendLayers=[]);const t=this.getLayoutTemplateById(n)?.mapSurroundInfoOptions;if(t){const e=t.northArrow;for(const t of e)X(T,t,d);const o=t.scaleBar;for(const t of o)X(T,t,f);const s=t.legend;for(const t of s)X(T,t,c)}}return T}getLayoutTemplateById(t){return t?this._templateIdToCustomTemplate.get(t):null}async addPortalTemplate(t){if(!this.portal||!t?.id)return;try{t.loaded||await t.load()}catch{return void this.applyTemplate(this.defaultTemplate)}const e=new M({type:"browse-template",layoutInfoTaskUrl:this._portalLayoutInfoTaskUrl,label:t.title,layoutItem:t});this._templateIdToCustomTemplate.set(e.id,e),this.browseTemplates.add(e)}removePortalTemplate(t){t.layoutItem&&this.templateOptions.id===t.layoutItem.id&&(this.defaultTemplate?this.applyTemplate(this.defaultTemplate):this.templateOptions.reset()),this.browseTemplates.remove(t),this._templateIdToCustomTemplate.delete(t.id)}async applyTemplate(t){if(t&&t===this.getLayoutTemplateById(this.templateOptions.id))return;if(this.templateOptions.reset(),!t)return;if("map-only"===t)return void(this.templateOptions.layout="map-only");!t.layout||!this.templatesInfo||this.templatesInfo.layout.choiceList.includes(t.layout)||(this.defaultTemplate?t=this.defaultTemplate:this.templateOptions.reset());const o=t.layout||t.layoutItem?.id,s=o?this.templateCustomTextElements?.[o]:void 0;if(await this.templateOptions.applyTemplate(t,{customTextElements:s,customLayoutOptions:this._customLayoutOptions}),o&&this._serviceTemplateCustomTextElements&&!this._serviceTemplateCustomTextElements[o]&&t.layoutTemplateInfo?.layoutOptions?.customTextElements){const s=e(this._serviceTemplateCustomTextElements);s[o]=t.layoutTemplateInfo.layoutOptions.customTextElements,this._serviceTemplateCustomTextElements=Object.freeze(s)}}createExportedFileLink(t){const e=this.toPrintTemplate(this.templateOptions).format.toLowerCase(),o=e.includes("png")?"png":e,s=t+o;return this._updateExportedFileNameMap(s),new N({name:t,extension:o,count:this._exportedFileNameMap[s]})}export(t){const e=this.createExportedFileLink(t);this.exportedLinks.add(e);const o=this.print(this.toPrintTemplate(this.templateOptions)).then(t=>e.set({url:t?.url,state:"ready"})).catch(t=>e.set({error:t,state:"error"}));return this.emit("submit",{link:e,saveExportEnabled:this.saveExportEnabled}),o.then(t=>this.emit("complete",{link:t,saveExportEnabled:this.saveExportEnabled})),{link:e,promise:o}}async _loadResources(t){this.destroyed||(await this._loadUrls(t),await this._loadTemplateInfos(t),this._updateOverLayItem())}async _loadTemplateInfos(t){const e=[...this.defaultTemplates,...this.printServiceTemplates];for(const{id:t}of e)this._templateIdToCustomTemplate.delete(t);this.defaultTemplates.removeAll(),this.printServiceTemplates.removeAll();const[o,s]=await Promise.all([this._getLayoutToLayoutTemplateInfos(t),this._getPrintServiceTemplatesInfo(t)]);await this._loadAllTemplates(o,s,t),this._processPrintServiceTemplatesInfo(s),await this._processTemplateOptions()}_updateExportedFileNameMap(t){void 0!==this._exportedFileNameMap[t]?this._exportedFileNameMap[t]++:this._exportedFileNameMap[t]=0}async _processTemplateOptions(){const{layout:t,layoutItem:e}=this.templateOptions;if("map-only"!==t)if(this._customLayoutOptions={legend:this.templateOptions.legendEnabled,northArrow:this.templateOptions.northArrowEnabled,scaleBar:this.templateOptions.scaleBarEnabled},e?.id){try{e.loaded||await e.load()}catch{return void this.applyTemplate(this.defaultTemplate)}let t=this._templateIdToCustomTemplate.get(e.id);t||(t=new M({label:e.title,layoutItem:e,layoutInfoTaskUrl:this._portalLayoutInfoTaskUrl}),this._templateIdToCustomTemplate.set(t.id,t)),await this.applyTemplate(t)}else if(t){const t=this.defaultTemplates.find(t=>t.layout===this.templateOptions.layout)??this.printServiceTemplates.find(t=>t.layout===this.templateOptions.layout);await this.applyTemplate(t??this.defaultTemplate)}}async _loadPortal(t){try{await this.portal.load(t)}catch(t){throw new i("print:could-not-load-portal","Cannot load print resource information from portal",{error:t,url:this.effectivePrintServiceUrl})}}async _loadUrls(t){if(this.printServiceUrl)this._set("effectivePrintServiceUrl",this.printServiceUrl),this._layoutInfoTaskUrl=await this._getLayoutInfoTaskUrl(this.effectivePrintServiceUrl,t);else{await this._loadPortal(t);const{printTask:e,asyncPrintTask:o,layoutInfoTask:s}=this.portal?.helperServices??{};this._set("effectivePrintServiceUrl",e?.url),this._asyncPrintTaskUrl=o?.url,this._layoutInfoTaskUrl=await this._getLayoutInfoTaskUrl(this.effectivePrintServiceUrl,t),s?.url&&this.effectivePrintServiceUrl!==s.url?this._portalLayoutInfoTaskUrl=await this._getLayoutInfoTaskUrl(s.url,t):this._portalLayoutInfoTaskUrl=this._layoutInfoTaskUrl}const e=this.effectivePrintServiceUrl?.toLowerCase().split("/");if(!e?.includes("gpserver"))throw new i("print:invalid-print-service-url","Can't fetch print templates information from provided URL",{url:this.effectivePrintServiceUrl})}async _getLayoutInfoTaskUrl(t,e){if(!t)return null;const o=await S(t,"GetLayoutTemplatesInfo",e);return o?t.replace(J,`$1${encodeURI(o.displayName)}`):null}_getPortalDefaultTemplates(t,e){return this.portal?.helperServices?.printTask?.templates?.filter(t=>"map_only"!==t.layout.toLowerCase()&&(!e||e.includes(O(t.layout))))?.map(e=>{const o=M.fromJSON(e);if(o.type="default-template",o.layoutInfoTaskUrl=this._layoutInfoTaskUrl,o.layout){const e=t.get(o.layout);e&&o.setLayoutTemplateInfo(e)}return o})??[]}async _getPortalCustomTemplates(t){if(this.printServiceUrl||!this.portal)return[];const{layoutGroupQuery:e,user:o}=this.portal,s=I.test(this.portal.url),i=o?.userLicenseTypeId,r=i&&q.has(i);if(!e||s&&!r)return[];const a=new _({query:e,disableExtraQuery:!0}),l=await this.portal.queryGroups(a,t);if(!l.total)return[];const p=l.results[0],n=new _({num:100,query:"type:Layout",sortField:p.sortField,sortOrder:p.sortOrder??void 0}),m=(await p.queryItems(n,t)).results;return m.length?m.map(t=>(this.portalTemplateIds.push(t.id),new M({type:"default-template",label:t.title,layoutItem:t,layoutInfoTaskUrl:this._portalLayoutInfoTaskUrl}))):[]}async _loadAllTemplates(t,e,o){let s=!1;const i=e?.layout?.choiceList;if(this.includeDefaultTemplates&&this.portal&&!this.printServiceUrl){const e=this._getPortalDefaultTemplates(t,i);s=!!e.length,this.defaultTemplates.addMany(e);const r=await this._getPortalCustomTemplates(o);this.defaultTemplates.addMany(r);for(const t of this.defaultTemplates)this._templateIdToCustomTemplate.set(t.id,t)}s||t.forEach((t,e)=>{if(!i||i.includes(e)){const o=new M({type:"print-service-template",layout:e,layoutInfoTaskUrl:this._layoutInfoTaskUrl});o.setLayoutTemplateInfo(t),this.printServiceTemplates.add(o),this._templateIdToCustomTemplate.set(o.id,o)}})}_processPrintServiceTemplatesInfo(t){this._set("templatesInfo",t);const e=t?.layout?.defaultValue;if(e&&"map-only"!==e){const t=this.defaultTemplates.find(t=>t.layout===e)??this.printServiceTemplates.find(t=>t.layout===e)??this.defaultTemplates.at(0)??this.printServiceTemplates.at(0);this._set("defaultTemplate",t)}}async _getLayoutToLayoutTemplateInfos(t){const e=this._layoutInfoTaskUrl,o=e?this._layoutTemplateInfosCache.get(e):void 0,s=o??await H(e,void 0,t);o||this._layoutTemplateInfosCache.set(e,s);const i=new Map,r={};for(const t of s){const e=O(t.layoutTemplate);i.set(e,t),r[e]=t.layoutOptions.customTextElements}return this._serviceTemplateCustomTextElements=Object.freeze(r),i}async _getPrintServiceTemplatesInfo(t){const e=this.effectivePrintServiceUrl?this._tasksInfoCache.get(this.effectivePrintServiceUrl):void 0,o=e??await S(this.effectivePrintServiceUrl,"ExportWebMap",t);if(!o)throw new i("print:unavailable-service-info","Can't fetch templates info from service");e||this._tasksInfoCache.set(this.effectivePrintServiceUrl,o);const{parameters:s}=o,r=s.find(({name:t})=>"Format"===t),a=s.find(({name:t})=>"Layout_Template"===t);return{format:this._getFormat(r),layout:this._getLayout(a)}}_getFormat(t){const e="all"===this.allowedFormats?t.choiceList:t.choiceList.filter(t=>"string"!=typeof this.allowedFormats&&this.allowedFormats.some(e=>new RegExp(`\\b${e}\\b`,"i").test(t))),s=(e.length?e:t.choiceList).map(t=>U.fromJSON(t)).filter(o),i=U.fromJSON(t.defaultValue),r=s.some(t=>new RegExp(`\\b${i}\\b`,"i").test(t))?i:s[0];return{choiceList:s,defaultValue:r}}_getLayout(t){const e=t.choiceList.filter(t=>"map_only"!==t.toLowerCase()),s="all"===this.allowedLayouts?e:e.filter(t=>this.allowedLayouts.includes(O(t))),i=(s.length?s:e).map(O).filter(o),r=O(t.defaultValue),a=i.includes(r)?r:i.find(t=>/(?=.*letter)(?=.*landscape)/i.test(t))??i.find(t=>/(?=.*a4)(?=.*landscape)/i.test(t))??i[0];return{choiceList:i,defaultValue:a}}_getOverlayItem(){return this._overlayItem||(this._overlayItem=new R({strokeDash:[5],strokeWidth:2,strokeColor:[30,144,255,255]})),this._overlayItem}_enablePrintPreview(){if(!this.view?.overlay)return;const t=this.templateOptions,e=this._getOverlayItem();this.addHandles([n(()=>[t.width,t.height,t.scaleEnabled,t.scale,t.layout,t.layoutItem,t.id,t.state,t.dpi,this.view?.scale,this.view?.size,this.view?.state.paddedViewState.size,this.view?.state.padding,this.loaded],()=>this._updateOverLayItem(),m),this.view?.on("drag",["Shift"],t=>this._handleDrag(t),E.WIDGET),this.view?.on("key-down",["Escape"],()=>this._resetDrag(),E.WIDGET)],"overlay-handler"),this.view.overlay.addItem(e)}_updateOverLayItem(){if(!this.view)return;const t=this.templateOptions,e=this._getOverlayItem(),o=t.layoutItem?.id??t.layout,s=this.view,i=s.spatialReference,[r,a]=s.state.paddedViewState.size,l=s.state.padding;let p=0,n=0;if("map-only"===o)null!=t.width&&null!=t.height&&(p=t.width,n=t.height);else if(o){const e=t.id?this._templateIdToCustomTemplate.get(t.id):null,{webMapFrameSize:o,pageUnits:s}=e?.layoutTemplateInfo??{};let l=!1;if(o&&s)if(this._isFreeHand){const t=o[0]/o[1];p=this._freeHandWidth,n=this._freehandHeight,p>n?n=p/t:p=n*t}else{const t=$.fromJSON(s.toLowerCase()),e=i.unit;h(t)===h(e)?(p=c(o[0],t,e),n=c(o[1],t,e)):(l=!0,p=o[0],n=o[1])}if(!this._isFreeHand)if(t.scaleEnabled&&t.scale){const e=l?Math.min(r/p,a/n):d(i)*y*t.dpi;p*=e,n*=e}else if(0===p||0===n)p=r,n=a;else{const t=(r-.1*r)/p,e=(a-.1*a)/n,o=Math.min(t,e);p*=o,n*=o}}const{scaleEnabled:m,scale:u}=t,f=m&&u?u/this.view.scale:1,j=m&&u?96/t.dpi:1;if(e.boxWidth=p*f*j||r,e.boxHeight=n*f*j||a,l&&(e.padding=l),e.backgroundWidth=r??0,e.backgroundHeight=a??0,"loading"===this.loadStatus)e.strokeColor=G;else if("loaded"===this.loadStatus)switch(this.templateOptions.state){case"pending":e.strokeColor=G;break;case"ready":e.strokeColor=V;break;case"error":e.strokeColor=z}}_resetDrag(){this._isFreeHand=!1,this._updateOverLayItem()}_handleDrag(t){switch(t.action){case"start":this._start();break;case"update":this._update(t);break;case"end":this._end()}t.stopPropagation()}_start(){this._isFreeHand=!0}_update(t){const e=this._getOverlayItem(),{x:o,y:s}=t,{x:i,y:r}=t.origin;o>i?(e.x=i,e.boxWidth=o-i):(e.x=o,e.boxWidth=i-o),s>r?(e.y=r,e.boxHeight=s-r):(e.y=s,e.boxHeight=r-s)}_end(){const t=this._getOverlayItem();if(!this.view||null==t.x||null==t.y)return;const e=this.view,o=e.toMap(u(t.x+.5*t.boxWidth,t.y+.5*t.boxHeight));t.x=null,t.y=null,e.goTo({center:o}),this._freeHandWidth=t.boxWidth,this._freehandHeight=t.boxHeight,"map-only"===this.templateOptions.layout&&(this.templateOptions.width=this._freeHandWidth,this.templateOptions.height=this._freehandHeight),this.templateOptions.scale=this.view.scale,this._updateOverLayItem()}};t([f()],Y.prototype,"_serviceTemplateCustomTextElements",void 0),t([f()],Y.prototype,"_templateIdToCustomTemplate",void 0),t([f()],Y.prototype,"allowedFormats",void 0),t([f()],Y.prototype,"allowedLayouts",void 0),t([f({type:Q})],Y.prototype,"browseTemplates",void 0),t([f({type:Q})],Y.prototype,"defaultTemplates",void 0),t([f()],Y.prototype,"error",void 0),t([f({type:Z})],Y.prototype,"exportedLinks",void 0),t([f()],Y.prototype,"extraParameters",void 0),t([f()],Y.prototype,"includeDefaultTemplates",void 0),t([f({readOnly:!0})],Y.prototype,"effectivePrintServiceUrl",null),t([f()],Y.prototype,"effectiveTemplateCustomTextElements",null),t([f({type:k})],Y.prototype,"outSpatialReference",void 0),t([f({type:w})],Y.prototype,"portal",void 0),t([f()],Y.prototype,"portalTemplateIds",void 0),t([f({type:Q})],Y.prototype,"printServiceTemplates",void 0),t([f({readOnly:!0})],Y.prototype,"defaultTemplate",void 0),t([f()],Y.prototype,"showPrintAreaEnabled",void 0),t([f()],Y.prototype,"printServiceUrl",void 0),t([f()],Y.prototype,"printTimeout",void 0),t([f()],Y.prototype,"saveExportEnabled",void 0),t([f({readOnly:!0})],Y.prototype,"state",null),t([f({readOnly:!0})],Y.prototype,"templatesInfo",void 0),t([f()],Y.prototype,"updateDelay",void 0),t([f()],Y.prototype,"view",void 0),t([f()],Y.prototype,"templateCustomTextElements",void 0),t([f({type:W})],Y.prototype,"templateOptions",void 0),Y=t([j("esri.widgets.Print.PrintViewModel")],Y);const K=Y;export{K as default};
