/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{id as e}from"../../kernel.js";import r from"../../core/Collection.js";import{b as s}from"../../core/Accessor.js";import i from"../../core/Error.js";import{EventedAccessor as o}from"../../core/Evented.js";import{L as a}from"../../chunks/Logger.js";import{whenOnce as l,once as n}from"../../core/reactiveUtils.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import{subclass as c}from"../../core/accessorSupport/decorators/subclass.js";import{isPoint as u,isMultipoint as m}from"../../geometry/support/jsonUtils.js";import{f as h}from"../../chunks/messages.js";import y from"../../layers/FeatureLayer.js";import d from"../../layers/GraphicsLayer.js";import g from"../../layers/support/CodedValueDomain.js";import{i as j,b as f,h as k}from"../../chunks/layerUtils.js";import b from"../../networks/UtilityNetwork.js";import{e as w}from"../../networks/Network.js";import A from"../../portal/Portal.js";import{h as v}from"../../chunks/utils12.js";import{trace as I}from"../../rest/networks/trace.js";import S from"../../rest/networks/support/TraceLocation.js";import _ from"../../rest/networks/support/TraceParameters.js";import{a as L}from"../../chunks/layerUtils2.js";import{geodesicBuffer as U,buffer as T,convexHull as F,geodesicArea as R,planarArea as G,cut as C,planarLength as P}from"../../geometry/geometryEngine.js";import V from"../../geometry/Polyline.js";import{project as O,load as D}from"../../chunks/projectionUtils.js";import E from"../../geometry/SpatialReference.js";import N from"../../Graphic.js";import x from"../../symbols/SimpleFillSymbol.js";import B from"../../symbols/SimpleLineSymbol.js";import M from"../../symbols/SimpleMarkerSymbol.js";import H from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import q from"../../views/interactive/snapping/SnappingOptions.js";import z from"../Sketch/SketchViewModel.js";import W from"../../PopupTemplate.js";import J from"../../popup/FieldInfo.js";import"../../core/urlUtils.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/jsonUtils.js";import"../../chunks/string.js";import"../../chunks/watch.js";import"../../chunks/ObjectPool.js";import"../../chunks/handleUtils.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../core/promiseUtils.js";import"../../chunks/events.js";import"../../chunks/maybe.js";import"../../chunks/SetUtils.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/Lifecycle.js";import"../../chunks/tracking.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/ObservableBase.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/Warning.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../chunks/reader.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../request.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/locale.js";import"../../core/Clonable.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../core/sql.js";import"../../chunks/layerContainerType.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/Element.js";import"../../chunks/formUtils.js";import"../../form/elements/AttachmentElement.js";import"../../form/elements/inputs/attachments/AttachmentInput.js";import"../../chunks/Input.js";import"../../form/elements/inputs/attachments/AudioInput.js";import"../../chunks/utils2.js";import"../../form/elements/inputs/attachments/DocumentInput.js";import"../../form/elements/inputs/attachments/ImageInput.js";import"../../form/elements/inputs/attachments/SignatureInput.js";import"../../form/elements/inputs/attachments/VideoInput.js";import"../../form/elements/FieldElement.js";import"../../form/elements/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../chunks/domains.js";import"../../layers/support/Domain.js";import"../../chunks/enumeration.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/elements/RelationshipElement.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../form/elements/TextElement.js";import"../../form/elements/UtilityNetworkAssociationsElement.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../layers/support/fieldUtils.js";import"../../chunks/guards.js";import"../../chunks/datetime.js";import"../../graphic/FeatureGraphicOrigin.js";import"../../graphic/GraphicOrigin.js";import"../../chunks/isFeatureGraphicOrigin.js";import"../../layers/Layer.js";import"../../core/Identifiable.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../time/TimeExtent.js";import"../../chunks/timeUtils.js";import"../../chunks/date.js";import"../../chunks/constants.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../intl.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/typeUtils.js";import"../../chunks/editsZScale.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/support/AttachmentsOrderByInfo.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/createFeatureId.js";import"../../chunks/typeUtils2.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils3.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils4.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/vec3f64.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/DoubleArray.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../chunks/lineMarkers.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/Font.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils2.js";import"../../chunks/parser.js";import"../../chunks/utils5.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../layers/mixins/DisplayFilteredLayer.js";import"../../layers/support/DisplayFilterInfo.js";import"../../chunks/scaleUtils.js";import"../../layers/support/DisplayFilter.js";import"../../chunks/uuid.js";import"../../chunks/displayFilterUtils.js";import"../../chunks/EditBusLayer.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/ElevationInfo.js";import"../../symbols/support/FeatureExpressionInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../tables/AttributeTableTemplate.js";import"../../tables/elements/AttributeTableGroupElement.js";import"../../tables/elements/AttributeTableAttachmentElement.js";import"../../tables/elements/AttributeTableElement.js";import"../../tables/elements/AttributeTableFieldElement.js";import"../../tables/elements/AttributeTableRelationshipElement.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/asyncUtils.js";import"../../chunks/featureQueryAll.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/commonProperties2.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../layers/catalog/catalogUtils.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../chunks/RendererLegendOptions.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/NormalizationBinParametersMixin.js";import"../../rest/support/RelationshipQuery.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../chunks/multiLayerServiceUtils.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../chunks/infoFor3D.js";import"../../layers/support/Subtype.js";import"../../chunks/portalItemUtils.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/typeUtils3.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/support/ClassBreakInfo.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/DictionaryScriptEvaluator.js";import"../../chunks/Version.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/ArcadeExpression.js";import"../../chunks/TimeOnly.js";import"../../chunks/enum.js";import"../../chunks/utils6.js";import"../../chunks/defaultCIMValues.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../renderers/PieChartRenderer.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../layers/support/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../layers/support/TimeInfo.js";import"../../time/TimeInterval.js";import"../../layers/mixins/TrackableLayer.js";import"../../layers/support/TrackInfo.js";import"../../layers/support/TrackPartInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/TitleCreator.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/GraphicsCollection.js";import"../../networks/support/NamedTraceConfiguration.js";import"../../networks/support/TraceConfiguration.js";import"../../chunks/typeUtils4.js";import"../../networks/support/UNTraceConfiguration.js";import"../../chunks/networkFieldUtils.js";import"../../networks/support/NetworkSystemLayers.js";import"../../networks/support/TerminalConfiguration.js";import"../../networks/support/Terminal.js";import"../../networks/support/TraceJobInfo.js";import"../../rest/networks/support/TraceResult.js";import"../../rest/networks/support/AggregatedGeometry.js";import"../../chunks/TelecomNetworkElement.js";import"../../rest/networks/support/NetworkElement.js";import"../../rest/networks/support/FunctionResult.js";import"../../networks/support/TopologyValidationJobInfo.js";import"../../rest/networks/support/ValidateNetworkTopologyResult.js";import"../../chunks/utils9.js";import"../../chunks/editableLayers.js";import"../../chunks/geometryEngineBase.js";import"../../chunks/_commonjsHelpers.js";import"../../chunks/hydrated.js";import"../../chunks/Settings.js";import"../../chunks/UpdatingHandles.js";import"../../chunks/isSupportedObject.js";import"../../chunks/elevationInfoUtils.js";import"../../chunks/InputManager.js";import"../../chunks/signal.js";import"../../chunks/keybindings.js";import"../../views/interactive/sketch/SketchLabelOptions.js";import"../../chunks/SketchOptions.js";import"../../views/interactive/sketch/SketchTooltipOptions.js";import"../../chunks/SketchTooltipVisibleElements.js";import"../../views/interactive/sketch/SketchValueOptions.js";import"../../chunks/SnappingManager.js";import"../../chunks/normalizedPoint.js";import"../../chunks/dehydratedPoint.js";import"../../chunks/constraints.js";import"../../chunks/vec3.js";import"../../chunks/utils11.js";import"../../chunks/Version2.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/plane.js";import"../../chunks/vector.js";import"../../chunks/mat3f64.js";import"../../chunks/mat4f64.js";import"../../chunks/quatf64.js";import"../../chunks/mathUtils2.js";import"../../chunks/sphere.js";import"../../chunks/ray.js";import"../../chunks/mat3.js";import"../../chunks/geometry2dUtils.js";import"../../chunks/RightAngleSnappingHint.js";import"../../chunks/geodesicLengthMeasurementUtils.js";import"../../chunks/quantityUtils.js";import"../../chunks/projectVectorToVector.js";import"../../chunks/projectPointToVector.js";import"../../chunks/spatialReferenceEllipsoidUtils.js";import"../../geometry/operators/geodeticLengthOperator.js";import"../../chunks/geodeticCurveType.js";import"../../chunks/geodesicMeasurementUtils.js";import"../../chunks/automaticAreaMeasurementUtils.js";import"../../chunks/geodesicAreaMeasurementUtils.js";import"../../chunks/earcut.js";import"../../chunks/triangle.js";import"../../chunks/lineSegment.js";import"../../chunks/automaticLengthMeasurementUtils.js";import"../../chunks/HighlightDefaults.js";import"../../chunks/hitTestSelectUtils.js";import"../../chunks/screenUtils2.js";import"../../chunks/sketchUtils.js";function Q(t){return"polygon"===t.type||"polyline"===t.type}class Z{createBuffer(t,e,r,s){if(Array.isArray(t)){if(t.length>0){const i=E.fromJSON(t[0].spatialReference);return i.isWGS84||i.isWebMercator?U(t,e,r,s):T(t,e,r,s)}return}const i=E.fromJSON(t.spatialReference);return i.isWGS84||i.isWebMercator?U(t,e[0],r):T(t,e[0],r)}createConvexHull(t){if(Array.isArray(t)){if(1===t.length&&function(t){return function(t){return t.hasOwnProperty("points")}(t)&&2===t.points.length}(t[0])){const e=F(t[0]);if(Q(e))return e}return F(t,!0).filter(Q)}const e=F(t);if(Q(e))return e}calculateArea(t,e){const r=new E({wkid:t.spatialReference.wkid});return r.isWGS84||r.isWebMercator?parseFloat(R(t,e).toFixed(2)):parseFloat(G(t,e).toFixed(2))}mergeAggregatedToGeometries(t){const e=[],{line:r,multipoint:s,polygon:i}=t;return r&&e.push(r),s&&e.push(s),i&&e.push(i),e}getPercentageAlong(t,e,r){let s=t;const i=this._createPolyline(t.paths,r.wkid);if("point"===e.type){const t=e.x-.5,o=e.x+.5,a=[[[t,e.y-.5],[o,e.y+.5]]];s=this._createPolyline(a,e.spatialReference.wkid),s=O(s,r);const l=C(i,s);if(l.length>0){const t=P(i,"feet");let e;return e=l[0].paths[0][0][0]===i.paths[0][0][0]?P(l[0],"feet"):P(l[1],"feet"),[e/t]}return[.5]}s=O(e,r);const o=C(i,s);if(o.length>0){const t=P(i,"feet");return[P(o[0],"feet")/t]}return[.5]}async projectGeometry(t,e){return await D(),O(t,e)}_createPolyline(t,e){return new V({hasZ:!1,hasM:!0,paths:t,spatialReference:new E({wkid:e})})}}const $=[227,27,21,.6],K=[21,244,21,.6],X=[{color:[255,0,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ff0000"},{color:[255,0,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ff00ff"},{color:[217,188,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#D9BCFF"},{color:[0,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#00ff00"},{color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ffff00"},{color:[0,0,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#0000ff"},{color:[255,165,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#ffa500"},{color:[0,0,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#000000"}];class Y{constructor(){this.highlightColor=[...X]}addCustomColor(t){this.highlightColor=[...X],this.highlightColor.some(e=>e.hex.toLowerCase()===t.hex.toLowerCase())||this.highlightColor.push(t)}getFlagGraphic(t,e,r,s){const i="starting-point"===e?K:$;if("polygon"===t.type){const e=t;e.centroid&&(t=e.centroid)}return s?this.makeGraphic(t,i,r?.attributes,null,s):this.makeGraphic(t,i,r?.attributes)}initializeSketch(t,e,s){const i=new r;return s.forEach(t=>i.add(new H({layer:t,enabled:!0}))),new z({layer:e,view:t,snappingOptions:new q({enabled:!0,featureEnabled:!0,featureSources:i})})}makeGraphic(t,e,r,s,i){let o,a=t;switch(t.type){case"multipoint":o=new M({color:e,size:12,outline:{color:e,width:0}}),s&&(a=t);break;case"point":o=i||new M({color:e,size:12,outline:{color:e,width:0}}),s&&(a=t);break;case"polyline":o=new B({color:e,width:12}),s&&(a=t);break;case"polygon":o=new x({color:e,outline:{color:e,width:12}}),s&&(a=t)}return new N({geometry:a,symbol:o,attributes:r??null})}}const tt=`utility-network-trace-result-area-${Date.now()}`;function et(t){return"graphics"===t.type}class rt{constructor(){this.traceInformation={},this._geometryHandler=new Z}addResultAreaToMap(t,e){const r=this.createGraphicLayer(e);r&&et(r)&&r.add(t)}changeResultAreaColor(t,e,r){const s=new x({color:e.color,style:"solid",outline:{color:e.color,width:1}}),i=this._findGraphicsByTraceId(t,r);return i&&i.forEach(t=>{t.symbol=s}),s}createBuffer(t,e,r,s){return this._geometryHandler.createBuffer(t,e,r,s)}createConvexHull(t,e,r){const s=this._geometryHandler.createConvexHull(t);return e>0&&s?this.createBuffer(s,[e],r,!1):s}createResultAreaGraphic(t,e,r,s,i,o){const a=new x({color:o.color,style:"solid",outline:{color:o.color,width:1}}),l=[];for(const t in e)l.push(new J({fieldName:t,label:"areaStatistic"===t?s.attributeStrings[t]+" ("+i.units[r]?.abbr+")":s.attributeStrings[t]}));return new N({geometry:t,symbol:a,attributes:e,popupTemplate:new W({title:e.traceName,content:[{type:"fields",fieldInfos:l}]})})}removeResultArea(t,e){const r=e.findLayerById(tt);if(r&&et(r)){const s=this._findGraphicsByTraceId(t,e);return s&&r.removeMany(s),s}return null}removeAllResultAreaGraphics(t){if(t){const e=t.findLayerById(tt);e&&et(e)&&e.removeAll()}}createGraphicLayer(t,e){const r=t.findLayerById(tt);if(r&&et(r))return r;const s=new d({title:e??tt,listMode:"hide",id:tt});return t.add(s),s}_findGraphicsByTraceId(t,e){const r=e.findLayerById(tt);if(r&&et(r)){const e=r.graphics.filter(e=>e.attributes.traceId===t);return e.length>0?e.toArray():null}return null}}function st(t){return"feature"===t.type}function it(t,e){return t.url.includes(e)}function ot(t,e){return(t.dataElement?.domainNetworks||[]).some(t=>t.subnetworkLayerId===e.layerId)}class at{getValidUtilityNetworkLayers(t,e){const r=[];return t?.allLayers.forEach(t=>{"group"===t.type?r.push(...t.layers.filter(j).filter(t=>st(t)&&e.isUtilityLayer(t)&&!ot(e,t)).filter(t=>it(t,e.featureServiceUrl)).toArray()):"subtype-group"===t.type?r.push(...t.sublayers.filter(t=>it(t,e.featureServiceUrl)).toArray()):j(t)&&st(t)&&e.isUtilityLayer(t)&&!ot(e,t)&&it(t,e.featureServiceUrl)&&r.push(t)}),r}}const lt=`utility-network-trace-flags-${Date.now()}`,nt=`utility-network-trace-results-${Date.now()}`,pt=`utility-network-trace-sketch-${Date.now()}`;function ct(t){return void 0!==t.layerViews}function ut(t){return"feature"===t.type||"subtype-group"===t.type||"group"===t.type}let mt=class extends o{constructor(t){super(t),this._activeProgress=!1,this._clickHandler=null,this._flags=[],this._flagId=0,this._geometryHandler=null,this._highlightHandler=[],this._resultAreaHandler=null,this._sketchViewModel=null,this._traceTimeout=6e5,this._utilityHelper=new at,this._validUNLayers=[],this._watchHandler=null,this.traces=[],this.graphicHandler=null,this.defaultGraphicColor={color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#FFFF00"},this.enableResultArea=!1,this.flags=[],this.gdbVersion="sde.DEFAULT",this.messages=null,this.messagesUnits=null,this.defaultResultAreaProperties={type:"convexhull",distance:10,unit:"meters",areaUnit:"square-meters",color:{color:[255,165,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#ffa500"},show:!1},this.selectedTraces=[],this.selectOnComplete=!0,this.showGraphicsOnComplete=!0,this.showSelectionAttributes=!0,this.traceResults=[],this.utilityNetwork=null}initialize(){s(a.getLogger(this),"gdbVersion will be removed and the gdbVersion of the UtilityNetwork will be consumed directly.",{replacement:"UtilityNetwork.gdbVersion",version:"4.31"}),this._geometryHandler=new Z,this.graphicHandler=new Y,this._resultAreaHandler=new rt,(async()=>{const[t,e]=await Promise.all([h("esri/widgets/UtilityNetworkTrace/t9n/UtilityNetworkTrace"),h("esri/core/t9n/Units")]);this.set({messages:t,messagesUnits:e})})()}destroy(){this.view=null}get resultAreaProperties(){return this.defaultResultAreaProperties}set resultAreaProperties(t){this._set("resultAreaProperties",{...this.defaultResultAreaProperties,...t}),this.graphicHandler.addCustomColor(this.resultAreaProperties.color),this.traceResults.forEach(e=>{const r=e.resultArea?.show;e.resultArea={...this.defaultResultAreaProperties,...t},this.removeResultAreaFromMap(e),this.enableResultArea&&this.createResultAreaGraphic(e).then(s=>{if(s){e.resultAreaGraphic=s;const i=t?.show??r;e.resultArea&&(e.resultArea.show=i),i&&this.addResultAreaToMap(e,s)}})})}get state(){return this.view?.ready?"ready":"loading"}get view(){return this._get("view")}set view(t){t&&"2d"!==t.type&&a.getLogger(this).error(new i("view:invalid-view","SceneView is not supported",{view:t})),this._set("view",t),this.utilityNetwork&&this.reset(),this.utilityNetwork=null,this.loadUtilityNetwork().then(t=>{t&&this.selectTracesOnLoad()})}addFlagByHit(t,e){const r=!!this.view&&this.view.popupEnabled,s=t=>{this.view?.popup&&(this.view.popupEnabled=t)};return new Promise((i,o)=>{r&&s(!1),this._clickHandler?.remove(),this._clickHandler=this._sketchViewModel.on("create",a=>{if("complete"===a.state){const l=this._getGraphicLayer(pt);l&&a.graphic&&l.remove(a.graphic),this.queryFlagByHitTest(a,t,e).then(r=>{this.emit("add-flag-complete",{type:t,symbol:e}),i(r)}).catch(r=>{this.emit("add-flag-error",{type:t,symbol:e}),o(r)}).finally(()=>{r&&s(!0),this._clickHandler?.remove()})}}),this._sketchViewModel.create("point"),this.emit("add-flag",{type:t})})}addNonspatialTraceLocation(t,e){const r=this._getDisplayField(t),s=this.utilityNetwork?.getTerminalConfiguration(t),i={terminalId:null,isFilterBarrier:!1,allTerminals:s,selectedTerminals:[s?s.terminals[0].id||null:1],displayValue:r};t.attributes={...t.attributes,...i};const o=t.attributes.hasOwnProperty("GLOBALID")?t.attributes.GLOBALID:t.attributes.globalid;if(!this._flags.some(t=>t.globalId===o&&t.type===e)){const r=this._createFlagProperty(t,e,null);this._flags.push(r),this.emit("add-flag-complete",{type:e})}this.emit("add-flag",{type:e})}async addFlagsOnLoad(){return this._flags.length>0?[]:(await l(()=>null!=this.view&&!this.view.updating),(await Promise.all(this.flags.map(async t=>{if(!t.mapPoint)return null;const{type:e}=t,r=t.mapPoint.clone(),s="barrier"===e?$:K,i={graphic:this.graphicHandler.makeGraphic(r,s),state:"complete",tool:"point",toolEventInfo:null,type:"create"};try{return await this.queryFlagByHitTest(i,t.type,null),this.emit("add-flag-complete",{type:e}),null}catch(t){return this.emit("add-flag-error",{type:e}),"barrier"===e?"barrier":"starting-point"}}))).filter(t=>!t))}async addResultAreaToMap(t,e){if(this.view)if(t.resultArea.show=!0,e)this._resultAreaHandler?.addResultAreaToMap(e,this.view.map),this.emit("add-result-area",{graphic:e});else if(t.results){const e=await this.createResultAreaGraphic(t);e&&(t.resultAreaGraphic=e,this._resultAreaHandler?.addResultAreaToMap(e,this.view.map),this.emit("add-result-area",{graphic:e}))}}async addResultGraphicToView(t,e){const{view:r}=this,{results:s}=t;if(r&&s&&this.utilityNetwork)for(const i in s.aggregatedGeometry)if("line,multipoint,polygon".includes(i)){const o=i,a=s.aggregatedGeometry[o];if(null!=a){a.spatialReference=this.utilityNetwork.spatialReference,t.graphicEnabled=!0;const s=await this._geometryHandler.projectGeometry(a,r.spatialReference),i={globalid:t.trace.globalId};if(null!==s){const t=this.graphicHandler.makeGraphic(s,e.color,i,r.spatialReference);this._getGraphicLayer(nt)?.add(t)}}}}addTerminal(t,e){const r=[...this._flags];r.forEach(r=>{r.globalId===e.globalId&&(e.selectedTerminals?.includes(parseInt(t,10))||r.selectedTerminals?.push(parseInt(t,10)))}),this._flags=r}async callTrace(){const t=this.traces.filter(t=>t.selected);return!!t.length&&(this.traceResults.length>0&&this.traceResults.forEach(t=>{this.removeResultGraphicFromView(t)}),this.traceResults=[],this.removeSelection(),await Promise.all(t.map(async(t,e)=>{const r=t,s=new _({gdbVersion:this.utilityNetwork?.gdbVersion,moment:this.utilityNetwork?.historicMoment,namedTraceConfigurationGlobalId:r.globalId,outSpatialReference:null,resultTypes:null,traceType:r.traceType,traceLocations:this._flags,traceConfiguration:null});await this.executeTrace(r,this.utilityNetwork?.networkServiceUrl,s).then(async t=>{if(t.hasOwnProperty("results")){const r={...t};if(null!==r.results){r.resultArea={...this.resultAreaProperties};const t=[...r.results.elements];r.results.elements.length=0;const s=new Map;for(const e of t)s.has(e.globalId)||(s.set(e.globalId,!0),r.results.elements.push(e));const i=[...this.traceResults];if(i.splice(e,0,r),this.traceResults=i,null!==r.results&&(this.selectOnComplete&&this.mergeSelection(!0,r.trace),this.showGraphicsOnComplete&&await this.addResultGraphicToView(r,r.graphicColor),this.enableResultArea)){const t=await this.createResultAreaGraphic(r);t&&(r.resultAreaGraphic=t,r.resultArea?.show&&await this.addResultAreaToMap(r,r.resultAreaGraphic))}}else{const r=[...this.traceResults];r.splice(e,0,t),this.traceResults=r}this._activeProgress=!1}else{this._activeProgress=!1;const r=[...this.traceResults];r.splice(e,0,t),this.traceResults=r}}).catch(t=>{throw this._activeProgress=!1,t})})),!0)}cancelAddFlagByHit(){this._sketchViewModel.cancel()}changeResultAreaColor(t,e){if(!t.resultArea)return;t.resultArea.color=e;const r=this._resultAreaHandler?.changeResultAreaColor(t.trace.globalId,e,this.view.map);t.resultAreaGraphic&&(t.resultAreaGraphic.symbol=r)}changeResultGraphicColor(t,e){const r=[...this.traceResults];r.length>0&&r.forEach(r=>{r.trace.globalId===e.trace.globalId&&(r.graphicColor=t,r.graphicEnabled=!0)}),this.traceResults=r,this.removeResultGraphicFromView(e),this.addResultGraphicToView(e,t)}changeFlagSymbol(t,e){this._flags.length>0&&this._flags.forEach(r=>{r.type===t&&e&&r.mapGraphic&&(r.mapGraphic.symbol=e)})}checkCanTrace(){const t={status:!0,issues:[]},e=this.traces.filter(t=>t.selected);return e.length||(t.status=!1,t.issues.push("noTracesSelected")),this._flags.some(t=>"starting-point"===t.type)||(t.status=!1,t.issues.push("noStartingPoints")),this._flags.filter(t=>null!==t.allTerminals).some(t=>!t.selectedTerminals.length)&&(t.status=!1,t.issues.push("noTerminalSelected")),t}checkSelectionExist(){return this._highlightHandler.some(t=>t)}clearResult(t){if(!this.view)return;let e=this.traceResults;if(e.length>0){const r=e.filter(e=>e.trace.globalId===t.globalId);r.length>0&&(this.removeResultGraphicFromView(r[0]),this.removeResultAreaFromMap(r[0])),e=e.filter(e=>e.trace.globalId!==t.globalId)}this.traceResults=e,0===e.length?(this.removeAllResultAreaGraphics(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]})):this.mergeSelection(!1,t)}createResultAreaGeometries(t,e,r){if(!this.view||!this.resultAreaProperties)return;let s;if(s="convexhull"===this.resultAreaProperties?.type?1===e.length&&(u(e[0])||m(e[0])&&1===e[0].points.length)?this._resultAreaHandler?.createBuffer(e,r,t.resultArea?.unit,!0):this._resultAreaHandler?.createConvexHull(e,t.resultArea?.distance,t.resultArea?.unit):this._resultAreaHandler?.createBuffer(e,r,t.resultArea?.unit,!0),!s)return;if(Array.isArray(s)){for(const e of s){const r=this.getResultAreaAttributes(t,e),s=this._resultAreaHandler?.createResultAreaGraphic(e,r,t.resultArea?.areaUnit,this.messages,this.messagesUnits,t.resultArea?.color);if(s)return s}return}const i=this.getResultAreaAttributes(t,s);return this._resultAreaHandler?.createResultAreaGraphic(s,i,t.resultArea?.areaUnit,this.messages,this.messagesUnits,t.resultArea?.color)}async createResultAreaGraphic(t){if(t.results){const e=await this._createResultAreaInputGeometry(t.results);if(e.length>0){const r=Array(e.length).fill(t.resultArea?.distance),s=this.createResultAreaGeometries(t,e,r);return this.emit("create-result-area",{graphic:s}),s}}}executeTrace(t,e,r){const s=this._processFlags(r.traceLocations);return r.traceLocations=s,I(e,r,{timeout:this._traceTimeout}).then(e=>({trace:t,results:e,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:"success",date:new Date})).catch(e=>({trace:t,results:null,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:e.message,date:new Date}))}async getNonspatialTraceLocationInitialFeature(){return new Promise((t,e)=>{this._clickHandler?.remove(),this._clickHandler=this._sketchViewModel.on("create",async r=>{if("complete"!==r.state)return;const s=this._getGraphicLayer(pt);s&&r.graphic&&s.remove(r.graphic);const i=this.view?.toScreen(r.graphic?.geometry);if(!i)return;const o=await(this.view?.hitTest(i));if(o?.results.length){const r=o.results.find(t=>"graphic"===t.type&&this.utilityNetwork?.isUtilityLayer(t.layer));r?t(r):e(null)}}),this._sketchViewModel.create("point")})}getResultAreaAttributes(t,r){const{messages:s}=this,i=[],o=[];this._flags.forEach(t=>{const e=t.displayValue?.field+":"+t.displayValue?.value+";"+s.attributeStrings.globalid+":"+t.globalId+";"+s.attributeStrings.terminalid+":"+t.terminalId+";"+s.attributeStrings.x+":"+t.mapPoint?.x+";"+s.attributeStrings.y+":"+t.mapPoint?.y;"starting-point"===t.type?i.push(e):o.push(e)});const a=this.utilityNetwork?this.utilityNetwork.gdbVersion:this.gdbVersion;return{traceId:t.trace.globalId,traceName:t.trace.title,traceDescription:t.trace.description??"",startingPoints:i.toString(),barriers:o.toString(),version:a??void 0,username:e.credentials[0].userId,date:t.date,elementCount:t.results?.elements.length,functionResult:JSON.stringify(t.results?.globalFunctionResults),areaStatistic:r?this._geometryHandler.calculateArea(r,t.resultArea?.areaUnit):0}}getValidSources(){let t=[];const e=this.utilityNetwork?.dataElement?.domainNetworks??[];for(const r of e)t=t.concat(r.junctionSources),t=t.concat(r.edgeSources);return t}groupResultsByNetworkSource(t){return 0===t.length?[]:this._groupBy(t,"networkSourceId")}async loadUtilityNetwork(){const{view:t}=this;if(!t)return null;if(await t.when(),this.utilityNetwork){if(this.utilityNetwork.loaded||await this.utilityNetwork.load(),this.utilityNetwork instanceof b){try{const e=t.map;await e.loadAll()}catch(t){if("layer:unsupported-layer-type"!==t.name)throw t}finally{this._loadUNSupportItems()}return this.utilityNetwork}return null}const e=t.map,r=e.utilityNetworks?.at(0);if(r){if(await r.load(),this.utilityNetwork=r,!await async function(t){const e=new y({url:t.networkSystemLayers.dirtyAreasLayerUrl});await e.load();const r=e.version;if(Number(r)<=11.1){const e=await k(t.layerUrl),r=new A({url:e});await r.load();const s=r?.user?.username;return!!s&&v(r,s,"utilityNetwork")}return!0}(r))throw new i("utility-network:no-user-type-extension","User type extension not found");try{await e.loadAll()}catch(t){if("layer:unsupported-layer-type"!==t.name)throw t}finally{this._loadUNSupportItems()}return r}return null}manageFilterBarrier(t,e){const r=[...this._flags];r.forEach(r=>{r.globalId===e.globalId&&"barrier"===e.type&&r.id===e.id&&(r.isFilterBarrier=t)}),this._flags=r}mergeSelection(t,e){let r=[];const s=[...this.traceResults],i=e.globalId;s.forEach(e=>{i===e.trace.globalId&&(e.selectionEnabled=t),e.selectionEnabled&&null!==e.results?.elements&&(r=[...r,...e.results?.elements??[]])}),this.selectResults([...new Set(r)])}async queryFeaturesById(t){const{view:e}=this;if(!e||!this.utilityNetwork)return null;const s=this.utilityNetwork.getObjectIdsFromElements(t),i={layerUrl:s[0].layerUrl,objectIds:s[0].objectIds,outFields:["*"]},o=e.map?.allTables.toArray().filter(t=>t?.parsedUrl?.path===s[0].layerUrl).filter(j)??[];this._getUniqueMapLayerViews(e).filter(({layer:t})=>t?.parsedUrl?.path===s[0].layerUrl).forEach(({layer:t})=>{"feature"!==t.type&&"subtype-group"!==t.type||o.push(t)});const a=(await Promise.all(o.map(async t=>{const s={layers:new r([t]),layerInfos:[i],returnGeometry:!0,outSpatialReference:e.spatialReference},[o]=await w(s);return o}))).filter(({featureSet:t})=>t.features.length>0);return a.length>0?a:null}queryFlagByHitTest(t,e,r){return this._lookupFlagByHit(t).then(t=>{const{view:s}=this;if(!s)return!1;if(t.length>0){const s=[...this._flags],i=r;return t.forEach(t=>{const r=t.graphic,o=r.attributes.hasOwnProperty("GLOBALID")?r.attributes.GLOBALID:r.attributes.globalid;if(s.filter(t=>t.globalId===o).length<=0){const t=this.graphicHandler.getFlagGraphic(r.attributes.mapPoint,e,r,i);this._getGraphicLayer(lt)?.add(t);const o=this._createFlagProperty(r,e,t);s.push(o)}else if(null!==r.attributes.percentAlong){const t=this.graphicHandler.getFlagGraphic(r.attributes.mapPoint,e,r,i);this._getGraphicLayer(lt)?.add(t);const o=this._createFlagProperty(r,e,t);s.push(o)}}),this._flags=s,!0}return!1})}removeResultGraphicFromView(t){const{view:e}=this;if(!e)return;const r=this._getGraphicLayer(nt)?.graphics;t.graphicEnabled=!1;const s=r?.filter(e=>e.attributes[e.attributes.hasOwnProperty("GLOBALID")?"GLOBALID":"globalid"]===t.trace.globalId);s?.forEach(t=>{this._getGraphicLayer(nt)?.remove(t)})}removeFlag(t){const e=this._flags.filter(e=>{if(e.id!==t.id)return e});this._removeGraphic(t),this._flags=e}removeAllResultAreaGraphics(){this._resultAreaHandler?.removeAllResultAreaGraphics(this.view.map)}removeResultAreaFromMap(t){if(t.resultArea){t.resultArea.show=!1;const e=this._resultAreaHandler?.removeResultArea(t.trace.globalId,this.view?.map);e&&this.emit("remove-result-area",{graphic:e})}}removeSelection(){this._highlightHandler.forEach(t=>{t&&t.remove()}),this._highlightHandler=[]}removeTerminal(t,e){const r=[...this._flags];r.forEach(r=>{if(r.globalId===e.globalId&&e.selectedTerminals?.includes(parseInt(t,10))){const s=e.selectedTerminals.indexOf(parseInt(t,10));r.selectedTerminals?.splice(s,1)}}),this._flags=r}removeFlagsOnLoadWatcher(){this._watchHandler&&null!==this._watchHandler&&this._watchHandler.remove()}removeClickHandler(){this._clickHandler&&(this._sketchViewModel.cancel(),this._clickHandler.remove())}reset(){this._flags=[],this.traceResults=[];const t=[...this.traces];t.forEach(t=>{t.selected=!1}),this.traces=t,this.view&&(this._getGraphicLayer(pt)?.removeAll(),this._getGraphicLayer(lt)?.removeAll(),this._getGraphicLayer(nt)?.removeAll(),this.removeAllResultAreaGraphics(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]}),this.emit("reset"))}selectFeaturesById(t){const{view:e}=this;if(!e||!this.utilityNetwork)return;const r=this.utilityNetwork.getObjectIdsFromElements(t);this._getUniqueMapLayerViews(e).forEach(t=>{var e;"layer"in t&&t.layer?.parsedUrl?.path===r[0].layerUrl&&("feature"===(e=t).layer.type||"subtype-group"===e.layer.type)&&this._highlightHandler.push(t.highlight(r[0].objectIds))})}selectResults(t){if(t.length>0){this.removeSelection();const e=this.groupResultsByNetworkSource(t),r=[];for(const t in e)this.selectFeaturesById(e[t]),r.push(this.queryFeaturesById(e[t]));Promise.all(r).then(t=>{this.emit("select-features",{resultSet:t})})}else this.removeSelection(),this.emit("clear-selection",{resultSet:[]})}selectTraces(t,e){const r=[...this.traces];r.forEach(r=>{e===r.globalId&&(r.selected=t)}),this.traces=r}selectTracesOnLoad(){this.utilityNetwork?.hasOwnProperty("sharedNamedTraceConfigurations")&&(this.traces=[...this.utilityNetwork.sharedNamedTraceConfigurations],this.traces.forEach(t=>{t.selected=!1,this.selectedTraces.includes(t.globalId)&&(t.selected=!0)}))}zoomToAsset(t){this.view?.goTo(t).catch(t=>console.error(t))}async _createResultAreaInputGeometry(t){if(null!=t.aggregatedGeometry)return this._geometryHandler.mergeAggregatedToGeometries(t.aggregatedGeometry);const e=this.groupResultsByNetworkSource(t.elements),r=[];for(const t in e)r.push(this.queryFeaturesById(e[t]));try{const t=await Promise.all(r),e=[];for(const r of t)if(r)for(const t of r)for(const r of t.featureSet.features)r.geometry&&e.push(r.geometry);return e}catch{return[]}}_loadUNSupportItems(){if(!this.utilityNetwork)return;const{map:t}=this.view,{messages:e}=this;this._populateOutfields(),this._createGraphicLayer(pt),this._createGraphicLayer(lt),this._createGraphicLayer(nt),this._resultAreaHandler?.createGraphicLayer(t,e?.alertsStrings.genericResultHeader),this._validUNLayers=this._utilityHelper.getValidUtilityNetworkLayers(t,this.utilityNetwork),this._sketchViewModel=this.graphicHandler.initializeSketch(this.view,this._getGraphicLayer(pt),this._validUNLayers)}_getUniqueMapLayerViews(t){const e=[],r=t.layerViews.filter(({layer:{type:t}})=>"feature"===t||"group"===t||"subtype-group"===t).toArray(),s=t=>{for(const r of t.layerViews)ct(r)?s(r):e.push(r)};return r.forEach(t=>{switch(t.layer.type){case"group":ct(t)&&s(t);break;case"subtype-group":e.push(t);break;default:e.some(e=>e.layer.id===t.layer.id)||e.push(t)}}),e}_processFlags(t){const e=[];return t.forEach(t=>{if(null!==t.selectedTerminals&&t.selectedTerminals.length>0)t.selectedTerminals.forEach(r=>{const s=new S({globalId:t.globalId,percentAlong:t.percentAlong,terminalId:r,type:t.type,isFilterBarrier:t.isFilterBarrier});e.push(s)});else{const r=new S({globalId:t.globalId,percentAlong:t.percentAlong,type:t.type,isFilterBarrier:t.isFilterBarrier});e.push(r)}}),e}_getDisplayField(t){return f(t?.sourceLayer)?this._getDisplayFieldBySublayer(t):this._getDisplayFieldByFeatureLayer(t)}_getDisplayFieldBySublayer(t){let e="",r="";const s=t.sourceLayer;e=this._checkParentForData(s,"displayField");for(const i in t.attributes){const o=i.toLowerCase();o===e?.toLowerCase()?(r=t.attributes[i],"assetgroup"===o||"assettype"===o?r=this._checkSubtype(s,s.subtypeCode):(r=this._checkDomain(s.fields,i,r),"string"==typeof r&&(r=this._defaultDisplayField(r,s)))):(r=this._checkDomain(s.fields,i,r),"string"==typeof r&&(r=this._defaultDisplayField(r,s)))}return{field:e,value:r.toString()}}_getDisplayFieldByFeatureLayer(t){const e=t.sourceLayer;let r=e.displayField,s="";for(const i in t.attributes){const o=i.toLowerCase();if(o===r?.toLowerCase())if(s=t.attributes[i],"assetgroup"===o||"assettype"===o){let o=t.attributes[e.typeIdField.toUpperCase()];o||(o=t.attributes[e.typeIdField.toLowerCase()]),r=e.typeIdField,s=this._checkSubtype(e,o),""===r&&(e.templates&&e.templates.length>0?(r=e.templates[0]?.name,s=e.templates[0]?.name):(r=e.displayField,s=t.attributes[i]))}else s=this._checkDomain(e.fields,i,s),"string"==typeof s&&(s=this._defaultDisplayField(s,e));else s=this._checkDomain(e.fields,i,s),"string"==typeof s&&(s=this._defaultDisplayField(s,e))}return{field:r,value:s?s.toString():""}}_checkSubtype(t,e){let r=e;if("subtype-sublayer"===t.type){const s=this._checkParentForData(t,"subtypes");s?.length>0&&s.forEach(t=>{t.code===e&&(r=t.name)})}else if(null!=t.types&&t.types.length>0){const s=t.types.filter(t=>t.id===e);s.length>0&&(r=s[0].name)}return r}_checkDomain(t,e,r){let s=r;const i=t.filter(t=>t.name.toLowerCase()===e.toLowerCase());if(i.length>0&&i[0].domain instanceof g&&i[0].domain?.codedValues){const t=i[0].domain.codedValues.filter(({code:t})=>t===r);t.length>0&&(s=t[0].name)}return s}_checkParentForData(t,e){return t.parent?.[e]??null}_defaultDisplayField(t,e){return t.trim()?t:e.templates&&e.templates?.length>0?e.templates[0].name:e.title}get _uniqueFlagId(){return this._flagId++}_groupBy(t,e){return t.reduce((t,r)=>((t[r[e]]=t[r[e]]||[]).push(r),t),{})}async _lookupFlagByHit(t){const e=[];let r={};const s=t.graphic?.geometry,i=this.view?.toScreen(s),o=await(this.view?.hitTest(i,{include:this._validUNLayers}));if(!o?.results.length)return[];const a=o?.results.find(t=>null!==t.layer),l=a,p=l.graphic.geometry?.type,c=a?.layer,u=c.globalIdField??"globalid",m=c.objectIdField??"objectid";if(u&&l.graphic.attributes[u])r=l.graphic.attributes;else{const t=await(this.view?.whenLayerView(c)),e=t.createQuery();e.outFields=["assetgroup","assettype","globalid","objectid"],e.where=`${m} = ${l.graphic.attributes[m]}`,await n(()=>!t?.updating&&!t?.dataUpdating);const s=await(t?.queryFeatures(e)),i=s?.features[0],o=i?.attributes;r=o}const h=this._getDisplayField(l.graphic),y=l.mapPoint;let d={};if("point"===p||"polygon"===p){if(this.utilityNetwork){const t=this.utilityNetwork.getTerminalConfiguration(l.graphic);d={terminalId:t?t.terminals[0].id||null:1,isFilterBarrier:!1,allTerminals:t??null,selectedTerminals:[t?t.terminals[0].id||null:1],percentAlong:null,displayValue:h,mapPoint:y}}}else if("polyline"===p){const e=l.graphic.geometry;d={terminalId:null,isFilterBarrier:!1,allTerminals:null,selectedTerminals:null,percentAlong:this._geometryHandler.getPercentageAlong(e,t.graphic?.geometry,e.spatialReference),displayValue:h,mapPoint:y}}return l.graphic.attributes={...r,...d},e.push(l),e}_createFlagProperty(t,e,r){const s=new S;s.terminalId=t.attributes.terminalId,s.isFilterBarrier=t.attributes.isFilterBarrier,s.percentAlong=t.attributes.percentAlong,s.globalId=t.attributes.globalid||t.attributes.GLOBALID,s.type=e;const i=s;return i.details=t,i.mapGraphic=r,i.id=this._uniqueFlagId,i.allTerminals=t.attributes.allTerminals,i.selectedTerminals=t.attributes.selectedTerminals,i.displayValue=t.attributes.displayValue,i.mapPoint=t.attributes.mapPoint,i}_populateOutfields(){if(!this.view)return;const{map:t}=this.view,e=this.getValidSources(),r=t=>{"group"===t.type?t.layers.forEach(t=>{ut(t)&&r(t)}):e.some(e=>e.layerId===t.layerId)&&t.fields.some(t=>"assetgroup"===t.name.toLowerCase())&&(t.outFields=["assetgroup","assettype","globalid","objectid"])};for(const e of t.layers)ut(e)&&r(e)}_removeGraphic(t){this._getGraphicLayer(lt)?.remove(t.mapGraphic)}_createGraphicLayer(t){const{map:e}=this.view;if(!e.findLayerById(t)){const e=new d({id:t,internal:!0,listMode:"hide",title:t});L(this.view,e)}}_getGraphicLayer(t){const{map:e}=this.view;if(e){const r=e.findLayerById(t);if(r&&"graphics"===r.type)return r}return null}};t([p()],mt.prototype,"_activeProgress",void 0),t([p()],mt.prototype,"_flags",void 0),t([p()],mt.prototype,"traces",void 0),t([p()],mt.prototype,"defaultGraphicColor",void 0),t([p()],mt.prototype,"enableResultArea",void 0),t([p()],mt.prototype,"flags",void 0),t([p()],mt.prototype,"gdbVersion",void 0),t([p()],mt.prototype,"messages",void 0),t([p()],mt.prototype,"messagesUnits",void 0),t([p()],mt.prototype,"resultAreaProperties",null),t([p()],mt.prototype,"selectedTraces",void 0),t([p()],mt.prototype,"selectOnComplete",void 0),t([p()],mt.prototype,"showGraphicsOnComplete",void 0),t([p()],mt.prototype,"showSelectionAttributes",void 0),t([p({readOnly:!0})],mt.prototype,"state",null),t([p()],mt.prototype,"traceResults",void 0),t([p()],mt.prototype,"utilityNetwork",void 0),t([p({value:null})],mt.prototype,"view",null),mt=t([c("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceViewModel")],mt);const ht=mt;export{X as d,ht as default};
