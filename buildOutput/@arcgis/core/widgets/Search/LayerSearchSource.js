/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{h as t,clone as s}from"../../core/lang.js";import{property as i}from"../../core/accessorSupport/decorators/property.js";import{L as r}from"../../chunks/Logger.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import n from"./SearchSource.js";import"../../intl.js";import l from"../../core/Error.js";import{m as a}from"../../chunks/maybe.js";import{m as p}from"../../chunks/unitUtils.js";import u from"../../geometry/Polygon.js";import{c,s as d}from"../../chunks/geometryUtils2.js";import{F as m}from"../../chunks/FullTextSearch.js";import{s as h}from"../../chunks/substitute.js";import{f}from"../../chunks/date.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/Lifecycle.js";import"../../chunks/tracking.js";import"../../chunks/Warning.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../core/promiseUtils.js";import"../../chunks/events.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/jsonUtils.js";import"../../core/JSONSupport.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../chunks/guards.js";import"../../chunks/datetime.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/support/AttachmentsOrderByInfo.js";import"../../chunks/jsonMap.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/locale.js";import"../../chunks/constants.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/mathUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/number.js";import"../../chunks/messages.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/assets.js";import"../../chunks/pe.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../geometry/Point.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/coordsUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/zmUtils.js";import"../../chunks/scaleUtils.js";const g=/https?:\/\/services.*\.arcgis\.com/i,j=/(?:\{([^}]+)\})/g,y=()=>r.getLogger("esri.widgets.Search.support.layerSearchUtils");function F(e,t){const{filter:s,withinViewEnabled:i}=e,r=t?.extent,o=s?.geometry;return o??(i&&r?r:void 0)}function x(e){return e&&e.includes("*")}async function k(e){e&&await e.load()}function v(e){return!(!e.fullText&&!e.where)}function S(e,t){const s=e?.indexes;return!(!s||!t?.length)&&s.filter(e=>"FullText"===e.indexType).some(e=>{const s=e.fields?.split(",").map(e=>e.trim().toLowerCase())||[];return t.every(e=>s.includes(e.toLowerCase()))})}function w({text:e,searchFields:t}){return e.trim().split(" ").filter(e=>!!e.trim()).map(e=>new m({onFields:t,searchTerm:e,searchType:"prefix"}))}function b(e){return e?.capabilities?.query?.supportsFullTextSearch??!1}function I(e){return e?.capabilities?.query?.supportsPagination??!1}function T(e){return e.displayField||e.layer.displayField||(t=e.layer,t?.fieldsIndex?.fields?.find(e=>"string"===e.type)?.name??"");var t}function C(e,t){return!(!e||!t?.length)&&t.every(t=>M(e,t))}function M(e,t){return!!e.getField(t)}function $(e){return e.replaceAll("'","''")}function U(e,t){const s=t?.where;return s?`(${e}) AND (${s})`:e}function E({searchTerm:e,layer:s,searchFields:i,filter:r,exactMatch:o,query:n,type:l}){const{definitionExpression:p,url:u}=s;let c="";return!n.fullText&&e&&i&&i.forEach(i=>{const n=s.getField(i),p=s.getFieldDomain?.(i,{excludeImpliedDomains:t("esri-widget-legacy-field-domain-calculation")}),d=p&&"coded-value"===p.type?function({codedValues:e},t,s){return a(e??[],e=>{const i=e.name,r=s?i:i.toLowerCase();return(s?t:t.toLowerCase())===r?e.code.toString():null})??null}(p,e,o):null,m=d||e||null;if(null!==m){const e=function({currentTerm:e,field:t,filter:s,exactMatch:i,url:r,type:o}){const n=t?.type,l=t?.name;if("string"===n||"date"===n||"global-id"===n){const t=g.test(r??""),n=t&&function(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}(e)?"N":"";return U(i&&"search"===o?`${l} = ${n}'${e}'`:t?`${l} LIKE ${n}'${e}%'`:`LOWER(${l}) LIKE ${n}'${e.toLowerCase()}%'`,s)}if("oid"===n||"small-integer"===n||"integer"===n||"single"===n||"double"===n){const t=Number(e);return isNaN(t)?null:U(`${l} = ${t}`,s)}return U(`${l} = ${e}`,s)}({currentTerm:m,field:n,filter:r,exactMatch:o,url:u,type:l});e&&(c+=function(e,t){return e?` OR (${t})`:`(${t})`}(c,e))}}),p&&c?`(${p}) AND (${c})`:p||c}function L(e,s,i){const r=e.sourceLayer,{attributes:o}=e,n=r.getFieldDomain?.(i,{feature:e,excludeImpliedDomains:t("esri-widget-legacy-field-domain-calculation")});if(s)return h(s,o);if(i&&o){const e=r.getField(i),t=(l=o)[a=i]??l[Object.keys(l).find(e=>e.toLowerCase()===a.toLowerCase())];return null==t?"":n&&"coded-value"===n.type?function(e,t){let s=null;const{codedValues:i}=e;return i&&i.length&&i.some(e=>e.code===t&&(s=e.name,!0)),s}(n,t)??"":"date"===e?.type?f(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}var l,a;return""}var R;let A=R=class extends n{constructor(e){super(e),this.displayField=null,this.exactMatch=null,this.orderByFields=null,this.searchFields=null,this.searchTemplate=null,this.suggestionTemplate=null,this.getResults=(e,t)=>function(e,t){const{exactMatch:i=!1,location:r,maxResults:o,spatialReference:n,source:a,sourceIndex:m,suggestResult:h,view:f}=e,{layer:g,filter:j,zoomScale:U}=a,R=f?.scale,A=F(a,f),B=t?.signal;return k(g).then(()=>{const e=g.popupTemplate;return e?e.getRequiredFields(g.fieldsIndex):null}).then(e=>{const{objectIdField:t,returnZ:F}=g,k=T(a);if(!M(g,k))throw y().error("invalid-field: displayField is invalid."),new l("getResults():invalid-field","displayField is invalid.");const O=e?.length?e:[k],N=a.outFields||O,_=x(N);if(N.includes(t)||_||N.push(t),g.floorInfo?.floorField&&N.push(g.floorInfo.floorField),!_&&!C(g,N))throw y().error("invalid-field: outField is invalid."),new l("getResults():invalid-field","outField is invalid.");const q=g.createQuery(),{orderByFields:D}=a;if(D&&(q.orderByFields=D),n){q.outSpatialReference=n;const e=1/p(n);e&&(q.maxAllowableOffset=e)}const V="mesh"===g.geometryType||"multipatch"===g.geometryType,P=g.capabilities?.data?.supportsZ&&!V;if(q.returnZ=P&&!1!==F,q.returnGeometry=!0,q.multipatchOption=V?"xyFootprint":null,N&&(q.outFields=N),r)q.geometry=r;else if(h.key)q.objectIds=[h.key];else{const e=a.searchFields||[k];if(!C(g,e))throw y().error("invalid-field: search field is invalid."),new l("getResults():invalid-field","search field is invalid.");I(g)&&(q.num=o),A&&(q.geometry=A);const t=h.text?.trim();if(!t)return[];const s=h.text,{prefix:r="",suffix:n=""}=a,p=$(`${r}${s}${n}`);b(g)&&S(g,e)&&!i&&s&&(q.fullText=w({text:s,searchFields:e}));const u=E({searchTerm:p,layer:g,searchFields:e,filter:j,exactMatch:i,query:q,type:"search"});if(q.where=u,!v(q))return[]}return g.queryFeatures(q,{signal:B}).then(e=>function(e,t,i,r,o,n,l){return e.features.map(e=>function(e,t,i,r,o,n,l){const a=e.clone();a.layer=e.layer;const p=e.sourceLayer,m=p?.objectIdField,h=m?e.attributes[m]:null,f=L(e,i.searchTemplate,o);null!=n&&function(e){return null!=e&&null!=e.minScale&&null!=e.maxScale}(p)&&(p.minScale&&p.minScale<n?n=p.minScale:p.maxScale&&p.maxScale>n&&(n=p.maxScale));const g=a.geometry?c(a.geometry,t??void 0,n??void 0):void 0,j="number"==typeof l&&g?d(s(g),t??void 0,l):g,y=e.clone();return y.layer=e.layer,null!=j&&(y.geometry=u.fromExtent(j)),{extent:j,target:y,feature:a,key:h,name:f,sourceIndex:r}}(e,t,i,r,o,n,l))}(e,f,a,m,k,R,U))})}({source:this,...e},t),this.getSuggestions=(e,t)=>function(e,t){const{source:s,spatialReference:i,view:r,suggestTerm:o,maxSuggestions:n,sourceIndex:a,exactMatch:p}=e,{layer:u,filter:c}=s,d=t?.signal,m=F(s,r);return k(u).then(()=>{if(!I(u))return[];const e=T(s),t=s.searchFields||[e],r=[];s.suggestionTemplate?s.suggestionTemplate.replaceAll(j,(e,t)=>(r.push(t),e)):r.push(e);const h=x(r);r.includes(u.objectIdField)||h||r.push(u.objectIdField);const f=M(u,e),g=h||C(u,r),F=C(u,t);if(!f)throw y().error("invalid-field: displayField is invalid."),new l("getSuggestions():invalid-field","displayField is invalid.");if(!g)throw y().error("invalid-field: outField is invalid."),new l("getSuggestions():invalid-field","outField is invalid.");if(!F)throw y().error("invalid-field: search field is invalid."),new l("getSuggestions():invalid-field","search field is invalid.");const k=u.createQuery(),{orderByFields:U}=s;if(U&&(k.orderByFields=U),k.outSpatialReference=i,k.returnGeometry=!1,k.num=n,k.outFields=r,m&&(k.geometry=m),!o.trim())return[];const{prefix:R="",suffix:A=""}=s,B=$(`${R}${o}${A}`);b(u)&&S(u,t)&&!p&&o&&(k.fullText=w({text:o,searchFields:t}));const O=E({searchTerm:B,layer:u,searchFields:t,filter:c,exactMatch:p,query:k,type:"suggest"});return k.where=O,v(k)?u.queryFeatures(k,{signal:d}).then(t=>function(e,t,s,i){return e.features.map(e=>function(e,t,s,i){const r=e.sourceLayer,{attributes:o}=e,{objectIdField:n}=r,l=n?o[n]:null;return{text:L(e,t.suggestionTemplate,i),key:l,sourceIndex:s}}(e,t,s,i))}(t,s,a,e)):[]})}({source:this,...e},t)}set layer(e){this._set("layer",e),e&&e.load().catch(()=>{})}get name(){return this._getLayerTitle()??""}set name(e){this._overrideIfSome("name",e)}clone(){return new R({autoNavigate:this.autoNavigate,filter:this.filter,maxResults:this.maxResults,maxSuggestions:this.maxSuggestions,minSuggestCharacters:this.minSuggestCharacters,outFields:this.outFields?s(this.outFields):null,placeholder:this.placeholder,popupEnabled:this.popupEnabled,prefix:this.prefix,resultGraphicEnabled:this.resultGraphicEnabled,resultSymbol:this.resultSymbol?this.resultSymbol.clone():null,suggestionsEnabled:this.suggestionsEnabled,suffix:this.suffix,withinViewEnabled:this.withinViewEnabled,displayField:this.displayField,exactMatch:this.exactMatch,layer:this.layer,searchFields:this.searchFields?s(this.searchFields):null,suggestionTemplate:this.suggestionTemplate,zoomScale:this.zoomScale})}_getFirstStringField(){return this.layer.fieldsIndex?.fields.find(e=>"string"===e.type)?.name??""}_getDisplayField(){return this.displayField||this.layer.displayField||this._getFirstStringField()}_getSearchFieldsString(){const{layer:e,searchFields:t}=this;return e.loaded?`: ${(t||[this._getDisplayField()]).map(t=>{const s=e.getField(t);return s?.alias||t}).join(", ")}`:""}_getLayerTitle(){const{layer:e}=this;if(!e)return;const{title:t}=e;return t?`${t}${this._getSearchFieldsString()}`:void 0}};e([i({json:{read:{source:"field.name"},write:{target:"field.name"}}})],A.prototype,"displayField",void 0),e([i({json:{read:{source:"field.exactMatch"},write:{target:"field.exactMatch"}}})],A.prototype,"exactMatch",void 0),e([i({value:null})],A.prototype,"layer",null),e([i()],A.prototype,"name",null),e([i({type:[String],json:{write:!0}})],A.prototype,"orderByFields",void 0),e([i()],A.prototype,"searchFields",void 0),e([i()],A.prototype,"searchTemplate",void 0),e([i()],A.prototype,"suggestionTemplate",void 0),A=R=e([o("esri.widgets.Search.LayerSearchSource")],A);const B=A;export{B as default};
